<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Performance issue /cache_dir / cache_mem / SMP workers
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Performance%20issue%20/cache_dir%20/%20cache_mem%20/%20SMP%0A%20workers&In-Reply-To=%3Cef100110-3528-b0dd-7a49-8efce15a979b%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="019702.html">
   <LINK REL="Next"  HREF="019655.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Performance issue /cache_dir / cache_mem / SMP workers</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Performance%20issue%20/cache_dir%20/%20cache_mem%20/%20SMP%0A%20workers&In-Reply-To=%3Cef100110-3528-b0dd-7a49-8efce15a979b%40treenet.co.nz%3E"
       TITLE="[squid-users] Performance issue /cache_dir / cache_mem / SMP workers">squid3 at treenet.co.nz
       </A><BR>
    <I>Sat Nov 24 07:10:37 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="019702.html">[squid-users] Performance issue /cache_dir / cache_mem / SMP	workers
</A></li>
        <LI>Next message (by thread): <A HREF="019655.html">[squid-users] Squid4 with GnuTLS - specify ciphers or disable	protocols
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19706">[ date ]</a>
              <a href="thread.html#19706">[ thread ]</a>
              <a href="subject.html#19706">[ subject ]</a>
              <a href="author.html#19706">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 24/11/18 3:21 am, pacolo wrote:
&gt;<i> Hello again,
</I>&gt;<i> 
</I>&gt;<i> We have found an issue in backend.conf, as the Rock cache_dir is SMP aware.
</I>&gt;<i> 
</I>&gt;<i> Change this...
</I>&gt;<i> #cache_dir rock /cache${process_number} 2097152
</I>&gt;<i> to this...
</I>&gt;<i> cache_dir rock /cache1 2097152
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> ... then the new errors are:
</I>&gt;<i> Nov 23 14:55:28 px06 squid[12559]: ERROR: /cache1/rock communication channel
</I>&gt;<i> establishment timeout
</I>&gt;<i> Nov 23 14:55:28 px06 squid[12559]: FATAL: Rock cache_dir at /cache1/rock
</I>&gt;<i> failed to open db file: (0) No error.
</I>&gt;<i> 
</I>&gt;<i> We have search for in the forum
</I>&gt;<i> (<A HREF="http://squid-web-proxy-cache.1019090.n4.nabble.com/RockStore-quot-Fatal-Error-quot-td4666691.html">http://squid-web-proxy-cache.1019090.n4.nabble.com/RockStore-quot-Fatal-Error-quot-td4666691.html</A>),
</I>&gt;<i> and tried what other people suggested without success.
</I>&gt;<i> 
</I>
If you have a mix of &quot;/cache${process_number}&quot; and &quot;/cache1&quot; in your
config files you may still be mixing SMP-aware and SMP-disabled access
to the &quot;/cache1&quot; path.

By your mention of &quot;backend.conf&quot; I assume you are trying to use
something based on our example SMP CARP cluster configuration.
 If that is correct please compare what you have to the current example
config &lt;<A HREF="https://wiki.squid-cache.org/ConfigExamples/SmpCarpCluster">https://wiki.squid-cache.org/ConfigExamples/SmpCarpCluster</A>&gt;.

It has had a few changes since initially written, and people
copy-pasting it into tutorials without linking back to our info have got
various bugs in their texts. Sometimes because they copied old versions
that no longer work, or because they made arbitrary changes without
properly understanding the consequences.


&gt;<i> 
</I>&gt;<i> /cache1
</I>&gt;<i> drwxr-xr-x 2 squid squid 16384 nov 21 13:05 lost+found
</I>&gt;<i> drwxr-xr-x 2 squid squid  4096 nov 23 12:38 rock
</I>&gt;<i> 
</I>&gt;<i> The permissions in /dev/shm are correct, too. Squid is writing some files.
</I>&gt;<i> ls_-l_dev_shm.txt
</I>&gt;<i> &lt;<A HREF="http://squid-web-proxy-cache.1019090.n4.nabble.com/file/t377599/ls_-l_dev_shm.txt">http://squid-web-proxy-cache.1019090.n4.nabble.com/file/t377599/ls_-l_dev_shm.txt</A>&gt;  
</I>&gt;<i> 
</I>&gt;<i> In addition, it appears that Squid can write in the localstatedir...
</I>&gt;<i> 
</I>&gt;<i> --localstatedir=/var'
</I>&gt;<i> squid_-v.txt
</I>&gt;<i> &lt;<A HREF="http://squid-web-proxy-cache.1019090.n4.nabble.com/file/t377599/squid_-v.txt">http://squid-web-proxy-cache.1019090.n4.nabble.com/file/t377599/squid_-v.txt</A>&gt;  
</I>&gt;<i> 
</I>&gt;<i> /var/run/squid
</I>&gt;<i> srwxr-x--- 1 squid squid 0 nov 23 14:55 squid-coordinator.ipc
</I>&gt;<i> srwxr-x--- 1 squid squid 0 nov 23 14:55 squid-kid-1.ipc
</I>&gt;<i> srwxr-x--- 1 squid squid 0 nov 23 14:55 squid-kid-2.ipc
</I>&gt;<i> srwxr-x--- 1 squid squid 0 nov 23 14:55 squid-kid-3.ipc
</I>&gt;<i> srwxr-x--- 1 squid squid 0 nov 23 13:00 squid-kid-4.ipc
</I>&gt;<i> srwxr-x--- 1 squid squid 0 nov 23 13:00 squid-kid-5.ipc
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> SELinux status:                 disabled
</I>&gt;<i> 
</I>&gt;<i> var_log_messages.txt
</I>&gt;<i> &lt;<A HREF="http://squid-web-proxy-cache.1019090.n4.nabble.com/file/t377599/var_log_messages.txt">http://squid-web-proxy-cache.1019090.n4.nabble.com/file/t377599/var_log_messages.txt</A>&gt;  
</I>&gt;<i> 
</I>
The log you provide has a mixture of multiple process outputs. But
appears to be lacking the &quot;kidN&quot; information Squid attaches to every log
line indicating which ${process_number} is writing to the log.

That makes it very hard to determine the source of SMP issues from a log
like this. Luckily you did provide the whole log and Squid-4 logs this
detail at the startup:

 (squid-coord-4) process 12557 started
 (squid-disk-3) process 12558 started
 (squid-2) process 12559 started
 (squid-1) process 12560 started

The Disker cannot open the configure cache_dir rock:

 Nov 23 14:55:21 px06 squid[12558]: ERROR: cannot open /cache1/rock:
(21) Is a directory

The SMP worker did not receiver any registration response from the
Disker, the cache_dir access fails. Worker aborts and enters into a loop
of constantly dying due to unresponsive Disker.

 Nov 23 14:55:28 px06 squid[12559]: ERROR: /cache1/rock communication
channel establishment timeout
 Nov 23 14:55:28 px06 squid[12559]: Not currently OK to rewrite swap log.
 Nov 23 14:55:28 px06 squid[12559]: storeDirWriteCleanLogs: Operation
aborted.
 Nov 23 14:55:28 px06 squid[12559]: FATAL: Rock cache_dir at
/cache1/rock failed to open db file: (0) No error.


So the fix is to:

1) stop Squid.

2) make sure it is fully shutdown with no residual instances or
processes running.

3) make sure the SMP /dev/shm sockets opened by Squid are fully gone.
Delete manually if necessary.

4) make sure the PID file is fully gone. Delete manually if necessary.

5) erase everything in the /cache1 directory.

5a) optionally: erase any other caches you may have.
  This will speed up the -z process, but only the cache showing errors
actually needs to be fully clean to fix this error message.

6) run &quot;squid -z&quot; manually and wait until it completes.

7) start Squid.


Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="019702.html">[squid-users] Performance issue /cache_dir / cache_mem / SMP	workers
</A></li>
	<LI>Next message (by thread): <A HREF="019655.html">[squid-users] Squid4 with GnuTLS - specify ciphers or disable	protocols
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19706">[ date ]</a>
              <a href="thread.html#19706">[ thread ]</a>
              <a href="subject.html#19706">[ subject ]</a>
              <a href="author.html#19706">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
