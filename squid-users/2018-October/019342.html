<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Uncomplete Negotiate negotiation with Kerberos
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Uncomplete%20Negotiate%20negotiation%20with%20Kerberos&In-Reply-To=%3Cfcfa0f22-8f57-a901-5d38-d0a73b9f90b2%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="019341.html">
   <LINK REL="Next"  HREF="019345.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Uncomplete Negotiate negotiation with Kerberos</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Uncomplete%20Negotiate%20negotiation%20with%20Kerberos&In-Reply-To=%3Cfcfa0f22-8f57-a901-5d38-d0a73b9f90b2%40treenet.co.nz%3E"
       TITLE="[squid-users] Uncomplete Negotiate negotiation with Kerberos">squid3 at treenet.co.nz
       </A><BR>
    <I>Tue Oct  2 12:55:18 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="019341.html">[squid-users] Uncomplete Negotiate negotiation with Kerberos
</A></li>
        <LI>Next message (by thread): <A HREF="019345.html">[squid-users] Uncomplete Negotiate negotiation with Kerberos
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19342">[ date ]</a>
              <a href="thread.html#19342">[ thread ]</a>
              <a href="subject.html#19342">[ subject ]</a>
              <a href="author.html#19342">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 3/10/18 12:32 AM, Emmanuel Coirier wrote:
&gt;<i> Hi everybody !
</I>&gt;<i> 
</I>&gt;<i> Is it desirable that the Negotiate/Kerberos proxy authentication method be interrupted as soon as Squid knows the identity of the browser's user, without letting the browser authenticates Squid in response ?
</I>
That is not possible to happen. The process of authenticating finishes
by telling Squid what the username is.

&gt;<i> 
</I>&gt;<i> When a browser wants to connect to some random HTTP website, it sends a GET request. A proxy wanting to authenticate the browser, via Kerberos, responds with 407, which lets the browser knows that it has to authenticate. Then the browser sends a Kerberos authenticator (in base64 in the Proxy-Authorization header). Then Squid *should* answer back with a Proxy-Authentication-Info letting the browser finish the Kerberos process and validating that it is communicating with the real proxy it wants to use. It is how gss-api is intended to be used.
</I>&gt;<i> 
</I>
That is not true. RFC 4559 section 4
(&lt;<A HREF="https://tools.ietf.org/html/rfc4559#section-4">https://tools.ietf.org/html/rfc4559#section-4</A>&gt;) defines how Negotiate
scheme operates in HTTP.

Notice two things;

 * firstly that there is no mention of *-Authentication-Info headers
anywhere in that specification.

* secondly that the auth tokens are exclusively flowing from the browser
to the server or proxy, not the other way around.




&gt;<i> It was the case with Squid 3.3.8, where Squid answers back, along with the response (200 OK), the Proxy-Authentication-Info header with the final token. But with Squid 4.2, the browser doesn't anymore add this headers, preventing the browser to authenticate back the proxy.
</I>&gt;<i> 
</I>
Squid-4 has been updated to conform to RFC 7615 requirements of these
*-Authentication-Info headers usage which was in fact only previously
defined for use with Digest authentication scheme - not Negotiate.


&gt;<i> The problem is that it enables some potentially Man in the Middle attack (since any malicious proxy where the traffic is diverted could then answers back without the client knowing it talks to a malicious proxy)
</I>&gt;<i> 
</I>
Quite the opposite. The MITM issue you point out is part of the
fundamental design of the Negotiate scheme and exists for both Squid-3
and Squid-4 behaviours.


Having the client use a token provided in-channel from the proxy enables
an MITM observing that channel to inject changes giving itself control
over what the client does in future authentication. This extra control
point is prohibited by the Squid-4 behaviour, and has never been a
formal part of Negotiate scheme as you can see from the RFC 4559 texts.

The design of Negotiate/Kerberos has both client and proxy independently
contact the DC to respectively generate and verify the tokens. All token
operations are performed by the DC itself and contain secrets only the
DC knows. The flow of tokens is exclusively from client to proxy as
proof that the client is already authenticated with the DC. The proxy /
server response is intentionally lacking to starve any MITM of
information it might use to reliably affect changes to the client tokens.



...
&gt;<i> 
</I>&gt;<i> It this behavior endorsed, or is it a bug ?
</I>&gt;<i> 
</I>
The Squid-4 behaviour is &quot;endorsed&quot;. The Squid-3 behaviour was arguably
a bug or more correctly an experimental feature which has now been
removed due to both the increased MITM risk I describe above and how its
content differs in syntax from the RFC 7615 specification.

Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="019341.html">[squid-users] Uncomplete Negotiate negotiation with Kerberos
</A></li>
	<LI>Next message (by thread): <A HREF="019345.html">[squid-users] Uncomplete Negotiate negotiation with Kerberos
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19342">[ date ]</a>
              <a href="thread.html#19342">[ thread ]</a>
              <a href="subject.html#19342">[ subject ]</a>
              <a href="author.html#19342">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
