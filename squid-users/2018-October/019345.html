<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Uncomplete Negotiate negotiation with Kerberos
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Uncomplete%20Negotiate%20negotiation%20with%20Kerberos&In-Reply-To=%3CDEE553E0920CFA41BAF85A4B9C6FC3498F27D10E88%40EXCHANGESRV1.olfeo-lab.net%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="019342.html">
   <LINK REL="Next"  HREF="019348.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Uncomplete Negotiate negotiation with Kerberos</H1>
    <B>Emmanuel Coirier</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Uncomplete%20Negotiate%20negotiation%20with%20Kerberos&In-Reply-To=%3CDEE553E0920CFA41BAF85A4B9C6FC3498F27D10E88%40EXCHANGESRV1.olfeo-lab.net%3E"
       TITLE="[squid-users] Uncomplete Negotiate negotiation with Kerberos">ecoirier at olfeo.com
       </A><BR>
    <I>Tue Oct  2 14:29:10 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="019342.html">[squid-users] Uncomplete Negotiate negotiation with Kerberos
</A></li>
        <LI>Next message (by thread): <A HREF="019348.html">[squid-users] Uncomplete Negotiate negotiation with Kerberos
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19345">[ date ]</a>
              <a href="thread.html#19345">[ thread ]</a>
              <a href="subject.html#19345">[ subject ]</a>
              <a href="author.html#19345">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Amos and others,

Thanks for your response, but I'm afraid I'm not sure to have understood everything...

&gt;<i> De : squid-users [mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>] De la part 
</I>&gt;<i> de Amos Jeffries
</I>
&gt;<i> &gt; When a browser wants to connect to some random HTTP website, it sends a GET 
</I>...
&gt;<i> to be used.
</I>&gt;<i> &gt; 
</I>&gt;<i> 
</I>&gt;<i> That is not true. RFC 4559 section 4
</I>&gt;<i> (&lt;<A HREF="https://tools.ietf.org/html/rfc4559#section-4">https://tools.ietf.org/html/rfc4559#section-4</A>&gt;) defines how Negotiate scheme 
</I>&gt;<i> operates in HTTP.
</I>
Ok

&gt;<i> &gt; The problem is that it enables some potentially Man in the Middle 
</I>&gt;<i> &gt; attack (since any malicious proxy where the traffic is diverted could 
</I>&gt;<i> &gt; then answers back without the client knowing it talks to a malicious 
</I>&gt;<i> &gt; proxy)
</I>&gt;<i> 
</I>&gt;<i> Quite the opposite. The MITM issue you point out is part of the fundamental 
</I>&gt;<i> design of the Negotiate scheme and exists for both Squid-3 and Squid-4 
</I>&gt;<i> behaviours.
</I>
Are you telling me that the Negotiate scheme is fundamentally flawed ?
 
&gt;<i> Having the client use a token provided in-channel from the proxy enables an MITM 
</I>&gt;<i> observing that channel to inject changes giving itself control over what the 
</I>&gt;<i> client does in future authentication. This extra control point is prohibited by 
</I>
I don't understand this point. If we hypothesize that the proxy sends the tokens (including the last one) generated by the service gssapi back to the client (whatever the means), we can think that the gssapi tokens going from service to client are authenticated and encrypted.

With Kerberos, it is possible since the client previously sends a service ticket which contains a random session key encrypted with the service key. The service can use this session key to authentify its response to the client.

So it is harder for a MITM to fake this last gssapi token, especially if the client wait for it. So I don't see how a MITM could exploit this last token.

Clearly, the http body response could be altered, but it can also be altered in the current situation.

Or, is it right that a client cannot trust any form of service authentication based on Negotiate since it is fundamentally flawed ? And thus this last token has no use ?

&gt;<i> the Squid-4 behaviour, and has never been a formal part of Negotiate scheme as 
</I>&gt;<i> you can see from the RFC 4559 texts.
</I>&gt;<i> 
</I>&gt;<i> The design of Negotiate/Kerberos has both client and proxy independently contact 
</I>&gt;<i> the DC to respectively generate and verify the tokens. All token operations are 
</I>
In my undestanding and experiments of Kerberos, the service (here Squid and more precisely its negotiate_kerberos_auth) doesn't contact anything, but only trusts the admin provided keytab (which is just the service key). This service key decrypts a service ticket provided by the client, and if this ticket is fine, the client is authenticated. But it doesn't imply any communication with some KDC (Heimdal for my case) or DC (Or is Microsft Kerberos implementation working differently ?). This has been tested with a KDC shut off when surfing once the service ticket was retrieved.

The client contacts the KDC from time to time to get a service ticket, but it's far less than for each TCP connection.

&gt;<i> performed by the DC itself and contain secrets only the DC knows. The flow of 
</I>&gt;<i> tokens is exclusively from client to proxy as proof that the client is already 
</I>&gt;<i> authenticated with the DC. The proxy / server response is intentionally lacking 
</I>&gt;<i> to starve any MITM of information it might use to reliably affect changes to the 
</I>&gt;<i> client tokens.
</I>
This is the point I don't understand. Could you tell me more ?

Thanks

-- 
Emmanuel Coirier
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="019342.html">[squid-users] Uncomplete Negotiate negotiation with Kerberos
</A></li>
	<LI>Next message (by thread): <A HREF="019348.html">[squid-users] Uncomplete Negotiate negotiation with Kerberos
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19345">[ date ]</a>
              <a href="thread.html#19345">[ thread ]</a>
              <a href="subject.html#19345">[ subject ]</a>
              <a href="author.html#19345">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
