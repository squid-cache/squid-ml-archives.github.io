<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Uncomplete Negotiate negotiation with Kerberos
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Uncomplete%20Negotiate%20negotiation%20with%20Kerberos&In-Reply-To=%3C215ed8c5-b718-562b-2330-6876290de74a%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="019354.html">
   <LINK REL="Next"  HREF="019347.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Uncomplete Negotiate negotiation with Kerberos</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Uncomplete%20Negotiate%20negotiation%20with%20Kerberos&In-Reply-To=%3C215ed8c5-b718-562b-2330-6876290de74a%40treenet.co.nz%3E"
       TITLE="[squid-users] Uncomplete Negotiate negotiation with Kerberos">squid3 at treenet.co.nz
       </A><BR>
    <I>Wed Oct  3 17:37:26 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="019354.html">[squid-users] Uncomplete Negotiate negotiation with Kerberos
</A></li>
        <LI>Next message (by thread): <A HREF="019347.html">[squid-users] sky go App
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19359">[ date ]</a>
              <a href="thread.html#19359">[ thread ]</a>
              <a href="subject.html#19359">[ subject ]</a>
              <a href="author.html#19359">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 4/10/18 3:18 AM, Emmanuel Coirier wrote:
&gt;<i> Hi Amos !
</I>&gt;<i> 
</I>&gt;<i> First thank you for your patience and your answers.
</I>&gt;<i> 
</I>&gt;<i> I agree on the Negotiate/Kerberos workflow, and its security implication. But I have some
</I>&gt;<i> last extra questioning about Kerberos.
</I>&gt;<i> 
</I>&gt;<i> It seems that we disagree on how Kerberos is supposed to work. See lower :
</I>&gt;<i> 
</I>&gt;&gt;&gt;<i> [Client sends a Kerberos Service Ticket to Squid]
</I>&gt;&gt;<i> The client sends such ticket to the proxy, the proxy sends it to the DC.
</I>&gt;<i> 
</I>&gt;<i> What do you consider as a DC ?
</I>&gt;<i> 
</I>&gt;<i> For me and until now, DC meant &quot;Domain Controller&quot;, or &quot;Distribution Center&quot;
</I>&gt;<i> (shorthand for KDC, Kerberos' Key Distribution Center): the trusted third party
</I>&gt;<i> process that can be either MIT/Heimdal Kerberos or MS Active Directory.
</I>&gt;<i> Am I right ?
</I>
That matches my understanding.

&gt;<i> 
</I>&gt;&gt;<i> The DC tells the proxy (&quot;OK allow&quot; or &quot;no deny&quot;). 
</I>&gt;<i> 
</I>&gt;<i> I didn't observed any communication between the negotiate_kerberos_auth helper
</I>&gt;<i> and the DC. The only form of communication is reading requests on the standard input
</I>&gt;<i> (from squid), reading files like a keytab (the service key) and the krb5.cfg
</I>&gt;<i> Kerberos Realm configuration file, and writing responses on the standard output (to Squid).
</I>&gt;<i> No connect() system call, no socket, no IPC to some DC. (And users where correctly
</I>&gt;<i> authenticated, of course)
</I>&gt;<i> 
</I>&gt;<i> And it should be fine since the Kerberos protocol doesn't define any communication
</I>&gt;<i> between a service and a DC.
</I>&gt;<i> 
</I>
I can only hazard a guess that you were not looking at the right place
or time for the server&lt;-&gt;DC communication.

Maybe something to do with your &quot;-s GSS_C_NO_NAME&quot; setting.


&gt;<i> Yesterday I tried a Debian Firefox with a Heimdal Kerberos server. This morning,
</I>&gt;<i> I've tried to use a Firefox on Windows 10, with an account provided from a
</I>&gt;<i> MS Windows Terminal Server 2008 running an Active Directory.
</I>&gt;<i> 
</I>&gt;<i> In either case Firefox was configured to pass trough a Squid instance.
</I>&gt;<i> 
</I>&gt;<i> This Squid instance was configured like this in the two scenarii :
</I>&gt;<i> 
</I>&gt;<i> 	auth_param negotiate program /usr/lib/squid/negotiate_kerberos_auth -s GSS_C_NO_NAME
</I>&gt;<i> 	auth_param negotiate children 1
</I>&gt;<i> 	auth_param negotiate keep_alive on
</I>&gt;<i> 	
</I>&gt;<i> 	acl foobar proxy_auth REQUIRED
</I>&gt;<i> 	http_access allow foobar
</I>&gt;<i> 
</I>&gt;<i> The keytab was configured via the KRB5_KTNAME environment variable like this :
</I>&gt;<i> 
</I>&gt;<i> 	(in the /etc/default/squid file)
</I>&gt;<i> 	export KRB5_KTNAME=FILE:/etc/squid/HTTP.keytab
</I>&gt;<i> 
</I>&gt;<i> This keytab was generated using the Samba &quot;net ads keytab&quot; command for Active Directory,
</I>&gt;<i> and with &quot;kadmin ext&quot; for Heimdal.
</I>&gt;<i> 
</I>&gt;&gt;<i> If that were the case there would be no need for auth_param helpers to be 
</I>&gt;&gt;<i> configured. Squid passes tokens to the helper which handles all contact and 
</I>&gt;&gt;<i> validation with the DC.
</I>&gt;<i> 
</I>&gt;<i> My point is that the Kerberos helper doesn't need any contact with the DC. All it
</I>&gt;<i> has to know is the service key stored in the keytab file. So each new TCP connection
</I>&gt;<i> does not create a contact to the DC. It is what I have observed, but perhaps I'm
</I>&gt;<i> missing something.
</I>
AFAIK the keytab file tells Squid helper what credentials *it* is to use
to login to the DC.


Consider, how is the Squid helper to know that a secret token delivered
by a random unknown client was actually generated by the DC and
validating that clients identity?


&gt;<i> 
</I>&gt;<i> So I need to be sure of this detail because we need to reduce the authentication
</I>&gt;<i> load of some Active Directories (which previously used NTLM), and Kerberos seems
</I>&gt;<i> to be the solution. By telling me that the helper contacts the DC on each TCP
</I>&gt;<i> connection with Kerberos, you puzzles me...
</I>&gt;<i> 
</I>

I have not said that exactly. I have said that every connection needs to
be *authenticated*. There are optimizations built into kerberos that
*may* be used to minimize and/or speedup DC contact unless it is
specifically needed.


I also see another source of confusion there.


NTLM requires 2 HTTP messages to complete the handshake. Kerberos only
uses 1. This is achieved by removing the initial type-1 and type-2 token
exchange out of HTTP and into side-channels defined by the keytab's and
their related info (eg DNS).

By not causing HTTP requests to be repeated as much and waited for this
change alone produces a massive speed increase (seconds vs milliseconds
of latency) and load reduction (helpers not stuck waiting for next HTTP
message to arrive with more tokens for their incomplete auth process).

Notice that these are details at the HTTP level of things. Optimizations
at the level of things like contact with the DC are minuscule compared
to the above benefits.


Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="019354.html">[squid-users] Uncomplete Negotiate negotiation with Kerberos
</A></li>
	<LI>Next message (by thread): <A HREF="019347.html">[squid-users] sky go App
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19359">[ date ]</a>
              <a href="thread.html#19359">[ thread ]</a>
              <a href="subject.html#19359">[ subject ]</a>
              <a href="author.html#19359">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
