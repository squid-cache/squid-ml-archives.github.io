<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Caching ChromeOS update files
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Caching%20ChromeOS%20update%20files&In-Reply-To=%3C9827d7d2-d907-7459-4b09-6d0e46a863fc%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="019363.html">
   <LINK REL="Next"  HREF="019366.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Caching ChromeOS update files</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Caching%20ChromeOS%20update%20files&In-Reply-To=%3C9827d7d2-d907-7459-4b09-6d0e46a863fc%40measurement-factory.com%3E"
       TITLE="[squid-users] Caching ChromeOS update files">rousskov at measurement-factory.com
       </A><BR>
    <I>Wed Oct  3 23:50:39 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="019363.html">[squid-users] Caching ChromeOS update files
</A></li>
        <LI>Next message (by thread): <A HREF="019366.html">[squid-users] acl declaration
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19365">[ date ]</a>
              <a href="thread.html#19365">[ thread ]</a>
              <a href="subject.html#19365">[ subject ]</a>
              <a href="author.html#19365">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 10/03/2018 02:00 PM, Kevin Byers wrote:

&gt;<i> I am trying to setup squid to specifically cache ChromeOS updates for
</I>&gt;<i> Chromebooks but I am currently stuck and lacking the proper knowledge
</I>&gt;<i> to solve the issue.
</I>&gt;<i> Issue #1: The update files are not being cached by squid.
</I>&gt;<i> TCP_MISS_ABORTED/206 messages occur in the squid access.log. I haven't
</I>&gt;<i> seen a HIT yet.
</I>&gt;<i> Issue #2: The update process on the Chromebooks seems to stall when
</I>&gt;<i> they are using squid as the proxy. The Chromebook will show the update
</I>&gt;<i> progress as a percentage increasing in number, and eventually it stops
</I>&gt;<i> changing. After waiting a while with no changes, the Chromebook will
</I>&gt;<i> stop the update process.
</I>&gt;<i> 
</I>&gt;<i> Here's the Chromebook update download logic that squid needs to adapt to:
</I>&gt;<i> A) Chromebooks update by fetching a single file from dl.google.com.
</I>&gt;<i> B) The update files can be up to about 500 megabytes.
</I>&gt;<i> C) Chromebooks always request a partial download (HTTP 206) even if
</I>&gt;<i> they are downloading the full file from the beginning.
</I>&gt;<i> D) Chromebooks will resume downloading the file from a prior partial download.
</I>&gt;<i> E) The HTTP response headers for the files have age:0 and
</I>&gt;<i> cache-control: public,max-age=86400. There is no &quot;partial&quot; attribute.
</I>
&gt;<i> Do any of these above things make it impossible to cache the update files?
</I>
Not necessarily.

As you already know, Squid does not support caching for partial
responses to Range requests (HTTP 206), but you can tell Squid to
request (and cache) the whole update object using a non-Range request
(HTTP 200) and then dole out its ranges as needed (HTTP 206). You are
already using range_offset_limit for that.

If Chromebook range requests are sequential (and start from the
beginning of the update object), this may work well.

You need to figure out where exactly things fail. For example:

1. On the first Chromebook request, does Squid convert Chromebook GET
Range request into a regular GET request (for the whole object; no Range
header)?

2. On the second Chromebook request, does Squid find the previously
fetched whole object in cache? Does Squid consider that cached entry fresh?

If you cannot figure this out, paste HTTP request and response headers
for relevant messages received _and_ sent by Squid (at least 8 messages
for the above two items), and somebody here will probably spot the
problem. Your &quot;debug_options ALL,2&quot; should log these headers to cache.log.


HTH,

Alex.



&gt;<i> Here's the squid configuration that I am using:  <A HREF="https://pastebin.com/m15g84xv">https://pastebin.com/m15g84xv</A>
</I>&gt;<i> Essentially, I increased the cache file size limits to 1 GB and
</I>&gt;<i> allowed only Chromebook IP traffic to squid.
</I>&gt;<i> I am only caching the files in RAM so there is no hard disk cache.
</I>&gt;<i> I created a refresh pattern to keep the update files cached for 7 days.
</I>&gt;<i> The Chromebooks are using a PAC file which only sends dl.google.com
</I>&gt;<i> traffic to squid, so squid is only dealing with dl.google.com traffic.
</I>&gt;<i> 
</I>&gt;<i> I am using squid 3.5.27 on ubuntu 18.04 LTS server edition VM with 2
</I>&gt;<i> vCPUs and 8 GB RAM.
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="019363.html">[squid-users] Caching ChromeOS update files
</A></li>
	<LI>Next message (by thread): <A HREF="019366.html">[squid-users] acl declaration
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19365">[ date ]</a>
              <a href="thread.html#19365">[ thread ]</a>
              <a href="subject.html#19365">[ subject ]</a>
              <a href="author.html#19365">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
