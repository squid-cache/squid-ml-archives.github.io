<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Proxy client certificate authentication rewritten to username/password authentication
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Proxy%20client%20certificate%20authentication%20rewritten%0A%20to%20username/password%20authentication&In-Reply-To=%3C26ef8f8c2ed74888afaad89b9db33c02%40it-ex10.win.ntnu.no%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="019401.html">
   <LINK REL="Next"  HREF="019403.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Proxy client certificate authentication rewritten to username/password authentication</H1>
    <B>Arnt Richard R&#248;rvik</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Proxy%20client%20certificate%20authentication%20rewritten%0A%20to%20username/password%20authentication&In-Reply-To=%3C26ef8f8c2ed74888afaad89b9db33c02%40it-ex10.win.ntnu.no%3E"
       TITLE="[squid-users] Proxy client certificate authentication rewritten to username/password authentication">arnt.r.rorvik at ntnu.no
       </A><BR>
    <I>Tue Oct  9 20:58:40 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="019401.html">[squid-users] Proxy client certificate authentication rewritten to username/password authentication
</A></li>
        <LI>Next message (by thread): <A HREF="019403.html">[squid-users] Proxy client certificate authentication rewritten to username/password authentication
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19402">[ date ]</a>
              <a href="thread.html#19402">[ thread ]</a>
              <a href="subject.html#19402">[ subject ]</a>
              <a href="author.html#19402">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi, Alex!

Thank you for your very kind and intelligent reply!

The origin server does not request any certificates from the client. We can instruct the clients to use the proxy directly, if terminating traffic directly in Squid can easen the implementation.

Furthermore, commenting your additons (&gt;):

&gt;<i> * IIRC, X509 certificates do not contain user names and passwords, at least not in HTTP authentication sense. Where should Squid get the user name and password to add to the URL?
</I>
The general idea is to have a table in Squid (or make accessible such a table from elsewhere) with a number of usernames and passwords, that would match certain placeholders in the startup URL issued by the clients  that would easily and uniquely match a certain pattern, such as

<A HREF="https://www.service4us.com/">https://www.service4us.com/</A> login/dologin.php?username=usernameplaceholder1&amp;password=passwordplaceholder1 for iPad 1
Here, the username- and password placeholder 1 would of course be replaced with the proper usernames and passwords looked up in the aforementioned table before being handed over to the origin server.

&gt;<i> If you detail whether your TLS clients know about Squid existence (i.e. connect to/through Squid),
</I>
That would be possible.

&gt;<i> whether your clients are regular browsers (or custom software you control), 
</I>
This would probably be the standard managed browser on iPads, that is, Safari with policies. They could in theory be anything, but manageability would normally dictate a managed browser.

&gt;<i> and whether your origin servers request client certificates
</I>Nope! :-)

&gt;<i> , then it may be possible to determine whether what you want is or can be supported. To detail your setup, consider describing what happens at TCP, TLS, and HTTP layers between a typical client, Squid, and origin server in your environment.
</I>
We will indeed do a more thorough inspection of how the traffic is performed on the different levels, and ask the origin server vendor for assistance.

Once again - thank you for your very kind and insightful help!


Arnt Richard R&#248;rvik
Senior engineer
Dept. of IT
Section of strategy and governance
Norwegian university of Science and Technology (NTNU), <A HREF="https://www.ntnu.edu/">https://www.ntnu.edu/</A> 
7491 Trondheim
Norway

SfB-address: sip:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">arnt.r.rorvik at ntnu.no</A>
Phone.: +47 73 55 91 67/ Mobile: +47 957 01 081
<A HREF="https://www.ntnu.no/ansatte/arnt.r.rorvik">https://www.ntnu.no/ansatte/arnt.r.rorvik</A>
<A HREF="https://no.linkedin.com/in/arrorvik">https://no.linkedin.com/in/arrorvik</A> 
<A HREF="https://www.youracclaim.com/badges/eaae291f-c686-4e84-b48d-96fa01a37401">https://www.youracclaim.com/badges/eaae291f-c686-4e84-b48d-96fa01a37401</A>




-----Opprinnelig melding-----
Fra: Alex Rousskov &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt; 
Sendt: 9. oktober 2018 22:26
Til: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>; Arnt Richard R&#248;rvik &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">arnt.r.rorvik at ntnu.no</A>&gt;
Emne: Re: [squid-users] Proxy client certificate authentication rewritten to username/password authentication

On 10/09/2018 01:39 PM, Arnt Richard R&#248;rvik wrote:

&gt;<i> Can the Squid web proxy be used to request and verify the machine 
</I>&gt;<i> certificate of workstations trying to initiate a session towards a 
</I>&gt;<i> given web server (outside Squid),
</I>
Yes if by &quot;machine certificate&quot; you mean an X509 certificate that TLS servers can request from TLS clients. Squid supports TLS client certificate request/validation.

Please note that if Squid requests that certificate, then the TLS connection has to be between the client and Squid, not between the client and the origin server. It is impossible for Squid to request a client certificate on a TLS connection that Squid does not participate in (beyond shoveling TCP payload bytes).

If the origin server itself requests a TLS client certificate, then, in theory, Squid can inspect the certificate returned by the client.
However, I doubt such requested-by-origin TLS client certificate inspection works out of the box, and it usually would not make sense in common deployments (because Squid would not have access to the validating CA used to sign the client certificate), but it is technically possible to extract that client certificate from a client-origin connection IIRC -- it is not encrypted -- and validate it against known-to-Squid CAs.


&gt;<i> and, rewrite this session initiation on the way out (towards the the 
</I>&gt;<i> given web server),
</I>
If you want Squid to request the certificate, then the TLS connection has to be between the client and Squid. If needed, Squid will open a TLS connection to the origin server. The two TLS connections are unrelated from TLS point of view.


&gt;<i> adding a username and password in the URL.
</I>
Yes, if client sends plain text requests to Squid, or if Squid bumps encrypted client requests. However:

* TLS client certificate validation is currently not fully compatible with TLS client connection bumping (i.e. SslBump) IIRC.

* When dealing with secure origin servers, popular browsers will not send plain text requests to Squid (i.e. &quot;GET <A HREF="https://example.com">https://example.com</A>&quot;).
Instead, they will want to establish dumb CONNECT tunnels through Squid.
Those tunnels do not expose HTTP request URLs (unless Squid bumps them).

* IIRC, X509 certificates do not contain user names and passwords, at least not in HTTP authentication sense. Where should Squid get the user name and password to add to the URL?

* Rewriting URLs requires using a url_rewrite_program helper or an ICAP/eCAP service.


In summary, various pieces of what you want are supported, but it is unclear what combination of those pieces would be applicable to your exact use case. Most likely, the combination you want is not and cannot be supported.

If you detail whether your TLS clients know about Squid existence (i.e.
connect to/through Squid), whether your clients are regular browsers (or custom software you control), and whether your origin servers request client certificates, then it may be possible to determine whether what you want is or can be supported. To detail your setup, consider describing what happens at TCP, TLS, and HTTP layers between a typical client, Squid, and origin server in your environment.


HTH,

Alex.
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="019401.html">[squid-users] Proxy client certificate authentication rewritten to username/password authentication
</A></li>
	<LI>Next message (by thread): <A HREF="019403.html">[squid-users] Proxy client certificate authentication rewritten to username/password authentication
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19402">[ date ]</a>
              <a href="thread.html#19402">[ thread ]</a>
              <a href="subject.html#19402">[ subject ]</a>
              <a href="author.html#19402">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
