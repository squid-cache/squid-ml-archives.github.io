<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] squid on openwrt: RAM usage and header forgery
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid%20on%20openwrt%3A%20RAM%20usage%20and%20header%20forgery&In-Reply-To=%3Ccb5c15e2-f788-2967-e7b5-c7543027ac7f%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="019405.html">
   <LINK REL="Next"  HREF="019433.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] squid on openwrt: RAM usage and header forgery</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid%20on%20openwrt%3A%20RAM%20usage%20and%20header%20forgery&In-Reply-To=%3Ccb5c15e2-f788-2967-e7b5-c7543027ac7f%40treenet.co.nz%3E"
       TITLE="[squid-users] squid on openwrt: RAM usage and header forgery">squid3 at treenet.co.nz
       </A><BR>
    <I>Wed Oct 10 13:15:53 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="019405.html">[squid-users] squid on openwrt: RAM usage and header forgery
</A></li>
        <LI>Next message (by thread): <A HREF="019433.html">[squid-users] squid on openwrt: RAM usage and header forgery
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19407">[ date ]</a>
              <a href="thread.html#19407">[ thread ]</a>
              <a href="subject.html#19407">[ subject ]</a>
              <a href="author.html#19407">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 10/10/18 8:18 PM, reinerotto wrote:
&gt;<i> 
</I>&gt;<i> Using squid 4.0.24 on openwrt,
</I>
Please upgrade. All 4.0.z versions are beta releases and no longer
supported.

&gt;<i> I see it grabbing significant amount of
</I>&gt;<i> additional RAM after short period of activity, although I tried to downsize
</I>&gt;<i> squid as much as possible. Any suggestion for further significant reduction
</I>&gt;<i> of mem requirements after startup, or why is there such a growth (&gt; 10MB)
</I>&gt;<i> after short period of time ?
</I>
Your machines /proc details below show the large numbers to be virtual,
not real memory usage


&gt;<i> 
</I>&gt;<i> Now mem requirements for kid-1, shortly after boot:
</I>&gt;<i> cat /proc/1447/status
</I>&gt;<i> Name:   squid
</I>...
&gt;<i> VmPeak:    15836 kB &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;
</I>&gt;<i> VmSize:    15836 kB
</I>&gt;<i> VmLck:         0 kB
</I>&gt;<i> VmPin:         0 kB
</I>&gt;<i> VmHWM:     11324 kB
</I>&gt;<i> VmRSS:     11324 kB
</I>&gt;<i> RssAnon:            4596 kB
</I>&gt;<i> RssFile:            6660 kB
</I>&gt;<i> RssShmem:             68 kB
</I>&gt;<i> VmData:     5708 kB &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;
</I>&gt;<i> VmStk:       132 kB
</I>&gt;<i> VmExe:      3744 kB
</I>&gt;<i> VmLib:      4196 kB
</I>&gt;<i> VmPTE:        28 kB
</I>&gt;<i> VmPMD:         0 kB
</I>&gt;<i> VmSwap:        0 kB
</I>
&gt;<i> 
</I>&gt;<i> #1h later, after some usage:
</I>&gt;<i>  cat /proc/1447/status
</I>&gt;<i> Name:   squid
</I>...
&gt;<i> VmPeak:    28844 kB &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;
</I>&gt;<i> VmSize:    28844 kB
</I>&gt;<i> VmLck:         0 kB
</I>&gt;<i> VmPin:         0 kB
</I>&gt;<i> VmHWM:     23064 kB
</I>&gt;<i> VmRSS:     23064 kB
</I>&gt;<i> RssAnon:           15856 kB
</I>&gt;<i> RssFile:            7140 kB
</I>&gt;<i> RssShmem:             68 kB
</I>&gt;<i> VmData:    18716 kB &lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;
</I>&gt;<i> VmStk:       132 kB
</I>&gt;<i> VmExe:      3744 kB
</I>&gt;<i> VmLib:      4196 kB
</I>&gt;<i> VmPTE:        40 kB
</I>&gt;<i> VmPMD:         0 kB
</I>&gt;<i> VmSwap:        0 kB
</I>

Note that the first value you are pointing at in the above report is
*peak* virtual memory usage. In other words the highest *ever* amount of
memory allocated, during all of that &quot;previous usage&quot; traffic going
through the proxy.

The second value is lower, so there is no memory leak nor problems
similar to leaks.


I expect it is the natural outcome of using helpers. The way fork()
operates on most systems is to allocate a block of virtual memory equal
in size to the real memory used at that time by the Squid worker process
starting the helper. It is never actually used by the child/helper
process. So as long as your machine can cope with the size existing in
virtual memory it can be ignored.

Your helpers are external ACL helpers, for which the default behaviour
is to not start any running until Squid is active and the first HTTP
message received.
 The second VmData value is just over 3x the initial VmData value. I
would not be surprised to see 3 helper processes running when that /proc
listing was done.


There have been a few bugs and code polish changes since that old beta
version which have been about memory reductions and improvements. But I
would not expect any major difference, just more streamlined use under load.



The other thing you can do to improve memory usage by Squid is to leave
the memory pools feature *enabled*. That allows you to define how much
memory Squid uses for its pools
(&lt;<A HREF="http://www.squid-cache.org/Doc/config/memory_pools_limit/">http://www.squid-cache.org/Doc/config/memory_pools_limit/</A>&gt;). It also
allows you to look at the cachemgr &quot;mem&quot; report to see what Squid is
using memory for (showing allocation rates, active amounts and peak
values). Without the memory pooling one can only guess at these numbers.

FYI: The doc for that pools limit directive mentions pools as a way to
avoid memory thrashing. Squid allocates and deallocates memory in small
packet-sized blocks at a rate approx 4x that of the traffic being
handled. eg. a 1MB/sec traffic rate will be allocating and then
deallocating around 4MB of memory in that same second.
 The way OS tend to cope with such high turnover cycles from a process
like Squid is to leave free()'d memory reserved in virtual-memory state
for the process that used them last to re-grab. This is also what Squid
pools do, but in a way optimized to also prevent fragmentation issues
accumulating due to each HTTP message being ever so slightly different
in memory needs.


&gt;<i> Initial mem requirements OK, but then the huge increase in size afterwards
</I>&gt;<i> it not appreciated.
</I>&gt;<i> (Don't need caching at all. Compiled without IPv6)
</I>
You do however need to process traffic. Simply receiving that traffic
requires memory allocations, processing the messages requires more, and
so on. All this processing accumulates small bits of information about
the traffic and memory is used to store that data to both produce mgr
reports and to optimize later traffic handling speeds. Without it your
proxy would be very, very slow.



&gt;<i> 
</I>&gt;<i> First the (anon) squid.conf:
</I>&gt;<i> acl localnet src 192.168.182.0/24
</I>&gt;<i> acl ssl_ports port 443
</I>&gt;<i> acl safe_ports port 80
</I>&gt;<i> acl safe_ports port 443
</I>&gt;<i> acl safe_ports port 3128
</I>&gt;<i> acl connect method connect
</I>&gt;<i> 
</I>&gt;<i> http_access deny !safe_ports
</I>&gt;<i> http_access deny connect !ssl_ports
</I>&gt;<i> 
</I>&gt;<i> acl acl1 url_regex -i .*/string1$
</I>&gt;<i> acl acl2 url_regex -i .*/string2$
</I>&gt;<i> acl acl3 url_regex -i .*/string3$
</I>&gt;<i> 
</I>&gt;<i> external_acl_type check_test ttl=0 cache=0 %SRC /etc/squid/check_test.sh
</I>&gt;<i> external_acl_type check_test_2 ttl=30 negative_ttl=3 cache=32 %SRC
</I>&gt;<i> /etc/squid/check_test_2.sh
</I>&gt;<i> acl check_2 check_test_2
</I>&gt;<i> acl check  external check_test
</I>&gt;<i> 
</I>&gt;<i> http_access deny acl1 check
</I>&gt;<i> http_access deny acl2 check
</I>&gt;<i> http_access deny acl3 check
</I>&gt;<i> 
</I>&gt;<i> http_access allow localnet
</I>&gt;<i> http_access allow localhost
</I>&gt;<i> http_access deny all
</I>&gt;<i> 
</I>&gt;<i> cache deny all
</I>&gt;<i> access_log none
</I>&gt;<i> cache_log /var/log/squid/cache.log
</I>&gt;<i> cache_store_log stdio:/dev/null
</I>
Don't do that. Just remove the cache_store_log line entirely from your
config. The store.log has not been enabled by default since Squid-3.0.


&gt;<i> logfile_rotate 0
</I>&gt;<i> logfile_daemon /dev/null
</I>
The above logfile_daemon line can be removed once you upgrade. It was
only needed to workaround bug 4171, which is fixed in the more recent
Squid-4 releases.


&gt;<i> 
</I>&gt;<i> http_port 3128
</I>&gt;<i> http_port 8888 intercept
</I>&gt;<i> 
</I>&gt;<i> https_port 4443  intercept ssl-bump cert=/etc/squid/ssl_cert/myCA.pem \
</I>&gt;<i>   generate-host-certificates=off dynamic_cert_mem_cache_size=1MB
</I>&gt;<i> sslflags=NO_DEFAULT_CA
</I>
Squid-4 release notes:
 &quot;New option tls-default-ca replaces sslflags=NO_DEFAULT_CA, the default
is also changed to OFF.&quot;

So you can remove the about sslflags= option. It does nothing but waste
memory during loading of the config file.



&gt;<i> acl step1 at_step SslBump1
</I>&gt;<i> ssl_bump peek step1 all
</I>&gt;<i> 
</I>&gt;<i> acl sni_block ssl::server_name .a.com
</I>&gt;<i> acl sni_block ssl::server_name .b.com
</I>&gt;<i> acl sni_block ssl::server_name .c.com
</I>&gt;<i> ssl_bump terminate !check_2 sni_block check
</I>&gt;<i> ssl_bump splice all
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> cache_mem 0 MB
</I>&gt;<i> shutdown_lifetime 10 seconds
</I>&gt;<i> httpd_suppress_version_string on
</I>&gt;<i> dns_v4_first on
</I>&gt;<i> forwarded_for delete
</I>&gt;<i> via off
</I>&gt;<i> reply_header_access Cache deny all
</I>
Do you actually see &quot;Cache:&quot; headers in any traffic? if so what do they
mean?

I ask because that header name has recently been proposed for
standardization by the HTTPbis working group at IETF as a formal
mechanism to replace the X-Cache and X-Cache-* headers. There should not
be any existing use of that &quot;Cache:&quot; name and I/we need to make the IETF
working group aware of any existing uses that may clash with the proposal.



&gt;<i> client_idle_pconn_timeout 1 minute
</I>&gt;<i> server_idle_pconn_timeout 5 minute
</I>&gt;<i> memory_pools off
</I>&gt;<i> ipcache_size 128
</I>&gt;<i> fqdncache_size 128
</I>&gt;<i> reply_header_access Alternate-Protocol deny all
</I>&gt;<i> reply_header_access alternate-protocol deny all
</I>
Header names are case-insensitive. The above is duplicate definition and
just wastes memory both at config parsing time, and in the permanent
memory representation of these header mangling rules.


&gt;<i> reply_header_access alt-svc deny all
</I>&gt;<i> pinger_enable off
</I>&gt;<i> digest_generation off
</I>&gt;<i> netdb_filename none
</I>&gt;<i> dns_nameservers 127.0.0.1
</I>&gt;<i> reply_body_max_size 4 MB
</I>&gt;<i> 
</I>&gt;<i> 
</I>...

&gt;<i> 
</I>&gt;<i> I get quite a lot of messages in cache.log:
</I>&gt;<i> 2018/10/09 12:38:49 kid1| ALE missing adapted HttpRequest object
</I>&gt;<i> 2018/10/09 12:38:49 kid1| ALE missing URL
</I>&gt;<i> 2018/10/09 12:38:49 kid1| ALE missing adapted HttpRequest object
</I>&gt;<i> 2018/10/09 12:40:18 kid1| SECURITY ALERT: Host header forgery detected on
</I>&gt;<i> local=212.95.165.32:443 remote=192.168.182.3:51304 FD 36 flags=33 (local IP
</I>&gt;<i> does not match any domain IP)
</I>&gt;<i> 2018/10/09 12:40:18 kid1| SECURITY ALERT: on URL:
</I>&gt;<i> b.scorecardresearch.com:443
</I>&gt;<i> 2018/10/09 12:40:28 kid1| SECURITY ALERT: Host header forgery detected on
</I>&gt;<i> local=104.193.83.156:443 remote=192.168.182.3:51400 FD 183 flags=33 (local
</I>&gt;<i> IP does not match any domain IP)
</I>&gt;<i> 2018/10/09 12:40:28 kid1| SECURITY ALERT: on URL:
</I>&gt;<i> csm2waycm-atl.netmng.com:443
</I>&gt;<i> 2018/10/09 12:40:28 kid1| SECURITY ALERT: Host header forgery detected on
</I>&gt;<i> local=104.193.83.156:443 remote=192.168.182.3:51402 FD 226 flags=33 (local
</I>&gt;<i> IP does not match any domain IP)
</I>&gt;<i> 
</I>&gt;<i> My guess is, that the &quot;header forgery&quot; might be caused be inconsistency
</I>&gt;<i> between browsers DNS-cache, my clients DNS-cache (Win 7) and the DNS-cache
</I>&gt;<i> on the device, running squid. As practically all these &quot;header forgeries&quot;
</I>&gt;<i> are for ad-networks, I consider it only an annoyance.Or is it _not_ ?
</I>&gt;<i> 
</I>
As the warning message says: &quot;local IP does not match any domain IP&quot;.
The client is trying to fetch data from a server which apparently is not
related to the origin server for the domain of the URL being fetched.

With your non-caching configuration it is just an annoyance. At worst it
means one of your clients is infected or being hijacked by a web-bug
script. So something to keep an eye on (thus the notices don't go away),
but not worry overly much about.

The issue of frequent false-positives is usually only seen when there
are very different recursive resolver chains being used to fetch the
information, or the parent resolver in that chain having non-standard
behaviour (as is the case with the 8.8.8.8 DNS services).
 Some things you can do to reduce these type of annoying warnings are
listed at &lt;<A HREF="https://wiki.squid-cache.org/KnowledgeBase/HostHeaderForgery">https://wiki.squid-cache.org/KnowledgeBase/HostHeaderForgery</A>&gt;.

Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="019405.html">[squid-users] squid on openwrt: RAM usage and header forgery
</A></li>
	<LI>Next message (by thread): <A HREF="019433.html">[squid-users] squid on openwrt: RAM usage and header forgery
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19407">[ date ]</a>
              <a href="thread.html#19407">[ thread ]</a>
              <a href="subject.html#19407">[ subject ]</a>
              <a href="author.html#19407">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
