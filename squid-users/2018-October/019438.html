<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] How to create a simple whitelist using regexes?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20How%20to%20create%20a%20simple%20whitelist%20using%20regexes%3F&In-Reply-To=%3CCAM6dNWrfq4NRBuEWOr02BRX5aTU4ZtZMJC1jfSAsOZ-XgFeATw%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="019437.html">
   <LINK REL="Next"  HREF="019439.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] How to create a simple whitelist using regexes?</H1>
    <B>RB</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20How%20to%20create%20a%20simple%20whitelist%20using%20regexes%3F&In-Reply-To=%3CCAM6dNWrfq4NRBuEWOr02BRX5aTU4ZtZMJC1jfSAsOZ-XgFeATw%40mail.gmail.com%3E"
       TITLE="[squid-users] How to create a simple whitelist using regexes?">ronthecon at gmail.com
       </A><BR>
    <I>Mon Oct 15 15:11:31 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="019437.html">[squid-users] How to create a simple whitelist using regexes?
</A></li>
        <LI>Next message (by thread): <A HREF="019439.html">[squid-users] How to create a simple whitelist using regexes?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19438">[ date ]</a>
              <a href="thread.html#19438">[ thread ]</a>
              <a href="subject.html#19438">[ subject ]</a>
              <a href="author.html#19438">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Matus,

Thanks for responding so quickly. I uploaded my configurations here if that
is more helpful: <A HREF="https://bit.ly/2NF4zNb">https://bit.ly/2NF4zNb</A>

The config that I previously shared is called squid_corp.conf. I also
noticed that if I don't use regular expressions and instead use domains, it
works correctly:

# acl whitelist url_regex &quot;/vagrant/squid_sites.txt&quot;
acl whitelist url_regex .squid-cache.org


Every time my squid.conf or my squid_sites.txt is modified, I restart the
squid service

sudo service squid3 restart


Then I use curl to test and now the url works.

$ curl -sSL --proxy localhost:3128 -D -
<A HREF="https://wiki.squid-cache.org/SquidFaq/SquidAcl">https://wiki.squid-cache.org/SquidFaq/SquidAcl</A> -o /dev/null 2&gt;&amp;1
HTTP/1.1 200 Connection established

HTTP/1.1 200 OK
Date: Mon, 15 Oct 2018 14:47:33 GMT
Server: Apache/2.4.7 (Ubuntu)
Vary: Cookie,User-Agent,Accept-Encoding
Content-Length: 101912
Cache-Control: max-age=3600
Expires: Mon, 15 Oct 2018 15:47:33 GMT
Content-Type: text/html; charset=utf-8


But this does not allow me to get more granular. I can only allow all
subdomains and paths for the domain squid-cache.org but I'm unable to only
allow the regular expressions if I put them inline or put them in
squid_sites.txt.

# acl whitelist url_regex &quot;/vagrant/squid_sites.txt&quot;
acl whitelist url_regex ^<A HREF="https://wiki.squid-cache.org/SquidFaq/SquidAcl.*">https://wiki.squid-cache.org/SquidFaq/SquidAcl.*</A>
acl whitelist url_regex .*squid-cache.org/SquidFaq/SquidAcl.*


If I put them inline like I have above, when I restarted squid it says the
following

2018/10/15 14:54:48 kid1| strtokFile: .*squid-cache.org/SquidFaq/SquidAcl.*
not found


If I put the expressions in the squid_sites.txt the above &quot;not found&quot;
message isn't shown and this is the debug output in
/var/log/squid3/cache.log (full output <A HREF="https://pastebin.com/NVwRxVmQ">https://pastebin.com/NVwRxVmQ</A>).

2018/10/15 15:05:45.083 kid1| Checklist.cc(275) matchNode: 0x7fb0068da2b8
matched=1 async=0 finished=0
2018/10/15 15:05:45.083 kid1| Acl.cc(336) matches: ACLList::matches:
checking whitelist
2018/10/15 15:05:45.083 kid1| Acl.cc(319) checklistMatches:
ACL::checklistMatches: checking 'whitelist'
2018/10/15 15:05:45.083 kid1| RegexData.cc(71) match: aclRegexData::match:
checking 'wiki.squid-cache.org:443'
2018/10/15 15:05:45.084 kid1| RegexData.cc(82) match: aclRegexData::match:
looking for '(^
<A HREF="https://wiki.squid-cache.org/SquidFaq/SquidAcl.*">https://wiki.squid-cache.org/SquidFaq/SquidAcl.*</A>)|(squid-cache.org/SquidFaq/SquidAcl.*
)'
2018/10/15 15:05:45.084 kid1| Acl.cc(321) checklistMatches:
ACL::ChecklistMatches: result for 'whitelist' is 0
2018/10/15 15:05:45.084 kid1| Acl.cc(349) matches: whitelist mismatched.
2018/10/15 15:05:45.084 kid1| Acl.cc(354) matches: whitelist result is false


So it's failing the regular expression check. If I use grep to verify if
the regex works, it does.

$ echo <A HREF="https://wiki.squid-cache.org/SquidFaq/SquidAcl">https://wiki.squid-cache.org/SquidFaq/SquidAcl</A> | grep &quot;^
<A HREF="https://wiki.squid-cache.org/SquidFaq/SquidAcl.*">https://wiki.squid-cache.org/SquidFaq/SquidAcl.*</A>&quot;
<A HREF="https://wiki.squid-cache.org/SquidFaq/SquidAcl">https://wiki.squid-cache.org/SquidFaq/SquidAcl</A>


&gt;<i> are you aware that you can only see CONNECT in https requests, unless
</I>using
ssl_bump?

Ah interesting. Are you saying that my https connections will always fail
unless I use ssl_bump to decrypt https to http connections? How would this
work correctly in production? Does squid proxy only block urls if it
detects http? How do you configure ssl_bump to work in this case? and is
that viable in production?

&gt;<i> of course it matches all, everything should match &quot;all&quot;.
</I>&gt;<i> I more wonder why doesn't it match &quot;http_access allow localhost&quot;
</I>
&gt;<i> have you reloaded squid config after changing it?
</I>&gt;<i> Did squid confirm it?
</I>
Would you have an example of one entire config file that would work to
whitelist an http/https url using a regular expression?

Best,


On Mon, Oct 15, 2018 at 4:49 AM Matus UHLAR - fantomas &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">uhlar at fantomas.sk</A>&gt;
wrote:

&gt;<i> KOn 15.10.18 01:04, RB wrote:
</I>&gt;<i> &gt;I'm trying to deny all urls except for only whitelisted regular
</I>&gt;<i> &gt;expressions. I have only this regular expression in my file
</I>&gt;<i> &gt;&quot;squid_sites.txt&quot;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;^<A HREF="https://wiki.squid-cache.org/SquidFaq/SquidAcl.*">https://wiki.squid-cache.org/SquidFaq/SquidAcl.*</A>
</I>&gt;<i>
</I>&gt;<i> are you aware that you can only see CONNECT in https requests, unless using
</I>&gt;<i> ssl_bump?
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt;acl bastion src 10.5.0.0/1
</I>&gt;<i> &gt;acl whitelist url_regex &quot;/vagrant/squid_sites.txt&quot;
</I>&gt;<i> [...]
</I>&gt;<i> &gt;http_access allow manager localhost
</I>&gt;<i> &gt;http_access deny manager
</I>&gt;<i> &gt;http_access deny !Safe_ports
</I>&gt;<i> &gt;http_access allow localhost
</I>&gt;<i> &gt;http_access allow purge localhost
</I>&gt;<i> &gt;http_access deny purge
</I>&gt;<i> &gt;http_access deny CONNECT !SSL_ports
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;http_access allow bastion whitelist
</I>&gt;<i> &gt;http_access deny bastion all
</I>&gt;<i>
</I>&gt;<i> &gt;I tried enabling debugging and tailing /var/log/squid3/cache.log but my
</I>&gt;<i> &gt;curl statement keeps matching &quot;all&quot;.
</I>&gt;<i>
</I>&gt;<i> of course it matches all, everything should match &quot;all&quot;.
</I>&gt;<i>
</I>&gt;<i> I more wonder why doesn't it match &quot;http_access allow localhost&quot;
</I>&gt;<i>
</I>&gt;<i> &gt;$ curl -sSL --proxy localhost:3128 -D - &quot;
</I>&gt;<i> &gt;<A HREF="https://wiki.squid-cache.org/SquidFaq/SquidAcl">https://wiki.squid-cache.org/SquidFaq/SquidAcl</A>&quot; -o /dev/null 2&gt;&amp;1 | grep
</I>&gt;<i> &gt;Squid
</I>&gt;<i> &gt;X-Squid-Error: ERR_ACCESS_DENIED 0
</I>&gt;<i>
</I>&gt;<i> &gt;Any ideas what I'm doing wrong?
</I>&gt;<i>
</I>&gt;<i> have you reloaded squid config after changing it?
</I>&gt;<i> Did squid confirm it?
</I>&gt;<i>
</I>&gt;<i> --
</I>&gt;<i> Matus UHLAR - fantomas, <A HREF="https://lists.squid-cache.org/listinfo/squid-users">uhlar at fantomas.sk</A> ; <A HREF="http://www.fantomas.sk/">http://www.fantomas.sk/</A>
</I>&gt;<i> Warning: I wish NOT to receive e-mail advertising to this address.
</I>&gt;<i> Varovanie: na tuto adresu chcem NEDOSTAVAT akukolvek reklamnu postu.
</I>&gt;<i> It's now safe to throw off your computer.
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20181015/2959fa88/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20181015/2959fa88/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="019437.html">[squid-users] How to create a simple whitelist using regexes?
</A></li>
	<LI>Next message (by thread): <A HREF="019439.html">[squid-users] How to create a simple whitelist using regexes?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19438">[ date ]</a>
              <a href="thread.html#19438">[ thread ]</a>
              <a href="subject.html#19438">[ subject ]</a>
              <a href="author.html#19438">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
