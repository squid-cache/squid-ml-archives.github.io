<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] How to create a simple whitelist using regexes?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20How%20to%20create%20a%20simple%20whitelist%20using%20regexes%3F&In-Reply-To=%3CCAM6dNWrEsYYKuZjdCe0LQR%3DvAwyqx_sVHOD2u94%3DV61zzX4tGA%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="019438.html">
   <LINK REL="Next"  HREF="019440.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] How to create a simple whitelist using regexes?</H1>
    <B>RB</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20How%20to%20create%20a%20simple%20whitelist%20using%20regexes%3F&In-Reply-To=%3CCAM6dNWrEsYYKuZjdCe0LQR%3DvAwyqx_sVHOD2u94%3DV61zzX4tGA%40mail.gmail.com%3E"
       TITLE="[squid-users] How to create a simple whitelist using regexes?">ronthecon at gmail.com
       </A><BR>
    <I>Mon Oct 15 15:56:50 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="019438.html">[squid-users] How to create a simple whitelist using regexes?
</A></li>
        <LI>Next message (by thread): <A HREF="019440.html">[squid-users] How to create a simple whitelist using regexes?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19439">[ date ]</a>
              <a href="thread.html#19439">[ thread ]</a>
              <a href="subject.html#19439">[ subject ]</a>
              <a href="author.html#19439">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I think I know what the issue is which can give us a clue to what is going
on.

2018/10/15 15:05:45.083 kid1| RegexData.cc(71) match: aclRegexData::match:
checking 'wiki.squid-cache.org:443'
2018/10/15 15:05:45.084 kid1| RegexData.cc(82) match: aclRegexData::match:
looking for '(^
<A HREF="https://wiki.squid-cache.org/SquidFaq/SquidAcl.*">https://wiki.squid-cache.org/SquidFaq/SquidAcl.*</A>)|(squid-cache.org/SquidFaq/SquidAcl.*
)'
2018/10/15 15:05:45.084 kid1| Acl.cc(321) checklistMatches:
ACL::ChecklistMatches: result for 'whitelist' is 0

The above seems to be applying the regex to &quot;wiki.squid-cache.org:443&quot;
instead of to &quot;<A HREF="https://wiki.squid-cache.org/SquidFaq/SquidAcl">https://wiki.squid-cache.org/SquidFaq/SquidAcl</A>&quot;. I added the
regex &quot;.*squid-cache.org.*&quot; to my list of regular expressions and now I see
this.

2018/10/15 15:16:03.641 kid1| RegexData.cc(71) match: aclRegexData::match:
checking 'wiki.squid-cache.org:443'
2018/10/15 15:16:03.641 kid1| RegexData.cc(82) match: aclRegexData::match:
looking for '(^https?://[^/]+/
wiki.squid-cache.org/SquidFaq/SquidAcl.*)|(squid-cache.org.*)'
2018/10/15 15:16:03.641 kid1| RegexData.cc(93) match: aclRegexData::match:
match '(^https?://[^/]+/
wiki.squid-cache.org/SquidFaq/SquidAcl.*)|(squid-cache.org.*)' found in '
wiki.squid-cache.org:443'
2018/10/15 15:16:03.641 kid1| Acl.cc(321) checklistMatches:
ACL::ChecklistMatches: result for 'whitelist' is 1


Any idea why url_regex wouldn't try to match the full url and instead only
matches on the subdomain, host domain, and port?

The Squid FAQ &lt;<A HREF="https://wiki.squid-cache.org/SquidFaq/SquidAcl">https://wiki.squid-cache.org/SquidFaq/SquidAcl</A>&gt; says the
following:

*url_regex*: URL regular expression pattern matching
*urlpath_regex*: URL-path regular expression pattern matching, leaves out
the protocol and hostname


with this example given

acl special_url url_regex ^<A HREF="http://www.squid-cache.org/Doc/FAQ/$">http://www.squid-cache.org/Doc/FAQ/$</A>


This seems to be the case between 3.3.8 (default on ubuntu 14.04) and
3.5.12 (default on ubuntu 16.04).

Is there another configuration that forces url_regex to match the entire
url? or should I use a different acl type?

Best,

On Mon, Oct 15, 2018 at 11:11 AM RB &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">ronthecon at gmail.com</A>&gt; wrote:

&gt;<i> Hi Matus,
</I>&gt;<i>
</I>&gt;<i> Thanks for responding so quickly. I uploaded my configurations here if
</I>&gt;<i> that is more helpful: <A HREF="https://bit.ly/2NF4zNb">https://bit.ly/2NF4zNb</A>
</I>&gt;<i>
</I>&gt;<i> The config that I previously shared is called squid_corp.conf. I also
</I>&gt;<i> noticed that if I don't use regular expressions and instead use domains, it
</I>&gt;<i> works correctly:
</I>&gt;<i>
</I>&gt;<i> # acl whitelist url_regex &quot;/vagrant/squid_sites.txt&quot;
</I>&gt;<i> acl whitelist url_regex .squid-cache.org
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Every time my squid.conf or my squid_sites.txt is modified, I restart the
</I>&gt;<i> squid service
</I>&gt;<i>
</I>&gt;<i> sudo service squid3 restart
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Then I use curl to test and now the url works.
</I>&gt;<i>
</I>&gt;<i> $ curl -sSL --proxy localhost:3128 -D -
</I>&gt;<i> <A HREF="https://wiki.squid-cache.org/SquidFaq/SquidAcl">https://wiki.squid-cache.org/SquidFaq/SquidAcl</A> -o /dev/null 2&gt;&amp;1
</I>&gt;<i> HTTP/1.1 200 Connection established
</I>&gt;<i>
</I>&gt;<i> HTTP/1.1 200 OK
</I>&gt;<i> Date: Mon, 15 Oct 2018 14:47:33 GMT
</I>&gt;<i> Server: Apache/2.4.7 (Ubuntu)
</I>&gt;<i> Vary: Cookie,User-Agent,Accept-Encoding
</I>&gt;<i> Content-Length: 101912
</I>&gt;<i> Cache-Control: max-age=3600
</I>&gt;<i> Expires: Mon, 15 Oct 2018 15:47:33 GMT
</I>&gt;<i> Content-Type: text/html; charset=utf-8
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> But this does not allow me to get more granular. I can only allow all
</I>&gt;<i> subdomains and paths for the domain squid-cache.org but I'm unable to
</I>&gt;<i> only allow the regular expressions if I put them inline or put them in
</I>&gt;<i> squid_sites.txt.
</I>&gt;<i>
</I>&gt;<i> # acl whitelist url_regex &quot;/vagrant/squid_sites.txt&quot;
</I>&gt;<i> acl whitelist url_regex ^<A HREF="https://wiki.squid-cache.org/SquidFaq/SquidAcl.*">https://wiki.squid-cache.org/SquidFaq/SquidAcl.*</A>
</I>&gt;<i> acl whitelist url_regex .*squid-cache.org/SquidFaq/SquidAcl.*
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> If I put them inline like I have above, when I restarted squid it says the
</I>&gt;<i> following
</I>&gt;<i>
</I>&gt;<i> 2018/10/15 14:54:48 kid1| strtokFile: .*
</I>&gt;<i> squid-cache.org/SquidFaq/SquidAcl.* not found
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> If I put the expressions in the squid_sites.txt the above &quot;not found&quot;
</I>&gt;<i> message isn't shown and this is the debug output in
</I>&gt;<i> /var/log/squid3/cache.log (full output <A HREF="https://pastebin.com/NVwRxVmQ">https://pastebin.com/NVwRxVmQ</A>).
</I>&gt;<i>
</I>&gt;<i> 2018/10/15 15:05:45.083 kid1| Checklist.cc(275) matchNode: 0x7fb0068da2b8
</I>&gt;<i> matched=1 async=0 finished=0
</I>&gt;<i> 2018/10/15 15:05:45.083 kid1| Acl.cc(336) matches: ACLList::matches:
</I>&gt;<i> checking whitelist
</I>&gt;<i> 2018/10/15 15:05:45.083 kid1| Acl.cc(319) checklistMatches:
</I>&gt;<i> ACL::checklistMatches: checking 'whitelist'
</I>&gt;<i> 2018/10/15 15:05:45.083 kid1| RegexData.cc(71) match: aclRegexData::match:
</I>&gt;<i> checking 'wiki.squid-cache.org:443'
</I>&gt;<i> 2018/10/15 15:05:45.084 kid1| RegexData.cc(82) match: aclRegexData::match:
</I>&gt;<i> looking for '(^
</I>&gt;<i> <A HREF="https://wiki.squid-cache.org/SquidFaq/SquidAcl.*">https://wiki.squid-cache.org/SquidFaq/SquidAcl.*</A>)|(squid-cache.org/SquidFaq/SquidAcl.*
</I>&gt;<i> )'
</I>&gt;<i> 2018/10/15 15:05:45.084 kid1| Acl.cc(321) checklistMatches:
</I>&gt;<i> ACL::ChecklistMatches: result for 'whitelist' is 0
</I>&gt;<i> 2018/10/15 15:05:45.084 kid1| Acl.cc(349) matches: whitelist mismatched.
</I>&gt;<i> 2018/10/15 15:05:45.084 kid1| Acl.cc(354) matches: whitelist result is
</I>&gt;<i> false
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> So it's failing the regular expression check. If I use grep to verify if
</I>&gt;<i> the regex works, it does.
</I>&gt;<i>
</I>&gt;<i> $ echo <A HREF="https://wiki.squid-cache.org/SquidFaq/SquidAcl">https://wiki.squid-cache.org/SquidFaq/SquidAcl</A> | grep &quot;^
</I>&gt;<i> <A HREF="https://wiki.squid-cache.org/SquidFaq/SquidAcl.*">https://wiki.squid-cache.org/SquidFaq/SquidAcl.*</A>&quot;
</I>&gt;<i> <A HREF="https://wiki.squid-cache.org/SquidFaq/SquidAcl">https://wiki.squid-cache.org/SquidFaq/SquidAcl</A>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; are you aware that you can only see CONNECT in https requests, unless
</I>&gt;<i> using
</I>&gt;<i> ssl_bump?
</I>&gt;<i>
</I>&gt;<i> Ah interesting. Are you saying that my https connections will always fail
</I>&gt;<i> unless I use ssl_bump to decrypt https to http connections? How would this
</I>&gt;<i> work correctly in production? Does squid proxy only block urls if it
</I>&gt;<i> detects http? How do you configure ssl_bump to work in this case? and is
</I>&gt;<i> that viable in production?
</I>&gt;<i>
</I>&gt;<i> &gt; of course it matches all, everything should match &quot;all&quot;.
</I>&gt;<i> &gt; I more wonder why doesn't it match &quot;http_access allow localhost&quot;
</I>&gt;<i>
</I>&gt;<i> &gt; have you reloaded squid config after changing it?
</I>&gt;<i> &gt; Did squid confirm it?
</I>&gt;<i>
</I>&gt;<i> Would you have an example of one entire config file that would work to
</I>&gt;<i> whitelist an http/https url using a regular expression?
</I>&gt;<i>
</I>&gt;<i> Best,
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> On Mon, Oct 15, 2018 at 4:49 AM Matus UHLAR - fantomas &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">uhlar at fantomas.sk</A>&gt;
</I>&gt;<i> wrote:
</I>&gt;<i>
</I>&gt;&gt;<i> KOn 15.10.18 01:04, RB wrote:
</I>&gt;&gt;<i> &gt;I'm trying to deny all urls except for only whitelisted regular
</I>&gt;&gt;<i> &gt;expressions. I have only this regular expression in my file
</I>&gt;&gt;<i> &gt;&quot;squid_sites.txt&quot;
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt;^<A HREF="https://wiki.squid-cache.org/SquidFaq/SquidAcl.*">https://wiki.squid-cache.org/SquidFaq/SquidAcl.*</A>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> are you aware that you can only see CONNECT in https requests, unless
</I>&gt;&gt;<i> using
</I>&gt;&gt;<i> ssl_bump?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &gt;acl bastion src 10.5.0.0/1
</I>&gt;&gt;<i> &gt;acl whitelist url_regex &quot;/vagrant/squid_sites.txt&quot;
</I>&gt;&gt;<i> [...]
</I>&gt;&gt;<i> &gt;http_access allow manager localhost
</I>&gt;&gt;<i> &gt;http_access deny manager
</I>&gt;&gt;<i> &gt;http_access deny !Safe_ports
</I>&gt;&gt;<i> &gt;http_access allow localhost
</I>&gt;&gt;<i> &gt;http_access allow purge localhost
</I>&gt;&gt;<i> &gt;http_access deny purge
</I>&gt;&gt;<i> &gt;http_access deny CONNECT !SSL_ports
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt;http_access allow bastion whitelist
</I>&gt;&gt;<i> &gt;http_access deny bastion all
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &gt;I tried enabling debugging and tailing /var/log/squid3/cache.log but my
</I>&gt;&gt;<i> &gt;curl statement keeps matching &quot;all&quot;.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> of course it matches all, everything should match &quot;all&quot;.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I more wonder why doesn't it match &quot;http_access allow localhost&quot;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &gt;$ curl -sSL --proxy localhost:3128 -D - &quot;
</I>&gt;&gt;<i> &gt;<A HREF="https://wiki.squid-cache.org/SquidFaq/SquidAcl">https://wiki.squid-cache.org/SquidFaq/SquidAcl</A>&quot; -o /dev/null 2&gt;&amp;1 | grep
</I>&gt;&gt;<i> &gt;Squid
</I>&gt;&gt;<i> &gt;X-Squid-Error: ERR_ACCESS_DENIED 0
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &gt;Any ideas what I'm doing wrong?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> have you reloaded squid config after changing it?
</I>&gt;&gt;<i> Did squid confirm it?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> --
</I>&gt;&gt;<i> Matus UHLAR - fantomas, <A HREF="https://lists.squid-cache.org/listinfo/squid-users">uhlar at fantomas.sk</A> ; <A HREF="http://www.fantomas.sk/">http://www.fantomas.sk/</A>
</I>&gt;&gt;<i> Warning: I wish NOT to receive e-mail advertising to this address.
</I>&gt;&gt;<i> Varovanie: na tuto adresu chcem NEDOSTAVAT akukolvek reklamnu postu.
</I>&gt;&gt;<i> It's now safe to throw off your computer.
</I>&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;<i> squid-users mailing list
</I>&gt;&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20181015/eaabba43/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20181015/eaabba43/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="019438.html">[squid-users] How to create a simple whitelist using regexes?
</A></li>
	<LI>Next message (by thread): <A HREF="019440.html">[squid-users] How to create a simple whitelist using regexes?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19439">[ date ]</a>
              <a href="thread.html#19439">[ thread ]</a>
              <a href="subject.html#19439">[ subject ]</a>
              <a href="author.html#19439">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
