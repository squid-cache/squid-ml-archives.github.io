<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] How to create a simple whitelist using regexes?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20How%20to%20create%20a%20simple%20whitelist%20using%20regexes%3F&In-Reply-To=%3CCAM6dNWrrF629gQurFqJ5-t_eVCLjGqyoTfvpf_LN%2ByoX0A_puw%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="019439.html">
   <LINK REL="Next"  HREF="019441.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] How to create a simple whitelist using regexes?</H1>
    <B>RB</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20How%20to%20create%20a%20simple%20whitelist%20using%20regexes%3F&In-Reply-To=%3CCAM6dNWrrF629gQurFqJ5-t_eVCLjGqyoTfvpf_LN%2ByoX0A_puw%40mail.gmail.com%3E"
       TITLE="[squid-users] How to create a simple whitelist using regexes?">ronthecon at gmail.com
       </A><BR>
    <I>Mon Oct 15 16:48:53 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="019439.html">[squid-users] How to create a simple whitelist using regexes?
</A></li>
        <LI>Next message (by thread): <A HREF="019441.html">[squid-users] How to create a simple whitelist using regexes?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19440">[ date ]</a>
              <a href="thread.html#19440">[ thread ]</a>
              <a href="subject.html#19440">[ subject ]</a>
              <a href="author.html#19440">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi again...

After some more research it looks like squid only has access to the url
domain if it's HTTPS and the only way to get the url path and query string
is to use ssl_bump to decrypt https so squid can see url path and query
arguments.

To use ssl_bump, I have to compile the code from source with --enable-ssl,
create a certificate, and add it to the chain of certs to every other vm
that proxies through squid, then squid can decrypt the https urls to see
paths and query args and finally apply the regex to those urls in order to
only allow explicit regex urls.

Is this correct?

On Mon, Oct 15, 2018 at 11:56 AM RB &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">ronthecon at gmail.com</A>&gt; wrote:

&gt;<i> I think I know what the issue is which can give us a clue to what is going
</I>&gt;<i> on.
</I>&gt;<i>
</I>&gt;<i> 2018/10/15 15:05:45.083 kid1| RegexData.cc(71) match: aclRegexData::match:
</I>&gt;<i> checking 'wiki.squid-cache.org:443'
</I>&gt;<i> 2018/10/15 15:05:45.084 kid1| RegexData.cc(82) match: aclRegexData::match:
</I>&gt;<i> looking for '(^
</I>&gt;<i> <A HREF="https://wiki.squid-cache.org/SquidFaq/SquidAcl.*">https://wiki.squid-cache.org/SquidFaq/SquidAcl.*</A>)|(squid-cache.org/SquidFaq/SquidAcl.*
</I>&gt;<i> )'
</I>&gt;<i> 2018/10/15 15:05:45.084 kid1| Acl.cc(321) checklistMatches:
</I>&gt;<i> ACL::ChecklistMatches: result for 'whitelist' is 0
</I>&gt;<i>
</I>&gt;<i> The above seems to be applying the regex to &quot;wiki.squid-cache.org:443&quot;
</I>&gt;<i> instead of to &quot;<A HREF="https://wiki.squid-cache.org/SquidFaq/SquidAcl">https://wiki.squid-cache.org/SquidFaq/SquidAcl</A>&quot;. I added
</I>&gt;<i> the regex &quot;.*squid-cache.org.*&quot; to my list of regular expressions and now I
</I>&gt;<i> see this.
</I>&gt;<i>
</I>&gt;<i> 2018/10/15 15:16:03.641 kid1| RegexData.cc(71) match: aclRegexData::match:
</I>&gt;<i> checking 'wiki.squid-cache.org:443'
</I>&gt;<i> 2018/10/15 15:16:03.641 kid1| RegexData.cc(82) match: aclRegexData::match:
</I>&gt;<i> looking for '(^https?://[^/]+/
</I>&gt;<i> wiki.squid-cache.org/SquidFaq/SquidAcl.*)|(squid-cache.org.*
</I>&gt;<i> &lt;<A HREF="http://wiki.squid-cache.org/SquidFaq/SquidAcl.*">http://wiki.squid-cache.org/SquidFaq/SquidAcl.*</A>)%7C(squid-cache.org.*&gt;)'
</I>&gt;<i> 2018/10/15 15:16:03.641 kid1| RegexData.cc(93) match: aclRegexData::match:
</I>&gt;<i> match '(^https?://[^/]+/
</I>&gt;<i> wiki.squid-cache.org/SquidFaq/SquidAcl.*)|(squid-cache.org.*
</I>&gt;<i> &lt;<A HREF="http://wiki.squid-cache.org/SquidFaq/SquidAcl.*">http://wiki.squid-cache.org/SquidFaq/SquidAcl.*</A>)%7C(squid-cache.org.*&gt;)'
</I>&gt;<i> found in 'wiki.squid-cache.org:443'
</I>&gt;<i> 2018/10/15 15:16:03.641 kid1| Acl.cc(321) checklistMatches:
</I>&gt;<i> ACL::ChecklistMatches: result for 'whitelist' is 1
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Any idea why url_regex wouldn't try to match the full url and instead only
</I>&gt;<i> matches on the subdomain, host domain, and port?
</I>&gt;<i>
</I>&gt;<i> The Squid FAQ &lt;<A HREF="https://wiki.squid-cache.org/SquidFaq/SquidAcl">https://wiki.squid-cache.org/SquidFaq/SquidAcl</A>&gt; says the
</I>&gt;<i> following:
</I>&gt;<i>
</I>&gt;<i> *url_regex*: URL regular expression pattern matching
</I>&gt;<i> *urlpath_regex*: URL-path regular expression pattern matching, leaves out
</I>&gt;<i> the protocol and hostname
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> with this example given
</I>&gt;<i>
</I>&gt;<i> acl special_url url_regex ^<A HREF="http://www.squid-cache.org/Doc/FAQ/$">http://www.squid-cache.org/Doc/FAQ/$</A>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> This seems to be the case between 3.3.8 (default on ubuntu 14.04) and
</I>&gt;<i> 3.5.12 (default on ubuntu 16.04).
</I>&gt;<i>
</I>&gt;<i> Is there another configuration that forces url_regex to match the entire
</I>&gt;<i> url? or should I use a different acl type?
</I>&gt;<i>
</I>&gt;<i> Best,
</I>&gt;<i>
</I>&gt;<i> On Mon, Oct 15, 2018 at 11:11 AM RB &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">ronthecon at gmail.com</A>&gt; wrote:
</I>&gt;<i>
</I>&gt;&gt;<i> Hi Matus,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Thanks for responding so quickly. I uploaded my configurations here if
</I>&gt;&gt;<i> that is more helpful: <A HREF="https://bit.ly/2NF4zNb">https://bit.ly/2NF4zNb</A>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The config that I previously shared is called squid_corp.conf. I also
</I>&gt;&gt;<i> noticed that if I don't use regular expressions and instead use domains, it
</I>&gt;&gt;<i> works correctly:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> # acl whitelist url_regex &quot;/vagrant/squid_sites.txt&quot;
</I>&gt;&gt;<i> acl whitelist url_regex .squid-cache.org
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Every time my squid.conf or my squid_sites.txt is modified, I restart the
</I>&gt;&gt;<i> squid service
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> sudo service squid3 restart
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Then I use curl to test and now the url works.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> $ curl -sSL --proxy localhost:3128 -D -
</I>&gt;&gt;<i> <A HREF="https://wiki.squid-cache.org/SquidFaq/SquidAcl">https://wiki.squid-cache.org/SquidFaq/SquidAcl</A> -o /dev/null 2&gt;&amp;1
</I>&gt;&gt;<i> HTTP/1.1 200 Connection established
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> HTTP/1.1 200 OK
</I>&gt;&gt;<i> Date: Mon, 15 Oct 2018 14:47:33 GMT
</I>&gt;&gt;<i> Server: Apache/2.4.7 (Ubuntu)
</I>&gt;&gt;<i> Vary: Cookie,User-Agent,Accept-Encoding
</I>&gt;&gt;<i> Content-Length: 101912
</I>&gt;&gt;<i> Cache-Control: max-age=3600
</I>&gt;&gt;<i> Expires: Mon, 15 Oct 2018 15:47:33 GMT
</I>&gt;&gt;<i> Content-Type: text/html; charset=utf-8
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> But this does not allow me to get more granular. I can only allow all
</I>&gt;&gt;<i> subdomains and paths for the domain squid-cache.org but I'm unable to
</I>&gt;&gt;<i> only allow the regular expressions if I put them inline or put them in
</I>&gt;&gt;<i> squid_sites.txt.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> # acl whitelist url_regex &quot;/vagrant/squid_sites.txt&quot;
</I>&gt;&gt;<i> acl whitelist url_regex ^<A HREF="https://wiki.squid-cache.org/SquidFaq/SquidAcl.*">https://wiki.squid-cache.org/SquidFaq/SquidAcl.*</A>
</I>&gt;&gt;<i> acl whitelist url_regex .*squid-cache.org/SquidFaq/SquidAcl.*
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> If I put them inline like I have above, when I restarted squid it says
</I>&gt;&gt;<i> the following
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> 2018/10/15 14:54:48 kid1| strtokFile: .*
</I>&gt;&gt;<i> squid-cache.org/SquidFaq/SquidAcl.* not found
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> If I put the expressions in the squid_sites.txt the above &quot;not found&quot;
</I>&gt;&gt;<i> message isn't shown and this is the debug output in
</I>&gt;&gt;<i> /var/log/squid3/cache.log (full output <A HREF="https://pastebin.com/NVwRxVmQ">https://pastebin.com/NVwRxVmQ</A>).
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> 2018/10/15 15:05:45.083 kid1| Checklist.cc(275) matchNode: 0x7fb0068da2b8
</I>&gt;&gt;<i> matched=1 async=0 finished=0
</I>&gt;&gt;<i> 2018/10/15 15:05:45.083 kid1| Acl.cc(336) matches: ACLList::matches:
</I>&gt;&gt;<i> checking whitelist
</I>&gt;&gt;<i> 2018/10/15 15:05:45.083 kid1| Acl.cc(319) checklistMatches:
</I>&gt;&gt;<i> ACL::checklistMatches: checking 'whitelist'
</I>&gt;&gt;<i> 2018/10/15 15:05:45.083 kid1| RegexData.cc(71) match:
</I>&gt;&gt;<i> aclRegexData::match: checking 'wiki.squid-cache.org:443'
</I>&gt;&gt;<i> 2018/10/15 15:05:45.084 kid1| RegexData.cc(82) match:
</I>&gt;&gt;<i> aclRegexData::match: looking for '(^
</I>&gt;&gt;<i> <A HREF="https://wiki.squid-cache.org/SquidFaq/SquidAcl.*">https://wiki.squid-cache.org/SquidFaq/SquidAcl.*</A>)|(squid-cache.org/SquidFaq/SquidAcl.*
</I>&gt;&gt;<i> )'
</I>&gt;&gt;<i> 2018/10/15 15:05:45.084 kid1| Acl.cc(321) checklistMatches:
</I>&gt;&gt;<i> ACL::ChecklistMatches: result for 'whitelist' is 0
</I>&gt;&gt;<i> 2018/10/15 15:05:45.084 kid1| Acl.cc(349) matches: whitelist mismatched.
</I>&gt;&gt;<i> 2018/10/15 15:05:45.084 kid1| Acl.cc(354) matches: whitelist result is
</I>&gt;&gt;<i> false
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> So it's failing the regular expression check. If I use grep to verify if
</I>&gt;&gt;<i> the regex works, it does.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> $ echo <A HREF="https://wiki.squid-cache.org/SquidFaq/SquidAcl">https://wiki.squid-cache.org/SquidFaq/SquidAcl</A> | grep &quot;^
</I>&gt;&gt;<i> <A HREF="https://wiki.squid-cache.org/SquidFaq/SquidAcl.*">https://wiki.squid-cache.org/SquidFaq/SquidAcl.*</A>&quot;
</I>&gt;&gt;<i> <A HREF="https://wiki.squid-cache.org/SquidFaq/SquidAcl">https://wiki.squid-cache.org/SquidFaq/SquidAcl</A>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &gt; are you aware that you can only see CONNECT in https requests, unless
</I>&gt;&gt;<i> using
</I>&gt;&gt;<i> ssl_bump?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Ah interesting. Are you saying that my https connections will always fail
</I>&gt;&gt;<i> unless I use ssl_bump to decrypt https to http connections? How would this
</I>&gt;&gt;<i> work correctly in production? Does squid proxy only block urls if it
</I>&gt;&gt;<i> detects http? How do you configure ssl_bump to work in this case? and is
</I>&gt;&gt;<i> that viable in production?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &gt; of course it matches all, everything should match &quot;all&quot;.
</I>&gt;&gt;<i> &gt; I more wonder why doesn't it match &quot;http_access allow localhost&quot;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &gt; have you reloaded squid config after changing it?
</I>&gt;&gt;<i> &gt; Did squid confirm it?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Would you have an example of one entire config file that would work to
</I>&gt;&gt;<i> whitelist an http/https url using a regular expression?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Best,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> On Mon, Oct 15, 2018 at 4:49 AM Matus UHLAR - fantomas &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">uhlar at fantomas.sk</A>&gt;
</I>&gt;&gt;<i> wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> KOn 15.10.18 01:04, RB wrote:
</I>&gt;&gt;&gt;<i> &gt;I'm trying to deny all urls except for only whitelisted regular
</I>&gt;&gt;&gt;<i> &gt;expressions. I have only this regular expression in my file
</I>&gt;&gt;&gt;<i> &gt;&quot;squid_sites.txt&quot;
</I>&gt;&gt;&gt;<i> &gt;
</I>&gt;&gt;&gt;<i> &gt;^<A HREF="https://wiki.squid-cache.org/SquidFaq/SquidAcl.*">https://wiki.squid-cache.org/SquidFaq/SquidAcl.*</A>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> are you aware that you can only see CONNECT in https requests, unless
</I>&gt;&gt;&gt;<i> using
</I>&gt;&gt;&gt;<i> ssl_bump?
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> &gt;acl bastion src 10.5.0.0/1
</I>&gt;&gt;&gt;<i> &gt;acl whitelist url_regex &quot;/vagrant/squid_sites.txt&quot;
</I>&gt;&gt;&gt;<i> [...]
</I>&gt;&gt;&gt;<i> &gt;http_access allow manager localhost
</I>&gt;&gt;&gt;<i> &gt;http_access deny manager
</I>&gt;&gt;&gt;<i> &gt;http_access deny !Safe_ports
</I>&gt;&gt;&gt;<i> &gt;http_access allow localhost
</I>&gt;&gt;&gt;<i> &gt;http_access allow purge localhost
</I>&gt;&gt;&gt;<i> &gt;http_access deny purge
</I>&gt;&gt;&gt;<i> &gt;http_access deny CONNECT !SSL_ports
</I>&gt;&gt;&gt;<i> &gt;
</I>&gt;&gt;&gt;<i> &gt;http_access allow bastion whitelist
</I>&gt;&gt;&gt;<i> &gt;http_access deny bastion all
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> &gt;I tried enabling debugging and tailing /var/log/squid3/cache.log but my
</I>&gt;&gt;&gt;<i> &gt;curl statement keeps matching &quot;all&quot;.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> of course it matches all, everything should match &quot;all&quot;.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> I more wonder why doesn't it match &quot;http_access allow localhost&quot;
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> &gt;$ curl -sSL --proxy localhost:3128 -D - &quot;
</I>&gt;&gt;&gt;<i> &gt;<A HREF="https://wiki.squid-cache.org/SquidFaq/SquidAcl">https://wiki.squid-cache.org/SquidFaq/SquidAcl</A>&quot; -o /dev/null 2&gt;&amp;1 |
</I>&gt;&gt;&gt;<i> grep
</I>&gt;&gt;&gt;<i> &gt;Squid
</I>&gt;&gt;&gt;<i> &gt;X-Squid-Error: ERR_ACCESS_DENIED 0
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> &gt;Any ideas what I'm doing wrong?
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> have you reloaded squid config after changing it?
</I>&gt;&gt;&gt;<i> Did squid confirm it?
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> --
</I>&gt;&gt;&gt;<i> Matus UHLAR - fantomas, <A HREF="https://lists.squid-cache.org/listinfo/squid-users">uhlar at fantomas.sk</A> ; <A HREF="http://www.fantomas.sk/">http://www.fantomas.sk/</A>
</I>&gt;&gt;&gt;<i> Warning: I wish NOT to receive e-mail advertising to this address.
</I>&gt;&gt;&gt;<i> Varovanie: na tuto adresu chcem NEDOSTAVAT akukolvek reklamnu postu.
</I>&gt;&gt;&gt;<i> It's now safe to throw off your computer.
</I>&gt;&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;&gt;<i> squid-users mailing list
</I>&gt;&gt;&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;&gt;&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20181015/4ded9531/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20181015/4ded9531/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="019439.html">[squid-users] How to create a simple whitelist using regexes?
</A></li>
	<LI>Next message (by thread): <A HREF="019441.html">[squid-users] How to create a simple whitelist using regexes?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19440">[ date ]</a>
              <a href="thread.html#19440">[ thread ]</a>
              <a href="subject.html#19440">[ subject ]</a>
              <a href="author.html#19440">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
