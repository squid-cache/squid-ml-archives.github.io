<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] deny_info and CONNECT for https request gives SSL error
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20deny_info%20and%20CONNECT%20for%20https%20request%20gives%20SSL%0A%20error&In-Reply-To=%3C02a57bf8-d124-888a-4a89-80cb0c0aab37%40gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="019452.html">
   <LINK REL="Next"  HREF="019462.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] deny_info and CONNECT for https request gives SSL error</H1>
    <B>Amish</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20deny_info%20and%20CONNECT%20for%20https%20request%20gives%20SSL%0A%20error&In-Reply-To=%3C02a57bf8-d124-888a-4a89-80cb0c0aab37%40gmail.com%3E"
       TITLE="[squid-users] deny_info and CONNECT for https request gives SSL error">anon.amish at gmail.com
       </A><BR>
    <I>Wed Oct 17 02:15:24 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="019452.html">[squid-users] deny_info and CONNECT for https request gives SSL error
</A></li>
        <LI>Next message (by thread): <A HREF="019462.html">[squid-users] deny_info and CONNECT for https request gives SSL error
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19454">[ date ]</a>
              <a href="thread.html#19454">[ thread ]</a>
              <a href="subject.html#19454">[ subject ]</a>
              <a href="author.html#19454">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 16/10/18 10:07 PM, Alex Rousskov wrote:
&gt;<i> On 10/16/2018 10:01 AM, Amish wrote:
</I>&gt;<i>
</I>&gt;&gt;<i> Thing is that squid behaves differently for 2 exactly same CONNECT
</I>&gt;&gt;<i> request with only difference being ssl-bump
</I>&gt;<i> Yes, Squid behaves differently when configured differently.
</I>&gt;<i>
</I>&gt;<i> * My original response was specific to SslBump-enabled Squid ports.
</I>&gt;<i> Today, those configurations assume that the admin wants to bump CONNECTs
</I>&gt;<i> on errors (and has given Squid the certificate to enable such bumping).
</I>&gt;<i>
</I>&gt;<i> * For SslBump-disabled ports (which is the default), Squid has no choice
</I>&gt;<i> but to deny/redirect the CONNECT request itself. Denied/redirected
</I>&gt;<i> CONNECT requests are mishandled by popular browsers -- Squid denial
</I>&gt;<i> errors are not shown to the user, and redirects are not followed.
</I>&gt;<i>
</I>&gt;<i> Please note that the difference is not in matching ssl_bump actions, but
</I>&gt;<i> in whether the corresponding http_port was configured to use SslBump. In
</I>&gt;<i> the former case, whether the ssl_bump rules are checked depends on the
</I>&gt;<i> SslBump step where the CONNECT request is denied/redirected. In the
</I>&gt;<i> second/default case, ssl_bump rules are never checked.
</I>
So if I have following config:

http_port 8080 ssl-bump ...
acl denyit src all
deny_info <A HREF="http://192.168.1.1/blocked.html">http://192.168.1.1/blocked.html</A> denyit
http_access deny denyit
ssl_bump splice all

i.e. ssl-bump enabled on port but splice everything. (test case)

In this case one would expect that squid would not bump the connection 
and return with 307 instead of 200.

But since it already sent 200 Connection Established - there is no 
returning back.
&gt;<i> If you prefer non-SslBump behavior, you should use it, of course! Some
</I>&gt;<i> admins find that browser-generated errors are insufficiently detailed
</I>&gt;<i> and/or produce more support queries than Squid-generated errors. YMMV.
</I>&gt;<i>
</I>&gt;<i> If you want to change SslBump behavior when denying or redirecting
</I>&gt;<i> CONNECT requests, please make a specific proposal, keeping in mind that
</I>&gt;<i> many existing Squid deployments depend on Squid error pages being
</I>&gt;<i> displayed to the user (and/or on Squid redirects followed). Your
</I>&gt;<i> proposal will need to either convince folks that the existing behavior
</I>&gt;<i> should change or add options to optionally enable some new behavior.
</I>
My proposal for would be to add &quot;-n&quot; (nobump) option to deny_info.

If -n is specified then squid will send 307 directly instead of 200.

Case 1)
deny_info <A HREF="http://192.168.1.1/blocked.html">http://192.168.1.1/blocked.html</A> denyit

Return with 200 and bump it (existing behaviour)

Case 2)
deny_info 3xx:<A HREF="http://192.168.1.1/blocked.html">http://192.168.1.1/blocked.html</A> denyit

Return with 200 and bump it (existing behaviour)

Case 3)
deny_info -n <A HREF="http://192.168.1.1/blocked.html">http://192.168.1.1/blocked.html</A> denyit

Return with 307 Temporary Redirect and Location: header

Case 4)
deny_info -n 302:<A HREF="http://192.168.1.1/blocked.html">http://192.168.1.1/blocked.html</A> denyit

Return with 302 Found and Location: header.

Case 1 and 2 above applicable only for sslbump cases.

For non-sslbump it already behaves as 3) and 4) above.


This would not change anything for existing users who want existing 
behaviour.

But allow people like me to *NOT* bump connection when deny_info is 
activated.

Please give a thought,

Thank you,

Amish

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="019452.html">[squid-users] deny_info and CONNECT for https request gives SSL error
</A></li>
	<LI>Next message (by thread): <A HREF="019462.html">[squid-users] deny_info and CONNECT for https request gives SSL error
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19454">[ date ]</a>
              <a href="thread.html#19454">[ thread ]</a>
              <a href="subject.html#19454">[ subject ]</a>
              <a href="author.html#19454">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
