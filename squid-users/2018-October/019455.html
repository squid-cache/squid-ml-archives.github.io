<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] How to create a simple whitelist using regexes?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20How%20to%20create%20a%20simple%20whitelist%20using%20regexes%3F&In-Reply-To=%3Cd5166d90-9659-91dd-7cc9-0c5712bb001f%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="019442.html">
   <LINK REL="Next"  HREF="019443.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] How to create a simple whitelist using regexes?</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20How%20to%20create%20a%20simple%20whitelist%20using%20regexes%3F&In-Reply-To=%3Cd5166d90-9659-91dd-7cc9-0c5712bb001f%40treenet.co.nz%3E"
       TITLE="[squid-users] How to create a simple whitelist using regexes?">squid3 at treenet.co.nz
       </A><BR>
    <I>Wed Oct 17 02:46:04 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="019442.html">[squid-users] How to create a simple whitelist using regexes?
</A></li>
        <LI>Next message (by thread): <A HREF="019443.html">[squid-users] Delay pools and external acl
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19455">[ date ]</a>
              <a href="thread.html#19455">[ thread ]</a>
              <a href="subject.html#19455">[ subject ]</a>
              <a href="author.html#19455">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>In addition to what Matus and Alex have already said about your problem,
you do not appear to understand regex patterns properly.


On 16/10/18 4:11 AM, RB wrote:
&gt;<i> Hi Matus,
</I>&gt;<i> 
</I>&gt;<i> Thanks for responding so quickly. I uploaded my configurations here if
</I>&gt;<i> that is more helpful: <A HREF="https://bit.ly/2NF4zNb">https://bit.ly/2NF4zNb</A>
</I>&gt;<i> 
</I>&gt;<i> The config that I previously shared is called squid_corp.conf. I also
</I>&gt;<i> noticed that if I don't use regular expressions and instead use domains,
</I>&gt;<i> it works correctly:
</I>&gt;<i> 
</I>&gt;<i>     # acl whitelist url_regex &quot;/vagrant/squid_sites.txt&quot;
</I>&gt;<i>     acl whitelist url_regex .squid-cache.org
</I>
This is still a regex. The ACL type is &quot;url_regex&quot; which makes the
string a regex - no matter what it looks like to your human eyes. To
Squid it is a regex.

It will match things like <A HREF="http://example.com/sZsquid-cacheXORG">http://example.com/sZsquid-cacheXORG</A> just
easily as any sub-domain of squid-cache.org. For example any traffic
injecting our squid-cache.org domain into their path or query-string.



&gt;<i> 
</I>&gt;<i> Every time my squid.conf or my squid_sites.txt is modified, I restart
</I>&gt;<i> the squid service
</I>&gt;<i> 
</I>&gt;<i>     sudo service squid3 restart
</I>&gt;<i> 
</I>
If Squid does not accept the config file it will not necessarily restart.

You should always run &quot;squid -k parse&quot; or &quot;squid3 -k parse&quot; to check the
config before attempting a restart.


The old Debian sysV init scripts had some protections that would protect
you from problems. But the newer systemd &quot;service&quot; systems are not able
to do that in a nice way. The habit is a good one to get into anyway.


&gt;<i> 
</I>&gt;<i> Then I use curl to test and now the url works.&#160;
</I>&gt;<i> 
</I>&gt;<i>     $ curl -sSL --proxy localhost:3128 -D -
</I>&gt;<i>     <A HREF="https://wiki.squid-cache.org/SquidFaq/SquidAcl-o">https://wiki.squid-cache.org/SquidFaq/SquidAcl-o</A> /dev/null 2&gt;&amp;1
</I>&gt;<i>     HTTP/1.1 200 Connection established
</I>&gt;<i> 
</I>&gt;<i>     HTTP/1.1 200 OK
</I>&gt;<i>     Date: Mon, 15 Oct 2018 14:47:33 GMT
</I>&gt;<i>     Server: Apache/2.4.7 (Ubuntu)
</I>&gt;<i>     Vary: Cookie,User-Agent,Accept-Encoding
</I>&gt;<i>     Content-Length: 101912
</I>&gt;<i>     Cache-Control: max-age=3600
</I>&gt;<i>     Expires: Mon, 15 Oct 2018 15:47:33 GMT
</I>&gt;<i>     Content-Type: text/html; charset=utf-8
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> But this does not allow me to get more granular. I can only allow all
</I>&gt;<i> subdomains and paths for the domain squid-cache.org
</I>&gt;<i> &lt;<A HREF="http://squid-cache.org">http://squid-cache.org</A>&gt; but I'm unable to only allow the regular
</I>&gt;<i> expressions if I put them inline or put them in squid_sites.txt.
</I>&gt;<i> 
</I>&gt;<i>     # acl whitelist url_regex &quot;/vagrant/squid_sites.txt&quot;
</I>&gt;<i>     acl whitelist url_regex
</I>&gt;<i>     ^<A HREF="https://wiki.squid-cache.org/SquidFaq/SquidAcl.*">https://wiki.squid-cache.org/SquidFaq/SquidAcl.*</A>
</I>&gt;<i>     acl whitelist url_regex .*squid-cache.org/SquidFaq/SquidAcl.*
</I>
Any regex pattern that lacks the beginning (^) and ending ($) anchor
symbols is always a match against *anywhere* in the input string.

So starting it with an optional prefix (.* or .?) or ending it with an
optional suffix (.* or .?) is pointless and confusing.


Notice how the pattern Squid is actually using lacks these prefix/suffix
parts or your patterns:

&gt;<i>     aclRegexData::match: looking for
</I>&gt;<i>     '(^<A HREF="https://wiki.squid-cache.org/SquidFaq/SquidAcl.*">https://wiki.squid-cache.org/SquidFaq/SquidAcl.*</A>)|(squid-cache.org/SquidFaq/SquidAcl.*)'
</I>

&gt;<i> 
</I>&gt;&gt;<i> are you aware that you can only see CONNECT in https requests, unless using
</I>&gt;<i> ssl_bump?
</I>&gt;<i> 
</I>&gt;<i> Ah interesting. Are you saying that my https connections will always
</I>&gt;<i> fail 
</I>
They will always fail to match your current regex, because your current
regex contain characters which are only ever existing in path portions
of URLs (note the *L*). Never in a CONNECT message URI (note the *I*)
which never contains any path portion.


&gt;<i> unless I use ssl_bump to decrypt https to http connections? How
</I>&gt;<i> would this work correctly in production? Does squid proxy only block
</I>&gt;<i> urls if it detects http? How do you configure ssl_bump to work in this
</I>&gt;<i> case? and is that viable in production?
</I>
SSL-Bump is to take the CONNECT tunnel data/payload portion and
_attempt_ decrypt any TLS inside. *If* the tunnel contains HTTPS traffic
(not guaranteed) that is where the full <A HREF="https://">https://</A> ... URLs are found.

Matus and Alex have already mentioned the issues with that so I wont
cover it again.

Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="019442.html">[squid-users] How to create a simple whitelist using regexes?
</A></li>
	<LI>Next message (by thread): <A HREF="019443.html">[squid-users] Delay pools and external acl
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19455">[ date ]</a>
              <a href="thread.html#19455">[ thread ]</a>
              <a href="subject.html#19455">[ subject ]</a>
              <a href="author.html#19455">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
