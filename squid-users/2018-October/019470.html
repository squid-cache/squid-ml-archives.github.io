<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] deny_info and CONNECT for https request gives SSL error
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20deny_info%20and%20CONNECT%20for%20https%20request%20gives%20SSL%0A%20error&In-Reply-To=%3Cb02bb1c3-4b5f-0131-2df7-fa1caba19a20%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="019464.html">
   <LINK REL="Next"  HREF="019467.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] deny_info and CONNECT for https request gives SSL error</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20deny_info%20and%20CONNECT%20for%20https%20request%20gives%20SSL%0A%20error&In-Reply-To=%3Cb02bb1c3-4b5f-0131-2df7-fa1caba19a20%40treenet.co.nz%3E"
       TITLE="[squid-users] deny_info and CONNECT for https request gives SSL error">squid3 at treenet.co.nz
       </A><BR>
    <I>Thu Oct 18 03:34:45 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="019464.html">[squid-users] deny_info and CONNECT for https request gives SSL error
</A></li>
        <LI>Next message (by thread): <A HREF="019467.html">[squid-users] deny_info and CONNECT for https request gives SSL error
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19470">[ date ]</a>
              <a href="thread.html#19470">[ thread ]</a>
              <a href="subject.html#19470">[ subject ]</a>
              <a href="author.html#19470">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 18/10/18 1:08 AM, Amish wrote:
&gt;<i> On 17/10/18 10:37 AM, Amos Jeffries wrote:
</I>&gt;&gt;<i> On 17/10/18 3:15 PM, Amish wrote:
</I>&gt;&gt;&gt;<i> My proposal for would be to add &quot;-n&quot; (nobump) option to deny_info.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> If -n is specified then squid will send 307 directly instead of 200.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Case 1)
</I>&gt;&gt;&gt;<i> deny_info <A HREF="http://192.168.1.1/blocked.html">http://192.168.1.1/blocked.html</A> denyit
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Return with 200 and bump it (existing behaviour)
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Case 2)
</I>&gt;&gt;&gt;<i> deny_info 3xx:<A HREF="http://192.168.1.1/blocked.html">http://192.168.1.1/blocked.html</A> denyit
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Return with 200 and bump it (existing behaviour)
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Case 3)
</I>&gt;&gt;&gt;<i> deny_info -n <A HREF="http://192.168.1.1/blocked.html">http://192.168.1.1/blocked.html</A> denyit
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Return with 307 Temporary Redirect and Location: header
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Case 4)
</I>&gt;&gt;&gt;<i> deny_info -n 302:<A HREF="http://192.168.1.1/blocked.html">http://192.168.1.1/blocked.html</A> denyit
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Return with 302 Found and Location: header.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Case 1 and 2 above applicable only for sslbump cases.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> For non-sslbump it already behaves as 3) and 4) above.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> This would not change anything for existing users who want existing
</I>&gt;&gt;&gt;<i> behaviour.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> But allow people like me to *NOT* bump connection when deny_info is
</I>&gt;&gt;&gt;<i> activated.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i> IMO the deny_info is very much the wrong place to be making such
</I>&gt;&gt;<i> decisions. Its purpose is to supply the *content* of the denial message
</I>&gt;&gt;<i> itself. Nothing about how that message gets delivered.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> If anything this would be an additional ssl-bump option on the port line
</I>&gt;&gt;<i> to say that traffic is not really being ssl-bump'ed despite the presence
</I>&gt;&gt;<i> of the ssl-bump setting.
</I>&gt;<i> 
</I>&gt;<i> If its additional ssl-bump option then it would become a global thing.
</I>&gt;<i> 
</I>&gt;<i> If its on deny_info then for some ACLs I can select to bump and for
</I>&gt;<i> others not. (i.e. gives finer control)
</I>&gt;<i> 
</I>&gt;&gt;<i> So think about that - why bother putting &quot;ssl-bump&quot; on the port in the
</I>&gt;&gt;<i> first place if the behaviour that option enables is not wanted to ever
</I>&gt;&gt;<i> happen?
</I>&gt;<i> 
</I>&gt;<i> I need SSL bump because I am bumping few domains and splicing rest.
</I>&gt;<i> 
</I>
... and you have a third case:

 Replace TLS ServerHello with a plain-text HTTP 3xx response.

Your intended redirect of the CONNECT tunnel includes traffic where the
client has already sent the 0-RTT TLS clientHello along with the CONNECT.


&gt;<i> But for blocked domains I prefer browser to show &quot;Proxy refused the
</I>&gt;<i> connection&quot; instead of SSL error.
</I>
When the proxy is *actually* refusing (403) the connection, that makes
sense. All the other non-200 status responses, including your 3xx
redirect also show that error page generated by the Browser.

Bumping is forced on us by that Browser behaviour. Without the bump your
redirect response has zero chance of working as you obviously want it
to. If you were happy with the Browsers error page you would not be
trying to redirect the CONNECT.


&gt;<i> 
</I>&gt;<i> Also browsers not respecting code other than 200 or 407 is actually a
</I>&gt;<i> browser bug. Hopefully corrected in future someday.
</I>&gt;<i> 
</I>
We call it a bug they call it intentionally designed behaviour.

Browsers used to support non-200 responses. That support has actively
and systematically been removed.



&gt;<i> May be browsers will start supporting 302/307 Location header someday,
</I>&gt;<i> for CONNECT requests too?
</I>
They used to support 301 until early 2010's. Then it was replaced with
that blanket &quot;Proxy is refusing connections&quot; error message on grounds
that MITM proxies were using 301 to display content to users.


&gt;<i> 
</I>&gt;<i> (ofcourse I am not RFC expert so I may be completely wrong to interpret it)
</I>&gt;<i> 
</I>
These issues have nothing to do with the RFCs (which mandate proxy
support), and everything to do with Browser folks interests and design
choices being different from other folks needs and interests.

Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="019464.html">[squid-users] deny_info and CONNECT for https request gives SSL error
</A></li>
	<LI>Next message (by thread): <A HREF="019467.html">[squid-users] deny_info and CONNECT for https request gives SSL error
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19470">[ date ]</a>
              <a href="thread.html#19470">[ thread ]</a>
              <a href="subject.html#19470">[ subject ]</a>
              <a href="author.html#19470">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
