<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Delay pools and external acl
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Delay%20pools%20and%20external%20acl&In-Reply-To=%3CCAHaQnLPf0w%2BaZAKzRdkoP6WYY4CUZ6XfVkeudh3R1XpujEChzg%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="019458.html">
   <LINK REL="Next"  HREF="019475.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Delay pools and external acl</H1>
    <B>Danilo V</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Delay%20pools%20and%20external%20acl&In-Reply-To=%3CCAHaQnLPf0w%2BaZAKzRdkoP6WYY4CUZ6XfVkeudh3R1XpujEChzg%40mail.gmail.com%3E"
       TITLE="[squid-users] Delay pools and external acl">danilovt at gmail.com
       </A><BR>
    <I>Thu Oct 18 13:23:40 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="019458.html">[squid-users] Delay pools and external acl
</A></li>
        <LI>Next message (by thread): <A HREF="019475.html">[squid-users] Delay pools and external acl
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19474">[ date ]</a>
              <a href="thread.html#19474">[ thread ]</a>
              <a href="subject.html#19474">[ subject ]</a>
              <a href="author.html#19474">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi, thanks for your message.

Not working yet. Please check where is my mistake.

I implemented a custom external ACL that checks on active directory via
ldap if a user is member of a particular group. If success returns:
OK group=Internet_Access
Else returns:
ERR

Squid.conf:
http_port 3128
auth_param basic program /usr/lib/squid/basic_ldap_auth -v 3 -b
dc=lab-novo,dc=br,dc=local -R -D
cn=ldap_proxy,ou=gestao_proxy,dc=lab-novo,dc=br,dc=local -w xxx -f
&quot;sAMAccountName=%s&quot; -u uid -P 10.0.0.1:389
acl login proxy_auth REQUIRED
http_access deny !login
external_acl_type group ttl=360 ipv4 %LOGIN /ext_danilo_ldap_group.sh
acl some_group external group Internet_Access
acl groupInternet note group Internet_Access
delay_pools 1
delay_class 1 1
delay_parameters 1 128000/128000
delay_access 1 allow groupInternet

Sqstat confirms that the bandwidth is not being limited.


Date: Wed, 17 Oct 2018 16:38:03 +1300
From: Amos Jeffries &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt;
To: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
Subject: Re: [squid-users] Delay pools and external acl
Message-ID: &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">c672c10a-e18f-8f4b-325b-62dd7bd2272f at treenet.co.nz</A>&gt;
Content-Type: text/plain; charset=utf-8

On 16/10/18 11:09 AM, Danilo V wrote:
&gt;<i> Hi all,
</I>&gt;<i>
</I>&gt;<i> Has anyone succeeded applying delay pools on groups from AD?
</I>&gt;<i>
</I>&gt;<i> I'm using squid 3.5.23 with basic_ldap_auth.
</I>&gt;<i> I initially tried to combine mapping groups with external acl type
</I>&gt;<i> (ext_ldap_group_acl) to delay pools. It's a trap :-(
</I>&gt;<i>
</I>
A trap?

For starters; &quot;group&quot; is an abstract concept buried in the depths of
authentication which has nothing to do with traffic. It is a purely
human scoping idea. Squid knows nothing of any &quot;group&quot;.


The external ACL type which handles such complex non-traffic things is
clearly listed in the Squid FAQ (and the 'acl' directive documentation)
as being a &quot;slow&quot; / async ACL type.

Delay pools is also clearly listed as an access control which only works
with &quot;fast&quot; category ACL types.

&lt;<A HREF="https://wiki.squid-cache.org/SquidFaq/SquidAcl#Fast_and_Slow_ACLs">https://wiki.squid-cache.org/SquidFaq/SquidAcl#Fast_and_Slow_ACLs</A>&gt;



&gt;<i> After doing more search I found about class 5 and note acl.
</I>&gt;<i> Has anyone a pratical implementation in this scenario?
</I>
Yes several admin have done so. But with custom helpers that integrate
with the new annotation system, or the Kerberos helpers that have been
upgraded to integrate as well. Other helpers have not been updated yet.


Your external ACL just needs to supply Squid with a &quot;tag=XX&quot; or
&quot;group=XX &quot; annotation to label the transaction with whichever group
matches.

 # login is required to do group checking...
 acl login proxy_auth REQUIRED
 http_access deny !login


 # the decision to allow the traffic into the proxy does group checks
and adds annotations...

 external_acl_type group %LOGIN ...
 acl some_group external group XX

 http_access allow some_group_check


 # the decision of what pool(s) to apply has to work FAST - so uses the
annotations already present or not present) as its decider:

 acl groupXX note group XX

 # or for older Squid
 acl groupXX note tag XX

 delay_access N allow groupXX


Amos
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20181018/ec5d9c1b/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20181018/ec5d9c1b/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="019458.html">[squid-users] Delay pools and external acl
</A></li>
	<LI>Next message (by thread): <A HREF="019475.html">[squid-users] Delay pools and external acl
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19474">[ date ]</a>
              <a href="thread.html#19474">[ thread ]</a>
              <a href="subject.html#19474">[ subject ]</a>
              <a href="author.html#19474">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
