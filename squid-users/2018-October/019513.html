<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] squid transparent proxy forward loop
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid%20transparent%20proxy%20forward%20loop&In-Reply-To=%3Cdd3a7f5f-8dbf-3fc4-a9b0-e1120374717b%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="019512.html">
   <LINK REL="Next"  HREF="019538.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] squid transparent proxy forward loop</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid%20transparent%20proxy%20forward%20loop&In-Reply-To=%3Cdd3a7f5f-8dbf-3fc4-a9b0-e1120374717b%40treenet.co.nz%3E"
       TITLE="[squid-users] squid transparent proxy forward loop">squid3 at treenet.co.nz
       </A><BR>
    <I>Mon Oct 22 13:12:01 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="019512.html">[squid-users] squid transparent proxy forward loop
</A></li>
        <LI>Next message (by thread): <A HREF="019538.html">[squid-users] squid transparent proxy forward loop
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19513">[ date ]</a>
              <a href="thread.html#19513">[ thread ]</a>
              <a href="subject.html#19513">[ subject ]</a>
              <a href="author.html#19513">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 23/10/18 1:26 AM, Juan Carvajal B. wrote:
&gt;<i> Dear list,
</I>&gt;<i> 
</I>&gt;<i> I hope you can give me some hints for my current task.
</I>&gt;<i> 
</I>&gt;<i> I would like to achieve the following:
</I>&gt;<i> 
</I>&gt;<i> 1. A user comes with the own device, for example phone or table.
</I>&gt;<i> 2. The user connects to our own WLAN network
</I>&gt;<i> 4. The user enters the addres of our website
</I>&gt;<i> 3. The user can only access our website, which is hosted in a sever *not
</I>&gt;<i> connected* to the internet.
</I>&gt;<i> 
</I>&gt;<i> We have the following set up
</I>&gt;<i> 
</I>&gt;<i> Tablets / phones &lt;---&gt; WLAN router &lt;---&gt; server
</I>&gt;<i> 
</I>&gt;<i> please note that there is *no* connection to internet. The server is
</I>&gt;<i> connected to the &quot;internet&quot; port of the router.
</I>&gt;<i> 
</I>&gt;<i> The server runs ubuntu &amp; apache.
</I>&gt;<i> 
</I>&gt;<i> I've been trying to achieve this with squid but I get a **warning of a
</I>&gt;<i> forwarding loop**. I do not know what I'm doing wrong.
</I>&gt;<i> 
</I>&gt;<i> I'm following this:
</I>&gt;<i> <A HREF="https://wiki.squid-cache.org/ConfigExamples/Intercept/LinuxRedirect">https://wiki.squid-cache.org/ConfigExamples/Intercept/LinuxRedirect</A>
</I>&gt;<i> <A HREF="https://wiki.squid-cache.org/SquidFaq/ReverseProxy">https://wiki.squid-cache.org/SquidFaq/ReverseProxy</A>
</I>&gt;<i> 
</I>&gt;<i> Here are my conf files:
</I>&gt;<i> 
</I>&gt;<i> ****squid.conf****
</I>&gt;<i> 
</I>

&gt;<i>     visible_hostname squid.proxy
</I>
I have seen other people using this &quot;squid.proxy&quot; as the FQDN of their
proxy. It is likely that your chosen proxy hostname is not unique.

Since this is a reverse-proxy it is best to set this to the FQDN of the
primary website you are proxying.



&gt;<i> &#160;&#160;&#160; http_port 3128 intercept
</I>&gt;<i> &#160;&#160;&#160; http_port 192.168.0.188:80 accel
</I>&gt;<i> defaultsite=our.domain.org
</I>&gt;<i> &#160;&#160;&#160; http_port 192.168.0.188:443 accel
</I>&gt;<i> defaultsite=our.domain.org
</I>
The above should be https_port and requires the TLS certificate for the
domain being virtual-hosted.

see
&lt;<A HREF="https://wiki.squid-cache.org/ConfigExamples/Reverse/HttpsVirtualHosting">https://wiki.squid-cache.org/ConfigExamples/Reverse/HttpsVirtualHosting</A>&gt; which
I added just yesterday.


&gt;<i> &#160;&#160;&#160; cache_peer 127.0.0.1 parent 80 0 no-query originserver name=myAccel
</I>&gt;<i> &#160;&#160;&#160; acl our_sites dstdomain our.domain.org
</I>&gt;<i> &#160;&#160;&#160; http_access allow our_sites
</I>&gt;<i> &#160;&#160;&#160; cache_peer_access myAccel allow our_sites
</I>&gt;<i> &#160;&#160;&#160; cache_peer_access myAccel deny all
</I>
Move the above custom configuration down to ...

&gt;<i> &#160;&#160;&#160; acl SSL_ports port 443
</I>&gt;<i> &#160;&#160;&#160; acl CONNECT method CONNECT
</I>&gt;<i> &#160;&#160;&#160; http_access deny !Safe_ports
</I>
You do not have any definition of Safe_ports above. It should contain at
least 80 and 443 for your proxy.

&gt;<i> &#160;&#160;&#160; http_access deny CONNECT !SSL_ports
</I>&gt;<i> &#160;&#160;&#160; http_access allow localhost manager
</I>&gt;<i> &#160;&#160;&#160; http_access deny manager
</I>
... here.


You are missing good rules for traffic arriving on the port 3128. The
below &quot;allow all&quot; is very bad.


&gt;<i> &#160;&#160;&#160; http_access allow localhost
</I>&gt;<i> &#160;&#160;&#160; http_access allow all
</I>
That should be:

 http_access deny all


...

&gt;<i> ****IPTABLES****
</I>&gt;<i> 
</I>&gt;<i> &#160;&#160;&#160; # your proxy IP
</I>&gt;<i> &#160;&#160;&#160; SQUIDIP=192.168.0.188
</I>&gt;<i> &#160;&#160;&#160; # your proxy listening port
</I>&gt;<i> &#160;&#160;&#160; SQUIDPORT=3128
</I>&gt;<i> &#160;&#160;&#160; iptables -t nat -A PREROUTING -s $SQUIDIP -p tcp --dport 80 -j ACCEPT
</I>&gt;<i> &#160;&#160;&#160; iptables -t nat -A PREROUTING -p tcp --dport 80 -j REDIRECT
</I>&gt;<i> --to-port $SQUIDPORT
</I>&gt;<i> 
</I>
Here is your problem. You have not bypassed the traffic Squid is sending
to 127.0.0.1:80.

Traffic to/from localhost does not use global IP addresses such as
192.168.0.188. Thus Squid's attempts to send traffic to Apache is being
looped back into port 3128 by iptables.


What is the point of all this interception anyway?

Your proxy is already listening on port 80 and 443 for directly
receiving traffic to any domain with a DNS entry of 192.168.0.188.


Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="019512.html">[squid-users] squid transparent proxy forward loop
</A></li>
	<LI>Next message (by thread): <A HREF="019538.html">[squid-users] squid transparent proxy forward loop
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19513">[ date ]</a>
              <a href="thread.html#19513">[ thread ]</a>
              <a href="subject.html#19513">[ subject ]</a>
              <a href="author.html#19513">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
