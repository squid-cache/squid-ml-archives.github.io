<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid proxy not working when upgrade from 27 to	3.5
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20proxy%20not%20working%20when%20upgrade%20from%2027%20to%0A%093.5&In-Reply-To=%3C4fc98d5d-8ea8-915d-4076-b1baa35e0bee%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="019518.html">
   <LINK REL="Next"  HREF="019520.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid proxy not working when upgrade from 27 to	3.5</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20proxy%20not%20working%20when%20upgrade%20from%2027%20to%0A%093.5&In-Reply-To=%3C4fc98d5d-8ea8-915d-4076-b1baa35e0bee%40treenet.co.nz%3E"
       TITLE="[squid-users] Squid proxy not working when upgrade from 27 to	3.5">squid3 at treenet.co.nz
       </A><BR>
    <I>Tue Oct 23 07:05:49 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="019518.html">[squid-users] Squid proxy not working when upgrade from 27 to 3.5
</A></li>
        <LI>Next message (by thread): <A HREF="019520.html">[squid-users] Squid proxy not working when upgrade from 27 to	3.5
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19519">[ date ]</a>
              <a href="thread.html#19519">[ thread ]</a>
              <a href="subject.html#19519">[ subject ]</a>
              <a href="author.html#19519">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 23/10/18 4:28 PM, Angus J. wrote:
&gt;<i> Squid proxy not working when upgrade from 27 to 3.5
</I>&gt;<i> 
</I>
Please run &quot;squid -k parse&quot; with the new Squid version. It is especially
important when jumping many versions like a 2.x to 3.5 does.

All issues it highlights as FATAL and ERROR must be fixed before you can
expect Squid to run properly. Anything labeled WARNING should also be
looked into and fixed where possible to avoid odd or annoying behaviours.

Have you checked the release notes for all the skipped Squid-3.x versions?
 While Squid operates mostly the same there have been some significant
changes to both HTTP and TLS/SSL in the last decade that result in some
very different visible behaviours at times.



If the problem(s) remain after doing the above please explain &quot;not working&quot;.

What you do see _exactly_ which makes you think something is going
wrong? we need details of the problem to provide any useful help.


&gt;<i> Squid proxy not working when upgrade to 3.5 and it will not caching anything 
</I>&gt;<i> 
</I>
The lack of caching is easily explained by reading the comments in your
config file(s):

&gt;<i> # Disable caching
</I>&gt;<i> cache deny all
</I>
and

&gt;<i> # the proxy-only indicates that caching will not be performed.
</I>&gt;<i> cache_peer ... proxy-only ...
</I>

You display two config files below. How does this relate to your Squid?
are you running two proxies and how are they related?


&gt;<i> ----------------------------------------------------------------------------
</I>&gt;<i> 
</I>&gt;<i> #Default:
</I>&gt;<i> # windows_ipaddrchangemonitor on
</I>&gt;<i> 
</I>&gt;<i> visible_hostname oul163.hkbb.edu.hk
</I>&gt;<i> http_port 3128 accel vhost defaultsite=oul163.hkbb.edu.hk
</I>
&gt;<i> https_port 80 accel cert=/etc/squid/certs/ouhk.crt
</I>&gt;<i> key=/etc/squid/certs/ouhk.key defaultsite=oul163.hkbb.edu.hk vhost
</I>&gt;<i> protocol=https options=NO_SSLv3:NO_SSLv2
</I>
Port 80 is a reserved port for HTTP traffic. Not for HTTPS traffic.


&gt;<i> https_port 8000 accel cert=/etc/squid/certs/ouhk.crt
</I>&gt;<i> key=/etc/squid/certs/ouhk.key defaultsite=oul163.hkbb.edu.hk vhost
</I>&gt;<i> protocol=https options=NO_SSLv3:NO_SSLv2
</I>&gt;<i> #https_port 8004 accel cert=/etc/squid/certs/ouhk.crt
</I>&gt;<i> key=/etc/squid/certs/ouhk.key defaultsite=oul163.hkbb.edu.hk vhost
</I>&gt;<i> protocol=https options=NO_SSLv3:NO_SSLv2
</I>&gt;<i> https_port 8004 accel cert=/etc/squid/certs/ouhk2.crt
</I>&gt;<i> key=/etc/squid/certs/ouhk2.key defaultsite=oul163.hkbb.edu.hk vhost
</I>&gt;<i> protocol=https options=NO_SSLv3:NO_SSLv2
</I>&gt;<i> #https_port 8005 accel cert=/etc/squid/certs/ouhk.crt
</I>&gt;<i> key=/etc/squid/certs/ouhk.key defaultsite=oul163.hkbb.edu.hk vhost
</I>&gt;<i> protocol=https options=NO_SSLv3:NO_SSLv2
</I>&gt;<i> https_port 8005 accel cert=/etc/squid/certs/ouhk3.crt
</I>&gt;<i> key=/etc/squid/certs/ouhk3.key defaultsite=oul163.hkbb.edu.hk vhost
</I>&gt;<i> protocol=https options=NO_SSLv3:NO_SSLv2
</I>
FYI: Squid does understands line wrapping in the config. For very long
lines you can end a line with slash '\' and start the next with
whitespace to make it easier to read.


&gt;<i> #ssl_bump allow all
</I>&gt;<i> #              Disable the following one
</I>&gt;<i> #ssl_bump options=NO_SSLv3
</I>&gt;<i> #always_direct allow all
</I>&gt;<i> #              Disable the following one
</I>&gt;<i> #sslproxy_cert_error allow all
</I>&gt;<i> sslproxy_options NO_SSLv3:NO_SSLv2
</I>&gt;<i> access_log /var/log/squid/access.log squid
</I>&gt;<i> cache_effective_user squid
</I>&gt;<i> cache_log /var/log/squid/cache.log
</I>&gt;<i> cache_store_log /var/log/squid/store.log
</I>&gt;<i> 
</I>&gt;<i> # the proxy-only indicates that caching will not be performed.
</I>&gt;<i> cache_peer 192.168.31.113 parent 8001 0 proxy-only name=prdhrms
</I>&gt;<i> cache_peer_domain prdhrms prdhrms.hkbb.edu.hk
</I>
&gt;<i> cache_peer 192.168.31.134 parent 8005 0 ssl sslflags=DONT_VERIFY_PEER
</I>&gt;<i> proxy-only   name=uathrms ssloptions=NO_SSLv3:NO_SSLv2
</I>&gt;<i> #cache_peer 192.168.31.134 parent 8005 0 ssl sslflags=DONT_VERIFY_DOMAIN
</I>&gt;<i> proxy-only name=uathrms ssloptions=NO_SSLv3:NO_SSLv2
</I>&gt;<i> cache_peer_domain uathrms uathrms.hkbb.edu.hk
</I>&gt;<i> cache_peer 192.168.31.134 parent 8004 0 ssl sslflags=DONT_VERIFY_PEER
</I>&gt;<i> proxy-only   name=sithrms ssloptions=NO_SSLv3:NO_SSLv2
</I>&gt;<i> cache_peer_domain sithrms sithrms.hkbb.edu.hk
</I>&gt;<i> cache_peer 192.168.31.134 parent 8000 0 ssl sslflags=DONT_VERIFY_PEER
</I>&gt;<i> proxy-only  name=devhrms ssloptions=NO_SSLv3:NO_SSLv2
</I>&gt;<i> #cache_peer 192.168.31.134 parent 8000 0 proxy-only originserver
</I>&gt;<i> name=devhrms ssll sslcafile=/certs/star_ouhk_edu_hk.crt
</I>&gt;<i> cache_peer_domain devhrms devhrms.hkbb.edu.hk
</I>

NP: cache_peer_domain is deprecated and has been removed from Squid-4
and later. You should replace these with cache_peer_access lines in
Squid-3 to avoid further problems on later upgrades.


Also, you are using reverse-proxy ports (accel vhost) but do not have
originserver set for any of the enabled cache_peer.

This is one of the major changes between HTTP/1.0 (Squid-2.x) and
HTTP/1.1 (Squid-3.x) that the origin servers have different syntax to
proxy traffic. Squid should be told accurately what type of peer it is
communicating with to properly optimize traffic performance and protocol
behaviours for the channel.


&gt;<i> 
</I>&gt;<i> # Create an additional ACL for local network access
</I>&gt;<i> acl localip src 192.168.31.0/24
</I>&gt;<i> 
</I>
Squid-3 and later configs define the above as an ACL called &quot;localnet&quot;.


&gt;<i> # access control list
</I>&gt;<i> acl hrmsacl dstdomain .hkbb.edu.hk
</I>&gt;<i> http_access allow hrmsacl
</I>&gt;<i> #acl hrmsacl2 dstdomain devhrms.hkbb.edu.hk
</I>&gt;<i> #cache_peer_access devhrms allow hrmsacl2
</I>&gt;<i> cache_peer_access prdhrms allow hrmsacl
</I>&gt;<i> cache_peer_access uathrms allow hrmsacl
</I>&gt;<i> cache_peer_access sithrms allow hrmsacl
</I>&gt;<i> cache_peer_access devhrms allow hrmsacl
</I>&gt;<i> #cache_peer_access secure allow SSL_ports
</I>&gt;<i> 
</I>&gt;<i> # Additional ACL definitions
</I>&gt;<i> acl all src all
</I>&gt;<i> acl manager proto cache_object
</I>&gt;<i> acl localhost src 127.0.0.1/32
</I>&gt;<i> acl to_localhost dst 127.0.0.0/8 0.0.0.0/32
</I>&gt;<i> acl purge method PURGE
</I>&gt;<i> acl CONNECT method CONNECT
</I>

All of the above common ACL definitions are now built-in to Squid and
can be removed from the config file. They were incrementally changed
though, so see the output of squid -k parse for which ones in your
particular release.

&gt;<i> 
</I>&gt;<i> # Restrictions
</I>&gt;<i> http_access allow manager localhost
</I>&gt;<i> http_access deny manager
</I>&gt;<i> http_access allow purge localhost
</I>&gt;<i> http_access deny purge
</I>&gt;<i> http_access deny all
</I>
These can be simplified to:

 http_access deny !localhost
 http_access allow manager
 http_access allow purge
 http_access deny all

&gt;<i> 
</I>&gt;<i> # Disable caching
</I>&gt;<i> cache deny all
</I>&gt;<i> 
</I>&gt;<i> logfile_rotate 10
</I>&gt;<i> 
</I>
The logfile_rotate default value is 10 unless your Squid has explicitly
been patched to use a different value (eg. as done by Debian/Ubuntu).

In Squid-3 and later there is no need to define anything to its default
value. So the above line can probably be removed.


The below appears to be a different config file, but contains all the
same issues with cache_peer.


&gt;<i> oul163:/etc/squid # vi  squid.conf
</I>&gt;<i> cache_peer 192.168.31.113 parent 8001 0 proxy-only name=prdhrms
</I>&gt;<i> cache_peer_domain prdhrms prdhrms.hkbb.edu.hk
</I>&gt;<i> cache_peer 192.168.31.134 parent 8005 0 ssl sslflags=DONT_VERIFY_PEER
</I>&gt;<i> proxy-only name=uathrms ssloptions=NO_SSLv3:NO_SSLv2
</I>&gt;<i> #cache_peer 192.168.31.134 parent 8005 0 ssl sslflags=DONT_VERIFY_DOMAIN
</I>&gt;<i> proxy-only name=uathrms ssloptions=NO_SSLv3:NO_SSLv2
</I>&gt;<i> cache_peer_domain uathrms uathrms.hkbb.edu.hk
</I>&gt;<i> cache_peer 192.168.31.134 parent 8004 0 ssl sslflags=DONT_VERIFY_PEER
</I>&gt;<i> proxy-only name=sithrms ssloptions=NO_SSLv3:NO_SSLv2
</I>&gt;<i> cache_peer_domain sithrms sithrms.hkbb.edu.hk
</I>&gt;<i> cache_peer 192.168.31.134 parent 8000 0 ssl sslflags=DONT_VERIFY_PEER
</I>&gt;<i> proxy-only name=devhrms ssloptions=NO_SSLv3:NO_SSLv2
</I>&gt;<i> #cache_peer 192.168.31.134 parent 8000 0 proxy-only originserver
</I>&gt;<i> name=devhrms ssll sslcafile=/certs/star_ouhk_edu_hk.crt
</I>&gt;<i> cache_peer_domain devhrms devhrms.hkbb.edu.hk
</I>&gt;<i> 
</I>&gt;<i> # Create an additional ACL for local network access
</I>&gt;<i> acl localip src 192.168.31.0/24
</I>&gt;<i> 
</I>&gt;<i> # access control list
</I>&gt;<i> acl hrmsacl dstdomain .hkbb.edu.hk
</I>&gt;<i> http_access allow hrmsacl
</I>&gt;<i> #acl hrmsacl2 dstdomain devhrms.hkbb.edu.hk
</I>&gt;<i> #cache_peer_access devhrms allow hrmsacl2
</I>&gt;<i> cache_peer_access prdhrms allow hrmsacl
</I>&gt;<i> cache_peer_access uathrms allow hrmsacl
</I>&gt;<i> cache_peer_access sithrms allow hrmsacl
</I>&gt;<i> cache_peer_access devhrms allow hrmsacl
</I>&gt;<i> #cache_peer_access secure allow SSL_ports
</I>&gt;<i> 
</I>&gt;<i> # Additional ACL definitions
</I>&gt;<i> acl all src all
</I>&gt;<i> acl manager proto cache_object
</I>&gt;<i> acl localhost src 127.0.0.1/32
</I>&gt;<i> acl to_localhost dst 127.0.0.0/8 0.0.0.0/32
</I>&gt;<i> acl purge method PURGE
</I>&gt;<i> acl CONNECT method CONNECT
</I>&gt;<i> 
</I>&gt;<i> # Restrictions
</I>&gt;<i> http_access allow manager localhost
</I>&gt;<i> http_access deny manager
</I>&gt;<i> http_access allow purge localhost
</I>&gt;<i> http_access deny purge
</I>&gt;<i> http_access deny all
</I>&gt;<i> 
</I>&gt;<i> # Disable caching
</I>&gt;<i> cache deny all
</I>&gt;<i> 
</I>&gt;<i> logfile_rotate 10
</I>&gt;<i> 
</I>&gt;<i> 
</I>

Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="019518.html">[squid-users] Squid proxy not working when upgrade from 27 to 3.5
</A></li>
	<LI>Next message (by thread): <A HREF="019520.html">[squid-users] Squid proxy not working when upgrade from 27 to	3.5
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19519">[ date ]</a>
              <a href="thread.html#19519">[ thread ]</a>
              <a href="subject.html#19519">[ subject ]</a>
              <a href="author.html#19519">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
