<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] error in parsing Proxy protocol version 2 by Squid	proxy protocol
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20error%20in%20parsing%20Proxy%20protocol%20version%202%20by%20Squid%0A%09proxy%20protocol&In-Reply-To=%3C1540320341175-0.post%40n4.nabble.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="019555.html">
   <LINK REL="Next"  HREF="019530.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] error in parsing Proxy protocol version 2 by Squid	proxy protocol</H1>
    <B>NityaIyer</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20error%20in%20parsing%20Proxy%20protocol%20version%202%20by%20Squid%0A%09proxy%20protocol&In-Reply-To=%3C1540320341175-0.post%40n4.nabble.com%3E"
       TITLE="[squid-users] error in parsing Proxy protocol version 2 by Squid	proxy protocol">nitu665 at gmail.com
       </A><BR>
    <I>Tue Oct 23 18:45:41 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="019555.html">[squid-users] Squid proxy not working when upgrade from 27 to	3.5
</A></li>
        <LI>Next message (by thread): <A HREF="019530.html">[squid-users] error in parsing Proxy protocol version 2 by Squid proxy protocol
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19528">[ date ]</a>
              <a href="thread.html#19528">[ thread ]</a>
              <a href="subject.html#19528">[ subject ]</a>
              <a href="author.html#19528">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello,

I really need a help in this issue.

I have a squid application running on a instance  behind the Network load
balancer[NLB] in  AWS cloud. Due to my use case, I have enabled proxy
protocol on the load balancer so that my backend instance can receive the
proxy protocol header. 

Few details:
- The network load balancer is sending proxy protocol version 2 header. 
- Squid version  - 3.5.20
- TCP listening  on 3128 both load balancer and my instance

As per the release note [1], below is the configuration of my Squid
application
********************************************************************
acl abc src 10.9.0.0/21 #My local network
proxy_protocol_access allow abc
logformat squid %ts.%03tu %6tr %&gt;a %Ss/%03&gt;Hs %&lt;st %rm %ru %[un %Sh/%&lt;a %mt
%&lt;la %&lt;lp %&lt;a %&lt;p %&lt;rd %&gt;rd proxy_protocol_access allow abc
http_port 3128 accel require-proxy-header
http_port 3128
***********************************************************************************
On testing, I find below logs on cache file of the squid. Somehow, squid
application is not interpreting the proxy protocol header version 2[PPv2]:

2018/10/11 17:55:45 kid1| PROXY protocol error: invalid header from
local=10.9.7.165:3128 remote=10.9.7.170:43730 FD 10 flags=1

2018/10/11 17:55:45 kid1| PROXY protocol error: invalid header from
local=10.9.7.165:3128 remote=10.9.7.170:61432 FD 10 flags=1

2018/10/11 17:55:45 kid1| PROXY protocol error: invalid header from
local=10.9.7.165:3128 remote=10.9.7.170:16783 FD 10 flags=1 

10.9.7.170 is the private IP load balancer and 10.9.7.165 is instance
itself.

To be noted:
- I configured Apache on the same box and Apache can successfully parse the
proxy protocol version 2 header received from NLB. I can successfully see
client IP address on access log of Apache.
**************************************************************************************
10.9.7.170 80 18.222.29.158 45634 - - [11/Oct/2018:15:15:18 +0000] &quot;GET /
HTTP/1.1&quot; 200 166 &quot;-&quot; &quot;curl/7.53.1&quot;
10.9.7.170 80 18.222.29.158 45638 - - [11/Oct/2018:15:17:15 +0000] &quot;GET /
HTTP/1.1&quot; 200 166 &quot;-&quot; &quot;curl/7.53.1&quot;
*************************************************************************************
10.9.7.170 is private IP of my NLB and 18.222.29.158 is my dummy box i.e.
client IP address.

- I used the same squid configuration to intercept proxy protocol version 1
header and surprisingly it works for version 1 header:
******************************************************************************************************
1539282729.144 0 18.222.29.158 TCP_DENIED/403 470 HEAD
<A HREF="http://18.203.114.1:3128/">http://18.203.114.1:3128/</A> - HIER_NONE/- text/html - - - - 18.203.114.1
18.203.114.1 proxy_protocol_access allow abc

1539286165.754 0 18.222.29.158 TCP_DENIED/403 4027 GET
<A HREF="http://18.203.114.1:3128/">http://18.203.114.1:3128/</A> - HIER_NONE/- text/html - - - - 18.203.114.1
18.203.114.1 proxy_protocol_access allow abc

1539286185.310 0 18.222.29.158 TCP_DENIED/403 4027 GET
<A HREF="http://18.203.114.1:3128/">http://18.203.114.1:3128/</A> - HIER_NONE/- text/html - - - - 18.203.114.1
18.203.114.1 proxy_protocol_access allow abc
***************************************************************************************************
Where: 18.222.29.158 is my dummy box nothing but client IP.


On summary , based on my analysis there is something I am missing or I dont
know but squid is not intercepting with the PPv2 header. Any help is greatly
appreciated.

Thank you

Regards
Nitya 


Reference: [1]
<A HREF="http://www.squid-cache.org/Versions/v3/3.5/squid-3.5.20-RELEASENOTES.html#ss2.7">http://www.squid-cache.org/Versions/v3/3.5/squid-3.5.20-RELEASENOTES.html#ss2.7</A>



--
Sent from: <A HREF="http://squid-web-proxy-cache.1019090.n4.nabble.com/Squid-Users-f1019091.html">http://squid-web-proxy-cache.1019090.n4.nabble.com/Squid-Users-f1019091.html</A>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="019555.html">[squid-users] Squid proxy not working when upgrade from 27 to	3.5
</A></li>
	<LI>Next message (by thread): <A HREF="019530.html">[squid-users] error in parsing Proxy protocol version 2 by Squid proxy protocol
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19528">[ date ]</a>
              <a href="thread.html#19528">[ thread ]</a>
              <a href="subject.html#19528">[ subject ]</a>
              <a href="author.html#19528">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
