<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] squid transparent proxy forward loop
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid%20transparent%20proxy%20forward%20loop&In-Reply-To=%3CCAN8OBP7iQxvCc-yL-mMNOBX3EBrJ9AvJBOZG0z2ZLekxQcvQAg%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="019513.html">
   <LINK REL="Next"  HREF="019514.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] squid transparent proxy forward loop</H1>
    <B>Juan Carvajal B.</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid%20transparent%20proxy%20forward%20loop&In-Reply-To=%3CCAN8OBP7iQxvCc-yL-mMNOBX3EBrJ9AvJBOZG0z2ZLekxQcvQAg%40mail.gmail.com%3E"
       TITLE="[squid-users] squid transparent proxy forward loop">juan at mediaarchitecture.org
       </A><BR>
    <I>Wed Oct 24 12:28:02 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="019513.html">[squid-users] squid transparent proxy forward loop
</A></li>
        <LI>Next message (by thread): <A HREF="019514.html">[squid-users] Squid 4.3 assertion failed
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19538">[ date ]</a>
              <a href="thread.html#19538">[ thread ]</a>
              <a href="subject.html#19538">[ subject ]</a>
              <a href="author.html#19538">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Thank you so much Matus,

we were indeed missing a DNS service:

Your proxy is already listening on port 80 and 443 for directly
receiving traffic to any domain with a DNS entry of 192.168.0.188.

best,

*Juan Carlos*

*Join our mailing list
&lt;<A HREF="http://lists.mediaarchitecture.org/?p=subscribe&amp;id=1">http://lists.mediaarchitecture.org/?p=subscribe&amp;id=1</A>&gt; (Max 1-mail / month)*



Am Mo., 22. Okt. 2018 um 15:12 Uhr schrieb Amos Jeffries &lt;
<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt;:

&gt;<i> On 23/10/18 1:26 AM, Juan Carvajal B. wrote:
</I>&gt;<i> &gt; Dear list,
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I hope you can give me some hints for my current task.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I would like to achieve the following:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; 1. A user comes with the own device, for example phone or table.
</I>&gt;<i> &gt; 2. The user connects to our own WLAN network
</I>&gt;<i> &gt; 4. The user enters the addres of our website
</I>&gt;<i> &gt; 3. The user can only access our website, which is hosted in a sever *not
</I>&gt;<i> &gt; connected* to the internet.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; We have the following set up
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Tablets / phones &lt;---&gt; WLAN router &lt;---&gt; server
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; please note that there is *no* connection to internet. The server is
</I>&gt;<i> &gt; connected to the &quot;internet&quot; port of the router.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; The server runs ubuntu &amp; apache.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I've been trying to achieve this with squid but I get a **warning of a
</I>&gt;<i> &gt; forwarding loop**. I do not know what I'm doing wrong.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I'm following this:
</I>&gt;<i> &gt; <A HREF="https://wiki.squid-cache.org/ConfigExamples/Intercept/LinuxRedirect">https://wiki.squid-cache.org/ConfigExamples/Intercept/LinuxRedirect</A>
</I>&gt;<i> &gt; <A HREF="https://wiki.squid-cache.org/SquidFaq/ReverseProxy">https://wiki.squid-cache.org/SquidFaq/ReverseProxy</A>
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Here are my conf files:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; ****squid.conf****
</I>&gt;<i> &gt;
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt;     visible_hostname squid.proxy
</I>&gt;<i>
</I>&gt;<i> I have seen other people using this &quot;squid.proxy&quot; as the FQDN of their
</I>&gt;<i> proxy. It is likely that your chosen proxy hostname is not unique.
</I>&gt;<i>
</I>&gt;<i> Since this is a reverse-proxy it is best to set this to the FQDN of the
</I>&gt;<i> primary website you are proxying.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt;     http_port 3128 intercept
</I>&gt;<i> &gt;     http_port 192.168.0.188:80 accel
</I>&gt;<i> &gt; defaultsite=our.domain.org
</I>&gt;<i> &gt;     http_port 192.168.0.188:443 accel
</I>&gt;<i> &gt; defaultsite=our.domain.org
</I>&gt;<i>
</I>&gt;<i> The above should be https_port and requires the TLS certificate for the
</I>&gt;<i> domain being virtual-hosted.
</I>&gt;<i>
</I>&gt;<i> see
</I>&gt;<i> &lt;<A HREF="https://wiki.squid-cache.org/ConfigExamples/Reverse/HttpsVirtualHosting">https://wiki.squid-cache.org/ConfigExamples/Reverse/HttpsVirtualHosting</A>&gt;
</I>&gt;<i> which
</I>&gt;<i> I added just yesterday.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt;     cache_peer 127.0.0.1 parent 80 0 no-query originserver name=myAccel
</I>&gt;<i> &gt;     acl our_sites dstdomain our.domain.org
</I>&gt;<i> &gt;     http_access allow our_sites
</I>&gt;<i> &gt;     cache_peer_access myAccel allow our_sites
</I>&gt;<i> &gt;     cache_peer_access myAccel deny all
</I>&gt;<i>
</I>&gt;<i> Move the above custom configuration down to ...
</I>&gt;<i>
</I>&gt;<i> &gt;     acl SSL_ports port 443
</I>&gt;<i> &gt;     acl CONNECT method CONNECT
</I>&gt;<i> &gt;     http_access deny !Safe_ports
</I>&gt;<i>
</I>&gt;<i> You do not have any definition of Safe_ports above. It should contain at
</I>&gt;<i> least 80 and 443 for your proxy.
</I>&gt;<i>
</I>&gt;<i> &gt;     http_access deny CONNECT !SSL_ports
</I>&gt;<i> &gt;     http_access allow localhost manager
</I>&gt;<i> &gt;     http_access deny manager
</I>&gt;<i>
</I>&gt;<i> ... here.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> You are missing good rules for traffic arriving on the port 3128. The
</I>&gt;<i> below &quot;allow all&quot; is very bad.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt;     http_access allow localhost
</I>&gt;<i> &gt;     http_access allow all
</I>&gt;<i>
</I>&gt;<i> That should be:
</I>&gt;<i>
</I>&gt;<i>  http_access deny all
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> ...
</I>&gt;<i>
</I>&gt;<i> &gt; ****IPTABLES****
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     # your proxy IP
</I>&gt;<i> &gt;     SQUIDIP=192.168.0.188
</I>&gt;<i> &gt;     # your proxy listening port
</I>&gt;<i> &gt;     SQUIDPORT=3128
</I>&gt;<i> &gt;     iptables -t nat -A PREROUTING -s $SQUIDIP -p tcp --dport 80 -j ACCEPT
</I>&gt;<i> &gt;     iptables -t nat -A PREROUTING -p tcp --dport 80 -j REDIRECT
</I>&gt;<i> &gt; --to-port $SQUIDPORT
</I>&gt;<i> &gt;
</I>&gt;<i>
</I>&gt;<i> Here is your problem. You have not bypassed the traffic Squid is sending
</I>&gt;<i> to 127.0.0.1:80.
</I>&gt;<i>
</I>&gt;<i> Traffic to/from localhost does not use global IP addresses such as
</I>&gt;<i> 192.168.0.188. Thus Squid's attempts to send traffic to Apache is being
</I>&gt;<i> looped back into port 3128 by iptables.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> What is the point of all this interception anyway?
</I>&gt;<i>
</I>&gt;<i> Your proxy is already listening on port 80 and 443 for directly
</I>&gt;<i> receiving traffic to any domain with a DNS entry of 192.168.0.188.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Amos
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20181024/44142daa/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20181024/44142daa/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="019513.html">[squid-users] squid transparent proxy forward loop
</A></li>
	<LI>Next message (by thread): <A HREF="019514.html">[squid-users] Squid 4.3 assertion failed
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19538">[ date ]</a>
              <a href="thread.html#19538">[ thread ]</a>
              <a href="subject.html#19538">[ subject ]</a>
              <a href="author.html#19538">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
