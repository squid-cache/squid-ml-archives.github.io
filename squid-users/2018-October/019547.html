<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] ERROR: NAT/TPROXY lookup failed to locate original IPs on local
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20ERROR%3A%20NAT/TPROXY%20lookup%20failed%20to%20locate%0A%20original%20IPs%20on%20local&In-Reply-To=%3CCAHgpA%2BJqj9LWdqCuGr-P_YYfD8pFGHJ0adQ3yx0Zsd9%2B83iCfw%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="019491.html">
   <LINK REL="Next"  HREF="019506.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] ERROR: NAT/TPROXY lookup failed to locate original IPs on local</H1>
    <B>Uchenna Nebedum</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20ERROR%3A%20NAT/TPROXY%20lookup%20failed%20to%20locate%0A%20original%20IPs%20on%20local&In-Reply-To=%3CCAHgpA%2BJqj9LWdqCuGr-P_YYfD8pFGHJ0adQ3yx0Zsd9%2B83iCfw%40mail.gmail.com%3E"
       TITLE="[squid-users] ERROR: NAT/TPROXY lookup failed to locate original IPs on local">nebeduch at gmail.com
       </A><BR>
    <I>Thu Oct 25 13:25:49 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="019491.html">[squid-users] ERROR: NAT/TPROXY lookup failed to locate original IPs on local
</A></li>
        <LI>Next message (by thread): <A HREF="019506.html">[squid-users] 4.3 RPM's are out and an additional SCTP proxies I	compiled
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19547">[ date ]</a>
              <a href="thread.html#19547">[ thread ]</a>
              <a href="subject.html#19547">[ subject ]</a>
              <a href="author.html#19547">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Rafael,
First off i'd like to thank you for the link you provided, it was really
helpful.
I've successfully installed squid and routed the traffic to the proxy
thanks to the diladele link, unfortunately i couldn't install websafety as
ubuntu removed squid 4.1-1 from their repo and had 4.3-1, i tried with 4.3
but there were problems with websafety... so installed squid 3.5 from
source with ssl enabled, I used the websafety squid.conf as reference, now
i have my proxy working, and i have connected greasyspoon to it, but
greasyspoon only adapts http content, how do i get it to adapt https
traffic? and this is assuming the ssl_bumping works, because i don't know
how to confirm if it does, i see https connections in the access.log though.

please see attached my squid.conf
cache_effective_user proxy
acl localnet src 10.0.0.0/24
acl localnet src 172.16.0.0/12
acl localnet src 192.168.0.0/16
acl localnet src fc00::/7
acl localnet src fe80::/10
acl SSL_ports port 443
acl Safe_ports port 80          # http
acl Safe_ports port 21          # ftp
acl Safe_ports port 443         # https
acl Safe_ports port 70          # gopher
acl Safe_ports port 210         # wais
acl Safe_ports port 1025-65535  # unregistered ports
acl Safe_ports port 280         # http-mgmt
acl Safe_ports port 488         # gss-http
acl Safe_ports port 591         # filemaker
acl Safe_ports port 777         # multiling http
acl CONNECT method CONNECT
http_port 3128 ssl-bump  generate-host-certificates=on
dynamic_cert_mem_cache_size=4MB cert=/opt/websafety/etc/myca.pem
http_port 3126 intercept
https_port 3127 intercept ssl-bump generate-host-certificates=on
dynamic_cert_mem_cache_size=4MB cert=/opt/websafety/etc/myca.pem
http_access deny !Safe_ports
http_access deny CONNECT !SSL_ports
http_access allow localhost manager
http_access deny manager
http_access allow localnet
http_access allow localhost
http_access deny all
sslcrtd_program /usr/local/squid/libexec/ssl_crtd -s /var/spool/squid_ssldb
-M 4MB
acl step1 at_step SslBump1
acl step2 at_step SslBump2
acl step3 at_step SslBump3
ssl_bump peek step1 all
ssl_bump bump all
ssl_bump bump ssl_force_bump
ssl_bump splice localhost
acl ssl_error_domains dstdomain
&quot;/opt/websafety/etc/squid/ssl/error/domains.conf&quot;
acl ssl_error_ips     dst
&quot;/opt/websafety/etc/squid/ssl/error/ips.conf&quot;
acl ssl_error_ips     dst
&quot;/opt/websafety/etc/squid/ssl/error/subnets.conf&quot;
sslproxy_cert_error allow ssl_error_domains
sslproxy_cert_error allow ssl_error_ips
shutdown_lifetime 10 seconds
adaptation_access greasyspoon allow all
visible_hostname proxy.example.lan
acl cache_exclude_domainname dstdomain
&quot;/opt/websafety/etc/squid/cache/exclude/domain_name.conf&quot;
acl cache_exclude_domainaddr dst
&quot;/opt/websafety/etc/squid/cache/exclude/domain_ip.conf&quot;
acl cache_exclude_domainaddr dst
&quot;/opt/websafety/etc/squid/cache/exclude/domain_subnet.conf&quot;
acl cache_exclude_domainaddr dst
&quot;/opt/websafety/etc/squid/cache/exclude/domain_range.conf&quot;
acl cache_exclude_useraddr src
&quot;/opt/websafety/etc/squid/cache/exclude/user_ip.conf&quot;
acl cache_exclude_useraddr src
&quot;/opt/websafety/etc/squid/cache/exclude/user_subnet.conf&quot;
acl cache_exclude_useraddr src
&quot;/opt/websafety/etc/squid/cache/exclude/user_range.conf&quot;
acl cache_exclude_useragent   browser -i
&quot;/opt/websafety/etc/squid/cache/exclude/user_agent.conf&quot;
acl cache_exclude_schedule    time
&quot;/opt/websafety/etc/squid/cache/exclude/schedule.conf&quot;
cache deny cache_exclude_domainname
cache deny cache_exclude_domainaddr
cache deny cache_exclude_useraddr
cache deny cache_exclude_useragent
cache deny cache_exclude_schedule
acl cache_exclude_contenttype rep_mime_type
&quot;/opt/websafety/etc/squid/cache/exclude/content_type.conf&quot;
send_hit deny cache_exclude_contenttype
store_miss deny cache_exclude_contenttype
refresh_pattern ^ftp:           1440    20%     10080
refresh_pattern ^gopher:        1440    0%      1440
refresh_pattern -i (/cgi-bin/|\?) 0     0%      0
refresh_pattern .               0       20%     4320
cache_replacement_policy lru
minimum_object_size 0 KB
maximum_object_size 4096 KB
dns_timeout 30 seconds
dns_v4_first on
icap_enable on
icap_preview_enable off
icap_preview_size 2048
icap_persistent_connections on
adaptation_send_client_ip on
adaptation_send_username on
icap_service greasyspoon respmod_precache <A HREF="icap://127.0.0.1:1344/response">icap://127.0.0.1:1344/response</A>
bypass=0
cache_mem 256 MB
maximum_object_size_in_memory 512 KB
memory_replacement_policy lru
forwarded_for on
forward_max_tries 25


also part of my access.log
1540473704.606   1021 10.0.0.250 TAG_NONE/200 0 CONNECT 52.97.133.226:443 -
HIER_NONE/- -
1540473711.552 465997 10.0.0.254 TCP_TUNNEL/200 4350 CONNECT
outlook.office365.com:443 - ORIGINAL_DST/52.97.131.242 -
1540473711.552 163713 10.0.0.254 TCP_TUNNEL/200 4320 CONNECT
inbox.google.com:443 - ORIGINAL_DST/216.58.223.197 -
1540473711.552 163689 10.0.0.254 TCP_TUNNEL/200 4231 CONNECT
inbox.google.com:443 - ORIGINAL_DST/216.58.223.197 -

and part of my cache.log
2018/10/25 11:36:21 kid1| Accepting SSL bumped HTTP Socket connections at
local=[::]:3128 remote=[::] FD 22 flags=9
2018/10/25 11:36:21 kid1| Accepting NAT intercepted HTTP Socket connections
at local=[::]:3126 remote=[::] FD 23 flags=41
2018/10/25 11:36:21 kid1| Accepting NAT intercepted SSL bumped HTTPS Socket
connections at local=[::]:3127 remote=[::] FD 24 flags=41
2018/10/25 11:36:22 kid1| storeLateRelease: released 0 objects
2018/10/25 11:42:08| Squid is already running!  Process ID 3497
2018/10/25 11:46:20| Squid is already running!  Process ID 3497
2018/10/25 11:46:24| Squid is already running!  Process ID 3497
2018/10/25 11:49:32 kid1| SECURITY ALERT: Host header forgery detected on
local=52.97.133.178:443 remote=10.0.0.250:39627 FD 39 flags=33 (local IP
does not match any domain IP)
2018/10/25 11:49:32 kid1| SECURITY ALERT: on URL: outlook.office365.com:443
2018/10/25 11:49:32 kid1| SECURITY ALERT: Host header forgery detected on
local=52.97.133.178:443 remote=10.0.0.250:39628 FD 39 flags=33 (local IP
does not match any domain IP)
2018/10/25 11:49:32 kid1| SECURITY ALERT: on URL: outlook.office365.com:443
2018/10/25 11:49:32 kid1| SECURITY ALERT: Host header forgery detected on
local=52.97.133.178:443 remote=10.0.0.250:39629 FD 39 flags=33 (local IP
does not match any domain IP)


please how do i get the adaptation to work for https traffic?
Thanks for everyones help.




Uchenna Nebedum

On Fri, Oct 19, 2018, 20:09 Rafael Akchurin &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rafael.akchurin at diladele.com</A>&gt;
wrote:

&gt;<i> Yes you can use any ICAP/eCAP server you like, just adjust the docs as
</I>&gt;<i> required and that is it.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> *From:* Uchenna Nebedum &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">nebeduch at gmail.com</A>&gt;
</I>&gt;<i> *Sent:* Friday, 19 October 2018 20:17
</I>&gt;<i> *To:* Rafael Akchurin &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rafael.akchurin at diladele.com</A>&gt;
</I>&gt;<i> *Cc:* <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> *Subject:* Re: [squid-users] ERROR: NAT/TPROXY lookup failed to locate
</I>&gt;<i> original IPs on local
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Thanks a lot Rafael, I've gone through the documentation it looks to be
</I>&gt;<i> very promising, one reservation i have is I want to use greasyspoon for
</I>&gt;<i> icap and i see ecap is implemented already. I intend to install everything
</I>&gt;<i> as suggested on the link, then after this change squid.conf to remove ecap
</I>&gt;<i> connection.
</I>&gt;<i>
</I>&gt;<i> Please, I hope this will work?
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Thanks a lot again for the link, it really explained everything well
</I>&gt;<i> enough for a beginner.
</I>&gt;<i>
</I>&gt;<i> Uchenna Nebedum
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> On Fri, Oct 19, 2018, 18:30 Rafael Akchurin &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rafael.akchurin at diladele.com</A>&gt;
</I>&gt;<i> wrote:
</I>&gt;<i>
</I>&gt;<i> Hello Uchenna,
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> May be this policy based routing with Mikrotik tutorial will be of any use
</I>&gt;<i>
</I>&gt;<i> See
</I>&gt;<i> <A HREF="https://docs.diladele.com/tutorials/mikrotik_transparent_squid/index.html">https://docs.diladele.com/tutorials/mikrotik_transparent_squid/index.html</A>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Best regards,
</I>&gt;<i>
</I>&gt;<i> Rafael Akchurin
</I>&gt;<i>
</I>&gt;<i> Diladele B.V.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> *From:* squid-users &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>&gt; *On
</I>&gt;<i> Behalf Of *Uchenna Nebedum
</I>&gt;<i> *Sent:* Friday, 19 October 2018 18:42
</I>&gt;<i> *To:* <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> *Subject:* [squid-users] ERROR: NAT/TPROXY lookup failed to locate
</I>&gt;<i> original IPs on local
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Good Day All,
</I>&gt;<i>
</I>&gt;<i> i'm new to squid and i have configured squid as an http transparent proxy
</I>&gt;<i> with a mikrotik.
</I>&gt;<i>
</I>&gt;<i> the squid server has only a single NIC, so i followed a tutorial and set
</I>&gt;<i> up a dst-nat to squid proxy for traffic on port 80,
</I>&gt;<i>
</I>&gt;<i> Chain:dstnat.
</I>&gt;<i>
</I>&gt;<i> Protocol:tcp
</I>&gt;<i>
</I>&gt;<i> Dst-port:80
</I>&gt;<i>
</I>&gt;<i> Action:dst-nat
</I>&gt;<i>
</I>&gt;<i> To Addresses:192.168.2.2 (squid proxy)
</I>&gt;<i>
</I>&gt;<i> To ports:8080
</I>&gt;<i>
</I>&gt;<i> but after setup, only https traffic works correctly,
</I>&gt;<i>
</I>&gt;<i> http traffic client error is &quot;This page isn't working ERR_EMPTY_RESPONSE&quot;
</I>&gt;<i>
</I>&gt;<i> squid access.log is empty then in squid cache.log these are the errors
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> ```
</I>&gt;<i>
</I>&gt;<i> 2018/10/19 17:08:54 kid1| ERROR: NF getsockopt(ORIGINAL_DST) failed on
</I>&gt;<i> local=192.168.2.2:8080 remote=192.168.1.254:41248 FD 10 flags=33: (92)
</I>&gt;<i> Protocol not available
</I>&gt;<i> 2018/10/19 17:08:54 kid1| ERROR: NAT/TPROXY lookup failed to locate
</I>&gt;<i> original IPs on local=192.168.2.2:8080 remote=192.168.1.254:41248 FD 10
</I>&gt;<i> flags=33
</I>&gt;<i>
</I>&gt;<i> ```
</I>&gt;<i>
</I>&gt;<i> please find below my squid.conf contents
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> ```
</I>&gt;<i>
</I>&gt;<i> acl localnet src 192.168.1.0/24
</I>&gt;<i> acl SSL_ports port 443
</I>&gt;<i> acl Safe_ports port 80
</I>&gt;<i> acl Safe_ports port 21
</I>&gt;<i> acl Safe_ports port 443
</I>&gt;<i> acl Safe_ports port 70
</I>&gt;<i> acl Safe_ports port 210
</I>&gt;<i> acl Safe_ports port 1025-65535
</I>&gt;<i> acl Safe_ports port 280
</I>&gt;<i> acl Safe_ports port 488
</I>&gt;<i> acl Safe_ports port 591
</I>&gt;<i> acl Safe_ports port 777
</I>&gt;<i> acl CONNECT method CONNECT
</I>&gt;<i> icap_enable off
</I>&gt;<i> icap_service service_req reqmod_precache 1 <A HREF="icap://127.0.0.1:1344/REQMOD">icap://127.0.0.1:1344/REQMOD</A>
</I>&gt;<i> adaptation_service_set class_req service_req
</I>&gt;<i> adaptation_access class_req allow all
</I>&gt;<i> icap_service service_resp respmod_precache 0 <A HREF="icap://127.0.0.1:1344/RESPMOD">icap://127.0.0.1:1344/RESPMOD</A>
</I>&gt;<i> adaptation_service_set class_resp service_resp
</I>&gt;<i> adaptation_access class_resp allow all
</I>&gt;<i> http_access deny !Safe_ports
</I>&gt;<i> http_access deny CONNECT !SSL_ports
</I>&gt;<i> http_access allow localhost manager
</I>&gt;<i> http_access deny manager
</I>&gt;<i> http_access deny to_localhost
</I>&gt;<i> http_access allow localnet
</I>&gt;<i> http_access allow localhost
</I>&gt;<i> http_access allow all
</I>&gt;<i> http_port 3128
</I>&gt;<i> http_port 8080 transparent
</I>&gt;<i>  access_log daemon:/var/log/squid/access.log squid
</I>&gt;<i> coredump_dir /var/spool/squid
</I>&gt;<i> refresh_pattern ^ftp:        1440    20%    10080
</I>&gt;<i> refresh_pattern ^gopher:    1440    0%    1440
</I>&gt;<i> refresh_pattern -i (/cgi-bin/|\?) 0    0%    0
</I>&gt;<i> refresh_pattern (Release|Packages(.gz)*)$      0       20%     2880
</I>&gt;<i> refresh_pattern .        0    20%    4320
</I>&gt;<i>
</I>&gt;<i> ```
</I>&gt;<i>
</I>&gt;<i> please any help or correction would be highly appreciated, i am not even
</I>&gt;<i> sure if the approach is correct.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> --
</I>&gt;<i>
</I>&gt;<i> Nebedum Uchenna
</I>&gt;<i>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20181025/75243254/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20181025/75243254/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="019491.html">[squid-users] ERROR: NAT/TPROXY lookup failed to locate original IPs on local
</A></li>
	<LI>Next message (by thread): <A HREF="019506.html">[squid-users] 4.3 RPM's are out and an additional SCTP proxies I	compiled
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19547">[ date ]</a>
              <a href="thread.html#19547">[ thread ]</a>
              <a href="subject.html#19547">[ subject ]</a>
              <a href="author.html#19547">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
