<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid 4.3: SSL Bump fails to send client certificate
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%204.3%3A%20SSL%20Bump%20fails%20to%20send%20client%0A%20certificate&In-Reply-To=%3C6a396e03-e800-3dab-2ea8-97342edff1c7%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="019588.html">
   <LINK REL="Next"  HREF="019596.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid 4.3: SSL Bump fails to send client certificate</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%204.3%3A%20SSL%20Bump%20fails%20to%20send%20client%0A%20certificate&In-Reply-To=%3C6a396e03-e800-3dab-2ea8-97342edff1c7%40measurement-factory.com%3E"
       TITLE="[squid-users] Squid 4.3: SSL Bump fails to send client certificate">rousskov at measurement-factory.com
       </A><BR>
    <I>Tue Oct 30 15:50:57 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="019588.html">[squid-users] Squid 4.3: SSL Bump fails to send client certificate
</A></li>
        <LI>Next message (by thread): <A HREF="019596.html">[squid-users] Squid 4.3: SSL Bump fails to send client	certificate
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19590">[ date ]</a>
              <a href="thread.html#19590">[ thread ]</a>
              <a href="subject.html#19590">[ subject ]</a>
              <a href="author.html#19590">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 10/30/18 2:36 AM, Sid wrote:

&gt;<i> http_port 3128 ssl-bump \ 
</I>&gt;<i>   cert=/usr/local/squid/etc/ssl_cert/myCA.pem \ 
</I>&gt;<i>   generate-host-certificates=on dynamic_cert_mem_cache_size=4MB 
</I>
&gt;<i> ssl_bump peek step1 
</I>&gt;<i> ssl_bump bump all 
</I>
&gt;<i> Browser &amp; HTTP UA Client connections are working with SSL bump properly; but
</I>&gt;<i> except for one connection. 
</I>
&gt;<i> Server sends certificate with SNI; but squid forwards it as IP Address to
</I>&gt;<i> client
</I>
Two problems with that statement:

1. Servers never send SNI. Clients usually send SNI. Squid should
forward SNI it received from the client to the server, provided the
client actually sent SNI. Did your client send SNI?

2. Bugs notwithstanding, the implied order of events is not what
actually happens: Squid, as configured, does _not_ forward anything from
the server certificate to the client. Squid, as configured, generates a
certificate based on client-supplied information (not server-supplied
information). After sending that generated certificate to the client,
Squid establishes a TLS connection with the server.


&gt;<i> When I took wireshark on Squid; I can see Squid sends: 
</I>
For an accurate picture, in addition to Squid-server and server-Squid
traffic, look at what Squid has received from the client and what Squid
sent to the client, all in actual order.


&gt;<i> 61 Alert (Level: Fatal, Description: Internal Error) to certificate sent by
</I>&gt;<i> Server 
</I>&gt;<i> 
</I>&gt;<i> cache.log: 
</I>&gt;<i> 2018/10/30 12:55:47 kid1| ERROR: negotiating TLS on FD 21:
</I>&gt;<i> error:14090086:SSL routines:ssl3_get_server_certificate:certificate verify
</I>&gt;<i> failed (1/-1/0) 
</I>&gt;<i> 2018/10/30 12:55:47 kid1| ERROR: negotiating TLS on FD 21:
</I>&gt;<i> error:14090086:SSL routines:ssl3_get_server_certificate:certificate verify
</I>&gt;<i> failed (1/-1/0) 
</I>&gt;<i> 
</I>&gt;<i> This is an internal server with its own CA certs. 
</I>
Is your Squid configured to trust those internal CAs? If not, Squid
would not be able to validate the server certificate.


HTH,

Alex.

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="019588.html">[squid-users] Squid 4.3: SSL Bump fails to send client certificate
</A></li>
	<LI>Next message (by thread): <A HREF="019596.html">[squid-users] Squid 4.3: SSL Bump fails to send client	certificate
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19590">[ date ]</a>
              <a href="thread.html#19590">[ thread ]</a>
              <a href="subject.html#19590">[ subject ]</a>
              <a href="author.html#19590">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
