<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid 3.5.25 does not recognise ICAP 408 status	code
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%203.5.25%20does%20not%20recognise%20ICAP%20408%20status%0A%09code&In-Reply-To=%3CCABCok%3DLTQvxAkgoQT8bU2YQ7SNbTZN2OHzAj9SL2Ex9GV0QMyQ%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="019595.html">
   <LINK REL="Next"  HREF="019607.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid 3.5.25 does not recognise ICAP 408 status	code</H1>
    <B>Arunabha Saha</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%203.5.25%20does%20not%20recognise%20ICAP%20408%20status%0A%09code&In-Reply-To=%3CCABCok%3DLTQvxAkgoQT8bU2YQ7SNbTZN2OHzAj9SL2Ex9GV0QMyQ%40mail.gmail.com%3E"
       TITLE="[squid-users] Squid 3.5.25 does not recognise ICAP 408 status	code">arunabha.saha at gmail.com
       </A><BR>
    <I>Wed Oct 31 17:20:00 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="019595.html">[squid-users] Squid 3.5.25 does not recognise ICAP 408 status code
</A></li>
        <LI>Next message (by thread): <A HREF="019607.html">[squid-users] Squid 3.5.25 does not recognise ICAP 408 status code
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19603">[ date ]</a>
              <a href="thread.html#19603">[ thread ]</a>
              <a href="subject.html#19603">[ subject ]</a>
              <a href="author.html#19603">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>&gt;<i>As with any timeout, it is impossible to say in general which side of
</I>&gt;<i>the connection is at fault. This case has at least three sides: It could
</I>&gt;<i>be the HTTP agent, Squid, and/or the ICAP service. Did one of them stall
</I>&gt;<i>the transaction? Or was the ICAP service just too impatient? See option
</I>&gt;<i>#4 below.
</I>I've tried to track this down.   There are some  persistent sockets used by
SaaS apps for APIs (otservice api from google sites) and sometimes the HTTP
response takes a long time to trickle in.  I have seen upto 25 seconds for
the response body to trickle in after the response header.   I don't know
yet if this is due to network delays but given that it happens only for
this particular uri I'm theorizing that this is how it works.    I can
whitelist the one i am aware of that is causing this issue but again the
concern is what about others that might throw this exception.    The
timeout at 10 seconds is somewhat aggressive so moving that up should help
but some code changes in either squid or icap as suggested look necessary.

&gt;<i>Please note that ICAP is a protocol, not a product/software name. It
</I>&gt;<i>probably does not matter what ICAP service you are using though.
</I>
Correct.  I was referring to the c-icap implementation.

On Wed, Oct 31, 2018 at 5:00 AM &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-request at lists.squid-cache.org</A>&gt;
wrote:

&gt;<i> Send squid-users mailing list submissions to
</I>&gt;<i>         <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i>
</I>&gt;<i> To subscribe or unsubscribe via the World Wide Web, visit
</I>&gt;<i>         <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i> or, via email, send a message with subject or body 'help' to
</I>&gt;<i>         <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-request at lists.squid-cache.org</A>
</I>&gt;<i>
</I>&gt;<i> You can reach the person managing the list at
</I>&gt;<i>         <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-owner at lists.squid-cache.org</A>
</I>&gt;<i>
</I>&gt;<i> When replying, please edit your Subject line so it is more specific
</I>&gt;<i> than &quot;Re: Contents of squid-users digest...&quot;
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Today's Topics:
</I>&gt;<i>
</I>&gt;<i>    1.
</I>&gt;<i> On 10/30/18 6:45 PM, Arunabha Saha wrote:
</I>&gt;<i>
</I>&gt;<i> &gt; Squid 3.5.25 does not seem to recognise the 408 request timeout error
</I>&gt;<i> &gt; code from ICAP.
</I>&gt;<i>
</I>&gt;<i> Squid effectively recognizes ICAP 408 response as an ICAP transaction
</I>&gt;<i> error response and blames the ICAP service for that error. That
</I>&gt;<i> (minimal) support can be improved, of course. See options #1 and #3 below.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>
&gt;<i>
</I>&gt;<i> Needless to say, treating all ICAP service timeouts as if nothing bad
</I>&gt;<i> happened would break some existing Squid deployments (while possibly
</I>&gt;<i> fixing yours). A proper general solution (option #3 below) would most
</I>&gt;<i> likely require making Squid behavior configurable.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; The more troublesome issue for me is the exception it generates and then
</I>&gt;<i> &gt; declares ICAP down after a certain number of such exceptions.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I don't want to disable the failure limit entirely given that we can
</I>&gt;<i> &gt; often have genuine failures that squid needs to detect.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; What i'd like to see is squid should not throw an exception in this
</I>&gt;<i> &gt; case.
</I>&gt;<i>
</I>&gt;<i> The &quot;exception&quot; is a minor low-level/technical detail. What you really
</I>&gt;<i> want to see is Squid blaming itself (rather than the ICAP service) for
</I>&gt;<i> the problem. Squid indeed lacks that kind of functionality, but it can
</I>&gt;<i> be added if really needed. See options #1 and #3 below.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; The timeout is somewhat aggressive but works with an earlier
</I>&gt;<i> &gt; version of ICAP (0.1.x).  The one i'm testing is 0.5.3.
</I>&gt;<i>
</I>&gt;<i> Please note that ICAP is a protocol, not a product/software name. It
</I>&gt;<i> probably does not matter what ICAP service you are using though.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; Any suggestions?
</I>&gt;<i>
</I>&gt;<i> I can suggest a few options, in no particular order:
</I>&gt;<i>
</I>&gt;<i> 1. Modify your Squid to treat 408 differently.
</I>&gt;<i> 2. Modify your ICAP service to stop sending ICAP 408 responses to Squid.
</I>&gt;<i> 3. Add proper ICAP timeout support feature to Squid.
</I>&gt;<i> 4. Investigate why your ICAP service times out. If you are lucky, you
</I>&gt;<i>    may be able to fix or work around the problem by adjusting Squid
</I>&gt;<i>    and/or your ICAP service configuration.
</I>&gt;<i>
</I>&gt;<i> For option #1, Adaptation::Icap::ModXact::parseIcapHead() may be a good
</I>&gt;<i> starting point.
</I>&gt;<i>
</I>&gt;<i> For options #1 and #3, see also
</I>&gt;<i>
</I>&gt;<i> <A HREF="https://wiki.squid-cache.org/SquidFaq/AboutSquid#How_to_add_a_new_Squid_feature.2C_enhance.2C_of_fix_something.3F">https://wiki.squid-cache.org/SquidFaq/AboutSquid#How_to_add_a_new_Squid_feature.2C_enhance.2C_of_fix_something.3F</A>
</I>&gt;<i>
</I>&gt;<i> In most cases, option #4 is the best first step but YMMV.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> HTH,
</I>&gt;<i>
</I>&gt;<i> Alex.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> ------------------------------
</I>&gt;<i>
</I>&gt;<i> Message: 2
</I>&gt;<i> Date: Tue, 30 Oct 2018 23:59:18 -0500 (CDT)
</I>&gt;<i> From: Sid &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">SIDDH05 at gmail.com</A>&gt;
</I>&gt;<i> To: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> Subject: Re: [squid-users] Squid 4.3: SSL Bump fails to send client
</I>&gt;<i>         certificate
</I>&gt;<i> Message-ID: &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">1540961958277-0.post at n4.nabble.com</A>&gt;
</I>&gt;<i> Content-Type: text/plain; charset=us-ascii
</I>&gt;<i>
</I>&gt;<i> Thank you Alex for the reply.
</I>&gt;<i>
</I>&gt;<i> Alex: 1. Servers never send SNI. Clients usually send SNI. Squid should
</I>&gt;<i> forward SNI it received from the client to the server, provided the client
</I>&gt;<i> actually sent SNI. Did your client send SNI?
</I>&gt;<i>
</I>&gt;<i> Sid: I can see in Client Hello IP Address being sent by Client; so there is
</I>&gt;<i> no SNI from client itself.
</I>&gt;<i>
</I>&gt;<i> Alex: 2. Bugs notwithstanding, the implied order of events is not what
</I>&gt;<i> actually happens: Squid, as configured, does _not_ forward anything from
</I>&gt;<i> the
</I>&gt;<i> server certificate to the client. Squid, as configured, generates a
</I>&gt;<i> certificate based on client-supplied information (not server-supplied
</I>&gt;<i> information). After sending that generated certificate to the client, Squid
</I>&gt;<i> establishes a TLS connection with the server.
</I>&gt;<i>
</I>&gt;<i> Sid: Thank you for explanation.
</I>&gt;<i>
</I>&gt;<i> Alex: For an accurate picture, in addition to Squid-server and server-Squid
</I>&gt;<i> traffic, look at what Squid has received from the client and what Squid
</I>&gt;<i> sent
</I>&gt;<i> to the client, all in actual order.
</I>&gt;<i>
</I>&gt;<i> Sid: I took wireshark on Squid server (centOS 7); I took 2 wiresharks
</I>&gt;<i> between Client &amp; Squid and then between Squid &amp; Server. I can see client
</I>&gt;<i> being sent fake cert generated by Squid &amp; client responds with &quot;Client key
</I>&gt;<i> Exchange&quot;, &quot;Change cipher spec&quot;, &quot;Encrypted Handshake Message&quot;. But I can't
</I>&gt;<i> see actual client certificate sent to Squid. Is there a way to decypt in
</I>&gt;<i> Wireshark. In Wireshark between Squid &amp; Server I can see Squid responding
</I>&gt;<i> with &quot;61 Alert (Level: Fatal, Description: Internal Error)&quot;.
</I>&gt;<i>
</I>&gt;<i> Alex: Is your Squid configured to trust those internal CAs? If not, Squid
</I>&gt;<i> would not be able to validate the server certificate.
</I>&gt;<i>
</I>&gt;<i> Sid: I have added those chained certificates as following in squid.conf
</I>&gt;<i> tls_outgoing_options cafile=/usr/local/squid/etc/UCAppsCA.pem
</I>&gt;<i> sslproxy_foreign_intermediate_certs /usr/local/squid/etc/UCAppsCA.pem
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> --
</I>&gt;<i> Sent from:
</I>&gt;<i> <A HREF="http://squid-web-proxy-cache.1019090.n4.nabble.com/Squid-Users-f1019091.html">http://squid-web-proxy-cache.1019090.n4.nabble.com/Squid-Users-f1019091.html</A>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> ------------------------------
</I>&gt;<i>
</I>&gt;<i> Message: 3
</I>&gt;<i> Date: Wed, 31 Oct 2018 05:27:20 -0500 (CDT)
</I>&gt;<i> From: uppsalanet &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">fredrik at pipemore.se</A>&gt;
</I>&gt;<i> To: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> Subject: Re: [squid-users] redirect based on url (302)
</I>&gt;<i> Message-ID: &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">1540981640859-0.post at n4.nabble.com</A>&gt;
</I>&gt;<i> Content-Type: text/plain; charset=us-ascii
</I>&gt;<i>
</I>&gt;<i> Hi Amos,
</I>&gt;<i> Is there a git that I can use to push stuff up?
</I>&gt;<i>
</I>&gt;<i> I think you need to split the string in an other way, look into this
</I>&gt;<i> example:
</I>&gt;<i> #!/usr/bin/perl
</I>&gt;<i> use strict;
</I>&gt;<i> use warnings;
</I>&gt;<i>
</I>&gt;<i> $|=1;
</I>&gt;<i> while (&lt;&gt;) {
</I>&gt;<i>      my $string = $_;
</I>&gt;<i>      print &quot;Received '\$_' = &quot;.$_.&quot;\n&quot;;
</I>&gt;<i>
</I>&gt;<i>      $string =~ m/^(\d+)\s(.*)$/;
</I>&gt;<i>      print &quot;After regexp '\$string' = &quot;.$string.&quot;\n&quot;;
</I>&gt;<i>      print &quot;After regexp '\$1' = &quot;.$1.&quot;\n&quot;;
</I>&gt;<i>      print &quot;After regexp '\$2' = &quot;.$2.&quot;\n&quot;;
</I>&gt;<i>
</I>&gt;<i>      ### Original split from sorce ###
</I>&gt;<i>      ### This doesn't split anything looks like elements of an array?
</I>&gt;<i>      #my ($cid, $uid) = ($1, $2);
</I>&gt;<i>
</I>&gt;<i>      ### Split the string ###
</I>&gt;<i>      ### Those two split based on one or more spaces
</I>&gt;<i>      #my ($cid, $uid) = split(/\s+/ ,$_);
</I>&gt;<i>      my ($cid, $uid) = split;
</I>&gt;<i>      $cid =~ s/%(..)/pack(&quot;H*&quot;, $1)/ge;
</I>&gt;<i>      $uid =~ s/%(..)/pack(&quot;H*&quot;, $1)/ge;
</I>&gt;<i>      print &quot;After split \$cid = &quot;.$cid.&quot;\n&quot;;
</I>&gt;<i>      print &quot;After split \$uid = &quot;.$uid.&quot;\n&quot;;
</I>&gt;<i> }
</I>&gt;<i>
</I>&gt;<i> Output from above with intake value '*130.238.000.00 muse.jhu.edu -*':
</I>&gt;<i> Received '$_' = 130.238.000.00 muse.jhu.edu -
</I>&gt;<i> After regexp '$string' = 130.238.000.00 muse.jhu.edu -
</I>&gt;<i> /Use of uninitialized value $1 in concatenation (.) or string at
</I>&gt;<i> ./sed_test_reg.pl line 13, &lt;&gt; line 1.
</I>&gt;<i> After regexp '$1' =
</I>&gt;<i> Use of uninitialized value $2 in concatenation (.) or string at
</I>&gt;<i> ./sed_test_reg.pl line 14, &lt;&gt; line 1.
</I>&gt;<i> After regexp '$2' = /
</I>&gt;<i> *After split $cid = 130.238.000.00
</I>&gt;<i> After split $uid = muse.jhu.edu*
</I>&gt;<i>
</I>&gt;<i> Cheers
</I>&gt;<i> Fredrik
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> --
</I>&gt;<i> Sent from:
</I>&gt;<i> <A HREF="http://squid-web-proxy-cache.1019090.n4.nabble.com/Squid-Users-f1019091.html">http://squid-web-proxy-cache.1019090.n4.nabble.com/Squid-Users-f1019091.html</A>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> ------------------------------
</I>&gt;<i>
</I>&gt;<i> Subject: Digest Footer
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> ------------------------------
</I>&gt;<i>
</I>&gt;<i> End of squid-users Digest, Vol 50, Issue 75
</I>&gt;<i> *******************************************
</I>&gt;<i>
</I>

-- 
regards,
Arun
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20181031/4f86ec84/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20181031/4f86ec84/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="019595.html">[squid-users] Squid 3.5.25 does not recognise ICAP 408 status code
</A></li>
	<LI>Next message (by thread): <A HREF="019607.html">[squid-users] Squid 3.5.25 does not recognise ICAP 408 status code
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19603">[ date ]</a>
              <a href="thread.html#19603">[ thread ]</a>
              <a href="subject.html#19603">[ subject ]</a>
              <a href="author.html#19603">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
