<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid 3.5.25 does not recognise ICAP 408 status code
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%203.5.25%20does%20not%20recognise%20ICAP%20408%20status%0A%20code&In-Reply-To=%3C03668bc9-085e-6bd9-599f-602af2d7432b%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="019603.html">
   <LINK REL="Next"  HREF="019598.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid 3.5.25 does not recognise ICAP 408 status code</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%203.5.25%20does%20not%20recognise%20ICAP%20408%20status%0A%20code&In-Reply-To=%3C03668bc9-085e-6bd9-599f-602af2d7432b%40measurement-factory.com%3E"
       TITLE="[squid-users] Squid 3.5.25 does not recognise ICAP 408 status code">rousskov at measurement-factory.com
       </A><BR>
    <I>Wed Oct 31 19:37:13 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="019603.html">[squid-users] Squid 3.5.25 does not recognise ICAP 408 status	code
</A></li>
        <LI>Next message (by thread): <A HREF="019598.html">[squid-users] bank blocked
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19607">[ date ]</a>
              <a href="thread.html#19607">[ thread ]</a>
              <a href="subject.html#19607">[ subject ]</a>
              <a href="author.html#19607">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 10/31/18 11:20 AM, Arunabha Saha wrote:
&gt;&gt;<i>As with any timeout, it is impossible to say in general which side of
</I>&gt;&gt;<i>the connection is at fault. This case has at least three sides: It could
</I>&gt;&gt;<i>be the HTTP agent, Squid, and/or the ICAP service. Did one of them stall
</I>&gt;&gt;<i>the transaction? Or was the ICAP service just too impatient? See option
</I>&gt;&gt;<i>#4 below.
</I>
&gt;<i> I've tried to track this down.&#160; &#160;There are some&#160; persistent sockets used
</I>&gt;<i> by SaaS apps for APIs (otservice api from google sites) and sometimes
</I>&gt;<i> the HTTP response takes a long time to trickle in.&#160; I have seen upto 25
</I>&gt;<i> seconds for the response body to trickle in after the response header.
</I>
Glad you found the culprit!

&#160;
&gt;<i> The timeout at 10 seconds is somewhat aggressive so moving
</I>&gt;<i> that up should help but some code changes in either squid or icap as
</I>&gt;<i> suggested look necessary.
</I>
If you do not want to modify Squid, then the ICAP service should tell
Squid what to do with the timed out HTTP transaction (e.g., respond with
ICAP 204 or ICAP 200) instead of telling Squid that the service does not
know what to do (i.e. respond with ICAP 408). When the service does not
know what to do, Squid does not know what to do either, resulting in
transaction errors (that Squid blames the ICAP service for).

Please note that teaching Squid about the special meaning of ICAP 408
(Timeout) responses is not enough to address the problem -- Squid would
still need to know what to do with the HTTP transaction (e.g. block it,
pass through as is, or abort) and with the service (count a service
failure or ignore the timeout). Those decisions are likely to be
different for different admins/deployments.

Alex.

&gt;<i> I was referring to the c-icap implementation.
</I>
&gt;<i>     On 10/30/18 6:45 PM, Arunabha Saha wrote:
</I>&gt;<i> 
</I>&gt;<i>     &gt; Squid 3.5.25 does not seem to recognise the 408 request timeout error
</I>&gt;<i>     &gt; code from ICAP.
</I>&gt;<i> 
</I>&gt;<i>     Squid effectively recognizes ICAP 408 response as an ICAP transaction
</I>&gt;<i>     error response and blames the ICAP service for that error. That
</I>&gt;<i>     (minimal) support can be improved, of course. See options #1 and #3
</I>&gt;<i>     below.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> &#160;
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i>     Needless to say, treating all ICAP service timeouts as if nothing bad
</I>&gt;<i>     happened would break some existing Squid deployments (while possibly
</I>&gt;<i>     fixing yours). A proper general solution (option #3 below) would most
</I>&gt;<i>     likely require making Squid behavior configurable.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i>     &gt; The more troublesome issue for me is the exception it generates
</I>&gt;<i>     and then
</I>&gt;<i>     &gt; declares ICAP down after a certain number of such exceptions.&#160; &#160;&#160;
</I>&gt;<i>     &gt;
</I>&gt;<i>     &gt; I don't want to disable the failure limit entirely given that we can
</I>&gt;<i>     &gt; often have genuine failures that squid needs to detect.&#160; &#160;
</I>&gt;<i>     &gt;
</I>&gt;<i>     &gt; What i'd like to see is squid should not throw an exception in this
</I>&gt;<i>     &gt; case.
</I>&gt;<i> 
</I>&gt;<i>     The &quot;exception&quot; is a minor low-level/technical detail. What you really
</I>&gt;<i>     want to see is Squid blaming itself (rather than the ICAP service) for
</I>&gt;<i>     the problem. Squid indeed lacks that kind of functionality, but it can
</I>&gt;<i>     be added if really needed. See options #1 and #3 below.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i>     &gt; The timeout is somewhat aggressive but works with an earlier
</I>&gt;<i>     &gt; version of ICAP (0.1.x).&#160; The one i'm testing is 0.5.3.
</I>&gt;<i> 
</I>&gt;<i>     Please note that ICAP is a protocol, not a product/software name. It
</I>&gt;<i>     probably does not matter what ICAP service you are using though.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i>     &gt; Any suggestions?
</I>&gt;<i> 
</I>&gt;<i>     I can suggest a few options, in no particular order:
</I>&gt;<i> 
</I>&gt;<i>     1. Modify your Squid to treat 408 differently.
</I>&gt;<i>     2. Modify your ICAP service to stop sending ICAP 408 responses to Squid.
</I>&gt;<i>     3. Add proper ICAP timeout support feature to Squid.
</I>&gt;<i>     4. Investigate why your ICAP service times out. If you are lucky, you
</I>&gt;<i>     &#160; &#160;may be able to fix or work around the problem by adjusting Squid
</I>&gt;<i>     &#160; &#160;and/or your ICAP service configuration.
</I>&gt;<i> 
</I>&gt;<i>     For option #1, Adaptation::Icap::ModXact::parseIcapHead() may be a good
</I>&gt;<i>     starting point.
</I>&gt;<i> 
</I>&gt;<i>     For options #1 and #3, see also
</I>&gt;<i>     <A HREF="https://wiki.squid-cache.org/SquidFaq/AboutSquid#How_to_add_a_new_Squid_feature.2C_enhance.2C_of_fix_something.3F">https://wiki.squid-cache.org/SquidFaq/AboutSquid#How_to_add_a_new_Squid_feature.2C_enhance.2C_of_fix_something.3F</A>
</I>&gt;<i> 
</I>&gt;<i>     In most cases, option #4 is the best first step but YMMV.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i>     HTH,
</I>&gt;<i> 
</I>&gt;<i>     Alex.
</I>&gt;<i> 
</I>
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="019603.html">[squid-users] Squid 3.5.25 does not recognise ICAP 408 status	code
</A></li>
	<LI>Next message (by thread): <A HREF="019598.html">[squid-users] bank blocked
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19607">[ date ]</a>
              <a href="thread.html#19607">[ thread ]</a>
              <a href="subject.html#19607">[ subject ]</a>
              <a href="author.html#19607">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
