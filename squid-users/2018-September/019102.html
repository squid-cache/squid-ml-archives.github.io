<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid intermittently not sending host header to peer
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20intermittently%20not%20sending%20host%20header%20to%20peer&In-Reply-To=%3CCAEdx1fqoSNwbX4LkBcCbmuNzSTdjPWYwS6UbyAG9GugVfFp3YQ%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="019139.html">
   <LINK REL="Next"  HREF="019106.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid intermittently not sending host header to peer</H1>
    <B>Michael Thomas</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20intermittently%20not%20sending%20host%20header%20to%20peer&In-Reply-To=%3CCAEdx1fqoSNwbX4LkBcCbmuNzSTdjPWYwS6UbyAG9GugVfFp3YQ%40mail.gmail.com%3E"
       TITLE="[squid-users] Squid intermittently not sending host header to peer">michael.thomas.sw20 at gmail.com
       </A><BR>
    <I>Mon Sep  3 09:32:44 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="019139.html">[squid-users] Squid fails to bump where there are too many DNS names in SAN field
</A></li>
        <LI>Next message (by thread): <A HREF="019106.html">[squid-users] Squid intermittently not sending host header to peer
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19102">[ date ]</a>
              <a href="thread.html#19102">[ thread ]</a>
              <a href="subject.html#19102">[ subject ]</a>
              <a href="author.html#19102">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I'm trying to figure out this weird intermittent issue.

I have two squid servers running, non-caching, non-transparent.

Client -&gt; Squid1 -&gt; Squid2 -&gt; Internet

All HTTPS requests work as expected, but randomly, about 50% of the time,
HTTP requests fail.

The reason for the failure is that the first squid server (Squid1) is not
correctly forwarding the request to the second. It is stripping away the
hostname, and obviously the second squid server has no clue what to do with
it then!

Refreshing either create or resolves the issue, again, seemingly at random.

The following is a copy of the access logs for two successful requests,
followed by a failure:

Squid1:
1535965629.452     81 3.3.3.3 TCP_MISS/200 5766 GET
<A HREF="http://redacted.com/messages/391/">http://redacted.com/messages/391/</A> - FIRSTUP_PARENT/2.2.2.2 text/html
1535965634.678     71 3.3.3.3 TCP_MISS/200 5759 GET
<A HREF="http://redacted.com/messages/391/">http://redacted.com/messages/391/</A> - FIRSTUP_PARENT/2.2.2.2 text/html
1535965636.673      1 3.3.3.3 TCP_MISS/400 4009 GET
<A HREF="http://redacted.com/messages/391/">http://redacted.com/messages/391/</A> - FIRSTUP_PARENT/2.2.2.2 text/html

Squid2:
1535965629.447     79 1.1.1.1 TCP_MISS/200 5673 GET
<A HREF="http://redacted.com/messages/391/">http://redacted.com/messages/391/</A> connect HIER_DIRECT/4.4.4.4 text/html
1535965634.673     68 1.1.1.1 TCP_MISS/200 5671 GET
<A HREF="http://redacted.com/messages/391/">http://redacted.com/messages/391/</A> connect HIER_DIRECT/4.4.4.4 text/html
1535965636.668      0 1.1.1.1 TAG_NONE/400 3916 GET /messages/391/ -
HIER_NONE/- text/html

squid.conf from Squid1:
http_port 3128 name=port_3128
http_access allow all
nonhierarchical_direct off

acl port_3128_acl myportname port_3128

always_direct deny port_3128_acl

never_direct allow port_3128_acl

# 3128
cache_peer 2.2.2.2 parent 3128 0 no-query proxy-only default  name=proxy3128
cache_peer_access proxy3128 allow port_3128_acl
cache_peer_access proxy3128 deny all

squid.conf from Squid2:
http_access allow all
http_port 3128

Where:
1.1.1.1: Squid1
2.2.2.2: Squid2
3.3.3.3: client
4.4.4.4: Web Server

I can't see any obvious error in my configuration, and the intermittent
nature of it makes me think it might be some sort of bug. I'd love to hear
if anyone else has run into this.

Kind Regards,
Michael Thomas
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20180903/c48a6072/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20180903/c48a6072/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="019139.html">[squid-users] Squid fails to bump where there are too many DNS names in SAN field
</A></li>
	<LI>Next message (by thread): <A HREF="019106.html">[squid-users] Squid intermittently not sending host header to peer
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19102">[ date ]</a>
              <a href="thread.html#19102">[ thread ]</a>
              <a href="subject.html#19102">[ subject ]</a>
              <a href="author.html#19102">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
