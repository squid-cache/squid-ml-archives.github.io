<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid intermittently not sending host header to peer
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20intermittently%20not%20sending%20host%20header%20to%0A%20peer&In-Reply-To=%3C3dab3bfd-04b9-fb14-fdb7-37b119386a41%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="019108.html">
   <LINK REL="Next"  HREF="019133.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid intermittently not sending host header to peer</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20intermittently%20not%20sending%20host%20header%20to%0A%20peer&In-Reply-To=%3C3dab3bfd-04b9-fb14-fdb7-37b119386a41%40treenet.co.nz%3E"
       TITLE="[squid-users] Squid intermittently not sending host header to peer">squid3 at treenet.co.nz
       </A><BR>
    <I>Tue Sep  4 13:35:43 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="019108.html">[squid-users] Squid intermittently not sending host header to	peer
</A></li>
        <LI>Next message (by thread): <A HREF="019133.html">[squid-users] Squid intermittently not sending host header to	peer
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19116">[ date ]</a>
              <a href="thread.html#19116">[ thread ]</a>
              <a href="subject.html#19116">[ subject ]</a>
              <a href="author.html#19116">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 4/09/18 2:13 AM, Michael Thomas wrote:
&gt;<i> HI Amos,
</I>&gt;<i> 
</I>&gt;<i> Thank you for responding.
</I>&gt;<i> 
</I>&gt;<i> To clarify, when I referred to HTTPS requests, I was referring to
</I>&gt;<i> CONNECT requests - I should have been more clear, my apologies. No
</I>&gt;<i> authentication is being performed by either server, so I'm not sure what
</I>&gt;<i> you're seeing in the logs that relates to that.
</I>
The log format looks like Squid native format. On all the 200 status
transactions there is &quot;connect&quot; instead of &quot;-&quot; where that format prints
username.


&gt;<i> 
</I>&gt;<i> CONNECT requests are logged correctly on both squid servers and appear
</I>&gt;<i> to operate correctly for every request.
</I>&gt;<i> 
</I>&gt;<i> Interestingly, I was mistaken before. It's not the host header that's
</I>&gt;<i> missing - that's still present. It's the full URI within the GET request.
</I>&gt;<i> 
</I>
Nod. Squid2 is receiving an origin-form request. Such as a client would
send *inside* a CONNECT tunnel, or Squid would send on DIRECT traffic.

The former was what I suspected at first, but the message does say Via:
with Squid1 details. So somehow Squid1 must think this connection is a
DIRECT (origin) connection.


&gt;<i> As requested, here is all the information:
</I>&gt;<i> 
</I>&gt;<i> *Squid1 version and build information:*
</I>&gt;<i> Squid Cache: Version 3.5.12
</I>&gt;<i> Service Name: squid
</I>&gt;<i> Ubuntu linux
</I>
Please upgrade his machine if you can. All this may turn out to be a
side effect of one of the many bugs fixed already.


&gt;<i> 
</I>&gt;<i> Here is a verbatim copy of both squid.conf files, with sensitive
</I>&gt;<i> information replaced:
</I>&gt;<i> 
</I>&gt;<i> *Squid1:*
</I>&gt;<i> http_port 3128 name=port_3128
</I>&gt;<i> http_access allow all
</I>&gt;<i> nonhierarchical_direct off
</I>&gt;<i> 
</I>&gt;<i> acl port_3128_acl myportname port_3128
</I>&gt;<i> always_direct deny port_3128_acl
</I>&gt;<i> never_direct allow port_3128_acl
</I>
If this is our actual config there is no need for these ACLs. This Squid
already accepts *everything* it is handed which has even vague
resemblance of HTTP syntax. All they are doing is making a false
illusion of some control existing.

It should be sufficient to use:
  never_direct allow all
  cache_peer_access proxy3128 allow all


Really you should leave the security checks we put into the default
config. They are there to prevent things like Squid being instructed to
send spam email, or worse DoS'ing your internal network.


&gt;<i> 
</I>&gt;<i> # 3128
</I>&gt;<i> cache_peer 2.2.2.2 parent 3128 0 no-query proxy-only default&#160; name=proxy3128
</I>&gt;<i> cache_peer_access proxy3128 allow port_3128_acl
</I>&gt;<i> cache_peer_access proxy3128 deny all
</I>&gt;<i> debug_options 11,2
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> *Squid2:*
</I>&gt;<i> http_access allow all
</I>&gt;<i> http_port 3128
</I>&gt;<i> debug_options 11,2
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> And here is a copy of the cache.log for a failed request:
</I>&gt;<i> 
</I>&gt;<i> *Squid1:*
</I>...
&gt;<i> ----------
</I>&gt;<i> 2018/09/03 13:36:45.088 kid1| 11,2| http.cc(2234) sendRequest: HTTP
</I>&gt;<i> Server local=1.1.1.1:55718 &lt;<A HREF="http://1.1.1.1:55718/">http://1.1.1.1:55718/</A>&gt;&#160;remote=2.2.2.2:3128
</I>&gt;<i> &lt;<A HREF="http://2.2.2.2:3128/">http://2.2.2.2:3128/</A>&gt;&#160;FD 14 flags=1
</I>&gt;<i> 2018/09/03 13:36:45.089 kid1| 11,2| http.cc(2235) sendRequest: HTTP
</I>&gt;<i> Server REQUEST:
</I>&gt;<i> ---------
</I>&gt;<i> GET /messages/391/ HTTP/1.1
</I>&gt;<i> Upgrade-Insecure-Requests: 1
</I>&gt;<i> User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36
</I>&gt;<i> (KHTML, like Gecko) Chrome/68.0.3440.106 Safari/537.36
</I>&gt;<i> Accept:
</I>&gt;<i> text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8
</I>&gt;<i> Accept-Encoding: gzip, deflate
</I>&gt;<i> Accept-Language: en-US,en;q=0.9,en-GB;q=0.8
</I>&gt;<i> Cookie: __cfduid=redacted; csrftoken=redacted; sessionid=redacted;
</I>&gt;<i> _ga=redacted
</I>&gt;<i> AlexaToolbar-ALX_NS_PH: AlexaToolbar/alx-4.0.3
</I>&gt;<i> Host:&#160;redacted.com &lt;<A HREF="http://redacted.com/">http://redacted.com/</A>&gt;
</I>&gt;<i> Via: 1.1 Squid1 (squid/3.5.12)
</I>&gt;<i> X-Forwarded-For: 3.3.3.3
</I>&gt;<i> Cache-Control: max-age=0
</I>&gt;<i> Connection: keep-alive
</I>&gt;<i> 
</I>

Okay. Next thing to do is identify what Squid1 thinks type of connection
this FD is used for. Please add debug level &quot;44,3 51,3&quot; to the Squid1
config and repeat the test.



Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="019108.html">[squid-users] Squid intermittently not sending host header to	peer
</A></li>
	<LI>Next message (by thread): <A HREF="019133.html">[squid-users] Squid intermittently not sending host header to	peer
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19116">[ date ]</a>
              <a href="thread.html#19116">[ thread ]</a>
              <a href="subject.html#19116">[ subject ]</a>
              <a href="author.html#19116">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
