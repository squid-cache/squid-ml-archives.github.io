<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] About SSL peek-n-splice/bump configurations
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20About%20SSL%20peek-n-splice/bump%20configurations&In-Reply-To=%3C770057a5-3808-3fdc-5bf7-f78d09705913%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="019150.html">
   <LINK REL="Next"  HREF="019153.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] About SSL peek-n-splice/bump configurations</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20About%20SSL%20peek-n-splice/bump%20configurations&In-Reply-To=%3C770057a5-3808-3fdc-5bf7-f78d09705913%40treenet.co.nz%3E"
       TITLE="[squid-users] About SSL peek-n-splice/bump configurations">squid3 at treenet.co.nz
       </A><BR>
    <I>Fri Sep  7 04:18:10 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="019150.html">[squid-users] About SSL peek-n-splice/bump configurations
</A></li>
        <LI>Next message (by thread): <A HREF="019153.html">[squid-users] About SSL peek-n-splice/bump configurations
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19151">[ date ]</a>
              <a href="thread.html#19151">[ thread ]</a>
              <a href="subject.html#19151">[ subject ]</a>
              <a href="author.html#19151">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 7/09/18 1:48 PM, Julian Perconti wrote:&gt;
&gt;<i> Hi all,
</I>&gt;<i> 
</I>&gt;<i> I have a new strange situation:
</I>&gt;<i> 
</I>&gt;<i> With this peek-n-splice configuration:
</I>&gt;<i> 
</I>&gt;<i> ssl_bump peek step1 all
</I>&gt;<i> ssl_bump peek step2 noBumpSites
</I>&gt;<i> ssl_bump splice step3 noBumpSites
</I>&gt;<i> ssl_bump bump
</I>
So... (lets call this config A)

#step1 does this:

&gt;<i> ssl_bump peek step1 all
</I>
#step2 does this:

&gt;<i> ssl_bump peek step2 noBumpSites
</I>&gt;<i> ssl_bump bump
</I>
If the bump at step2 happened, there is no step3.

#step3 does this:

&gt;<i> ssl_bump splice step3 noBumpSites
</I>


&gt;<i> 
</I>&gt;<i> I got this error on spliced sites (a bank site):
</I>&gt;<i> 
</I>&gt;<i> The system return in the browser this error: (chrome 69):
</I>&gt;<i> 
</I>&gt;<i> (104) Connection reset by peer (TLS code: SQUID_ERR_SSL_HANDSHAKE)
</I>&gt;<i> Handshake with SSL server failed: [No Error]
</I>&gt;<i> 
</I>&gt;<i> This proxy and the remote host failed to negotiate a mutually acceptable security settings for handling your request. It is possible that the remote host does not support secure connections, or the proxy is not satisfied with the host security credentials.
</I>&gt;<i> 
</I>&gt;<i> cache.log:
</I>&gt;<i> 2018/09/06 22:40:36 kid1| ERROR: negotiating TLS on FD 44: error:00000000:lib(0):func(0):reason(0) (5/-1/104)
</I>&gt;<i> 
</I>&gt;<i> But if i change the ssl bump(s) directive to:
</I>&gt;<i> 
</I>&gt;<i> ssl_bump peek step1
</I>&gt;<i> ssl_bump splice noBumpSites
</I>&gt;<i> ssl_bump bump all
</I>&gt;<i> 
</I>
So ... (lets call this config B)

#step does this:

&gt;<i> ssl_bump peek step1
</I>
#step2 does this:

&gt;<i> ssl_bump splice noBumpSites
</I>&gt;<i> ssl_bump bump all
</I>
Notice there is never any step3, and the splice in this ruleset happens
at step2.


So config (A) is trying to do a step3 (handshake with server) when it
has only peek'ed and relayed the clientHello as-is (including any secret
tokens an unknown features the client is trying to use). The bump action
is bound to fail.
 ** &quot;stare&quot; is the action which sets up and filters the handshake ready
for bump action at step3 (server handshake with TLS features Squid knows
how to handle).


The config (B) bumps at step2. That is what the old and very broken
&quot;client-first&quot; behaviour used to be. It does not produce any errors from
the proxy BUT leads directly to a huge pile of security vulnerabilities
and nasty side effects that may never be seen by you. Use at your own risk.



&gt;<i> I can Access to spliced site and no any kind of errors in access.log
</I>&gt;<i> 
</I>&gt;<i> Any idea?
</I>
Have you read the documentation?
 &lt;<A HREF="https://wiki.squid-cache.org/Features/SslPeekAndSplice">https://wiki.squid-cache.org/Features/SslPeekAndSplice</A>&gt;

Break your rules down into the stages as I have above and what is going
on becomes a bit more clear.

Then you can consider what ssl_bump is doing in terms of what info Squid
has available.
 step1: TCP IP:port or CONNECT URI (forward-proxy only)
 step2: TLS clientHello + TLS SNI (if any)
 step3: TLS serverHello + server cert

The entire directive set is interpreted from top-to-bottom left-to-right
each step. First line to fully match is what happens for that step.


Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="019150.html">[squid-users] About SSL peek-n-splice/bump configurations
</A></li>
	<LI>Next message (by thread): <A HREF="019153.html">[squid-users] About SSL peek-n-splice/bump configurations
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19151">[ date ]</a>
              <a href="thread.html#19151">[ thread ]</a>
              <a href="subject.html#19151">[ subject ]</a>
              <a href="author.html#19151">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
