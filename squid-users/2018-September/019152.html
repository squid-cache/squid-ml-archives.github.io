<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] About SSL peek-n-splice/bump configurations
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20About%20SSL%20peek-n-splice/bump%20configurations&In-Reply-To=%3C91d0f215-18cc-c904-aa48-523ab5ce7b39%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="019303.html">
   <LINK REL="Next"  HREF="019155.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] About SSL peek-n-splice/bump configurations</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20About%20SSL%20peek-n-splice/bump%20configurations&In-Reply-To=%3C91d0f215-18cc-c904-aa48-523ab5ce7b39%40measurement-factory.com%3E"
       TITLE="[squid-users] About SSL peek-n-splice/bump configurations">rousskov at measurement-factory.com
       </A><BR>
    <I>Fri Sep  7 04:20:21 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="019303.html">[squid-users] About SSL peek-n-splice/bump configurations
</A></li>
        <LI>Next message (by thread): <A HREF="019155.html">[squid-users] Could compile squid with --enable-storeio
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19152">[ date ]</a>
              <a href="thread.html#19152">[ thread ]</a>
              <a href="subject.html#19152">[ subject ]</a>
              <a href="author.html#19152">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 09/06/2018 07:48 PM, Julian Perconti wrote:

&gt;<i> With this peek-n-splice configuration:
</I>&gt;<i> 
</I>&gt;<i> ssl_bump peek step1 all
</I>&gt;<i> ssl_bump peek step2 noBumpSites
</I>&gt;<i> ssl_bump splice step3 noBumpSites
</I>&gt;<i> ssl_bump bump
</I>&gt;<i> 
</I>&gt;<i> I got this error on spliced sites (a bank site):
</I>
&gt;<i> (104) Connection reset by peer (TLS code: SQUID_ERR_SSL_HANDSHAKE)
</I>&gt;<i> Handshake with SSL server failed: [No Error]
</I>
&gt;<i> 2018/09/06 22:40:36 kid1| ERROR: negotiating TLS on FD 44: error:00000000:lib(0):func(0):reason(0) (5/-1/104)
</I>
OK, so the origin server is resetting a connection when Squid talk to
it. Does that happen during the peek (step2), splice (step3), or bump
(step3) rule?

One way to answer that question is to post an ALL,9 log of the isolated
failing transaction for a developer to tell you what is going on.

Another way is to replace a suspected rule with, say, an &quot;ssl_bump
terminate all&quot; rule and see if anything changes (going from the last
suspected rule up towards the first one until something does change).

There are other ways as well, of course.


&gt;<i> But if i change the ssl bump(s) directive to:
</I>&gt;<i> 
</I>&gt;<i> ssl_bump peek step1
</I>&gt;<i> ssl_bump splice noBumpSites
</I>&gt;<i> ssl_bump bump all
</I>&gt;<i> 
</I>&gt;<i> I can Access to spliced site and no any kind of errors in access.log
</I>&gt;<i> 
</I>&gt;<i> Any idea?
</I>
My working theory is that your noBumpSites (i.e. ssl::server_name_regex)
ACL matches at step2 but does not match at step3. That is just a guess,
and, even if it is correct, it does not fully explain what Squid does in
that case and why the peer resets the connection.


HTH,

Alex.

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="019303.html">[squid-users] About SSL peek-n-splice/bump configurations
</A></li>
	<LI>Next message (by thread): <A HREF="019155.html">[squid-users] Could compile squid with --enable-storeio
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19152">[ date ]</a>
              <a href="thread.html#19152">[ thread ]</a>
              <a href="subject.html#19152">[ subject ]</a>
              <a href="author.html#19152">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
