<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] About SSL peek-n-splice/bump configurations
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20About%20SSL%20peek-n-splice/bump%20configurations&In-Reply-To=%3C8264c402-9b3c-5da7-0d2a-9d7b0d66952f%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="019151.html">
   <LINK REL="Next"  HREF="019162.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] About SSL peek-n-splice/bump configurations</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20About%20SSL%20peek-n-splice/bump%20configurations&In-Reply-To=%3C8264c402-9b3c-5da7-0d2a-9d7b0d66952f%40measurement-factory.com%3E"
       TITLE="[squid-users] About SSL peek-n-splice/bump configurations">rousskov at measurement-factory.com
       </A><BR>
    <I>Fri Sep  7 04:47:15 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="019151.html">[squid-users] About SSL peek-n-splice/bump configurations
</A></li>
        <LI>Next message (by thread): <A HREF="019162.html">[squid-users] About SSL peek-n-splice/bump configurations
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19153">[ date ]</a>
              <a href="thread.html#19153">[ thread ]</a>
              <a href="subject.html#19153">[ subject ]</a>
              <a href="author.html#19153">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 09/06/2018 10:18 PM, Amos Jeffries wrote:

&gt;<i> So... (lets call this config A)
</I>&gt;<i> 
</I>&gt;<i> #step1 does this:
</I>&gt;<i> 
</I>&gt;&gt;<i> ssl_bump peek step1 all
</I>&gt;<i> 
</I>&gt;<i> #step2 does this:
</I>&gt;<i> 
</I>&gt;&gt;<i> ssl_bump peek step2 noBumpSites
</I>&gt;&gt;<i> ssl_bump bump
</I>&gt;<i> 
</I>&gt;<i> If the bump at step2 happened, there is no step3.
</I>&gt;<i> 
</I>&gt;<i> #step3 does this:
</I>&gt;<i> 
</I>&gt;&gt;<i> ssl_bump splice step3 noBumpSites
</I>
You should also add this to step3 if the bump did not happen at step2
(i.e. if noBumpSites matched at step2):

   ssl_bump bump


&gt;<i> So ... (lets call this config B)
</I>&gt;<i> 
</I>&gt;<i> #step does this:
</I>&gt;<i> 
</I>&gt;&gt;<i> ssl_bump peek step1
</I>&gt;<i> 
</I>&gt;<i> #step2 does this:
</I>&gt;<i> 
</I>&gt;&gt;<i> ssl_bump splice noBumpSites
</I>&gt;&gt;<i> ssl_bump bump all
</I>&gt;<i> 
</I>&gt;<i> Notice there is never any step3, and the splice in this ruleset happens
</I>&gt;<i> at step2.
</I>
Correct (assuming noBumpSites matches at step2).


&gt;<i> So config (A) is trying to do a step3 (handshake with server) when it
</I>&gt;<i> has only peek'ed and relayed the clientHello as-is (including any secret
</I>&gt;<i> tokens an unknown features the client is trying to use).
</I>
The handshake with the server actually started during step2 (SSL Hellos
were exchanged). The SSL negotiation (if any) completes during step3,
most likely without Squid participation (because Squid is just splicing
at TCP level). If Squid does try to participate in that SSL negotiation,
then it is a Squid bug (see below), and, like you said below, the
handshake will fail because Squid has forwarded client information
without knowing client secrets.


&gt;<i> The bump action is bound to fail.
</I>
IIRC, the bump action should be ignored by Squid at step3 because it
becomes banned by peeking at step2. Bugs notwithstanding,
banned/impossible actions should be ignored. Instead, the connections
should be spliced at step3 if no rule matches at step3 because the last
matching rule at step2 was &quot;peek&quot;, indicating a splicing intent. Again,
I do not know whether the Squid actually does what it is supposed to do
in this case.


&gt;<i> The config (B) bumps at step2.
</I>
It also splices banks at step2. It is possible that the working test
case is spliced at step2 when using config B (and that is why it works).


&gt;<i> Then you can consider what ssl_bump is doing in terms of what info Squid
</I>&gt;<i> has available.
</I>&gt;<i>  step1: TCP IP:port or CONNECT URI (forward-proxy only)
</I>&gt;<i>  step2: TLS clientHello + TLS SNI (if any)
</I>&gt;<i>  step3: TLS serverHello + server cert
</I>&gt;<i> 
</I>&gt;<i> The entire directive set is interpreted from top-to-bottom left-to-right
</I>&gt;<i> each step. First line to fully match is what happens for that step.
</I>
Correct.


Cheers,

Alex.

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="019151.html">[squid-users] About SSL peek-n-splice/bump configurations
</A></li>
	<LI>Next message (by thread): <A HREF="019162.html">[squid-users] About SSL peek-n-splice/bump configurations
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19153">[ date ]</a>
              <a href="thread.html#19153">[ thread ]</a>
              <a href="subject.html#19153">[ subject ]</a>
              <a href="author.html#19153">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
