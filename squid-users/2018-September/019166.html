<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] About SSL peek-n-splice/bump configurations
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20About%20SSL%20peek-n-splice/bump%20configurations&In-Reply-To=%3Cc7a4d318-c335-03de-9e5c-73fc258e38c0%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="019162.html">
   <LINK REL="Next"  HREF="019174.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] About SSL peek-n-splice/bump configurations</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20About%20SSL%20peek-n-splice/bump%20configurations&In-Reply-To=%3Cc7a4d318-c335-03de-9e5c-73fc258e38c0%40treenet.co.nz%3E"
       TITLE="[squid-users] About SSL peek-n-splice/bump configurations">squid3 at treenet.co.nz
       </A><BR>
    <I>Fri Sep  7 18:19:08 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="019162.html">[squid-users] About SSL peek-n-splice/bump configurations
</A></li>
        <LI>Next message (by thread): <A HREF="019174.html">[squid-users] About SSL peek-n-splice/bump configurations
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19166">[ date ]</a>
              <a href="thread.html#19166">[ thread ]</a>
              <a href="subject.html#19166">[ subject ]</a>
              <a href="author.html#19166">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 8/09/18 4:58 AM, Julian Perconti wrote:
&gt;&gt;<i> De: Amos Jeffries
</I>&gt;&gt;<i> On 7/09/18 1:48 PM, Julian Perconti wrote:&gt;
</I>&gt;&gt;&gt;<i> Hi all,
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> I have a new strange situation:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> With this peek-n-splice configuration:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> ssl_bump peek step1 all
</I>&gt;&gt;&gt;<i> ssl_bump peek step2 noBumpSites
</I>&gt;&gt;&gt;<i> ssl_bump splice step3 noBumpSites
</I>&gt;&gt;&gt;<i> ssl_bump bump
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> So... (lets call this config A)
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> #step1 does this:
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> ssl_bump peek step1 all
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> #step2 does this:
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> ssl_bump peek step2 noBumpSites
</I>&gt;&gt;&gt;<i> ssl_bump bump
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> If the bump at step2 happened, there is no step3.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> #step3 does this:
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> ssl_bump splice step3 noBumpSites
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> I got this error on spliced sites (a bank site):
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> The system return in the browser this error: (chrome 69):
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> (104) Connection reset by peer (TLS code: SQUID_ERR_SSL_HANDSHAKE)
</I>&gt;&gt;&gt;<i> Handshake with SSL server failed: [No Error]
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> This proxy and the remote host failed to negotiate a mutually acceptable
</I>&gt;&gt;<i> security settings for handling your request. It is possible that the remote host
</I>&gt;&gt;<i> does not support secure connections, or the proxy is not satisfied with the
</I>&gt;&gt;<i> host security credentials.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> cache.log:
</I>&gt;&gt;&gt;<i> 2018/09/06 22:40:36 kid1| ERROR: negotiating TLS on FD 44:
</I>&gt;&gt;&gt;<i> error:00000000:lib(0):func(0):reason(0) (5/-1/104)
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> But if i change the ssl bump(s) directive to:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> ssl_bump peek step1
</I>&gt;&gt;&gt;<i> ssl_bump splice noBumpSites
</I>&gt;&gt;&gt;<i> ssl_bump bump all
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> So ... (lets call this config B)
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> #step does this:
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> ssl_bump peek step1
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> #step2 does this:
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> ssl_bump splice noBumpSites
</I>&gt;&gt;&gt;<i> ssl_bump bump all
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Notice there is never any step3, and the splice in this ruleset happens at
</I>&gt;&gt;<i> step2.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> So config (A) is trying to do a step3 (handshake with server) when it has only
</I>&gt;&gt;<i> peek'ed and relayed the clientHello as-is (including any secret tokens an
</I>&gt;&gt;<i> unknown features the client is trying to use). The bump action is bound to
</I>&gt;&gt;<i> fail.
</I>&gt;&gt;<i>  ** &quot;stare&quot; is the action which sets up and filters the handshake ready for
</I>&gt;&gt;<i> bump action at step3 (server handshake with TLS features Squid knows how
</I>&gt;&gt;<i> to handle).
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> So from <A HREF="http://marek.helion.pl/install/squid.html">http://marek.helion.pl/install/squid.html</A>
</I>&gt;<i> 
</I>&gt;<i> We have this configs:
</I>&gt;<i> 
</I>&gt;<i> ssl_bump peek step1 all
</I>&gt;<i> ssl_bump peek step2 noBumpSites
</I>&gt;<i> ssl_bump splice step3 noBumpSites
</I>&gt;<i> ssl_bump stare step2
</I>&gt;<i> ssl_bump bump step3
</I>&gt;<i> 
</I>&gt;<i> Is better to use the above conf (staring at step2)? Because you said that bump at step2 is insecure.
</I>&gt;<i> 
</I>&gt;<i> Is the same if a I change the order of the above conf to:
</I>&gt;<i> 
</I>&gt;<i> ssl_bump peek step1 all
</I>&gt;<i> ssl_bump peek step2 noBumpSites
</I>&gt;<i> ssl_bump stare step2 &lt;&lt;&lt; order changed
</I>&gt;<i> ssl_bump splice step3 noBumpSites
</I>&gt;<i> ssl_bump bump step3
</I>&gt;<i> 
</I>
What exactly do you think the step1, step2, step3 ACLs here are doing?

I hoped it is obvious, but maybe not. Understanding that detail should
help resolve at least some of your confusion about these config snippets
and how &quot;tiny&quot; changes to them are affecting Squid behaviour in major ways.


&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The config (B) bumps at step2. That is what the old and very broken &quot;client-
</I>&gt;&gt;<i> first&quot; behaviour used to be. It does not produce any errors from the proxy
</I>&gt;&gt;<i> BUT leads directly to a huge pile of security vulnerabilities and nasty side
</I>&gt;&gt;<i> effects that may never be seen by you. Use at your own risk.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;<i> 
</I>&gt;<i> So in a brief I think that  config A is more secure.
</I>&gt;<i> 
</I>
No. Config (A) from the earlier post actively *creates* insecurity by;

 1) hiding any information about the real server security level,
    - downgrade attacks. Right down to plaintext levels.

 2) hiding any information about the server certificate validity,
    - silent third-party MITM.
    - invalid certificate attacks.

 3) opening the server connection to multiplexed use from multiple
clients of Squid,
   - consider that in light of (1) and (2)




&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> I can Access to spliced site and no any kind of errors in access.log
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Any idea?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Have you read the documentation?
</I>&gt;&gt;<i>  &lt;<A HREF="https://wiki.squid-cache.org/Features/SslPeekAndSplice">https://wiki.squid-cache.org/Features/SslPeekAndSplice</A>&gt;
</I>&gt;<i> 
</I>&gt;<i> Yes I did, but the thing is (still for me) a bit complex, see what the autor of the link posted above said about the squid TLS.
</I>&gt;<i> 
</I>
I assume you mean Alex, that page is a true community effort with
several authors. He is &quot;just&quot; the latest to update the info as Squid
changed and/or better ways to write the info were found. Both of us are
in the main dev team on Squid and neither authored the actual ssl_bump
processing code.

Note that my descriptions are at time hedged with &quot;should&quot;, &quot;may&quot;, &quot;if&quot;,
etc and Alex outright mentions possible bugs along with similar terms.


Any suggestions towards simplifying the wiki details, or presenting them
in an easier to read way would be welcome.


&gt;&gt;<i>
</I>&gt;&gt;<i> Break your rules down into the stages as I have above and what is going on
</I>&gt;&gt;<i> becomes a bit more clear.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Then you can consider what ssl_bump is doing in terms of what info Squid
</I>&gt;&gt;<i> has available.
</I>&gt;&gt;<i>  step1: TCP IP:port or CONNECT URI (forward-proxy only)
</I>&gt;&gt;<i>  step2: TLS clientHello + TLS SNI (if any)
</I>&gt;&gt;<i>  step3: TLS serverHello + server cert
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The entire directive set is interpreted from top-to-bottom left-to-right each
</I>&gt;&gt;<i> step. First line to fully match is what happens for that step.
</I>&gt;<i> 
</I>&gt;<i> Above in the current thread, there is a question about the order of steps.
</I>&gt;<i> 
</I>
The &quot;steps&quot; are messages of the TLS handshake and Squid processing code.
They happen as per the wiki page section &quot;Processing steps&quot;. My above is
a summary of the *data* available at each step at the time each ssl_bump
processing occurs.

The variable things are what info the client and server are providing,
and what your locally defined ACLs (like the &quot;noBumpSites&quot;) are actually
matching on when tested.

There is also the fact that all this code is still quite volatile so the
code changes nearly every release or so, and parts of it all are buggy -
some we know about, some not yet. See above about both Alex and I
hedging our descriptions a bit at times where things become
non-deterministic.


&gt;<i> However I test (today) the site that caused (yesterday) the handshake problem and with the original config and now works, so I dont know what to think what could be happened.
</I>
TLS is quite a volatile environment. It could be many things.

Unfortunately it also means further learning we might all get about this
failure situation is not likely to happen any time soon.

&gt;<i> I refer to this with the term &quot;original config&quot;:
</I>&gt;<i> 
</I>&gt;<i> ssl_bump peek step1 all
</I>&gt;<i> ssl_bump peek step2 noBumpSites
</I>&gt;<i> ssl_bump splice step3 noBumpSites
</I>&gt;<i> ssl_bump bump
</I>&gt;<i> 
</I>
Even though this works on your previously broken site as well as others
it still has the problems related to bump sometimes happening at step2
before server details are known to your Squid.


Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="019162.html">[squid-users] About SSL peek-n-splice/bump configurations
</A></li>
	<LI>Next message (by thread): <A HREF="019174.html">[squid-users] About SSL peek-n-splice/bump configurations
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19166">[ date ]</a>
              <a href="thread.html#19166">[ thread ]</a>
              <a href="subject.html#19166">[ subject ]</a>
              <a href="author.html#19166">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
