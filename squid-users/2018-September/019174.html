<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] About SSL peek-n-splice/bump configurations
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20About%20SSL%20peek-n-splice/bump%20configurations&In-Reply-To=%3C008001d4479b%24b22b9290%241682b7b0%24%40yahoo.com.ar%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="019166.html">
   <LINK REL="Next"  HREF="019175.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] About SSL peek-n-splice/bump configurations</H1>
    <B>Julian Perconti</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20About%20SSL%20peek-n-splice/bump%20configurations&In-Reply-To=%3C008001d4479b%24b22b9290%241682b7b0%24%40yahoo.com.ar%3E"
       TITLE="[squid-users] About SSL peek-n-splice/bump configurations">vh1988 at yahoo.com.ar
       </A><BR>
    <I>Sat Sep  8 17:45:10 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="019166.html">[squid-users] About SSL peek-n-splice/bump configurations
</A></li>
        <LI>Next message (by thread): <A HREF="019175.html">[squid-users] About SSL peek-n-splice/bump configurations
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19174">[ date ]</a>
              <a href="thread.html#19174">[ thread ]</a>
              <a href="subject.html#19174">[ subject ]</a>
              <a href="author.html#19174">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>&gt;<i> -----Mensaje original-----
</I>&gt;<i> De: squid-users &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>&gt; En nombre de
</I>&gt;<i> Amos Jeffries
</I>&gt;<i> Enviado el: viernes, 7 de septiembre de 2018 15:19
</I>&gt;<i> Para: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> Asunto: Re: [squid-users] About SSL peek-n-splice/bump configurations
</I>&gt;<i> 
</I>&gt;<i> &gt; So from <A HREF="http://marek.helion.pl/install/squid.html">http://marek.helion.pl/install/squid.html</A>
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; We have this configs:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; ssl_bump peek step1 all
</I>&gt;<i> &gt; ssl_bump peek step2 noBumpSites
</I>&gt;<i> &gt; ssl_bump splice step3 noBumpSites
</I>&gt;<i> &gt; ssl_bump stare step2
</I>&gt;<i> &gt; ssl_bump bump step3
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Is better to use the above conf (staring at step2)? Because you said that
</I>&gt;<i> bump at step2 is insecure.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Is the same if a I change the order of the above conf to:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; ssl_bump peek step1 all
</I>&gt;<i> &gt; ssl_bump peek step2 noBumpSites
</I>&gt;<i> &gt; ssl_bump stare step2 &lt;&lt;&lt; order changed ssl_bump splice step3
</I>&gt;<i> &gt; noBumpSites ssl_bump bump step3
</I>&gt;<i> &gt;
</I>&gt;<i> 
</I>&gt;<i> What exactly do you think the step1, step2, step3 ACLs here are doing?
</I>
I don not know what -exactly- these ACL are doing; that is what I trying to find out.
I have some ideas about them, but not the exactly knowledge, for that reason I asked if there is difference between those 2 configs order (because the step is the same)

&gt;<i> 
</I>&gt;<i> I hoped it is obvious, but maybe not. Understanding that detail should
</I>&gt;<i> help resolve at least some of your confusion about these config snippets
</I>&gt;<i> and how &quot;tiny&quot; changes to them are affecting Squid behaviour in major ways.
</I>&gt;<i> 
</I>
No, it isn't obviuos to me, and yes, I am still trying to understand by re-reading wiki squid doc and other sites about peek and splice decisions and about the steps too.

&gt;<i> 
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; So in a brief I think that  config A is more secure.
</I>&gt;<i> &gt;
</I>&gt;<i> 
</I>&gt;<i> No. Config (A) from the earlier post actively *creates* insecurity by;
</I>
But,according to <A HREF="http://marek.helion.pl/install/squid.html;">http://marek.helion.pl/install/squid.html;</A> It's supposed that config  &quot;A&quot; check server certificate. Because it is peeking at step2 and splicing at step3 the whitelist sites.

&gt;<i> 
</I>&gt;<i>  1) hiding any information about the real server security level,
</I>&gt;<i>     - downgrade attacks. Right down to plaintext levels.
</I>&gt;<i> 
</I>&gt;<i>  2) hiding any information about the server certificate validity,
</I>&gt;<i>     - silent third-party MITM.
</I>&gt;<i>     - invalid certificate attacks.
</I>&gt;<i> 
</I>&gt;<i>  3) opening the server connection to multiplexed use from multiple
</I>&gt;<i> clients of Squid,
</I>&gt;<i>    - consider that in light of (1) and (2)
</I>
I dont understand, in earlier post:

&gt;&gt;<i> ssl_bump peek step1 all
</I>&gt;&gt;<i> ssl_bump peek step2 noBumpSites
</I>&gt;&gt;<i> ssl_bump splice step3 noBumpSites
</I>&gt;&gt;<i> ssl_bump bump
</I>&gt;&gt;<i>
</I>&gt;<i>So... (lets call this config A)
</I>
In this config I think the problem is that squid is peeking at step2 noBumpSites; but also bump all other sites at step2 (there is no step specified in the last line -the bump-)

Therefore I think that would be &quot;better&quot; or &quot; less insecure&quot; bumping at step3.

Conlusion based on these words:

&gt;<i> So config (A) is trying to do a step3 (handshake with server) when it 
</I>&gt;<i> has only peek'ed and relayed the clientHello as-is (including any 
</I>&gt;<i> secret tokens an unknown features the client is trying to use). The 
</I>&gt;<i> bump action is bound to fail.
</I>&gt;<i>  ** &quot;stare&quot; is the action which sets up and filters the handshake 
</I>&gt;<i> ready for bump action at step3 (server handshake with TLS features 
</I>&gt;<i> Squid knows how to handle).
</I>
I think that my config would be something like this:

ssl_bump peek step1 all

ssl_bump peek step2 noBumpSites 

&gt;<i>From squid doc:
</I>&quot;When a peek rule matches during step 2, Squid proceeds to step3 where it parses the TLS Server Hello and extracts server certificate while preserving the possibility of splicing the client and server connections; peeking at the server certificate usually precludes future bumping&quot;

And from <A HREF="http://marek.helion.pl/install/squid.html">http://marek.helion.pl/install/squid.html</A>
Peeking at step 2 will check the name stored in server certificate (CommonName, SubjectAltName) as well. So let's do it! you must enable peek at step 2 and finally splice at step3 (if certName matches the whitelist)

ssl_bump splice step3 noBumpSites
(following the ruleset explained above)

And here I believe that the final bump should be make at step3:

ssl_bump bump step3	

OR there is no difference if i dont specify the step in the bump line?

summarizing:

ssl_bump peek step1 all
ssl_bump peek step2 noBumpSites
ssl_bump splice step3 noBumpSites
ssl_bump bump step3

EDIT:
Before send this mail to list, I test the squid behaviour and if I dont add a stare (dont know why this happens, stare is the less used option I saw in many examples on the web) line at step2, all accesed site are spliced; so my final config would be taken from helion.pl: (almost defeated by this thread/topic)

ssl_bump peek step1 all               	# at step 1 we're peeking at client TLS-request in order to find the &quot;SNI&quot;
ssl_bump peek step2 nobumpSites       	# here we're peeking at server certificate
ssl_bump splice step3 nobumpSites     	# here we're splicing connections which match the whitelist
ssl_bump stare step2                  		# here we're staring at server certificate
ssl_bump bump step3                   	# finally we're bumping all other SSL connections at step 3

The autor of helion.pl says:

&quot;Honestly I don't see a reason to stare at the server certificate before bumping. Even without &quot;staring&quot; the fake-certificate has the same attributes (Common Name etc.) like the original one. But it might change in the future...&quot;

So I leave the stare line to avoid splice all the traffic.

Thank You again.

Squid Cache: Version 4.2-20180902-r6d8f397
Service Name: squid

This binary uses OpenSSL 1.1.0f  25 May 2017. For legal restrictions on distribution see <A HREF="https://www.openssl.org/source/license.html">https://www.openssl.org/source/license.html</A>

configure options:  '--prefix=/usr' '--build=x86_64-linux-gnu' '--localstatedir=/var/squid' '--libexecdir=/lib/squid' '--srcdir=.' '--datadir=/share/squid' '--disable-maintainer-mode' '--disable-dependency-tracking' '--disable-silent-rules' '--with-cppunit-basedir=/usr' '--enable-inline' '--enable-async-io=8' '--enable-delay-pools' '--enable-underscores' '--sysconfdir=/etc/squid' '--with-logdir=/var/log/squid' '--with-pidfile=/var/run/squid.pid' '--with-openssl' '--enable-ssl-crtd' '--mandir=/share/man' '--enable-arp-acl' '--enable-esi' '--enable-zph-qos' '--enable-wccpv2' '--with-filedescriptors=65536' '--with-large-files' '--with-default-user=proxy' '--enable-linux-netfilter' '--enable-follow-x-forwarded-for' '--enable-storeio=ufs,aufs,diskd' '--enable-removal-policies=lru,heap' '--enable-icap' '--enable-icap-client' '--enable-cache-digests' '--enable-async-io' '--enable-poll' '--enable-truncate' '--disable-ident-lookups' '--disable-translation' 'build_alias=x86_64-linux-gnu' 'CFLAGS=-g -O2 -fPIE -fstack-protector --param=ssp-buffer-size=4 -Wformat -Werror=format-security -Wall' 'LDFLAGS=-fPIE -pie -Wl,-z,relro -Wl,-z,now' 'CPPFLAGS=-D_FORTIFY_SOURCE=2' 'CXXFLAGS=-g -O2 -fPIE -fstack-protector --param=ssp-buffer-size=4 -Wformat -Werror=format-security'

&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt;&gt; I can Access to spliced site and no any kind of errors in access.log
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt; Any idea?
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; Have you read the documentation?
</I>&gt;<i> &gt;&gt;  &lt;<A HREF="https://wiki.squid-cache.org/Features/SslPeekAndSplice">https://wiki.squid-cache.org/Features/SslPeekAndSplice</A>&gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Yes I did, but the thing is (still for me) a bit complex, see what the autor of
</I>&gt;<i> the link posted above said about the squid TLS.
</I>&gt;<i> &gt;
</I>&gt;<i> 
</I>&gt;<i> I assume you mean Alex, that page is a true community effort with
</I>&gt;<i> several authors. He is &quot;just&quot; the latest to update the info as Squid
</I>&gt;<i> changed and/or better ways to write the info were found. Both of us are
</I>&gt;<i> in the main dev team on Squid and neither authored the actual ssl_bump
</I>&gt;<i> processing code.
</I>
I refered to this page: <A HREF="http://marek.helion.pl/install/squid.html">http://marek.helion.pl/install/squid.html</A>

&gt;<i> 
</I>&gt;<i> Note that my descriptions are at time hedged with &quot;should&quot;, &quot;may&quot;, &quot;if&quot;,
</I>&gt;<i> etc and Alex outright mentions possible bugs along with similar terms.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Any suggestions towards simplifying the wiki details, or presenting them
</I>&gt;<i> in an easier to read way would be welcome.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; Break your rules down into the stages as I have above and what is going
</I>&gt;<i> on
</I>&gt;<i> &gt;&gt; becomes a bit more clear.
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; Then you can consider what ssl_bump is doing in terms of what info Squid
</I>&gt;<i> &gt;&gt; has available.
</I>&gt;<i> &gt;&gt;  step1: TCP IP:port or CONNECT URI (forward-proxy only)
</I>&gt;<i> &gt;&gt;  step2: TLS clientHello + TLS SNI (if any)
</I>&gt;<i> &gt;&gt;  step3: TLS serverHello + server cert
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; The entire directive set is interpreted from top-to-bottom left-to-right
</I>&gt;<i> each
</I>&gt;<i> &gt;&gt; step. First line to fully match is what happens for that step.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Above in the current thread, there is a question about the order of steps.
</I>&gt;<i> &gt;
</I>&gt;<i> 
</I>&gt;<i> The &quot;steps&quot; are messages of the TLS handshake and Squid processing code.
</I>&gt;<i> They happen as per the wiki page section &quot;Processing steps&quot;. My above is
</I>&gt;<i> a summary of the *data* available at each step at the time each ssl_bump
</I>&gt;<i> processing occurs.
</I>&gt;<i> 
</I>&gt;<i> The variable things are what info the client and server are providing,
</I>&gt;<i> and what your locally defined ACLs (like the &quot;noBumpSites&quot;) are actually
</I>&gt;<i> matching on when tested.
</I>&gt;<i> 
</I>&gt;<i> There is also the fact that all this code is still quite volatile so the
</I>&gt;<i> code changes nearly every release or so, and parts of it all are buggy -
</I>&gt;<i> some we know about, some not yet. See above about both Alex and I
</I>&gt;<i> hedging our descriptions a bit at times where things become
</I>&gt;<i> non-deterministic.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> &gt; However I test (today) the site that caused (yesterday) the handshake
</I>&gt;<i> problem and with the original config and now works, so I dont know what to
</I>&gt;<i> think what could be happened.
</I>&gt;<i> 
</I>&gt;<i> TLS is quite a volatile environment. It could be many things.
</I>&gt;<i> 
</I>&gt;<i> Unfortunately it also means further learning we might all get about this
</I>&gt;<i> failure situation is not likely to happen any time soon.
</I>&gt;<i> 
</I>&gt;<i> &gt; I refer to this with the term &quot;original config&quot;:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; ssl_bump peek step1 all
</I>&gt;<i> &gt; ssl_bump peek step2 noBumpSites
</I>&gt;<i> &gt; ssl_bump splice step3 noBumpSites
</I>&gt;<i> &gt; ssl_bump bump
</I>&gt;<i> &gt;
</I>&gt;<i> 
</I>&gt;<i> Even though this works on your previously broken site as well as others
</I>&gt;<i> it still has the problems related to bump sometimes happening at step2
</I>&gt;<i> before server details are known to your Squid.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Amos
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="019166.html">[squid-users] About SSL peek-n-splice/bump configurations
</A></li>
	<LI>Next message (by thread): <A HREF="019175.html">[squid-users] About SSL peek-n-splice/bump configurations
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19174">[ date ]</a>
              <a href="thread.html#19174">[ thread ]</a>
              <a href="subject.html#19174">[ subject ]</a>
              <a href="author.html#19174">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
