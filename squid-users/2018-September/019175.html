<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] About SSL peek-n-splice/bump configurations
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20About%20SSL%20peek-n-splice/bump%20configurations&In-Reply-To=%3C04c7931e-cb29-80d1-2a2a-8a1ccb4761f5%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="019174.html">
   <LINK REL="Next"  HREF="019176.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] About SSL peek-n-splice/bump configurations</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20About%20SSL%20peek-n-splice/bump%20configurations&In-Reply-To=%3C04c7931e-cb29-80d1-2a2a-8a1ccb4761f5%40treenet.co.nz%3E"
       TITLE="[squid-users] About SSL peek-n-splice/bump configurations">squid3 at treenet.co.nz
       </A><BR>
    <I>Sun Sep  9 05:34:30 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="019174.html">[squid-users] About SSL peek-n-splice/bump configurations
</A></li>
        <LI>Next message (by thread): <A HREF="019176.html">[squid-users] About SSL peek-n-splice/bump configurations
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19175">[ date ]</a>
              <a href="thread.html#19175">[ thread ]</a>
              <a href="subject.html#19175">[ subject ]</a>
              <a href="author.html#19175">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 9/09/18 5:45 AM, Julian Perconti wrote:
&gt;&gt;<i> -----Mensaje original-----
</I>&gt;&gt;<i> De: squid-users &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>&gt; En nombre de
</I>&gt;&gt;<i> Amos Jeffries
</I>&gt;&gt;<i> Enviado el: viernes, 7 de septiembre de 2018 15:19
</I>&gt;&gt;<i> Para: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;&gt;<i> Asunto: Re: [squid-users] About SSL peek-n-splice/bump configurations
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> So from <A HREF="http://marek.helion.pl/install/squid.html">http://marek.helion.pl/install/squid.html</A>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> We have this configs:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> ssl_bump peek step1 all
</I>&gt;&gt;&gt;<i> ssl_bump peek step2 noBumpSites
</I>&gt;&gt;&gt;<i> ssl_bump splice step3 noBumpSites
</I>&gt;&gt;&gt;<i> ssl_bump stare step2
</I>&gt;&gt;&gt;<i> ssl_bump bump step3
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Is better to use the above conf (staring at step2)? Because you said that
</I>&gt;&gt;<i> bump at step2 is insecure.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Is the same if a I change the order of the above conf to:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> ssl_bump peek step1 all
</I>&gt;&gt;&gt;<i> ssl_bump peek step2 noBumpSites
</I>&gt;&gt;&gt;<i> ssl_bump stare step2 &lt;&lt;&lt; order changed ssl_bump splice step3
</I>&gt;&gt;&gt;<i> noBumpSites ssl_bump bump step3
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> What exactly do you think the step1, step2, step3 ACLs here are doing?
</I>&gt;<i> 
</I>&gt;<i> I don not know what -exactly- these ACL are doing; that is what I trying to find out.
</I>&gt;<i> I have some ideas about them, but not the exactly knowledge, for that reason I asked if there is difference between those 2 configs order (because the step is the same)
</I>
Okay. When ssl_bump is being processed the first time SslBump1 matches
as true, the second time SslBump2 is true, and third time for SslBump3.
Outside their own step in the TLS handshake process they match false.

This is how you select that a certain line in ssl_bump is *only* to
match and happen at a certain part (step) of the handshake sequence.

&gt;<i> 
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I hoped it is obvious, but maybe not. Understanding that detail should
</I>&gt;&gt;<i> help resolve at least some of your confusion about these config snippets
</I>&gt;&gt;<i> and how &quot;tiny&quot; changes to them are affecting Squid behaviour in major ways.
</I>&gt;&gt;<i>
</I>&gt;<i> 
</I>&gt;<i> No, it isn't obviuos to me, and yes, I am still trying to understand by re-reading wiki squid doc and other sites about peek and splice decisions and about the steps too.
</I>&gt;<i> 
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> So in a brief I think that  config A is more secure.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> No. Config (A) from the earlier post actively *creates* insecurity by;
</I>&gt;<i> 
</I>&gt;<i> But,according to <A HREF="http://marek.helion.pl/install/squid.html;">http://marek.helion.pl/install/squid.html;</A> It's supposed that config  &quot;A&quot; check server certificate. Because it is peeking at step2 and splicing at step3 the whitelist sites.
</I>&gt;<i> 
</I>
The peek at step2 line has another ACL condition which must _also_ be
true for peek to actually happen. In every transaction where that
noBumpSites is *false* the ssl_bump ACL processing continues on and
finds the &quot;bump&quot; line.

(that much is just regular ACL processing logic, not SSL-Bump specific).


Also, Marek is another slightly confused admin like yourself. So that
page follows what he understands and has a few mistakes. It is also from
2 years ago, since then we have fixed some bugs and TLS has had features
added and removed (notably TLS/1.3 rollout begun and SSL formally
obsoleted).

&gt;&gt;<i>
</I>&gt;&gt;<i>  1) hiding any information about the real server security level,
</I>&gt;&gt;<i>     - downgrade attacks. Right down to plaintext levels.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>  2) hiding any information about the server certificate validity,
</I>&gt;&gt;<i>     - silent third-party MITM.
</I>&gt;&gt;<i>     - invalid certificate attacks.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>  3) opening the server connection to multiplexed use from multiple
</I>&gt;&gt;<i> clients of Squid,
</I>&gt;&gt;<i>    - consider that in light of (1) and (2)
</I>&gt;<i> 
</I>&gt;<i> I dont understand, in earlier post:
</I>&gt;<i> 
</I>&gt;&gt;&gt;<i> ssl_bump peek step1 all
</I>&gt;&gt;&gt;<i> ssl_bump peek step2 noBumpSites
</I>&gt;&gt;&gt;<i> ssl_bump splice step3 noBumpSites
</I>&gt;&gt;&gt;<i> ssl_bump bump
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i> So... (lets call this config A)
</I>&gt;<i> 
</I>&gt;<i> In this config I think the problem is that squid is peeking at step2 noBumpSites;
</I>
Yes, exactly so.

&gt;<i>  but also bump all other sites at step2 (there is no step specified in
</I>the last line -the bump-)
&gt;<i> 
</I>
Not quite. That line is the reason bump is being done in (A).

BUT if that line had a step3 ACL there would still be the same cases
hitting ... no lines -&gt; an implict guess from Squid about splice vs bump.

I thought Squid chose bump to preserve the old client-first behaviour.
But your test below indicates that your version is splicing.


&gt;<i> Therefore I think that would be &quot;better&quot; or &quot; less insecure&quot; bumping at step3.
</I>&gt;<i> 
</I>
Yes, exactly so - it is more secure to bump at step3.

BUT, as Alex said, bump at step3 does not work after a peek at step2.

The peek happening at step2 means any secret tokens have already been
passed around. Squid then cannot replace those tokens with its own ones.
 'stare' is the action which holds back things like that and filters the
features such that Squid can bump the encryption.


The other bumps, which happen at step2 are where the issues I pointed
out happen. Those vulnerabilities are directly cause by lack of
serverHello details and how insecure it is to trust the client *alone*
about what is going on.
 From Squid's perspective attacks usually come from clients (external
malicious ones), so yeah not a good idea to trust them based on their
own claims (clientHello).


&gt;<i> Conlusion based on these words:
</I>&gt;<i> 
</I>&gt;&gt;<i> So config (A) is trying to do a step3 (handshake with server) when it 
</I>&gt;&gt;<i> has only peek'ed and relayed the clientHello as-is (including any 
</I>&gt;&gt;<i> secret tokens an unknown features the client is trying to use). The 
</I>&gt;&gt;<i> bump action is bound to fail.
</I>&gt;&gt;<i>  ** &quot;stare&quot; is the action which sets up and filters the handshake 
</I>&gt;&gt;<i> ready for bump action at step3 (server handshake with TLS features 
</I>&gt;&gt;<i> Squid knows how to handle).
</I>&gt;<i> 
</I>&gt;<i> I think that my config would be something like this:
</I>&gt;<i> 
</I>&gt;<i> ssl_bump peek step1 all
</I>&gt;<i> 
</I>&gt;<i> ssl_bump peek step2 noBumpSites 
</I>&gt;<i> 
</I>&gt;<i> From squid doc:
</I>&gt;<i> &quot;When a peek rule matches during step 2, Squid proceeds to step3 where it parses the TLS Server Hello and extracts server certificate while preserving the possibility of splicing the client and server connections; peeking at the server certificate usually precludes future bumping&quot;
</I>&gt;<i> 
</I>&gt;<i> And from <A HREF="http://marek.helion.pl/install/squid.html">http://marek.helion.pl/install/squid.html</A>
</I>&gt;<i> Peeking at step 2 will check the name stored in server certificate (CommonName, SubjectAltName) as well. So let's do it! you must enable peek at step 2 and finally splice at step3 (if certName matches the whitelist)
</I>&gt;<i> 
</I>
Pause.

What do you want/need to happen to the handshakes that do not match the
noBumpSites criteria for peeking?

Squid has to do something, your test below indicates that is splice.

Anyway, assume the implicit is doing something you don't want or likely
to change as bugs get fixed. Make sure one of your config lines always
matches to be clear.

Resume;

&gt;<i> ssl_bump splice step3 noBumpSites
</I>&gt;<i> (following the ruleset explained above)
</I>&gt;<i> 
</I>&gt;<i> And here I believe that the final bump should be make at step3:
</I>&gt;<i> 
</I>&gt;<i> ssl_bump bump step3	
</I>&gt;<i> 
</I>&gt;<i> OR there is no difference if i dont specify the step in the bump line?
</I>&gt;<i> 
</I>
If you omit a step ACL in any ssl_bump line that lines action will apply
at any step where; its ACLs match, the action is valid, and no prior
line has matched.


&gt;<i> summarizing:
</I>&gt;<i> 
</I>&gt;<i> ssl_bump peek step1 all
</I>&gt;<i> ssl_bump peek step2 noBumpSites
</I>&gt;<i> ssl_bump splice step3 noBumpSites
</I>&gt;<i> ssl_bump bump step3
</I>&gt;<i> 
</I>&gt;<i> EDIT:
</I>&gt;<i> Before send this mail to list, I test the squid behaviour and if I dont add a stare (dont know why this happens, stare is the less used option I saw in many examples on the web) line at step2, all accesed site are spliced; so my final config would be taken from helion.pl: (almost defeated by this thread/topic)
</I>&gt;<i> 
</I>
Okay, so your Squid implicitly chooses to splice at step2.
Sorry about the confusion. The implicit action(s) have been different in
the past. Which is #1 reason to make an explicit config line for each case.


&gt;<i> ssl_bump peek step1 all               	# at step 1 we're peeking at client TLS-request in order to find the &quot;SNI&quot;
</I>&gt;<i> ssl_bump peek step2 nobumpSites       	# here we're peeking at server certificate
</I>&gt;<i> ssl_bump splice step3 nobumpSites     	# here we're splicing connections which match the whitelist
</I>&gt;<i> ssl_bump stare step2                  		# here we're staring at server certificate
</I>&gt;<i> ssl_bump bump step3                   	# finally we're bumping all other SSL connections at step 3
</I>&gt;<i> 
</I>&gt;<i> The autor of helion.pl says:
</I>&gt;<i> 
</I>&gt;<i> &quot;Honestly I don't see a reason to stare at the server certificate before bumping. Even without &quot;staring&quot; the fake-certificate has the same attributes (Common Name etc.) like the original one. But it might change in the future...&quot;
</I>&gt;<i> 
</I>&gt;<i> So I leave the stare line to avoid splice all the traffic.
</I>&gt;<i> 
</I>
Good.


HTH
Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="019174.html">[squid-users] About SSL peek-n-splice/bump configurations
</A></li>
	<LI>Next message (by thread): <A HREF="019176.html">[squid-users] About SSL peek-n-splice/bump configurations
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19175">[ date ]</a>
              <a href="thread.html#19175">[ thread ]</a>
              <a href="subject.html#19175">[ subject ]</a>
              <a href="author.html#19175">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
