<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] About SSL peek-n-splice/bump configurations
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20About%20SSL%20peek-n-splice/bump%20configurations&In-Reply-To=%3C019301d4486b%24049ebf00%240ddc3d00%24%40yahoo.com.ar%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="019175.html">
   <LINK REL="Next"  HREF="019177.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] About SSL peek-n-splice/bump configurations</H1>
    <B>Julian Perconti</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20About%20SSL%20peek-n-splice/bump%20configurations&In-Reply-To=%3C019301d4486b%24049ebf00%240ddc3d00%24%40yahoo.com.ar%3E"
       TITLE="[squid-users] About SSL peek-n-splice/bump configurations">vh1988 at yahoo.com.ar
       </A><BR>
    <I>Sun Sep  9 18:29:13 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="019175.html">[squid-users] About SSL peek-n-splice/bump configurations
</A></li>
        <LI>Next message (by thread): <A HREF="019177.html">[squid-users] About SSL peek-n-splice/bump configurations
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19176">[ date ]</a>
              <a href="thread.html#19176">[ thread ]</a>
              <a href="subject.html#19176">[ subject ]</a>
              <a href="author.html#19176">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>&gt;<i> -----Mensaje original-----
</I>&gt;<i> De: squid-users &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>&gt; En nombre de
</I>&gt;<i> Amos Jeffries
</I>&gt;<i> Enviado el: domingo, 9 de septiembre de 2018 02:35
</I>&gt;<i> Para: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> Asunto: Re: [squid-users] About SSL peek-n-splice/bump configurations
</I>&gt;<i> 
</I>&gt;<i> On 9/09/18 5:45 AM, Julian Perconti wrote:
</I>&gt;<i> &gt;&gt; -----Mensaje original-----
</I>&gt;<i> &gt;&gt; De: squid-users &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>&gt; En nombre
</I>&gt;<i> &gt;&gt; de Amos Jeffries Enviado el: viernes, 7 de septiembre de 2018 15:19
</I>&gt;<i> &gt;&gt; Para: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> &gt;&gt; Asunto: Re: [squid-users] About SSL peek-n-splice/bump configurations
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt;&gt; So from <A HREF="http://marek.helion.pl/install/squid.html">http://marek.helion.pl/install/squid.html</A>
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt; We have this configs:
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt; ssl_bump peek step1 all
</I>&gt;<i> &gt;&gt;&gt; ssl_bump peek step2 noBumpSites
</I>&gt;<i> &gt;&gt;&gt; ssl_bump splice step3 noBumpSites
</I>&gt;<i> &gt;&gt;&gt; ssl_bump stare step2
</I>&gt;<i> &gt;&gt;&gt; ssl_bump bump step3
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt; Is better to use the above conf (staring at step2)? Because you said
</I>&gt;<i> &gt;&gt;&gt; that
</I>&gt;<i> &gt;&gt; bump at step2 is insecure.
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt; Is the same if a I change the order of the above conf to:
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt; ssl_bump peek step1 all
</I>&gt;<i> &gt;&gt;&gt; ssl_bump peek step2 noBumpSites
</I>&gt;<i> &gt;&gt;&gt; ssl_bump stare step2 &lt;&lt;&lt; order changed ssl_bump splice step3
</I>&gt;<i> &gt;&gt;&gt; noBumpSites ssl_bump bump step3
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; What exactly do you think the step1, step2, step3 ACLs here are doing?
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I don not know what -exactly- these ACL are doing; that is what I trying to
</I>&gt;<i> find out.
</I>&gt;<i> &gt; I have some ideas about them, but not the exactly knowledge, for that
</I>&gt;<i> &gt; reason I asked if there is difference between those 2 configs order
</I>&gt;<i> &gt; (because the step is the same)
</I>&gt;<i> 
</I>&gt;<i> Okay. When ssl_bump is being processed the first time SslBump1 matches as
</I>&gt;<i> true, the second time SslBump2 is true, and third time for SslBump3.
</I>&gt;<i> Outside their own step in the TLS handshake process they match false.
</I>&gt;<i> 
</I>&gt;<i> This is how you select that a certain line in ssl_bump is *only* to match and
</I>&gt;<i> happen at a certain part (step) of the handshake sequence.
</I>
Well. 

First of all thank You for your time and explanation, and patient of course. It's much appretiated.

I Hope this thread helps to others that have a similar confusion and doubts like me.
Still the things are not &quot;entirely&quot; clear, I will quote.


...So that means that squid processes the SslBump directives:

1: maybe more than one time in a single request...?

2: In a sequential order (as You or Alex said in an earlier post)

- ... and &quot;automagically&quot; determine what to do if the ACL match or not? 
With this I mean, for example.., that in a config could be first, in this order, a step1 directive then a step3 directive and finally a step2? With an ACL of course. 
To clarify the SslBump order is determinant but its also depends in what I want to do with steps and ACLs.

Lets say...it is *not* mandatory to tell squid SslBump steps directives like:

At step1 do x
At step 2 do y
At step3 do z

And so on...

&gt;<i> 
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; I hoped it is obvious, but maybe not. Understanding that detail
</I>&gt;<i> &gt;&gt; should help resolve at least some of your confusion about these
</I>&gt;<i> &gt;&gt; config snippets and how &quot;tiny&quot; changes to them are affecting Squid
</I>&gt;<i> behaviour in major ways.
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; No, it isn't obviuos to me, and yes, I am still trying to understand by re-
</I>&gt;<i> reading wiki squid doc and other sites about peek and splice decisions and
</I>&gt;<i> about the steps too.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt; So in a brief I think that  config A is more secure.
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; No. Config (A) from the earlier post actively *creates* insecurity
</I>&gt;<i> &gt;&gt; by;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; But,according to <A HREF="http://marek.helion.pl/install/squid.html;">http://marek.helion.pl/install/squid.html;</A> It's supposed
</I>&gt;<i> that config  &quot;A&quot; check server certificate. Because it is peeking at step2 and
</I>&gt;<i> splicing at step3 the whitelist sites.
</I>&gt;<i> &gt;
</I>&gt;<i> 
</I>&gt;<i> The peek at step2 line has another ACL condition which must _also_ be true
</I>&gt;<i> for peek to actually happen. In every transaction where that noBumpSites is
</I>&gt;<i> *false* the ssl_bump ACL processing continues on and finds the &quot;bump&quot; line.
</I>&gt;<i> 
</I>&gt;<i> (that much is just regular ACL processing logic, not SSL-Bump specific).
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Also, Marek is another slightly confused admin like yourself. So that page
</I>&gt;<i> follows what he understands and has a few mistakes. It is also from
</I>&gt;<i> 2 years ago, since then we have fixed some bugs and TLS has had features
</I>&gt;<i> added and removed (notably TLS/1.3 rollout begun and SSL formally
</I>&gt;<i> obsoleted).
</I>&gt;<i> 
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt;  1) hiding any information about the real server security level,
</I>&gt;<i> &gt;&gt;     - downgrade attacks. Right down to plaintext levels.
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt;  2) hiding any information about the server certificate validity,
</I>&gt;<i> &gt;&gt;     - silent third-party MITM.
</I>&gt;<i> &gt;&gt;     - invalid certificate attacks.
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt;  3) opening the server connection to multiplexed use from multiple
</I>&gt;<i> &gt;&gt; clients of Squid,
</I>&gt;<i> &gt;&gt;    - consider that in light of (1) and (2)
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I dont understand, in earlier post:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;&gt;&gt; ssl_bump peek step1 all
</I>&gt;<i> &gt;&gt;&gt; ssl_bump peek step2 noBumpSites
</I>&gt;<i> &gt;&gt;&gt; ssl_bump splice step3 noBumpSites
</I>&gt;<i> &gt;&gt;&gt; ssl_bump bump
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt; So... (lets call this config A)
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; In this config I think the problem is that squid is peeking at step2
</I>&gt;<i> &gt; noBumpSites;
</I>&gt;<i> 
</I>&gt;<i> Yes, exactly so.
</I>&gt;<i> 
</I>&gt;<i> &gt;  but also bump all other sites at step2 (there is no step specified in
</I>&gt;<i> the last line -the bump-)
</I>&gt;<i> &gt;
</I>&gt;<i> 
</I>&gt;<i> Not quite. That line is the reason bump is being done in (A).
</I>&gt;<i> 
</I>&gt;<i> BUT if that line had a step3 ACL there would still be the same cases hitting ...
</I>&gt;<i> no lines -&gt; an implict guess from Squid about splice vs bump.
</I>
Therefore is always better to tell to squid the step. To avoid ambiguous decison, etc.

&gt;<i> 
</I>&gt;<i> I thought Squid chose bump to preserve the old client-first behaviour.
</I>&gt;<i> But your test below indicates that your version is splicing.
</I>
That is what I want to do. 
But I dont understand why sites are failling if I am splicing those ones. May be cause I am peeking at step2 and splice at step3 the noBumpSites.

&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> &gt; Therefore I think that would be &quot;better&quot; or &quot; less insecure&quot; bumping at
</I>&gt;<i> step3.
</I>&gt;<i> &gt;
</I>&gt;<i> 
</I>&gt;<i> Yes, exactly so - it is more secure to bump at step3.
</I>&gt;<i> 
</I>&gt;<i> BUT, as Alex said, bump at step3 does not work after a peek at step2.
</I>
Yes, according to the doc, peeking at step2 precules future bumping. I dont want to bump the whitelist, I want to tunnel instead.
That is why peek all at step1 but peek noBumpSites at step2.

&gt;<i> 
</I>&gt;<i> The peek happening at step2 means any secret tokens have already been
</I>&gt;<i> passed around. Squid then cannot replace those tokens with its own ones.
</I>&gt;<i>  'stare' is the action which holds back things like that and filters the features
</I>&gt;<i> such that Squid can bump the encryption.
</I>&gt;<i> 
</I>
When I should stare?

&gt;<i> 
</I>&gt;<i> The other bumps, which happen at step2 are where the issues I pointed out
</I>&gt;<i> happen. Those vulnerabilities are directly cause by lack of serverHello details
</I>&gt;<i> and how insecure it is to trust the client *alone* about what is going on.
</I>&gt;<i>  From Squid's perspective attacks usually come from clients (external
</I>&gt;<i> malicious ones), so yeah not a good idea to trust them based on their own
</I>&gt;<i> claims (clientHello).
</I>&gt;<i> 
</I>
Peeking at step2 does not prevent this?

&gt;<i> 
</I>&gt;<i> &gt; Conlusion based on these words:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;&gt; So config (A) is trying to do a step3 (handshake with server) when it
</I>&gt;<i> &gt;&gt; has only peek'ed and relayed the clientHello as-is (including any
</I>&gt;<i> &gt;&gt; secret tokens an unknown features the client is trying to use). The
</I>&gt;<i> &gt;&gt; bump action is bound to fail.
</I>&gt;<i> &gt;&gt;  ** &quot;stare&quot; is the action which sets up and filters the handshake
</I>&gt;<i> &gt;&gt; ready for bump action at step3 (server handshake with TLS features
</I>&gt;<i> &gt;&gt; Squid knows how to handle).
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I think that my config would be something like this:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; ssl_bump peek step1 all
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; ssl_bump peek step2 noBumpSites
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; From squid doc:
</I>&gt;<i> &gt; &quot;When a peek rule matches during step 2, Squid proceeds to step3 where it
</I>&gt;<i> parses the TLS Server Hello and extracts server certificate while preserving
</I>&gt;<i> the possibility of splicing the client and server connections; peeking at the
</I>&gt;<i> server certificate usually precludes future bumping&quot;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; And from <A HREF="http://marek.helion.pl/install/squid.html">http://marek.helion.pl/install/squid.html</A>
</I>&gt;<i> &gt; Peeking at step 2 will check the name stored in server certificate
</I>&gt;<i> &gt; (CommonName, SubjectAltName) as well. So let's do it! you must enable
</I>&gt;<i> &gt; peek at step 2 and finally splice at step3 (if certName matches the
</I>&gt;<i> &gt; whitelist)
</I>&gt;<i> &gt;
</I>&gt;<i> 
</I>&gt;<i> Pause.
</I>&gt;<i> 
</I>&gt;<i> What do you want/need to happen to the handshakes that do not match the
</I>&gt;<i> noBumpSites criteria for peeking?
</I>
Quick answer: Bump.

What I exactly  want to do is:
Secure bump to the sites that are not listed in &quot;noBumoSites&quot; ACL and secure splice/tunnel to sites listed in &quot;noBumpSites&quot;. 

&gt;<i> 
</I>&gt;<i> Squid has to do something, your test below indicates that is splice.
</I>&gt;<i> 
</I>&gt;<i> Anyway, assume the implicit is doing something you don't want or likely to
</I>&gt;<i> change as bugs get fixed. Make sure one of your config lines always matches
</I>&gt;<i> to be clear.
</I>&gt;<i> 
</I>&gt;<i> Resume;
</I>&gt;<i> 
</I>&gt;<i> &gt; ssl_bump splice step3 noBumpSites
</I>&gt;<i> &gt; (following the ruleset explained above)
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; And here I believe that the final bump should be make at step3:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; ssl_bump bump step3
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; OR there is no difference if i dont specify the step in the bump line?
</I>&gt;<i> &gt;
</I>&gt;<i> 
</I>&gt;<i> If you omit a step ACL in any ssl_bump line that lines action will apply at any
</I>&gt;<i> step where; its ACLs match, the action is valid, and no prior line has matched.
</I>
An old doubt, answered by Alex and now by You, thanks to both.
So it is always better to tell squid what &quot;he&quot; exactly has to do in each step. Or avoid to let him to &quot;decide&quot;...

&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> &gt; summarizing:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; ssl_bump peek step1 all
</I>&gt;<i> &gt; ssl_bump peek step2 noBumpSites
</I>&gt;<i> &gt; ssl_bump splice step3 noBumpSites
</I>&gt;<i> &gt; ssl_bump bump step3
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; EDIT:
</I>&gt;<i> &gt; Before send this mail to list, I test the squid behaviour and if I
</I>&gt;<i> &gt; dont add a stare (dont know why this happens, stare is the less used
</I>&gt;<i> &gt; option I saw in many examples on the web) line at step2, all accesed
</I>&gt;<i> &gt; site are spliced; so my final config would be taken from helion.pl:
</I>&gt;<i> &gt; (almost defeated by this thread/topic)
</I>&gt;<i> &gt;
</I>&gt;<i> 
</I>&gt;<i> Okay, so your Squid implicitly chooses to splice at step2.
</I>&gt;<i> Sorry about the confusion. The implicit action(s) have been different in the
</I>&gt;<i> past. Which is #1 reason to make an explicit config line for each case.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> &gt; ssl_bump peek step1 all               	# at step 1 we're peeking at client TLS-request in order to find the &quot;SNI&quot;
</I>&gt;<i> &gt; ssl_bump peek step2 nobumpSites       	# here we're peeking at server certificate
</I>&gt;<i> &gt; ssl_bump splice step3 nobumpSites     	# here we're splicing connections which match the whitelist
</I>&gt;<i> &gt; ssl_bump stare step2                  		# here we're staring at server certificate
</I>&gt;<i> &gt; ssl_bump bump step3                   	# finally we're bumping all other SSL connections at step 3
</I>
Wouldn't be less ambiguous to squid if I do this change:?

ssl_bump peek step1 all &gt; A question: I am not here peeking the noBumpSites list too? Should I add an !noBumpSites? to the end of this line? Just a doubt.
ssl_bump peek step2 nobumpSites 
ssl_bump splice step3 nobumpSites
ssl_bump stare step2 nobumpSites &gt; explicit staring whitelist (I haven't test this) it is just an idea...it make sense? (also I dont understand what exactly the satre action do)
ssl_bump bump step3 

I think this config avoid the &quot;old client-first insecure&quot; behaviour. I am right? And squid check server-certitifacte before splice.

&gt;<i> &gt;
</I>&gt;<i> &gt; The autor of helion.pl says:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; &quot;Honestly I don't see a reason to stare at the server certificate before
</I>&gt;<i> bumping. Even without &quot;staring&quot; the fake-certificate has the same attributes
</I>&gt;<i> (Common Name etc.) like the original one. But it might change in the
</I>&gt;<i> future...&quot;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; So I leave the stare line to avoid splice all the traffic.
</I>&gt;<i> &gt;
</I>&gt;<i> 
</I>&gt;<i> Good.
</I>
Final Words, the site that start to fail from one day to antoher is www.santanderrio.com.ar. All other spliced sites never stops working.

I will use ssllabs.com to test the site.

The thing that cause a lot of confusion to me is that in peek-n-splice environment, I can peek, plice,bump,starte in many steps (1,2,3).
That make the things a bit complex to decide. And of course to understand.
&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> HTH
</I>
Yes, it really helps.

Thank You very much.

&gt;<i> Amos
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="019175.html">[squid-users] About SSL peek-n-splice/bump configurations
</A></li>
	<LI>Next message (by thread): <A HREF="019177.html">[squid-users] About SSL peek-n-splice/bump configurations
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19176">[ date ]</a>
              <a href="thread.html#19176">[ thread ]</a>
              <a href="subject.html#19176">[ subject ]</a>
              <a href="author.html#19176">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
