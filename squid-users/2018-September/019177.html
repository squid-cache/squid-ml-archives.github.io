<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] About SSL peek-n-splice/bump configurations
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20About%20SSL%20peek-n-splice/bump%20configurations&In-Reply-To=%3C6b762c34-f0c4-2d9a-6616-432305af160b%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="019176.html">
   <LINK REL="Next"  HREF="019189.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] About SSL peek-n-splice/bump configurations</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20About%20SSL%20peek-n-splice/bump%20configurations&In-Reply-To=%3C6b762c34-f0c4-2d9a-6616-432305af160b%40treenet.co.nz%3E"
       TITLE="[squid-users] About SSL peek-n-splice/bump configurations">squid3 at treenet.co.nz
       </A><BR>
    <I>Mon Sep 10 04:12:45 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="019176.html">[squid-users] About SSL peek-n-splice/bump configurations
</A></li>
        <LI>Next message (by thread): <A HREF="019189.html">[squid-users] About SSL peek-n-splice/bump configurations
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19177">[ date ]</a>
              <a href="thread.html#19177">[ thread ]</a>
              <a href="subject.html#19177">[ subject ]</a>
              <a href="author.html#19177">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 10/09/18 6:29 AM, Julian Perconti wrote:
&gt;&gt;<i> -----Mensaje original-----
</I>&gt;&gt;<i> De: Amos Jeffries
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> On 9/09/18 5:45 AM, Julian Perconti wrote:
</I>&gt;&gt;&gt;&gt;<i> -----Mensaje original-----
</I>&gt;&gt;&gt;&gt;<i> De: Amos Jeffries
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> So from <A HREF="http://marek.helion.pl/install/squid.html">http://marek.helion.pl/install/squid.html</A>
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> We have this configs:
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> ssl_bump peek step1 all
</I>&gt;&gt;&gt;&gt;&gt;<i> ssl_bump peek step2 noBumpSites
</I>&gt;&gt;&gt;&gt;&gt;<i> ssl_bump splice step3 noBumpSites
</I>&gt;&gt;&gt;&gt;&gt;<i> ssl_bump stare step2
</I>&gt;&gt;&gt;&gt;&gt;<i> ssl_bump bump step3
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> Is better to use the above conf (staring at step2)? Because you said
</I>&gt;&gt;&gt;&gt;&gt;<i> that
</I>&gt;&gt;&gt;&gt;<i> bump at step2 is insecure.
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> Is the same if a I change the order of the above conf to:
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> ssl_bump peek step1 all
</I>&gt;&gt;&gt;&gt;&gt;<i> ssl_bump peek step2 noBumpSites
</I>&gt;&gt;&gt;&gt;&gt;<i> ssl_bump stare step2 &lt;&lt;&lt; order changed ssl_bump splice step3
</I>&gt;&gt;&gt;&gt;&gt;<i> noBumpSites ssl_bump bump step3
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> What exactly do you think the step1, step2, step3 ACLs here are doing?
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> I don not know what -exactly- these ACL are doing; that is what I trying to
</I>&gt;&gt;<i> find out.
</I>&gt;&gt;&gt;<i> I have some ideas about them, but not the exactly knowledge, for that
</I>&gt;&gt;&gt;<i> reason I asked if there is difference between those 2 configs order
</I>&gt;&gt;&gt;<i> (because the step is the same)
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Okay. When ssl_bump is being processed the first time SslBump1 matches as
</I>&gt;&gt;<i> true, the second time SslBump2 is true, and third time for SslBump3.
</I>&gt;&gt;<i> Outside their own step in the TLS handshake process they match false.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> This is how you select that a certain line in ssl_bump is *only* to match and
</I>&gt;&gt;<i> happen at a certain part (step) of the handshake sequence.
</I>&gt;<i> 
</I>&gt;<i> Well. 
</I>&gt;<i> 
</I>&gt;<i> First of all thank You for your time and explanation, and patient of course. It's much appretiated.
</I>&gt;<i> 
</I>&gt;<i> I Hope this thread helps to others that have a similar confusion and doubts like me.
</I>&gt;<i> Still the things are not &quot;entirely&quot; clear, I will quote.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> ...So that means that squid processes the SslBump directives:
</I>&gt;<i> 
</I>&gt;<i> 1: maybe more than one time in a single request...?
</I>&gt;<i> 
</I>
Yes. Up to 3 times. A peek or splice action causes another check later.


&gt;<i> 2: In a sequential order (as You or Alex said in an earlier post)
</I>&gt;<i> 
</I>&gt;<i> - ... and &quot;automagically&quot; determine what to do if the ACL match or not? 
</I>&gt;<i> With this I mean, for example.., that in a config could be first, in this order, a step1 directive then a step3 directive and finally a step2? With an ACL of course. 
</I>
No, this order is fixed and follows the TLS handshake stages/steps:
 step1, then step2, then step3. Exact same order as on the Squid wiki page.

The automagic is only applied when
 a) no ssl_bump lines at all match (auto-decide for you), and
 b) an action that matches is not valid for the step (auto-ignore that
line).


&gt;<i> To clarify the SslBump order is determinant but its also depends in what I want to do with steps and ACLs.
</I>&gt;<i> 
</I>
Yes. Though what you understand by that statement still seems to differ
a bit from what we understand it to mean.


&gt;<i> Lets say...it is *not* mandatory to tell squid SslBump steps directives like:
</I>&gt;<i> 
</I>&gt;<i> At step1 do x
</I>&gt;<i> At step 2 do y
</I>&gt;<i> At step3 do z
</I>&gt;<i> 
</I>&gt;<i> And so on...
</I>&gt;<i> 
</I>
Well, its true you don't *have* to . BUt also you don't have to use
SSL-Bump at all either.

If you want to be sure what Squid is doing, and that it will continue to
do that reliably then telling it for each step is a good idea.



&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> I hoped it is obvious, but maybe not. Understanding that detail
</I>&gt;&gt;&gt;&gt;<i> should help resolve at least some of your confusion about these
</I>&gt;&gt;&gt;&gt;<i> config snippets and how &quot;tiny&quot; changes to them are affecting Squid
</I>&gt;&gt;<i> behaviour in major ways.
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> No, it isn't obviuos to me, and yes, I am still trying to understand by re-
</I>&gt;&gt;<i> reading wiki squid doc and other sites about peek and splice decisions and
</I>&gt;&gt;<i> about the steps too.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> So in a brief I think that  config A is more secure.
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> No. Config (A) from the earlier post actively *creates* insecurity
</I>&gt;&gt;&gt;&gt;<i> by;
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> But,according to <A HREF="http://marek.helion.pl/install/squid.html;">http://marek.helion.pl/install/squid.html;</A> It's supposed
</I>&gt;&gt;<i> that config  &quot;A&quot; check server certificate. Because it is peeking at step2 and
</I>&gt;&gt;<i> splicing at step3 the whitelist sites.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The peek at step2 line has another ACL condition which must _also_ be true
</I>&gt;&gt;<i> for peek to actually happen. In every transaction where that noBumpSites is
</I>&gt;&gt;<i> *false* the ssl_bump ACL processing continues on and finds the &quot;bump&quot; line.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> (that much is just regular ACL processing logic, not SSL-Bump specific).
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Also, Marek is another slightly confused admin like yourself. So that page
</I>&gt;&gt;<i> follows what he understands and has a few mistakes. It is also from
</I>&gt;&gt;<i> 2 years ago, since then we have fixed some bugs and TLS has had features
</I>&gt;&gt;<i> added and removed (notably TLS/1.3 rollout begun and SSL formally
</I>&gt;&gt;<i> obsoleted).
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>  1) hiding any information about the real server security level,
</I>&gt;&gt;&gt;&gt;<i>     - downgrade attacks. Right down to plaintext levels.
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>  2) hiding any information about the server certificate validity,
</I>&gt;&gt;&gt;&gt;<i>     - silent third-party MITM.
</I>&gt;&gt;&gt;&gt;<i>     - invalid certificate attacks.
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>  3) opening the server connection to multiplexed use from multiple
</I>&gt;&gt;&gt;&gt;<i> clients of Squid,
</I>&gt;&gt;&gt;&gt;<i>    - consider that in light of (1) and (2)
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> I dont understand, in earlier post:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> ssl_bump peek step1 all
</I>&gt;&gt;&gt;&gt;&gt;<i> ssl_bump peek step2 noBumpSites
</I>&gt;&gt;&gt;&gt;&gt;<i> ssl_bump splice step3 noBumpSites
</I>&gt;&gt;&gt;&gt;&gt;<i> ssl_bump bump
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> So... (lets call this config A)
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> In this config I think the problem is that squid is peeking at step2
</I>&gt;&gt;&gt;<i> noBumpSites;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Yes, exactly so.
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>  but also bump all other sites at step2 (there is no step specified in
</I>&gt;&gt;<i> the last line -the bump-)
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Not quite. That line is the reason bump is being done in (A).
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> BUT if that line had a step3 ACL there would still be the same cases hitting ...
</I>&gt;&gt;<i> no lines -&gt; an implict guess from Squid about splice vs bump.
</I>&gt;<i> 
</I>&gt;<i> Therefore is always better to tell to squid the step. To avoid ambiguous decison, etc.
</I>&gt;<i> 
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I thought Squid chose bump to preserve the old client-first behaviour.
</I>&gt;&gt;<i> But your test below indicates that your version is splicing.
</I>&gt;<i> 
</I>&gt;<i> That is what I want to do. 
</I>&gt;<i> But I dont understand why sites are failling if I am splicing those ones. May be cause I am peeking at step2 and splice at step3 the noBumpSites.
</I>&gt;<i> 
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Therefore I think that would be &quot;better&quot; or &quot; less insecure&quot; bumping at
</I>&gt;&gt;<i> step3.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Yes, exactly so - it is more secure to bump at step3.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> BUT, as Alex said, bump at step3 does not work after a peek at step2.
</I>&gt;<i> 
</I>&gt;<i> Yes, according to the doc, peeking at step2 precules future bumping. I dont want to bump the whitelist, I want to tunnel instead.
</I>&gt;<i> That is why peek all at step1 but peek noBumpSites at step2.
</I>&gt;<i> 
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The peek happening at step2 means any secret tokens have already been
</I>&gt;&gt;<i> passed around. Squid then cannot replace those tokens with its own ones.
</I>&gt;&gt;<i>  'stare' is the action which holds back things like that and filters the features
</I>&gt;&gt;<i> such that Squid can bump the encryption.
</I>&gt;&gt;<i>
</I>&gt;<i> 
</I>&gt;<i> When I should stare?
</I>
When you, as the admin with meta knowledge about the overall policy -
know that a bump is wanted to happen later.


&gt;<i> 
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The other bumps, which happen at step2 are where the issues I pointed out
</I>&gt;&gt;<i> happen. Those vulnerabilities are directly cause by lack of serverHello details
</I>&gt;&gt;<i> and how insecure it is to trust the client *alone* about what is going on.
</I>&gt;&gt;<i>  From Squid's perspective attacks usually come from clients (external
</I>&gt;&gt;<i> malicious ones), so yeah not a good idea to trust them based on their own
</I>&gt;&gt;<i> claims (clientHello).
</I>&gt;&gt;<i>
</I>&gt;<i> 
</I>&gt;<i> Peeking at step2 does not prevent this?
</I>
Peeking at step2 precludes / forbids later bumping, so yes.

What I have been trying to highlight is that there is traffic that
config (A) allows to go through *without* any peek at step2. It reaches
the &quot;ssl_bump bump&quot; line.



&gt;<i> 
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Conlusion based on these words:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> So config (A) is trying to do a step3 (handshake with server) when it
</I>&gt;&gt;&gt;&gt;<i> has only peek'ed and relayed the clientHello as-is (including any
</I>&gt;&gt;&gt;&gt;<i> secret tokens an unknown features the client is trying to use). The
</I>&gt;&gt;&gt;&gt;<i> bump action is bound to fail.
</I>&gt;&gt;&gt;&gt;<i>  ** &quot;stare&quot; is the action which sets up and filters the handshake
</I>&gt;&gt;&gt;&gt;<i> ready for bump action at step3 (server handshake with TLS features
</I>&gt;&gt;&gt;&gt;<i> Squid knows how to handle).
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> I think that my config would be something like this:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> ssl_bump peek step1 all
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> ssl_bump peek step2 noBumpSites
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> From squid doc:
</I>&gt;&gt;&gt;<i> &quot;When a peek rule matches during step 2, Squid proceeds to step3 where it
</I>&gt;&gt;<i> parses the TLS Server Hello and extracts server certificate while preserving
</I>&gt;&gt;<i> the possibility of splicing the client and server connections; peeking at the
</I>&gt;&gt;<i> server certificate usually precludes future bumping&quot;
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> And from <A HREF="http://marek.helion.pl/install/squid.html">http://marek.helion.pl/install/squid.html</A>
</I>&gt;&gt;&gt;<i> Peeking at step 2 will check the name stored in server certificate
</I>&gt;&gt;&gt;<i> (CommonName, SubjectAltName) as well. So let's do it! you must enable
</I>&gt;&gt;&gt;<i> peek at step 2 and finally splice at step3 (if certName matches the
</I>&gt;&gt;&gt;<i> whitelist)
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Pause.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> What do you want/need to happen to the handshakes that do not match the
</I>&gt;&gt;<i> noBumpSites criteria for peeking?
</I>&gt;<i> 
</I>&gt;<i> Quick answer: Bump.
</I>&gt;<i> 
</I>
Then put the below line after your &quot;peek step2 noBumPSites&quot; line:

  ssl_bump stare step2


&gt;<i> What I exactly  want to do is:
</I>&gt;<i> Secure bump to the sites that are not listed in &quot;noBumoSites&quot; ACL and secure splice/tunnel to sites listed in &quot;noBumpSites&quot;. 
</I>&gt;<i> 
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Squid has to do something, your test below indicates that is splice.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Anyway, assume the implicit is doing something you don't want or likely to
</I>&gt;&gt;<i> change as bugs get fixed. Make sure one of your config lines always matches
</I>&gt;&gt;<i> to be clear.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Resume;
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> ssl_bump splice step3 noBumpSites
</I>&gt;&gt;&gt;<i> (following the ruleset explained above)
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> And here I believe that the final bump should be make at step3:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> ssl_bump bump step3
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> OR there is no difference if i dont specify the step in the bump line?
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> If you omit a step ACL in any ssl_bump line that lines action will apply at any
</I>&gt;&gt;<i> step where; its ACLs match, the action is valid, and no prior line has matched.
</I>&gt;<i> 
</I>&gt;<i> An old doubt, answered by Alex and now by You, thanks to both.
</I>&gt;<i> So it is always better to tell squid what &quot;he&quot; exactly has to do in each step. Or avoid to let him to &quot;decide&quot;...
</I>&gt;<i> 
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> summarizing:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> ssl_bump peek step1 all
</I>&gt;&gt;&gt;<i> ssl_bump peek step2 noBumpSites
</I>&gt;&gt;&gt;<i> ssl_bump splice step3 noBumpSites
</I>&gt;&gt;&gt;<i> ssl_bump bump step3
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> EDIT:
</I>&gt;&gt;&gt;<i> Before send this mail to list, I test the squid behaviour and if I
</I>&gt;&gt;&gt;<i> dont add a stare (dont know why this happens, stare is the less used
</I>&gt;&gt;&gt;<i> option I saw in many examples on the web) line at step2, all accesed
</I>&gt;&gt;&gt;<i> site are spliced; so my final config would be taken from helion.pl:
</I>&gt;&gt;&gt;<i> (almost defeated by this thread/topic)
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Okay, so your Squid implicitly chooses to splice at step2.
</I>&gt;&gt;<i> Sorry about the confusion. The implicit action(s) have been different in the
</I>&gt;&gt;<i> past. Which is #1 reason to make an explicit config line for each case.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> ssl_bump peek step1 all               	# at step 1 we're peeking at client TLS-request in order to find the &quot;SNI&quot;
</I>&gt;&gt;&gt;<i> ssl_bump peek step2 nobumpSites       	# here we're peeking at server certificate
</I>&gt;&gt;&gt;<i> ssl_bump splice step3 nobumpSites     	# here we're splicing connections which match the whitelist
</I>&gt;&gt;&gt;<i> ssl_bump stare step2                  		# here we're staring at server certificate
</I>&gt;&gt;&gt;<i> ssl_bump bump step3                   	# finally we're bumping all other SSL connections at step 3
</I>&gt;<i> 
</I>&gt;<i> Wouldn't be less ambiguous to squid if I do this change:?
</I>&gt;<i> 
</I>&gt;<i> ssl_bump peek step1 all &gt; A question: I am not here peeking the noBumpSites list too? Should I add an !noBumpSites? to the end of this line? Just a doubt.
</I>&gt;<i> ssl_bump peek step2 nobumpSites 
</I>&gt;<i> ssl_bump splice step3 nobumpSites
</I>&gt;<i> ssl_bump stare step2 nobumpSites &gt; explicit staring whitelist (I haven't test this) it is just an idea...it make sense?
</I>

The ACLs on the line above are the same as the peek line earlier. So the
peek line matched already, nothing reaches this line.
 &lt;<A HREF="https://wiki.squid-cache.org/SquidFaq/SquidAcl#Common_Mistakes">https://wiki.squid-cache.org/SquidFaq/SquidAcl#Common_Mistakes</A>&gt;

Less ambiguous, yes, if your knowledge of Squid ACLs is low. The FAQ
link above should help a bit here.


Your policy (&quot;Quick answer: Bump.&quot;) was to prefer bump'ing. For that to
happen as step 3 it needs a stare first at step 2.

So consider the stare here as the normal action this step2 is supposed
to perform. With the peek line being the whitelist preventing stare+bump
for special cases.




&gt;<i>  (also I dont understand what exactly the satre action do)
</I>
Hmm. Think of &quot;peek&quot; as a postal worker reading postcards people send in
the mail. &quot;stare&quot; as the postal worker both reading and rewriting them
to remove words (s)he doesn't like or understand.

Say if the a postcard ended with the words &quot;never qwertyuio&quot;. A peek'ing
postie would still deliver it unchanged, a stare'ing postie would
deliver a postcard with the last word &quot;never&quot;.

If the sender/receiver of the postcard had agreed to start using crypto
every time a message ended with &quot;qwertyuio&quot; - the peeking postie would
then just see a bunch of garbage/crypted postcards start to happen. The
stare'ing one would be able to read the content, maybe even continue
changing things.

The exact details are more complex of course, but essentially the same
things going on.



&gt;<i> I think this config avoid the &quot;old client-first insecure&quot; behaviour. I am right? And squid check server-certitifacte before splice.
</I>&gt;<i> 
</I>
Step 3 is where the &quot;preclude&quot; starts to matter.


The Step 2 action determines whether the original clientHello or one
rewritten by Squid gets sent to the server in order to get a serverHello
out of it.

AIUI, &quot;stare step2&quot; precludes &quot;splice step3&quot;. So that line should be
ignored by Squid unless there was a peek done at step2.

To follow that postal analogy; client-first is like the postal worker
simply replying to peoples postcards instead of delivering them. If/when
they have to answer a question, writing a wholly new/different message
to find out for itself first before answering.


&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> The autor of helion.pl says:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> &quot;Honestly I don't see a reason to stare at the server certificate before
</I>&gt;&gt;<i> bumping. Even without &quot;staring&quot; the fake-certificate has the same attributes
</I>&gt;&gt;<i> (Common Name etc.) like the original one. But it might change in the
</I>&gt;&gt;<i> future...&quot;
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> So I leave the stare line to avoid splice all the traffic.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Good.
</I>&gt;<i> 
</I>&gt;<i> Final Words, the site that start to fail from one day to antoher is www.santanderrio.com.ar. All other spliced sites never stops working.
</I>&gt;<i> 
</I>&gt;<i> I will use ssllabs.com to test the site.
</I>&gt;<i> 
</I>&gt;<i> The thing that cause a lot of confusion to me is that in peek-n-splice environment, I can peek, plice,bump,starte in many steps (1,2,3).
</I>&gt;<i> That make the things a bit complex to decide. And of course to understand.
</I>

Nod. One thing to be clear on is that TLS is designed to actively
prevent MITM doing things like bump'ing. A client and server which are
both using TLS properly cannot be bump'ed. They can only be peek'd and
splice'd.

There are many features in TLS that partially or fully work towards that
goal. So it depends on which of those are negotiated between the
endpoints (*if* negotiated) and also whether Squid is up to date enough
to detect and prevent them when stare'ing.

There are also a bunch of different protocols happening in the HTTP
environment these days (QUICK, CoAP, SPDY, HTTP/2 etc) - if one of those
which Squid does not (yet) support is used to transfer TLS related data
the endpoints may be transmitting info the proxy cannot affect.


There is still an arms-race going on in TLS these days (though slowing a
bit now). Thus the whole &quot;only use the latest Squid release when
SSL-Bump'ing&quot; line we push so hard.

Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="019176.html">[squid-users] About SSL peek-n-splice/bump configurations
</A></li>
	<LI>Next message (by thread): <A HREF="019189.html">[squid-users] About SSL peek-n-splice/bump configurations
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19177">[ date ]</a>
              <a href="thread.html#19177">[ thread ]</a>
              <a href="subject.html#19177">[ subject ]</a>
              <a href="author.html#19177">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
