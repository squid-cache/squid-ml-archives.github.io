<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid 4.2 : caching is not working
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%204.2%20%3A%20caching%20is%20not%20working&In-Reply-To=%3C6450cba7-3e41-4fa4-f12b-83da50d71ace%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="019178.html">
   <LINK REL="Next"  HREF="019180.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid 4.2 : caching is not working</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%204.2%20%3A%20caching%20is%20not%20working&In-Reply-To=%3C6450cba7-3e41-4fa4-f12b-83da50d71ace%40treenet.co.nz%3E"
       TITLE="[squid-users] Squid 4.2 : caching is not working">squid3 at treenet.co.nz
       </A><BR>
    <I>Mon Sep 10 14:16:03 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="019178.html">[squid-users] Squid 4.2 : caching is not working
</A></li>
        <LI>Next message (by thread): <A HREF="019180.html">[squid-users] Squid 4.2 : caching is not working
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19179">[ date ]</a>
              <a href="thread.html#19179">[ thread ]</a>
              <a href="subject.html#19179">[ subject ]</a>
              <a href="author.html#19179">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 11/09/18 12:18 AM, Hariharan Sethuraman wrote:
&gt;<i> Hi All,
</I>&gt;<i> 
</I>&gt;<i> I have two things to clarify:
</I>&gt;<i> 1) In earlier email (snipped below), Amos told that is caching and
</I>&gt;<i> scheduled to download
</I>
Thats not what I wrote. There is data and it is scheduled for removal
(erase) as soon as the current client gets responded to. It is
specifically *not* caching.

That confirms why you are not seeing anything in the disk cache.

&gt;<i> - does it mean that we got the answer and do some
</I>&gt;<i> override?
</I>

&gt;<i> --------------------
</I>&gt;<i> ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------&#160;
</I>&gt;&gt;<i>&#160; &#160; &#160;This is what I see when the download is in progress:
</I>&gt;&gt;<i>&#160;
</I>&gt;&gt;<i>&#160; &#160; &#160;KEY 44000000000000000902000000000000
</I>&gt;&gt;<i>&#160; &#160; &#160;&#160; &#160; &#160; &#160; STORE_PENDING NOT_IN_MEMORY SWAPOUT_NONE PING_DONE
</I>&gt;&gt;<i>&#160; &#160; &#160;&#160; &#160; &#160; &#160; RELEASE_REQUEST,DISPATCHED,PRIVATE,VALIDATED
</I>&gt;<i> 
</I>&gt;<i> So file stored in memory and scheduled for removal.&#160;
</I>&gt;<i> --------------------
</I>&gt;<i> ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
</I>&gt;<i> &#160;
</I>&gt;<i> 2) With more debug_options enabled, I see that it is not caching because
</I>&gt;<i> the response is part of authenticated flow. Is there a way I can
</I>&gt;<i> override this?
</I>
No. The server is supplying sufficient headers for caching to make it
appear that the site authors intentionally are sending what does get
delivered.


&gt;<i> -&#160; &#160;Initially when this file download starts, it gets authorized (I
</I>&gt;<i> think that is why I see HEAD request is sent to target which has
</I>&gt;<i> Cache-Control: max-age=0) and then the subsequent GET requests (dont
</I>&gt;<i> have any cache-control header) download the chunk using adjusted range
</I>&gt;<i> and offset.
</I>
Client delivered Cache-Control do not matter. It is the *server*
Cache-Control which matters here.

The client can also *not* send the authentication header. That would let
Squid cache the object IF the server sent this same object without
credentials being needed.


&gt;<i> -&#160; &#160;But the subsequent GET reply seems set with auth flag, see the code
</I>&gt;<i> below snipped from source
</I>&gt;<i> (<A HREF="https://github.com/squid-cache/squid/blob/4f1c93a7a0d14eec223e199275ce570d840f71bc/src/http.cc">https://github.com/squid-cache/squid/blob/4f1c93a7a0d14eec223e199275ce570d840f71bc/src/http.cc</A>).&#160;
</I>&gt;<i> &#160; &#160; &#160; &#160; // RFC 2068, sec 14.9.4 - MUST NOT cache any response with
</I>&gt;<i> Authentication UNLESS certain CC controls are present
</I>&gt;<i> &#160; &#160; // allow HTTP violations to IGNORE those controls (ie re-block
</I>&gt;<i> caching Auth)
</I>&gt;<i> &#160; &#160; if (request &amp;&amp; (request-&gt;flags.auth || request-&gt;flags.authSent)) {
</I>&gt;<i> &#160; &#160; &#160; &#160; if (!rep-&gt;cache_control)
</I>&gt;<i> &#160; &#160; &#160; &#160; &#160; &#160; return decision.make(ReuseDecision::reuseNot,
</I>&gt;<i> &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&quot;authenticated and server reply missing
</I>&gt;<i> Cache-Control&quot;);
</I>&gt;<i> -&#160; &#160;I tried adding override-expire in the cgi-bin refresh pattern, but
</I>&gt;<i> that will override only for max-age in Cache-control but not relevant
</I>&gt;<i> for auth flag.
</I>
Indeed. It also will only do anything for certain outdated dynamic
content URLs.

As far as Squid is able to tell the content was generated specifically
for this authenticated user. You need the server to send Cache-Control
with one of public, must-revalidate, or s-maxage which indicate that it
is actually cacheable by a shared cache (ie Squid).

Otherwise the object is &quot;private&quot;, and the cache related settings are
intended for a client-specific cache, such as a Browser has.



Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="019178.html">[squid-users] Squid 4.2 : caching is not working
</A></li>
	<LI>Next message (by thread): <A HREF="019180.html">[squid-users] Squid 4.2 : caching is not working
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19179">[ date ]</a>
              <a href="thread.html#19179">[ thread ]</a>
              <a href="subject.html#19179">[ subject ]</a>
              <a href="author.html#19179">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
