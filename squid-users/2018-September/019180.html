<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid 4.2 : caching is not working
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%204.2%20%3A%20caching%20is%20not%20working&In-Reply-To=%3CCANfnjgL0HumPCD31S6zrgtnCyEewCRyNjS_CJ8PijxHFn1RQAg%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="019179.html">
   <LINK REL="Next"  HREF="019181.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid 4.2 : caching is not working</H1>
    <B>Hariharan Sethuraman</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%204.2%20%3A%20caching%20is%20not%20working&In-Reply-To=%3CCANfnjgL0HumPCD31S6zrgtnCyEewCRyNjS_CJ8PijxHFn1RQAg%40mail.gmail.com%3E"
       TITLE="[squid-users] Squid 4.2 : caching is not working">srnhari at gmail.com
       </A><BR>
    <I>Mon Sep 10 14:27:39 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="019179.html">[squid-users] Squid 4.2 : caching is not working
</A></li>
        <LI>Next message (by thread): <A HREF="019181.html">[squid-users] Squid 4.2 : caching is not working
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19180">[ date ]</a>
              <a href="thread.html#19180">[ thread ]</a>
              <a href="subject.html#19180">[ subject ]</a>
              <a href="author.html#19180">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Mon, 10 Sep 2018, 19:46 Amos Jeffries, &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt; wrote:

&gt;<i> On 11/09/18 12:18 AM, Hariharan Sethuraman wrote:
</I>&gt;<i> &gt; Hi All,
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I have two things to clarify:
</I>&gt;<i> &gt; 1) In earlier email (snipped below), Amos told that is caching and
</I>&gt;<i> &gt; scheduled to download
</I>&gt;<i>
</I>&gt;<i> Thats not what I wrote. There is data and it is scheduled for removal
</I>&gt;<i> (erase) as soon as the current client gets responded to. It is
</I>&gt;<i> specifically *not* caching.
</I>&gt;<i>
</I>&gt;<i> That confirms why you are not seeing anything in the disk cache.
</I>&gt;<i>
</I>&gt;<i> &gt; - does it mean that we got the answer and do some
</I>&gt;<i> &gt; override?
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; --------------------
</I>&gt;<i> &gt;
</I>&gt;<i> ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
</I>&gt;<i> &gt;&gt;     This is what I see when the download is in progress:
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt;     KEY 44000000000000000902000000000000
</I>&gt;<i> &gt;&gt;             STORE_PENDING NOT_IN_MEMORY SWAPOUT_NONE PING_DONE
</I>&gt;<i> &gt;&gt;             RELEASE_REQUEST,DISPATCHED,PRIVATE,VALIDATED
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; So file stored in memory and scheduled for removal.
</I>&gt;<i> &gt; --------------------
</I>&gt;<i> &gt;
</I>&gt;<i> ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; 2) With more debug_options enabled, I see that it is not caching because
</I>&gt;<i> &gt; the response is part of authenticated flow. Is there a way I can
</I>&gt;<i> &gt; override this?
</I>&gt;<i>
</I>&gt;<i> No. The server is supplying sufficient headers for caching to make it
</I>&gt;<i> appear that the site authors intentionally are sending what does get
</I>&gt;<i> delivered.
</I>&gt;<i>
</I>If I understand correctly, you are saying the caching will not be done on
squid as the content is authorised by the specific client. We can't do
anything until I ask site owners to change cache control as public?

&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; -   Initially when this file download starts, it gets authorized (I
</I>&gt;<i> &gt; think that is why I see HEAD request is sent to target which has
</I>&gt;<i> &gt; Cache-Control: max-age=0) and then the subsequent GET requests (dont
</I>&gt;<i> &gt; have any cache-control header) download the chunk using adjusted range
</I>&gt;<i> &gt; and offset.
</I>&gt;<i>
</I>&gt;<i> Client delivered Cache-Control do not matter. It is the *server*
</I>&gt;<i> Cache-Control which matters here.
</I>&gt;<i>
</I>&gt;<i> The client can also *not* send the authentication header. That would let
</I>&gt;<i> Squid cache the object IF the server sent this same object without
</I>&gt;<i> credentials being needed.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; -   But the subsequent GET reply seems set with auth flag, see the code
</I>&gt;<i> &gt; below snipped from source
</I>&gt;<i> &gt; (
</I>&gt;<i> <A HREF="https://github.com/squid-cache/squid/blob/4f1c93a7a0d14eec223e199275ce570d840f71bc/src/http.cc">https://github.com/squid-cache/squid/blob/4f1c93a7a0d14eec223e199275ce570d840f71bc/src/http.cc</A>
</I>&gt;<i> ).
</I>&gt;<i> &gt;         // RFC 2068, sec 14.9.4 - MUST NOT cache any response with
</I>&gt;<i> &gt; Authentication UNLESS certain CC controls are present
</I>&gt;<i> &gt;     // allow HTTP violations to IGNORE those controls (ie re-block
</I>&gt;<i> &gt; caching Auth)
</I>&gt;<i> &gt;     if (request &amp;&amp; (request-&gt;flags.auth || request-&gt;flags.authSent)) {
</I>&gt;<i> &gt;         if (!rep-&gt;cache_control)
</I>&gt;<i> &gt;             return decision.make(ReuseDecision::reuseNot,
</I>&gt;<i> &gt;                                  &quot;authenticated and server reply missing
</I>&gt;<i> &gt; Cache-Control&quot;);
</I>&gt;<i> &gt; -   I tried adding override-expire in the cgi-bin refresh pattern, but
</I>&gt;<i> &gt; that will override only for max-age in Cache-control but not relevant
</I>&gt;<i> &gt; for auth flag.
</I>&gt;<i>
</I>&gt;<i> Indeed. It also will only do anything for certain outdated dynamic
</I>&gt;<i> content URLs.
</I>&gt;<i>
</I>&gt;<i> As far as Squid is able to tell the content was generated specifically
</I>&gt;<i> for this authenticated user. You need the server to send Cache-Control
</I>&gt;<i> with one of public, must-revalidate, or s-maxage which indicate that it
</I>&gt;<i> is actually cacheable by a shared cache (ie Squid).
</I>&gt;<i>
</I>&gt;<i> Otherwise the object is &quot;private&quot;, and the cache related settings are
</I>&gt;<i> intended for a client-specific cache, such as a Browser has.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Amos
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20180910/9caa3430/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20180910/9caa3430/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="019179.html">[squid-users] Squid 4.2 : caching is not working
</A></li>
	<LI>Next message (by thread): <A HREF="019181.html">[squid-users] Squid 4.2 : caching is not working
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19180">[ date ]</a>
              <a href="thread.html#19180">[ thread ]</a>
              <a href="subject.html#19180">[ subject ]</a>
              <a href="author.html#19180">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
