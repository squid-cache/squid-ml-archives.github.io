<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] About SSL peek-n-splice/bump configurations
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20About%20SSL%20peek-n-splice/bump%20configurations&In-Reply-To=%3C009d01d44935%241648ef80%2442dace80%24%40yahoo.com.ar%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="019177.html">
   <LINK REL="Next"  HREF="019190.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] About SSL peek-n-splice/bump configurations</H1>
    <B>Julian Perconti</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20About%20SSL%20peek-n-splice/bump%20configurations&In-Reply-To=%3C009d01d44935%241648ef80%2442dace80%24%40yahoo.com.ar%3E"
       TITLE="[squid-users] About SSL peek-n-splice/bump configurations">vh1988 at yahoo.com.ar
       </A><BR>
    <I>Mon Sep 10 18:35:42 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="019177.html">[squid-users] About SSL peek-n-splice/bump configurations
</A></li>
        <LI>Next message (by thread): <A HREF="019190.html">[squid-users] About SSL peek-n-splice/bump configurations
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19189">[ date ]</a>
              <a href="thread.html#19189">[ thread ]</a>
              <a href="subject.html#19189">[ subject ]</a>
              <a href="author.html#19189">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>&gt;<i> -----Mensaje original-----
</I>&gt;<i> De: squid-users &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>&gt; En nombre de
</I>&gt;<i> Amos Jeffries
</I>&gt;<i> Enviado el: lunes, 10 de septiembre de 2018 01:13
</I>&gt;<i> Para: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> Asunto: Re: [squid-users] About SSL peek-n-splice/bump configurations
</I>&gt;<i> 
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; ...So that means that squid processes the SslBump directives:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; 1: maybe more than one time in a single request...?
</I>&gt;<i> &gt;
</I>&gt;<i> 
</I>&gt;<i> Yes. Up to 3 times. A peek or splice action causes another check later.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> &gt; 2: In a sequential order (as You or Alex said in an earlier post)
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; - ... and &quot;automagically&quot; determine what to do if the ACL match or not?
</I>&gt;<i> &gt; With this I mean, for example.., that in a config could be first, in this order,
</I>&gt;<i> a step1 directive then a step3 directive and finally a step2? With an ACL of
</I>&gt;<i> course.
</I>&gt;<i> 
</I>&gt;<i> No, this order is fixed and follows the TLS handshake stages/steps:
</I>&gt;<i>  step1, then step2, then step3. Exact same order as on the Squid wiki page.
</I>&gt;<i> 
</I>&gt;<i> The automagic is only applied when
</I>&gt;<i>  a) no ssl_bump lines at all match (auto-decide for you), and
</I>&gt;<i>  b) an action that matches is not valid for the step (auto-ignore that line).
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> &gt; To clarify the SslBump order is determinant but its also depends in what I
</I>&gt;<i> want to do with steps and ACLs.
</I>&gt;<i> &gt;
</I>&gt;<i> 
</I>&gt;<i> Yes. Though what you understand by that statement still seems to differ a bit
</I>&gt;<i> from what we understand it to mean.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> &gt; Lets say...it is *not* mandatory to tell squid SslBump steps directives like:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; At step1 do x
</I>&gt;<i> &gt; At step 2 do y
</I>&gt;<i> &gt; At step3 do z
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; And so on...
</I>&gt;<i> &gt;
</I>&gt;<i> 
</I>&gt;<i> Well, its true you don't *have* to . BUt also you don't have to use SSL-Bump
</I>&gt;<i> at all either.
</I>&gt;<i> 
</I>&gt;<i> If you want to be sure what Squid is doing, and that it will continue to do that
</I>&gt;<i> reliably then telling it for each step is a good idea.
</I>
Yes, but see below..what my conclusi&#243;n is.

&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> &gt; When I should stare?
</I>&gt;<i> 
</I>&gt;<i> When you, as the admin with meta knowledge about the overall policy -
</I>&gt;<i> know that a bump is wanted to happen later.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Peeking at step2 does not prevent this?
</I>&gt;<i> 
</I>&gt;<i> Peeking at step2 precludes / forbids later bumping, so yes.
</I>&gt;<i> 
</I>&gt;<i> What I have been trying to highlight is that there is traffic that config (A)
</I>&gt;<i> allows to go through *without* any peek at step2. It reaches the &quot;ssl_bump
</I>&gt;<i> bump&quot; line.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Quick answer: Bump.
</I>
A better term would have been &quot;Short answer&quot;

&gt;<i> &gt;
</I>&gt;<i> 
</I>&gt;<i> Then put the below line after your &quot;peek step2 noBumPSites&quot; line:
</I>&gt;<i> 
</I>&gt;<i>   ssl_bump stare step2
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Wouldn't be less ambiguous to squid if I do this change:?
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; ssl_bump peek step1 all &gt; A question: I am not here peeking the
</I>&gt;<i> noBumpSites list too? Should I add an !noBumpSites? to the end of this line?
</I>&gt;<i> Just a doubt.
</I>&gt;<i> &gt; ssl_bump peek step2 nobumpSites
</I>&gt;<i> &gt; ssl_bump splice step3 nobumpSites
</I>&gt;<i> &gt; ssl_bump stare step2 nobumpSites &gt; explicit staring whitelist (I haven't test
</I>&gt;<i> this) it is just an idea...it make sense?
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> The ACLs on the line above are the same as the peek line earlier. So the
</I>&gt;<i> peek line matched already, nothing reaches this line.
</I>&gt;<i>  &lt;<A HREF="https://wiki.squid-cache.org/SquidFaq/SquidAcl#Common_Mistakes">https://wiki.squid-cache.org/SquidFaq/SquidAcl#Common_Mistakes</A>&gt;
</I>&gt;<i> 
</I>&gt;<i> Less ambiguous, yes, if your knowledge of Squid ACLs is low. The FAQ
</I>&gt;<i> link above should help a bit here.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Your policy (&quot;Quick answer: Bump.&quot;) was to prefer bump'ing. For that to
</I>&gt;<i> happen as step 3 it needs a stare first at step 2.
</I>&gt;<i> 
</I>&gt;<i> So consider the stare here as the normal action this step2 is supposed
</I>&gt;<i> to perform. With the peek line being the whitelist preventing stare+bump
</I>&gt;<i> for special cases.
</I>&gt;<i> 
</I>&gt;<i> &gt;  (also I dont understand what exactly the satre action do)
</I>&gt;<i> 
</I>&gt;<i> Hmm. Think of &quot;peek&quot; as a postal worker reading postcards people send in
</I>&gt;<i> the mail. &quot;stare&quot; as the postal worker both reading and rewriting them
</I>&gt;<i> to remove words (s)he doesn't like or understand.
</I>&gt;<i> 
</I>&gt;<i> Say if the a postcard ended with the words &quot;never qwertyuio&quot;. A peek'ing
</I>&gt;<i> postie would still deliver it unchanged, a stare'ing postie would
</I>&gt;<i> deliver a postcard with the last word &quot;never&quot;.
</I>&gt;<i> 
</I>&gt;<i> If the sender/receiver of the postcard had agreed to start using crypto
</I>&gt;<i> every time a message ended with &quot;qwertyuio&quot; - the peeking postie would
</I>&gt;<i> then just see a bunch of garbage/crypted postcards start to happen. The
</I>&gt;<i> stare'ing one would be able to read the content, maybe even continue
</I>&gt;<i> changing things.
</I>&gt;<i> 
</I>&gt;<i> The exact details are more complex of course, but essentially the same
</I>&gt;<i> things going on.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> &gt; I think this config avoid the &quot;old client-first insecure&quot; behaviour. I am right?
</I>&gt;<i> And squid check server-certitifacte before splice.
</I>&gt;<i> &gt;
</I>&gt;<i> 
</I>&gt;<i> Step 3 is where the &quot;preclude&quot; starts to matter.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> The Step 2 action determines whether the original clientHello or one
</I>&gt;<i> rewritten by Squid gets sent to the server in order to get a serverHello
</I>&gt;<i> out of it.
</I>&gt;<i> 
</I>&gt;<i> AIUI, &quot;stare step2&quot; precludes &quot;splice step3&quot;. So that line should be
</I>&gt;<i> ignored by Squid unless there was a peek done at step2.
</I>&gt;<i> 
</I>&gt;<i> To follow that postal analogy; client-first is like the postal worker
</I>&gt;<i> simply replying to peoples postcards instead of delivering them. If/when
</I>&gt;<i> they have to answer a question, writing a wholly new/different message
</I>&gt;<i> to find out for itself first before answering.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; The thing that cause a lot of confusion to me is that in peek-n-splice
</I>&gt;<i> environment, I can peek, plice,bump,starte in many steps (1,2,3).
</I>&gt;<i> &gt; That make the things a bit complex to decide. And of course to understand.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Nod. One thing to be clear on is that TLS is designed to actively
</I>&gt;<i> prevent MITM doing things like bump'ing. A client and server which are
</I>&gt;<i> both using TLS properly cannot be bump'ed. They can only be peek'd and
</I>&gt;<i> splice'd.
</I>
That is what I want to do:
Sensitive sites like banks, I dont want to bump/intercept. Instead of that, do a secure tunnel, between the client and server. May be via peeki'ng at step2?

&gt;<i> 
</I>&gt;<i> There are many features in TLS that partially or fully work towards that
</I>&gt;<i> goal. So it depends on which of those are negotiated between the
</I>&gt;<i> endpoints (*if* negotiated) and also whether Squid is up to date enough
</I>&gt;<i> to detect and prevent them when stare'ing.
</I>&gt;<i> 
</I>&gt;<i> There are also a bunch of different protocols happening in the HTTP
</I>&gt;<i> environment these days (QUICK, CoAP, SPDY, HTTP/2 etc) - if one of those
</I>&gt;<i> which Squid does not (yet) support is used to transfer TLS related data
</I>&gt;<i> the endpoints may be transmitting info the proxy cannot affect.
</I>
Yes, sad but true today, I think.

&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> There is still an arms-race going on in TLS these days (though slowing a
</I>&gt;<i> bit now). Thus the whole &quot;only use the latest Squid release when
</I>&gt;<i> SSL-Bump'ing&quot; line we push so hard.
</I>&gt;<i> 
</I>
OK, let me show You the final config, explained (called config &quot;F&quot;):

acl noBumpSites ssl::server_name_regex -i &quot;/etc/squid/url.nobump&quot;

acl step1 at_step SslBump1
acl step2 at_step SslBump2
acl step3 at_step SslBump3

   ssl_bump peek step1 all

Here I am peek'ing all, to bump/splice/stare at next step.
The doc.: 
&quot;Step 1 is the only step that is always performed.&quot; 
&quot; When a peek rule matches during step1, Squid proceeds to step2 where it parses the TLS Client Hello and extracts SNI (if any).&quot;

   ssl_bump peek step2 noBumpSites

Here I am peek'ing too, but at step2 so, this makes future bump impossble. 
The doc.: &quot;Peeking at this step usually makes bumping at step 3 impossible.&quot;

I think that splice at step3 would be reduntant. Because if peek'ing here &quot;usually&quot; makes bump imposible at next step so squid will decide an &quot;automagic splice noBumpSites&quot;

   ssl_bump stare step2 all

Here we star'ing at step2.
The doc.: &quot;Staring at this step usually makes splicing at step 3 impossible.&quot;

Unlike the previous example, stare'ing at this step makes impossbile  future splic'ing... therefore squid will decide an &quot;automagic bump all&quot;

And finally:
Due to what has been said above, these two next lines I think are redundant or not necessary.

#ssl_bump splice step3 noBumpSites
#ssl_bump bump step3 all

The doc.:
&quot; Step 3 is only performed if a peek or stare rule matched during the previous step.&quot;
&quot; In most cases, the only meaningful choice at step 3 is whether to terminate the connection. &quot;
The key-line for me to understand was: &quot;The splicing or bumping decision is usually dictated by either peeking or staring at the previous step.&quot;

So, in a brief the confi is:

ssl_bump peek step1 all
ssl_bump peek step2 noBumpSites
ssl_bump stare step2 all

Comments:
In access.log I saw the bumped traffic (sites that are not white-listed by noBumpSites ACL) and TCP_TUNNEL when a spliced connection ends.
But, also see *many* lines like these when access to a non-intercepted or spliced site, say ibm.com:

At the beggining:
NONE/200 0 CONNECT 2.19.111.47:443 - ORIGINAL_DST/2.19.111.47 -  

At the end:
TCP_TUNNEL/200 197238 CONNECT 2.19.111.47:443

Final questions:

1: Is this peek-n-splice ruleset insecure? Whether if the site is bumped or spliced, both cases.
2: It is correct to say that those lines are not necessary/redundant? (#ssl_bump splice step3 noBumpSites/#ssl_bump bump step3 all)
3: Is the order of each step &quot;correct&quot;?


*Best regards and thank You*





</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="019177.html">[squid-users] About SSL peek-n-splice/bump configurations
</A></li>
	<LI>Next message (by thread): <A HREF="019190.html">[squid-users] About SSL peek-n-splice/bump configurations
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19189">[ date ]</a>
              <a href="thread.html#19189">[ thread ]</a>
              <a href="subject.html#19189">[ subject ]</a>
              <a href="author.html#19189">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
