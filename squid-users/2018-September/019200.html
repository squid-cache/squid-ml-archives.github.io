<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] About SSL peek-n-splice/bump configurations
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20About%20SSL%20peek-n-splice/bump%20configurations&In-Reply-To=%3C500fbad5-d277-965f-d29a-a81c2f343d2e%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="019198.html">
   <LINK REL="Next"  HREF="019203.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] About SSL peek-n-splice/bump configurations</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20About%20SSL%20peek-n-splice/bump%20configurations&In-Reply-To=%3C500fbad5-d277-965f-d29a-a81c2f343d2e%40measurement-factory.com%3E"
       TITLE="[squid-users] About SSL peek-n-splice/bump configurations">rousskov at measurement-factory.com
       </A><BR>
    <I>Wed Sep 12 16:41:26 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="019198.html">[squid-users] About SSL peek-n-splice/bump configurations
</A></li>
        <LI>Next message (by thread): <A HREF="019203.html">[squid-users] About SSL peek-n-splice/bump configurations
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19200">[ date ]</a>
              <a href="thread.html#19200">[ thread ]</a>
              <a href="subject.html#19200">[ subject ]</a>
              <a href="author.html#19200">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 09/12/2018 08:28 AM, Julian Perconti wrote:


&gt;<i> Please, let me know if I understand why those cfg are equals
</I>
I am afraid you do not. You are probably missing the fact that, at each
step, the rules after the matching applicable rule are not checked.
Also, you seem to insert some implicit peeking rules that are never
there. Finally, there may be some confusion regarding how multiple ACLs
on one line are evaluated (and/or you do not think that stepN is just an
ACL?). Details below.


&gt;<i> ssl_bump peek step1 
</I>&gt;<i> ssl_bump peek noBumpSites
</I>&gt;<i> ssl_bump stare all
</I>

&gt;&gt;<i>   ssl_bump peek step1  # implicit &quot;all&quot; at step1
</I>
Yes, if you wish to think about it that way. In reality, the condition
is exactly &quot;step1&quot;, rather than &quot;step1 and all&quot; or &quot;step1 and true&quot;.


&gt;&gt;<i>   ssl_bump peek noBumpSites # As there no step specified, squid match at any step
</I>
Not exactly. Squid will evaluate this rule at any step that (a) reaches
this line and (b) where the peek action is applicable. The intersection
of those two preconditions is &quot;step2&quot; rather than &quot;any step&quot;.


&gt;<i> then this line, match at step1 
</I>
No, this line will not be evaluated at step1. Only the first rule is
evaluated at step1 (because that first rule always matches at step1).


&gt;<i> and then at step2, so when a match occurs at step2 it precludes future bumping of the sites listed in the ACL.
</I>
Yes, but that is kind of irrelevant here because there are no bump rules
to exclude. At step3, this previous/step2 peeking should result in Squid
applying the default &quot;splice&quot; rule (you can view that as excluding the
default &quot;bump&quot; rule if you wish).


&gt;&gt;<i> ssl_bump stare all # Here there is either no step2 (and any step)
</I>&gt;&gt;<i> specified but, because in the previous line You has (implicitly)
</I>&gt;&gt;<i> peeked at step2, the stare'ing not (or can&#180;t) applies to sites
</I>&gt;&gt;<i> listed in ACL (they were peeked at step2).
</I>
Something like that. Step2 always happens in this configuration (so &quot;no
step2&quot; does not make sense), and there is no such thing as &quot;implicit
peeking&quot;, but I think you more-or-less got the right idea here.


&gt;<i> ssl_bump peek noBumpSites
</I>&gt;<i> ssl_bump stare all
</I>

&gt;&gt;<i> ssl_bump peek noBumpSites # Like previous example, but..I guess
</I>&gt;&gt;<i> that as there is no &quot;all&quot; explicit, this line do a &quot;peek all at
</I>&gt;&gt;<i> step1&quot; (implicitly)
</I>
No, this line does not do &quot;peek all&quot;. It does &quot;peek noBumpSites&quot;. That
is, it tells Squid to peek when and only when both of the conditions
below are true:

(a) the peeking action is applicable (i.e., step1 or step2)
(b) the noBumpSites ACL matches

The two conditions above are evaluated in the specified order. Condition
(b) is not evaluated unless condition (a) is satisfied.



&gt;<i> To clarify, if I would add an &quot;all&quot; at the end of this line, then all traffic would be spliced.
</I>
Adding &quot;all&quot; to any line changes nothing as far as line matching is
considered. The value of &quot;foo and true&quot; is equivalent to the value of &quot;foo&quot;.



&gt;&gt;&gt;<i> 1: Is this peek-n-splice ruleset insecure?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Define &quot;secure&quot;.
</I>
&gt;<i> Well, is not the same if there is a squid-TLS (in the LAN) between a
</I>&gt;<i> client and sensitive external server when a TLS connection is being
</I>&gt;<i> established as if there is nothing between they.
</I>
I am not sure I interpret your definition correctly, but I hope the
following statements will answer your question regardless of that
interpretation:

* Staring (at step2) or bumping (at any step) alters TLS bytes on the
wire. The client and the origin server will see some TLS bytes that are
going to differ from the TLS bytes they would have seen if Squid was not
there.

* In this scope, the deprecated client-first and server-first actions
are equivalent to applying the &quot;bump&quot; action.

* If successful, ssl_bump peek and splice actions do not alter TLS
bytes. Peeking and/or splicing Squid can be viewed as a TCP proxy as far
as TLS bytes forwarding is concerned. The client and the origin server
will see the same TLS bytes they would have seen if Squid was not there.

* In this scope, various errors are usually equivalent to applying the
&quot;bump&quot; action.


If your definition of &quot;secure&quot; is &quot;does not change TLS bytes exchanges
between client and server&quot;, then if your configuration has a &quot;stare&quot;
and/or &quot;bump&quot; actions, it is &quot;insecure&quot;. If your configuration may lead
to certificate validation errors, it is also &quot;insecure&quot;.


&gt;<i> In this sense I would like to know how could I interference as less
</I>&gt;<i> as possible with the squid in the middle when someone is accesing to
</I>&gt;<i> a site that I wish not to bump.
</I>
Peeking and/or splicing does not change TLS bytes. It is passive
monitoring. See the bullets above for a more complete/precise picture.


&gt;<i> When I do this:
</I>&gt;<i> 
</I>&gt;<i> ssl_bump splice noBumpSites
</I>&gt;<i> ssl_bump stare all
</I>
&gt;<i> It is supposed that in this config I am (guessing), implicity,
</I>&gt;<i> peeking  (first?) and splice at any step and bumping (implicity) at
</I>&gt;<i> step3 sites that does not match with whitelist by staring at step2.
</I>&gt;<i> Maybe something like that, I dont know.
</I>
I do not think your description of the above configuration is correct.
Squid uses default actions (&quot;splice&quot; or &quot;bump&quot;) when no applicable rules
match. In the above configuration, one of the rules will always match
during step1 and during step2 (if any). Thus, there will be no implicit
splicing or bumping during the first steps. If Squid reaches step3, then
Squid will apply the default bump rule at that step (because &quot;stare&quot;
matched at the previous step).

I am not sure, but I think the above configuration is equivalent to the
following configuration that does not rely on default rules:

  ssl_bump splice step1 noBumpSites
  ssl_bump splice step2 noBumpSites
  ssl_bump stare step1
  ssl_bump stare step2
  ssl_bump bump step3


HTH,

Alex.

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="019198.html">[squid-users] About SSL peek-n-splice/bump configurations
</A></li>
	<LI>Next message (by thread): <A HREF="019203.html">[squid-users] About SSL peek-n-splice/bump configurations
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19200">[ date ]</a>
              <a href="thread.html#19200">[ thread ]</a>
              <a href="subject.html#19200">[ subject ]</a>
              <a href="author.html#19200">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
