<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] About SSL peek-n-splice/bump configurations
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20About%20SSL%20peek-n-splice/bump%20configurations&In-Reply-To=%3C004401d44b0e%2446cf40c0%24d46dc240%24%40yahoo.com.ar%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="019200.html">
   <LINK REL="Next"  HREF="019205.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] About SSL peek-n-splice/bump configurations</H1>
    <B>Julian Perconti</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20About%20SSL%20peek-n-splice/bump%20configurations&In-Reply-To=%3C004401d44b0e%2446cf40c0%24d46dc240%24%40yahoo.com.ar%3E"
       TITLE="[squid-users] About SSL peek-n-splice/bump configurations">vh1988 at yahoo.com.ar
       </A><BR>
    <I>Thu Sep 13 03:02:56 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="019200.html">[squid-users] About SSL peek-n-splice/bump configurations
</A></li>
        <LI>Next message (by thread): <A HREF="019205.html">[squid-users] About SSL peek-n-splice/bump configurations
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19203">[ date ]</a>
              <a href="thread.html#19203">[ thread ]</a>
              <a href="subject.html#19203">[ subject ]</a>
              <a href="author.html#19203">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>&gt;<i> I am afraid you do not. You are probably missing the fact that, at each step,
</I>&gt;<i> the rules after the matching applicable rule are not checked.
</I>&gt;<i> Also, you seem to insert some implicit peeking rules that are never there.
</I>&gt;<i> Finally, there may be some confusion regarding how multiple ACLs on one
</I>&gt;<i> line are evaluated (and/or you do not think that stepN is just an ACL?).
</I>
You're right, it's just and ACL like any other. Maybe I lost sight of that point.

&gt;<i> Details below.
</I>
I will keep trying to understand the best I can.

&gt;<i> &gt; ssl_bump peek step1
</I>&gt;<i> &gt; ssl_bump peek noBumpSites
</I>&gt;<i> &gt; ssl_bump stare all
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> &gt;&gt;   ssl_bump peek step1  # implicit &quot;all&quot; at step1
</I>&gt;<i> 
</I>&gt;<i> Yes, if you wish to think about it that way. In reality, the condition
</I>&gt;<i> is exactly &quot;step1&quot;, rather than &quot;step1 and all&quot; or &quot;step1 and true&quot;.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> &gt;&gt;   ssl_bump peek noBumpSites # As there no step specified, squid match
</I>&gt;<i> at any step
</I>&gt;<i> 
</I>&gt;<i> Not exactly. Squid will evaluate this rule at any step that (a) reaches
</I>&gt;<i> this line and (b) where the peek action is applicable. The intersection
</I>&gt;<i> of those two preconditions is &quot;step2&quot; rather than &quot;any step&quot;.
</I>
Ok, say that the most (not to say the *only*) important beyond any step or action is the *secuential order -line_by_line-* of the rules (steps) .

Example:

  ssl_bump splice noBumpSites # this will be totally ignored by Squid if a stare rule precedes this.

i.e.:

  ssl_bump stare noBumpSites # No matter what, here is the Squid first match and he is at step1...
  ssl_bump splice noBumpSites # ...Therefore here Squid is at step2, then this line will never match, even not having specified the step in both lines, because &quot;noBumpSites&quot; was already stared at first line.

Well, I am not really sure about the above example (Maybe I choosen the worst).. if I a read what the Actions do at wiki, appears doubts in mind, it's just an example about how implicit steps works.

Anyway, as an excercise I guess that in this example what Squid will do is a final &quot;splice noBumpSites&quot; at step2, because stare action always match at step1 (and at wiki, peek/stare description are the same)

I can not realize right now about what will happen at step3 or SslBump3.. guess that there will never be a bump, not sure.
*BUT* if in case that an implicit stare occurs at step2 due to first line, then squid will bump the &quot;noBumpSites&quot; and never-match/ignore the second line completely.

&gt;<i> &gt; then this line, match at step1
</I>
&quot;This line&quot; was ssl_bump peek noBumpSites

&gt;<i> No, this line will not be evaluated at step1. Only the first rule is
</I>&gt;<i> evaluated at step1 (because that first rule always matches at step1).
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> &gt; and then at step2, so when a match occurs at step2 it precludes future
</I>&gt;<i> bumping of the sites listed in the ACL.
</I>&gt;<i> 
</I>&gt;<i> Yes, but that is kind of irrelevant here because there are no bump rules
</I>&gt;<i> to exclude. At step3, this previous/step2 peeking should result in Squid
</I>&gt;<i> applying the default &quot;splice&quot; rule (you can view that as excluding the
</I>&gt;<i> default &quot;bump&quot; rule if you wish).
</I>
Yes, that's the idea, default/implicit bump all, except the &quot;noBumpSites&quot;, but maybe is not the best way to do that.

&gt;<i> &gt;&gt; ssl_bump stare all # Here there is either no step2 (and any step)
</I>&gt;<i> &gt;&gt; specified but, because in the previous line You has (implicitly)
</I>&gt;<i> &gt;&gt; peeked at step2, the stare'ing not (or can&#180;t) applies to sites
</I>&gt;<i> &gt;&gt; listed in ACL (they were peeked at step2).
</I>&gt;<i> 
</I>&gt;<i> Something like that. Step2 always happens in this configuration (so &quot;no
</I>&gt;<i> step2&quot; does not make sense), and there is no such thing as &quot;implicit
</I>&gt;<i> peeking&quot;, but I think you more-or-less got the right idea here.
</I>
I didn't know that no exists &quot;implicit peeking&quot; as you said above. Instead, I always thought that peeking was mandatory.
Resume: Implicit splice and bump exists aalways exists. Implicit peek, no. Is this correct?

See my doubt at the end...and conclusion.

&gt;<i> &gt;&gt; ssl_bump peek noBumpSites # Like previous example, but..I guess
</I>&gt;<i> &gt;&gt; that as there is no &quot;all&quot; explicit, this line do a &quot;peek all at
</I>&gt;<i> &gt;&gt; step1&quot; (implicitly)
</I>&gt;<i> 
</I>&gt;<i> No, this line does not do &quot;peek all&quot;. It does &quot;peek noBumpSites&quot;. That
</I>&gt;<i> is, it tells Squid to peek when and only when both of the conditions
</I>&gt;<i> below are true:
</I>&gt;<i> 
</I>&gt;<i> (a) the peeking action is applicable (i.e., step1 or step2)
</I>&gt;<i> (b) the noBumpSites ACL matches
</I>&gt;<i> 
</I>&gt;<i> The two conditions above are evaluated in the specified order. Condition
</I>&gt;<i> (b) is not evaluated unless condition (a) is satisfied.
</I>
Another important point to keep in mind what your are telling above.

&gt;<i> &gt; To clarify, if I would add an &quot;all&quot; at the end of this line, then all traffic would
</I>&gt;<i> be spliced.
</I>&gt;<i> 
</I>&gt;<i> Adding &quot;all&quot; to any line changes nothing as far as line matching is
</I>&gt;<i> considered. The value of &quot;foo and true&quot; is equivalent to the value of &quot;foo&quot;.
</I>
So the word &quot;all&quot; makes sense if its is &quot;alone&quot;? Or not even like that?
e.g.: ssl_bump peek step1 all = ssl_bump peek step1, *always*?

&gt;<i> I am not sure I interpret your definition correctly, but I hope the
</I>&gt;<i> following statements will answer your question regardless of that
</I>&gt;<i> interpretation:
</I>&gt;<i> 
</I>&gt;<i> * Staring (at step2) or bumping (at any step) alters TLS bytes on the
</I>&gt;<i> wire. The client and the origin server will see some TLS bytes that are
</I>&gt;<i> going to differ from the TLS bytes they would have seen if Squid was not
</I>&gt;<i> there.
</I>&gt;<i> 
</I>&gt;<i> * In this scope, the deprecated client-first and server-first actions
</I>&gt;<i> are equivalent to applying the &quot;bump&quot; action.
</I>&gt;<i> 
</I>&gt;<i> * If successful, ssl_bump peek and splice actions do not alter TLS
</I>&gt;<i> bytes. Peeking and/or splicing Squid can be viewed as a TCP proxy as far
</I>&gt;<i> as TLS bytes forwarding is concerned. The client and the origin server
</I>&gt;<i> will see the same TLS bytes they would have seen if Squid was not there.
</I>&gt;<i> 
</I>&gt;<i> * In this scope, various errors are usually equivalent to applying the
</I>&gt;<i> &quot;bump&quot; action.
</I> 
Very clear and useful explanation

&gt;<i> 
</I>&gt;<i> If your definition of &quot;secure&quot; is &quot;does not change TLS bytes exchanges
</I>&gt;<i> between client and server&quot;
</I>
Yes, you have correctly understood what I tried to mean with the term &quot;secure&quot;;  Say..: &quot;Don't let squid touch sites that should not be touched&quot; ...or some like that.

&gt;<i>, then if your configuration has a &quot;stare&quot;
</I>&gt;<i> and/or &quot;bump&quot; actions, it is &quot;insecure&quot;. If your configuration may lead
</I>&gt;<i> to certificate validation errors, it is also &quot;insecure&quot;.
</I>
Does not the splice at step1 and step2 action avoid this? I mean if squid act as a -TCP forward proxy only- for noBumpSites. &quot;Don't touch TLS bytes&quot;

&gt;<i> &gt; When I do this:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; ssl_bump splice noBumpSites
</I>&gt;<i> &gt; ssl_bump stare all
</I>&gt;<i> 
</I>&gt;<i> &gt; It is supposed that in this config I am (guessing), implicity,
</I>&gt;<i> &gt; peeking  (first?) and splice at any step and bumping (implicity) at
</I>&gt;<i> &gt; step3 sites that does not match with whitelist by staring at step2.
</I>&gt;<i> &gt; Maybe something like that, I dont know.
</I>&gt;<i> 
</I>&gt;<i> I do not think your description of the above configuration is correct.
</I>&gt;<i> Squid uses default actions (&quot;splice&quot; or &quot;bump&quot;) when no applicable rules
</I>&gt;<i> match. In the above configuration, one of the rules will always match
</I>&gt;<i> during step1 and during step2 (if any). Thus, there will be no implicit
</I>&gt;<i> splicing or bumping during the first steps. If Squid reaches step3, then
</I>&gt;<i> Squid will apply the default bump rule at that step (because &quot;stare&quot;
</I>&gt;<i> matched at the previous step).
</I>&gt;<i> 
</I>&gt;<i> I am not sure, but I think the above configuration is equivalent to the
</I>&gt;<i> following configuration that does not rely on default rules:
</I>&gt;<i> 
</I>&gt;<i>   ssl_bump splice step1 noBumpSites
</I>&gt;<i>   ssl_bump splice step2 noBumpSites
</I>&gt;<i>   ssl_bump stare step1
</I>&gt;<i>   ssl_bump stare step2
</I>&gt;<i>   ssl_bump bump step3
</I>
According to Amos: Always is better to be explicit and bump at step3 after stare at step2. (And of course more clearly to understand)

I have tested this above config (I think that this one you've posted is what I want to do) against the &quot;compact/default one (the last &quot;2-lines-config&quot; above) and I almost sure that the squid logs reports the same behaviour, and maybe there are less lines with: &quot;ssl&quot; lib errors...and &quot;Security Alert: there is no ip/domain match....&quot; 

BUT here you are never peek'ing? How is that? 
You are stare'ing instead of peek'ing at step1 (3rd line), I would have done a peek at that line. I refered to this question when I said  &quot;see the doubt at the end...&quot; at almost at the middle of msg..

&gt;<i> HTH,
</I>&gt;<i> 
</I>&gt;<i> Alex.
</I>
OK....:

I think that is enough. We should make a pause or close the thread.
I *MUST* as soon as possible re-re and re-read the this thread entirely again and again.. And the Wiki page too. 
Because I am remembering (in English as well as I can) that Amos said things that You are telling me -again- (maybe in other words, but that isn't important neither the point)

All the best,

Thank You all


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="019200.html">[squid-users] About SSL peek-n-splice/bump configurations
</A></li>
	<LI>Next message (by thread): <A HREF="019205.html">[squid-users] About SSL peek-n-splice/bump configurations
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19203">[ date ]</a>
              <a href="thread.html#19203">[ thread ]</a>
              <a href="subject.html#19203">[ subject ]</a>
              <a href="author.html#19203">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
