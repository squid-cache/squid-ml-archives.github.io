<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] About SSL peek-n-splice/bump configurations
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20About%20SSL%20peek-n-splice/bump%20configurations&In-Reply-To=%3C0472b838-415e-e4d2-c71a-7fbce45de926%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="019203.html">
   <LINK REL="Next"  HREF="019211.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] About SSL peek-n-splice/bump configurations</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20About%20SSL%20peek-n-splice/bump%20configurations&In-Reply-To=%3C0472b838-415e-e4d2-c71a-7fbce45de926%40measurement-factory.com%3E"
       TITLE="[squid-users] About SSL peek-n-splice/bump configurations">rousskov at measurement-factory.com
       </A><BR>
    <I>Thu Sep 13 15:00:14 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="019203.html">[squid-users] About SSL peek-n-splice/bump configurations
</A></li>
        <LI>Next message (by thread): <A HREF="019211.html">[squid-users] About SSL peek-n-splice/bump configurations
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19205">[ date ]</a>
              <a href="thread.html#19205">[ thread ]</a>
              <a href="subject.html#19205">[ subject ]</a>
              <a href="author.html#19205">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 09/12/2018 09:02 PM, Julian Perconti wrote:

&gt;<i> ssl_bump peek step1
</I>&gt;<i> ssl_bump peek noBumpSites
</I>&gt;<i> ssl_bump stare all
</I>
&gt;&gt;&gt;&gt;<i> ssl_bump peek noBumpSites # As there no step specified, squid match
</I>&gt;&gt;&gt;&gt;<i> at any step
</I>
&gt;&gt;<i> Not exactly. Squid will evaluate this rule at any step that (a) reaches
</I>&gt;&gt;<i> this line and (b) where the peek action is applicable. The intersection
</I>&gt;&gt;<i> of those two preconditions is &quot;step2&quot; rather than &quot;any step&quot;.
</I>
&gt;<i> Ok, say that the most (not to say the *only*) important beyond any step or action is the *secuential order -line_by_line-* of the rules (steps) .
</I>&gt;<i> 
</I>&gt;<i> Example:
</I>&gt;<i> 
</I>&gt;<i>   ssl_bump splice noBumpSites # this will be totally ignored by Squid if a stare rule precedes this.
</I>
No, this is incorrect. There are many cases were a previous stare rule
will not have the effect you state it will. For example:

  # Squid may splice at step2 despite the preceding stare rule
  # because staring at step1 does not preclude splicing.

  ssl_bump stare step1
  ssl_bump splice noBumpSites

and

  # Squid will splice at step1 despite the preceding stare rule
  # because the preceding stare rule never matches
  ssl_bump stare !all
  ssl_bump splice all


&gt;<i> ssl_bump stare noBumpSites # No matter what, here is the Squid first
</I>&gt;<i> match and he is at step1...
</I>
&gt;<i> ssl_bump splice noBumpSites # ...Therefore here Squid is at step2,
</I>&gt;<i> then this line will never match, even not having specified the step
</I>&gt;<i> in both lines, because &quot;noBumpSites&quot; was already stared at first
</I>&gt;<i> line.
</I>You seem to be assuming that the action during the previous step is
important even if the rule with that action did not match during the
previous step. That is incorrect. The previous step action may be
important only if it was actually used during that previous step (i.e.
Squid reached that action's rule and that rule's ACLs matched).


&gt;<i> if in case that an implicit stare occurs at step2 due to first line,
</I>&gt;<i> then squid will [...] never-match/ignore the second line completely.
</I>
That is correct. The part in [...] was a bit misleading because it
depended on the not shown (default?) rules, so I removed it.



&gt;<i> Resume: Implicit splice and bump exists aalways exists. Implicit peek, no. Is this correct?
</I>
There are ways to interpret this statement correctly, but I would not
phrase it this way.

A better statement would be that when no rule matched at a given step,
Squid uses the default rule. The default rule is &quot;bump&quot; if Squid stared
at the previous step. The default rule is &quot;splice&quot; in all other cases,
including the case where no rule matched during the first step (i.e.
there was no &quot;previous step&quot;).


&gt;&gt;<i> Adding &quot;all&quot; to any line changes nothing as far as line matching is
</I>&gt;&gt;<i> considered. The value of &quot;foo and true&quot; is equivalent to the value of &quot;foo&quot;.
</I>&gt;<i> 
</I>&gt;<i> So the word &quot;all&quot; makes sense if its is &quot;alone&quot;?
</I>
The documented ssl_bump line syntax requires an ACL. If you want a rule
to always match, use an &quot;all&quot; ACL. Ideally, the syntax should be relaxed
to not require an ACL at all in those cases. I did not check whether the
implementation matches the documentation.


&gt;<i> e.g.: ssl_bump peek step1 all = ssl_bump peek step1, *always*?
</I>
Yes, as far as rule matching is concerned. The &quot;all&quot; ACL always matches.


&gt;&gt;<i> if your configuration has a &quot;stare&quot;
</I>&gt;&gt;<i> and/or &quot;bump&quot; actions, it is &quot;insecure&quot;. If your configuration may lead
</I>&gt;&gt;<i> to certificate validation errors, it is also &quot;insecure&quot;.
</I>
&gt;<i> Does not the splice at step1 and step2 action avoid this? I mean if
</I>&gt;<i> squid act as a -TCP forward proxy only- for noBumpSites. &quot;Don't touch
</I>&gt;<i> TLS bytes&quot;
</I>
I am not sure what you mean by &quot;this&quot; exactly, but splicing (at any
step) does not guarantee the lack of errors. The earlier you tell Squid
to splice the connections, the fewer checks Squid will do, decreasing
the probability of an error. Errors lead to bumping the client
connection (to deliver the error message).


&gt;&gt;&gt;<i> When I do this:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> ssl_bump splice noBumpSites
</I>&gt;&gt;&gt;<i> ssl_bump stare all
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> It is supposed that in this config I am (guessing), implicity,
</I>&gt;&gt;&gt;<i> peeking  (first?) and splice at any step and bumping (implicity) at
</I>&gt;&gt;&gt;<i> step3 sites that does not match with whitelist by staring at step2.
</I>&gt;&gt;&gt;<i> Maybe something like that, I dont know.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I do not think your description of the above configuration is correct.
</I>&gt;&gt;<i> Squid uses default actions (&quot;splice&quot; or &quot;bump&quot;) when no applicable rules
</I>&gt;&gt;<i> match. In the above configuration, one of the rules will always match
</I>&gt;&gt;<i> during step1 and during step2 (if any). Thus, there will be no implicit
</I>&gt;&gt;<i> splicing or bumping during the first steps. If Squid reaches step3, then
</I>&gt;&gt;<i> Squid will apply the default bump rule at that step (because &quot;stare&quot;
</I>&gt;&gt;<i> matched at the previous step).
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I am not sure, but I think the above configuration is equivalent to the
</I>&gt;&gt;<i> following configuration that does not rely on default rules:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>   ssl_bump splice step1 noBumpSites
</I>&gt;&gt;<i>   ssl_bump splice step2 noBumpSites
</I>&gt;&gt;<i>   ssl_bump stare step1
</I>&gt;&gt;<i>   ssl_bump stare step2
</I>&gt;&gt;<i>   ssl_bump bump step3
</I>
&gt;<i> According to Amos: Always is better to be explicit and bump at step3
</I>&gt;<i> after stare at step2. (And of course more clearly to understand)
</I>
That &quot;always better to be explicit&quot; recipe fails when you cannot tell (a
priori) what the previous step result was. In those cases, you may want
to rely on the default rules (after making sure they work) OR rewrite
the configuration so that you know for sure what the previous step
result was. In the two-line configuration above, we always know what the
previous step result was, so it is possible to add an explicit (and
correct) step3 action.

Which configuration is clearer depends on the observer. Use whatever
correct variant looks best to _you_.


&gt;<i> BUT here you are never peek'ing? How is that? 
</I>
Staring at step1 performs the same actions as peeking at step1. The only
difference is the side effect on the default rules choice for step2 (if
Squid needs to make that choice). In both of the above configurations,
there is no need for Squid to make that choice for step2.


Alex.

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="019203.html">[squid-users] About SSL peek-n-splice/bump configurations
</A></li>
	<LI>Next message (by thread): <A HREF="019211.html">[squid-users] About SSL peek-n-splice/bump configurations
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19205">[ date ]</a>
              <a href="thread.html#19205">[ thread ]</a>
              <a href="subject.html#19205">[ subject ]</a>
              <a href="author.html#19205">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
