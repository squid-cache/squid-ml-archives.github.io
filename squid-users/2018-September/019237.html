<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] About SSL peek-n-splice/bump configurations
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20About%20SSL%20peek-n-splice/bump%20configurations&In-Reply-To=%3C006d01d44eaf%2455ecc290%2401c647b0%24%40yahoo.com.ar%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="019213.html">
   <LINK REL="Next"  HREF="019239.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] About SSL peek-n-splice/bump configurations</H1>
    <B>Julian Perconti</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20About%20SSL%20peek-n-splice/bump%20configurations&In-Reply-To=%3C006d01d44eaf%2455ecc290%2401c647b0%24%40yahoo.com.ar%3E"
       TITLE="[squid-users] About SSL peek-n-splice/bump configurations">vh1988 at yahoo.com.ar
       </A><BR>
    <I>Mon Sep 17 17:53:21 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="019213.html">[squid-users] About SSL peek-n-splice/bump configurations
</A></li>
        <LI>Next message (by thread): <A HREF="019239.html">[squid-users] About SSL peek-n-splice/bump configurations
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19237">[ date ]</a>
              <a href="thread.html#19237">[ thread ]</a>
              <a href="subject.html#19237">[ subject ]</a>
              <a href="author.html#19237">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>&gt;<i> &gt; So, when squid reaches this first rule and line (there is no explicit
</I>&gt;<i> &gt; step)  ...does Squid make a &quot;bucle of steps&quot; only along the first line
</I>&gt;<i> &gt; and go to next line only when the rule stop being
</I>&gt;<i> &gt; applicable/matchable?
</I>&gt;<i> 
</I>&gt;<i> I hesitate answering that question with a simple &quot;yes&quot; or &quot;no&quot; because any
</I>&gt;<i> such answer is likely to mislead folks reading this email.
</I>
Well yes, and I hope that this thread helps to others.

&gt;<i> 
</I>&gt;<i> The overall logic is like this:
</I>&gt;<i> 
</I>&gt;<i>   for each step
</I>&gt;<i>   do
</I>&gt;<i>       for each rule
</I>&gt;<i>       do
</I>&gt;<i>           if the rule action is possible and the rule ACLs match,
</I>&gt;<i>               then perform the rule action and either go to the next
</I>&gt;<i>               step or, after applying the final action, exit
</I>&gt;<i>       done
</I>&gt;<i>       apply the default action and exit
</I>&gt;<i>   done
</I>
Well, this explanation merits to copy it and paste into squid.conf as a comment.

Let me know if I understand what Squid does with the rules of SslBump through this logic:

&gt;<i>   for each step
</I>&gt;<i>   do # This loop will execute as maximum up to three times; because there are 3 steps in the entire SslBump environment.
</I>
&gt;<i>       for each rule
</I>&gt;<i>       do # ...and this loop, will execute as many times as the amount of the rules the config has.
</I>
Probably my interpretation of the nested loop is wrong.

Now, How does Squid takes  and retains decisions when the steps are implicit/explicit throught the rules? The developers knows the details.

&gt;<i> &gt; He is being a passive observer of that TLS traffic.
</I>&gt;<i> 
</I>&gt;<i> Squid also validates what it observes/forwards. And there is also TCP/IP
</I>&gt;<i> traffic before (and around) TLS traffic.
</I>
OK, so I will peek, instead of splice at step1 and step2; and the final action will be splice and it will happen at step3; the step where the final actions are always taken.

I think that splice at step1 does not make sense according to the doc. and also to the order of steps or the sequence, about how the rules are evaluated.
By other hand, lets squid to do more checks even if a sites will be spliced: to do that, as I said above, I (think that) have to peek instead splice at step1 and step2. 

Even more, about the step3 the squid doc. says: 
  I: Get TLS Server Hello info from the server, including the server certificate.
  II: Validate the TLS server certificate.

Finally, the thing that really does not makes sense is splice at step1 and then splice at step2:
Acording to squid doc.: &quot;step2/step3 is only performed if a peek or stare rule matched during the previous step.&quot; (not a splice rule)

&gt;<i> &gt; Here, I am talking about the idea of (explicitly) splice at step1 and then at
</I>&gt;<i> step2 of a white list of sites.
</I>&gt;<i> 
</I>&gt;<i> If you splice at step1, then the number of validations that Squid does would
</I>&gt;<i> be smaller (possibly zero, not sure) than if you splice at step2.
</I>
Again, following the documentation: &quot;Step 2 is only performed if a peek or stare rule matched during the previous step.&quot; So, Is &quot;correct&quot; to splice at step1 or step2?

&gt;<i> The devil is in the details:
</I>
Always.

&gt;<i> * A key detail here is determining whether the intended site _is_
</I>&gt;<i> &quot;really/special sensitive&quot;. For example, the intercepted client is connecting to
</I>&gt;<i> b::a:d IPv6 address while claiming in the TLS Hello that it is trying to get to
</I>&gt;<i> sensitive.example.com. Should Squid trust the intended destination IP
</I>&gt;<i> address or the TLS SNI? Or should we wait for the server to identify itself
</I>&gt;<i> with a valid SSL certificate? Etc.
</I>
&gt;<i>From the &quot;security side&quot; I think that the second option. &quot;...wait for the server to identify (...)&quot;
</I>
Therefore, I think that as is &quot;more secure&quot; bump at step3 then should be more secure splice at step3 too.

&gt;<i> * The other key detail is what should happen when that sensitive site refuses
</I>&gt;<i> to communicate with Squid or otherwise misbehaves. Should Squid, for
</I>&gt;<i> example, simply close the browser connection, making it more likely that the
</I>&gt;<i> user (or their admin) blames the proxy? Or should Squid bump the browser
</I>&gt;<i> connection to explain what has happened, creating all the headaches
</I>&gt;<i> associated with bumping.
</I>
Do not what to say at this point. Maybe I am missing something...

&gt;<i> Your Squid configuration should reflect all these key decisions.
</I>&gt;<i> If Squid does not have enough configuration options or code to do exactly
</I>&gt;<i> what you want, then you (or others) can always add more code/options. If
</I>&gt;<i> your use case is common/general enough, then quality implementations of
</I>&gt;<i> those additional features should be officially accepted.
</I>
Well, let me show You, what is my *second final* config to do the the most approximate actions I want Squid do and who has read the thread knows, taken as a conclusion of the thread:

Telling to Squid what exactly he has to do at each step explicitly:

   ssl_bump peek step1 noBumpSites # at step1 peak or stare do the same, but Amos says that stare alters &quot;the letters&quot; while peek no.
   ssl_bump peek step2 noBumpSites 
   ssl_bump splice step3 noBumpSites # This is probably reduntant
   ssl_bump stare step1 # Maybe It is the same if I peek here instead stare, because the difference about stare and peek happens at step2, the same come could be stay at first line, not sure.
   ssl_bump stare step2
   ssl_bump bump step3 # This is even more reduntant too.

If You have a look at helion.pl and/or the original config and compare his config and my own above are very similar (not to say identical)

As an excercise a more compact config that do more-or-less the same would be:

   ssl_bump peek noBumpSites
   ssl_bump stare

But, what happen if Squid decides automagically wrong? Or something does not match...?

Do You think that the above rules is more-or-less the more nearest what I want to do?
Excuse me but, I think that at this stage, I gues that You already know what I mean when I say &quot;...what I want to do?&quot;


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="019213.html">[squid-users] About SSL peek-n-splice/bump configurations
</A></li>
	<LI>Next message (by thread): <A HREF="019239.html">[squid-users] About SSL peek-n-splice/bump configurations
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19237">[ date ]</a>
              <a href="thread.html#19237">[ thread ]</a>
              <a href="subject.html#19237">[ subject ]</a>
              <a href="author.html#19237">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
