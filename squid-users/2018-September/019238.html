<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Help: squid restarts and squidGuard die
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Help%3A%20squid%20restarts%20and%20squidGuard%20die&In-Reply-To=%3Cf8f51c90-6bd7-09d0-a90b-c9552748d813%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="019236.html">
   <LINK REL="Next"  HREF="019241.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Help: squid restarts and squidGuard die</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Help%3A%20squid%20restarts%20and%20squidGuard%20die&In-Reply-To=%3Cf8f51c90-6bd7-09d0-a90b-c9552748d813%40treenet.co.nz%3E"
       TITLE="[squid-users] Help: squid restarts and squidGuard die">squid3 at treenet.co.nz
       </A><BR>
    <I>Mon Sep 17 18:38:06 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="019236.html">[squid-users] Help: squid restarts and squidGuard die
</A></li>
        <LI>Next message (by thread): <A HREF="019241.html">[squid-users] Help: squid restarts and squidGuard die
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19238">[ date ]</a>
              <a href="thread.html#19238">[ thread ]</a>
              <a href="subject.html#19238">[ subject ]</a>
              <a href="author.html#19238">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 18/09/18 3:37 AM, Service MV wrote:
&gt;<i> Dear Ones, I draw on your experience in seeking help to determine
</I>&gt;<i> whether or not it is possible to achieve the configuration I am looking
</I>&gt;<i> for, due to a strange error I am having.
</I>
FYI: SquidGuard has not been maintained for many years now.

I recommend you convert as many of your filtering rules as you can into
normal Squid ACLs. Traffic which is being blocked for simple reasons can
be done much more efficiently by Squid than a helper.

You can use the more up-to-date ufdbguard helper as a drop-in
replacement for squidguard during the conversion.



&gt;<i> 
</I>&gt;<i> Before commenting on the bug I describe my testing environment:
</I>&gt;<i> - A VM CentOS 7 Core over VirtualBox 5.2, 1 NIC.
</I>&gt;<i> - My VM is attached to my domain W2012R2 (following this post
</I>&gt;<i> <A HREF="https://www.rootusers.com/how-to-join-centos-linux-to-an-active-directory-domain/">https://www.rootusers.com/how-to-join-centos-linux-to-an-active-directory-domain/</A>)
</I>&gt;<i> to achieve kerberos authentication transparent to the user. SElinux
</I>&gt;<i> disabled. Owner permissions to user squid in all folders/files involved.
</I>&gt;<i> - squid 3.5.20 installed and working great with kerberos, NTLM and basic
</I>&gt;<i> authentication. All authentication mechanisms tested and working great.
</I>&gt;<i> - SquidGuard: 1.4 Berkeley DB 5.3.21 installed and working great with
</I>&gt;<i> blacklists and acl default.
</I>&gt;<i> 
</I>&gt;<i> My problem starts when I try to use source acl using ldapusersearch in
</I>&gt;<i> squidGuard...&#160;
</I>&gt;<i> 
</I>&gt;<i> systemctl status squid:
</I>&gt;<i> (squid-1)[12627]: The redirector helpers are crashing too rapidly, need
</I>&gt;<i> help!
</I>&gt;<i> 
</I>&gt;<i> *squidGuard.conf*
</I>&gt;<i> 
</I>&gt;<i> dbhome /etc/squid/db
</I>&gt;<i> logdir /var/log/squidGuard
</I>&gt;<i> ldapbinddn
</I>&gt;<i> CN=ldap,OU=SERVICIOS,OU=SISTEMAS,OU=CANAL,OU=MYCOMPANY,DC=mydomain,DC=local
</I>&gt;<i> ldapbindpass myULTRAsecretPASS
</I>&gt;<i> ldapprotover 3
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> src WEB_BASIC {
</I>&gt;<i> ldapusersearch
</I>&gt;<i> <A HREF="ldap://dc-1.mydomain.local:3268/dc=mydomain,dc=local?sAMAccountName?sub?(&amp;(sAMAccountName=%s">ldap://dc-1.mydomain.local:3268/dc=mydomain,dc=local?sAMAccountName?sub?(&amp;(sAMAccountName=%s</A>)(memberOf=cn=WEB_BASIC%2cou=INTERNET%2cou=PERMISOS%2cou=MYCOMPANY%2cdc=mydomain%2cdc=local))
</I>&gt;<i> log block.log
</I>&gt;<i> }
</I>&gt;<i> 
</I>...
&gt;<i> 
</I>&gt;<i> acl {
</I>&gt;<i> 
</I>&gt;<i> WEB_BASIC{
</I>&gt;<i> pass whitelist !BL_porn !blacklist all
</I>&gt;<i> redirect
</I>&gt;<i> <A HREF="http://s-server1.mydomain.local/cgi-bin/squidGuard.cgi?clientaddr=%a&amp;clientname=%n&amp;clientuser=%i&amp;clientgroup=%s&amp;targetgroup=%t&amp;url=%u">http://s-server1.mydomain.local/cgi-bin/squidGuard.cgi?clientaddr=%a&amp;clientname=%n&amp;clientuser=%i&amp;clientgroup=%s&amp;targetgroup=%t&amp;url=%u</A>
</I>&gt;<i> log block.log
</I>&gt;<i> }
</I>&gt;<i> 
</I>...


&gt;<i> *squid.conf*
</I>&gt;<i> 
</I>&gt;<i> acl localnet src 10.10.8.0/22 # LAN net
</I>&gt;<i> acl dmz src 192.168.20.0/27   # DMZ net
</I>
These ACLs are never used dues to what you are doing with the &quot;auth&quot; ACL.

...
&gt;<i> 
</I>&gt;<i> ### acl for proxy authentication (kerberos or ntlm) and ldap authorizations
</I>&gt;<i> acl auth proxy_auth REQUIRED
</I>&gt;<i> 
</I>&gt;<i> # Define protocols used for redirects
</I>&gt;<i> acl HTTP proto HTTP
</I>&gt;<i> acl HTTPS proto HTTPS
</I>
These have nothing to do with redirects and are never used.

&gt;<i> 
</I>&gt;<i> ### enforce authentication
</I>&gt;<i> http_access allow auth&#160;
</I>&gt;<i> http_access deny !auth
</I>&gt;<i> 
</I>
All possible traffic will match either &quot;auth&quot; or &quot;!auth&quot; above.

That means no http_access rules following this point do anything.


&gt;<i> ### standard access rules
</I>&gt;<i> http_access deny !Safe_ports&#160;
</I>&gt;<i> http_access deny CONNECT !SSL_ports&#160;
</I>&gt;<i> http_access allow localhost manager&#160;
</I>&gt;<i> http_access deny manager
</I>
Your custom http_access rules (eg the auth checks) should be down here
so the basic security rules above have a chance to protect your proxy
again DoS, traffic smuggling attacks etc. before more complicated and
resource consuming things happen.


&gt;<i> http_access allow localnet
</I>&gt;<i> http_access allow dmz
</I>&gt;<i> http_access allow localhost&#160;
</I>&gt;<i> http_access deny all
</I>&gt;<i> 
</I>
...
&gt;<i> visible_hostname eren 
</I>
The hostname needs to be a FQDN. It is delivered to clients in URLs
generated by Squid so they can fetch objects directly from the proxy.

FYI: Squid-3 should be able to automatically locate the hostname of the
machine it is running on. If that is not working then you need to fix
your machine, other software will be using the same mechanism and
likewise be encountering problems.


&gt;<i> httpd_suppress_version_string on&#160;
</I>&gt;<i> uri_whitespace strip
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> ## squidGuard ##
</I>&gt;<i> url_rewrite_program /usr/bin/squidGuard -c /etc/squid/squidGuard.conf
</I>&gt;<i> url_rewrite_children 10 startup=5 idle=1 concurrency=0
</I>&gt;<i> url_rewrite_bypass off
</I>&gt;<i> 
</I>&gt;<i> 
</I>
Your traffic in your access.log is all CONNECT requests. Those messages
cannot be re-written by SquidGuard. So at the very least you require
this config line:

 url_rewrite_access deny CONNECT


.. at this point you may notice your SG rules have no effect. This is
one of many reasons why you should do access control in the proxy
config, not externally in a complicated and slow helper.

&gt;<i> 
</I>&gt;<i> *messages*
</I>&gt;<i> 
</I>&gt;<i> Sep 17 11:13:07 proxy kernel: squidGuard[12552]: segfault at
</I>&gt;<i> ffffffffd7706bb0 ip 00007fdbf2052e70 sp 00007fffd1b73c70 error 5 in
</I>&gt;<i> libldap-2.4.so.2.10.7[7fdbf2027000+52000]
</I>&gt;<i> Sep 17 11:13:07 proxy kernel: squidGuard[12553]: segfault at
</I>&gt;<i> ffffffffa3d27bb0 ip 00007fd79b787e70 sp 00007ffe47e9b880 error 5 in
</I>&gt;<i> libldap-2.4.so.2.10.7[7fd79b75c000+52000]
</I>
...

&gt;<i> 
</I>&gt;<i> If I disable src and acl WEB_BASIC I have no problem. The default acl
</I>&gt;<i> does its thing without problems.
</I>&gt;<i> But when I enable src and acl WEB_BASIC squidGuard explodes and squid
</I>&gt;<i> restarts so I get to notice.
</I>&gt;<i> I see an error in a libldap library... Will it be a library error? Or am
</I>&gt;<i> I misconfiguring my squid ?
</I>&gt;<i> 
</I>
It is not a Squid error. It is something in SquidGuard and/or the library.

Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="019236.html">[squid-users] Help: squid restarts and squidGuard die
</A></li>
	<LI>Next message (by thread): <A HREF="019241.html">[squid-users] Help: squid restarts and squidGuard die
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19238">[ date ]</a>
              <a href="thread.html#19238">[ thread ]</a>
              <a href="subject.html#19238">[ subject ]</a>
              <a href="author.html#19238">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
