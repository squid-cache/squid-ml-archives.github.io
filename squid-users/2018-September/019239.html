<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] About SSL peek-n-splice/bump configurations
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20About%20SSL%20peek-n-splice/bump%20configurations&In-Reply-To=%3Cee42d35f-2dc0-3bbc-f6c4-a1852374a832%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="019237.html">
   <LINK REL="Next"  HREF="019240.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] About SSL peek-n-splice/bump configurations</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20About%20SSL%20peek-n-splice/bump%20configurations&In-Reply-To=%3Cee42d35f-2dc0-3bbc-f6c4-a1852374a832%40measurement-factory.com%3E"
       TITLE="[squid-users] About SSL peek-n-splice/bump configurations">rousskov at measurement-factory.com
       </A><BR>
    <I>Mon Sep 17 19:57:12 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="019237.html">[squid-users] About SSL peek-n-splice/bump configurations
</A></li>
        <LI>Next message (by thread): <A HREF="019240.html">[squid-users] About SSL peek-n-splice/bump configurations
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19239">[ date ]</a>
              <a href="thread.html#19239">[ thread ]</a>
              <a href="subject.html#19239">[ subject ]</a>
              <a href="author.html#19239">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 09/17/2018 11:53 AM, Julian Perconti wrote:

&gt;&gt;<i> The overall logic is like this:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>   for each step
</I>&gt;&gt;<i>   do
</I>&gt;&gt;<i>       for each rule
</I>&gt;&gt;<i>       do
</I>&gt;&gt;<i>           if the rule action is possible and the rule ACLs match,
</I>&gt;&gt;<i>               then perform the rule action and either go to the next
</I>&gt;&gt;<i>               step or, after applying the final action, exit
</I>&gt;&gt;<i>       done
</I>&gt;&gt;<i>       apply the default action and exit
</I>&gt;&gt;<i>   done
</I>
&gt;<i> Let me know if I understand what Squid does with the rules of SslBump through this logic:
</I>&gt;<i> 
</I>&gt;&gt;<i>   for each step
</I>&gt;&gt;<i>   do # This loop will execute as maximum up to three times; because there are 3 steps in the entire SslBump environment.
</I>
Yes.


&gt;&gt;<i>       for each rule
</I>&gt;&gt;<i>       do # ...and this loop, will execute as many times as the amount of the rules the config has.
</I>
For each other loop iteration, this inner loop will execute zero or more
times, depending on the number _and_ meaning/content of the rules.

Both loops can finish &quot;early&quot; (i.e. before three steps and/or before all
configured rules are evaluated).



&gt;<i> Now, How does Squid takes  and retains decisions when the steps are
</I>&gt;<i> implicit/explicit throught the rules?
</I>
See my loops summary above: If the inner loop runs to its completion,
then Squid applies the default action (because the inner loop found no
usable explicit rules). There is no secret magic here (at least not at
this level of detail).


&gt;<i> OK, so I will peek, instead of splice at step1 and step2; and the
</I>&gt;<i> final action will be splice and it will happen at step3; the step
</I>&gt;<i> where the final actions are always taken.
</I>
Just to avoid misunderstanding: Final actions may be taken at any step,
but only final actions are possible at step3.


&gt;<i> I think that splice at step1 does not make sense according to the
</I>&gt;<i> doc. and also to the order of steps or the sequence, about how the
</I>&gt;<i> rules are evaluated.
</I>
I do not know what you mean. Splice at step1 is certainly possible and
even recommended for known non-TLS traffic.


&gt;<i> the thing that really does not makes sense is splice at step1 and then splice at step2:
</I>
It is not possible to splice twice. Splicing is one of the final
actions. No other action follows a final action (by definition). Search
for the two &quot;exit&quot; words in the loop summary to find where final actions
may be applied.


&gt;<i> Acording to squid doc.: &quot;step2/step3 is only performed if a peek or
</I>&gt;<i> stare rule matched during the previous step.&quot; (not a splice rule)
</I>
Correct.


&gt;<i> So, Is &quot;correct&quot; to splice at step1 or step2?
</I>
The best thing to do depends on your goals and the transaction. Splicing
at step1, step2, OR step3 makes sense in some cases and does not make
sense (or is impossible) in others.

You need to evaluate your rules in the context of a specific transaction
though: The same set of ssl_bump rules may splice transaction A at step1
and transaction C at step3. The loops summarized above are executed from
scratch for every transaction that reaches ssl_bump directive evaluation.


&gt;&gt;<i> * A key detail here is determining whether the intended site _is_
</I>&gt;&gt;<i> &quot;really/special sensitive&quot;. For example, the intercepted client is connecting to
</I>&gt;&gt;<i> b::a:d IPv6 address while claiming in the TLS Hello that it is trying to get to
</I>&gt;&gt;<i> sensitive.example.com. Should Squid trust the intended destination IP
</I>&gt;&gt;<i> address or the TLS SNI? Or should we wait for the server to identify itself
</I>&gt;&gt;<i> with a valid SSL certificate? Etc.
</I>
&gt;<i> From the &quot;security side&quot; I think that the second option. &quot;...wait for the server to identify (...)&quot;
</I>
&gt;<i> Therefore, I think that as is &quot;more secure&quot; bump at step3 then should be more secure splice at step3 too.
</I>
It is impossible to make &quot;splice or bump&quot; decision at step3 because
splicing at step3 requires peeking at step2 while bumping at step3
requires staring at step2. In a context of a single transaction, it is
impossible to both peek and stare at the same time!

Thus, you essentially have to make that &quot;splice or bump&quot; decision
earlier, at step1 or step2, when you have less information than you
would have at step3. It is almost like the dominant quantum physics
theory -- by measuring at step2, you determine the outcome of that
measurement (i.e. available actions at step3).


&gt;<i> Telling to Squid what exactly he has to do at each step explicitly:
</I>&gt;<i> 
</I>&gt;<i>    ssl_bump peek step1 noBumpSites # at step1 peak or stare do the same, but Amos says that stare alters &quot;the letters&quot; while peek no.
</I>
A matching peek rule at step1 results in (TLS Client Hello being parsed
during) step2. It also tells Squid to splice by default at step2 if
Squid needs to apply a default action at step2.

A matching stare rule at step1 results in (TLS Client Hello being parsed
during) step2. It also tells Squid to bump by default at step2 if Squid
needs to apply a default action at step2.

There are no TLS byte modifications during peeking or staring at step1.

I think this is all documented at
<A HREF="https://wiki.squid-cache.org/Features/SslPeekAndSplice">https://wiki.squid-cache.org/Features/SslPeekAndSplice</A>



&gt;<i>    ssl_bump peek noBumpSites
</I>&gt;<i>    ssl_bump stare
</I>&gt;<i> 
</I>&gt;<i> But, what happen if Squid decides automagically wrong? Or something does not match...?
</I>
I do not know what you mean by &quot;Squid decides automagically wrong&quot;

At step1 and at step2, if noBumpSites matches, then Squid will peek.

At step1 and at step2, if noBumpSites does not match, then Squid will stare.

At step3, no explicit rules can match so Squid will either splice or
bump, depending on whether noBumpSites matched at step2.




&gt;<i> Do You think that the above rules is more-or-less the more nearest
</I>&gt;<i> what I want to do? Excuse me but, I think that at this stage, I gues
</I>&gt;<i> that You already know what I mean when I say &quot;...what I want to do?&quot;
</I>
Sorry, I do not. And since there are many details that define what one
wants to (or should) do, it may be impractical to relay all of them on
an informal email thread. However, if you understand how SslBump rules
work, then you can either answer a vague &quot;Am I doing what I want to be
doing?&quot; question yourself or ask more specific questions that can be
answered on the mailing list.

Alex.

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="019237.html">[squid-users] About SSL peek-n-splice/bump configurations
</A></li>
	<LI>Next message (by thread): <A HREF="019240.html">[squid-users] About SSL peek-n-splice/bump configurations
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19239">[ date ]</a>
              <a href="thread.html#19239">[ thread ]</a>
              <a href="subject.html#19239">[ subject ]</a>
              <a href="author.html#19239">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
