<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Help: squid restarts and squidGuard die
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Help%3A%20squid%20restarts%20and%20squidGuard%20die&In-Reply-To=%3C96404267-7169-4A99-87D7-F5656592E900%40data-core.org%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="019238.html">
   <LINK REL="Next"  HREF="019249.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Help: squid restarts and squidGuard die</H1>
    <B>Flashdown</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Help%3A%20squid%20restarts%20and%20squidGuard%20die&In-Reply-To=%3C96404267-7169-4A99-87D7-F5656592E900%40data-core.org%3E"
       TITLE="[squid-users] Help: squid restarts and squidGuard die">flashdown at data-core.org
       </A><BR>
    <I>Mon Sep 17 23:10:54 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="019238.html">[squid-users] Help: squid restarts and squidGuard die
</A></li>
        <LI>Next message (by thread): <A HREF="019249.html">[squid-users] Help: squid restarts and squidGuard die
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19241">[ date ]</a>
              <a href="thread.html#19241">[ thread ]</a>
              <a href="subject.html#19241">[ subject ]</a>
              <a href="author.html#19241">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Just want to add, I use SquidGuard in two High load setups and never ran into issues. I didnt integrate it as url rewrite helper but as external acl helper and it works great with 800 Users.. 

Am 17. September 2018 20:38:06 MESZ schrieb Amos Jeffries &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt;:
&gt;<i>On 18/09/18 3:37 AM, Service MV wrote:
</I>&gt;&gt;<i> Dear Ones, I draw on your experience in seeking help to determine
</I>&gt;&gt;<i> whether or not it is possible to achieve the configuration I am
</I>&gt;<i>looking
</I>&gt;&gt;<i> for, due to a strange error I am having.
</I>&gt;<i>
</I>&gt;<i>FYI: SquidGuard has not been maintained for many years now.
</I>&gt;<i>
</I>&gt;<i>I recommend you convert as many of your filtering rules as you can into
</I>&gt;<i>normal Squid ACLs. Traffic which is being blocked for simple reasons
</I>&gt;<i>can
</I>&gt;<i>be done much more efficiently by Squid than a helper.
</I>&gt;<i>
</I>&gt;<i>You can use the more up-to-date ufdbguard helper as a drop-in
</I>&gt;<i>replacement for squidguard during the conversion.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> Before commenting on the bug I describe my testing environment:
</I>&gt;&gt;<i> - A VM CentOS 7 Core over VirtualBox 5.2, 1 NIC.
</I>&gt;&gt;<i> - My VM is attached to my domain W2012R2 (following this post
</I>&gt;&gt;<i>
</I>&gt;<i><A HREF="https://www.rootusers.com/how-to-join-centos-linux-to-an-active-directory-domain/">https://www.rootusers.com/how-to-join-centos-linux-to-an-active-directory-domain/</A>)
</I>&gt;&gt;<i> to achieve kerberos authentication transparent to the user. SElinux
</I>&gt;&gt;<i> disabled. Owner permissions to user squid in all folders/files
</I>&gt;<i>involved.
</I>&gt;&gt;<i> - squid 3.5.20 installed and working great with kerberos, NTLM and
</I>&gt;<i>basic
</I>&gt;&gt;<i> authentication. All authentication mechanisms tested and working
</I>&gt;<i>great.
</I>&gt;&gt;<i> - SquidGuard: 1.4 Berkeley DB 5.3.21 installed and working great with
</I>&gt;&gt;<i> blacklists and acl default.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> My problem starts when I try to use source acl using ldapusersearch
</I>&gt;<i>in
</I>&gt;&gt;<i> squidGuard...&#160;
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> systemctl status squid:
</I>&gt;&gt;<i> (squid-1)[12627]: The redirector helpers are crashing too rapidly,
</I>&gt;<i>need
</I>&gt;&gt;<i> help!
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> *squidGuard.conf*
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> dbhome /etc/squid/db
</I>&gt;&gt;<i> logdir /var/log/squidGuard
</I>&gt;&gt;<i> ldapbinddn
</I>&gt;&gt;<i>
</I>&gt;<i>CN=ldap,OU=SERVICIOS,OU=SISTEMAS,OU=CANAL,OU=MYCOMPANY,DC=mydomain,DC=local
</I>&gt;&gt;<i> ldapbindpass myULTRAsecretPASS
</I>&gt;&gt;<i> ldapprotover 3
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> src WEB_BASIC {
</I>&gt;&gt;<i> ldapusersearch
</I>&gt;&gt;<i>
</I>&gt;<i><A HREF="ldap://dc-1.mydomain.local:3268/dc=mydomain,dc=local?sAMAccountName?sub?(&amp;(sAMAccountName=%s">ldap://dc-1.mydomain.local:3268/dc=mydomain,dc=local?sAMAccountName?sub?(&amp;(sAMAccountName=%s</A>)(memberOf=cn=WEB_BASIC%2cou=INTERNET%2cou=PERMISOS%2cou=MYCOMPANY%2cdc=mydomain%2cdc=local))
</I>&gt;&gt;<i> log block.log
</I>&gt;&gt;<i> }
</I>&gt;&gt;<i> 
</I>&gt;<i>...
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> acl {
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> WEB_BASIC{
</I>&gt;&gt;<i> pass whitelist !BL_porn !blacklist all
</I>&gt;&gt;<i> redirect
</I>&gt;&gt;<i>
</I>&gt;<i><A HREF="http://s-server1.mydomain.local/cgi-bin/squidGuard.cgi?clientaddr=%a&amp;clientname=%n&amp;clientuser=%i&amp;clientgroup=%s&amp;targetgroup=%t&amp;url=%u">http://s-server1.mydomain.local/cgi-bin/squidGuard.cgi?clientaddr=%a&amp;clientname=%n&amp;clientuser=%i&amp;clientgroup=%s&amp;targetgroup=%t&amp;url=%u</A>
</I>&gt;&gt;<i> log block.log
</I>&gt;&gt;<i> }
</I>&gt;&gt;<i> 
</I>&gt;<i>...
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> *squid.conf*
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> acl localnet src 10.10.8.0/22 # LAN net
</I>&gt;&gt;<i> acl dmz src 192.168.20.0/27   # DMZ net
</I>&gt;<i>
</I>&gt;<i>These ACLs are never used dues to what you are doing with the &quot;auth&quot;
</I>&gt;<i>ACL.
</I>&gt;<i>
</I>&gt;<i>...
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> ### acl for proxy authentication (kerberos or ntlm) and ldap
</I>&gt;<i>authorizations
</I>&gt;&gt;<i> acl auth proxy_auth REQUIRED
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> # Define protocols used for redirects
</I>&gt;&gt;<i> acl HTTP proto HTTP
</I>&gt;&gt;<i> acl HTTPS proto HTTPS
</I>&gt;<i>
</I>&gt;<i>These have nothing to do with redirects and are never used.
</I>&gt;<i>
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> ### enforce authentication
</I>&gt;&gt;<i> http_access allow auth&#160;
</I>&gt;&gt;<i> http_access deny !auth
</I>&gt;&gt;<i> 
</I>&gt;<i>
</I>&gt;<i>All possible traffic will match either &quot;auth&quot; or &quot;!auth&quot; above.
</I>&gt;<i>
</I>&gt;<i>That means no http_access rules following this point do anything.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> ### standard access rules
</I>&gt;&gt;<i> http_access deny !Safe_ports&#160;
</I>&gt;&gt;<i> http_access deny CONNECT !SSL_ports&#160;
</I>&gt;&gt;<i> http_access allow localhost manager&#160;
</I>&gt;&gt;<i> http_access deny manager
</I>&gt;<i>
</I>&gt;<i>Your custom http_access rules (eg the auth checks) should be down here
</I>&gt;<i>so the basic security rules above have a chance to protect your proxy
</I>&gt;<i>again DoS, traffic smuggling attacks etc. before more complicated and
</I>&gt;<i>resource consuming things happen.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> http_access allow localnet
</I>&gt;&gt;<i> http_access allow dmz
</I>&gt;&gt;<i> http_access allow localhost&#160;
</I>&gt;&gt;<i> http_access deny all
</I>&gt;&gt;<i> 
</I>&gt;<i>
</I>&gt;<i>...
</I>&gt;&gt;<i> visible_hostname eren 
</I>&gt;<i>
</I>&gt;<i>The hostname needs to be a FQDN. It is delivered to clients in URLs
</I>&gt;<i>generated by Squid so they can fetch objects directly from the proxy.
</I>&gt;<i>
</I>&gt;<i>FYI: Squid-3 should be able to automatically locate the hostname of the
</I>&gt;<i>machine it is running on. If that is not working then you need to fix
</I>&gt;<i>your machine, other software will be using the same mechanism and
</I>&gt;<i>likewise be encountering problems.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> httpd_suppress_version_string on&#160;
</I>&gt;&gt;<i> uri_whitespace strip
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> ## squidGuard ##
</I>&gt;&gt;<i> url_rewrite_program /usr/bin/squidGuard -c /etc/squid/squidGuard.conf
</I>&gt;&gt;<i> url_rewrite_children 10 startup=5 idle=1 concurrency=0
</I>&gt;&gt;<i> url_rewrite_bypass off
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> 
</I>&gt;<i>
</I>&gt;<i>Your traffic in your access.log is all CONNECT requests. Those messages
</I>&gt;<i>cannot be re-written by SquidGuard. So at the very least you require
</I>&gt;<i>this config line:
</I>&gt;<i>
</I>&gt;<i> url_rewrite_access deny CONNECT
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>.. at this point you may notice your SG rules have no effect. This is
</I>&gt;<i>one of many reasons why you should do access control in the proxy
</I>&gt;<i>config, not externally in a complicated and slow helper.
</I>&gt;<i>
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> *messages*
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> Sep 17 11:13:07 proxy kernel: squidGuard[12552]: segfault at
</I>&gt;&gt;<i> ffffffffd7706bb0 ip 00007fdbf2052e70 sp 00007fffd1b73c70 error 5 in
</I>&gt;&gt;<i> libldap-2.4.so.2.10.7[7fdbf2027000+52000]
</I>&gt;&gt;<i> Sep 17 11:13:07 proxy kernel: squidGuard[12553]: segfault at
</I>&gt;&gt;<i> ffffffffa3d27bb0 ip 00007fd79b787e70 sp 00007ffe47e9b880 error 5 in
</I>&gt;&gt;<i> libldap-2.4.so.2.10.7[7fd79b75c000+52000]
</I>&gt;<i>
</I>&gt;<i>...
</I>&gt;<i>
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> If I disable src and acl WEB_BASIC I have no problem. The default acl
</I>&gt;&gt;<i> does its thing without problems.
</I>&gt;&gt;<i> But when I enable src and acl WEB_BASIC squidGuard explodes and squid
</I>&gt;&gt;<i> restarts so I get to notice.
</I>&gt;&gt;<i> I see an error in a libldap library... Will it be a library error? Or
</I>&gt;<i>am
</I>&gt;&gt;<i> I misconfiguring my squid ?
</I>&gt;&gt;<i> 
</I>&gt;<i>
</I>&gt;<i>It is not a Squid error. It is something in SquidGuard and/or the
</I>&gt;<i>library.
</I>&gt;<i>
</I>&gt;<i>Amos
</I>&gt;<i>_______________________________________________
</I>&gt;<i>squid-users mailing list
</I>&gt;<i><A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i><A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20180918/f6692bfb/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20180918/f6692bfb/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="019238.html">[squid-users] Help: squid restarts and squidGuard die
</A></li>
	<LI>Next message (by thread): <A HREF="019249.html">[squid-users] Help: squid restarts and squidGuard die
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19241">[ date ]</a>
              <a href="thread.html#19241">[ thread ]</a>
              <a href="subject.html#19241">[ subject ]</a>
              <a href="author.html#19241">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
