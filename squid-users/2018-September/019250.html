<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] About SSL peek-n-splice/bump configurations
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20About%20SSL%20peek-n-splice/bump%20configurations&In-Reply-To=%3C003601d44f61%24dfd30e80%249f792b80%24%40yahoo.com.ar%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="019240.html">
   <LINK REL="Next"  HREF="019251.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] About SSL peek-n-splice/bump configurations</H1>
    <B>Julian Perconti</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20About%20SSL%20peek-n-splice/bump%20configurations&In-Reply-To=%3C003601d44f61%24dfd30e80%249f792b80%24%40yahoo.com.ar%3E"
       TITLE="[squid-users] About SSL peek-n-splice/bump configurations">vh1988 at yahoo.com.ar
       </A><BR>
    <I>Tue Sep 18 15:11:25 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="019240.html">[squid-users] About SSL peek-n-splice/bump configurations
</A></li>
        <LI>Next message (by thread): <A HREF="019251.html">[squid-users] About SSL peek-n-splice/bump configurations
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19250">[ date ]</a>
              <a href="thread.html#19250">[ thread ]</a>
              <a href="subject.html#19250">[ subject ]</a>
              <a href="author.html#19250">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>&gt;<i> Both loops can finish &quot;early&quot; (i.e. before three steps and/or before all
</I>&gt;<i> configured rules are evaluated).
</I>
Yes, maybe I would have should say at least: &quot;Well in really, depend on the rules..&quot; Especially in the inner loop.
But I pointed to the maximum possibilities. (if exists)

&gt;<i> Just to avoid misunderstanding: Final actions may be taken at any step, but
</I>&gt;<i> only final actions are possible at step3.
</I>
Good point.
My mistake, I forgot that. 
In fact, in the actions table its clear that a final action like terminate can occurs at any step and even worst, any action can occurs at step1.
&gt;<i>From another point of view: at step3 only final actions are allowed.
</I>
&gt;<i> &gt; I think that splice at step1 does not make sense according to the doc.
</I>&gt;<i> &gt; and also to the order of steps or the sequence, about how the rules
</I>&gt;<i> &gt; are evaluated.
</I>&gt;<i> 
</I>&gt;<i> I do not know what you mean. Splice at step1 is certainly possible and even
</I>&gt;<i> recommended for known non-TLS traffic.
</I>
Idem; same comments as above.

&gt;<i> &gt; the thing that really does not makes sense is splice at step1 and then splice
</I>&gt;<i> at step2:
</I>&gt;<i> 
</I>&gt;<i> It is not possible to splice twice. Splicing is one of the final actions. No other
</I>&gt;<i> action follows a final action (by definition). Search for the two &quot;exit&quot; words in
</I>&gt;<i> the loop summary to find where final actions may be applied.
</I>
So, if a rule &quot;x&quot; match a splice action at inner loop when the outer loop starts, then take the final action for the rule &quot;x&quot; and if no there is no more rules at step1 exit and proceed to evaluate the rules for the step2.
Some like that?

&gt;<i> The best thing to do depends on your goals and the transaction. Splicing at
</I>&gt;<i> step1, step2, OR step3 makes sense in some cases and does not make sense
</I>&gt;<i> (or is impossible) in others.
</I>&gt;<i> 
</I>&gt;<i> You need to evaluate your rules in the context of a specific transaction
</I>&gt;<i> though: The same set of ssl_bump rules may splice transaction A at step1 and
</I>&gt;<i> transaction C at step3. The loops summarized above are executed from
</I>&gt;<i> scratch for every transaction that reaches ssl_bump directive evaluation.
</I>
I lost You here.

&gt;<i> It is impossible to make &quot;splice or bump&quot; decision at step3 because splicing at
</I>&gt;<i> step3 requires peeking at step2 while bumping at step3 requires staring at
</I>&gt;<i> step2. In a context of a single transaction, it is impossible to both peek and
</I>&gt;<i> stare at the same time!
</I>&gt;<i> Thus, you essentially have to make that &quot;splice or bump&quot; decision earlier, at
</I>&gt;<i> step1 or step2, when you have less information than you would have at
</I>&gt;<i> step3. It is almost like the dominant quantum physics theory -- by measuring
</I>&gt;<i> at step2, you determine the outcome of that measurement (i.e. available
</I>&gt;<i> actions at step3).
</I>
Wait, maybe I do not explain myself well or I don not understand what do You want to mean; the ACL at every step are not the same. See below.

&gt;<i> &gt;    ssl_bump peek noBumpSites
</I>&gt;<i> &gt;    ssl_bump stare
</I>
It suppsed that here due to acl in the first line, squid will bump later, all except sites that matches the acl.

&gt;<i> &gt; But, what happen if Squid decides automagically wrong? Or something
</I>&gt;<i> does not match...?
</I>&gt;<i> 
</I>&gt;<i> I do not know what you mean by &quot;Squid decides automagically wrong&quot;
</I>
Well, it was just an (probably bad one) idea/thought.

&gt;<i> At step1 and at step2, if noBumpSites matches, then Squid will peek.
</I>Therefore default splice...

&gt;<i> At step1 and at step2, if noBumpSites does not match, then Squid will stare.
</I>...and default bump.

&gt;<i> At step3, no explicit rules can match so Squid will either splice or bump,
</I>&gt;<i> depending on whether noBumpSites matched at step2.
</I>
Yes, just an aclaration: in this specific case &quot;At step3, no explicit rules can match&quot; (not anymore). 
All was already done in the previous steps.

&gt;<i> &gt; Do You think that the above rules is more-or-less the more nearest
</I>&gt;<i> &gt; what I want to do? Excuse me but, I think that at this stage, I gues
</I>&gt;<i> &gt; that You already know what I mean when I say &quot;...what I want to do?&quot;
</I>&gt;<i> 
</I>&gt;<i> Sorry, I do not. And since there are many details that define what one wants
</I>&gt;<i> to (or should) do, it may be impractical to relay all of them on an informal
</I>&gt;<i> email thread. However, if you understand how SslBump rules work, then you
</I>&gt;<i> can either answer a vague &quot;Am I doing what I want to be doing?&quot; question
</I>&gt;<i> yourself or ask more specific questions that can be answered on the mailing
</I>&gt;<i> list.
</I>
Ok I am sorry for that, I understood that You had an idea about what I want to do, in a earlier message.
I will answer with a &quot;little&quot; change in the last config to illustrate what I should/want to do in my scenario.

It was: (Again: With this cfg I dont see any domain in TCP_TUNNEL neither the Security alerts..)

   ssl_bump peek noBumpSites # Here two steps will happen. And final action (splice)  happens at step3 by default.
   ssl_bump stare

And now is: (And with this I see the domain:443 in TCP_TUNNEL and Security alerts about the domain and ip match in the logs.)

  ssl_bump splice noBumpSites # This line reachs a splice rule at step1 and that is a final action, without future proccesing.
  ssl_bump stare

Squid is telling to the client (in last config.) :
&quot;I will not touch any TLS byte. I can not do much about the security risk you may run. Despite what I said, I will do as many checks as possible then You will be connected...&quot;

Maybe splice at step1 I am leaving the client alone. But, what can I do? 
I have to choose: peek at 1 and 2 like before (and errors can happen; that is why I have reopened the thread... the cause was an error message from squid while a client was trying to access a bank site) or just splice (less checks,maybe less errors).

Thank You again.


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="019240.html">[squid-users] About SSL peek-n-splice/bump configurations
</A></li>
	<LI>Next message (by thread): <A HREF="019251.html">[squid-users] About SSL peek-n-splice/bump configurations
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19250">[ date ]</a>
              <a href="thread.html#19250">[ thread ]</a>
              <a href="subject.html#19250">[ subject ]</a>
              <a href="author.html#19250">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
