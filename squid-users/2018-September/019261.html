<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] About SSL peek-n-splice/bump configurations
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20About%20SSL%20peek-n-splice/bump%20configurations&In-Reply-To=%3C934754fd-e048-5b28-35c5-b8e2da1337db%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="019257.html">
   <LINK REL="Next"  HREF="019262.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] About SSL peek-n-splice/bump configurations</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20About%20SSL%20peek-n-splice/bump%20configurations&In-Reply-To=%3C934754fd-e048-5b28-35c5-b8e2da1337db%40measurement-factory.com%3E"
       TITLE="[squid-users] About SSL peek-n-splice/bump configurations">rousskov at measurement-factory.com
       </A><BR>
    <I>Wed Sep 19 21:35:29 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="019257.html">[squid-users] About SSL peek-n-splice/bump configurations
</A></li>
        <LI>Next message (by thread): <A HREF="019262.html">[squid-users] About SSL peek-n-splice/bump configurations
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19261">[ date ]</a>
              <a href="thread.html#19261">[ thread ]</a>
              <a href="subject.html#19261">[ subject ]</a>
              <a href="author.html#19261">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 09/19/2018 10:23 AM, Julian Perconti wrote:
&gt;&gt;<i> Alex: After a splice rule is applied, SslBump is over. No  more rules are 
</I>&gt;&gt;<i> checked. No more loops are iterated. Squid simply &quot;exits&quot; the  SslBump 
</I>&gt;&gt;<i> feature (and becomes a TCP tunnel).
</I>
&gt;<i> What about the meaning of the ACL's at step1 when splice?
</I>
* If the splice rule ACLs match, the splice rule is applied. In that
case you can consult my statement above.

* If the splice rule ACLs do not match, then the splice rule is not
applied. My statement above explicitly does not cover this case -- it
starts with &quot;after a splice rule is APPLIED&quot;.


&gt;<i> e.g.:
</I>&gt;<i> There only these two rules for ssl_bump statements:
</I>&gt;<i> 
</I>&gt;<i> ssl_bump splice sitesAB
</I>&gt;<i> ssl_bump splice SitesCD
</I>
&gt;<i> I guess that here, Squid has to do 2 loops at outer/main loop to
</I>&gt;<i> evaluate step1 twice, due to rules differs (sitesAB and sitesCD ACL)
</I>&gt;<i> and see if both match to splice.
</I>
I do not know why you are guessing instead of carefully applying the
already documented procedure, but you guessed wrong. At any step, the
first matching rule is applied. For example, if sitesAB matches, then
Squid splices without checking the second (i.e. SitesCD) rule.

N.B. I removed the (misplaced) &quot;step1&quot; ACLs from the above example. That
ACL does not affect the above discussion.


&gt;<i> Are You (perhaps) talking about the examples in the thread and not what happens &quot;in general&quot;?
</I>
My statements above are general except the &quot;For example...&quot; sentence
that refers to your specific example.


&gt;<i> In which case the &quot;noBumpSites&quot; ACL could have not match? I mean if I
</I>&gt;<i> tell a Squid: &quot;splice at step1 this.site.net&quot; How that matches can
</I>&gt;<i> fail?
</I>
Roughly speaking, the server_name ACL matches at step1 when the real or
fake CONNECT Host information match one of the configured server names.

For example, if you are intercepting or if the real CONNECT request
contains an IP address (rather than a host name), then the server_name
ACL matches if the reverse DNS lookup for that IP address is successful
and matches at least one of the configured server names. In other cases,
the ACL does not match during step1.

The reality is more complex than the above rough summary because domain
name comparison is a complex algorithm. Consult the latest Squid
documentation for details. Also, please do not forget that step2
matching adds checking TLS client SNI name, and step3 matching adds
checking certificate Subject names. It gets really complex...

For example, the Host header of a CONNECT request may not be the same as
the TLS client-supplied SNI name, and/or the server certificate subject
name may. These differences (and other random factors like DNS
inconsistencies) may result in the server_name ACL match result changes
across the steps.

Modern Squids have additional server_name options that control some of
the matching nuances discussed above.


Alex.

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="019257.html">[squid-users] About SSL peek-n-splice/bump configurations
</A></li>
	<LI>Next message (by thread): <A HREF="019262.html">[squid-users] About SSL peek-n-splice/bump configurations
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19261">[ date ]</a>
              <a href="thread.html#19261">[ thread ]</a>
              <a href="subject.html#19261">[ subject ]</a>
              <a href="author.html#19261">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
