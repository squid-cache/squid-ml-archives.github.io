<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Any suggestions or comments about my configuration? squid 3.5.20
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Any%20suggestions%20or%20comments%20about%20my%0A%20configuration%3F%20squid%203.5.20&In-Reply-To=%3C678580bb-dbfa-96d9-242c-ab5741f4bd28%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="019260.html">
   <LINK REL="Next"  HREF="019278.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Any suggestions or comments about my configuration? squid 3.5.20</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Any%20suggestions%20or%20comments%20about%20my%0A%20configuration%3F%20squid%203.5.20&In-Reply-To=%3C678580bb-dbfa-96d9-242c-ab5741f4bd28%40treenet.co.nz%3E"
       TITLE="[squid-users] Any suggestions or comments about my configuration? squid 3.5.20">squid3 at treenet.co.nz
       </A><BR>
    <I>Thu Sep 20 10:41:23 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="019260.html">[squid-users] Any suggestions or comments about my configuration?	squid 3.5.20
</A></li>
        <LI>Next message (by thread): <A HREF="019278.html">[squid-users] Any suggestions or comments about my configuration? squid 3.5.20
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19263">[ date ]</a>
              <a href="thread.html#19263">[ thread ]</a>
              <a href="subject.html#19263">[ subject ]</a>
              <a href="author.html#19263">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 20/09/18 8:52 AM, Service MV wrote:
&gt;<i> Dear Ones, the more I use Squid the more I realize how powerful it is.
</I>&gt;<i> And like all powerful software it can be complex at first.
</I>&gt;<i> I would like to share my settings and if possible listen (read actually)
</I>&gt;<i> your comments and suggestions.
</I>&gt;<i> My goals of using squid:
</I>&gt;<i> - Transparent authentication of my AD users (2012R2)
</I>&gt;<i> - Internet access rules based on users belonging to AD groups.
</I>&gt;<i> - Non-authenticated clients (Win PCs) cannot navigate through the proxy.
</I>&gt;<i> - That the clients (Win PCs) not belonging to an AD group allowed in
</I>&gt;<i> squid, cannot navigate through the proxy.
</I>&gt;<i> 
</I>&gt;<i> My test scenario:
</I>&gt;<i> - A VM CentOS 7 Core over VirtualBox 5.2, 1 NIC.
</I>&gt;<i> - My VM is attached to my domain W2012R2 (following this
</I>&gt;<i> post&#160;<A HREF="https://www.rootusers.com/how-to-join-centos-linux-to-an-active-directory-domain/">https://www.rootusers.com/how-to-join-centos-linux-to-an-active-directory-domain/</A>)
</I>&gt;<i> to achieve kerberos authentication transparent to the user. SElinux
</I>&gt;<i> disabled. Owner permissions to user squid in all folders/files involved.
</I>&gt;<i> - squid 3.5.20 installed and working great with kerberos, NTLM and basic
</I>&gt;<i> authentication.
</I>&gt;<i> 
</I>&gt;<i> squid.conf
</I>&gt;<i> ### negotiate kerberos &amp; ntlm authentication
</I>
FYI: the technical terms for these are Negotiate/NTLM and
Negotiate/Kerberos.  With the '/' being part of the type name, not the
usual meaning of alternative words.

&gt;<i> auth_param negotiate program /usr/sbin/negotiate_wrapper --ntlm
</I>&gt;<i> /usr/bin/ntlm_auth --helper-protocol=squid-2.5-ntlmssp --kerberos
</I>&gt;<i> /usr/lib64/squid/negotiate_kerberos_auth -r -i -s GSS_C_NO_NAME&#160;
</I>&gt;<i> auth_param negotiate children 10&#160;
</I>&gt;<i> auth_param negotiate keep_alive on
</I>&gt;<i>
</I>...
&gt;<i> 
</I>&gt;<i> ### LDAP group membership sources
</I>&gt;<i> # WEB_ACCESS_1
</I>&gt;<i> external_acl_type AD_WEB_ACCESS_1 %LOGIN
</I>&gt;<i> /usr/lib64/squid/ext_ldap_group_acl -P -R -b OU=USERS,DC=netgol,DC=local
</I>&gt;<i> -D ldap -W &quot;/etc/squid/ldap_pass.txt&quot; -f
</I>&gt;<i> (&amp;(sAMAccountName=%u)(memberOf=cn=WEB_ACCESS_1,OU=INTERNET,OU=PERMISOS,OU=NETGOL,DC=netgol,DC=local))
</I>&gt;<i> -h s-dc1.netgol.local -p 3268
</I>&gt;<i> acl WEB_ACCESS_1 external AD_WEB_ACCESS_1 web-access-1
</I>&gt;<i> 
</I>&gt;<i> # WEB_ACCESS_2
</I>&gt;<i> external_acl_type AD_WEB_ACCESS_2 %LOGIN
</I>&gt;<i> /usr/lib64/squid/ext_ldap_group_acl -P -R -b OU=USERS,DC=netgol,DC=local
</I>&gt;<i> -D ldap -W &quot;/etc/squid/ldap_pass.txt&quot; -f
</I>&gt;<i> (&amp;(sAMAccountName=%u)(memberOf=cn=WEB_ACCESS_2,OU=INTERNET,OU=PERMISOS,OU=NETGOL,DC=netgol,DC=local))
</I>&gt;<i> -h s-dc1.netgol.local -p 3268
</I>&gt;<i> acl WEB_ACCESS_2 external AD_WEB_ACCESS_2 web-access-2
</I>&gt;<i> 
</I>&gt;<i> # WEB_ACCESS_3
</I>&gt;<i> external_acl_type AD_WEB_ACCESS_3 %LOGIN
</I>&gt;<i> /usr/lib64/squid/ext_ldap_group_acl -P -R -b OU=USERS,DC=netgol,DC=local
</I>&gt;<i> -D ldap -W &quot;/etc/squid/ldap_pass.txt&quot; -f
</I>&gt;<i> (&amp;(sAMAccountName=%u)(memberOf=cn=WEB_ACCESS_3,OU=INTERNET,OU=PERMISOS,OU=NETGOL,DC=netgol,DC=local))
</I>&gt;<i> -h s-dc1.netgol.local -p 3268
</I>&gt;<i> acl WEB_ACCESS_3 external AD_WEB_ACCESS_3 web-access-3
</I>
I notice several useful things about these external_acl_type definitions:

 1) that they are identical except for the &quot;memberOf=cn=WEB_ACCESS_&quot;
string in the LDAP query.

 2) that the group name you pass the helper (&quot;web-access-1/2/3&quot;) is
never actually used (no %g in the filter syntax).

That means you can simplify quite a lot just by passing the real group
name to the helper and using %g.

  external_acl_type AD_WEB_ACCESS %LOGIN \
    /usr/lib64/squid/ext_ldap_group_acl -P -R \
   -b OU=USERS,DC=netgol,DC=local \
   -D ldap -W &quot;/etc/squid/ldap_pass.txt&quot; \
  -f
&quot;(&amp;(sAMAccountName=%u)(memberOf=cn=%g,OU=INTERNET,OU=PERMISOS,OU=NETGOL,DC=netgol,DC=local))&quot;
\
  -h s-dc1.netgol.local -p 3268


   acl WEB_ACCESS_1 external AD_WEB_ACCESS WEB_ACCESS_1
   acl WEB_ACCESS_2 external AD_WEB_ACCESS WEB_ACCESS_2
   acl WEB_ACCESS_3 external AD_WEB_ACCESS WEB_ACCESS_3



(I suspect there is something you can do to simplify the AD tree for -b
and -f LDAP parameters. But someone more familiar with LDAP syntax will
have to go over that.)

&gt;<i> 
</I>&gt;<i> ### HTTP access control policies
</I>&gt;<i> http_access deny !Safe_ports&#160;
</I>&gt;<i> http_access deny CONNECT !SSL_ports&#160;
</I>&gt;<i> http_access allow localhost manager&#160;
</I>&gt;<i> http_access deny manager
</I>
Your policy said:
 &quot;Non-authenticated clients (Win PCs) cannot navigate through the proxy.&quot;

So what you need to start with in your custom rules, is one which says
only that not-auth clients are forbidden.

 acl auth proxy_auth REQUIRED
 http_access deny !auth

... now to reach the below tests a client *must* be logged in. You can
safely assume that credentials are available for all tests below.


FYI: Squid will send an auth-challenge denial instead of a regular
forbid error page. If your clients are logged into AD correctly they
will authenticate transparently as you wish. If the client is *not*
logged into the domain they *might* see a popup - that has nothing to do
with Squid and can only be resolved at the browser.
  Note that Squid will have already been doing this for the external
ACLs, but this is a simpler and clearer way to write the config which
also allows you to make the group checks send a hard 403 forbidden
instead of having to always allow clients to re-login.



&gt;<i> http_access deny WEB_ACCESS_1 LS_malicius
</I>&gt;<i> http_access deny WEB_ACCESS_2 LS_malicius
</I>&gt;<i> http_access deny WEB_ACCESS_3 LS_malicius
</I>
Since none of the groups is allowed to LS_malicius you do not actually
have to know what group they are in to block that traffic.

Just use:
 http_access deny LS_malicius

You can further optimize performance by placing that above the login
line. Since login is a waste of cycles if you are only going to reject.

The only reason you might want to deny here is to log which user was
trying to go there (infected?). So you need to decide if that log detail
is worth the slower performance and heavier load on AD. The performance
benefit varies by network and may be extremely small (or not) - so you
may want to experiment and measure.


&gt;<i> http_access deny WEB_ACCESS_1 LS_remotecontrol
</I>&gt;<i> http_access deny WEB_ACCESS_2 LS_remotecontrol
</I>
Similar, but slightly different here for LS_remotecontrol.

In this case note that group #3 is about to be allowed to do anythign,
including this traffic. So you can allow them now:

 http_access allow WEB_ACCESS_3

... then do the denial for the remaining groups without needing to check
which group is which.

   http_access deny LS_remotecontrol

... then the regular group #1 and #2 allow.

&gt;<i> http_access allow WEB_ACCESS_1
</I>&gt;<i> http_access allow WEB_ACCESS_2
</I>
&gt;<i> http_access allow localhost
</I>
Your policy statements do not mention anything about localhost traffic
being allowed to use the proxy. Is this something you can remove?


&gt;<i> http_access deny all
</I>&gt;<i> 
</I>
So to summarize, you http_access should look like this (modulo your
localhost decision):


  ### HTTP access control policies
  http_access deny !Safe_ports
  http_access deny CONNECT !SSL_ports
  http_access allow localhost manager
  http_access deny manager
  http_access deny !auth
  http_access allow localhost
  http_access deny LS_malicius
  http_access allow WEB_ACCESS_3
  http_access deny LS_remotecontrol
  http_access allow WEB_ACCESS_1
  http_access allow WEB_ACCESS_2
  http_access deny all



&gt;<i> ### personalization ###
</I>&gt;<i> http_port 8080&#160;
</I>&gt;<i> coredump_dir /var/spool/squid&#160;
</I>&gt;<i> refresh_pattern ^ftp: 1440 20% 10080&#160;
</I>&gt;<i> refresh_pattern ^gopher: 1440 0% 1440&#160;
</I>&gt;<i> refresh_pattern -i (/cgi-bin/|\?) 0 0% 0&#160;
</I>&gt;<i> refresh_pattern .&#160; 0 20% 4320&#160;
</I>&gt;<i> quick_abort_min 0 KB&#160;
</I>&gt;<i> quick_abort_max 0 KB&#160;
</I>&gt;<i> read_timeout 5 minutes&#160;
</I>&gt;<i> request_timeout 3 minutes&#160;
</I>&gt;<i> half_closed_clients off&#160;
</I>&gt;<i> shutdown_lifetime 15 seconds&#160;
</I>&gt;<i> log_icp_queries off&#160;
</I>&gt;<i> dns_v4_first on&#160;
</I>&gt;<i> ipcache_size 2048&#160;
</I>&gt;<i> ipcache_low 90&#160;
</I>&gt;<i> fqdncache_size 4096&#160;
</I>&gt;<i> forwarded_for off&#160;
</I>&gt;<i> cache_mgr <A HREF="https://lists.squid-cache.org/listinfo/squid-users">system at netgol.net</A>
</I>&gt;<i> visible_hostname proxy.netgol.local&#160;
</I>&gt;<i> httpd_suppress_version_string on&#160;
</I>&gt;<i> uri_whitespace strip
</I>&gt;<i> logfile_rotate 7
</I>&gt;<i> debug_options rotate=7
</I>&gt;<i> 
</I>
In the above, you might want to add config comments for yourself
mentioning why each of the above is different from the defaults.

If they are just copy-paste from a tutorial without understanding why,
then maybe the defaults are fine for your needs.

Some of what you have above *are* the modern defaults which do not need
configuring (eg half_closed_clients, uri_whitespace, ipcache_low, maybe
coredump_dir).

Some are irrelevant. eg log_icp_queries is pointless when ICP is
disabled by default, &quot;debug_options rotate=N&quot; defaults to the
logfile_rotate value.

Some are intended to resolve quite specific issues which are not
relevant on most networks (eg dns_v4_first, forwarded_for,
visible_hostname, half_closed_clients) and you may actually need
different settings than people commonly paste blindly into web
tutorials. Read the docs for those options particularly the descriptions
of use-cases, caveats, and any WARNINGS / NOTICE text.


And last but not least - always run &quot;squid -k parse&quot; after changing
config or upgrading the proxy.  Squid can detect a large number of
config problems and tells you about them, usually with instructions on
how to resolve it.


HTH
Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="019260.html">[squid-users] Any suggestions or comments about my configuration?	squid 3.5.20
</A></li>
	<LI>Next message (by thread): <A HREF="019278.html">[squid-users] Any suggestions or comments about my configuration? squid 3.5.20
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19263">[ date ]</a>
              <a href="thread.html#19263">[ thread ]</a>
              <a href="subject.html#19263">[ subject ]</a>
              <a href="author.html#19263">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
