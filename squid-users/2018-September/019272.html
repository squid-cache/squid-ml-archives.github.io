<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Help: squid restarts and squidGuard die
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Help%3A%20squid%20restarts%20and%20squidGuard%20die&In-Reply-To=%3C22f8fd29-c1c0-f764-2343-2e95600b7cdd%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="019268.html">
   <LINK REL="Next"  HREF="019276.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Help: squid restarts and squidGuard die</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Help%3A%20squid%20restarts%20and%20squidGuard%20die&In-Reply-To=%3C22f8fd29-c1c0-f764-2343-2e95600b7cdd%40treenet.co.nz%3E"
       TITLE="[squid-users] Help: squid restarts and squidGuard die">squid3 at treenet.co.nz
       </A><BR>
    <I>Thu Sep 20 20:41:48 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="019268.html">[squid-users] Help: squid restarts and squidGuard die
</A></li>
        <LI>Next message (by thread): <A HREF="019276.html">[squid-users] Help: squid restarts and squidGuard die
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19272">[ date ]</a>
              <a href="thread.html#19272">[ thread ]</a>
              <a href="subject.html#19272">[ subject ]</a>
              <a href="author.html#19272">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 21/09/18 3:46 AM, Marcus Kool wrote:
&gt;<i> 
</I>&gt;<i> On 20/09/18 08:46, Amos Jeffries wrote:
</I>&gt;&gt;<i> On 19/09/18 11:49 PM, Marcus Kool wrote:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> On 18/09/18 23:03, Amos Jeffries wrote:
</I>&gt;&gt;&gt;&gt;<i> On 19/09/18 1:54 AM, neok wrote:
</I>&gt;&gt;&gt;&gt;&gt;<i> Thank you very much Amos for putting me in the right direction.
</I>&gt;&gt;&gt;&gt;&gt;<i> I successfully carried out the modifications you indicated to me.
</I>&gt;&gt;&gt;&gt;&gt;<i> Regarding ufdbGuard, if I understood correctly, what you recommend is
</I>&gt;&gt;&gt;&gt;&gt;<i> to use
</I>&gt;&gt;&gt;&gt;&gt;<i> the ufdbConvertDB tool to convert my blacklists in plain text to the
</I>&gt;&gt;&gt;&gt;&gt;<i> ufdbGuard database format? And then use that/those databases in
</I>&gt;&gt;&gt;&gt;&gt;<i> normal squid
</I>&gt;&gt;&gt;&gt;&gt;<i> ACL's?
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> No, ufdbguard is a fork of SquidGuard that can be used as a drop-in
</I>&gt;&gt;&gt;&gt;<i> replacement which works better while you improve your config.
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> You should work towards less complexity. Squid / squid.conf is where
</I>&gt;&gt;&gt;&gt;<i> HTTP access control takes place. The helper is about re-writing the URL
</I>&gt;&gt;&gt;&gt;<i> (only) - which is a complex and destructive process.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> ufdbGuard is a simple tool that has the same syntax in its configuration
</I>&gt;&gt;&gt;<i> file as squidGuard has.
</I>&gt;&gt;&gt;<i> It is far from complex, has a great Reference Manual, exmaple config
</I>&gt;&gt;&gt;<i> file and a responsive support desk.
</I>&gt;&gt;&gt;<i> Amos, I have never seen you calling a URL writer being a complex and
</I>&gt;&gt;&gt;<i> destructive process.&#160; What do you mean?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Re-writing requires Squid to:
</I>&gt;&gt;<i> &#160; * fork external helpers, and
</I>&gt;&gt;<i> &#160; * maintain queues of lookups to those helpers, and
</I>&gt;&gt;<i> &#160; * maintain cache of helper responses, and
</I>&gt;&gt;<i> &#160; * maintain a whole extra copy of HTTP-request state, and
</I>&gt;&gt;<i> &#160; * copy some (not all) of that state info between the two &quot;client&quot;
</I>&gt;&gt;<i> requests.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &#160; ... lots of complexity, memory, CPU time, traffic latency, etc.
</I>&gt;<i> 
</I>&gt;<i> Squid itself is complex and for any feature of Squid one can make a list
</I>&gt;<i> like above to say that it is complex.
</I>&gt;<i> The fact that one can make such a list does not mean much to me.
</I>&gt;<i> One can make the same or a similar list for external acl helpers and
</I>&gt;<i> even native acls.
</I>&gt;<i> 
</I>&gt;&gt;<i> Also when used for access control (re-write to an &quot;error&quot; URL) the
</I>&gt;&gt;<i> re-write helper needs extra complexity in itself to act as the altered
</I>&gt;&gt;<i> origin server for error pages, or have some fourth-party web server.
</I>&gt;<i> 
</I>&gt;<i> Squid cannot do everything that a URL writer, and specifically
</I>&gt;<i> ufdbGuard, can.
</I>&gt;<i> For example, Squid must restart and break all open connections when a
</I>&gt;<i> tiny detail of the configuration changes.&#160; With ufdbGuard this does not
</I>&gt;<i> happen.
</I>

Squid does not close or break any client connections when reconfigured.
Squid pauses active transactions, reconfigures then continues with the
new config.

Are you perhapse mistaking the fact that Squid shuts down the
*rewriters* on reconfigure for a full Squid shutdown?

(hmm, there is another downside to placing all the access control in a
helper - waiting for the helpers to restart on config changes. Though as
you say ufdbguard does it efficiently, others do not).



&gt;<i> ufdbGuard supports dynamic lists of users, domains and source ip
</I>&gt;<i> addresses which are updated every X minutes without any service
</I>&gt;<i> interruption.
</I>
So does Squid, via external ACL and/or authentication.


&gt;<i> When other parameters change, ufdbGuard resets itself with zero service
</I>&gt;<i> interruption for Squid and its users.
</I>
This is not always true. If the helper pauses even for some milliseconds
it is holding up Squid and clients. Particularly if it is a bottleneck
process like URL-rewrite interface where the helper lookup queue limits
total traffic capacity of the entire proxy.

I think you mean that the helper has threading to do a load in the
background and swap in the config. Correct?

Squid is working (very slowly) towards that model and the SMP features
already reconfigure one worker at a time sequentially so effectively
there should always be a helper with either old or new config answering
incoming traffic while one &quot;resets itself&quot;.


&gt;<i> ufdbGuard can decide to probe a site to make a decision, and hence
</I>&gt;<i> detect Skype, Teamviewer and other types of sites that an admin might
</I>&gt;<i> want to block.&#160; Squid cannot.
</I>
Squid can, via external ACL. IIRC, Eliezer wrote an ICAP system that did
that too.

Also, the URL-rewrite helper cannot do anything if Squid cannot pass it
a URL. By nature of what the interface is designed to do.


&gt;<i> ufdbGuard can decide to do a lookup of a reverse IP lookup to make a
</I>&gt;<i> decision.&#160; Squid cannot.
</I>
Squid can via external ACL.

We have not had much (any?) requests for an ACL doing that. Patches welcome.


&gt;<i> ufdbGuard supports complex time restrictions for access. Squid support
</I>&gt;<i> simple time restrictions.
</I>
Such as?

Squid supports complex time points and/or ranges. The time ACL is a
bitmap extending at 1 second intervals across an entire week. Further
extension is done with external ACL, note ACL and/or allof ACL.


&gt;<i> ufdbGuard supports flat file domain/url lists and a commercial URL
</I>&gt;<i> database.&#160; Squid does not.
</I>&gt;<i> And the list goes on.
</I>
I am still looking for a feature Squid does not actually support in one
way or another.

As you can see from Flashdown posts &quot;external ACL&quot; can mean SquidGuard /
ufdbguard running on that other interface. So really *anything* they can
do so can Squid external ACL - if not one of the other mechanisms.
At no point is the URL-rewrite API _necessary_ for access control in a
modern Squid.


&gt;<i> 
</I>&gt;<i> So when you state on the mailing list that users should unconditionally
</I>&gt;<i> stop using a URL writer in favor of using Squid acls, you may be causing
</I>&gt;<i> troubles for admins who do not know the implications of your advice.
</I>

Understood. I shall try harder to remember the disclaimers usually
added. Thank you for pointing out the omission.


&gt;<i> 
</I>&gt;&gt;&gt;<i> URL rewriters have been used for decades for HTTP access control but you
</I>&gt;&gt;&gt;<i> state &quot;squid.conf is where HTTP access control takes place&quot;.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Once upon a time, back at the dawn of the WWW (before the 1990s) Squid
</I>&gt;&gt;<i> lacked external_acl_type and modular ACLs.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> That persisted for the first decade or so of Squid's life, with only the
</I>&gt;&gt;<i> re-write API for admin to use for complicated permissions.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Then one day about 2 decades or so ago, external ACL was added and the
</I>&gt;&gt;<i> ACLs were also made much easier to implement and plug in new checks.
</I>&gt;&gt;<i> Today we have hundreds of native ACLs and even a selection of custom ACL
</I>&gt;&gt;<i> helpers. Making the need for these abuses of the poor re-writers.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Old habits and online tutorials however are hard to get rid of.
</I>&gt;<i> 
</I>&gt;<i> If you want to get rid of habits that in your view are old/obsolete,
</I>&gt;<i> then why not start a discussion?
</I>
I have. This appears to be the latest one.


&gt;<i> And in the event that at the end of the discussion, the decision is made
</I>&gt;<i> that a particular interface should be removed, why not phase it out ?
</I>
It still has uses as a URL-rewrite/redirect interface for actions not
related directly to access control.

&gt;<i> 
</I>&gt;&gt;&gt;<i> Are you saying that you want it is the _only_ place for HTTP access
</I>&gt;&gt;&gt;<i> control?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I'm saying the purpose of the url_rewrite_* API in Squid is to tell
</I>&gt;&gt;<i> Squid whether the URL (only) needs some mangling in order for the
</I>&gt;&gt;<i> server/origin to understand it.
</I>&gt;&gt;<i> &#160; It can re-write transparently with all the problems that causes to
</I>&gt;&gt;<i> security scopes and URL sync between the endpoints. Or redirect the
</I>&gt;&gt;<i> client to the &quot;correct&quot; URL.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The Squid http_access and similar *access controls* are the place for
</I>&gt;&gt;<i> access control - hint is in the naming. With external ACL type for
</I>&gt;&gt;<i> anything Squid does not support natively or well. As Flashdown mentioned
</I>&gt;&gt;<i> even calls to SquidGuard etc. can be wrapped and used as external ACLs.
</I>&gt;<i> 
</I>&gt;<i> Wrapping and externals ACLs adds the same complexity, memory, CPU time,
</I>&gt;<i> traffic latency, etc that you use as an argument against a URL writer.
</I>&gt;<i> Is it only because of the name, 'external acl helper' vs 'url rewriter
</I>&gt;<i> helper', that you dislike the url rewriter?
</I>

The external ACL usage is better because it is run at times when Squid
is making decisions about access to the proxy and/or features supplied
by the proxy. The admin can decide exactly when in Squid processing it
is tested - limiting the delays and reducing the lookups to only when
necessary.
 eg. you cannot decide whether a transaction is allowed to be sent to
ICAP or not with a re-writer. Or decide whether ssl_bump is going to
splice vs bump with a URL re-writer.


URL-rewrite API requires access control to *prevent* it being used, and
runs *after* access control - so Squid has to actively allow the traffic
through its own access controls first in order to use the URL-rewrite
API. This leads to a lot of the &quot;http_access allow all&quot; type config issues.


Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="019268.html">[squid-users] Help: squid restarts and squidGuard die
</A></li>
	<LI>Next message (by thread): <A HREF="019276.html">[squid-users] Help: squid restarts and squidGuard die
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19272">[ date ]</a>
              <a href="thread.html#19272">[ thread ]</a>
              <a href="subject.html#19272">[ subject ]</a>
              <a href="author.html#19272">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
