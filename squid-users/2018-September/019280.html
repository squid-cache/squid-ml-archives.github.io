<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] About SSL peek-n-splice/bump configurations
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20About%20SSL%20peek-n-splice/bump%20configurations&In-Reply-To=%3C002e01d451bc%24ec104de0%24c430e9a0%24%40yahoo.com.ar%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="019262.html">
   <LINK REL="Next"  HREF="019281.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] About SSL peek-n-splice/bump configurations</H1>
    <B>Julian Perconti</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20About%20SSL%20peek-n-splice/bump%20configurations&In-Reply-To=%3C002e01d451bc%24ec104de0%24c430e9a0%24%40yahoo.com.ar%3E"
       TITLE="[squid-users] About SSL peek-n-splice/bump configurations">vh1988 at yahoo.com.ar
       </A><BR>
    <I>Fri Sep 21 15:08:11 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="019262.html">[squid-users] About SSL peek-n-splice/bump configurations
</A></li>
        <LI>Next message (by thread): <A HREF="019281.html">[squid-users] About SSL peek-n-splice/bump configurations
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19280">[ date ]</a>
              <a href="thread.html#19280">[ thread ]</a>
              <a href="subject.html#19280">[ subject ]</a>
              <a href="author.html#19280">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi all.

I will go (finally) with this sslBump config. Although I still have some doubts...
I think that It&#180;s time to finish this thread.

#  TLS CFG
acl noBumpSites ssl::server_name_regex -i &quot;/etc/squid/url.nobump&quot;

# steps ACL
acl step1 at_step SslBump1
acl step2 at_step SslBump2
acl step3 at_step SslBump3

#  SslBump actions
ssl_bump peek step1
ssl_bump splice noBumpSites
ssl_bump stare step2

The TLS config &quot;explained&quot; as  well as I can understand:
*Clarification*: maybe I will quote some words out of context; but Alex told me that he almost always speaks &quot;In general terms&quot; about what Squid does.

# First rule:
ssl_bump peek step1 #  Step 1 is the only step that is always performed.

If I no peek at step1, and instead directly splice, happens what the wiki warns (this was checked):

&quot; Bump All Sites Except Banks
&quot; Usually does not work for requests that go to non-banks -- they will not be bumped.&quot; (Verified)
&quot; Depending on other settings, Squid may terminate connections to banks if Squid cannot validate client SNI (Host header forgery detection) or the server certificate.&quot;
The wiki example about this warn the config is:
  ssl_bump splice serverIsBank
  ssl_bump peek all
  ssl_bump bump all

So my conclusion is: &quot;It's &quot;better&quot; (to avoid: ...not work for requests that go to non-banks) to peek step1&quot;

# Second rule:
ssl_bump splice noBumpSites 

Here a doubt, I'm sorry.
Based on above words and the squid behaviour I mentioned, I think that this rule should implicity match only at step2.

Alex words: 

&gt;<i>&quot;So, &quot;yes&quot;, Squid only executes the first rule action _when_ the first
</I>&gt;<i>rule action is applicable and its ACLs match at every step, but, &quot;no&quot;,
</I>&gt;<i>Squid does not make a bunch of steps with only the first rule in mind.&quot;
</I>
With the overall logic in mind, the first impression is that the second rule could match at step1 and at step2 too. Like this rule would the first one (but is the second).
However as I said above if the splice is the first rule instead the peek, the squid&#180;s behaviour changes.

&gt;<i>After a splice rule is applied, SslBump is over. No  more rules are 
</I>&gt;<i>checked. No more loops are iterated. Squid simply &quot;exits&quot; the  SslBump 
</I>&gt;<i>feature (and becomes a TCP tunnel).
</I>
Here, probably (not sure) Alex rerefered here to &quot;splice all&quot; rule. In that case is clear &quot;splice is a final action&quot; then no more future checks.
&quot;Actions splice, bump, and terminate are final actions: They prevent further processing of the ssl_bump rules.&quot;

But in my config next to splice there is an ACL. That is why I asked: &quot;But, doesn't the ACL matters?&quot; in earlier mail.

Therefore, due to above Alex&#180;s statement:  Will Squid ignore the last rule?
I checked that the answer is no. If I remove the last rule (stare step2) all the traffic is spliced.
I think that the reason is: (explicit) peek step1 &gt;  (implicit) peek step2 &gt; result: default splice all. (peek at step2 precludes future bumping)
Even more, if I remove the last rule, the second rule I think that will be ingnored. In reallity will had not make sense.

# Third/last rule:
ssl_bump stare step2 # stare at step2 so implicit and &quot;secure&quot; default bump action at step3.

Probably I said something (or all) that is WRONG.

Thank You.


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="019262.html">[squid-users] About SSL peek-n-splice/bump configurations
</A></li>
	<LI>Next message (by thread): <A HREF="019281.html">[squid-users] About SSL peek-n-splice/bump configurations
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19280">[ date ]</a>
              <a href="thread.html#19280">[ thread ]</a>
              <a href="subject.html#19280">[ subject ]</a>
              <a href="author.html#19280">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
