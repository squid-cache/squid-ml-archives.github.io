<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] About SSL peek-n-splice/bump configurations
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20About%20SSL%20peek-n-splice/bump%20configurations&In-Reply-To=%3C003b01d45292%24fd11c4d0%24f7354e70%24%40yahoo.com.ar%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="019287.html">
   <LINK REL="Next"  HREF="019301.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] About SSL peek-n-splice/bump configurations</H1>
    <B>Julian Perconti</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20About%20SSL%20peek-n-splice/bump%20configurations&In-Reply-To=%3C003b01d45292%24fd11c4d0%24f7354e70%24%40yahoo.com.ar%3E"
       TITLE="[squid-users] About SSL peek-n-splice/bump configurations">vh1988 at yahoo.com.ar
       </A><BR>
    <I>Sat Sep 22 16:40:33 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="019287.html">[squid-users] About SSL peek-n-splice/bump configurations
</A></li>
        <LI>Next message (by thread): <A HREF="019301.html">[squid-users] About SSL peek-n-splice/bump configurations
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19289">[ date ]</a>
              <a href="thread.html#19289">[ thread ]</a>
              <a href="subject.html#19289">[ subject ]</a>
              <a href="author.html#19289">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>&gt;<i> &gt; # Second rule:
</I>&gt;<i> &gt; ssl_bump splice noBumpSites
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I think that this rule should implicity match only at step2.
</I>&gt;<i> 
</I>&gt;<i> I do not know what &quot;implicitly match&quot; means here, but yes, the splice rule
</I>&gt;<i> may only match at step2 in this configuration:
</I>
When I say &quot;implicit&quot; I want to mean that there is no any step specified in the rule.

&gt;<i> * It cannot match at step1 because the earlier &quot;peek&quot; rule matches at step1.
</I>
Yes, rule #1 &quot;matches all&quot; therefore the domains into &quot;noBumpSites&quot; ACL are also peeked. And, that first rule will always match.
 
&gt;<i> * It is always reached during step2 because no rules above it can match
</I>&gt;<i> during step2.
</I>
Yes, first rule has an explicit peek at step1, hence it is impossible any kind of match at step2 before the 2nd rule or in the first rule.

&gt;<i>Whether it matches during step2 depends on whether
</I>&gt;<i> noBumpSites matches a particular transaction during step2.
</I>
If I understood You correctly, I think that here you are pointing to an earlier message where You explained some reasons why the &quot;noBumpSites&quot; could not always match.

&gt;<i> * It cannot match at step3 because for a splice rule to match at step3 a peek
</I>&gt;<i> rule has to match at step2, and there is no peek rule that can match at step2
</I>&gt;<i> in your configuration.
</I>
Althought there is no any peek rule at step2, in the second rule a final action is applied to noBumpSites (if match)
In fact, in case that (for any reason) the 2nd rule can not match, there is a explicit stare rule at step2.
So, I think that its almost impossible that splice at step3 happens in this configuration for the noBumpSites.
In the worst of the cases, if at rule #2 no match, then noBumpSites will be bumped, due to stare at step2.

Is this reasoning correct?

&gt;<i> &gt; However as I said above if the splice is the first rule instead the
</I>&gt;<i> &gt; peek, the squid&#180;s behaviour changes.
</I>&gt;<i> 
</I>&gt;<i> Naturally. If you place the splice rule first, it may match during step1 as well.
</I>&gt;<i> If you do not, it cannot.
</I>
That was a comment to confirm that the wiki doc warn and said at 2017's is what is  happening now with Squid 4.2 (18/9 source).

&gt;<i> &gt;&gt; After a splice rule is applied, SslBump is over. No  more rules are
</I>&gt;<i> &gt;&gt; checked. No more loops are iterated. Squid simply &quot;exits&quot; the
</I>&gt;<i> &gt;&gt; SslBump feature (and becomes a TCP tunnel).
</I>&gt;<i> 
</I>&gt;<i> &gt; Here, probably (not sure) Alex rerefered here to &quot;splice all&quot; rule.
</I>&gt;<i> 
</I>&gt;<i> I think you are ignoring or misinterpreting the verb &quot;applied&quot;. Here, &quot;applied&quot;
</I>&gt;<i> means Squid has executed the rule action. Not just considered the rule
</I>&gt;<i> containing that action, but actually ran that action. Applying a rule action
</I>&gt;<i> implies that the rule ACLs (whatever they were) matched, of course. A rule
</I>&gt;<i> action is never applied when the rule ACLs do not match.
</I>
Yes, I misinterpreted You more than one time; I'm sorry. (Because You are speaking in english, and I am reading/speaking in an &quot;almost-english&quot; as well as I can)
So, In the final action the ACL is important. This is what I tried to mean.
I insist, because when You said that, I thought (without understanding the logic): &quot;OK, therefore if I splice at step2 some.site.net, the following lines are over; no more processing no matter whatever any ACL the rule has&quot;

&gt;<i> &gt; In that case is clear &quot;splice is a final action&quot; then no more future checks.
</I>&gt;<i> 
</I>&gt;<i> The notion of a &quot;final&quot; action does not depend on rule ACLs.
</I>
Here is where I your explanation breaks my head. Here is the most important confusion of all of my own other confusions/misunderstanding.

In the config I posted, there is a splice action in the middle, and only the &quot;noBumpSites&quot; are spliced (at least checked with logs).
And even with the splice action as second rule, the 3rd rule is processed (Squid is still processing rules after splice noBumpSites ACL).
It is checked because if I remove the last rule all the traffic is spliced (due to peek at step1 and splice at step2) and future defaults actions.
I think that this happens because, if there is no 3rd line stare'ing at step2, so:
  
   ssl_bump splice noBumpSites = ssl_bump splice noBumpSites all. (not sure, I will do a test with only one rule, to see what Squid does: ssl_bump peek step1)

If this were the last rule, but in this configuration there is a 3rd rule which is stare'ing at step2)

&gt;<i> After Squid applies the &quot;splice&quot; action (in whatever context, for whatever reason),
</I>&gt;<i> SslBump processing for that transaction is over. Same for &quot;bump&quot; and
</I>&gt;<i> &quot;terminate&quot; actions.
</I>
What do You exactly mean with &quot;for that transaction&quot;? Maybe that rule?
 
&gt;<i> &gt; But in my config next to splice there is an ACL. That is why I asked: &quot;But,
</I>&gt;<i> doesn't the ACL matters?&quot; in earlier mail.
</I>&gt;<i> 
</I>&gt;<i> ACLs (and other things) determine which rules match. After a rule matches,
</I>&gt;<i> then Squid applies its action, and then the notion of a &quot;final action&quot; starts to
</I>&gt;<i> matter.
</I>
Thats statement clarify the thing a bit more.

&gt;<i> &gt; Will Squid ignore the last rule?
</I>&gt;<i> 
</I>&gt;<i> No. The last rule will be applied at step2 whenever noBumpSites mismatches
</I>&gt;<i> at step2.
</I>
Yes, I said and verified that, the last rule is not ignored by Squid, even with the splice rule at previuos rule.

&gt;<i> HTH,
</I>&gt;<i> 
</I>&gt;<i> Alex.
</I>
Thank You very much.


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="019287.html">[squid-users] About SSL peek-n-splice/bump configurations
</A></li>
	<LI>Next message (by thread): <A HREF="019301.html">[squid-users] About SSL peek-n-splice/bump configurations
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19289">[ date ]</a>
              <a href="thread.html#19289">[ thread ]</a>
              <a href="subject.html#19289">[ subject ]</a>
              <a href="author.html#19289">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
