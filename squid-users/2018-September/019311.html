<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Why does this proxy configuration ignore no-cache and no-store?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Why%20does%20this%20proxy%20configuration%20ignore%20no-cache%0A%20and%20no-store%3F&In-Reply-To=%3C6a8bc753-5abf-6cf2-134b-11858b664dc4%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="019310.html">
   <LINK REL="Next"  HREF="019312.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Why does this proxy configuration ignore no-cache and no-store?</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Why%20does%20this%20proxy%20configuration%20ignore%20no-cache%0A%20and%20no-store%3F&In-Reply-To=%3C6a8bc753-5abf-6cf2-134b-11858b664dc4%40treenet.co.nz%3E"
       TITLE="[squid-users] Why does this proxy configuration ignore no-cache and no-store?">squid3 at treenet.co.nz
       </A><BR>
    <I>Fri Sep 28 07:56:07 UTC 2018</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="019310.html">[squid-users] Why does this proxy configuration ignore no-cache and	no-store?
</A></li>
        <LI>Next message (by thread): <A HREF="019312.html">[squid-users] Why does this proxy configuration ignore no-cache and no-store?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19311">[ date ]</a>
              <a href="thread.html#19311">[ thread ]</a>
              <a href="subject.html#19311">[ subject ]</a>
              <a href="author.html#19311">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 28/09/18 11:04 AM, Brett wrote:
&gt;<i> I'm having some trouble because my 4.0.24-VCS squid proxy is caching requests
</I>&gt;<i> that it shouldn't be, breaking the website I'm routing through it.
</I>
NP: please upgrade your proxy that is a beta release. Squid-4 now has
several stable releases.


&gt;<i> 
</I>&gt;<i> From the HAR output of the client using the proxy:
</I>&gt;<i> 
</I>&gt;<i> Response Headers
</I>&gt;<i> Cache-Control	
</I>&gt;<i>      no-cache;no-store
</I>
Is the ';' above part of the HAR format or part of the actual headers
received?

...
&gt;<i> Vary	
</I>&gt;<i>     Accept-Encoding
</I>&gt;<i> Age	
</I>&gt;<i>     24
</I>&gt;<i> Warning	
</I>&gt;<i>     110 squid/4.0.24-VCS &quot;Response is stale&quot;
</I>&gt;<i> X-Cache	
</I>&gt;<i>     HIT from proxy
</I>&gt;<i> Via	
</I>&gt;<i>     1.1 proxy (squid/4.0.24-VCS)
</I>...

&gt;<i> 
</I>&gt;<i> Note the no-cache;no-store Cache Control headers and then the proxy
</I>&gt;<i> returning the result from the cache, and it's awareness of not following
</I>&gt;<i> HTTP rules, i.e. &quot;Response is stale&quot;
</I>
If your response contains &quot;Cache-Control: no-cache;no-store&quot; then that
actually means just &quot;Cache-Control: no-cache&quot; which tells Squid it *can*
cache the response.

If the response contains &quot;Cache-Control: no-cache, no-store&quot; then that
actually means just &quot;Cache-Control: no-store&quot;. More on that below.


&gt;<i> 
</I>&gt;<i> This would indicate that my configuration is telling the proxy to ignore
</I>&gt;<i> these rules. I do have some rules setup for images etc that do override
</I>&gt;<i> cache control, but not for html, text etc, which this request was for.
</I>
One thing to be aware of &quot;html, text etc&quot; has no meaning to Squid. It is
working strictly from whether the given regex pattern matches against
the full URL string. Including the query-string part.

That means URLs like &quot;<A HREF="http://example.com/some.html?got=.iso">http://example.com/some.html?got=.iso</A>&quot; will match
your pattern.


&gt;<i> Following is my configuration:
</I>&gt;<i> 
</I>...
&gt;<i> offline_mode on
</I>...
&gt;<i> refresh_pattern ^ftp: 1440 20% 10080
</I>&gt;<i> refresh_pattern ^gopher: 1440 0% 1440
</I>&gt;<i> refresh_pattern -i \.(gif|png|jpg|jpeg|ico|woff|woff2)$ 10080 90% 43200
</I>&gt;<i> override-expire ignore-no-cache ignore-no-store ignore-private
</I>&gt;<i> refresh_pattern -i \.(iso|avi|wav|mp3|mp4|mpeg|swf|flv|x-flv)$ 43200 90%
</I>&gt;<i> 432000 override-expire ignore-no-cache ignore-no-store ignore-private
</I>&gt;<i> refresh_pattern -i \.(css|js)$ 1440 40% 40320
</I>&gt;<i> 
</I>
NP: ignore-no-cache is no longer supported since version ~3.2. In
HTTP/1.1 compliant proxies like Squid it actually *prevents* caching
which is counter to most intended uses and better done with
cache/store_miss/send_hit directives allow/deny rules instead.


You are also missing the default refresh_pattern line carefully crafted
to make broken CGI scripts and dynamic content behave according to
RFC2616 caching requirements. Without it such broken content will be
cached for very, very long times.

Please restore this line to the end of your refresh_pattern lines:

  refresh_pattern -i (/cgi-bin/\?) 0 0% 0


&gt;<i> I've also tried deleting all of the refresh_pattern statements and I still
</I>&gt;<i> get the same outcome. What am I doing wrong?
</I>&gt;<i> 
</I>
Three things that I can see:

1) ignore-no-store tells Squid to ignore Cache-Control:no-store headers.

Since no-store overrides no-cache in HTTP semantics which means
&quot;Cache-Control: no-cache, no-store&quot; is just &quot;Cache-Control: no-store&quot;
... you have told Squid to ignore that header entirely.

Removing that option was the right thing to do. But not sufficient by
itself (or removing the whole line ) to immediately change Squid
behaviour because of the below...


2) offline_mode on tells squid not to revalidate anything.

This directive is badly named and does not do what most people think it
does. It is global in effect. Please see the documentation:
 &lt;<A HREF="http://www.squid-cache.org/Doc/config/offline_mode/">http://www.squid-cache.org/Doc/config/offline_mode/</A>&gt;

My advice is do not use this directive unless you are in the process of
a live server migration between two proxies. In which case debugging
weird traffic behaviour is best left until the procedure is completed
and both the directive and defunct proxy removed from the traffic path.


3) override-expire with an age parameter of 43200 minutes.

The specific response you are asking about is not affected by this. But
others using Expires header will be broken in similar ways when this
setting is applied to them.


Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="019310.html">[squid-users] Why does this proxy configuration ignore no-cache and	no-store?
</A></li>
	<LI>Next message (by thread): <A HREF="019312.html">[squid-users] Why does this proxy configuration ignore no-cache and no-store?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19311">[ date ]</a>
              <a href="thread.html#19311">[ thread ]</a>
              <a href="subject.html#19311">[ subject ]</a>
              <a href="author.html#19311">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
