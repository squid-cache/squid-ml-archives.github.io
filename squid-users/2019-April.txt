From david at articatech.com  Mon Apr  1 09:17:18 2019
From: david at articatech.com (David Touzeau)
Date: Mon, 1 Apr 2019 11:17:18 +0200
Subject: [squid-users] Why Squid on CentOS is faster than Debian ?
In-Reply-To: <11154c61-dd09-99d3-e07e-a505d72ba81b@articatech.com>
References: <066e5172-ab3e-3095-98e0-59891b3397b0@articatech.com>
 <20190330120546.GA29173@fantomas.sk>
 <594ce52d-78c0-6593-cd51-7edf719978d4@articatech.com>
 <5d6ef032-46ee-d4fa-a734-710a6341788c@treenet.co.nz>
 <11154c61-dd09-99d3-e07e-a505d72ba81b@articatech.com>
Message-ID: <c6d83524-a044-3e6d-35fe-88232ec242fb@articatech.com>


Le 01/04/2019 ? 00:23, David Touzeau a ?crit?:
>
> Le 31/03/2019 ? 05:50, Amos Jeffries a ?crit?:
>> On 31/03/19 3:41 am, David Touzeau wrote:
>>> On 30.03.19 10:22, David Touzeau wrote:
>>>
>>>>> Did you have perform squid stress on Debian against CentOS ?
>>>>>
>>>>> I have installed:
>>>>>
>>>>> * Debian 9 net install + Squid compiled
>>>>> * CentOS 7 minimal? + Squid compiled
>>>>>
>>>>> Same version, same compilation parameters, same Squid settings.
>>>>> It seems that Squid on CentOS is 10 times faster than squid on Debian
>>>> faster in what? Response time? number of parallel connections?
>>>> single or multiple connection data transfers?
>>>> HTTP or HTTPS?
>>>>
>>>>> What are kernel differences that made this huge performance changes?
>>>> no kernel differences should cause 10x speed difference.
>>>>
>> If you still have the config.log files from the build you may be able to
>> track down something being detected (or not) in one of the builds.
>>
>> The -march=native or -O level options for compile would be the first
>> place I look for a major difference like that. Either on Squid or on one
>> of the system libraries it uses. The *FLAGS summary at the end of the
>> build can be a good starting point for comparison.
>>
>> Compiler version can also have an effect as newer compilers use more
>> performance related tricks than older ones (YMMV on which tricks are
>> actually better).
>>
>>
>>> Faster in what? Response time?
>>>
>>> 1. response time, MISS and HIT are faster
>>>
>>> Example:
>>>
>>> on Centos MEM_HIT are about? 0-1 msec against Debian about 3-4 msec
>>>
>> On the same test traffic?
>>
>>
>> Amos
>
> Thanks Amos, we will take care during the compilation.
>
> But to be sure of tests:
>
> Using same settings, same cache, same hardware and same destination 
> websites.


Hi Amos and Community...

We have recompiled same squid version on 2 systems

No march= using --disable-arch-native on both systems

Debian config.log

https://github.com/dtouzeau/1.6.x/blob/Tempfiles/debian9-config.log?raw=true

Centos config.log

https://github.com/dtouzeau/1.6.x/blob/Tempfiles/centos7-config.log?raw=true

-----------------------------------------------------------
Result was CentOS 44% faster on TCP_MEM_HITS
-----------------------------------------------------------





From alex at dvm.esines.cu  Mon Apr  1 12:00:51 2019
From: alex at dvm.esines.cu (=?UTF-8?Q?Alex_Guti=c3=a9rrez_Mart=c3=adnez?=)
Date: Mon, 1 Apr 2019 08:00:51 -0400
Subject: [squid-users] =?utf-8?q?kerberos_=28Alex_Guti=C3=A9rrez=29?=
Message-ID: <6246359b-a0c5-da14-931f-4515ddef7718@dvm.esines.cu>

Thanks again for your support Mr. Jeffries, My proxy only contains of 1 
GB of memory :-(


Here i leave my squid.conf


#######################################################################################

#######################################################################################

#######################################################################################


#hide squid
httpd_suppress_version_string on
#name of squid
visible_hostname Hermes
#secutiry options
via off
forwarded_for off
follow_x_forwarded_for deny all
#headers
request_header_access From deny all
request_header_access Server deny all
request_header_access WWW-Authenticate deny all
request_header_access Link deny all
request_header_access Cache-Control deny all
request_header_access Proxy-Connection deny all
request_header_access X-Cache deny all
request_header_access X-Cache-Lookup deny all
request_header_access Via deny all
request_header_access X-Forwarded-For deny all
request_header_access Pragma deny all
request_header_access Keep-Alive deny all
#error directory
error_directory /usr/share/squid_error
#allowed ports
acl SSL_ports port 443
acl Safe_ports port 21 # ftp
acl Safe_ports port 80 # http
acl Safe_ports port 81 # http_industria2
acl Safe_ports port 70 # gopher
#acl Safe_ports port 75 # pagina_llp
acl Safe_ports port 210 # wais
acl Safe_ports port 280 # http-mgmt
acl Safe_ports port 443 # https
acl Safe_ports port 488 # gss-http
acl Safe_ports port 591 # filemaker
acl Safe_ports port 777 # multiling http
acl Safe_ports port 1025-65535 # unregistered ports
acl CONNECT method CONNECT
#################
#sqstat
#################
acl webserver src 127.0.0.1/32
http_access allow manager webserver
http_access deny manager
#kav
acl dmz src 172.16.1.14
http_access allow dmz
#allow one user per ip
authenticate_ip_ttl 600 seconds
acl multilogin max_user_ip -s 1
http_access deny multilogin
##########################################
# Logs:
access_log /var/log/squid/access.log squid !manager !dmz
logformat squid %ts.%03tu %6tr %>a %Ss/%03>Hs %<st %rm %ru %un %Sh/%<A %mt
log_uses_indirect_client on
##########################################
#never allow insecure ports
http_access deny !Safe_ports
http_access deny CONNECT !SSL_ports
##########################################
#allow everithing from Cuba
##########################################
acl cuba dstdomain .cu
http_access allow cuba all
########################################################
#auth kerberos#
########################################################
auth_param negotiate program /usr/lib/squid/negotiate_kerberos_auth -d 
-s HTTP/ares.empresa.cu
auth_param negotiate children 10
auth_param negotiate keep_alive on

external_acl_type kerberos_group ttl=3600 negative_ttl=3600 %LOGIN 
/usr/lib/squid/ext_kerberos_ldap_group_acl -a -g InternetFull -D EMPRESA.CU
external_acl_type kerberos_group2 ttl=3600 negative_ttl=3600 %LOGIN 
/usr/lib/squid/ext_kerberos_ldap_group_acl -a -g InternetLimitado -D 
EMPRESA.CU
#-g Internet_access hace reeferencia al grupo de acceso a internet
#-d EMPRESA.CU hace referencia al dominio empresa
acl auth proxy_auth REQUIRED
acl full external kerberos_group
acl limitado external kerberos_group2
http_access deny !auth
########################################################
#network declaration#
########################################################
#acl dmz src "/etc/squid/dmz"
acl lan src "/etc/squid/lan"
########################################################
#schedule declaration#
########################################################
acl desayuno time MTWHF 00:00-09:00
acl matutino time MTWHF 09:00-12:00
acl almuerzo time MTWHF 12:00-14:00
acl tarde time MTWHF 14:00-16:00
acl descanso time MTWHF 16:00-24:00
acl nolaboral time SA 00:00-24:00
########################################################
#Never allow ip browsing
########################################################
acl bloquear_ip dstdom_regex [0-9]+(\.[0-9]+){3}
http_access deny bloquear_ip !dmz
########################################################
#acl declaration#
########################################################
acl bl1 dstdomain -n "/etc/squid/bloqueo/porno"
acl servicios dstdomain -n "/etc/squid/bloqueo/servicios"
acl bl2 url_regex -i "/etc/squid/bloqueo/android"
acl bl7 dstdomain -n "/etc/squid/bloqueo/ad2"
acl sociales dstdomain -n "/etc/squid/bloqueo/sociales"
acl correos dstdomain -n "/etc/squid/bloqueo/correos"
acl extensiones urlpath_regex -i "/etc/squid/bloqueo/listaextensiones"
acl lento dstdomain -n "/etc/squid/bloqueo/lento"
acl ytb dstdomain -n "/etc/squid/bloqueo/ytb"
########################################################
#use of schedules#
########################################################
http_access deny desayuno !sociales !dmz !lan
http_access deny matutino sociales !dmz lan
http_access deny almuerzo !sociales !dmz !lan
http_access deny tarde sociales !dmz lan
http_access deny descanso !sociales !dmz !lan
http_access deny nolaboral !sociales !dmz !lan
#########################################################################
#acl restrictions#
#########################################################################
http_access deny lan !limitado !full !dmz
#http_access deny listanegraregex !dmz
http_access deny servicios !dmz
http_access deny bl1
http_access deny bl2
http_access deny bl7 !dmz
http_access deny correos !full limitado !dmz
http_access deny sociales !full !limitado !dmz
http_access deny lan !full !limitado
http_access deny dmz full limitado
#########################################################################
#parent proxy
#########################################################################
cache_peer masterproxy.empresa.cu parent 8020 0
#########################################################################
#never allow direct connections, always trough proxy
#########################################################################
never_direct allow all
#######################################################################
# clients ports
http_port 3128
#########################################################################
#########################################################################
#Cache #
###############################################################################
#Establecemos los patrones de refrescamiento de la cache #
#patron de refrescamiento -- tipo de archivo -- tiempo del objeto -- %de 
refrescamiento -- tiempo #
#1440 minutos equivalen a 24 horas #
################################
#Sitios que guardo en cache
################################
refresh_pattern -i (/cgi-bin/|\?) 0???? 0%????? 0
refresh_pattern . 1440 40% 4320
################################
#Refrescamiento de la cache
################################
refresh_pattern ^ftp: 1440 20% 4320
refresh_pattern ^gopher: 1440 0% 4320
refresh_pattern -i \.(gif|png|jpg|jpeg|ico)$ 1440 60% 4320
refresh_pattern -i \.(iso|avi|wav|mp3|mp4|mpeg|swf|flv|x-flv)$ 1440 60% 
43200
refresh_pattern -i 
\.(deb|exe|zip|tar|tgz|ram|rar|bin|ppt|doc|tiff|pdf|xls|docx|xlsx|pptx)$ 
1440 60% 4320
refresh_pattern -i \.index.(html|htm)$ 1440 10% 4320
refresh_pattern -i \.(html|htm|css|js)$ 1440 10% 4320
#########################################################################
##cuanto el squid intenta cachear en mi nombre
read_ahead_gap 20 KB
quick_abort_min 3 KB
quick_abort_max 2048 KB
quick_abort_pct 95
#opciones de cache
delay_initial_bucket_level 75
minimum_object_size 3 KB
maximum_object_size 1 MB
maximum_object_size_in_memory 300 KB
cache_dir aufs /opt/squid 25600 16 256
cache_mem 512 MB
##cache_store_log /opt/squid/cache_store.log
##coredump_dir /opt/squid/dump
##minimum_expiry_time 550 seconds
############################
#uso cache
###########################
client_db off
##offline_mode off
cache_swap_low 60
cache_swap_high 70
cache_replacement_policy heap LUDFA
memory_replacement_policy heap GDSF
half_closed_clients off
###############################################################################
# establecemos los archivos de volcado en /var/cache/squid/
coredump_dir /opt/squid/
###############################################################################
#Delay pools#
###############################################################################
# TABLA DE EQUIVALENCIAS
#1800 B ==> 2 kb ==> 1.5KB
#2048 B ==> 16 kb ==> 2KB
#4096 B ==> 32 kb ==> 4KB
#8192 B ==> 64 kb ==> 8KB
#16384 B ==> 128kb ==> 16KB
#32768 B ==> 256Kb ==> 32KB
#65536 B ==> 512Kb ==> 64KB
#131072 B ==> 1 Mb ==> 128KB
#196608 B ==> 1.5 Mb ==> 192KB
#262144 B ==> 2 Mb ==> 256KB
#3993216 B ==> 3 Mb
#524288 B ==> 4 Mb ==> 512KB
#655360 B ==> 5 Mb
#7986432 B ==> 6 Mb
#917504 B ==> 7 Mb
#1048576 B ==> 8 Mb
###############################################################################
#delay pools declarations
###############################################################################
delay_pools 6
#delay_pools 5

#Canal 1 advertising
delay_class 1 1
delay_access 1 allow bl7 !dmz
delay_access 1 deny all
delay_parameters 1 2048/1800

#Canal 2 lento
delay_class 2 2
delay_access 2 allow lento !dmz
delay_access 2 deny all
#delay_parameters 2 32768/16384 16384/8192
delay_parameters 2 65536/32768 32768/16384

#Canal 3 para cuba
delay_class 3 2
delay_access 3 allow cuba !dmz
delay_access 3 deny all
#delay_parameters 3 65536/32768 32768/16384
delay_parameters 3 98304/65536 65536/32768

#Canal 4 Sociales
delay_class 4 2
delay_access 4 allow correos !dmz
delay_access 4 allow sociales !dmz
delay_access 4 allow ytb !dmz
delay_access 4 allow extensiones !dmz
delay_access 4 deny all
#delay_parameters 4 98304/65536 49152/32768
#delay_parameters 4 174762/131072 98304/65536
delay_parameters 4 260000/240000 230000/200000

#Canal 5 para lan
delay_class 5 2
delay_access 5 allow lan !dmz
delay_access 5 allow nolaboral !dmz
delay_access 5 deny all
#delay_parameters 5 131072/98304 65536/49152
delay_parameters 5 262144/130172 130172/98304

#Canal 6 para lan
delay_class 6 1
delay_access 6 allow dmz
delay_access 6 deny all
#delay_parameters 6 131072/98304
#delay_parameters 6 262144/262144
delay_parameters 6 7986432/7986432



#######################################################################################

#######################################################################################

#######################################################################################


My acl? lan, only contains ip address, all the acl with dstdomain 
contains domains in this format .google.com. the acl extensiones 
contains something similar to this \.bin$. And last but not less android 
acl contains something like ^http://qva2world.com



now i leave my kerb5.conf



#######################################################################################

#######################################################################################

#######################################################################################


[logging]
default = FILE:/var/log/krb5libs.log
kdc = FILE:/var/log/krb5kdc.log
admin_server = FILE:/var/log/kadmind.log

[libdefaults]
default_realm = EMPRESA.CU
default_tkt = rc4-hmac
default_tgs_enctypes = rc4-hmac

ticket_lifetime = 24h
default_keytab_name = /etc/squid/PROXY.keytab

#Opcional si usas MSKT-Utils
# for Windows 2008 with AES
default_tgs_enctypes = aes256-cts-hmac-sha1-96 rc4-hmac des-cbc-crc 
des-cbc-md5
default_tkt_enctypes = aes256-cts-hmac-sha1-96 rc4-hmac des-cbc-crc 
des-cbc-md5
permitted_enctypes = aes256-cts-hmac-sha1-96 rc4-hmac des-cbc-crc 
des-cbc-md5

[realms]
EMPRESA.CU = {
kdc = zeus.empresa.cu
admin_server = zeus.empresa.cu
}

[domain_realm]
empresa.cu = EMPRESA.CU

-- 
Saludos Cordiales

Lic. Alex Guti?rrez Mart?nez

Tel. +53 7 2710327

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20190401/b38dd060/attachment.htm>

From rousskov at measurement-factory.com  Mon Apr  1 21:22:54 2019
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Mon, 1 Apr 2019 15:22:54 -0600
Subject: [squid-users] Why Squid on CentOS is faster than Debian ?
In-Reply-To: <c6d83524-a044-3e6d-35fe-88232ec242fb@articatech.com>
References: <066e5172-ab3e-3095-98e0-59891b3397b0@articatech.com>
 <20190330120546.GA29173@fantomas.sk>
 <594ce52d-78c0-6593-cd51-7edf719978d4@articatech.com>
 <5d6ef032-46ee-d4fa-a734-710a6341788c@treenet.co.nz>
 <11154c61-dd09-99d3-e07e-a505d72ba81b@articatech.com>
 <c6d83524-a044-3e6d-35fe-88232ec242fb@articatech.com>
Message-ID: <31bb34b4-9c61-68cd-78df-51b8630c446d@measurement-factory.com>

On 4/1/19 3:17 AM, David Touzeau wrote:

> On 30.03.19 10:22, David Touzeau wrote:
>> * Debian 9 net install + Squid compiled
>> * CentOS 7 minimal? + Squid compiled
>>
>> Same version, same compilation parameters, same Squid settings.
>> It seems that Squid on CentOS is 10 times faster than squid on Debian


> We have recompiled same squid version on 2 systems
> 
> No march= using --disable-arch-native on both systems
> 
> Debian config.log
> https://github.com/dtouzeau/1.6.x/blob/Tempfiles/debian9-config.log?raw=true
> 
> Centos config.log
> https://github.com/dtouzeau/1.6.x/blob/Tempfiles/centos7-config.log?raw=true
> 
> Result was CentOS 44% faster on TCP_MEM_HITS

Just to clarify: Did changing ./configure options alone move you from
1000% to 44%? Or was the earlier "10 times" just a crude approximation
that we should ignore now?


Do your Squids use shared memory for the memory cache? See
memory_cache_shared (even if you do not set it explicitly).
http://www.squid-cache.org/Doc/config/memory_cache_shared/

Any significant difference in mgr:info and mgr:counters output after a
test that only has memory hits?

Alex.


From jun357572957zhao at hotmail.com  Tue Apr  2 01:10:37 2019
From: jun357572957zhao at hotmail.com (=?gb2312?B?1dQgv6E=?=)
Date: Tue, 2 Apr 2019 01:10:37 +0000
Subject: [squid-users] How to restrict the maximum negotiated version of
 squid HTTPS to TLS1.2
Message-ID: <CO2PR0801MB2312283C8FEAFDCC4C70C6EE98560@CO2PR0801MB2312.namprd08.prod.outlook.com>

Hi, this is part of my squid.conf:
https_port 192.168.30.4:3129 intercept ssl-bump connection-auth=off generate-host-certificates=on dynamic_cert_mem_cache_size=4MB cert=/opt/squid/ssl_cert/CA.pem sslflags=NO_DEFAULT_CA

acl broken_sites ssl::server_name foo.com
acl ssl_step1 at_step SslBump1

ssl_bump peek ssl_step1
ssl_bump bump broken_sites
ssl_bump splice all

so how to restrict the maximum negotiated version of squid HTTPS to TLS1.2?
I also try configure like this:


https_port 192.168.30.4:3129 intercept ssl-bump connection-auth=off generate-host-certificates=on dynamic_cert_mem_cache_size=4MB cert=/opt/squid/ssl_cert/CA.pem  version=4


it did not work.

the access.log show TCP/TUNNEL 200
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20190402/92341273/attachment.htm>

From squid3 at treenet.co.nz  Tue Apr  2 05:07:22 2019
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Tue, 2 Apr 2019 18:07:22 +1300
Subject: [squid-users] How to restrict the maximum negotiated version of
 squid HTTPS to TLS1.2
In-Reply-To: <CO2PR0801MB2312283C8FEAFDCC4C70C6EE98560@CO2PR0801MB2312.namprd08.prod.outlook.com>
References: <CO2PR0801MB2312283C8FEAFDCC4C70C6EE98560@CO2PR0801MB2312.namprd08.prod.outlook.com>
Message-ID: <a35ce939-5eea-e965-371f-69da02a619c8@treenet.co.nz>

On 2/04/19 2:10 pm, ? ? wrote:
> Hi, this is part of my squid.conf:
> https_port 192.168.30.4:3129 intercept ssl-bump connection-auth=off
> generate-host-certificates=on dynamic_cert_mem_cache_size=4MB
> cert=/opt/squid/ssl_cert/CA.pem sslflags=NO_DEFAULT_CA?
> 
> acl broken_sites ssl::server_name foo.com?
> acl ssl_step1 at_step SslBump1
> 
> ssl_bump peek ssl_step1
> ssl_bump bump broken_sites
> ssl_bump splice all
> 
> so how to restrict the maximum negotiated version of squid HTTPS to TLS1.2?


That is not possible without patching Squid. Only versions up to TLS/1.2
can be controlled by any published Squid.


> I also try configure like this:
> 
> 
> https_port 192.168.30.4:3129 intercept ssl-bump connection-auth=off
> generate-host-certificates=on dynamic_cert_mem_cache_size=4MB
> cert=/opt/squid/ssl_cert/CA.pem? version=4?
> 
> 
> it did not work.
> 

The deprecated 'version=4' setting means TLS/*1.0* only.

> the access.log show TCP/TUNNEL 200
> 

That indicates that the protocol arriving from the client is probably
not TLS or SSL in any form, but some other protocol. If that is true
then no matter what you set for TLS versions allowed it will always tunnel.

Amos


From squid-user at tlinx.org  Tue Apr  2 05:43:38 2019
From: squid-user at tlinx.org (L A Walsh)
Date: Mon, 01 Apr 2019 22:43:38 -0700
Subject: [squid-users] Why Squid on CentOS is faster than Debian ?
In-Reply-To: <c6d83524-a044-3e6d-35fe-88232ec242fb@articatech.com>
References: <066e5172-ab3e-3095-98e0-59891b3397b0@articatech.com>
 <20190330120546.GA29173@fantomas.sk>
 <594ce52d-78c0-6593-cd51-7edf719978d4@articatech.com>
 <5d6ef032-46ee-d4fa-a734-710a6341788c@treenet.co.nz>
 <11154c61-dd09-99d3-e07e-a505d72ba81b@articatech.com>
 <c6d83524-a044-3e6d-35fe-88232ec242fb@articatech.com>
Message-ID: <5CA2F68A.8000009@tlinx.org>

On 4/1/2019 2:17 AM, David Touzeau wrote:
> We have recompiled same squid version on 2 systems
> https://github.com/dtouzeau/1.6.x/blob/Tempfiles/centos7-config.log?raw=true
>
> -----------------------------------------------------------
> Result was CentOS 44% faster on TCP_MEM_HITS
> -----------------------------------------------------------
>   
What kernels are the two systems running?

Are the config options exactly the same?

Just a WAG, but but are the settings for
CONFIG_TRANSPARENT_HUGEPAGE the same for both?




From david at articatech.com  Tue Apr  2 07:23:16 2019
From: david at articatech.com (David Touzeau)
Date: Tue, 2 Apr 2019 09:23:16 +0200
Subject: [squid-users] Why Squid on CentOS is faster than Debian ?
In-Reply-To: <31bb34b4-9c61-68cd-78df-51b8630c446d@measurement-factory.com>
References: <066e5172-ab3e-3095-98e0-59891b3397b0@articatech.com>
 <20190330120546.GA29173@fantomas.sk>
 <594ce52d-78c0-6593-cd51-7edf719978d4@articatech.com>
 <5d6ef032-46ee-d4fa-a734-710a6341788c@treenet.co.nz>
 <11154c61-dd09-99d3-e07e-a505d72ba81b@articatech.com>
 <c6d83524-a044-3e6d-35fe-88232ec242fb@articatech.com>
 <31bb34b4-9c61-68cd-78df-51b8630c446d@measurement-factory.com>
Message-ID: <7330fbab-1808-e217-8f7f-3f08bc2b88ab@articatech.com>


Le 01/04/2019 ? 23:22, Alex Rousskov a ?crit?:
> On 4/1/19 3:17 AM, David Touzeau wrote:
>
>> On 30.03.19 10:22, David Touzeau wrote:
>>> * Debian 9 net install + Squid compiled
>>> * CentOS 7 minimal? + Squid compiled
>>>
>>> Same version, same compilation parameters, same Squid settings.
>>> It seems that Squid on CentOS is 10 times faster than squid on Debian
>
>> We have recompiled same squid version on 2 systems
>>
>> No march= using --disable-arch-native on both systems
>>
>> Debian config.log
>> https://github.com/dtouzeau/1.6.x/blob/Tempfiles/debian9-config.log?raw=true
>>
>> Centos config.log
>> https://github.com/dtouzeau/1.6.x/blob/Tempfiles/centos7-config.log?raw=true
>>
>> Result was CentOS 44% faster on TCP_MEM_HITS
> Just to clarify: Did changing ./configure options alone move you from
> 1000% to 44%? Or was the earlier "10 times" just a crude approximation
> that we should ignore now?
>
>
> Do your Squids use shared memory for the memory cache? See
> memory_cache_shared (even if you do not set it explicitly).
> http://www.squid-cache.org/Doc/config/memory_cache_shared/
>
> Any significant difference in mgr:info and mgr:counters output after a
> test that only has memory hits?
>
> Alex.

Hi Alex and comunity

The test did not use workers

Here it is a piece of logs between the 2 machines

CentOS 7:
1554185117.132????? 1 172.16.1.228 50:46:5d:a0:3e:5a TCP_MEM_HIT/200 
10979 GET 
http://www.projetmontsaintmichel.com/upload/document/reduites/TR_BA_0611_2.jpg 
- HIER_NONE/- image/jpeg
1554185117.133????? 1 172.16.1.228 50:46:5d:a0:3e:5a TCP_MEM_HIT/200 
5531 GET 
http://www.projetmontsaintmichel.com/upload/document/reduites/TR_BA_0611_5.jpg 
- HIER_NONE/- image/jpeg
1554185117.134????? 0 172.16.1.228 50:46:5d:a0:3e:5a TCP_MEM_HIT/200 
3727 GET 
http://www.projetmontsaintmichel.com//upload/document/minis/capture_40.jpg 
- HIER_NONE/- image/jpeg
1554185117.137????? 0 172.16.1.228 50:46:5d:a0:3e:5a TCP_MEM_HIT/200 
1230 GET http://www.projetmontsaintmichel.com/web/images/ico_pdf.png - 
HIER_NONE/- image/png
1554185117.141????? 1 172.16.1.228 50:46:5d:a0:3e:5a TCP_MEM_HIT/200 
33600 GET 
http://www.projetmontsaintmichel.com/upload/document/reduites/TR_BA_0609_6.gif 
- HIER_NONE/- image/gif
1554185117.142????? 1 172.16.1.228 50:46:5d:a0:3e:5a TCP_MEM_HIT/200 
20200 GET 
http://www.projetmontsaintmichel.com/upload/document/reduites/TR_BA_0609_2.gif 
- HIER_NONE/- image/gif
1554185117.144????? 1 172.16.1.228 50:46:5d:a0:3e:5a TCP_MEM_HIT/200 
29375 GET 
http://www.projetmontsaintmichel.com/upload/document/reduites/TR_BA_0609_5.gif 
- HIER_NONE/- image/gif
1554185117.146????? 1 172.16.1.228 50:46:5d:a0:3e:5a TCP_MEM_HIT/200 
29835 GET 
http://www.projetmontsaintmichel.com/upload/document/reduites/TR_BA_0609_4.gif 
- HIER_NONE/- image/gif
1554185117.147????? 2 172.16.1.228 50:46:5d:a0:3e:5a TCP_MEM_HIT/200 
28683 GET 
http://www.projetmontsaintmichel.com/upload/document/reduites/TR_BA_0609_1.gif 
- HIER_NONE/- image/gif
1554185117.149????? 1 172.16.1.228 50:46:5d:a0:3e:5a TCP_MEM_HIT/200 
7715 GET 
http://www.projetmontsaintmichel.com/upload/document/reduites/TR_BA_0608_3.jpg 
- HIER_NONE/- image/jpeg
1554185117.151????? 0 172.16.1.228 50:46:5d:a0:3e:5a TCP_MEM_HIT/200 
8175 GET 
http://www.projetmontsaintmichel.com/upload/document/reduites/TR_BA_0608_2.jpg 
- HIER_NONE/- image/jpeg
1554185117.152????? 0 172.16.1.228 50:46:5d:a0:3e:5a TCP_MEM_HIT/200 
2519 GET 
http://www.projetmontsaintmichel.com/web/images/bloc_infoschantier2.gif 
- HIER_NONE/- image/gif
1554185117.153????? 0 172.16.1.228 50:46:5d:a0:3e:5a TCP_MEM_HIT/200 
3870 GET 
http://www.projetmontsaintmichel.com/web/images/bloc_espacepro2.gif - 
HIER_NONE/- image/gif
1554185117.157????? 0 172.16.1.228 50:46:5d:a0:3e:5a TCP_MEM_HIT/200 
9349 GET 
http://www.projetmontsaintmichel.com/upload/document/reduites/TR_BA_0608_1.jpg 
- HIER_NONE/- image/jpeg
1554185117.162????? 0 172.16.1.228 50:46:5d:a0:3e:5a TCP_MEM_HIT/200 
3622 GET 
http://www.projetmontsaintmichel.com//upload/document/minis/capture_29.jpg 
- HIER_NONE/- image/jpeg
1554185117.162????? 1 172.16.1.228 50:46:5d:a0:3e:5a TCP_MEM_HIT/200 409 
GET 
http://www.projetmontsaintmichel.com/web/images/puce_carre_visite.gif - 
HIER_NONE/- image/gif
1554185117.162????? 1 172.16.1.228 50:46:5d:a0:3e:5a TCP_MEM_HIT/200 409 
GET http://www.projetmontsaintmichel.com/web/images/puce_carre_gris.gif 
- HIER_NONE/- image/gif
1554185117.175????? 1 172.16.1.228 50:46:5d:a0:3e:5a TCP_MEM_HIT/200 
23219 GET 
http://www.projetmontsaintmichel.com/web/images/fond_footer.jpg - 
HIER_NONE/- image/jpeg
1554185117.187????? 0 172.16.1.228 50:46:5d:a0:3e:5a TCP_MEM_HIT/200 540 
GET http://www.projetmontsaintmichel.com/web/galerie/images/overlay.png 
- HIER_NONE/- image/png
1554185117.389????? 2 172.16.1.228 50:46:5d:a0:3e:5a TCP_MEM_HIT/200 858 
GET http://www.projetmontsaintmichel.com/favicon.ico - HIER_NONE/- 
image/x-icon

Debian 9:
1554185129.651????? 1 172.16.1.228 50:46:5d:a0:3e:5a TCP_MEM_HIT/200 
8887 GET 
http://www.projetmontsaintmichel.com/upload/document/reduites/TR_BA_0611_1.jpg 
- HIER_NONE/- image/jpeg
1554185129.660????? 5 172.16.1.228 50:46:5d:a0:3e:5a TCP_MEM_HIT/200 
8733 GET 
http://www.projetmontsaintmichel.com/upload/document/reduites/TR_BA_0611_4.jpg 
- HIER_NONE/- image/jpeg
1554185129.664????? 1 172.16.1.228 50:46:5d:a0:3e:5a TCP_MEM_HIT/200 
5565 GET 
http://www.projetmontsaintmichel.com/upload/document/reduites/TR_BA_0611_5.jpg 
- HIER_NONE/- image/jpeg
1554185129.664????? 1 172.16.1.228 50:46:5d:a0:3e:5a TCP_MEM_HIT/200 
11013 GET 
http://www.projetmontsaintmichel.com/upload/document/reduites/TR_BA_0611_2.jpg 
- HIER_NONE/- image/jpeg
1554185129.665????? 2 172.16.1.228 50:46:5d:a0:3e:5a TCP_MEM_HIT/200 
3761 GET 
http://www.projetmontsaintmichel.com//upload/document/minis/capture_40.jpg 
- HIER_NONE/- image/jpeg
1554185129.665????? 1 172.16.1.228 50:46:5d:a0:3e:5a TCP_MEM_HIT/200 
1264 GET http://www.projetmontsaintmichel.com/web/images/ico_pdf.png - 
HIER_NONE/- image/png
1554185129.677???? 12 172.16.1.228 50:46:5d:a0:3e:5a TCP_MEM_HIT/200 
33634 GET 
http://www.projetmontsaintmichel.com/upload/document/reduites/TR_BA_0609_6.gif 
- HIER_NONE/- image/gif
1554185129.677????? 2 172.16.1.228 50:46:5d:a0:3e:5a TCP_MEM_HIT/200 
7749 GET 
http://www.projetmontsaintmichel.com/upload/document/reduites/TR_BA_0608_3.jpg 
- HIER_NONE/- image/jpeg
1554185129.677????? 4 172.16.1.228 50:46:5d:a0:3e:5a TCP_MEM_HIT/200 
20234 GET 
http://www.projetmontsaintmichel.com/upload/document/reduites/TR_BA_0609_2.gif 
- HIER_NONE/- image/gif
1554185129.678????? 4 172.16.1.228 50:46:5d:a0:3e:5a TCP_MEM_HIT/200 
28717 GET 
http://www.projetmontsaintmichel.com/upload/document/reduites/TR_BA_0609_1.gif 
- HIER_NONE/- image/gif
1554185129.678????? 4 172.16.1.228 50:46:5d:a0:3e:5a TCP_MEM_HIT/200 
29869 GET 
http://www.projetmontsaintmichel.com/upload/document/reduites/TR_BA_0609_4.gif 
- HIER_NONE/- image/gif
1554185129.678????? 4 172.16.1.228 50:46:5d:a0:3e:5a TCP_MEM_HIT/200 
29409 GET 
http://www.projetmontsaintmichel.com/upload/document/reduites/TR_BA_0609_5.gif 
- HIER_NONE/- image/gif
1554185129.688????? 3 172.16.1.228 50:46:5d:a0:3e:5a TCP_MEM_HIT/200 
8209 GET 
http://www.projetmontsaintmichel.com/upload/document/reduites/TR_BA_0608_2.jpg 
- HIER_NONE/- image/jpeg
1554185129.691????? 2 172.16.1.228 50:46:5d:a0:3e:5a TCP_MEM_HIT/200 
9383 GET 
http://www.projetmontsaintmichel.com/upload/document/reduites/TR_BA_0608_1.jpg 
- HIER_NONE/- image/jpeg
1554185129.692????? 1 172.16.1.228 50:46:5d:a0:3e:5a TCP_MEM_HIT/200 
3656 GET 
http://www.projetmontsaintmichel.com//upload/document/minis/capture_29.jpg 
- HIER_NONE/- image/jpeg
1554185129.694????? 1 172.16.1.228 50:46:5d:a0:3e:5a TCP_MEM_HIT/200 443 
GET 
http://www.projetmontsaintmichel.com/web/images/puce_carre_visite.gif - 
HIER_NONE/- image/gif
1554185129.694????? 1 172.16.1.228 50:46:5d:a0:3e:5a TCP_MEM_HIT/200 443 
GET http://www.projetmontsaintmichel.com/web/images/puce_carre_gris.gif 
- HIER_NONE/- image/gif
1554185129.700????? 3 172.16.1.228 50:46:5d:a0:3e:5a TCP_MEM_HIT/200 574 
GET http://www.projetmontsaintmichel.com/web/galerie/images/overlay.png 
- HIER_NONE/- image/png
1554185129.701????? 3 172.16.1.228 50:46:5d:a0:3e:5a TCP_MEM_HIT/200 
23253 GET 
http://www.projetmontsaintmichel.com/web/images/fond_footer.jpg - 
HIER_NONE/- image/jpeg
1554185129.857????? 1 172.16.1.228 50:46:5d:a0:3e:5a TCP_MEM_HIT/200 892 
GET http://www.projetmontsaintmichel.com/favicon.ico - HIER_NONE/- 
image/x-icon


CentOS :
 ??? total: 14msec
 ??? average: 0.7msec

Debian :
 ??? total: 56msec
 ??? average: 2.8msec

CentOS vs Debian: 400% faster with CentOS

Do you know why CentOS objects are 34 bytes smaller than Debian ?





> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users


From david at articatech.com  Tue Apr  2 07:23:58 2019
From: david at articatech.com (David Touzeau)
Date: Tue, 2 Apr 2019 09:23:58 +0200
Subject: [squid-users] Why Squid on CentOS is faster than Debian ?
In-Reply-To: <5CA2F68A.8000009@tlinx.org>
References: <066e5172-ab3e-3095-98e0-59891b3397b0@articatech.com>
 <20190330120546.GA29173@fantomas.sk>
 <594ce52d-78c0-6593-cd51-7edf719978d4@articatech.com>
 <5d6ef032-46ee-d4fa-a734-710a6341788c@treenet.co.nz>
 <11154c61-dd09-99d3-e07e-a505d72ba81b@articatech.com>
 <c6d83524-a044-3e6d-35fe-88232ec242fb@articatech.com>
 <5CA2F68A.8000009@tlinx.org>
Message-ID: <1ed9f29c-c206-2c1d-352d-6f547551f753@articatech.com>


Le 02/04/2019 ? 07:43, L A Walsh a ?crit?:
> On 4/1/2019 2:17 AM, David Touzeau wrote:
>> We have recompiled same squid version on 2 systems
>> https://github.com/dtouzeau/1.6.x/blob/Tempfiles/centos7-config.log?raw=true
>>
>> -----------------------------------------------------------
>> Result was CentOS 44% faster on TCP_MEM_HITS
>> -----------------------------------------------------------
>>    
> What kernels are the two systems running?
>
> Are the config options exactly the same?
>
> Just a WAG, but but are the settings for
> CONFIG_TRANSPARENT_HUGEPAGE the same for both?

Yes it the same : always [madvise] never

>
>


From belle at bazuin.nl  Tue Apr  2 07:53:38 2019
From: belle at bazuin.nl (=?windows-1252?Q?L.P.H._van_Belle?=)
Date: Tue, 2 Apr 2019 09:53:38 +0200
Subject: [squid-users] Why Squid on CentOS is faster than Debian ?
In-Reply-To: <1ed9f29c-c206-2c1d-352d-6f547551f753@articatech.com>
References: <5CA2F68A.8000009@tlinx.org>
Message-ID: <vmime.5ca31502.51b3.2578070e6b172822@ms249-lin-003.rotterdam.bazuin.nl>

I suggest start compairing the logs you posted, the builds are really different. 

Differences in 
- kernel
- needed packages
- build paramaters due to missing or different packages.
Etc. 

Just diff you logs and you will see it. 

Greetz, 

Louis


 

> -----Oorspronkelijk bericht-----
> Van: squid-users 
> [mailto:squid-users-bounces at lists.squid-cache.org] Namens 
> David Touzeau
> Verzonden: dinsdag 2 april 2019 9:24
> CC: squid-users at lists.squid-cache.org
> Onderwerp: Re: [squid-users] Why Squid on CentOS is faster 
> than Debian ?
> 
> 
> Le 02/04/2019 ? 07:43, L A Walsh a ?crit?:
> > On 4/1/2019 2:17 AM, David Touzeau wrote:
> >> We have recompiled same squid version on 2 systems
> >> 
> https://github.com/dtouzeau/1.6.x/blob/Tempfiles/centos7-confi
> g.log?raw=true
> >>
> >> -----------------------------------------------------------
> >> Result was CentOS 44% faster on TCP_MEM_HITS
> >> -----------------------------------------------------------
> >>    
> > What kernels are the two systems running?
> >
> > Are the config options exactly the same?
> >
> > Just a WAG, but but are the settings for
> > CONFIG_TRANSPARENT_HUGEPAGE the same for both?
> 
> Yes it the same : always [madvise] never
> 
> >
> >
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users
> 



From jun357572957zhao at hotmail.com  Tue Apr  2 08:33:12 2019
From: jun357572957zhao at hotmail.com (=?gb2312?B?1dQgv6E=?=)
Date: Tue, 2 Apr 2019 08:33:12 +0000
Subject: [squid-users] =?gb2312?b?u9i4tDogc3F1aWQtdXNlcnMgRGlnZXN0LCBWb2wg?=
	=?gb2312?b?NTYsIElzc3VlIDM=?=
In-Reply-To: <mailman.4828.1554189799.3082.squid-users@lists.squid-cache.org>
References: <mailman.4828.1554189799.3082.squid-users@lists.squid-cache.org>
Message-ID: <CO2PR0801MB2312B90D51283EC37943CC3398560@CO2PR0801MB2312.namprd08.prod.outlook.com>

Because squid 4.5 with the configuration like this can not bump TLS1.3.

https_port 192.168.30.4:3129 intercept ssl-bump connection-auth=off generate-host-certificates=on dynamic_cert_mem_cache_size=4MB cert=/opt/squid/ssl_cert/CA.pem sslflags=NO_DEFAULT_CA

acl broken_sites ssl::server_name google.com
acl ssl_step1 at_step SslBump1

ssl_bump peek ssl_step1
ssl_bump bump broken_sites
ssl_bump splice all


How can squid 4.5 be configured to support TLS1.3 .


If not , how can i configure  squid4.5  which negotiate TLS version with a tls1.3-enabled webserver to restrict the TLS version below 1.2
________________________________
???: squid-users <squid-users-bounces at lists.squid-cache.org> ?? squid-users-request at lists.squid-cache.org <squid-users-request at lists.squid-cache.org>
????: 2019?4?2? 7:23
???: squid-users at lists.squid-cache.org
??: squid-users Digest, Vol 56, Issue 3

Send squid-users mailing list submissions to
        squid-users at lists.squid-cache.org

To subscribe or unsubscribe via the World Wide Web, visit
        http://lists.squid-cache.org/listinfo/squid-users
or, via email, send a message with subject or body 'help' to
        squid-users-request at lists.squid-cache.org

You can reach the person managing the list at
        squid-users-owner at lists.squid-cache.org

When replying, please edit your Subject line so it is more specific
than "Re: Contents of squid-users digest..."


Today's Topics:

   1. Re: Why Squid on CentOS is faster than Debian ? (Alex Rousskov)
   2. How to restrict the maximum negotiated version of squid HTTPS
      to TLS1.2 (? ?)
   3. Re: How to restrict the maximum negotiated version of squid
      HTTPS to TLS1.2 (Amos Jeffries)
   4. Re: Why Squid on CentOS is faster than Debian ? (L A Walsh)
   5. Re: Why Squid on CentOS is faster than Debian ? (David Touzeau)


----------------------------------------------------------------------

Message: 1
Date: Mon, 1 Apr 2019 15:22:54 -0600
From: Alex Rousskov <rousskov at measurement-factory.com>
To: squid-users at lists.squid-cache.org
Subject: Re: [squid-users] Why Squid on CentOS is faster than Debian ?
Message-ID:
        <31bb34b4-9c61-68cd-78df-51b8630c446d at measurement-factory.com>
Content-Type: text/plain; charset=utf-8

On 4/1/19 3:17 AM, David Touzeau wrote:

> On 30.03.19 10:22, David Touzeau wrote:
>> * Debian 9 net install + Squid compiled
>> * CentOS 7 minimal  + Squid compiled
>>
>> Same version, same compilation parameters, same Squid settings.
>> It seems that Squid on CentOS is 10 times faster than squid on Debian


> We have recompiled same squid version on 2 systems
>
> No march= using --disable-arch-native on both systems
>
> Debian config.log
> https://github.com/dtouzeau/1.6.x/blob/Tempfiles/debian9-config.log?raw=true
>
> Centos config.log
> https://github.com/dtouzeau/1.6.x/blob/Tempfiles/centos7-config.log?raw=true
>
> Result was CentOS 44% faster on TCP_MEM_HITS

Just to clarify: Did changing ./configure options alone move you from
1000% to 44%? Or was the earlier "10 times" just a crude approximation
that we should ignore now?


Do your Squids use shared memory for the memory cache? See
memory_cache_shared (even if you do not set it explicitly).
http://www.squid-cache.org/Doc/config/memory_cache_shared/

Any significant difference in mgr:info and mgr:counters output after a
test that only has memory hits?

Alex.


------------------------------

Message: 2
Date: Tue, 2 Apr 2019 01:10:37 +0000
From: ? ? <jun357572957zhao at hotmail.com>
To: Squid <squid-users at lists.squid-cache.org>
Subject: [squid-users] How to restrict the maximum negotiated version
        of squid HTTPS to TLS1.2
Message-ID:
        <CO2PR0801MB2312283C8FEAFDCC4C70C6EE98560 at CO2PR0801MB2312.namprd08.prod.outlook.com>

Content-Type: text/plain; charset="gb2312"

Hi, this is part of my squid.conf:
https_port 192.168.30.4:3129 intercept ssl-bump connection-auth=off generate-host-certificates=on dynamic_cert_mem_cache_size=4MB cert=/opt/squid/ssl_cert/CA.pem sslflags=NO_DEFAULT_CA

acl broken_sites ssl::server_name foo.com
acl ssl_step1 at_step SslBump1

ssl_bump peek ssl_step1
ssl_bump bump broken_sites
ssl_bump splice all

so how to restrict the maximum negotiated version of squid HTTPS to TLS1.2?
I also try configure like this:


https_port 192.168.30.4:3129 intercept ssl-bump connection-auth=off generate-host-certificates=on dynamic_cert_mem_cache_size=4MB cert=/opt/squid/ssl_cert/CA.pem  version=4


it did not work.

the access.log show TCP/TUNNEL 200
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20190402/92341273/attachment-0001.html>

------------------------------

Message: 3
Date: Tue, 2 Apr 2019 18:07:22 +1300
From: Amos Jeffries <squid3 at treenet.co.nz>
To: squid-users at lists.squid-cache.org
Subject: Re: [squid-users] How to restrict the maximum negotiated
        version of squid HTTPS to TLS1.2
Message-ID: <a35ce939-5eea-e965-371f-69da02a619c8 at treenet.co.nz>
Content-Type: text/plain; charset=UTF-8

On 2/04/19 2:10 pm, ? ? wrote:
> Hi, this is part of my squid.conf:
> https_port 192.168.30.4:3129 intercept ssl-bump connection-auth=off
> generate-host-certificates=on dynamic_cert_mem_cache_size=4MB
> cert=/opt/squid/ssl_cert/CA.pem sslflags=NO_DEFAULT_CA
>
> acl broken_sites ssl::server_name foo.com
> acl ssl_step1 at_step SslBump1
>
> ssl_bump peek ssl_step1
> ssl_bump bump broken_sites
> ssl_bump splice all
>
> so how to restrict the maximum negotiated version of squid HTTPS to TLS1.2?


That is not possible without patching Squid. Only versions up to TLS/1.2
can be controlled by any published Squid.


> I also try configure like this:
>
>
> https_port 192.168.30.4:3129 intercept ssl-bump connection-auth=off
> generate-host-certificates=on dynamic_cert_mem_cache_size=4MB
> cert=/opt/squid/ssl_cert/CA.pem  version=4
>
>
> it did not work.
>

The deprecated 'version=4' setting means TLS/*1.0* only.

> the access.log show TCP/TUNNEL 200
>

That indicates that the protocol arriving from the client is probably
not TLS or SSL in any form, but some other protocol. If that is true
then no matter what you set for TLS versions allowed it will always tunnel.

Amos


------------------------------

Message: 4
Date: Mon, 01 Apr 2019 22:43:38 -0700
From: L A Walsh <squid-user at tlinx.org>
To: david at articatech.com
Cc: squid-users at lists.squid-cache.org
Subject: Re: [squid-users] Why Squid on CentOS is faster than Debian ?
Message-ID: <5CA2F68A.8000009 at tlinx.org>
Content-Type: text/plain; charset=UTF-8

On 4/1/2019 2:17 AM, David Touzeau wrote:
> We have recompiled same squid version on 2 systems
> https://github.com/dtouzeau/1.6.x/blob/Tempfiles/centos7-config.log?raw=true
>
> -----------------------------------------------------------
> Result was CentOS 44% faster on TCP_MEM_HITS
> -----------------------------------------------------------
>
What kernels are the two systems running?

Are the config options exactly the same?

Just a WAG, but but are the settings for
CONFIG_TRANSPARENT_HUGEPAGE the same for both?




------------------------------

Message: 5
Date: Tue, 2 Apr 2019 09:23:16 +0200
From: David Touzeau <david at articatech.com>
To: squid-users at lists.squid-cache.org
Subject: Re: [squid-users] Why Squid on CentOS is faster than Debian ?
Message-ID: <7330fbab-1808-e217-8f7f-3f08bc2b88ab at articatech.com>
Content-Type: text/plain; charset=utf-8; format=flowed


Le 01/04/2019 ? 23:22, Alex Rousskov a ?crit :
> On 4/1/19 3:17 AM, David Touzeau wrote:
>
>> On 30.03.19 10:22, David Touzeau wrote:
>>> * Debian 9 net install + Squid compiled
>>> * CentOS 7 minimal  + Squid compiled
>>>
>>> Same version, same compilation parameters, same Squid settings.
>>> It seems that Squid on CentOS is 10 times faster than squid on Debian
>
>> We have recompiled same squid version on 2 systems
>>
>> No march= using --disable-arch-native on both systems
>>
>> Debian config.log
>> https://github.com/dtouzeau/1.6.x/blob/Tempfiles/debian9-config.log?raw=true
>>
>> Centos config.log
>> https://github.com/dtouzeau/1.6.x/blob/Tempfiles/centos7-config.log?raw=true
>>
>> Result was CentOS 44% faster on TCP_MEM_HITS
> Just to clarify: Did changing ./configure options alone move you from
> 1000% to 44%? Or was the earlier "10 times" just a crude approximation
> that we should ignore now?
>
>
> Do your Squids use shared memory for the memory cache? See
> memory_cache_shared (even if you do not set it explicitly).
> http://www.squid-cache.org/Doc/config/memory_cache_shared/
>
> Any significant difference in mgr:info and mgr:counters output after a
> test that only has memory hits?
>
> Alex.

Hi Alex and comunity

The test did not use workers

Here it is a piece of logs between the 2 machines

CentOS 7:
1554185117.132      1 172.16.1.228 50:46:5d:a0:3e:5a TCP_MEM_HIT/200
10979 GET
http://www.projetmontsaintmichel.com/upload/document/reduites/TR_BA_0611_2.jpg
- HIER_NONE/- image/jpeg
1554185117.133      1 172.16.1.228 50:46:5d:a0:3e:5a TCP_MEM_HIT/200
5531 GET
http://www.projetmontsaintmichel.com/upload/document/reduites/TR_BA_0611_5.jpg
- HIER_NONE/- image/jpeg
1554185117.134      0 172.16.1.228 50:46:5d:a0:3e:5a TCP_MEM_HIT/200
3727 GET
http://www.projetmontsaintmichel.com//upload/document/minis/capture_40.jpg
- HIER_NONE/- image/jpeg
1554185117.137      0 172.16.1.228 50:46:5d:a0:3e:5a TCP_MEM_HIT/200
1230 GET http://www.projetmontsaintmichel.com/web/images/ico_pdf.png -
HIER_NONE/- image/png
1554185117.141      1 172.16.1.228 50:46:5d:a0:3e:5a TCP_MEM_HIT/200
33600 GET
http://www.projetmontsaintmichel.com/upload/document/reduites/TR_BA_0609_6.gif
- HIER_NONE/- image/gif
1554185117.142      1 172.16.1.228 50:46:5d:a0:3e:5a TCP_MEM_HIT/200
20200 GET
http://www.projetmontsaintmichel.com/upload/document/reduites/TR_BA_0609_2.gif
- HIER_NONE/- image/gif
1554185117.144      1 172.16.1.228 50:46:5d:a0:3e:5a TCP_MEM_HIT/200
29375 GET
http://www.projetmontsaintmichel.com/upload/document/reduites/TR_BA_0609_5.gif
- HIER_NONE/- image/gif
1554185117.146      1 172.16.1.228 50:46:5d:a0:3e:5a TCP_MEM_HIT/200
29835 GET
http://www.projetmontsaintmichel.com/upload/document/reduites/TR_BA_0609_4.gif
- HIER_NONE/- image/gif
1554185117.147      2 172.16.1.228 50:46:5d:a0:3e:5a TCP_MEM_HIT/200
28683 GET
http://www.projetmontsaintmichel.com/upload/document/reduites/TR_BA_0609_1.gif
- HIER_NONE/- image/gif
1554185117.149      1 172.16.1.228 50:46:5d:a0:3e:5a TCP_MEM_HIT/200
7715 GET
http://www.projetmontsaintmichel.com/upload/document/reduites/TR_BA_0608_3.jpg
- HIER_NONE/- image/jpeg
1554185117.151      0 172.16.1.228 50:46:5d:a0:3e:5a TCP_MEM_HIT/200
8175 GET
http://www.projetmontsaintmichel.com/upload/document/reduites/TR_BA_0608_2.jpg
- HIER_NONE/- image/jpeg
1554185117.152      0 172.16.1.228 50:46:5d:a0:3e:5a TCP_MEM_HIT/200
2519 GET
http://www.projetmontsaintmichel.com/web/images/bloc_infoschantier2.gif
- HIER_NONE/- image/gif
1554185117.153      0 172.16.1.228 50:46:5d:a0:3e:5a TCP_MEM_HIT/200
3870 GET
http://www.projetmontsaintmichel.com/web/images/bloc_espacepro2.gif -
HIER_NONE/- image/gif
1554185117.157      0 172.16.1.228 50:46:5d:a0:3e:5a TCP_MEM_HIT/200
9349 GET
http://www.projetmontsaintmichel.com/upload/document/reduites/TR_BA_0608_1.jpg
- HIER_NONE/- image/jpeg
1554185117.162      0 172.16.1.228 50:46:5d:a0:3e:5a TCP_MEM_HIT/200
3622 GET
http://www.projetmontsaintmichel.com//upload/document/minis/capture_29.jpg
- HIER_NONE/- image/jpeg
1554185117.162      1 172.16.1.228 50:46:5d:a0:3e:5a TCP_MEM_HIT/200 409
GET
http://www.projetmontsaintmichel.com/web/images/puce_carre_visite.gif -
HIER_NONE/- image/gif
1554185117.162      1 172.16.1.228 50:46:5d:a0:3e:5a TCP_MEM_HIT/200 409
GET http://www.projetmontsaintmichel.com/web/images/puce_carre_gris.gif
- HIER_NONE/- image/gif
1554185117.175      1 172.16.1.228 50:46:5d:a0:3e:5a TCP_MEM_HIT/200
23219 GET
http://www.projetmontsaintmichel.com/web/images/fond_footer.jpg -
HIER_NONE/- image/jpeg
1554185117.187      0 172.16.1.228 50:46:5d:a0:3e:5a TCP_MEM_HIT/200 540
GET http://www.projetmontsaintmichel.com/web/galerie/images/overlay.png
- HIER_NONE/- image/png
1554185117.389      2 172.16.1.228 50:46:5d:a0:3e:5a TCP_MEM_HIT/200 858
GET http://www.projetmontsaintmichel.com/favicon.ico - HIER_NONE/-
image/x-icon

Debian 9:
1554185129.651      1 172.16.1.228 50:46:5d:a0:3e:5a TCP_MEM_HIT/200
8887 GET
http://www.projetmontsaintmichel.com/upload/document/reduites/TR_BA_0611_1.jpg
- HIER_NONE/- image/jpeg
1554185129.660      5 172.16.1.228 50:46:5d:a0:3e:5a TCP_MEM_HIT/200
8733 GET
http://www.projetmontsaintmichel.com/upload/document/reduites/TR_BA_0611_4.jpg
- HIER_NONE/- image/jpeg
1554185129.664      1 172.16.1.228 50:46:5d:a0:3e:5a TCP_MEM_HIT/200
5565 GET
http://www.projetmontsaintmichel.com/upload/document/reduites/TR_BA_0611_5.jpg
- HIER_NONE/- image/jpeg
1554185129.664      1 172.16.1.228 50:46:5d:a0:3e:5a TCP_MEM_HIT/200
11013 GET
http://www.projetmontsaintmichel.com/upload/document/reduites/TR_BA_0611_2.jpg
- HIER_NONE/- image/jpeg
1554185129.665      2 172.16.1.228 50:46:5d:a0:3e:5a TCP_MEM_HIT/200
3761 GET
http://www.projetmontsaintmichel.com//upload/document/minis/capture_40.jpg
- HIER_NONE/- image/jpeg
1554185129.665      1 172.16.1.228 50:46:5d:a0:3e:5a TCP_MEM_HIT/200
1264 GET http://www.projetmontsaintmichel.com/web/images/ico_pdf.png -
HIER_NONE/- image/png
1554185129.677     12 172.16.1.228 50:46:5d:a0:3e:5a TCP_MEM_HIT/200
33634 GET
http://www.projetmontsaintmichel.com/upload/document/reduites/TR_BA_0609_6.gif
- HIER_NONE/- image/gif
1554185129.677      2 172.16.1.228 50:46:5d:a0:3e:5a TCP_MEM_HIT/200
7749 GET
http://www.projetmontsaintmichel.com/upload/document/reduites/TR_BA_0608_3.jpg
- HIER_NONE/- image/jpeg
1554185129.677      4 172.16.1.228 50:46:5d:a0:3e:5a TCP_MEM_HIT/200
20234 GET
http://www.projetmontsaintmichel.com/upload/document/reduites/TR_BA_0609_2.gif
- HIER_NONE/- image/gif
1554185129.678      4 172.16.1.228 50:46:5d:a0:3e:5a TCP_MEM_HIT/200
28717 GET
http://www.projetmontsaintmichel.com/upload/document/reduites/TR_BA_0609_1.gif
- HIER_NONE/- image/gif
1554185129.678      4 172.16.1.228 50:46:5d:a0:3e:5a TCP_MEM_HIT/200
29869 GET
http://www.projetmontsaintmichel.com/upload/document/reduites/TR_BA_0609_4.gif
- HIER_NONE/- image/gif
1554185129.678      4 172.16.1.228 50:46:5d:a0:3e:5a TCP_MEM_HIT/200
29409 GET
http://www.projetmontsaintmichel.com/upload/document/reduites/TR_BA_0609_5.gif
- HIER_NONE/- image/gif
1554185129.688      3 172.16.1.228 50:46:5d:a0:3e:5a TCP_MEM_HIT/200
8209 GET
http://www.projetmontsaintmichel.com/upload/document/reduites/TR_BA_0608_2.jpg
- HIER_NONE/- image/jpeg
1554185129.691      2 172.16.1.228 50:46:5d:a0:3e:5a TCP_MEM_HIT/200
9383 GET
http://www.projetmontsaintmichel.com/upload/document/reduites/TR_BA_0608_1.jpg
- HIER_NONE/- image/jpeg
1554185129.692      1 172.16.1.228 50:46:5d:a0:3e:5a TCP_MEM_HIT/200
3656 GET
http://www.projetmontsaintmichel.com//upload/document/minis/capture_29.jpg
- HIER_NONE/- image/jpeg
1554185129.694      1 172.16.1.228 50:46:5d:a0:3e:5a TCP_MEM_HIT/200 443
GET
http://www.projetmontsaintmichel.com/web/images/puce_carre_visite.gif -
HIER_NONE/- image/gif
1554185129.694      1 172.16.1.228 50:46:5d:a0:3e:5a TCP_MEM_HIT/200 443
GET http://www.projetmontsaintmichel.com/web/images/puce_carre_gris.gif
- HIER_NONE/- image/gif
1554185129.700      3 172.16.1.228 50:46:5d:a0:3e:5a TCP_MEM_HIT/200 574
GET http://www.projetmontsaintmichel.com/web/galerie/images/overlay.png
- HIER_NONE/- image/png
1554185129.701      3 172.16.1.228 50:46:5d:a0:3e:5a TCP_MEM_HIT/200
23253 GET
http://www.projetmontsaintmichel.com/web/images/fond_footer.jpg -
HIER_NONE/- image/jpeg
1554185129.857      1 172.16.1.228 50:46:5d:a0:3e:5a TCP_MEM_HIT/200 892
GET http://www.projetmontsaintmichel.com/favicon.ico - HIER_NONE/-
image/x-icon


CentOS :
     total: 14msec
     average: 0.7msec

Debian :
     total: 56msec
     average: 2.8msec

CentOS vs Debian: 400% faster with CentOS

Do you know why CentOS objects are 34 bytes smaller than Debian ?





> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users


------------------------------

Subject: Digest Footer

_______________________________________________
squid-users mailing list
squid-users at lists.squid-cache.org
http://lists.squid-cache.org/listinfo/squid-users


------------------------------

End of squid-users Digest, Vol 56, Issue 3
******************************************
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20190402/a470d67d/attachment.htm>

From jun357572957zhao at hotmail.com  Tue Apr  2 08:35:31 2019
From: jun357572957zhao at hotmail.com (=?gb2312?B?1dQgv6E=?=)
Date: Tue, 2 Apr 2019 08:35:31 +0000
Subject: [squid-users] How can squid 4.5 be configured to support TLS1.3
Message-ID: <CO2PR0801MB2312A60174BBA5D8F32B6BAF98560@CO2PR0801MB2312.namprd08.prod.outlook.com>

Because squid 4.5 with the configuration like this can not bump TLS1.3.

https_port 192.168.30.4:3129 intercept ssl-bump connection-auth=off generate-host-certificates=on dynamic_cert_mem_cache_size=4MB cert=/opt/squid/ssl_cert/CA.pem sslflags=NO_DEFAULT_CA

acl broken_sites ssl::server_name google.com
acl ssl_step1 at_step SslBump1

ssl_bump peek ssl_step1
ssl_bump bump broken_sites
ssl_bump splice all


How can squid 4.5 be configured to support TLS1.3 .


If not , how can i configure  squid4.5  which negotiate TLS version with a tls1.3-enabled webserver to restrict the TLS version below 1.2
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20190402/a24bb2a0/attachment.htm>

From squid3 at treenet.co.nz  Tue Apr  2 08:39:35 2019
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Tue, 2 Apr 2019 21:39:35 +1300
Subject: [squid-users] Why Squid on CentOS is faster than Debian ?
In-Reply-To: <vmime.5ca31502.51b3.2578070e6b172822@ms249-lin-003.rotterdam.bazuin.nl>
References: <5CA2F68A.8000009@tlinx.org>
 <vmime.5ca31502.51b3.2578070e6b172822@ms249-lin-003.rotterdam.bazuin.nl>
Message-ID: <fcfc55fa-6d01-2d8a-da55-d75a56463d4b@treenet.co.nz>

On 2/04/19 8:53 pm, L.P.H. van Belle wrote:
> I suggest start compairing the logs you posted, the builds are really different. 
> 
> Differences in 
> - kernel
> - needed packages
> - build paramaters due to missing or different packages.
> Etc. 
> 
> Just diff you logs and you will see it. 
> 

The biggest there is C++11 support being enabled on CentOS. That alone
enables quite a few performance optimizations in the stdlib template code.

Amos


From Ralf.Hildebrandt at charite.de  Tue Apr  2 09:51:57 2019
From: Ralf.Hildebrandt at charite.de (Ralf Hildebrandt)
Date: Tue, 2 Apr 2019 11:51:57 +0200
Subject: [squid-users] Squid-5 vs. FTP:// URLs
Message-ID: <20190402095154.cwfo3izzir5vnuvy@charite.de>

Currently I'm trying to channel ftp:// style URLs through our squid-5.
In general this is working ok, but:

ftp directory listings are DOWNLOADED instead of being displayed (in Chrome 73.0.x -- in Firefox Quantum 67.0b6 this works)
It's probably related to this: https://www.bleepingcomputer.com/news/google/chrome-and-firefox-developers-aim-to-remove-support-for-ftp/

The URL scheme is ftp://, the data returned by the proxy is text/html,
and since that's the case, the data is being downloaded instead of
being displayed directly.

Is there any way around this?

-- 
Ralf Hildebrandt                   Charite Universit?tsmedizin Berlin
ralf.hildebrandt at charite.de        Campus Benjamin Franklin
https://www.charite.de             Hindenburgdamm 30, 12203 Berlin
Gesch?ftsbereich IT, Abt. Netzwerk fon: +49-30-450.570.155


From squid3 at treenet.co.nz  Tue Apr  2 10:25:48 2019
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Tue, 2 Apr 2019 23:25:48 +1300
Subject: [squid-users] Squid-5 vs. FTP:// URLs
In-Reply-To: <20190402095154.cwfo3izzir5vnuvy@charite.de>
References: <20190402095154.cwfo3izzir5vnuvy@charite.de>
Message-ID: <d503422f-e2d1-f9ee-6ea6-567dee0cd901@treenet.co.nz>

On 2/04/19 10:51 pm, Ralf Hildebrandt wrote:
> Currently I'm trying to channel ftp:// style URLs through our squid-5.
> In general this is working ok, but:
> 
> ftp directory listings are DOWNLOADED instead of being displayed (in Chrome 73.0.x -- in Firefox Quantum 67.0b6 this works)
> It's probably related to this: https://www.bleepingcomputer.com/news/google/chrome-and-firefox-developers-aim-to-remove-support-for-ftp/
> 
> The URL scheme is ftp://, the data returned by the proxy is text/html,
> and since that's the case, the data is being downloaded instead of
> being displayed directly.

You will have to take that up with the Browse folks. They are the ones
who broke their software.

> 
> Is there any way around this?
> 

No. Both the request and response are in HTTP(S) protocol. The scheme of
the URL has nothing to do with what the client / Browser should be
doing. If they are imparting any special behaviour due to scheme that is
entirely artificial on their part.

Amos


From uhlar at fantomas.sk  Tue Apr  2 13:17:17 2019
From: uhlar at fantomas.sk (Matus UHLAR - fantomas)
Date: Tue, 2 Apr 2019 15:17:17 +0200
Subject: [squid-users] Why Squid on CentOS is faster than Debian ?
In-Reply-To: <fcfc55fa-6d01-2d8a-da55-d75a56463d4b@treenet.co.nz>
References: <5CA2F68A.8000009@tlinx.org>
 <vmime.5ca31502.51b3.2578070e6b172822@ms249-lin-003.rotterdam.bazuin.nl>
 <fcfc55fa-6d01-2d8a-da55-d75a56463d4b@treenet.co.nz>
Message-ID: <20190402131717.GD17883@fantomas.sk>

>On 2/04/19 8:53 pm, L.P.H. van Belle wrote:
>> I suggest start compairing the logs you posted, the builds are really different.
>>
>> Differences in
>> - kernel
>> - needed packages
>> - build paramaters due to missing or different packages.
>> Etc.
>>
>> Just diff you logs and you will see it.

On 02.04.19 21:39, Amos Jeffries wrote:
>The biggest there is C++11 support being enabled on CentOS. That alone
>enables quite a few performance optimizations in the stdlib template code.

it looks to me that on debian it's by default, while on centos it needs -std=c++11
-- 
Matus UHLAR - fantomas, uhlar at fantomas.sk ; http://www.fantomas.sk/
Warning: I wish NOT to receive e-mail advertising to this address.
Varovanie: na tuto adresu chcem NEDOSTAVAT akukolvek reklamnu postu.
Boost your system's speed by 500% - DEL C:\WINDOWS\*.*


From rousskov at measurement-factory.com  Tue Apr  2 15:39:46 2019
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Tue, 2 Apr 2019 09:39:46 -0600
Subject: [squid-users] Squid-5 vs. FTP:// URLs
In-Reply-To: <20190402095154.cwfo3izzir5vnuvy@charite.de>
References: <20190402095154.cwfo3izzir5vnuvy@charite.de>
Message-ID: <83742c5e-010a-aa8d-2e64-0cb0e69e6561@measurement-factory.com>

On 4/2/19 3:51 AM, Ralf Hildebrandt wrote:
> ftp directory listings are DOWNLOADED instead of being displayed (in Chrome 73.0.x -- in Firefox Quantum 67.0b6 this works)
> It's probably related to this: https://www.bleepingcomputer.com/news/google/chrome-and-firefox-developers-aim-to-remove-support-for-ftp/
> 
> The URL scheme is ftp://, the data returned by the proxy is text/html,
> and since that's the case, the data is being downloaded instead of
> being displayed directly.
> 
> Is there any way around this?

Based on the above URL alone, the browsers wanted to continue rendering
FTP directory indexes.

* If browsers still render FTP directory indexes without Squid, but stop
rendering them with Squid, then either we can adjust Squid to play along
or they need to improve their proxy support. More information is needed
to distinguish those two possible outcomes.

* Otherwise, see Amos response. TLDR: Squid is at the browsers mercy.

Alex.


From rousskov at measurement-factory.com  Tue Apr  2 16:06:08 2019
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Tue, 2 Apr 2019 10:06:08 -0600
Subject: [squid-users] Why Squid on CentOS is faster than Debian ?
In-Reply-To: <7330fbab-1808-e217-8f7f-3f08bc2b88ab@articatech.com>
References: <066e5172-ab3e-3095-98e0-59891b3397b0@articatech.com>
 <20190330120546.GA29173@fantomas.sk>
 <594ce52d-78c0-6593-cd51-7edf719978d4@articatech.com>
 <5d6ef032-46ee-d4fa-a734-710a6341788c@treenet.co.nz>
 <11154c61-dd09-99d3-e07e-a505d72ba81b@articatech.com>
 <c6d83524-a044-3e6d-35fe-88232ec242fb@articatech.com>
 <31bb34b4-9c61-68cd-78df-51b8630c446d@measurement-factory.com>
 <7330fbab-1808-e217-8f7f-3f08bc2b88ab@articatech.com>
Message-ID: <2d6e5b11-6955-0486-5663-8d1980954645@measurement-factory.com>

On 4/2/19 1:23 AM, David Touzeau wrote:
> Le 01/04/2019 ? 23:22, Alex Rousskov a ?crit?:
>> Do your Squids use shared memory for the memory cache? See
>> memory_cache_shared (even if you do not set it explicitly).
>> http://www.squid-cache.org/Doc/config/memory_cache_shared/

> The test did not use workers

That does not answer my question. Do you use Rock cache_dir(s)?


>> Any significant difference in mgr:info and mgr:counters output after a
>> test that only has memory hits?

The question still stands. I would recommend testing this with a single
URL and a fixed/same number of requests submitted by a reliable proxy
benchmarking tool or at least a wget/curl script.


> Do you know why CentOS objects are 34 bytes smaller than Debian ?

Something in your test setup or environment results responses (or
response delivery statistics) that differ in size between the tests. I
do not know what it is, and the number of possible options is too large
to guess correctly: It could be anything from 32-vs-64 bit OSes, to
locale differences, to Squid host name, to Cookies, to test setup
imperfections, to Squid statistics collection bugs, etc., etc.

Have you compared the responses received by the client (headers and
all)? Do they differ by 34 bytes? I suggest testing with a single URL
that produces different results and then digging down to identify the
difference (starting with comparing responses).

Alex.


From david at articatech.com  Tue Apr  2 22:00:44 2019
From: david at articatech.com (David Touzeau)
Date: Wed, 3 Apr 2019 00:00:44 +0200
Subject: [squid-users] Why Squid on CentOS is faster than Debian ?
In-Reply-To: <2d6e5b11-6955-0486-5663-8d1980954645@measurement-factory.com>
References: <066e5172-ab3e-3095-98e0-59891b3397b0@articatech.com>
 <20190330120546.GA29173@fantomas.sk>
 <594ce52d-78c0-6593-cd51-7edf719978d4@articatech.com>
 <5d6ef032-46ee-d4fa-a734-710a6341788c@treenet.co.nz>
 <11154c61-dd09-99d3-e07e-a505d72ba81b@articatech.com>
 <c6d83524-a044-3e6d-35fe-88232ec242fb@articatech.com>
 <31bb34b4-9c61-68cd-78df-51b8630c446d@measurement-factory.com>
 <7330fbab-1808-e217-8f7f-3f08bc2b88ab@articatech.com>
 <2d6e5b11-6955-0486-5663-8d1980954645@measurement-factory.com>
Message-ID: <d1805d96-9cf7-079b-cbd7-23c4638c08b9@articatech.com>


Le 02/04/2019 ? 18:06, Alex Rousskov a ?crit?:
> On 4/2/19 1:23 AM, David Touzeau wrote:
>> Le 01/04/2019 ? 23:22, Alex Rousskov a ?crit?:
>>> Do your Squids use shared memory for the memory cache? See
>>> memory_cache_shared (even if you do not set it explicitly).
>>> http://www.squid-cache.org/Doc/config/memory_cache_shared/
>> The test did not use workers
> That does not answer my question. Do you use Rock cache_dir(s)?
>
>
>>> Any significant difference in mgr:info and mgr:counters output after a
>>> test that only has memory hits?
> The question still stands. I would recommend testing this with a single
> URL and a fixed/same number of requests submitted by a reliable proxy
> benchmarking tool or at least a wget/curl script.
>
>
>> Do you know why CentOS objects are 34 bytes smaller than Debian ?
> Something in your test setup or environment results responses (or
> response delivery statistics) that differ in size between the tests. I
> do not know what it is, and the number of possible options is too large
> to guess correctly: It could be anything from 32-vs-64 bit OSes, to
> locale differences, to Squid host name, to Cookies, to test setup
> imperfections, to Squid statistics collection bugs, etc., etc.
>
> Have you compared the responses received by the client (headers and
> all)? Do they differ by 34 bytes? I suggest testing with a single URL
> that produces different results and then digging down to identify the
> difference (starting with comparing responses).
>
> Alex.

Thanks Alex for these ways to investigate.

We will try to get more precise for the tests

We have reduced the squid.conf to the minimal way in order to be sure 
that nothing can disturb testing.

Only one cache, no rock, no workers, no tuning

Amos says that perhaps the C++ version can make some tweaks in this case 
we will start to do the same tests with Ubuntu that uses the most recent 
kernels and C++

But for the moment

- without intelligence
- Without investigations efforts
- Just by compiling squid

To resume

Centos 7 is 10 times faster than Debian 7
Centos 7 is 400%? faster than Debian 9

Debian 9 is a? little faster than Debian 7

We will keep updated for Unbuntu.







From squid3 at treenet.co.nz  Wed Apr  3 04:57:45 2019
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Wed, 3 Apr 2019 17:57:45 +1300
Subject: [squid-users] Why Squid on CentOS is faster than Debian ?
In-Reply-To: <d1805d96-9cf7-079b-cbd7-23c4638c08b9@articatech.com>
References: <066e5172-ab3e-3095-98e0-59891b3397b0@articatech.com>
 <20190330120546.GA29173@fantomas.sk>
 <594ce52d-78c0-6593-cd51-7edf719978d4@articatech.com>
 <5d6ef032-46ee-d4fa-a734-710a6341788c@treenet.co.nz>
 <11154c61-dd09-99d3-e07e-a505d72ba81b@articatech.com>
 <c6d83524-a044-3e6d-35fe-88232ec242fb@articatech.com>
 <31bb34b4-9c61-68cd-78df-51b8630c446d@measurement-factory.com>
 <7330fbab-1808-e217-8f7f-3f08bc2b88ab@articatech.com>
 <2d6e5b11-6955-0486-5663-8d1980954645@measurement-factory.com>
 <d1805d96-9cf7-079b-cbd7-23c4638c08b9@articatech.com>
Message-ID: <e17ab906-7cf9-8704-afb4-7a85120596be@treenet.co.nz>



On 3/04/19 11:00 am, David Touzeau wrote:
> 
> Le 02/04/2019 ? 18:06, Alex Rousskov a ?crit?:
>> On 4/2/19 1:23 AM, David Touzeau wrote:
>>> Le 01/04/2019 ? 23:22, Alex Rousskov a ?crit?:
>>>> Do your Squids use shared memory for the memory cache? See
>>>> memory_cache_shared (even if you do not set it explicitly).
>>>> http://www.squid-cache.org/Doc/config/memory_cache_shared/
>>> The test did not use workers
>> That does not answer my question. Do you use Rock cache_dir(s)?
>>
>>
>>>> Any significant difference in mgr:info and mgr:counters output after a
>>>> test that only has memory hits?
>> The question still stands. I would recommend testing this with a single
>> URL and a fixed/same number of requests submitted by a reliable proxy
>> benchmarking tool or at least a wget/curl script.
>>
>>
>>> Do you know why CentOS objects are 34 bytes smaller than Debian ?
>> Something in your test setup or environment results responses (or
>> response delivery statistics) that differ in size between the tests. I
>> do not know what it is, and the number of possible options is too large
>> to guess correctly: It could be anything from 32-vs-64 bit OSes, to
>> locale differences, to Squid host name, to Cookies, to test setup
>> imperfections, to Squid statistics collection bugs, etc., etc.
>>
>> Have you compared the responses received by the client (headers and
>> all)? Do they differ by 34 bytes? I suggest testing with a single URL
>> that produces different results and then digging down to identify the
>> difference (starting with comparing responses).
>>
>> Alex.
> 
> Thanks Alex for these ways to investigate.
> 
> We will try to get more precise for the tests
> 
> We have reduced the squid.conf to the minimal way in order to be sure
> that nothing can disturb testing.
> 
> Only one cache, no rock, no workers, no tuning
> 
> Amos says that perhaps the C++ version can make some tweaks in this case
> we will start to do the same tests with Ubuntu that uses the most recent
> kernels and C++
> 
> But for the moment
> 
> - without intelligence
> - Without investigations efforts
> - Just by compiling squid
> 
> To resume
> 
> Centos 7 is 10 times faster than Debian 7
> Centos 7 is 400%? faster than Debian 9
> 
> Debian 9 is a? little faster than Debian 7
> 


Can you provide the same numbers for Deb 7 that you did for Deb 9 ? so
we can see what exactly "a little faster" means.

PS. your first post which said "10 times faster" also said it was for
"Debian 9 net install" - no Debian 7.


> We will keep updated for Unbuntu.
> 

Thanks.


Amos


From squid3 at treenet.co.nz  Wed Apr  3 05:00:28 2019
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Wed, 3 Apr 2019 18:00:28 +1300
Subject: [squid-users] How to restrict the maximum negotiated version of
 squid HTTPS to TLS1.2
In-Reply-To: <a35ce939-5eea-e965-371f-69da02a619c8@treenet.co.nz>
References: <CO2PR0801MB2312283C8FEAFDCC4C70C6EE98560@CO2PR0801MB2312.namprd08.prod.outlook.com>
 <a35ce939-5eea-e965-371f-69da02a619c8@treenet.co.nz>
Message-ID: <0cb17416-2e6e-72b8-9a48-b24e8c613887@treenet.co.nz>

On 2/04/19 6:07 pm, Amos Jeffries wrote:
> On 2/04/19 2:10 pm, ? ? wrote:
>> Hi, this is part of my squid.conf:
>> https_port 192.168.30.4:3129 intercept ssl-bump connection-auth=off
>> generate-host-certificates=on dynamic_cert_mem_cache_size=4MB
>> cert=/opt/squid/ssl_cert/CA.pem sslflags=NO_DEFAULT_CA?
>>
>> acl broken_sites ssl::server_name foo.com?
>> acl ssl_step1 at_step SslBump1
>>
>> ssl_bump peek ssl_step1
>> ssl_bump bump broken_sites
>> ssl_bump splice all
>>
>> so how to restrict the maximum negotiated version of squid HTTPS to TLS1.2?
> 
> 
> That is not possible without patching Squid. Only versions up to TLS/1.2
> can be controlled by any published Squid.
> 

You could try configuring your OpenSSL not to use TLS/1.3.

<http://openssl.6102.n7.nabble.com/How-to-disable-TLS-1-3-in-OpenSSL-1-1-1-td76300.html>

Amos


From uhlar at fantomas.sk  Wed Apr  3 07:14:34 2019
From: uhlar at fantomas.sk (Matus UHLAR - fantomas)
Date: Wed, 3 Apr 2019 09:14:34 +0200
Subject: [squid-users] Why Squid on CentOS is faster than Debian ?
In-Reply-To: <d1805d96-9cf7-079b-cbd7-23c4638c08b9@articatech.com>
References: <066e5172-ab3e-3095-98e0-59891b3397b0@articatech.com>
 <20190330120546.GA29173@fantomas.sk>
 <594ce52d-78c0-6593-cd51-7edf719978d4@articatech.com>
 <5d6ef032-46ee-d4fa-a734-710a6341788c@treenet.co.nz>
 <11154c61-dd09-99d3-e07e-a505d72ba81b@articatech.com>
 <c6d83524-a044-3e6d-35fe-88232ec242fb@articatech.com>
 <31bb34b4-9c61-68cd-78df-51b8630c446d@measurement-factory.com>
 <7330fbab-1808-e217-8f7f-3f08bc2b88ab@articatech.com>
 <2d6e5b11-6955-0486-5663-8d1980954645@measurement-factory.com>
 <d1805d96-9cf7-079b-cbd7-23c4638c08b9@articatech.com>
Message-ID: <20190403071434.GA16782@fantomas.sk>

On 03.04.19 00:00, David Touzeau wrote:
>Thanks Alex for these ways to investigate.
>
>We will try to get more precise for the tests
>
>We have reduced the squid.conf to the minimal way in order to be sure 
>that nothing can disturb testing.
>
>Only one cache, no rock, no workers, no tuning
>
>Amos says that perhaps the C++ version can make some tweaks in this 
>case we will start to do the same tests with Ubuntu that uses the most 
>recent kernels and C++
>
>But for the moment
>
>- without intelligence
>- Without investigations efforts
>- Just by compiling squid
>
>To resume
>
>Centos 7 is 10 times faster than Debian 7
>Centos 7 is 400%? faster than Debian 9
>
>Debian 9 is a? little faster than Debian 7
>
>We will keep updated for Unbuntu.

could you post the config(s) used somewhere?

so we could look for anything suspicious.
I assume squid doesn't have diferent defaults for different OSes or
configure results.
-- 
Matus UHLAR - fantomas, uhlar at fantomas.sk ; http://www.fantomas.sk/
Warning: I wish NOT to receive e-mail advertising to this address.
Varovanie: na tuto adresu chcem NEDOSTAVAT akukolvek reklamnu postu.
LSD will make your ECS screen display 16.7 million colors


From lukasycas at gmail.com  Thu Apr  4 01:16:54 2019
From: lukasycas at gmail.com (=?UTF-8?Q?Lukas_Y=C4=8Das?=)
Date: Thu, 4 Apr 2019 04:16:54 +0300
Subject: [squid-users] external acl helper for URI lookups from database
Message-ID: <CAJNHcRMPqXS=7RgrZJSf2FdjqGFmPsY99BPJu-8wXuHDndjGXQ@mail.gmail.com>

Hello,

Very big fan of Squid software, trying to get to know it better.

A current use case of mine that I require is would be for squid to be able
to block as it currently does via acl url_regex badurl, just that not from
a string inside the configuration file or a file containing the strings on
the OS, but from a MySQL database. (Imagine a simple table = sites, with
rows = badurl1, badurl2, badurl3. If client matches badurl1 they get
blockpage)

1.1) Would this be possible?
1.2) Would this be ''efficient''? (imagining a lot of various traffic and
for each one querying the DB)

And another question -
I'm attempting to write a prototype for a helper in python

ext_py_acl:
#!/usr/bin/python

import sys

while True:
    line = sys.stdin.readline()
    if (line.find("badstring") == -1):
        sys.stdout.write( 'ERR\n' )
    else:
sys.stdout.write( 'OK\n' )

squid.conf:
external_acl_type blockscript %URI /usr/local/squid/libexec/ext_py_acl

2.1) When running this not with squid I pass random strings and it gives me
OK via stdout and if i pass on something with 'badstring' I receive an ERR
- according to all the docs i've read - should work on squid.
What actually happens is the helper processes begin spawning, 1/5, then
another 1/5, until they fill up to 5/5 (tried setting max to 50 - they
filled up to 50) and seem to somehow hang.
When passing -k shutdown to squid I see some weird gibberish logs e.g.:
[Errno 32] Broken pipe[Errno 32] Broken pipesys.stdout.write( 'ERR\n' )

Could someone advise on how to troubleshoot this further and get the
helpers running? Or is there something im lacking here?

Regards,
Lukas
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20190404/0e35311c/attachment.htm>

From squid3 at treenet.co.nz  Thu Apr  4 05:46:14 2019
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Thu, 4 Apr 2019 18:46:14 +1300
Subject: [squid-users] external acl helper for URI lookups from database
In-Reply-To: <CAJNHcRMPqXS=7RgrZJSf2FdjqGFmPsY99BPJu-8wXuHDndjGXQ@mail.gmail.com>
References: <CAJNHcRMPqXS=7RgrZJSf2FdjqGFmPsY99BPJu-8wXuHDndjGXQ@mail.gmail.com>
Message-ID: <d5c516ae-6af1-8280-2b29-96b832441329@treenet.co.nz>

On 4/04/19 2:16 pm, Lukas Y?as wrote:
> Hello,
> 
> Very big fan of Squid software, trying to get to know it better.
> 
> A current use case of mine that I require is would be for squid to be
> able to block as it currently does via acl url_regex badurl, just that
> not from a string inside the configuration file or a file containing the
> strings on the OS, but from a MySQL database. (Imagine a simple table =
> sites, with rows = badurl1, badurl2, badurl3. If client matches badurl1
> they get blockpage)
> 
> 1.1) Would this be possible??
> 1.2) Would this be ''efficient''? (imagining a lot of various traffic
> and for each one querying the DB)
> 
> And another question -?
> I'm attempting to write a prototype for a helper in python
> 
> ext_py_acl:
> #!/usr/bin/python
> 
> import sys
> 
> while True:
> ? ? line = sys.stdin.readline()
> ? ? if (line.find("badstring") == -1):
> ? ? ? ? sys.stdout.write( 'ERR\n' )
> ? ? else:
> sys.stdout.write( 'OK\n' )
> 
> squid.conf:
> external_acl_type blockscript %URI /usr/local/squid/libexec/ext_py_acl?
> ?

And the config that actually uses this helper?


> 2.1) When running this not with squid I pass random strings and it gives
> me OK via stdout and if i pass on something with 'badstring' I receive
> an ERR - according to all the docs i've read - should work on squid.
> What actually happens is the helper processes begin spawning, 1/5, then
> another 1/5, until they fill up to 5/5 (tried setting max to 50 - they
> filled up to 50) and seem to somehow hang. 

Waiting for more input like it should be? or actually stuck?

Python has some known issues with I/O which make it tricky to use properly.
 <https://wiki.squid-cache.org/Features/AddonHelpers#What_language_are_helper_meant_to_be_written_in.3F>


> When passing -k shutdown to squid I see some weird gibberish logs e.g.:
> [Errno 32] Broken pipe[Errno 32] Broken pipesys.stdout.write( 'ERR\n' )
> 

Because "True" is still true even after Squid shutdown closes the
helper's stdin.

You need a condition to exit the while loop when stdin is closed.


> Could someone advise on how to troubleshoot this further and get the
> helpers running? Or is there something im lacking here?
> 

Consider using the ext_SQL_session_acl helper. With minor adjustments to
the squid.conf it can be used to lookup *anything* in an SQL database.

Amos


From davide.belloni at gmail.com  Thu Apr  4 09:11:38 2019
From: davide.belloni at gmail.com (Davide Belloni)
Date: Thu, 4 Apr 2019 11:11:38 +0200
Subject: [squid-users] Squid 4 ssl_bump issue
Message-ID: <CAPaB35=B6+hbYDMGC3BZXVhO8UVOg=zxdFswv--av3zHHb+aCg@mail.gmail.com>

Hi,
I've a problem in Ubuntu 18.04.2 with Squid 4.6 compiled with OpenSSL 1.1
about ssl_bump. The same configuration works in Squid 3.5 and OpenSSL 1.0

Here the relevant conf :

...
http_port 3128 ssl-bump options=ALL:NO_SSLv3 connection-auth=off
generate-host-certificates=off cert=/etc/squid/squidCA.pem

# Not bypass server certificate validation errors
sslproxy_cert_error deny all
# This one return errors with debian on GCP (
https://wiki.squid-cache.org/KnowledgeBase/HostHeaderForgery)
host_verify_strict off

sslproxy_session_cache_size 0

acl step1 at_step SslBump1
acl step2 at_step SslBump2
acl step3 at_step SslBump3

ssl_bump peek step1 all
ssl_bump peek step2 all

# API Google
acl api_google_urls url_regex
^(https?:\/\/)?.*\.googleapis\.com(:443)?($|\/)
acl api_google_urls url_regex ^(https?:\/\/)?.*\.google\.com(:443)?($|\/)
acl api_google_urls url_regex
^(https?:\/\/)?.*\.cloud\.google\.com(:443)?($|\/)
acl api_google_urls url_regex
^(https:\/\/)?([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})
acl api_google_ssl ssl::server_name_regex .*\.googleapis\.com
acl api_google_ssl ssl::server_name_regex .*\.google\.com
acl api_google_ssl ssl::server_name_regex .*\.cloud\.google\.com
acl api_google_ips src 127.0.0.1/32

http_access allow api_google_ips api_google_urls
ssl_bump splice step3 api_google_ips api_google_ssl

http_access deny all
ssl_bump terminate step3 all
...


To compile and install squid I use this script:

# set squid version
> export SQUID_VER="4.6"
> export SQUID_PKG="${SQUID_VER}-2"
> sudo apt-get -y install libssl-dev devscripts build-essential fakeroot
> dpkg-dev
> sudo apt-get -y install libcppunit-dev libsasl2-dev libxml2-dev
> libkrb5-dev \
>     libdb-dev libnetfilter-conntrack-dev libexpat1-dev libcap2-dev
> libldap2-dev \
>     libpam0g-dev libgnutls28-dev libssl-dev libdbi-perl libecap3
> libecap3-dev \
>     ed libltdl-dev cdbs debhelper dh-apparmor
> # we will be working in a subfolder make it
> mkdir -p build/squid
> # decend into working directory
> pushd build/squid
> curl --tlsv1.1 -sSO
> http://cdn-fastly.deb.debian.org/debian/pool/main/s/squid/squid_${SQUID_PKG}.dsc
> curl --tlsv1.1 -sSO
> http://cdn-fastly.deb.debian.org/debian/pool/main/s/squid/squid_${SQUID_VER}.orig.tar.gz
> curl --tlsv1.1 -sSO
> http://cdn-fastly.deb.debian.org/debian/pool/main/s/squid/squid_${SQUID_PKG}.debian.tar.xz
> # unpack the source package
> dpkg-source -x squid_${SQUID_PKG}.dsc
> echo "DEB_CONFIGURE_EXTRA_FLAGS += --enable-ssl --with-openssl
> --enable-ssl-crtd" >> squid-${SQUID_VER}/debian/rules
> # build the package
> cd squid-${SQUID_VER} && dpkg-buildpackage -rfakeroot -b -J2 -uc -us
> sudo apt-get install squid-langpack
> sudo dpkg --install squid-common_${SQUID_PKG}_all.deb
> sudo dpkg --install squid_${SQUID_PKG}_amd64.deb
> sudo dpkg --install squidclient_${SQUID_PKG}_amd64.deb
> cd /etc/squid
> sudo openssl req -new -newkey rsa:2048 -sha256 -days 365 -nodes -subj
> "/CN=nobody" -x509 -extensions v3_ca -keyout squidCA.pem -out squidCA.pem
> chown proxy:proxy /var/spool/squid
> chown proxy:proxy /var/log/squid
> chown -R proxy:proxy /etc/squid
> sudo apt-get -y remove --purge libssl-dev
> sudo apt-get -y remove --purge devscripts build-essential fakeroot dpkg-dev
> sudo apt-get -y remove --purge libcppunit-dev libsasl2-dev libxml2-dev
> libkrb5-dev \
>     libdb-dev libnetfilter-conntrack-dev libexpat1-dev libcap2-dev
> libldap2-dev \
>     libpam0g-dev libgnutls28-dev libssl-dev libecap3-dev \
>     ed libltdl-dev cdbs debhelper dh-apparmor
> sudo apt-get -y autoremove


I'm upgrading to Squid4 with OpenSSL 1.1 because with Squid3 Ive some
connections that get stuck (for example
https://packages.cloud.google.com/apt/doc/apt-key.gpg) I think for
unsupported ciphers.

But with Squid4 and OpenSSL1.1 I've this lines in cache log:

> 2019/04/04 08:49:15 kid1| ERROR: client https start failed to allocate
> handle: error:140AB043:SSL routines:SSL_CTX_use_certificate:passed a null
> parameter

2019/04/04 08:49:15 kid1| ERROR: could not create TLS server context for
> local=127.0.0.1:3128 remote=127.0.0.1:39203 FD 19 flags=1

and this in access log:

> 127.0.0.1 - - [04/Apr/2019:08:49:15 +0000] "CONNECT
> packages.cloud.google.com:443 HTTP/1.1" 200 0 "-" "curl/7.58.0"
> NONE_ABORTED:HIER_NONE packages.cloud.google.com


for the following connection:

root at instance-2:/etc/squid $ https_proxy="http://127.0.0.1:3128" curl -vvvv
-sSO  https://packages.cloud.google.com/apt/doc/apt-key.gpg
*   Trying 127.0.0.1...
* TCP_NODELAY set
* Connected to 127.0.0.1 (127.0.0.1) port 3128 (#0)
* allocate connect buffer!
* Establish HTTP proxy tunnel to packages.cloud.google.com:443
> CONNECT packages.cloud.google.com:443 HTTP/1.1
> Host: packages.cloud.google.com:443
> User-Agent: curl/7.58.0
> Proxy-Connection: Keep-Alive
>
< HTTP/1.1 200 Connection established
<
* Proxy replied 200 to CONNECT request
* CONNECT phase completed!
* ALPN, offering h2
* ALPN, offering http/1.1
* successfully set certificate verify locations:
*   CAfile: /etc/ssl/certs/ca-certificates.crt
  CApath: /etc/ssl/certs
} [5 bytes data]
* TLSv1.2 (OUT), TLS handshake, Client hello (1):
} [223 bytes data]
* OpenSSL SSL_connect: SSL_ERROR_SYSCALL in connection to
packages.cloud.google.com:443
* Closing connection 0
curl: (35) OpenSSL SSL_connect: SSL_ERROR_SYSCALL in connection to
packages.cloud.google.com:443


Thanks

-- 

Davide Belloni
http://about.me/davidebelloni
http://www.linkedin.com/in/davidebelloni


-- 

Davide Belloni
http://about.me/davidebelloni
http://www.linkedin.com/in/davidebelloni
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20190404/178c244b/attachment.htm>

From squid3 at treenet.co.nz  Thu Apr  4 10:35:22 2019
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Thu, 4 Apr 2019 23:35:22 +1300
Subject: [squid-users] Squid 4 ssl_bump issue
In-Reply-To: <CAPaB35=B6+hbYDMGC3BZXVhO8UVOg=zxdFswv--av3zHHb+aCg@mail.gmail.com>
References: <CAPaB35=B6+hbYDMGC3BZXVhO8UVOg=zxdFswv--av3zHHb+aCg@mail.gmail.com>
Message-ID: <8ccdbd38-1582-310c-0225-05b3a3139f09@treenet.co.nz>

On 4/04/19 10:11 pm, Davide Belloni wrote:
> Hi,
> I've a problem in Ubuntu 18.04.2 with Squid 4.6 compiled with OpenSSL
> 1.1 about ssl_bump. The same configuration works in Squid 3.5 and
> OpenSSL 1.0
> 
> Here the relevant conf :
> 
>     ...
>     http_port 3128 ssl-bump options=ALL:NO_SSLv3 connection-auth=off
>     generate-host-certificates=off cert=/etc/squid/squidCA.pem
> 

There are several differences which are relevant here.

Firstly, the options= setting in v4 is buggy right now.

Secondly, that "ALL" setting enables a large number of highly unsafe
OpenSSL features. It is not a good idea to use that.

Thirdly, v4 now checks the contents of that squidCA.pem file and only
loads the actually needed cert/key/chain objects. v3 would load
everything even if the cert properties were forbidden for use by a proxy
or HTTP server.



>     # Not bypass server certificate validation errors
>     sslproxy_cert_error deny all
>     # This one return errors with debian on GCP
>     (https://wiki.squid-cache.org/KnowledgeBase/HostHeaderForgery)
>     host_verify_strict off


The above two directives are setting the defaults. It is only a waste of
CPU cycles to configure that in any Squid version. No need to configure
these at all.

> 
>     sslproxy_session_cache_size 0
> 
>     acl step1 at_step SslBump1
>     acl step2 at_step SslBump2
>     acl step3 at_step SslBump3
> 
>     ssl_bump peek step1 all
>     ssl_bump peek step2 all
> 
>     # API Google
>     acl api_google_urls url_regex
>     ^(https?:\/\/)?.*\.googleapis\.com(:443)?($|\/)
>     acl api_google_urls url_regex
>     ^(https?:\/\/)?.*\.google\.com(:443)?($|\/)
>     acl api_google_urls url_regex
>     ^(https?:\/\/)?.*\.cloud\.google\.com(:443)?($|\/)
>     acl api_google_urls url_regex
>     ^(https:\/\/)?([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})

These regex are overly complex. These two patterns cover the same set of
URLs:

 acl api_google_urls url_regex \
   \.google(apis)?\.com(:443)?($|\/)
   ^(https:\/\/)?([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})



>     acl api_google_ssl ssl::server_name_regex .*\.googleapis\.com
>     acl api_google_ssl ssl::server_name_regex .*\.google\.com
>     acl api_google_ssl ssl::server_name_regex .*\.cloud\.google\.com

Same with these ones:

 acl api_google_ssl ssl::server_name_regex \.google(apis)?\.com


>     acl api_google_ips src?127.0.0.1/32
> 
>     http_access allow api_google_ips api_google_urls
>     ssl_bump splice step3 api_google_ips api_google_ssl
> 
>     http_access deny all
>     ssl_bump terminate step3 all
>     ...
> 
> 
...


> 
> I'm upgrading to Squid4 with OpenSSL 1.1 because with Squid3 Ive some
> connections that get stuck (for example
> https://packages.cloud.google.com/apt/doc/apt-key.gpg) I think for
> unsupported ciphers.
> 
> But with Squid4 and OpenSSL1.1 I've this lines in cache log:
> 
>     2019/04/04 08:49:15 kid1| ERROR: client https start failed to
>     allocate handle: error:140AB043:SSL
>     routines:SSL_CTX_use_certificate:passed a null parameter
> 

Check the SquidCA.pem file actually contains a valid X.509 server CA
certificate and matching key.


>     2019/04/04 08:49:15 kid1| ERROR: could not create TLS server context
>     for local=127.0.0.1:3128 <http://127.0.0.1:3128>
>     remote=127.0.0.1:39203 <http://127.0.0.1:39203> FD 19 flags=1
> 

This must be fixed before any more advanced tests are worth performing.
Their results will be invalid until Squid has an operational TLS context.


Amos


From davide.belloni at gmail.com  Thu Apr  4 10:57:43 2019
From: davide.belloni at gmail.com (Davide Belloni)
Date: Thu, 4 Apr 2019 12:57:43 +0200
Subject: [squid-users] Squid 4 ssl_bump issue
In-Reply-To: <8ccdbd38-1582-310c-0225-05b3a3139f09@treenet.co.nz>
References: <CAPaB35=B6+hbYDMGC3BZXVhO8UVOg=zxdFswv--av3zHHb+aCg@mail.gmail.com>
 <8ccdbd38-1582-310c-0225-05b3a3139f09@treenet.co.nz>
Message-ID: <CAPaB35mXWRLxOCCMxQyC+apCYWNtHkqWry7HvEu09WgpSuughA@mail.gmail.com>

Hi, thanks very much for all the advices!
About the action to generate the certificate I've followed the squid wiki,
that doesn't modify (if I remember correctly) openssl conf to create it .

Do you have some link to a good howto about that?

Thanjs

Il gio 4 apr 2019, 12:35 Amos Jeffries <squid3 at treenet.co.nz> ha scritto:

> On 4/04/19 10:11 pm, Davide Belloni wrote:
> > Hi,
> > I've a problem in Ubuntu 18.04.2 with Squid 4.6 compiled with OpenSSL
> > 1.1 about ssl_bump. The same configuration works in Squid 3.5 and
> > OpenSSL 1.0
> >
> > Here the relevant conf :
> >
> >     ...
> >     http_port 3128 ssl-bump options=ALL:NO_SSLv3 connection-auth=off
> >     generate-host-certificates=off cert=/etc/squid/squidCA.pem
> >
>
> There are several differences which are relevant here.
>
> Firstly, the options= setting in v4 is buggy right now.
>
> Secondly, that "ALL" setting enables a large number of highly unsafe
> OpenSSL features. It is not a good idea to use that.
>
> Thirdly, v4 now checks the contents of that squidCA.pem file and only
> loads the actually needed cert/key/chain objects. v3 would load
> everything even if the cert properties were forbidden for use by a proxy
> or HTTP server.
>
>
>
> >     # Not bypass server certificate validation errors
> >     sslproxy_cert_error deny all
> >     # This one return errors with debian on GCP
> >     (https://wiki.squid-cache.org/KnowledgeBase/HostHeaderForgery)
> >     host_verify_strict off
>
>
> The above two directives are setting the defaults. It is only a waste of
> CPU cycles to configure that in any Squid version. No need to configure
> these at all.
>
> >
> >     sslproxy_session_cache_size 0
> >
> >     acl step1 at_step SslBump1
> >     acl step2 at_step SslBump2
> >     acl step3 at_step SslBump3
> >
> >     ssl_bump peek step1 all
> >     ssl_bump peek step2 all
> >
> >     # API Google
> >     acl api_google_urls url_regex
> >     ^(https?:\/\/)?.*\.googleapis\.com(:443)?($|\/)
> >     acl api_google_urls url_regex
> >     ^(https?:\/\/)?.*\.google\.com(:443)?($|\/)
> >     acl api_google_urls url_regex
> >     ^(https?:\/\/)?.*\.cloud\.google\.com(:443)?($|\/)
> >     acl api_google_urls url_regex
> >     ^(https:\/\/)?([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})
>
> These regex are overly complex. These two patterns cover the same set of
> URLs:
>
>  acl api_google_urls url_regex \
>    \.google(apis)?\.com(:443)?($|\/)
>    ^(https:\/\/)?([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})
>
>
>
> >     acl api_google_ssl ssl::server_name_regex .*\.googleapis\.com
> >     acl api_google_ssl ssl::server_name_regex .*\.google\.com
> >     acl api_google_ssl ssl::server_name_regex .*\.cloud\.google\.com
>
> Same with these ones:
>
>  acl api_google_ssl ssl::server_name_regex \.google(apis)?\.com
>
>
> >     acl api_google_ips src 127.0.0.1/32
> >
> >     http_access allow api_google_ips api_google_urls
> >     ssl_bump splice step3 api_google_ips api_google_ssl
> >
> >     http_access deny all
> >     ssl_bump terminate step3 all
> >     ...
> >
> >
> ...
>
>
> >
> > I'm upgrading to Squid4 with OpenSSL 1.1 because with Squid3 Ive some
> > connections that get stuck (for example
> > https://packages.cloud.google.com/apt/doc/apt-key.gpg) I think for
> > unsupported ciphers.
> >
> > But with Squid4 and OpenSSL1.1 I've this lines in cache log:
> >
> >     2019/04/04 08:49:15 kid1| ERROR: client https start failed to
> >     allocate handle: error:140AB043:SSL
> >     routines:SSL_CTX_use_certificate:passed a null parameter
> >
>
> Check the SquidCA.pem file actually contains a valid X.509 server CA
> certificate and matching key.
>
>
> >     2019/04/04 08:49:15 kid1| ERROR: could not create TLS server context
> >     for local=127.0.0.1:3128 <http://127.0.0.1:3128>
> >     remote=127.0.0.1:39203 <http://127.0.0.1:39203> FD 19 flags=1
> >
>
> This must be fixed before any more advanced tests are worth performing.
> Their results will be invalid until Squid has an operational TLS context.
>
>
> Amos
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20190404/704784b8/attachment.htm>

From davide.belloni at gmail.com  Thu Apr  4 11:37:44 2019
From: davide.belloni at gmail.com (Davide Belloni)
Date: Thu, 4 Apr 2019 13:37:44 +0200
Subject: [squid-users] Squid 4 ssl_bump issue
In-Reply-To: <CAPaB35mXWRLxOCCMxQyC+apCYWNtHkqWry7HvEu09WgpSuughA@mail.gmail.com>
References: <CAPaB35=B6+hbYDMGC3BZXVhO8UVOg=zxdFswv--av3zHHb+aCg@mail.gmail.com>
 <8ccdbd38-1582-310c-0225-05b3a3139f09@treenet.co.nz>
 <CAPaB35mXWRLxOCCMxQyC+apCYWNtHkqWry7HvEu09WgpSuughA@mail.gmail.com>
Message-ID: <CAPaB35nXEjj_m4Tf8uyV9S65VPS-iyBRu0bSZKfnm4O_WFZK1g@mail.gmail.com>

Hi,
this is the certificate that I'm using at the moment:

Certificate:
>     Data:
>         Version: 3 (0x2)
>         Serial Number:
>             a3:49:9a:ee:ac:75:66:da
>     Signature Algorithm: sha256WithRSAEncryption
>         Issuer: CN = nobody
>         Validity
>             Not Before: Apr  4 11:32:47 2019 GMT
>             Not After : Apr  3 11:32:47 2020 GMT
>         Subject: CN = nobody
>         Subject Public Key Info:
>             Public Key Algorithm: rsaEncryption
>                 Public-Key: (2048 bit)
>                 Modulus:
>                     00:d8:fc:85:95:05:42:aa:3c:52:64:a2:02:a2:8d:
>                     c9:86:48:c3:82:b5:1e:4f:8e:c3:7f:fb:6b:9b:2e:
>                     61:39:10:58:09:09:c9:88:e9:c0:d9:16:b4:e7:36:
>                     99:25:57:c6:f2:07:79:67:7b:50:20:a8:60:42:fa:
>                     e1:57:80:9e:e3:08:80:a6:fb:67:b5:25:3f:96:b0:
>                     83:73:35:91:36:cb:d7:7c:06:d6:58:a9:78:36:10:
>                     73:24:af:53:31:c8:a1:0d:89:05:c1:36:55:22:2a:
>                     8b:33:06:5b:07:47:9e:ff:dd:34:a4:5e:ce:56:95:
>                     8c:4f:76:e5:28:f8:9a:49:3d:50:5b:4b:5f:2a:b4:
>                     9c:0d:f4:1e:09:4f:62:64:a2:ee:46:0f:1a:42:ae:
>                     63:92:8c:02:9c:c0:dc:25:d1:d1:b0:ee:a5:fc:66:
>                     20:20:1b:ac:f4:0e:30:ed:2e:27:b9:02:ca:cb:7b:
>                     32:92:4c:6a:c1:58:59:cd:9b:14:3a:c9:76:bd:e1:
>                     06:dc:0d:f6:53:23:45:28:4b:07:8c:3f:6d:e8:6a:
>                     f2:01:c5:73:55:76:d2:cf:36:63:6f:6e:86:49:c5:
>                     20:05:95:db:fb:05:36:17:7d:a5:fb:3f:37:cb:47:
>                     3e:b4:a0:fd:35:e2:e7:31:c9:60:39:17:e9:7a:82:
>                     0b:75
>                 Exponent: 65537 (0x10001)
>         X509v3 extensions:
>             X509v3 Basic Constraints: critical
>                 CA:TRUE
>             X509v3 Subject Key Identifier:
>                 85:A5:3F:F5:8C:88:EA:38:BF:46:42:72:8B:EE:A1:04:B8:FC:E2:D4
>             X509v3 Key Usage: critical
>                 Digital Signature, Non Repudiation, Key Encipherment, Key
> Agreement, Certificate Sign, CRL Sign
>             X509v3 Extended Key Usage:
>                 TLS Web Server Authentication
>             X509v3 Subject Alternative Name:
>                 DNS:nobody



On Thu, 4 Apr 2019 at 12:57, Davide Belloni <davide.belloni at gmail.com>
wrote:

> Hi, thanks very much for all the advices!
> About the action to generate the certificate I've followed the squid wiki,
> that doesn't modify (if I remember correctly) openssl conf to create it .
>
> Do you have some link to a good howto about that?
>
> Thanjs
>
> Il gio 4 apr 2019, 12:35 Amos Jeffries <squid3 at treenet.co.nz> ha scritto:
>
>> On 4/04/19 10:11 pm, Davide Belloni wrote:
>> > Hi,
>> > I've a problem in Ubuntu 18.04.2 with Squid 4.6 compiled with OpenSSL
>> > 1.1 about ssl_bump. The same configuration works in Squid 3.5 and
>> > OpenSSL 1.0
>> >
>> > Here the relevant conf :
>> >
>> >     ...
>> >     http_port 3128 ssl-bump options=ALL:NO_SSLv3 connection-auth=off
>> >     generate-host-certificates=off cert=/etc/squid/squidCA.pem
>> >
>>
>> There are several differences which are relevant here.
>>
>> Firstly, the options= setting in v4 is buggy right now.
>>
>> Secondly, that "ALL" setting enables a large number of highly unsafe
>> OpenSSL features. It is not a good idea to use that.
>>
>> Thirdly, v4 now checks the contents of that squidCA.pem file and only
>> loads the actually needed cert/key/chain objects. v3 would load
>> everything even if the cert properties were forbidden for use by a proxy
>> or HTTP server.
>>
>>
>>
>> >     # Not bypass server certificate validation errors
>> >     sslproxy_cert_error deny all
>> >     # This one return errors with debian on GCP
>> >     (https://wiki.squid-cache.org/KnowledgeBase/HostHeaderForgery)
>> >     host_verify_strict off
>>
>>
>> The above two directives are setting the defaults. It is only a waste of
>> CPU cycles to configure that in any Squid version. No need to configure
>> these at all.
>>
>> >
>> >     sslproxy_session_cache_size 0
>> >
>> >     acl step1 at_step SslBump1
>> >     acl step2 at_step SslBump2
>> >     acl step3 at_step SslBump3
>> >
>> >     ssl_bump peek step1 all
>> >     ssl_bump peek step2 all
>> >
>> >     # API Google
>> >     acl api_google_urls url_regex
>> >     ^(https?:\/\/)?.*\.googleapis\.com(:443)?($|\/)
>> >     acl api_google_urls url_regex
>> >     ^(https?:\/\/)?.*\.google\.com(:443)?($|\/)
>> >     acl api_google_urls url_regex
>> >     ^(https?:\/\/)?.*\.cloud\.google\.com(:443)?($|\/)
>> >     acl api_google_urls url_regex
>> >     ^(https:\/\/)?([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})
>>
>> These regex are overly complex. These two patterns cover the same set of
>> URLs:
>>
>>  acl api_google_urls url_regex \
>>    \.google(apis)?\.com(:443)?($|\/)
>>    ^(https:\/\/)?([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})
>>
>>
>>
>> >     acl api_google_ssl ssl::server_name_regex .*\.googleapis\.com
>> >     acl api_google_ssl ssl::server_name_regex .*\.google\.com
>> >     acl api_google_ssl ssl::server_name_regex .*\.cloud\.google\.com
>>
>> Same with these ones:
>>
>>  acl api_google_ssl ssl::server_name_regex \.google(apis)?\.com
>>
>>
>> >     acl api_google_ips src 127.0.0.1/32
>> >
>> >     http_access allow api_google_ips api_google_urls
>> >     ssl_bump splice step3 api_google_ips api_google_ssl
>> >
>> >     http_access deny all
>> >     ssl_bump terminate step3 all
>> >     ...
>> >
>> >
>> ...
>>
>>
>> >
>> > I'm upgrading to Squid4 with OpenSSL 1.1 because with Squid3 Ive some
>> > connections that get stuck (for example
>> > https://packages.cloud.google.com/apt/doc/apt-key.gpg) I think for
>> > unsupported ciphers.
>> >
>> > But with Squid4 and OpenSSL1.1 I've this lines in cache log:
>> >
>> >     2019/04/04 08:49:15 kid1| ERROR: client https start failed to
>> >     allocate handle: error:140AB043:SSL
>> >     routines:SSL_CTX_use_certificate:passed a null parameter
>> >
>>
>> Check the SquidCA.pem file actually contains a valid X.509 server CA
>> certificate and matching key.
>>
>>
>> >     2019/04/04 08:49:15 kid1| ERROR: could not create TLS server context
>> >     for local=127.0.0.1:3128 <http://127.0.0.1:3128>
>> >     remote=127.0.0.1:39203 <http://127.0.0.1:39203> FD 19 flags=1
>> >
>>
>> This must be fixed before any more advanced tests are worth performing.
>> Their results will be invalid until Squid has an operational TLS context.
>>
>>
>> Amos
>> _______________________________________________
>> squid-users mailing list
>> squid-users at lists.squid-cache.org
>> http://lists.squid-cache.org/listinfo/squid-users
>>
>

-- 

Davide Belloni
http://about.me/davidebelloni
http://www.linkedin.com/in/davidebelloni
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20190404/14e04791/attachment.htm>

From chip_pop at hotmail.com  Thu Apr  4 19:55:00 2019
From: chip_pop at hotmail.com (joseph)
Date: Thu, 4 Apr 2019 14:55:00 -0500 (CDT)
Subject: [squid-users] StoreID java example helper
In-Reply-To: <004a01d4be64$82af7190$880e54b0$@ngtech.co.il>
References: <004a01d4be64$82af7190$880e54b0$@ngtech.co.il>
Message-ID: <1554407700590-0.post@n4.nabble.com>

try that
Store ID helper AKA Dynamic Content Booster is scalable, enterprise-grade,
high-performance multi-threaded content deduplicator. It works with any
Squid starting with v3 and with all products based on it.
https://github.com/yvoinov/store-id-helper



-----
************************** 
***** Crash to the future  ****
**************************
--
Sent from: http://squid-web-proxy-cache.1019090.n4.nabble.com/Squid-Users-f1019091.html


From squid3 at treenet.co.nz  Fri Apr  5 04:22:37 2019
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Fri, 5 Apr 2019 17:22:37 +1300
Subject: [squid-users] Squid 4 ssl_bump issue
In-Reply-To: <CAPaB35nXEjj_m4Tf8uyV9S65VPS-iyBRu0bSZKfnm4O_WFZK1g@mail.gmail.com>
References: <CAPaB35=B6+hbYDMGC3BZXVhO8UVOg=zxdFswv--av3zHHb+aCg@mail.gmail.com>
 <8ccdbd38-1582-310c-0225-05b3a3139f09@treenet.co.nz>
 <CAPaB35mXWRLxOCCMxQyC+apCYWNtHkqWry7HvEu09WgpSuughA@mail.gmail.com>
 <CAPaB35nXEjj_m4Tf8uyV9S65VPS-iyBRu0bSZKfnm4O_WFZK1g@mail.gmail.com>
Message-ID: <2a56b72e-911d-f600-cd4b-d4657ab33eda@treenet.co.nz>

On 5/04/19 12:37 am, Davide Belloni wrote:
> Hi,
> this is the certificate that I'm using at the moment:
> 

AFAICS the pieces Squid-4 needs for your config and checks for are all
there.

Are the pieces correctly ordered in the .pem file? key first, then CA cert.


> 
> On Thu, 4 Apr 2019 at 12:57, Davide Belloni wrote:
> 
>     Hi, thanks very much for all the advices!
>     About the action to generate the certificate I've followed the squid
>     wiki, that doesn't modify (if I remember correctly) openssl conf to
>     create it .
> 
>     Do you have some link to a good howto about that?
> 


Ah, we have several how-to's in the wiki. The SSL-Bump documentation has
an example. The ConfigExamples section has one for self-signed root CA
like yours, one for intermediate CA signing cert, and one for a wildcard
domain cert.

The one most relevant to what you have is:
<https://wiki.squid-cache.org/ConfigExamples/Intercept/SslBumpExplicit#Features.2FDynamicSslCert.Create_Self-Signed_Root_CA_Certificate>

If this already matches what you are doing, and the PEM file content is
correct, and that context creation ERROR still shows up. Then your next
step would be to start Squid with the -X command line option and see if
anything more specific about it shows up.
 (This will produce a huge amount of debug info, but you only need the
startup sequence where the ERROR shows up. It should not be necessary to
send traffic until the context is working.)

Amos


From davide.belloni at gmail.com  Fri Apr  5 06:54:08 2019
From: davide.belloni at gmail.com (Davide Belloni)
Date: Fri, 5 Apr 2019 08:54:08 +0200
Subject: [squid-users] Squid 4 ssl_bump issue
In-Reply-To: <2a56b72e-911d-f600-cd4b-d4657ab33eda@treenet.co.nz>
References: <CAPaB35=B6+hbYDMGC3BZXVhO8UVOg=zxdFswv--av3zHHb+aCg@mail.gmail.com>
 <8ccdbd38-1582-310c-0225-05b3a3139f09@treenet.co.nz>
 <CAPaB35mXWRLxOCCMxQyC+apCYWNtHkqWry7HvEu09WgpSuughA@mail.gmail.com>
 <CAPaB35nXEjj_m4Tf8uyV9S65VPS-iyBRu0bSZKfnm4O_WFZK1g@mail.gmail.com>
 <2a56b72e-911d-f600-cd4b-d4657ab33eda@treenet.co.nz>
Message-ID: <CAPaB35nYChb5XFCpqDwu9ujnQt_ff1uY-JOmEOEuYj7=Jb6mkQ@mail.gmail.com>

Hi,
the setup is exactly what you suggested but still the ERROR shows up.
Here the startup sequence about context creation:

2019/04/05 06:29:48.050| Initializing https:// proxy context
2019/04/05 06:29:48.050| 24,8| SBuf.cc(38) SBuf: SBuf950 created from id
SBuf110
2019/04/05 06:29:48.050| 24,8| Tokenizer.cc(174) skip: skipping char '1'
2019/04/05 06:29:48.050| 24,5| Tokenizer.cc(25) consume: consuming 1 bytes
2019/04/05 06:29:48.050| 24,8| SBuf.cc(497) consume: SBuf950 consume 1
2019/04/05 06:29:48.050| 24,8| SBuf.cc(38) SBuf: SBuf951 created from id
SBuf950
2019/04/05 06:29:48.050| 24,8| SBuf.cc(70) ~SBuf: SBuf951 destructed
2019/04/05 06:29:48.050| 24,8| Tokenizer.cc(174) skip: skipping char '.'
2019/04/05 06:29:48.050| 24,5| Tokenizer.cc(25) consume: consuming 1 bytes
2019/04/05 06:29:48.050| 24,8| SBuf.cc(497) consume: SBuf950 consume 1
2019/04/05 06:29:48.050| 24,8| SBuf.cc(38) SBuf: SBuf952 created from id
SBuf950
2019/04/05 06:29:48.050| 24,8| SBuf.cc(70) ~SBuf: SBuf952 destructed
2019/04/05 06:29:48.050| 24,8| SBuf.cc(38) SBuf: SBuf953 created from id
SBuf950
2019/04/05 06:29:48.050| 24,5| Tokenizer.cc(25) consume: consuming 1 bytes
2019/04/05 06:29:48.050| 24,8| SBuf.cc(497) consume: SBuf950 consume 1
2019/04/05 06:29:48.050| 24,8| SBuf.cc(38) SBuf: SBuf954 created from id
SBuf950
2019/04/05 06:29:48.050| 24,8| SBuf.cc(70) ~SBuf: SBuf954 destructed
2019/04/05 06:29:48.050| 24,8| SBuf.cc(70) ~SBuf: SBuf953 destructed
2019/04/05 06:29:48.050| 24,8| SBuf.cc(70) ~SBuf: SBuf950 destructed
2019/04/05 06:29:48.051| 83,9| support.cc(586) InitClientContext: Setting
certificate verification callback.
2019/04/05 06:29:48.051| 83,8| PeerOptions.cc(647) updateContextCa: Setting
CA certificate locations.
2019/04/05 06:29:48.051| 83,8| PeerOptions.cc(630) loadSystemTrustedCa:
Setting default system Trusted CA. ctx=0x55dcadedcd20
2019/04/05 06:29:48.052| 24,8| SBuf.cc(30) SBuf: SBuf955 created
2019/04/05 06:29:48.052| 24,7| SBuf.cc(85) assign: assigning SBuf955 from
SBuf118
2019/04/05 06:29:48.052| 24,8| SBuf.cc(38) SBuf: SBuf956 created from id
SBuf955
2019/04/05 06:29:48.053| 24,8| SBuf.cc(70) ~SBuf: SBuf956 destructed
2019/04/05 06:29:48.053| 24,8| SBuf.cc(70) ~SBuf: SBuf955 destructed
2019/04/05 06:29:48.053| Initializing http_port 0.0.0.0:3128 TLS contexts
2019/04/05 06:29:48.053| Using certificate in /etc/squid/squidCA.pem
2019/04/05 06:29:48.053| 24,7| SBuf.cc(160) rawSpace: reserving 1 for
SBuf217
2019/04/05 06:29:48.053| 24,7| SBuf.cc(167) rawSpace: SBuf217 not growing
2019/04/05 06:29:48.053| 24,7| SBuf.cc(160) rawSpace: reserving 1 for
SBuf217
2019/04/05 06:29:48.053| 24,8| SBuf.cc(886) cow: SBuf217 new size:23
2019/04/05 06:29:48.053| 24,8| SBuf.cc(857) reAlloc: SBuf217 new size: 23
2019/04/05 06:29:48.054| 24,9| MemBlob.cc(56) MemBlob: constructed,
this=0x55dcadedd7c0 id=blob1225 reserveSize=23
2019/04/05 06:29:48.054| 24,8| MemBlob.cc(101) memAlloc: blob1225 memAlloc:
requested=23, received=40
2019/04/05 06:29:48.054| 24,7| SBuf.cc(865) reAlloc: SBuf217 new store
capacity: 40
2019/04/05 06:29:48.054| 83,3| KeyData.cc(105) loadX509ChainFromFile: Using
certificate chain in /etc/squid/squidCA.pem
2019/04/05 06:29:48.054| 83,3| KeyData.cc(123) loadX509ChainFromFile:
Adding issuer CA: /CN=nobody
2019/04/05 06:29:48.054| Using key in /etc/squid/squidCA.pem
2019/04/05 06:29:48.054| 24,7| SBuf.cc(160) rawSpace: reserving 1 for
SBuf218
2019/04/05 06:29:48.054| 24,8| SBuf.cc(886) cow: SBuf218 new size:23
2019/04/05 06:29:48.054| 24,8| SBuf.cc(857) reAlloc: SBuf218 new size: 23
2019/04/05 06:29:48.054| 24,9| MemBlob.cc(56) MemBlob: constructed,
this=0x55dcadef07f0 id=blob1226 reserveSize=23
2019/04/05 06:29:48.054| 24,8| MemBlob.cc(101) memAlloc: blob1226 memAlloc:
requested=23, received=40
2019/04/05 06:29:48.054| 24,9| MemBlob.cc(82) ~MemBlob: destructed,
this=0x55dcaddf6c30 id=blob554 capacity=40 size=23
2019/04/05 06:29:48.054| 24,7| SBuf.cc(865) reAlloc: SBuf218 new store
capacity: 40
2019/04/05 06:29:48.054| 83,8| PeerOptions.cc(647) updateContextCa: Setting
CA certificate locations.
2019/04/05 06:29:48.054| 83,9| ServerOptions.cc(444) updateContextClientCa:
Not requiring any client certificates
2019/04/05 06:29:48.054| 24,8| SBuf.cc(30) SBuf: SBuf957 created
2019/04/05 06:29:48.054| 24,7| SBuf.cc(85) assign: assigning SBuf957 from
SBuf118
2019/04/05 06:29:48.054| 24,8| SBuf.cc(38) SBuf: SBuf958 created from id
SBuf957
2019/04/05 06:29:48.054| 24,8| SBuf.cc(70) ~SBuf: SBuf958 destructed
2019/04/05 06:29:48.054| 24,8| SBuf.cc(70) ~SBuf: SBuf957 destructed

If you want I can attach all the cache log with startup and one request
with error
Thanks


On Fri, 5 Apr 2019 at 06:23, Amos Jeffries <squid3 at treenet.co.nz> wrote:

> On 5/04/19 12:37 am, Davide Belloni wrote:
> > Hi,
> > this is the certificate that I'm using at the moment:
> >
>
> AFAICS the pieces Squid-4 needs for your config and checks for are all
> there.
>
> Are the pieces correctly ordered in the .pem file? key first, then CA cert.
>
>
> >
> > On Thu, 4 Apr 2019 at 12:57, Davide Belloni wrote:
> >
> >     Hi, thanks very much for all the advices!
> >     About the action to generate the certificate I've followed the squid
> >     wiki, that doesn't modify (if I remember correctly) openssl conf to
> >     create it .
> >
> >     Do you have some link to a good howto about that?
> >
>
>
> Ah, we have several how-to's in the wiki. The SSL-Bump documentation has
> an example. The ConfigExamples section has one for self-signed root CA
> like yours, one for intermediate CA signing cert, and one for a wildcard
> domain cert.
>
> The one most relevant to what you have is:
> <
> https://wiki.squid-cache.org/ConfigExamples/Intercept/SslBumpExplicit#Features.2FDynamicSslCert.Create_Self-Signed_Root_CA_Certificate
> >
>
> If this already matches what you are doing, and the PEM file content is
> correct, and that context creation ERROR still shows up. Then your next
> step would be to start Squid with the -X command line option and see if
> anything more specific about it shows up.
>  (This will produce a huge amount of debug info, but you only need the
> startup sequence where the ERROR shows up. It should not be necessary to
> send traffic until the context is working.)
>
> Amos
>


-- 

Davide Belloni
http://about.me/davidebelloni
http://www.linkedin.com/in/davidebelloni
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20190405/b6fcbf8f/attachment.htm>

From squid3 at treenet.co.nz  Fri Apr  5 07:06:23 2019
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Fri, 5 Apr 2019 20:06:23 +1300
Subject: [squid-users] Squid 4 ssl_bump issue
In-Reply-To: <CAPaB35nYChb5XFCpqDwu9ujnQt_ff1uY-JOmEOEuYj7=Jb6mkQ@mail.gmail.com>
References: <CAPaB35=B6+hbYDMGC3BZXVhO8UVOg=zxdFswv--av3zHHb+aCg@mail.gmail.com>
 <8ccdbd38-1582-310c-0225-05b3a3139f09@treenet.co.nz>
 <CAPaB35mXWRLxOCCMxQyC+apCYWNtHkqWry7HvEu09WgpSuughA@mail.gmail.com>
 <CAPaB35nXEjj_m4Tf8uyV9S65VPS-iyBRu0bSZKfnm4O_WFZK1g@mail.gmail.com>
 <2a56b72e-911d-f600-cd4b-d4657ab33eda@treenet.co.nz>
 <CAPaB35nYChb5XFCpqDwu9ujnQt_ff1uY-JOmEOEuYj7=Jb6mkQ@mail.gmail.com>
Message-ID: <38c28f48-44e4-0cd1-b63f-1412cc9ca481@treenet.co.nz>


On 5/04/19 7:54 pm, Davide Belloni wrote:
> Hi,
> the setup is exactly what you suggested but still the ERROR shows up.
> Here the startup sequence about context creation:
> 

Okay that looked reasonable.


> 
> If you want I can attach all the cache log with startup and one request
> with error
> Thanks
> 

Ah, so the error shows up on first request?

In that case then yes the trace from that please.

Amos


From ml at netfence.it  Fri Apr  5 10:14:30 2019
From: ml at netfence.it (Andrea Venturoli)
Date: Fri, 5 Apr 2019 12:14:30 +0200
Subject: [squid-users] SqStat [was How to catch a big spender ?]
In-Reply-To: <64729425-0b82-998f-0b1a-4ed7ff05f641@riosoft.com.br>
References: <1955e0f9-4e10-02f1-a8ba-c50888915a63@cinbesa.com.br>
 <64729425-0b82-998f-0b1a-4ed7ff05f641@riosoft.com.br>
Message-ID: <bf72930b-fa78-9a7f-b0c9-4b4c6983a204@netfence.it>

On 3/25/19 9:03 PM, Bruno de Paula Larini wrote:

> Search for "sqstat". The tool is very simple, but it works for me.

Hello.
I got curious about this and decided to try sqstat.
I'm on FreeBSD and used the version in the port, which is 1.20; this 
seems to be the last available.

It doesn't even work out of the box, see:
> https://mysolution.lk/sqstat-error-error-1-cannot-get-data-server-answered-http1-1-200-ok/

With the patches on that page I was able to start it, but still it gets 
some data wrong and I had to make further corrections.


So, is this an abandoned project?
Are there similar alternatives?
Better ways to do the same thing?

  bye & Thanks
	av.


From m.wegner at hopitaldugier.fr  Fri Apr  5 13:06:00 2019
From: m.wegner at hopitaldugier.fr (=?iso-8859-1?Q?Wegner_Micha=EBl?=)
Date: Fri, 05 Apr 2019 15:06:00 +0200
Subject: [squid-users] youtube restriction.
Message-ID: <527bfee2.1d4ebb0.29b980e7.db3@hopitaldugier.fr>

Hi,
 
I install squid + squidguard, and I can't play youtube video.
For example : https://m.youtube.com/watch?v=Hmj3LToi4W8 ; https://m.youtube.com/watch?v=jbBUQ-uvlRU
 
Error : video not available access to this video is limited
 
I have Ubuntu server 18.04 and squid v 3.5.27
 
Can' you help me please
 
Thanks,
 
Kind Regards
 
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20190405/0f1e17cf/attachment.htm>

From m_zouhairy at skno.by  Fri Apr  5 13:21:28 2019
From: m_zouhairy at skno.by (Vacheslav Zouhairy)
Date: Fri, 05 Apr 2019 16:21:28 +0300
Subject: [squid-users] youtube restriction.
In-Reply-To: <527bfee2.1d4ebb0.29b980e7.db3@hopitaldugier.fr>
References: <527bfee2.1d4ebb0.29b980e7.db3@hopitaldugier.fr>
Message-ID: <edde432e1f0745413ed6d35d157a6abc025b7d3d.camel@skno.by>

time to try ufdbguard, it is very flexible and relatively easy to
configure.
On Fri, 2019-04-05 at 15:06 +0200, Wegner Micha?l wrote:
> Hi,
>  
> I install squid + squidguard, and I can?t play youtube video.
> For example : https://m.youtube.com/watch?v=Hmj3LToi4W8 ; 
> https://m.youtube.com/watch?v=jbBUQ-uvlRU
>  
> Error : video not available 
> access to this video is limited I have Ubuntu server 18.04 and squid
> v 3.5.27 Can? you help me please Thanks, Kind Regards 
> _______________________________________________squid-users mailing 
> listsquid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20190405/4c512724/attachment.htm>

From Antony.Stone at squid.open.source.it  Fri Apr  5 13:39:08 2019
From: Antony.Stone at squid.open.source.it (Antony Stone)
Date: Fri, 5 Apr 2019 15:39:08 +0200
Subject: [squid-users] youtube restriction.
In-Reply-To: <527bfee2.1d4ebb0.29b980e7.db3@hopitaldugier.fr>
References: <527bfee2.1d4ebb0.29b980e7.db3@hopitaldugier.fr>
Message-ID: <201904051539.08777.Antony.Stone@squid.open.source.it>

On Friday 05 April 2019 at 15:06:00, Wegner Micha?l wrote:

> Hi,
> 
> I install squid + squidguard, and I can't play youtube video.
> For example : https://m.youtube.com/watch?v=Hmj3LToi4W8 ;
> https://m.youtube.com/watch?v=jbBUQ-uvlRU
> 
> Error : video not available access to this video is limited

1. Does it work if you do not go via Squid and SquidGuard?

2. Can you play any other Youtube videos?

3. Given that this is an HTTPS connection, how are you restricting HTTPS 
content with SquidGuard?

> I have Ubuntu server 18.04 and squid v 3.5.27
> 
> Can' you help me please

Regards,


Antony.

-- 
"Measuring average network latency is about as useful as measuring the mean 
temperature of patients in a hospital."

 - St?phane Bortzmeyer

                                                   Please reply to the list;
                                                         please *don't* CC me.


From liujy0208 at gmail.com  Sun Apr  7 04:45:57 2019
From: liujy0208 at gmail.com (jyliu)
Date: Sat, 6 Apr 2019 23:45:57 -0500 (CDT)
Subject: [squid-users] Squid bind each outgoing ip to a user?
Message-ID: <1554612357975-0.post@n4.nabble.com>

I am trying to use squid and bind 2 outgoing ips separately to 2 users.

The ideal results will be, I can access the following:

xxx.xxx.xxx.14:3128:user1:user1password 
xxx.xxx.xxx.18:3128:user2:user2password

But not:

xxx.xxx.xxx.14:3128:user2:user2password 
xxx.xxx.xxx.18:3128:user1:user1password

I find a similar question on stackoverflow and thus use a similar
squid.conf:


acl http proto http
acl port_80 port 80
acl port_443 port 443
acl CONNECT method CONNECT


auth_param basic program /usr/lib64/squid/basic_ncsa_auth
/etc/squid/passwords
acl ncsa_users proxy_auth REQUIRED
external_acl_type userIp %SRC %LOGIN /usr/lib64/squid/ext_file_userip_acl -f
/etc/squid/userIp.conf

acl userIp external userIp

http_access deny !ncsa_users
http_access allow userIp
http_access deny all

http_port 3128
acl ip1 myip xxx.xxx.xxx.14
tcp_outgoing_address xxx.xxx.xxx.14 ip1

acl ip2 myip xxx.xxx.xxx.18
tcp_outgoing_address xxx.xxx.xxx.18 ip2


And in my userIp.conf I have:


xxx.xxx.xxx.14 user1
xxx.xxx.xxx.18 user2


And in my /etc/squid/passwords I have the following created by htpasswd:


user1:encrypted password
user2:encrypted password

The problem is: if I delete* 'http_access deny !ncsa_users'*, then user1 can
access both xxx.xxx.xxx.14 and xxx.xxx.xxx.18. Same with user2.

But if I keep* 'http_access deny !ncsa_users'* as it is, then all connection
fails.

I feel *'http_access allow userIp'* doesn't work as it intends to.

I can't search a similar problem on web... Hope anyone could help me



--
Sent from: http://squid-web-proxy-cache.1019090.n4.nabble.com/Squid-Users-f1019091.html


From squid3 at treenet.co.nz  Sun Apr  7 06:01:51 2019
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Sun, 7 Apr 2019 18:01:51 +1200
Subject: [squid-users] Squid bind each outgoing ip to a user?
In-Reply-To: <1554612357975-0.post@n4.nabble.com>
References: <1554612357975-0.post@n4.nabble.com>
Message-ID: <4581ead3-43b3-d2f6-3d65-5915cd4b0410@treenet.co.nz>

On 7/04/19 4:45 pm, jyliu wrote:
> I am trying to use squid and bind 2 outgoing ips separately to 2 users.
> 
> The ideal results will be, I can access the following:
> 
> xxx.xxx.xxx.14:3128:user1:user1password 
> xxx.xxx.xxx.18:3128:user2:user2password
> 
> But not:
> 
> xxx.xxx.xxx.14:3128:user2:user2password 
> xxx.xxx.xxx.18:3128:user1:user1password
> 
> I find a similar question on stackoverflow and thus use a similar
> squid.conf:
> 
> 
> acl http proto http
> acl port_80 port 80
> acl port_443 port 443
> acl CONNECT method CONNECT
> 
> 
> auth_param basic program /usr/lib64/squid/basic_ncsa_auth
> /etc/squid/passwords
> acl ncsa_users proxy_auth REQUIRED
> external_acl_type userIp %SRC %LOGIN /usr/lib64/squid/ext_file_userip_acl -f
> /etc/squid/userIp.conf
> 
> acl userIp external userIp
> 
> http_access deny !ncsa_users
> http_access allow userIp
> http_access deny all
> 
> http_port 3128
> acl ip1 myip xxx.xxx.xxx.14
> tcp_outgoing_address xxx.xxx.xxx.14 ip1
> 
> acl ip2 myip xxx.xxx.xxx.18
> tcp_outgoing_address xxx.xxx.xxx.18 ip2
> 
> 
> And in my userIp.conf I have:
> 
> 
> xxx.xxx.xxx.14 user1
> xxx.xxx.xxx.18 user2
> 
> 
> And in my /etc/squid/passwords I have the following created by htpasswd:
> 
> 
> user1:encrypted password
> user2:encrypted password
> 
> The problem is: if I delete* 'http_access deny !ncsa_users'*, then user1 can
> access both xxx.xxx.xxx.14 and xxx.xxx.xxx.18. Same with user2.

... because they are no longer required to login to have their requests
serviced by the proxy.

> 
> But if I keep* 'http_access deny !ncsa_users'* as it is, then all connection
> fails.

Fails how?

 Squid sending back a 401/407 "please give your credentials" response?

 Squid delivering a 403 forbidden response?

 Squid not breaking HTTP to cause the IP mapping you wanted to see?

 Something else?



> 
> I feel *'http_access allow userIp'* doesn't work as it intends to.

"feelings" are irrelevant here. These ACL rules are algorithms. They can
be calculated and most importantly their calculations can be viewed.

 Please add "-d" command line option to your squid.conf helper lines to
see what the helpers are actually doing.

 And "debug_options 11,2 28,5" to your squid.conf see what is actually
going on.


Amos


From liujy0208 at gmail.com  Sun Apr  7 07:01:14 2019
From: liujy0208 at gmail.com (jyliu)
Date: Sun, 7 Apr 2019 02:01:14 -0500 (CDT)
Subject: [squid-users] Squid bind each outgoing ip to a user?
In-Reply-To: <4581ead3-43b3-d2f6-3d65-5915cd4b0410@treenet.co.nz>
References: <1554612357975-0.post@n4.nabble.com>
 <4581ead3-43b3-d2f6-3d65-5915cd4b0410@treenet.co.nz>
Message-ID: <1554620474598-0.post@n4.nabble.com>

Thanks for replying so quickly! I really appreciate it!

I am very new to Squid (start a week ago) so I probably will make dumb
mistakes.

I just search this forum and find another post similar to my problem, and
your answer is:
>http_port xxx.xxx.xxx.14:3128 name=0
>acl ip1 myportname 0
>tcp_outgoing_address xxx.xxx.xxx.14 ip1

Is this the same as what I am previously doing?
> http_port 3128 
> acl ip1 myip xxx.xxx.xxx.14 
> tcp_outgoing_address xxx.xxx.xxx.14 ip1 



I check access.log it returns 407:
TCP_DENIED/407 3710 GET http://www.google.com/ test HIER_NONE/- text/html

I am not sure how to put -d in squid.conf helper...But I add those
debug_options.

And here is cache.log file:
19/04/07 02:54:03.585 kid1| Eui48.cc(204) lookup: id=0x1b94b94 query ARP
table
2019/04/07 02:54:03.586 kid1| Eui48.cc(247) lookup: id=0x1b94b94 query ARP
on each interface (280 found)
2019/04/07 02:54:03.586 kid1| Eui48.cc(253) lookup: id=0x1b94b94 found
interface lo
2019/04/07 02:54:03.586 kid1| Eui48.cc(253) lookup: id=0x1b94b94 found
interface eth0
2019/04/07 02:54:03.586 kid1| Eui48.cc(262) lookup: id=0x1b94b94 looking up
ARP address for 209.166.109.90 on eth0
2019/04/07 02:54:03.586 kid1| Eui48.cc(253) lookup: id=0x1b94b94 found
interface eth0:0
2019/04/07 02:54:03.586 kid1| Eui48.cc(253) lookup: id=0x1b94b94 found
interface eth0:1
2019/04/07 02:54:03.586 kid1| Eui48.cc(253) lookup: id=0x1b94b94 found
interface eth0:2
2019/04/07 02:54:03.586 kid1| Eui48.cc(253) lookup: id=0x1b94b94 found
interface eth0:3
2019/04/07 02:54:03.586 kid1| Eui48.cc(253) lookup: id=0x1b94b94 found
interface eth0:4
2019/04/07 02:54:03.586 kid1| Eui48.cc(541) lookup: id=0x1b94b94
209.166.109.90 NOT found
2019/04/07 02:54:03.586 kid1| FilledChecklist.cc(58) ~ACLFilledChecklist:
ACLFilledChecklist destroyed 0x7fff1c681000
2019/04/07 02:54:03.586 kid1| Checklist.cc(189) ~ACLChecklist:
ACLChecklist::~ACLChecklist: destroyed 0x7fff1c681000
2019/04/07 02:54:03.586 kid1| client_side.cc(2408) parseHttpRequest: HTTP
Client local=204.188.217.14:3128 remote=209.166.109.90:55394 FD 9 flags=1
2019/04/07 02:54:03.586 kid1| client_side.cc(2409) parseHttpRequest: HTTP
Client REQUEST:
---------
GET http://www.google.com/ HTTP/1.1
Host: www.google.com
Proxy-Authorization: Basic dGVzdDp0ZXN0
User-Agent: curl/7.58.0
Accept: */*
Proxy-Connection: Keep-Alive


----------
2019/04/07 02:54:03.587 kid1| Checklist.cc(62) preCheck: 0x1777988 checking
slow rules
2019/04/07 02:54:03.587 kid1| Acl.cc(157) matches: checking http_access
2019/04/07 02:54:03.587 kid1| Acl.cc(157) matches: checking http_access#1
2019/04/07 02:54:03.587 kid1| Acl.cc(157) matches: checking !ncsa_users
2019/04/07 02:54:03.587 kid1| Acl.cc(157) matches: checking ncsa_users
2019/04/07 02:54:03.587 kid1| AclProxyAuth.cc(143) checkForAsync: checking
password via authenticator
2019/04/07 02:54:03.587 kid1| Starting new basicauthenticator helpers...
2019/04/07 02:54:03.588 kid1| Acl.cc(62) AuthenticateAcl: returning 2
sending credentials to helper.
2019/04/07 02:54:03.588 kid1| Acl.cc(177) matches: checked: ncsa_users = -1
async
2019/04/07 02:54:03.588 kid1| Acl.cc(177) matches: checked: !ncsa_users = -1
async
2019/04/07 02:54:03.588 kid1| Acl.cc(177) matches: checked: http_access#1 =
-1 async
2019/04/07 02:54:03.588 kid1| Acl.cc(177) matches: checked: http_access = -1
async
2019/04/07 02:54:03.602 kid1| InnerNode.cc(87) resumeMatchingAt: checking
http_access at 0
2019/04/07 02:54:03.602 kid1| InnerNode.cc(87) resumeMatchingAt: checking
http_access#1 at 0
2019/04/07 02:54:03.602 kid1| InnerNode.cc(87) resumeMatchingAt: checking
!ncsa_users at 0
2019/04/07 02:54:03.602 kid1| Acl.cc(157) matches: checking ncsa_users
2019/04/07 02:54:03.602 kid1| Acl.cc(359) cacheMatchAcl: ACL::cacheMatchAcl:
miss for 'ncsa_users'. Adding result 1
2019/04/07 02:54:03.602 kid1| Acl.cc(177) matches: checked: ncsa_users = 1
2019/04/07 02:54:03.602 kid1| InnerNode.cc(90) resumeMatchingAt: checked:
!ncsa_users = 0
2019/04/07 02:54:03.602 kid1| InnerNode.cc(90) resumeMatchingAt: checked:
http_access#1 = 0
2019/04/07 02:54:03.602 kid1| Acl.cc(157) matches: checking http_access#2
2019/04/07 02:54:03.602 kid1| Acl.cc(157) matches: checking userIp
2019/04/07 02:54:03.602 kid1| Acl.cc(177) matches: checked: userIp = -1
async
2019/04/07 02:54:03.602 kid1| Acl.cc(177) matches: checked: http_access#2 =
-1 async
2019/04/07 02:54:03.602 kid1| InnerNode.cc(90) resumeMatchingAt: checked:
http_access = -1 async
2019/04/07 02:54:03.602 kid1| InnerNode.cc(87) resumeMatchingAt: checking
http_access at 1
2019/04/07 02:54:03.602 kid1| InnerNode.cc(87) resumeMatchingAt: checking
http_access#2 at 0
2019/04/07 02:54:03.602 kid1| Acl.cc(157) matches: checking userIp
2019/04/07 02:54:03.602 kid1| Acl.cc(177) matches: checked: userIp = 0
2019/04/07 02:54:03.602 kid1| InnerNode.cc(90) resumeMatchingAt: checked:
http_access#2 = 0
2019/04/07 02:54:03.602 kid1| InnerNode.cc(90) resumeMatchingAt: checked:
http_access = 0
2019/04/07 02:54:03.602 kid1| Checklist.cc(378) calcImplicitAnswer:
0x1777988 NO match found, last action ALLOWED so returning DENIED
2019/04/07 02:54:03.602 kid1| Checklist.cc(55) markFinished: 0x1777988
answer DENIED for implicit rule won
2019/04/07 02:54:03.602 kid1| Checklist.cc(155) checkCallback:
ACLChecklist::checkCallback: 0x1777988 answer=DENIED
2019/04/07 02:54:03.602 kid1| Gadgets.cc(103) aclIsProxyAuth:
aclIsProxyAuth: called for userIp
2019/04/07 02:54:03.603 kid1| Gadgets.cc(108) aclIsProxyAuth:
aclIsProxyAuth: returning 1
2019/04/07 02:54:03.603 kid1| FilledChecklist.cc(58) ~ACLFilledChecklist:
ACLFilledChecklist destroyed 0x7fff1c680c30
2019/04/07 02:54:03.603 kid1| Checklist.cc(189) ~ACLChecklist:
ACLChecklist::~ACLChecklist: destroyed 0x7fff1c680c30
2019/04/07 02:54:03.603 kid1| FilledChecklist.cc(58) ~ACLFilledChecklist:
ACLFilledChecklist destroyed 0x7fff1c680a90
2019/04/07 02:54:03.603 kid1| Checklist.cc(189) ~ACLChecklist:
ACLChecklist::~ACLChecklist: destroyed 0x7fff1c680a90
2019/04/07 02:54:03.603 kid1| client_side.cc(1460) sendStartOfMessage: HTTP
Client local=204.188.217.14:3128 remote=209.166.109.90:55394 FD 9 flags=1
2019/04/07 02:54:03.603 kid1| client_side.cc(1461) sendStartOfMessage: HTTP
Client REPLY:
---------
HTTP/1.1 407 Proxy Authentication Required
Server: squid/3.4.14
Mime-Version: 1.0
Date: Sun, 07 Apr 2019 06:54:03 GMT
Content-Type: text/html
Content-Length: 3234
X-Squid-Error: ERR_CACHE_ACCESS_DENIED 0
Vary: Accept-Language
Content-Language: en
Proxy-Authenticate: Basic realm="Squid proxy-caching web server"
X-Cache: MISS from mx3.dealsbay.org
X-Cache-Lookup: NONE from mx3.dealsbay.org:3128
Via: 1.1 mx3.dealsbay.org (squid/3.4.14)
Connection: keep-alive


----------
2019/04/07 02:54:03.603 kid1| FilledChecklist.cc(58) ~ACLFilledChecklist:
ACLFilledChecklist destroyed 0x1777988
2019/04/07 02:54:03.603 kid1| Checklist.cc(189) ~ACLChecklist:
ACLChecklist::~ACLChecklist: destroyed 0x1777988
2019/04/07 02:54:03.604 kid1| Checklist.cc(62) preCheck: 0x7fff1c680d20
checking fast ACLs
2019/04/07 02:54:03.604 kid1| Acl.cc(157) matches: checking access_log
daemon:/var/log/squid/access.log
2019/04/07 02:54:03.604 kid1| Acl.cc(157) matches: checking (access_log
daemon:/var/log/squid/access.log line)
2019/04/07 02:54:03.604 kid1| Acl.cc(177) matches: checked: (access_log
daemon:/var/log/squid/access.log line) = 1
2019/04/07 02:54:03.604 kid1| Acl.cc(177) matches: checked: access_log
daemon:/var/log/squid/access.log = 1
2019/04/07 02:54:03.604 kid1| Checklist.cc(55) markFinished: 0x7fff1c680d20
answer ALLOWED for match
2019/04/07 02:54:03.604 kid1| FilledChecklist.cc(58) ~ACLFilledChecklist:
ACLFilledChecklist destroyed 0x7fff1c680d20
2019/04/07 02:54:03.604 kid1| Checklist.cc(189) ~ACLChecklist:
ACLChecklist::~ACLChecklist: destroyed 0x7fff1c680d20



--
Sent from: http://squid-web-proxy-cache.1019090.n4.nabble.com/Squid-Users-f1019091.html


From squid3 at treenet.co.nz  Sun Apr  7 07:55:26 2019
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Sun, 7 Apr 2019 19:55:26 +1200
Subject: [squid-users] Squid bind each outgoing ip to a user?
In-Reply-To: <1554620474598-0.post@n4.nabble.com>
References: <1554612357975-0.post@n4.nabble.com>
 <4581ead3-43b3-d2f6-3d65-5915cd4b0410@treenet.co.nz>
 <1554620474598-0.post@n4.nabble.com>
Message-ID: <ded1a6fe-f730-b337-3a04-c104864d0077@treenet.co.nz>

On 7/04/19 7:01 pm, jyliu wrote:
> Thanks for replying so quickly! I really appreciate it!
> 
> I am very new to Squid (start a week ago) so I probably will make dumb
> mistakes.
> 
> I just search this forum and find another post similar to my problem, and
> your answer is:
>> http_port xxx.xxx.xxx.14:3128 name=0
>> acl ip1 myportname 0
>> tcp_outgoing_address xxx.xxx.xxx.14 ip1
> 
> Is this the same as what I am previously doing?

No. The myportname ACL tests the non-changing name= setting of whichever
http_port the requests TCP connection was received on.

"myip" checks against the dynamically changing TCP connection port
number the client used to connect to Squid. This may have nothing to do
with the http_port port number.

It just happens that your current tests are using the port 3128 to
connect directly to the proxy so they both reach the same outcome.



Correct configuration is to either use mytportname to match the
squid.conf setting if that is what you want. Or use localport ACL to
match the client connection dst-port value if that is what you want.


>> http_port 3128 
>> acl ip1 myip xxx.xxx.xxx.14 
>> tcp_outgoing_address xxx.xxx.xxx.14 ip1 
> 
> 
> 
> I check access.log it returns 407:
> TCP_DENIED/407 3710 GET http://www.google.com/ test HIER_NONE/- text/html
> 

So that is HTTP status "407 Proxy Authentication Required".

Either the request has no credentials. Or any credentials given are not
sufficient to perform the action being asked of the proxy. Other
credentials are being requested by the proxy.



> I am not sure how to put -d in squid.conf helper...But I add those
> debug_options.


See those auth_param and external_acl_type lines where the helper
program command-lines are configured.
  Add -d to the helepr parameter list on those lines.

Like so:


  auth_param basic program /usr/lib64/squid/basic_ncsa_auth -d \
    /etc/squid/passwords


  external_acl_type userIp %SRC %LOGIN \
    /usr/lib64/squid/ext_file_userip_acl -d \
    -f /etc/squid/userIp.conf


> 
> And here is cache.log file:
...
> 2019/04/07 02:54:03.586 kid1| client_side.cc(2408) parseHttpRequest: HTTP
> Client local=204.188.217.14:3128 remote=209.166.109.90:55394 FD 9 flags=1
> 2019/04/07 02:54:03.586 kid1| client_side.cc(2409) parseHttpRequest: HTTP
> Client REQUEST:
> ---------
> GET http://www.google.com/ HTTP/1.1
> Host: www.google.com
> Proxy-Authorization: Basic dGVzdDp0ZXN0
> User-Agent: curl/7.58.0
> Accept: */*
> Proxy-Connection: Keep-Alive
> 
> 
> ----------
> 2019/04/07 02:54:03.587 kid1| Checklist.cc(62) preCheck: 0x1777988 checking
> slow rules
> 2019/04/07 02:54:03.587 kid1| Acl.cc(157) matches: checking http_access
> 2019/04/07 02:54:03.587 kid1| Acl.cc(157) matches: checking http_access#1
> 2019/04/07 02:54:03.587 kid1| Acl.cc(157) matches: checking !ncsa_users

> 2019/04/07 02:54:03.587 kid1| AclProxyAuth.cc(143) checkForAsync: checking
> password via authenticator
> 2019/04/07 02:54:03.587 kid1| Starting new basicauthenticator helpers...
> 2019/04/07 02:54:03.588 kid1| Acl.cc(62) AuthenticateAcl: returning 2
> sending credentials to helper.

...
> 2019/04/07 02:54:03.602 kid1| Acl.cc(177) matches: checked: ncsa_users = 1

Credentials existed in the request. Login happened successfully ...


> 2019/04/07 02:54:03.602 kid1| InnerNode.cc(90) resumeMatchingAt: checked:
> !ncsa_users = 0

... so "http_access deny !ncsa_users" passed. Moving on.


...
> 2019/04/07 02:54:03.602 kid1| Acl.cc(157) matches: checking userIp
> 2019/04/07 02:54:03.602 kid1| Acl.cc(177) matches: checked: userIp = 0

The external_acl_type helper found that "204.188.217.14 test" was not in
your userIp.conf file.



> 2019/04/07 02:54:03.602 kid1| InnerNode.cc(90) resumeMatchingAt: checked:
> http_access#2 = 0
> 2019/04/07 02:54:03.602 kid1| InnerNode.cc(90) resumeMatchingAt: checked:
> http_access = 0
> 2019/04/07 02:54:03.602 kid1| Checklist.cc(378) calcImplicitAnswer:
> 0x1777988 NO match found, last action ALLOWED so returning DENIED

This states that the "http_access deny all" rule you showed being in
your config earlier does not exist.

Last ACL to be tested being userIp - which used authentication
credentials. So a different outcome may have happened if some other
login was supplied by the client.

 ==> the 407 challenge is produced to get _different_ credentials that
may pass the userIp check.


> Client local=204.188.217.14:3128 remote=209.166.109.90:55394 FD 9 flags=1
> 2019/04/07 02:54:03.603 kid1| client_side.cc(1461) sendStartOfMessage: HTTP
> Client REPLY:
> ---------
> HTTP/1.1 407 Proxy Authentication Required
> Server: squid/3.4.14
> Mime-Version: 1.0
> Date: Sun, 07 Apr 2019 06:54:03 GMT
> Content-Type: text/html
> Content-Length: 3234
> X-Squid-Error: ERR_CACHE_ACCESS_DENIED 0
> Vary: Accept-Language
> Content-Language: en
> Proxy-Authenticate: Basic realm="Squid proxy-caching web server"
> X-Cache: MISS from mx3.dealsbay.org
> X-Cache-Lookup: NONE from mx3.dealsbay.org:3128
> Via: 1.1 mx3.dealsbay.org (squid/3.4.14)
> Connection: keep-alive
> 
> ----------


PS. The most current Squid release is 4.6. Please upgrade. There are a
very large number of bug fixes and more than a few major security
vulnerabilities fixed since 3.4.14.
 Ideally no version older than Squid-3.5.28 should be in use anymore.


Amos


From liujy0208 at gmail.com  Sun Apr  7 08:12:07 2019
From: liujy0208 at gmail.com (jyliu)
Date: Sun, 7 Apr 2019 03:12:07 -0500 (CDT)
Subject: [squid-users] Squid bind each outgoing ip to a user?
In-Reply-To: <ded1a6fe-f730-b337-3a04-c104864d0077@treenet.co.nz>
References: <1554612357975-0.post@n4.nabble.com>
 <4581ead3-43b3-d2f6-3d65-5915cd4b0410@treenet.co.nz>
 <1554620474598-0.post@n4.nabble.com>
 <ded1a6fe-f730-b337-3a04-c104864d0077@treenet.co.nz>
Message-ID: <1554624727464-0.post@n4.nabble.com>

Thanks! Now I understand and will carefully check what's wrong and then
update it...

Yea I find when I paste the cache.log, I accidentally comment out the
'http_access deny all' when I run the code..


Lastly an interesting question is, '204.188.217.14 test' is actually my
first line in userIp.conf

Here is what in my userIp.conf:
204.188.217.14 test
204.188.217.18 wuhuarou

<http://squid-web-proxy-cache.1019090.n4.nabble.com/file/t377697/1.png> 

So I am pretty confused about this error (also seems to be the key problem
of my code)




--
Sent from: http://squid-web-proxy-cache.1019090.n4.nabble.com/Squid-Users-f1019091.html


From liujy0208 at gmail.com  Sun Apr  7 17:24:27 2019
From: liujy0208 at gmail.com (jyliu)
Date: Sun, 7 Apr 2019 12:24:27 -0500 (CDT)
Subject: [squid-users] Squid bind each outgoing ip to a user?
In-Reply-To: <ded1a6fe-f730-b337-3a04-c104864d0077@treenet.co.nz>
References: <1554612357975-0.post@n4.nabble.com>
 <4581ead3-43b3-d2f6-3d65-5915cd4b0410@treenet.co.nz>
 <1554620474598-0.post@n4.nabble.com>
 <ded1a6fe-f730-b337-3a04-c104864d0077@treenet.co.nz>
Message-ID: <1554657867477-0.post@n4.nabble.com>

****UPDATE****

I find the problem... In UserIp file, if I put user's ip (my own pc's ip for
example), it works.

So now my userIp.conf is: (that's my own ip)
209.xxx.109.90 test

And my squid.conf is: (This is the outgoing Ip i want to proxy to)
http_port 204.188.217.14:3128 name=0
acl ip1 myportname 0
tcp_outgoing_address 204.188.217.14 ip1

This works...

However, this isn't what I want... I want authenticate the user based on
their username and password, not base on their own pc's ip address. So
ideally, as long as the username and password is correct, one can have 
204.188.217.14:3128:test:testpassword
on any of their own ip address..


Sorry I think I may mistake the function of 'external_acl_type'?

But for my purpose, is there a way to do so?



--
Sent from: http://squid-web-proxy-cache.1019090.n4.nabble.com/Squid-Users-f1019091.html


From squid3 at treenet.co.nz  Mon Apr  8 05:46:36 2019
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Mon, 8 Apr 2019 17:46:36 +1200
Subject: [squid-users] Squid bind each outgoing ip to a user?
In-Reply-To: <1554657867477-0.post@n4.nabble.com>
References: <1554612357975-0.post@n4.nabble.com>
 <4581ead3-43b3-d2f6-3d65-5915cd4b0410@treenet.co.nz>
 <1554620474598-0.post@n4.nabble.com>
 <ded1a6fe-f730-b337-3a04-c104864d0077@treenet.co.nz>
 <1554657867477-0.post@n4.nabble.com>
Message-ID: <edf9a196-bb5c-747b-d1f4-7601a878a25c@treenet.co.nz>

On 8/04/19 5:24 am, jyliu wrote:
> ****UPDATE****
> 
> I find the problem... In UserIp file, if I put user's ip (my own pc's ip for
> example), it works.
> 
> So now my userIp.conf is: (that's my own ip)
> 209.xxx.109.90 test
> 
> And my squid.conf is: (This is the outgoing Ip i want to proxy to)
> http_port 204.188.217.14:3128 name=0
> acl ip1 myportname 0
> tcp_outgoing_address 204.188.217.14 ip1
> 
> This works...
> 
> However, this isn't what I want... I want authenticate the user based on
> their username and password, not base on their own pc's ip address. So



Please note that this is *not* "authentication" by IP address. It is
"authorization" by IP + login.  Specifically the "%SRC %LOGIN" pair.

As noted in my earlier comments to the log trace, the login step
succeeds completely. Only after that the IP+login ACL fails.

In other words: The clients credentials were valid, but not sufficient
to give access privilege to the request.



> ideally, as long as the username and password is correct, one can have 
> 204.188.217.14:3128:test:testpassword
> on any of their own ip address..
> 
> 
> Sorry I think I may mistake the function of 'external_acl_type'?

You have been passing the helper the %SRC format code. That expands to
the client IP address.

See
<http://www.squid-cache.org/Versions/v3/3.4/cfgman/external_acl_type.html>
for the list of codes in Squid-3.4. Any which expand to an IP address
can be used where you currently have %SRC.


You need the %MYADDR format code to give the helper the Squid receiving
IP address.


Amos


From m.wegner at hopitaldugier.fr  Mon Apr  8 09:15:00 2019
From: m.wegner at hopitaldugier.fr (=?utf-8?Q?Wegner_Micha=C3=ABl?=)
Date: Mon, 08 Apr 2019 11:15:00 +0200
Subject: [squid-users] squid-users Digest, Vol 56, Issue 12
In-Reply-To: <mailman.1.1554552002.12924.squid-users@lists.squid-cache.org>
Message-ID: <947be1d7.1d4edeb.38594b5d.26c5@hopitaldugier.fr>

Hi Antony,

The video is Ok, if i not used squid v3.5.
If on the squid.conf file I disabled rediretion on squidgaurd the problem is the same.
If squid is actived, somme videos are blocked, (the videos in restricted mode)
With a old version of squid (2.6) there are no problems

Regards,

Micha?l

-----Message d'origine-----
De?: squid-users [mailto:squid-users-bounces at lists.squid-cache.org] De la part de squid-users-request at lists.squid-cache.org
Envoy??: samedi 6 avril 2019 14:00
??: squid-users at lists.squid-cache.org
Objet?: squid-users Digest, Vol 56, Issue 12

Send squid-users mailing list submissions to
	squid-users at lists.squid-cache.org

To subscribe or unsubscribe via the World Wide Web, visit
	http://lists.squid-cache.org/listinfo/squid-users
or, via email, send a message with subject or body 'help' to
	squid-users-request at lists.squid-cache.org

You can reach the person managing the list at
	squid-users-owner at lists.squid-cache.org

When replying, please edit your Subject line so it is more specific than "Re: Contents of squid-users digest..."


Today's Topics:

   1. youtube restriction. (Wegner Micha?l)
   2. Re: youtube restriction. (Vacheslav Zouhairy)
   3. Re: youtube restriction. (Antony Stone)


----------------------------------------------------------------------

Message: 1
Date: Fri, 05 Apr 2019 15:06:00 +0200
From: Wegner Micha?l <m.wegner at hopitaldugier.fr>
To: squid-users at lists.squid-cache.org
Subject: [squid-users] youtube restriction.
Message-ID: <527bfee2.1d4ebb0.29b980e7.db3 at hopitaldugier.fr>
Content-Type: text/plain; charset="iso-8859-1"

Hi,
 
I install squid + squidguard, and I can't play youtube video.
For example : https://m.youtube.com/watch?v=Hmj3LToi4W8 ; https://m.youtube.com/watch?v=jbBUQ-uvlRU
 
Error : video not available access to this video is limited
 
I have Ubuntu server 18.04 and squid v 3.5.27
 
Can' you help me please
 
Thanks,
 
Kind Regards
 
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20190405/0f1e17cf/attachment-0001.html>

------------------------------

Message: 2
Date: Fri, 05 Apr 2019 16:21:28 +0300
From: Vacheslav Zouhairy <m_zouhairy at skno.by>
To: squid-users at lists.squid-cache.org
Subject: Re: [squid-users] youtube restriction.
Message-ID: <edde432e1f0745413ed6d35d157a6abc025b7d3d.camel at skno.by>
Content-Type: text/plain; charset="utf-8"

time to try ufdbguard, it is very flexible and relatively easy to configure.
On Fri, 2019-04-05 at 15:06 +0200, Wegner Micha?l wrote:
> Hi,
>  
> I install squid + squidguard, and I can?t play youtube video.
> For example : https://m.youtube.com/watch?v=Hmj3LToi4W8 ; 
> https://m.youtube.com/watch?v=jbBUQ-uvlRU
>  
> Error : video not available
> access to this video is limited I have Ubuntu server 18.04 and squid v 
> 3.5.27 Can? you help me please Thanks, Kind Regards 
> _______________________________________________squid-users mailing 
> listsquid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20190405/4c512724/attachment-0001.html>

------------------------------

Message: 3
Date: Fri, 5 Apr 2019 15:39:08 +0200
From: Antony Stone <Antony.Stone at squid.open.source.it>
To: squid-users at lists.squid-cache.org
Subject: Re: [squid-users] youtube restriction.
Message-ID: <201904051539.08777.Antony.Stone at squid.open.source.it>
Content-Type: Text/Plain;  charset="iso-8859-15"

On Friday 05 April 2019 at 15:06:00, Wegner Micha?l wrote:

> Hi,
> 
> I install squid + squidguard, and I can't play youtube video.
> For example : https://m.youtube.com/watch?v=Hmj3LToi4W8 ; 
> https://m.youtube.com/watch?v=jbBUQ-uvlRU
> 
> Error : video not available access to this video is limited

1. Does it work if you do not go via Squid and SquidGuard?

2. Can you play any other Youtube videos?

3. Given that this is an HTTPS connection, how are you restricting HTTPS content with SquidGuard?

> I have Ubuntu server 18.04 and squid v 3.5.27
> 
> Can' you help me please

Regards,


Antony.

--
"Measuring average network latency is about as useful as measuring the mean temperature of patients in a hospital."

 - St?phane Bortzmeyer

                                                   Please reply to the list;
                                                         please *don't* CC me.


------------------------------

Subject: Digest Footer

_______________________________________________
squid-users mailing list
squid-users at lists.squid-cache.org
http://lists.squid-cache.org/listinfo/squid-users


------------------------------

End of squid-users Digest, Vol 56, Issue 12
*******************************************



From Antony.Stone at squid.open.source.it  Mon Apr  8 09:34:07 2019
From: Antony.Stone at squid.open.source.it (Antony Stone)
Date: Mon, 8 Apr 2019 11:34:07 +0200
Subject: [squid-users] youtube restriction.
In-Reply-To: <201904051539.08777.Antony.Stone@squid.open.source.it>
References: <527bfee2.1d4ebb0.29b980e7.db3@hopitaldugier.fr>
 <201904051539.08777.Antony.Stone@squid.open.source.it>
Message-ID: <201904081134.07513.Antony.Stone@squid.open.source.it>

Hi.

I'm replying in the original thread, to keep this conversation together in the 
archives etc.

On Monday 08 April 2019 at 11:15:00, Wegner Micha?l wrote:

> Hi Antony,
> 
> The video is Ok, if i not used squid v3.5.

So, it's not Youtube blocking that particualr video in your country etc.

> If on the squid.conf file I disabled rediretion on squidgaurd the problem
> is the same.

Okay, we can disregard SquidGuard as being the problem, then.

> If squid is actived, somme videos are blocked, (the videos in
> restricted mode)

That tells us it's your Squid configuration which is causing the problem.

> With a old version of squid (2.6) there are no problems

There are a *lot* of differences between Squid 2.6 and 3.5, especially for 
HTTPS.  You *have* made suitable adjustments to the configuration file, I hope?


Antony.

> Date: Fri, 5 Apr 2019 15:39:08 +0200
> From: Antony Stone <Antony.Stone at squid.open.source.it>
> To: squid-users at lists.squid-cache.org
> Subject: Re: [squid-users] youtube restriction.
> Message-ID: <201904051539.08777.Antony.Stone at squid.open.source.it>
> Content-Type: Text/Plain;  charset="iso-8859-15"
> 
> On Friday 05 April 2019 at 15:06:00, Wegner Micha?l wrote:
> > Hi,
> > 
> > I install squid + squidguard, and I can't play youtube video.
> > For example : https://m.youtube.com/watch?v=Hmj3LToi4W8 ;
> > https://m.youtube.com/watch?v=jbBUQ-uvlRU
> > 
> > Error : video not available access to this video is limited
> 
> 1. Does it work if you do not go via Squid and SquidGuard?
> 
> 2. Can you play any other Youtube videos?
> 
> 3. Given that this is an HTTPS connection, how are you restricting HTTPS
> content with SquidGuard?
> 
> > I have Ubuntu server 18.04 and squid v 3.5.27
> > 
> > Can' you help me please
> 
> Regards,
> 
> 
> Antony.

-- 
Pavlov is in the pub enjoying a pint.
The barman rings for last orders, and Pavlov jumps up exclaiming "Damn!  I 
forgot to feed the dog!"

                                                   Please reply to the list;
                                                         please *don't* CC me.


From liujy0208 at gmail.com  Mon Apr  8 17:08:07 2019
From: liujy0208 at gmail.com (jyliu)
Date: Mon, 8 Apr 2019 12:08:07 -0500 (CDT)
Subject: [squid-users] Squid bind each outgoing ip to a user?
In-Reply-To: <edf9a196-bb5c-747b-d1f4-7601a878a25c@treenet.co.nz>
References: <1554612357975-0.post@n4.nabble.com>
 <4581ead3-43b3-d2f6-3d65-5915cd4b0410@treenet.co.nz>
 <1554620474598-0.post@n4.nabble.com>
 <ded1a6fe-f730-b337-3a04-c104864d0077@treenet.co.nz>
 <1554657867477-0.post@n4.nabble.com>
 <edf9a196-bb5c-747b-d1f4-7601a878a25c@treenet.co.nz>
Message-ID: <1554743287775-0.post@n4.nabble.com>

Wow thank you for your help!

So in summary, I mis-use the %SRC (and I don't know there is a %MYADDR )..

Really appreciate it!



--
Sent from: http://squid-web-proxy-cache.1019090.n4.nabble.com/Squid-Users-f1019091.html


From davide.belloni at gmail.com  Tue Apr  9 07:58:31 2019
From: davide.belloni at gmail.com (Davide Belloni)
Date: Tue, 9 Apr 2019 09:58:31 +0200
Subject: [squid-users] Squid 4 ssl_bump issue
In-Reply-To: <CAPaB35m+MC9fQ-xneRO=3YptwB5Sxkaw1o6DEODEZGoUXHAGRQ@mail.gmail.com>
References: <CAPaB35=B6+hbYDMGC3BZXVhO8UVOg=zxdFswv--av3zHHb+aCg@mail.gmail.com>
 <8ccdbd38-1582-310c-0225-05b3a3139f09@treenet.co.nz>
 <CAPaB35mXWRLxOCCMxQyC+apCYWNtHkqWry7HvEu09WgpSuughA@mail.gmail.com>
 <CAPaB35nXEjj_m4Tf8uyV9S65VPS-iyBRu0bSZKfnm4O_WFZK1g@mail.gmail.com>
 <2a56b72e-911d-f600-cd4b-d4657ab33eda@treenet.co.nz>
 <CAPaB35nYChb5XFCpqDwu9ujnQt_ff1uY-JOmEOEuYj7=Jb6mkQ@mail.gmail.com>
 <38c28f48-44e4-0cd1-b63f-1412cc9ca481@treenet.co.nz>
 <CAPaB35m+MC9fQ-xneRO=3YptwB5Sxkaw1o6DEODEZGoUXHAGRQ@mail.gmail.com>
Message-ID: <CAPaB35mUc8gXt48qVg3khzSgsfWJsWRtGGsQZ2dBNA0_Gaj-7w@mail.gmail.com>

Hi,
here the cache log in debug mode with the single request (previous email
was blocked because the atachment was too big)

Thanks

On Mon, 8 Apr 2019 at 08:26, Davide Belloni <davide.belloni at gmail.com>
wrote:

> Hi,
> here the cache log in debug mode with the single request
>
> Thanks
>
> On Fri, 5 Apr 2019 at 09:06, Amos Jeffries <squid3 at treenet.co.nz> wrote:
>
>>
>> On 5/04/19 7:54 pm, Davide Belloni wrote:
>> > Hi,
>> > the setup is exactly what you suggested but still the ERROR shows up.
>> > Here the startup sequence about context creation:
>> >
>>
>> Okay that looked reasonable.
>>
>>
>> >
>> > If you want I can attach all the cache log with startup and one request
>> > with error
>> > Thanks
>> >
>>
>> Ah, so the error shows up on first request?
>>
>> In that case then yes the trace from that please.
>>
>> Amos
>>
>
>
> --
>
> Davide Belloni
> http://about.me/davidebelloni
> http://www.linkedin.com/in/davidebelloni
>


-- 

Davide Belloni
http://about.me/davidebelloni
http://www.linkedin.com/in/davidebelloni
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20190409/535ef7f7/attachment.htm>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: cache.log.tgz
Type: application/gzip
Size: 23386 bytes
Desc: not available
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20190409/535ef7f7/attachment.gz>

From m.wegner at hopitaldugier.fr  Tue Apr  9 09:18:00 2019
From: m.wegner at hopitaldugier.fr (=?utf-8?Q?Wegner_Micha=C3=ABl?=)
Date: Tue, 09 Apr 2019 11:18:00 +0200
Subject: [squid-users] squid-users Digest, Vol 56, Issue 12
In-Reply-To: <947be1d7.1d4edeb.38594b5d.26c5@hopitaldugier.fr>
Message-ID: <343d0c9c.1d4eeb5.3d82a6b3.2eef@hopitaldugier.fr>



-----Message d'origine-----
De?: Wegner Micha?l [mailto:m.wegner at hopitaldugier.fr] 
Envoy??: lundi 8 avril 2019 11:15
??: squid-users at lists.squid-cache.org
Objet?: RE: squid-users Digest, Vol 56, Issue 12

Hi Antony,

The video is Ok, if i not used squid v3.5.
If on the squid.conf file I disabled rediretion on squidgaurd the problem is the same.
If squid is actived, somme videos are blocked, (the videos in restricted mode) With a old version of squid (2.6) there are no problems

Regards,

Hi,

I install a new serveur squid version 4.6 without squiguard and access allow all.
I set the ssl and i import certificate on the client but without success.

My squid.conf is : 

acl localnet src 0.0.0.1-0.255.255.255  # RFC 1122 "this" network (LAN)
acl localnet src 10.0.0.0/8             # RFC 1918 local private network (LAN)
acl localnet src 100.64.0.0/10          # RFC 6598 shared address space (CGN)
acl localnet src 169.254.0.0/16         # RFC 3927 link-local (directly plugged) machines
acl localnet src 172.16.0.0/12          # RFC 1918 local private network (LAN)
acl localnet src 192.168.0.0/16         # RFC 1918 local private network (LAN)
acl localnet src fc00::/7               # RFC 4193 local private network range
acl localnet src fe80::/10              # RFC 4291 link-local (directly plugged) machines

acl SSL_ports port 443
acl Safe_ports port 80          # http
acl Safe_ports port 21          # ftp
acl Safe_ports port 443         # https
acl Safe_ports port 70          # gopher
acl Safe_ports port 210         # wais
acl Safe_ports port 1025-65535  # unregistered ports
acl Safe_ports port 280         # http-mgmt
acl Safe_ports port 488         # gss-http
acl Safe_ports port 591         # filemaker
acl Safe_ports port 777         # multiling http
acl CONNECT method CONNECT

#
# Deny requests to certain unsafe ports
http_access deny !Safe_ports

# Deny CONNECT to other than secure SSL ports
http_access deny CONNECT !SSL_ports

# Only allow cachemgr access from localhost
http_access allow localhost manager
http_access deny manager

#
# INSERT YOUR OWN RULE(S) HERE TO ALLOW ACCESS FROM YOUR CLIENTS
#
include /etc/squid/conf.d/*

#http_access allow localnet
http_access allow localhost

# And finally deny all other access to this proxy
#http_access deny all
http_access allow all


http_port 3128 ssl-bump cert=/opt/squid/etc/ssl_cert/myCA.pem generate-host-certificates=on dynamic_cert_mem_cache_size=4MB
sslcrtd_program /usr/lib/squid/security_file_certgen -s /opt/squid/log/squid/ssl_db -M 4MB
coredump_dir /opt/squid/var/cache/squid
cache_dir ufs /opt/squid/var/cache/squid 1000 16 256 # 1GB as Cache


# Squid normally listens to port 3128

#http_port 3128

# Leave coredumps in the first cache dir
coredump_dir /var/spool/squid



refresh_pattern ^ftp:           1440    20%     10080
refresh_pattern ^gopher:        1440    0%      1440
refresh_pattern -i (/cgi-bin/|\?) 0     0%      0
refresh_pattern .               0       20%     4320


regards

Micha?l


-----Message d'origine-----
De?: squid-users [mailto:squid-users-bounces at lists.squid-cache.org] De la part de squid-users-request at lists.squid-cache.org
Envoy??: samedi 6 avril 2019 14:00
??: squid-users at lists.squid-cache.org
Objet?: squid-users Digest, Vol 56, Issue 12

Send squid-users mailing list submissions to
	squid-users at lists.squid-cache.org

To subscribe or unsubscribe via the World Wide Web, visit
	http://lists.squid-cache.org/listinfo/squid-users
or, via email, send a message with subject or body 'help' to
	squid-users-request at lists.squid-cache.org

You can reach the person managing the list at
	squid-users-owner at lists.squid-cache.org

When replying, please edit your Subject line so it is more specific than "Re: Contents of squid-users digest..."


Today's Topics:

   1. youtube restriction. (Wegner Micha?l)
   2. Re: youtube restriction. (Vacheslav Zouhairy)
   3. Re: youtube restriction. (Antony Stone)


----------------------------------------------------------------------

Message: 1
Date: Fri, 05 Apr 2019 15:06:00 +0200
From: Wegner Micha?l <m.wegner at hopitaldugier.fr>
To: squid-users at lists.squid-cache.org
Subject: [squid-users] youtube restriction.
Message-ID: <527bfee2.1d4ebb0.29b980e7.db3 at hopitaldugier.fr>
Content-Type: text/plain; charset="iso-8859-1"

Hi,
 
I install squid + squidguard, and I can't play youtube video.
For example : https://m.youtube.com/watch?v=Hmj3LToi4W8 ; https://m.youtube.com/watch?v=jbBUQ-uvlRU
 
Error : video not available access to this video is limited
 
I have Ubuntu server 18.04 and squid v 3.5.27
 
Can' you help me please
 
Thanks,
 
Kind Regards
 
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20190405/0f1e17cf/attachment-0001.html>

------------------------------

Message: 2
Date: Fri, 05 Apr 2019 16:21:28 +0300
From: Vacheslav Zouhairy <m_zouhairy at skno.by>
To: squid-users at lists.squid-cache.org
Subject: Re: [squid-users] youtube restriction.
Message-ID: <edde432e1f0745413ed6d35d157a6abc025b7d3d.camel at skno.by>
Content-Type: text/plain; charset="utf-8"

time to try ufdbguard, it is very flexible and relatively easy to configure.
On Fri, 2019-04-05 at 15:06 +0200, Wegner Micha?l wrote:
> Hi,
>  
> I install squid + squidguard, and I can?t play youtube video.
> For example : https://m.youtube.com/watch?v=Hmj3LToi4W8 ; 
> https://m.youtube.com/watch?v=jbBUQ-uvlRU
>  
> Error : video not available
> access to this video is limited I have Ubuntu server 18.04 and squid v
> 3.5.27 Can? you help me please Thanks, Kind Regards 
> _______________________________________________squid-users mailing 
> listsquid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20190405/4c512724/attachment-0001.html>

------------------------------

Message: 3
Date: Fri, 5 Apr 2019 15:39:08 +0200
From: Antony Stone <Antony.Stone at squid.open.source.it>
To: squid-users at lists.squid-cache.org
Subject: Re: [squid-users] youtube restriction.
Message-ID: <201904051539.08777.Antony.Stone at squid.open.source.it>
Content-Type: Text/Plain;  charset="iso-8859-15"

On Friday 05 April 2019 at 15:06:00, Wegner Micha?l wrote:

> Hi,
> 
> I install squid + squidguard, and I can't play youtube video.
> For example : https://m.youtube.com/watch?v=Hmj3LToi4W8 ; 
> https://m.youtube.com/watch?v=jbBUQ-uvlRU
> 
> Error : video not available access to this video is limited

1. Does it work if you do not go via Squid and SquidGuard?

2. Can you play any other Youtube videos?

3. Given that this is an HTTPS connection, how are you restricting HTTPS content with SquidGuard?

> I have Ubuntu server 18.04 and squid v 3.5.27
> 
> Can' you help me please

Regards,


Antony.

--
"Measuring average network latency is about as useful as measuring the mean temperature of patients in a hospital."

 - St?phane Bortzmeyer

                                                   Please reply to the list;
                                                         please *don't* CC me.


------------------------------

Subject: Digest Footer

_______________________________________________
squid-users mailing list
squid-users at lists.squid-cache.org
http://lists.squid-cache.org/listinfo/squid-users


------------------------------

End of squid-users Digest, Vol 56, Issue 12
*******************************************



From Ralf.Hildebrandt at charite.de  Tue Apr  9 11:24:04 2019
From: Ralf.Hildebrandt at charite.de (Ralf Hildebrandt)
Date: Tue, 9 Apr 2019 13:24:04 +0200
Subject: [squid-users] Current downloads on
	http://www.squid-cache.org/Versions/v5/
Message-ID: <20190409112402.3mhmc5lld7uti45t@charite.de>

The most recent download is squid-5.0.0-20190331-rf5e179474 while
changesets lists a few more changes. Is the autogeneration of the
tarballs broken?

-- 
Ralf Hildebrandt                   Charite Universit?tsmedizin Berlin
ralf.hildebrandt at charite.de        Campus Benjamin Franklin
https://www.charite.de             Hindenburgdamm 30, 12203 Berlin
Gesch?ftsbereich IT, Abt. Netzwerk fon: +49-30-450.570.155


From leomessi983 at yahoo.com  Tue Apr  9 13:40:29 2019
From: leomessi983 at yahoo.com (leomessi983 at yahoo.com)
Date: Tue, 9 Apr 2019 13:40:29 +0000 (UTC)
Subject: [squid-users] hide squid name for clients
References: <99780358.458450.1554817229493.ref@mail.yahoo.com>
Message-ID: <99780358.458450.1554817229493@mail.yahoo.com>

HiWhen i use curl -I?http://foo.com squid will send his name and version to clients that i don't want to!!


root at debian:~# curl? -I http://youtube.com
HTTP/1.1 403 Forbidden
Server: squid/4.6
Mime-Version: 1.0
Date: Tue, 09 Apr 2019 13:34:36 GMT
Content-Type: text/html;charset=utf-8
Content-Length: 404
X-Squid-Error: ERR_ACCESS_DENIED 0
Vary: Accept-Language
Content-Language: en
X-Cache: MISS from LINUX-SRV
Via: 1.1? LINUX-SRV (squid/4.6)
Connection: keep-alive


How can i config squid to doesn't show this information to clients?!

TANK YOU 



-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20190409/952cdfe5/attachment.htm>

From squid3 at treenet.co.nz  Tue Apr  9 19:53:11 2019
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Wed, 10 Apr 2019 07:53:11 +1200
Subject: [squid-users] Current downloads on
 http://www.squid-cache.org/Versions/v5/
In-Reply-To: <20190409112402.3mhmc5lld7uti45t@charite.de>
References: <20190409112402.3mhmc5lld7uti45t@charite.de>
Message-ID: <67add3a5-98f9-6ff1-6968-8c22b1747ac7@treenet.co.nz>

On 9/04/19 11:24 pm, Ralf Hildebrandt wrote:
> The most recent download is squid-5.0.0-20190331-rf5e179474 while
> changesets lists a few more changes. Is the autogeneration of the
> tarballs broken?
> 

The tarballs and rsync are only published if the code builds
successfully on all our test systems. Right now there are three failing
to build with the latest committed changes.

Amos


From Ralf.Hildebrandt at charite.de  Tue Apr  9 21:35:48 2019
From: Ralf.Hildebrandt at charite.de (Ralf Hildebrandt)
Date: Tue, 9 Apr 2019 23:35:48 +0200
Subject: [squid-users] [ext] Re: Current downloads on
 http://www.squid-cache.org/Versions/v5/
In-Reply-To: <67add3a5-98f9-6ff1-6968-8c22b1747ac7@treenet.co.nz>
References: <20190409112402.3mhmc5lld7uti45t@charite.de>
 <67add3a5-98f9-6ff1-6968-8c22b1747ac7@treenet.co.nz>
Message-ID: <20190409213546.afczn5pp4ynrjd4f@charite.de>

* Amos Jeffries <squid3 at treenet.co.nz>:

> The tarballs and rsync are only published if the code builds
> successfully on all our test systems. Right now there are three failing
> to build with the latest committed changes.

Ah that's cool. I didn't know there was such a plausibility test.
Happy to wait then :)

-- 
Ralf Hildebrandt                   Charite Universit?tsmedizin Berlin
ralf.hildebrandt at charite.de        Campus Benjamin Franklin
https://www.charite.de             Hindenburgdamm 30, 12203 Berlin
Gesch?ftsbereich IT, Abt. Netzwerk fon: +49-30-450.570.155


From ngtech1ltd at gmail.com  Tue Apr  9 22:17:11 2019
From: ngtech1ltd at gmail.com (Eliezer Croitoru)
Date: Wed, 10 Apr 2019 01:17:11 +0300
Subject: [squid-users] squid-5.0.0-20190331-rf5e179474 cannot be built on
	CentOS 7
Message-ID: <523aed16-009f-cbd2-1f5f-bd61c4a8970c@gmail.com>

An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20190410/bd38d7e6/attachment.htm>

From ngtech1ltd at gmail.com  Tue Apr  9 22:25:35 2019
From: ngtech1ltd at gmail.com (Eliezer Croitoru)
Date: Wed, 10 Apr 2019 01:25:35 +0300
Subject: [squid-users] StoreID java example helper
In-Reply-To: <1554407700590-0.post@n4.nabble.com>
References: <004a01d4be64$82af7190$880e54b0$@ngtech.co.il>
 <1554407700590-0.post@n4.nabble.com>
Message-ID: <bad0681e-72bd-9c94-f795-fdfd34b5e9d3@gmail.com>

An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20190410/09f0d19a/attachment.htm>

From squid3 at treenet.co.nz  Wed Apr 10 05:21:12 2019
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Wed, 10 Apr 2019 17:21:12 +1200
Subject: [squid-users] squid-5.0.0-20190331-rf5e179474 cannot be built
 on CentOS 7
In-Reply-To: <523aed16-009f-cbd2-1f5f-bd61c4a8970c@gmail.com>
References: <523aed16-009f-cbd2-1f5f-bd61c4a8970c@gmail.com>
Message-ID: <78b99733-b1af-6132-4ae9-b6c6e3a08856@treenet.co.nz>

This is a squid-dev topic please.

FWIW though, CentOS 7 built that snapshot fine for our build farm. Only
Fedora and CentOS 6 had trouble with that build.

Amos


On 10/04/19 10:17 am, Eliezer Croitoru wrote:
> I have not got into great depth or details but the CentOS 7 build node I
> am using cannot build squid-5.0.0-20190331-rf5e179474 and the past 5.0
> series tar.bz2 files.
> 
> 
> I have tested these to build ontop of Debian 9.x but have not tested wet
> it yet to work properly as a production system.
> 
> 
> Eliezer
> 
> 
> -- 
> 
> ----
> 
> Eliezer Croitoru <http://ngtech.co.il/main-en/>
> Linux System Administrator
> Mobile: +972-5-28704261
> Email: eliezer at ngtech.co.il <mailto:eliezer at ngtech.co.il>
> 
> 
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users
> 


From squid3 at treenet.co.nz  Wed Apr 10 05:44:20 2019
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Wed, 10 Apr 2019 17:44:20 +1200
Subject: [squid-users] youtube restriction.
In-Reply-To: <201904081134.07513.Antony.Stone@squid.open.source.it>
References: <527bfee2.1d4ebb0.29b980e7.db3@hopitaldugier.fr>
 <201904051539.08777.Antony.Stone@squid.open.source.it>
 <201904081134.07513.Antony.Stone@squid.open.source.it>
Message-ID: <5477a8d4-dbd8-df8f-1beb-f1d2c0202bf0@treenet.co.nz>

On 8/04/19 9:34 pm, Antony Stone wrote:
> Hi.
> 
> I'm replying in the original thread, to keep this conversation together in the 
> archives etc.
> 
> On Monday 08 April 2019 at 11:15:00, Wegner Micha?l wrote:
> 
>> Hi Antony,
>>
>> The video is Ok, if i not used squid v3.5.
> 
> So, it's not Youtube blocking that particualr video in your country etc.
> 
>> If on the squid.conf file I disabled rediretion on squidgaurd the problem
>> is the same.
> 
> Okay, we can disregard SquidGuard as being the problem, then.
> 
>> If squid is actived, somme videos are blocked, (the videos in
>> restricted mode)
> 
> That tells us it's your Squid configuration which is causing the problem.
> 
>> With a old version of squid (2.6) there are no problems
> 
> There are a *lot* of differences between Squid 2.6 and 3.5, especially for 
> HTTPS.  You *have* made suitable adjustments to the configuration file, I hope?
> 
> 
> Antony.
> 

> -----Message d'origine-----
> De : Wegner Micha?l
> Envoy? : lundi 8 avril 2019 11:15
> 
> Hi Antony,
> 
> The video is Ok, if i not used squid v3.5.
> If on the squid.conf file I disabled rediretion on squidgaurd the problem is the same.
> If squid is actived, somme videos are blocked, (the videos in restricted mode) With a old version of squid (2.6) there are no problems
> 
> Regards,
> 
> Hi,
> 
> I install a new serveur squid version 4.6 without squiguard and access allow all.
> I set the ssl and i import certificate on the client but without success.
> 
> My squid.conf is : 
> 
...
> #
> # Deny requests to certain unsafe ports
> http_access deny !Safe_ports
> 
> # Deny CONNECT to other than secure SSL ports
> http_access deny CONNECT !SSL_ports
> 
> # Only allow cachemgr access from localhost
> http_access allow localhost manager
> http_access deny manager
> 
> #
> # INSERT YOUR OWN RULE(S) HERE TO ALLOW ACCESS FROM YOUR CLIENTS
> #
> include /etc/squid/conf.d/*

Do you have any config files in that directory? if so please post their
content too.

> 
> #http_access allow localnet
> http_access allow localhost
> 
> # And finally deny all other access to this proxy
> #http_access deny all
> http_access allow all
> 

Allowing anyone to send traffic through your proxy without limitation is
*not* a good idea. Now that you confirmed it makes no difference, please
remove again to avoid it adding complications.

If an error was showing up before to make you think this was a
possibility, we will need to see that message please.


> 
> http_port 3128 ssl-bump cert=/opt/squid/etc/ssl_cert/myCA.pem generate-host-certificates=on dynamic_cert_mem_cache_size=4MB
> sslcrtd_program /usr/lib/squid/security_file_certgen -s /opt/squid/log/squid/ssl_db -M 4MB
> coredump_dir /opt/squid/var/cache/squid
> cache_dir ufs /opt/squid/var/cache/squid 1000 16 256 # 1GB as Cache
> 

So you have "ssl-bump" and related settings on the port. This means that
Squid will attempt to decrypt the TLS/SSL traffic arriving in that ports
CONNECT requests.

However, there is no sign of any ssl_bump access controls. Which means
your Squid will *not* do the decryption. This config should act exactly
as if you had not specified ssl-bump at all. The TLS/SSL inside a
CONNECT tunnel is between the client and origin server directly -
exactly as if the proxy was not there.



PS. One thing to be aware of though is that YouTube being a Google
property is pushing use of newer protocols like HTTP/2, HTTP/3 and QUIC.
You may find that the traffic is not going over TCP at all or being
detected as an unsupported protocol.
 That latter would produce error responses - Squid-4 has
<http://www.squid-cache.org/Doc/config/on_unsupported_protocol/> to work
around that.


Amos


From squid3 at treenet.co.nz  Wed Apr 10 06:11:41 2019
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Wed, 10 Apr 2019 18:11:41 +1200
Subject: [squid-users] hide squid name for clients
In-Reply-To: <99780358.458450.1554817229493@mail.yahoo.com>
References: <99780358.458450.1554817229493.ref@mail.yahoo.com>
 <99780358.458450.1554817229493@mail.yahoo.com>
Message-ID: <3d5b1ecc-5cd5-a12d-4104-469c01030581@treenet.co.nz>

On 10/04/19 1:40 am, leomessi983 wrote:
> Hi
> When i use curl -I?http://foo.com squid will send his name and version
> to clients that i don't want to!!
> 
> 
> root at debian:~# curl? -I http://youtube.com
> HTTP/1.1 403 Forbidden
> Server: squid/4.6
> Mime-Version: 1.0
> Date: Tue, 09 Apr 2019 13:34:36 GMT
> Content-Type: text/html;charset=utf-8
> Content-Length: 404
> X-Squid-Error: ERR_ACCESS_DENIED 0
> Vary: Accept-Language
> Content-Language: en
> X-Cache: MISS from LINUX-SRV
> Via: 1.1? LINUX-SRV (squid/4.6)
> Connection: keep-alive
> 
> 
> How can i config squid to doesn't show this information to clients?!
> 


Why? Many of these details are needed to have good Internet
communication between the proxy and other HTTP agents receiving this
message.


For example; The above response is a statement of security policy *by
the proxy*. If the client is not made aware that it is a proxy response
there can be unwanted side effects in the security handling of whatever
domain the client was trying to fetch when the proxy created that
response. eg CORS restrictions on other content of the site which the
proxy would have allowed, failover to unexpected protocols, broken
origin XSS protections, etc.


You can configure
<http://www.squid-cache.org/Doc/config/httpd_suppress_version_string/>
if you want to hide the exact Squid version.

Other headers can be manipulated with
<http://www.squid-cache.org/Doc/config/reply_header_access/> and
<http://www.squid-cache.org/Doc/config/reply_header_replace/>, or
<http://www.squid-cache.org/Doc/config/reply_header_add/>. But please be
very careful if you do that, as mentioned above there can be surprising
side effects.


PS. Do not be embarrassed to be using a proxy. Most traffic on the
Internet these days goes through up to 6 proxies before it reaches the
client.

Amos


From davide.belloni at gmail.com  Wed Apr 10 09:14:18 2019
From: davide.belloni at gmail.com (Davide Belloni)
Date: Wed, 10 Apr 2019 11:14:18 +0200
Subject: [squid-users] Squid 4 ssl_bump issue
In-Reply-To: <CAPaB35mUc8gXt48qVg3khzSgsfWJsWRtGGsQZ2dBNA0_Gaj-7w@mail.gmail.com>
References: <CAPaB35=B6+hbYDMGC3BZXVhO8UVOg=zxdFswv--av3zHHb+aCg@mail.gmail.com>
 <8ccdbd38-1582-310c-0225-05b3a3139f09@treenet.co.nz>
 <CAPaB35mXWRLxOCCMxQyC+apCYWNtHkqWry7HvEu09WgpSuughA@mail.gmail.com>
 <CAPaB35nXEjj_m4Tf8uyV9S65VPS-iyBRu0bSZKfnm4O_WFZK1g@mail.gmail.com>
 <2a56b72e-911d-f600-cd4b-d4657ab33eda@treenet.co.nz>
 <CAPaB35nYChb5XFCpqDwu9ujnQt_ff1uY-JOmEOEuYj7=Jb6mkQ@mail.gmail.com>
 <38c28f48-44e4-0cd1-b63f-1412cc9ca481@treenet.co.nz>
 <CAPaB35m+MC9fQ-xneRO=3YptwB5Sxkaw1o6DEODEZGoUXHAGRQ@mail.gmail.com>
 <CAPaB35mUc8gXt48qVg3khzSgsfWJsWRtGGsQZ2dBNA0_Gaj-7w@mail.gmail.com>
Message-ID: <CAPaB35=738A=voigmR2Bn54zQt1Nt4rG+Y9hhbm3brCqPyzUBw@mail.gmail.com>

Hi,
in the request scope of cache log I cannot find nothing that suggest to a
configuration issue

Maybe is the time to open a bug?

On Tue, 9 Apr 2019 at 09:58, Davide Belloni <davide.belloni at gmail.com>
wrote:

> Hi,
> here the cache log in debug mode with the single request (previous email
> was blocked because the atachment was too big)
>
> Thanks
>
> On Mon, 8 Apr 2019 at 08:26, Davide Belloni <davide.belloni at gmail.com>
> wrote:
>
>> Hi,
>> here the cache log in debug mode with the single request
>>
>> Thanks
>>
>> On Fri, 5 Apr 2019 at 09:06, Amos Jeffries <squid3 at treenet.co.nz> wrote:
>>
>>>
>>> On 5/04/19 7:54 pm, Davide Belloni wrote:
>>> > Hi,
>>> > the setup is exactly what you suggested but still the ERROR shows up.
>>> > Here the startup sequence about context creation:
>>> >
>>>
>>> Okay that looked reasonable.
>>>
>>>
>>> >
>>> > If you want I can attach all the cache log with startup and one request
>>> > with error
>>> > Thanks
>>> >
>>>
>>> Ah, so the error shows up on first request?
>>>
>>> In that case then yes the trace from that please.
>>>
>>> Amos
>>>
>>
>>
>> --
>>
>> Davide Belloni
>> http://about.me/davidebelloni
>> http://www.linkedin.com/in/davidebelloni
>>
>
>
> --
>
> Davide Belloni
> http://about.me/davidebelloni
> http://www.linkedin.com/in/davidebelloni
>


-- 

Davide Belloni
http://about.me/davidebelloni
http://www.linkedin.com/in/davidebelloni
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20190410/a08ba67d/attachment.htm>

From eperez at quadrianweb.com  Wed Apr 10 14:37:30 2019
From: eperez at quadrianweb.com (Erick Perez - Quadrian Enterprises)
Date: Wed, 10 Apr 2019 09:37:30 -0500
Subject: [squid-users] domain in whitelist being denied
Message-ID: <CACXMG+s2ECY9ahhd2ke+=yO1rgmOtMdKP0N9koabLo04fvPrTQ@mail.gmail.com>

Hi,
I have added a new domain in my whitelist in squid (no caching, just
block/deny) and the domain is being blocked. suggestions?
I have included the relevant bits in the config. Nothing has changed
except for adding the new domain.

url: https://www.sqlsoftware.nom.co:8441

#/etc/squid/alloweddomains
.sqlsoftware.nom.co

#access.log
#
1554650994.238      0 10.231.0.53 TCP_DENIED/403 3742 CONNECT
www.sqlsoftware.nom.co:8441 - NONE/- text/html
1554650994.254      0 10.231.0.53 TCP_DENIED/403 3742 CONNECT
www.sqlsoftware.nom.co:8441 - NONE/- text/html
#

#squid.conf
#
acl mylan src 10.230.0.0/16
acl allowedsites dstdomain "/etc/squid/alloweddomains"
acl Safe_ports port 8441 # sqlsoftware.nom.co
acl CONNECT method CONNECT
# Deny requests to certain unsafe ports
http_access deny !Safe_ports
# Deny CONNECT to other than secure SSL ports
http_access deny CONNECT !SSL_ports
http_access allow mylan allowedsites
#

thanks,

---------------------
Erick Perez
---------------------


From ingoogni at gmail.com  Wed Apr 10 14:42:40 2019
From: ingoogni at gmail.com (ingo janssen)
Date: Wed, 10 Apr 2019 16:42:40 +0200
Subject: [squid-users] Can't get Squid configured properly
Message-ID: <5d9de5b8-8ce6-b486-4a3e-e29b440c9921@gmail.com>

My goal is to do some local modification through ICAP to websites before 
they hit my browser. The basics work, but then there is the SslBump.

Compiled and installed squid-4.6 on FreeBSD 12 in a jail with 
--with-openssl,  --enable-ssl-crtd amongst other options.

created certificates as per:
https://wiki.squid-cache.org/ConfigExamples/Intercept/SslBumpExplicit

Non encrypted sites work fine, no encripted site works:

"duckduckgo.com has a security policy called HTTP Strict Transport 
Security (HSTS), which means that Firefox can only connect to it 
securely. You can?t add an exception to visit this site."

with no advanced option to continue. Other sites give that option, but 
finally resulting in:

"
(92) Protocol error (TLS code: X509_V_ERR_UNABLE_TO_GET_ISSUER_CERT_LOCALLY)

SSL Certficate error: certificate issuer (CA) not known: /OU=GlobalSign 
Root CA - R2/O=GlobalSign/CN=GlobalSign
"

in the end all https sites directly or indirectly in that error. From 
what I read in various discussions after searching these errors 4.6 
should automatically download intermediate certificates.

Some guidance would be welcomed.

Config:
acl localnet src 192.168.0.0/16

acl SSL_ports port 443
acl Safe_ports port 80          # http
acl Safe_ports port 443         # https

acl step1 at_step SslBump1
acl step2 at_step SslBump2
acl step3 at_step SslBump3
acl ssl_exclude_domains ssl::server_name 
"/usr/local/etc/squid/ssl_excl_domains.conf"
ssl_bump splice localhost
ssl_bump peek step1 all
ssl_bump splice ssl_exclude_domains
ssl_bump bump all

http_access deny !Safe_ports
http_access deny !SSL_ports

http_access allow localhost manager
http_access deny manager

http_access allow localnet
http_access allow localhost

http_access deny all

http_port 3128 ssl-bump generate-host-certificates=on 
dynamic_cert_mem_cache_size=4MB tls-ce>
sslcrtd_program /usr/local/libexec/squid/security_file_certgen -s 
/var/squid/cache/ssl_db -M>
sslcrtd_children 5

cache deny all

coredump_dir /var/squid/cache

refresh_pattern ^ftp:           1440    20%     10080
refresh_pattern ^gopher:        1440    0%      1440
refresh_pattern -i (/cgi-bin/|\?) 0     0%      0
refresh_pattern .               0       20%     4320

TIA,

Ingo


From spokke at virtualbrain.info  Wed Apr 10 15:54:45 2019
From: spokke at virtualbrain.info (spokke)
Date: Wed, 10 Apr 2019 10:54:45 -0500 (CDT)
Subject: [squid-users] negotiate_wrapper_auth double free or corruption
Message-ID: <1554911685648-0.post@n4.nabble.com>

Ciao, 

we have a working squid 4  + AD SSO, system is a centos 7 virtual server,
squid it's installed from unofficial (but supported) repository
http://www1.ngtech.co.il...

This are the lines of the auth wrapper configuration

auth_param negotiate program /usr/lib64/squid/negotiate_wrapper_auth --ntlm
/usr/bin/ntlm_auth -d --diagnostics --helper-protocol=squid-2.5-ntlmssp
--domain=XXXXXXXXXX --kerberos /usr/lib64/squid/negotiate_kerberos_auth  -d
-k /etc/squid/PROXY.keytab -s GSS_C_NO_NAME
auth_param negotiate children 80 startup=40 idle=10
auth_param negotiate keep_alive off

all seems to work fine except of sometime on the cache log appear a really
ugly crash message:
** Error in `(negotiate_wrapper_auth)': double free or corruption (!prev):
0x00000000021c8980 ***
======= Backtrace: =========
/lib64/libc.so.6(+0x81489)[0x7fec93d8e489]
(negotiate_wrapper_auth)[0x401bb1]
(negotiate_wrapper_auth)[0x4016a6]
/lib64/libc.so.6(__libc_start_main+0xf5)[0x7fec93d2f3d5]
(negotiate_wrapper_auth)[0x40170b]
======= Memory map: ========
00400000-00404000 r-xp 00000000 fd:00 688457                            
/usr/lib64/squid/negotiate_wrapper_a
uth
00603000-00604000 r--p 00003000 fd:00 688457                            
/usr/lib64/squid/negotiate_wrapper_a
uth
00604000-00605000 rw-p 00004000 fd:00 688457                            
/usr/lib64/squid/negotiate_wrapper_a
uth
021c8000-021e9000 rw-p 00000000 00:00 0                                 
[heap]
7fec8c000000-7fec8c021000 rw-p 00000000 00:00 0 
7fec8c021000-7fec90000000 ---p 00000000 00:00 0 
7fec934df000-7fec934f6000 r-xp 00000000 fd:00 8151                      
/usr/lib64/libpthread-2.17.so
7fec934f6000-7fec936f5000 ---p 00017000 fd:00 8151                      
/usr/lib64/libpthread-2.17.so
7fec936f5000-7fec936f6000 r--p 00016000 fd:00 8151                      
/usr/lib64/libpthread-2.17.so
7fec936f6000-7fec936f7000 rw-p 00017000 fd:00 8151                      
/usr/lib64/libpthread-2.17.so
7fec936f7000-7fec936fb000 rw-p 00000000 00:00 0 
7fec936fb000-7fec936ff000 r-xp 00000000 fd:00 48464                     
/usr/lib64/libmnl.so.0.1.0
7fec936ff000-7fec938ff000 ---p 00004000 fd:00 48464                     
/usr/lib64/libmnl.so.0.1.0
7fec938ff000-7fec93900000 r--p 00004000 fd:00 48464                     
/usr/lib64/libmnl.so.0.1.0
7fec93900000-7fec93901000 rw-p 00005000 fd:00 48464                     
/usr/lib64/libmnl.so.0.1.0
7fec93901000-7fec93907000 r-xp 00000000 fd:00 48682                     
/usr/lib64/libnfnetlink.so.0.2.0
7fec93907000-7fec93b06000 ---p 00006000 fd:00 48682                     
/usr/lib64/libnfnetlink.so.0.2.0
7fec93b06000-7fec93b07000 r--p 00005000 fd:00 48682                     
/usr/lib64/libnfnetlink.so.0.2.0
7fec93b07000-7fec93b08000 rw-p 00006000 fd:00 48682                     
/usr/lib64/libnfnetlink.so.0.2.0
7fec93b08000-7fec93b0c000 r-xp 00000000 fd:00 17626                     
/usr/lib64/libattr.so.1.1.0
7fec93b0c000-7fec93d0b000 ---p 00004000 fd:00 17626                     
/usr/lib64/libattr.so.1.1.0
7fec93d0b000-7fec93d0c000 r--p 00003000 fd:00 17626                     
/usr/lib64/libattr.so.1.1.0
7fec93d0c000-7fec93d0d000 rw-p 00004000 fd:00 17626                     
/usr/lib64/libattr.so.1.1.0
7fec93d0d000-7fec93ecf000 r-xp 00000000 fd:00 8144                      
/usr/lib64/libc-2.17.so
7fec93ecf000-7fec940cf000 ---p 001c2000 fd:00 8144                      
/usr/lib64/libc-2.17.so
7fec940cf000-7fec940d3000 r--p 001c2000 fd:00 8144                      
/usr/lib64/libc-2.17.so
7fec940d3000-7fec940d5000 rw-p 001c6000 fd:00 8144                      
/usr/lib64/libc-2.17.so
7fec940d5000-7fec940da000 rw-p 00000000 00:00 0 
7fec940da000-7fec940ef000 r-xp 00000000 fd:00 635666                    
/usr/lib64/libgcc_s-4.8.5-20150702.s
o.1
7fec940ef000-7fec942ee000 ---p 00015000 fd:00 635666                    
/usr/lib64/libgcc_s-4.8.5-20150702.s
o.1
7fec942ee000-7fec942ef000 r--p 00014000 fd:00 635666                    
/usr/lib64/libgcc_s-4.8.5-20150702.s
o.1
7fec942ef000-7fec942f0000 rw-p 00015000 fd:00 635666                    
/usr/lib64/libgcc_s-4.8.5-20150702.s
o.1
7fec942f0000-7fec943f1000 r-xp 00000000 fd:00 743856                    
/usr/lib64/libm-2.17.so
7fec943f1000-7fec945f0000 ---p 00101000 fd:00 743856                    
/usr/lib64/libm-2.17.so
7fec945f0000-7fec945f1000 r--p 00100000 fd:00 743856                    
/usr/lib64/libm-2.17.so
7fec945f1000-7fec945f2000 rw-p 00101000 fd:00 743856                    
/usr/lib64/libm-2.17.so
7fec945f2000-7fec946db000 r-xp 00000000 fd:00 191114                    
/usr/lib64/libstdc++.so.6.0.19
7fec946db000-7fec948da000 ---p 000e9000 fd:00 191114                    
/usr/lib64/libstdc++.so.6.0.19
7fec948da000-7fec948e2000 r--p 000e8000 fd:00 191114                    
/usr/lib64/libstdc++.so.6.0.19
7fec948e2000-7fec948e4000 rw-p 000f0000 fd:00 191114                    
/usr/lib64/libstdc++.so.6.0.19
7fec948e4000-7fec948f9000 rw-p 00000000 00:00 0 
7fec948f9000-7fec94900000 r-xp 00000000 fd:00 8158                      
/usr/lib64/librt-2.17.so
7fec94900000-7fec94aff000 ---p 00007000 fd:00 8158                      
/usr/lib64/librt-2.17.so
7fec94aff000-7fec94b00000 r--p 00006000 fd:00 8158                      
/usr/lib64/librt-2.17.so
7fec94b00000-7fec94b01000 rw-p 00007000 fd:00 8158                      
/usr/lib64/librt-2.17.so
7fec94b01000-7fec94b1d000 r-xp 00000000 fd:00 49012                     
/usr/lib64/libnetfilter_conntrack.so
.3.6.0
7fec94b1d000-7fec94d1c000 ---p 0001c000 fd:00 49012                     
/usr/lib64/libnetfilter_conntrack.so
.3.6.0
7fec94d1c000-7fec94d1e000 r--p 0001b000 fd:00 49012                     
/usr/lib64/libnetfilter_conntrack.so
.3.6.0
7fec94d1e000-7fec94d1f000 rw-p 0001d000 fd:00 49012                     
/usr/lib64/libnetfilter_conntrack.so
.3.6.0
7fec94d1f000-7fec94d23000 r-xp 00000000 fd:00 17631                     
/usr/lib64/libcap.so.2.22
7fec94d23000-7fec94f22000 ---p 00004000 fd:00 17631                     
/usr/lib64/libcap.so.2.22
7fec94f22000-7fec94f23000 r--p 00003000 fd:00 17631                     
/usr/lib64/libcap.so.2.22
7fec94f23000-7fec94f24000 rw-p 00004000 fd:00 17631                     
/usr/lib64/libcap.so.2.22
7fec94f24000-7fec94f3a000 r-xp 00000000 fd:00 8155                      
/usr/lib64/libresolv-2.17.so
7fec94f3a000-7fec95139000 ---p 00016000 fd:00 8155                      
/usr/lib64/libresolv-2.17.so
7fec95139000-7fec9513a000 r--p 00015000 fd:00 8155                      
/usr/lib64/libresolv-2.17.so
7fec9513a000-7fec9513b000 rw-p 00016000 fd:00 8155                      
/usr/lib64/libresolv-2.17.so
7fec9513b000-7fec9513d000 rw-p 00000000 00:00 0 
7fec9513d000-7fec95153000 r-xp 00000000 fd:00 743858                    
/usr/lib64/libnsl-2.17.so
7fec95153000-7fec95353000 ---p 00016000 fd:00 743858                    
/usr/lib64/libnsl-2.17.so
7fec95353000-7fec95354000 r--p 00016000 fd:00 743858                    
/usr/lib64/libnsl-2.17.so
7fec95354000-7fec95355000 rw-p 00017000 fd:00 743858                    
/usr/lib64/libnsl-2.17.so
7fec95355000-7fec95357000 rw-p 00000000 00:00 0 
7fec95357000-7fec95359000 r-xp 00000000 fd:00 743854                    
/usr/lib64/libdl-2.17.so
7fec95359000-7fec95559000 ---p 00002000 fd:00 743854                    
/usr/lib64/libdl-2.17.so
7fec95559000-7fec9555a000 r--p 00002000 fd:00 743854                    
/usr/lib64/libdl-2.17.so
7fec9555a000-7fec9555b000 rw-p 00003000 fd:00 743854                    
/usr/lib64/libdl-2.17.so
7fec9555b000-7fec9557d000 r-xp 00000000 fd:00 7853                      
/usr/lib64/ld-2.17.so
7fec9576a000-7fec95773000 rw-p 00000000 00:00 0 
7fec9577a000-7fec9577c000 rw-p 00000000 00:00 0 
7fec9577c000-7fec9577d000 r--p 00021000 fd:00 7853                      
/usr/lib64/ld-2.17.so
7fec9577d000-7fec9577e000 rw-p 00022000 fd:00 7853                      
/usr/lib64/ld-2.17.so
7fec9577e000-7fec9577f000 rw-p 00000000 00:00 0 
7ffe2e6d9000-7ffe2e70e000 rw-p 00000000 00:00 0                         
[stack]
7ffe2e7b5000-7ffe2e7b7000 r-xp 00000000 00:00 0                         
[vdso]
ffffffffff600000-ffffffffff601000 r-xp 00000000 00:00 0                 
[vsyscall]
2019/04/10 08:36:08 kid1| WARNING: negotiateauthenticator #Hlpr488 exited
2019/04/10 08:36:08 kid1| Too few negotiateauthenticator processes are
running (need 10/60)
2019/04/10 08:36:08 kid1| Starting new helpers
2019/04/10 08:36:08 kid1| helperOpenServers: Starting 10/60
'negotiate_wrapper_auth' processes
2019/04/10 08:36:09 kid1| ERROR: Negotiate Authentication Helper '0/0'
crashed!.
2019/04/10 08:36:09 kid1| ERROR: Negotiate Authentication validating user.
Result: {result=Unknown}
*** Error in `(negotiate_wrapper_auth)': double free or corruption (!prev):
0x0000000002421980 ***
*** Error in `(negotiate_wrapper_auth)': double free or corruption (!prev):
0x00000000013a8980 ***
.....

seems that the wrapper crash but i dont undestand why...i've tried to reduce
or increase the number of childrens/startup/idle processes but the errors
always appear....someone can help me to undestand this issue??

thanks

Ale



--
Sent from: http://squid-web-proxy-cache.1019090.n4.nabble.com/Squid-Users-f1019091.html


From ingoogni at gmail.com  Wed Apr 10 16:08:02 2019
From: ingoogni at gmail.com (ingo janssen)
Date: Wed, 10 Apr 2019 18:08:02 +0200
Subject: [squid-users] Can't get Squid configured properly
In-Reply-To: <5d9de5b8-8ce6-b486-4a3e-e29b440c9921@gmail.com>
References: <5d9de5b8-8ce6-b486-4a3e-e29b440c9921@gmail.com>
Message-ID: <973be9f0-337c-ef4c-5511-d1dd1fc90b62@gmail.com>

Sorry to answer my own question,
after installing ca_root_nss most sites work.
Some though give a straight access denied.

Ingo


On 10-4-2019 16:42, ingo janssen wrote:

> 
> Some guidance would be welcomed.
> 


From rousskov at measurement-factory.com  Wed Apr 10 19:21:55 2019
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Wed, 10 Apr 2019 13:21:55 -0600
Subject: [squid-users] domain in whitelist being denied
In-Reply-To: <CACXMG+s2ECY9ahhd2ke+=yO1rgmOtMdKP0N9koabLo04fvPrTQ@mail.gmail.com>
References: <CACXMG+s2ECY9ahhd2ke+=yO1rgmOtMdKP0N9koabLo04fvPrTQ@mail.gmail.com>
Message-ID: <1240a556-904a-c15b-9269-65db53f07c2d@measurement-factory.com>

On 4/10/19 8:37 AM, Erick Perez - Quadrian Enterprises wrote:

> I have added a new domain in my whitelist in squid (no caching, just
> block/deny) and the domain is being blocked. suggestions?

In general:

1. Figure out which directive denies the transaction.
2. Adjust your configuration to allow the transaction.

Specifically in your case, I suspect that

#1 will point you to the "deny CONNECT !SSL_ports" rule and

#2 would result in adding port 8441 to the SSL_ports ACL.

You may also want to remove port 8441 from Safe_ports, depending on how
you use Safe_ports, and whether you consider port 8441 "safe" for your
specific usage.


HTH,

Alex.


> url: https://www.sqlsoftware.nom.co:8441
> 
> #/etc/squid/alloweddomains
> .sqlsoftware.nom.co
> 
> #access.log
> #
> 1554650994.238      0 10.231.0.53 TCP_DENIED/403 3742 CONNECT
> www.sqlsoftware.nom.co:8441 - NONE/- text/html
> 1554650994.254      0 10.231.0.53 TCP_DENIED/403 3742 CONNECT
> www.sqlsoftware.nom.co:8441 - NONE/- text/html
> #
> 
> #squid.conf
> #
> acl mylan src 10.230.0.0/16
> acl allowedsites dstdomain "/etc/squid/alloweddomains"
> acl Safe_ports port 8441 # sqlsoftware.nom.co
> acl CONNECT method CONNECT
> # Deny requests to certain unsafe ports
> http_access deny !Safe_ports
> # Deny CONNECT to other than secure SSL ports
> http_access deny CONNECT !SSL_ports
> http_access allow mylan allowedsites
> #


From rousskov at measurement-factory.com  Wed Apr 10 21:16:07 2019
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Wed, 10 Apr 2019 15:16:07 -0600
Subject: [squid-users] negotiate_wrapper_auth double free or corruption
In-Reply-To: <1554911685648-0.post@n4.nabble.com>
References: <1554911685648-0.post@n4.nabble.com>
Message-ID: <b227c5aa-f361-6d9b-d18e-fec13c5d4b12@measurement-factory.com>

On 4/10/19 9:54 AM, spokke wrote:
> sometime on the cache log appear a really ugly crash message:
> ** Error in `(negotiate_wrapper_auth)': double free or corruption (!prev):
> 0x00000000021c8980 ***
> ======= Backtrace: =========
> /lib64/libc.so.6(+0x81489)[0x7fec93d8e489]
> (negotiate_wrapper_auth)[0x401bb1]
> (negotiate_wrapper_auth)[0x4016a6]
> /lib64/libc.so.6(__libc_start_main+0xf5)[0x7fec93d2f3d5]
> (negotiate_wrapper_auth)[0x40170b]


> seems that the wrapper crash but i dont undestand why...

AFAICT, the wrapper is buggy[1]. However, this is not my area of
expertise, you may be suffering from other wrapper bugs, and/or problems
other than wrapper bugs may be causing the symptoms you are reporting.


> i've tried to reduce
> or increase the number of childrens/startup/idle processes but the errors
> always appear....someone can help me to undestand this issue??

The issue here is memory corruption, most likely due to a bug in some
software. See above for more details.

Alex.
[1] https://bugs.squid-cache.org/show_bug.cgi?id=4936


From eperez at quadrianweb.com  Wed Apr 10 21:56:48 2019
From: eperez at quadrianweb.com (Erick Perez - Quadrian Enterprises)
Date: Wed, 10 Apr 2019 16:56:48 -0500
Subject: [squid-users] domain in whitelist being denied
In-Reply-To: <1240a556-904a-c15b-9269-65db53f07c2d@measurement-factory.com>
References: <CACXMG+s2ECY9ahhd2ke+=yO1rgmOtMdKP0N9koabLo04fvPrTQ@mail.gmail.com>
 <1240a556-904a-c15b-9269-65db53f07c2d@measurement-factory.com>
Message-ID: <CACXMG+ucj7LTwpzLGnQXXg8X4fD7n-V5ut8Y17JO8UyXDi7teg@mail.gmail.com>

Alex, it worked perfectly.
removing the previous 8441 acl and the adding
acl SSL_ports port 8441
then a squid reload, all good to go!.

thanks.


---------------------
Erick Perez
Soluciones Tacticas Pasivas/Activas de Inteligencia y Analitica de
Datos para Gobiernos
Quadrian Enterprises S.A. - Panama, Republica de Panama
Skype chat: eaperezh
WhatsApp IM: +507-6675-5083
---------------------

On Wed, Apr 10, 2019 at 2:22 PM Alex Rousskov
<rousskov at measurement-factory.com> wrote:
>
> On 4/10/19 8:37 AM, Erick Perez - Quadrian Enterprises wrote:
>
> > I have added a new domain in my whitelist in squid (no caching, just
> > block/deny) and the domain is being blocked. suggestions?
>
> In general:
>
> 1. Figure out which directive denies the transaction.
> 2. Adjust your configuration to allow the transaction.
>
> Specifically in your case, I suspect that
>
> #1 will point you to the "deny CONNECT !SSL_ports" rule and
>
> #2 would result in adding port 8441 to the SSL_ports ACL.
>
> You may also want to remove port 8441 from Safe_ports, depending on how
> you use Safe_ports, and whether you consider port 8441 "safe" for your
> specific usage.
>
>
> HTH,
>
> Alex.
>
>
> > url: https://www.sqlsoftware.nom.co:8441
> >
> > #/etc/squid/alloweddomains
> > .sqlsoftware.nom.co
> >
> > #access.log
> > #
> > 1554650994.238      0 10.231.0.53 TCP_DENIED/403 3742 CONNECT
> > www.sqlsoftware.nom.co:8441 - NONE/- text/html
> > 1554650994.254      0 10.231.0.53 TCP_DENIED/403 3742 CONNECT
> > www.sqlsoftware.nom.co:8441 - NONE/- text/html
> > #
> >
> > #squid.conf
> > #
> > acl mylan src 10.230.0.0/16
> > acl allowedsites dstdomain "/etc/squid/alloweddomains"
> > acl Safe_ports port 8441 # sqlsoftware.nom.co
> > acl CONNECT method CONNECT
> > # Deny requests to certain unsafe ports
> > http_access deny !Safe_ports
> > # Deny CONNECT to other than secure SSL ports
> > http_access deny CONNECT !SSL_ports
> > http_access allow mylan allowedsites
> > #
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users


From squid3 at treenet.co.nz  Thu Apr 11 03:59:28 2019
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Thu, 11 Apr 2019 15:59:28 +1200
Subject: [squid-users] domain in whitelist being denied
In-Reply-To: <CACXMG+s2ECY9ahhd2ke+=yO1rgmOtMdKP0N9koabLo04fvPrTQ@mail.gmail.com>
References: <CACXMG+s2ECY9ahhd2ke+=yO1rgmOtMdKP0N9koabLo04fvPrTQ@mail.gmail.com>
Message-ID: <009f3ddc-1301-9ad2-c4d2-088369d13bb6@treenet.co.nz>

On 11/04/19 2:37 am, Erick Perez - Quadrian Enterprises wrote:
> Hi,
> I have added a new domain in my whitelist in squid (no caching, just
> block/deny) and the domain is being blocked. suggestions?

The domain is not being blocked. Either the client or the tunnel is.



> I have included the relevant bits in the config.

The relevant config is not what you think it is.

> Nothing has changed
> except for adding the new domain.

To me it looks like you added the whitelist ACLs and the access control
checking them.


> 
> url: https://www.sqlsoftware.nom.co:8441
> 
> #/etc/squid/alloweddomains
> .sqlsoftware.nom.co
> 
> #access.log
> #
> 1554650994.238      0 10.231.0.53 TCP_DENIED/403 3742 CONNECT
> www.sqlsoftware.nom.co:8441 - NONE/- text/html
> 1554650994.254      0 10.231.0.53 TCP_DENIED/403 3742 CONNECT
> www.sqlsoftware.nom.co:8441 - NONE/- text/html
> #
> 
> #squid.conf
> #
> acl mylan src 10.230.0.0/16

The client 10.231.0.53 is not within that CIDR range.

You need to test from a client within the LAN range or extend the
"mylan" to *actually* list your LAN.


> acl allowedsites dstdomain "/etc/squid/alloweddomains"
> acl Safe_ports port 8441 # sqlsoftware.nom.co

If you use the default Safe_ports ACL definition this port was already
included there. No need for this line unless you have reduced the
provided Safe_ports ACL.


> acl CONNECT method CONNECT
> # Deny requests to certain unsafe ports
> http_access deny !Safe_ports
> # Deny CONNECT to other than secure SSL ports
> http_access deny CONNECT !SSL_ports

Port 8441 is not port 443 (HTTPS). Assuming that you don't have any
previous http_access rules doing weird things this is where the denial
comes from right now.

You need check that the traffic to this port is actually safe for
bypassing the proxy controls completely (that is what happens with CONNECT).

If that is what you actually want, add this port to the SSL_Ports list.


Amos


From squid3 at treenet.co.nz  Thu Apr 11 04:01:34 2019
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Thu, 11 Apr 2019 16:01:34 +1200
Subject: [squid-users] domain in whitelist being denied
In-Reply-To: <CACXMG+ucj7LTwpzLGnQXXg8X4fD7n-V5ut8Y17JO8UyXDi7teg@mail.gmail.com>
References: <CACXMG+s2ECY9ahhd2ke+=yO1rgmOtMdKP0N9koabLo04fvPrTQ@mail.gmail.com>
 <1240a556-904a-c15b-9269-65db53f07c2d@measurement-factory.com>
 <CACXMG+ucj7LTwpzLGnQXXg8X4fD7n-V5ut8Y17JO8UyXDi7teg@mail.gmail.com>
Message-ID: <3ff33bb9-b2d6-eba1-bd27-4278550dc347@treenet.co.nz>

On 11/04/19 9:56 am, Erick Perez - Quadrian Enterprises wrote:
> Alex, it worked perfectly.
> removing the previous 8441 acl and the adding
> acl SSL_ports port 8441
> then a squid reload, all good to go!.
> 

That tells me something else is going on in your config because the
client IP address is not allowed by the rules you showed us.

Amos


From squid3 at treenet.co.nz  Thu Apr 11 05:27:21 2019
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Thu, 11 Apr 2019 17:27:21 +1200
Subject: [squid-users] Squid 4 ssl_bump issue
In-Reply-To: <CAPaB35=738A=voigmR2Bn54zQt1Nt4rG+Y9hhbm3brCqPyzUBw@mail.gmail.com>
References: <CAPaB35=B6+hbYDMGC3BZXVhO8UVOg=zxdFswv--av3zHHb+aCg@mail.gmail.com>
 <8ccdbd38-1582-310c-0225-05b3a3139f09@treenet.co.nz>
 <CAPaB35mXWRLxOCCMxQyC+apCYWNtHkqWry7HvEu09WgpSuughA@mail.gmail.com>
 <CAPaB35nXEjj_m4Tf8uyV9S65VPS-iyBRu0bSZKfnm4O_WFZK1g@mail.gmail.com>
 <2a56b72e-911d-f600-cd4b-d4657ab33eda@treenet.co.nz>
 <CAPaB35nYChb5XFCpqDwu9ujnQt_ff1uY-JOmEOEuYj7=Jb6mkQ@mail.gmail.com>
 <38c28f48-44e4-0cd1-b63f-1412cc9ca481@treenet.co.nz>
 <CAPaB35m+MC9fQ-xneRO=3YptwB5Sxkaw1o6DEODEZGoUXHAGRQ@mail.gmail.com>
 <CAPaB35mUc8gXt48qVg3khzSgsfWJsWRtGGsQZ2dBNA0_Gaj-7w@mail.gmail.com>
 <CAPaB35=738A=voigmR2Bn54zQt1Nt4rG+Y9hhbm3brCqPyzUBw@mail.gmail.com>
Message-ID: <2d771974-2e23-4b10-87a5-f390114119cc@treenet.co.nz>

On 10/04/19 9:14 pm, Davide Belloni wrote:
> Hi,
> in the request scope of cache log I cannot find nothing that suggest to
> a configuration issue
> 

It may be related to the session cache being set to '0'. The log shows
the server context being created, then destroyed just before the code
produces that error message. The code is relying on the SSL_CTX pointer
being stored somewhere which is not storing it in the bumping code path
your setup uses.


> Maybe is the time to open a bug?
> 

Please do. I have unfortunately run out of time to dedicate to looking
into this.


Amos


From ais.otacoder at gmail.com  Thu Apr 11 06:38:12 2019
From: ais.otacoder at gmail.com (Ota Coder)
Date: Thu, 11 Apr 2019 14:38:12 +0800
Subject: [squid-users] Permission denied on
	/usr/share/squid/errors/templates and /usr/share/squid/icons/silk
Message-ID: <CAEACB1WwWBRxFV2bzcYJsbB+Rhfq8b17zJjF-bfpvHpa8gFGmw@mail.gmail.com>

Hi!

I'm on Slackware 14.2 and installed Squid version 3.5.26 but I'm having
this problem everytime I ran in the terminal:

# squid -z
# squid -N -D -d1

and check the /var/log/squid/cache.log

Most of the errors shown is "(13) Permission denied" on the files at
folders /usr/share/squid/errors/templates/ and usr/share/squid/icons/silk/

Here's an excerpt:

2019/04/11 14:04:22| '/usr/share/squid/errors/templates/ERR_ACCESS_DENIED':
(13) Permission denied
2019/04/11 14:04:22| WARNING: failed to find or read error text file
ERR_ACCESS_DENIED
2019/04/11 14:04:22|
'/usr/share/squid/errors/templates/ERR_CACHE_ACCESS_DENIED': (13)
Permission denied
2019/04/11 14:04:22| WARNING: failed to find or read error text file
ERR_CACHE_ACCESS_DENIED
2019/04/11 14:04:22|
'/usr/share/squid/errors/templates/ERR_CACHE_MGR_ACCESS_DENIED': (13)
Permission denied
2019/04/11 14:04:22| WARNING: failed to find or read error text file
ERR_CACHE_MGR_ACCESS_DENIED
2019/04/11 14:04:22|
'/usr/share/squid/errors/templates/ERR_FORWARDING_DENIED': (13) Permission
denied
2019/04/11 14:04:22| WARNING: failed to find or read error text file
ERR_FORWARDING_DENIED
2019/04/11 14:04:22| '/usr/share/squid/errors/templates/ERR_NO_RELAY': (13)
Permission denied
2019/04/11 14:04:22| WARNING: failed to find or read error text file
ERR_NO_RELAY
2019/04/11 14:04:22|
'/usr/share/squid/errors/templates/ERR_CANNOT_FORWARD': (13) Permission
denied
2019/04/11 14:04:22| WARNING: failed to find or read error text file
ERR_CANNOT_FORWARD
2019/04/11 14:04:22| '/usr/share/squid/errors/templates/ERR_READ_TIMEOUT':
(13) Permission denied
2019/04/11 14:04:22| WARNING: failed to find or read error text file
ERR_READ_TIMEOUT
2019/04/11 14:04:22| '/usr/share/squid/errors/templates/ERR_LIFETIME_EXP':
(13) Permission denied
2019/04/11 14:04:22| WARNING: failed to find or read error text file
ERR_LIFETIME_EXP
2019/04/11 14:04:22| '/usr/share/squid/errors/templates/ERR_READ_ERROR':
(13) Permission denied
2019/04/11 14:04:22| WARNING: failed to find or read error text file
ERR_READ_ERROR

...

2019/04/11 14:04:22| ERROR: opening icon file
/usr/share/squid/icons/silk/image.png: (13) Permission denied
2019/04/11 14:04:22| ERROR: opening icon file
/usr/share/squid/icons/silk/page_white_text.png: (13) Permission denied
2019/04/11 14:04:22| ERROR: opening icon file
/usr/share/squid/icons/silk/arrow_up.png: (13) Permission denied
2019/04/11 14:04:22| ERROR: opening icon file
/usr/share/squid/icons/silk/folder.png: (13) Permission denied
2019/04/11 14:04:22| ERROR: opening icon file
/usr/share/squid/icons/silk/link.png: (13) Permission denied
2019/04/11 14:04:22| ERROR: opening icon file
/usr/share/squid/icons/SN.png: (13) Permission denied
2019/04/11 14:04:22| ERROR: opening icon file
/usr/share/squid/icons/silk/folder_table.png: (13) Permission denied
2019/04/11 14:04:22| ERROR: opening icon file
/usr/share/squid/icons/silk/music.png: (13) Permission denied
2019/04/11 14:04:22| ERROR: opening icon file
/usr/share/squid/icons/silk/film.png: (13) Permission denied
2019/04/11 14:04:22| ERROR: opening icon file
/usr/share/squid/icons/silk/computer_link.png: (13) Permission denied
2019/04/11 14:04:22| ERROR: opening icon file
/usr/share/squid/icons/silk/application.png: (13) Permission denied
2019/04/11 14:04:22| ERROR: opening icon file
/usr/share/squid/icons/silk/bullet_red.png: (13) Permission denied
2019/04/11 14:04:22| ERROR: opening icon file
/usr/share/squid/icons/silk/page_white.png: (13) Permission denied
2019/04/11 14:04:22| ERROR: opening icon file
/usr/share/squid/icons/silk/package_go.png: (13) Permission denied
2019/04/11 14:04:22| ERROR: opening icon file
/usr/share/squid/icons/silk/page_white_acrobat.png: (13) Permission denied
2019/04/11 14:04:22| ERROR: opening icon file
/usr/share/squid/icons/silk/page_green.png: (13) Permission denied
2019/04/11 14:04:22| ERROR: opening icon file
/usr/share/squid/icons/silk/page_white_picture.png: (13) Permission denied
2019/04/11 14:04:22| ERROR: opening icon file
/usr/share/squid/icons/silk/compress.png: (13) Permission denied
2019/04/11 14:04:22| ERROR: opening icon file
/usr/share/squid/icons/silk/script.png: (13) Permission denied
2019/04/11 14:04:22| ERROR: opening icon file
/usr/share/squid/icons/silk/database.png: (13) Permission denied
2019/04/11 14:04:22| ERROR: opening icon file
/usr/share/squid/icons/silk/cd.png: (13) Permission denied
2019/04/11 14:04:22| ERROR: opening icon file
/usr/share/squid/icons/silk/page_white_magnify.png: (13) Permission denied
2019/04/11 14:04:22| ERROR: opening icon file
/usr/share/squid/icons/silk/box.png: (13) Permission denied
2019/04/11 14:04:22| ERROR: opening icon file
/usr/share/squid/icons/silk/page_white_stack.png: (13) Permission denied

Here is the complete output in the cache.log - http://termbin.com/apfa

I typed in lsattr -R on /usr/share/squid and this is the result -
http://termbin.com/k37c

I checked the permissions and owner at /usr/share/squid/errors/templates/
and it is correct - http://termbin.com/jo0e

The cache_effective_user in /etc/squid/squid.conf is "squid" and the
cache_effective_group is "squid"

I mostly followed the settings written in this post -
https://www.linuxquestions.org/questions/blog/arniekat-436077/slackware-14-1-squid-3-4-7-36215/

But yeah, when I ran:

# squid -N -D -d1

squid really doesn't start when I checked when I ran:

# netstat -ltup

port 3128 doesn't show and squid is not in the output

Any help in fixing this soon is very much appreciated.

Thank you in advance.

Ais
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20190411/5c43b6f2/attachment.htm>

From davide.belloni at gmail.com  Thu Apr 11 08:00:03 2019
From: davide.belloni at gmail.com (Davide Belloni)
Date: Thu, 11 Apr 2019 10:00:03 +0200
Subject: [squid-users] Squid 4 ssl_bump issue
In-Reply-To: <2d771974-2e23-4b10-87a5-f390114119cc@treenet.co.nz>
References: <CAPaB35=B6+hbYDMGC3BZXVhO8UVOg=zxdFswv--av3zHHb+aCg@mail.gmail.com>
 <8ccdbd38-1582-310c-0225-05b3a3139f09@treenet.co.nz>
 <CAPaB35mXWRLxOCCMxQyC+apCYWNtHkqWry7HvEu09WgpSuughA@mail.gmail.com>
 <CAPaB35nXEjj_m4Tf8uyV9S65VPS-iyBRu0bSZKfnm4O_WFZK1g@mail.gmail.com>
 <2a56b72e-911d-f600-cd4b-d4657ab33eda@treenet.co.nz>
 <CAPaB35nYChb5XFCpqDwu9ujnQt_ff1uY-JOmEOEuYj7=Jb6mkQ@mail.gmail.com>
 <38c28f48-44e4-0cd1-b63f-1412cc9ca481@treenet.co.nz>
 <CAPaB35m+MC9fQ-xneRO=3YptwB5Sxkaw1o6DEODEZGoUXHAGRQ@mail.gmail.com>
 <CAPaB35mUc8gXt48qVg3khzSgsfWJsWRtGGsQZ2dBNA0_Gaj-7w@mail.gmail.com>
 <CAPaB35=738A=voigmR2Bn54zQt1Nt4rG+Y9hhbm3brCqPyzUBw@mail.gmail.com>
 <2d771974-2e23-4b10-87a5-f390114119cc@treenet.co.nz>
Message-ID: <CAPaB35kuriq1aOrv7hU=BDjCF1h4RLJG0c3yJoN9w-joTHzKiw@mail.gmail.com>

Ok,
here we are: https://bugs.squid-cache.org/show_bug.cgi?id=4938

On Thu, 11 Apr 2019 at 07:27, Amos Jeffries <squid3 at treenet.co.nz> wrote:

> On 10/04/19 9:14 pm, Davide Belloni wrote:
> > Hi,
> > in the request scope of cache log I cannot find nothing that suggest to
> > a configuration issue
> >
>
> It may be related to the session cache being set to '0'. The log shows
> the server context being created, then destroyed just before the code
> produces that error message. The code is relying on the SSL_CTX pointer
> being stored somewhere which is not storing it in the bumping code path
> your setup uses.
>
>
> > Maybe is the time to open a bug?
> >
>
> Please do. I have unfortunately run out of time to dedicate to looking
> into this.
>
>
> Amos
>


-- 

Davide Belloni
http://about.me/davidebelloni
http://www.linkedin.com/in/davidebelloni
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20190411/dca5a06f/attachment.htm>

From squid3 at treenet.co.nz  Fri Apr 12 15:34:13 2019
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Sat, 13 Apr 2019 03:34:13 +1200
Subject: [squid-users] Permission denied on
 /usr/share/squid/errors/templates and /usr/share/squid/icons/silk
In-Reply-To: <CAEACB1WwWBRxFV2bzcYJsbB+Rhfq8b17zJjF-bfpvHpa8gFGmw@mail.gmail.com>
References: <CAEACB1WwWBRxFV2bzcYJsbB+Rhfq8b17zJjF-bfpvHpa8gFGmw@mail.gmail.com>
Message-ID: <d1d0152b-175f-045a-9b70-1023d9cd142b@treenet.co.nz>

On 11/04/19 6:38 pm, Ota Coder wrote:
> Hi!
> 
> I'm on Slackware 14.2 and installed Squid version 3.5.26 but I'm having
> this problem everytime I ran in the terminal:
> 
> # squid -z
> # squid -N -D -d1
> 
> and check the /var/log/squid/cache.log
> 
> Most of the errors shown is "(13) Permission denied" on the files at
> folders /usr/share/squid/errors/templates/ and usr/share/squid/icons/silk/
> 
> Here's an excerpt:
> 
> 2019/04/11 14:04:22|
> '/usr/share/squid/errors/templates/ERR_ACCESS_DENIED': (13) Permission
> denied
> 2019/04/11 14:04:22| WARNING: failed to find or read error text file
> ERR_ACCESS_DENIED

...
> Here is the complete output in the cache.log - http://termbin.com/apfa
> 
> I typed in lsattr -R on /usr/share/squid and this is the result -
> http://termbin.com/k37c
> 
> I checked the permissions and owner at
> /usr/share/squid/errors/templates/ and it is correct -
> http://termbin.com/jo0e


IIRC; Squid also needs read access to all directories along in the path.
If you are manually setting permissions that may have been overlooked.

Also, check if there is anything like SELinux or AppArmor running on the
machine. They can prevent access to files despite what the Unix
permissions say.


> 
> The cache_effective_user in /etc/squid/squid.conf is "squid" and the
> cache_effective_group is "squid"
> 
> I mostly followed the settings written in this post -
> https://www.linuxquestions.org/questions/blog/arniekat-436077/slackware-14-1-squid-3-4-7-36215/
> 
> But yeah, when I ran:
> 
> # squid -N -D -d1
> 
> squid really doesn't start when I checked when I ran:


According to your cache.log Squid exited due to inability to write to
the access.log files:

2019/04/11 14:04:30| logfileHandleWrite:
daemon:/var/log/squid/access.log: error writing ((32) Broken pipe)


Amos


From johnrefwe at mail.com  Fri Apr 12 21:21:13 2019
From: johnrefwe at mail.com (johnr)
Date: Fri, 12 Apr 2019 16:21:13 -0500 (CDT)
Subject: [squid-users] Logging ICAP headers in access log
Message-ID: <1555104073279-0.post@n4.nabble.com>

Hi,

I am attempting to log ICAP headers in the access log. Specifically, I
modify my logformat directive to include something like
{x-icap-info}icap::>h for a header x-icap-info that is available in the icap
request headers. 

>From the logformat documentation
(http://www.squid-cache.org/Doc/config/logformat/) it says that log codes
mentioned in icap_log (http://www.squid-cache.org/Doc/config/icap_log/) are
available if icap is enabled. I am able to successfully log icap:tt in the
access log, but logging the headers has not been working. 

Am I mistaken in thinking this is possible or is it perhaps just a case of
not using the correct syntax?

Thank you for any help,

John



--
Sent from: http://squid-web-proxy-cache.1019090.n4.nabble.com/Squid-Users-f1019091.html


From squid3 at treenet.co.nz  Sat Apr 13 05:56:16 2019
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Sat, 13 Apr 2019 17:56:16 +1200
Subject: [squid-users] Logging ICAP headers in access log
In-Reply-To: <1555104073279-0.post@n4.nabble.com>
References: <1555104073279-0.post@n4.nabble.com>
Message-ID: <1ad0e2c9-e167-4440-85ae-9e63cca981ed@treenet.co.nz>

On 13/04/19 9:21 am, johnr wrote:
> Hi,
> 
> I am attempting to log ICAP headers in the access log. Specifically, I
> modify my logformat directive to include something like
> {x-icap-info}icap::>h for a header x-icap-info that is available in the icap
> request headers. 
> 
> From the logformat documentation
> (http://www.squid-cache.org/Doc/config/logformat/) it says that log codes
> mentioned in icap_log (http://www.squid-cache.org/Doc/config/icap_log/) are
> available if icap is enabled. I am able to successfully log icap:tt in the
> access log, but logging the headers has not been working. 
> 
> Am I mistaken in thinking this is possible or is it perhaps just a case of
> not using the correct syntax?

Is ICAP REQMOD or ICAP RESPMOD or both being used?

Are multiple ICAP services being used?

Are ICAP access controls being used?
 if so what config?

What *are* you seeing logged?

What exactly is the header name you are trying to log?

Have you tried it with case-sensitive naming?

Have you tried just %icap::>h to show the full set of ICAP headers the
transaction has when logging to access.log?

Please be aware that the ICAP codes are only expected to produce output
*if* the HTTP transaction was passed to an ICAP server. Some requests do
not get that far and should be producing a '-' instead.


Does cache.log contain any mention of problems?
  particularly on startup or reconfigure.

Does "squid -k parse" mention any WARNING or ERROR about your config?
 If so please fix those to ensure no bad config is interferring.

And finally, what version and build of Squid are you using?
 (output of "squid -v" please)


Amos


From portalnet2 at outlook.com.br  Sat Apr 13 12:14:28 2019
From: portalnet2 at outlook.com.br (Pedro Daniel Costa)
Date: Sat, 13 Apr 2019 12:14:28 +0000
Subject: [squid-users] Squid-4.6 compile errors
Message-ID: <CP2PR80MB00339E02443107F8D3C94141BB290@CP2PR80MB0033.lamprd80.prod.outlook.com>


Hi guys

I am a newbie initiating on squid, i have managed to download squid-4.6 on my ubuntu server and i am trying to compile it for transparente proxy mode with https

But Its giving me compile errors apparently if I enable -enable-ssl  option.

I read on the changelogs that ssl apparently has been removed on latest version 4.6


Can someone advise me on the configuration compile mode example that I can use in order to compile 4.6 version successfully ?


Also is it true that we can now cache https content without installing intercept certificates on clients devices?  Or we do still need to install the client browser certificate on the client browser side? As I have read some example of installing the certificate automatically on the client side using the root ca1 ?


Thanks in advance


-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20190413/bc168c57/attachment.htm>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: image001.gif
Type: image/gif
Size: 2488 bytes
Desc: image001.gif
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20190413/bc168c57/attachment.gif>

From portalnet2 at outlook.com.br  Sat Apr 13 13:40:52 2019
From: portalnet2 at outlook.com.br (tester100)
Date: Sat, 13 Apr 2019 08:40:52 -0500 (CDT)
Subject: [squid-users] Squid 4.6 Transparent HTTP & HTTPS Proxy
In-Reply-To: <1551962112557-0.post@n4.nabble.com>
References: <1551961038560-0.post@n4.nabble.com>
 <201903071321.54569.Antony.Stone@squid.open.source.it>
 <1551962112557-0.post@n4.nabble.com>
Message-ID: <1555162852755-0.post@n4.nabble.com>

Hiya

i am trying to compile squid 4.6 also with the same configure as shown here
but its giving me error on the enable-ssl  option..


I have managed to compile it without the --enable-ssl function, but then
again

in the ssl_crtd files  there is no files generated therefore it shows the
following error


/etc/squid/ssl_certs# /usr/lib/squid/ssl_crtd: No such file or directory
bash: /usr/lib/squid/ssl_crtd:: No such file or directory



dkanejs wrote
> Thanks for the reply and apologies my post didn't include the HTML
> fragments:
> 
> Configuration:
> 
> ./configure \
>     --enable-ssl \
>     --enable-ssl-crtd \
>     --with-openssl \
>     --disable-arch-native \
>     --prefix=/usr \
>     --localstatedir=/var \
>     --sysconfdir=/etc/squid \
>     --libexecdir=/usr/lib/squid \
>     --datadir=/usr/share/squid \
>     --with-default-user=proxy \
>     --with-logdir=/var/log/squid \
>     --with-pidfile=/var/run/squid.pid
> 
> Squid configuration:
> 
> visible_hostname squid
> http_port 3128
> acl whitelist dstdomain .example.com
> http_access allow whitelist
> https_port 3129 cert=/etc/squid/squid.pem
> options=NO_SSLv2,NO_SSLv3,NO_TLSv1,NO_TLSv1_1,NO_TICKET 
> cipher=HIGH:MEDIUM:!RC4:!aNULL:!eNULL:!LOW:!3DES:!MD5:!EXP:!PSK:!SRP:!DSS
> ssl-bump intercept
> acl SSL_port port 443
> http_access allow SSL_port
> acl CONNECT method CONNECT
> acl step1 at_step SslBump1
> acl step2 at_step SslBump2
> acl step3 at_step SslBump3
> ssl_bump peek step1 all
> ssl_bump peek step2 whitelist
> ssl_bump splice step3 whitelist
> ssl_bump terminate step2 all
> http_access deny all
> coredump_dir /var/cache/squid/
> 
> iptables:
> 
> iptables -t nat -I PREROUTING -p tcp --dport 80 -j REDIRECT --to-port 3128
> iptables -t nat -I PREROUTING -p tcp --dport 443 -j REDIRECT --to-port
> 3129
> 
> Access log:
> 
> 1551954200.914     54 10.0.1.166 NONE_ABORTED/200 0 CONNECT
> 93.184.216.34:443 - HIER_NONE/- -
> 1551954214.370      0 10.0.1.166 NONE/400 3810 GET / - HIER_NONE/-
> text/html
> 1551954217.223      0 10.0.1.166 NONE/400 3810 GET / - HIER_NONE/-
> text/html
> 1551954256.558      0 10.0.1.166 NONE/400 3810 GET / - HIER_NONE/-
> text/html
> 1551954261.638      0 10.0.1.166 NONE/400 3810 GET / - HIER_NONE/-
> text/html
> 1551954273.516    215 10.0.1.166 NONE_ABORTED/200 0 CONNECT
> 93.184.216.34:443 - HIER_NONE/- -
> 1551954391.304      1 185.59.221.44 NONE_ABORTED/200 0 CONNECT
> 10.0.0.151:443 - HIER_NONE/- -
> 1551954395.346      0 185.59.221.44 NONE_ABORTED/200 0 CONNECT
> 10.0.0.151:443 - HIER_NONE/- -
> 1551954398.938      0 185.59.221.44 NONE_ABORTED/200 0 CONNECT
> 10.0.0.151:443 - HIER_NONE/- -
> 
> Thanks again,
> David
> 
> 
> 
> --
> Sent from:
> http://squid-web-proxy-cache.1019090.n4.nabble.com/Squid-Users-f1019091.html
> _______________________________________________
> squid-users mailing list

> squid-users at .squid-cache

> http://lists.squid-cache.org/listinfo/squid-users





--
Sent from: http://squid-web-proxy-cache.1019090.n4.nabble.com/Squid-Users-f1019091.html


From squid3 at treenet.co.nz  Sat Apr 13 14:03:36 2019
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Sun, 14 Apr 2019 02:03:36 +1200
Subject: [squid-users] Squid-4.6 compile errors
In-Reply-To: <CP2PR80MB00339E02443107F8D3C94141BB290@CP2PR80MB0033.lamprd80.prod.outlook.com>
References: <CP2PR80MB00339E02443107F8D3C94141BB290@CP2PR80MB0033.lamprd80.prod.outlook.com>
Message-ID: <a1433e58-17c3-b440-0fa4-d9ada2d4f1d7@treenet.co.nz>

On 14/04/19 12:14 am, Pedro Daniel Costa wrote:
> Hi guys
> 
> 
> I am a newbie initiating on squid, i have managed to download squid-4.6
> on my ubuntu server and i am trying to compile it for transparente proxy
> mode with https
> 
> ?
> 
> But Its giving me compile errors apparently if I enable ?enable-ssl? option.
> 

That build option does not exist in Squid-4 (nor v3.5).

<http://www.squid-cache.org/Versions/v3/3.5/squid-3.5.28-RELEASENOTES.html#ss4.3>

> 
> I read on the changelogs that ssl apparently has been removed on latest
> version 4.6
> 

> 
> Can someone advise me on the configuration compile mode example that I
> can use in order to compile 4.6 version successfully ?
> 

Make sure the libssl-dev package in installed and has version 1.1 or later.

Then use --with-openssl to build Squid.


> 
> Also is it true that we can now cache https content without installing
> intercept certificates on clients devices?

This is not true.

To cache HTTPS the traffic has to be decrypted.
To decrypt, the client has to accepts Squids TLS handshake certificate.
To accept a cert, at least one CA from its signing/Issuer chain must be
installed by the client.


>? Or we do still need to
> install the client browser certificate on the client browser side?

"client browser certificate" does not mean what you seem to think it means.


> As I
> have read some example of installing the certificate automatically on
> the client side using the root ca1 ?
> 

I suspect you have misread something. Please provide a citation or link
to that source.


HTH
Amos


From squid3 at treenet.co.nz  Sat Apr 13 14:06:51 2019
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Sun, 14 Apr 2019 02:06:51 +1200
Subject: [squid-users] Squid 4.6 Transparent HTTP & HTTPS Proxy
In-Reply-To: <1555162852755-0.post@n4.nabble.com>
References: <1551961038560-0.post@n4.nabble.com>
 <201903071321.54569.Antony.Stone@squid.open.source.it>
 <1551962112557-0.post@n4.nabble.com> <1555162852755-0.post@n4.nabble.com>
Message-ID: <7c0abaaa-f13c-0ed2-4728-66592c739c3f@treenet.co.nz>

On 14/04/19 1:40 am, tester100 wrote:
> Hiya
> 
> i am trying to compile squid 4.6 also with the same configure as shown here
> but its giving me error on the enable-ssl  option..
> 
> 
> I have managed to compile it without the --enable-ssl function, but then
> again
> 

See my response to your earlier post.

> in the ssl_crtd files  there is no files generated therefore it shows the
> following error
> 
> 
> /etc/squid/ssl_certs# /usr/lib/squid/ssl_crtd: No such file or directory
> bash: /usr/lib/squid/ssl_crtd:: No such file or directory
> 

Please see the release notes for Squid-4:

<http://www.squid-cache.org/Versions/v4/squid-4.6-RELEASENOTES.html#ss2.4>


Amos


From ngtech1ltd at gmail.com  Sat Apr 13 17:54:49 2019
From: ngtech1ltd at gmail.com (Eliezer Croitoru)
Date: Sat, 13 Apr 2019 20:54:49 +0300
Subject: [squid-users] squid-5.0.0-20190331-rf5e179474 cannot be built
 on CentOS 7
In-Reply-To: <78b99733-b1af-6132-4ae9-b6c6e3a08856@treenet.co.nz>
References: <523aed16-009f-cbd2-1f5f-bd61c4a8970c@gmail.com>
 <78b99733-b1af-6132-4ae9-b6c6e3a08856@treenet.co.nz>
Message-ID: <5e6fe36c-7dbd-fe1b-6e93-63381dfa059f@gmail.com>

An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20190413/4b57d5a9/attachment.htm>

From portalnet2 at outlook.com.br  Sun Apr 14 23:08:11 2019
From: portalnet2 at outlook.com.br (tester100)
Date: Sun, 14 Apr 2019 18:08:11 -0500 (CDT)
Subject: [squid-users] YouTube\GoogleVideo caching is here,
	tested and verified.
In-Reply-To: <0aca01d33ca2$e7f1d330$b7d57990$@ngtech.co.il>
References: <0aca01d33ca2$e7f1d330$b7d57990$@ngtech.co.il>
Message-ID: <1555283291916-0.post@n4.nabble.com>

Hi Eliezer...

would you mind sharing the scripts, so i can test it on my squid 3.5.28
version?

i have a store-id.pl script already running and caching certain files on
https sites..

but on youtube its only caching images.. not the videos format from local
CDN server from ISP in the region

i only get this on my log

Apr 14 23:06:58     32 172.255.255.1 TCP_MISS/200 6502 GET
https://i.ytimg.com/vi/yqQwH_Qj1x0/hqdefault.jpg? -
HIER_DIRECT/170.254.11.57 image/webp
Apr 14 23:06:58    170 172.255.255.1 TCP_MISS/200 650 GET
https://www.youtube.com/pcs/activeview? - HIER_DIRECT/172.217.30.110
image/gif
Apr 14 23:06:58     97 172.255.255.1 TAG_NONE/200 0 CONNECT i.ytimg.com:443
- HIER_DIRECT/170.254.11.57 -
Apr 14 23:06:58     99 172.255.255.1 TAG_NONE/200 0 CONNECT i.ytimg.com:443
- HIER_DIRECT/170.254.11.57 -
Apr 14 23:06:58    191 172.255.255.1 TCP_MISS/204 515 GET
https://www.youtube.com/api/stats/ads? - HIER_DIRECT/172.217.30.110
text/html
Apr 14 23:06:58    146 172.255.255.1 TCP_MISS/200 618 GET
https://www.google.com/pagead/lvz? - HIER_DIRECT/172.217.28.228 image/gif
Apr 14 23:06:58     55 172.255.255.1 TCP_MISS/200 8997 GET
https://i.ytimg.com/vi/k5Zu898lbVU/hqdefault.jpg? -
HIER_DIRECT/170.254.11.57 image/webp
Apr 14 23:06:58     28 172.255.255.1 TCP_MISS/200 8231 GET
https://i.ytimg.com/vi/z260XtnMJks/hqdefault.jpg? -
HIER_DIRECT/170.254.11.57 image/webp
Apr 14 23:06:58    299 172.255.255.1 TAG_NONE/200 0 CONNECT i.ytimg.com:443
- HIER_DIRECT/170.254.11.57 -
Apr 14 23:06:58     82 172.255.255.1 TAG_NONE/200 0 CONNECT i.ytimg.com:443
- HIER_DIRECT/170.254.11.57 -
Apr 14 23:06:58      2 172.255.255.1 TCP_HIT/200 4697 GET
https://i.ytimg.com/vi/iVEvf-tR1os/hqdefault.jpg? - HIER_NONE/- image/webp
Apr 14 23:06:58     41 172.255.255.1 TCP_MISS/200 6536 GET
https://i.ytimg.com/vi/WqiYXdRNIdM/hqdefault.jpg? -
HIER_DIRECT/170.254.11.57 image/webp
Apr 14 23:06:58     62 172.255.255.1 TAG_NONE/200 0 CONNECT i.ytimg.com:443
- HIER_DIRECT/170.254.11.57 -
Apr 14 23:06:58     59 172.255.255.1 TAG_NONE/200 0 CONNECT i.ytimg.com:443
- HIER_DIRECT/170.254.11.57 -
Apr 14 23:06:58      2 172.255.255.1 TCP_HIT/200 8658 GET
https://i.ytimg.com/vi/E9dls93E6MI/hqdefault.jpg? - HIER_NONE/- image/webp
Apr 14 23:06:58    374 172.255.255.1 TCP_MISS/200 618 GET
https://www.google.com.br/pagead/lvz? - HIER_DIRECT/172.217.28.227 image/gif
Apr 14 23:06:58     26 172.255.255.1 TCP_MISS/200 8509 GET
https://i.ytimg.com/vi/BmoEIyw1HFU/hqdefault.jpg? -
HIER_DIRECT/170.254.11.57 image/webp
Apr 14 23:06:59    164 172.255.255.1 TAG_NONE/200 0 CONNECT
static.doubleclick.net:443 - HIER_DIRECT/172.217.162.102 -
Apr 14 23:06:59     22 172.255.255.1 TCP_MISS/304 283 GET
https://static.doubleclick.net/instream/ad_status.js -
HIER_DIRECT/172.217.162.102 -
Apr 14 23:06:59    164 172.255.255.1 TAG_NONE/200 0 CONNECT
www.youtube.com:443 - HIER_DIRECT/172.217.30.110 -
Apr 14 23:06:59    363 172.255.255.1 TAG_NONE/200 0 CONNECT
www.youtube.com:443 - HIER_DIRECT/172.217.30.110 -
Apr 14 23:06:59     22 172.255.255.1 TCP_MISS/204 250 GET
https://www.youtube.com/generate_204? - HIER_DIRECT/172.217.30.110 -
Apr 14 23:06:59    178 172.255.255.1 TCP_MISS/200 1394 POST
https://www.youtube.com/service_ajax? - HIER_DIRECT/172.217.30.110
application/json
Apr 14 23:07:00    143 172.255.255.1 TAG_NONE/200 0 CONNECT
www.youtube.com:443 - HIER_DIRECT/172.217.30.110 -
Apr 14 23:07:00    147 172.255.255.1 TAG_NONE/200 0 CONNECT
www.youtube.com:443 - HIER_DIRECT/172.217.30.110 -
Apr 14 23:07:01    172 172.255.255.1 TCP_MISS/200 618 GET
https://www.youtube.com/pagead/conversion/? - HIER_DIRECT/172.217.30.110
image/gif
Apr 14 23:07:01    164 172.255.255.1 TCP_MISS/200 618 GET
https://www.youtube.com/pagead/conversion/? - HIER_DIRECT/172.217.30.110
image/gif
Apr 14 23:07:02    139 172.255.255.1 TAG_NONE/200 0 CONNECT
www.youtube.com:443 - HIER_DIRECT/172.217.30.110 -
Apr 14 23:07:02    278 172.255.255.1 TAG_NONE/200 0 CONNECT
r2---sn-uxjioxucg-cnce.googlevideo.com:443 - HIER_DIRECT/170.254.11.45 -
Apr 14 23:07:02     45 172.255.255.1 TCP_MISS/200 1987 GET
https://r2---sn-uxjioxucg-cnce.googlevideo.com/videoplayback? -
HIER_DIRECT/170.254.11.45 video/mp4
Apr 14 23:07:03     64 172.255.255.1 TAG_NONE/200 0 CONNECT
r2---sn-uxjioxucg-cnce.googlevideo.com:443 - HIER_DIRECT/170.254.11.45 -
Apr 14 23:07:03    162 172.255.255.1 TCP_MISS/204 595 POST
https://www.youtube.com/api/stats/qoe? - HIER_DIRECT/172.217.30.110
text/html
Apr 14 23:07:03     39 172.255.255.1 TCP_MISS/200 1414 GET
https://r2---sn-uxjioxucg-cnce.googlevideo.com/videoplayback? -
HIER_DIRECT/170.254.11.45 audio/webm
Apr 14 23:07:03    421 172.255.255.1 TAG_NONE/200 0 CONNECT
www.youtube.com:443 - HIER_DIRECT/172.217.30.110 -
Apr 14 23:07:03    129 172.255.255.1 TCP_MISS/200 6027 GET
https://www.youtube.com/sw.js - HIER_DIRECT/172.217.30.110 text/javascript
Apr 14 23:07:05    162 172.255.255.1 TAG_NONE/200 0 CONNECT
www.youtube.com:443 - HIER_DIRECT/172.217.30.110 -
Apr 14 23:07:05    124 172.255.255.1 TCP_MISS/200 507 POST
https://www.youtube.com/youtubei/v1/log_event? - HIER_DIRECT/172.217.30.110
application/json
Apr 14 23:07:06    164 172.255.255.1 TAG_NONE/200 0 CONNECT
www.youtube.com:443 - HIER_DIRECT/172.217.30.110 -
Apr 14 23:07:06    174 172.255.255.1 TCP_MISS/200 618 GET
https://www.youtube.com/pagead/conversion/? - HIER_DIRECT/172.217.30.110
image/gif
Apr 14 23:07:08    151 172.255.255.1 TAG_NONE/200 0 CONNECT
www.youtube.com:443 - HIER_DIRECT/172.217.30.110 -
Apr 14 23:07:08   8781 172.255.255.1 TAG_NONE/200 0 CONNECT s.ytimg.com:443
- HIER_DIRECT/172.217.162.110 -
Apr 14 23:07:09      1 172.255.255.1 TCP_MEM_HIT/200 904 GET
https://s.ytimg.com/yts/img/favicon-vfl8qSV2F.ico - HIER_NONE/- image/x-icon


Eliezer Croitoru wrote
> Hey All,
> 
> After quite some time I have compiled a solution for YouTube videos
> caching
> for PC's.
> The next step would be to cache it for mobile devices but I am looking for
> someone who wants this solution.
> The only drawback is that this solution is designed for
> intercept\transparent proxies and not tproxy but it might work on these
> too.
> 
> The installation is pretty simple on a systemd based OS like Debian 8+9,
> Ubuntu 16.04, CentOS\RHEK 7, Oracle Enterprise Linux 7 and OpenSUSE leap
> and
> above.
> It consists of four components:
> - local redis DB
> - ICAP service binary
> - ICAP service system service unit file
> - ruby StoreID script
> 
> And of course a special squid.conf with ssl_bump enabled.
> 
> For now I will not package it using RPM or DEB and will use a shell script
> or README.md that describes the installation and usage steps.
> Contact me here or by a PM.
> 
> Eliezer
> 
> ----
> Eliezer Croitoru
> Linux System Administrator
> Mobile: +972-5-28704261
> Email: 

> eliezer at .co

> 
> _______________________________________________
> squid-users mailing list

> squid-users at .squid-cache

> http://lists.squid-cache.org/listinfo/squid-users


Eliezer Croitoru wrote
> Hey All,
> 
> After quite some time I have compiled a solution for YouTube videos
> caching
> for PC's.
> The next step would be to cache it for mobile devices but I am looking for
> someone who wants this solution.
> The only drawback is that this solution is designed for
> intercept\transparent proxies and not tproxy but it might work on these
> too.
> 
> The installation is pretty simple on a systemd based OS like Debian 8+9,
> Ubuntu 16.04, CentOS\RHEK 7, Oracle Enterprise Linux 7 and OpenSUSE leap
> and
> above.
> It consists of four components:
> - local redis DB
> - ICAP service binary
> - ICAP service system service unit file
> - ruby StoreID script
> 
> And of course a special squid.conf with ssl_bump enabled.
> 
> For now I will not package it using RPM or DEB and will use a shell script
> or README.md that describes the installation and usage steps.
> Contact me here or by a PM.
> 
> Eliezer
> 
> ----
> Eliezer Croitoru
> Linux System Administrator
> Mobile: +972-5-28704261
> Email: 

> eliezer at .co

> 
> _______________________________________________
> squid-users mailing list

> squid-users at .squid-cache

> http://lists.squid-cache.org/listinfo/squid-users





--
Sent from: http://squid-web-proxy-cache.1019090.n4.nabble.com/Squid-Users-f1019091.html


From david at articatech.com  Mon Apr 15 14:01:09 2019
From: david at articatech.com (David Touzeau)
Date: Mon, 15 Apr 2019 16:01:09 +0200
Subject: [squid-users] squid v4: logformat log the last denied ACL object
Message-ID: <3a67a227-f921-05a6-170a-3b37884003b3@articatech.com>

Hi

Is it possible, sometimes to better understand a bunch of ACLs to log 
the last matches or a set of matched acls objects:


example


192.168.1.235 - - [15/Apr/2019:15:59:30 +0200] "GET 
http://www.msftncsi.com/ncsi.txt HTTP/1.1" 200 211 "-" "curl/7.52.1" 
TCP_MISS:HIER_DIRECT text/plain objects1,objects2



From rousskov at measurement-factory.com  Mon Apr 15 17:35:16 2019
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Mon, 15 Apr 2019 11:35:16 -0600
Subject: [squid-users] Logging ICAP headers in access log
In-Reply-To: <1555104073279-0.post@n4.nabble.com>
References: <1555104073279-0.post@n4.nabble.com>
Message-ID: <3651c34f-b59d-6119-19bc-7cc8fc9898f9@measurement-factory.com>

On 4/12/19 3:21 PM, johnr wrote:

> I am attempting to log ICAP headers in the access log. Specifically, I
> modify my logformat directive to include something like
> {x-icap-info}icap::>h for a header x-icap-info that is available in the icap
> request headers. 

I have not tested this, but I doubt it is supported. Squid does not
remember individual ICAP transactions and probably does not remember the
last ICAP request headers either. Squid only remembers the last ICAP
response header (%adapt::<last_h), but that is not what you want.


> From the logformat documentation
> (http://www.squid-cache.org/Doc/config/logformat/) it says that log codes
> mentioned in icap_log (http://www.squid-cache.org/Doc/config/icap_log/) are
> available if icap is enabled. 

If I am right regarding that lack of support, then my original wording
in logformat documentation (commit 3ff6559) was poor/misleading: What I
was probably trying to say is that %icap::x codes documented in the
icap_log directive become available *for use with icap_log* when ICAP
support is enabled.

If you want to log ICAP request headers, consider using icap_log or
enhancing Squid to remember the last ICAP request header (like Squid
already remembers the last ICAP response header).


HTH,

Alex.


From david at articatech.com  Tue Apr 16 10:32:28 2019
From: david at articatech.com (David Touzeau)
Date: Tue, 16 Apr 2019 12:32:28 +0200
Subject: [squid-users] Why Squid on CentOS is faster than Debian ?
In-Reply-To: <fcfc55fa-6d01-2d8a-da55-d75a56463d4b@treenet.co.nz>
References: <5CA2F68A.8000009@tlinx.org>
 <vmime.5ca31502.51b3.2578070e6b172822@ms249-lin-003.rotterdam.bazuin.nl>
 <fcfc55fa-6d01-2d8a-da55-d75a56463d4b@treenet.co.nz>
Message-ID: <6e1a0e09-4926-398a-62d9-d07fb326e45e@articatech.com>


Le 02/04/2019 ? 10:39, Amos Jeffries a ?crit?:
> On 2/04/19 8:53 pm, L.P.H. van Belle wrote:
>> I suggest start compairing the logs you posted, the builds are really different.
>>
>> Differences in
>> - kernel
>> - needed packages
>> - build paramaters due to missing or different packages.
>> Etc.
>>
>> Just diff you logs and you will see it.
>>
> The biggest there is C++11 support being enabled on CentOS. That alone
> enables quite a few performance optimizations in the stdlib template code.
>
> Amos
> _______________________________________________

Hi,


We have tested squid in Debian 10 and performance are now the same as 
CentOS 7

So Debian 10 should be the best choice but it is not released yet...





From belle at bazuin.nl  Tue Apr 16 12:13:01 2019
From: belle at bazuin.nl (=?windows-1252?Q?L.P.H._van_Belle?=)
Date: Tue, 16 Apr 2019 14:13:01 +0200
Subject: [squid-users] Why Squid on CentOS is faster than Debian ?
In-Reply-To: <6e1a0e09-4926-398a-62d9-d07fb326e45e@articatech.com>
References: <fcfc55fa-6d01-2d8a-da55-d75a56463d4b@treenet.co.nz>
Message-ID: <vmime.5cb5c6cd.16c3.52a2e19b4389871d@ms249-lin-003.rotterdam.bazuin.nl>

And what if you test on debian stretch. 
Rebuilding squid 4.6 for stretch is pretty easy. 

Add buster src to repo. 
apt-get build-dep squid3
apt-get source squid3 -b

And now you wait. 

Greetz, 

Louis


> -----Oorspronkelijk bericht-----
> Van: squid-users 
> [mailto:squid-users-bounces at lists.squid-cache.org] Namens 
> David Touzeau
> Verzonden: dinsdag 16 april 2019 12:32
> Aan: squid-users at lists.squid-cache.org
> Onderwerp: Re: [squid-users] Why Squid on CentOS is faster 
> than Debian ?
> 
> 
> Le 02/04/2019 ? 10:39, Amos Jeffries a ?crit?:
> > On 2/04/19 8:53 pm, L.P.H. van Belle wrote:
> >> I suggest start compairing the logs you posted, the builds 
> are really different.
> >>
> >> Differences in
> >> - kernel
> >> - needed packages
> >> - build paramaters due to missing or different packages.
> >> Etc.
> >>
> >> Just diff you logs and you will see it.
> >>
> > The biggest there is C++11 support being enabled on CentOS. 
> That alone
> > enables quite a few performance optimizations in the stdlib 
> template code.
> >
> > Amos
> > _______________________________________________
> 
> Hi,
> 
> 
> We have tested squid in Debian 10 and performance are now the same as 
> CentOS 7
> 
> So Debian 10 should be the best choice but it is not released yet...
> 
> 
> 
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users
> 



From rousskov at measurement-factory.com  Mon Apr 15 20:41:25 2019
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Mon, 15 Apr 2019 14:41:25 -0600
Subject: [squid-users] squid v4: logformat log the last denied ACL object
In-Reply-To: <3a67a227-f921-05a6-170a-3b37884003b3@articatech.com>
References: <3a67a227-f921-05a6-170a-3b37884003b3@articatech.com>
Message-ID: <67f94546-58b2-0dd5-24c3-4d6059864197@measurement-factory.com>

On 4/15/19 8:01 AM, David Touzeau wrote:

> Is it possible, sometimes to better understand a bunch of ACLs to log
> the last matches or a set of matched acls objects:

> 192.168.1.235 - - [15/Apr/2019:15:59:30 +0200] "GET
> http://www.msftncsi.com/ncsi.txt HTTP/1.1" 200 211 "-" "curl/7.52.1"
> TCP_MISS:HIER_DIRECT text/plain objects1,objects2

Yes, it is possible to do something like that in modern Squids, but
covering all ACLs in a non-trivial squid.conf would require tedious
manual work or automation. Here is a rough untested recipe:

1. For each named ACL x that you want to access-log, create a wrapper
annotation ACL called matchAndLogX:

   acl x ...
   acl annotateAfterX annotate_transaction matchedAcls+=x
   acl matchAndLogX all-of x annotateAfterX


2. For each named ACL x wrapped in step 1, replace all its uses in old
squid.conf directives with the matchAndLogX ACLs defined in step 1. For
example:

   http_access deny x y

becomes

   http_access deny matchAndLogX matchAndLogY


3. Add matchedAcls annotation to your logformat definition to log
annotations accumulated by the wrapper ACLs defined in step 1:

   logformat myAccessRecord ...  %note{matchedAcls}
   access_log ... logformat=myAccessRecord ...


Depending on your actual configuration, you may be able to reduce the
amount of logging/wrapping if you annotate groups of matching ACLs
rather than each individual ACL. For example:

    acl annotateAfterX annotate_transaction matchedAcls+=(x,y)
    http_access deny x y annotateAfterXandY


Needless to say, adding such annotations manually to a non-trivial
configuration is a lot of error-prone work! Automating wrapping,
monitoring cache.log with elevated debugging levels (see debug_options),
or hacking Squid to log the info you need is a better approach in many
(most?) cases.


HTH,

Alex.


From info at schroeffu.ch  Tue Apr 16 12:25:34 2019
From: info at schroeffu.ch (info at schroeffu.ch)
Date: Tue, 16 Apr 2019 12:25:34 +0000
Subject: [squid-users] Chrome is not displaying ftp:// directory from squid,
 it downloads them as an HTML file
Message-ID: <6673a992b93c2864b1829808613778e2@schroeffu.ch>

Hey Squid Users, I have Squid 4.6 running and Chrome cannot display ftp:// links.
Chrome is downloading the directory listing as a file with HTML code inside, instead of displaying it.

Example URL: ftp://ftp.adobe.com/pub/connect/updaters/meeting/10_1 (ftp://ftp.adobe.com/pub/connect/updaters/meeting/10_1)

Screenshot Chrome && Firefox to compare: https://imgur.com/a/8U9IbgQ (https://imgur.com/a/8U9IbgQ)

Am I not the only one with this issue, right? Is there a configurable workaround for Chrome users in Squid?

Many thanks in advance for any help.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20190416/c184e3b2/attachment.htm>

From squid3 at treenet.co.nz  Tue Apr 16 10:20:45 2019
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Tue, 16 Apr 2019 22:20:45 +1200
Subject: [squid-users] squid v4: logformat log the last denied ACL object
In-Reply-To: <3a67a227-f921-05a6-170a-3b37884003b3@articatech.com>
References: <3a67a227-f921-05a6-170a-3b37884003b3@articatech.com>
Message-ID: <14babd43-26b2-b4d0-0cda-223729adffc8@treenet.co.nz>

On 16/04/19 2:01 am, David Touzeau wrote:
> Hi
> 
> Is it possible, sometimes to better understand a bunch of ACLs to log
> the last matches or a set of matched acls objects:
> 
> 
> example
> 
> 
> 192.168.1.235 - - [15/Apr/2019:15:59:30 +0200] "GET
> http://www.msftncsi.com/ncsi.txt HTTP/1.1" 200 211 "-" "curl/7.52.1"
> TCP_MISS:HIER_DIRECT text/plain objects1,objects2
> 

Not from access.log itself. You need cache.log trace with "debug_options
28,7" to actually see what is going on.

Amos


From cschnatz at me.com  Tue Apr 16 10:34:12 2019
From: cschnatz at me.com (Christian Schnatz)
Date: Tue, 16 Apr 2019 12:34:12 +0200
Subject: [squid-users] Squid 4.6 "SSL routines:tls_parse_stoc_sct:bad
	extension"
Message-ID: <14A610BA-948A-46AC-B56C-B3781718E68E@me.com>

Hi Everyone,

we?ve just updated one of our machines to squid 4.6 with openssl 1.1.1 and ran in some strange errors when accessing *.google.com and apple app/itunes store domains. 
Has anyone else encountered the follow errors and nows how to solve them? Right now clients are unable to browse the apple app store and do get a squid error page when accessing google.com.

Apr 16 12:17:05 squid[2201]: ERROR: negotiating TLS on FD 202: error:1425F175:SSL routines:ssl_choose_client_version:inappropriate fallback (1/-1/0)
Apr 16 12:17:05 squid[2201]: 1555409825.478    327 172.20.233.28 NONE/200 0 CONNECT 104.31.75.217:443 - ORIGINAL_DST/104.31.75.217 -

Apr 16 12:17:05 squid[2203]: 1555409825.184  10099 172.20.228.187 NONE_ABORTED/200 0 CONNECT 213.180.141.156:443 - HIER_NONE/- -
Apr 16 12:17:05 squid[2201]: ERROR: negotiating TLS on FD 873: error:1423406E:SSL routines:tls_parse_stoc_sct:bad extension (1/-1/0)


We are running squid with the following config:

sslproxy_cert_error allow all
https_port 3129 ssl-bump intercept connection-auth=off tls-cert=/etc/squid/myCA.pem generate-host-certificates=on dynamic_cert_mem_cache_size=12MB options=ALL
tls_outgoing_options options=ALL
tls_outgoing_options flags=DONT_VERIFY_PEER
tls_outgoing_options default-ca=off
tls_outgoing_options min-version=1.0

follow_x_forwarded_for allow all
logfile_rotate 2
access_log syslog:LOG_LOCAL0:EMERGENCY squid
max_filedescriptors 65535

http_port 3131
acl localnet src 10.0.0.0/8	# RFC1918 possible internal network
acl localnet src 172.16.0.0/12	# RFC1918 possible internal network
acl localnet src 192.168.0.0/16	# RFC1918 possible internal network

acl SSL_ports port 443
acl Safe_ports port 80		# http
acl Safe_ports port 21		# ftp
acl Safe_ports port 443		# https
acl Safe_ports port 70		# gopher
acl Safe_ports port 210		# wais
acl Safe_ports port 1025-65535	# unregistered ports
acl Safe_ports port 280		# http-mgmt
acl Safe_ports port 488		# gss-http
acl Safe_ports port 591		# filemaker
acl Safe_ports port 777		# multiling http
acl CONNECT method CONNECT

http_access deny !Safe_ports
http_access deny CONNECT !SSL_ports
http_access allow localhost manager
http_access deny manager
http_access allow localnet
http_access allow localhost
http_access deny all
http_port 3128 transparent
#debug_options ALL,9
coredump_dir /var/spool/squid
url_rewrite_program /usr/bin/cf_plugin
url_rewrite_extras "%ssl::>sni %>a %et"

refresh_pattern ^ftp:		1440	20%	10080
refresh_pattern ^gopher:	1440	0%	1440
refresh_pattern -i (/cgi-bin/|\?) 0	0%	0
refresh_pattern (Release|Packages(.gz)*)$      0       20%     2880
refresh_pattern .		0	20%	4320

cache deny all
cache_log /dev/null
logfile_rotate 0

sslproxy_session_cache_size 0 MB

acl ssl_step1 at_step SslBump1
acl ssl_step2 at_step SslBump2
acl ssl_step3 at_step SslBump3

external_acl_type bump_check children-max=10 %URI %ssl::>sni %>a %et /usr/bin/cf_plugin -b
acl cf_allows external bump_check

ssl_bump peek ssl_step1 all
always_direct allow all
ssl_bump peek ssl_step2 cf_allows
ssl_bump bump ssl_step3 all
ssl_bump stare ssl_step2 !cf_allows
ssl_bump splice ssl_step3 cf_allows
ssl_bump bump ssl_step3 !cf_allows

on_unsupported_protocol tunnel all
url_rewrite_children 10
shutdown_lifetime 5 seconds
memory_pools off
cache_mem 2 MB
workers 5
ipcache_size 10240
fqdncache_size 10240
httpd_suppress_version_string on


Our main usage is to extract the SNI or IP from the SSL Request, forward it to cf_plugin and do some magic to decide wether this request should be blocked or not.

Squid has been build with the follow options:

Squid Cache: Version 4.6
Service Name: squid
Ubuntu linux

This binary uses OpenSSL 1.1.1b  26 Feb 2019. For legal restrictions on distribution see https://www.openssl.org/source/license.html

configure options:  '--build=x86_64-linux-gnu' '--prefix=/usr' '--includedir=${prefix}/include' '--mandir=${prefix}/share/man' '--infodir=${prefix}/share/info' '--sysconfdir=/etc' '--localstatedir=/var' '--libexecdir=${prefix}/lib/squid' '--srcdir=.' '--disable-maintainer-mode' '--disable-dependency-tracking' '--disable-silent-rules' 'BUILDCXXFLAGS=-g -O2 -fPIE -fstack-protector-strong -Wformat -Werror=format-security -Wdate-time -D_FORTIFY_SOURCE=2 -Wl,-Bsymbolic-functions -fPIE -pie -Wl,-z,relro -Wl,-z,now -Wl,--as-needed' '--enable-build-info=Ubuntu linux' '--datadir=/usr/share/squid' '--sysconfdir=/etc/squid' '--libexecdir=/usr/lib/squid' '--mandir=/usr/share/man' '--enable-inline' '--disable-arch-native' '--enable-async-io=8' '--enable-storeio=ufs,aufs,diskd,rock' '--enable-removal-policies=lru,heap' '--enable-delay-pools' '--enable-cache-digests' '--enable-icap-client' '--enable-follow-x-forwarded-for' '--enable-auth-basic=DB,fake,getpwnam,LDAP,NCSA,NIS,PAM,POP3,RADIUS,SASL,SMB' '--enable-auth-digest=file,LDAP' '--enable-auth-negotiate=kerberos,wrapper' '--enable-auth-ntlm=fake,SMB_LM' '--enable-external-acl-helpers=file_userip,kerberos_ldap_group,LDAP_group,session,SQL_session,time_quota,unix_group,wbinfo_group' '--enable-security-cert-validators=fake' '--enable-storeid-rewrite-helpers=file' '--enable-url-rewrite-helpers=fake' '--enable-eui' '--enable-esi' '--enable-icmp' '--enable-zph-qos' '--enable-ecap' '--disable-translation' '--with-swapdir=/var/spool/squid' '--with-logdir=/var/log/squid' '--with-pidfile=/var/run/squid.pid' '--with-filedescriptors=65536' '--with-large-files' '--with-default-user=proxy' '--with-gnutls' '--with-openssl' '--enable-linux-netfilter' 'build_alias=x86_64-linux-gnu' 'CFLAGS=-g -O2 -fPIE -fstack-protector-strong -Wformat -Werror=format-security -Wall' 'LDFLAGS=-Wl,-Bsymbolic-functions -fPIE -pie -Wl,-z,relro -Wl,-z,now -Wl,--as-needed' 'CPPFLAGS=-Wdate-time -D_FORTIFY_SOURCE=2' 'CXXFLAGS=-g -O2 -fPIE -fstack-protector-strong -Wformat -Werror=format-security'


Some more Logoutput (not sure if that?s useful to debug this issue)

squidclient -p 3131 mgr:info
HTTP/1.1 200 OK
Server: squid
Mime-Version: 1.0
Date: Tue, 16 Apr 2019 10:29:09 GMT
Content-Type: text/plain
Expires: Tue, 16 Apr 2019 10:29:09 GMT
Last-Modified: Tue, 16 Apr 2019 10:29:09 GMT
Connection: close

Squid Object Cache: Version 4.6
Build Info: Ubuntu linux
Service Name: squid
Start Time:	Mon, 15 Apr 2019 20:18:12 GMT
Current Time:	Tue, 16 Apr 2019 10:29:09 GMT
Connection information for squid:
	Number of clients accessing cache:	21581
	Number of HTTP requests received:	754759
	Number of ICP messages received:	0
	Number of ICP messages sent:	0
	Number of queued ICP replies:	0
	Number of HTCP messages received:	0
	Number of HTCP messages sent:	0
	Request failure ratio:	 0.00
	Average HTTP requests per minute since start:	887.0
	Average ICP messages per minute since start:	0.0
	Select loop called: 110154975 times, 2.369 ms avg
Cache information for squid:
	Hits as % of all requests:	5min: 0.0%, 60min: 0.0%
	Hits as % of bytes sent:	5min: 3.7%, 60min: 2.0%
	Memory hits as % of hit requests:	5min: 0.0%, 60min: 0.0%
	Disk hits as % of hit requests:	5min: 0.0%, 60min: 0.0%
	Storage Swap size:	0 KB
	Storage Swap capacity:	 0.0% used,  0.0% free
	Storage Mem size:	0 KB
	Storage Mem capacity:	 0.0% used, 100.0% free
	Mean Object Size:	0.00 KB
	Requests given to unlinkd:	0
Median Service Times (seconds)  5 min    60 min:
	HTTP Requests (All):   0.72598  0.66412
	Cache Misses:          0.01207  0.01340
	Cache Hits:            0.00000  0.00000
	Near Hits:             0.00000  0.00000
	Not-Modified Replies:  0.00000  0.00000
	DNS Lookups:           0.00094  0.00094
	ICP Queries:           0.00000  0.00000
Resource usage for squid:
	UP Time:	51057.266 seconds
	CPU Time:	4205.240 seconds
	CPU Usage:	8.24%
	CPU Usage, 5 minute avg:	17.61%
	CPU Usage, 60 minute avg:	20.58%
	Maximum Resident Size: 4742208 KB
	Page faults with physical i/o: 4
Memory accounted for:
	Total accounted:       151043 KB
	memPoolAlloc calls:      6205
	memPoolFree calls:  155540361
File descriptor usage for squid:
	Maximum number of file descriptors:   5120
	Largest file desc currently in use:    957
	Number of file desc currently in use: 4631
	Files queued for open:                   0
	Available number of file descriptors:  489
	Reserved number of file descriptors:   500
	Store Disk files open:                   0
Internal Data Structures:
	  2540 StoreEntries
	  2540 StoreEntries with MemObjects
	     0 Hot Object Cache Items
	     0 on-disk objects


Best Regards and thanks for your help,
Chris



From portalnet2 at outlook.com.br  Tue Apr 16 15:04:15 2019
From: portalnet2 at outlook.com.br (tester100)
Date: Tue, 16 Apr 2019 10:04:15 -0500 (CDT)
Subject: [squid-users] Squid 3.5 https facebook caching
Message-ID: <1555427055618-0.post@n4.nabble.com>

Hi guys

i am currently using this setup on my squid 3.5.28 version for https
filtering using ssl certificate

its caching http and https (some specific extensions) on facebook i can
cache images,css, and other javascript files..

aldo when i press play to play the video and try to cache it , it simply
does not play any videos i can only play the live feeds transmission, this
is the squid.conf files and the store-id.pl i am using



# SQUID CONFIGURATION OF CYBERSCIE.COM
#

acl localnet src 10.0.0.0/8	# RFC1918 possible internal network
acl localnet src 172.16.0.0/12	# RFC1918 possible internal network
acl localnet src fc00::/7       # RFC 4193 local private network range
acl localnet src fe80::/10      # RFC 4291 link-local (directly plugged)
machines
acl localnet src 192.168.1.0/24 
acl localnet src 192.168.2.0/24

acl SSL_ports port 443
acl SSL_ports port 5353
acl Safe_ports port 21
acl Safe_ports port 22
acl Safe_ports port 53
acl Safe_ports port 70
acl Safe_ports port 80
acl Safe_ports port 210
acl Safe_ports port 280
acl Safe_ports port 1025-65535
acl Safe_ports port 443
acl Safe_ports port 488
acl Safe_ports port 591
acl Safe_ports port 777
acl Safe_ports port 5353
acl Safe_ports port 18901-18909
acl Safe_ports port 1818
acl Safe_ports port 39190
acl Safe_ports port 40000-40010
acl Safe_ports port 7777
acl Safe_ports port 19101
acl Safe_ports port 27780
acl Safe_ports port 29000
acl Safe_ports port 22100
acl Safe_ports port 5121
acl Safe_ports port 6000-6152
acl Safe_ports port 2001
acl Safe_ports port 9601-9602
acl Safe_ports port 8085
acl Safe_ports port 11011-11041
acl Safe_ports port 13413
acl Safe_ports port 19000
acl Safe_ports port 5105
acl Safe_ports port 10009
acl Safe_ports port 12060-12070
acl Safe_ports port 6000-6001
acl Safe_ports port 29200
acl Safe_ports port 10402
acl Safe_ports port 9600
acl Safe_ports port 15002
acl Safe_ports port 16402-16502
acl Safe_ports port 5126
acl Safe_ports port 3010
acl Safe_ports port 11031  
acl Safe_ports port 11440-11460
acl Safe_ports port 11100-11125
acl Safe_ports port 4300
acl Safe_ports port 12011
acl Safe_ports port 12110
acl Safe_ports port 15001
acl Safe_ports port 15002
acl Safe_ports port 7341
acl Safe_ports port 7451
acl Safe_ports port 7808
acl Safe_ports port 30000
acl Safe_ports port 9001
acl Safe_ports port 9030
acl Safe_ports port 953
acl Safe_ports port 42051-42052
acl Safe_ports port 36567
acl Safe_ports port 8001
acl Safe_ports port 14000-14050
acl Safe_ports port 27019
acl Safe_ports port 28901-28920
acl Safe_ports port 7201-7208
acl Safe_ports port 17001-17002
acl Safe_ports port 14300-14440
acl Safe_ports port 15100-15150
acl Safe_ports port 7770-7790
acl Safe_ports port 16320-16340
acl Safe_ports port 9000-9160
acl Safe_ports port 7200
acl Safe_ports port 7400
acl Safe_ports port 7106
acl Safe_ports port 7999
acl Safe_ports port 47611
acl Safe_ports port 36567
acl Safe_ports port 10087	
acl Safe_ports port 27000-27050
acl Safe_ports port 27014-27050
acl Safe_ports port 4380
acl Safe_ports port 3478
acl Safe_ports port 4379
acl Safe_ports port 8890
acl Safe_ports port 9339
acl Safe_ports port 8890
acl Safe_ports port 7200-7210
acl Safe_ports port 7450-7460
acl Safe_ports port 8000
acl Safe_ports port 64990-65010
acl CONNECT method CONNECT

# ACCESS RULES
http_access deny !Safe_ports
http_access deny CONNECT !SSL_ports
http_access allow localnet
http_access allow localhost
http_access deny all

# LISTENING PORT SQUID

http_port 3128 ssl-bump cert=/etc/squid/ssl_certs/myCA.pem
generate-host-certificates=on dynamic_cert_mem_cache_size=4MB


# CONNECTION HANDLING
qos_flows local-hit=0x30
collapsed_forwarding on	
balance_on_multiple_ip on
detect_broken_pconn on
client_persistent_connections off
server_persistent_connections on

# DNS OPTIONS
#dns_packet_max 4096
dns_defnames on
dns_v4_first on
connect_retries 2
negative_dns_ttl 1 second
quick_abort_min 0
quick_abort_max 0
quick_abort_pct 80
range_offset_limit 0
ipcache_low 98
ipcache_high 99
ipcache_size 4096
fqdncache_size 2048
pipeline_prefetch 0

# MISCELEANOUS
memory_pools off
reload_into_ims on
max_filedescriptors 65536

# CACHE MANAGEMENT
cache_mem 512 MB
maximum_object_size_in_memory 128 KB
memory_replacement_policy heap GDSF
cache_effective_group proxy	
cache_effective_user proxy
cache_dir aufs /cache/cache 100000 16 256
coredump_dir /cache/cache
cache_mgr cyberscie
visible_hostname someone at gmail.com
minimum_object_size 0 KB
maximum_object_size 1 GB
read_ahead_gap 64 KB		#Amount of data to buffer from server to client
cache_replacement_policy heap LFUDA
store_dir_select_algorithm least-load
cache_swap_low 90
cache_swap_high 95

# LOG FILE OPTIONS
logfile_daemon /usr/lib/squid/log_file_daemon
access_log daemon:/var/log/squid/access.log squid
cache_log /dev/null		#cache_log /var/log/squid/cache.log(to enable)
cache_store_log none
logfile_rotate 3
pid_filename /var/run/squid.pid

# FILTERING HTTPS
acl 1 dstdomain .fbcdn.net .akamaihd.net .fbsbx.com
#acl 2a dstdomain .mahadana.com .mql4.com .metaquotes.net
acl 2 url_regex -i ^https?:\/\/attachment\.fbsbx\.com\/.*\?(id=[0-9]*).*
acl 2 url_regex -i
\.fbsbx\.com\/.*\/(.*\.(unity3d|pak|zip|exe|dll|jpg|png|gif|swf)/)$
acl 2 url_regex -i ^https?:\/\/.*\.ytimg\.com(.*\.(webp|jpg|gif))
acl 2 url_regex -i ^https?:\/\/([^\.]*)\.yimg\.com\/(.*)
acl 2 url_regex -i ^https?:\/\/.*\.gstatic\.com\/images\?q=tbn\:(.*)
acl 2 url_regex -i
^https?:\/\/.*\.reverbnation\.com\/.*\/(ec_stream_song|download_song_direct|stream_song)\/([0-9]*).*
acl 2 url_regex -i
^https?:\/\/([a-z0-9.]*)(\.doubleclick\.net|\.quantserve\.com|.exoclick\.com|interclick.\com|\.googlesyndication\.com|\.auditude\.com|.visiblemeasures\.com|yieldmanager|cpxinteractive)(.*)
acl 2 url_regex -i ^https?:\/\/(.*?)\/(ads)\?(.*?)
acl 2 url_regex -i ^https?:\/\/.*steampowered\.com\/.*\/([0-9]+\/(.*))
acl 3 url_regex -i
^https?:\/\/(.*?)\/speedtest\/.*\.(jpg|txt|png|gif|swf)\?.*
acl 3 url_regex -i speedtest\/.*\.(jpg|txt|png|gif|swf)\?.*
acl 4 url_regex -i reverbnation.*audio_player.*ec_stream_song.*$
acl 5 url_regex -i utm.gif.*
acl 6 url_regex -i c.android.clients.google.com.market.GetBinary.GetBinary.*
acl 7 url_regex -i youtube.*(ptracking|stream_204|player_204|gen_204).*$
acl 7 url_regex -i
\.c\.(youtube|google)\.com\/(get_video|videoplayback|videoplay).*$
acl 7 url_regex -i (youtube|google).*\/videoplayback\?.*
acl 8 http_status 302
acl getmethod method GET

ssl_bump splice localhost
acl 9 at_step SslBump1
acl 10 at_step SslBump2
acl 11 at_step SslBump3
ssl_bump peek 9 all
ssl_bump bump 10 all
ssl_bump bump 11 all

sslcrtd_program /usr/lib/squid/ssl_crtd -s /var/lib/squid/ssl_db -M 4MB
sslcrtd_children 16 startup=1 idle=1
sslproxy_capath /etc/ssl/certs
sslproxy_cert_error allow all
sslproxy_flags DONT_VERIFY_PEER		#this line fixing www.gmail.com,
mail.yahoo.com for some errors
always_direct allow all
ssl_unclean_shutdown on

# STORE ID
store_id_program /usr/bin/perl /etc/squid/store-id.pl
store_id_children 10 startup=5 idle=2 concurrency=10
store_id_access allow 1
store_id_access allow 2
store_id_access allow 3
store_id_access allow 4
store_id_access allow 5
store_id_access allow 6
store_id_access allow 7
store_miss deny 7 8
send_hit deny 7 8
store_id_access deny all

# TUNNING CACHE
max_stale 1 years
vary_ignore_expire on
shutdown_lifetime 10 seconds

# REFRESH PATTERN
refresh_pattern -i https?:\/\/.*\.xx\.fbcdn\.net\/.*\.(jpg|png) 43830 99%
259200 override-expire override-lastmod ignore-reload
refresh_pattern static\.(xx|ak)\.fbcdn\.net*\.(jpg|gif|png) 241920 99%
241920 ignore-reload override-expire ignore-no-store
refresh_pattern ^https?\:\/\/profile\.ak\.fbcdn.net*\.(jpg|gif|png) 241920
99% 241920 ignore-reload override-expire ignore-no-store
refresh_pattern (akamaihd|fbcdn)\.net 14400 99% 518400  ignore-no-store
ignore-private ignore-reload ignore-must-revalidate store-stale
refresh_pattern (audio|video)\/(webm|mp4) 129600 99% 129600 ignore-reload
override-expire override-lastmod ignore-must-revalidate  ignore-private
ignore-no-store ignore-auth store-stale
refresh_pattern -i \/speedtest\/.*\.(txt|jpg|png|swf)  0  99% 14400
override-expire ignore-reload ignore-private ignore-reload override-lastmod
reload-into-ims
refresh_pattern -i reverbnation.com 1440 99% 14400 override-expire
override-lastmod ignore-no-cache ignore-private ignore-must-revalidate
ignore-reload store-stale
refresh_pattern -i (yimg|twimg)\.com\.*	1440 100% 129600 override-expire
ignore-reload reload-into-ims
refresh_pattern -i (ytimg|ggpht)\.com\.*	1440 80% 129600 override-expire
override-lastmod ignore-auth ignore-reload reload-into-ims
refresh_pattern -i
(get_video\?|videoplayback\?|videodownload\?|\.mp4|\.webm|\.flv|((audio|video)\/(webm|mp4)))
241920 100% 241920 override-expire ignore-reload ignore-private
ignore-no-store ignore-must-revalidate reload-into-ims ignore-auth
store-stale
refresh_pattern -i ^https?\:\/\/.*\.googlevideo\.com\/videoplayback.*	10080
99% 43200 override-lastmod override-expire ignore-reload reload-into-ims
ignore-private reload-into-ims ignore-auth store-stale
refresh_pattern
^\.*(streamate.doublepimp.com.*\.js\?|utm\.gif|ads\?|rmxads\.com|ad\.z5x\.net|bh\.contextweb\.com|bstats\.adbrite\.com|a1\.interclick\.com|ad\.trafficmp\.com|ads\.cubics\.com|ad\.xtendmedia\.com|\.googlesyndication\.com|advertising\.com|yieldmanager|game-advertising\.com|pixel\.quantserve\.com|adperium\.com|doubleclick\.net|adserving\.cpxinteractive\.com|syndication\.com|media.fastclick.net).*
1440 99% 14400 ignore-private override-expire ignore-reload ignore-auth
max-stale=1440
refresh_pattern \.(ico|video-stats) 1440 99% 14400 override-expire
ignore-reload ignore-private ignore-auth override-lastmod
ignore-must-revalidate
refresh_pattern
^http://((cbk|mt|khm|mlt|tbn)[0-9]?)\.google\.co(m|\.uk|\.id) 1440 99% 14400
override-expire override-lastmod ignore-reload ignore-private ignore-auth
ignore-must-revalidate 
refresh_pattern vid\.akm\.dailymotion\.com.*\.on2\? 1440 99% 14400
override-expire override-lastmod
refresh_pattern galleries\.video(\?|sz) 1440 99% 14400 override-expire
ignore-reload ignore-must-revalidate ignore-private
refresh_pattern \.wikimapia\.org\/? 1440 99% 14400 override-expire
override-lastmod ignore-reload ignore-private
refresh_pattern -i (livescore.com|goal.com|bobet) 0 50% 60
refresh_pattern
(photobucket|pbsrc|flickr|yimg|ytimg|twimg|gravatar)\.com.*\.(jp(e?g|e|2)|gif|png|tiff?|bmp|swf|mp(4|3))
1440 99% 14400 override-expire ignore-reload ignore-private
refresh_pattern
(zynga|topeleven|ninjasaga|mafiawars|cityville|farmville|crowdstar|spilcdn|agame|popcap)\.com/.*
1440 99% 14400 override-expire ignore-reload ignore-private
refresh_pattern -i
\.(3gp|7z|ace|asx|bin|deb|divx|dvr-ms|ram|rpm|exe|inc|cab|qt) 10080 80%
10080 override-expire override-lastmod reload-into-ims
refresh_pattern -i
\.(rar|jar|gz|tgz|bz2|iso|m1v|m2(v|p)|mo(d|v)|arj|lha|lzh|zip|tar|iop|nzp|pak|mar|msp)
10080 80% 10080 override-expire override-lastmod reload-into-ims
ignore-reload
refresh_pattern -i
\.(jp(e?g|e|2)|gif|pn[pg]|bm?|tiff?|ico|swf|dat|ad|txt|dll) 10080 80% 10080
override-expire override-lastmod reload-into-ims
refresh_pattern -i
\.(avi|ac4|mp(e?g|a|e|1|2|3|4)|mk(a|v)|ms(i|u|p)|og(x|v|a|g)|rm|r(a|p)m|snd|vob|webm)
10080 80% 10080 override-expire override-lastmod reload-into-ims
refresh_pattern -i
\.(pp(t?x)|s|t)|pdf|rtf|wax|wm(a|v)|wmx|wpl|cb(r|z|t)|xl(s?x)|do(c?x)|flv|x-flv)
10080 80% 10080 override-expire override-lastmod reload-into-ims
refresh_pattern -i
\.(3gp|7z|ace|asx|bin|deb|cup|dvr-ms|ram|rpm|exe|inc|cab|qt) 10080 100%
43800 override-expire override-lastmod ignore-reload ignore-no-store
ignore-private ignore-auth ignore-must-revalidate store-stale
refresh_pattern -i
\.(rar|jar|gz|tgz|bz2|iso|m1v|m2(v|p)|mo(d|v)|arj|lha|lzh|zip|tar|pak|cup)
10080 100% 43800 override-expire override-lastmod ignore-reload
ignore-no-store ignore-private ignore-auth ignore-must-revalidate
store-stale
refresh_pattern -i
\.(jp(e?g|e|2)|gif|pn[pg]|bm?|tiff?|ico|swf|dat|ad|txt|dll) 10080 100% 43800
override-expire override-lastmod ignore-reload ignore-no-store
ignore-private ignore-auth ignore-must-revalidate store-stale
refresh_pattern -i
\.(avi|ac4|mp(e?g|a|e|1|2|3|4)|mk(a|v)|ms(i|u|p)|og(x|v|a|g)|rm|r(a|p)m|snd|vob)
10080 100% 43800 override-expire override-lastmod ignore-reload
ignore-no-store ignore-private ignore-auth ignore-must-revalidate
store-stale
refresh_pattern -i
\.(pp(t?x)|s|t)|pdf|rtf|wax|wm(a|v)|wmx|wpl|cb(r|z|t)|xl(s?x)|do(c?x)|flv|x-flv)
10080 100% 43800 override-expire override-lastmod ignore-reload
ignore-no-store ignore-private ignore-auth ignore-must-revalidate
store-stale
refresh_pattern -i .(html|htm|css|js|xml)$ 1440 75% 40320
refresh_pattern -i .index.(html|htm)$ 0 75% 43800
refresh_pattern -i ^http.*squid\.internal.* 43200 100% 799000
override-expire override-lastmod ignore-reload ignore-no-store
ignore-must-revalidate ignore-private ignore-auth

#KEEP THESE LINES AT BOTTOM OF CONFIGURATION
refresh_pattern ^ftp:  1440 20% 10080
refresh_pattern ^gopher: 1440 0% 1440
refresh_pattern -i (/cgi-bin/|\?) 0 0% 0
refresh_pattern .  0 20% 4320



and the store-id.pl below



#!/usr/bin/perl
#
# storeid.pl with debug opt - based on storeurl.pl
# @ http://www2.fh-lausitz.de/launic/comp/misc/squid/projekt_youtube/
#
# modified by cyberscie.com
 
use IO::File;
$|=1;
STDOUT->autoflush(1);
$debug=0;			## recommended:0
$bypassallrules=0;		## recommended:0
$sucks="";			## unused
$sucks="sucks" if ($debug>=1);
$timenow="";
$printtimenow=1;  		## print timenow: 0|1
my $logfile = '/tmp/storeid.log';

open my $logfh, '>>', $logfile
    or die "Couldn't open $logfile for appending: $!\n" if $debug;
$logfh->autoflush(1) if $debug;

while (<>) {
$timenow=time()." " if ($printtimenow);
print $logfh "$timenow"."in : $_" if ($debug>=1);
chop; 
my $myURL = $_;
@X = split(" ",$myURL);
$a = $X[0]; ## channel id
$b = $X[1]; ## url
$c = $X[2]; ## ip address
$u = $b; ## url

if ($bypassallrules){
 $out="$u"; ## map 1:1

} elsif ($u=~
m/http.*\.(fbcdn|akamaihd)\.net\/h(profile|photos).*[\d\w].*\/([\w]\d+x\d+\/.*\.[\d\w]{3}).*/)
{
	$out="OK store-id=http://fbcdn.net.squid.internal/" . $2 . "/" . $3 ;

} elsif ($u=~
m/^http(.*)static(.*)(akamaihd|fbcdn).net\/rsrc.php\/(.*\/.*\/(.*).(js|css|png|gif))(\?(.*)|$)/)
{
	$out="OK store-id=http://fbcdn.net.squid.internal/static/" . $5 . "." . $6
;

} elsif ($u=~ m/^https?\:\/\/.*utm.gif.*/) {
	$out="OK store-id=http://google-analytics.squid.internal/__utm.gif";
 
} elsif ($u=~ m/^https?\:\/\/.*\/speedtest\/(.*\.(jpg|txt)).*/) {
	$out="OK store-id=http://speedtest.squid.internal/" . $1;
 
} elsif ($u=~ m/^https?\:\/\/.*\/(.*\..*(mp4|3gp|flv))\?.*/) {
	$out="OK store-id=http://video-file.squid.internal/" . $1;

} elsif ($u=~
m/^https?\:\/\/c2lo\.reverbnation\.com\/audio_player\/ec_stream_song\/(.*)\?.*/)
{
	$out="OK store-id=http://reverbnation.squid.internal/" . $1;
 
} elsif ($u=~
m/^https?\:\/\/.*\.c\.android\.clients\.google\.com\/market\/GetBinary\/GetBinary\/(.*\/.*)\?.*/)
{
	$out="OK store-id=http://playstore-android.squid.internal/" . $1;

} elsif ($u =~
m/^http:\/\/([a-z])[0-9]?(\.gstatic\.com.*|\.wikimapia\.org.*)/) {
	$out="OK store-id=http://gstatic.squid.internal/" . $2;

} elsif ($u =~
m/^https?:\/\/.*(googleusercontent.com|blogspot.com)\/(.*)\/([a-z0-9]+)(-[a-z]-[a-z]-[a-z]+)?\/(.*\.(jpg|png))/){
	$out="OK store-id=http://googleusercontent.squid.internal/" . $5;

} elsif ($_ =~
m/^https?:\/\/([a-z0-9.]*)(\.doubleclick\.net|\.quantserve\.com|.exoclick\.com|interclick.\com|\.googlesyndication\.com|\.auditude\.com|.visiblemeasures\.com|yieldmanager|cpxinteractive)(.*)/){
	$out="OK store-id=http://ads.squid.internal/" . $3;

} elsif ($u=~ m/^http\:\/\/.*\.4shared\.com\/download\/(.*)\/.*/) {
	$out="OK store-id=http://4shared.squid.internal/" . $1;

} elsif ($u =~ m/^http:\/\/(www\.ziddu\.com.*\.[^\/]{3,4})\/(.*?)/) {
	$out="OK store-id=http://ziddu.squid.internal/" . $1;

} elsif ($u =~ m/^http:\/\/(.*?)\.yimg\.com\/(.*?)\.yimg\.com\/(.*?)\?(.*)/)
{
	$out="OK store-id=http://cdn.yimg.squid.internal/" . $3;

} elsif (($u =~ /filehippo/) &&
(m/^https?:\/\/(.*?)\.(.*?)\/(.*?)\/(.*)\.([a-z0-9]{3,4})(\?.*)?/)) {
	@y = ($1,$2,$4,$5); $y[0] =~ s/[a-z0-9]{2,5}/cdn./;
	$out="OK store-id=http://filehippo.squid.internal/" . $3;
	
} elsif ($u[1] =~
m/^http:\/\/.*dlink__[23]Fdownload_[23]F([\w\d-]+)_3Ftsid.*/) {
	$1 =~ s/_5F/_/g;
	$out="OK store-id=http://4shared.squid.internal/" . $1;

} elsif ($u=~ m/^https?\:\/\/.*youtube.*ptracking.*/){
	@video_id = m/[&?]video_id\=([^\&\s]*)/;
	@cpn = m/[&?]cpn\=([^\&\s]*)/;
	unless (-e "/tmp/@cpn"){
	open FILE, ">/tmp/@cpn";
	print FILE "@video_id";
	close FILE;
	}
	$out="ERR";
 
} elsif ($u=~ m/^https?\:\/\/.*youtube.*stream_204.*/){
	@docid = m/[&?]docid\=([^\&\s]*)/;
	@cpn = m/[&?]cpn\=([^\&\s]*)/;
	unless (-e "/tmp/@cpn"){
	open FILE, ">/tmp/@cpn";
	print FILE "@docid";
	close FILE;
	}
	$out="ERR";
 
} elsif ($u=~ m/^https?\:\/\/.*youtube.*player_204.*/){
	@v = m/[&?]v\=([^\&\s]*)/;
	@cpn = m/[&?]cpn\=([^\&\s]*)/;
	unless (-e "/tmp/@cpn"){
	open FILE, ">/tmp/@cpn";
	print FILE "@v";
	close FILE;
	}
	$out="ERR";
 
} elsif ($u=~ m/^https?\:\/\/.*(youtube|googlevideo).*videoplayback.*/){
	@itag = m/[&?](itag\=[0-9]*)/;
	@range = m/[&?](range\=[^\&\s]*)/;
	@cpn = m/[&?]cpn\=([^\&\s]*)/;
	@mime = m/[&?](mime\=[^\&\s]*)/;
	@id = m/[&?]id\=([^\&\s]*)/;
 
	if (defined(@cpn[0])){
		if (-e "/tmp/@cpn"){
		open FILE, "/tmp/@cpn";
		@id = <FILE>;
		close FILE;}
	}
	$out="OK store-id=http://video-srv.squid.internal/id=@id at mime@range";

} else {
	$out="ERR";
}
	print $logfh "$timenow"."out: $a $out\n" if ($debug>=1);
	print "$a $out\n";
}
close $logfh if ($debug);





This way i can play the facebook videos, but no caching is done i only get
TCP_TUNNEL/200



http_port 3129 tproxy ssl-bump generate-host-certificates=on
dynamic_cert_mem_cache_size=4MB cert=/etc/squid/ssl_certs/squid.crt
key=/etc/squid/ssl_certs/squid.key
cipher=ECDHE-RSA-RC4-SHA:ECDHE-RSA-AES128-SHA:DHE-RSA-AES128-SHA:DHE-RSA-CAMELLIA128-SHA:AES128-SHA:RC4-SHA:HIGH:!aNULL:!MD5:!ADH




And this way i can cache https but cannot play the videos on the facebook at
all



http_port 3128 ssl-bump cert=/etc/squid/ssl_certs/myCA.pem
generate-host-certificates=on dynamic_cert_mem_cache_size=4MB




Any ideas or hints on what could be wrong? i am kind of lost now.. any tips
will be appreciate



--
Sent from: http://squid-web-proxy-cache.1019090.n4.nabble.com/Squid-Users-f1019091.html


From portalnet2 at outlook.com.br  Tue Apr 16 15:11:40 2019
From: portalnet2 at outlook.com.br (tester100)
Date: Tue, 16 Apr 2019 10:11:40 -0500 (CDT)
Subject: [squid-users] Squid 3.5 https facebook caching
In-Reply-To: <1555427055618-0.post@n4.nabble.com>
References: <1555427055618-0.post@n4.nabble.com>
Message-ID: <1555427500985-0.post@n4.nabble.com>

Aldo

when i press refresh or when i clean history on my browser and login to
facebook again i can see this memory hits on the log.. with .mp4 video
extensions but cannot play it at all

<http://squid-web-proxy-cache.1019090.n4.nabble.com/file/t377703/m6ZdWuf.png> 



--
Sent from: http://squid-web-proxy-cache.1019090.n4.nabble.com/Squid-Users-f1019091.html


From ngtech1ltd at gmail.com  Tue Apr 16 18:23:32 2019
From: ngtech1ltd at gmail.com (Eliezer Croitoru)
Date: Tue, 16 Apr 2019 21:23:32 +0300
Subject: [squid-users] Why Squid on CentOS is faster than Debian ?
In-Reply-To: <6e1a0e09-4926-398a-62d9-d07fb326e45e@articatech.com>
References: <5CA2F68A.8000009@tlinx.org>
 <vmime.5ca31502.51b3.2578070e6b172822@ms249-lin-003.rotterdam.bazuin.nl>
 <fcfc55fa-6d01-2d8a-da55-d75a56463d4b@treenet.co.nz>
 <6e1a0e09-4926-398a-62d9-d07fb326e45e@articatech.com>
Message-ID: <9c334166-ae4e-6716-9b76-ba7cff141365@gmail.com>

An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20190416/d7fa6561/attachment.htm>

From rousskov at measurement-factory.com  Tue Apr 16 21:25:25 2019
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Tue, 16 Apr 2019 15:25:25 -0600
Subject: [squid-users] Chrome is not displaying ftp:// directory from
 squid, it downloads them as an HTML file
In-Reply-To: <6673a992b93c2864b1829808613778e2@schroeffu.ch>
References: <6673a992b93c2864b1829808613778e2@schroeffu.ch>
Message-ID: <1c41cde5-ff7c-4005-c0ec-389b18bdabda@measurement-factory.com>

On 4/16/19 6:25 AM, info at schroeffu.ch wrote:
> 
> Hey Squid Users, I have Squid 4.6 running and Chrome cannot display
> ftp:// links.
> Chrome is downloading the directory listing as a file with HTML code
> inside, instead of displaying it.
> 
> Example URL: ftp://ftp.adobe.com/pub/connect/updaters/meeting/10_1
> 
> Screenshot Chrome && Firefox to compare: https://imgur.com/a/8U9IbgQ
> 
> Am I not the only one with this issue, right? 

Please see the following recent email thread:
http://lists.squid-cache.org/pipermail/squid-users/2019-April/020433.html

Alex.


From squid3 at treenet.co.nz  Wed Apr 17 12:54:39 2019
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Thu, 18 Apr 2019 00:54:39 +1200
Subject: [squid-users] Squid 3.5 https facebook caching
In-Reply-To: <1555427500985-0.post@n4.nabble.com>
References: <1555427055618-0.post@n4.nabble.com>
 <1555427500985-0.post@n4.nabble.com>
Message-ID: <5e42a16f-69c4-09e7-952b-15e80398f602@treenet.co.nz>

On 17/04/19 3:11 am, tester100 wrote:
> Aldo
> 
> when i press refresh or when i clean history on my browser and login to
> facebook again i can see this memory hits on the log.. with .mp4 video
> extensions but cannot play it at all

Yes those Browser controls are normally the way one forces proxies
awareness of problems to make them fix this type of issue.

However, the proxy admin configured a lot of ignore-* options on the
refresh_patterns as well as a global conversion of reload into IMS
fetches ("reload_into_ims on"). As a result the Browser reload or
revalidate requests get ignored or converted into less effective fetches.

Amos


From squid3 at treenet.co.nz  Wed Apr 17 13:52:03 2019
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Thu, 18 Apr 2019 01:52:03 +1200
Subject: [squid-users] Squid 3.5 https facebook caching
In-Reply-To: <1555427055618-0.post@n4.nabble.com>
References: <1555427055618-0.post@n4.nabble.com>
Message-ID: <95e8facb-4e51-09a4-b505-0a6e13367419@treenet.co.nz>

On 17/04/19 3:04 am, tester100 wrote:
> Hi guys
> 
> i am currently using this setup on my squid 3.5.28 version for https
> filtering using ssl certificate
> 
> its caching http and https (some specific extensions) on facebook i can
> cache images,css, and other javascript files..
> 
> aldo when i press play to play the video and try to cache it , it simply
> does not play any videos i can only play the live feeds transmission, this
> is the squid.conf files and the store-id.pl i am using
> 
> 
> 
> # SQUID CONFIGURATION OF CYBERSCIE.COM
> #
> 
> acl localnet src 10.0.0.0/8	# RFC1918 possible internal network
> acl localnet src 172.16.0.0/12	# RFC1918 possible internal network
> acl localnet src fc00::/7       # RFC 4193 local private network range
> acl localnet src fe80::/10      # RFC 4291 link-local (directly plugged)
> machines
> acl localnet src 192.168.1.0/24 
> acl localnet src 192.168.2.0/24
> 
> acl SSL_ports port 443
> acl SSL_ports port 5353
> acl Safe_ports port 21
> acl Safe_ports port 22
> acl Safe_ports port 53
> acl Safe_ports port 70
> acl Safe_ports port 80
> acl Safe_ports port 210
> acl Safe_ports port 280
> acl Safe_ports port 1025-65535

The above line means that any of the *many* entries you have for ports
over 1024 are a pointless waste of memory and CPU cycles.

Please start by running "squid -k parse" on your config and fix all the
issues that get mentioned.
...
> acl CONNECT method CONNECT
> 
> # ACCESS RULES
> http_access deny !Safe_ports
> http_access deny CONNECT !SSL_ports
> http_access allow localnet
> http_access allow localhost
> http_access deny all
> 
> # LISTENING PORT SQUID
> 
> http_port 3128 ssl-bump cert=/etc/squid/ssl_certs/myCA.pem
> generate-host-certificates=on dynamic_cert_mem_cache_size=4MB
> 
> 
> # CONNECTION HANDLING
> qos_flows local-hit=0x30
> collapsed_forwarding on	
> balance_on_multiple_ip on

The above breaks performance of server persistent connections....

> detect_broken_pconn on
> client_persistent_connections off
> server_persistent_connections on

... which is the only type of persistence you have enabled.

> 
> # DNS OPTIONS
> #dns_packet_max 4096
> dns_defnames on
> dns_v4_first on
> connect_retries 2
> negative_dns_ttl 1 second
> quick_abort_min 0
> quick_abort_max 0
> quick_abort_pct 80
> range_offset_limit 0

Hm, so all transactions which are started will run until completion even
if no client needs that response.

> ipcache_low 98
> ipcache_high 99
> ipcache_size 4096
> fqdncache_size 2048
> pipeline_prefetch 0
> 
> # MISCELEANOUS
> memory_pools off
> reload_into_ims on
> max_filedescriptors 65536
> 
> # CACHE MANAGEMENT
> cache_mem 512 MB
> maximum_object_size_in_memory 128 KB
> memory_replacement_policy heap GDSF
> cache_effective_group proxy	
> cache_effective_user proxy
> cache_dir aufs /cache/cache 100000 16 256
> coredump_dir /cache/cache
> cache_mgr cyberscie
> visible_hostname someone at gmail.com

The above looks like an email address. Not an FQDN.

"hostname" is the name of the machine running Squid. To work properly it
should be a FQDN that can be resolved with DNS.


> minimum_object_size 0 KB
> maximum_object_size 1 GB
> read_ahead_gap 64 KB		#Amount of data to buffer from server to client
> cache_replacement_policy heap LFUDA
> store_dir_select_algorithm least-load
> cache_swap_low 90
> cache_swap_high 95
> 
> # LOG FILE OPTIONS
> logfile_daemon /usr/lib/squid/log_file_daemon
> access_log daemon:/var/log/squid/access.log squid
> cache_log /dev/null		#cache_log /var/log/squid/cache.log(to enable)

This is a bad idea. What do you expect will happen to the machine when
Squid renames the /dev/null path to /dev/null.0 and places a file at
that location?


> cache_store_log none

It is not necessary to set things to their default value in Squid-3.

> logfile_rotate 3
> pid_filename /var/run/squid.pid
> 
> # FILTERING HTTPS
> acl 1 dstdomain .fbcdn.net .akamaihd.net .fbsbx.com
> #acl 2a dstdomain .mahadana.com .mql4.com .metaquotes.net
> acl 2 url_regex -i ^https?:\/\/attachment\.fbsbx\.com\/.*\?(id=[0-9]*).*
> acl 2 url_regex -i
> \.fbsbx\.com\/.*\/(.*\.(unity3d|pak|zip|exe|dll|jpg|png|gif|swf)/)$


The above "2" lines are pointless. The ACL called "1" has already
matched and allowed Store-ID processing of all the domains this pattern
might match.

> acl 2 url_regex -i ^https?:\/\/.*\.ytimg\.com(.*\.(webp|jpg|gif))

The above pattern does not match what it may seem to match.

Notice that;
  A) there is no path-segment delimiter ('/' or '\?') required. So the
thing that _looks_ like a file extension can match when existing in the
domain name (eg http://hello.ytimg.com.gif-fy.invalid/ will be allowed)
 B)


> acl 2 url_regex -i ^https?:\/\/([^\.]*)\.yimg\.com\/(.*)
> acl 2 url_regex -i ^https?:\/\/.*\.gstatic\.com\/images\?q=tbn\:(.*)



It is pointless to place "(.*)" or ".*" or ".+" at the start or end of a
regex pattern.

Arbitrary suffix is implicit and all this will do is slow the regex
processing down even further trying to match the entire (possibly VERY
long) URL against ".*"
 That goes for all places you use regex patterns.


> acl 2 url_regex -i
> ^https?:\/\/.*\.reverbnation\.com\/.*\/(ec_stream_song|download_song_direct|stream_song)\/([0-9]*).*
> acl 2 url_regex -i
> ^https?:\/\/([a-z0-9.]*)(\.doubleclick\.net|\.quantserve\.com|.exoclick\.com|interclick.\com|\.googlesyndication\.com|\.auditude\.com|.visiblemeasures\.com|yieldmanager|cpxinteractive)(.*)
> acl 2 url_regex -i ^https?:\/\/(.*?)\/(ads)\?(.*?)
> acl 2 url_regex -i ^https?:\/\/.*steampowered\.com\/.*\/([0-9]+\/(.*))
> acl 3 url_regex -i
> ^https?:\/\/(.*?)\/speedtest\/.*\.(jpg|txt|png|gif|swf)\?.*
> acl 3 url_regex -i speedtest\/.*\.(jpg|txt|png|gif|swf)\?.*

Notice that the second line for "3" matches everything the first pattern
does, and a lot more. You can erase the first pattern and save a lot of
CPU without any change in proxy allow/deny permissions.

> acl 4 url_regex -i reverbnation.*audio_player.*ec_stream_song.*$
> acl 5 url_regex -i utm.gif.*
> acl 6 url_regex -i c.android.clients.google.com.market.GetBinary.GetBinary.*
> acl 7 url_regex -i youtube.*(ptracking|stream_204|player_204|gen_204).*$
> acl 7 url_regex -i
> \.c\.(youtube|google)\.com\/(get_video|videoplayback|videoplay).*$
> acl 7 url_regex -i (youtube|google).*\/videoplayback\?.*
> acl 8 http_status 302
> acl getmethod method GET
> 
> ssl_bump splice localhost
> acl 9 at_step SslBump1
> acl 10 at_step SslBump2
> acl 11 at_step SslBump3
> ssl_bump peek 9 all
> ssl_bump bump 10 all
> ssl_bump bump 11 all

Why the weird numbers?

The "all" on all the above ssl_bump lines are pointless and may be
confusing you.


> 
> sslcrtd_program /usr/lib/squid/ssl_crtd -s /var/lib/squid/ssl_db -M 4MB
> sslcrtd_children 16 startup=1 idle=1
> sslproxy_capath /etc/ssl/certs
> sslproxy_cert_error allow all

Above prevents Squid from acting on TLS errors. In fact it can cause
some to be hidden which should be fatal to the transaction.


> sslproxy_flags DONT_VERIFY_PEER		#this line fixing www.gmail.com,

Absolutely No! The above line 'fixes' nothing. All it does is tell Squid
not to bother checking TLS security.

Those problems still exist, still cause other side effects, and are
often breaking things for clients. But you cannot see that because it is
being hidden by the above setting.

 ... and as a bonus (for the bad guys) your proxy can now be hijacked by
a malicious HTTPS server without any hints being given about it happening.


I suspect that whatever is going wrong the crypto activity is part of
it. But without those crypto issues being visible nobody can say for
sure. There are also refresh_pattern issues mentionend below.


> mail.yahoo.com for some errors
> always_direct allow all

Please remove this. You do not have any cache_peer lines. This setting
was only ever needed for a single Squid-3.2 release over a 2-week
period. That bug was long, long, long ago fixed.


> ssl_unclean_shutdown on
> 
> # STORE ID
> store_id_program /usr/bin/perl /etc/squid/store-id.pl
> store_id_children 10 startup=5 idle=2 concurrency=10
> store_id_access allow 1
> store_id_access allow 2
> store_id_access allow 3
> store_id_access allow 4
> store_id_access allow 5
> store_id_access allow 6

So if all the 1 thru 6 ACLs are just url_regex patterns. Why bother
having them as separate ACLs? you can list all the patterns in one ACL
and save a lot of CPU cycles and time.


> store_id_access allow 7
> store_miss deny 7 8
> send_hit deny 7 8

It would be a lot more performant to switch those around. Check 8 then
7. Like so:

  store_miss deny 8 7
  send_hit deny 8 7


> store_id_access deny all
> 

This should really be up with the other store_id_access lines.


> # TUNNING CACHE
> max_stale 1 years
> vary_ignore_expire on
> shutdown_lifetime 10 seconds
> 
> # REFRESH PATTERN
> refresh_pattern -i https?:\/\/.*\.xx\.fbcdn\.net\/.*\.(jpg|png) 43830 99%
> 259200 override-expire override-lastmod ignore-reload

Um,

1) override-lastmod is generally a bad idea. It prevents the
Last-Modified header telling Squid that an object as any previous time
since it was updated - this option actively *reduces* the time objects
can be cached.

2) overide-expire should not be used for sites like Facebook which
provide well behaved cacheability headers. Like (1) it actively breaks
caching with often the opposite result to what one wants.

3) ignore-reload is part of why your Browser "refresh" attempts are
failing to do anything at all.

4) override-expire is *shortening* the caching time for these objects.
Facebook actually has pretty good cacheability once you get past the
problem of it all being hidden behind crypto.


> refresh_pattern static\.(xx|ak)\.fbcdn\.net*\.(jpg|gif|png) 241920 99%
> 241920 ignore-reload override-expire ignore-no-store

5) ignore-no-store is a bad idea. This *forces* private details from one
persons FB profile pages to be delivered to other clients. It exists
only because there are some very badly designed sites abusing the
Cache-Control header. Facebook is *not* one of those sites.


> refresh_pattern ^https?\:\/\/profile\.ak\.fbcdn.net*\.(jpg|gif|png) 241920
> 99% 241920 ignore-reload override-expire ignore-no-store
> refresh_pattern (akamaihd|fbcdn)\.net 14400 99% 518400  ignore-no-store
> ignore-private ignore-reload ignore-must-revalidate store-stale


6) ignore-private has been made relatively safe in the latest Squid. BUT
the revalidation mechanisms are required for it to be safe at all.
 It is a very bad idea to use with either ignore-reload or
ignore-must-revalidate ... let alone both at once. Security
vulnerabilities will exist as a result of these options used together.

7) store-stale is in a similar position of requiring revalidation /
reload to be possible. But with less severe results - only badly broken
web page display.


These issues caused by (5), (6), and (7) could be at least a part of
what is going wrong. Probably also some other things.


> refresh_pattern (audio|video)\/(webm|mp4) 129600 99% 129600 ignore-reload
> override-expire override-lastmod ignore-must-revalidate  ignore-private
> ignore-no-store ignore-auth store-stale


Notice that if the earlier FB patterns did not match this makes videos
and audio URLs forced to be immediately stale/expired, forced to be
cached anyway, forced all clients/users to get the same objects, and
then also prohibits anything from updating the cache object if a broken
one gets into cache somehow.

You were saying something about video problems?


The remainder of your refresh_patterns show a lot of repeats of these
issues.

Remember: these options are dangerous. Use with great care. And
understand what the options are doing



> 
> This way i can play the facebook videos, but no caching is done i only get
> TCP_TUNNEL/200
> 
> 
> 
> http_port 3129 tproxy ssl-bump generate-host-certificates=on
> dynamic_cert_mem_cache_size=4MB cert=/etc/squid/ssl_certs/squid.crt
> key=/etc/squid/ssl_certs/squid.key
> cipher=ECDHE-RSA-RC4-SHA:ECDHE-RSA-AES128-SHA:DHE-RSA-AES128-SHA:DHE-RSA-CAMELLIA128-SHA:AES128-SHA:RC4-SHA:HIGH:!aNULL:!MD5:!ADH
> 


Do you know what the differences between these two port lines are?

In one the client is aware that the proxy exists and sends details to it
in a CONNECT request.


> 
> And this way i can cache https but cannot play the videos on the facebook at
> all
> 
> 
> 
> http_port 3128 ssl-bump cert=/etc/squid/ssl_certs/myCA.pem
> generate-host-certificates=on dynamic_cert_mem_cache_size=4MB
> 
> 
> 
> 
> Any ideas or hints on what could be wrong? i am kind of lost now.. any tips
> will be appreciate
> 
> 
> 
> --
> Sent from: http://squid-web-proxy-cache.1019090.n4.nabble.com/Squid-Users-f1019091.html
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users
> 


From squid3 at treenet.co.nz  Wed Apr 17 21:32:18 2019
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Thu, 18 Apr 2019 09:32:18 +1200
Subject: [squid-users] Squid 4.6 "SSL routines:tls_parse_stoc_sct:bad
 extension"
In-Reply-To: <14A610BA-948A-46AC-B56C-B3781718E68E@me.com>
References: <14A610BA-948A-46AC-B56C-B3781718E68E@me.com>
Message-ID: <d5da4460-1db5-911e-4d1e-77bfb31f903c@treenet.co.nz>

On 16/04/19 10:34 pm, Christian Schnatz wrote:
> Hi Everyone,
> 
> we?ve just updated one of our machines to squid 4.6 with openssl 1.1.1 and ran in some strange errors when accessing *.google.com and apple app/itunes store domains. 
> Has anyone else encountered the follow errors and nows how to solve them? Right now clients are unable to browse the apple app store and do get a squid error page when accessing google.com.
> 
> Apr 16 12:17:05 squid[2201]: ERROR: negotiating TLS on FD 202: error:1425F175:SSL routines:ssl_choose_client_version:inappropriate fallback (1/-1/0)

A 5min web search can be useful.

 <https://security.stackexchange.com/questions/160922/ssl-error-inappropriate-fallback-and-tls-fallback-scsv>



> Apr 16 12:17:05 squid[2201]: 1555409825.478    327 172.20.233.28 NONE/200 0 CONNECT 104.31.75.217:443 - ORIGINAL_DST/104.31.75.217 -
> 
> Apr 16 12:17:05 squid[2203]: 1555409825.184  10099 172.20.228.187 NONE_ABORTED/200 0 CONNECT 213.180.141.156:443 - HIER_NONE/- -
> Apr 16 12:17:05 squid[2201]: ERROR: negotiating TLS on FD 873: error:1423406E:SSL routines:tls_parse_stoc_sct:bad extension (1/-1/0)


Your OpenSSL library does not understand the TLS extension being
received from one endpoint. The client or server, depending on which
step the SSL-Bump process is up to and what your ssl_bump rules say to do.

It is possible that your OpenSSL installation is corrupted, that the
endpoint is using some mandatory avoid TLS/SSL extension that is no
longer supported, that the endpoint is not sending TLS/SSL at all, or a
number of other similar things.


> 
> We are running squid with the following config:
> 
> sslproxy_cert_error allow all
> https_port 3129 ssl-bump intercept connection-auth=off tls-cert=/etc/squid/myCA.pem generate-host-certificates=on dynamic_cert_mem_cache_size=12MB options=ALL
> tls_outgoing_options options=ALL

The above options enables (or disables) a lot of OpenSL features which
are set with default on/off for very good reasons. Usually because they
cause bad problems if used on general TLS traffic. Things like 0-bit
security keys, nul-ciphers, IE 3 compatibility ciphers, SSLv2 and so on.

If used at all the "ALL" shoudl be followed by a long list of things to
turn off again. Or prefixed with a '!' to disable everything, followed
by a long list of things to turn on. Just by itself is a bad idea.


> tls_outgoing_options flags=DONT_VERIFY_PEER

This is another even worse idea. It is hiding TLS problems from you.
Serious ones with the security keys and certs.


> tls_outgoing_options default-ca=off
> tls_outgoing_options min-version=1.0

TLS has no version older than 1.0. So the above line is pointless.

> 
> follow_x_forwarded_for allow all
> logfile_rotate 2
> access_log syslog:LOG_LOCAL0:EMERGENCY squid
> max_filedescriptors 65535
> 
> http_port 3131
> acl localnet src 10.0.0.0/8	# RFC1918 possible internal network
> acl localnet src 172.16.0.0/12	# RFC1918 possible internal network
> acl localnet src 192.168.0.0/16	# RFC1918 possible internal network
> 
> acl SSL_ports port 443
> acl Safe_ports port 80		# http
> acl Safe_ports port 21		# ftp
> acl Safe_ports port 443		# https
> acl Safe_ports port 70		# gopher
> acl Safe_ports port 210		# wais
> acl Safe_ports port 1025-65535	# unregistered ports
> acl Safe_ports port 280		# http-mgmt
> acl Safe_ports port 488		# gss-http
> acl Safe_ports port 591		# filemaker
> acl Safe_ports port 777		# multiling http
> acl CONNECT method CONNECT
> 
> http_access deny !Safe_ports
> http_access deny CONNECT !SSL_ports
> http_access allow localhost manager
> http_access deny manager
> http_access allow localnet
> http_access allow localhost
> http_access deny all
> http_port 3128 transparent

"transparent" is a long ago deprecated option. It was replaced by
"intercept" to avoid confusion with transparent proxy options that do
*actual* transparency.


> #debug_options ALL,9
> coredump_dir /var/spool/squid
> url_rewrite_program /usr/bin/cf_plugin
> url_rewrite_extras "%ssl::>sni %>a %et"
> 
> refresh_pattern ^ftp:		1440	20%	10080
> refresh_pattern ^gopher:	1440	0%	1440
> refresh_pattern -i (/cgi-bin/|\?) 0	0%	0
> refresh_pattern (Release|Packages(.gz)*)$      0       20%     2880
> refresh_pattern .		0	20%	4320
> 
> cache deny all
> cache_log /dev/null

Another bad idea. This can lead to /dev/null being moved to /dev/null.0
and a file put at /dev/null . Imagine the machine disks over-filling
with infinite amounts of crap from every application and script ever
running.
 Use "debug_options ALL,0" to minimize cache.log output.


> logfile_rotate 0
> 
> sslproxy_session_cache_size 0 MB
> 
> acl ssl_step1 at_step SslBump1
> acl ssl_step2 at_step SslBump2
> acl ssl_step3 at_step SslBump3
> 
> external_acl_type bump_check children-max=10 %URI %ssl::>sni %>a %et /usr/bin/cf_plugin -b
> acl cf_allows external bump_check
> 
> ssl_bump peek ssl_step1 all
> always_direct allow all

You do not have any cache_peer's.  This always_direct is not useful in
any way. Please remove.

> ssl_bump peek ssl_step2 cf_allows
> ssl_bump bump ssl_step3 all
> ssl_bump stare ssl_step2 !cf_allows
> ssl_bump splice ssl_step3 cf_allows
> ssl_bump bump ssl_step3 !cf_allows

The above lines should never be reachable. There is already a bump rule
that matches step3. If that rule is not possible, then this one cannot
be either.


> 
> Our main usage is to extract the SNI or IP from the SSL Request, forward it to cf_plugin and do some magic to decide wether this request should be blocked or not.
> 

At no point do these ssl_bump rules block anything. In fact they do the
opposite.

They decide whether to allow unconditional tunnel through the proxy
(splice) or whether to decrypt and let the rest of the proxy do things
to the traffic (bump).

The other access rules in your proxy just allow if anything ecrypted
comes from a localnet client. So nothing in the way of blocking based on
SNI, URL domain or such ever happens.


HTH
Amos


From portalnet2 at outlook.com.br  Thu Apr 18 00:03:13 2019
From: portalnet2 at outlook.com.br (tester100)
Date: Wed, 17 Apr 2019 19:03:13 -0500 (CDT)
Subject: [squid-users] Squid 3.5 https facebook caching
In-Reply-To: <95e8facb-4e51-09a4-b505-0a6e13367419@treenet.co.nz>
References: <1555427055618-0.post@n4.nabble.com>
 <95e8facb-4e51-09a4-b505-0a6e13367419@treenet.co.nz>
Message-ID: <1555545793141-0.post@n4.nabble.com>

Amos  

big thxs for all your input

it just shows me that i know nothing about squid that i am complete newbie,
and that i need to spend my time reading all the manual and config examples.

big thanks i will have some guidance on reading and research for the next
couple of days now.



--
Sent from: http://squid-web-proxy-cache.1019090.n4.nabble.com/Squid-Users-f1019091.html


From david at articatech.com  Thu Apr 18 07:18:41 2019
From: david at articatech.com (David Touzeau)
Date: Thu, 18 Apr 2019 09:18:41 +0200
Subject: [squid-users] squid v4: logformat log the last denied ACL object
In-Reply-To: <67f94546-58b2-0dd5-24c3-4d6059864197@measurement-factory.com>
References: <3a67a227-f921-05a6-170a-3b37884003b3@articatech.com>
 <67f94546-58b2-0dd5-24c3-4d6059864197@measurement-factory.com>
Message-ID: <c2ed87a3-0204-bf19-ea30-df6c89ef66c6@articatech.com>


Le 15/04/2019 ? 22:41, Alex Rousskov a ?crit?:
> On 4/15/19 8:01 AM, David Touzeau wrote:
>
>> Is it possible, sometimes to better understand a bunch of ACLs to log
>> the last matches or a set of matched acls objects:
>> 192.168.1.235 - - [15/Apr/2019:15:59:30 +0200] "GET
>> http://www.msftncsi.com/ncsi.txt HTTP/1.1" 200 211 "-" "curl/7.52.1"
>> TCP_MISS:HIER_DIRECT text/plain objects1,objects2
> Yes, it is possible to do something like that in modern Squids, but
> covering all ACLs in a non-trivial squid.conf would require tedious
> manual work or automation. Here is a rough untested recipe:
>
> 1. For each named ACL x that you want to access-log, create a wrapper
> annotation ACL called matchAndLogX:
>
>     acl x ...
>     acl annotateAfterX annotate_transaction matchedAcls+=x
>     acl matchAndLogX all-of x annotateAfterX
>
>
> 2. For each named ACL x wrapped in step 1, replace all its uses in old
> squid.conf directives with the matchAndLogX ACLs defined in step 1. For
> example:
>
>     http_access deny x y
>
> becomes
>
>     http_access deny matchAndLogX matchAndLogY
>
>
> 3. Add matchedAcls annotation to your logformat definition to log
> annotations accumulated by the wrapper ACLs defined in step 1:
>
>     logformat myAccessRecord ...  %note{matchedAcls}
>     access_log ... logformat=myAccessRecord ...
>
>
> Depending on your actual configuration, you may be able to reduce the
> amount of logging/wrapping if you annotate groups of matching ACLs
> rather than each individual ACL. For example:
>
>      acl annotateAfterX annotate_transaction matchedAcls+=(x,y)
>      http_access deny x y annotateAfterXandY
>
>
> Needless to say, adding such annotations manually to a non-trivial
> configuration is a lot of error-prone work! Automating wrapping,
> monitoring cache.log with elevated debugging levels (see debug_options),
> or hacking Squid to log the info you need is a better approach in many
> (most?) cases.
>
>
> HTH,
>
> Alex.
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users

Thanks !!!

Will try both options





From info at schroeffu.ch  Thu Apr 18 09:26:38 2019
From: info at schroeffu.ch (info at schroeffu.ch)
Date: Thu, 18 Apr 2019 09:26:38 +0000
Subject: [squid-users] Squid 4.6 cannot open 2 other popular domains with
	SSL bump
Message-ID: <9fc16f0ce0ee476f35a9a67e1de42079@schroeffu.ch>

Hi Squid Users,

with Squid 4.6 I cannot open these 2 domains when SSL bump is enabled:

https://www.hays.de
https://www.plantronics.com

Both are showing me a different type of error, details below.
I could not find any HPKP site or subdomain there, so I guess Squid has another problem with this domains.
Can somebody explain me how I should debug that correctly, to open a bugreport?

### Bump Settings:

 acl domains_dont_sslbump ssl::server_name_regex "/etc/squid/ka/domains_dont_sslbump.acl"
 acl domains_dont_sslbump ssl::server_name_regex "/etc/squid/blacklists/blacklist_ut1/blacklists/bank/domains"
 acl domains_dont_sslbump ssl::server_name_regex "/etc/squid/blacklists/blacklist_shallalist/BL/finance/banking/domains"
 acl domains_dont_sslbump ssl::server_name_regex "/etc/squid/blacklists/blacklist_shallalist/BL/finance/other/domains"
 http_port proxy02:8080 ssl-bump generate-host-certificates=on dynamic_cert_mem_cache_size=4MB cert=/etc/squid/certs/cert.pem key=/etc/squid/certs/key.ohnersa.pem
 sslcrtd_program /usr/lib/squid/security_file_certgen -s /var/lib/ssl_db -M 4MB
 always_direct allow all
 acl step1 at_step SslBump1
 ssl_bump peek step1
 ssl_bump bump all !domains_dont_sslbump

#### hays.de:
1555577795.968 1 172.16.x.x TCP_DENIED/407 4995 GET http://hays.de/ - HIER_NONE/- text/html
1555577796.067 63 172.16.x.x TCP_MISS/301 465 GET http://hays.de/ user1 HIER_DIRECT/149.126.72.70 -
1555577796.083 0 172.16.x.x TCP_DENIED/407 4124 CONNECT hays.de:443 - HIER_NONE/- text/html
1555577796.101 1 172.16.x.x TCP_DENIED/407 4460 CONNECT hays.de:443 - HIER_NONE/- text/html
1555577796.202 86 172.16.x.x NONE/200 0 CONNECT hays.de:443 user1 HIER_DIRECT/149.126.72.70 -
1555577796.302 15 172.16.x.x TCP_MISS/301 345 GET https://hays.de/ user1 HIER_DIRECT/149.126.72.70 -
1555577796.320 0 172.16.x.x TCP_DENIED/407 4140 CONNECT www.hays.de:443 - HIER_NONE/- text/html
1555577796.333 1 172.16.x.x TCP_DENIED/407 4476 CONNECT www.hays.de:443 - HIER_NONE/- text/html
1555577796.507 158 172.16.x.x NONE/200 0 CONNECT www.hays.de:443 user1 HIER_DIRECT/149.126.77.70 -
1555577796.602 30 172.16.x.x TCP_MISS_ABORTED/000 0 GET https://www.hays.de/ user1 HIER_DIRECT/149.126.77.70 -

Error displayed on https://www.hays.de (from the Browser Chrome/or Firefox):

 Chrome: ERR_EMPTY_RESPONSE
 Firefox: Secure Connection Failed // An error occurred during a connection to www.hays.de. // The page you are trying to view cannot be shown because the authenticity of the received data could not be verified. // Please contact the website owners to inform them of this problem.

Header Response while this error message is displayed:

 HTTP/1.1 200 Connection established
 Server: squid
 Mime-Version: 1.0
 Date: Thu, 18 Apr 2019 09:05:28 GMT
 Content-Type: text/html;charset=utf-8
 Content-Length: 3759
 X-Squid-Error: ERR_CACHE_ACCESS_DENIED 0
 Proxy-Authenticate: NTLM VNTUAACAAAADAAMAD(...)
 X-Cache: MISS from proxy02
 X-Cache-Lookup: NONE from proxy02:8080
 Via: 1.1 proxy02 (squid)
 Connection: keep-alive

#### plantronics.com
1555577912.476 391 172.16.x.x TCP_MISS/301 869 GET http://plantronics.com/ user1 HIER_DIRECT/198.231.10.19 text/html
1555577912.514 0 172.16.x.x TCP_DENIED/407 4172 CONNECT www.plantronics.com:443 - HIER_NONE/- text/html
1555577912.529 1 172.16.x.x TCP_DENIED/407 4508 CONNECT www.plantronics.com:443 - HIER_NONE/- text/html
1555577912.864 324 172.16.x.x NONE/200 0 CONNECT www.plantronics.com:443 user1 HIER_DIRECT/54.192.94.216 -
1555577913.564 521 172.16.x.x TCP_MISS/403 745 GET https://www.plantronics.com/ user1 HIER_DIRECT/54.192.94.216 text/html

Error displayed on frontpage https://www.plantronics.com (from their Apache or Nginx):

 Forbidden
 You don't have permission to access /.noindex.html on this server.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20190418/7302951b/attachment.htm>

From squid3 at treenet.co.nz  Thu Apr 18 10:32:23 2019
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Thu, 18 Apr 2019 22:32:23 +1200
Subject: [squid-users] Squid 4.6 cannot open 2 other popular domains
 with SSL bump
In-Reply-To: <9fc16f0ce0ee476f35a9a67e1de42079@schroeffu.ch>
References: <9fc16f0ce0ee476f35a9a67e1de42079@schroeffu.ch>
Message-ID: <113fe037-50f1-5f8d-6be1-76767579504b@treenet.co.nz>

On 18/04/19 9:26 pm, info at schroeffu.ch wrote:
> Hi Squid Users,
> 
> with Squid 4.6 I cannot open these 2 domains when SSL bump is enabled:
> 
> https://www.hays.de
> https://www.plantronics.com
> 
> Both are showing me a different type of error, details below.
> I could not find any HPKP site or subdomain there, so I guess Squid has
> another problem with this domains.
> Can somebody explain me how I should debug that correctly, to open a
> bugreport?
> 
> ### Bump Settings:
> 
> acl domains_dont_sslbump ssl::server_name_regex
> "/etc/squid/ka/domains_dont_sslbump.acl"
> acl domains_dont_sslbump ssl::server_name_regex
> "/etc/squid/blacklists/blacklist_ut1/blacklists/bank/domains"
> acl domains_dont_sslbump ssl::server_name_regex
> "/etc/squid/blacklists/blacklist_shallalist/BL/finance/banking/domains"
> acl domains_dont_sslbump ssl::server_name_regex
> "/etc/squid/blacklists/blacklist_shallalist/BL/finance/other/domains"
> 
> http_port proxy02:8080 ssl-bump generate-host-certificates=on
> dynamic_cert_mem_cache_size=4MB cert=/etc/squid/certs/cert.pem
> key=/etc/squid/certs/key.ohnersa.pem
> sslcrtd_program /usr/lib/squid/security_file_certgen -s /var/lib/ssl_db
> -M 4MB
> always_direct allow all

You are no longer using an experimental patch on Squid-3.2. If you ever
did. This config hack to work around a very short lived / temporary bug
in SSL-Bump behaviour has not been necessary for many years.


> acl step1 at_step SslBump1
> ssl_bump peek step1
> ssl_bump bump all !domains_dont_sslbump
> 
> #### hays.de:
> 1555577795.968 1 172.16.x.x TCP_DENIED/407 4995 GET http://hays.de/ -
> HIER_NONE/- text/html
> 1555577796.067 63 172.16.x.x TCP_MISS/301 465 GET http://hays.de/ user1
> HIER_DIRECT/149.126.72.70 -
> 1555577796.083 0 172.16.x.x TCP_DENIED/407 4124 CONNECT hays.de:443 -
> HIER_NONE/- text/html
> 1555577796.101 1 172.16.x.x TCP_DENIED/407 4460 CONNECT hays.de:443 -
> HIER_NONE/- text/html
> 1555577796.202 86 172.16.x.x NONE/200 0 CONNECT hays.de:443 user1
> HIER_DIRECT/149.126.72.70 -
> 1555577796.302 15 172.16.x.x TCP_MISS/301 345 GET https://hays.de/ user1
> HIER_DIRECT/149.126.72.70 -
> 1555577796.320 0 172.16.x.x TCP_DENIED/407 4140 CONNECT www.hays.de:443
> - HIER_NONE/- text/html
> 1555577796.333 1 172.16.x.x TCP_DENIED/407 4476 CONNECT www.hays.de:443
> - HIER_NONE/- text/html
> 1555577796.507 158 172.16.x.x NONE/200 0 CONNECT www.hays.de:443 user1
> HIER_DIRECT/149.126.77.70 -
> 1555577796.602 30 172.16.x.x TCP_MISS_ABORTED/000 0 GET
> https://www.hays.de/ user1 HIER_DIRECT/149.126.77.70 -
> 
> Error displayed on https://www.hays.de (from the Browser Chrome/or Firefox):
> 
> Chrome: ERR_EMPTY_RESPONSE
> Firefox: Secure Connection Failed // An error occurred during a
> connection to www.hays.de. // The page you are trying to view cannot be
> shown because the authenticity of the received data could not be
> verified. // Please contact the website owners to inform them of this
> problem.
> 
> Header Response while this error message is displayed:
> 
> HTTP/1.1 200 Connection established
> Server: squid
> Mime-Version: 1.0
> Date: Thu, 18 Apr 2019 09:05:28 GMT
> Content-Type: text/html;charset=utf-8
> Content-Length: 3759
> X-Squid-Error: ERR_CACHE_ACCESS_DENIED 0
> Proxy-Authenticate: NTLM VNTUAACAAAADAAMAD(...)
> X-Cache: MISS from proxy02
> X-Cache-Lookup: NONE from proxy02:8080
> Via: 1.1 proxy02 (squid)
> Connection: keep-alive

This is the plain-text message in response to the client CONNECT
request. All it does is tell the Browser that the proxy has given is a
TCP connection (er tunnel) to the origin and it can start the TLS
handshakes.

The 'empty response' Chrome is mentioning is what follows the TLS
handshake, which itself follows the above plain-text headers. If the TLS
fails for any reason there will be no such response.
 So this is Chrome willfully hiding TLS errors from the user while
taking the opportunity to blame the proxy for those failures it has
exchanging TLS with the _origin_ server.


Note that all out SSL-Bump related documentation states that "when used
properly TLS cannot be bumped". Specifically the X.509 server
certificate cannot be forced to be trusted by the clients. If they are
aware (via a number of other means) what that certificate should look
like they *will* reject Squids generated (forged) server cert.
 Good luck finding out whether that is the case though. Browser people
like to hide such details from us all.
 Try to perform these HTTPS transactions without using a Browser. That
should make it clearer what the issue is, and in which piece of software
(Browser, Squid, OpenSSL, or origin server).


The other common alternative is that these sites TLS is suddenly broken.
Test if traffic works without the proxy. Preferably with a tool that can
show you the TLS handshake particulars.


> 
> #### plantronics.com
> 1555577912.476 391 172.16.x.x TCP_MISS/301 869 GET
> http://plantronics.com/ user1 HIER_DIRECT/198.231.10.19 text/html
> 1555577912.514 0 172.16.x.x TCP_DENIED/407 4172 CONNECT
> www.plantronics.com:443 - HIER_NONE/- text/html
> 1555577912.529 1 172.16.x.x TCP_DENIED/407 4508 CONNECT
> www.plantronics.com:443 - HIER_NONE/- text/html
> 1555577912.864 324 172.16.x.x NONE/200 0 CONNECT www.plantronics.com:443
> user1 HIER_DIRECT/54.192.94.216 -
> 1555577913.564 521 172.16.x.x TCP_MISS/403 745 GET
> https://www.plantronics.com/ user1 HIER_DIRECT/54.192.94.216 text/html
> 
> Error displayed on frontpage https://www.plantronics.com (from their
> Apache or Nginx):
> 
> Forbidden
> You don't have permission to access /.noindex.html on this server.
> 

Notice that this is a page generated by *their* server. Your proxy is
successfully decrypting the traffic. Their server is not happy or
understanding the HTTPS requests arriving after that.

Amos


From squid3 at treenet.co.nz  Thu Apr 18 10:45:04 2019
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Thu, 18 Apr 2019 22:45:04 +1200
Subject: [squid-users] Squid 3.5 https facebook caching
In-Reply-To: <1555545793141-0.post@n4.nabble.com>
References: <1555427055618-0.post@n4.nabble.com>
 <95e8facb-4e51-09a4-b505-0a6e13367419@treenet.co.nz>
 <1555545793141-0.post@n4.nabble.com>
Message-ID: <29c923ba-93ef-7f10-585c-9cf54383a1eb@treenet.co.nz>

On 18/04/19 12:03 pm, tester100 wrote:
> Amos  
> 
> big thxs for all your input
> 
> it just shows me that i know nothing about squid that i am complete newbie,
> and that i need to spend my time reading all the manual and config examples.
> 

I did not mean to imply a lot of reading was needed. Just some in
relation to the items I mentioned as probably leading to your issue. The
rest can be long-term goals to fix up.

FYI: The Squid wiki <http://wiki.squid-cache.org/> and config manual
<http://www.squid-cache.org/Doc/config/> (the v3.5 pages for your Squid
version) are the most accurate information sources behind reading the
code itself. But keep in mind that Squid-3 is also outdated nowdays,
Squid-4 and later have changed some significant feature behaviours.


Most of the things I pointed out were useful at some point (eg Squid-2),
and may still be for some use-cases. But for which Squid behaviour has
changed since how-tos and tutorials advising them were written.


> big thanks i will have some guidance on reading and research for the next
> couple of days now.
> 

You are welcome. Any further questions or advice wanted please feel free
to ask. Helping each other use Squid is a what this mailing list is
about - for experts and newbies alike.

Cheers
Amos


From m.wegner at hopitaldugier.fr  Thu Apr 18 13:34:00 2019
From: m.wegner at hopitaldugier.fr (=?utf-8?Q?Wegner_Micha=C3=ABl?=)
Date: Thu, 18 Apr 2019 15:34:00 +0200
Subject: [squid-users] squid-users Digest, Vol 56, Issue 12
In-Reply-To: <343d0c9c.1d4eeb5.3d82a6b3.2eef@hopitaldugier.fr>
Message-ID: <8984823b.1d4f5eb.6cc6cb3c.3b71@hopitaldugier.fr>

Hi,

The SSL is OK I always can't play some YouTube video.
Squid in version 4.6
In access.log : TCP_TUNNEL/200 2083 CONNECT www.youtube.com:443 - HIER_DIRECT/216.58.206.238
I think the problem comes from heading.

My squid.conf for test is :
visible_hostname squid

acl localnet src 10.0.0.0/8

acl SSL_ports port 443

acl Safe_ports port 80          # http
acl Safe_ports port 21          # ftp
acl Safe_ports port 443         # https
acl Safe_ports port 70          # gopher
acl Safe_ports port 210         # wais
acl Safe_ports port 1025-65535  # unregistered ports
acl Safe_ports port 280         # http-mgmt
acl Safe_ports port 488         # gss-http
acl Safe_ports port 591         # filemaker
acl Safe_ports port 777         # multiling http

acl CONNECT method CONNECT

http_access deny !Safe_ports
http_access deny CONNECT !SSL_ports
http_access allow localnet
http_access allow localhost
http_access deny all

http_port 3128
https_port 3129 intercept ssl-bump generate-host-certificates=on dynamic_cert_mem_cache_size=4MB cert=/opt/squid/etc/ssl_cert/myCA.pem

ssl_bump splice localhost
acl 9 at_step SslBump1
acl 10 at_step SslBump2
acl 11 at_step SslBump3
ssl_bump peek 9 all
ssl_bump bump 10 all
ssl_bump bump 11 all

coredump_dir /var/spool/squid


Kind regards,

-----Message d'origine-----
De?: Wegner Micha?l [mailto:m.wegner at hopitaldugier.fr] 
Envoy??: mardi 9 avril 2019 11:18
??: squid-users at lists.squid-cache.org
Objet?: RE: squid-users Digest, Vol 56, Issue 12



-----Message d'origine-----
De?: Wegner Micha?l [mailto:m.wegner at hopitaldugier.fr]
Envoy??: lundi 8 avril 2019 11:15
??: squid-users at lists.squid-cache.org
Objet?: RE: squid-users Digest, Vol 56, Issue 12

Hi Antony,

The video is Ok, if i not used squid v3.5.
If on the squid.conf file I disabled rediretion on squidgaurd the problem is the same.
If squid is actived, somme videos are blocked, (the videos in restricted mode) With a old version of squid (2.6) there are no problems

Regards,

Hi,

I install a new serveur squid version 4.6 without squiguard and access allow all.
I set the ssl and i import certificate on the client but without success.

My squid.conf is : 

acl localnet src 0.0.0.1-0.255.255.255  # RFC 1122 "this" network (LAN)
acl localnet src 10.0.0.0/8             # RFC 1918 local private network (LAN)
acl localnet src 100.64.0.0/10          # RFC 6598 shared address space (CGN)
acl localnet src 169.254.0.0/16         # RFC 3927 link-local (directly plugged) machines
acl localnet src 172.16.0.0/12          # RFC 1918 local private network (LAN)
acl localnet src 192.168.0.0/16         # RFC 1918 local private network (LAN)
acl localnet src fc00::/7               # RFC 4193 local private network range
acl localnet src fe80::/10              # RFC 4291 link-local (directly plugged) machines

acl SSL_ports port 443
acl Safe_ports port 80          # http
acl Safe_ports port 21          # ftp
acl Safe_ports port 443         # https
acl Safe_ports port 70          # gopher
acl Safe_ports port 210         # wais
acl Safe_ports port 1025-65535  # unregistered ports
acl Safe_ports port 280         # http-mgmt
acl Safe_ports port 488         # gss-http
acl Safe_ports port 591         # filemaker
acl Safe_ports port 777         # multiling http
acl CONNECT method CONNECT

#
# Deny requests to certain unsafe ports
http_access deny !Safe_ports

# Deny CONNECT to other than secure SSL ports http_access deny CONNECT !SSL_ports

# Only allow cachemgr access from localhost http_access allow localhost manager http_access deny manager

#
# INSERT YOUR OWN RULE(S) HERE TO ALLOW ACCESS FROM YOUR CLIENTS # include /etc/squid/conf.d/*

#http_access allow localnet
http_access allow localhost

# And finally deny all other access to this proxy #http_access deny all http_access allow all


http_port 3128 ssl-bump cert=/opt/squid/etc/ssl_cert/myCA.pem generate-host-certificates=on dynamic_cert_mem_cache_size=4MB sslcrtd_program /usr/lib/squid/security_file_certgen -s /opt/squid/log/squid/ssl_db -M 4MB coredump_dir /opt/squid/var/cache/squid cache_dir ufs /opt/squid/var/cache/squid 1000 16 256 # 1GB as Cache


# Squid normally listens to port 3128

#http_port 3128

# Leave coredumps in the first cache dir coredump_dir /var/spool/squid



refresh_pattern ^ftp:           1440    20%     10080
refresh_pattern ^gopher:        1440    0%      1440
refresh_pattern -i (/cgi-bin/|\?) 0     0%      0
refresh_pattern .               0       20%     4320


regards

Micha?l


-----Message d'origine-----
De?: squid-users [mailto:squid-users-bounces at lists.squid-cache.org] De la part de squid-users-request at lists.squid-cache.org
Envoy??: samedi 6 avril 2019 14:00
??: squid-users at lists.squid-cache.org
Objet?: squid-users Digest, Vol 56, Issue 12

Send squid-users mailing list submissions to
	squid-users at lists.squid-cache.org

To subscribe or unsubscribe via the World Wide Web, visit
	http://lists.squid-cache.org/listinfo/squid-users
or, via email, send a message with subject or body 'help' to
	squid-users-request at lists.squid-cache.org

You can reach the person managing the list at
	squid-users-owner at lists.squid-cache.org

When replying, please edit your Subject line so it is more specific than "Re: Contents of squid-users digest..."


Today's Topics:

   1. youtube restriction. (Wegner Micha?l)
   2. Re: youtube restriction. (Vacheslav Zouhairy)
   3. Re: youtube restriction. (Antony Stone)


----------------------------------------------------------------------

Message: 1
Date: Fri, 05 Apr 2019 15:06:00 +0200
From: Wegner Micha?l <m.wegner at hopitaldugier.fr>
To: squid-users at lists.squid-cache.org
Subject: [squid-users] youtube restriction.
Message-ID: <527bfee2.1d4ebb0.29b980e7.db3 at hopitaldugier.fr>
Content-Type: text/plain; charset="iso-8859-1"

Hi,
 
I install squid + squidguard, and I can't play youtube video.
For example : https://m.youtube.com/watch?v=Hmj3LToi4W8 ; https://m.youtube.com/watch?v=jbBUQ-uvlRU
 
Error : video not available access to this video is limited
 
I have Ubuntu server 18.04 and squid v 3.5.27
 
Can' you help me please
 
Thanks,
 
Kind Regards
 
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20190405/0f1e17cf/attachment-0001.html>

------------------------------

Message: 2
Date: Fri, 05 Apr 2019 16:21:28 +0300
From: Vacheslav Zouhairy <m_zouhairy at skno.by>
To: squid-users at lists.squid-cache.org
Subject: Re: [squid-users] youtube restriction.
Message-ID: <edde432e1f0745413ed6d35d157a6abc025b7d3d.camel at skno.by>
Content-Type: text/plain; charset="utf-8"

time to try ufdbguard, it is very flexible and relatively easy to configure.
On Fri, 2019-04-05 at 15:06 +0200, Wegner Micha?l wrote:
> Hi,
>  
> I install squid + squidguard, and I can?t play youtube video.
> For example : https://m.youtube.com/watch?v=Hmj3LToi4W8 ; 
> https://m.youtube.com/watch?v=jbBUQ-uvlRU
>  
> Error : video not available
> access to this video is limited I have Ubuntu server 18.04 and squid v
> 3.5.27 Can? you help me please Thanks, Kind Regards 
> _______________________________________________squid-users mailing 
> listsquid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20190405/4c512724/attachment-0001.html>

------------------------------

Message: 3
Date: Fri, 5 Apr 2019 15:39:08 +0200
From: Antony Stone <Antony.Stone at squid.open.source.it>
To: squid-users at lists.squid-cache.org
Subject: Re: [squid-users] youtube restriction.
Message-ID: <201904051539.08777.Antony.Stone at squid.open.source.it>
Content-Type: Text/Plain;  charset="iso-8859-15"

On Friday 05 April 2019 at 15:06:00, Wegner Micha?l wrote:

> Hi,
> 
> I install squid + squidguard, and I can't play youtube video.
> For example : https://m.youtube.com/watch?v=Hmj3LToi4W8 ; 
> https://m.youtube.com/watch?v=jbBUQ-uvlRU
> 
> Error : video not available access to this video is limited

1. Does it work if you do not go via Squid and SquidGuard?

2. Can you play any other Youtube videos?

3. Given that this is an HTTPS connection, how are you restricting HTTPS content with SquidGuard?

> I have Ubuntu server 18.04 and squid v 3.5.27
> 
> Can' you help me please

Regards,


Antony.

--
"Measuring average network latency is about as useful as measuring the mean temperature of patients in a hospital."

 - St?phane Bortzmeyer

                                                   Please reply to the list;
                                                         please *don't* CC me.


------------------------------

Subject: Digest Footer

_______________________________________________
squid-users mailing list
squid-users at lists.squid-cache.org
http://lists.squid-cache.org/listinfo/squid-users


------------------------------

End of squid-users Digest, Vol 56, Issue 12
*******************************************



From ngtech1ltd at gmail.com  Thu Apr 18 21:17:32 2019
From: ngtech1ltd at gmail.com (Eliezer Croitoru)
Date: Fri, 19 Apr 2019 00:17:32 +0300
Subject: [squid-users] Squid 3.5 https facebook caching
In-Reply-To: <29c923ba-93ef-7f10-585c-9cf54383a1eb@treenet.co.nz>
References: <1555427055618-0.post@n4.nabble.com>
 <95e8facb-4e51-09a4-b505-0a6e13367419@treenet.co.nz>
 <1555545793141-0.post@n4.nabble.com>
 <29c923ba-93ef-7f10-585c-9cf54383a1eb@treenet.co.nz>
Message-ID: <6f81e912-2c71-b25e-818b-7c16df7298e7@gmail.com>

Just to add:

Facebook has these headers for many of their videos:

 1.
    Cache-Control:
    max-age=1209600, no-transform


So what happens is that the client browser will save these URLs for a 
very long time and it's good.

It takes of burden from the intermediate proxy.

I wrote some code that works for most of the facebook public videos at:

http://gogs.ngtech.co.il/NgTech-LTD/storeid-helpers/raw/master/facebook--video-2019.rb


Hope it helps.

Eliezer


On 4/18/2019 1:45 PM, Amos Jeffries wrote:
> On 18/04/19 12:03 pm, tester100 wrote:
>> Amos
>>
>> big thxs for all your input
>>
>> it just shows me that i know nothing about squid that i am complete newbie,
>> and that i need to spend my time reading all the manual and config examples.
>>
> I did not mean to imply a lot of reading was needed. Just some in
> relation to the items I mentioned as probably leading to your issue. The
> rest can be long-term goals to fix up.
>
> FYI: The Squid wiki <http://wiki.squid-cache.org/> and config manual
> <http://www.squid-cache.org/Doc/config/> (the v3.5 pages for your Squid
> version) are the most accurate information sources behind reading the
> code itself. But keep in mind that Squid-3 is also outdated nowdays,
> Squid-4 and later have changed some significant feature behaviours.
>
>
> Most of the things I pointed out were useful at some point (eg Squid-2),
> and may still be for some use-cases. But for which Squid behaviour has
> changed since how-tos and tutorials advising them were written.
>
>
>> big thanks i will have some guidance on reading and research for the next
>> couple of days now.
>>
> You are welcome. Any further questions or advice wanted please feel free
> to ask. Helping each other use Squid is a what this mailing list is
> about - for experts and newbies alike.
>
> Cheers
> Amos
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users
-- 

----

Eliezer Croitoru <http://ngtech.co.il/main-en/>
Linux System Administrator
Mobile: +972-5-28704261
Email: eliezer at ngtech.co.il <mailto:eliezer at ngtech.co.il>



From squid3 at treenet.co.nz  Fri Apr 19 03:35:49 2019
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Fri, 19 Apr 2019 15:35:49 +1200
Subject: [squid-users] Squid 3.5 https facebook caching
In-Reply-To: <6f81e912-2c71-b25e-818b-7c16df7298e7@gmail.com>
References: <1555427055618-0.post@n4.nabble.com>
 <95e8facb-4e51-09a4-b505-0a6e13367419@treenet.co.nz>
 <1555545793141-0.post@n4.nabble.com>
 <29c923ba-93ef-7f10-585c-9cf54383a1eb@treenet.co.nz>
 <6f81e912-2c71-b25e-818b-7c16df7298e7@gmail.com>
Message-ID: <67347320-3125-f3c4-d706-46820eea5718@treenet.co.nz>

On 19/04/19 9:17 am, Eliezer Croitoru wrote:
> Just to add:
> 
> Facebook has these headers for many of their videos:
> 
> 1.
> ?? Cache-Control:
> ?? max-age=1209600, no-transform
> 
> 
> So what happens is that the client browser will save these URLs for a
> very long time and it's good.


As will Squid unless the admin has configured refresh_pattern options
that force expiry earlier.

Amos


From squid3 at treenet.co.nz  Fri Apr 19 03:59:23 2019
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Fri, 19 Apr 2019 15:59:23 +1200
Subject: [squid-users] squid-users Digest, Vol 56, Issue 12
In-Reply-To: <8984823b.1d4f5eb.6cc6cb3c.3b71@hopitaldugier.fr>
References: <8984823b.1d4f5eb.6cc6cb3c.3b71@hopitaldugier.fr>
Message-ID: <a018e0cd-8dc7-02b2-d474-82a202472bfa@treenet.co.nz>

> -----Message d'origine-----
...
>
> When replying, please edit your Subject line so it is more specific
than "Re: Contents of squid-users digest..."

When you are trying to message the list about issues please change your
subscription settings to deliver you the individual posts so you can
reply to threads instead of digests.


On 19/04/19 1:34 am, Wegner Micha?l wrote:
> Hi,
> 
> The SSL is OK I always can't play some YouTube video.
> Squid in version 4.6
> In access.log : TCP_TUNNEL/200 2083 CONNECT www.youtube.com:443 - HIER_DIRECT/216.58.206.238
> I think the problem comes from heading.
> 

What are you calling "heading"?


The (incomplete) access.log entry you show has;

 * an unknown client requesting a tunnel to www.youtube.com.

 * Squid is opening a tunnel to the server 216.58.206.238.

 * Squid is informing the client that it was 200/success. The tunnel can
be used.

 * 2083 bytes are sent to the client. Some of those were for the 200
response.

 * the tunnel is closed without any errors having occured.


This line means multiple different things depending on which port your
proxy received it on (if received) or whether Squid generated the
CONNECT pieces for SSL-Bump internal use.


> My squid.conf for test is :
> visible_hostname squid
> 
> acl localnet src 10.0.0.0/8
> 
> acl SSL_ports port 443
> 
> acl Safe_ports port 80          # http
> acl Safe_ports port 21          # ftp
> acl Safe_ports port 443         # https
> acl Safe_ports port 70          # gopher
> acl Safe_ports port 210         # wais
> acl Safe_ports port 1025-65535  # unregistered ports
> acl Safe_ports port 280         # http-mgmt
> acl Safe_ports port 488         # gss-http
> acl Safe_ports port 591         # filemaker
> acl Safe_ports port 777         # multiling http
> 
> acl CONNECT method CONNECT
> 
> http_access deny !Safe_ports
> http_access deny CONNECT !SSL_ports
> http_access allow localnet
> http_access allow localhost
> http_access deny all
> 
> http_port 3128

Traffic arriving on above port never has SSL-Bump applied to it. Tunnels
are always directly client<->origin with no Squid interaction to the
HTTPS portion.


> https_port 3129 intercept ssl-bump generate-host-certificates=on dynamic_cert_mem_cache_size=4MB cert=/opt/squid/etc/ssl_cert/myCA.pem
> 
> ssl_bump splice localhost

Traffic NAT intercepted from localhost is always spliced. The TLS and
wrapped HTTPS are always directly client<->origin with no Squid interaction.

> acl 9 at_step SslBump1
> acl 10 at_step SslBump2
> acl 11 at_step SslBump3
> ssl_bump peek 9 all
> ssl_bump bump 10 all

All traffic which is from non-localhost is always bumped at step-2 by
SSL-Bump.

Step-2 has zero details about the actual origin server TLS capabilities
or properties. Bumping at this step is what we call "client-first". It
has *many* problems and should be avoided unless absolutely necessary.


YouTube is a Google domain. Google are particularly strict about their
TLS usage and security. They do a lot of things to absolutely prohibit
things like client-first being possible at all.

Bump not being possible at all is the normal state for Google domains.
It is more surprising that you are reporting "works fine" for parts of
YT than the failure.

More details will be needed to see what is going on. Please start by
providing the whole of that access.log line and the other log entries
from your test transaction. If bumping is happening at all there *will*
be multiple log entries.


> ssl_bump bump 11 all
> 

Above should never happen because everything was already spliced at
step-1 or bumped at step-2.


Amos


From m.wegner at hopitaldugier.fr  Fri Apr 19 06:32:00 2019
From: m.wegner at hopitaldugier.fr (=?utf-8?Q?Wegner_Micha=C3=ABl?=)
Date: Fri, 19 Apr 2019 08:32:00 +0200
Subject: [squid-users] squid-users Digest, Vol 56, Issue 32
In-Reply-To: <mailman.143.1555646376.3077.squid-users@lists.squid-cache.org>
Message-ID: <b3fe8a78.1d4f679.706a7a38.46a8@hopitaldugier.fr>

Hi,

Please find below access.log, cache.log and syslog.
Do you want a other log

Thanks


root at srv-squid-i2:/var/log/squid# more access.log
1555648138.455  73091 10.5.27.200 TCP_TUNNEL/200 4085 CONNECT array615-prod.do.dsp.mp.microsoft.com:443 - HIER_DIRECT/40.69.219.197 -
1555648580.052  73447 10.5.27.200 TCP_TUNNEL/200 4088 CONNECT array608-prod.do.dsp.mp.microsoft.com:443 - HIER_DIRECT/40.69.221.239 -
1555649036.566    160 10.5.27.200 TCP_TUNNEL/200 7558 CONNECT c.urs.microsoft.com:443 - HIER_DIRECT/40.112.75.175 -
1555649119.277 125693 10.5.27.200 TCP_TUNNEL/200 4087 CONNECT array615-prod.do.dsp.mp.microsoft.com:443 - HIER_DIRECT/40.69.219.197 -
1555649138.798 109989 10.5.27.200 TCP_TUNNEL/200 20881 CONNECT iecvlist.microsoft.com:443 - HIER_DIRECT/152.199.19.161 -
1555649464.161 109997 10.5.27.200 TCP_TUNNEL/200 1712 CONNECT www.youtube.com:443 - HIER_DIRECT/216.58.215.46 -
1555649464.161 108037 10.5.27.200 TCP_TUNNEL/200 1197 CONNECT googleads.g.doubleclick.net:443 - HIER_DIRECT/172.217.19.226 -
1555649505.784  31964 10.5.27.200 TCP_TUNNEL_ABORTED/200 3877 CONNECT v10.events.data.microsoft.com:443 - HIER_DIRECT/52.114.132.21 -
1555649509.173    380 10.5.27.200 TCP_TUNNEL/200 4237 CONNECT v10.events.data.microsoft.com:443 - HIER_DIRECT/52.114.132.21 -
1555649680.077  90863 10.5.27.200 TCP_TUNNEL/200 4086 CONNECT array608-prod.do.dsp.mp.microsoft.com:443 - HIER_DIRECT/40.69.221.239 -
1555649850.998    473 10.5.27.200 TCP_TUNNEL/200 4318 CONNECT settings-win.data.microsoft.com:443 - HIER_DIRECT/52.138.216.83 -
1555650083.397 122117 10.5.27.200 TCP_TUNNEL/200 4086 CONNECT array615-prod.do.dsp.mp.microsoft.com:443 - HIER_DIRECT/40.69.219.197 -
1555650103.666  64195 10.5.27.200 TCP_TUNNEL/200 7202 CONNECT config.edge.skype.com:443 - HIER_DIRECT/13.107.3.128 -
1555650272.369  60315 10.5.27.200 TCP_TUNNEL_ABORTED/200 8347 CONNECT www.bing.com:443 - HIER_DIRECT/13.107.21.200 -
1555650780.077  92598 10.5.27.200 TCP_TUNNEL/200 4086 CONNECT array608-prod.do.dsp.mp.microsoft.com:443 - HIER_DIRECT/40.69.221.239 -
1555650836.825    170 10.5.27.200 TCP_TUNNEL/200 7412 CONNECT c.urs.microsoft.com:443 - HIER_DIRECT/40.127.128.174 -
1555651108.433  80243 10.5.27.200 TCP_TUNNEL/200 4088 CONNECT array615-prod.do.dsp.mp.microsoft.com:443 - HIER_DIRECT/40.69.219.197 -
1555651265.123 109984 10.5.27.200 TCP_TUNNEL/200 1716 CONNECT www.youtube.com:443 - HIER_DIRECT/216.58.204.142 -
1555651265.123 107990 10.5.27.200 TCP_TUNNEL/200 1315 CONNECT googleads.g.doubleclick.net:443 - HIER_DIRECT/216.58.209.226 -
1555651274.348    486 10.5.27.200 TCP_TUNNEL/200 4237 CONNECT v10.events.data.microsoft.com:443 - HIER_DIRECT/52.114.132.23 -
1555651880.093 109899 10.5.27.200 TCP_TUNNEL/200 4086 CONNECT array608-prod.do.dsp.mp.microsoft.com:443 - HIER_DIRECT/40.69.221.239 -
1555652318.162 124789 10.5.27.200 TCP_TUNNEL/200 4086 CONNECT array615-prod.do.dsp.mp.microsoft.com:443 - HIER_DIRECT/40.69.219.197 -
1555652637.037    168 10.5.27.200 TCP_TUNNEL/200 7558 CONNECT c.urs.microsoft.com:443 - HIER_DIRECT/137.117.142.136 -
1555652738.982 110004 10.5.27.200 TCP_TUNNEL/200 20880 CONNECT iecvlist.microsoft.com:443 - HIER_DIRECT/152.199.19.161 -
1555652949.663 125870 10.5.27.200 TCP_TUNNEL/200 4088 CONNECT array608-prod.do.dsp.mp.microsoft.com:443 - HIER_DIRECT/40.69.221.239 -
1555653066.135 109979 10.5.27.200 TCP_TUNNEL/200 1705 CONNECT www.youtube.com:443 - HIER_DIRECT/216.58.209.238 -
1555653066.135 107992 10.5.27.200 TCP_TUNNEL/200 1337 CONNECT googleads.g.doubleclick.net:443 - HIER_DIRECT/216.58.213.162 -
1555653074.079    215 10.5.27.200 TCP_TUNNEL/200 4237 CONNECT v10.events.data.microsoft.com:443 - HIER_DIRECT/52.114.75.78 -
1555653418.457  62776 10.5.27.200 TCP_TUNNEL/200 4087 CONNECT array615-prod.do.dsp.mp.microsoft.com:443 - HIER_DIRECT/40.69.219.197 -
1555653648.118  68460 10.5.27.200 TCP_TUNNEL/200 7202 CONNECT config.edge.skype.com:443 - HIER_DIRECT/13.107.3.128 -
1555654080.060 104160 10.5.27.200 TCP_TUNNEL/200 4086 CONNECT array608-prod.do.dsp.mp.microsoft.com:443 - HIER_DIRECT/40.69.221.239 -
1555654437.259    166 10.5.27.200 TCP_TUNNEL/200 7412 CONNECT c.urs.microsoft.com:443 - HIER_DIRECT/137.117.142.136 -
1555654475.378   2134 10.5.27.200 TCP_TUNNEL_ABORTED/200 7466 CONNECT arc.msn.com:443 - HIER_DIRECT/40.112.91.29 -
1555654475.378   2136 10.5.27.200 TCP_TUNNEL_ABORTED/200 5902 CONNECT arc.msn.com:443 - HIER_DIRECT/40.112.91.29 -
1555654475.379   2135 10.5.27.200 TCP_TUNNEL_ABORTED/200 5902 CONNECT arc.msn.com:443 - HIER_DIRECT/40.112.91.29 -
1555654475.379   2138 10.5.27.200 TCP_TUNNEL_ABORTED/200 5902 CONNECT arc.msn.com:443 - HIER_DIRECT/40.112.91.29 -
1555654508.826    840 10.5.27.200 TCP_TUNNEL_ABORTED/200 6667 CONNECT arc.msn.com:443 - HIER_DIRECT/40.112.91.29 -
1555654589.774    132 10.5.27.200 TCP_TUNNEL/200 4607 CONNECT disc601-prod.do.dsp.mp.microsoft.com:443 - HIER_DIRECT/95.101.16.117 -
1555654640.134  98179 10.5.27.200 TCP_TUNNEL/200 3561 CONNECT array615-prod.do.dsp.mp.microsoft.com:443 - HIER_DIRECT/40.69.219.197 -
1555654867.118 109979 10.5.27.200 TCP_TUNNEL/200 1703 CONNECT www.youtube.com:443 - HIER_DIRECT/172.217.18.206 -
1555654867.118 107994 10.5.27.200 TCP_TUNNEL/200 1282 CONNECT googleads.g.doubleclick.net:443 - HIER_DIRECT/172.217.19.226 -
1555654874.900   1004 10.5.27.200 TCP_TUNNEL/200 4237 CONNECT v10.events.data.microsoft.com:443 - HIER_DIRECT/52.114.32.7 -
1555654944.756     62 10.5.27.200 TCP_MISS/200 4680 GET http://tile-service.weather.microsoft.com/fr-FR/livetile/preinstall? - HIER_DIRECT/23.36.210.35 text/
Xml

root at srv-squid-i2:/var/log/squid# more cache.log
2019/04/19 06:25:02| Set Current Directory to /var/spool/squid
2019/04/19 06:25:02 kid1| storeDirWriteCleanLogs: Starting...
2019/04/19 06:25:02 kid1|   Finished.  Wrote 0 entries.
2019/04/19 06:25:02 kid1|   Took 0.00 seconds (  0.00 entries/sec).
2019/04/19 06:25:02 kid1| logfileRotate: daemon:/var/log/squid/access.log
2019/04/19 06:25:02 kid1| logfileRotate: daemon:/var/log/squid/access.log
2019/04/19 06:25:02 kid1| assertion failed: comm.cc:428: "!isOpen(conn->fd)"
2019/04/19 06:25:06 kid1| Set Current Directory to /var/spool/squid
2019/04/19 06:25:06 kid1| Starting Squid Cache version 4.6 for x86_64-pc-linux-gnu...
2019/04/19 06:25:06 kid1| Service Name: squid
2019/04/19 06:25:06 kid1| Process ID 26758
2019/04/19 06:25:06 kid1| Process Roles: worker
2019/04/19 06:25:06 kid1| With 1024 file descriptors available
2019/04/19 06:25:06 kid1| Initializing IP Cache...
2019/04/19 06:25:06 kid1| DNS Socket created at [::], FD 5
2019/04/19 06:25:06 kid1| DNS Socket created at 0.0.0.0, FD 10
2019/04/19 06:25:06 kid1| Adding nameserver 127.0.0.53 from /etc/resolv.conf
2019/04/19 06:25:06 kid1| Adding domain ifsi.chdupaysdegier.fr from /etc/resolv.conf
2019/04/19 06:25:06 kid1| helperOpenServers: Starting 5/32 'security_file_certgen' processes
2019/04/19 06:25:06 kid1| Logfile: opening log daemon:/var/log/squid/access.log
2019/04/19 06:25:06 kid1| Logfile Daemon: opening log /var/log/squid/access.log
2019/04/19 06:25:06 kid1| Local cache digest enabled; rebuild/rewrite every 3600/3600 sec
2019/04/19 06:25:06 kid1| Store logging disabled
2019/04/19 06:25:06 kid1| Swap maxSize 0 + 524288 KB, estimated 40329 objects
2019/04/19 06:25:06 kid1| Target number of buckets: 2016
2019/04/19 06:25:06 kid1| Using 8192 Store buckets
2019/04/19 06:25:06 kid1| Max Mem  size: 524288 KB
2019/04/19 06:25:06 kid1| Max Swap size: 0 KB
2019/04/19 06:25:06 kid1| Using Least Load store dir selection
2019/04/19 06:25:06 kid1| Set Current Directory to /var/spool/squid
2019/04/19 06:25:06 kid1| Finished loading MIME types and icons.
2019/04/19 06:25:06 kid1| HTCP Disabled.
2019/04/19 06:25:06 kid1| Pinger socket opened on FD 26
2019/04/19 06:25:06 kid1| Squid plugin modules loaded: 0
2019/04/19 06:25:06 kid1| Adaptation support is off.
2019/04/19 06:25:06 kid1| Accepting HTTP Socket connections at local=[::]:3128 remote=[::] FD 23 flags=9
2019/04/19 06:25:06 kid1| Accepting NAT intercepted SSL bumped HTTPS Socket connections at local=[::]:3129 remote=[::] FD 24 flags=41
2019/04/19 06:25:06| pinger: Initialising ICMP pinger ...
2019/04/19 06:25:06| pinger: ICMP socket opened.
2019/04/19 06:25:06| pinger: ICMPv6 socket opened
2019/04/19 06:25:07 kid1| storeLateRelease: released 0 objects
2019/04/19 06:43:48| SendEcho ERROR: sending to ICMPv6 packet to [2606:2800:133:206e:1315:22a5:2006:24fd]: (101) Network is unreachable
2019/04/19 06:49:14| SendEcho ERROR: sending to ICMPv6 packet to [2a00:1450:4007:809::200e]: (101) Network is unreachable
2019/04/19 06:49:16| SendEcho ERROR: sending to ICMPv6 packet to [2a00:1450:4007:805::2002]: (101) Network is unreachable
2019/04/19 07:03:32| SendEcho ERROR: sending to ICMPv6 packet to [2620:1ec:c11::200]: (101) Network is unreachable
2019/04/19 07:10:31 kid1| Logfile: opening log stdio:/var/spool/squid/netdb.state
2019/04/19 07:10:31 kid1| Logfile: closing log stdio:/var/spool/squid/netdb.state
2019/04/19 07:10:31 kid1| NETDB state saved; 1 entries, 0 msec
2019/04/19 07:19:15| SendEcho ERROR: sending to ICMPv6 packet to [2a00:1450:4007:817::200e]: (101) Network is unreachable
2019/04/19 07:19:17| SendEcho ERROR: sending to ICMPv6 packet to [2a00:1450:4007:812::2002]: (101) Network is unreachable
2019/04/19 07:43:48| SendEcho ERROR: sending to ICMPv6 packet to [2606:2800:133:206e:1315:22a5:2006:24fd]: (101) Network is unreachable
2019/04/19 07:49:16| SendEcho ERROR: sending to ICMPv6 packet to [2a00:1450:4007:808::200e]: (101) Network is unreachable
2019/04/19 07:49:18| SendEcho ERROR: sending to ICMPv6 packet to [2a00:1450:4007:805::2002]: (101) Network is unreachable
2019/04/19 08:19:17| SendEcho ERROR: sending to ICMPv6 packet to [2a00:1450:4007:816::200e]: (101) Network is unreachable
2019/04/19 08:19:19| SendEcho ERROR: sending to ICMPv6 packet to [2a00:1450:4007:805::2002]: (101) Network is unreachable
2019/04/19 08:22:24| SendEcho ERROR: sending to ICMPv6 packet to [2a02:26f0:d4:183::611]: (101) Network is unreachable
2019/04/19 08:22:33| SendEcho ERROR: sending to ICMPv6 packet to [2620:1ec:c11::200]: (101) Network is unreachable
2019/04/19 08:22:36| SendEcho ERROR: sending to ICMPv6 packet to [2a03:9180:1:64::e]: (101) Network is unreachable


root at srv-squid-i2:/var/log# more syslog
Apr 19 06:25:02 srv-squid-i2 rsyslogd:  [origin software="rsyslogd" swVersion="8.32.0" x-pid="850" x-info="http://www.rsyslog.com"] rsyslogd was HUPed
Apr 19 06:25:02 srv-squid-i2 squid[23529]: Closing Pinger socket on FD 26
Apr 19 06:25:02 srv-squid-i2 squid[23529]: storeDirWriteCleanLogs: Starting...
Apr 19 06:25:02 srv-squid-i2 squid[23529]:   Finished.  Wrote 0 entries.
Apr 19 06:25:02 srv-squid-i2 squid[23529]:   Took 0.00 seconds (  0.00 entries/sec).
Apr 19 06:25:02 srv-squid-i2 squid[23529]: logfileRotate: daemon:/var/log/squid/access.log
Apr 19 06:25:02 srv-squid-i2 squid[23529]: logfileRotate: daemon:/var/log/squid/access.log
Apr 19 06:25:02 srv-squid-i2 squid[23529]: assertion failed: comm.cc:428: "!isOpen(conn->fd)"
Apr 19 06:25:06 srv-squid-i2 squid[23527]: Squid Parent: squid-1 process 23529 exited due to signal 6 with status 0
Apr 19 06:25:06 srv-squid-i2 squid[23527]: Squid Parent: (squid-1) process 26758 started
Apr 19 06:25:06 srv-squid-i2 squid[26758]: Set Current Directory to /var/spool/squid
Apr 19 06:25:06 srv-squid-i2 squid[26758]: Starting Squid Cache version 4.6 for x86_64-pc-linux-gnu...
Apr 19 06:25:06 srv-squid-i2 squid[26758]: Service Name: squid
Apr 19 06:25:06 srv-squid-i2 squid[26758]: Process ID 26758
Apr 19 06:25:06 srv-squid-i2 squid[26758]: Process Roles: worker
Apr 19 06:25:06 srv-squid-i2 squid[26758]: With 1024 file descriptors available
Apr 19 06:25:06 srv-squid-i2 squid[26758]: Initializing IP Cache...
Apr 19 06:25:06 srv-squid-i2 squid[26758]: DNS Socket created at [::], FD 5
Apr 19 06:25:06 srv-squid-i2 squid[26758]: DNS Socket created at 0.0.0.0, FD 10
Apr 19 06:25:06 srv-squid-i2 squid[26758]: Adding nameserver 127.0.0.53 from /etc/resolv.conf
Apr 19 06:25:06 srv-squid-i2 squid[26758]: Adding domain ifsi.chdupaysdegier.fr from /etc/resolv.conf
Apr 19 06:25:06 srv-squid-i2 squid[26758]: helperOpenServers: Starting 5/32 'security_file_certgen' processes
Apr 19 06:25:06 srv-squid-i2 squid[26758]: Logfile: opening log daemon:/var/log/squid/access.log
Apr 19 06:25:06 srv-squid-i2 squid[26758]: Logfile Daemon: opening log /var/log/squid/access.log
Apr 19 06:25:06 srv-squid-i2 squid[26758]: Local cache digest enabled; rebuild/rewrite every 3600/3600 sec
Apr 19 06:25:06 srv-squid-i2 squid[26758]: Store logging disabled
Apr 19 06:25:06 srv-squid-i2 squid[26758]: Swap maxSize 0 + 524288 KB, estimated 40329 objects
Apr 19 06:25:06 srv-squid-i2 squid[26758]: Target number of buckets: 2016
Apr 19 06:25:06 srv-squid-i2 squid[26758]: Using 8192 Store buckets
Apr 19 06:25:06 srv-squid-i2 squid[26758]: Max Mem  size: 524288 KB
Apr 19 06:25:06 srv-squid-i2 squid[26758]: Max Swap size: 0 KB
Apr 19 06:25:06 srv-squid-i2 squid[26758]: Using Least Load store dir selection
Apr 19 06:25:06 srv-squid-i2 squid[26758]: Set Current Directory to /var/spool/squid
Apr 19 06:25:06 srv-squid-i2 squid[26758]: Finished loading MIME types and icons.
Apr 19 06:25:06 srv-squid-i2 squid[26758]: HTCP Disabled.
Apr 19 06:25:06 srv-squid-i2 squid[26758]: Pinger socket opened on FD 26
Apr 19 06:25:06 srv-squid-i2 squid[26758]: Squid plugin modules loaded: 0
Apr 19 06:25:06 srv-squid-i2 squid[26758]: Adaptation support is off.
Apr 19 06:25:06 srv-squid-i2 squid[26758]: Accepting HTTP Socket connections at local=[::]:3128 remote=[::] FD 23 flags=9
Apr 19 06:25:06 srv-squid-i2 squid[26758]: Accepting NAT intercepted SSL bumped HTTPS Socket connections at local=[::]:3129 remote=[::] FD 24 flags=41
Apr 19 06:25:07 srv-squid-i2 squid[26758]: storeLateRelease: released 0 objects
Apr 19 06:36:14 srv-squid-i2 snapd[14282]: storehelpers.go:441: cannot refresh snap "core": snap has no updates available
Apr 19 06:36:14 srv-squid-i2 snapd[14282]: autorefresh.go:379: auto-refresh: all snaps are up-to-date
Apr 19 07:10:31 srv-squid-i2 squid[26758]: Logfile: opening log stdio:/var/spool/squid/netdb.state
Apr 19 07:10:31 srv-squid-i2 squid[26758]: Logfile: closing log stdio:/var/spool/squid/netdb.state
Apr 19 07:10:31 srv-squid-i2 squid[26758]: NETDB state saved; 1 entries, 0 msec
Apr 19 07:17:01 srv-squid-i2 CRON[27013]: (root) CMD (   cd / && run-parts --report /etc/cron.hourly)
Apr 19 08:05:05 srv-squid-i2 systemd[1]: Started ntp-systemd-netif.service.
Apr 19 08:17:01 srv-squid-i2 CRON[27257]: (root) CMD (   cd / && run-parts --report /etc/cron.hourly)


-----Message d'origine-----
De?: squid-users [mailto:squid-users-bounces at lists.squid-cache.org] De la part de squid-users-request at lists.squid-cache.org
Envoy??: vendredi 19 avril 2019 06:00
??: squid-users at lists.squid-cache.org
Objet?: squid-users Digest, Vol 56, Issue 32

Send squid-users mailing list submissions to
	squid-users at lists.squid-cache.org

To subscribe or unsubscribe via the World Wide Web, visit
	http://lists.squid-cache.org/listinfo/squid-users
or, via email, send a message with subject or body 'help' to
	squid-users-request at lists.squid-cache.org

You can reach the person managing the list at
	squid-users-owner at lists.squid-cache.org

When replying, please edit your Subject line so it is more specific than "Re: Contents of squid-users digest..."


Today's Topics:

   1. Re: squid-users Digest, Vol 56, Issue 12 (Wegner Micha?l)
   2. Re: Squid 3.5 https facebook caching (Eliezer Croitoru)
   3. Re: Squid 3.5 https facebook caching (Amos Jeffries)
   4. Re: squid-users Digest, Vol 56, Issue 12 (Amos Jeffries)


----------------------------------------------------------------------

Message: 1
Date: Thu, 18 Apr 2019 15:34:00 +0200
From: Wegner Micha?l <m.wegner at hopitaldugier.fr>
To: squid-users at lists.squid-cache.org
Subject: Re: [squid-users] squid-users Digest, Vol 56, Issue 12
Message-ID: <8984823b.1d4f5eb.6cc6cb3c.3b71 at hopitaldugier.fr>
Content-Type: text/plain; charset=utf-8

Hi,

The SSL is OK I always can't play some YouTube video.
Squid in version 4.6
In access.log : TCP_TUNNEL/200 2083 CONNECT www.youtube.com:443 - HIER_DIRECT/216.58.206.238 I think the problem comes from heading.

My squid.conf for test is :
visible_hostname squid

acl localnet src 10.0.0.0/8

acl SSL_ports port 443

acl Safe_ports port 80          # http
acl Safe_ports port 21          # ftp
acl Safe_ports port 443         # https
acl Safe_ports port 70          # gopher
acl Safe_ports port 210         # wais
acl Safe_ports port 1025-65535  # unregistered ports
acl Safe_ports port 280         # http-mgmt
acl Safe_ports port 488         # gss-http
acl Safe_ports port 591         # filemaker
acl Safe_ports port 777         # multiling http

acl CONNECT method CONNECT

http_access deny !Safe_ports
http_access deny CONNECT !SSL_ports
http_access allow localnet
http_access allow localhost
http_access deny all

http_port 3128
https_port 3129 intercept ssl-bump generate-host-certificates=on dynamic_cert_mem_cache_size=4MB cert=/opt/squid/etc/ssl_cert/myCA.pem

ssl_bump splice localhost
acl 9 at_step SslBump1
acl 10 at_step SslBump2
acl 11 at_step SslBump3
ssl_bump peek 9 all
ssl_bump bump 10 all
ssl_bump bump 11 all

coredump_dir /var/spool/squid


Kind regards,

-----Message d'origine-----
De?: Wegner Micha?l [mailto:m.wegner at hopitaldugier.fr]
Envoy??: mardi 9 avril 2019 11:18
??: squid-users at lists.squid-cache.org
Objet?: RE: squid-users Digest, Vol 56, Issue 12



-----Message d'origine-----
De?: Wegner Micha?l [mailto:m.wegner at hopitaldugier.fr]
Envoy??: lundi 8 avril 2019 11:15
??: squid-users at lists.squid-cache.org
Objet?: RE: squid-users Digest, Vol 56, Issue 12

Hi Antony,

The video is Ok, if i not used squid v3.5.
If on the squid.conf file I disabled rediretion on squidgaurd the problem is the same.
If squid is actived, somme videos are blocked, (the videos in restricted mode) With a old version of squid (2.6) there are no problems

Regards,

Hi,

I install a new serveur squid version 4.6 without squiguard and access allow all.
I set the ssl and i import certificate on the client but without success.

My squid.conf is : 

acl localnet src 0.0.0.1-0.255.255.255  # RFC 1122 "this" network (LAN)
acl localnet src 10.0.0.0/8             # RFC 1918 local private network (LAN)
acl localnet src 100.64.0.0/10          # RFC 6598 shared address space (CGN)
acl localnet src 169.254.0.0/16         # RFC 3927 link-local (directly plugged) machines
acl localnet src 172.16.0.0/12          # RFC 1918 local private network (LAN)
acl localnet src 192.168.0.0/16         # RFC 1918 local private network (LAN)
acl localnet src fc00::/7               # RFC 4193 local private network range
acl localnet src fe80::/10              # RFC 4291 link-local (directly plugged) machines

acl SSL_ports port 443
acl Safe_ports port 80          # http
acl Safe_ports port 21          # ftp
acl Safe_ports port 443         # https
acl Safe_ports port 70          # gopher
acl Safe_ports port 210         # wais
acl Safe_ports port 1025-65535  # unregistered ports
acl Safe_ports port 280         # http-mgmt
acl Safe_ports port 488         # gss-http
acl Safe_ports port 591         # filemaker
acl Safe_ports port 777         # multiling http
acl CONNECT method CONNECT

#
# Deny requests to certain unsafe ports
http_access deny !Safe_ports

# Deny CONNECT to other than secure SSL ports http_access deny CONNECT !SSL_ports

# Only allow cachemgr access from localhost http_access allow localhost manager http_access deny manager

#
# INSERT YOUR OWN RULE(S) HERE TO ALLOW ACCESS FROM YOUR CLIENTS # include /etc/squid/conf.d/*

#http_access allow localnet
http_access allow localhost

# And finally deny all other access to this proxy #http_access deny all http_access allow all


http_port 3128 ssl-bump cert=/opt/squid/etc/ssl_cert/myCA.pem generate-host-certificates=on dynamic_cert_mem_cache_size=4MB sslcrtd_program /usr/lib/squid/security_file_certgen -s /opt/squid/log/squid/ssl_db -M 4MB coredump_dir /opt/squid/var/cache/squid cache_dir ufs /opt/squid/var/cache/squid 1000 16 256 # 1GB as Cache


# Squid normally listens to port 3128

#http_port 3128

# Leave coredumps in the first cache dir coredump_dir /var/spool/squid



refresh_pattern ^ftp:           1440    20%     10080
refresh_pattern ^gopher:        1440    0%      1440
refresh_pattern -i (/cgi-bin/|\?) 0     0%      0
refresh_pattern .               0       20%     4320


regards

Micha?l


-----Message d'origine-----
De?: squid-users [mailto:squid-users-bounces at lists.squid-cache.org] De la part de squid-users-request at lists.squid-cache.org
Envoy??: samedi 6 avril 2019 14:00
??: squid-users at lists.squid-cache.org
Objet?: squid-users Digest, Vol 56, Issue 12

Send squid-users mailing list submissions to
	squid-users at lists.squid-cache.org

To subscribe or unsubscribe via the World Wide Web, visit
	http://lists.squid-cache.org/listinfo/squid-users
or, via email, send a message with subject or body 'help' to
	squid-users-request at lists.squid-cache.org

You can reach the person managing the list at
	squid-users-owner at lists.squid-cache.org

When replying, please edit your Subject line so it is more specific than "Re: Contents of squid-users digest..."


Today's Topics:

   1. youtube restriction. (Wegner Micha?l)
   2. Re: youtube restriction. (Vacheslav Zouhairy)
   3. Re: youtube restriction. (Antony Stone)


----------------------------------------------------------------------

Message: 1
Date: Fri, 05 Apr 2019 15:06:00 +0200
From: Wegner Micha?l <m.wegner at hopitaldugier.fr>
To: squid-users at lists.squid-cache.org
Subject: [squid-users] youtube restriction.
Message-ID: <527bfee2.1d4ebb0.29b980e7.db3 at hopitaldugier.fr>
Content-Type: text/plain; charset="iso-8859-1"

Hi,
 
I install squid + squidguard, and I can't play youtube video.
For example : https://m.youtube.com/watch?v=Hmj3LToi4W8 ; https://m.youtube.com/watch?v=jbBUQ-uvlRU
 
Error : video not available access to this video is limited
 
I have Ubuntu server 18.04 and squid v 3.5.27
 
Can' you help me please
 
Thanks,
 
Kind Regards
 
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20190405/0f1e17cf/attachment-0001.html>

------------------------------

Message: 2
Date: Fri, 05 Apr 2019 16:21:28 +0300
From: Vacheslav Zouhairy <m_zouhairy at skno.by>
To: squid-users at lists.squid-cache.org
Subject: Re: [squid-users] youtube restriction.
Message-ID: <edde432e1f0745413ed6d35d157a6abc025b7d3d.camel at skno.by>
Content-Type: text/plain; charset="utf-8"

time to try ufdbguard, it is very flexible and relatively easy to configure.
On Fri, 2019-04-05 at 15:06 +0200, Wegner Micha?l wrote:
> Hi,
>  
> I install squid + squidguard, and I can?t play youtube video.
> For example : https://m.youtube.com/watch?v=Hmj3LToi4W8 ; 
> https://m.youtube.com/watch?v=jbBUQ-uvlRU
>  
> Error : video not available
> access to this video is limited I have Ubuntu server 18.04 and squid v
> 3.5.27 Can? you help me please Thanks, Kind Regards 
> _______________________________________________squid-users mailing 
> listsquid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20190405/4c512724/attachment-0001.html>

------------------------------

Message: 3
Date: Fri, 5 Apr 2019 15:39:08 +0200
From: Antony Stone <Antony.Stone at squid.open.source.it>
To: squid-users at lists.squid-cache.org
Subject: Re: [squid-users] youtube restriction.
Message-ID: <201904051539.08777.Antony.Stone at squid.open.source.it>
Content-Type: Text/Plain;  charset="iso-8859-15"

On Friday 05 April 2019 at 15:06:00, Wegner Micha?l wrote:

> Hi,
> 
> I install squid + squidguard, and I can't play youtube video.
> For example : https://m.youtube.com/watch?v=Hmj3LToi4W8 ; 
> https://m.youtube.com/watch?v=jbBUQ-uvlRU
> 
> Error : video not available access to this video is limited

1. Does it work if you do not go via Squid and SquidGuard?

2. Can you play any other Youtube videos?

3. Given that this is an HTTPS connection, how are you restricting HTTPS content with SquidGuard?

> I have Ubuntu server 18.04 and squid v 3.5.27
> 
> Can' you help me please

Regards,


Antony.

--
"Measuring average network latency is about as useful as measuring the mean temperature of patients in a hospital."

 - St?phane Bortzmeyer

                                                   Please reply to the list;
                                                         please *don't* CC me.


------------------------------

Subject: Digest Footer

_______________________________________________
squid-users mailing list
squid-users at lists.squid-cache.org
http://lists.squid-cache.org/listinfo/squid-users


------------------------------

End of squid-users Digest, Vol 56, Issue 12
*******************************************



------------------------------

Message: 2
Date: Fri, 19 Apr 2019 00:17:32 +0300
From: Eliezer Croitoru <ngtech1ltd at gmail.com>
To: squid-users at lists.squid-cache.org
Subject: Re: [squid-users] Squid 3.5 https facebook caching
Message-ID: <6f81e912-2c71-b25e-818b-7c16df7298e7 at gmail.com>
Content-Type: text/plain; charset=utf-8; format=flowed

Just to add:

Facebook has these headers for many of their videos:

 1.
    Cache-Control:
    max-age=1209600, no-transform


So what happens is that the client browser will save these URLs for a 
very long time and it's good.

It takes of burden from the intermediate proxy.

I wrote some code that works for most of the facebook public videos at:

http://gogs.ngtech.co.il/NgTech-LTD/storeid-helpers/raw/master/facebook--video-2019.rb


Hope it helps.

Eliezer


On 4/18/2019 1:45 PM, Amos Jeffries wrote:
> On 18/04/19 12:03 pm, tester100 wrote:
>> Amos
>>
>> big thxs for all your input
>>
>> it just shows me that i know nothing about squid that i am complete newbie,
>> and that i need to spend my time reading all the manual and config examples.
>>
> I did not mean to imply a lot of reading was needed. Just some in
> relation to the items I mentioned as probably leading to your issue. The
> rest can be long-term goals to fix up.
>
> FYI: The Squid wiki <http://wiki.squid-cache.org/> and config manual
> <http://www.squid-cache.org/Doc/config/> (the v3.5 pages for your Squid
> version) are the most accurate information sources behind reading the
> code itself. But keep in mind that Squid-3 is also outdated nowdays,
> Squid-4 and later have changed some significant feature behaviours.
>
>
> Most of the things I pointed out were useful at some point (eg Squid-2),
> and may still be for some use-cases. But for which Squid behaviour has
> changed since how-tos and tutorials advising them were written.
>
>
>> big thanks i will have some guidance on reading and research for the next
>> couple of days now.
>>
> You are welcome. Any further questions or advice wanted please feel free
> to ask. Helping each other use Squid is a what this mailing list is
> about - for experts and newbies alike.
>
> Cheers
> Amos
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users
-- 

----

Eliezer Croitoru <http://ngtech.co.il/main-en/>
Linux System Administrator
Mobile: +972-5-28704261
Email: eliezer at ngtech.co.il <mailto:eliezer at ngtech.co.il>



------------------------------

Message: 3
Date: Fri, 19 Apr 2019 15:35:49 +1200
From: Amos Jeffries <squid3 at treenet.co.nz>
To: squid-users at lists.squid-cache.org
Subject: Re: [squid-users] Squid 3.5 https facebook caching
Message-ID: <67347320-3125-f3c4-d706-46820eea5718 at treenet.co.nz>
Content-Type: text/plain; charset=utf-8

On 19/04/19 9:17 am, Eliezer Croitoru wrote:
> Just to add:
> 
> Facebook has these headers for many of their videos:
> 
> 1.
> ?? Cache-Control:
> ?? max-age=1209600, no-transform
> 
> 
> So what happens is that the client browser will save these URLs for a
> very long time and it's good.


As will Squid unless the admin has configured refresh_pattern options
that force expiry earlier.

Amos


------------------------------

Message: 4
Date: Fri, 19 Apr 2019 15:59:23 +1200
From: Amos Jeffries <squid3 at treenet.co.nz>
To: squid-users at lists.squid-cache.org
Subject: Re: [squid-users] squid-users Digest, Vol 56, Issue 12
Message-ID: <a018e0cd-8dc7-02b2-d474-82a202472bfa at treenet.co.nz>
Content-Type: text/plain; charset=utf-8

> -----Message d'origine-----
...
>
> When replying, please edit your Subject line so it is more specific
than "Re: Contents of squid-users digest..."

When you are trying to message the list about issues please change your
subscription settings to deliver you the individual posts so you can
reply to threads instead of digests.


On 19/04/19 1:34 am, Wegner Micha?l wrote:
> Hi,
> 
> The SSL is OK I always can't play some YouTube video.
> Squid in version 4.6
> In access.log : TCP_TUNNEL/200 2083 CONNECT www.youtube.com:443 - HIER_DIRECT/216.58.206.238
> I think the problem comes from heading.
> 

What are you calling "heading"?


The (incomplete) access.log entry you show has;

 * an unknown client requesting a tunnel to www.youtube.com.

 * Squid is opening a tunnel to the server 216.58.206.238.

 * Squid is informing the client that it was 200/success. The tunnel can
be used.

 * 2083 bytes are sent to the client. Some of those were for the 200
response.

 * the tunnel is closed without any errors having occured.


This line means multiple different things depending on which port your
proxy received it on (if received) or whether Squid generated the
CONNECT pieces for SSL-Bump internal use.


> My squid.conf for test is :
> visible_hostname squid
> 
> acl localnet src 10.0.0.0/8
> 
> acl SSL_ports port 443
> 
> acl Safe_ports port 80          # http
> acl Safe_ports port 21          # ftp
> acl Safe_ports port 443         # https
> acl Safe_ports port 70          # gopher
> acl Safe_ports port 210         # wais
> acl Safe_ports port 1025-65535  # unregistered ports
> acl Safe_ports port 280         # http-mgmt
> acl Safe_ports port 488         # gss-http
> acl Safe_ports port 591         # filemaker
> acl Safe_ports port 777         # multiling http
> 
> acl CONNECT method CONNECT
> 
> http_access deny !Safe_ports
> http_access deny CONNECT !SSL_ports
> http_access allow localnet
> http_access allow localhost
> http_access deny all
> 
> http_port 3128

Traffic arriving on above port never has SSL-Bump applied to it. Tunnels
are always directly client<->origin with no Squid interaction to the
HTTPS portion.


> https_port 3129 intercept ssl-bump generate-host-certificates=on dynamic_cert_mem_cache_size=4MB cert=/opt/squid/etc/ssl_cert/myCA.pem
> 
> ssl_bump splice localhost

Traffic NAT intercepted from localhost is always spliced. The TLS and
wrapped HTTPS are always directly client<->origin with no Squid interaction.

> acl 9 at_step SslBump1
> acl 10 at_step SslBump2
> acl 11 at_step SslBump3
> ssl_bump peek 9 all
> ssl_bump bump 10 all

All traffic which is from non-localhost is always bumped at step-2 by
SSL-Bump.

Step-2 has zero details about the actual origin server TLS capabilities
or properties. Bumping at this step is what we call "client-first". It
has *many* problems and should be avoided unless absolutely necessary.


YouTube is a Google domain. Google are particularly strict about their
TLS usage and security. They do a lot of things to absolutely prohibit
things like client-first being possible at all.

Bump not being possible at all is the normal state for Google domains.
It is more surprising that you are reporting "works fine" for parts of
YT than the failure.

More details will be needed to see what is going on. Please start by
providing the whole of that access.log line and the other log entries
from your test transaction. If bumping is happening at all there *will*
be multiple log entries.


> ssl_bump bump 11 all
> 

Above should never happen because everything was already spliced at
step-1 or bumped at step-2.


Amos


------------------------------

Subject: Digest Footer

_______________________________________________
squid-users mailing list
squid-users at lists.squid-cache.org
http://lists.squid-cache.org/listinfo/squid-users


------------------------------

End of squid-users Digest, Vol 56, Issue 32
*******************************************



From squid3 at treenet.co.nz  Sat Apr 20 05:26:39 2019
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Sat, 20 Apr 2019 17:26:39 +1200
Subject: [squid-users] squid-users Digest, Vol 56, Issue 32
In-Reply-To: <b3fe8a78.1d4f679.706a7a38.46a8@hopitaldugier.fr>
References: <b3fe8a78.1d4f679.706a7a38.46a8@hopitaldugier.fr>
Message-ID: <a0b9d637-c0a0-665d-00b5-29f3e336bf7f@treenet.co.nz>

On 19/04/19 6:32 pm, Wegner Micha?l wrote:
> Hi,
> 
> Please find below access.log, cache.log and syslog.
> Do you want a other log
> 

These logs appear to show a lot of regular CONNECT tunnels being
requested by a client. If that is right (arriving in port 3128) then
Squid is not doing anything except opening these tunnels.

squidguard is not capable of handling CONNECT URLs properly. Any attempt
to use it on these CONNECT will break things.

Beyond the URL-rewrite problem, anything in the tunnel is an issue
directly between the client and origin. SSL-Bump is _not_ happening
here. Squid has no part in the HTTPS or other protocol the Browser is
using for the fetch.



What you need to do depends on what you are trying to achieve by using
the proxy. What is that exactly?


Amos


From guzzy at bol.com.br  Sat Apr 20 21:02:21 2019
From: guzzy at bol.com.br (Fabricio Ferreira)
Date: Sat, 20 Apr 2019 18:02:21 -0300
Subject: [squid-users] SQUID 4.6 - Kerberos Helper Error - FreeBSD
Message-ID: <002201d4f7bc$58f328b0$0ad97a10$@bol.com.br>

Hello Everyone,
Greetings.
Recently I had to upgrade my Squid to ver 4.6 - that?s when my problems
started.
I can't use the KERBEROS helper anymore.
I am trying to use exactly the same configurtion I was using for Squid
3.5.27(by the way, I am using Squid with SAMBA 4.10 ? 
>From the command prompt, everything works fine. Keytab was successfully
generated and it?s working.
Also, NTLM is working fine with SQUID 4.6. It?s just the KERBEROS who is
presenting errors)

Here my squid config (I always used this one with no issues)

#### NEGOTIATE KERBEROS AUTHENTICATION #### a
uth_param negotiate program /usr/local/libexec/squid/negotiate_kerberos_auth
-d -i -s mailto:HTTP/server25.kontroldeb.corp at KONTROLDEB.CORP 
auth_param negotiate children 10 startup=5 idle=2
auth_param negotiate keep_alive on

 #### STARTING CUSTOM ACLs #### 
acl auth proxy_auth REQUIRED 

#### STARTING CUSTOM AUTHORIZATION ACL ### 
http_access allow auth

***********************************************
Here the error messages (logs)
*****************************************
2019/04/20 17:59:52 kid1| Starting Squid Cache version 4.6 for
amd64-portbld-freebsd12.0...
2019/04/20 17:59:52 kid1| Service Name: squid
negotiate_kerberos_auth.cc(489): pid=93354 :2019/04/20 17:59:52|
negotiate_kerberos_auth: INFO: Starting version 3.1.0sq
negotiate_kerberos_auth.cc(489): pid=93688 :2019/04/20 17:59:52|
negotiate_kerberos_auth: INFO: Starting version 3.1.0sq
negotiate_kerberos_auth.cc(548): pid=93688 :negotiate_kerberos_auth.cc(489):
pid=93875 :negotiate_kerberos_auth.cc(548): pid=93354 :2019/04/20 17:59:52|
negotiate_kerberos_auth: INFO: Setting keytab to /etc/krb5.keytab
negotiate_kerberos_auth.cc(489): pid=94044 :2019/04/20 17:59:52|
negotiate_kerberos_auth: INFO: Starting version 3.1.0sq
2019/04/20 17:59:52| negotiate_kerberos_auth: INFO: Setting keytab to
/etc/krb5.keytab
negotiate_kerberos_auth.cc(572): pid=93688 :negotiate_kerberos_auth.cc(548):
pid=93875 :negotiate_kerberos_auth.cc(572): pid=93354 :2019/04/20 17:59:52|
negotiate_kerberos_auth: INFO: Changed keytab to
MEMORY:negotiate_kerberos_auth_93688
2019/04/20 17:59:52| negotiate_kerberos_auth: INFO: Setting keytab to
/etc/krb5.keytab
2019/04/20 17:59:52| negotiate_kerberos_auth: INFO: Changed keytab to
MEMORY:negotiate_kerberos_auth_93354
negotiate_kerberos_auth.cc(572): pid=93875 :2019/04/20 17:59:52|
negotiate_kerberos_auth: INFO: Changed keytab to
MEMORY:negotiate_kerberos_auth_93875
2019/04/20 17:59:52| negotiate_kerberos_auth: INFO: Starting version 3.1.0sq
negotiate_kerberos_auth.cc(548): pid=94044 :2019/04/20 17:59:52|
negotiate_kerberos_auth: INFO: Setting keytab to /etc/krb5.keytab
negotiate_kerberos_auth.cc(572): pid=94044 :2019/04/20 17:59:52|
negotiate_kerberos_auth: INFO: Changed keytab to
MEMORY:negotiate_kerberos_auth_94044
negotiate_kerberos_auth.cc(489): pid=94248 :2019/04/20 17:59:52|
negotiate_kerberos_auth: INFO: Starting version 3.1.0sq
negotiate_kerberos_auth.cc(548): pid=94248 :2019/04/20 17:59:52|
negotiate_kerberos_auth: INFO: Setting keytab to /etc/krb5.keytab
negotiate_kerberos_auth.cc(572): pid=94248 :2019/04/20 17:59:52|
negotiate_kerberos_auth: INFO: Changed keytab to
MEMORY:negotiate_kerberos_auth_94248
2019/04/20 17:59:53| pinger: Initialising ICMP pinger ...
negotiate_kerberos_auth.cc(612): pid=93354 :2019/04/20 18:00:01|
negotiate_kerberos_auth: DEBUG: Got 'YR
YIIHhAYGKwYBBQUCoIIHeDCCB3SgMDAuBgkqhkiC9xIBAgIGCSqGSIb3EgECAgYKKwYBBAGCNwIC
HgYKKwYBBAGCNwICCqKCBz4Eggc6YIIHNgYJKoZIhvcSAQICAQBuggclMIIHIaADAgEFoQMCAQ6i
BwMFACAAAACjggU2YYIFMjCCBS6gAwIBBaERGw9LT05UUk9MREVCLkNPUlCiLzAtoAMCAQKhJjAk
GwRIVFRQGxxrb250cm9sMjVkZXYua29udHJvbGRlYi5jb3Jwo4IE4TCCBN2gAwIBEqEDAgECooIE
zwSCBMsEgu4Ba4hHYkQrneobn+MXZqZcJCLwMO2Gx4l7wq4OGeDstei8C8jxhfeuwryCLsG+bU31
OZq/EoHKRRJK/tVhpSPnrPeUclcyBLXiXqH8gCnucNae0oiXasEayFjsKzpqmf/Tl/KuU+dYKVid
pt6NMQ+3v3hP9T6hiJt95UFODTuIMT62Yrum52ztXs2u0JwnCX/cV6gVuj6gT3jrVD84EptCLKAn
Brd+m11FV8xq8aI9A0TZD4G1Bq6Nn4WS2VoIqUptxN1jmPWR2hiy1xB12Yh5N/wn+txVgoyZ+AqO
R4ENS6kJVxeI6ZqVcqp0HGojX01V1Jq695VOzNw85nUkduczbTcdBx/xAP0M17X2EO5G7hDDsx+B
J3mqRIok75CmzDLDF8jC7v3ZLwNvAlJRFS0RoFQiwB/hdN60t1pqetQTkGqlbF4GeXF/9HW8pW/Y
iXvkAaQuepBkm/uOKSwF1KMpSGdoxGPBSL+VpwQ509whV1/HS/JQOB+Zbt/TbXuBgvdpCeK/AFfH
d/BGtejN/k4BoHYAyEt1ApHpL1sEGNEBiK3LSsdHogxVRpQDrqv+jUMzph42HdJyLe52rfM8t7gi
6AlX/Ti5ss2/dBYZ10YTfixCekFxp/Rv9HPZYF4iWPz/L2DkZjBAjgwH8b8ZBUw581VjLkOs38VF
HU33wnoUY/jyyZAf52e+1uSoMuEhoMElMttR9g0s0jXBlfSEZ9N4sMiB/PF8+xefQieSQXCs37da
hHewXmHctqoCF/+FTgmOK7zCqV9rAOSvq3fkAnaCMxVeiKpYLx4kf3XZlyhT8+l9k9Clz5V2VoTd
HWU1AJf99t8NEtertk1x7qO5eBFGugaWARykmLzLx18bwsOf1YomL1dpOhfq2DllTRRpZMV2m716
oqne8iBDXpYm+wKuDV21j3t6MYF/iF7kkZU+ZXj35FVrPcPFoKOHHWsubCeGSJm5MXr4TrX+8siI
p9LeLNAFVr3mcLhnb+5CxmpRo6+LUfg4bkhk9vGzytB9PxHPxrmCBegj0R8NXQn+b4GJekAZDsR3
FAgMawQwNcPc159RHGOkS8r6y4rZ2WU5F2VPuKUtpsUhbSmybD4J7CGZ2NgGXmuD67affV7X8i7T
ygb4qhmxbzjLnUeGvK1lcCD4tVgMPOpskhYK7bHc0MstWqdQZjJSidn33j9xn9IPBGcD2U9hMeST
oGMxBP9h5vuEpRJuFOqbQOtoH+AKsl7lyhSqjil2t7bTS1Ao1+WcYst2tGvgFd8RpUILsQ9Swnei
//otQcnKw7PnMRtt6F0fXtMyjeFB8887HhmCfcnOMcA10xZ5ytrdgdWYmxFPaOAZhZpnbAocLd/s
xN2Kp2D1yGuvc6ioMOPRa8CzuBjbCy64VUbnC4Jhuf0SDcjvlJY2/EnqOjKSpFSP+GJyCtOgTBfA
WZI9K7cKSJ+zV12rhiqxeoHKj7nhLW4VxQ7jcP/pXPMXXSHSaFdGyie24UvuzjQSP28Rm4uH0Hkv
01psSVyX1t3X4zlq3FHzQMUMxHAeXobd0JCIxozZ8zKfyOjf/uNZjvrldcHujFfxvRUrI67q5VX/
qKnkxjtUdGvjmhZvi1bLheHVDiD5gAHQwcRICN3oeP2Dpu2kggHQMIIBzKADAgESooIBwwSCAb9o
aIF8EJ5Cq/22K8eKhEu/lhtFToakRCPvYYPhpInyylc3mFvS1d+HS915J1GJ43aWdNS/Acmc+clN
8eooEpB5Yz2LpOj2op121UuA9OMuMsrxeymchWyr+McY+NDgRyBbgAL5jJce6vYG48aGYkzT8Jq1
eo16uZSIAVztyB/B09w3wVUHlRIUkNLKQoZWmA/mmN5OZrVX0KN6pYaz7zxEKUtheNpJ/sAiHvHO
MWiOUwhlxAFH++1EcuMvfzj+MMGOuCpwhfU+vBTFaiiVcVcFl31FnkW3jwh6BflpFnryLXJOFUc4
2k03T1g7fArpdGX7h8sMharVxRPKg9H5j3+e+Sm3aBC/p2Xwl414mh/fsuUsjsxKYAheC9pGmsFi
5yk3tZ3+NUQfPJcLyIH/vISG4lFrBJtz690o2x/PuhgOrefmXV+vnFJ1OD06kV955ayFr0GxWz+A
rtSVKqmBi8jt8/+1ZmFrfW5JzslV9Evqb5on6OtxgokvRPFl2r+fm37g8PmvIA1L8cX3moP6UTPr
S2mBPxLlwubPUlstuk4RyvOQx4jtU0ToGDH8DZRZA78JaseKphULfJqVWWDJhK8=' from squid
(length: 2575).
negotiate_kerberos_auth.cc(679): pid=93354 :2019/04/20 18:00:01|
negotiate_kerberos_auth: DEBUG: Decode
'YIIHhAYGKwYBBQUCoIIHeDCCB3SgMDAuBgkqhkiC9xIBAgIGCSqGSIb3EgECAgYKKwYBBAGCNwI
CHgYKKwYBBAGCNwICCqKCBz4Eggc6YIIHNgYJKoZIhvcSAQICAQBuggclMIIHIaADAgEFoQMCAQ6
iBwMFACAAAACjggU2YYIFMjCCBS6gAwIBBaERGw9LT05UUk9MREVCLkNPUlCiLzAtoAMCAQKhJjA
kGwRIVFRQGxxrb250cm9sMjVkZXYua29udHJvbGRlYi5jb3Jwo4IE4TCCBN2gAwIBEqEDAgECooI
EzwSCBMsEgu4Ba4hHYkQrneobn+MXZqZcJCLwMO2Gx4l7wq4OGeDstei8C8jxhfeuwryCLsG+bU3
1OZq/EoHKRRJK/tVhpSPnrPeUclcyBLXiXqH8gCnucNae0oiXasEayFjsKzpqmf/Tl/KuU+dYKVi
dpt6NMQ+3v3hP9T6hiJt95UFODTuIMT62Yrum52ztXs2u0JwnCX/cV6gVuj6gT3jrVD84EptCLKA
nBrd+m11FV8xq8aI9A0TZD4G1Bq6Nn4WS2VoIqUptxN1jmPWR2hiy1xB12Yh5N/wn+txVgoyZ+Aq
OR4ENS6kJVxeI6ZqVcqp0HGojX01V1Jq695VOzNw85nUkduczbTcdBx/xAP0M17X2EO5G7hDDsx+
BJ3mqRIok75CmzDLDF8jC7v3ZLwNvAlJRFS0RoFQiwB/hdN60t1pqetQTkGqlbF4GeXF/9HW8pW/
YiXvkAaQuepBkm/uOKSwF1KMpSGdoxGPBSL+VpwQ509whV1/HS/JQOB+Zbt/TbXuBgvdpCeK/AFf
Hd/BGtejN/k4BoHYAyEt1ApHpL1sEGNEBiK3LSsdHogxVRpQDrqv+jUMzph42HdJyLe52rfM8t7g
i6AlX/Ti5ss2/dBYZ10YTfixCekFxp/Rv9HPZYF4iWPz/L2DkZjBAjgwH8b8ZBUw581VjLkOs38V
FHU33wnoUY/jyyZAf52e+1uSoMuEhoMElMttR9g0s0jXBlfSEZ9N4sMiB/PF8+xefQieSQXCs37d
ahHewXmHctqoCF/+FTgmOK7zCqV9rAOSvq3fkAnaCMxVeiKpYLx4kf3XZlyhT8+l9k9Clz5V2VoT
dHWU1AJf99t8NEtertk1x7qO5eBFGugaWARykmLzLx18bwsOf1YomL1dpOhfq2DllTRRpZMV2m71
6oqne8iBDXpYm+wKuDV21j3t6MYF/iF7kkZU+ZXj35FVrPcPFoKOHHWsubCeGSJm5MXr4TrX+8si
Ip9LeLNAFVr3mcLhnb+5CxmpRo6+LUfg4bkhk9vGzytB9PxHPxrmCBegj0R8NXQn+b4GJekAZDsR
3FAgMawQwNcPc159RHGOkS8r6y4rZ2WU5F2VPuKUtpsUhbSmybD4J7CGZ2NgGXmuD67affV7X8i7
Tygb4qhmxbzjLnUeGvK1lcCD4tVgMPOpskhYK7bHc0MstWqdQZjJSidn33j9xn9IPBGcD2U9hMeS
ToGMxBP9h5vuEpRJuFOqbQOtoH+AKsl7lyhSqjil2t7bTS1Ao1+WcYst2tGvgFd8RpUILsQ9Swne
i//otQcnKw7PnMRtt6F0fXtMyjeFB8887HhmCfcnOMcA10xZ5ytrdgdWYmxFPaOAZhZpnbAocLd/
sxN2Kp2D1yGuvc6ioMOPRa8CzuBjbCy64VUbnC4Jhuf0SDcjvlJY2/EnqOjKSpFSP+GJyCtOgTBf
AWZI9K7cKSJ+zV12rhiqxeoHKj7nhLW4VxQ7jcP/pXPMXXSHSaFdGyie24UvuzjQSP28Rm4uH0Hk
v01psSVyX1t3X4zlq3FHzQMUMxHAeXobd0JCIxozZ8zKfyOjf/uNZjvrldcHujFfxvRUrI67q5VX
/qKnkxjtUdGvjmhZvi1bLheHVDiD5gAHQwcRICN3oeP2Dpu2kggHQMIIBzKADAgESooIBwwSCAb9
oaIF8EJ5Cq/22K8eKhEu/lhtFToakRCPvYYPhpInyylc3mFvS1d+HS915J1GJ43aWdNS/Acmc+cl
N8eooEpB5Yz2LpOj2op121UuA9OMuMsrxeymchWyr+McY+NDgRyBbgAL5jJce6vYG48aGYkzT8Jq
1eo16uZSIAVztyB/B09w3wVUHlRIUkNLKQoZWmA/mmN5OZrVX0KN6pYaz7zxEKUtheNpJ/sAiHvH
OMWiOUwhlxAFH++1EcuMvfzj+MMGOuCpwhfU+vBTFaiiVcVcFl31FnkW3jwh6BflpFnryLXJOFUc
42k03T1g7fArpdGX7h8sMharVxRPKg9H5j3+e+Sm3aBC/p2Xwl414mh/fsuUsjsxKYAheC9pGmsF
i5yk3tZ3+NUQfPJcLyIH/vISG4lFrBJtz690o2x/PuhgOrefmXV+vnFJ1OD06kV955ayFr0GxWz+
ArtSVKqmBi8jt8/+1ZmFrfW5JzslV9Evqb5on6OtxgokvRPFl2r+fm37g8PmvIA1L8cX3moP6UTP
rS2mBPxLlwubPUlstuk4RyvOQx4jtU0ToGDH8DZRZA78JaseKphULfJqVWWDJhK8=' (decoded
length estimate: 1929).
2019/04/20 18:00:01 kid1| WARNING: negotiateauthenticator #Hlpr1 exited
2019/04/20 18:00:01 kid1| FATAL: The negotiateauthenticator helpers are
crashing too rapidly, need help!

2019/04/20 18:00:01 kid1| Squid Cache (Version 4.6): Terminated abnormally.
CPU Usage: 0.066 seconds = 0.049 user + 0.016 sys
Maximum Resident Size: 105984 KB
Page faults with physical i/o: 0

##########################################

Anyone else having the same issue after upgrade to SQUID 4.6? (FreeBSD)

Any help is very welcome!
Thanks Much!
Fabricio.





From squid3 at treenet.co.nz  Sun Apr 21 06:45:46 2019
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Sun, 21 Apr 2019 18:45:46 +1200
Subject: [squid-users] SQUID 4.6 - Kerberos Helper Error - FreeBSD
In-Reply-To: <002201d4f7bc$58f328b0$0ad97a10$@bol.com.br>
References: <002201d4f7bc$58f328b0$0ad97a10$@bol.com.br>
Message-ID: <abb3985a-3aae-5f89-ee95-0d59dc478386@treenet.co.nz>

On 21/04/19 9:02 am, Fabricio Ferreira wrote:
> Hello Everyone,
> Greetings.
> Recently I had to upgrade my Squid to ver 4.6 - that?s when my problems
> started.
> I can't use the KERBEROS helper anymore.
> I am trying to use exactly the same configurtion I was using for Squid
> 3.5.27(by the way, I am using Squid with SAMBA 4.10 ? 
> From the command prompt, everything works fine. Keytab was successfully
> generated and it?s working.

Was that run as the same low-privilege user account Squid runs it?

One thing you can do is use the exact same options (including -d) that
Squid uses and see of there is any noticable difference in the stderr
log output it produces vs the cache.log entries you provided below.

If nothing shows up there, try copy-paste'ing the same "YR ..." line
(single line of input) that Squid sends ans see if anything shows up then.


The helpers each start by opening /etc/krb5.keytab then immediately
switch to separate memory-only keytabs. That may be something going
wrong with the /etc/krb5.keytab file access.


Amos


From guzzy at bol.com.br  Sun Apr 21 20:21:34 2019
From: guzzy at bol.com.br (Fabricio Ferreira)
Date: Sun, 21 Apr 2019 17:21:34 -0300
Subject: [squid-users] SQUID 4.6 - Kerberos Helper Error - FreeBSD
In-Reply-To: <abb3985a-3aae-5f89-ee95-0d59dc478386@treenet.co.nz>
References: <002201d4f7bc$58f328b0$0ad97a10$@bol.com.br>
 <abb3985a-3aae-5f89-ee95-0d59dc478386@treenet.co.nz>
Message-ID: <001801d4f87f$d33e0860$79ba1920$@bol.com.br>

Hello Amos,
Thanks Much for your help on this.

I have re-checked all permissions and ownership of the keytab file. Everything looks fine. Same settings I have used before on squid 3.5.x  (0440 - root:proxy  /etc/krb5.keytab)
Yes, keytab has the "proxy" group set - squid user is part of it.  

Looking at the stderr log, this is all I see:
##########################################
pid 85392 (negotiate_kerberos_), uid 100: exited on signal 11
pid 85451 (negotiate_kerberos_), uid 100: exited on signal 11
pid 85555 (negotiate_kerberos_), uid 100: exited on signal 11
pid 85710 (negotiate_kerberos_), uid 100: exited on signal 11
pid 85924 (negotiate_kerberos_), uid 100: exited on signal 11
pid 18353 (negotiate_kerberos_), uid 100: exited on signal 11
pid 18452 (negotiate_kerberos_), uid 100: exited on signal 11
pid 18783 (negotiate_kerberos_), uid 100: exited on signal 11
pid 19021 (negotiate_kerberos_), uid 100: exited on signal 11
pid 19294 (negotiate_kerberos_), uid 100: exited on signal 11
pid 19307 (negotiate_kerberos_), uid 100: exited on signal 11
pid 19532 (negotiate_kerberos_), uid 100: exited on signal 11
pid 19591 (negotiate_kerberos_), uid 100: exited on signal 11
...
#####################################################
Not much uh?  I don't see anybody using Kerberos with squid 4.6 on FreeBSD 12 yet, so, I think I am alone for a while.
Does it worth to report it to the FreeBSD port (squid) maintainer?

Thanks once again!
Fabricio.

-----Original Message-----
From: squid-users <squid-users-bounces at lists.squid-cache.org> On Behalf Of Amos Jeffries
Sent: Sunday, April 21, 2019 3:46 AM
To: squid-users at lists.squid-cache.org
Subject: Re: [squid-users] SQUID 4.6 - Kerberos Helper Error - FreeBSD

On 21/04/19 9:02 am, Fabricio Ferreira wrote:
> Hello Everyone,
> Greetings.
> Recently I had to upgrade my Squid to ver 4.6 - that?s when my 
> problems started.
> I can't use the KERBEROS helper anymore.
> I am trying to use exactly the same configurtion I was using for Squid 
> 3.5.27(by the way, I am using Squid with SAMBA 4.10 ? From the command 
> prompt, everything works fine. Keytab was successfully generated and 
> it?s working.

Was that run as the same low-privilege user account Squid runs it?

One thing you can do is use the exact same options (including -d) that Squid uses and see of there is any noticable difference in the stderr log output it produces vs the cache.log entries you provided below.

If nothing shows up there, try copy-paste'ing the same "YR ..." line (single line of input) that Squid sends ans see if anything shows up then.


The helpers each start by opening /etc/krb5.keytab then immediately switch to separate memory-only keytabs. That may be something going wrong with the /etc/krb5.keytab file access.


Amos
_______________________________________________
squid-users mailing list
squid-users at lists.squid-cache.org
http://lists.squid-cache.org/listinfo/squid-users



From squid3 at treenet.co.nz  Mon Apr 22 03:48:37 2019
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Mon, 22 Apr 2019 15:48:37 +1200
Subject: [squid-users] SQUID 4.6 - Kerberos Helper Error - FreeBSD
In-Reply-To: <001801d4f87f$d33e0860$79ba1920$@bol.com.br>
References: <002201d4f7bc$58f328b0$0ad97a10$@bol.com.br>
 <abb3985a-3aae-5f89-ee95-0d59dc478386@treenet.co.nz>
 <001801d4f87f$d33e0860$79ba1920$@bol.com.br>
Message-ID: <af617b62-38ba-5dab-12b4-383632a65553@treenet.co.nz>

On 22/04/19 8:21 am, Fabricio Ferreira wrote:
> Hello Amos,
> Thanks Much for your help on this.
> 
> I have re-checked all permissions and ownership of the keytab file. Everything looks fine. Same settings I have used before on squid 3.5.x  (0440 - root:proxy  /etc/krb5.keytab)
> Yes, keytab has the "proxy" group set - squid user is part of it.  
> 
> Looking at the stderr log, this is all I see:
> ##########################################
> pid 85392 (negotiate_kerberos_), uid 100: exited on signal 11
> pid 85451 (negotiate_kerberos_), uid 100: exited on signal 11
> pid 85555 (negotiate_kerberos_), uid 100: exited on signal 11
> pid 85710 (negotiate_kerberos_), uid 100: exited on signal 11
> pid 85924 (negotiate_kerberos_), uid 100: exited on signal 11
> pid 18353 (negotiate_kerberos_), uid 100: exited on signal 11
> pid 18452 (negotiate_kerberos_), uid 100: exited on signal 11
> pid 18783 (negotiate_kerberos_), uid 100: exited on signal 11
> pid 19021 (negotiate_kerberos_), uid 100: exited on signal 11
> pid 19294 (negotiate_kerberos_), uid 100: exited on signal 11
> pid 19307 (negotiate_kerberos_), uid 100: exited on signal 11
> pid 19532 (negotiate_kerberos_), uid 100: exited on signal 11
> pid 19591 (negotiate_kerberos_), uid 100: exited on signal 11
> ...
> #####################################################
> Not much uh? 

Progress at least. This signal 11 is a segmentation fault.

Next thing to do is get a backtrace (with symbol names) from that crash.
How to do that is described at
<https://wiki.squid-cache.org/SquidFaq/BugReporting#crashes_and_core_dumps>.
Just use gdb on the helper, not Squid binary.


> I don't see anybody using Kerberos with squid 4.6 on FreeBSD 12 yet, so, I think I am alone for a while.
> Does it worth to report it to the FreeBSD port (squid) maintainer?

Eventually. They will also need the backtrace from the helper to see
what is going wrong.


Do you have multiple Kerberos libraries installed on your machine?
 I know there is a build bug which affects Squid-4 using Kerberos
libraries in custom locations. The fix for that will be in v4.7.

Amos


From dasknkt+squid at gmail.com  Fri Apr 26 00:00:18 2019
From: dasknkt+squid at gmail.com (interwebbot)
Date: Thu, 25 Apr 2019 19:00:18 -0500 (CDT)
Subject: [squid-users] Sibling cache_peer inside docker containers
Message-ID: <1556236818002-0.post@n4.nabble.com>

I have 2 squid instances running inside docker containers on the same host. I
am trying to set these two instances as cache_peer siblings for storage
optimization. Here is the config I am using:



http_port 3128

acl localnet src 10.0.0.0/8     # RFC1918 possible internal network
acl localnet src 172.16.0.0/12  # RFC1918 possible internal network
acl localnet src 192.168.0.0/16 # RFC1918 possible internal network
acl localnet src fc00::/7       # RFC 4193 local private network range
acl localnet src fe80::/10      # RFC 4291 link-local (directly plugged)
machines
acl squid-(1/2)  src 172.17.0.(2/3)
acl SSL_ports port 443

acl Safe_ports port 80          # http
acl Safe_ports port 21          # ftp
acl Safe_ports port 443         # https
acl Safe_ports port 70          # gopher
acl Safe_ports port 210         # wais
acl Safe_ports port 280         # http-mgmt
acl Safe_ports port 488         # gss-http
acl Safe_ports port 591         # filemaker
acl Safe_ports port 777         # multiling http
acl Safe_ports port 1025-65535  # unregistered ports

acl CONNECT method CONNECT

http_access deny !Safe_ports
http_access deny CONNECT !SSL_ports
http_access allow localhost manager
http_access deny manager

#
# INSERT YOUR OWN RULE(S) HERE TO ALLOW ACCESS FROM YOUR CLIENTS
#

http_access allow localnet
http_access allow localhost
http_access allow squid-2
http_access deny all

coredump_dir /squid/var/cache/squid

icp_port 3130
cache_peer 172.17.0.(2/3) sibling 3128 3130 default #proxy-only
prefer_direct off
icp_access allow all
icp_query_timeout 500
debug_options ALL,1 12,5 42,3

refresh_pattern ^ftp:           1440    20%     10080
refresh_pattern ^gopher:        1440    0%      1440
refresh_pattern -i (/cgi-bin/|\?) 0     0%      0
refresh_pattern .               0       20%     4320

cache_store_log /var/log/squid/store.log


To test if this is working, I am trying the following test:
 > curl -x http://127.0.0.1:3131 -L http://example.com (this results in a
MISS from squid-1 as expected)
 > curl -x http://127.0.0.1:3131 -L http://example.com (this results in a
HIT from squid-1 as expected)

 > curl -x http://127.0.0.1:3132 -L http://example.com (this results in a
MISS from squid-2. NOT EXPECTED)

Am I correct in assuming that last curl should result in a HIT instead of
MISS? If yes, what is wrong with my config?

Thanks in advance



--
Sent from: http://squid-web-proxy-cache.1019090.n4.nabble.com/Squid-Users-f1019091.html


From squid3 at treenet.co.nz  Fri Apr 26 12:39:18 2019
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Sat, 27 Apr 2019 00:39:18 +1200
Subject: [squid-users] Sibling cache_peer inside docker containers
In-Reply-To: <1556236818002-0.post@n4.nabble.com>
References: <1556236818002-0.post@n4.nabble.com>
Message-ID: <d34cb012-cc9c-8368-6c3f-4c46fc6bc4cd@treenet.co.nz>

On 26/04/19 12:00 pm, interwebbot wrote:
> I have 2 squid instances running inside docker containers on the same host. I
> am trying to set these two instances as cache_peer siblings for storage
> optimization. Here is the config I am using:
> 
> 
> 
> http_port 3128
> 
> acl localnet src 10.0.0.0/8     # RFC1918 possible internal network
> acl localnet src 172.16.0.0/12  # RFC1918 possible internal network
> acl localnet src 192.168.0.0/16 # RFC1918 possible internal network
> acl localnet src fc00::/7       # RFC 4193 local private network range
> acl localnet src fe80::/10      # RFC 4291 link-local (directly plugged)
> machines
> acl squid-(1/2)  src 172.17.0.(2/3)


Is this above what you actually have in the config file?
 or a (x/y) syntax you made up to represent each of the config files
having similar but not identical entries:

 acl squid-1  src 172.17.0.2
 acl squid-2  src 172.17.0.3

There are places where you should have different values but do not use
this syntax. So it is not clear if those were mistakes in the config or
mistakes in the email. Please show exactly what is in each config file
respective to these lines and the cache_peer lines.


Notice that these 172.17.0.* are matched by the localnet 172.16.0.0/12
CIR range. That means the "allow localnet" rule will be allowing traffic
and your "allow squid-2" rule is never reached.

...
> #
> # INSERT YOUR OWN RULE(S) HERE TO ALLOW ACCESS FROM YOUR CLIENTS
> #
> 
> http_access allow localnet
> http_access allow localhost
> http_access allow squid-2
> http_access deny all
> 
> coredump_dir /squid/var/cache/squid
> 
> icp_port 3130
> cache_peer 172.17.0.(2/3) sibling 3128 3130 default #proxy-only

"default" is only relevant when there are multiple peers to choose from
and the first is not the preferred default, or a second selection
algorithms is being used.


> prefer_direct off
> icp_access allow all
> icp_query_timeout 500
> debug_options ALL,1 12,5 42,3
> 
> refresh_pattern ^ftp:           1440    20%     10080
> refresh_pattern ^gopher:        1440    0%      1440
> refresh_pattern -i (/cgi-bin/|\?) 0     0%      0
> refresh_pattern .               0       20%     4320
> 
> cache_store_log /var/log/squid/store.log
> 
> 
> To test if this is working, I am trying the following test:
>  > curl -x http://127.0.0.1:3131 -L http://example.com (this results in a
> MISS from squid-1 as expected)
>  > curl -x http://127.0.0.1:3131 -L http://example.com (this results in a
> HIT from squid-1 as expected)
> 
>  > curl -x http://127.0.0.1:3132 -L http://example.com (this results in a
> MISS from squid-2. NOT EXPECTED)
> 


The Squid.conf you presented does not contain any http_port 3131 or
3132. How is the traffic getting from these to the 3128 Squid is opening?
 Also are both logging that their 3128 listening attempt was successful?


The details you are presenting are not clear and definitive about what
is going on.


> Am I correct in assuming that last curl should result in a HIT instead of
> MISS? 

Unknown. Which proxy is receiving the traffic from curl?

Which peer is receiving the 3130 UDP traffic?
 Is that a different port on each peer which you forgot to mention?

Is the "proxy-only" flag disabled in both configs?
 Best erase it entirely than rely on the "#" handling. The # behaviour
is not consistent with all directives.


Please be aware that both caches start off is a "cold" state with no
content including knowledge about other caches/peer contents or RTT
network properties. The first request(s) through them trigger a probe to
get better info and log as MISS - but waiting for that probe to produce
data can mean DIRECT connection is more efficient for that request.

The *second* request through is what should be expected to choose
best-path with details to optimize the choice of "best". In this case
the local cache produces a HIT - which is better than any network path
and can hide the RTT sibling lookup behaviours.


(Details like these are why its often best to show both configs, even if
they have a lot of overlap).


> If yes, what is wrong with my config?
> 

Any answer would have to be based more on assumptions about what you
mean than the details provided so far.

Amos


From dasknkt+squid at gmail.com  Mon Apr 29 17:51:21 2019
From: dasknkt+squid at gmail.com (interwebbot)
Date: Mon, 29 Apr 2019 12:51:21 -0500 (CDT)
Subject: [squid-users] Sibling cache_peer inside docker containers
In-Reply-To: <d34cb012-cc9c-8368-6c3f-4c46fc6bc4cd@treenet.co.nz>
References: <1556236818002-0.post@n4.nabble.com>
 <d34cb012-cc9c-8368-6c3f-4c46fc6bc4cd@treenet.co.nz>
Message-ID: <1556560281663-0.post@n4.nabble.com>

Hi Amos,

I have updated the config files with the changes you suggested.

*cat /var/spool/squid-1.conf*
http_port 3128

acl localnet src 10.0.0.0/8     # RFC1918 possible internal network
acl localnet src 172.16.0.0/12  # RFC1918 possible internal network
acl localnet src 192.168.0.0/16 # RFC1918 possible internal network
acl localnet src fc00::/7       # RFC 4193 local private network range
acl localnet src fe80::/10      # RFC 4291 link-local (directly plugged)
machines
acl SSL_ports port 443

acl Safe_ports port 80          # http
acl Safe_ports port 21          # ftp
acl Safe_ports port 443         # https
acl Safe_ports port 70          # gopher
acl Safe_ports port 210         # wais
acl Safe_ports port 280         # http-mgmt
acl Safe_ports port 488         # gss-http
acl Safe_ports port 591         # filemaker
acl Safe_ports port 777         # multiling http
acl Safe_ports port 1025-65535  # unregistered ports

acl CONNECT method CONNECT

http_access deny !Safe_ports
http_access deny CONNECT !SSL_ports
http_access allow localhost manager
http_access deny manager

#
# INSERT YOUR OWN RULE(S) HERE TO ALLOW ACCESS FROM YOUR CLIENTS
#

http_access allow localnet
http_access allow localhost
http_access deny all

coredump_dir /squid/var/cache/squid

icp_port 3130
cache_peer 172.17.0.3 sibling 3128 3130
prefer_direct off
icp_access allow all
icp_query_timeout 500
debug_options ALL,1 12,5 42,3

refresh_pattern ^ftp:           1440    20%     10080
refresh_pattern ^gopher:        1440    0%      1440
refresh_pattern -i (/cgi-bin/|\?) 0     0%      0
refresh_pattern .               0       20%     4320

cache_store_log /var/log/squid/store.log


*cat /var/spool/squid-2.conf*
http_port 3128

acl localnet src 10.0.0.0/8     # RFC1918 possible internal network
acl localnet src 172.16.0.0/12  # RFC1918 possible internal network
acl localnet src 192.168.0.0/16 # RFC1918 possible internal network
acl localnet src fc00::/7       # RFC 4193 local private network range
acl localnet src fe80::/10      # RFC 4291 link-local (directly plugged)
machines
acl SSL_ports port 443

acl Safe_ports port 80          # http
acl Safe_ports port 21          # ftp
acl Safe_ports port 443         # https
acl Safe_ports port 70          # gopher
acl Safe_ports port 210         # wais
acl Safe_ports port 280         # http-mgmt
acl Safe_ports port 488         # gss-http
acl Safe_ports port 591         # filemaker
acl Safe_ports port 777         # multiling http
acl Safe_ports port 1025-65535  # unregistered ports

acl CONNECT method CONNECT

http_access deny !Safe_ports
http_access deny CONNECT !SSL_ports
http_access allow localhost manager
http_access deny manager

#
# INSERT YOUR OWN RULE(S) HERE TO ALLOW ACCESS FROM YOUR CLIENTS
#

http_access allow localnet
http_access allow localhost
http_access deny all

coredump_dir /squid/var/cache/squid

icp_port 3130
cache_peer 172.17.0.2 sibling 3128 3130
prefer_direct off
icp_access allow all
icp_query_timeout 500
debug_options ALL,1 12,5 42,3

refresh_pattern ^ftp:           1440    20%     10080
refresh_pattern ^gopher:        1440    0%      1440
refresh_pattern -i (/cgi-bin/|\?) 0     0%      0
refresh_pattern .               0       20%     4320

cache_store_log /var/log/squid/store.log


>> These squid instances are launched using the following commands

*docker stop squid-1*||true && docker run --name squid-1 --rm -d \
  --publish 3131:3128 \
  --hostname squid-1 \
  --volume /var/spool/squid-1.conf:/etc/squid/squid.conf \
  --volume /var/spool/squid-1:/var/spool/squid \
  sameersbn/squid:3.5.27-1
 
 
*docker stop squid-2*||true && docker run --name squid-2 --rm -d \
  --publish 3132:3128 \
  --hostname squid-2 \
  --volume /var/spool/squid-2.conf:/etc/squid/squid.conf \
  --volume /var/spool/squid-2:/var/spool/squid \
  sameersbn/squid:3.5.27-1 

Localhost port *3131 is mapped to port 3128 of squid-1*
Localhost port *3132 is mapped to port 3128 of squid-2*


>> Checking the cache.log

docker exec -it *squid-1* sh -c 'cat /var/log/squid/*cache.log*'
2019/04/26 01:24:12| cannot change current directory to
/squid/var/cache/squid: (2) No such file or directory
2019/04/26 01:24:12| Current Directory is /
2019/04/26 01:24:12| Creating missing swap directories
2019/04/26 01:24:12| No cache_dir stores are configured.
2019/04/26 01:24:12| cannot change current directory to
/squid/var/cache/squid: (2) No such file or directory
2019/04/26 01:24:12| Current Directory is /
2019/04/26 01:24:12| Starting Squid Cache version 3.5.27 for
x86_64-pc-linux-gnu...
2019/04/26 01:24:12| Service Name: squid
2019/04/26 01:24:12| Process ID 1
2019/04/26 01:24:12| Process Roles: master worker
2019/04/26 01:24:12| With 1048576 file descriptors available
2019/04/26 01:24:12| Initializing IP Cache...
2019/04/26 01:24:12| DNS Socket created at [::], FD 8
2019/04/26 01:24:12| DNS Socket created at 0.0.0.0, FD 9
2019/04/26 01:24:12| Adding domain minimal from /etc/resolv.conf
2019/04/26 01:24:12| Adding nameserver 10.0.100.10 from /etc/resolv.conf
2019/04/26 01:24:12| Adding nameserver 10.0.100.11 from /etc/resolv.conf
2019/04/26 01:24:12| Logfile: opening log daemon:/var/log/squid/access.log
2019/04/26 01:24:12| Logfile Daemon: opening log /var/log/squid/access.log
2019/04/26 01:24:12| Local cache digest enabled; rebuild/rewrite every
3600/3600 sec
2019/04/26 01:24:12| Logfile: opening log /var/log/squid/store.log
2019/04/26 01:24:12| WARNING: log name now starts with a module name. Use
'stdio:/var/log/squid/store.log'
2019/04/26 01:24:12| Swap maxSize 0 + 262144 KB, estimated 20164 objects
2019/04/26 01:24:12| Target number of buckets: 1008
2019/04/26 01:24:12| Using 8192 Store buckets
2019/04/26 01:24:12| Max Mem  size: 262144 KB
2019/04/26 01:24:12| Max Swap size: 0 KB
2019/04/26 01:24:12| Using Least Load store dir selection
2019/04/26 01:24:12| cannot change current directory to
/squid/var/cache/squid: (2) No such file or directory
2019/04/26 01:24:12| Current Directory is /
2019/04/26 01:24:12| Finished loading MIME types and icons.
2019/04/26 01:24:12.888| 12,2| AsyncCall.cc(26) AsyncCall: The AsyncCall
icpIncomingConnectionOpened constructed, this=0x55cb205b6bc0 [call4]
2019/04/26 01:24:12.889| 12,2| AsyncCall.cc(93) ScheduleCall:
StartListening.cc(59) will call icpIncomingConnectionOpened(local=[::]:3130
remote=[::] FD 14 flags=9, err=0) [call4]
2019/04/26 01:24:12.889| HTCP Disabled.
2019/04/26 01:24:12.889| Pinger socket opened on FD 16
2019/04/26 01:24:12.889| *Configuring Sibling 172.17.0.3/3128/3130*
2019/04/26 01:24:12.889| Squid plugin modules loaded: 0
2019/04/26 01:24:12.889| Adaptation support is off.
2019/04/26 01:24:12.889| Accepting HTTP Socket connections at
local=[::]:3128 remote=[::] FD 13 flags=9
2019/04/26 01:24:12.896| 12,2| AsyncCallQueue.cc(55) fireNext: entering
icpIncomingConnectionOpened(local=[::]:3130 remote=[::] FD 14 flags=9,
err=0)
2019/04/26 01:24:12.896| 12,2| AsyncCall.cc(38) make: make call
icpIncomingConnectionOpened [call4]
2019/04/26 01:24:12.896| *Accepting ICP messages on [::]:3130*
2019/04/26 01:24:12.896| *Sending ICP messages from [::]:3130*
2019/04/26 01:24:12.896| 12,2| AsyncCallQueue.cc(57) fireNext: leaving
icpIncomingConnectionOpened(local=[::]:3130 remote=[::] FD 14 flags=9,
err=0)
2019/04/26 01:24:12| pinger: Initialising ICMP pinger ...
2019/04/26 01:24:12| pinger: ICMP socket opened.
2019/04/26 01:24:12| pinger: ICMPv6 socket opened
2019/04/26 01:24:12.910| 42,2| IcmpPinger.cc(189) Recv:  Pass [::1] off to
ICMPv6 module.
2019/04/26 01:24:12.910| 42,2| Icmp.cc(95) Log: pingerLog: 1556241852.910257
[::1]                                         0
2019/04/26 01:24:12.910| 42,2| IcmpPinger.cc(198) Recv:  Pass 127.0.0.1 off
to ICMPv4 module.
2019/04/26 01:24:12.910| 42,2| Icmp.cc(95) Log: pingerLog: 1556241852.910324
127.0.0.1                                     32
2019/04/26 01:24:12.910| 42,2| Icmp.cc(95) Log: pingerLog: 1556241852.910379
[::1]                                         129 Echo Reply      0ms 1 hops
2019/04/26 01:24:12.910| 42,2| IcmpPinger.cc(211) SendResult: return result
to squid. len=76
2019/04/26 01:24:12.910| 42,2| IcmpPinger.cc(211) SendResult: return result
to squid. len=7990
2019/04/26 01:24:12.910| 42,2| Icmp.cc(95) Log: pingerLog: 1556241852.910412
127.0.0.1                                     0 Echo Reply      0ms 1 hops
2019/04/26 01:24:13| storeLateRelease: released 0 objects
2019/04/26 01:24:32.917| 42,2| IcmpPinger.cc(198) Recv:  Pass 172.17.0.3 off
to ICMPv4 module.
2019/04/26 01:24:32.917| 42,2| Icmp.cc(95) Log: pingerLog: 1556241872.917292
172.17.0.3                                    32
2019/04/26 01:24:32.917| 42,2| IcmpPinger.cc(211) SendResult: return result
to squid. len=7991
2019/04/26 01:24:32.917| 42,2| Icmp.cc(95) Log: pingerLog: 1556241872.917510
172.17.0.3                                    0 Echo Reply      0ms 1 hops



docker exec -it *squid-2* sh -c 'cat /var/log/squid/*cache.log*'
2019/04/26 01:24:25| cannot change current directory to
/squid/var/cache/squid: (2) No such file or directory
2019/04/26 01:24:25| Current Directory is /
2019/04/26 01:24:25| Creating missing swap directories
2019/04/26 01:24:25| No cache_dir stores are configured.
2019/04/26 01:24:25| cannot change current directory to
/squid/var/cache/squid: (2) No such file or directory
2019/04/26 01:24:25| Current Directory is /
2019/04/26 01:24:25| Starting Squid Cache version 3.5.27 for
x86_64-pc-linux-gnu...
2019/04/26 01:24:25| Service Name: squid
2019/04/26 01:24:25| Process ID 1
2019/04/26 01:24:25| Process Roles: master worker
2019/04/26 01:24:25| With 1048576 file descriptors available
2019/04/26 01:24:25| Initializing IP Cache...
2019/04/26 01:24:25| DNS Socket created at [::], FD 8
2019/04/26 01:24:25| DNS Socket created at 0.0.0.0, FD 9
2019/04/26 01:24:25| Adding domain minimal from /etc/resolv.conf
2019/04/26 01:24:25| Adding nameserver 10.0.100.10 from /etc/resolv.conf
2019/04/26 01:24:25| Adding nameserver 10.0.100.11 from /etc/resolv.conf
2019/04/26 01:24:25| Logfile: opening log daemon:/var/log/squid/access.log
2019/04/26 01:24:25| Logfile Daemon: opening log /var/log/squid/access.log
2019/04/26 01:24:25| Local cache digest enabled; rebuild/rewrite every
3600/3600 sec
2019/04/26 01:24:25| Logfile: opening log /var/log/squid/store.log
2019/04/26 01:24:25| WARNING: log name now starts with a module name. Use
'stdio:/var/log/squid/store.log'
2019/04/26 01:24:25| Swap maxSize 0 + 262144 KB, estimated 20164 objects
2019/04/26 01:24:25| Target number of buckets: 1008
2019/04/26 01:24:25| Using 8192 Store buckets
2019/04/26 01:24:25| Max Mem  size: 262144 KB
2019/04/26 01:24:25| Max Swap size: 0 KB
2019/04/26 01:24:25| Using Least Load store dir selection
2019/04/26 01:24:25| cannot change current directory to
/squid/var/cache/squid: (2) No such file or directory
2019/04/26 01:24:25| Current Directory is /
2019/04/26 01:24:25| Finished loading MIME types and icons.
2019/04/26 01:24:25.668| 12,2| AsyncCall.cc(26) AsyncCall: The AsyncCall
icpIncomingConnectionOpened constructed, this=0x5620f1da8bc0 [call4]
2019/04/26 01:24:25.669| 12,2| AsyncCall.cc(93) ScheduleCall:
StartListening.cc(59) will call icpIncomingConnectionOpened(local=[::]:3130
remote=[::] FD 14 flags=9, err=0) [call4]
2019/04/26 01:24:25.669| HTCP Disabled.
2019/04/26 01:24:25.669| Pinger socket opened on FD 16
2019/04/26 01:24:25.669| *Configuring Sibling 172.17.0.2/3128/3130*
2019/04/26 01:24:25.669| Squid plugin modules loaded: 0
2019/04/26 01:24:25.669| Adaptation support is off.
2019/04/26 01:24:25.669| Accepting HTTP Socket connections at
local=[::]:3128 remote=[::] FD 13 flags=9
2019/04/26 01:24:25.685| 12,2| AsyncCallQueue.cc(55) fireNext: entering
icpIncomingConnectionOpened(local=[::]:3130 remote=[::] FD 14 flags=9,
err=0)
2019/04/26 01:24:25.685| 12,2| AsyncCall.cc(38) make: make call
icpIncomingConnectionOpened [call4]
2019/04/26 01:24:25.685| *Accepting ICP messages on [::]:3130*
2019/04/26 01:24:25.685| *Sending ICP messages from [::]:3130*
2019/04/26 01:24:25.685| 12,2| AsyncCallQueue.cc(57) fireNext: leaving
icpIncomingConnectionOpened(local=[::]:3130 remote=[::] FD 14 flags=9,
err=0)
2019/04/26 01:24:25| pinger: Initialising ICMP pinger ...
2019/04/26 01:24:25| pinger: ICMP socket opened.
2019/04/26 01:24:25| pinger: ICMPv6 socket opened
2019/04/26 01:24:25.699| 42,2| IcmpPinger.cc(189) Recv:  Pass [::1] off to
ICMPv6 module.
2019/04/26 01:24:25.699| 42,2| Icmp.cc(95) Log: pingerLog: 1556241865.699446
[::1]                                         0
2019/04/26 01:24:25.699| 42,2| IcmpPinger.cc(198) Recv:  Pass 127.0.0.1 off
to ICMPv4 module.
2019/04/26 01:24:25.699| 42,2| Icmp.cc(95) Log: pingerLog: 1556241865.699521
127.0.0.1                                     32
2019/04/26 01:24:25.699| 42,2| Icmp.cc(95) Log: pingerLog: 1556241865.699575
[::1]                                         129 Echo Reply      0ms 1 hops
2019/04/26 01:24:25.699| 42,2| IcmpPinger.cc(211) SendResult: return result
to squid. len=76
2019/04/26 01:24:25.699| 42,2| IcmpPinger.cc(211) SendResult: return result
to squid. len=7990
2019/04/26 01:24:25.699| 42,2| Icmp.cc(95) Log: pingerLog: 1556241865.699612
127.0.0.1                                     0 Echo Reply      0ms 1 hops
2019/04/26 01:24:26| storeLateRelease: released 0 objects
2019/04/26 01:24:45.705| 42,2| IcmpPinger.cc(198) Recv:  Pass 172.17.0.2 off
to ICMPv4 module.
2019/04/26 01:24:45.705| 42,2| Icmp.cc(95) Log: pingerLog: 1556241885.705744
172.17.0.2                                    32
2019/04/26 01:24:45.705| 42,2| IcmpPinger.cc(211) SendResult: return result
to squid. len=7991
2019/04/26 01:24:45.705| 42,2| Icmp.cc(95) Log: pingerLog: 1556241885.705878
172.17.0.2                                    0 Echo Reply      0ms 1 hops

>> Testing with the curl requests

curl -vvv -I -x http://127.0.0.1:3131 -L http://example.com
* About to connect() to proxy 127.0.0.1 port 3131 (#0)
*   Trying 127.0.0.1...
* Connected to 127.0.0.1 (127.0.0.1) port 3131 (#0)
> HEAD http://example.com/ HTTP/1.1
> User-Agent: curl/7.29.0
> Host: example.com
> Accept: */*
> Proxy-Connection: Keep-Alive
>
< HTTP/1.1 200 OK
HTTP/1.1 200 OK
< Content-Encoding: gzip
Content-Encoding: gzip
< Accept-Ranges: bytes
Accept-Ranges: bytes
< Cache-Control: max-age=604800
Cache-Control: max-age=604800
< Content-Type: text/html; charset=UTF-8
Content-Type: text/html; charset=UTF-8
< Date: Fri, 26 Apr 2019 18:06:45 GMT
Date: Fri, 26 Apr 2019 18:06:45 GMT
< ETag: "1541025663+ident"
ETag: "1541025663+ident"
< Expires: Fri, 03 May 2019 18:06:45 GMT
Expires: Fri, 03 May 2019 18:06:45 GMT
< Last-Modified: Fri, 09 Aug 2013 23:54:35 GMT
Last-Modified: Fri, 09 Aug 2013 23:54:35 GMT
< Server: ECS (sjc/4E46)
Server: ECS (sjc/4E46)
< X-Cache: HIT
X-Cache: HIT
< Content-Length: 606
Content-Length: 606
< X-Cache: MISS from squid-1
X-Cache: MISS from squid-1
< X-Cache-Lookup: *MISS from squid-1:3128*
X-Cache-Lookup: *MISS from squid-1:3128*
< Via: 1.1 squid-1 (squid/3.5.27)
Via: 1.1 squid-1 (squid/3.5.27)
< Connection: keep-alive
Connection: keep-alive




curl -vvv -I -x http://127.0.0.1:3131 -L http://example.com
* About to connect() to proxy 127.0.0.1 port 3131 (#0)
*   Trying 127.0.0.1...
* Connected to 127.0.0.1 (127.0.0.1) port 3131 (#0)
> HEAD http://example.com/ HTTP/1.1
> User-Agent: curl/7.29.0
> Host: example.com
> Accept: */*
> Proxy-Connection: Keep-Alive
>
< HTTP/1.1 200 OK
HTTP/1.1 200 OK
< Content-Encoding: gzip
Content-Encoding: gzip
< Accept-Ranges: bytes
Accept-Ranges: bytes
< Cache-Control: max-age=604800
Cache-Control: max-age=604800
< Content-Type: text/html; charset=UTF-8
Content-Type: text/html; charset=UTF-8
< Date: Fri, 26 Apr 2019 18:06:45 GMT
Date: Fri, 26 Apr 2019 18:06:45 GMT
< ETag: "1541025663+ident"
ETag: "1541025663+ident"
< Expires: Fri, 03 May 2019 18:06:45 GMT
Expires: Fri, 03 May 2019 18:06:45 GMT
< Last-Modified: Fri, 09 Aug 2013 23:54:35 GMT
Last-Modified: Fri, 09 Aug 2013 23:54:35 GMT
< Server: ECS (sjc/4E46)
Server: ECS (sjc/4E46)
< X-Cache: HIT
X-Cache: HIT
< Content-Length: 606
Content-Length: 606
< Age: 2
Age: 2
< X-Cache: HIT from squid-1
X-Cache: HIT from squid-1
< X-Cache-Lookup: *HIT from squid-1:3128*
X-Cache-Lookup: *HIT from squid-1:3128*
< Via: 1.1 squid-1 (squid/3.5.27)
Via: 1.1 squid-1 (squid/3.5.27)
< Connection: keep-alive
Connection: keep-alive

<
* Connection #0 to host 127.0.0.1 left intact




curl -vvv -I -x http://127.0.0.1:3132 -L http://example.com
* About to connect() to proxy 127.0.0.1 port 3132 (#0)
*   Trying 127.0.0.1...
* Connected to 127.0.0.1 (127.0.0.1) port 3132 (#0)
> HEAD http://example.com/ HTTP/1.1
> User-Agent: curl/7.29.0
> Host: example.com
> Accept: */*
> Proxy-Connection: Keep-Alive
>
< HTTP/1.1 200 OK
HTTP/1.1 200 OK
< Content-Encoding: gzip
Content-Encoding: gzip
< Accept-Ranges: bytes
Accept-Ranges: bytes
< Cache-Control: max-age=604800
Cache-Control: max-age=604800
< Content-Type: text/html; charset=UTF-8
Content-Type: text/html; charset=UTF-8
< Date: Fri, 26 Apr 2019 18:09:06 GMT
Date: Fri, 26 Apr 2019 18:09:06 GMT
< ETag: "1541025663"
ETag: "1541025663"
< Expires: Fri, 03 May 2019 18:09:06 GMT
Expires: Fri, 03 May 2019 18:09:06 GMT
< Last-Modified: Fri, 09 Aug 2013 23:54:35 GMT
Last-Modified: Fri, 09 Aug 2013 23:54:35 GMT
< Server: ECS (sjc/4E45)
Server: ECS (sjc/4E45)
< X-Cache: HIT
X-Cache: HIT
< Content-Length: 606
Content-Length: 606
< X-Cache: MISS from squid-2
X-Cache: MISS from squid-2
< X-Cache-Lookup: *MISS from squid-2:3128*
X-Cache-Lookup: *MISS from squid-2:3128*
< Via: 1.1 squid-2 (squid/3.5.27)
Via: 1.1 squid-2 (squid/3.5.27)
< Connection: keep-alive
Connection: keep-alive

<
* Connection #0 to host 127.0.0.1 left intact


>> I am expecting the third curl request should result in sibling hit. If
>> that's not possible, kindly advise an alternative way to verify peer
>> caching.

Thanks



--
Sent from: http://squid-web-proxy-cache.1019090.n4.nabble.com/Squid-Users-f1019091.html


From leomessi983 at yahoo.com  Tue Apr 30 06:49:04 2019
From: leomessi983 at yahoo.com (leomessi983 at yahoo.com)
Date: Tue, 30 Apr 2019 06:49:04 +0000 (UTC)
Subject: [squid-users] udp log buffer size
References: <682005820.2525871.1556606944832.ref@mail.yahoo.com>
Message-ID: <682005820.2525871.1556606944832@mail.yahoo.com>

Hi squid membersHow can i disable buffering logs to send them to a UDP receiver daemon?I want to get logs immediately without buffering them with squid!
I checked before and my daemon I/O is OK and gets logs immediately, when i reload squid it send logs to my daemon but? it get some time to send them without reloading, my buffer-size=0KB configuration does not work!!
This is my config:
access_log udp://127.0.0.1:12188 logformat=squid1 buffer-size=0KB

Thanx
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20190430/28f56afa/attachment.htm>

From leomessi983 at yahoo.com  Tue Apr 30 07:11:50 2019
From: leomessi983 at yahoo.com (leomessi983 at yahoo.com)
Date: Tue, 30 Apr 2019 07:11:50 +0000 (UTC)
Subject: [squid-users] udp log buffer size
References: <2023369986.2521575.1556608310458.ref@mail.yahoo.com>
Message-ID: <2023369986.2521575.1556608310458@mail.yahoo.com>

Hi squid membersMy squid? version is 4.6 .
How can i disable buffering logs to send them to a UDP receiver daemon?I want to get logs immediately without buffering them with squid!
I checked before and my daemon I/O is OK and gets logs immediately, when i reload squid it send logs to my daemon but? it get some time to send them without reloading, my buffer-size=0KB configuration does not work!!
This is my config:
access_log udp://127.0.0.1:12188 logformat=squid1 buffer-size=0KB

Thanx
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20190430/9c3594a2/attachment.htm>

From giacomo at gtrovato.com  Tue Apr 30 14:04:31 2019
From: giacomo at gtrovato.com (Giacomo Trovato)
Date: Tue, 30 Apr 2019 16:04:31 +0200
Subject: [squid-users] SSL_ERROR_RX_RECORD_TOO_LONG
Message-ID: <5966bff0eb74aecf2edacffcbb58fbcf@gtrovato.com>

Hi All, 

I've pfSense with Squid + SquidGuard (Splice All - no CA certificate).
It worked well until one month ago, now sometimes appears the error
message SSL_ERROR_RX_RECORD_TOO_LONG (see attachment).
It appears randomly on all PC / smartphone on different HTTPS sites.
The devices connected directly (no proxy) work properly.
Any hint? 

Than you! 
-- 

Giacomo Trovato
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20190430/29cbaa59/attachment.htm>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: Schermata del 2019-04-30 16-00-06.png
Type: image/png
Size: 28893 bytes
Desc: not available
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20190430/29cbaa59/attachment.png>

From rousskov at measurement-factory.com  Tue Apr 30 14:36:26 2019
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Tue, 30 Apr 2019 08:36:26 -0600
Subject: [squid-users] SSL_ERROR_RX_RECORD_TOO_LONG
In-Reply-To: <5966bff0eb74aecf2edacffcbb58fbcf@gtrovato.com>
References: <5966bff0eb74aecf2edacffcbb58fbcf@gtrovato.com>
Message-ID: <5eefd13a-b9ad-ffff-a6df-33c1da2e6c29@measurement-factory.com>

On 4/30/19 8:04 AM, Giacomo Trovato wrote:

> I've pfSense with Squid + SquidGuard (Splice All - no CA certificate).
> It worked well until one month ago, now sometimes appears the error
> message SSL_ERROR_RX_RECORD_TOO_LONG (see attachment).
> It appears randomly on all PC / smartphone on different HTTPS sites.
> The devices connected directly (no proxy) work properly.
> Any hint?


What is your current Squid version?

The browser claims that your Squid sent it a very long (most likely
malformed) TLS record. If this does not happen without Squid, then this
is likely a Squid bug. I see references to similar problems in old
(Squid v3) web posts.

* If you can reproduce with Squid v4 or later, the best next step is to
share a packet capture of the offending transaction along with the
cache.log after setting debug_options to ALL,9. Please compress large
files before sharing.

* If you cannot reproduce with Squid v4 or later, then the best next
step is to upgrade your Squid.


HTH,

Alex.


From rousskov at measurement-factory.com  Tue Apr 30 14:41:41 2019
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Tue, 30 Apr 2019 08:41:41 -0600
Subject: [squid-users] udp log buffer size
In-Reply-To: <682005820.2525871.1556606944832@mail.yahoo.com>
References: <682005820.2525871.1556606944832.ref@mail.yahoo.com>
 <682005820.2525871.1556606944832@mail.yahoo.com>
Message-ID: <10612069-b56b-ea4f-d3ab-064724d59a95@measurement-factory.com>

On 4/30/19 12:49 AM, leomessi983 at yahoo.com wrote:
> Hi squid members
> How can i disable buffering logs to send them to a UDP receiver daemon?

Upgrade to Squid v4 containing the following change and set access_log
buffer-size to zero: https://github.com/squid-cache/squid/pull/377

If you are running v5, the corresponding change is
https://github.com/squid-cache/squid/pull/359

Alex.


From squid3 at treenet.co.nz  Tue Apr 30 07:35:57 2019
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Tue, 30 Apr 2019 19:35:57 +1200
Subject: [squid-users] udp log buffer size
In-Reply-To: <2023369986.2521575.1556608310458@mail.yahoo.com>
References: <2023369986.2521575.1556608310458.ref@mail.yahoo.com>
 <2023369986.2521575.1556608310458@mail.yahoo.com>
Message-ID: <bfd8307d-da26-ea09-35ab-348afede757d@treenet.co.nz>

On 30/04/19 7:11 pm, leomessi983 at yahoo.com wrote:
> Hi squid members
> My squid? version is 4.6 .
> How can i disable buffering logs to send them to a UDP receiver daemon?
> I want to get logs immediately without buffering them with squid!
> I checked before and my daemon I/O is OK and gets logs immediately, when
> i reload squid it send logs to my daemon but? it get some time to send
> them without reloading, my buffer-size=0KB configuration does not work!!
> 
> This is my config:
> 
> access_log udp://127.0.0.1:12188 logformat=squid1 buffer-size=0KB
> 


IIRC there was a typo in the instructions, "buffer-size=0" (no unit)
should work.

Amos


From squid3 at treenet.co.nz  Sun Apr 28 06:45:30 2019
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Sun, 28 Apr 2019 18:45:30 +1200
Subject: [squid-users] Sibling cache_peer inside docker containers
In-Reply-To: <CALwgGcr_FKuh5T0hAaL01w6uNBmi7H21pqhg0cCXwhua77vQYA@mail.gmail.com>
References: <1556236818002-0.post@n4.nabble.com>
 <d34cb012-cc9c-8368-6c3f-4c46fc6bc4cd@treenet.co.nz>
 <CALwgGcr_FKuh5T0hAaL01w6uNBmi7H21pqhg0cCXwhua77vQYA@mail.gmail.com>
Message-ID: <60ea4698-d7c8-cc20-4f7d-9f554bf5b067@treenet.co.nz>

On 27/04/19 6:12 am, Das Me wrote:
>>> I am expecting the third curl request should result in sibling hit.
> If that's not possible, kindly advise an alternative way to verify peer
> caching.
> 

With "debug_options 44,3" Squid will log all its route selection decisions.

Amos


