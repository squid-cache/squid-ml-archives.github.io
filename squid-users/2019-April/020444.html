<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid 4 ssl_bump issue
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%204%20ssl_bump%20issue&In-Reply-To=%3CCAPaB35%3DB6%2BhbYDMGC3BZXVhO8UVOg%3DzxdFswv--av3zHHb%2BaCg%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="020443.html">
   <LINK REL="Next"  HREF="020445.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid 4 ssl_bump issue</H1>
    <B>Davide Belloni</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%204%20ssl_bump%20issue&In-Reply-To=%3CCAPaB35%3DB6%2BhbYDMGC3BZXVhO8UVOg%3DzxdFswv--av3zHHb%2BaCg%40mail.gmail.com%3E"
       TITLE="[squid-users] Squid 4 ssl_bump issue">davide.belloni at gmail.com
       </A><BR>
    <I>Thu Apr  4 09:11:38 UTC 2019</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="020443.html">[squid-users] external acl helper for URI lookups from database
</A></li>
        <LI>Next message (by thread): <A HREF="020445.html">[squid-users] Squid 4 ssl_bump issue
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20444">[ date ]</a>
              <a href="thread.html#20444">[ thread ]</a>
              <a href="subject.html#20444">[ subject ]</a>
              <a href="author.html#20444">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,
I've a problem in Ubuntu 18.04.2 with Squid 4.6 compiled with OpenSSL 1.1
about ssl_bump. The same configuration works in Squid 3.5 and OpenSSL 1.0

Here the relevant conf :

...
http_port 3128 ssl-bump options=ALL:NO_SSLv3 connection-auth=off
generate-host-certificates=off cert=/etc/squid/squidCA.pem

# Not bypass server certificate validation errors
sslproxy_cert_error deny all
# This one return errors with debian on GCP (
<A HREF="https://wiki.squid-cache.org/KnowledgeBase/HostHeaderForgery">https://wiki.squid-cache.org/KnowledgeBase/HostHeaderForgery</A>)
host_verify_strict off

sslproxy_session_cache_size 0

acl step1 at_step SslBump1
acl step2 at_step SslBump2
acl step3 at_step SslBump3

ssl_bump peek step1 all
ssl_bump peek step2 all

# API Google
acl api_google_urls url_regex
^(https?:\/\/)?.*\.googleapis\.com(:443)?($|\/)
acl api_google_urls url_regex ^(https?:\/\/)?.*\.google\.com(:443)?($|\/)
acl api_google_urls url_regex
^(https?:\/\/)?.*\.cloud\.google\.com(:443)?($|\/)
acl api_google_urls url_regex
^(https:\/\/)?([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})
acl api_google_ssl ssl::server_name_regex .*\.googleapis\.com
acl api_google_ssl ssl::server_name_regex .*\.google\.com
acl api_google_ssl ssl::server_name_regex .*\.cloud\.google\.com
acl api_google_ips src 127.0.0.1/32

http_access allow api_google_ips api_google_urls
ssl_bump splice step3 api_google_ips api_google_ssl

http_access deny all
ssl_bump terminate step3 all
...


To compile and install squid I use this script:

# set squid version
&gt;<i> export SQUID_VER=&quot;4.6&quot;
</I>&gt;<i> export SQUID_PKG=&quot;${SQUID_VER}-2&quot;
</I>&gt;<i> sudo apt-get -y install libssl-dev devscripts build-essential fakeroot
</I>&gt;<i> dpkg-dev
</I>&gt;<i> sudo apt-get -y install libcppunit-dev libsasl2-dev libxml2-dev
</I>&gt;<i> libkrb5-dev \
</I>&gt;<i>     libdb-dev libnetfilter-conntrack-dev libexpat1-dev libcap2-dev
</I>&gt;<i> libldap2-dev \
</I>&gt;<i>     libpam0g-dev libgnutls28-dev libssl-dev libdbi-perl libecap3
</I>&gt;<i> libecap3-dev \
</I>&gt;<i>     ed libltdl-dev cdbs debhelper dh-apparmor
</I>&gt;<i> # we will be working in a subfolder make it
</I>&gt;<i> mkdir -p build/squid
</I>&gt;<i> # decend into working directory
</I>&gt;<i> pushd build/squid
</I>&gt;<i> curl --tlsv1.1 -sSO
</I>&gt;<i> <A HREF="http://cdn-fastly.deb.debian.org/debian/pool/main/s/squid/squid_${SQUID_PKG">http://cdn-fastly.deb.debian.org/debian/pool/main/s/squid/squid_${SQUID_PKG</A>}.dsc
</I>&gt;<i> curl --tlsv1.1 -sSO
</I>&gt;<i> <A HREF="http://cdn-fastly.deb.debian.org/debian/pool/main/s/squid/squid_${SQUID_VER">http://cdn-fastly.deb.debian.org/debian/pool/main/s/squid/squid_${SQUID_VER</A>}.orig.tar.gz
</I>&gt;<i> curl --tlsv1.1 -sSO
</I>&gt;<i> <A HREF="http://cdn-fastly.deb.debian.org/debian/pool/main/s/squid/squid_${SQUID_PKG">http://cdn-fastly.deb.debian.org/debian/pool/main/s/squid/squid_${SQUID_PKG</A>}.debian.tar.xz
</I>&gt;<i> # unpack the source package
</I>&gt;<i> dpkg-source -x squid_${SQUID_PKG}.dsc
</I>&gt;<i> echo &quot;DEB_CONFIGURE_EXTRA_FLAGS += --enable-ssl --with-openssl
</I>&gt;<i> --enable-ssl-crtd&quot; &gt;&gt; squid-${SQUID_VER}/debian/rules
</I>&gt;<i> # build the package
</I>&gt;<i> cd squid-${SQUID_VER} &amp;&amp; dpkg-buildpackage -rfakeroot -b -J2 -uc -us
</I>&gt;<i> sudo apt-get install squid-langpack
</I>&gt;<i> sudo dpkg --install squid-common_${SQUID_PKG}_all.deb
</I>&gt;<i> sudo dpkg --install squid_${SQUID_PKG}_amd64.deb
</I>&gt;<i> sudo dpkg --install squidclient_${SQUID_PKG}_amd64.deb
</I>&gt;<i> cd /etc/squid
</I>&gt;<i> sudo openssl req -new -newkey rsa:2048 -sha256 -days 365 -nodes -subj
</I>&gt;<i> &quot;/CN=nobody&quot; -x509 -extensions v3_ca -keyout squidCA.pem -out squidCA.pem
</I>&gt;<i> chown proxy:proxy /var/spool/squid
</I>&gt;<i> chown proxy:proxy /var/log/squid
</I>&gt;<i> chown -R proxy:proxy /etc/squid
</I>&gt;<i> sudo apt-get -y remove --purge libssl-dev
</I>&gt;<i> sudo apt-get -y remove --purge devscripts build-essential fakeroot dpkg-dev
</I>&gt;<i> sudo apt-get -y remove --purge libcppunit-dev libsasl2-dev libxml2-dev
</I>&gt;<i> libkrb5-dev \
</I>&gt;<i>     libdb-dev libnetfilter-conntrack-dev libexpat1-dev libcap2-dev
</I>&gt;<i> libldap2-dev \
</I>&gt;<i>     libpam0g-dev libgnutls28-dev libssl-dev libecap3-dev \
</I>&gt;<i>     ed libltdl-dev cdbs debhelper dh-apparmor
</I>&gt;<i> sudo apt-get -y autoremove
</I>

I'm upgrading to Squid4 with OpenSSL 1.1 because with Squid3 Ive some
connections that get stuck (for example
<A HREF="https://packages.cloud.google.com/apt/doc/apt-key.gpg">https://packages.cloud.google.com/apt/doc/apt-key.gpg</A>) I think for
unsupported ciphers.

But with Squid4 and OpenSSL1.1 I've this lines in cache log:

&gt;<i> 2019/04/04 08:49:15 kid1| ERROR: client https start failed to allocate
</I>&gt;<i> handle: error:140AB043:SSL routines:SSL_CTX_use_certificate:passed a null
</I>&gt;<i> parameter
</I>
2019/04/04 08:49:15 kid1| ERROR: could not create TLS server context for
&gt;<i> local=127.0.0.1:3128 remote=127.0.0.1:39203 FD 19 flags=1
</I>
and this in access log:

&gt;<i> 127.0.0.1 - - [04/Apr/2019:08:49:15 +0000] &quot;CONNECT
</I>&gt;<i> packages.cloud.google.com:443 HTTP/1.1&quot; 200 0 &quot;-&quot; &quot;curl/7.58.0&quot;
</I>&gt;<i> NONE_ABORTED:HIER_NONE packages.cloud.google.com
</I>

for the following connection:

<A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at instance-2</A>:/etc/squid $ https_proxy=&quot;<A HREF="http://127.0.0.1:3128">http://127.0.0.1:3128</A>&quot; curl -vvvv
-sSO  <A HREF="https://packages.cloud.google.com/apt/doc/apt-key.gpg">https://packages.cloud.google.com/apt/doc/apt-key.gpg</A>
*   Trying 127.0.0.1...
* TCP_NODELAY set
* Connected to 127.0.0.1 (127.0.0.1) port 3128 (#0)
* allocate connect buffer!
* Establish HTTP proxy tunnel to packages.cloud.google.com:443
&gt;<i> CONNECT packages.cloud.google.com:443 HTTP/1.1
</I>&gt;<i> Host: packages.cloud.google.com:443
</I>&gt;<i> User-Agent: curl/7.58.0
</I>&gt;<i> Proxy-Connection: Keep-Alive
</I>&gt;<i>
</I>&lt; HTTP/1.1 200 Connection established
&lt;
* Proxy replied 200 to CONNECT request
* CONNECT phase completed!
* ALPN, offering h2
* ALPN, offering http/1.1
* successfully set certificate verify locations:
*   CAfile: /etc/ssl/certs/ca-certificates.crt
  CApath: /etc/ssl/certs
} [5 bytes data]
* TLSv1.2 (OUT), TLS handshake, Client hello (1):
} [223 bytes data]
* OpenSSL SSL_connect: SSL_ERROR_SYSCALL in connection to
packages.cloud.google.com:443
* Closing connection 0
curl: (35) OpenSSL SSL_connect: SSL_ERROR_SYSCALL in connection to
packages.cloud.google.com:443


Thanks

-- 

Davide Belloni
<A HREF="http://about.me/davidebelloni">http://about.me/davidebelloni</A>
<A HREF="http://www.linkedin.com/in/davidebelloni">http://www.linkedin.com/in/davidebelloni</A>


-- 

Davide Belloni
<A HREF="http://about.me/davidebelloni">http://about.me/davidebelloni</A>
<A HREF="http://www.linkedin.com/in/davidebelloni">http://www.linkedin.com/in/davidebelloni</A>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20190404/178c244b/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20190404/178c244b/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="020443.html">[squid-users] external acl helper for URI lookups from database
</A></li>
	<LI>Next message (by thread): <A HREF="020445.html">[squid-users] Squid 4 ssl_bump issue
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20444">[ date ]</a>
              <a href="thread.html#20444">[ thread ]</a>
              <a href="subject.html#20444">[ subject ]</a>
              <a href="author.html#20444">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
