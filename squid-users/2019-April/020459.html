<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid bind each outgoing ip to a user?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20bind%20each%20outgoing%20ip%20to%20a%20user%3F&In-Reply-To=%3Cded1a6fe-f730-b337-3a04-c104864d0077%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="020458.html">
   <LINK REL="Next"  HREF="020460.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid bind each outgoing ip to a user?</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20bind%20each%20outgoing%20ip%20to%20a%20user%3F&In-Reply-To=%3Cded1a6fe-f730-b337-3a04-c104864d0077%40treenet.co.nz%3E"
       TITLE="[squid-users] Squid bind each outgoing ip to a user?">squid3 at treenet.co.nz
       </A><BR>
    <I>Sun Apr  7 07:55:26 UTC 2019</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="020458.html">[squid-users] Squid bind each outgoing ip to a user?
</A></li>
        <LI>Next message (by thread): <A HREF="020460.html">[squid-users] Squid bind each outgoing ip to a user?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20459">[ date ]</a>
              <a href="thread.html#20459">[ thread ]</a>
              <a href="subject.html#20459">[ subject ]</a>
              <a href="author.html#20459">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 7/04/19 7:01 pm, jyliu wrote:
&gt;<i> Thanks for replying so quickly! I really appreciate it!
</I>&gt;<i> 
</I>&gt;<i> I am very new to Squid (start a week ago) so I probably will make dumb
</I>&gt;<i> mistakes.
</I>&gt;<i> 
</I>&gt;<i> I just search this forum and find another post similar to my problem, and
</I>&gt;<i> your answer is:
</I>&gt;&gt;<i> http_port xxx.xxx.xxx.14:3128 name=0
</I>&gt;&gt;<i> acl ip1 myportname 0
</I>&gt;&gt;<i> tcp_outgoing_address xxx.xxx.xxx.14 ip1
</I>&gt;<i> 
</I>&gt;<i> Is this the same as what I am previously doing?
</I>
No. The myportname ACL tests the non-changing name= setting of whichever
http_port the requests TCP connection was received on.

&quot;myip&quot; checks against the dynamically changing TCP connection port
number the client used to connect to Squid. This may have nothing to do
with the http_port port number.

It just happens that your current tests are using the port 3128 to
connect directly to the proxy so they both reach the same outcome.



Correct configuration is to either use mytportname to match the
squid.conf setting if that is what you want. Or use localport ACL to
match the client connection dst-port value if that is what you want.


&gt;&gt;<i> http_port 3128 
</I>&gt;&gt;<i> acl ip1 myip xxx.xxx.xxx.14 
</I>&gt;&gt;<i> tcp_outgoing_address xxx.xxx.xxx.14 ip1 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> I check access.log it returns 407:
</I>&gt;<i> TCP_DENIED/407 3710 GET <A HREF="http://www.google.com/">http://www.google.com/</A> test HIER_NONE/- text/html
</I>&gt;<i> 
</I>
So that is HTTP status &quot;407 Proxy Authentication Required&quot;.

Either the request has no credentials. Or any credentials given are not
sufficient to perform the action being asked of the proxy. Other
credentials are being requested by the proxy.



&gt;<i> I am not sure how to put -d in squid.conf helper...But I add those
</I>&gt;<i> debug_options.
</I>

See those auth_param and external_acl_type lines where the helper
program command-lines are configured.
  Add -d to the helepr parameter list on those lines.

Like so:


  auth_param basic program /usr/lib64/squid/basic_ncsa_auth -d \
    /etc/squid/passwords


  external_acl_type userIp %SRC %LOGIN \
    /usr/lib64/squid/ext_file_userip_acl -d \
    -f /etc/squid/userIp.conf


&gt;<i> 
</I>&gt;<i> And here is cache.log file:
</I>...
&gt;<i> 2019/04/07 02:54:03.586 kid1| client_side.cc(2408) parseHttpRequest: HTTP
</I>&gt;<i> Client local=204.188.217.14:3128 remote=209.166.109.90:55394 FD 9 flags=1
</I>&gt;<i> 2019/04/07 02:54:03.586 kid1| client_side.cc(2409) parseHttpRequest: HTTP
</I>&gt;<i> Client REQUEST:
</I>&gt;<i> ---------
</I>&gt;<i> GET <A HREF="http://www.google.com/">http://www.google.com/</A> HTTP/1.1
</I>&gt;<i> Host: www.google.com
</I>&gt;<i> Proxy-Authorization: Basic dGVzdDp0ZXN0
</I>&gt;<i> User-Agent: curl/7.58.0
</I>&gt;<i> Accept: */*
</I>&gt;<i> Proxy-Connection: Keep-Alive
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> ----------
</I>&gt;<i> 2019/04/07 02:54:03.587 kid1| Checklist.cc(62) preCheck: 0x1777988 checking
</I>&gt;<i> slow rules
</I>&gt;<i> 2019/04/07 02:54:03.587 kid1| Acl.cc(157) matches: checking http_access
</I>&gt;<i> 2019/04/07 02:54:03.587 kid1| Acl.cc(157) matches: checking http_access#1
</I>&gt;<i> 2019/04/07 02:54:03.587 kid1| Acl.cc(157) matches: checking !ncsa_users
</I>
&gt;<i> 2019/04/07 02:54:03.587 kid1| AclProxyAuth.cc(143) checkForAsync: checking
</I>&gt;<i> password via authenticator
</I>&gt;<i> 2019/04/07 02:54:03.587 kid1| Starting new basicauthenticator helpers...
</I>&gt;<i> 2019/04/07 02:54:03.588 kid1| Acl.cc(62) AuthenticateAcl: returning 2
</I>&gt;<i> sending credentials to helper.
</I>
...
&gt;<i> 2019/04/07 02:54:03.602 kid1| Acl.cc(177) matches: checked: ncsa_users = 1
</I>
Credentials existed in the request. Login happened successfully ...


&gt;<i> 2019/04/07 02:54:03.602 kid1| InnerNode.cc(90) resumeMatchingAt: checked:
</I>&gt;<i> !ncsa_users = 0
</I>
... so &quot;http_access deny !ncsa_users&quot; passed. Moving on.


...
&gt;<i> 2019/04/07 02:54:03.602 kid1| Acl.cc(157) matches: checking userIp
</I>&gt;<i> 2019/04/07 02:54:03.602 kid1| Acl.cc(177) matches: checked: userIp = 0
</I>
The external_acl_type helper found that &quot;204.188.217.14 test&quot; was not in
your userIp.conf file.



&gt;<i> 2019/04/07 02:54:03.602 kid1| InnerNode.cc(90) resumeMatchingAt: checked:
</I>&gt;<i> http_access#2 = 0
</I>&gt;<i> 2019/04/07 02:54:03.602 kid1| InnerNode.cc(90) resumeMatchingAt: checked:
</I>&gt;<i> http_access = 0
</I>&gt;<i> 2019/04/07 02:54:03.602 kid1| Checklist.cc(378) calcImplicitAnswer:
</I>&gt;<i> 0x1777988 NO match found, last action ALLOWED so returning DENIED
</I>
This states that the &quot;http_access deny all&quot; rule you showed being in
your config earlier does not exist.

Last ACL to be tested being userIp - which used authentication
credentials. So a different outcome may have happened if some other
login was supplied by the client.

 ==&gt; the 407 challenge is produced to get _different_ credentials that
may pass the userIp check.


&gt;<i> Client local=204.188.217.14:3128 remote=209.166.109.90:55394 FD 9 flags=1
</I>&gt;<i> 2019/04/07 02:54:03.603 kid1| client_side.cc(1461) sendStartOfMessage: HTTP
</I>&gt;<i> Client REPLY:
</I>&gt;<i> ---------
</I>&gt;<i> HTTP/1.1 407 Proxy Authentication Required
</I>&gt;<i> Server: squid/3.4.14
</I>&gt;<i> Mime-Version: 1.0
</I>&gt;<i> Date: Sun, 07 Apr 2019 06:54:03 GMT
</I>&gt;<i> Content-Type: text/html
</I>&gt;<i> Content-Length: 3234
</I>&gt;<i> X-Squid-Error: ERR_CACHE_ACCESS_DENIED 0
</I>&gt;<i> Vary: Accept-Language
</I>&gt;<i> Content-Language: en
</I>&gt;<i> Proxy-Authenticate: Basic realm=&quot;Squid proxy-caching web server&quot;
</I>&gt;<i> X-Cache: MISS from mx3.dealsbay.org
</I>&gt;<i> X-Cache-Lookup: NONE from mx3.dealsbay.org:3128
</I>&gt;<i> Via: 1.1 mx3.dealsbay.org (squid/3.4.14)
</I>&gt;<i> Connection: keep-alive
</I>&gt;<i> 
</I>&gt;<i> ----------
</I>

PS. The most current Squid release is 4.6. Please upgrade. There are a
very large number of bug fixes and more than a few major security
vulnerabilities fixed since 3.4.14.
 Ideally no version older than Squid-3.5.28 should be in use anymore.


Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="020458.html">[squid-users] Squid bind each outgoing ip to a user?
</A></li>
	<LI>Next message (by thread): <A HREF="020460.html">[squid-users] Squid bind each outgoing ip to a user?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20459">[ date ]</a>
              <a href="thread.html#20459">[ thread ]</a>
              <a href="subject.html#20459">[ subject ]</a>
              <a href="author.html#20459">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
