<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid 3.5 https facebook caching
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%203.5%20https%20facebook%20caching&In-Reply-To=%3C95e8facb-4e51-09a4-b505-0a6e13367419%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="020511.html">
   <LINK REL="Next"  HREF="020514.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid 3.5 https facebook caching</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%203.5%20https%20facebook%20caching&In-Reply-To=%3C95e8facb-4e51-09a4-b505-0a6e13367419%40treenet.co.nz%3E"
       TITLE="[squid-users] Squid 3.5 https facebook caching">squid3 at treenet.co.nz
       </A><BR>
    <I>Wed Apr 17 13:52:03 UTC 2019</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="020511.html">[squid-users] Squid 3.5 https facebook caching
</A></li>
        <LI>Next message (by thread): <A HREF="020514.html">[squid-users] Squid 3.5 https facebook caching
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20512">[ date ]</a>
              <a href="thread.html#20512">[ thread ]</a>
              <a href="subject.html#20512">[ subject ]</a>
              <a href="author.html#20512">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 17/04/19 3:04 am, tester100 wrote:
&gt;<i> Hi guys
</I>&gt;<i> 
</I>&gt;<i> i am currently using this setup on my squid 3.5.28 version for https
</I>&gt;<i> filtering using ssl certificate
</I>&gt;<i> 
</I>&gt;<i> its caching http and https (some specific extensions) on facebook i can
</I>&gt;<i> cache images,css, and other javascript files..
</I>&gt;<i> 
</I>&gt;<i> aldo when i press play to play the video and try to cache it , it simply
</I>&gt;<i> does not play any videos i can only play the live feeds transmission, this
</I>&gt;<i> is the squid.conf files and the store-id.pl i am using
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> # SQUID CONFIGURATION OF CYBERSCIE.COM
</I>&gt;<i> #
</I>&gt;<i> 
</I>&gt;<i> acl localnet src 10.0.0.0/8	# RFC1918 possible internal network
</I>&gt;<i> acl localnet src 172.16.0.0/12	# RFC1918 possible internal network
</I>&gt;<i> acl localnet src fc00::/7       # RFC 4193 local private network range
</I>&gt;<i> acl localnet src fe80::/10      # RFC 4291 link-local (directly plugged)
</I>&gt;<i> machines
</I>&gt;<i> acl localnet src 192.168.1.0/24 
</I>&gt;<i> acl localnet src 192.168.2.0/24
</I>&gt;<i> 
</I>&gt;<i> acl SSL_ports port 443
</I>&gt;<i> acl SSL_ports port 5353
</I>&gt;<i> acl Safe_ports port 21
</I>&gt;<i> acl Safe_ports port 22
</I>&gt;<i> acl Safe_ports port 53
</I>&gt;<i> acl Safe_ports port 70
</I>&gt;<i> acl Safe_ports port 80
</I>&gt;<i> acl Safe_ports port 210
</I>&gt;<i> acl Safe_ports port 280
</I>&gt;<i> acl Safe_ports port 1025-65535
</I>
The above line means that any of the *many* entries you have for ports
over 1024 are a pointless waste of memory and CPU cycles.

Please start by running &quot;squid -k parse&quot; on your config and fix all the
issues that get mentioned.
...
&gt;<i> acl CONNECT method CONNECT
</I>&gt;<i> 
</I>&gt;<i> # ACCESS RULES
</I>&gt;<i> http_access deny !Safe_ports
</I>&gt;<i> http_access deny CONNECT !SSL_ports
</I>&gt;<i> http_access allow localnet
</I>&gt;<i> http_access allow localhost
</I>&gt;<i> http_access deny all
</I>&gt;<i> 
</I>&gt;<i> # LISTENING PORT SQUID
</I>&gt;<i> 
</I>&gt;<i> http_port 3128 ssl-bump cert=/etc/squid/ssl_certs/myCA.pem
</I>&gt;<i> generate-host-certificates=on dynamic_cert_mem_cache_size=4MB
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> # CONNECTION HANDLING
</I>&gt;<i> qos_flows local-hit=0x30
</I>&gt;<i> collapsed_forwarding on	
</I>&gt;<i> balance_on_multiple_ip on
</I>
The above breaks performance of server persistent connections....

&gt;<i> detect_broken_pconn on
</I>&gt;<i> client_persistent_connections off
</I>&gt;<i> server_persistent_connections on
</I>
... which is the only type of persistence you have enabled.

&gt;<i> 
</I>&gt;<i> # DNS OPTIONS
</I>&gt;<i> #dns_packet_max 4096
</I>&gt;<i> dns_defnames on
</I>&gt;<i> dns_v4_first on
</I>&gt;<i> connect_retries 2
</I>&gt;<i> negative_dns_ttl 1 second
</I>&gt;<i> quick_abort_min 0
</I>&gt;<i> quick_abort_max 0
</I>&gt;<i> quick_abort_pct 80
</I>&gt;<i> range_offset_limit 0
</I>
Hm, so all transactions which are started will run until completion even
if no client needs that response.

&gt;<i> ipcache_low 98
</I>&gt;<i> ipcache_high 99
</I>&gt;<i> ipcache_size 4096
</I>&gt;<i> fqdncache_size 2048
</I>&gt;<i> pipeline_prefetch 0
</I>&gt;<i> 
</I>&gt;<i> # MISCELEANOUS
</I>&gt;<i> memory_pools off
</I>&gt;<i> reload_into_ims on
</I>&gt;<i> max_filedescriptors 65536
</I>&gt;<i> 
</I>&gt;<i> # CACHE MANAGEMENT
</I>&gt;<i> cache_mem 512 MB
</I>&gt;<i> maximum_object_size_in_memory 128 KB
</I>&gt;<i> memory_replacement_policy heap GDSF
</I>&gt;<i> cache_effective_group proxy	
</I>&gt;<i> cache_effective_user proxy
</I>&gt;<i> cache_dir aufs /cache/cache 100000 16 256
</I>&gt;<i> coredump_dir /cache/cache
</I>&gt;<i> cache_mgr cyberscie
</I>&gt;<i> visible_hostname <A HREF="https://lists.squid-cache.org/listinfo/squid-users">someone at gmail.com</A>
</I>
The above looks like an email address. Not an FQDN.

&quot;hostname&quot; is the name of the machine running Squid. To work properly it
should be a FQDN that can be resolved with DNS.


&gt;<i> minimum_object_size 0 KB
</I>&gt;<i> maximum_object_size 1 GB
</I>&gt;<i> read_ahead_gap 64 KB		#Amount of data to buffer from server to client
</I>&gt;<i> cache_replacement_policy heap LFUDA
</I>&gt;<i> store_dir_select_algorithm least-load
</I>&gt;<i> cache_swap_low 90
</I>&gt;<i> cache_swap_high 95
</I>&gt;<i> 
</I>&gt;<i> # LOG FILE OPTIONS
</I>&gt;<i> logfile_daemon /usr/lib/squid/log_file_daemon
</I>&gt;<i> access_log daemon:/var/log/squid/access.log squid
</I>&gt;<i> cache_log /dev/null		#cache_log /var/log/squid/cache.log(to enable)
</I>
This is a bad idea. What do you expect will happen to the machine when
Squid renames the /dev/null path to /dev/null.0 and places a file at
that location?


&gt;<i> cache_store_log none
</I>
It is not necessary to set things to their default value in Squid-3.

&gt;<i> logfile_rotate 3
</I>&gt;<i> pid_filename /var/run/squid.pid
</I>&gt;<i> 
</I>&gt;<i> # FILTERING HTTPS
</I>&gt;<i> acl 1 dstdomain .fbcdn.net .akamaihd.net .fbsbx.com
</I>&gt;<i> #acl 2a dstdomain .mahadana.com .mql4.com .metaquotes.net
</I>&gt;<i> acl 2 url_regex -i ^https?:\/\/attachment\.fbsbx\.com\/.*\?(id=[0-9]*).*
</I>&gt;<i> acl 2 url_regex -i
</I>&gt;<i> \.fbsbx\.com\/.*\/(.*\.(unity3d|pak|zip|exe|dll|jpg|png|gif|swf)/)$
</I>

The above &quot;2&quot; lines are pointless. The ACL called &quot;1&quot; has already
matched and allowed Store-ID processing of all the domains this pattern
might match.

&gt;<i> acl 2 url_regex -i ^https?:\/\/.*\.ytimg\.com(.*\.(webp|jpg|gif))
</I>
The above pattern does not match what it may seem to match.

Notice that;
  A) there is no path-segment delimiter ('/' or '\?') required. So the
thing that _looks_ like a file extension can match when existing in the
domain name (eg <A HREF="http://hello.ytimg.com.gif-fy.invalid/">http://hello.ytimg.com.gif-fy.invalid/</A> will be allowed)
 B)


&gt;<i> acl 2 url_regex -i ^https?:\/\/([^\.]*)\.yimg\.com\/(.*)
</I>&gt;<i> acl 2 url_regex -i ^https?:\/\/.*\.gstatic\.com\/images\?q=tbn\:(.*)
</I>


It is pointless to place &quot;(.*)&quot; or &quot;.*&quot; or &quot;.+&quot; at the start or end of a
regex pattern.

Arbitrary suffix is implicit and all this will do is slow the regex
processing down even further trying to match the entire (possibly VERY
long) URL against &quot;.*&quot;
 That goes for all places you use regex patterns.


&gt;<i> acl 2 url_regex -i
</I>&gt;<i> ^https?:\/\/.*\.reverbnation\.com\/.*\/(ec_stream_song|download_song_direct|stream_song)\/([0-9]*).*
</I>&gt;<i> acl 2 url_regex -i
</I>&gt;<i> ^https?:\/\/([a-z0-9.]*)(\.doubleclick\.net|\.quantserve\.com|.exoclick\.com|interclick.\com|\.googlesyndication\.com|\.auditude\.com|.visiblemeasures\.com|yieldmanager|cpxinteractive)(.*)
</I>&gt;<i> acl 2 url_regex -i ^https?:\/\/(.*?)\/(ads)\?(.*?)
</I>&gt;<i> acl 2 url_regex -i ^https?:\/\/.*steampowered\.com\/.*\/([0-9]+\/(.*))
</I>&gt;<i> acl 3 url_regex -i
</I>&gt;<i> ^https?:\/\/(.*?)\/speedtest\/.*\.(jpg|txt|png|gif|swf)\?.*
</I>&gt;<i> acl 3 url_regex -i speedtest\/.*\.(jpg|txt|png|gif|swf)\?.*
</I>
Notice that the second line for &quot;3&quot; matches everything the first pattern
does, and a lot more. You can erase the first pattern and save a lot of
CPU without any change in proxy allow/deny permissions.

&gt;<i> acl 4 url_regex -i reverbnation.*audio_player.*ec_stream_song.*$
</I>&gt;<i> acl 5 url_regex -i utm.gif.*
</I>&gt;<i> acl 6 url_regex -i c.android.clients.google.com.market.GetBinary.GetBinary.*
</I>&gt;<i> acl 7 url_regex -i youtube.*(ptracking|stream_204|player_204|gen_204).*$
</I>&gt;<i> acl 7 url_regex -i
</I>&gt;<i> \.c\.(youtube|google)\.com\/(get_video|videoplayback|videoplay).*$
</I>&gt;<i> acl 7 url_regex -i (youtube|google).*\/videoplayback\?.*
</I>&gt;<i> acl 8 http_status 302
</I>&gt;<i> acl getmethod method GET
</I>&gt;<i> 
</I>&gt;<i> ssl_bump splice localhost
</I>&gt;<i> acl 9 at_step SslBump1
</I>&gt;<i> acl 10 at_step SslBump2
</I>&gt;<i> acl 11 at_step SslBump3
</I>&gt;<i> ssl_bump peek 9 all
</I>&gt;<i> ssl_bump bump 10 all
</I>&gt;<i> ssl_bump bump 11 all
</I>
Why the weird numbers?

The &quot;all&quot; on all the above ssl_bump lines are pointless and may be
confusing you.


&gt;<i> 
</I>&gt;<i> sslcrtd_program /usr/lib/squid/ssl_crtd -s /var/lib/squid/ssl_db -M 4MB
</I>&gt;<i> sslcrtd_children 16 startup=1 idle=1
</I>&gt;<i> sslproxy_capath /etc/ssl/certs
</I>&gt;<i> sslproxy_cert_error allow all
</I>
Above prevents Squid from acting on TLS errors. In fact it can cause
some to be hidden which should be fatal to the transaction.


&gt;<i> sslproxy_flags DONT_VERIFY_PEER		#this line fixing www.gmail.com,
</I>
Absolutely No! The above line 'fixes' nothing. All it does is tell Squid
not to bother checking TLS security.

Those problems still exist, still cause other side effects, and are
often breaking things for clients. But you cannot see that because it is
being hidden by the above setting.

 ... and as a bonus (for the bad guys) your proxy can now be hijacked by
a malicious HTTPS server without any hints being given about it happening.


I suspect that whatever is going wrong the crypto activity is part of
it. But without those crypto issues being visible nobody can say for
sure. There are also refresh_pattern issues mentionend below.


&gt;<i> mail.yahoo.com for some errors
</I>&gt;<i> always_direct allow all
</I>
Please remove this. You do not have any cache_peer lines. This setting
was only ever needed for a single Squid-3.2 release over a 2-week
period. That bug was long, long, long ago fixed.


&gt;<i> ssl_unclean_shutdown on
</I>&gt;<i> 
</I>&gt;<i> # STORE ID
</I>&gt;<i> store_id_program /usr/bin/perl /etc/squid/store-id.pl
</I>&gt;<i> store_id_children 10 startup=5 idle=2 concurrency=10
</I>&gt;<i> store_id_access allow 1
</I>&gt;<i> store_id_access allow 2
</I>&gt;<i> store_id_access allow 3
</I>&gt;<i> store_id_access allow 4
</I>&gt;<i> store_id_access allow 5
</I>&gt;<i> store_id_access allow 6
</I>
So if all the 1 thru 6 ACLs are just url_regex patterns. Why bother
having them as separate ACLs? you can list all the patterns in one ACL
and save a lot of CPU cycles and time.


&gt;<i> store_id_access allow 7
</I>&gt;<i> store_miss deny 7 8
</I>&gt;<i> send_hit deny 7 8
</I>
It would be a lot more performant to switch those around. Check 8 then
7. Like so:

  store_miss deny 8 7
  send_hit deny 8 7


&gt;<i> store_id_access deny all
</I>&gt;<i> 
</I>
This should really be up with the other store_id_access lines.


&gt;<i> # TUNNING CACHE
</I>&gt;<i> max_stale 1 years
</I>&gt;<i> vary_ignore_expire on
</I>&gt;<i> shutdown_lifetime 10 seconds
</I>&gt;<i> 
</I>&gt;<i> # REFRESH PATTERN
</I>&gt;<i> refresh_pattern -i https?:\/\/.*\.xx\.fbcdn\.net\/.*\.(jpg|png) 43830 99%
</I>&gt;<i> 259200 override-expire override-lastmod ignore-reload
</I>
Um,

1) override-lastmod is generally a bad idea. It prevents the
Last-Modified header telling Squid that an object as any previous time
since it was updated - this option actively *reduces* the time objects
can be cached.

2) overide-expire should not be used for sites like Facebook which
provide well behaved cacheability headers. Like (1) it actively breaks
caching with often the opposite result to what one wants.

3) ignore-reload is part of why your Browser &quot;refresh&quot; attempts are
failing to do anything at all.

4) override-expire is *shortening* the caching time for these objects.
Facebook actually has pretty good cacheability once you get past the
problem of it all being hidden behind crypto.


&gt;<i> refresh_pattern static\.(xx|ak)\.fbcdn\.net*\.(jpg|gif|png) 241920 99%
</I>&gt;<i> 241920 ignore-reload override-expire ignore-no-store
</I>
5) ignore-no-store is a bad idea. This *forces* private details from one
persons FB profile pages to be delivered to other clients. It exists
only because there are some very badly designed sites abusing the
Cache-Control header. Facebook is *not* one of those sites.


&gt;<i> refresh_pattern ^https?\:\/\/profile\.ak\.fbcdn.net*\.(jpg|gif|png) 241920
</I>&gt;<i> 99% 241920 ignore-reload override-expire ignore-no-store
</I>&gt;<i> refresh_pattern (akamaihd|fbcdn)\.net 14400 99% 518400  ignore-no-store
</I>&gt;<i> ignore-private ignore-reload ignore-must-revalidate store-stale
</I>

6) ignore-private has been made relatively safe in the latest Squid. BUT
the revalidation mechanisms are required for it to be safe at all.
 It is a very bad idea to use with either ignore-reload or
ignore-must-revalidate ... let alone both at once. Security
vulnerabilities will exist as a result of these options used together.

7) store-stale is in a similar position of requiring revalidation /
reload to be possible. But with less severe results - only badly broken
web page display.


These issues caused by (5), (6), and (7) could be at least a part of
what is going wrong. Probably also some other things.


&gt;<i> refresh_pattern (audio|video)\/(webm|mp4) 129600 99% 129600 ignore-reload
</I>&gt;<i> override-expire override-lastmod ignore-must-revalidate  ignore-private
</I>&gt;<i> ignore-no-store ignore-auth store-stale
</I>

Notice that if the earlier FB patterns did not match this makes videos
and audio URLs forced to be immediately stale/expired, forced to be
cached anyway, forced all clients/users to get the same objects, and
then also prohibits anything from updating the cache object if a broken
one gets into cache somehow.

You were saying something about video problems?


The remainder of your refresh_patterns show a lot of repeats of these
issues.

Remember: these options are dangerous. Use with great care. And
understand what the options are doing



&gt;<i> 
</I>&gt;<i> This way i can play the facebook videos, but no caching is done i only get
</I>&gt;<i> TCP_TUNNEL/200
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> http_port 3129 tproxy ssl-bump generate-host-certificates=on
</I>&gt;<i> dynamic_cert_mem_cache_size=4MB cert=/etc/squid/ssl_certs/squid.crt
</I>&gt;<i> key=/etc/squid/ssl_certs/squid.key
</I>&gt;<i> cipher=ECDHE-RSA-RC4-SHA:ECDHE-RSA-AES128-SHA:DHE-RSA-AES128-SHA:DHE-RSA-CAMELLIA128-SHA:AES128-SHA:RC4-SHA:HIGH:!aNULL:!MD5:!ADH
</I>&gt;<i> 
</I>

Do you know what the differences between these two port lines are?

In one the client is aware that the proxy exists and sends details to it
in a CONNECT request.


&gt;<i> 
</I>&gt;<i> And this way i can cache https but cannot play the videos on the facebook at
</I>&gt;<i> all
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> http_port 3128 ssl-bump cert=/etc/squid/ssl_certs/myCA.pem
</I>&gt;<i> generate-host-certificates=on dynamic_cert_mem_cache_size=4MB
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Any ideas or hints on what could be wrong? i am kind of lost now.. any tips
</I>&gt;<i> will be appreciate
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> --
</I>&gt;<i> Sent from: <A HREF="http://squid-web-proxy-cache.1019090.n4.nabble.com/Squid-Users-f1019091.html">http://squid-web-proxy-cache.1019090.n4.nabble.com/Squid-Users-f1019091.html</A>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i> 
</I>
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="020511.html">[squid-users] Squid 3.5 https facebook caching
</A></li>
	<LI>Next message (by thread): <A HREF="020514.html">[squid-users] Squid 3.5 https facebook caching
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20512">[ date ]</a>
              <a href="thread.html#20512">[ thread ]</a>
              <a href="subject.html#20512">[ subject ]</a>
              <a href="author.html#20512">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
