<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid 4.6 &quot;SSL routines:tls_parse_stoc_sct:bad extension&quot;
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%204.6%20%22SSL%20routines%3Atls_parse_stoc_sct%3Abad%0A%20extension%22&In-Reply-To=%3Cd5da4460-1db5-911e-4d1e-77bfb31f903c%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="020506.html">
   <LINK REL="Next"  HREF="020504.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid 4.6 &quot;SSL routines:tls_parse_stoc_sct:bad extension&quot;</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%204.6%20%22SSL%20routines%3Atls_parse_stoc_sct%3Abad%0A%20extension%22&In-Reply-To=%3Cd5da4460-1db5-911e-4d1e-77bfb31f903c%40treenet.co.nz%3E"
       TITLE="[squid-users] Squid 4.6 &quot;SSL routines:tls_parse_stoc_sct:bad extension&quot;">squid3 at treenet.co.nz
       </A><BR>
    <I>Wed Apr 17 21:32:18 UTC 2019</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="020506.html">[squid-users] Squid 4.6 &quot;SSL routines:tls_parse_stoc_sct:bad	extension&quot;
</A></li>
        <LI>Next message (by thread): <A HREF="020504.html">[squid-users] Chrome is not displaying ftp:// directory from squid, it downloads them as an HTML file
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20513">[ date ]</a>
              <a href="thread.html#20513">[ thread ]</a>
              <a href="subject.html#20513">[ subject ]</a>
              <a href="author.html#20513">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 16/04/19 10:34 pm, Christian Schnatz wrote:
&gt;<i> Hi Everyone,
</I>&gt;<i> 
</I>&gt;<i> we&#8217;ve just updated one of our machines to squid 4.6 with openssl 1.1.1 and ran in some strange errors when accessing *.google.com and apple app/itunes store domains. 
</I>&gt;<i> Has anyone else encountered the follow errors and nows how to solve them? Right now clients are unable to browse the apple app store and do get a squid error page when accessing google.com.
</I>&gt;<i> 
</I>&gt;<i> Apr 16 12:17:05 squid[2201]: ERROR: negotiating TLS on FD 202: error:1425F175:SSL routines:ssl_choose_client_version:inappropriate fallback (1/-1/0)
</I>
A 5min web search can be useful.

 &lt;<A HREF="https://security.stackexchange.com/questions/160922/ssl-error-inappropriate-fallback-and-tls-fallback-scsv">https://security.stackexchange.com/questions/160922/ssl-error-inappropriate-fallback-and-tls-fallback-scsv</A>&gt;



&gt;<i> Apr 16 12:17:05 squid[2201]: 1555409825.478    327 172.20.233.28 NONE/200 0 CONNECT 104.31.75.217:443 - ORIGINAL_DST/104.31.75.217 -
</I>&gt;<i> 
</I>&gt;<i> Apr 16 12:17:05 squid[2203]: 1555409825.184  10099 172.20.228.187 NONE_ABORTED/200 0 CONNECT 213.180.141.156:443 - HIER_NONE/- -
</I>&gt;<i> Apr 16 12:17:05 squid[2201]: ERROR: negotiating TLS on FD 873: error:1423406E:SSL routines:tls_parse_stoc_sct:bad extension (1/-1/0)
</I>

Your OpenSSL library does not understand the TLS extension being
received from one endpoint. The client or server, depending on which
step the SSL-Bump process is up to and what your ssl_bump rules say to do.

It is possible that your OpenSSL installation is corrupted, that the
endpoint is using some mandatory avoid TLS/SSL extension that is no
longer supported, that the endpoint is not sending TLS/SSL at all, or a
number of other similar things.


&gt;<i> 
</I>&gt;<i> We are running squid with the following config:
</I>&gt;<i> 
</I>&gt;<i> sslproxy_cert_error allow all
</I>&gt;<i> https_port 3129 ssl-bump intercept connection-auth=off tls-cert=/etc/squid/myCA.pem generate-host-certificates=on dynamic_cert_mem_cache_size=12MB options=ALL
</I>&gt;<i> tls_outgoing_options options=ALL
</I>
The above options enables (or disables) a lot of OpenSL features which
are set with default on/off for very good reasons. Usually because they
cause bad problems if used on general TLS traffic. Things like 0-bit
security keys, nul-ciphers, IE 3 compatibility ciphers, SSLv2 and so on.

If used at all the &quot;ALL&quot; shoudl be followed by a long list of things to
turn off again. Or prefixed with a '!' to disable everything, followed
by a long list of things to turn on. Just by itself is a bad idea.


&gt;<i> tls_outgoing_options flags=DONT_VERIFY_PEER
</I>
This is another even worse idea. It is hiding TLS problems from you.
Serious ones with the security keys and certs.


&gt;<i> tls_outgoing_options default-ca=off
</I>&gt;<i> tls_outgoing_options min-version=1.0
</I>
TLS has no version older than 1.0. So the above line is pointless.

&gt;<i> 
</I>&gt;<i> follow_x_forwarded_for allow all
</I>&gt;<i> logfile_rotate 2
</I>&gt;<i> access_log syslog:LOG_LOCAL0:EMERGENCY squid
</I>&gt;<i> max_filedescriptors 65535
</I>&gt;<i> 
</I>&gt;<i> http_port 3131
</I>&gt;<i> acl localnet src 10.0.0.0/8	# RFC1918 possible internal network
</I>&gt;<i> acl localnet src 172.16.0.0/12	# RFC1918 possible internal network
</I>&gt;<i> acl localnet src 192.168.0.0/16	# RFC1918 possible internal network
</I>&gt;<i> 
</I>&gt;<i> acl SSL_ports port 443
</I>&gt;<i> acl Safe_ports port 80		# http
</I>&gt;<i> acl Safe_ports port 21		# ftp
</I>&gt;<i> acl Safe_ports port 443		# https
</I>&gt;<i> acl Safe_ports port 70		# gopher
</I>&gt;<i> acl Safe_ports port 210		# wais
</I>&gt;<i> acl Safe_ports port 1025-65535	# unregistered ports
</I>&gt;<i> acl Safe_ports port 280		# http-mgmt
</I>&gt;<i> acl Safe_ports port 488		# gss-http
</I>&gt;<i> acl Safe_ports port 591		# filemaker
</I>&gt;<i> acl Safe_ports port 777		# multiling http
</I>&gt;<i> acl CONNECT method CONNECT
</I>&gt;<i> 
</I>&gt;<i> http_access deny !Safe_ports
</I>&gt;<i> http_access deny CONNECT !SSL_ports
</I>&gt;<i> http_access allow localhost manager
</I>&gt;<i> http_access deny manager
</I>&gt;<i> http_access allow localnet
</I>&gt;<i> http_access allow localhost
</I>&gt;<i> http_access deny all
</I>&gt;<i> http_port 3128 transparent
</I>
&quot;transparent&quot; is a long ago deprecated option. It was replaced by
&quot;intercept&quot; to avoid confusion with transparent proxy options that do
*actual* transparency.


&gt;<i> #debug_options ALL,9
</I>&gt;<i> coredump_dir /var/spool/squid
</I>&gt;<i> url_rewrite_program /usr/bin/cf_plugin
</I>&gt;<i> url_rewrite_extras &quot;%ssl::&gt;sni %&gt;a %et&quot;
</I>&gt;<i> 
</I>&gt;<i> refresh_pattern ^ftp:		1440	20%	10080
</I>&gt;<i> refresh_pattern ^gopher:	1440	0%	1440
</I>&gt;<i> refresh_pattern -i (/cgi-bin/|\?) 0	0%	0
</I>&gt;<i> refresh_pattern (Release|Packages(.gz)*)$      0       20%     2880
</I>&gt;<i> refresh_pattern .		0	20%	4320
</I>&gt;<i> 
</I>&gt;<i> cache deny all
</I>&gt;<i> cache_log /dev/null
</I>
Another bad idea. This can lead to /dev/null being moved to /dev/null.0
and a file put at /dev/null . Imagine the machine disks over-filling
with infinite amounts of crap from every application and script ever
running.
 Use &quot;debug_options ALL,0&quot; to minimize cache.log output.


&gt;<i> logfile_rotate 0
</I>&gt;<i> 
</I>&gt;<i> sslproxy_session_cache_size 0 MB
</I>&gt;<i> 
</I>&gt;<i> acl ssl_step1 at_step SslBump1
</I>&gt;<i> acl ssl_step2 at_step SslBump2
</I>&gt;<i> acl ssl_step3 at_step SslBump3
</I>&gt;<i> 
</I>&gt;<i> external_acl_type bump_check children-max=10 %URI %ssl::&gt;sni %&gt;a %et /usr/bin/cf_plugin -b
</I>&gt;<i> acl cf_allows external bump_check
</I>&gt;<i> 
</I>&gt;<i> ssl_bump peek ssl_step1 all
</I>&gt;<i> always_direct allow all
</I>
You do not have any cache_peer's.  This always_direct is not useful in
any way. Please remove.

&gt;<i> ssl_bump peek ssl_step2 cf_allows
</I>&gt;<i> ssl_bump bump ssl_step3 all
</I>&gt;<i> ssl_bump stare ssl_step2 !cf_allows
</I>&gt;<i> ssl_bump splice ssl_step3 cf_allows
</I>&gt;<i> ssl_bump bump ssl_step3 !cf_allows
</I>
The above lines should never be reachable. There is already a bump rule
that matches step3. If that rule is not possible, then this one cannot
be either.


&gt;<i> 
</I>&gt;<i> Our main usage is to extract the SNI or IP from the SSL Request, forward it to cf_plugin and do some magic to decide wether this request should be blocked or not.
</I>&gt;<i> 
</I>
At no point do these ssl_bump rules block anything. In fact they do the
opposite.

They decide whether to allow unconditional tunnel through the proxy
(splice) or whether to decrypt and let the rest of the proxy do things
to the traffic (bump).

The other access rules in your proxy just allow if anything ecrypted
comes from a localnet client. So nothing in the way of blocking based on
SNI, URL domain or such ever happens.


HTH
Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="020506.html">[squid-users] Squid 4.6 &quot;SSL routines:tls_parse_stoc_sct:bad	extension&quot;
</A></li>
	<LI>Next message (by thread): <A HREF="020504.html">[squid-users] Chrome is not displaying ftp:// directory from squid, it downloads them as an HTML file
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20513">[ date ]</a>
              <a href="thread.html#20513">[ thread ]</a>
              <a href="subject.html#20513">[ subject ]</a>
              <a href="author.html#20513">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
