<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid 4.6 cannot open 2 other popular domains with SSL bump
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%204.6%20cannot%20open%202%20other%20popular%20domains%0A%20with%20SSL%20bump&In-Reply-To=%3C113fe037-50f1-5f8d-6be1-76767579504b%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="020516.html">
   <LINK REL="Next"  HREF="020523.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid 4.6 cannot open 2 other popular domains with SSL bump</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%204.6%20cannot%20open%202%20other%20popular%20domains%0A%20with%20SSL%20bump&In-Reply-To=%3C113fe037-50f1-5f8d-6be1-76767579504b%40treenet.co.nz%3E"
       TITLE="[squid-users] Squid 4.6 cannot open 2 other popular domains with SSL bump">squid3 at treenet.co.nz
       </A><BR>
    <I>Thu Apr 18 10:32:23 UTC 2019</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="020516.html">[squid-users] Squid 4.6 cannot open 2 other popular domains with	SSL bump
</A></li>
        <LI>Next message (by thread): <A HREF="020523.html">[squid-users] squid-users Digest, Vol 56, Issue 32
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20517">[ date ]</a>
              <a href="thread.html#20517">[ thread ]</a>
              <a href="subject.html#20517">[ subject ]</a>
              <a href="author.html#20517">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 18/04/19 9:26 pm, <A HREF="https://lists.squid-cache.org/listinfo/squid-users">info at schroeffu.ch</A> wrote:
&gt;<i> Hi Squid Users,
</I>&gt;<i> 
</I>&gt;<i> with Squid 4.6 I cannot open these 2 domains when SSL bump is enabled:
</I>&gt;<i> 
</I>&gt;<i> <A HREF="https://www.hays.de">https://www.hays.de</A>
</I>&gt;<i> <A HREF="https://www.plantronics.com">https://www.plantronics.com</A>
</I>&gt;<i> 
</I>&gt;<i> Both are showing me a different type of error, details below.
</I>&gt;<i> I could not find any HPKP site or subdomain there, so I guess Squid has
</I>&gt;<i> another problem with this domains.
</I>&gt;<i> Can somebody explain me how I should debug that correctly, to open a
</I>&gt;<i> bugreport?
</I>&gt;<i> 
</I>&gt;<i> ### Bump Settings:
</I>&gt;<i> 
</I>&gt;<i> acl domains_dont_sslbump ssl::server_name_regex
</I>&gt;<i> &quot;/etc/squid/ka/domains_dont_sslbump.acl&quot;
</I>&gt;<i> acl domains_dont_sslbump ssl::server_name_regex
</I>&gt;<i> &quot;/etc/squid/blacklists/blacklist_ut1/blacklists/bank/domains&quot;
</I>&gt;<i> acl domains_dont_sslbump ssl::server_name_regex
</I>&gt;<i> &quot;/etc/squid/blacklists/blacklist_shallalist/BL/finance/banking/domains&quot;
</I>&gt;<i> acl domains_dont_sslbump ssl::server_name_regex
</I>&gt;<i> &quot;/etc/squid/blacklists/blacklist_shallalist/BL/finance/other/domains&quot;
</I>&gt;<i> 
</I>&gt;<i> http_port proxy02:8080 ssl-bump generate-host-certificates=on
</I>&gt;<i> dynamic_cert_mem_cache_size=4MB cert=/etc/squid/certs/cert.pem
</I>&gt;<i> key=/etc/squid/certs/key.ohnersa.pem
</I>&gt;<i> sslcrtd_program /usr/lib/squid/security_file_certgen -s /var/lib/ssl_db
</I>&gt;<i> -M 4MB
</I>&gt;<i> always_direct allow all
</I>
You are no longer using an experimental patch on Squid-3.2. If you ever
did. This config hack to work around a very short lived / temporary bug
in SSL-Bump behaviour has not been necessary for many years.


&gt;<i> acl step1 at_step SslBump1
</I>&gt;<i> ssl_bump peek step1
</I>&gt;<i> ssl_bump bump all !domains_dont_sslbump
</I>&gt;<i> 
</I>&gt;<i> #### hays.de:
</I>&gt;<i> 1555577795.968 1 172.16.x.x TCP_DENIED/407 4995 GET <A HREF="http://hays.de/">http://hays.de/</A> -
</I>&gt;<i> HIER_NONE/- text/html
</I>&gt;<i> 1555577796.067 63 172.16.x.x TCP_MISS/301 465 GET <A HREF="http://hays.de/">http://hays.de/</A> user1
</I>&gt;<i> HIER_DIRECT/149.126.72.70 -
</I>&gt;<i> 1555577796.083 0 172.16.x.x TCP_DENIED/407 4124 CONNECT hays.de:443 -
</I>&gt;<i> HIER_NONE/- text/html
</I>&gt;<i> 1555577796.101 1 172.16.x.x TCP_DENIED/407 4460 CONNECT hays.de:443 -
</I>&gt;<i> HIER_NONE/- text/html
</I>&gt;<i> 1555577796.202 86 172.16.x.x NONE/200 0 CONNECT hays.de:443 user1
</I>&gt;<i> HIER_DIRECT/149.126.72.70 -
</I>&gt;<i> 1555577796.302 15 172.16.x.x TCP_MISS/301 345 GET <A HREF="https://hays.de/">https://hays.de/</A> user1
</I>&gt;<i> HIER_DIRECT/149.126.72.70 -
</I>&gt;<i> 1555577796.320 0 172.16.x.x TCP_DENIED/407 4140 CONNECT www.hays.de:443
</I>&gt;<i> - HIER_NONE/- text/html
</I>&gt;<i> 1555577796.333 1 172.16.x.x TCP_DENIED/407 4476 CONNECT www.hays.de:443
</I>&gt;<i> - HIER_NONE/- text/html
</I>&gt;<i> 1555577796.507 158 172.16.x.x NONE/200 0 CONNECT www.hays.de:443 user1
</I>&gt;<i> HIER_DIRECT/149.126.77.70 -
</I>&gt;<i> 1555577796.602 30 172.16.x.x TCP_MISS_ABORTED/000 0 GET
</I>&gt;<i> <A HREF="https://www.hays.de/">https://www.hays.de/</A> user1 HIER_DIRECT/149.126.77.70 -
</I>&gt;<i> 
</I>&gt;<i> Error displayed on <A HREF="https://www.hays.de">https://www.hays.de</A> (from the Browser Chrome/or Firefox):
</I>&gt;<i> 
</I>&gt;<i> Chrome: ERR_EMPTY_RESPONSE
</I>&gt;<i> Firefox: Secure Connection Failed // An error occurred during a
</I>&gt;<i> connection to www.hays.de. // The page you are trying to view cannot be
</I>&gt;<i> shown because the authenticity of the received data could not be
</I>&gt;<i> verified. // Please contact the website owners to inform them of this
</I>&gt;<i> problem.
</I>&gt;<i> 
</I>&gt;<i> Header Response while this error message is displayed:
</I>&gt;<i> 
</I>&gt;<i> HTTP/1.1 200 Connection established
</I>&gt;<i> Server: squid
</I>&gt;<i> Mime-Version: 1.0
</I>&gt;<i> Date: Thu, 18 Apr 2019 09:05:28 GMT
</I>&gt;<i> Content-Type: text/html;charset=utf-8
</I>&gt;<i> Content-Length: 3759
</I>&gt;<i> X-Squid-Error: ERR_CACHE_ACCESS_DENIED 0
</I>&gt;<i> Proxy-Authenticate: NTLM VNTUAACAAAADAAMAD(...)
</I>&gt;<i> X-Cache: MISS from proxy02
</I>&gt;<i> X-Cache-Lookup: NONE from proxy02:8080
</I>&gt;<i> Via: 1.1 proxy02 (squid)
</I>&gt;<i> Connection: keep-alive
</I>
This is the plain-text message in response to the client CONNECT
request. All it does is tell the Browser that the proxy has given is a
TCP connection (er tunnel) to the origin and it can start the TLS
handshakes.

The 'empty response' Chrome is mentioning is what follows the TLS
handshake, which itself follows the above plain-text headers. If the TLS
fails for any reason there will be no such response.
 So this is Chrome willfully hiding TLS errors from the user while
taking the opportunity to blame the proxy for those failures it has
exchanging TLS with the _origin_ server.


Note that all out SSL-Bump related documentation states that &quot;when used
properly TLS cannot be bumped&quot;. Specifically the X.509 server
certificate cannot be forced to be trusted by the clients. If they are
aware (via a number of other means) what that certificate should look
like they *will* reject Squids generated (forged) server cert.
 Good luck finding out whether that is the case though. Browser people
like to hide such details from us all.
 Try to perform these HTTPS transactions without using a Browser. That
should make it clearer what the issue is, and in which piece of software
(Browser, Squid, OpenSSL, or origin server).


The other common alternative is that these sites TLS is suddenly broken.
Test if traffic works without the proxy. Preferably with a tool that can
show you the TLS handshake particulars.


&gt;<i> 
</I>&gt;<i> #### plantronics.com
</I>&gt;<i> 1555577912.476 391 172.16.x.x TCP_MISS/301 869 GET
</I>&gt;<i> <A HREF="http://plantronics.com/">http://plantronics.com/</A> user1 HIER_DIRECT/198.231.10.19 text/html
</I>&gt;<i> 1555577912.514 0 172.16.x.x TCP_DENIED/407 4172 CONNECT
</I>&gt;<i> www.plantronics.com:443 - HIER_NONE/- text/html
</I>&gt;<i> 1555577912.529 1 172.16.x.x TCP_DENIED/407 4508 CONNECT
</I>&gt;<i> www.plantronics.com:443 - HIER_NONE/- text/html
</I>&gt;<i> 1555577912.864 324 172.16.x.x NONE/200 0 CONNECT www.plantronics.com:443
</I>&gt;<i> user1 HIER_DIRECT/54.192.94.216 -
</I>&gt;<i> 1555577913.564 521 172.16.x.x TCP_MISS/403 745 GET
</I>&gt;<i> <A HREF="https://www.plantronics.com/">https://www.plantronics.com/</A> user1 HIER_DIRECT/54.192.94.216 text/html
</I>&gt;<i> 
</I>&gt;<i> Error displayed on frontpage <A HREF="https://www.plantronics.com">https://www.plantronics.com</A> (from their
</I>&gt;<i> Apache or Nginx):
</I>&gt;<i> 
</I>&gt;<i> Forbidden
</I>&gt;<i> You don't have permission to access /.noindex.html on this server.
</I>&gt;<i> 
</I>
Notice that this is a page generated by *their* server. Your proxy is
successfully decrypting the traffic. Their server is not happy or
understanding the HTTPS requests arriving after that.

Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="020516.html">[squid-users] Squid 4.6 cannot open 2 other popular domains with	SSL bump
</A></li>
	<LI>Next message (by thread): <A HREF="020523.html">[squid-users] squid-users Digest, Vol 56, Issue 32
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20517">[ date ]</a>
              <a href="thread.html#20517">[ thread ]</a>
              <a href="subject.html#20517">[ subject ]</a>
              <a href="author.html#20517">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
