<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Sibling cache_peer inside docker containers
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Sibling%20cache_peer%20inside%20docker%20containers&In-Reply-To=%3Cd34cb012-cc9c-8368-6c3f-4c46fc6bc4cd%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="020529.html">
   <LINK REL="Next"  HREF="020540.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Sibling cache_peer inside docker containers</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Sibling%20cache_peer%20inside%20docker%20containers&In-Reply-To=%3Cd34cb012-cc9c-8368-6c3f-4c46fc6bc4cd%40treenet.co.nz%3E"
       TITLE="[squid-users] Sibling cache_peer inside docker containers">squid3 at treenet.co.nz
       </A><BR>
    <I>Fri Apr 26 12:39:18 UTC 2019</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="020529.html">[squid-users] Sibling cache_peer inside docker containers
</A></li>
        <LI>Next message (by thread): <A HREF="020540.html">[squid-users] Sibling cache_peer inside docker containers
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20530">[ date ]</a>
              <a href="thread.html#20530">[ thread ]</a>
              <a href="subject.html#20530">[ subject ]</a>
              <a href="author.html#20530">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 26/04/19 12:00 pm, interwebbot wrote:
&gt;<i> I have 2 squid instances running inside docker containers on the same host. I
</I>&gt;<i> am trying to set these two instances as cache_peer siblings for storage
</I>&gt;<i> optimization. Here is the config I am using:
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> http_port 3128
</I>&gt;<i> 
</I>&gt;<i> acl localnet src 10.0.0.0/8     # RFC1918 possible internal network
</I>&gt;<i> acl localnet src 172.16.0.0/12  # RFC1918 possible internal network
</I>&gt;<i> acl localnet src 192.168.0.0/16 # RFC1918 possible internal network
</I>&gt;<i> acl localnet src fc00::/7       # RFC 4193 local private network range
</I>&gt;<i> acl localnet src fe80::/10      # RFC 4291 link-local (directly plugged)
</I>&gt;<i> machines
</I>&gt;<i> acl squid-(1/2)  src 172.17.0.(2/3)
</I>

Is this above what you actually have in the config file?
 or a (x/y) syntax you made up to represent each of the config files
having similar but not identical entries:

 acl squid-1  src 172.17.0.2
 acl squid-2  src 172.17.0.3

There are places where you should have different values but do not use
this syntax. So it is not clear if those were mistakes in the config or
mistakes in the email. Please show exactly what is in each config file
respective to these lines and the cache_peer lines.


Notice that these 172.17.0.* are matched by the localnet 172.16.0.0/12
CIR range. That means the &quot;allow localnet&quot; rule will be allowing traffic
and your &quot;allow squid-2&quot; rule is never reached.

...
&gt;<i> #
</I>&gt;<i> # INSERT YOUR OWN RULE(S) HERE TO ALLOW ACCESS FROM YOUR CLIENTS
</I>&gt;<i> #
</I>&gt;<i> 
</I>&gt;<i> http_access allow localnet
</I>&gt;<i> http_access allow localhost
</I>&gt;<i> http_access allow squid-2
</I>&gt;<i> http_access deny all
</I>&gt;<i> 
</I>&gt;<i> coredump_dir /squid/var/cache/squid
</I>&gt;<i> 
</I>&gt;<i> icp_port 3130
</I>&gt;<i> cache_peer 172.17.0.(2/3) sibling 3128 3130 default #proxy-only
</I>
&quot;default&quot; is only relevant when there are multiple peers to choose from
and the first is not the preferred default, or a second selection
algorithms is being used.


&gt;<i> prefer_direct off
</I>&gt;<i> icp_access allow all
</I>&gt;<i> icp_query_timeout 500
</I>&gt;<i> debug_options ALL,1 12,5 42,3
</I>&gt;<i> 
</I>&gt;<i> refresh_pattern ^ftp:           1440    20%     10080
</I>&gt;<i> refresh_pattern ^gopher:        1440    0%      1440
</I>&gt;<i> refresh_pattern -i (/cgi-bin/|\?) 0     0%      0
</I>&gt;<i> refresh_pattern .               0       20%     4320
</I>&gt;<i> 
</I>&gt;<i> cache_store_log /var/log/squid/store.log
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> To test if this is working, I am trying the following test:
</I>&gt;<i>  &gt; curl -x <A HREF="http://127.0.0.1:3131">http://127.0.0.1:3131</A> -L <A HREF="http://example.com">http://example.com</A> (this results in a
</I>&gt;<i> MISS from squid-1 as expected)
</I>&gt;<i>  &gt; curl -x <A HREF="http://127.0.0.1:3131">http://127.0.0.1:3131</A> -L <A HREF="http://example.com">http://example.com</A> (this results in a
</I>&gt;<i> HIT from squid-1 as expected)
</I>&gt;<i> 
</I>&gt;<i>  &gt; curl -x <A HREF="http://127.0.0.1:3132">http://127.0.0.1:3132</A> -L <A HREF="http://example.com">http://example.com</A> (this results in a
</I>&gt;<i> MISS from squid-2. NOT EXPECTED)
</I>&gt;<i> 
</I>

The Squid.conf you presented does not contain any http_port 3131 or
3132. How is the traffic getting from these to the 3128 Squid is opening?
 Also are both logging that their 3128 listening attempt was successful?


The details you are presenting are not clear and definitive about what
is going on.


&gt;<i> Am I correct in assuming that last curl should result in a HIT instead of
</I>&gt;<i> MISS? 
</I>
Unknown. Which proxy is receiving the traffic from curl?

Which peer is receiving the 3130 UDP traffic?
 Is that a different port on each peer which you forgot to mention?

Is the &quot;proxy-only&quot; flag disabled in both configs?
 Best erase it entirely than rely on the &quot;#&quot; handling. The # behaviour
is not consistent with all directives.


Please be aware that both caches start off is a &quot;cold&quot; state with no
content including knowledge about other caches/peer contents or RTT
network properties. The first request(s) through them trigger a probe to
get better info and log as MISS - but waiting for that probe to produce
data can mean DIRECT connection is more efficient for that request.

The *second* request through is what should be expected to choose
best-path with details to optimize the choice of &quot;best&quot;. In this case
the local cache produces a HIT - which is better than any network path
and can hide the RTT sibling lookup behaviours.


(Details like these are why its often best to show both configs, even if
they have a lot of overlap).


&gt;<i> If yes, what is wrong with my config?
</I>&gt;<i> 
</I>
Any answer would have to be based more on assumptions about what you
mean than the details provided so far.

Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="020529.html">[squid-users] Sibling cache_peer inside docker containers
</A></li>
	<LI>Next message (by thread): <A HREF="020540.html">[squid-users] Sibling cache_peer inside docker containers
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20530">[ date ]</a>
              <a href="thread.html#20530">[ thread ]</a>
              <a href="subject.html#20530">[ subject ]</a>
              <a href="author.html#20530">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
