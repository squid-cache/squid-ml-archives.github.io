<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Problems with squid 3.1 to 3.3 upgrade
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Problems%20with%20squid%203.1%20to%203.3%20upgrade&In-Reply-To=%3Ca68e3318-022e-8211-4417-e826d0ca9741%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="020868.html">
   <LINK REL="Next"  HREF="020871.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Problems with squid 3.1 to 3.3 upgrade</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Problems%20with%20squid%203.1%20to%203.3%20upgrade&In-Reply-To=%3Ca68e3318-022e-8211-4417-e826d0ca9741%40treenet.co.nz%3E"
       TITLE="[squid-users] Problems with squid 3.1 to 3.3 upgrade">squid3 at treenet.co.nz
       </A><BR>
    <I>Sat Aug 10 06:47:23 UTC 2019</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="020868.html">[squid-users] Problems with squid 3.1 to 3.3 upgrade
</A></li>
        <LI>Next message (by thread): <A HREF="020871.html">[squid-users] Problems with squid 3.1 to 3.3 upgrade
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20869">[ date ]</a>
              <a href="thread.html#20869">[ thread ]</a>
              <a href="subject.html#20869">[ subject ]</a>
              <a href="author.html#20869">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 10/08/19 8:32 am, Tom Karches wrote:
&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> On Fri, Aug 9, 2019 at 2:37 PM Alex Rousskov wrote:
</I>&gt;<i> 
</I>&gt;<i>     On 8/9/19 1:37 PM, Tom Karches wrote:
</I>&gt;<i>     &gt; On Fri, Aug 9, 2019 at 11:38 AM Alex Rousskov wrote:
</I>&gt;<i> 
</I>&gt;<i>     &gt; Ok, here is the info from the real trace. First time with
</I>&gt;<i>     #dns_v4_first
</I>&gt;<i>     &gt; on&#160; commented out, 2nd time &quot;dns_v4_ first on&quot; is active.
</I>&gt;<i>     Difference is
</I>&gt;<i>     &gt; with no &quot;dns_v4_first on&quot; directive, I get a RR_CONNECT_FAIL 111. When
</I>&gt;<i>     &gt; active, I get a RR_CONNECT_FAIL 101.
</I>&gt;<i> 
</I>&gt;<i>     BTW, it may be easier for you to read --trace--ascii output.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> I didn't see anything additional using the ascii option, though it is
</I>&gt;<i> easier to read
</I>&gt;<i> &#160;
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i>     Both are ERR_CONNECT_FAIL errors (&quot;connection reset by peer&quot; and
</I>&gt;<i>     &quot;connection refused&quot;). Your Squid cannot connect to where it needs to
</I>&gt;<i>     connect in order to establish a TCP tunnel. It could be a Squid
</I>&gt;<i>     misconfiguration, a routing problem, insufficient capabilities, and many
</I>&gt;<i>     other things.
</I>&gt;<i> 
</I>&gt;<i>     I suggest checking cache.log for WARNINGs and ERRORs. After arriving at
</I>&gt;<i>     a clean cache.log, I would use a packet capture (or similar) to see
</I>&gt;<i>     where Squid is trying to connect (and which local address it is
</I>&gt;<i>     connecting from). That information may be enough to figure out why Squid
</I>&gt;<i>     cannot connect successfully.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> This is what I am seeing from cache.log when I attempt the proxy :
</I>&gt;<i> 
</I>&gt;<i> &#160;
</I>&gt;<i> 
</I>&gt;<i> 2019/08/09 16:19:08.127 kid1| 33,2| client_side.cc(817) swanSong:
</I>&gt;<i> local=127.0.0.1:3128 &lt;<A HREF="http://127.0.0.1:3128">http://127.0.0.1:3128</A>&gt; remote=127.0.0.1:33428
</I>&gt;<i> &lt;<A HREF="http://127.0.0.1:33428">http://127.0.0.1:33428</A>&gt; flags=1
</I>&gt;<i> 
</I>&gt;<i> 2019/08/09 16:19:10.051 kid1| 33,2| client_side.cc(817) swanSong:
</I>&gt;<i> local=152.7.114.135:3128 &lt;<A HREF="http://152.7.114.135:3128">http://152.7.114.135:3128</A>&gt;
</I>&gt;<i> remote=10.50.54.21:43198 &lt;<A HREF="http://10.50.54.21:43198">http://10.50.54.21:43198</A>&gt; flags=1
</I>&gt;<i> 
</I>&gt;<i> Right now my debug is set to&#160;ALL,1 33,2. Is there a better set of
</I>&gt;<i> options to provide me more visibility of what might be wrong?
</I>&gt;<i> 
</I>
11,2 will show the HTTP message headers.

44,2 will show the servers Squid is finding as possible destinations for
the request/tunnel.

5,6 should show the TCP connection attempts activity by Squid.


If it is not clear from that, those should give you hints about lines to
look for (skip to) for searching a much larger ALL,6 trace.


&gt;<i> Here is our config file, in case that helps. If it's something obvious
</I>&gt;<i> I'm not seeing. We have some whitelists, but I am running with those
</I>&gt;<i> turned off until this is working so I won't include them here. Thanks
</I>&gt;<i> for the help.
</I>&gt;<i> 
</I>

Few bits of polish. But nothing visible there to indicate what your
problem might be.

I think it is probably a firewall or routing problem for the traffic
leaving the proxy machine.


&gt;<i> Tom
</I>&gt;<i> 
</I>&gt;<i> # squid config file - 2019-08-09
</I>&gt;<i> # Timeouts
</I>&gt;<i> connect_timeout 2 minutes &#160;# For CDWG Vendor
</I>&gt;<i> debug_options ALL,1 33,2
</I>&gt;<i> 
</I>&gt;<i> dns_v4_first on
</I>&gt;<i> 
</I>&gt;<i> acl SSL_ports port 443
</I>&gt;<i> acl SSL_ports port 1443 &#160; &#160; # b2b-test.apple.com:1443
</I>&gt;<i> &lt;<A HREF="http://b2b-test.apple.com:1443">http://b2b-test.apple.com:1443</A>&gt;
</I>&gt;<i> acl SSL_ports port 3079 &#160; &#160; # bci.stapleslink.com
</I>&gt;<i> &lt;<A HREF="http://bci.stapleslink.com">http://bci.stapleslink.com</A>&gt; special port
</I>&gt;<i> acl SSL_ports port 4443 &#160; &#160; # pascal.apple.com:4443
</I>&gt;<i> &lt;<A HREF="http://pascal.apple.com:4443">http://pascal.apple.com:4443</A>&gt;
</I>&gt;<i> acl SSL_ports port 993 &#160; &#160; &#160;# IMAP from Stat application to Gmail
</I>&gt;<i> acl SSL_ports port 22 &#160; &#160; &#160; # Allow SSH and SFTP to proxy/connect
</I>&gt;<i> acl SSL_ports port 8443 &#160; &#160; # redhat cap port
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> acl Safe_ports port 80 &#160; &#160; &#160; &#160; &#160;# http
</I>&gt;<i> acl Safe_ports port 21 &#160; &#160; &#160; &#160; &#160;# ftp
</I>&gt;<i> acl Safe_ports port 443 &#160; &#160; &#160; &#160; # https
</I>&gt;<i> acl Safe_ports port 70 &#160; &#160; &#160; &#160; &#160;# gopher
</I>&gt;<i> acl Safe_ports port 210 &#160; &#160; &#160; &#160; # wais
</I>&gt;<i> acl Safe_ports port 1025-65535 &#160;# unregistered ports
</I>&gt;<i> acl Safe_ports port 280 &#160; &#160; &#160; &#160; # http-mgmt
</I>&gt;<i> acl Safe_ports port 488 &#160; &#160; &#160; &#160; # gss-http
</I>&gt;<i> acl Safe_ports port 591 &#160; &#160; &#160; &#160; # filemaker
</I>&gt;<i> acl Safe_ports port 777 &#160; &#160; &#160; &#160; # multiling http
</I>
The ports below are all included in the 1024-65535 range. No need to
list them explicitly here.


&gt;<i> acl Safe_ports port 5228 &#160; &#160; &#160; &#160;# google services
</I>&gt;<i> acl Safe_ports port 1935 &#160; &#160; &#160; &#160;# cam steamer port
</I>&gt;<i> acl Safe_ports port 8443 &#160; &#160; &#160; &#160;# redhat cap port
</I>&gt;<i> acl CONNECT method CONNECT
</I>&gt;<i> 
</I>&gt;<i> #
</I>&gt;<i> # Recommended minimum Access Permission configuration:
</I>&gt;<i> #
</I>&gt;<i> # Only allow cachemgr access from localhost
</I>&gt;<i> http_access allow manager localhost
</I>&gt;<i> http_access deny manager
</I>&gt;<i> 
</I>
Latest Squid recommendation is to have these manager lines after the
CONNECT !SSL_ports line.


&gt;<i> # Deny requests to certain unsafe ports
</I>&gt;<i> http_access deny !Safe_ports
</I>&gt;<i> 
</I>&gt;<i> # Deny CONNECT to other than secure SSL ports
</I>&gt;<i> http_access deny CONNECT !SSL_ports
</I>&gt;<i> 
</I>&gt;<i> # We strongly recommend the following be uncommented to protect innocent
</I>&gt;<i> # web applications running on the proxy server who think the only
</I>&gt;<i> # one who can access services on &quot;localhost&quot; is a local user
</I>&gt;<i> #http_access deny to_localhost
</I>&gt;<i> 
</I>&gt;<i> #
</I>&gt;<i> # INSERT YOUR OWN RULE(S) HERE TO ALLOW ACCESS FROM YOUR CLIENTS
</I>&gt;<i> #
</I>&gt;<i> 
</I>&gt;<i> # Example rule allowing access from your local networks.
</I>&gt;<i> # Adapt localnet in the ACL section to list your (internal) IP networks
</I>&gt;<i> # from where browsing should be allowed
</I>&gt;<i> http_access allow localnet
</I>&gt;<i> http_access allow localhost
</I>&gt;<i> 
</I>&gt;<i> # And finally deny all other access to this proxy
</I>&gt;<i> http_access deny all
</I>&gt;<i> 
</I>&gt;<i> icp_access deny all
</I>
ICP is off by default in modern Squid. No need for the above deny.
&gt;<i> 
</I>&gt;<i> # Squid normally listens to port 3128
</I>&gt;<i> http_port 3128
</I>&gt;<i> 
</I>&gt;<i> # Uncomment and adjust the following to add a disk cache directory.
</I>&gt;<i> #cache_dir ufs /var/spool/squid 2048 16 256
</I>&gt;<i> 
</I>&gt;<i> # Default configuration value for cache_mem
</I>&gt;<i> #cache_mem 256 MB
</I>&gt;<i> cache deny all
</I>&gt;<i> 
</I>&gt;<i> # Leave coredumps in the first cache dir
</I>&gt;<i> coredump_dir /var/spool/squid
</I>&gt;<i> 
</I>&gt;<i> # Add any of your own refresh_pattern entries above these.
</I>&gt;<i> refresh_pattern ^ftp: &#160; &#160; &#160; &#160; &#160; 1440 &#160; &#160;20% &#160; &#160; 10080
</I>&gt;<i> refresh_pattern ^gopher: &#160; &#160; &#160; &#160;1440 &#160; &#160;0% &#160; &#160; &#160;1440
</I>&gt;<i> refresh_pattern -i (/cgi-bin/|\?) 0 &#160; &#160; 0% &#160; &#160; &#160;0
</I>&gt;<i> refresh_pattern . &#160; &#160; &#160; &#160; &#160; &#160; &#160; 0 &#160; &#160; &#160; 20% &#160; &#160; 4320
</I>&gt;<i> 
</I>&gt;<i> max_filedescriptors 65000
</I>&gt;<i> 
</I>&gt;<i> -- 
</I>&gt;<i> Thomas Karches
</I>&gt;<i> NCSU OIT CSI -&#160;Systems Specialist
</I>&gt;<i> M.E Student - Technology Education
</I>&gt;<i> Hillsborough 319 / 919.515.5508
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i> 
</I>
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="020868.html">[squid-users] Problems with squid 3.1 to 3.3 upgrade
</A></li>
	<LI>Next message (by thread): <A HREF="020871.html">[squid-users] Problems with squid 3.1 to 3.3 upgrade
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20869">[ date ]</a>
              <a href="thread.html#20869">[ thread ]</a>
              <a href="subject.html#20869">[ subject ]</a>
              <a href="author.html#20869">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
