<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] HAProxy + Squid
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20HAProxy%20%2B%20Squid&In-Reply-To=%3C2209db35-4616-7b8f-dd81-8d4d45c9a59d%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="020895.html">
   <LINK REL="Next"  HREF="020859.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] HAProxy + Squid</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20HAProxy%20%2B%20Squid&In-Reply-To=%3C2209db35-4616-7b8f-dd81-8d4d45c9a59d%40treenet.co.nz%3E"
       TITLE="[squid-users] HAProxy + Squid">squid3 at treenet.co.nz
       </A><BR>
    <I>Fri Aug 16 07:18:08 UTC 2019</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="020895.html">[squid-users] HAProxy + Squid
</A></li>
        <LI>Next message (by thread): <A HREF="020859.html">[squid-users] acl src question
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20896">[ date ]</a>
              <a href="thread.html#20896">[ thread ]</a>
              <a href="subject.html#20896">[ subject ]</a>
              <a href="author.html#20896">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 16/08/19 8:46 am, Service MV wrote:
&gt;<i> Thank you, Amos. Taking into account your and Rafael's recommendations,
</I>&gt;<i> I configured HAProxy and Squid to use the PROXY protocol instead of
</I>&gt;<i> reformatting the messages.
</I>&gt;<i> At the moment I disabled authentication, due to internal requirements.
</I>&gt;<i> I had a hard time dealing with the HAProxy health checks, but I was able
</I>&gt;<i> to fix it.
</I>&gt;<i> However, by configuring Squid in this way, I had a last problem that I
</I>&gt;<i> didn't expect:
</I>&gt;<i> Squid reports the client's IP to my internet gateway instead of their
</I>&gt;<i> own IP.
</I>
Your Squid should be using its own machines default IP to connect at the
TCP level, and you have &quot;forwarded_for off&quot; already to prevent it adding
the X-Forwarded-For header.

Maybe HAProxy is adding it to the headers still. But I do not see the
config option that is supposed to need in your haproxy.cnf

Maybe the server is getting the info some other way directly from the
client?


&gt;<i> 
</I>&gt;<i> squid.conf
</I>&gt;<i> acl localnet src 192.168.12.1-192.168.13.254# my clients IP's
</I>&gt;<i> acl localnet src 192.168.11.80# haproxy IP
</I>&gt;<i> 
</I>...

&gt;<i> # implementation of core access policies
</I>&gt;<i> proxy_protocol_access allow localnet
</I>
Careful. Since localnet includes your client IPs this means clients can
connect directly to Squid and send forged PROXY details.

You should have another src ACL that matches only the HAProxy IP. Use
that here.

...
&gt;<i> forwarded_for off
</I>&gt;<i> 
</I>

Either &quot;transparent&quot; or &quot;delete&quot; would seem to suite your needs better here.


Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="020895.html">[squid-users] HAProxy + Squid
</A></li>
	<LI>Next message (by thread): <A HREF="020859.html">[squid-users] acl src question
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20896">[ date ]</a>
              <a href="thread.html#20896">[ thread ]</a>
              <a href="subject.html#20896">[ subject ]</a>
              <a href="author.html#20896">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
