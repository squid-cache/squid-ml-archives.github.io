<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Linearly increasing delays in HTTPS proxy CONNECTS /	3.5.20
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Linearly%20increasing%20delays%20in%20HTTPS%20proxy%20CONNECTS%20/%0A%093.5.20&In-Reply-To=%3C592B861A-9199-4497-8BFF-9F253F62AFBA%40iki.fi%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="020906.html">
   <LINK REL="Next"  HREF="020910.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Linearly increasing delays in HTTPS proxy CONNECTS /	3.5.20</H1>
    <B>Ilari Laitinen</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Linearly%20increasing%20delays%20in%20HTTPS%20proxy%20CONNECTS%20/%0A%093.5.20&In-Reply-To=%3C592B861A-9199-4497-8BFF-9F253F62AFBA%40iki.fi%3E"
       TITLE="[squid-users] Linearly increasing delays in HTTPS proxy CONNECTS /	3.5.20">ilari.laitinen at iki.fi
       </A><BR>
    <I>Tue Aug 20 13:12:12 UTC 2019</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="020906.html">[squid-users] squid for live streaming
</A></li>
        <LI>Next message (by thread): <A HREF="020910.html">[squid-users] Linearly increasing delays in HTTPS proxy CONNECTS / 3.5.20
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20909">[ date ]</a>
              <a href="thread.html#20909">[ thread ]</a>
              <a href="subject.html#20909">[ subject ]</a>
              <a href="author.html#20909">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi!

I am experiencing a slowdown between CONNECT requests and corresponding &quot;200 Connection established&quot; responses. This happens when performance testing a load-balanced pair of squid servers with hundreds of simultaneous, independent, proxied HTTPS requests per second per server.

Most new connections get delayed by an increasing amount of time, raising often to more than 5 seconds. This obviously fails the performance test. Existing connections seem to be unaffected. The problematic situation lasts for a couple of seconds with strikingly linearly increasing delays. Expected operation resumes afterwards with a notable spike in traffic. Sometimes the delay stays at a specific level for a couple of seconds before the issue resolves itself.

squid 3.5.20 on CentOS 7

I have recorded the traffic using tcpdump and it boils down to the following. Everything else is very, very fast even during these slowdown periods.


Legend:
&#8220;source&#8221; is one of the servers where the load test originates
&#8220;squid&#8221; is the server where squid runs
&#8220;target&#8221; is a cloud service

source &#8212;&gt; squid [SYN]
source &lt;&#8212; squid [SYN, ACK]
source &#8212;&gt; squid [ACK]
source &#8212;&gt; squid [CONNECT target:443 HTTP/1.1]
source &lt;&#8212; squid [ACK]

[Unexpected delay here]

squid &#8212;&gt; target [SYN]
squid &lt;&#8212; target [SYN, ACK]
squid &#8212;&gt; target [ACK]
source &lt;&#8212; squid [HTTP/1.1 200 Connection established]
source &#8212;&gt; squid [ACK]

[Rest of the connection here without such delays]


System load stays at comfortable level (aroung 0.6 even while experiencing the issue), memory is not an issue. From 
SNMP data, I noticed small but consistent spikes in squid's disk cache usage coinciding with the issue at hand. This seemed strange, given there was no other traffic during the tests and proxied HTTPS means there's nothing to cache (right?). I nevertheless tried switching the cache from ufs to aufs and also using the no-cache option with ufs. Didn&#8217;t help. (And the spikes remained&#8230;)

I tried increasing the net.ipv4.ip_local_port_range sysctl value (it was set to default). That didn&#8217;t help, either.

The servers are located in a IPv4-only local network. Every outgoing request is supposed to be IPv4. The servers do have IPv6 interfaces but there is no traffic at all. Squid periodically queries AAAA records. Is it possible that new connections get queued while squid is busy trying to use IPv6 after receiving the new AAAAs? I have very little control over the environment. Is dns_v4_first worth a try in my scenario?

Is there something I&#8217;m missing?
What should I look into next? Could setting up &quot;workers N&#8221; help, for example?

Best Regards,

-- 
Ilari Laitinen


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="020906.html">[squid-users] squid for live streaming
</A></li>
	<LI>Next message (by thread): <A HREF="020910.html">[squid-users] Linearly increasing delays in HTTPS proxy CONNECTS / 3.5.20
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20909">[ date ]</a>
              <a href="thread.html#20909">[ thread ]</a>
              <a href="subject.html#20909">[ subject ]</a>
              <a href="author.html#20909">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
