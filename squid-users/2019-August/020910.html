<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Linearly increasing delays in HTTPS proxy CONNECTS / 3.5.20
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Linearly%20increasing%20delays%20in%20HTTPS%20proxy%0A%20CONNECTS%20/%203.5.20&In-Reply-To=%3Cd5759d03-ead0-c441-029f-288955ec4cd9%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="020909.html">
   <LINK REL="Next"  HREF="020925.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Linearly increasing delays in HTTPS proxy CONNECTS / 3.5.20</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Linearly%20increasing%20delays%20in%20HTTPS%20proxy%0A%20CONNECTS%20/%203.5.20&In-Reply-To=%3Cd5759d03-ead0-c441-029f-288955ec4cd9%40measurement-factory.com%3E"
       TITLE="[squid-users] Linearly increasing delays in HTTPS proxy CONNECTS / 3.5.20">rousskov at measurement-factory.com
       </A><BR>
    <I>Tue Aug 20 14:23:05 UTC 2019</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="020909.html">[squid-users] Linearly increasing delays in HTTPS proxy CONNECTS /	3.5.20
</A></li>
        <LI>Next message (by thread): <A HREF="020925.html">[squid-users] Linearly increasing delays in HTTPS proxy CONNECTS / 3.5.20
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20910">[ date ]</a>
              <a href="thread.html#20910">[ thread ]</a>
              <a href="subject.html#20910">[ subject ]</a>
              <a href="author.html#20910">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 8/20/19 9:12 AM, Ilari Laitinen wrote:

&gt;<i> I am experiencing a slowdown between CONNECT requests and corresponding &quot;200 Connection established&quot; responses.
</I>
I assume you are not using any SslBump features but please correct me if
I am wrong.


&gt;<i> source &#8212;&gt; squid [SYN]
</I>&gt;<i> source &lt;&#8212; squid [SYN, ACK]
</I>&gt;<i> source &#8212;&gt; squid [ACK]
</I>&gt;<i> source &#8212;&gt; squid [CONNECT target:443 HTTP/1.1]
</I>&gt;<i> source &lt;&#8212; squid [ACK]
</I>&gt;<i> 
</I>&gt;<i> [Unexpected delay here]
</I>&gt;<i> 
</I>&gt;<i> squid &#8212;&gt; target [SYN]
</I>&gt;<i> squid &lt;&#8212; target [SYN, ACK]
</I>&gt;<i> squid &#8212;&gt; target [ACK]
</I>&gt;<i> source &lt;&#8212; squid [HTTP/1.1 200 Connection established]
</I>&gt;<i> source &#8212;&gt; squid [ACK]
</I>&gt;<i> 
</I>&gt;<i> [Rest of the connection here without such delays]
</I>

&gt;<i> I noticed small but consistent spikes in squid's disk cache usage
</I>&gt;<i> coinciding with the issue at hand. This seemed strange, given there
</I>&gt;<i> was no other traffic during the tests and proxied HTTPS means there's
</I>&gt;<i> nothing to cache (right?).
</I>
Correct. To avoid suspecting disks, configure Squid to log to a
RAM-based partition and remove cache_dirs [until you solve the problem].


&gt;<i> The servers are located in a IPv4-only local network. Every outgoing
</I>&gt;<i> request is supposed to be IPv4. The servers do have IPv6 interfaces
</I>&gt;<i> but there is no traffic at all. Squid periodically queries AAAA
</I>&gt;<i> records. Is it possible that new connections get queued while squid
</I>&gt;<i> is busy trying to use IPv6 after receiving the new AAAAs?
</I>
If &quot;no traffic at all&quot; means &quot;zero IPv6 packets&quot;, then it is not
possible. Otherwise, it is possible (only the latest Squid (i.e. future
v5) does not have this kind of problem).


&gt;<i> I have very little control over the environment. Is dns_v4_first
</I>&gt;<i> worth a try in my scenario?
</I>
It is not a reliable solution, but it would not hurt as far as
performance is concerned.


&gt;<i> What should I look into next?
</I>
1. Check system logs.

2. Check atop output while the problem is present. If this is a resource
bottleneck, atop may expose it.

3. If there is IPv6 traffic, to eliminate IPv6 as a suspect, you can
disable IPv6 on the box, use Squid built without IPv6 support, or even
use a DNS forwarder that, for example, rejects all AAAA queries. All
these solutions can and should be validated by examining actual IPv6
traffic. And none of them are needed if there is no IPv6 traffic at all.

4. With delays ranging into _seconds_ it should be fairly easy for a
capable Squid developer to figure out what your Squid is doing by
looking at Squid debugging logs. You can post a link to compressed
cache.log here for analysis, but you should first simplify your workload
so that it has CONNECT tunnels and nothing else (if you have not
already) and enable debugging when the problem is present (e.g., use
&quot;squid -k debug&quot; although it is currently better to send the right
signal manually).


&gt;<i> Could setting up &quot;workers N&#8221; help, for example?
</I>
The answer depends on your definition of &quot;help&quot;: Large number of workers
may mask the problem to the point where it no longer bothers you, but I
would not make the setup a lot more complex until you know where the
current bottleneck is. In fact, I would go into the opposite direction
of making the setup as simple as possible!



HTH,

Alex.

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="020909.html">[squid-users] Linearly increasing delays in HTTPS proxy CONNECTS /	3.5.20
</A></li>
	<LI>Next message (by thread): <A HREF="020925.html">[squid-users] Linearly increasing delays in HTTPS proxy CONNECTS / 3.5.20
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20910">[ date ]</a>
              <a href="thread.html#20910">[ thread ]</a>
              <a href="subject.html#20910">[ subject ]</a>
              <a href="author.html#20910">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
