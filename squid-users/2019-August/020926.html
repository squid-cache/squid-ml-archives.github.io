<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Linearly increasing delays in HTTPS proxy CONNECTS / 3.5.20
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Linearly%20increasing%20delays%20in%20HTTPS%20proxy%0A%20CONNECTS%20/%203.5.20&In-Reply-To=%3C05ec929a-8e17-1b8a-c95d-02fc299623f2%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="020925.html">
   <LINK REL="Next"  HREF="020911.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Linearly increasing delays in HTTPS proxy CONNECTS / 3.5.20</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Linearly%20increasing%20delays%20in%20HTTPS%20proxy%0A%20CONNECTS%20/%203.5.20&In-Reply-To=%3C05ec929a-8e17-1b8a-c95d-02fc299623f2%40measurement-factory.com%3E"
       TITLE="[squid-users] Linearly increasing delays in HTTPS proxy CONNECTS / 3.5.20">rousskov at measurement-factory.com
       </A><BR>
    <I>Fri Aug 30 13:40:11 UTC 2019</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="020925.html">[squid-users] Linearly increasing delays in HTTPS proxy CONNECTS / 3.5.20
</A></li>
        <LI>Next message (by thread): <A HREF="020911.html">[squid-users] TCP_MISS_ABORTED/503 - -Squid-Error: ERR_DNS_FAIL 0
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20926">[ date ]</a>
              <a href="thread.html#20926">[ thread ]</a>
              <a href="subject.html#20926">[ subject ]</a>
              <a href="author.html#20926">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 8/30/19 8:16 AM, Ilari Laitinen wrote:

&gt;<i> I also noticed that the platform (in general) tries to resolve ipv6
</I>&gt;<i> first, but the TCP dumps have no ipv6 packages at all. This is
</I>&gt;<i> baffling, because there were indeed some unrelated open ipv6
</I>&gt;<i> connections on the Squid server (reported by netstat).
</I>
You may be able to validate your packet collection rules by adjusting
them to include those known IPv6 connections/ports. Perhaps you are just
not collecting IPv6 traffic.

It is also possible that Squid gets AAAA records but never uses them
because Squid thinks that IPv6 is disabled on your server.


&gt;<i> I unfortunately cannot share the debug log because it contains some
</I>&gt;<i> sensitive information. We nevertheless recorded what ended up being a
</I>&gt;<i> huge sample.
</I>
If you hire a Squid developer to help you, they should be willing to
sign a reasonable NDA and/or view data on your servers, without copying.
IMHO, it does not make much sense to sit on a likely valuable direct
information while, at the same time, spending a lot of time to find
distant echoes of that same information elsewhere!


&gt;<i> I suspect Squid might be waiting for local TCP ports from the kernel
</I>&gt;<i> (or something related).
</I>
IIRC, ephemeral source port allocator is instantaneous -- Squid either
gets a port or a port allocation error, without waiting. When we
overload the server with high-performance tests (without an explicit
port manager), we see port allocation errors rather than stalled tests.
However, perhaps that is not true in your OS/environment.


&gt;<i> Right now, there are four different IP addresses returned for the
</I>&gt;<i> target cloud service. For practical purposes, they are returned in a
</I>&gt;<i> random order. The traffic would ideally be spread over all of them.
</I>&gt;<i> Unfortunately it is evident both from the debug log and from the TCP
</I>&gt;<i> dump that Squid is using only one of the addresses at a time. The
</I>&gt;<i> amount of connections in the TIME_WAIT state for that single IP
</I>&gt;<i> address gets very close to the maximum defined by the
</I>&gt;<i> net.ipv4.ip_local_port_range sysctl. After a while (a minute or so in
</I>&gt;<i> the recording) this address changes presumably in response to a new
</I>&gt;<i> DNS query result.
</I>
In theory, Squid should round-robin across all destination IP addresses
for a single host name. If your Squid v3 does not, it is probably a
Squid bug that can be fixed [by upgrading].

Said that, IIRC, the notion of &quot;round robin&quot; is rather vague in Squid
because there are several places where an IP may be requested for the
same host name inside the same transaction. I would not be surprised if
that low-level round-robin behavior results in the same IP being used
for most transactions in some environments (until an error or a new DNS
query reshuffles the IPs). Debugging logs may expose this problem.


&gt;<i> Could this be the bottleneck?
</I>
I would expect that the lack of ports would lead to errors, not stalled
transactions. However, there may be some hidden dependency that I am
missing. For example, lack of ports leads to errors, the errors are not
logged where you can see them, but lead to excessive DNS retries and/or
Squid bugs that lead to delays.


&gt;<i> One possible workaround that I can think of is setting a short
</I>&gt;<i> positive_dns_ttl, but this doesn&#8217;t fully guarantee an even
</I>&gt;<i> distribution, now does it?
</I>
No, it does not. Moreover, Squid v3 had some TTL handling bugs that were
fixed (in v4 and later code) by the Happy Eyeballs project. Taking all
the known problems into the account, it is difficult for me to predict
the effect of changing TTLs. Said that, it does not hurt to try! Maybe
you will be lucky, and a simple configuration change will remove the
cause of increasing transaction delays.


HTH,

Alex.

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="020925.html">[squid-users] Linearly increasing delays in HTTPS proxy CONNECTS / 3.5.20
</A></li>
	<LI>Next message (by thread): <A HREF="020911.html">[squid-users] TCP_MISS_ABORTED/503 - -Squid-Error: ERR_DNS_FAIL 0
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20926">[ date ]</a>
              <a href="thread.html#20926">[ thread ]</a>
              <a href="subject.html#20926">[ subject ]</a>
              <a href="author.html#20926">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
