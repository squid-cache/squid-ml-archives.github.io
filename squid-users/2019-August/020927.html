<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Advice on Cache Peer ACLs
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Advice%20on%20Cache%20Peer%20ACLs&In-Reply-To=%3Ce9709e86-2719-4d0a-b163-1c9966a09263%40www.fastmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="020924.html">
   <LINK REL="Next"  HREF="020928.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Advice on Cache Peer ACLs</H1>
    <B>creditu at eml.cc</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Advice%20on%20Cache%20Peer%20ACLs&In-Reply-To=%3Ce9709e86-2719-4d0a-b163-1c9966a09263%40www.fastmail.com%3E"
       TITLE="[squid-users] Advice on Cache Peer ACLs">creditu at eml.cc
       </A><BR>
    <I>Fri Aug 30 15:44:56 UTC 2019</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="020924.html">[squid-users] Help with IP forwarder on squid
</A></li>
        <LI>Next message (by thread): <A HREF="020928.html">[squid-users] Advice on Cache Peer ACLs
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20927">[ date ]</a>
              <a href="thread.html#20927">[ thread ]</a>
              <a href="subject.html#20927">[ subject ]</a>
              <a href="author.html#20927">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>We use several squid servers in accelerator mode for load balancing to send public requests to backend servers.   The squids don't do any caching, they just forward requests to the backend. 

We have cache_peer directives to send the incoming requests to the backend Apache servers.  What I need to do is send requests to a certain page to a specific backend server and all others to the  other backends.  The site has many pages, subpages etc.  

What I want to do is if someone requests:
<A HREF="https://www.example.com/anything/anything/script.php">https://www.example.com/anything/anything/script.php</A>   or <A HREF="https://origin-www.example.com/anything/anything/etc/etc/script.php">https://origin-www.example.com/anything/anything/etc/etc/script.php</A>

Send the request to only .1, .2,.3.

If someone requests :
<A HREF="https://www.example.com/anything/tst/map2/script.php">https://www.example.com/anything/tst/map2/script.php</A>   or <A HREF="https://origin-www.example.com/anything/anything/tst/map1/etc/script.php">https://origin-www.example.com/anything/anything/tst/map1/etc/script.php</A>

Send that request only to .4 and .5.

It seems to work most of the time, but tailing the access logs on the servers I sometimes see one of the requests for ../tst/map2/... or map1 show up on .1,.2, or .3.  

Is there something I'm missing?

Here is what I have so far.

acl all_requests dstdomain -n www.example.com origin-www.example.com
acl limited  url_regex -i /tst/map1|/tst/map2


cache_peer 192.168.1.1 parent 80 0 no-query no-digest connect-fail-limit=10 weight=1 originserver round-robin
cache_peer_access 192.168.1.1 deny limited
cache_peer_access 192.168.1.1 allow all_requests
cache_peer_access 192.168.1.1 deny all

cache_peer 192.168.1.2 parent 80 0 no-query no-digest connect-fail-limit=10 weight=1 originserver round-robin
cache_peer_access 192.168.1.2 deny limited
cache_peer_access 192.168.1.2 allow all_requests
cache_peer_access 192.168.1.2 deny all

cache_peer 192.168.1.3 parent 80 0 no-query no-digest connect-fail-limit=10 weight=1 originserver round-robin
cache_peer_access 192.168.1.3 deny limited
cache_peer_access 192.168.1.3 allow all_requests
cache_peer_access 192.168.1.3 deny all

cache_peer 192.168.1.4 parent 80 0 no-query no-digest connect-fail-limit=10 weight=1 originserver round-robin
cache_peer_access 192.168.1.4 allow limited
cache_peer_access 192.168.1.4 deny all

cache_peer 192.168.1.5 parent 80 0 no-query no-digest connect-fail-limit=10 weight=1 originserver round-robin
cache_peer_access 192.168.1.5 allow limited
cache_peer_access 192.168.1.5 deny all


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="020924.html">[squid-users] Help with IP forwarder on squid
</A></li>
	<LI>Next message (by thread): <A HREF="020928.html">[squid-users] Advice on Cache Peer ACLs
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20927">[ date ]</a>
              <a href="thread.html#20927">[ thread ]</a>
              <a href="subject.html#20927">[ subject ]</a>
              <a href="author.html#20927">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
