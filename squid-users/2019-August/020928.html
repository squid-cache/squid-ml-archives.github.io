<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Advice on Cache Peer ACLs
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Advice%20on%20Cache%20Peer%20ACLs&In-Reply-To=%3Ca6e88fdd-229e-6e2e-f13b-34b846f1928f%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="020927.html">
   <LINK REL="Next"  HREF="020929.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Advice on Cache Peer ACLs</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Advice%20on%20Cache%20Peer%20ACLs&In-Reply-To=%3Ca6e88fdd-229e-6e2e-f13b-34b846f1928f%40measurement-factory.com%3E"
       TITLE="[squid-users] Advice on Cache Peer ACLs">rousskov at measurement-factory.com
       </A><BR>
    <I>Fri Aug 30 17:41:53 UTC 2019</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="020927.html">[squid-users] Advice on Cache Peer ACLs
</A></li>
        <LI>Next message (by thread): <A HREF="020929.html">[squid-users] Advice on Cache Peer ACLs
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20928">[ date ]</a>
              <a href="thread.html#20928">[ thread ]</a>
              <a href="subject.html#20928">[ subject ]</a>
              <a href="author.html#20928">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 8/30/19 11:44 AM, <A HREF="https://lists.squid-cache.org/listinfo/squid-users">creditu at eml.cc</A> wrote:
&gt;<i> We use several squid servers in accelerator mode for load balancing to send public requests to backend servers.   The squids don't do any caching, they just forward requests to the backend. 
</I>&gt;<i> 
</I>&gt;<i> We have cache_peer directives to send the incoming requests to the backend Apache servers.  What I need to do is send requests to a certain page to a specific backend server and all others to the  other backends.  The site has many pages, subpages etc.  
</I>&gt;<i> 
</I>&gt;<i> What I want to do is if someone requests:
</I>&gt;<i> <A HREF="https://www.example.com/anything/anything/script.php">https://www.example.com/anything/anything/script.php</A>   or <A HREF="https://origin-www.example.com/anything/anything/etc/etc/script.php">https://origin-www.example.com/anything/anything/etc/etc/script.php</A>
</I>&gt;<i> 
</I>&gt;<i> Send the request to only .1, .2,.3.
</I>&gt;<i> 
</I>&gt;<i> If someone requests :
</I>&gt;<i> <A HREF="https://www.example.com/anything/tst/map2/script.php">https://www.example.com/anything/tst/map2/script.php</A>   or <A HREF="https://origin-www.example.com/anything/anything/tst/map1/etc/script.php">https://origin-www.example.com/anything/anything/tst/map1/etc/script.php</A>
</I>&gt;<i> 
</I>&gt;<i> Send that request only to .4 and .5.
</I>&gt;<i> 
</I>&gt;<i> It seems to work most of the time, but tailing the access logs on the servers I sometimes see one of the requests for ../tst/map2/... or map1 show up on .1,.2, or .3.  
</I>

Do Squid access logs have the corresponding records as well? What cache
peer selection algorithm does Squid record for those misdirected
transactions?


&gt;<i> Is there something I'm missing?
</I>
Could Squid go direct to one of those origin servers (e.g., when all
eligible cache peers were down)?

BTW, please note that your cache_peer_access rules look inconsistent:
Your cache_peer_access .1-3 rules require certain domain names but .4-5
rules do not. This does not explain the discrepancy you are describing
above, but you may want to adjust your rules for consistency sake
(either to ignore dstdomain completely or to require correct domains for
all cache peers).


HTH,

Alex.


&gt;<i> acl all_requests dstdomain -n www.example.com origin-www.example.com
</I>&gt;<i> acl limited  url_regex -i /tst/map1|/tst/map2
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> cache_peer 192.168.1.1 parent 80 0 no-query no-digest connect-fail-limit=10 weight=1 originserver round-robin
</I>&gt;<i> cache_peer_access 192.168.1.1 deny limited
</I>&gt;<i> cache_peer_access 192.168.1.1 allow all_requests
</I>&gt;<i> cache_peer_access 192.168.1.1 deny all
</I>&gt;<i> 
</I>&gt;<i> cache_peer 192.168.1.2 parent 80 0 no-query no-digest connect-fail-limit=10 weight=1 originserver round-robin
</I>&gt;<i> cache_peer_access 192.168.1.2 deny limited
</I>&gt;<i> cache_peer_access 192.168.1.2 allow all_requests
</I>&gt;<i> cache_peer_access 192.168.1.2 deny all
</I>&gt;<i> 
</I>&gt;<i> cache_peer 192.168.1.3 parent 80 0 no-query no-digest connect-fail-limit=10 weight=1 originserver round-robin
</I>&gt;<i> cache_peer_access 192.168.1.3 deny limited
</I>&gt;<i> cache_peer_access 192.168.1.3 allow all_requests
</I>&gt;<i> cache_peer_access 192.168.1.3 deny all
</I>&gt;<i> 
</I>&gt;<i> cache_peer 192.168.1.4 parent 80 0 no-query no-digest connect-fail-limit=10 weight=1 originserver round-robin
</I>&gt;<i> cache_peer_access 192.168.1.4 allow limited
</I>&gt;<i> cache_peer_access 192.168.1.4 deny all
</I>&gt;<i> 
</I>&gt;<i> cache_peer 192.168.1.5 parent 80 0 no-query no-digest connect-fail-limit=10 weight=1 originserver round-robin
</I>&gt;<i> cache_peer_access 192.168.1.5 allow limited
</I>&gt;<i> cache_peer_access 192.168.1.5 deny all
</I>
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="020927.html">[squid-users] Advice on Cache Peer ACLs
</A></li>
	<LI>Next message (by thread): <A HREF="020929.html">[squid-users] Advice on Cache Peer ACLs
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20928">[ date ]</a>
              <a href="thread.html#20928">[ thread ]</a>
              <a href="subject.html#20928">[ subject ]</a>
              <a href="author.html#20928">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
