<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Resolved: Peek-and-splice not working when mixing TLS1.3 servers and TLS1.2 clients
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Resolved%3A%20Peek-and-splice%20not%20working%20when%20mixing%0A%20TLS1.3%20servers%20and%20TLS1.2%20clients&In-Reply-To=%3Ca0cb15df-648c-c0f6-f410-948176524683%40ntcomputer.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="021422.html">
   <LINK REL="Next"  HREF="021435.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Resolved: Peek-and-splice not working when mixing TLS1.3 servers and TLS1.2 clients</H1>
    <B>Nikolaus</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Resolved%3A%20Peek-and-splice%20not%20working%20when%20mixing%0A%20TLS1.3%20servers%20and%20TLS1.2%20clients&In-Reply-To=%3Ca0cb15df-648c-c0f6-f410-948176524683%40ntcomputer.de%3E"
       TITLE="[squid-users] Resolved: Peek-and-splice not working when mixing TLS1.3 servers and TLS1.2 clients">dc.sqml at ntcomputer.de
       </A><BR>
    <I>Sat Dec  7 13:54:36 UTC 2019</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="021422.html">[squid-users] TCP_TUNNEL
</A></li>
        <LI>Next message (by thread): <A HREF="021435.html">[squid-users] Resolved: Peek-and-splice not working when mixing TLS1.3 servers and TLS1.2 clients
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21434">[ date ]</a>
              <a href="thread.html#21434">[ thread ]</a>
              <a href="subject.html#21434">[ subject ]</a>
              <a href="author.html#21434">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I was able to solve the issue, fixing both squid-side
&quot;error:1425F175:SSL routines:ssl_choose_client_version:inappropriate
fallback (1/-1/0)&quot; and client-side certificate verification errors when
attempting to contact TLS 1.3 server over a TLS 1.3-enabled squid from a
TLS 1.2 client. I will first explain what causes the issue before
presenting my solution, which involves changes of the squid code base,
for anybody who is affected by the same problem.

I have inspected the squid source code and noticed that TLS peeking
works roughly like this:

1. The client sends a client_hello, which is parsed by squid using a
custom handshake parser.&#160; &lt;-- Uses TLS 1.2
2. Squid creates an OpenSSL TLS session for the peeked connection&#160; &lt;--
Uses TLS 1.3!
3. Squid forwards the original client_hello handshake message to the
server &lt;-- TLS 1.2
4. Squid passes the received server_hello response to the OpenSSL
session created previously&#160; &lt;-- Response uses TLS 1.2 - Problem!

Now, the &quot;problem&quot; is that TLS 1.3 defines a set of new protocol
downgrade attack prevention mechanisms (can be found e.g. here:
<A HREF="https://blog.gypsyengineer.com/en/security/how-does-tls-1-3-protect-against-downgrade-attacks.html">https://blog.gypsyengineer.com/en/security/how-does-tls-1-3-protect-against-downgrade-attacks.html</A>).
Both OpenSSL and most likely the server implement these. This includes
that the server random in the TLS 1.2 server_hello contains an indicator
that the server is TL 1.3-capable. The OpenSSL session created by squid
detects this, notices that it is TLS 1.3-capable itself, and closes the
connection because it assumes a protocol downgrade attack! Little does
it know, that our client actually only supports TLS 1.2, so we *want*
the lower protocol version.

My solution includes setting the maximum TLS version of the OpenSSL
session to the version received from the client. This proved a little
bit difficult, since the way TLS versions are negotiated has also been
changed by the TLS 1.3 specification, and the squid handshake parser was
not yet able to detect TLS 1.3 correctly - I have therefore also
implemented parsing of the SupportedVersions TLS Extension and a
preliminary support for sparse version ranges. You can find all these
changes at
<A HREF="https://github.com/nthuemmel/squid/tree/tls_downgrade_compatibility">https://github.com/nthuemmel/squid/tree/tls_downgrade_compatibility</A> ,
which is a fork of squid 4.9. Feel free to compile &amp; test it if you have
a transparent peek-and-splice setup and are affected by the
&quot;inappropriate fallback&quot; problem.

I would of course be glad if the fix could be merged into the main squid
repository. If you are a dev, please let me know what you think and if I
should open a pull request. There are still some TODOs left, because I
wasn't sure what the best way is to integrate some of the changes.
Notably, there was also a comment which discourages setting a maximum
version for the OpenSSL session to improve peek+bump compatibility - I
don't have a setup to which this applies, so I don't know how big of an
impact this is or if it is still relevant.

Best Regards
Nikolaus
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20191207/3146565a/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20191207/3146565a/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="021422.html">[squid-users] TCP_TUNNEL
</A></li>
	<LI>Next message (by thread): <A HREF="021435.html">[squid-users] Resolved: Peek-and-splice not working when mixing TLS1.3 servers and TLS1.2 clients
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21434">[ date ]</a>
              <a href="thread.html#21434">[ thread ]</a>
              <a href="subject.html#21434">[ subject ]</a>
              <a href="author.html#21434">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
