<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] A patch for intercepted/WCCP HTTPS and 409 errors
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20A%20patch%20for%20intercepted/WCCP%20HTTPS%20and%20409%20errors&In-Reply-To=%3C20191211075143.GA57830%40thismonkey.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="021488.html">
   <LINK REL="Next"  HREF="021484.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] A patch for intercepted/WCCP HTTPS and 409 errors</H1>
    <B>Scott</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20A%20patch%20for%20intercepted/WCCP%20HTTPS%20and%20409%20errors&In-Reply-To=%3C20191211075143.GA57830%40thismonkey.com%3E"
       TITLE="[squid-users] A patch for intercepted/WCCP HTTPS and 409 errors">3m9n51s2ewut at thismonkey.com
       </A><BR>
    <I>Wed Dec 11 07:51:43 UTC 2019</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="021488.html">[squid-users] Is there a scalable way in SSL-Bump forwarding client's certificate to server?
</A></li>
        <LI>Next message (by thread): <A HREF="021484.html">[squid-users] A patch for intercepted/WCCP HTTPS and 409 errors
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21479">[ date ]</a>
              <a href="thread.html#21479">[ thread ]</a>
              <a href="subject.html#21479">[ subject ]</a>
              <a href="author.html#21479">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

I understand that squid does some security checking that the SNI of an 
intercepted/WCCP HTTPS requests matches the reverse DNS of the IP of the 
connection.  Or something like that.

However with the prevalence of CDNs and badly configured DNSs and geographic 
DNSs, this breaks lots of connections (eg, I can't watch the NHL).

I run Squid on a trusted network and use it primarily for caching and 
logging, and so I while I need to run WCCP for some non-proxy capable 
devices, I don't need that security check.

It stops all of those 409 errors occurring.

Because of that I've created some patches that add a new option
&quot;host_verify_strict_intercepted&quot; which is off by default.  They are
for Squid 4.9.  As this is disabling a security feature of Squid do
not apply this patch unless you are prepared for any and all consequences.

--- cf.data.pre 2019-12-11 12:56:37.263665000 +1100
+++ cf.data.pre.orig    2019-12-11 11:25:20.708044000 +1100
@@ -2632,15 +2632,6 @@
        See <A HREF="http://wiki.squid-cache.org/SquidFaq/SquidAcl">http://wiki.squid-cache.org/SquidFaq/SquidAcl</A> for details.
 DOC_END

-NAME: host_verify_strict_intercepted
-TYPE: onoff
-DEFAULT: on
-LOC: Config.onoff.hostStrictVerifyIntercepted
-DOC_START
-       To be completed.
-
-DOC_END
-
 NAME: host_verify_strict
 TYPE: onoff
 DEFAULT: off

--- client_side_request.cc      2019-12-11 12:52:04.552556000 +1100
+++ client_side_request.cc.orig 2019-11-06 06:14:40.000000000 +1100
@@ -642,21 +642,16 @@

     debugs(85, 3, &quot;validate host=&quot; &lt;&lt; host &lt;&lt; &quot;, port=&quot; &lt;&lt; port &lt;&lt; &quot;, portStr=&quot; &lt;&lt; (portStr?portStr:&quot;NULL&quot;));
     if (http-&gt;request-&gt;flags.intercepted || http-&gt;request-&gt;flags.interceptTproxy) {
-        if (Config.onoff.hostStrictVerifyIntercepted) {
-            // verify the Host: port (if any) matches the apparent destination
-            if (portStr &amp;&amp; port != http-&gt;getConn()-&gt;clientConnection-&gt;local.port()) {
-                debugs(85, 3, &quot;FAIL on validate port &quot; &lt;&lt; http-&gt;getConn()-&gt;clientConnection-&gt;local.port() &lt;&lt;
-                       &quot; matches Host: port &quot; &lt;&lt; port &lt;&lt; &quot; (&quot; &lt;&lt; portStr &lt;&lt; &quot;)&quot;);
-                hostHeaderVerifyFailed(&quot;intercepted port&quot;, portStr);
-            } else {
-                // XXX: match the scheme default port against the apparent destination
-
-                // verify the destination DNS is one of the Host: headers IPs
-                ipcache_nbgethostbyname(host, hostHeaderIpVerifyWrapper, this);
-            }
+        // verify the Host: port (if any) matches the apparent destination
+        if (portStr &amp;&amp; port != http-&gt;getConn()-&gt;clientConnection-&gt;local.port()) {
+            debugs(85, 3, &quot;FAIL on validate port &quot; &lt;&lt; http-&gt;getConn()-&gt;clientConnection-&gt;local.port() &lt;&lt;
+                   &quot; matches Host: port &quot; &lt;&lt; port &lt;&lt; &quot; (&quot; &lt;&lt; portStr &lt;&lt; &quot;)&quot;);
+            hostHeaderVerifyFailed(&quot;intercepted port&quot;, portStr);
         } else {
-            debugs(85, 3, &quot;validate intercept skipped.&quot;);
-            http-&gt;doCallouts();
+            // XXX: match the scheme default port against the apparent destination
+
+            // verify the destination DNS is one of the Host: headers IPs
+            ipcache_nbgethostbyname(host, hostHeaderIpVerifyWrapper, this);
         }
     } else if (!Config.onoff.hostStrictVerify) {
         debugs(85, 3, &quot;validate skipped.&quot;);


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="021488.html">[squid-users] Is there a scalable way in SSL-Bump forwarding client's certificate to server?
</A></li>
	<LI>Next message (by thread): <A HREF="021484.html">[squid-users] A patch for intercepted/WCCP HTTPS and 409 errors
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21479">[ date ]</a>
              <a href="thread.html#21479">[ thread ]</a>
              <a href="subject.html#21479">[ subject ]</a>
              <a href="author.html#21479">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
