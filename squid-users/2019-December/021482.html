<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] HTTPS interception proxy having issues
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20HTTPS%20interception%20proxy%20having%20issues&In-Reply-To=%3Cb0fde508-ec79-b310-385a-19070e574cd7%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="021469.html">
   <LINK REL="Next"  HREF="021472.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] HTTPS interception proxy having issues</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20HTTPS%20interception%20proxy%20having%20issues&In-Reply-To=%3Cb0fde508-ec79-b310-385a-19070e574cd7%40treenet.co.nz%3E"
       TITLE="[squid-users] HTTPS interception proxy having issues">squid3 at treenet.co.nz
       </A><BR>
    <I>Wed Dec 11 12:00:23 UTC 2019</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="021469.html">[squid-users] HTTPS interception proxy having issues
</A></li>
        <LI>Next message (by thread): <A HREF="021472.html">[squid-users] Sibling peer cache not working, ver 3.5.27
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21482">[ date ]</a>
              <a href="thread.html#21482">[ thread ]</a>
              <a href="subject.html#21482">[ subject ]</a>
              <a href="author.html#21482">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 11/12/19 3:48 am, aashutosh kalyankar wrote:
&gt;<i> 
</I>&gt;<i> Hi! I am trying to set up a HTTPs intercept proxy but I cannot get it to
</I>&gt;<i> work. Can someone point me in the right direction?&#160;
</I>&gt;<i> 
</I>&gt;<i> I tried following the
</I>&gt;<i> tutorial&#160;@&#160;<A HREF="https://www.youtube.com/watch?v=Bogdplu_lsE">https://www.youtube.com/watch?v=Bogdplu_lsE</A> (Transparent
</I>&gt;<i> HTTP+HTTPS Proxy with Squid and iptables)&#160; for squid file.
</I>&gt;<i> and&#160;<A HREF="https://github.com/diladele/squid-ubuntu&#160;for">https://github.com/diladele/squid-ubuntu&#160;for</A> building squid 3.5 on
</I>&gt;<i> ubuntu.&#160;
</I>&gt;<i> 
</I>&gt;<i> *squid.conf file&#160;*
</I>&gt;<i> 
</I>&gt;<i> acl clients src&#160;172.16.10.0/24
</I>&gt;<i> acl clients src&#160;172.18.10.0/24
</I>&gt;<i> 
</I>&gt;<i> http_access allow localhost
</I>&gt;<i> http_access allow clients
</I>&gt;<i> http_access deny all
</I>&gt;<i> http_port 8080
</I>&gt;<i> http_port 3128 intercept
</I>&gt;<i> https_port 3129 intercept ssl-bump cert=/etc/squid/ssl_certs/myCA.pem
</I>&gt;<i> generate-host-certificates=on dynamic_cert_mem_cache_size=4MB
</I>&gt;<i> 
</I>&gt;<i> sslcrtd_program /usr/lib/squid/ssl_crtd -s /var/lib/ssl_db -M 4MB
</I>&gt;<i> acl step1 at_step SslBump1
</I>&gt;<i> ssl_bump peek step1
</I>&gt;<i> ssl_bump bump all
</I>&gt;<i> 
</I>&gt;<i> # only wait 5 seconds to terminate active connections
</I>&gt;<i> shutdown_lifetime 5
</I>&gt;<i> ~&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160;
</I>&gt;<i> 
</I>&gt;<i> I am forced to use old 3.5 version of squid as I am running&#160;very old
</I>&gt;<i> version of Vsphere supporting ubuntu 14.04 and below. 
</I>
Such things do not apply when building from source. You can build any
version which your build tools can handle. That should be any Squid-3.5
release, including the daily auto-generated code.



&gt;<i> *Squid Cache: Version 3.5.19&#160;*
</I>&gt;<i> Service Name: squid
</I>&gt;<i> Ubuntu linux
</I>&gt;<i> configure options: &#160;'--build=x86_64-linux-gnu' '--prefix=/usr'
</I>&gt;<i> '--includedir=${prefix}/include' '--mandir=${prefix}/share/man'
</I>&gt;<i> '--infodir=${prefix}/share/info' '--sysconfdir=/etc'
</I>&gt;<i> '--localstatedir=/var' '--libexecdir=${prefix}/lib/squid3' '--srcdir=.'
</I>&gt;<i> '--disable-maintainer-mode' '--disable-dependency-tracking'
</I>&gt;<i> '--disable-silent-rules' 'BUILDCXXFLAGS=-g -O2 -fPIE -fstack-protector
</I>&gt;<i> --param=ssp-buffer-size=4 -Wformat -Werror=format-security
</I>&gt;<i> -D_FORTIFY_SOURCE=2 -Wl,-Bsymbolic-functions -fPIE -pie -Wl,-z,relro
</I>&gt;<i> -Wl,-z,now' '--datadir=/usr/share/squid' '--sysconfdir=/etc/squid'
</I>&gt;<i> '--libexecdir=/usr/lib/squid' '--mandir=/usr/share/man'
</I>&gt;<i> '--enable-inline' '--disable-arch-native' '--enable-async-io=8'
</I>&gt;<i> '--enable-storeio=ufs,aufs,diskd,rock'
</I>&gt;<i> '--enable-removal-policies=lru,heap' '--enable-delay-pools'
</I>&gt;<i> '--enable-cache-digests' '--enable-icap-client'
</I>&gt;<i> '--enable-follow-x-forwarded-for'
</I>&gt;<i> '--enable-auth-basic=DB,fake,getpwnam,LDAP,NCSA,NIS,PAM,POP3,RADIUS,SASL,SMB'
</I>&gt;<i> '--enable-auth-digest=file,LDAP'
</I>&gt;<i> '--enable-auth-negotiate=kerberos,wrapper'
</I>&gt;<i> '--enable-auth-ntlm=fake,smb_lm'
</I>&gt;<i> '--enable-external-acl-helpers=file_userip,kerberos_ldap_group,LDAP_group,session,SQL_session,time_quota,unix_group,wbinfo_group'
</I>&gt;<i> '--enable-url-rewrite-helpers=fake' '--enable-eui' '--enable-esi'
</I>&gt;<i> '--enable-icmp' '--enable-zph-qos' '--enable-ecap'
</I>&gt;<i> '--disable-translation' '--with-swapdir=/var/spool/squid'
</I>&gt;<i> '--with-logdir=/var/log/squid' '--with-pidfile=/var/run/squid.pid'
</I>&gt;<i> '--with-filedescriptors=65536' '--with-large-files'
</I>&gt;<i> '--with-default-user=proxy' '--with-openssl' '--enable-ssl'
</I>&gt;<i> '--enable-ssl-crtd' '--enable-build-info=Ubuntu linux'
</I>&gt;<i> '--enable-linux-netfilter' 'build_alias=x86_64-linux-gnu' 'CFLAGS=-g -O2
</I>&gt;<i> -fPIE -fstack-protector --param=ssp-buffer-size=4 -Wformat
</I>&gt;<i> -Werror=format-security -Wall' 'LDFLAGS=-Wl,-Bsymbolic-functions -fPIE
</I>&gt;<i> -pie -Wl,-z,relro -Wl,-z,now' 'CPPFLAGS=-D_FORTIFY_SOURCE=2'
</I>&gt;<i> 'CXXFLAGS=-g -O2 -fPIE -fstack-protector --param=ssp-buffer-size=4
</I>&gt;<i> -Wformat -Werror=format-security'
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> *Firewall &amp; Nat rules added&#160;*
</I>&gt;<i> sudo iptables -A INPUT -j ACCEPT -p tcp --dport 3128 -m comment
</I>&gt;<i> --comment &quot;squid http proxy&quot;
</I>&gt;<i> sudo iptables -A INPUT -j ACCEPT -p tcp --dport 3129 -m comment
</I>&gt;<i> --comment &quot;squid https proxy&quot;
</I>&gt;<i> sudo iptables -A INPUT -j ACCEPT -p tcp &#160;--dport 8080 -m comment
</I>&gt;<i> -comment &quot;squid http8080 proxy
</I>

Irrelevant unless you have a local policy of requiring these for any
port to receive traffic.

There should be mangle table PREROUTING chain rule(s) to DROP or REJECT
any packets headed to Squid intercept ports.


&gt;<i> 
</I>&gt;<i> &#160;sudo iptables -t nat -A PREROUTING -i eth0 -p tcp -m tcp --dport 80 -m
</I>&gt;<i> comment --comment &quot;transparent http proxy&quot; -j REDIRECT --to-ports 3128
</I>&gt;<i> &#160;sudo iptables -t nat -A PREROUTING -i eth0 -p tcp -m tcp --dport 443 -m
</I>&gt;<i> comment --comment &quot;transparent https proxy&quot; -j REDIRECT --to-ports 3129
</I>&gt;<i> &#160;sudo iptables -t nat -A PREROUTING -i eth0 -p tcp -m tcp --dport 80 -m
</I>&gt;<i> comment --comment &quot; http 8080 proxy&quot; -j REDIRECT --to-ports 8080
</I>
You already REDIRECT port 80 to port 3128. This last rule will do nothing.

&gt;<i> 
</I>&gt;<i> *CACHE.log*
</I>&gt;<i> My machine ip: 172.16.10.5
</I>&gt;<i> Squid server ip(vmware): 172.18.10.15
</I>&gt;<i> 2019/12/09 19:42:00.677 kid1| SECURITY ALERT: Host header forgery
</I>&gt;<i> detected on local=172.18.10.15:3128
</I>&gt;<i> &lt;<A HREF="http://172.18.10.15:3128/">http://172.18.10.15:3128/</A>&gt;&#160;remote=172.16.10.5:35346
</I>&gt;<i> &lt;<A HREF="http://172.16.10.5:35346/">http://172.16.10.5:35346/</A>&gt;&#160;FD 21 flags=33 (intercepted port does not
</I>&gt;<i> match 443)
</I>

Squid is receiving a request for the URL <A HREF="https://172.18.10.15:3128/">https://172.18.10.15:3128/</A> or
equivalent.

It looks to me like you are making the classic mistake of sending
traffic directly to the Squid intercept port.

To test an interceptor proxy you MUST have a client making normal
requests like you would see them do in production environment ...
directly to the HTTP(S) origin servers.
 Let the intercept/NAT systems catch the traffic and deliver it to the
proxy - only then will that proxy have a chance at working as intended.



Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="021469.html">[squid-users] HTTPS interception proxy having issues
</A></li>
	<LI>Next message (by thread): <A HREF="021472.html">[squid-users] Sibling peer cache not working, ver 3.5.27
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21482">[ date ]</a>
              <a href="thread.html#21482">[ thread ]</a>
              <a href="subject.html#21482">[ subject ]</a>
              <a href="author.html#21482">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
