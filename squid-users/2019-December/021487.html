<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] A patch for intercepted/WCCP HTTPS and 409 errors
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20A%20patch%20for%20intercepted/WCCP%20HTTPS%20and%20409%20errors&In-Reply-To=%3C50b0b52c-00d2-6c2e-92ee-c4017eb9e8c7%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="021485.html">
   <LINK REL="Next"  HREF="021491.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] A patch for intercepted/WCCP HTTPS and 409 errors</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20A%20patch%20for%20intercepted/WCCP%20HTTPS%20and%20409%20errors&In-Reply-To=%3C50b0b52c-00d2-6c2e-92ee-c4017eb9e8c7%40treenet.co.nz%3E"
       TITLE="[squid-users] A patch for intercepted/WCCP HTTPS and 409 errors">squid3 at treenet.co.nz
       </A><BR>
    <I>Wed Dec 11 13:27:46 UTC 2019</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="021485.html">[squid-users] A patch for intercepted/WCCP HTTPS and 409 errors
</A></li>
        <LI>Next message (by thread): <A HREF="021491.html">[squid-users] A patch for intercepted/WCCP HTTPS and 409 errors
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21487">[ date ]</a>
              <a href="thread.html#21487">[ thread ]</a>
              <a href="subject.html#21487">[ subject ]</a>
              <a href="author.html#21487">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 12/12/19 1:49 am, Scott wrote:
&gt;&gt;<i> On 11/12/19 8:51 pm, Scott wrote:
</I>&gt;&gt;&gt;<i> Hi,
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> I understand that squid does some security checking that the SNI of an 
</I>&gt;&gt;&gt;<i> intercepted/WCCP HTTPS requests matches the reverse DNS of the IP of the 
</I>&gt;&gt;&gt;<i> connection.  Or something like that.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Not being able to say precisely what Squid is actually doing shows that
</I>&gt;&gt;<i> you are lacking understanding of the processes taking place.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The security check you are posting about has many secondary consequences
</I>&gt;&gt;<i> and side effects to be taken into account. Quite a few people have taken
</I>&gt;&gt;<i> a stab at solving these rejections and what we have in Squid right now
</I>&gt;&gt;<i> is the best that can be done without significant redesign work (which is
</I>&gt;&gt;<i> underway - just very slowly, help welcome).
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> This is why we have the squid-dev mailing list for code change
</I>&gt;&gt;<i> discussion. If you want to actually help solving false-positives in this
</I>&gt;&gt;<i> security check please post there and we who have been working on this
</I>&gt;&gt;<i> issue for 10+ years now can discuss what we know about the situation,
</I>&gt;&gt;<i> the &quot;gotcha&quot; side effects we have to avoid and ideas for improvement.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> However with the prevalence of CDNs and badly configured DNSs and geographic 
</I>&gt;&gt;&gt;<i> DNSs, this breaks lots of connections (eg, I can't watch the NHL).
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> I run Squid on a trusted network and use it primarily for caching and 
</I>&gt;&gt;&gt;<i> logging, and so I while I need to run WCCP for some non-proxy capable 
</I>&gt;&gt;&gt;<i> devices, I don't need that security check.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Without that check you cannot call your network a &quot;secure network&quot;
</I>&gt;&gt;<i> anymore. The absence of the check opens a nest of security holes for
</I>&gt;&gt;<i> attackers to walk right in past all those other protections.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> It stops all of those 409 errors occurring.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Because of that I've created some patches that add a new option
</I>&gt;&gt;&gt;<i> &quot;host_verify_strict_intercepted&quot; which is off by default.  They are
</I>&gt;&gt;&gt;<i> for Squid 4.9.  As this is disabling a security feature of Squid do
</I>&gt;&gt;&gt;<i> not apply this patch unless you are prepared for any and all consequences.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Please do not spread this around. People who want to really insist on
</I>&gt;&gt;<i> allowing virus/malware to spread unchecked around their networks can
</I>&gt;&gt;<i> make smaller patches.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Amos
</I>&gt;&gt;<i>
</I>&gt;<i> Hi Amos,
</I>&gt;<i> 
</I>&gt;<i> sorry for posting in the wrong forum.  While you're here: I've seen a handful 
</I>&gt;<i> of posts about the 409s and the response has been &quot;security&quot;.  Fair enough.  
</I>&gt;<i> 
</I>&gt;<i> Can you please provide a concrete example of
</I>&gt;<i> 
</I>&gt;<i> a) why host_verify_strict is available as a toggle for non-intercepted 
</I>&gt;<i> requests, and
</I>&gt;<i> b) why intercepted requests don't have this option at all?
</I>&gt;<i> 
</I>
a) Because the root vulnerability (CVE-2009-0801) which opens up the
nest of effects has no external effect on non-intercepted HTTP syntax
traffic.
 If you have a paranoid security policy or want to track down broken
software it can be useful to validate everything. So its there, but off
by default.


b) While CVE-2009-0801 appears simply a Browser issue the other side
effects that are possible include seeding the proxy cache with arbitrary
content at arbitrary URLs, using that to spread infections, to
exfiltrate data, and use that data to bypass other security mechanisms
like the network border firewalls.

The worst part is that the Squid access.log are also corrupted with
false information from the Host header (and/or SNI in HTTPS) on the
transactions where these things happen. So the attacker is hidden from
admin and security forensics. That is going too far into unsafe
territory IMO.


Other useful reading:
 &lt;<A HREF="http://www.squid-cache.org/Advisories/SQUID-2011_1.txt">http://www.squid-cache.org/Advisories/SQUID-2011_1.txt</A>&gt;
 &lt;<A HREF="https://wiki.squid-cache.org/KnowledgeBase/HostHeaderForgery">https://wiki.squid-cache.org/KnowledgeBase/HostHeaderForgery</A>&gt;


&gt;<i> I'm suffering from a lack of imagination and I've yet to see any example 
</I>&gt;<i> given (and ok, I may have missed one somewhere) and would like one brought to 
</I>&gt;<i> my (and other reader's) attention.
</I>&gt;<i> 
</I>&gt;<i> Thanks,
</I>&gt;<i> Scott
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i> 
</I>
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="021485.html">[squid-users] A patch for intercepted/WCCP HTTPS and 409 errors
</A></li>
	<LI>Next message (by thread): <A HREF="021491.html">[squid-users] A patch for intercepted/WCCP HTTPS and 409 errors
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21487">[ date ]</a>
              <a href="thread.html#21487">[ thread ]</a>
              <a href="subject.html#21487">[ subject ]</a>
              <a href="author.html#21487">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
