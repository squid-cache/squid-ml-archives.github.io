<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] A patch for intercepted/WCCP HTTPS and 409 errors
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20A%20patch%20for%20intercepted/WCCP%20HTTPS%20and%20409%20errors&In-Reply-To=%3C20191212022210.GA15129%40thismonkey.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="021487.html">
   <LINK REL="Next"  HREF="021499.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] A patch for intercepted/WCCP HTTPS and 409 errors</H1>
    <B>Scott Aitken</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20A%20patch%20for%20intercepted/WCCP%20HTTPS%20and%20409%20errors&In-Reply-To=%3C20191212022210.GA15129%40thismonkey.com%3E"
       TITLE="[squid-users] A patch for intercepted/WCCP HTTPS and 409 errors">3m9n51s2ewut at thismonkey.com
       </A><BR>
    <I>Thu Dec 12 02:22:10 UTC 2019</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="021487.html">[squid-users] A patch for intercepted/WCCP HTTPS and 409 errors
</A></li>
        <LI>Next message (by thread): <A HREF="021499.html">[squid-users] peek and splice with gnutls
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21491">[ date ]</a>
              <a href="thread.html#21491">[ thread ]</a>
              <a href="subject.html#21491">[ subject ]</a>
              <a href="author.html#21491">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>&gt;<i> On 12/12/19 1:49 am, Scott wrote:
</I>&gt;<i> &gt;&gt; On 11/12/19 8:51 pm, Scott wrote:
</I>&gt;<i> &gt;&gt;&gt; Hi,
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt; I understand that squid does some security checking that the SNI of an 
</I>&gt;<i> &gt;&gt;&gt; intercepted/WCCP HTTPS requests matches the reverse DNS of the IP of the 
</I>&gt;<i> &gt;&gt;&gt; connection.  Or something like that.
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; Not being able to say precisely what Squid is actually doing shows that
</I>&gt;<i> &gt;&gt; you are lacking understanding of the processes taking place.
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; The security check you are posting about has many secondary consequences
</I>&gt;<i> &gt;&gt; and side effects to be taken into account. Quite a few people have taken
</I>&gt;<i> &gt;&gt; a stab at solving these rejections and what we have in Squid right now
</I>&gt;<i> &gt;&gt; is the best that can be done without significant redesign work (which is
</I>&gt;<i> &gt;&gt; underway - just very slowly, help welcome).
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; This is why we have the squid-dev mailing list for code change
</I>&gt;<i> &gt;&gt; discussion. If you want to actually help solving false-positives in this
</I>&gt;<i> &gt;&gt; security check please post there and we who have been working on this
</I>&gt;<i> &gt;&gt; issue for 10+ years now can discuss what we know about the situation,
</I>&gt;<i> &gt;&gt; the &quot;gotcha&quot; side effects we have to avoid and ideas for improvement.
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt; However with the prevalence of CDNs and badly configured DNSs and geographic 
</I>&gt;<i> &gt;&gt;&gt; DNSs, this breaks lots of connections (eg, I can't watch the NHL).
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt; I run Squid on a trusted network and use it primarily for caching and 
</I>&gt;<i> &gt;&gt;&gt; logging, and so I while I need to run WCCP for some non-proxy capable 
</I>&gt;<i> &gt;&gt;&gt; devices, I don't need that security check.
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; Without that check you cannot call your network a &quot;secure network&quot;
</I>&gt;<i> &gt;&gt; anymore. The absence of the check opens a nest of security holes for
</I>&gt;<i> &gt;&gt; attackers to walk right in past all those other protections.
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt; It stops all of those 409 errors occurring.
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt; Because of that I've created some patches that add a new option
</I>&gt;<i> &gt;&gt;&gt; &quot;host_verify_strict_intercepted&quot; which is off by default.  They are
</I>&gt;<i> &gt;&gt;&gt; for Squid 4.9.  As this is disabling a security feature of Squid do
</I>&gt;<i> &gt;&gt;&gt; not apply this patch unless you are prepared for any and all consequences.
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; Please do not spread this around. People who want to really insist on
</I>&gt;<i> &gt;&gt; allowing virus/malware to spread unchecked around their networks can
</I>&gt;<i> &gt;&gt; make smaller patches.
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; Amos
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt; Hi Amos,
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; sorry for posting in the wrong forum.  While you're here: I've seen a handful 
</I>&gt;<i> &gt; of posts about the 409s and the response has been &quot;security&quot;.  Fair enough.  
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; Can you please provide a concrete example of
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; a) why host_verify_strict is available as a toggle for non-intercepted 
</I>&gt;<i> &gt; requests, and
</I>&gt;<i> &gt; b) why intercepted requests don't have this option at all?
</I>&gt;<i> &gt; 
</I>&gt;<i> 
</I>&gt;<i> a) Because the root vulnerability (CVE-2009-0801) which opens up the
</I>&gt;<i> nest of effects has no external effect on non-intercepted HTTP syntax
</I>&gt;<i> traffic.
</I>&gt;<i>  If you have a paranoid security policy or want to track down broken
</I>&gt;<i> software it can be useful to validate everything. So its there, but off
</I>&gt;<i> by default.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> b) While CVE-2009-0801 appears simply a Browser issue the other side
</I>&gt;<i> effects that are possible include seeding the proxy cache with arbitrary
</I>&gt;<i> content at arbitrary URLs, using that to spread infections, to
</I>&gt;<i> exfiltrate data, and use that data to bypass other security mechanisms
</I>&gt;<i> like the network border firewalls.
</I>&gt;<i> 
</I>&gt;<i> The worst part is that the Squid access.log are also corrupted with
</I>&gt;<i> false information from the Host header (and/or SNI in HTTPS) on the
</I>&gt;<i> transactions where these things happen. So the attacker is hidden from
</I>&gt;<i> admin and security forensics. That is going too far into unsafe
</I>&gt;<i> territory IMO.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Other useful reading:
</I>&gt;<i>  &lt;<A HREF="http://www.squid-cache.org/Advisories/SQUID-2011_1.txt">http://www.squid-cache.org/Advisories/SQUID-2011_1.txt</A>&gt;
</I>&gt;<i>  &lt;<A HREF="https://wiki.squid-cache.org/KnowledgeBase/HostHeaderForgery">https://wiki.squid-cache.org/KnowledgeBase/HostHeaderForgery</A>&gt;
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> &gt; I'm suffering from a lack of imagination and I've yet to see any example 
</I>&gt;<i> &gt; given (and ok, I may have missed one somewhere) and would like one brought to 
</I>&gt;<i> &gt; my (and other reader's) attention.
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; Thanks,
</I>&gt;<i> &gt; Scott
</I>Thanks Amos,

I found 
<A HREF="https://www.thesecuritypractice.com/the_security_practice/TransparentProxyAbuse.pdf">https://www.thesecuritypractice.com/the_security_practice/TransparentProxyAbuse.pdf</A> 
extremely useful.  Unfortunately the documentation around Squid's fix doesn't 
get into the side-effects in great detail.

The biggest side-effect is accessing non-malicious sites whose full list of A 
and AAAA records is incomplete.  This is becoming increasingly common 
especially given the preponderance of CDNs (and poor administration).

For a malicious client it's easy to circumvent Squid's fix (just don't send 
an SNI at all) - this applies to my network as I peek and splice (no MITM - 
so no HTTP headers).  But the main point of the CVE seems to be a general 
user visiting a malicious site.

My reading of the PDF is that Squid could have implemented an option to 
connect to the IP of the intercepted SYN rather than use the SNI/Host:, which 
wouldn't cause these annoying 409s.

That said, do you think the implementation of an acl of permitted dstdomains 
that aren't validated to be insecure?  I'd be happy to have a prescriptive 
list of domain names which are NOT to be verified but known to be broken from 
a DNS perspective.

eg:
acl safe_domains google.com
host_verify_strict !safe_domains

Scott

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="021487.html">[squid-users] A patch for intercepted/WCCP HTTPS and 409 errors
</A></li>
	<LI>Next message (by thread): <A HREF="021499.html">[squid-users] peek and splice with gnutls
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21491">[ date ]</a>
              <a href="thread.html#21491">[ thread ]</a>
              <a href="subject.html#21491">[ subject ]</a>
              <a href="author.html#21491">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
