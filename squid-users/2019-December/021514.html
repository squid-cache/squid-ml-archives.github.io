<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] cant download microsoft cert file
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20cant%20download%20microsoft%20cert%20file&In-Reply-To=%3Cd812f44c-959b-7778-5861-0bcee625b9bf%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="021511.html">
   <LINK REL="Next"  HREF="021515.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] cant download microsoft cert file</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20cant%20download%20microsoft%20cert%20file&In-Reply-To=%3Cd812f44c-959b-7778-5861-0bcee625b9bf%40treenet.co.nz%3E"
       TITLE="[squid-users] cant download microsoft cert file">squid3 at treenet.co.nz
       </A><BR>
    <I>Sun Dec 15 10:40:29 UTC 2019</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="021511.html">[squid-users] cant download microsoft cert file
</A></li>
        <LI>Next message (by thread): <A HREF="021515.html">[squid-users] cant download microsoft cert file
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21514">[ date ]</a>
              <a href="thread.html#21514">[ thread ]</a>
              <a href="subject.html#21514">[ subject ]</a>
              <a href="author.html#21514">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 15/12/19 1:16 pm, robert k Wild wrote:
&gt;<i> hi Amos,
</I>&gt;<i> 
</I>&gt;<i> thank you for getting back to me about this :)
</I>&gt;<i> 
</I>&gt;<i> this is my new config
</I>&gt;<i> 
</I>&gt;<i> #
</I>&gt;<i> #SSL
</I>&gt;<i> http_port 3128 ssl-bump \
</I>&gt;<i> cert=/usr/local/squid/etc/ssl_cert/myCA.pem \
</I>&gt;<i> generate-host-certificates=on dynamic_cert_mem_cache_size=4MB
</I>&gt;<i> sslcrtd_program /usr/local/squid/libexec/security_file_certgen -s
</I>&gt;<i> /var/lib/ssl_db -M 4MB
</I>&gt;<i> acl step1 at_step SslBump1
</I>&gt;<i> ssl_bump peek step1
</I>&gt;<i> ssl_bump bump all
</I>&gt;<i> 
</I>&gt;<i> #Windows Updates
</I>&gt;<i> acl windowsupdate dstdomain &quot;/usr/local/squid/etc/wu.txt&quot;
</I>&gt;<i> acl CONNECT method CONNECT
</I>&gt;<i> acl wuCONNECT dstdomain &quot;/usr/local/squid/etc/wu.txt&quot;
</I>&gt;<i> http_access allow CONNECT wuCONNECT
</I>&gt;<i> http_access allow windowsupdate
</I>&gt;<i> 
</I>...
&gt;<i> 
</I>&gt;<i> #
</I>&gt;<i> # Recommended minimum Access Permission configuration:
</I>&gt;<i> #
</I>&gt;<i> # Deny requests to certain unsafe ports
</I>&gt;<i> http_access deny !Safe_ports
</I>&gt;<i> 
</I>&gt;<i> # Deny CONNECT to other than secure SSL ports
</I>&gt;<i> http_access deny CONNECT !SSL_ports
</I>&gt;<i> 
</I>&gt;<i> # Only allow cachemgr access from localhost
</I>&gt;<i> http_access allow localhost manager
</I>&gt;<i> http_access deny manager
</I>&gt;<i> 
</I>&gt;<i> # We strongly recommend the following be uncommented to protect innocent
</I>&gt;<i> # web applications running on the proxy server who think the only
</I>&gt;<i> # one who can access services on &quot;localhost&quot; is a local user
</I>&gt;<i> #http_access deny to_localhost
</I>&gt;<i> 
</I>&gt;<i> #
</I>&gt;<i> # INSERT YOUR OWN RULE(S) HERE TO ALLOW ACCESS FROM YOUR CLIENTS
</I>&gt;<i> #
</I>&gt;<i> 
</I>&gt;<i> # Example rule allowing access from your local networks.
</I>&gt;<i> # Adapt localnet in the ACL section to list your (internal) IP networks
</I>&gt;<i> # from where browsing should be allowed
</I>&gt;<i> http_access allow localnet
</I>&gt;<i> http_access allow localhost
</I>&gt;<i> 
</I>...

&gt;<i> 
</I>&gt;<i> the reason why i have added the windows update lines at the beginning is
</I>&gt;<i> that the link says so (below)
</I>&gt;<i> 
</I>&gt;<i> <A HREF="https://linuxnlenux.wordpress.com/2014/10/14/howto-allow-windows-updates-through-squid/">https://linuxnlenux.wordpress.com/2014/10/14/howto-allow-windows-updates-through-squid/</A>
</I>&gt;<i> 
</I>
That is a copy-n-paste of an old email without any of the context. See
&lt;<A HREF="https://wiki.squid-cache.org/SquidFaq/WindowsUpdate">https://wiki.squid-cache.org/SquidFaq/WindowsUpdate</A>&gt; for the full
context and more up to date info.

Note that the things that need to be first are very specifically a
sub-set of the MS domains which use a non-443 port for call-home traffic
so they would normally get blocked by the SSL_ports protection.


For a generic whitelist you should still have your list where the config
says &quot;INSERT YOUR OWN RULES ...&quot; .


&gt;<i> 
</I>&gt;<i> and when im looking at the logs real time
</I>&gt;<i> 
</I>&gt;<i> 1576368417.620 &#160; &#160; 48 10.100.1.5 NONE/200 0 CONNECT
</I>&gt;<i> fe3cr.delivery.mp.microsoft.com:443
</I>&gt;<i> &lt;<A HREF="http://fe3cr.delivery.mp.microsoft.com:443">http://fe3cr.delivery.mp.microsoft.com:443</A>&gt; - HIER_DIRECT/191.232.139.2
</I>&gt;<i> &lt;<A HREF="http://191.232.139.2">http://191.232.139.2</A>&gt; -
</I>&gt;<i> 1576368417.647 &#160; &#160; &#160;0 10.100.1.5 NONE/503 4363 POST
</I>&gt;<i> <A HREF="https://fe3cr.delivery.mp.microsoft.com/ClientWebService/client.asmx">https://fe3cr.delivery.mp.microsoft.com/ClientWebService/client.asmx</A> -
</I>&gt;<i> HIER_NONE/- text/html
</I>&gt;<i> 1576368419.702 &#160; &#160; &#160;0 - TCP_MEM_HIT/200 807 GET
</I>&gt;<i> <A HREF="http://www.microsoft.com/pkiops/certs/Microsoft%20ECC%20Product%20Root%20Certificate%20Authority%202018.crt">http://www.microsoft.com/pkiops/certs/Microsoft%20ECC%20Product%20Root%20Certificate%20Authority%202018.crt</A>
</I>&gt;<i> - HIER_NONE/- application/octet-st
</I>&gt;<i> ream
</I>&gt;<i> 
</I>
These show good progress from where you started off. The cert is being
downloaded fine. The tunnel being bumped fine. But the POST request
which was decrypted could not be serviced.

Can you find out what the 503 message says?


Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="021511.html">[squid-users] cant download microsoft cert file
</A></li>
	<LI>Next message (by thread): <A HREF="021515.html">[squid-users] cant download microsoft cert file
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21514">[ date ]</a>
              <a href="thread.html#21514">[ thread ]</a>
              <a href="subject.html#21514">[ subject ]</a>
              <a href="author.html#21514">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
