<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] squidclamav cant connect to clamd service
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squidclamav%20cant%20connect%20to%20clamd%20service&In-Reply-To=%3CCAGU_CiLfoNorfqCjWScpJVROCZHdJZTemNZ%2BvYUTX-tdFnf4Kg%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="021558.html">
   <LINK REL="Next"  HREF="021575.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] squidclamav cant connect to clamd service</H1>
    <B>robert k Wild</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squidclamav%20cant%20connect%20to%20clamd%20service&In-Reply-To=%3CCAGU_CiLfoNorfqCjWScpJVROCZHdJZTemNZ%2BvYUTX-tdFnf4Kg%40mail.gmail.com%3E"
       TITLE="[squid-users] squidclamav cant connect to clamd service">robertkwild at gmail.com
       </A><BR>
    <I>Fri Dec 27 19:15:49 UTC 2019</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="021558.html">[squid-users] c-icap documentation getting stuck
</A></li>
        <LI>Next message (by thread): <A HREF="021575.html">[squid-users] error running c-icap in squidclamav.conf
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21574">[ date ]</a>
              <a href="thread.html#21574">[ thread ]</a>
              <a href="subject.html#21574">[ subject ]</a>
              <a href="author.html#21574">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>hi all,

ive been struggling with this for a few weeks and hopefully one of you guys
can help me out as im struggling finding solutions

ive installed on my centos 7 vm machine

c-icap

c-icap modules

<A HREF="http://c-icap.sourceforge.net/download.html">http://c-icap.sourceforge.net/download.html</A>

squid 4.9

<A HREF="http://www.squid-cache.org/Versions/v4/">http://www.squid-cache.org/Versions/v4/</A>

clamav

<A HREF="https://hostpresto.com/community/tutorials/how-to-install-clamav-on-centos-7/">https://hostpresto.com/community/tutorials/how-to-install-clamav-on-centos-7/</A>

squidclamav

<A HREF="https://sourceforge.net/projects/squidclamav/files/latest/download">https://sourceforge.net/projects/squidclamav/files/latest/download</A>

and i followed this guide compiling them from source with the configure
options make and make install on all of them

<A HREF="https://wiki.squid-cache.org/ConfigExamples/ContentAdaptation/C-ICAP">https://wiki.squid-cache.org/ConfigExamples/ContentAdaptation/C-ICAP</A>

squid works as a proxy just fine, just struggling with the c-icap with
squidclamav part

this is the error i get -

Sun Dec 22 21:40:44 2019, 1586/40797952, squidclamav.c(2081) dconnect: Sun
Dec 22 21:40:44 2019, 1586/40797952, ERROR Can't connect to clamd on local
socket /run/clamd.scan/clamd.sock.
Sun Dec 22 21:40:44 2019, 1586/40797952, squidclamav.c(787)
squidclamav_end_of_data_handler: Sun Dec 22 21:40:44 2019, 1586/40797952,
ERROR Can't connect to Clamd daemon.
Mon Dec 23 10:10:11 2019, main proc, c-icap server already running!
Mon Dec 23 10:37:44 2019, main proc, c-icap server already running!
[<A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at squid</A> ~]# ls /run/clamd.scan/
[<A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at squid</A> ~]#

but i have changed all my services to a /services directory and there all
running -

[<A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at squid</A> ~]# ls /services/c-icap/
c-icap.ctl c-icap.pid
[<A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at squid</A> ~]# ls /services/clamd.scan/
clamd.sock
[<A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at squid</A> ~]#

so my question is why is squidclamav still looking in
&quot;/run/clamd.scan/clamd.sock&quot;

i have even specified in my &quot;/etc/squidclamav.conf&quot; where the clamd service
is

# clamd_port to the corresponding value.
clamd_local /services/clamd.scan/clamd.sock
#clamd_ip 127.0.0.1
#clamd_port 3310
but i have resolved it by this :)

so in my squid.conf i added the c-icap lines using this site as the link i
gave, gave a c-icap protocol error, everytime i opened a web page

<A HREF="https://www.server-world.info/en/note?os=CentOS_7&amp;p=squid&amp;f=5">https://www.server-world.info/en/note?os=CentOS_7&amp;p=squid&amp;f=5</A> (the c-icap
lines are at the end of the guide)

i also did this

vi /etc/tmpfiles.d/c-icap.conf
d /run/c-icap 0770 root root -

vi /etc/tmpfiles.d/clamd.scan.conf
d /run/clamd.scan 0770 root root -

i also made c-icap.conf and clamd.d/scan.conf, i made the user root just to
make my life a lot easier not to run into any troubleshooting problems

and finally this command to re-initialise squidclamav with the c-icap
configs

echo -n &quot;squidclamav:cfgreload&quot; &gt; /run/c-icap/c-icap.ctl

then when i went on the <A HREF="http://www.eicar.org/download/eicar_com.zip">http://www.eicar.org/download/eicar_com.zip</A>

i got a virus found
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20191227/e46e09fb/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20191227/e46e09fb/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="021558.html">[squid-users] c-icap documentation getting stuck
</A></li>
	<LI>Next message (by thread): <A HREF="021575.html">[squid-users] error running c-icap in squidclamav.conf
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21574">[ date ]</a>
              <a href="thread.html#21574">[ thread ]</a>
              <a href="subject.html#21574">[ subject ]</a>
              <a href="author.html#21574">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
