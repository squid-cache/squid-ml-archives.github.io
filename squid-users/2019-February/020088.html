<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Connection to cache peer failed &quot;SSL Transparent proxy'
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Connection%20to%20cache%20peer%20failed%20%22SSL%20Transparent%0A%20proxy%27&In-Reply-To=%3Cec2e4d70-98d7-1354-9507-d360a8d8bec8%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="020085.html">
   <LINK REL="Next"  HREF="020092.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Connection to cache peer failed &quot;SSL Transparent proxy'</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Connection%20to%20cache%20peer%20failed%20%22SSL%20Transparent%0A%20proxy%27&In-Reply-To=%3Cec2e4d70-98d7-1354-9507-d360a8d8bec8%40treenet.co.nz%3E"
       TITLE="[squid-users] Connection to cache peer failed &quot;SSL Transparent proxy'">squid3 at treenet.co.nz
       </A><BR>
    <I>Tue Feb  5 06:24:47 UTC 2019</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="020085.html">[squid-users] Connection to cache peer failed &quot;SSL Transparent	proxy'
</A></li>
        <LI>Next message (by thread): <A HREF="020092.html">[squid-users] Connection to cache peer failed &quot;SSL Transparent	proxy'
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20088">[ date ]</a>
              <a href="thread.html#20088">[ thread ]</a>
              <a href="subject.html#20088">[ subject ]</a>
              <a href="author.html#20088">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>[ Rules horribly mangled by sending a web page to a plain-text mailing
list. I have fixed some where I replied, but not all. ]


On 5/02/19 4:07 am, Walid A. Shaari wrote:
&gt;<i> Hello,
</I>&gt;<i> 
</I>&gt;<i> I have a squid proxy, trying to configure it to enforce traffic from a
</I>&gt;<i> private cloud appliance (Azure Stack) to go over to the corporate proxy.
</I>&gt;<i> traffic is mostly https, I see the below errors, note
</I>&gt;<i> that&#160;ParentProxy-22 is the parent proxy listening on port 9090.
</I>


&gt;<i>&#160; also,
</I>&gt;<i> why in the access logs I have some entries not going to parent proxy&#160;
</I>&gt;<i> &#160;(e.g.&#160;1549282865.527 13 192.168.3.10 NONE/200 0
</I>&gt;<i> CONNECT&#160;52.138.216.83:443 &lt;<A HREF="http://52.138.216.83:443/">http://52.138.216.83:443/</A>&gt;&#160;- HIER_NONE/- -)
</I>&gt;<i> 
</I>
Some transactions do not need server contact. The above &quot;CONNECT&quot; with
raw-IP:port, &quot;NONE&quot; status type, &quot;NONE&quot; peer type and 0 byte size is
what gets logged for the SSL-Bump step-1 interaction when only a TCP SYN
packet has actually happened.

NP: Each step of SSL-Bump process has a separate log entry with
incrementally more data up to the one with a 'final' result which
instead logs the decrypted transactions or the error.


&gt;<i> ### error logs ###Feb 4 15:26:38 azproxy squid[192272]: TCP connection
</I>&gt;<i> to ParentProxy-22/9090 failed&#160;
</I>&gt;<i> Feb 4 15:26:38 azproxy squid[192272]: Error parsing SSL Server Hello
</I>&gt;<i> Message on FD 20&#160;
</I>&gt;<i> Feb 4 15:26:38 azproxy squid[192272]: ERROR: negotiating TLS on FD 20:
</I>&gt;<i> error:140770FC:SSL routines:SSL23_GET_SERVER_HELLO:unknown protocol
</I>&gt;<i> (1/-1/0) 
</I>
The OpenSSL library on your proxy machine does not understand the
protocol that it is receiving in the supposedly TLS / HTTPS traffic.

Usually seeing this on peer connections means the peer is *not* a TLS
explicit proxy, nor HTTPS / TLS origin server. Such things respond in
their actual protocol with an error -&gt; OpenSSL displays that message.


...&gt;
&gt;<i> cache_peer ParentProxy-22 parent 9090 0 no-query
</I>&gt;<i> sslcapath=/etc/pki/ca-trust/source/anchors/
</I>
Two things of note:

1) as above, does this peer *actually* support TLS connections on its
port 9090?
 Native TLS connections, not HTTP Upgrade or anything like that.

2) That sslcapath= is providing an entire set of CA's. Any given server
typically has one certificate, signed by one CA. So it is rare that you
would need an entire set of CA's to be trusted by this proxy.

For better security you should be able to load the specific CA that peer
uses with sslcafile= instead of the whole path.


&gt;<i> acl local-network dstdomain .azcompany.com
</I>&gt;<i> acl everything src&#160;10.0.0.0/8
</I>&gt;<i> http_access allow everything
</I>

These are very deceptive.

 * &quot;everything&quot; is actually a small sub-set of 'things'.

 * &quot;local-network&quot; is not necessarily local. Any IP address with
reverse-DNS configured to claim its name is within *.azcompany.com will
match this ACL regardless of where in the world it actually is.


The default squid.conf defines an ACL &quot;localnet&quot; (Local Network) for the
permitted clients subnet.

The ACL called &quot;all&quot; is provided to match every transaction with a
client IP.


&gt;<i> never_direct deny local-network
</I>

Fine, but why are you waiting until a place (never_direct) where Squid
is unable to wait for results of reverse-DNS lookup?
 That will result in unpredictable non-match occuring whenever DNS TTL
is encountered.


&gt;<i> never_direct allow all
</I>&gt;<i> http_port 8080 intercept
</I>&gt;<i> https_port 8090 intercept ssl-bump generate-host-certificates=on
</I>&gt;<i> cert=/etc/squid/ssl_certs/azproxyCA.pem dynamic_cert_mem_cache_size=16MB
</I>&gt;<i> #connection-auth=off
</I>&gt;<i> http_port 8100&#160; &#160; &#160; &#160; &#160; &#160; &#160;#forward port not used.
</I>&gt;<i> 
</I>&gt;<i> sslcrtd_program /usr/lib64/squid/security_file_certgen -s
</I>&gt;<i> /var/spool/squid/ssl_db -M 4MB
</I>&gt;<i> acl step1 at_step SslBump1
</I>&gt;<i> ssl_bump peek step1
</I>&gt;<i> ssl_bump bump all
</I>
&gt;<i> tls_outgoing_options /etc/pki/ca-trust/source/anchors/ca.crt
</I>
Squid should be telling you on startup that there is no valid option
named &quot;/etc/pki/ca-trust/source/anchors/ca.crt&quot;

 tls_outgoing_options directive takes a set of k=v pairs setting the
options just like http(s)_port and cache_peer.



HTH
Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="020085.html">[squid-users] Connection to cache peer failed &quot;SSL Transparent	proxy'
</A></li>
	<LI>Next message (by thread): <A HREF="020092.html">[squid-users] Connection to cache peer failed &quot;SSL Transparent	proxy'
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20088">[ date ]</a>
              <a href="thread.html#20088">[ thread ]</a>
              <a href="subject.html#20088">[ subject ]</a>
              <a href="author.html#20088">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
