<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Filering HTTPS URLs - A complete configuration
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Filering%20HTTPS%20URLs%20-%20A%20complete%20configuration&In-Reply-To=%3C48ab3054-7651-564a-c79e-fc2b38db7b4a%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="020090.html">
   <LINK REL="Next"  HREF="020107.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Filering HTTPS URLs - A complete configuration</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Filering%20HTTPS%20URLs%20-%20A%20complete%20configuration&In-Reply-To=%3C48ab3054-7651-564a-c79e-fc2b38db7b4a%40treenet.co.nz%3E"
       TITLE="[squid-users] Filering HTTPS URLs - A complete configuration">squid3 at treenet.co.nz
       </A><BR>
    <I>Tue Feb  5 15:35:52 UTC 2019</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="020090.html">[squid-users] Filering HTTPS URLs - A complete configuration
</A></li>
        <LI>Next message (by thread): <A HREF="020107.html">[squid-users] Filering HTTPS URLs - A complete configuration
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20091">[ date ]</a>
              <a href="thread.html#20091">[ thread ]</a>
              <a href="subject.html#20091">[ subject ]</a>
              <a href="author.html#20091">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 6/02/19 3:33 am, Paul Doignon wrote:
&gt;<i> Hi,
</I>&gt;<i> 
</I>&gt;<i> I'm struggling a lot to configure Squid. To improve the security of my app in my AWS private subnet,
</I>
If it is indeed *your* app; then please alter it not to require the
interception we see below. Ability to connect to a TLS explicit proxy or
just sending regular proxy CONNECT tunnel is a leap up in security.


&gt;<i> I would like to build a HTTPS proxy to whitelist *only* some URLs.
</I>&gt;<i> My wish is to *not* rely on SNI filtering but bump HTTPS traffic in order to filter the URLs (path) of HTTPS requests. I know that means to install a custom CA.
</I>&gt;<i> The thing is... I have a hard compiling a working configuration file for Squid 3.5, most examples are outdated or incomplete.
</I>
It looks below like you are of the mistaken belief that &quot;HTTPS requests&quot;
are actually a distinct thing that can be manipulated and tested.

&quot;HTTPS&quot; is just a moniker used to describe a multi-layer system for
delivering HTTP messages securely. This has a major impact on what can
be done at any particular time, especially regarding the URLs from those
HTTP messages.


&gt;<i> 
</I>&gt;<i> My current config is :
</I>&gt;<i> 
</I>&gt;<i> # ---
</I>&gt;<i> # General
</I>&gt;<i> cache_effective_user squid
</I>&gt;<i> cache_effective_group squid
</I>&gt;<i> shutdown_lifetime 1 seconds 
</I>&gt;<i> visible_hostname squid
</I>&gt;<i> 
</I>
Note 1) 'squid' is not a unique hostname. Ideally it should be a FQDN.
At the very least an internally resolvable name so the URLs Squid
generates with this string as the domain name will be valid for clients
needing to download objects with those URLs from Squid. Either way it
has to be unique across all proxies the traffic *might* travel -
otherwise the messages will be dropped in transit. So definitely do not
use something this simple and often-repeated as &quot;squid&quot; or &quot;proxy&quot;.


&gt;<i> # Hide some reavealing or useless headers
</I>&gt;<i> forwarded_for delete
</I>&gt;<i> httpd_suppress_version_string off
</I>&gt;<i> reply_header_access X-Cache deny all
</I>&gt;<i> reply_header_access X-Cache-Lookup deny all
</I>&gt;<i> via off
</I>&gt;<i> 
</I>&gt;<i> # Tuning
</I>&gt;<i> max_filedesc 10000
</I>&gt;<i> 
</I>&gt;<i> # Disable access to manager
</I>&gt;<i> http_access deny manager
</I>&gt;<i> 
</I>
2) you are missing the security protections from the default squid.conf...


&gt;<i> # Handling HTTPS requests
</I>&gt;<i> https_port 8080 ssl-bump generate-host-certificates=on dynamic_cert_mem_cache_size=4MB cert=/etc/squid/ssl/squid.pem options=NO_SSLv3,NO_TLSv1,NO_TLSv1_1,SINGLE_DH_USE,SINGLE_ECDH_USE intercept
</I>&gt;<i> sslcrtd_program /usr/lib64/squid/ssl_crtd -s /var/lib/squid/ssl_db -M 4MB
</I>&gt;<i> sslcrtd_children 8 startup=1 idle=1
</I>&gt;<i> acl SSL_port port 443
</I>&gt;<i> http_access allow SSL_port
</I>&gt;<i> 
</I>
3) Not a good idea. I see a lot of admin get this far and stop looking
for the proper solution when &quot;things work&quot;.

Since you are intercepting traffic to reach this point it should be
somewhat reasonable to limit the allowed traffic to some IP range. eg.
the subnet of IPs you are intercepting and sending into the proxy.


&gt;<i> # Whitelist
</I>&gt;<i> acl whitelist-regex url_regex -i thirdparty.com/upload/stuff/
</I>&gt;<i> acl whitelist-regex url_regex -i otherthirdparty.com/specific-path/
</I>&gt;<i> http_access allow whitelist-regex
</I>
Okay.

&gt;<i> 
</I>&gt;<i> # SSL bump
</I>&gt;<i> acl step1 at_step SslBump1
</I>&gt;<i> ssl_bump peek step1
</I>
 ... if the client is allowed to connect to the proxy, fetch its
clientHello details...


&gt;<i> ssl_bump bump whitelist-regex
</I>
... then try to do the impossible. We only have TLS details at this
point. There is no HTTP message - therefore no URL to match against.
 -&gt; result: skip this line, never do this &quot;bump&quot; action.


&gt;<i> ssl_bump terminate step2 !whitelist-regex
</I>
... regex still cannot match.
... but a non-match (aka false) with '!' means true.

So at step2 always terminate the connection.


Notice how there has still not been anything even remotely HTTP from the
client/app and they are now disconnected.

&gt;<i> 
</I>&gt;<i> # Deny the rest
</I>&gt;<i> http_access deny all
</I>&gt;<i> # --- 
</I>&gt;<i> 
</I>&gt;<i> What I am missing ?
</I>
It seems understanding of what ssl_bump is doing is lacking.

Please see &lt;<A HREF="https://wiki.squid-cache.org/Features/SslPeekAndSplice">https://wiki.squid-cache.org/Features/SslPeekAndSplice</A>&gt; for
details on the TLS handshake process and what SSL-Bump does during that.


&gt;<i> Should I use squid 4 for this ?
</I>
TL;DR : Yes.


Long version:

TLS is a volatile environment these days and each Squid release has
large improvements to cope with that change. You will find that v4 works
okay in a lot of TLS situations where v3 would the throwing up errors
and needing extra config workarounds.

Also, v3.x are all officially deprecated / no longer supported. v4 is
the current stable release.


Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="020090.html">[squid-users] Filering HTTPS URLs - A complete configuration
</A></li>
	<LI>Next message (by thread): <A HREF="020107.html">[squid-users] Filering HTTPS URLs - A complete configuration
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20091">[ date ]</a>
              <a href="thread.html#20091">[ thread ]</a>
              <a href="subject.html#20091">[ subject ]</a>
              <a href="author.html#20091">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
