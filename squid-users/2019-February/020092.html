<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Connection to cache peer failed &quot;SSL Transparent	proxy'
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Connection%20to%20cache%20peer%20failed%20%22SSL%20Transparent%0A%09proxy%27&In-Reply-To=%3CCAN4dctqz-VsR%3D9B7uV%3DOW5AGCGxHxgm%3Da5sMab23qQo9g6wm3Q%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="020088.html">
   <LINK REL="Next"  HREF="020094.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Connection to cache peer failed &quot;SSL Transparent	proxy'</H1>
    <B>Walid A. Shaari</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Connection%20to%20cache%20peer%20failed%20%22SSL%20Transparent%0A%09proxy%27&In-Reply-To=%3CCAN4dctqz-VsR%3D9B7uV%3DOW5AGCGxHxgm%3Da5sMab23qQo9g6wm3Q%40mail.gmail.com%3E"
       TITLE="[squid-users] Connection to cache peer failed &quot;SSL Transparent	proxy'">walid.shaari at linux.com
       </A><BR>
    <I>Tue Feb  5 16:28:27 UTC 2019</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="020088.html">[squid-users] Connection to cache peer failed &quot;SSL Transparent proxy'
</A></li>
        <LI>Next message (by thread): <A HREF="020094.html">[squid-users] Connection to cache peer failed &quot;SSL Transparent proxy'
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20092">[ date ]</a>
              <a href="thread.html#20092">[ thread ]</a>
              <a href="subject.html#20092">[ subject ]</a>
              <a href="author.html#20092">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Dear Amos,


Thank you for your time and response. I have changed the configuration to
the below. I believe the parent proxy is not using SSL/TLS. I do not see
the Hello error message any longer ( I hope).  I have not used your
proposed localnet as I just saw your email, at the time being, the ACL is
quite open as I am still troubleshooting, will tighten it when I am
comfortable with a final config.

- for the 'never direct', are you suggesting I use 'never direct deny
localnet'?


by the way, my final goal is to enable https traffic through, not really
intercept it, by trial and error and reading the mailing list, that config
below is what seems to be working for me right now, can not confirm totally
as parent proxy is not under my control, nor is the appliance, however from
the access.log and system message logs, things look better than earlier.
what is the best resource to understand the peek and splice, any good
places other than squid cache main url?


I did get a couple of new errors, have not worked on them, I might have
some clues.


  1- squid[192090]: SECURITY ALERT: Host header forgery detected on local=
52.138.216.83:443 remote=192.168.3.4:1384 &lt;<A HREF="http://10.8.103.4:1384/">http://10.8.103.4:1384/</A>&gt; FD 50
flags=33 (local IP does not match any domain IP)

       I believe this is covered in
<A HREF="https://wiki.squid-cache.org/KnowledgeBase/HostHeaderForgery">https://wiki.squid-cache.org/KnowledgeBase/HostHeaderForgery</A>


   2- temporary disabling (Unauthorized) digest from 192.168.4.22
        wondering if  I should add 'always_direct deny all'  and '
nonhierarchical_direct off'?

####   Anonymous access to parent proxy

#forwarded_for  delete

#request_header_access Surrogate-Capability deny all



dns_v4_first on

cache_peer  192.168.4.22  parent 9090 0 no-query
#sslcapath=/etc/pki/ca-trust/source/anchors/

acl local-network dstdomain .azcompany.com   # tighten after finalizng
troubleshooting, maybe replace with localnet

http_access allow all

never_direct deny local-network    # revisit not using DNS for resolution

never_direct allow all

http_port 8080 intercept    # should I really use intercept in here? can I
get away without it

https_port 8090 intercept ssl-bump generate-host-certificates=on
cert=/etc/squid/ssl_certs/bccaz01CA.pem  dynamic_cert_mem_cache_size=16MB
#connection-auth=off

http_port 8100    #forward port not used, only for troubleshooting.


sslcrtd_program /usr/lib64/squid/security_file_certgen -s
/var/spool/squid/ssl_db -M 4MB


acl step1 at_step SslBump1

acl azure_sites  dstdom_regex microsoft.com azure.com azureedge.net
microsoftazurestack.com trafficmanager.net  wdcp.microsoft.com
wdcpalt.microsoft.com updates.microsoft.com

acl azure_sites2 dstdom_regex download.microsoft.com msdl.microsoft.com
crl.microsoft.com secure.aadcdn.microsoftonline-p.com

ssl_bump peek step1

ssl_bump splice  azure_sites azure_sites2 #Avoid bumping Microsoft/Azure
related sites


sslproxy_cert_error allow azure_sites azure_sites2     # is there a better
way to handle these and log them?


debug_options  ALL,9

On Tue, 5 Feb 2019 at 09:25, Amos Jeffries &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt; wrote:

&gt;<i> [ Rules horribly mangled by sending a web page to a plain-text mailing
</I>&gt;<i> list. I have fixed some where I replied, but not all. ]
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> On 5/02/19 4:07 am, Walid A. Shaari wrote:
</I>&gt;<i> &gt; Hello,
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I have a squid proxy, trying to configure it to enforce traffic from a
</I>&gt;<i> &gt; private cloud appliance (Azure Stack) to go over to the corporate proxy.
</I>&gt;<i> &gt; traffic is mostly https, I see the below errors, note
</I>&gt;<i> &gt; that ParentProxy-22 is the parent proxy listening on port 9090.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt;  also,
</I>&gt;<i> &gt; why in the access logs I have some entries not going to parent proxy
</I>&gt;<i> &gt;  (e.g. 1549282865.527 13 192.168.3.10 NONE/200 0
</I>&gt;<i> &gt; CONNECT 52.138.216.83:443 &lt;<A HREF="http://52.138.216.83:443/">http://52.138.216.83:443/</A>&gt; - HIER_NONE/- -)
</I>&gt;<i> &gt;
</I>&gt;<i>
</I>&gt;<i> Some transactions do not need server contact. The above &quot;CONNECT&quot; with
</I>&gt;<i> raw-IP:port, &quot;NONE&quot; status type, &quot;NONE&quot; peer type and 0 byte size is
</I>&gt;<i> what gets logged for the SSL-Bump step-1 interaction when only a TCP SYN
</I>&gt;<i> packet has actually happened.
</I>&gt;<i>
</I>&gt;<i> NP: Each step of SSL-Bump process has a separate log entry with
</I>&gt;<i> incrementally more data up to the one with a 'final' result which
</I>&gt;<i> instead logs the decrypted transactions or the error.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; ### error logs ###Feb 4 15:26:38 azproxy squid[192272]: TCP connection
</I>&gt;<i> &gt; to ParentProxy-22/9090 failed
</I>&gt;<i> &gt; Feb 4 15:26:38 azproxy squid[192272]: Error parsing SSL Server Hello
</I>&gt;<i> &gt; Message on FD 20
</I>&gt;<i> &gt; Feb 4 15:26:38 azproxy squid[192272]: ERROR: negotiating TLS on FD 20:
</I>&gt;<i> &gt; error:140770FC:SSL routines:SSL23_GET_SERVER_HELLO:unknown protocol
</I>&gt;<i> &gt; (1/-1/0)
</I>&gt;<i>
</I>&gt;<i> The OpenSSL library on your proxy machine does not understand the
</I>&gt;<i> protocol that it is receiving in the supposedly TLS / HTTPS traffic.
</I>&gt;<i>
</I>&gt;<i> Usually seeing this on peer connections means the peer is *not* a TLS
</I>&gt;<i> explicit proxy, nor HTTPS / TLS origin server. Such things respond in
</I>&gt;<i> their actual protocol with an error -&gt; OpenSSL displays that message.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> ...&gt;
</I>&gt;<i> &gt; cache_peer ParentProxy-22 parent 9090 0 no-query
</I>&gt;<i> &gt; sslcapath=/etc/pki/ca-trust/source/anchors/
</I>&gt;<i>
</I>&gt;<i> Two things of note:
</I>&gt;<i>
</I>&gt;<i> 1) as above, does this peer *actually* support TLS connections on its
</I>&gt;<i> port 9090?
</I>&gt;<i>  Native TLS connections, not HTTP Upgrade or anything like that.
</I>&gt;<i>
</I>&gt;<i> 2) That sslcapath= is providing an entire set of CA's. Any given server
</I>&gt;<i> typically has one certificate, signed by one CA. So it is rare that you
</I>&gt;<i> would need an entire set of CA's to be trusted by this proxy.
</I>&gt;<i>
</I>&gt;<i> For better security you should be able to load the specific CA that peer
</I>&gt;<i> uses with sslcafile= instead of the whole path.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; acl local-network dstdomain .azcompany.com
</I>&gt;<i> &gt; acl everything src 10.0.0.0/8
</I>&gt;<i> &gt; http_access allow everything
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> These are very deceptive.
</I>&gt;<i>
</I>&gt;<i>  * &quot;everything&quot; is actually a small sub-set of 'things'.
</I>&gt;<i>
</I>&gt;<i>  * &quot;local-network&quot; is not necessarily local. Any IP address with
</I>&gt;<i> reverse-DNS configured to claim its name is within *.azcompany.com will
</I>&gt;<i> match this ACL regardless of where in the world it actually is.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> The default squid.conf defines an ACL &quot;localnet&quot; (Local Network) for the
</I>&gt;<i> permitted clients subnet.
</I>&gt;<i>
</I>&gt;<i> The ACL called &quot;all&quot; is provided to match every transaction with a
</I>&gt;<i> client IP.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; never_direct deny local-network
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Fine, but why are you waiting until a place (never_direct) where Squid
</I>&gt;<i> is unable to wait for results of reverse-DNS lookup?
</I>&gt;<i>  That will result in unpredictable non-match occuring whenever DNS TTL
</I>&gt;<i> is encountered.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; never_direct allow all
</I>&gt;<i> &gt; http_port 8080 intercept
</I>&gt;<i> &gt; https_port 8090 intercept ssl-bump generate-host-certificates=on
</I>&gt;<i> &gt; cert=/etc/squid/ssl_certs/azproxyCA.pem dynamic_cert_mem_cache_size=16MB
</I>&gt;<i> &gt; #connection-auth=off
</I>&gt;<i> &gt; http_port 8100             #forward port not used.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; sslcrtd_program /usr/lib64/squid/security_file_certgen -s
</I>&gt;<i> &gt; /var/spool/squid/ssl_db -M 4MB
</I>&gt;<i> &gt; acl step1 at_step SslBump1
</I>&gt;<i> &gt; ssl_bump peek step1
</I>&gt;<i> &gt; ssl_bump bump all
</I>&gt;<i>
</I>&gt;<i> &gt; tls_outgoing_options /etc/pki/ca-trust/source/anchors/ca.crt
</I>&gt;<i>
</I>&gt;<i> Squid should be telling you on startup that there is no valid option
</I>&gt;<i> named &quot;/etc/pki/ca-trust/source/anchors/ca.crt&quot;
</I>&gt;<i>
</I>&gt;<i>  tls_outgoing_options directive takes a set of k=v pairs setting the
</I>&gt;<i> options just like http(s)_port and cache_peer.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> HTH
</I>&gt;<i> Amos
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20190205/8b45d05c/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20190205/8b45d05c/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="020088.html">[squid-users] Connection to cache peer failed &quot;SSL Transparent proxy'
</A></li>
	<LI>Next message (by thread): <A HREF="020094.html">[squid-users] Connection to cache peer failed &quot;SSL Transparent proxy'
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20092">[ date ]</a>
              <a href="thread.html#20092">[ thread ]</a>
              <a href="subject.html#20092">[ subject ]</a>
              <a href="author.html#20092">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
