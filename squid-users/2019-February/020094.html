<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Connection to cache peer failed &quot;SSL Transparent proxy'
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Connection%20to%20cache%20peer%20failed%20%22SSL%20Transparent%0A%20proxy%27&In-Reply-To=%3C3c826662-b81d-d885-3c0c-9c3430ce7316%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="020092.html">
   <LINK REL="Next"  HREF="020111.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Connection to cache peer failed &quot;SSL Transparent proxy'</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Connection%20to%20cache%20peer%20failed%20%22SSL%20Transparent%0A%20proxy%27&In-Reply-To=%3C3c826662-b81d-d885-3c0c-9c3430ce7316%40treenet.co.nz%3E"
       TITLE="[squid-users] Connection to cache peer failed &quot;SSL Transparent proxy'">squid3 at treenet.co.nz
       </A><BR>
    <I>Wed Feb  6 02:45:26 UTC 2019</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="020092.html">[squid-users] Connection to cache peer failed &quot;SSL Transparent	proxy'
</A></li>
        <LI>Next message (by thread): <A HREF="020111.html">[squid-users] Connection to cache peer failed &quot;SSL Transparent	proxy'
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20094">[ date ]</a>
              <a href="thread.html#20094">[ thread ]</a>
              <a href="subject.html#20094">[ subject ]</a>
              <a href="author.html#20094">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 6/02/19 5:28 am, Walid A. Shaari wrote:
&gt;<i> Dear Amos,
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Thank you for your time and response. I have changed the configuration
</I>&gt;<i> to the below. I believe the parent proxy is not using SSL/TLS. I do not
</I>&gt;<i> see the Hello error message any longer ( I hope).&#160; I have not used your
</I>&gt;<i> proposed localnet as I just saw your email, at the time being, the ACL
</I>&gt;<i> is quite open as I am still troubleshooting, will tighten it when I am
</I>&gt;<i> comfortable with a final config.
</I>&gt;<i> 
</I>&gt;<i> - for the 'never direct', are you suggesting I use 'never direct deny
</I>&gt;<i> localnet'?
</I>
There are two ways to resolve the issue there.

1) The most often we recommend is to _also_ use the same ACL in an
earlier security check like http_access so the DNS lookup happens early
and the data is more reliably available when the fast-type check needs it.

or,

2) To use something that does not require remote lookups. IP address
tests etc.


It depends on what your policies are as to which is the better approach
to take. It is looking a bit like (2) is probably the way to go. With
the switch from dstdomain to server_name type for the ssl_bump
processing this issue may just disappear.


&gt;<i> 
</I>&gt;<i> by the way, my final goal is to enable https traffic through, not really
</I>&gt;<i> intercept it, by trial and error and reading the mailing list, that
</I>&gt;<i> config below is what seems to be working for me right now, can not
</I>&gt;<i> confirm totally as parent proxy is not under my control, nor is the
</I>&gt;<i> appliance, however from the access.log and system message logs, things
</I>&gt;<i> look better than earlier.&#160; what is the best resource to understand the
</I>&gt;<i> peek and splice, any good places other than squid cache main url?
</I>&gt;<i> 
</I>
The documentation of what modern Squid SSL-Bump feature does can be
found at &lt;<A HREF="https://wiki.squid-cache.org/Features/SslPeekAndSplice">https://wiki.squid-cache.org/Features/SslPeekAndSplice</A>&gt;. It is
community maintained and kept as up to date as we can.

That page links to the relevant squid.conf documentation for the
relevant pieces. The whole TLS situation is a bit volatile so questions
are welcome here if you are unsure about anything in regards to your
specific Squid version, or observe things not matching that text.


&gt;<i> 
</I>&gt;<i> I did get a couple of new errors, have not worked on them, I might have
</I>&gt;<i> some clues.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> &#160; 1-&#160;squid[192090]: SECURITY ALERT: Host header forgery detected on
</I>&gt;<i> local=52.138.216.83:443
</I>&gt;<i> &lt;<A HREF="http://52.138.216.83:443/">http://52.138.216.83:443/</A>&gt;&#160;remote=192.168.3.4:1384
</I>&gt;<i> &lt;<A HREF="http://10.8.103.4:1384/">http://10.8.103.4:1384/</A>&gt;&#160;FD 50 flags=33 (local IP does not match any
</I>&gt;<i> domain IP)
</I>&gt;<i> 
</I>&gt;<i> &#160; &#160; &#160; &#160;I believe this is covered in
</I>&gt;<i> <A HREF="https://wiki.squid-cache.org/KnowledgeBase/HostHeaderForgery">https://wiki.squid-cache.org/KnowledgeBase/HostHeaderForgery</A>
</I>&gt;<i> 
</I>
Yes.


&gt;<i> 
</I>&gt;<i> &#160; &#160;2-&#160;temporary disabling (Unauthorized) digest from&#160;192.168.4.22
</I>&gt;<i> 
</I>&gt;<i> &#160; &#160; &#160; &#160; wondering if &#160;I should add 'always_direct deny all' &#160;and '
</I>&gt;<i> nonhierarchical_direct off'?
</I>&gt;<i> 
</I>
To encourage use of the peer when it is possible but not optimal. That
&quot;nonhierarchical_direct off&quot; is the way to go.


But &quot;always_direct deny ...&quot; is a soft negative. It just means don't
*force* things to go direct. So they might still go direct to origin or
via a cache_peer as needed.

&quot;never_direct allow ...&quot; is the directive to force things to go to
cache_peer's or fail. Instead of via DIRECT or ORIGINAL_DST server
connections.

If you try to force things you will run up against the lack of
re-CONNECT features in Squid. That is Squid cannot yet generate CONNECT
tunnels through non-TLS peers like you have.

Given that the intercepted HTTPS traffic must leave Squid over secure
connections that effectively means it cannot use the peer as it normally
would and has to send that traffic via ORIGINAL_DST / DIRECT connections
to the HTTPS server. If those are forbidden the transaction has no
choice but to terminate with an error message.


FWIW: Measurement Factory have an experimental branch adding that
re-CONNECT functionality to Squid, if you are okay running alpha quality
code that may be of interest.
 On the other side, I am working with a client on a configuration that
should result in the needed behaviour for the stable releases. That is
just entering testing and depends on whether they are willing for the
details to be published.


&gt;<i> #### &#160; Anonymous access to parent proxy
</I>&gt;<i> 
</I>&gt;<i> #forwarded_for&#160; delete
</I>&gt;<i> 
</I>&gt;<i> #request_header_access Surrogate-Capability deny all
</I>&gt;<i> 
</I>
FYI: the bug behind the S-C header problems is now fixed in v4.5
release. Once you upgrade this can be removed.

&gt;<i> 
</I>&gt;<i> dns_v4_first on
</I>&gt;<i> 
</I>&gt;<i> cache_peer&#160; 192.168.4.22&#160; parent 9090 0 no-query
</I>&gt;<i> #sslcapath=/etc/pki/ca-trust/source/anchors/&#160;&#160;
</I>&gt;<i> 
</I>&gt;<i> acl local-network dstdomain .azcompany.com &#160;#
</I>&gt;<i> tighten after finalizng troubleshooting, maybe replace with localnet
</I>&gt;<i> 
</I>&gt;<i> http_access allow all
</I>&gt;<i> 
</I>&gt;<i> never_direct deny local-network&#160; &#160; # revisit not using DNS for resolution
</I>&gt;<i> 
</I>&gt;<i> never_direct allow all&#160; &#160;&#160;
</I>&gt;<i> 
</I>&gt;<i> http_port 8080 intercept&#160; &#160; # should I really use intercept in here? can
</I>&gt;<i> I get away without it
</I>&gt;<i> 
</I>&gt;<i> https_port 8090 intercept ssl-bump generate-host-certificates=on&#160;
</I>&gt;<i> cert=/etc/squid/ssl_certs/bccaz01CA.pem&#160;
</I>&gt;<i> dynamic_cert_mem_cache_size=16MB #connection-auth=off
</I>&gt;<i> 
</I>&gt;<i> http_port 8100&#160; &#160; #forward port not used, only for troubleshooting.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> sslcrtd_program /usr/lib64/squid/security_file_certgen -s
</I>&gt;<i> /var/spool/squid/ssl_db -M 4MB
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> acl step1 at_step SslBump1
</I>&gt;<i> 
</I>&gt;<i> acl azure_sites&#160; dstdom_regex microsoft.com &lt;<A HREF="http://microsoft.com">http://microsoft.com</A>&gt;
</I>&gt;<i> azure.com &lt;<A HREF="http://azure.com">http://azure.com</A>&gt; azureedge.net &lt;<A HREF="http://azureedge.net">http://azureedge.net</A>&gt;
</I>&gt;<i> microsoftazurestack.com &lt;<A HREF="http://microsoftazurestack.com">http://microsoftazurestack.com</A>&gt;
</I>&gt;<i> trafficmanager.net &lt;<A HREF="http://trafficmanager.net">http://trafficmanager.net</A>&gt;&#160; wdcp.microsoft.com
</I>&gt;<i> &lt;<A HREF="http://wdcp.microsoft.com">http://wdcp.microsoft.com</A>&gt; wdcpalt.microsoft.com
</I>&gt;<i> &lt;<A HREF="http://wdcpalt.microsoft.com">http://wdcpalt.microsoft.com</A>&gt; updates.microsoft.com
</I>&gt;<i> &lt;<A HREF="http://updates.microsoft.com">http://updates.microsoft.com</A>&gt;
</I>&gt;<i> 
</I>&gt;<i> acl azure_sites2 dstdom_regex download.microsoft.com
</I>&gt;<i> &lt;<A HREF="http://download.microsoft.com">http://download.microsoft.com</A>&gt; msdl.microsoft.com
</I>&gt;<i> &lt;<A HREF="http://msdl.microsoft.com">http://msdl.microsoft.com</A>&gt; crl.microsoft.com &lt;<A HREF="http://crl.microsoft.com">http://crl.microsoft.com</A>&gt;
</I>&gt;<i> secure.aadcdn.microsoftonline-p.com
</I>&gt;<i> &lt;<A HREF="http://secure.aadcdn.microsoftonline-p.com">http://secure.aadcdn.microsoftonline-p.com</A>&gt;
</I>&gt;<i> 
</I>
FYI: Regex is a slow procedure so when possible should be avoided. Since
all the above are domain names it looks like dstdomain would be better
with these ACL values. Some maybe using the wildcard dstdomain syntax.

 acl azure_sites dstdomain .microsoft.com \
    .azure.com .azureedge.net \
    .microsoftazurestack.com .trafficmanager.net

 acl azure_sites2 dstdomain .microsoft.com \
    secure.aadcdn.microsoftonline-p.com


&gt;<i> ssl_bump peek step1
</I>&gt;<i> 
</I>&gt;<i> ssl_bump splice&#160; azure_sites azure_sites2 #Avoid bumping Microsoft/Azure
</I>&gt;<i> related sites
</I>&gt;<i> 
</I>
The way ACLs work in Squid items on a line like &quot;azure_sites
azure_sites2&quot; *both* have to match for the lines action to be used.

So the above line means all those domains except *.microsoft.com will
*not* be spliced here even if a URL domain was available.


&gt;<i> 
</I>&gt;<i> sslproxy_cert_error allow azure_sites azure_sites2&#160; &#160; &#160;# is there a
</I>&gt;<i> better way to handle these and log them?
</I>&gt;<i> 
</I>

For ssl_bump you should prefer the ssl::server_name or
ssl::server_name_regex type ACLs.

All Squid has in the way of URL at that timing is the CONNECT message
from step 1, which is a raw-IP for intercepted traffic. The domain names
in TLS / ssl_bump come from TLS SNI and server X.509 certificate.

The ssl::server_name ACL uses dstdomain-like comparisons, but against
the TLS handshake values instead of the HTTP request message values or
reverse-DNS names.


Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="020092.html">[squid-users] Connection to cache peer failed &quot;SSL Transparent	proxy'
</A></li>
	<LI>Next message (by thread): <A HREF="020111.html">[squid-users] Connection to cache peer failed &quot;SSL Transparent	proxy'
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20094">[ date ]</a>
              <a href="thread.html#20094">[ thread ]</a>
              <a href="subject.html#20094">[ subject ]</a>
              <a href="author.html#20094">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
