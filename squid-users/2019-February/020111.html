<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Connection to cache peer failed &quot;SSL Transparent	proxy'
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Connection%20to%20cache%20peer%20failed%20%22SSL%20Transparent%0A%09proxy%27&In-Reply-To=%3CCAN4dctqQA%2Bsgu6UZ1q7ycm1LaCqNenOSao6J7NCOeR8ZjcjGHQ%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="020094.html">
   <LINK REL="Next"  HREF="020118.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Connection to cache peer failed &quot;SSL Transparent	proxy'</H1>
    <B>Walid A. Shaari</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Connection%20to%20cache%20peer%20failed%20%22SSL%20Transparent%0A%09proxy%27&In-Reply-To=%3CCAN4dctqQA%2Bsgu6UZ1q7ycm1LaCqNenOSao6J7NCOeR8ZjcjGHQ%40mail.gmail.com%3E"
       TITLE="[squid-users] Connection to cache peer failed &quot;SSL Transparent	proxy'">walid.shaari at linux.com
       </A><BR>
    <I>Wed Feb  6 19:03:18 UTC 2019</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="020094.html">[squid-users] Connection to cache peer failed &quot;SSL Transparent proxy'
</A></li>
        <LI>Next message (by thread): <A HREF="020118.html">[squid-users] Connection to cache peer failed &quot;SSL Transparent proxy'
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20111">[ date ]</a>
              <a href="thread.html#20111">[ thread ]</a>
              <a href="subject.html#20111">[ subject ]</a>
              <a href="author.html#20111">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Wed, 6 Feb 2019 at 05:53, Amos Jeffries &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt; wrote:

&gt;<i>
</I>&gt;<i> It depends on what your policies are as to which is the better approach
</I>&gt;<i> to take. It is looking a bit like (2) is probably the way to go. With
</I>&gt;<i> the switch from dstdomain to server_name type for the ssl_bump
</I>&gt;<i> processing this issue may just disappear.
</I>&gt;<i>
</I>&gt;<i>
</I>Thank you, will try it tomorow.

&gt;<i>
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; by the way, my final goal is to enable https traffic through, not really
</I>&gt;<i> &gt; intercept it, by trial and error and reading the mailing list, that
</I>&gt;<i> &gt; config below is what seems to be working for me right now, can not
</I>&gt;<i> &gt; confirm totally as parent proxy is not under my control, nor is the
</I>&gt;<i> &gt; appliance, however from the access.log and system message logs, things
</I>&gt;<i> &gt; look better than earlier.  what is the best resource to understand the
</I>&gt;<i> &gt; peek and splice, any good places other than squid cache main url?
</I>&gt;<i> &gt;
</I>&gt;<i>
</I>&gt;<i> The documentation of what modern Squid SSL-Bump feature does can be
</I>&gt;<i> found at &lt;<A HREF="https://wiki.squid-cache.org/Features/SslPeekAndSplice">https://wiki.squid-cache.org/Features/SslPeekAndSplice</A>&gt;. It is
</I>&gt;<i> community maintained and kept as up to date as we can.
</I>&gt;<i>
</I>&gt;<i> That page links to the relevant squid.conf documentation for the
</I>&gt;<i> relevant pieces. The whole TLS situation is a bit volatile so questions
</I>&gt;<i> are welcome here if you are unsure about anything in regards to your
</I>&gt;<i> specific Squid version, or observe things not matching that text.
</I>&gt;<i>
</I>&gt;<i> ..... ..... ......
</I>&gt;<i> If you try to force things you will run up against the lack of
</I>&gt;<i> re-CONNECT features in Squid. That is Squid cannot yet generate CONNECT
</I>&gt;<i> tunnels through non-TLS peers like you have.
</I>&gt;<i>
</I>&gt;<i> Given that the intercepted HTTPS traffic must leave Squid over secure
</I>&gt;<i> connections that effectively means it cannot use the peer as it normally
</I>&gt;<i> would and has to send that traffic via ORIGINAL_DST / DIRECT connections
</I>&gt;<i> to the HTTPS server. If those are forbidden the transaction has no
</I>&gt;<i> choice but to terminate with an error message.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> FWIW: Measurement Factory have an experimental branch adding that
</I>&gt;<i> re-CONNECT functionality to Squid, if you are okay running alpha quality
</I>&gt;<i> code that may be of interest.
</I>&gt;<i>  On the other side, I am working with a client on a configuration that
</I>&gt;<i> should result in the needed behaviour for the stable releases. That is
</I>&gt;<i> just entering testing and depends on whether they are willing for the
</I>&gt;<i> details to be published.
</I>&gt;<i>
</I>
I am ok if it resolves my issues and does not introduce new bugs, I have
some deadlines that I need to meet or otherwise drop all of this.

&gt;<i>
</I>&gt;<i>
</I>&gt;<i>  &gt; ####   Anonymous access to parent proxy
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; #forwarded_for  delete
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; #request_header_access Surrogate-Capability deny all
</I>&gt;<i> &gt;
</I>&gt;<i>
</I>&gt;<i> FYI: the bug behind the S-C header problems is now fixed in v4.5
</I>&gt;<i> release. Once you upgrade this can be removed.
</I>&gt;<i>
</I>
I am on v4.5

&gt;<i>
</I>&gt;<i>  &gt;
</I>&gt;<i> &gt; dns_v4_first on
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; cache_peer  192.168.4.22  parent 9090 0 no-query
</I>&gt;<i> &gt; #sslcapath=/etc/pki/ca-trust/source/anchors/
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; acl local-network dstdomain .azcompany.com  #
</I>&gt;<i> &gt; tighten after finalizng troubleshooting, maybe replace with localnet
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; http_access allow all
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; never_direct deny local-network    # revisit not using DNS for resolution
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; never_direct allow all
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; http_port 8080 intercept    # should I really use intercept in here? can
</I>&gt;<i> &gt; I get away without it
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; https_port 8090 intercept ssl-bump generate-host-certificates=on
</I>&gt;<i> &gt; cert=/etc/squid/ssl_certs/bccaz01CA.pem
</I>&gt;<i> &gt; dynamic_cert_mem_cache_size=16MB #connection-auth=off
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; http_port 8100    #forward port not used, only for troubleshooting.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; sslcrtd_program /usr/lib64/squid/security_file_certgen -s
</I>&gt;<i> &gt; /var/spool/squid/ssl_db -M 4MB
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; acl step1 at_step SslBump1
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; acl azure_sites  dstdom_regex microsoft.com &lt;<A HREF="http://microsoft.com">http://microsoft.com</A>&gt;
</I>&gt;<i> &gt; azure.com &lt;<A HREF="http://azure.com">http://azure.com</A>&gt; azureedge.net &lt;<A HREF="http://azureedge.net">http://azureedge.net</A>&gt;
</I>&gt;<i> &gt; microsoftazurestack.com &lt;<A HREF="http://microsoftazurestack.com">http://microsoftazurestack.com</A>&gt;
</I>&gt;<i> &gt; trafficmanager.net &lt;<A HREF="http://trafficmanager.net">http://trafficmanager.net</A>&gt;  wdcp.microsoft.com
</I>&gt;<i> &gt; &lt;<A HREF="http://wdcp.microsoft.com">http://wdcp.microsoft.com</A>&gt; wdcpalt.microsoft.com
</I>&gt;<i> &gt; &lt;<A HREF="http://wdcpalt.microsoft.com">http://wdcpalt.microsoft.com</A>&gt; updates.microsoft.com
</I>&gt;<i> &gt; &lt;<A HREF="http://updates.microsoft.com">http://updates.microsoft.com</A>&gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; acl azure_sites2 dstdom_regex download.microsoft.com
</I>&gt;<i> &gt; &lt;<A HREF="http://download.microsoft.com">http://download.microsoft.com</A>&gt; msdl.microsoft.com
</I>&gt;<i> &gt; &lt;<A HREF="http://msdl.microsoft.com">http://msdl.microsoft.com</A>&gt; crl.microsoft.com &lt;<A HREF="http://crl.microsoft.com">http://crl.microsoft.com</A>&gt;
</I>&gt;<i> &gt; secure.aadcdn.microsoftonline-p.com
</I>&gt;<i> &gt; &lt;<A HREF="http://secure.aadcdn.microsoftonline-p.com">http://secure.aadcdn.microsoftonline-p.com</A>&gt;
</I>&gt;<i> &gt;
</I>&gt;<i>
</I>&gt;<i> FYI: Regex is a slow procedure so when possible should be avoided. Since
</I>&gt;<i> all the above are domain names it looks like dstdomain would be better
</I>&gt;<i> with these ACL values. Some maybe using the wildcard dstdomain syntax.
</I>&gt;<i>
</I>&gt;<i>  acl azure_sites dstdomain .microsoft.com \
</I>&gt;<i>     .azure.com .azureedge.net \
</I>&gt;<i>     .microsoftazurestack.com .trafficmanager.net
</I>&gt;<i>
</I>&gt;<i>  acl azure_sites2 dstdomain .microsoft.com \
</I>&gt;<i>     secure.aadcdn.microsoftonline-p.com
</I>

Great, thanks, will use that definitely.

&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; ssl_bump peek step1
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; ssl_bump splice  azure_sites azure_sites2 #Avoid bumping Microsoft/Azure
</I>&gt;<i> &gt; related sites
</I>&gt;<i> &gt;
</I>&gt;<i>
</I>&gt;<i> The way ACLs work in Squid items on a line like &quot;azure_sites
</I>&gt;<i> azure_sites2&quot; *both* have to match for the lines action to be used.
</I>&gt;<i>
</I>&gt;<i> So the above line means all those domains except *.microsoft.com will
</I>&gt;<i> *not* be spliced here even if a URL domain was available.
</I>&gt;<i>
</I>
Sorry, I did not get that, is it because microsoft.com is duplicated by
mistake twice on both lines?

Thank you Amos, you were great help.

Walid
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20190206/4e3934ef/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20190206/4e3934ef/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="020094.html">[squid-users] Connection to cache peer failed &quot;SSL Transparent proxy'
</A></li>
	<LI>Next message (by thread): <A HREF="020118.html">[squid-users] Connection to cache peer failed &quot;SSL Transparent proxy'
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20111">[ date ]</a>
              <a href="thread.html#20111">[ thread ]</a>
              <a href="subject.html#20111">[ subject ]</a>
              <a href="author.html#20111">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
