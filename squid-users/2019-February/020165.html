<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] High response times with Squid
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20High%20response%20times%20with%20Squid&In-Reply-To=%3C278870b9477d47f4ac746c0995cacb7d%40deshaw.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="020130.html">
   <LINK REL="Next"  HREF="020169.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] High response times with Squid</H1>
    <B>Ahmad, Sarfaraz</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20High%20response%20times%20with%20Squid&In-Reply-To=%3C278870b9477d47f4ac746c0995cacb7d%40deshaw.com%3E"
       TITLE="[squid-users] High response times with Squid">Sarfaraz.Ahmad at deshaw.com
       </A><BR>
    <I>Thu Feb 14 10:38:57 UTC 2019</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="020130.html">[squid-users] High response times with Squid
</A></li>
        <LI>Next message (by thread): <A HREF="020169.html">[squid-users] High response times with Squid
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20165">[ date ]</a>
              <a href="thread.html#20165">[ thread ]</a>
              <a href="subject.html#20165">[ subject ]</a>
              <a href="author.html#20165">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi again,
I made some progress on this.
To reiterate, I am peeking at the SNI and then bump all connections to the origin server in context of this problem. ( the origin server is seamless.com )

Here are the new findings ,
1) The 20sec lag is noticed even when I splice the connection.
2) It 99% has to do with the following slow ACL acl.

acl deny_explicit_dstdomain dstdomain &quot;/etc/squid/acls/deny_explicit_dstdomain&quot;

I see PTR lookups failing when Squid tries to validate my ACLs. When I disable that ACL, the 20second lag is gone. So I am pretty confident that subsequent PTR lookups are causing the delay here.
I don't see a configuration directive with which I can configure how many times Squid retries the lookup.
I see one that sets the timeout though (dns_timeout  defaults 30 seconds).

Could you guys give me some pointers on what could be happening here ?

Regards,
Ahmad


-----Original Message-----
From: squid-users &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>&gt; On Behalf Of Amos Jeffries
Sent: Saturday, February 9, 2019 10:20 AM
To: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
Subject: Re: [squid-users] High response times with Squid

On 8/02/19 7:30 pm, Ahmad, Sarfaraz wrote:
&gt;<i> Hi,
</I>&gt;<i> 
</I>&gt;<i> &#160;
</I>&gt;<i> 
</I>&gt;<i> I am using Squid 4.5 with WCCP. Intercepting SSL by peeking at step1 
</I>&gt;<i> and then deciding to either splice or bump upon the SNI.
</I>&gt;<i> 
</I>&gt;<i> I am noticing a weird behavior for some of my TCP connections. &#160;Squid 
</I>&gt;<i> is taking over 20s to decide what do with the ClientHello sent by the 
</I>&gt;<i> browser. It is only after 20s that it decides to send out a 
</I>&gt;<i> ClientHello to the origin server and at the same time reply to the 
</I>&gt;<i> client with a ServerHello.
</I>&gt;<i> 
</I>&gt;<i> This behavior is hard to reproduce and only some clients are affected.
</I>&gt;<i> 
</I>&gt;<i> &#160;
</I>&gt;<i> 
</I>&gt;<i> I will try to summarize what I see in cache.log with ALL, 6 debug options.
</I>&gt;<i> 
</I>&gt;<i> &#160;
</I>&gt;<i> 
</I>&gt;<i> 1)&#160;&#160;&#160;&#160;&#160; Squid's INTERCEPTION thread/program receives a TCP SYN from 
</I>&gt;<i> workstation.
</I>&gt;<i> 
</I>&gt;<i> 2019/02/06 17:23:19.070 kid1| 89,5| Intercept.cc(405) Lookup: address
</I>&gt;<i> BEGIN: me/client= *&lt;SQUID_IP&gt;:*23129, destination/me=
</I>&gt;<i> *&lt;CLIENT/BROWSER_IP&gt;:*58232
</I>&gt;<i> 
</I>
No. This is looking up the original TCP dst-IP:port in the kernel NAT tables.


&gt;<i> &#160;
</I>&gt;<i> 
</I>&gt;<i> 2)&#160;&#160;&#160;&#160;&#160; Squid becomes the origin server and sets up the TCP connection.
</I>&gt;<i> 
</I>
No. The local= log values are a simple statement of the TCP packet values received from the NAT system at (1). Squid is an MITM in this setup, so the client *thinks* it is talking to the origin.

Being an MITM Squid is designed to operate as transparently as possible, but at no time has the abilities of the origin server.


&gt;<i> 2019/02/06 17:23:19.070 kid1| 5,5| AsyncCall.cc(93) ScheduleCall:
</I>&gt;<i> TcpAcceptor.cc(339) will call
</I>&gt;<i> httpsAccept(local*=&lt;ORIGIN_SERVER_ON_THE_INTERNET&gt;*:443
</I>&gt;<i> remote=*&lt;CLIENT/BROWSER_IP&gt;:*58232 FD 40 flags=33, MXID_1101703) 
</I>&gt;<i> [call34733258]
</I>&gt;<i> 
</I>
...
&gt;<i> 
</I>&gt;<i> 8)&#160;&#160;&#160;&#160;&#160; No ServerHello has been sent back to the client yet, Squid 
</I>&gt;<i> starts a TCP connection with the origin server
</I>&gt;<i> 
</I>&gt;<i> 2019/02/06 17:23:19.110 kid1| 5,4| AsyncJob.cc(123) callStart:
</I>&gt;<i> Comm::ConnOpener status in: [ job2971439]
</I>&gt;<i> 
</I>&gt;<i> 2019/02/06 17:23:19.110 kid1| 5,5| ConnOpener.cc(350) doConnect:
</I>&gt;<i> local=0.0.0.0 remote*=&lt;ORIGIN_SERVER_ON_THE_INTERNET&gt;:*443 flags=1:
</I>&gt;<i> Comm::OK - connected
</I>&gt;<i> 
</I>&gt;<i> 2019/02/06 17:23:19.110 kid1| 5,4| ConnOpener.cc(155) cleanFd:
</I>&gt;<i> local=0.0.0.0 remote=&lt;*ORIGIN_SERVER_ON_THE_INTERNET*&gt;:443 flags=1 
</I>&gt;<i> closing temp FD 50
</I>&gt;<i> 
</I>&gt;<i> &#160;
</I>&gt;<i> 
</I>&gt;<i> 9)&#160;&#160;&#160;&#160;&#160; Squid starts a TLS session with the remote/origin server, 
</I>&gt;<i> sends the ClientHello. A total of 0.4 seconds in Squid sending 
</I>&gt;<i> clienthello to origin server. This is probably when Squid decides to 
</I>&gt;<i> send back the ServerHello to the browser.
</I>
Don't guess. Check.

Either you have step2 / client-first bumping - in which case the Squid serverHello would have been sent to the client at (7).

Or, you have step3 / server-first bumping - in which case Squid cannot send a serverHello to the client until it has received the origin's serverHello. Which still has not yet been received despite your trace ending here.

...
&gt;<i> 
</I>&gt;<i> 2019/02/06 17:23:19.111 kid1| 83,5| PeerConnector.cc(123) initialize:
</I>&gt;<i> local=*&lt;SQUID_IP&gt;*:44498 remote=*&lt;ORIGIN_SERVER_ON_THE_INTERNET&gt;*:443 
</I>&gt;<i> FD
</I>&gt;<i> 50 flags=1, session=0x14899390
</I>&gt;<i> 
</I>&gt;<i> &#160;
</I>&gt;<i> 
</I>&gt;<i> So somewhere between Step 8 and Step 9, Squid is taking over 20s.
</I>&gt;<i> 
</I>
There is only 1 millisecond between those steps.

The client connection was received at 17:23:19.070, your (9) finished at
17:23:19.111 -&gt; so there is your 0.41 seconds. If there is any 20s gap for this transaction it is later in the log part you have not shown.


&gt;<i> 
</I>&gt;<i> What could possibly be keeping it busy ?
</I>&gt;<i> 
</I>
Other transactions? Nothing?

What is going on at (9) is *preparing* to send a TLS clientHello. At the point your log stops it still has not actually been written to the network.

There is actually still a good half of the SSl-Bump process to happen:
 - assemble the Squid clientHello bytes,
 - send that to origin
 - receive origin serverHello
 - validate the origin details
 - HTTP fetch missing certificates (if any)
   - re-validate the origin details (repeat fetch as necessary)
 - formulate the Squid serverHello
 - send that to client
 - receive HTTP request over the secured client connection

... then all the HTTP(S) message processing on the resulting connection.


&gt;<i> 
</I>&gt;<i> UPDATE: This problem statement seems local to a few websites. Outside 
</I>&gt;<i> of the proxy, those websites quite quickly as is expected.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Any thoughts on where to look ? &#160;other bits and pieces I could check ?
</I>&gt;<i> &#160;I have jumbo frames enabled (9000 bytes) but am running the proxies 
</I>&gt;<i> at
</I>&gt;<i> L2 1500 MTU.
</I>&gt;<i> 
</I>
It is hard to say without also knowing your squid.conf settings and what sites specifically you are having trouble with,

Could be anything from a packet loss in some remote router halfway around the world. To misconfiguration of something in your network. To misconfiguration by the origin server admin.

IMO that last one is most likely if the behaviour is only delay (not
errors) and with only certain domains.

Amos
_______________________________________________
squid-users mailing list
<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
<A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="020130.html">[squid-users] High response times with Squid
</A></li>
	<LI>Next message (by thread): <A HREF="020169.html">[squid-users] High response times with Squid
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20165">[ date ]</a>
              <a href="thread.html#20165">[ thread ]</a>
              <a href="subject.html#20165">[ subject ]</a>
              <a href="author.html#20165">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
