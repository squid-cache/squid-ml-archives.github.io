<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Issues With 3.1.20 and Windows Update
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Issues%20With%203.1.20%20and%20Windows%20Update&In-Reply-To=%3C%21%26%21AAAAAAAAAAAuAAAAAAAAANdDuvHk9MdNkXRSPO6m5z0BAMO2jhD3dRHOtM0AqgC7tuYAAAAAAA4AABAAAAC3Lh8CEfTjS4wI0QXcaNncAQAAAAA%3D%40ngtech.co.il%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="020219.html">
   <LINK REL="Next"  HREF="020224.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Issues With 3.1.20 and Windows Update</H1>
    <B>eliezer at ngtech.co.il</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Issues%20With%203.1.20%20and%20Windows%20Update&In-Reply-To=%3C%21%26%21AAAAAAAAAAAuAAAAAAAAANdDuvHk9MdNkXRSPO6m5z0BAMO2jhD3dRHOtM0AqgC7tuYAAAAAAA4AABAAAAC3Lh8CEfTjS4wI0QXcaNncAQAAAAA%3D%40ngtech.co.il%3E"
       TITLE="[squid-users] Issues With 3.1.20 and Windows Update">eliezer at ngtech.co.il
       </A><BR>
    <I>Sat Feb 23 22:15:20 UTC 2019</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="020219.html">[squid-users] Issues With 3.1.20 and Windows Update
</A></li>
        <LI>Next message (by thread): <A HREF="020224.html">[squid-users] Issues With 3.1.20 and Windows Update
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20220">[ date ]</a>
              <a href="thread.html#20220">[ thread ]</a>
              <a href="subject.html#20220">[ subject ]</a>
              <a href="author.html#20220">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Just add before the line:
http_access deny !auth
 
a localnet allow windows update rule.
It should be something like:
## Start of config snippet
acl windows_updates  dstdomain &quot;/etc/squid3/windows_update&quot;
acl src locanet 192.168.42.0/24
 
http_access allow localnet windows_updates
http_access deny !auth
 
## End of config snippet
### &quot;/etc/squid3/windows_update&#8221; contains
.windowsupdate.com
&#8230;
#
Take the regex from the domains refresh_pattern at:
<A HREF="https://wiki.squid-cache.org/ConfigExamples/Caching/WindowsUpdates">https://wiki.squid-cache.org/ConfigExamples/Caching/WindowsUpdates</A>
and at:
<A HREF="http://www1.ngtech.co.il/wpe/windows-updates-a-caching-stub-zone/">http://www1.ngtech.co.il/wpe/windows-updates-a-caching-stub-zone/</A>
(look for dstdom_regex or download\.microsoft\.com )
 
Let me know if it helps.
 
Eliezer
 
*	Try to upgrade from 3.1 if possible.
*	I probably can compile a newer version for your OS.
 
----
 &lt;<A HREF="http://ngtech.co.il/main-en/">http://ngtech.co.il/main-en/</A>&gt; Eliezer Croitoru
Linux System Administrator
Mobile: +972-5-28704261
Email:  &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">eliezer at ngtech.co.il</A>&gt; <A HREF="https://lists.squid-cache.org/listinfo/squid-users">eliezer at ngtech.co.il</A>

 
From: squid-users &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>&gt; On Behalf Of Hernan Saltiel
Sent: Saturday, February 23, 2019 22:55
To: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
Subject: [squid-users] Issues With 3.1.20 and Windows Update
 
Hi,
    I'm trying to use a Squid 3.1.20 to update several Windows Clientes (some are Vista, some are 7, some are 10).
    We're using NTLM authentication, and some groups (some users can use full internet, some can only on some sites) and this is working fine. 
    The issue arises when trying to update Windows, using automatic updates. We see, on the log files, messages like the following: 
 
1550954462.404      0 192.168.42.121 TCP_DENIED/407 3980 GET <A HREF="http://ctldl.windowsupdate.com/msdownload/update/v3/static/trustedr/en/authrootstl.cab?">http://ctldl.windowsupdate.com/msdownload/update/v3/static/trustedr/en/authrootstl.cab?</A> - NONE/- text/html
1550954462.410      0 192.168.42.121 TCP_DENIED/407 4261 GET <A HREF="http://ctldl.windowsupdate.com/msdownload/update/v3/static/trustedr/en/authrootstl.cab?">http://ctldl.windowsupdate.com/msdownload/update/v3/static/trustedr/en/authrootstl.cab?</A> - NONE/- text/html
1550954462.415      0 192.168.42.121 TCP_DENIED/407 4635 GET <A HREF="http://ctldl.windowsupdate.com/msdownload/update/v3/static/trustedr/en/authrootstl.cab?">http://ctldl.windowsupdate.com/msdownload/update/v3/static/trustedr/en/authrootstl.cab?</A> - NONE/- text/html
   
    Some aspects concerns me...first of all, that our users cannot update Windows. But then I noticed there is no user on that connection, as we have in other: 
 
1550954433.432    581 192.168.62.58 TCP_MISS/200 2853 CONNECT gameplay.intel.com:443 &lt;<A HREF="http://gameplay.intel.com:443">http://gameplay.intel.com:443</A>&gt;  jperez DIRECT/23.198.191.99 &lt;<A HREF="http://23.198.191.99">http://23.198.191.99</A>&gt;  -
 
    I don't know if this is a known issue, or not...anybody can point me in the right direction to understand the nature of this issue, and how to solve/mitigate it?
 
    Thanks a lot in advance for your time and attention and best regards,
 
---
Some information about this installation: 
 
<A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at pxyserver</A>:/var/log/squid3# squid3 -version
Squid Cache: Version 3.1.20
configure options:  '--build=i486-linux-gnu' '--prefix=/usr' '--includedir=${prefix}/include' '--mandir=${prefix}/share/man' '--infodir=${prefix}/share/info' '--sysconfdir=/etc' '--localstatedir=/var' '--libexecdir=${prefix}/lib/squid3' '--srcdir=.' '--disable-maintainer-mode' '--disable-dependency-tracking' '--disable-silent-rules' '--datadir=/usr/share/squid3' '--sysconfdir=/etc/squid3' '--mandir=/usr/share/man' '--with-cppunit-basedir=/usr' '--enable-inline' '--enable-async-io=8' '--enable-storeio=ufs,aufs,diskd' '--enable-removal-policies=lru,heap' '--enable-delay-pools' '--enable-cache-digests' '--enable-underscores' '--enable-icap-client' '--enable-follow-x-forwarded-for' '--enable-auth=basic,digest,ntlm,negotiate' '--enable-basic-auth-helpers=LDAP,MSNT,NCSA,PAM,SASL,SMB,YP,DB,POP3,getpwnam,squid_radius_auth,multi-domain-NTLM' '--enable-ntlm-auth-helpers=smb_lm,' '--enable-digest-auth-helpers=ldap,password' '--enable-negotiate-auth-helpers=squid_kerb_auth' '--enable-external-acl-helpers=ip_user,ldap_group,session,unix_group,wbinfo_group' '--enable-arp-acl' '--enable-esi' '--enable-zph-qos' '--enable-wccpv2' '--disable-translation' '--with-logdir=/var/log/squid3' '--with-pidfile=/var/run/squid3.pid' '--with-filedescriptors=65536' '--with-large-files' '--with-default-user=proxy' '--enable-linux-netfilter' 'build_alias=i486-linux-gnu' 'CFLAGS=-g -O2 -fPIE -fstack-protector --param=ssp-buffer-size=4 -Wformat -Werror=format-security -Wall' 'LDFLAGS=-fPIE -pie -Wl,-z,relro -Wl,-z,now' 'CPPFLAGS=-D_FORTIFY_SOURCE=2' 'CXXFLAGS=-g -O2 -fPIE -fstack-protector --param=ssp-buffer-size=4 -Wformat -Werror=format-security' --with-squid=/build/buildd-squid3_3.1.20-2.2-i386-3NN6Xn/squid3-3.1.20
/etc/squid3/squid.conf: 
 
cache_mgr <A HREF="https://lists.squid-cache.org/listinfo/squid-users">cache at mydomain.local</A> &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">cache at mydomain.local</A>&gt; 
auth_param negotiate program /usr/local/bin/negotiate_wrapper --ntlm /usr/bin/ntlm_auth --diagnostics --helper-protocol=squid-2.5-ntlmssp --domain=MYDOMAIN --kerberos /usr/lib/squid3/squid_kerb_auth -d -s GSS_C_NO_NAME
auth_param negotiate children 10
auth_param negotiate keep_alive off
auth_param ntlm program /usr/bin/ntlm_auth --diagnostics --helper-protocol=squid-2.5-ntlmssp --domain=MYDOMAIN
auth_param ntlm children 10
auth_param ntlm keep_alive off
auth_param basic program /usr/lib/squid3/squid_ldap_auth -R -b &quot;dc=mydomain,dc=local&quot; -D <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid at mydomain.local</A> &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid at mydomain.local</A>&gt;  -W /etc/squid3/ldappass.txt -f sAMAccountName=%s -h ARBERN005M.mydomain.local
auth_param basic children 10
auth_param basic realm Internet Proxy
auth_param basic credentialsttl 1 minute
external_acl_type memberof %LOGIN /usr/lib/squid3/squid_ldap_group -R -K -b &quot;dc=mydomain,dc=local&quot; -D <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid at mydomain.local</A> &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid at mydomain.local</A>&gt;  -W /etc/squid3/ldappass.txt -f &quot;(&amp;(objectclass=person)(sAMAccountName=%v)(memberof=cn=%g,cn=Users,dc=mydomain,dc=local))&quot; -h ARBERN005M.mydomain.local
acl company src &quot;/etc/squid3/full&quot;
acl limitados src &quot;/etc/squid3/limitados&quot;
acl lentos src &quot;/etc/squid3/lento&quot;
acl all src all
acl manager proto cache_object
acl localhost src 127.0.0.1/32 &lt;<A HREF="http://127.0.0.1/32">http://127.0.0.1/32</A>&gt; 
acl to_localhost dst 127.0.0.0/8 &lt;<A HREF="http://127.0.0.0/8">http://127.0.0.0/8</A>&gt; 
acl purge method PURGE
acl dnld url_regex -i \.avi
acl dnld url_regex -i \.mp3
acl dnld url_regex -i \.fla
acl dnld url_regex -i \.flv
acl dnld url_regex -i \.wav
acl dnld url_regex -i \.asf
acl dnld url_regex -i \.wmf
acl dnld url_regex -i \.pif
acl dnld url_regex -i \.bat
acl dnld url_regex -i \.scr
acl dnld url_regex -i \.wdm
acl dnld url_regex -i \.wmv
acl dnld url_regex -i \.mid
acl dnld url_regex -i \.mpg
acl dnld url_regex -i \.mpg
acl dnld url_regex -i \.mpeg
acl dnld url_regex -i \.ogg
acl dnld url_regex -i \.ogm
acl dnld url_regex -i \.exe
acl dnld url_regex -i \.arj
acl dnld url_regex -i \.iso
acl dnld url_regex -i \.nrg
acl dnld url_regex -i \.bin
acl dnld url_regex -i \.dmg
acl dnld url_regex -i \.img
acl dnld url_regex -i \.pl
acl dnld_full url_regex -i \.avi
acl dnld_full url_regex -i \.mp3
acl dnld_full url_regex -i \.wav
acl dnld_full url_regex -i \.asf
acl dnld_full url_regex -i \.wmf
acl dnld_full url_regex -i \.mpg
acl dnld_full url_regex -i \.mpg
acl dnld_full url_regex -i \.mpeg
acl dnld_full url_regex -i \.ogg
acl dnld_full url_regex -i \.ogm
acl streaming browser -i ^.*NSPlayer.*
acl streaming browser -i ^.*Player.*
acl streaming browser -i ^.*Windows-Media-Player.*
acl streaming1 browser -i ^video/x-ms-asf$
acl streaming1 browser -i ^application/vnd.ms.wms-hdr.asfv1$
acl streaming1 browser -i ^application/x-mms-framed$
acl streaming1 browser -i ^audio/x-pn-realaudio$
acl streaming1 browser ^.*mms.*
acl streaming1 browser ^.*ms-hdr.*
acl streaming1 browser ^.*x-fcs.*
acl streaming1 browser ^.*x-ms-asf.*
acl streaming1 browser -i ^application/octet-stream$
acl streaming1 browser -i application/octet-stream
delay_pools 1
delay_class 1 1
delay_parameters 1 1000/100
acl dp url_regex \.flv$
acl dp url_regex -i watch?
acl dp url_regex -i youtube
acl dp url_regex -i facebook
delay_access 1 allow dp lentos
acl auth proxy_auth REQUIRED
acl internet_full       external memberof &quot;/etc/squid3/internet_full.txt&quot;
acl internet_limitado   external memberof &quot;/etc/squid3/internet_limitado.txt&quot;
acl internet_limitado2  external memberof &quot;/etc/squid3/internet_limitado2.txt&quot;
acl destinos_permitidos         dstdomain &quot;/etc/squid3/destinos_permitidos&quot;
acl destinos_permitidos2        dstdomain &quot;/etc/squid3/destinos_permitidos2&quot;
acl sitios_denegados            dstdomain &quot;/etc/squid3/sitios_denegados&quot;
acl prohibidos                  dstdomain &quot;/etc/squid3/prohibidos.txt&quot;
acl prohibidos-full             dstdomain &quot;/etc/squid3/prohibidos-full.txt&quot;
acl intfull-                    dstdomain &quot;/etc/squid3/intfull-&quot;
acl allowedsites        dstdomain &quot;/etc/squid3/allowedsites.txt&quot;
acl manager proto cache_object
acl SSL_ports port 443
acl CONNECT method CONNECT
http_access allow manager localhost
http_access deny manager
http_access allow localhost
http_access deny !auth
http_access deny sitios_denegados all
http_access allow allowedsites
http_access allow limitados !dnld !streaming !streaming1 !sitios_denegados
http_access allow !dnld !streaming !streaming1 destinos_permitidos internet_limitado
http_access allow !dnld !streaming !streaming1 destinos_permitidos2 internet_limitado2
http_access allow !dnld_full !streaming !streaming1 !prohibidos-full internet_full
http_access deny all
access_log /var/log/squid3/access.log squid !allowedsites
http_port 3128
hierarchy_stoplist cgi-bin ?
coredump_dir /var/spool/squid3
refresh_pattern ^ftp:           1440    20%     10080
refresh_pattern ^gopher:        1440    0%      1440
refresh_pattern -i (/cgi-bin/|\?) 0     0%      0
refresh_pattern .               0       20%     4320


 
-- 
HeCSa
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20190224/f152ee2e/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20190224/f152ee2e/attachment.htm</A>&gt;
-------------- next part --------------
A non-text attachment was scrubbed...
Name: image001.png
Type: image/png
Size: 11295 bytes
Desc: not available
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20190224/f152ee2e/attachment.png">http://lists.squid-cache.org/pipermail/squid-users/attachments/20190224/f152ee2e/attachment.png</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="020219.html">[squid-users] Issues With 3.1.20 and Windows Update
</A></li>
	<LI>Next message (by thread): <A HREF="020224.html">[squid-users] Issues With 3.1.20 and Windows Update
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20220">[ date ]</a>
              <a href="thread.html#20220">[ thread ]</a>
              <a href="subject.html#20220">[ subject ]</a>
              <a href="author.html#20220">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
