<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Issues With 3.1.20 and Windows Update
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Issues%20With%203.1.20%20and%20Windows%20Update&In-Reply-To=%3C57a6f319-dc20-9e59-dff3-474083c784a7%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="020220.html">
   <LINK REL="Next"  HREF="020223.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Issues With 3.1.20 and Windows Update</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Issues%20With%203.1.20%20and%20Windows%20Update&In-Reply-To=%3C57a6f319-dc20-9e59-dff3-474083c784a7%40treenet.co.nz%3E"
       TITLE="[squid-users] Issues With 3.1.20 and Windows Update">squid3 at treenet.co.nz
       </A><BR>
    <I>Sun Feb 24 07:05:35 UTC 2019</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="020220.html">[squid-users] Issues With 3.1.20 and Windows Update
</A></li>
        <LI>Next message (by thread): <A HREF="020223.html">[squid-users] | Ignoring non-issuer CA from ... while squid -kparse
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20224">[ date ]</a>
              <a href="thread.html#20224">[ thread ]</a>
              <a href="subject.html#20224">[ subject ]</a>
              <a href="author.html#20224">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 24/02/19 9:55 am, Hernan Saltiel wrote:
&gt;<i> Hi,
</I>&gt;<i> &#160;&#160;&#160; I'm trying to use a Squid 3.1.20 to update several Windows Clientes
</I>&gt;<i> (some are Vista, some are 7, some are 10).
</I>&gt;<i> &#160;&#160;&#160; We're using NTLM authentication, and some groups (some users can use
</I>&gt;<i> full internet, some can only on some sites) and this is working fine.
</I>&gt;<i> &#160;&#160;&#160; The issue arises when trying to update Windows, using automatic
</I>&gt;<i> updates. We see, on the log files, messages like the following:
</I>&gt;<i> 
</I>&gt;<i> 1550954462.404&#160;&#160;&#160;&#160;&#160; 0 192.168.42.121 TCP_DENIED/407 3980 GET
</I>&gt;<i> <A HREF="http://ctldl.windowsupdate.com/msdownload/update/v3/static/trustedr/en/authrootstl.cab?">http://ctldl.windowsupdate.com/msdownload/update/v3/static/trustedr/en/authrootstl.cab?</A>
</I>&gt;<i> - NONE/- text/html
</I>&gt;<i> 1550954462.410&#160;&#160;&#160;&#160;&#160; 0 192.168.42.121 TCP_DENIED/407 4261 GET
</I>&gt;<i> <A HREF="http://ctldl.windowsupdate.com/msdownload/update/v3/static/trustedr/en/authrootstl.cab?">http://ctldl.windowsupdate.com/msdownload/update/v3/static/trustedr/en/authrootstl.cab?</A>
</I>&gt;<i> - NONE/- text/html
</I>&gt;<i> 1550954462.415&#160;&#160;&#160;&#160;&#160; 0 192.168.42.121 TCP_DENIED/407 4635 GET
</I>&gt;<i> <A HREF="http://ctldl.windowsupdate.com/msdownload/update/v3/static/trustedr/en/authrootstl.cab?">http://ctldl.windowsupdate.com/msdownload/update/v3/static/trustedr/en/authrootstl.cab?</A>
</I>&gt;<i> - NONE/- text/html
</I>&gt;<i> &#160;&#160;
</I>&gt;<i> &#160;&#160;&#160; Some aspects concerns me...first of all, that our users cannot
</I>&gt;<i> update Windows. But then I noticed there is no user on that connection,
</I>&gt;<i> as we have in other:
</I>&gt;<i> 
</I>&gt;<i> 1550954433.432&#160;&#160;&#160; 581 192.168.62.58 TCP_MISS/200 2853 CONNECT
</I>&gt;<i> gameplay.intel.com:443  *jperez*
</I>&gt;<i> DIRECT/23.198.191.99 -
</I>&gt;<i> 
</I>&gt;<i> &#160;&#160;&#160; I don't know if this is a known issue, or not...anybody can point me
</I>&gt;<i> in the right direction to understand the nature of this issue, and how
</I>&gt;<i> to solve/mitigate it?
</I>
This is how NTLM works. Multiple HTTP requests exchanging type-1,2,3
tickets. Only the last one has a user name.

The absence of these multiple exchanges and all the time and bandwidth
they consume is what makes Negotiate/Kerberos have better performance.


However, if you are *only* seeing lack of username and 407/403 on the
update requests the WU agent is having problems logging in thorugh a
proxy. See
&lt;<A HREF="https://wiki.squid-cache.org/SquidFaq/WindowsUpdate#Squid_problems_with_Windows_Update_v5">https://wiki.squid-cache.org/SquidFaq/WindowsUpdate#Squid_problems_with_Windows_Update_v5</A>&gt;
and maybe
&lt;<A HREF="https://wiki.squid-cache.org/SquidFaq/WindowsUpdate#How_do_I_stop_Squid_popping_up_the_Authentication_box_for_Windows_Update.3F">https://wiki.squid-cache.org/SquidFaq/WindowsUpdate#How_do_I_stop_Squid_popping_up_the_Authentication_box_for_Windows_Update.3F</A>&gt;
for some things that may help.


Microsoft products since 2006 (Windows XP) have all had Kerberos support
and deprecated use of NTLM. If you do not have anything older to support
you may find it very useful to remove NTLM usage from the network
entirely. Remove from clients first, then servers and proxy.



Also, if you can upgrade the proxy please do. Latest release of Squid is
v4.6. There are large numbers of bugs and at least several major
security issues with all releases older than v3.5.28.


Below are some config changes you may find useful:

&gt;<i> /etc/squid3/squid.conf:
</I>&gt;<i> 
</I>&gt;<i> cache_mgr <A HREF="https://lists.squid-cache.org/listinfo/squid-users">cache at mydomain.local</A>
</I>&gt;<i> auth_param negotiate program /usr/local/bin/negotiate_wrapper --ntlm
</I>&gt;<i> /usr/bin/ntlm_auth --diagnostics --helper-protocol=squid-2.5-ntlmssp
</I>&gt;<i> --domain=MYDOMAIN --kerberos /usr/lib/squid3/squid_kerb_auth -d -s
</I>&gt;<i> GSS_C_NO_NAME
</I>&gt;<i> auth_param negotiate children 10
</I>&gt;<i> auth_param negotiate keep_alive off
</I>&gt;<i> auth_param ntlm program /usr/bin/ntlm_auth --diagnostics
</I>&gt;<i> --helper-protocol=squid-2.5-ntlmssp --domain=MYDOMAIN
</I>&gt;<i> auth_param ntlm children 10
</I>&gt;<i> auth_param ntlm keep_alive off
</I>&gt;<i> auth_param basic program /usr/lib/squid3/squid_ldap_auth -R -b
</I>&gt;<i> &quot;dc=mydomain,dc=local&quot; -D <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid at mydomain.local</A> -W
</I>&gt;<i> /etc/squid3/ldappass.txt -f sAMAccountName=%s -h ARBERN005M.mydomain.local
</I>&gt;<i> auth_param basic children 10
</I>&gt;<i> auth_param basic realm Internet Proxy
</I>&gt;<i> auth_param basic credentialsttl 1 minute
</I>&gt;<i> external_acl_type memberof %LOGIN /usr/lib/squid3/squid_ldap_group -R -K
</I>&gt;<i> -b &quot;dc=mydomain,dc=local&quot; -D <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid at mydomain.local</A> -W
</I>&gt;<i> /etc/squid3/ldappass.txt -f
</I>&gt;<i> &quot;(&amp;(objectclass=person)(sAMAccountName=%v)(memberof=cn=%g,cn=Users,dc=mydomain,dc=local))&quot;
</I>&gt;<i> -h ARBERN005M.mydomain.local
</I>&gt;<i> acl company src &quot;/etc/squid3/full&quot;
</I>&gt;<i> acl limitados src &quot;/etc/squid3/limitados&quot;
</I>&gt;<i> acl lentos src &quot;/etc/squid3/lento&quot;
</I>&gt;<i> acl all src all
</I>&gt;<i> acl manager proto cache_object
</I>&gt;<i> acl localhost src 127.0.0.1/32
</I>&gt;<i> acl to_localhost dst 127.0.0.0/8
</I>&gt;<i> acl purge method PURGE
</I>&gt;<i> acl dnld url_regex -i \.avi
</I>&gt;<i> acl dnld url_regex -i \.mp3
</I>&gt;<i> acl dnld url_regex -i \.fla
</I>&gt;<i> acl dnld url_regex -i \.flv
</I>&gt;<i> acl dnld url_regex -i \.wav
</I>&gt;<i> acl dnld url_regex -i \.asf
</I>&gt;<i> acl dnld url_regex -i \.wmf
</I>&gt;<i> acl dnld url_regex -i \.pif
</I>&gt;<i> acl dnld url_regex -i \.bat
</I>&gt;<i> acl dnld url_regex -i \.scr
</I>&gt;<i> acl dnld url_regex -i \.wdm
</I>&gt;<i> acl dnld url_regex -i \.wmv
</I>&gt;<i> acl dnld url_regex -i \.mid
</I>&gt;<i> acl dnld url_regex -i \.mpg
</I>&gt;<i> acl dnld url_regex -i \.mpg
</I>&gt;<i> acl dnld url_regex -i \.mpeg
</I>&gt;<i> acl dnld url_regex -i \.ogg
</I>&gt;<i> acl dnld url_regex -i \.ogm
</I>&gt;<i> acl dnld url_regex -i \.exe
</I>&gt;<i> acl dnld url_regex -i \.arj
</I>&gt;<i> acl dnld url_regex -i \.iso
</I>&gt;<i> acl dnld url_regex -i \.nrg
</I>&gt;<i> acl dnld url_regex -i \.bin
</I>&gt;<i> acl dnld url_regex -i \.dmg
</I>&gt;<i> acl dnld url_regex -i \.img
</I>&gt;<i> acl dnld url_regex -i \.pl
</I>
Regex is very slow to test. Especially when so many separate tests need
to be run just to test the ACL.

Newer Squid have optimizations that can help remove the duplicate
entries from above. But you should still combine these for less tests,
especially if you are staying with this Squid.

Also, are you really wanting to check these strings in the domain name
portion of URLs? url_path_regex is better for matching strings in the
URL-path area.

  acl dnld urlpath_regex -i \
      \.(avi|mp3|fl[av]|wav|asf|wm[fv]|pif|bat) \
      \.(scr|wdm|mid|mpe?g|og[gm]|exe|arj|iso|nrg) \
      \.(bin|[di]mg|pl)


&gt;<i> acl dnld_full url_regex -i \.avi
</I>&gt;<i> acl dnld_full url_regex -i \.mp3
</I>&gt;<i> acl dnld_full url_regex -i \.wav
</I>&gt;<i> acl dnld_full url_regex -i \.asf
</I>&gt;<i> acl dnld_full url_regex -i \.wmf
</I>&gt;<i> acl dnld_full url_regex -i \.mpg
</I>&gt;<i> acl dnld_full url_regex -i \.mpg
</I>&gt;<i> acl dnld_full url_regex -i \.mpeg
</I>&gt;<i> acl dnld_full url_regex -i \.ogg
</I>&gt;<i> acl dnld_full url_regex -i \.ogm
</I>&gt;<i> acl streaming browser -i ^.*NSPlayer.*
</I>&gt;<i> acl streaming browser -i ^.*Player.*
</I>&gt;<i> acl streaming browser -i ^.*Windows-Media-Player.*
</I>&gt;<i> acl streaming1 browser -i ^video/x-ms-asf$
</I>&gt;<i> acl streaming1 browser -i ^application/vnd.ms.wms-hdr.asfv1$
</I>&gt;<i> acl streaming1 browser -i ^application/x-mms-framed$
</I>&gt;<i> acl streaming1 browser -i ^audio/x-pn-realaudio$
</I>&gt;<i> acl streaming1 browser ^.*mms.*
</I>&gt;<i> acl streaming1 browser ^.*ms-hdr.*
</I>&gt;<i> acl streaming1 browser ^.*x-fcs.*
</I>&gt;<i> acl streaming1 browser ^.*x-ms-asf.*
</I>&gt;<i> acl streaming1 browser -i ^application/octet-stream$
</I>&gt;<i> acl streaming1 browser -i application/octet-stream
</I>
There are two problems above.

Firstly the 'browser' ACL type only matches the User-Agent HTTP header.
A lot of those regex are patterns matching Content-Type header values.
Something is very weirdly broken if they are being placed into User-Agent.

Secondly there are large overlaps in the patterns.

It looks to me like the proper value for this should be:

  acl streaming browser -i Player

  acl streaming1 req_header Content-Type -i ^audio/x-pn-realaudio$
  acl streaming1 req_header Content-Type -i mms|ms-hdr|x-ms-asf
  acl streaming1 req_header Content-Type -i application/octet-stream


&gt;<i> delay_pools 1
</I>&gt;<i> delay_class 1 1
</I>&gt;<i> delay_parameters 1 1000/100
</I>&gt;<i> acl dp url_regex \.flv$
</I>&gt;<i> acl dp url_regex -i watch?
</I>
Regex typo. This will match any URL with &quot;watc&quot; *anywhere* in it.

I think you meant  &quot;watch\?&quot;


&gt;<i> acl dp url_regex -i youtube
</I>&gt;<i> acl dp url_regex -i facebook
</I>&gt;<i> delay_access 1 allow dp lentos
</I>&gt;<i> acl auth proxy_auth REQUIRED
</I>&gt;<i> acl internet_full&#160;&#160;&#160;&#160;&#160;&#160; external memberof &quot;/etc/squid3/internet_full.txt&quot;
</I>&gt;<i> acl internet_limitado&#160;&#160; external memberof
</I>&gt;<i> &quot;/etc/squid3/internet_limitado.txt&quot;
</I>&gt;<i> acl internet_limitado2&#160; external memberof
</I>&gt;<i> &quot;/etc/squid3/internet_limitado2.txt&quot;
</I>&gt;<i> acl destinos_permitidos&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; dstdomain &quot;/etc/squid3/destinos_permitidos&quot;
</I>&gt;<i> acl destinos_permitidos2&#160;&#160;&#160;&#160;&#160;&#160;&#160; dstdomain &quot;/etc/squid3/destinos_permitidos2&quot;
</I>&gt;<i> acl sitios_denegados&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; dstdomain &quot;/etc/squid3/sitios_denegados&quot;
</I>&gt;<i> acl prohibidos&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; dstdomain &quot;/etc/squid3/prohibidos.txt&quot;
</I>&gt;<i> acl prohibidos-full&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; dstdomain &quot;/etc/squid3/prohibidos-full.txt&quot;
</I>&gt;<i> acl intfull-&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; dstdomain &quot;/etc/squid3/intfull-&quot;
</I>&gt;<i> acl allowedsites&#160;&#160;&#160;&#160;&#160;&#160;&#160; dstdomain &quot;/etc/squid3/allowedsites.txt&quot;
</I>&gt;<i> acl manager proto cache_object
</I>&gt;<i> acl SSL_ports port 443
</I>&gt;<i> acl CONNECT method CONNECT
</I>
You are missing the rules that prevent security attacks against the
proxy. DoS and such. Please re-add them.

If there is traffic you want to go through which those rules deny you
should adjust the Safe_ports and/or SSL_ports ACLs instead of removing
these lines.

 http_access deny !Safe_ports
 http_access deny CONNECT !SSL_ports


&gt;<i> http_access allow manager localhost
</I>&gt;<i> http_access deny manager
</I>&gt;<i> http_access allow localhost
</I>&gt;<i> http_access deny !auth
</I>&gt;<i> http_access deny sitios_denegados all
</I>
The &quot;all&quot; on the line above is not useful.

&gt;<i> http_access allow allowedsites
</I>&gt;<i> http_access allow limitados !dnld !streaming !streaming1 !sitios_denegados
</I>&gt;<i> http_access allow !dnld !streaming !streaming1 destinos_permitidos
</I>&gt;<i> internet_limitado
</I>&gt;<i> http_access allow !dnld !streaming !streaming1 destinos_permitidos2
</I>&gt;<i> internet_limitado2
</I>&gt;<i> http_access allow !dnld_full !streaming !streaming1 !prohibidos-full
</I>&gt;<i> internet_full
</I>

Rather than long lists of exceptions to be re-checked on every request
it would be better to order the groups by increasing level of
restrictions and deny things early.



Like this:

  http_access allow allowedsites
  http_access deny streaming
  http_access deny streaming1

  http_access allow !dnld_full !prohibidos-full internet_full

  http_access deny !dnld

  http_access allow limitados !sitios_denegados

  http_access allow destinos_permitidos internet_limitado

  http_access allow destinos_permitidos2 internet_limitado2


&gt;<i> http_access deny all
</I>


Cheers
Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="020220.html">[squid-users] Issues With 3.1.20 and Windows Update
</A></li>
	<LI>Next message (by thread): <A HREF="020223.html">[squid-users] | Ignoring non-issuer CA from ... while squid -kparse
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20224">[ date ]</a>
              <a href="thread.html#20224">[ thread ]</a>
              <a href="subject.html#20224">[ subject ]</a>
              <a href="author.html#20224">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
