<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Need help about ICAP scan timeout/max file size for	big files
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Need%20help%20about%20ICAP%20scan%20timeout/max%20file%20size%20for%0A%09big%20files&In-Reply-To=%3C7e8169f092321085e591faaa7642d589%40schroeffu.ch%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="019900.html">
   <LINK REL="Next"  HREF="019899.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Need help about ICAP scan timeout/max file size for	big files</H1>
    <B>info at schroeffu.ch</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Need%20help%20about%20ICAP%20scan%20timeout/max%20file%20size%20for%0A%09big%20files&In-Reply-To=%3C7e8169f092321085e591faaa7642d589%40schroeffu.ch%3E"
       TITLE="[squid-users] Need help about ICAP scan timeout/max file size for	big files">info at schroeffu.ch
       </A><BR>
    <I>Fri Jan  4 10:38:59 UTC 2019</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="019900.html">[squid-users] Web Socket Support For Reverse Proxy
</A></li>
        <LI>Next message (by thread): <A HREF="019899.html">[squid-users] Need help about ICAP scan timeout/max file size for big files
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19898">[ date ]</a>
              <a href="thread.html#19898">[ thread ]</a>
              <a href="subject.html#19898">[ subject ]</a>
              <a href="author.html#19898">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi all,

i am trying to solve the problem, that SQUID is caching all the big files (for example 1GB) before sending them to the client, but the connected ICAP virus scanner is configured with max_file_size 2MB and scan_timeout 5 seconds. So all bigger files, or longer scanning times, should result in &quot;clean&quot; state from the icap virus scanner.

I am running antivirus FSIGK (F-Secure Internet GateKeeper) as an ICAP daemon connected to Squid with this configuration:

#ICAP
icap_enable on
acl domains_dont_icapscan url_regex -i &quot;/etc/squid/ka/domains_dont_icapscan.acl&quot;
acl audio rep_mime_type -i ^(audio/x-mpegurl|audio/mpeg|audio/ogg|audio/aac|audio/mp3)$

icap_service service_req reqmod_precache bypass=1 <A HREF="icap://127.0.0.1:1344/request">icap://127.0.0.1:1344/request</A>
adaptation_access service_req allow !domains_dont_icapscan
icap_service service_resp respmod_precache bypass=1 <A HREF="icap://127.0.0.1:1344/response">icap://127.0.0.1:1344/response</A>
adaptation_access service_resp allow !domains_dont_icapscan !audio

Detecting viruses is working, but downloading large files is a huge problem. Squid is downloading them completely first into the servers memory and caching them, before sending them to the client. Its not stop scanning &amp; caching after 2MB/5Seconds. When downloading big files (f.e. 1gb) the browser just does nothing but waiting a long time, because squid is downloading and caching 1gb before forward to client.

I tried change respmod_precache to respmod_postcache but it seems not to be implemented yet, with respmod_postcache fsigk icap log is empty , no virus detection works anymore.
I have a test-virus-file with 100MB (<A HREF="https://schroeffu.ch/100mbrandomvirus_begin.txt">https://schroeffu.ch/100mbrandomvirus_begin.txt</A> (<A HREF="https://schroeffu.ch/100mbrandomvirus_begin.txt">https://schroeffu.ch/100mbrandomvirus_begin.txt</A>) eicar+randomcontent) and the virus is detected by fsigk with settings max_scan_size=104400136 / scan_timeout=9000 , change them to max_scan_size=2147483 (2mb) and scan_timeout=5 (5Seconds) the virus is correctly not detected anymore, but, squid still does cache the 100mb before sending to the client.

How can I configure the ICAP Service to truly let bigger files/longer scan times through the icap service marked as &quot;clean&quot;?

Thanks for any help!
Schroeffu
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20190104/d495aa1e/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20190104/d495aa1e/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="019900.html">[squid-users] Web Socket Support For Reverse Proxy
</A></li>
	<LI>Next message (by thread): <A HREF="019899.html">[squid-users] Need help about ICAP scan timeout/max file size for big files
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19898">[ date ]</a>
              <a href="thread.html#19898">[ thread ]</a>
              <a href="subject.html#19898">[ subject ]</a>
              <a href="author.html#19898">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
