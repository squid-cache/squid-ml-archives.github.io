<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Need help about ICAP scan timeout/max file size for big files
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Need%20help%20about%20ICAP%20scan%20timeout/max%20file%20size%0A%20for%20big%20files&In-Reply-To=%3C8dd230a5-b951-056b-372b-26f72698b64a%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="019898.html">
   <LINK REL="Next"  HREF="019902.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Need help about ICAP scan timeout/max file size for big files</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Need%20help%20about%20ICAP%20scan%20timeout/max%20file%20size%0A%20for%20big%20files&In-Reply-To=%3C8dd230a5-b951-056b-372b-26f72698b64a%40treenet.co.nz%3E"
       TITLE="[squid-users] Need help about ICAP scan timeout/max file size for big files">squid3 at treenet.co.nz
       </A><BR>
    <I>Fri Jan  4 12:14:18 UTC 2019</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="019898.html">[squid-users] Need help about ICAP scan timeout/max file size for	big files
</A></li>
        <LI>Next message (by thread): <A HREF="019902.html">[squid-users] Need help about ICAP scan timeout/max file size for big files
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19899">[ date ]</a>
              <a href="thread.html#19899">[ thread ]</a>
              <a href="subject.html#19899">[ subject ]</a>
              <a href="author.html#19899">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 4/01/19 11:38 pm, <A HREF="https://lists.squid-cache.org/listinfo/squid-users">info at schroeffu.ch</A> wrote:
&gt;<i> 
</I>&gt;<i> Hi all,
</I>&gt;<i> 
</I>&gt;<i> i am trying to solve the problem, that SQUID is caching all the big
</I>&gt;<i> files (for example 1GB) before sending them to the client, but the
</I>&gt;<i> connected ICAP virus scanner is configured with max_file_size 2MB and
</I>&gt;<i> scan_timeout 5 seconds. So all bigger files, or longer scanning times,
</I>&gt;<i> should result in &quot;clean&quot; state from the icap virus scanner.
</I>&gt;<i> 
</I>&gt;<i> I am running antivirus FSIGK (F-Secure Internet GateKeeper) as an ICAP
</I>&gt;<i> daemon connected to Squid with this configuration:
</I>&gt;<i> 
</I>&gt;<i> #ICAP
</I>&gt;<i> icap_enable on
</I>&gt;<i> acl domains_dont_icapscan url_regex -i
</I>&gt;<i> &quot;/etc/squid/ka/domains_dont_icapscan.acl&quot;
</I>&gt;<i> acl audio rep_mime_type -i
</I>&gt;<i> ^(audio\/x-mpegurl|audio\/mpeg|audio\/ogg|audio\/aac|audio/mp3)$
</I>&gt;<i> 
</I>&gt;<i> icap_service service_req reqmod_precache bypass=1
</I>&gt;<i> <A HREF="icap://127.0.0.1:1344/request">icap://127.0.0.1:1344/request</A>
</I>&gt;<i> adaptation_access service_req allow !domains_dont_icapscan
</I>
&gt;<i> icap_service service_resp respmod_precache bypass=1
</I>&gt;<i> <A HREF="icap://127.0.0.1:1344/response">icap://127.0.0.1:1344/response</A>
</I>
&gt;<i> adaptation_access service_resp allow !domains_dont_icapscan !audio
</I>
The above line says that everything which is not *both* an audio file
and on your dont-scan list does get scanned.

In other words, you can only whitelist audio responses.


&gt;<i> 
</I>&gt;<i> Detecting viruses is working, but downloading large files is a huge
</I>&gt;<i> problem. Squid is downloading them completely first into the servers
</I>&gt;<i> memory and caching them,&gt; before sending them to the client. Its not stop
</I>&gt;<i> scanning &amp; caching after 2MB/5Seconds.
</I>
Squid is not scanning. The whole point of ICAP is that something *else*
is doing the content manipulation/scanning.

Squid is just a relaying the content octets blindly between the various
agents using it.


&gt;<i> When downloading big files (f.e.
</I>&gt;<i> 1gb) the browser just does nothing but waiting a long time, because
</I>&gt;<i> squid is downloading and caching 1gb before forward to client.
</I>
The amount of memory used will depend on other config settings which you
have not shown. Please provide all your config so we can analyze the
problem in full context of what is going on around these ICAP services.


&gt;<i> 
</I>&gt;<i> I tried change respmod_precache to respmod_postcache but it seems not to
</I>&gt;<i> be implemented yet, with respmod_postcache fsigk icap log is empty , no
</I>&gt;<i> virus detection works anymore.
</I>
Correct. Post-cache ICAP hooks are not supported/implemented by Squid.

If scanning it once (pre-cache) is slow then scanning it per-fetch / N
times (aka post-cache) would be at least N times slower.



&gt;<i> I have a test-virus-file with 100MB
</I>&gt;<i> (<A HREF="https://schroeffu.ch/100mbrandomvirus_begin.txt">https://schroeffu.ch/100mbrandomvirus_begin.txt</A> eicar+randomcontent)
</I>&gt;<i> and the virus is detected by fsigk with settings max_scan_size=104400136
</I>&gt;<i> / scan_timeout=9000 , change them to max_scan_size=2147483 (2mb) and
</I>&gt;<i> scan_timeout=5 (5Seconds) the virus is correctly not detected anymore,
</I>
These sound like config setting for the scanning operation. None of that
has any relevance to Squid.

The file is a TXT file not an audio file, so as far as Squid can tell it
is always to be delivered to the scanner.


&gt;<i> but, squid still does cache the 100mb before sending to the client.
</I>&gt;<i> 
</I>&gt;<i> How can I configure the ICAP Service to truly let bigger files/longer
</I>&gt;<i> scan times through the icap service marked as &quot;clean&quot;?
</I>

What you describe sounds like problems identified with ClamAV early on.
It turned out clam was storing the object to disk and waiting for it to
complete before scanning and providing any output to Squid.

Please check whether the scanner you are using does that type of behaviour.


Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="019898.html">[squid-users] Need help about ICAP scan timeout/max file size for	big files
</A></li>
	<LI>Next message (by thread): <A HREF="019902.html">[squid-users] Need help about ICAP scan timeout/max file size for big files
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19899">[ date ]</a>
              <a href="thread.html#19899">[ thread ]</a>
              <a href="subject.html#19899">[ subject ]</a>
              <a href="author.html#19899">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
