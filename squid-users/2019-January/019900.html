<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Web Socket Support For Reverse Proxy
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Web%20Socket%20Support%20For%20Reverse%20Proxy&In-Reply-To=%3C1b15383eb84ea73bb10406cdb2ae986a%40dweimer.net%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="019897.html">
   <LINK REL="Next"  HREF="019898.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Web Socket Support For Reverse Proxy</H1>
    <B>Dean E. Weimer</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Web%20Socket%20Support%20For%20Reverse%20Proxy&In-Reply-To=%3C1b15383eb84ea73bb10406cdb2ae986a%40dweimer.net%3E"
       TITLE="[squid-users] Web Socket Support For Reverse Proxy">dweimer at dweimer.net
       </A><BR>
    <I>Fri Jan  4 13:41:27 UTC 2019</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="019897.html">[squid-users] Web Socket Support For Reverse Proxy
</A></li>
        <LI>Next message (by thread): <A HREF="019898.html">[squid-users] Need help about ICAP scan timeout/max file size for	big files
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19900">[ date ]</a>
              <a href="thread.html#19900">[ thread ]</a>
              <a href="subject.html#19900">[ subject ]</a>
              <a href="author.html#19900">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 2019-01-04 1:39 am, Amos Jeffries wrote:
&gt;<i> On 4/01/19 5:48 am, Dean E. Weimer wrote:
</I>&gt;&gt;<i> I am running Squid as a reverse proxy for several internally hosted
</I>&gt;&gt;<i> websites, some HTTP and some HTTPS with wild card cerrtificate. We 
</I>&gt;&gt;<i> have
</I>&gt;&gt;<i> recently setup a Atlassian Confluence Server, and are unable to edit 
</I>&gt;&gt;<i> any
</I>&gt;&gt;<i> documents through the reverse proxy. On inspection of client web 
</I>&gt;&gt;<i> console
</I>&gt;&gt;<i> logs we are receiving the following error.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> failed: Error during WebSocket handshake: Unexpected response code: 
</I>&gt;&gt;<i> 200
</I>&gt;&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> The client software does not support the WebSockets fallback
</I>&gt;<i> mechanism(s) properly.
</I>
Searching for Fallback information led me to find part of the issue.


It appears that the Confluence web application is using synchrony to 
handle collaborative editing they wrote their own proxy to proxy the web 
socket requests to the synchrony app from within their app. That proxy 
has a known issue of not supporting the fallback feature. Apparently 
this was reported as a major bug in release notes of the beta version of 
the first 6.0 release and hasn't been addressed. The current 
documentation lists it as supported by default and tells you how to 
disable it if for some reason you don't want to allow fallback support.

&lt;<A HREF="https://jira.atlassian.com/browse/CONFSERVER-44250">https://jira.atlassian.com/browse/CONFSERVER-44250</A>&gt;

XHR fallback has known issues when synchrony service is accessed via the 
synchrony-proxy web application.

Workaround is to ensure that browser traffic goes direct to synchrony 
instead of being routed via the confluence synchrony-proxy web 
application.


&gt;&gt;<i> I have been searching the Squid documentation and can't find anything 
</I>&gt;&gt;<i> on
</I>&gt;&gt;<i> web sockets. Is it not supported in reverse proxy mode?
</I>&gt;<i> 
</I>&gt;<i> Indeed. 200 status is a &quot;success&quot; response from the origin. The data
</I>&gt;<i> requested is still being delivered, just with HTTP instead of 
</I>&gt;<i> WebSockets.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> Currently running Squid 4.3, the cache peer for the specific server 
</I>&gt;&gt;<i> is.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> cache_peer 10.20.10.25 parent 8490 0 ssl no-query no-digest 
</I>&gt;&gt;<i> originserver
</I>&gt;&gt;<i> name=confluence_parent sslcapath=/usr/local/share/certs
</I>&gt;&gt;<i> sslflags=DONT_VERIFY_PEER login=PASSTHRU front-end-https=on proxy-only
</I>&gt;&gt;<i> cache_peer_access confluence_parent allow CONFLUENCE SSL
</I>&gt;&gt;<i> cache_peer_access confluence_parent deny all
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> The confluence server is configured to use a proxy, and is aware that 
</I>&gt;&gt;<i> it
</I>&gt;&gt;<i> is there.
</I>&gt;<i> 
</I>&gt;<i> That could be the problem then. Why does the *server* need configuring
</I>&gt;<i> to *use* a proxy?
</I>&gt;<i> 
</I>&gt;<i> Clients use a proxy to fetch requests. Servers *receive* requests from 
</I>&gt;<i> a
</I>&gt;<i> proxy.
</I>
The proxy configuration on the server tells it the hostname and port 
used on the proxy to properly rewrite the links.

&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Amos
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>
-- 
Thanks,
    Dean E. Weimer
    <A HREF="http://www.dweimer.net/">http://www.dweimer.net/</A>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="019897.html">[squid-users] Web Socket Support For Reverse Proxy
</A></li>
	<LI>Next message (by thread): <A HREF="019898.html">[squid-users] Need help about ICAP scan timeout/max file size for	big files
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19900">[ date ]</a>
              <a href="thread.html#19900">[ thread ]</a>
              <a href="subject.html#19900">[ subject ]</a>
              <a href="author.html#19900">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
