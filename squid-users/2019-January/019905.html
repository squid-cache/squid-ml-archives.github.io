<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid 4.1 Error negotiating SSL connection
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%204.1%20Error%20negotiating%20SSL%20connection&In-Reply-To=%3C00bd01d4a739%244ebc6150%24ec3523f0%24%40ngtech.co.il%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="019904.html">
   <LINK REL="Next"  HREF="019909.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid 4.1 Error negotiating SSL connection</H1>
    <B>eliezer at ngtech.co.il</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%204.1%20Error%20negotiating%20SSL%20connection&In-Reply-To=%3C00bd01d4a739%244ebc6150%24ec3523f0%24%40ngtech.co.il%3E"
       TITLE="[squid-users] Squid 4.1 Error negotiating SSL connection">eliezer at ngtech.co.il
       </A><BR>
    <I>Tue Jan  8 10:02:44 UTC 2019</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="019904.html">[squid-users] could not bind to binddn 'Can't contact LDAP server'
</A></li>
        <LI>Next message (by thread): <A HREF="019909.html">[squid-users] can't access https://www.finanzamt.bayern.de/ with sslbump (other sites works well)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19905">[ date ]</a>
              <a href="thread.html#19905">[ thread ]</a>
              <a href="subject.html#19905">[ subject ]</a>
              <a href="author.html#19905">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>So with 4.5 we are still waiting for openssl to advance into TLS 1.3, right?
Can the thread writer add a list of these domains which can help others?

Thanks,
Eliezer

----
Eliezer Croitoru
Linux System Administrator
Mobile: +972-5-28704261
Email: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">eliezer at ngtech.co.il</A>


-----Original Message-----
From: squid-users &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>&gt; On Behalf Of Amos Jeffries
Sent: Wednesday, July 4, 2018 07:21
To: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
Subject: Re: [squid-users] Squid 4.1 Error negotiating SSL connection

On 04/07/18 12:06, Julian Perconti wrote:
&gt;<i> Hi all,
</I>&gt;<i> 
</I>&gt;<i>  
</I>&gt;<i> 
</I>&gt;<i> I have installed squid 4.1 on debian 9 with openssl 1.1.0f on
</I>&gt;<i> transparent mode.
</I>&gt;<i> 
</I>&gt;<i>  
</I>&gt;<i> 
</I>&gt;<i> I need to know how to track this error: (debbuging options is almost
</I>&gt;<i> impossible i mean examine the FD, etc.)
</I>&gt;<i> 
</I>
The SSL-Bump activity is fairly complex at times and involves many
different layers and components. So an ALL,9 or ALL,7 debug log may be
necessary to trace the actions.

&gt;<i>  
</I>&gt;<i> 
</I>&gt;<i> kid1| Error negotiating SSL connection on FD 19:
</I>&gt;<i> error:00000001:lib(0):func(0):reason(1) (1/-1)
</I>&gt;<i> 
</I>&gt;<i> 
</I>

Those annoyingly opaque error messages are produced by your OpenSSL library.

Other programs showing that same string apparently are negotiating
protocol version for the messaging layer or handshake format which are
incompatible with the choice of ciphers. eg SSLv2 message syntax with
TLS ciphers, or SSLv3 message syntax with  TLS/1.2-only ciphers.

Since you have done the cipher test, it may be the SSLv2 issue or some
TLS extension being attempted.


If cache.log is too obscure a packet trace with wireshark may be less
so. The clear-text part of TLS at the start should have better hints
about the issue, whatever it is.


 
&gt;<i> 
</I>&gt;<i> There are a lot of them in cache.log when mobile devices uses
</I>&gt;<i> (unsuccefully) apps like instagram/Pinterest/Facebook/twitter, etc.
</I>&gt;<i> 
</I>&gt;<i>  
</I>&gt;<i> 
</I>&gt;<i> Neither is a &#8220;cipher-out&#8221; problem because I just tried:
</I>&gt;<i> tls_outgoing_options cipher=ALL (only for testing)
</I>&gt;<i> 
</I>
This test is mistaken.

&quot;cipher=ALL&quot; and &quot;options=ALL&quot; actually mean to actively *enable* lots
of things OpenSSL would normally disable. This still counts as
restriction, because only things compatible with the most obsolete or
broken cipher/option can be negotiated.

A correct test would be to _remove_ the cipher=* option entirely from
your config and see what changes.

With no manual restrictions the issues are then limited to natural
differences in OpenSSL version between client and Squid.


&gt;<i> 
</I>&gt;<i> From any PC those sites works well. So there is not a certificate
</I>&gt;<i> missing problem.
</I>&gt;<i> 
</I>
When SSL-Bump is done crypto issues are the union of configured
capabilities at client (PC), proxy (Squid), server - plus the 3
particular crypto libraries on each of those uses. So 6 possible points
of failure, all affecting each other.

I find it is often a LOT easier (and more successful) to look at the TLS
handshake itself and see what is actually happening. Then figure out
from there what needs tuning to work around it.


&gt;<i> 
</I>&gt;<i> Here a copy of most relevant config:
</I>&gt;<i> 
</I>&gt;<i>  
</I>&gt;<i> 
</I>&gt;<i> =================CFG==================
</I>&gt;<i> 
</I>&gt;<i>  
</I>&gt;<i> 
</I>&gt;<i> http_port 3128
</I>&gt;<i> 
</I>&gt;<i> http_port 3129 intercept
</I>&gt;<i> 
</I>&gt;<i> https_port 3130 intercept ssl-bump \
</I>&gt;<i> 
</I>&gt;<i>   cert=/etc/squid/ssl_cert/squid4ssl.pem \
</I>&gt;<i> 
</I>&gt;<i>   key=/etc/squid/ssl_cert/squid4ssl.pem \
</I>&gt;<i> 
</I>&gt;<i>   generate-host-certificates=on dynamic_cert_mem_cache_size=4MB
</I>&gt;<i> 
</I>&gt;<i>  
</I>&gt;<i> 
</I>&gt;<i> sslcrtd_program /lib/squid/security_file_certgen -s /var/lib/ssl_db -M 4MB
</I>&gt;<i> 
</I>&gt;<i>  
</I>&gt;<i> 
</I>&gt;<i> tls_outgoing_options cafile=/etc/ssl/certs/ca-certificates.crt
</I>&gt;<i> 
</I>&gt;<i> tls_outgoing_options cafile=/etc/squid/ssl_cert/cabundle.pem
</I>&gt;<i> 
</I>&gt;<i> tls_outgoing_options options=NO_SSLv3
</I>&gt;<i> 
</I>
This NO_SSLv3 may be part of issue. AFAIK when SSLv3 compatibility is no
longer required the latest OpenSSL is able to move to pure TLS message
syntax which has a few usually very minor differences which TLS/1.3 uses.

The services you mention are the ones IME most likely to be adopting
TLS/1.3 already when clients like your Squid accept it. Which is where
PC vs Squid library differences can lead to drastically different
visible outcomes.


&gt;<i> tls_outgoing_options
</I>&gt;<i> cipher=ALL:!SSLv2:!ADH:!DSS:!MD5:!EXP:!DES:!PSK:!SRP:!RC4:!IDEA:!SEED:!aNULL:!eNULL
</I>&gt;<i> 
</I>

HTH
Amos
_______________________________________________
squid-users mailing list
<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
<A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="019904.html">[squid-users] could not bind to binddn 'Can't contact LDAP server'
</A></li>
	<LI>Next message (by thread): <A HREF="019909.html">[squid-users] can't access https://www.finanzamt.bayern.de/ with sslbump (other sites works well)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19905">[ date ]</a>
              <a href="thread.html#19905">[ thread ]</a>
              <a href="subject.html#19905">[ subject ]</a>
              <a href="author.html#19905">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
