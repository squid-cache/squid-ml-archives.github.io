<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Need help about ICAP scan timeout/max file size for big files
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Need%20help%20about%20ICAP%20scan%20timeout/max%20file%20size%0A%20for%20big%20files&In-Reply-To=%3C5826e10ffcf1341dbc4d5e2a4e635321%40schroeffu.ch%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="019902.html">
   <LINK REL="Next"  HREF="019911.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Need help about ICAP scan timeout/max file size for big files</H1>
    <B>info at schroeffu.ch</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Need%20help%20about%20ICAP%20scan%20timeout/max%20file%20size%0A%20for%20big%20files&In-Reply-To=%3C5826e10ffcf1341dbc4d5e2a4e635321%40schroeffu.ch%3E"
       TITLE="[squid-users] Need help about ICAP scan timeout/max file size for big files">info at schroeffu.ch
       </A><BR>
    <I>Tue Jan  8 16:46:13 UTC 2019</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="019902.html">[squid-users] Need help about ICAP scan timeout/max file size for big files
</A></li>
        <LI>Next message (by thread): <A HREF="019911.html">[squid-users] Need help about ICAP scan timeout/max file size for big files
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19908">[ date ]</a>
              <a href="thread.html#19908">[ thread ]</a>
              <a href="subject.html#19908">[ subject ]</a>
              <a href="author.html#19908">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Alex (&amp; hi Amos)

it depends on the ICAP Service. The one I am trying to use is F-Secure FSICAPD which is not working as expected.

So i compared with ClamAV C-ICAP: With ClamAV C-ICAP there is defined &quot;MaxStreamSize 25M&quot; as default, so after 25MB scanned by ICAP I can see with tcpdump on port 1344 &quot;ICAP/1.0 200 OK&quot; from ICAP to Squid which triggers the browser to start the download. Thats what i want also for F-Secure ICAP.

#ClamAV MaxStreamSize reached ICAP response:
ICAP/1.0 200 OK
Server: C-ICAP/0.4.4
Connection: keep-alive
ISTag: CI0001-1-squidclamav-10
Encapsulated: res-hdr=0, res-body=331

Unfortunately, the F-Secure ICAP is not sending this &quot;ICAP/1.0 200 OK&quot; after X MB or X Seconds. I am in touch with them if this is a bug, i dont know yet, they're checking that. So, if their ICAP really is not sending &quot;ICAP/1.0 200 OK&quot; after X Seconds/MB, can I configure SQUID with a workaround?

So, to your questions:

&gt;<i> 1. How to configure Squid to never send huge files to your ICAP service?
</I>
Yes, as a workaround, but how? Header of big files are usually not included.

&gt;<i> 2. How to configure your ICAP service to speed up huge-file decisions?
</I>
The header seems not include the file size. Here is an example of 100MB Virus File (EICAR Signature at the beginning) Header:

RESPMOD <A HREF="icap://127.0.0.1:1344/response">icap://127.0.0.1:1344/response</A> ICAP/1.0
Host: 127.0.0.1:1344
Date: Fri, 04 Jan 2019 15:56:48 GMT
Encapsulated: req-hdr=0, res-hdr=434, res-body=676

GET <A HREF="https://schroeffu.ch/100mbrandomvirus_begin.txt">https://schroeffu.ch/100mbrandomvirus_begin.txt</A> HTTP/1.1
User-Agent: Mozilla/5.0 (Windows NT 6.3; Win64; x64; rv:64.0) Gecko/20100101 Firefox/64.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
Accept-Language: de,en-US;q=0.7,en;q=0.3
Accept-Encoding: gzip, deflate, br
Cookie: _pk_id.n/a.1636=5b8e9d8d8516ea65.1546604985.1.1546604985.1546604985.
Upgrade-Insecure-Requests: 1
Host: schroeffu.ch

HTTP/1.1 200 OK
Server: nginx
Date: Fri, 04 Jan 2019 15:56:48 GMT
Content-Type: text/plain
Last-Modified: Fri, 04 Jan 2019 15:31:19 GMT
Vary: Accept-Encoding
ETag: W/&quot;5c2f7c47-61a8088&quot;
X-Powered-By: PleskLin
Content-Encoding: gzip

The 200 OK reaches Squid after 100% of 100MB has been scanned by F-secure ICAP after 114 Seconds (!),  means, the browser is 114 Seconds doing nothing but watiting:

ICAP/1.0 200 OK
Server: F-Secure ICAP Server
ISTag: &quot;FSAV-2019-01-02_04&quot;
Connection: keep-alive
Expires: Fri, 04 Jan 2019 16:58:42 GMT
X-FSecure-Scan-Result: clean
X-FSecure-ORSP-FRS-Duration: 5.005693
X-FSecure-Transaction-Duration: 114.205939
X-FSecure-Versions: F-Secure Corporation Hydra/5.22 build 28/2018-12-28_01 F-Secure Corporation Aquarius/1.0 build 8/2019-01-02_04 fsavd/1.0/0148 fsicapd/1.1.277-263d28a
Encapsulated: res-hdr=0, res-body=242

&gt;<i> 3. How to configure Squid to send huge files to your ICAP service without storing them in Squid memory or in Squid disk cache?
</I>
No, this point we can forget.

I think best would be to configure squid, if ICAP is not able to scan the complete request in 10 seconds, skip (or mark as clean) and let browser download it. 10 seconds icap scan timeout seems to be the default in ESET Linux Gateway ICAP too. Can I configure that in Squid?

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="019902.html">[squid-users] Need help about ICAP scan timeout/max file size for big files
</A></li>
	<LI>Next message (by thread): <A HREF="019911.html">[squid-users] Need help about ICAP scan timeout/max file size for big files
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19908">[ date ]</a>
              <a href="thread.html#19908">[ thread ]</a>
              <a href="subject.html#19908">[ subject ]</a>
              <a href="author.html#19908">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
