<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Need help about ICAP scan timeout/max file size for big files
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Need%20help%20about%20ICAP%20scan%20timeout/max%20file%20size%0A%20for%20big%20files&In-Reply-To=%3C90db7988-22dd-46ff-a2bf-b03315f2e8f1%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="019908.html">
   <LINK REL="Next"  HREF="019901.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Need help about ICAP scan timeout/max file size for big files</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Need%20help%20about%20ICAP%20scan%20timeout/max%20file%20size%0A%20for%20big%20files&In-Reply-To=%3C90db7988-22dd-46ff-a2bf-b03315f2e8f1%40measurement-factory.com%3E"
       TITLE="[squid-users] Need help about ICAP scan timeout/max file size for big files">rousskov at measurement-factory.com
       </A><BR>
    <I>Tue Jan  8 18:09:22 UTC 2019</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="019908.html">[squid-users] Need help about ICAP scan timeout/max file size for big files
</A></li>
        <LI>Next message (by thread): <A HREF="019901.html">[squid-users] [squid-announce] Squid-4.5 is available
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19911">[ date ]</a>
              <a href="thread.html#19911">[ thread ]</a>
              <a href="subject.html#19911">[ subject ]</a>
              <a href="author.html#19911">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 1/8/19 9:46 AM, <A HREF="https://lists.squid-cache.org/listinfo/squid-users">info at schroeffu.ch</A> wrote:

&gt;<i> With ClamAV C-ICAP there is defined &quot;MaxStreamSize 25M&quot; as default,
</I>&gt;<i> so after 25MB scanned by ICAP I can see with tcpdump on port 1344
</I>&gt;<i> &quot;ICAP/1.0 200 OK&quot; from ICAP to Squid which triggers the browser to
</I>&gt;<i> start the download. Thats what i want also for F-Secure ICAP.
</I>
The best solution would be for F-Secure to add support for (or enable in
your setup) &quot;data trickling&quot; or &quot;patience pages&quot;. Any workarounds inside
Squid would be either nasty (e.g., timeouts, abandoned transactions,
etc.) or expensive (require Squid or eCAP/ICAP wrapper development).


&gt;<i> if their ICAP really is not sending &quot;ICAP/1.0 200 OK&quot; after X
</I>&gt;<i> Seconds/MB, can I configure SQUID with a workaround?
</I>
You can try to specify a timeout via icap_io_timeout. Bugs
notwithstanding, Squid would terminate a connection to the ICAP service
that does not respond in X seconds. You may need to adjust
icap_service_failure_limit and/or icap_service_revival_delay to avoid
marking the affected ICAP service as &quot;down&quot; [too often]. Again, this is
not a proper solution and it may have negative side effects such as
memory leaks and unresponsive ICAP service. It may be worth trying while
you wait for F-Secure.

Unfortunately, the icap_io_timeout may not work if Squid is constantly
writing to the ICAP service (to deliver more virgin body bytes). Squid
should be treating each such write as an I/O, resetting the timeout.


You can also hack Squid to treat these cases specially. For example, you
could add adaptation_response_timeout or a similar directive that would
work like icap_io_timeout but ignore write activity. If you go down that
route, I suggest posting an RFC with new option description to squid-dev
as the first step.


You can even write an ICAP service (or eCAP adapter) that will add data
trickling or patience pages support to any ICAP service, but that is a
lot of development work!


&gt;<i> The header seems not include the file size. Here is an example of
</I>&gt;<i> 100MB Virus File
</I>
Please note that you should test/analyze &quot;real&quot; transactions, not
requests for test files. If real transactions of interest usually lack
the Content-Length header, then timeout-based knobs are your best bet
(see above): There are no ACLs that can match accumulated response size
and, more importantly, there is no directive that would repeatedly
evaluate such ACLs as Squid accumulates the response body while waiting
for the ICAP response.


HTH,

Alex.

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="019908.html">[squid-users] Need help about ICAP scan timeout/max file size for big files
</A></li>
	<LI>Next message (by thread): <A HREF="019901.html">[squid-users] [squid-announce] Squid-4.5 is available
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19911">[ date ]</a>
              <a href="thread.html#19911">[ thread ]</a>
              <a href="subject.html#19911">[ subject ]</a>
              <a href="author.html#19911">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
