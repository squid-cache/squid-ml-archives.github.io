<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] FTP inspection configuration
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20FTP%20inspection%20configuration&In-Reply-To=%3Ce93fc433-d3d0-fe8b-cb23-bae6ff2c9d29%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="019946.html">
   <LINK REL="Next"  HREF="019954.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] FTP inspection configuration</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20FTP%20inspection%20configuration&In-Reply-To=%3Ce93fc433-d3d0-fe8b-cb23-bae6ff2c9d29%40treenet.co.nz%3E"
       TITLE="[squid-users] FTP inspection configuration">squid3 at treenet.co.nz
       </A><BR>
    <I>Wed Jan 16 03:33:55 UTC 2019</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="019946.html">[squid-users] FTP inspection configuration
</A></li>
        <LI>Next message (by thread): <A HREF="019954.html">[squid-users] squid 4.5, can't download certificate?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19948">[ date ]</a>
              <a href="thread.html#19948">[ thread ]</a>
              <a href="subject.html#19948">[ subject ]</a>
              <a href="author.html#19948">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 16/01/19 3:10 pm, eugene.elyashev wrote:
&gt;<i> Hello,
</I>&gt;<i> I'm trying to configure squid 3.5.6 as an FTP proxy for native FTP uploads
</I>&gt;<i> to be inspected by an ICAP service.
</I>
Please try an upgrade, there have been a lot of fixes in the 3+ years
since that release. Current production/stable release is v4.5.

For the FTP issues 3.5.28 would be enough of an upgrade. But ...

Since you are also using SSL-Bump you should be tracking the latest
Squid releases and upgrading frequently. TLS is a highly volatile
environment - almost every Squid release since v3.2 has had additions to
cope with that.


&gt;<i> 
</I>&gt;<i> Currently FileZilla fails to connect via proxy and also telnet on port 21
</I>&gt;<i> fails..
</I>&gt;<i> 
</I>&gt;<i> What is missing in the config and how to configure FileZilla connection?
</I>&gt;<i> 
</I>
Your ICAP service is only processing PUT and POST transactions. IIRC, at
least some of the FTP native messaging occurs as GET.

...
&gt;<i> 
</I>&gt;<i> http_port 3128 ssl-bump
</I>&gt;<i> cert=/usr/local/squid-3.5.6/ssl_cert/squid356_https.pem
</I>&gt;<i> key=/usr/local/squid-3.5.6/ssl_cert/squid356_https.pem
</I>&gt;<i> always_direct allow all
</I>
The above is not necessary in v3.2+, it was only useful as a hack
workaround for a bug in a single v3.1.x point release.


&gt;<i> ssl_bump server-first all
</I>
This bumping mode is deprecated due to lack of ability to cope with
modern TLS extensions and behaviour (ie. TLS SNI). Use the v3.5+ actions
instead
 &lt;<A HREF="https://wiki.squid-cache.org/Features/SslPeekAndSplice">https://wiki.squid-cache.org/Features/SslPeekAndSplice</A>&gt;


&gt;<i> sslproxy_flags DONT_VERIFY_PEER
</I>
Please do not do this, ever. It only prevents *you* from seeing problems
(eg to debug them), they still exist and affect the traffic.
 Remove the above line and then actually fix any problems that are then
visible.


&gt;<i> ftp_port 21
</I>&gt;<i> 
</I>&gt;<i> coredump_dir /usr/local/squid-3.5.6/var/cache/squid
</I>&gt;<i> 
</I>&gt;<i> refresh_pattern ^ftp:		1440	20%	10080
</I>&gt;<i> refresh_pattern ^gopher:	1440	0%	1440
</I>&gt;<i> refresh_pattern -i (/cgi-bin/|\?) 0	0%	0
</I>&gt;<i> refresh_pattern .		0	20%	4320
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> acl vontu_reqmod_http_upload method POST PUT
</I>&gt;<i> icap_service vontu_reqmod reqmod_precache 0 <A HREF="icap://&lt;icap_server:1344">icap://&lt;icap_server:1344</A>&gt;/reqmod
</I>&gt;<i> adaptation_service_set class_vontu_reqmod vontu_reqmod
</I>&gt;<i> adaptation_access class_vontu_reqmod allow vontu_reqmod_http_upload
</I>&gt;<i> 
</I>
The ACL above restricting the ICAP service to only seeing PUT and POT
requests is probably the cause of your problem.

Another possibility is one of the ICAP bugs which have been fixed in
later v3.5 releases.


Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="019946.html">[squid-users] FTP inspection configuration
</A></li>
	<LI>Next message (by thread): <A HREF="019954.html">[squid-users] squid 4.5, can't download certificate?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#19948">[ date ]</a>
              <a href="thread.html#19948">[ thread ]</a>
              <a href="subject.html#19948">[ subject ]</a>
              <a href="author.html#19948">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
