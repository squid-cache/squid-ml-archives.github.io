<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] squid on openwrt: Possible to get rid of &quot;... SECURITY ALERT: Host header forgery detected ...&quot; msgs ?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid%20on%20openwrt%3A%20Possible%20to%20get%20rid%20of%20%22...%0A%20SECURITY%20ALERT%3A%20Host%20header%20forgery%20detected%20...%22%20msgs%20%3F&In-Reply-To=%3C5b9085e4-7d5b-6f7a-15c4-5e2056d20563%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="020015.html">
   <LINK REL="Next"  HREF="020025.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] squid on openwrt: Possible to get rid of &quot;... SECURITY ALERT: Host header forgery detected ...&quot; msgs ?</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid%20on%20openwrt%3A%20Possible%20to%20get%20rid%20of%20%22...%0A%20SECURITY%20ALERT%3A%20Host%20header%20forgery%20detected%20...%22%20msgs%20%3F&In-Reply-To=%3C5b9085e4-7d5b-6f7a-15c4-5e2056d20563%40treenet.co.nz%3E"
       TITLE="[squid-users] squid on openwrt: Possible to get rid of &quot;... SECURITY ALERT: Host header forgery detected ...&quot; msgs ?">squid3 at treenet.co.nz
       </A><BR>
    <I>Thu Jan 24 01:44:00 UTC 2019</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="020015.html">[squid-users] squid on openwrt: Possible to get rid of &quot;... SECURITY ALERT: Host header forgery detected ...&quot; msgs ?
</A></li>
        <LI>Next message (by thread): <A HREF="020025.html">[squid-users] squid on openwrt: Possible to get rid of &quot;... SECURITY ALERT: Host header forgery detected ...&quot; msgs ?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20017">[ date ]</a>
              <a href="thread.html#20017">[ thread ]</a>
              <a href="subject.html#20017">[ subject ]</a>
              <a href="author.html#20017">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 24/01/19 2:55 am, reinerotto wrote:
&gt;<i> I suspect, these messages, for example, are not caused by any malware, but
</I>&gt;<i> somehow by skype:
</I>&gt;<i> 
</I>&gt;<i> 2019/01/23 13:38:18 kid1| SECURITY ALERT: on URL:
</I>&gt;<i> mobile.pipe.aria.microsoft.com:443
</I>&gt;<i> 2019/01/23 13:38:18 kid1| SECURITY ALERT: Host header forgery detected on
</I>&gt;<i> local=52.114.76.35:443 remote=192.168.182.10:59312 FD 31 flags=33 (local IP
</I>&gt;<i> does not match any domain IP)
</I>&gt;<i> 2019/01/23 13:38:18 kid1| SECURITY ALERT: on URL:
</I>&gt;<i> mobile.pipe.aria.microsoft.com:443
</I>&gt;<i> 2019/01/23 13:39:03 kid1| SECURITY ALERT: Host header forgery detected on
</I>&gt;<i> local=52.114.74.44:443 remote=192.168.182.10:59378 FD 37 flags=33 (local IP
</I>&gt;<i> does not match any domain IP)
</I>&gt;<i> 2019/01/23 13:39:03 kid1| SECURITY ALERT: on URL:
</I>&gt;<i> mobile.pipe.aria.microsoft.com:443
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> May be,  some inconsistency of cached DNS in the client and the
</I>&gt;<i> openwrt-device, running squid.
</I>

I have checked those domains and their DNS results. Their IPs change
every 30sec to another random IP in a /16 block belonging to a company
which is *not* Microsoft. This is just one /16 out of the 10s of
millions of IPs MS have allocated.

If you can track down any inconsistency in DNS caching that would help
reduce the frequency of false-positive tests and generally improve the
behaviour of all software using that DNS cache.


Meanwhile directly addressing those warnings would be reducing or
removing the use of HTTP persistence on client connections.

 &lt;<A HREF="http://www.squid-cache.org/Doc/config/client_lifetime/">http://www.squid-cache.org/Doc/config/client_lifetime/</A>&gt;
 &lt;<A HREF="http://www.squid-cache.org/Doc/config/client_persistent_connections/">http://www.squid-cache.org/Doc/config/client_persistent_connections/</A>&gt;



&gt;<i> There are some &quot;rumours&quot;, that not all browsers correctly honor TTL for
</I>&gt;<i> cached DNS.
</I>
Um, I suspect you don't understand what that use of double-quote means:
rumours about rumours existing. Either way that does not matter.


What Browsers do is use persistent connections. Part of HTTP design, and
used in reasonable ways. It's just that DNS TTL may have different
duration - case in point being these Skype connections where the IP is
forced to change every 30sec, persistence is indefinite but usually
several minutes.
Consider having a Skype chat where you close and re-open the app every
30sec versus only doing that once and hour, or once a day. DNS Best
Practice is/was to use 24hr TTLs - the mega corps do their own thing, so
one guess why your logos are so annoying?


With short DNS TTL by the time a second (or third, or Nth) HTTP request
is sent in the connection the origin has all the appearance of having
moved elsewhere and become indistinguishable from an attacker diverting
traffic to get themselves a trivial tunnel into your network.


For now all we can do is take the warnings seriously and find ways to
prevent the network behaviours that cause them. The security issues this
detection prevents are so nasty we consider the pain (monetary costs,
latency and bandwidth - not just log sizes) worth the price of avoiding
those outcomes.


&gt;<i> 
</I>&gt;<i> Anyway, even, in case malware would trigger these messages, then this opens
</I>&gt;<i> the gate to attack resource limited squid-installations, like mine on
</I>&gt;<i> openwrt, by flooding cache.log, kept in RAM, and possibly forcing an
</I>&gt;<i> OOM-crash.
</I>&gt;<i> Simple fix would be to disable cache.log, but I am hesitating to do so, not
</I>&gt;<i> to drop more valuable messages.
</I>
That OpenWRT case is exactly what squid.conf &quot;debug_options rotate=N&quot;
option was designed for. Set the N to the number of cache.log files you
want to retain. A log monitor to trigger &quot;squid -k rotate&quot; when the logs
get too large completes the picture for complete control over how much
memory is spent on these logs.
 An older solution is to place a Unix pipe at the cache.log filesystem
path. Sending the log lines either directly to a processor or another
device entirely.

Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="020015.html">[squid-users] squid on openwrt: Possible to get rid of &quot;... SECURITY ALERT: Host header forgery detected ...&quot; msgs ?
</A></li>
	<LI>Next message (by thread): <A HREF="020025.html">[squid-users] squid on openwrt: Possible to get rid of &quot;... SECURITY ALERT: Host header forgery detected ...&quot; msgs ?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20017">[ date ]</a>
              <a href="thread.html#20017">[ thread ]</a>
              <a href="subject.html#20017">[ subject ]</a>
              <a href="author.html#20017">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
