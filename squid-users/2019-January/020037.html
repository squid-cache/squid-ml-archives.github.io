<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Fwd: Https blocked sites getting ssl error , with connection abruptly ending - Peek and splice feature
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Fwd%3A%20Https%20blocked%20sites%20getting%20ssl%20error%20%2C%0A%20with%20connection%20abruptly%20ending%20-%20Peek%20and%20splice%20feature&In-Reply-To=%3CCAL0CaX_O3C%3D1JJ_OHSEm_-M0CQrEx7RALcDov-6eYQKQKnwskg%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="020067.html">
   <LINK REL="Next"  HREF="020039.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Fwd: Https blocked sites getting ssl error , with connection abruptly ending - Peek and splice feature</H1>
    <B>bandeep2000</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Fwd%3A%20Https%20blocked%20sites%20getting%20ssl%20error%20%2C%0A%20with%20connection%20abruptly%20ending%20-%20Peek%20and%20splice%20feature&In-Reply-To=%3CCAL0CaX_O3C%3D1JJ_OHSEm_-M0CQrEx7RALcDov-6eYQKQKnwskg%40mail.gmail.com%3E"
       TITLE="[squid-users] Fwd: Https blocked sites getting ssl error , with connection abruptly ending - Peek and splice feature">bandeep2000 at gmail.com
       </A><BR>
    <I>Fri Jan 25 17:18:51 UTC 2019</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="020067.html">[squid-users] Using a static wildcard certificate with ssl-bump in explicit forward proxy mode
</A></li>
        <LI>Next message (by thread): <A HREF="020039.html">[squid-users] Fwd: Https blocked sites getting ssl error , with connection abruptly ending - Peek and splice feature
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20037">[ date ]</a>
              <a href="thread.html#20037">[ thread ]</a>
              <a href="subject.html#20037">[ subject ]</a>
              <a href="author.html#20037">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Everyone,

Have configured squid proxy with https whitelisted sites using ssl bump,
peek and splice feature
in transparent mode.
Although non whitelisted site are getting blocked, but it is not graceful,
with 'ssl connect error'  and  no 403 message(using curl). For http, it is
working fine with Access denied with 403 http error code.

Using ssl bump 'terminate all' seem to abruptly stop the connection, this
might cause issues in our application.

Is there a way to terminate the connection with access denied message
gracefully(with 403 error code)  just like it does for Http.

*Non Whitelisted site error:*

curl -I <A HREF="https://nba.com">https://nba.com</A>

*curl: (35) SSL connect error*

*http non whitelisted site:*

<A HREF="https://lists.squid-cache.org/listinfo/squid-users">c5278791 at ban-squid-client22</A> ~]$ curl -I <A HREF="http://nba.com">http://nba.com</A>

HTTP/1.1 403 Forbidden

Server: squid/3.5.28

Mime-Version: 1.0

Date: Fri, 25 Jan 2019 17:01:38 GMT

Content-Type: text/html;charset=utf-8

Content-Length: 3574

X-Squid-Error: ERR_ACCESS_DENIED 0

Vary: Accept-Language

Content-Language: en

X-Cache: MISS from squid

Via: 1.1 squid (squid/3.5.28)

Connection: keep-alive

*https whitelisted site works fine:*

curl -I <A HREF="https://cnn.com">https://cnn.com</A>

HTTP/1.1 301 Moved Permanently

Server: Varnish

Retry-After: 0

Content-Length: 0

Cache-Control: public, max-age=600

Location: <A HREF="https://www.cnn.com/">https://www.cnn.com/</A>

Accept-Ranges: bytes

Date: Fri, 25 Jan 2019 17:00:08 GMT

Via: 1.1 varnish

Connection: close

Set-Cookie: countryCode=US; Domain=.cnn.com; Path=/

Set-Cookie: geoData=mountain view|CA|94043|US|NA; Domain=.cnn.com; Path=/

X-Served-By: cache-sea1038-SEA

X-Cache: HIT

X-Cache-Hits: 0





*Squid.conf Details:*

visible_hostname squid



cache deny all

#Handling HTTP requests

http_port 3128 intercept

acl allowed_http_sites dstdomain .amazonaws.com .bbc.com

#acl allowed_http_sites dstdomain [you can add other domains to permit]

http_access allow allowed_http_sites



#Handling HTTPS requests

https_port 3130 cert=/etc/pki/tls/certs/squidCA.pem ssl-bump intercept

acl SSL_port port 443

http_access allow SSL_port

acl allowed_https_sites ssl::server_name .amazonaws.com .cnn.com .yahoo.com
.bbc.com

#acl allowed_https_sites ssl::server_name [you can add other domains to
permit]

acl step1 at_step SslBump1

acl step2 at_step SslBump2

acl step3 at_step SslBump3

ssl_bump peek step1 all

ssl_bump splice allowed_https_sites

#ssl_bump peek step2 all

ssl_bump terminate  all



http_access deny all


*Squid version:*

squid -v

Squid Cache: Version *3.5.28*

Service Name: squid


This binary uses OpenSSL 1.0.1e-fips 11 Feb 2013. For legal restrictions on
distribution see <A HREF="https://www.openssl.org/source/license.html">https://www.openssl.org/source/license.html</A>


configure options:  '--prefix=/usr' '--includedir=/usr/include'
'--datadir=/usr/share' '--bindir=/usr/sbin' '--libexecdir=/usr/lib/squid'
'--localstatedir=/var' '--sysconfdir=/etc/squid'
'--with-logdir=/var/log/squid' '--with-openssl' '--enable-ssl-crtd'
--enable-ltdl-convenien


*OS version:*

cat /etc/redhat-release

CentOS release 6.10 (Final)

Thanks,

-Bandeep
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20190125/32f83fa5/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20190125/32f83fa5/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="020067.html">[squid-users] Using a static wildcard certificate with ssl-bump in explicit forward proxy mode
</A></li>
	<LI>Next message (by thread): <A HREF="020039.html">[squid-users] Fwd: Https blocked sites getting ssl error , with connection abruptly ending - Peek and splice feature
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20037">[ date ]</a>
              <a href="thread.html#20037">[ thread ]</a>
              <a href="subject.html#20037">[ subject ]</a>
              <a href="author.html#20037">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
