<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Only allow specific Users per Port
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Only%20allow%20specific%20Users%20per%20Port&In-Reply-To=%3C0a2fbd4e-2f92-a8e4-5a28-b60c6cb6472a%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="020041.html">
   <LINK REL="Next"  HREF="020045.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Only allow specific Users per Port</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Only%20allow%20specific%20Users%20per%20Port&In-Reply-To=%3C0a2fbd4e-2f92-a8e4-5a28-b60c6cb6472a%40treenet.co.nz%3E"
       TITLE="[squid-users] Only allow specific Users per Port">squid3 at treenet.co.nz
       </A><BR>
    <I>Sat Jan 26 04:21:04 UTC 2019</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="020041.html">[squid-users] Only allow specific Users per Port
</A></li>
        <LI>Next message (by thread): <A HREF="020045.html">[squid-users] Big HTTP-POST file uploads not working
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20043">[ date ]</a>
              <a href="thread.html#20043">[ thread ]</a>
              <a href="subject.html#20043">[ subject ]</a>
              <a href="author.html#20043">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 26/01/19 4:19 pm, Schokobecher wrote:
&gt;<i> Hello,
</I>&gt;<i> 
</I>&gt;<i> I'm struggling quite a bit with transitioning from&#160;basic_ncsa_auth to
</I>&gt;<i> basic_db_auth.
</I>&gt;<i> I have some ports where only certain users (sometimes just one) is
</I>&gt;<i> allowed to connect/pass the ACL check.
</I>&gt;<i> 
</I>&gt;<i> I'm running Squid 3.28 on Ubuntu&#160;&#160;
</I>&gt;<i> 
</I>&gt;<i> I have lines like this:
</I>&gt;<i> acl&#160;userA proxy_auth_regex -i userA
</I>&gt;<i> 
</I>&gt;<i> Which reads the htpasswd file and matches the user based on the regex.
</I>
That is technically wrong. When figuring out this type of problem the
details matter.

That is an ACL which reads the HTTP request message for details and
matches true if it finds &quot;usera&quot; or any case-insensitive variation of that.

It has a prerequisite that the auth system has already authenticated
those credentials as valid. But the ACL itself does not do any of that.

As a result of that seemingly minor detail that ACL will happily
non-match when it should match if the access control using it is a
'fast' category control. Correlated with that it may also wrongly match
if the ACL is configured in a '!' modifier.



&gt;<i> Port config looks like this:
</I>&gt;<i> 
</I>&gt;<i> http_port 3201 name=3201
</I>&gt;<i> acl userA3201 myportname 3201
</I>&gt;<i> cache_peer example.com parent 3300 0 no-query
</I>&gt;<i> no-digest proxy-only standby=60 name=up01
</I>&gt;<i> cache_peer_access&#160; up01&#160; allow userA3201
</I>&gt;<i> never_direct allow userA3201
</I>&gt;<i> http_access allow&#160; userA3201 userA
</I>
So &quot;usera&quot; is allowed when they use port 3201.

What else have you configured? This line *cannot* be the one allowing
other users to that port, nor this user to other ports. Some other line
or combination of lines is doing that.


&gt;<i> 
</I>&gt;<i> And that for multiple Ports.
</I>&gt;<i> 
</I>&gt;<i> I now want to transition to basic_db_auth and got it up and running, but
</I>&gt;<i> the problem is that the above does not work anymore. All authed users
</I>&gt;<i> can now connect to every port.
</I>&gt;<i> 
</I>
That implies something in your access controls changed. The few you have
mentioned do not show anything related to the problem.

OR, maybe you set the DB helper to return OK for users unrelated to the
actual HTTP request client. You have omitted those details too.


&gt;<i> UserA can use Port 3201,3202,3206 for connecting to the proxy
</I>&gt;<i> UserB can't use these and only can use 3315
</I>&gt;<i> 
</I>&gt;<i> What is the best/cleanest way to regain the above functionality?
</I>
Cleanest way is to:

 1) revert to the old config file. check that it still works.

 2) check that the new SQL DB contents match the NCSA htpasswd entries.

 3) change only the auth_param &quot;program&quot; line setting which helper is
used. Nothing else, not even other auth_param lines should be touched (yet).

 4) check that the proxy behaviour has not changed in regards to who is
getting to what.
  - if there is a change then your parameters to the DB helper need fixing.
 - otherwise problem stated above is solved and you can move on to other
changes.


Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="020041.html">[squid-users] Only allow specific Users per Port
</A></li>
	<LI>Next message (by thread): <A HREF="020045.html">[squid-users] Big HTTP-POST file uploads not working
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20043">[ date ]</a>
              <a href="thread.html#20043">[ thread ]</a>
              <a href="subject.html#20043">[ subject ]</a>
              <a href="author.html#20043">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
