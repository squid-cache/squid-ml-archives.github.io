<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Big HTTP-POST file uploads not working
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Big%20HTTP-POST%20file%20uploads%20not%20working&In-Reply-To=%3C099e6e9c-4813-fd23-c2a7-7fd8487196da%40maweos.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="020049.html">
   <LINK REL="Next"  HREF="020051.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Big HTTP-POST file uploads not working</H1>
    <B>Matthias Weigel</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Big%20HTTP-POST%20file%20uploads%20not%20working&In-Reply-To=%3C099e6e9c-4813-fd23-c2a7-7fd8487196da%40maweos.de%3E"
       TITLE="[squid-users] Big HTTP-POST file uploads not working">matthias.weigel at maweos.de
       </A><BR>
    <I>Tue Jan 29 07:05:24 UTC 2019</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="020049.html">[squid-users] Big HTTP-POST file uploads not working
</A></li>
        <LI>Next message (by thread): <A HREF="020051.html">[squid-users] Big HTTP-POST file uploads not working
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20050">[ date ]</a>
              <a href="thread.html#20050">[ thread ]</a>
              <a href="subject.html#20050">[ subject ]</a>
              <a href="author.html#20050">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Amos,

thanks for your analysing!

Any idea, why the IIS server behaves differently with Apache as the
Reverse Proxy (anything else being the same)?

Does Squid do anything special with TCP streams?

Best Regards

Matthias

Am 29.01.2019 um 05:01 schrieb Amos Jeffries:
&gt;<i> On 29/01/19 8:50 am, Matthias Weigel wrote:
</I>&gt;&gt;<i> Hi Alex,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> this problem just got a lot weirder:
</I>&gt;&gt;<i> - Upload works fine with debug_options ALL,7 ALL,8 or ALL,9.
</I>&gt;&gt;<i> - Upload fails with debug_options ALL,6 and lower.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I created a debug_options ALL,6 cache.log.
</I>&gt;&gt;<i> <A HREF="http://94.16.117.186/squid/cache.log.3b.gz">http://94.16.117.186/squid/cache.log.3b.gz</A>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> During this test, the following happened at the client:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Stall at 20:10:38
</I>&gt;&gt;<i> Recover at 20:12:47
</I>&gt;&gt;<i> Stall at 20:14:11
</I>&gt;&gt;<i> Failure at 20:16:17
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Any ideas?
</I>&gt;&gt;<i>
</I>&gt;<i> 
</I>&gt;<i> The FD 18 client-&gt;Squid I/O stops happening at 20:10:35.923 with input
</I>&gt;<i> buffer full and more data apparently waiting to arrive.
</I>&gt;<i> 
</I>&gt;<i> But the FD 20 Squid-&gt;server I/O halted earlier at 20:10:35.437 with a
</I>&gt;<i> 4KB packet being sent and still waiting for the signal to proceed
</I>&gt;<i> sending more.
</I>&gt;<i> 
</I>&gt;<i> At 20:12:47.068 a signal is received finally, but it indicates the
</I>&gt;<i> server connection has gone away with no reason given. Squid generates a
</I>&gt;<i> 502 error response and delivers that to the client.
</I>&gt;<i> 
</I>&gt;<i> The client opens a new connection, does all its TLS handshakes again and
</I>&gt;<i> re-sends the same very large POST request. Which encounters the same
</I>&gt;<i> sequence of server stops responding, client buffer fills and &quot;stall&quot;
</I>&gt;<i> until the server FD is closed. Then again the 502 from Squid but the
</I>&gt;<i> client does not resume this time.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> So whatever is going on it looks to me like it is the origin server
</I>&gt;<i> being a problem. Though you may need to look at the actual TCP packet
</I>&gt;<i> flow to confirm. I expect you will find that a packet from Squid to the
</I>&gt;<i> server does not get ACK'd, or a network timeout occurs (NAT or TCP
</I>&gt;<i> lifetimes are common), ...
</I>&gt;<i> 
</I>&gt;<i>  Or maybe the server is itself dealing with a similar backlog from
</I>&gt;<i> unresponsive internal agent/component leaving its input buffer to
</I>&gt;<i> overflow just like Squids one from the client does.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Amos
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i> 
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="020049.html">[squid-users] Big HTTP-POST file uploads not working
</A></li>
	<LI>Next message (by thread): <A HREF="020051.html">[squid-users] Big HTTP-POST file uploads not working
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20050">[ date ]</a>
              <a href="thread.html#20050">[ thread ]</a>
              <a href="subject.html#20050">[ subject ]</a>
              <a href="author.html#20050">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
