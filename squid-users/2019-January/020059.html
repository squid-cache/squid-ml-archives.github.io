<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid not coming up with dynamic host certificate on ssl bum
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20not%20coming%20up%20with%20dynamic%20host%20certificate%0A%20on%20ssl%20bum&In-Reply-To=%3C2733a0ec-c7c4-ac6d-51a9-bd072a9e72ff%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="020057.html">
   <LINK REL="Next"  HREF="020061.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid not coming up with dynamic host certificate on ssl bum</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20not%20coming%20up%20with%20dynamic%20host%20certificate%0A%20on%20ssl%20bum&In-Reply-To=%3C2733a0ec-c7c4-ac6d-51a9-bd072a9e72ff%40treenet.co.nz%3E"
       TITLE="[squid-users] Squid not coming up with dynamic host certificate on ssl bum">squid3 at treenet.co.nz
       </A><BR>
    <I>Wed Jan 30 13:04:52 UTC 2019</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="020057.html">[squid-users] Squid not coming up with dynamic host certificate on	ssl bum
</A></li>
        <LI>Next message (by thread): <A HREF="020061.html">[squid-users] daily releases
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20059">[ date ]</a>
              <a href="thread.html#20059">[ thread ]</a>
              <a href="subject.html#20059">[ subject ]</a>
              <a href="author.html#20059">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 30/01/19 8:11 pm, bandeep2000 wrote:
&gt;<i> Have squid in transparent, want to ssl bump all the connections which
</I>&gt;<i> are not whitelisted, but when given&#160;*generate-host-certificates=on ,
</I>&gt;<i> *squid keeps crashing when trying to bring it up after service restart.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> */var/log/messages*
</I>&gt;<i> 
</I>&gt;<i> Jan 30 07:05:52 ban-squid-proxy22 squid[23323]: Squid Parent: (squid-1)
</I>&gt;<i> process 23441 started
</I>&gt;<i> 
</I>&gt;<i> Jan 30 07:05:52 ban-squid-proxy22 (squid-1): The ssl_crtd helpers are
</I>&gt;<i> crashing too rapidly, need help!
</I>&gt;<i> 
</I>
There is the error. cache.log should contain more details and possibly
instructions about the error.

Probably you did not initialize the certificate database or it needs to
be purged and reinitialized.




&gt;<i> 
</I>&gt;<i> *squid.conf details:*
</I>&gt;<i> *
</I>&gt;<i> *
</I>&gt;<i> 
</I>&gt;<i> visible_hostname squid
</I>&gt;<i> 
</I>

This name will clash with any other proxy calling itself &quot;squid&quot; and the
traffic may/will be rejected as forwarding loop.

Using the full hostname or FQDN is best to ensure the URLs of objects
provided direct from Squid to clients can be fetched by those clients.


&gt;<i> 
</I>&gt;<i> cache deny all
</I>&gt;<i> 
</I>&gt;<i> #Handling HTTP requests
</I>&gt;<i> 
</I>&gt;<i> http_port 3128 intercept
</I>&gt;<i> 
</I>&gt;<i> acl allowed_http_sites dstdomain ...
</I>&gt;<i> acl blacklist url_regex -i /.(.*?)
</I>
The above is equivalent to:

  acl blacklist url_regex /.

Meaning &quot;blacklist&quot; matches any URI containing a '/' character followed
by one other character...

&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> http_access allow allowed_http_sites
</I>&gt;<i> 
</I>&gt;<i> http_access deny blacklist
</I>&gt;<i> 
</I>

... all URLs start with &quot;<A HREF="scheme://">scheme://</A>&quot; therefore the first '/' always
exists and is always followed by the second '/'.

... So any traffic with a URL is blacklisted.

The only traffic allowed is that on the whitelist or with URI or URN -
the latter two do not require the '//' scheme delimiters. So they
usually will not match, but may do so.


&gt;<i> 
</I>&gt;<i> #Handling HTTPS requests
</I>&gt;<i> 
</I>&gt;<i> #https_port 3130 cert=/etc/pki/tls/certs/squidCA.pem ssl-bump intercept
</I>&gt;<i> 
</I>&gt;<i> #/root/openssl/squid.crt&#160; squid.csr&#160; /root/openssl/squid.key
</I>&gt;<i> 
</I>&gt;<i> *https_port 3130 cert=/root/openssl/squid.crt
</I>&gt;<i> key=/root/openssl/squid.key ssl-bump intercept
</I>&gt;<i> generate-host-certificates=on version=1
</I>&gt;<i> options=NO_SSLv2,NO_SSLv3,SINGLE_DH_USE*
</I>&gt;<i> 
</I>
Please put the traffic mode (&quot;intercept&quot; for these) as the first option
after the port number. The Squid &quot;-k parse&quot; checks can only verify
correct operation and help instructions if the mode is known when the
other options are interpreted.



&gt;<i> sslcrtd_program /usr/lib/squid/ssl_crtd -s /var/lib/squid/ssl_db -M 4MB
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> acl SSL_port port 443
</I>&gt;<i> 
</I>&gt;<i> http_access allow SSL_port
</I>&gt;<i> 
</I>
So any attempt to open opaque tunnels (uses a URI not a URL) to port 443
to any domain is allowed by any client who can get TCP connections to
reach your proxy port 3128.
 Also to any server in the allowed_https_sites whitelist regardless of
whether the client is your LAN or an external attacker.

(NP: there are good reasons we recommend the default !Safe_ports and
&quot;CONNECT !SSL_ports&quot; ACL checks as to be used firs and your rules
second. Mostly it is about protecting your network from abusers.)


&gt;<i> acl allowed_https_sites ssl::server_name ...
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> acl step1 at_step SslBump1
</I>&gt;<i> 
</I>&gt;<i> acl step2 at_step SslBump2
</I>&gt;<i> 
</I>&gt;<i> acl step3 at_step SslBump3
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> ssl_bump peek step1 all
</I>&gt;<i> 
</I>&gt;<i> #ssl_bump peek all
</I>&gt;<i> 
</I>&gt;<i> ssl_bump splice step2 allowed_https_sites
</I>&gt;<i> 
</I>&gt;<i> ssl_bump splice step3 allowed_https_sites
</I>&gt;<i> 
</I>
No traffic should ever reach the step3. Since step2 always finishes with
the above splice or the below bump actions. There are no other
possibilities at step2 which would ever lead to step3 (server
credentials) being checked.


&gt;<i> ssl_bump bump step2 all
</I>&gt;<i> 
</I>
Note: the &quot;all&quot; ACL is always pointless on ssl_bump lines and seems to
often confuse people into thinking that a line matches all traffic (it
does nothing). I recommend removing those and re-checking the rules
against your understanding of what your policy needs to make happen.


Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="020057.html">[squid-users] Squid not coming up with dynamic host certificate on	ssl bum
</A></li>
	<LI>Next message (by thread): <A HREF="020061.html">[squid-users] daily releases
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20059">[ date ]</a>
              <a href="thread.html#20059">[ thread ]</a>
              <a href="subject.html#20059">[ subject ]</a>
              <a href="author.html#20059">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
