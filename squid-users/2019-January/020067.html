<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Using a static wildcard certificate with ssl-bump in explicit forward proxy mode
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Using%20a%20static%20wildcard%20certificate%20with%20ssl-bump%0A%20in%20explicit%20forward%20proxy%20mode&In-Reply-To=%3Ca42f71f6-2d59-5cf4-aeed-59923fc135cc%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="020064.html">
   <LINK REL="Next"  HREF="020037.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Using a static wildcard certificate with ssl-bump in explicit forward proxy mode</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Using%20a%20static%20wildcard%20certificate%20with%20ssl-bump%0A%20in%20explicit%20forward%20proxy%20mode&In-Reply-To=%3Ca42f71f6-2d59-5cf4-aeed-59923fc135cc%40treenet.co.nz%3E"
       TITLE="[squid-users] Using a static wildcard certificate with ssl-bump in explicit forward proxy mode">squid3 at treenet.co.nz
       </A><BR>
    <I>Thu Jan 31 01:14:16 UTC 2019</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="020064.html">[squid-users] Using a static wildcard certificate with ssl-bump in explicit forward proxy mode
</A></li>
        <LI>Next message (by thread): <A HREF="020037.html">[squid-users] Fwd: Https blocked sites getting ssl error , with connection abruptly ending - Peek and splice feature
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20067">[ date ]</a>
              <a href="thread.html#20067">[ thread ]</a>
              <a href="subject.html#20067">[ subject ]</a>
              <a href="author.html#20067">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 31/01/19 7:47 am, Bill Bernsen wrote:
&gt;<i> Amos, thank you for the quick response. My original question could use
</I>&gt;<i> an example to clarify.
</I>&gt;<i> 
</I>&gt;<i> client ------&gt; example.com (HTTPS squid proxy)
</I>&gt;<i> ------&gt; instance.example.com (HTTPS server)
</I>&gt;<i> 
</I>
Sadly this does not by itself actually clarify the issue. Are those
domains the machine hostnames or the HTTP(S) message URL domains?
 (The description later does that, so this comment is more an FYI.)


&gt;<i> The HTTPS squid proxy on example.com has a trusted
</I>
... definition of that &quot;on&quot; and thus its implications for traffic syntax
and the resulting behaviour limitations is the key point(s) I am trying
to understand here.


&gt;<i> wildcard certificate for *.example.com
</I>&gt;<i> The HTTPS server on instance.example.com 
</I>&gt;<i> has an untrusted certificate for instance.example.com
</I>&gt;<i> 
</I>&gt;<i> So without MITM, the client issues a CONNECT to squid running on
</I>&gt;<i> example.com &lt;<A HREF="http://example.com">http://example.com</A>&gt; which does its TLS, authenticates,
</I>&gt;<i> connects to upstream then goes into tunneling mode. The client does the
</I>&gt;<i> TLS handshake with instance.example.com &lt;<A HREF="http://instance.example.com">http://instance.example.com</A>&gt;,
</I>&gt;<i> receives its untrusted certificate, and isn't happy.
</I>

In this case the client is fully aware that the proxy exists.

=&gt; The proxy did *not* get a request to contact instance.example.com -
therefore it did not connect to instance.example.com.

==&gt; The proxy was asked for a tunnel to &quot;example.com&quot; and all security
validation done by the proxy will be comparing the *exact* FQDN
&quot;example.com&quot; against values in that traffic.

The client *separately* (inside the tunneled opaque bytes) contacts the
server and negotiates use of the &quot;instance.example.com&quot; virtual host.

=&gt; The proxy has zero involvement and zero knowledge of this.

==&gt; all security validation done by the client itself and will be
comparing the negotiated FQDN &quot;instance.example.com&quot; against values in
that traffic.

PS. Note there are no wildcards other than the cert field(s). The things
tested against that wildcard has always an exact actual value.


&gt;<i> 
</I>&gt;<i> I'm looking for a MITM mode that, instead of requiring a CA that can
</I>&gt;<i> dynamically create trusted certs on the fly, will return a wildcard
</I>&gt;<i> certificate for all requests (or even better, for any requests matching
</I>&gt;<i> hosts in its subdomain). Is that something that exists?
</I>
MITM mode the client does not connect to the proxy. The client connects
to an origin.

 The network NAT or whatever doing the *intercept* part is delivering
the traffic to the proxy.

 Squid is _itself_ generating the CONNECT which shows up (to simplify
processing and failure handling). What data is available determines what
can be done:

SSL-Bump step-1 : only TCP SYN packet details are available.
   ==&gt; raw-IP:port and nothing else.

SSL-Bump step-2 : TLS SNI (maybe)
   ==&gt; exact FQDN value &quot;instance.example.com&quot;

Notice that at no point yet is the MITM ever aware that &quot;example.com&quot;
plays a part and no reason to even suspect a wildcard existence.

At step-3 things get a little bit easier since the server X.509
certificate is available. That cert is the only place the wildcard can
come from, and is in a certificate field where free-form text is allowed
and *often* used. One sub-domain may also sit on a separate server not
using this same cert with wildcard. So care needs to be taken to avoid
issues from that data source.


&gt;<i> 
</I>&gt;<i> I hacked up my own version of ssl_crtd to serve a static cert and ran
</I>
Fine. Though you should be able to use generate-host-certificates=off
and place your static cert into the cert= parameter. If that is not
working it is a Squid bug to be fixed.

I have PRs already underway to make the generate option take the CA cert
and leave cert= for the static certs like your case needs. No ETA on
when that will be completed though.


&gt;<i> into another wrinkle. Is there a version of squid that supports ssl-bump
</I>&gt;<i> with https_port?
</I>
All versions of Squid-3.2 and later support SSL-Bump on https_port.

Though since forward-proxy and MITM have mutually exclusive X.509
certificate requirements currently the only way to do SSL-Bump on
https_port is to use &quot;intercept&quot; or &quot;tproxy&quot; traffic modes - leaving
explicit TLS proxy with the forward-proxy mode.


Amos

-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 833 bytes
Desc: OpenPGP digital signature
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20190131/384c4d85/attachment.sig">http://lists.squid-cache.org/pipermail/squid-users/attachments/20190131/384c4d85/attachment.sig</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="020064.html">[squid-users] Using a static wildcard certificate with ssl-bump in explicit forward proxy mode
</A></li>
	<LI>Next message (by thread): <A HREF="020037.html">[squid-users] Fwd: Https blocked sites getting ssl error , with connection abruptly ending - Peek and splice feature
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20067">[ date ]</a>
              <a href="thread.html#20067">[ thread ]</a>
              <a href="subject.html#20067">[ subject ]</a>
              <a href="author.html#20067">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
