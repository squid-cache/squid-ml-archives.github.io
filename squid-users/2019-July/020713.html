<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Non-standard proxy setup
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Non-standard%20proxy%20setup&In-Reply-To=%3Cbf4b6e33-5075-ef84-dea9-c42ef68ac46f%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="020712.html">
   <LINK REL="Next"  HREF="020714.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Non-standard proxy setup</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Non-standard%20proxy%20setup&In-Reply-To=%3Cbf4b6e33-5075-ef84-dea9-c42ef68ac46f%40measurement-factory.com%3E"
       TITLE="[squid-users] Non-standard proxy setup">rousskov at measurement-factory.com
       </A><BR>
    <I>Tue Jul  9 13:54:25 UTC 2019</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="020712.html">[squid-users] Non-standard proxy setup
</A></li>
        <LI>Next message (by thread): <A HREF="020714.html">[squid-users] squid-users Digest, Vol 59, Issue 10
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20713">[ date ]</a>
              <a href="thread.html#20713">[ thread ]</a>
              <a href="subject.html#20713">[ subject ]</a>
              <a href="author.html#20713">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 7/9/19 9:10 AM, Tardif, Christian wrote:

&gt;<i> I have a node on which there&#8217;s an application which isn&#8217;t proxy aware so
</I>&gt;<i> basically, the only remaining option would be to use a transparent
</I>&gt;<i> proxy. But my corporate proxy isn&#8217;t a transparent proxy. So I have to
</I>&gt;<i> build this in two layers. My solution would be to:
</I>&gt;<i> 
</I>&gt;<i> &#160;
</I>&gt;<i> 
</I>&gt;<i> 1)&#160;&#160;&#160;&#160; Have a squid proxy on the node&#8217;s router host configured as a
</I>&gt;<i> transparent proxy for both HTTP and HTTPS
</I>&gt;<i> 
</I>&gt;<i> 2)&#160;&#160;&#160;&#160; Have this squid proxy configured to talk to the parent host,
</I>&gt;<i> which would be my corporate proxy
</I>&gt;<i> 
</I>&gt;<i> 3)&#160;&#160;&#160;&#160; Have this squid proxy able to decide if a particular flow should
</I>&gt;<i> go to the corporate proxy or connect &#8220;directly&#8221; with the destination host
</I>&gt;<i> 
</I>&gt;<i> &#160;
</I>&gt;<i> 
</I>&gt;<i> I&#8217;ve been successful at tasks #2 and #3 (well, in fact, I did it with
</I>&gt;<i> tinyproxy but stopped because of task #1
</I>&gt;<i> 
</I>&gt;<i> &#160;
</I>&gt;<i> 
</I>&gt;<i> I&#8217;ve partly succedded at task #1. In fact, it worked for HTTP. I haven&#8217;t
</I>&gt;<i> figured out how to do it for HTTPS. My questions are:
</I>&gt;<i> 
</I>&gt;<i> &#160;
</I>&gt;<i> 
</I>&gt;<i> 1)&#160;&#160;&#160;&#160; I do not understand how the client would be able to perform a
</I>&gt;<i> CONNECT to reach squid in HTTPS. So I&#8217;m assuming that there&#8217;s some other
</I>&gt;<i> magic.
</I>
The client will attempt to open a TLS/TCP connection to the origin
server. Your router (or some such) will redirect client TLS/TCP bytes to
your Squid's https_port. If configured correctly, Squid will accept that
TCP connection and wrap/forward it into/inside an HTTP CONNECT tunnel
through the corporate proxy.


&gt;<i> 2)&#160;&#160;&#160;&#160; The second thing I don&#8217;t understand is the certificates
</I>&gt;<i> management. Let&#8217;s say my node tries to reach <A HREF="https://www.google.com">https://www.google.com</A> but
</I>&gt;<i> does not know anything about the proxy. I assume that the client will
</I>&gt;<i> get the certificate from squid in some way, but would probably expect to
</I>&gt;<i> receive a certificate from Google. How would that work?
</I>
* If you do not want your Squid to look inside the connection to
google.com, then your Squid will work at TCP level. Same for the
corporate proxy. Both proxies will forward Google certificate to the
unsuspecting client and everything will work fine most[XXX] of the time.

* Otherwise, you will need to use SslBump functionality and impersonate
the origin server, including faking its certificate. If you add your
proxy CA certificate to the client, this bumping will work for some
sites and will break others.

[XXX] The only HTTPS-related problem you may have in a tunneling-only
Squid is with TCP-level error reporting to the client (e.g., when Squid
cannot connect to the corporate proxy). By default, Squid may want to
bump the client connection (to report those errors to the client),
causing bumping problems mentioned in the second bullet above. For Squid
configurations that are not supposed to bump traffic at all, this
implicit bumping on errors is a bug/misfeature.


HTH,

Alex.

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="020712.html">[squid-users] Non-standard proxy setup
</A></li>
	<LI>Next message (by thread): <A HREF="020714.html">[squid-users] squid-users Digest, Vol 59, Issue 10
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20713">[ date ]</a>
              <a href="thread.html#20713">[ thread ]</a>
              <a href="subject.html#20713">[ subject ]</a>
              <a href="author.html#20713">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
