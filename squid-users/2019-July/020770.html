<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] network problems with squid ssl-bump
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20network%20problems%20with%20squid%20ssl-bump&In-Reply-To=%3C039788b5-8f00-6724-91f6-0353cf6e3728%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="020767.html">
   <LINK REL="Next"  HREF="020768.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] network problems with squid ssl-bump</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20network%20problems%20with%20squid%20ssl-bump&In-Reply-To=%3C039788b5-8f00-6724-91f6-0353cf6e3728%40treenet.co.nz%3E"
       TITLE="[squid-users] network problems with squid ssl-bump">squid3 at treenet.co.nz
       </A><BR>
    <I>Thu Jul 18 15:29:18 UTC 2019</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="020767.html">[squid-users] network problems with squid ssl-bump
</A></li>
        <LI>Next message (by thread): <A HREF="020768.html">[squid-users] squid time out
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20770">[ date ]</a>
              <a href="thread.html#20770">[ thread ]</a>
              <a href="subject.html#20770">[ subject ]</a>
              <a href="author.html#20770">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 18/07/19 7:52 pm, Ashley wrote:
&gt;<i> Hi all,
</I>&gt;<i> 
</I>&gt;<i> I have a couple of questions about squid 3.5. My company has set up a squid
</I>&gt;<i> proxy with sslbump functionality. There are more than 300 people in my
</I>&gt;<i> company and we are all intensive users of internet.
</I>&gt;<i> 
</I>
The TLS environment is a very volatile place this past decade. Almost
every Squid release has some significant changes you will need for
SSL-Bump to work nicely or sometimes to work at all.

Due to this our official advice is to follow the latest release if you
need SSL-Bump. Especially if you encounter any problems, try the latest
and see if the problem disappears. Today that means Squid-4 (current
stable), or possibly even Squid-5 (cutting-edge, test well before use).

Squid-3.5.28 as bundled by some OS distributors can be reasonable *if*
it meets your needs. Which apparently it does not, and if you are
building your own Squid definitely build the latest version out.



&gt;<i> After we implemented our squid web proxy (with multiple instances) , we had
</I>&gt;<i> problems with our network. The internet becomes very slow and some of the
</I>&gt;<i> web pages are time out. We checked the cache.log and some error logs are
</I>&gt;<i> shown as follows.
</I>&gt;<i> 
</I>&gt;<i> 2019/07/18 14:27:48 kid4| ERROR: Disconnecting from a helper that overflowed
</I>&gt;<i> 32768-byte Squid input buffer: ssl_crtd #Hlpr33
</I>
That is a problem. The SSL-Bump cert generator cannot deliver the
intended fake cert back to Squid for delivery to a client.

Take a close look at the certs which are being mimic'd by this helper
and ensure they are less than 30KB in size. The 32KB buffer needs to
hold the cert plus a bunch of helper protocol values used by Squid.

If you have not done something that would make the cert be huge (eg a
server with lots of domain in its SubjectName). Then it may be a bug in
that helper, try newer Squid version.


The below look like side effects of the above. When no cert is able to
generate, negotiation will break.


&gt;<i> 019/07/18 14:59:34 kid6| Error negotiating SSL on FD 146: error:14077410:SSL
</I>&gt;<i> routines:SSL23_GET_SERVER_HELLO:sslv3 alert handshake failure (1/-1/0)
</I>&gt;<i> 2019/07/18 14:59:36 kid3| Error negotiating SSL on FD 153:
</I>&gt;<i> error:00000000:lib(0):func(0):reason(0) (5/0/0)
</I>&gt;<i> 2019/07/18 14:59:41 kid5| fqdncacheParse: No PTR record for '50.57.251.150'
</I>&gt;<i> 2019/07/18 14:59:41 kid5| fqdncacheParse: No PTR record for '50.57.251.150'
</I>&gt;<i> 2019/07/18 14:59:41 kid1| Failed to connect to nameserver 10.0.0.254 using
</I>&gt;<i> TCP.
</I>&gt;<i> 2019/07/18 14:59:41 kid5| Error negotiating SSL on FD 82: error:14077438:SSL
</I>&gt;<i> routines:SSL23_GET_SERVER_HELLO:tlsv1 alert internal error (1/-1/0)
</I>&gt;<i> 2019/07/18 14:59:43 kid5| Error negotiating SSL on FD 94: error:14077410:SSL
</I>&gt;<i> routines:SSL23_GET_SERVER_HELLO:sslv3 alert handshake failure (1/-1/0)
</I>&gt;<i> 2019/07/18 14:59:43 kid6| fqdncacheParse: No PTR record for
</I>&gt;<i> '207.246.147.249'
</I>&gt;<i> 2019/07/18 14:59:43 kid6| fqdncacheParse: No PTR record for
</I>&gt;<i> '207.246.147.249'
</I>&gt;<i> 2019/07/18 14:59:49 kid2| Error negotiating SSL on FD 64:
</I>&gt;<i> error:00000000:lib(0):func(0):reason(0) (5/-1/54)
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Our squid.conf is as follows.
</I>&gt;<i> 
</I>
...
&gt;<i> 
</I>&gt;<i> cache_effective_user www
</I>&gt;<i> 
</I>
Be Very Careful. That user account is a standard service name for web
servers. Squid is not a web server and should not be given access to
web-server related system resources. Likewise web servers should not be
given access to Squid internal state data (eg the SSL-Bump generated
security keys, cache contents, and shared memory sockets).

...
&gt;<i> 
</I>&gt;<i> /usr/local/eaclhelper/CSQR_MyPortFWHelper.php
</I>&gt;<i> external_acl_type myPortFWFilter children-max=6 ttl=1 %SRC
</I>&gt;<i> /usr/local/eaclhelper/CSQR_MyPortFWHelper
</I>&gt;<i> acl myPortFW external myPortFWFilter
</I>&gt;<i> deny_info info_myPortFW myPortFW
</I>&gt;<i> http_access deny myPortFW
</I>&gt;<i> 
</I>&gt;<i> external_acl_type myAclFilter children-idle=3 children-startup=6
</I>&gt;<i> children-max=64 %SRC %SRCPORT %DST %PORT %URI
</I>&gt;<i> /usr/local/eaclhelper/CSQR_MyAclHelper
</I>&gt;<i> acl myAcl external myAclFilter
</I>&gt;<i> deny_info info_myAcl myAcl
</I>&gt;<i> http_access deny myAcl
</I>&gt;<i> 
</I>&gt;<i> http_access allow localnet
</I>&gt;<i> http_access allow localhost
</I>&gt;<i> 
</I>&gt;<i> http_access deny all
</I>&gt;<i> 
</I>&gt;<i> workers 6
</I>&gt;<i> sslproxy_session_cache_size 0
</I>&gt;<i> 
</I>&gt;<i> if ${process_number} = 7
</I>&gt;<i> 
</I>&gt;<i> http_port 127.0.0.1:3127 
</I>&gt;<i> 
</I>&gt;<i> else
</I>&gt;<i> 
</I>&gt;<i> http_port 127.0.0.${process_number}:3128
</I>&gt;<i> https_port 127.0.0.${process_number}:3129 intercept ssl-bump
</I>&gt;<i> cert=/usr/local/squid/ssl_cert/myCA.pem generate-host-certificates=on
</I>&gt;<i> dynamic_cert_mem_cache_size=4MB
</I>&gt;<i> 
</I>... &lt;snip unnecessary config&gt; ...

&gt;<i> 
</I>&gt;<i> endif # endif for squid coordinator
</I>&gt;<i> 
</I>&gt;<i> # ssl_bump ACL
</I>&gt;<i> acl broken_dstdom dstdomain
</I>&gt;<i> &quot;/home/www/htdocs/snims/lurk/sslTP_default_conf/no_sslbump_dstdom.default&quot;
</I>&gt;<i> acl broken_dst dst
</I>&gt;<i> &quot;/home/www/htdocs/snims/lurk/sslTP_default_conf/no_sslbump_dst.default&quot;
</I>&gt;<i> acl bump_dstdom dstdomain
</I>&gt;<i> &quot;/home/www/htdocs/snims/lurk/sslTP_default_conf/sslbump_dstdom.default&quot;
</I>&gt;<i> acl bump_dst dst
</I>&gt;<i> &quot;/home/www/htdocs/snims/lurk/sslTP_default_conf/sslbump_dst.default&quot;
</I>&gt;<i> 
</I>&gt;<i> always_direct allow all
</I>
Please remove. You do not have cache_peer. The above was only ever
needed to workaround a very short-lived bug back in Squid-3.1.



&gt;<i> # the following two options are unsafe and not always necessary:
</I>&gt;<i> sslproxy_cert_error allow all
</I>&gt;<i> sslproxy_flags DONT_VERIFY_PEER
</I>&gt;<i> 
</I>
Please do not use DONT_VERIFY_PEER. All it does is prevent you (the
admin) from seeing what problems are happening.

The &quot;allow all&quot; for errors is also a bad idea. I suggest removing both
of these, then solving the error(s) that show up. yes you will see
errors happening, the idea is to look into them and see whether it is an
attack or network issue to fix before they become massive problems like
you are having now.


&gt;<i> # sslcrtd
</I>&gt;<i> sslcrtd_program /usr/local/squid/libexec/ssl_crtd -s /var/squid/ssl_db -M
</I>&gt;<i> 4MB
</I>&gt;<i> sslcrtd_children 32 startup=5 idle=3
</I>&gt;<i> 
</I>&gt;<i> # ecap_adapter
</I>&gt;<i> ecap_enable off
</I>&gt;<i> adaptation_send_client_ip on
</I>&gt;<i> loadable_modules /usr/local/ecap_adapter/lib/ecap_adapter_passthru.so
</I>&gt;<i> ecap_service eReqmod reqmod_precache 0
</I>&gt;<i> <A HREF="ecap://e-cap.org/ecap/services/sample/passthru">ecap://e-cap.org/ecap/services/sample/passthru</A> 
</I>&gt;<i> ecap_service eRespmod respmod_precache 0
</I>&gt;<i> <A HREF="ecap://e-cap.org/ecap/services/sample/passthru">ecap://e-cap.org/ecap/services/sample/passthru</A> 
</I>&gt;<i> 
</I>&gt;<i> adaptation_service_set reqFilter eReqmod
</I>&gt;<i> adaptation_service_set respFilter eRespmod
</I>&gt;<i> adaptation_access respFilter allow all
</I>&gt;<i> adaptation_access reqFilter allow all
</I>&gt;<i> 
</I>...
&gt;<i> 
</I>&gt;<i> ## sslBump ssl server name ACL
</I>&gt;<i> acl monitorSites ssl::server_name
</I>&gt;<i> &quot;/home/www/htdocs/snims/lurk/sslTP_default_conf/monitor_sslserver.default&quot;
</I>&gt;<i> acl monitorSites_define ssl::server_name
</I>&gt;<i> &quot;/home/www/htdocs/snims/lurk/sslTP_default_conf/monitor_sslserver.define&quot;
</I>&gt;<i> acl monitorSites_security ssl::server_name
</I>&gt;<i> &quot;/home/www/htdocs/snims/lurk/sslTP_default_conf/monitor_sslserver.security&quot;
</I>&gt;<i> acl monitorSites_security_IP dst
</I>&gt;<i> &quot;/home/www/htdocs/snims/lurk/sslTP_default_conf/monitor_dst.security&quot;
</I>&gt;<i> acl brokenSites ssl::server_name
</I>&gt;<i> &quot;/home/www/htdocs/snims/lurk/sslTP_default_conf/no_sslbump_sslserver.default&quot;
</I>&gt;<i> acl brokenSites_define ssl::server_name
</I>&gt;<i> &quot;/home/www/htdocs/snims/lurk/sslTP_default_conf/no_sslbump_sslserver.define&quot;
</I>&gt;<i> 
</I>&gt;<i> ## sslBump acl setting for squid 3.5 
</I>&gt;<i> acl step1 at_step SslBump1
</I>&gt;<i> acl step2 at_step SslBump2
</I>&gt;<i> acl step3 at_step SslBump3
</I>
NP: you are not using the step2 or step3 ACLs. They can be removed.

&gt;<i> ssl_bump peek step1 all
</I>
The &quot;all&quot; on the above line is pointless.

&gt;<i> 
</I>&gt;<i> ssl_bump splice broken_dstdom
</I>&gt;<i> ssl_bump splice broken_dst
</I>&gt;<i> ssl_bump splice brokenSites_define
</I>&gt;<i> 
</I>
After the above line anything matching brokenSites_define will be
spliced. OR is a server which _cannot_ be spliced.

So you can remove the redundant &quot;!brokenSites_define&quot; from the below lines.

Since you are following these below lines with a &quot;splice all&quot; line you
can greatly simplify the ACL processing time by adding this line right here:
 ssl_bump splice brokenSites

.. then removing all the &quot;!brokenSites&quot; below.


&gt;<i> ssl_bump bump monitorSites !brokenSites !brokenSites_define
</I>&gt;<i> ssl_bump bump monitorSites_define !brokenSites !brokenSites_define
</I>&gt;<i> ssl_bump bump monitorSites_security !brokenSites !brokenSites_define
</I>&gt;<i> ssl_bump bump monitorSites_security_IP !brokenSites !brokenSites_define
</I>&gt;<i> 
</I>&gt;<i> ssl_bump splice all
</I>&gt;<i> 
</I>&gt;<i> ## sslproxy cert setting for squid 3.5
</I>&gt;<i> sslproxy_options NO_SSLv2,NO_SSLv3,SINGLE_DH_USE,SINGLE_ECDH_USE
</I>&gt;<i> sslproxy_cipher
</I>&gt;<i> EECDH+ECDSA+AESGCM:EECDH+aRSA+AESGCM:EECDH+ECDSA+SHA384:EECDH+ECDSA+SHA256:EECDH+aRSA+SHA384:EECDH+aRSA+SHA256:EECDH+aRSA+RC4:EECDH:EDH+aRSA:HIGH:!RC4:!aNULL:!eNULL:!LOW:!3DES:!MD5:!EXP:!PSK:!SRP:!DSS
</I>&gt;<i> sslproxy_cert_adapt setValidAfter all
</I>&gt;<i> 
</I>&gt;<i> Can anyone advise what&#8217;s wrong with our settings? Or is there any limitation
</I>&gt;<i> for sslbump in terms of concurrent connections? Any suggestions and advice
</I>&gt;<i> will be highly appreciated.
</I>
Squid-3 SSL-Bump is limited to OpenSSL 1.0 capabilities. The bump action
is limited to the union of client capabilities, server capabilities,
Squid OpenSSL 1.0 capabilities, and the configured sslproxy_* restrictions.


Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="020767.html">[squid-users] network problems with squid ssl-bump
</A></li>
	<LI>Next message (by thread): <A HREF="020768.html">[squid-users] squid time out
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20770">[ date ]</a>
              <a href="thread.html#20770">[ thread ]</a>
              <a href="subject.html#20770">[ subject ]</a>
              <a href="author.html#20770">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
