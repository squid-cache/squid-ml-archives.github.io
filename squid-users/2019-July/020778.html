<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] squid time out
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid%20time%20out&In-Reply-To=%3CCAEuwzCGf48jn7W-Lr%2B6%2B_mc%2BeKhT_1Dozb3BfjPe1spgOuFHBA%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="020769.html">
   <LINK REL="Next"  HREF="020795.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] squid time out</H1>
    <B>ANDRINANTENAINA Avo</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid%20time%20out&In-Reply-To=%3CCAEuwzCGf48jn7W-Lr%2B6%2B_mc%2BeKhT_1Dozb3BfjPe1spgOuFHBA%40mail.gmail.com%3E"
       TITLE="[squid-users] squid time out">avo.andrinantenaina at gmail.com
       </A><BR>
    <I>Fri Jul 19 05:30:22 UTC 2019</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="020769.html">[squid-users] squid time out
</A></li>
        <LI>Next message (by thread): <A HREF="020795.html">[squid-users] squid time out
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20778">[ date ]</a>
              <a href="thread.html#20778">[ thread ]</a>
              <a href="subject.html#20778">[ subject ]</a>
              <a href="author.html#20778">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Amos,

Thank you for your prompt reply.

As you said, the first request is hitting the proxy with the &quot;user&quot; field
empty, but there is no second request. And I was wrong about the &quot;timer&quot;.
Please find below the config

*auth_param negotiate program
/usr/local/squid/libexec/negotiate_wrapper_auth   -d --ntlm
/usr/local/samba/bin/ntlm_auth --diagnostics
--helper-protocol=squid-2.5-ntlmssp  --domain=KATANA --kerberos
/usr/local/squid/libexec/ext_kerberos_sid_group_acl -d -s GSS_C_NO_NAME*

*auth_param negotiate children 60*

*auth_param negotiate keep_alive off*



*auth_param ntlm program /usr/local/samba/bin/ntlm_auth --diagnostics
--helper-protocol=squid-2.5-ntlmssp  --domain=KATANA*

*auth_param ntlm children 60*

*auth_param ntlm keep_alive off*



*auth_param basic program /usr/local/samba/bin/ntlm_auth
--helper-protocol=squid-2.5-basic*

*auth_param basic children 60*

*auth_param basic credentialsttl 4 hours*



*auth_param basic program /usr/local/squid/libexec/basic_ldap_auth  -R -b
&quot;dc=KATANA,dc=LOCAL&quot; -D <A HREF="https://lists.squid-cache.org/listinfo/squid-users">katanauser at KATANA.LOCAL</A> -W
/usr/local/squid/etc/pass.txt -f sAMAccountName=%s -h 192.168.111.40*

*auth_param basic children 60*

*auth_param basic realm Katana Local*

*auth_param basic credentialsttl 1 minute*



*acl auth proxy_auth REQUIRED*



*tcp_outgoing_address 0.0.0.0 all*

*dns_v4_first    on*



*acl mimeblock rep_mime_type ^application/x-shockwave-flash$*

*http_reply_access deny mimeblock*

*acl deny_rep_mime_flashvideo rep_mime_type video/flv*

*http_reply_access deny deny_rep_mime_flashvideo*



*acl local0  dst  172.16.0.0/12 &lt;<A HREF="http://172.16.0.0/12">http://172.16.0.0/12</A>&gt;*

*acl local1  dst  192.168.0.0/16 &lt;<A HREF="http://192.168.0.0/16">http://192.168.0.0/16</A>&gt;*

*http_access allow local0 all*

*http_access allow local1 all*

*cache deny local1*

*cache deny local0*

*redirector_access deny local0*

*redirector_access deny local1*



*http_access deny !auth*

*http_access allow auth*

*#http_access deny all*

*http_port 8080*



*debug_options 29,9*

*cache_swap_low 94*

*cache_swap_high 95*

*logfile_rotate 150*



*cache_dir aufs /media/STORAGE/cache 7000 16 256*

*cache_log  /media/STORAGE/ACCESS/cache.log*

*access_log /media/STORAGE/ACCESS/access.log*



*refresh_pattern ^ftp:    1440  20%  10080*

*refresh_pattern ^gopher:  1440  0%  1440*

*refresh_pattern -i (/cgi-bin/|\?) 0  0%  0*

*refresh_pattern .    0  20%  4320*



*acl allsrc src all*

*acl safeports port 21 70 80 210 280 443 488 563 591 631 777 901  8080 3129
1025-65535*

*acl sslports port 443 563*



*acl purge method PURGE*

*acl connect method CONNECT*



*acl HTTP proto HTTP*

*acl HTTPS proto HTTPS*

*acl allowed_subnets src 192.168.0.0/16 &lt;<A HREF="http://192.168.0.0/16">http://192.168.0.0/16</A>&gt;*

*http_access allow allowed_subnets*

*http_access allow manager localhost*



*http_access deny manager*

*http_access allow purge localhost*

*http_access deny purge*

*http_access deny !safeports*

*http_access deny CONNECT !sslports*



*http_access allow localhost*



*request_body_max_size 0 KB*

*delay_pools 1*

*delay_class 1 2*

*delay_parameters 1 -1/-1 -1/-1*

*delay_initial_bucket_level 100*

*delay_access 1 allow allsrc*



*http_access deny allsrc*



*acl max_user_ip_conn max_user_ip -s 1*

*http_access deny max_user_ip_conn*

*deny_info <A HREF="https://192.168.111.111/index3.html">https://192.168.111.111/index3.html</A>
&lt;<A HREF="https://192.168.111.111/index3.html">https://192.168.111.111/index3.html</A>&gt;  max_user_ip_conn*



*acl Java browser Java/1.4 Java/1.5 Java/1.6 Java/1.7 Java/1.8*

*http_access allow Java*



*url_rewrite_program /usr/local/ufdbguard/bin/ufdbgclient -l /var/log/squid*

*url_rewrite_children 64 startup=16 idle=4 concurrency=0*

*debug_options 28,9*

*url_rewrite_children 10*





*icap_enable on*

*icap_send_client_ip on*

*icap_send_client_username on*

*icap_client_username_encode off*

*icap_client_username_header X-Authenticated-User*

*icap_preview_enable on*

*icap_preview_size 1024*

*icap_service service_req reqmod_precache bypass=1
<A HREF="icap://127.0.0.1:1345/squidclamav">icap://127.0.0.1:1345/squidclamav</A> &lt;<A HREF="http://127.0.0.1:1345/squidclamav">http://127.0.0.1:1345/squidclamav</A>&gt;*

*adaptation_access service_req allow all*

*icap_service service_resp respmod_precache bypass=1
<A HREF="icap://127.0.0.1:1345/squidclamav">icap://127.0.0.1:1345/squidclamav</A> &lt;<A HREF="http://127.0.0.1:1345/squidclamav">http://127.0.0.1:1345/squidclamav</A>&gt;*

*adaptation_access service_resp allow all*



Thank you




&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Message: 1
</I>&gt;<i> Date: Fri, 19 Jul 2019 02:59:13 +1200
</I>&gt;<i> From: Amos Jeffries &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt;
</I>&gt;<i> To: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> Subject: Re: [squid-users] squid time out
</I>&gt;<i> Message-ID: &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">9b813ff3-23b3-c35a-8b40-403ee67053a5 at treenet.co.nz</A>&gt;
</I>&gt;<i> Content-Type: text/plain; charset=utf-8
</I>&gt;<i>
</I>&gt;<i> On 19/07/19 1:57 am, ANDRINANTENAINA Avo wrote:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I have a huge range in terms of network, but awkwardly, the
</I>&gt;<i> &gt; authentication/ACL and everything works well in one given subnet but not
</I>&gt;<i> &gt; on the others. The users in the other subnets are not able to surf the
</I>&gt;<i> &gt; internet, and this without any specific logs from the proxy side ( the
</I>&gt;<i> &gt; most significant part of the config could be seen below). Any request
</I>&gt;<i> &gt; from these users just times out.  ____
</I>&gt;<i> &gt;
</I>&gt;<i> ...
</I>&gt;<i>
</I>&gt;<i> &gt; __ __
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I can&#8217;t really understand the issue, from the affected networks:____
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; __-          __The user is able to ping the proxy and access its port
</I>&gt;<i> &gt; 8080 (through telnet / netcat) ____
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; __-          __The request is able to reach the proxy but the in the
</I>&gt;<i> &gt; access_log the /&#8220;user&#8221; /is missing ____
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; /1563455060.396      1 192.168.230.195 TCP_DENIED/407 4714 GET
</I>&gt;<i> &gt; <A HREF="http://api.bing.com/qsml.aspx?">http://api.bing.com/qsml.aspx?</A> - HIER_NONE/- text/html____/
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; __-          __TCP_DENIED/407, requesting the user to go through the
</I>&gt;<i> &gt; authentication phase is presented by the proxy to the user&#8217;s browser but
</I>&gt;<i> &gt; nothing happens. I thought that if the timer set to Kerberos, NTLM
</I>&gt;<i> &gt; expires, a pop up should appear but nothing (from wireshark)____
</I>&gt;<i> &gt;
</I>&gt;<i>
</I>&gt;<i> Er. Not sure what you mean by a timer.
</I>&gt;<i>
</I>&gt;<i> The log entry is a reasonable first-request from any client. No sane
</I>&gt;<i> client will broadcast user credentials until it knows the receiving
</I>&gt;<i> agent needs them - and in what form they are needed.
</I>&gt;<i>  That is why your log entry has no username, and the purpose of the 407
</I>&gt;<i> status.
</I>&gt;<i>
</I>&gt;<i> Once that 407 is delivered to the Browser that HTTP transaction is over.
</I>&gt;<i> If nothing happens afterwards that is a Browser or network layer
</I>&gt;<i> problem, nothing to do with Squid. (There are exceptions, but I see no
</I>&gt;<i> sign of those being relevant in your config).
</I>&gt;<i>
</I>&gt;<i> Browser popup is what happens if the Browser is _unable_ to find
</I>&gt;<i> appropriate user credentials to send the proxy or web server needing
</I>&gt;<i> login. If it is able to find any Kerberors, NTLM or Basic auth
</I>&gt;<i> credentials to use (in that order of priority) - it will start a new
</I>&gt;<i> HTTP transaction using those. Which will be logged as a separate HTTP
</I>&gt;<i> transaction.
</I>&gt;<i>  But, if those credentials are not able to validate there may not be any
</I>&gt;<i> resulting username to log. Your wireshark trace shows no
</I>&gt;<i> Proxy-Authorization header in the request, so of course there will be no
</I>&gt;<i> username on that transactions log entry.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Setting the timeouts on credentials usability between the DC and the
</I>&gt;<i> Browsers will only cause credential tokens to become invalid before they
</I>&gt;<i> arrive at the proxy. That can lead to loops of transactions with 407 and
</I>&gt;<i> no username logged, especially with NTLM credentials.
</I>&gt;<i>
</I>&gt;<i> Setting any of the auth related TTL or timeouts in squid.conf to short
</I>&gt;<i> values will only cause extra work for the auth validation process.
</I>&gt;<i> Slowing everything down. It has no effect on whether credentials are
</I>&gt;<i> valid, nor what the Browser does.
</I>&gt;<i>
</I>&gt;<i> Despite the PR and marketing MS have done about single-sign-on being a
</I>&gt;<i> NTLM thing, it is actually a regular part of all HTTP authentication.
</I>&gt;<i> Seeing the popup is a *bad* sign, something is going wrong with the
</I>&gt;<i> Browsers auth setup if it has to be bothering the user for details.
</I>&gt;<i>  On Windows particularly the Browser should have access to the users
</I>&gt;<i> machine login or Kerberos keytab and so use one of those to access the
</I>&gt;<i> proxy without bothering or even being noticed by the user at all.
</I>&gt;<i>
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; -          On cache.log there is nothing that could mean something, just
</I>&gt;<i> &gt; a bunch of ARP error. Tried to debug the section 29 for authentication &#8230;
</I>&gt;<i> &gt; but nothing. Checked the IE internet options, just in case the windows
</I>&gt;<i> &gt; authentication profile is no ticked &#8230; but it is there.
</I>&gt;<i> &gt;
</I>&gt;<i>
</I>&gt;<i> ARP errors may be nothing, or it could be a sign that your routing needs
</I>&gt;<i> something fixed.
</I>&gt;<i>  A routing problem might be affecting background connectivity for NTLM
</I>&gt;<i> and Kerberos processes the Browser has to do to allocate auth tokens
</I>&gt;<i> with DC.
</I>&gt;<i>  It might also effect the proxy verifying those tokens, but that would
</I>&gt;<i> have a different more obvious error logged.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> If the above does not help your troubleshooting, please consider posting
</I>&gt;<i> your whole squid.conf.  (Without the #comment lines, and obfuscate
</I>&gt;<i> anything like cachemgr_passwd which should not be made public - but in a
</I>&gt;<i> way which ensures we can still tell eg that two IPs are different numbers).
</I>&gt;<i>
</I>&gt;<i> Amos
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20190719/8fd8c023/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20190719/8fd8c023/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="020769.html">[squid-users] squid time out
</A></li>
	<LI>Next message (by thread): <A HREF="020795.html">[squid-users] squid time out
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20778">[ date ]</a>
              <a href="thread.html#20778">[ thread ]</a>
              <a href="subject.html#20778">[ subject ]</a>
              <a href="author.html#20778">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
