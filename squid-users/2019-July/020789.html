<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] caching apt package lists/Raspbian
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20caching%20apt%20package%20lists/Raspbian&In-Reply-To=%3C89d5147f-0b4f-c609-6ca2-3837e9ec697b%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="020787.html">
   <LINK REL="Next"  HREF="020794.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] caching apt package lists/Raspbian</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20caching%20apt%20package%20lists/Raspbian&In-Reply-To=%3C89d5147f-0b4f-c609-6ca2-3837e9ec697b%40treenet.co.nz%3E"
       TITLE="[squid-users] caching apt package lists/Raspbian">squid3 at treenet.co.nz
       </A><BR>
    <I>Sat Jul 20 14:36:05 UTC 2019</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="020787.html">[squid-users] caching apt package lists/Raspbian
</A></li>
        <LI>Next message (by thread): <A HREF="020794.html">[squid-users] caching apt package lists/Raspbian
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20789">[ date ]</a>
              <a href="thread.html#20789">[ thread ]</a>
              <a href="subject.html#20789">[ subject ]</a>
              <a href="author.html#20789">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 20/07/19 5:19 pm, TarotApprentice wrote:
&gt;<i> Recently upgraded to Raspbian Buster and squid 4.6. Since then I am
</I>unable to cache the Packages.xz that apt uses. The various other Pis
using this proxy all end up downloading the 30MB Packages.xz every time.
Does anyone have any suggestions on how to get it to cache?
&gt;<i> 
</I>&gt;<i> Cheers MarkJ
</I>&gt;<i> 
</I>
According to both Redbot and my manual check the object is only 12MB,
not 30MB. If you are getting 30MB somebody is interfering with that
download.


It should be caching by default. The redbot tool shows the site is
providing all the required cache headers and working perfectly for
revalidation. The REFRESH_UNMODIFIED log entries show that too.

The TCP_MISS_ABORTED indicates that for that log entry there was nothing
in cache (yet) for that URL, and the client aborted the transfer with
only 2.6MB fetched.



Can you try having just one Pi do its update and seeing if the .xz
object is cached afterwards?

Alternatively try the command:
  squidclient
<A HREF="http://raspbian.raspberrypi.org/raspbian/dists/buster/main/binary-armhf/Packages.xz">http://raspbian.raspberrypi.org/raspbian/dists/buster/main/binary-armhf/Packages.xz</A>

It the object is cacheable, but your environment tends to have the Pi's
all fetching at the same time (eg before the first finishes), then you
may find collapsed_forwarding feature of use. That helps with caching
parallel fetches of objects.

Amos


&gt;<i> squid -v
</I>&gt;<i> Squid Cache: Version 4.6
</I>&gt;<i> Service Name: squid
</I>&gt;<i> Raspbian linux
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> access.log
</I>&gt;<i> 
</I>&gt;<i> 1563597855.786&#160;&#160;&#160; 605 192.168.1.73 TCP_REFRESH_UNMODIFIED/200 15306 GET <A HREF="http://raspbian.raspberrypi.org/raspbian/dists/buster/InRelease">http://raspbian.raspberrypi.org/raspbian/dists/buster/InRelease</A> - HIER_DIRECT/93.93.128.193 -
</I>&gt;<i> 
</I>&gt;<i> 1563597855.811&#160;&#160;&#160; 620 192.168.1.73 TCP_REFRESH_UNMODIFIED/200 25429 GET <A HREF="http://archive.raspberrypi.org/debian/dists/buster/InRelease">http://archive.raspberrypi.org/debian/dists/buster/InRelease</A> - HIER_DIRECT/93.93.128.133 -
</I>&gt;<i> 
</I>&gt;<i> 1563597857.486&#160;&#160;&#160; 620 192.168.1.73 TCP_REFRESH_UNMODIFIED/200 205801 GET <A HREF="http://archive.raspberrypi.org/debian/dists/buster/main/binary-armhf/Packages.gz">http://archive.raspberrypi.org/debian/dists/buster/main/binary-armhf/Packages.gz</A> - HIER_DIRECT/93.93.128.133 application/x-gzip
</I>&gt;<i> 
</I>&gt;<i> 1563597936.436&#160; 80026 192.168.1.73 TCP_MISS_ABORTED/200 2641974 GET <A HREF="http://raspbian.raspberrypi.org/raspbian/dists/buster/main/binary-armhf/Packages.xz">http://raspbian.raspberrypi.org/raspbian/dists/buster/main/binary-armhf/Packages.xz</A> - HIER_DIRECT/93.93.128.193 application/x-xz
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> config file
</I>&gt;<i> 
</I>...
&gt;<i> acl hiddenwasp2 dstdomain <A HREF="http://103.206.123.13">http://103.206.123.13</A>
</I>
The above &quot;<A HREF="http://">http://</A>&quot; is not a valid domain name.

&gt;<i> http_access deny !Safe_ports
</I>&gt;<i> http_access deny CONNECT !SSL_ports
</I>&gt;<i> http_access deny ads
</I>&gt;<i> http_access deny malware
</I>&gt;<i> http_access deny malware2
</I>&gt;<i> http_access deny hiddenwasp
</I>&gt;<i> http_access deny hiddenwasp2
</I>&gt;<i> http_access allow l500-020b manager
</I>&gt;<i> http_access deny manager
</I>

'dst' ACL is quite slow and resource intensive. You should put these
manager rules above the &quot;malware2&quot; denial to protect against DoS better.

...
&gt;<i> http_port 3128
</I>&gt;<i> cache_mem 448 MB
</I>&gt;<i> maximum_object_size 320 MB
</I>&gt;<i> memory_replacement_policy lru
</I>&gt;<i> cache_replacement_policy heap LFUDA
</I>&gt;<i> cache_dir aufs /var/spool/squid 18432 32 256
</I>&gt;<i> quick_abort_min -1 KB
</I>&gt;<i> client_request_buffer_max_size 128 KB
</I>
...

&gt;<i> refresh_pattern (\.deb|\.udeb)$ 1440&#160;&#160;&#160; 80%&#160;&#160;&#160;&#160; 10080
</I>&gt;<i> refresh_pattern ^ftp:&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; 1440&#160;&#160;&#160; 20%&#160;&#160;&#160;&#160; 10080
</I>&gt;<i> refresh_pattern ^gopher:&#160;&#160;&#160;&#160;&#160;&#160;&#160; 1440&#160;&#160;&#160; 0%&#160;&#160;&#160;&#160;&#160; 1440
</I>&gt;<i> refresh_pattern -i (/cgi-bin/|\?) 0&#160;&#160;&#160;&#160; 0%&#160;&#160;&#160;&#160;&#160; 0
</I>&gt;<i> refresh_pattern .&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; 0&#160;&#160;&#160;&#160;&#160;&#160; 20%&#160;&#160;&#160;&#160; 4320
</I>

Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="020787.html">[squid-users] caching apt package lists/Raspbian
</A></li>
	<LI>Next message (by thread): <A HREF="020794.html">[squid-users] caching apt package lists/Raspbian
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20789">[ date ]</a>
              <a href="thread.html#20789">[ thread ]</a>
              <a href="subject.html#20789">[ subject ]</a>
              <a href="author.html#20789">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
