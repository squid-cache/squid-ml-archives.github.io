<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] caching apt package lists/Raspbian
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20caching%20apt%20package%20lists/Raspbian&In-Reply-To=%3C45004701-F8F9-47F1-9D45-007ECBE81D6A%40yahoo.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="020789.html">
   <LINK REL="Next"  HREF="020796.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] caching apt package lists/Raspbian</H1>
    <B>Mark James</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20caching%20apt%20package%20lists/Raspbian&In-Reply-To=%3C45004701-F8F9-47F1-9D45-007ECBE81D6A%40yahoo.com%3E"
       TITLE="[squid-users] caching apt package lists/Raspbian">tarotapprentice at yahoo.com
       </A><BR>
    <I>Sun Jul 21 04:20:47 UTC 2019</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="020789.html">[squid-users] caching apt package lists/Raspbian
</A></li>
        <LI>Next message (by thread): <A HREF="020796.html">[squid-users] caching apt package lists/Raspbian
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20794">[ date ]</a>
              <a href="thread.html#20794">[ thread ]</a>
              <a href="subject.html#20794">[ subject ]</a>
              <a href="author.html#20794">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Doing an &#8220;apt update&#8221; on the squid machine got another TCP_MISS_ABORTED for ::1 and then subsequent IPv4 requests from other Pis get the TCP_REQUEST_UNMODIFIED.

Packages.xz was 13MB.


&gt;<i> On 21 Jul 2019, at 12:36 am, Amos Jeffries &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt; wrote:
</I>&gt;<i> 
</I>&gt;&gt;<i> On 20/07/19 5:19 pm, TarotApprentice wrote:
</I>&gt;&gt;<i> Recently upgraded to Raspbian Buster and squid 4.6. Since then I am
</I>&gt;<i> unable to cache the Packages.xz that apt uses. The various other Pis
</I>&gt;<i> using this proxy all end up downloading the 30MB Packages.xz every time.
</I>&gt;<i> Does anyone have any suggestions on how to get it to cache?
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> Cheers MarkJ
</I>&gt;&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> According to both Redbot and my manual check the object is only 12MB,
</I>&gt;<i> not 30MB. If you are getting 30MB somebody is interfering with that
</I>&gt;<i> download.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> It should be caching by default. The redbot tool shows the site is
</I>&gt;<i> providing all the required cache headers and working perfectly for
</I>&gt;<i> revalidation. The REFRESH_UNMODIFIED log entries show that too.
</I>&gt;<i> 
</I>&gt;<i> The TCP_MISS_ABORTED indicates that for that log entry there was nothing
</I>&gt;<i> in cache (yet) for that URL, and the client aborted the transfer with
</I>&gt;<i> only 2.6MB fetched.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Can you try having just one Pi do its update and seeing if the .xz
</I>&gt;<i> object is cached afterwards?
</I>&gt;<i> 
</I>&gt;<i> Alternatively try the command:
</I>&gt;<i>  squidclient
</I>&gt;<i> <A HREF="http://raspbian.raspberrypi.org/raspbian/dists/buster/main/binary-armhf/Packages.xz">http://raspbian.raspberrypi.org/raspbian/dists/buster/main/binary-armhf/Packages.xz</A>
</I>&gt;<i> 
</I>&gt;<i> It the object is cacheable, but your environment tends to have the Pi's
</I>&gt;<i> all fetching at the same time (eg before the first finishes), then you
</I>&gt;<i> may find collapsed_forwarding feature of use. That helps with caching
</I>&gt;<i> parallel fetches of objects.
</I>&gt;<i> 
</I>&gt;<i> Amos
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> squid -v
</I>&gt;&gt;<i> Squid Cache: Version 4.6
</I>&gt;&gt;<i> Service Name: squid
</I>&gt;&gt;<i> Raspbian linux
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> access.log
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> 1563597855.786    605 192.168.1.73 TCP_REFRESH_UNMODIFIED/200 15306 GET <A HREF="http://raspbian.raspberrypi.org/raspbian/dists/buster/InRelease">http://raspbian.raspberrypi.org/raspbian/dists/buster/InRelease</A> - HIER_DIRECT/93.93.128.193 -
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> 1563597855.811    620 192.168.1.73 TCP_REFRESH_UNMODIFIED/200 25429 GET <A HREF="http://archive.raspberrypi.org/debian/dists/buster/InRelease">http://archive.raspberrypi.org/debian/dists/buster/InRelease</A> - HIER_DIRECT/93.93.128.133 -
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> 1563597857.486    620 192.168.1.73 TCP_REFRESH_UNMODIFIED/200 205801 GET <A HREF="http://archive.raspberrypi.org/debian/dists/buster/main/binary-armhf/Packages.gz">http://archive.raspberrypi.org/debian/dists/buster/main/binary-armhf/Packages.gz</A> - HIER_DIRECT/93.93.128.133 application/x-gzip
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> 1563597936.436  80026 192.168.1.73 TCP_MISS_ABORTED/200 2641974 GET <A HREF="http://raspbian.raspberrypi.org/raspbian/dists/buster/main/binary-armhf/Packages.xz">http://raspbian.raspberrypi.org/raspbian/dists/buster/main/binary-armhf/Packages.xz</A> - HIER_DIRECT/93.93.128.193 application/x-xz
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> config file
</I>&gt;&gt;<i> 
</I>&gt;<i> ...
</I>&gt;&gt;<i> acl hiddenwasp2 dstdomain <A HREF="http://103.206.123.13">http://103.206.123.13</A>
</I>&gt;<i> 
</I>&gt;<i> The above &quot;<A HREF="http://">http://</A>&quot; is not a valid domain name.
</I>&gt;<i> 
</I>&gt;&gt;<i> http_access deny !Safe_ports
</I>&gt;&gt;<i> http_access deny CONNECT !SSL_ports
</I>&gt;&gt;<i> http_access deny ads
</I>&gt;&gt;<i> http_access deny malware
</I>&gt;&gt;<i> http_access deny malware2
</I>&gt;&gt;<i> http_access deny hiddenwasp
</I>&gt;&gt;<i> http_access deny hiddenwasp2
</I>&gt;&gt;<i> http_access allow l500-020b manager
</I>&gt;&gt;<i> http_access deny manager
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 'dst' ACL is quite slow and resource intensive. You should put these
</I>&gt;<i> manager rules above the &quot;malware2&quot; denial to protect against DoS better.
</I>&gt;<i> 
</I>&gt;<i> ...
</I>&gt;&gt;<i> http_port 3128
</I>&gt;&gt;<i> cache_mem 448 MB
</I>&gt;&gt;<i> maximum_object_size 320 MB
</I>&gt;&gt;<i> memory_replacement_policy lru
</I>&gt;&gt;<i> cache_replacement_policy heap LFUDA
</I>&gt;&gt;<i> cache_dir aufs /var/spool/squid 18432 32 256
</I>&gt;&gt;<i> quick_abort_min -1 KB
</I>&gt;&gt;<i> client_request_buffer_max_size 128 KB
</I>&gt;<i> 
</I>&gt;<i> ...
</I>&gt;<i> 
</I>&gt;&gt;<i> refresh_pattern (\.deb|\.udeb)$ 1440    80%     10080
</I>&gt;&gt;<i> refresh_pattern ^ftp:           1440    20%     10080
</I>&gt;&gt;<i> refresh_pattern ^gopher:        1440    0%      1440
</I>&gt;&gt;<i> refresh_pattern -i (/cgi-bin/|\?) 0     0%      0
</I>&gt;&gt;<i> refresh_pattern .               0       20%     4320
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Amos
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="020789.html">[squid-users] caching apt package lists/Raspbian
</A></li>
	<LI>Next message (by thread): <A HREF="020796.html">[squid-users] caching apt package lists/Raspbian
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20794">[ date ]</a>
              <a href="thread.html#20794">[ thread ]</a>
              <a href="subject.html#20794">[ subject ]</a>
              <a href="author.html#20794">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
