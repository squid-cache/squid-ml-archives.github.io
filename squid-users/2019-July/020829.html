<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Why `Storage Mem capacity` has a value larger than 100%.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Why%20%60Storage%20Mem%20capacity%60%20has%20a%20value%20larger%0A%20than%20100%25.&In-Reply-To=%3Cca793032-31b7-1219-4c2b-ec27d8bf01d5%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="020824.html">
   <LINK REL="Next"  HREF="020816.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Why `Storage Mem capacity` has a value larger than 100%.</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Why%20%60Storage%20Mem%20capacity%60%20has%20a%20value%20larger%0A%20than%20100%25.&In-Reply-To=%3Cca793032-31b7-1219-4c2b-ec27d8bf01d5%40treenet.co.nz%3E"
       TITLE="[squid-users] Why `Storage Mem capacity` has a value larger than 100%.">squid3 at treenet.co.nz
       </A><BR>
    <I>Wed Jul 31 14:39:50 UTC 2019</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="020824.html">[squid-users] Why `Storage Mem capacity` has a value larger	than 100%.
</A></li>
        <LI>Next message (by thread): <A HREF="020816.html">[squid-users] Unable to limit bandwidth (squid 4.7.2 )
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20829">[ date ]</a>
              <a href="thread.html#20829">[ thread ]</a>
              <a href="subject.html#20829">[ subject ]</a>
              <a href="author.html#20829">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 31/07/19 3:23 pm, kmiku7 wrote:
&gt;<i> 
</I>&gt;<i> Thanks your reply.
</I>&gt;<i> I am running 64bit build of squid on 64bit system. The output of top/ps
</I>&gt;<i> shows that squid is using as much memory as claimed in report.
</I>
Okay. That means the negative values are just an artifact of 32-bit
types used in the report display, not actually overflow bugs in the
store code.

&gt;<i> I configure cache directory with size of 4T: cache_dir ufs PATH 4194304 128
</I>&gt;<i> 256.
</I>
FYI: On 64-bit systems each 1GB of disk storage needs approximately 15MB
of RAM for the index and metadata.

Does your machine actually have 60GB of RAM available for the proxy to
use for this large cache_dir index?


Those numbers are relative to the avg object size. So I advise tuning
the min-size= parameter so only the many-MB objects get stored there.
That should cut the index RAM requirement by a few orders of magnitude.


&gt;<i> 
</I>&gt;<i> There are many child-process start, following is output of `ps`:
</I>&gt;<i> USER    20401  0.0  0.0  71020  2728 ?        Ss   Feb14   0:00
</I>&gt;<i> /PATH/TO/squid -f /PATH/TO/CONFIG/FILE -n squidHot
</I>&gt;<i> USER    20405  0.5 11.8 8258832 7771408 ?     S    Feb14 1298:30 (squid-1)
</I>&gt;<i> --kid squid-1 -f /PATH/TO/CONFIG/FILE -n squidHot
</I>&gt;<i> USER    20440  0.0  0.0  29468  1444 ?        S    Feb14   0:16
</I>&gt;<i> (logfile-daemon) /PATH/TO/access.log
</I>&gt;<i> USER    20441  0.0  0.0  29460  1256 ?        S    Feb14   0:00 (unlinkd)
</I>&gt;<i> USER    20444  0.0  0.0  29468  1252 ?        S    Feb14   0:00
</I>&gt;<i> (logfile-daemon) /PATH/TO/store.log
</I>&gt;<i> 
</I>&gt;<i> Process 20405 cost maximum memory.
</I>&gt;<i> 
</I>&gt;<i> Other part of report also make me puzzled:
</I>&gt;<i> 	Internal Data Structures:
</I>&gt;<i> 		  1185 StoreEntries
</I>
ie. Total number of objects being cached by this proxy.


&gt;<i> 		  1184 StoreEntries with MemObjects
</I>
ie. Total number of objects which have at least some portion stored in
RAM for fast access.

This includes:
 * all objects in cache_mem
 * all cacheable objects currently being received from a server
 * all cacheable objects currently being delivered to a client
(though objects may match multiple of those criteria, each is only
counted once).

The difference between this and total objects (1185 - 1184 = 1) is the
number of objects *only* stored in a cache_dir.


&gt;<i> 		     8 Hot Object Cache Items
</I>
ie. Total count of items in cache_mem area of RAM.

&gt;<i> 		     9 on-disk objects
</I>
ie. Total count of objects stored in all configured cache_dir.


&gt;<i> `9 on-disk objects` means only 9 entries of 1185 are stored on disk, and
</I>&gt;<i> others are stored in memory?
</I>&gt;<i> 
</I>
Essentially, yes.


&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Amos Jeffries wrote
</I>&gt;&gt;<i> Also, your proxy is apparently trying to fit objects with an *average*
</I>&gt;&gt;<i> size exceeding 70MB into that 256MB of cache. The bit of the report you
</I>&gt;&gt;<i> elided shows how many it is trying to fit in there.
</I>&gt;<i> 
</I>&gt;<i> Yes, we have many file larger than 256MB. But what problem will this lead
</I>&gt;<i> to? And why?
</I>&gt;<i> 
</I>
That will lead to disk I/O capacity being a major limiting factor in
delivery speed for all those objects. Since their data has to be saved
to or read from disk in order to be used.

Modulo bugs, the store is only supposed to be keeping a small portion of
them in memory awaiting delivery (on sending them) or waiting for
swapout to disk (on receiving). Though maximum_object_size_in_memory
place a role there, objects under that limit *may* be loaded fully into
cache_mem.

Check your object size limits:
&lt;<A HREF="http://www.squid-cache.org/Doc/config/minimum_object_size/">http://www.squid-cache.org/Doc/config/minimum_object_size/</A>&gt;
&lt;<A HREF="http://www.squid-cache.org/Doc/config/maximum_object_size/">http://www.squid-cache.org/Doc/config/maximum_object_size/</A>&gt;
&lt;<A HREF="http://www.squid-cache.org/Doc/config/maximum_object_size_in_memory/">http://www.squid-cache.org/Doc/config/maximum_object_size_in_memory/</A>&gt;


PS. I also advise upgrading to the latest v4 release to avoid the
security issues and a memory leak that have been fixed since v4.4.

Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="020824.html">[squid-users] Why `Storage Mem capacity` has a value larger	than 100%.
</A></li>
	<LI>Next message (by thread): <A HREF="020816.html">[squid-users] Unable to limit bandwidth (squid 4.7.2 )
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20829">[ date ]</a>
              <a href="thread.html#20829">[ thread ]</a>
              <a href="subject.html#20829">[ subject ]</a>
              <a href="author.html#20829">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
