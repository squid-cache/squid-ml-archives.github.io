<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Questions about connection pooling to origins when using squid as a HTTPS forward egress proxy
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Questions%20about%20connection%20pooling%20to%20origins%0A%20when%20using%20squid%20as%20a%20HTTPS%20forward%20egress%20proxy&In-Reply-To=%3C8e3c7ff6-ef54-165b-0b72-bb2b6fb60010%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="020621.html">
   <LINK REL="Next"  HREF="020625.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Questions about connection pooling to origins when using squid as a HTTPS forward egress proxy</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Questions%20about%20connection%20pooling%20to%20origins%0A%20when%20using%20squid%20as%20a%20HTTPS%20forward%20egress%20proxy&In-Reply-To=%3C8e3c7ff6-ef54-165b-0b72-bb2b6fb60010%40treenet.co.nz%3E"
       TITLE="[squid-users] Questions about connection pooling to origins when using squid as a HTTPS forward egress proxy">squid3 at treenet.co.nz
       </A><BR>
    <I>Fri Jun  7 10:41:00 UTC 2019</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="020621.html">[squid-users] Questions about connection pooling to origins when using squid as a HTTPS forward egress proxy
</A></li>
        <LI>Next message (by thread): <A HREF="020625.html">[squid-users] Questions about connection pooling to origins when using squid as a HTTPS forward egress proxy
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20624">[ date ]</a>
              <a href="thread.html#20624">[ thread ]</a>
              <a href="subject.html#20624">[ subject ]</a>
              <a href="author.html#20624">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 7/06/19 9:30 pm, Srikanth Raju wrote:
&gt;<i> Hello!
</I>&gt;<i> We are planning to use squid as a forward egress proxy to whitelist
</I>&gt;<i> domains. In general, we configured it to whitelist/blacklist domains
</I>&gt;<i> based on the examples in the site and this seems to work with peek and
</I>&gt;<i> splice on our preliminary tests as a transparent egress proxy. We're
</I>&gt;<i> doing this with an AWS VPC using the standard techniques documented in
</I>&gt;<i> their blogs
</I>&gt;<i> 
</I>&gt;<i> I had a few questions about the setup for some additional features
</I>&gt;<i> 
</I>&gt;<i>   * We want to have the ability to connection pool certain HTTPS calls
</I>&gt;<i>     going externally within from within squid. This would be
</I>&gt;<i>     specifically for some external partners that we know have slow
</I>&gt;<i>     connection setup time and or in case of misbehaving libraries.
</I>&gt;<i>   * WIth &quot;peek and splice&quot; method for HTTPS, this doesn't make sense,
</I>&gt;<i>     since it's a TCP tunnel basically. There shouldn't be a way to
</I>&gt;<i>     replay the handshake, hence it's impossible to pool at the squid layer.
</I>
Your conclusion is correct. But the true reason is that splice sets up
an end-to-end relationship for the client and server. Squid has no part
of anything happening inside the tunnel. There is *literally* no way to
coordinate N clients to share a tunnel.


&gt;<i>   * We need to consider 'bump' for some use cases along with our own
</I>&gt;<i>     intermediate CA, which we're ok with, since we can choose the
</I>&gt;<i>     domains to 'splice' and domains to 'bump'/
</I>
Correct.

&gt;<i>   * The biggest reason we care about TLS termination with bump is
</I>&gt;<i>     because we think it might give us performance benefits along some
</I>&gt;<i>     critical code paths *due to connection pooling to some slow
</I>&gt;<i>     upstreams within squid.*
</I>&gt;<i>   * Does squid automatically do this or does it need some extra config.
</I>&gt;<i>     I was looking at 'server_connections' config var.
</I>

HTTPS connections cannot be pooled due to protocol ties at the transport
level between clients and servers. Once details of the TLS handshake are
delivered they are pinned together.

Instead Squid delivers what <A HREF="https://">https://</A> responses it can from cache, which
is the next best thing.


&gt;<i> [Currently we
</I>&gt;<i>     roughly follow the config in the AWS Guide]
</I>&gt;<i>     &lt;<A HREF="https://aws.amazon.com/blogs/security/how-to-add-dns-filtering-to-your-nat-instance-with-squid/">https://aws.amazon.com/blogs/security/how-to-add-dns-filtering-to-your-nat-instance-with-squid/</A>&gt;
</I>&gt;<i> 
</I>
Please be aware that config is unsafe. It effectively makes an
open-proxy setup. Any client anywhere in the world can abuse the proxy
as a relay to reach any AWS hosted site.


&gt;<i> 
</I>&gt;<i> Another thing we cared about , with a much lower priority, was HTTP/2
</I>&gt;<i> translation. We would like to reap the benefits of HTTP/2 on external
</I>&gt;<i> services that do support it and we connect to, but our application does
</I>&gt;<i> not yet have any production-safe http2 clients(python).
</I>&gt;<i> Is there any roadmap for when that will land on Squid master?
</I>&gt;<i> 
</I>
HTTP/2 is not being directly worked on at present. I go back to it
occasionally, but most of my time has been taken up with improving the
HTTPS support.


Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="020621.html">[squid-users] Questions about connection pooling to origins when using squid as a HTTPS forward egress proxy
</A></li>
	<LI>Next message (by thread): <A HREF="020625.html">[squid-users] Questions about connection pooling to origins when using squid as a HTTPS forward egress proxy
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20624">[ date ]</a>
              <a href="thread.html#20624">[ thread ]</a>
              <a href="subject.html#20624">[ subject ]</a>
              <a href="author.html#20624">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
