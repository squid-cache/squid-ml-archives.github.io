<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Attempting to use follow_x_forwarded_for in ACL
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Attempting%20to%20use%20follow_x_forwarded_for%20in%20ACL&In-Reply-To=%3CDM5PR19MB1579088FD14378C793AC7EA7CD100%40DM5PR19MB1579.namprd19.prod.outlook.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="020622.html">
   <LINK REL="Next"  HREF="020618.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Attempting to use follow_x_forwarded_for in ACL</H1>
    <B>Joey Officer</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Attempting%20to%20use%20follow_x_forwarded_for%20in%20ACL&In-Reply-To=%3CDM5PR19MB1579088FD14378C793AC7EA7CD100%40DM5PR19MB1579.namprd19.prod.outlook.com%3E"
       TITLE="[squid-users] Attempting to use follow_x_forwarded_for in ACL">JOfficer at istreamfs.com
       </A><BR>
    <I>Fri Jun  7 14:03:12 UTC 2019</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="020622.html">[squid-users] Attempting to use follow_x_forwarded_for in ACL
</A></li>
        <LI>Next message (by thread): <A HREF="020618.html">[squid-users] client delay pools
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20627">[ date ]</a>
              <a href="thread.html#20627">[ thread ]</a>
              <a href="subject.html#20627">[ subject ]</a>
              <a href="author.html#20627">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Thank you for the reply Amos.  I went back and read the documentation yesterday with a fresh set of eyes and realized what I was doing wrong.  Your summary at the end of your reply is exactly where I ended up once I understood what the follow_x_forwarded_for directive was doing.  To be fair, the documentation is straight-forward enough, I simply mis-understood what it was really doing (might have been lack of sleep).  I ended up turning on debug and reading through cache.log to see the rule and it's lack of matching (that's when I went back and re-read the docs - having my light bulb moment).

I modified my squid.conf almost exactly as you referenced (I didn't know I could put in a range of IPs like that for the haproxy hosts, so thanks!) and re-tested.  The end result is exactly what I was expecting / hoping for.  Hopefully this thread can serve as a clearer example for future generations ;)

Cheers,
Joey


-----Original Message-----
From: squid-users &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>&gt; On Behalf Of Amos Jeffries
Sent: Friday, June 7, 2019 4:34 AM
To: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
Subject: Re: [squid-users] Attempting to use follow_x_forwarded_for in ACL

On 7/06/19 2:38 am, Joey Officer wrote:
&gt;<i> Greetings all,
</I>&gt;<i> 
</I>&gt;<i> &#160;
</I>&gt;<i> 
</I>&gt;<i> squid.conf references the ability to use the x-forwarded-for header in 
</I>&gt;<i> ACLs by using the follow_x_forwarded_for in ACL, referenced here:
</I>&gt;<i> <A HREF="http://www.squid-cache.org/Doc/config/follow_x_forwarded_for/">http://www.squid-cache.org/Doc/config/follow_x_forwarded_for/</A> and here 
</I>&gt;<i> <A HREF="http://www.squid-cache.org/Doc/config/acl_uses_indirect_client/">http://www.squid-cache.org/Doc/config/acl_uses_indirect_client/</A>
</I>&gt;<i> 
</I>&gt;<i> &#160;
</I>&gt;<i> 
</I>&gt;<i> There appear to be three pre-reqs, which I&#8217;ve met:
</I>&gt;<i> 
</I>&gt;<i> &#160;
</I>&gt;<i> 
</I>&gt;<i> squid.conf: acl_uses_indirect_client on
</I>&gt;<i> 
</I>&gt;<i> squid built with --enable-follow-x-forwarded-for (confirmed)
</I>&gt;<i> 
</I>&gt;<i> and the appropriate ACL entries (see below)
</I>&gt;<i> 
</I>

More correctly; configuration to tell Squid which clients to trust X-Forwarded-For headers from.


&gt;<i> &#160;
</I>&gt;<i> 
</I>&gt;<i> In my scenario, I have a pair of squid hosts (squid ver 3.5.6) sitting 
</I>&gt;<i> behind a pair of haproxy/keepalived hosts which provide balancing and 
</I>&gt;<i> redundancy/availability.&#160; Haproxy is configured to add an 
</I>&gt;<i> x-forwarded-for header (if one doesn&#8217;t already exist) and I can see 
</I>&gt;<i> the x-forwarded-for header in the request if I run packet capture on 
</I>&gt;<i> the squid hosts.
</I>&gt;<i> 
</I>&gt;<i> &#160;
</I>&gt;<i> 
</I>&gt;<i> For this scenario, I have a box sitting on the 192.168.4.0/24 network, 
</I>&gt;<i> which has access to three IPs on 192.168.2.0/24 network (2.30, 2.31, 
</I>&gt;<i> and
</I>&gt;<i> 2.32 which are haproxy1, haproxy2, and keepalived vIP respectively). 
</I>&gt;<i> Hosts wanting internet access must using the haproxy-vip as a proxy 
</I>&gt;<i> IP, which is then forwarded to the real squid backends.&#160; To sum up:
</I>&gt;<i> 
</I>&gt;<i> &#160;
</I>&gt;<i> 
</I>&gt;<i> haproxy1 &#8211; 192.168.2.30
</I>&gt;<i> 
</I>&gt;<i> haproxy2 &#8211; 192.168.2.31
</I>&gt;<i> 
</I>&gt;<i> haproxy-vip &#8211; 192.168.2.32
</I>&gt;<i> 
</I>&gt;<i> squid1 &#8211; 192.168.2.128
</I>&gt;<i> 
</I>&gt;<i> squid2 &#8211; 192.168.2.129
</I>&gt;<i> 
</I>&gt;<i> zone1 &#8211; 192.168.3.0/24 with hosts having a proxy configured as
</I>&gt;<i> 192.168.2.32:3128
</I>&gt;<i> 
</I>&gt;<i> client1 &#8211; 192.168.4.31 with a proxy configured as 192.168.2.32:3128
</I>&gt;<i> 
</I>&gt;<i> &#160;
</I>&gt;<i> 
</I>&gt;<i> Squid will see the real-ip of the client connection as the haproxy-vip 
</I>&gt;<i> endpoint and not the real-client IP.&#160; If I understand the 
</I>&gt;<i> documentation correctly, I should be able to perform something like 
</I>&gt;<i> the following in an ACL:
</I>&gt;<i> 
</I>

&quot;client&quot; is the initiating end of a single TCP connection. It is a relative term. The client on traffic arriving to Squid really is the haproxy-vip IP.

There may be X-Forwarded-For header chains passed in by the client(s) on the other side of the HAProxy. Or other clients that bypass the HAProxy to connect directly with Squid. None of the IP's are necessarily what you consider the &quot;real&quot; client.

Understanding that is important to understanding what follow_x_Forwarded_for does and how to use it safely.


follow_x_forwarded_for tells Squid which clients it can trust to receive X-Forwarded-For values from. In other words your HAProxy machines *only* are trusted to deliver true XFF headers:

  acl haproxy src 192.168.2.30-192.168.2.32
  follow_x_forwarded_for allow haproxy
  follow_x_forwarded_for deny all


So whatever IPs connected to the HAProxy will be treated as Squid client-IP instead of the HAProxy themselves. Any clients bypassing the haproxy and connecting to Squid will remain being recorded properly as the &quot;real&quot; client. And any fake values a &quot;real&quot; client tries to inject will be ignored.


&gt;<i> 
</I>&gt;<i> # create acl source references
</I>&gt;<i> 
</I>&gt;<i> acl zone1 src 192.168.3.0/24
</I>&gt;<i> 
</I>&gt;<i> acl client1 src 192.168.4.31/32
</I>&gt;<i> 
</I>&gt;<i> &#160;
</I>&gt;<i> 
</I>&gt;<i> # acl to test x-forwarded-for matching header
</I>&gt;<i> 
</I>&gt;<i> acl testing_proxy_dst dstdomain .google.com
</I>&gt;<i> 
</I>&gt;<i> follow_x_forwarded_for allow zone1 testing_proxy_dst
</I>&gt;<i> 
</I>&gt;<i> follow_x_forwarded_for allow client1 testing_proxy_dst
</I>&gt;<i> 
</I>
What you are doing here is telling Squid to trust any values / lies the
zone1 or cleint1 machines send in their XFF headers - but *not* to trust the HAProxy frontends.

I hope that makes it clear what is going on.


Amos
_______________________________________________
squid-users mailing list
<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
<A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="020622.html">[squid-users] Attempting to use follow_x_forwarded_for in ACL
</A></li>
	<LI>Next message (by thread): <A HREF="020618.html">[squid-users] client delay pools
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20627">[ date ]</a>
              <a href="thread.html#20627">[ thread ]</a>
              <a href="subject.html#20627">[ subject ]</a>
              <a href="author.html#20627">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
