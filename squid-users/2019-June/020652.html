<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Log resolved IP somehow?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Log%20resolved%20IP%20somehow%3F&In-Reply-To=%3C566a2c2f-eaa5-4f9d-4473-2a7577246d83%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="020650.html">
   <LINK REL="Next"  HREF="020653.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Log resolved IP somehow?</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Log%20resolved%20IP%20somehow%3F&In-Reply-To=%3C566a2c2f-eaa5-4f9d-4473-2a7577246d83%40treenet.co.nz%3E"
       TITLE="[squid-users] Log resolved IP somehow?">squid3 at treenet.co.nz
       </A><BR>
    <I>Tue Jun 18 14:13:08 UTC 2019</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="020650.html">[squid-users] Log resolved IP somehow?
</A></li>
        <LI>Next message (by thread): <A HREF="020653.html">[squid-users] [ext] Re:  Log resolved IP somehow?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20652">[ date ]</a>
              <a href="thread.html#20652">[ thread ]</a>
              <a href="subject.html#20652">[ subject ]</a>
              <a href="author.html#20652">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 19/06/19 1:37 am, Ralf Hildebrandt wrote:
&gt;<i> From my log:
</I>&gt;<i> ============
</I>&gt;<i> 
</I>&gt;<i> Mon Jun 17 07:28:47 2019     36 10.39.68.232 TCP_DENIED/302 390 CONNECT trx.adscale.de:443 - HIER_NONE/- text/html accessRule=ensiloip -
</I>&gt;<i> 
</I>&gt;<i> Now I tried find out why  trx.adscale.de is being denied. I'm using squid-5 with annotate_transaction:
</I>&gt;<i> 
</I>&gt;<i> acl markensiloip annotate_transaction accessRule=ensiloip
</I>&gt;<i> acl ensiloip dst &quot;/etc/squid5/manual-ensilo-ipblocklist.acl&quot;
</I>&gt;<i> http_access deny ensiloip markensiloip
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> So I *DO* know that /etc/squid5/manual-ensilo-ipblocklist.acl must be
</I>&gt;<i> the reason for the refusal -- so I resolved trx.adscale.de and got:
</I>&gt;<i> 
</I>&gt;<i> # host trx.adscale.de
</I>&gt;<i> trx.adscale.de is an alias for san.adscale.de.edgekey.net.
</I>&gt;<i> san.adscale.de.edgekey.net is an alias for e9040.g.akamaiedge.net.
</I>&gt;<i> e9040.g.akamaiedge.net has address 95.100.198.56
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> So a CDN is being used. And alas:
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> # fgrep -c 95.100.198.56 /etc/squid5/manual-ensilo-ipblocklist.acl
</I>&gt;<i> 0
</I>&gt;<i> # fgrep -c 95.100.198 /etc/squid5/manual-ensilo-ipblocklist.acl
</I>&gt;<i> 0
</I>&gt;<i> # fgrep -c 95.100 /etc/squid5/manual-ensilo-ipblocklist.acl
</I>&gt;<i> 0
</I>&gt;<i> 
</I>&gt;<i> So, I guss the IP must have change between to time &quot;trx.adscale.de&quot; was
</I>&gt;<i> blocked and now. 
</I>
Or,
 its IPv6 is listed.

Or,
 your test was done from a different machine than the one running Squid.

Or,
 the DNS query packet arrived at Akamai via a different DNS recursive
resolver this time.

Or,
 the Internet route between your network and Akamai DNS changed slightly.

(Don't we all love query-dependent DNS responses.)

&gt;<i> 
</I>&gt;<i> How can I log the IP &quot;trx.adscale.de&quot; resolved to when the rejection happened?
</I>&gt;<i> 
</I>
Your DNS resolver logs should contain that info.

If the check is close to the transaction time, then your Squid ipcache
manager report should list all the IPs that domain has.

Other than that, your best bet would be the debug trace of what ACLs are
matching. &quot;debug_options 28,4&quot; should do it.


Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="020650.html">[squid-users] Log resolved IP somehow?
</A></li>
	<LI>Next message (by thread): <A HREF="020653.html">[squid-users] [ext] Re:  Log resolved IP somehow?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20652">[ date ]</a>
              <a href="thread.html#20652">[ thread ]</a>
              <a href="subject.html#20652">[ subject ]</a>
              <a href="author.html#20652">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
