<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] How to enable proxy protocol v2 on squid version 4.6.1, and NLB
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20How%20to%20enable%20proxy%20protocol%20v2%20on%20squid%20version%0A%204.6.1%2C%20and%20NLB&In-Reply-To=%3Caee01b57-5b5c-689e-09df-9f3d836c3c66%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="020660.html">
   <LINK REL="Next"  HREF="020662.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] How to enable proxy protocol v2 on squid version 4.6.1, and NLB</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20How%20to%20enable%20proxy%20protocol%20v2%20on%20squid%20version%0A%204.6.1%2C%20and%20NLB&In-Reply-To=%3Caee01b57-5b5c-689e-09df-9f3d836c3c66%40treenet.co.nz%3E"
       TITLE="[squid-users] How to enable proxy protocol v2 on squid version 4.6.1, and NLB">squid3 at treenet.co.nz
       </A><BR>
    <I>Fri Jun 21 12:13:24 UTC 2019</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="020660.html">[squid-users] How to enable proxy protocol v2 on squid version	4.6.1, and NLB
</A></li>
        <LI>Next message (by thread): <A HREF="020662.html">[squid-users] splash page: redirection loop
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20661">[ date ]</a>
              <a href="thread.html#20661">[ thread ]</a>
              <a href="subject.html#20661">[ subject ]</a>
              <a href="author.html#20661">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 21/06/19 10:45 pm, summaiya wrote:
&gt;<i> Hi All, 
</I>&gt;<i> 
</I>&gt;<i> I have deployed EC2 Egress URL Filtering Squid Proxy solution, I have used
</I>&gt;<i> AWS PrivateLink to centralize web filtering in explicit mode. Squid proxy
</I>&gt;<i> farm is implemented by a Network Load Balancer which distributes TCP
</I>&gt;<i> requests across multiple Target Squid proxy instances, running in separate
</I>&gt;<i> Availability Zones
</I>&gt;<i> 
</I>&gt;<i> My setup is similar to that mentioned in this blog :-
</I>&gt;<i> <A HREF="https://aws.amazon.com/blogs/networking-and-content-delivery/how-to-use-aws-privatelink-to-secure-and-scale-web-filtering-using-explicit-proxy/">https://aws.amazon.com/blogs/networking-and-content-delivery/how-to-use-aws-privatelink-to-secure-and-scale-web-filtering-using-explicit-proxy/</A>
</I>&gt;<i> 
</I>&gt;<i> I have installed Squid version 4.6.1, but the access log do not show the
</I>&gt;<i> client ip address, even though I added the below rules:- 
</I>&gt;<i> http_port 3128 require-proxy-header
</I>&gt;<i> http_port 3128
</I>
You cannot have two identical listening ports. Remove the second.

&gt;<i> proxy_protocol_access allow localnet
</I>&gt;<i> 
</I>
This access control is supposed to *only* match true for the specific
machines who are allowed to send PROXY protocol traffic to your Squid
(aka the where A/B machinery).

WARNING: If you open it to a whole network like AWS you are effectively
allowing anyone else with AWS hosted services to use your proxy and
worse, to control what information shows up in your log files - so you
cannot see who the abuser/attacker is. Use these features with extreme
care, they actively hide attacks from your regular logging view(s).


&gt;<i> The proxy settings at the client are below :-
</I>&gt;<i> [<A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at ip-172-16-1-99</A> ~]# export | grep proxy
</I>&gt;<i> declare -x
</I>&gt;<i> http_proxy=&quot;<A HREF="http://vpce-05a51748abb0bfd68-4e77o32h.vpce-svc-070d1304cc7cc5b5f.eu-west-2.vpce.amazonaws.com:3128">http://vpce-05a51748abb0bfd68-4e77o32h.vpce-svc-070d1304cc7cc5b5f.eu-west-2.vpce.amazonaws.com:3128</A>&quot;
</I>&gt;<i> declare -x
</I>&gt;<i> https_proxy=&quot;<A HREF="http://vpce-05a51748abb0bfd68-4e77o32h.vpce-svc-070d1304cc7cc5b5f.eu-west-2.vpce.amazonaws.com:3128">http://vpce-05a51748abb0bfd68-4e77o32h.vpce-svc-070d1304cc7cc5b5f.eu-west-2.vpce.amazonaws.com:3128</A>&quot;
</I>&gt;<i> declare -x no_proxy=&quot;169.254.169.254
</I>&gt;<i> 
</I>&gt;<i> But still the access logs do not show the client ip address, am I missing
</I>&gt;<i> something in the solution.Do I have to enable the proxy protocol v2 at NLB
</I>&gt;<i> level as welll, will it break the application? 
</I>&gt;<i> I checked most of the similar blogs, but I did not find any proper solution.
</I>&gt;<i> 
</I>
Since you do not already know the answer to that question I suspect you
may be misunderstanding what PROXY protocol is.

PROXY is a wrapper protocol for use between two intermediaries. Such
that the frontend one can inform the backend about details of TCP
connections it is relaying.


&gt;<i>From your log below it looks like the NLB is the frontend and Squid the
</I>backend. But I am not completely clear on your full HTTP route design,
so there may be other middleware agents to take into account.

Hopefully the above details can help you answer the question for
yourself about where to enable PROXY and whether its actually usable in
your topology. Keep in mind that others using it for their designs does
not mean yours is able to.


&gt;<i> Squid Access logs :- showing ip address of NLB not client ip address 
</I>&gt;<i> 
</I>&gt;<i> [<A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at ip-10-0-0-193</A> squid]# cat access.log
</I>&gt;<i> 1560426278.960      0 10.0.0.17 TAG_NONE/400 4546 NONE error:invalid-request
</I>&gt;<i> - HIER_NONE/- text/html
</I>&gt;<i> 1560426279.647      0 10.0.0.17 TAG_NONE/400 4546 NONE error:invalid-request
</I>&gt;<i> - HIER_NONE/- text/html
</I>&gt;<i> 
</I>&gt;<i> Kindly provide some steps which I need to take care at squid servers conf
</I>&gt;<i> file and at client instance.
</I>
10.0.0.17 is connecting to your Squid and sending something which is not
a PROXY protocol header.

So yes at very least *if* that is a middleware machine; then it needs to
support sending PROXY protocol (and to have it enabled).

Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="020660.html">[squid-users] How to enable proxy protocol v2 on squid version	4.6.1, and NLB
</A></li>
	<LI>Next message (by thread): <A HREF="020662.html">[squid-users] splash page: redirection loop
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20661">[ date ]</a>
              <a href="thread.html#20661">[ thread ]</a>
              <a href="subject.html#20661">[ subject ]</a>
              <a href="author.html#20661">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
