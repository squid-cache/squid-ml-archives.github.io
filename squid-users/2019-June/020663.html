<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] splash page: redirection loop
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20splash%20page%3A%20redirection%20loop&In-Reply-To=%3Cebf5d968-bb73-0024-8853-63e42e799eb9%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="020662.html">
   <LINK REL="Next"  HREF="020665.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] splash page: redirection loop</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20splash%20page%3A%20redirection%20loop&In-Reply-To=%3Cebf5d968-bb73-0024-8853-63e42e799eb9%40treenet.co.nz%3E"
       TITLE="[squid-users] splash page: redirection loop">squid3 at treenet.co.nz
       </A><BR>
    <I>Mon Jun 24 13:05:39 UTC 2019</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="020662.html">[squid-users] splash page: redirection loop
</A></li>
        <LI>Next message (by thread): <A HREF="020665.html">[squid-users] splash page: redirection loop
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20663">[ date ]</a>
              <a href="thread.html#20663">[ thread ]</a>
              <a href="subject.html#20663">[ subject ]</a>
              <a href="author.html#20663">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 24/06/19 5:04 am, <A HREF="https://lists.squid-cache.org/listinfo/squid-users">julien412 at yahoo.fr</A> wrote:
&gt;<i> Hello,
</I>&gt;<i> 
</I>&gt;<i> I'm trying to use Squid with Splash page and followed
</I>&gt;<i> <A HREF="https://wiki.squid-cache.org/ConfigExamples/Portal/Splash">https://wiki.squid-cache.org/ConfigExamples/Portal/Splash</A> but I've got
</I>&gt;<i> an issue with a redirection loop.
</I>&gt;<i> Connecting to any web site redirects to splash page but splash page is
</I>&gt;<i> redirected to itself in infinite loop until squid breaks it.
</I>&gt;<i> 
</I>&gt;<i> This happens on Centos7/Squid 3.5.20, Ubuntu bionic/3.5.27 or 4.4 source
</I>&gt;<i> build.
</I>&gt;<i> 
</I>&gt;<i> Installed with ansible role with travis testing failing on redirection
</I>&gt;<i> <A HREF="https://travis-ci.org/juju4/ansible-squid/jobs/549377518">https://travis-ci.org/juju4/ansible-squid/jobs/549377518</A>
</I>&gt;<i> 
</I>&gt;<i> This part should not happen
</I>&gt;<i> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; +&lt; HTTP/1.1 302 Found
</I>&gt;<i> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; +&lt; Server: squid/3.5.27
</I>&gt;<i> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; +&lt; Mime-Version: 1.0
</I>&gt;<i> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; +&lt; Date: Sun, 23 Jun 2019 15:04:22 GMT
</I>&gt;<i> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; +&lt; Content-Type: text/html;charset=utf-8
</I>&gt;<i> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; +&lt; Content-Length: 0
</I>&gt;<i> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; +&lt; Location:
</I>&gt;<i> <A HREF="http://localhost/splash.php?url=http%3A%2F%2Flocalhost%2Fsplash.php%3Furl%3Dhttp%253A%252F%252Fwww.google.com%252F">http://localhost/splash.php?url=http%3A%2F%2Flocalhost%2Fsplash.php%3Furl%3Dhttp%253A%252F%252Fwww.google.com%252F</A>
</I>&gt;<i> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; +&lt; X-Squid-Error: 403 Access Denied
</I>&gt;<i> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; +&lt; X-Cache: MISS from default-splash-ubuntu-1804-1561301803
</I>&gt;<i> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; +&lt; X-Cache-Lookup: NONE from
</I>&gt;<i> default-splash-ubuntu-1804-1561301803:3128
</I>&gt;<i> &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; +&lt; Connection: keep-alive
</I>&gt;<i> 
</I>&gt;<i> Config extract
</I>&gt;<i> &#160;&#160;&#160;&#160;&#160; external_acl_type splash_page ttl=60 concurrency=100 %SRC
</I>&gt;<i> /usr/lib/squid/ext_session_acl -t 7200 -b /var/lib/squid/session.db
</I>&gt;<i> &#160;&#160;&#160;&#160;&#160;&#160; acl existing_users external splash_page
</I>&gt;<i> &#160;&#160;&#160;&#160;&#160;&#160; deny_info <A HREF="http://localhost/splash.php?url=%s">http://localhost/splash.php?url=%s</A> existing_users&#160;&#160;&#160;&#160;&#160;&#160;
</I>&gt;<i> &#160;&#160;&#160;&#160;&#160;&#160; http_access deny !existing_users
</I>&gt;<i> 
</I>&gt;<i> Any advices?
</I>

Couple of things:

* this is a localhost URL. The client is expected to contact *its*
localhost, not use the proxy for the followup request. But that is not
related to the loop here.


* you need to check access.log to see whether the client src-IP is
changing between requests. If it does that is the cause of the loop.

 - the test is broken: it configures Squid to send data to
access_custom.log *instead* of access.log, then tries to use the empty
access.log as the test log output.


* please add &quot;-d&quot; to the session helper command line options. That
should show what the helper is doing to declare &quot;no session&quot; when the
client feeds back the splash URL to the proxy.



PS. If I am reading the PR which is being tested - it looks like it
changes the check from one which checks;
 - the Location URL being redirected to the splash page =&gt; OK
 - the Location URL looping =&gt; BAD
 - all non-splash URLs =&gt; BAD
to;
 - the Location has *any* URL which includes the splash page =&gt; OK
   (corollary: - the Location URL looping =&gt; OK !!)
 - all non-splash URLs =&gt; BAD

Squid is only failing this test because v3.5 eventually rejects one of
the 8KB+ long URLs generated by the loop.


There are problems with the underlying helper tests too:

   describe command('echo 10.0.0.1 concurrency=100 | ...

==&gt;  &quot;10.0.0.1&quot; is an invalid concurrency channel number. Channel IDs
are integer values in current helpers. If your squid.conf contains
&quot;concurrency=100&quot; the channel-ID delivered to the helper will be an
integer between 0 and 99 (inclusive).

==&gt;  &quot;concurrency=100&quot; is the name of the session you just asked the
helper to create.

==&gt; combined the above problems mean your helper test is not testing the
same type of sessions as your other tests are trying to use.

Luckily the session helper does not actually care what the session name
values are, they are just opaque strings - hashed and stored for &quot;-t N&quot;
seconds. So this still tests that the helper works, just not in the way
apparently intended.


Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="020662.html">[squid-users] splash page: redirection loop
</A></li>
	<LI>Next message (by thread): <A HREF="020665.html">[squid-users] splash page: redirection loop
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20663">[ date ]</a>
              <a href="thread.html#20663">[ thread ]</a>
              <a href="subject.html#20663">[ subject ]</a>
              <a href="author.html#20663">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
