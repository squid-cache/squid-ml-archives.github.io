<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Help with transparent whitelisting proxy on Squid	4.4
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Help%20with%20transparent%20whitelisting%20proxy%20on%20Squid%0A%094.4&In-Reply-To=%3CCAOR_B-ffSjPTXowhRQqsFWGm20_gUA2Ps1LxA3mOy1ma_WdUBg%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="020673.html">
   <LINK REL="Next"  HREF="020677.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Help with transparent whitelisting proxy on Squid	4.4</H1>
    <B>Jared Fox</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Help%20with%20transparent%20whitelisting%20proxy%20on%20Squid%0A%094.4&In-Reply-To=%3CCAOR_B-ffSjPTXowhRQqsFWGm20_gUA2Ps1LxA3mOy1ma_WdUBg%40mail.gmail.com%3E"
       TITLE="[squid-users] Help with transparent whitelisting proxy on Squid	4.4">jared.fox at practiv.com
       </A><BR>
    <I>Wed Jun 26 23:39:58 UTC 2019</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="020673.html">[squid-users] Help with transparent whitelisting proxy on Squid 4.4
</A></li>
        <LI>Next message (by thread): <A HREF="020677.html">[squid-users] Help with transparent whitelisting proxy on Squid 4.4
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20676">[ date ]</a>
              <a href="thread.html#20676">[ thread ]</a>
              <a href="subject.html#20676">[ subject ]</a>
              <a href="author.html#20676">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Amos

So i have tried the following based on your suggestions, but it is
still failing and have errors below:

1. Switched to a wildcard whitelist instead of single domain
2. Updated the logformat to provide more information, see below:
3. Add in `--client-requested`, but this made no difference.
   3a. Add to single ACL, acl domainIsWhitelisted ssl::server_name
--client-requested cloudtrace.googleapis.com
   3b. Commented out single record, switched to wildcard
   3c. Add to wildcard

Error messages and Logs:

Access Log:     26/Jun/2019:23:18:38     96 REDACTED 216.58.200.106
NONE/200 0 CONNECT 216.58.200.106:443 HTTP/1.1 SSL:
cloudtrace.googleapis.com peek Client(Subject/Tx/Neg/Sup/Cip): -
TLS/1.0 - TLS/1.2 - Server(Subject/Rx/Neg/Sup/Cip): - TLS/1.2 -
TLS/1.2 -

Cache Log:     2019/06/26 23:18:38 kid1| ERROR: negotiating TLS on FD
11: error:140920F8:SSL routines:ssl3_get_server_hello:unknown cipher
returned (1/-1/0)

Can you please explain what you mean? What should this changed to so
that it does work.

&gt;<i> Please be aware that in your config the ssl::server_name ACL is *not* matching the SNI in your config.
</I>&gt;<i> - Your ssl_bump rules say &quot;peek all&quot; - so peek happens on the two Hello
</I>&gt;<i> messages. When the serverHello has been peek'd the real server name is
</I>&gt;<i> available from the servers own certificate.
</I>
Updated Squid.conf.

# ===========================
# Squid 4.7 Config - Work in Progress
# ===========================

acl localnet src 10.0.0.0/8                 # Kubernetes VPC CIDR range
acl SSL_ports port 443                      # HTTPS
acl Safe_ports port 80                       # HTTP
acl Safe_ports port 443                     # HTTPS
acl CONNECT method CONNECT   # Traffic restriction
acl step1 at_step SslBump1              # Needed by ssl-bump

# -------------------------------
# Whitelist the following Domains
# -------------------------------
# FQDN - Try to use FQDN
acl domainIsWhitelisted ssl::server_name accounts.google.com

# ----------------------------------------------
# Wildcard
acl domainIsWhitelisted ssl::server_name --client-requested .googleapis.com
acl domainIsWhitelisted ssl::server_name --client-requested
.googleapis.l.google.com
# -------------------------------

# Deny requests to certain unsafe ports
http_access deny !Safe_ports

# Deny CONNECT to other than secure SSL ports
http_access deny CONNECT !SSL_ports

# Only allow cachemgr access from localhost
http_access allow localhost manager
http_access deny manager

# Example rule allowing access from your local networks.
# Adapt localnet in the ACL section to list your (internal) IP networks
# from where browsing should be allowed
http_access allow localnet
http_access allow localhost

# And finally deny all other access to this proxy
http_access deny all

# Passively Intercepted HTTPS Traffic
https_port 9091 cert=/etc/squid/example.com.cert
key=/etc/squid/example.com.private ssl-bump intercept
acl step1 at_step SslBump1
ssl_bump peek all
ssl_bump splice domainIsWhitelisted
ssl_bump terminate all

# Leave coredumps in the first cache dir
coredump_dir /var/spool/squid

# Logging
logformat custom1 %tg %6tr %&gt;a %&lt;A %Ss/%03&gt;Hs %&lt;st %rm %ru HTTP/%rv
SSL: %ssl::&gt;sni %ssl::bump_mode Client(Subject/Tx/Neg/Sup/Cip):
%ssl::&gt;cert_subject %ssl::&gt;received_hello_version
%ssl::&gt;negotiated_version %ssl::&gt;received_supported_version
%ssl::&gt;negotiated_cipher Server(Subject/Rx/Neg/Sup/Cip):
%ssl::&lt;cert_subject %ssl::&lt;received_hello_version
%ssl::&lt;negotiated_version %ssl::&lt;received_supported_version
%ssl::&lt;negotiated_cipher
access_log daemon:/var/log/squid/access_custom1.log custom1

# Listen on port 3128 for HTTP Connet method - unused and firewalled off.
http_port 3128
# End of File

Kind regards
Jared

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="020673.html">[squid-users] Help with transparent whitelisting proxy on Squid 4.4
</A></li>
	<LI>Next message (by thread): <A HREF="020677.html">[squid-users] Help with transparent whitelisting proxy on Squid 4.4
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20676">[ date ]</a>
              <a href="thread.html#20676">[ thread ]</a>
              <a href="subject.html#20676">[ subject ]</a>
              <a href="author.html#20676">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
