<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Help with transparent whitelisting proxy on Squid 4.4
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Help%20with%20transparent%20whitelisting%20proxy%20on%20Squid%0A%204.4&In-Reply-To=%3C7c67e5a8-a92e-46eb-556c-3eff73f4e114%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="020676.html">
   <LINK REL="Next"  HREF="020670.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Help with transparent whitelisting proxy on Squid 4.4</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Help%20with%20transparent%20whitelisting%20proxy%20on%20Squid%0A%204.4&In-Reply-To=%3C7c67e5a8-a92e-46eb-556c-3eff73f4e114%40treenet.co.nz%3E"
       TITLE="[squid-users] Help with transparent whitelisting proxy on Squid 4.4">squid3 at treenet.co.nz
       </A><BR>
    <I>Thu Jun 27 10:31:53 UTC 2019</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="020676.html">[squid-users] Help with transparent whitelisting proxy on Squid	4.4
</A></li>
        <LI>Next message (by thread): <A HREF="020670.html">[squid-users] squid basic
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20677">[ date ]</a>
              <a href="thread.html#20677">[ thread ]</a>
              <a href="subject.html#20677">[ subject ]</a>
              <a href="author.html#20677">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 27/06/19 11:39 am, Jared Fox wrote:
&gt;<i> Hi Amos
</I>&gt;<i> 
</I>&gt;<i> So i have tried the following based on your suggestions, but it is
</I>&gt;<i> still failing and have errors below:
</I>&gt;<i> 
</I>&gt;<i> 1. Switched to a wildcard whitelist instead of single domain
</I>&gt;<i> 2. Updated the logformat to provide more information, see below:
</I>&gt;<i> 3. Add in `--client-requested`, but this made no difference.
</I>&gt;<i>    3a. Add to single ACL, acl domainIsWhitelisted ssl::server_name
</I>&gt;<i> --client-requested cloudtrace.googleapis.com
</I>&gt;<i>    3b. Commented out single record, switched to wildcard
</I>&gt;<i>    3c. Add to wildcard
</I>&gt;<i> 
</I>&gt;<i> Error messages and Logs:
</I>&gt;<i> 
</I>&gt;<i> Access Log:     26/Jun/2019:23:18:38     96 REDACTED 216.58.200.106
</I>&gt;<i> NONE/200 0 CONNECT 216.58.200.106:443 HTTP/1.1 SSL:
</I>&gt;<i> cloudtrace.googleapis.com peek Client(Subject/Tx/Neg/Sup/Cip): -
</I>&gt;<i> TLS/1.0 - TLS/1.2 - Server(Subject/Rx/Neg/Sup/Cip): - TLS/1.2 -
</I>&gt;<i> TLS/1.2 -
</I>&gt;<i> 
</I>&gt;<i> Cache Log:     2019/06/26 23:18:38 kid1| ERROR: negotiating TLS on FD
</I>&gt;<i> 11: error:140920F8:SSL routines:ssl3_get_server_hello:unknown cipher
</I>&gt;<i> returned (1/-1/0)
</I>&gt;<i> 
</I>
This means the OpenSSL library being used by Squid does not contain any
support for the cipher(s) the server chose to use for this transaction.

They only way I am aware of to avoid it is to upgrade the OpenSSL
library Squid is built against.


&gt;<i> Can you please explain what you mean? What should this changed to so
</I>&gt;<i> that it does work.
</I>&gt;<i> 
</I>&gt;&gt;<i> Please be aware that in your config the ssl::server_name ACL is *not* matching the SNI in your config.
</I>&gt;&gt;<i> - Your ssl_bump rules say &quot;peek all&quot; - so peek happens on the two Hello
</I>&gt;&gt;<i> messages. When the serverHello has been peek'd the real server name is
</I>&gt;&gt;<i> available from the servers own certificate.
</I>&gt;<i> 
</I>
To quote the ssl::server_name documentation:

&quot;
# The ACL computes server name(s) using such information sources as
# CONNECT request URI, TLS client SNI, and TLS server certificate
# subject (CN and SubjectAltName). The computed server name(s) usually
# change with each SslBump step, as more info becomes available:
# * SNI is used as the server name instead of the request URI,
# * subject name(s) from the server certificate (CN and
#   SubjectAltName) are used as the server names instead of SNI.
&quot;

That last bullet point is what is/was happening with your original proxy
config.

The &quot;--client-requested&quot; flag overrides that and causes the SNI to be
used in the match even when server cert is known.


&gt;<i> Updated Squid.conf.
</I>&gt;<i> 
</I>&gt;<i> # ===========================
</I>&gt;<i> # Squid 4.7 Config - Work in Progress
</I>&gt;<i> # ===========================
</I>&gt;<i> 
</I>&gt;<i> acl localnet src 10.0.0.0/8                 # Kubernetes VPC CIDR range
</I>&gt;<i> acl SSL_ports port 443                      # HTTPS
</I>&gt;<i> acl Safe_ports port 80                       # HTTP
</I>&gt;<i> acl Safe_ports port 443                     # HTTPS
</I>&gt;<i> acl CONNECT method CONNECT   # Traffic restriction
</I>&gt;<i> acl step1 at_step SslBump1              # Needed by ssl-bump
</I>&gt;<i> 
</I>&gt;<i> # -------------------------------
</I>&gt;<i> # Whitelist the following Domains
</I>&gt;<i> # -------------------------------
</I>&gt;<i> # FQDN - Try to use FQDN
</I>&gt;<i> acl domainIsWhitelisted ssl::server_name accounts.google.com
</I>&gt;<i> 
</I>&gt;<i> # ----------------------------------------------
</I>&gt;<i> # Wildcard
</I>&gt;<i> acl domainIsWhitelisted ssl::server_name --client-requested .googleapis.com
</I>&gt;<i> acl domainIsWhitelisted ssl::server_name --client-requested
</I>&gt;<i> .googleapis.l.google.com
</I>&gt;<i> # -------------------------------
</I>&gt;<i> 
</I>&gt;<i> # Deny requests to certain unsafe ports
</I>&gt;<i> http_access deny !Safe_ports
</I>&gt;<i> 
</I>&gt;<i> # Deny CONNECT to other than secure SSL ports
</I>&gt;<i> http_access deny CONNECT !SSL_ports
</I>&gt;<i> 
</I>&gt;<i> # Only allow cachemgr access from localhost
</I>&gt;<i> http_access allow localhost manager
</I>&gt;<i> http_access deny manager
</I>&gt;<i> 
</I>&gt;<i> # Example rule allowing access from your local networks.
</I>&gt;<i> # Adapt localnet in the ACL section to list your (internal) IP networks
</I>&gt;<i> # from where browsing should be allowed
</I>&gt;<i> http_access allow localnet
</I>&gt;<i> http_access allow localhost
</I>&gt;<i> 
</I>&gt;<i> # And finally deny all other access to this proxy
</I>&gt;<i> http_access deny all
</I>&gt;<i> 
</I>&gt;<i> # Passively Intercepted HTTPS Traffic
</I>&gt;<i> https_port 9091 cert=/etc/squid/example.com.cert
</I>&gt;<i> key=/etc/squid/example.com.private ssl-bump intercept
</I>&gt;<i> acl step1 at_step SslBump1
</I>&gt;<i> ssl_bump peek all
</I>&gt;<i> ssl_bump splice domainIsWhitelisted
</I>&gt;<i> ssl_bump terminate all
</I>&gt;<i> 
</I>&gt;<i> # Leave coredumps in the first cache dir
</I>&gt;<i> coredump_dir /var/spool/squid
</I>&gt;<i> 
</I>&gt;<i> # Logging
</I>&gt;<i> logformat custom1 %tg %6tr %&gt;a %&lt;A %Ss/%03&gt;Hs %&lt;st %rm %ru HTTP/%rv
</I>&gt;<i> SSL: %ssl::&gt;sni %ssl::bump_mode Client(Subject/Tx/Neg/Sup/Cip):
</I>&gt;<i> %ssl::&gt;cert_subject %ssl::&gt;received_hello_version
</I>&gt;<i> %ssl::&gt;negotiated_version %ssl::&gt;received_supported_version
</I>&gt;<i> %ssl::&gt;negotiated_cipher Server(Subject/Rx/Neg/Sup/Cip):
</I>&gt;<i> %ssl::&lt;cert_subject %ssl::&lt;received_hello_version
</I>&gt;<i> %ssl::&lt;negotiated_version %ssl::&lt;received_supported_version
</I>&gt;<i> %ssl::&lt;negotiated_cipher
</I>&gt;<i> access_log daemon:/var/log/squid/access_custom1.log custom1
</I>&gt;<i> 
</I>&gt;<i> # Listen on port 3128 for HTTP Connet method - unused and firewalled off.
</I>&gt;<i> http_port 3128
</I>

NP: this is not about CONNECT method. It is about serving up error
pages, FTP listings, and all the icons/scripts/stylesheets etc embedded
in those.

Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="020676.html">[squid-users] Help with transparent whitelisting proxy on Squid	4.4
</A></li>
	<LI>Next message (by thread): <A HREF="020670.html">[squid-users] squid basic
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20677">[ date ]</a>
              <a href="thread.html#20677">[ thread ]</a>
              <a href="subject.html#20677">[ subject ]</a>
              <a href="author.html#20677">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
