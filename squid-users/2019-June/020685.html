<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] SQUID_ERR_SSL_HANDSHAKE
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20SQUID_ERR_SSL_HANDSHAKE&In-Reply-To=%3C94206d52-19b2-f616-623b-1b4ba9af917a%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="020684.html">
   <LINK REL="Next"  HREF="020686.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] SQUID_ERR_SSL_HANDSHAKE</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20SQUID_ERR_SSL_HANDSHAKE&In-Reply-To=%3C94206d52-19b2-f616-623b-1b4ba9af917a%40treenet.co.nz%3E"
       TITLE="[squid-users] SQUID_ERR_SSL_HANDSHAKE">squid3 at treenet.co.nz
       </A><BR>
    <I>Sat Jun 29 12:13:39 UTC 2019</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="020684.html">[squid-users] SQUID_ERR_SSL_HANDSHAKE
</A></li>
        <LI>Next message (by thread): <A HREF="020686.html">[squid-users] SQUID_ERR_SSL_HANDSHAKE
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20685">[ date ]</a>
              <a href="thread.html#20685">[ thread ]</a>
              <a href="subject.html#20685">[ subject ]</a>
              <a href="author.html#20685">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 29/06/19 10:34 pm, Walter H. wrote:
&gt;<i> On 29.06.2019 10:17, Amos Jeffries wrote:
</I>&gt;&gt;<i> On 29/06/19 3:03 am, Walter H. wrote:
</I>&gt;&gt;&gt;<i> sslproxy_cipher
</I>&gt;&gt;&gt;<i> EECDH+ECDSA+AESGCM:EECDH+aRSA+AESGCM:EECDH+ECDSA:EECDH:EDH+AESGCM:EDH:ECDH+AESGCM:ECDH+AES:ECDH:AES:HIGH:MEDIUM:!SSLv2:+SSLv3:!3DES:!RC4:!MD5:!IDEA:!SEED:!aNULL:!eNULL:!LOW:!EXP:!DSS:!PSK:!RSA:!SRP
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> sslproxy_options NO_SSLv2 NO_SSLv3 TLSv1 TLSv1_1 TLSv1_2
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i> I do not see the tls-dh setting necessary for the elliptic curves to
</I>&gt;&gt;<i> work in your displayed config.
</I>&gt;<i> do you mean the dhparams= at the http_port here?
</I>
Sorry, I got that wrong. There is no params for Squid-&gt;server
connections. The flags on sslproxy_options you found for the next part
below were what you need.

&gt;<i> 
</I>&gt;<i> http_port 3128 ssl-bump generate-host-certificates=on
</I>&gt;<i> dynamic_cert_mem_cache_size=16MB cert=/etc/squid/cert/squidCA.pem
</I>&gt;<i> options=NO_SSLv2,NO_SSLv3,SINGLE_DH_USE,SINGLE_ECDH_USE
</I>&gt;<i> dhparams=/etc/squid/cert/dhparam.pem
</I>&gt;<i> 
</I>&gt;&gt;<i> &#160; So that would make the above cipher
</I>&gt;&gt;<i> directive essentially disable everything except SSLv3 with MEDIUM/HIGH
</I>&gt;&gt;<i> level non-RSA ciphers.
</I>&gt;<i> even with this:
</I>&gt;<i> 
</I>&gt;<i> sslproxy_options NO_SSLv2,NO_SSLv3,SINGLE_DH_USE,SINGLE_ECDH_USE
</I>&gt;<i> and the sslproxy_cipher commented out,
</I>&gt;<i> 
</I>&gt;<i> this site doesn't work;
</I>&gt;<i> 
</I>&gt;<i> sslcrtvalidator_program cache=8192 ttl=240
</I>&gt;<i> /usr/lib64/squid/ssl_crtvalid/main.sh
</I>&gt;<i> sslcrtvalidator_children 12 startup=5 idle=1 concurrency=1
</I>&gt;<i> 
</I>&gt;<i> this validator isn't called at all with the site&#160; <A HREF="https://www.3bg.at">https://www.3bg.at</A>
</I>&gt;<i> e.g. with&#160; <A HREF="https://wiki.squid-cache.org&#160;&#160;">https://wiki.squid-cache.org&#160;&#160;</A> this validator-script is
</I>&gt;<i> caled, and
</I>&gt;<i> there is the following traced
</I>&gt;<i> 
</I>&gt;<i> 0 cert_validate 5324 host=wiki.squid-cache.org
</I>&gt;<i> proto_version=TLSv1.2
</I>&gt;<i> cipher=ECDHE-RSA-AES256-GCM-SHA384
</I>&gt;<i> ...
</I>&gt;<i> 
</I>
That is a good sign. That exact combo is in the set supported by the
breaking server so it is unlikely your Squid or its OpenSSL is
contributing to this particular problem.


&gt;<i> 
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The value of sslproxy_options directive is colon (:) or comma (,)
</I>&gt;&gt;<i> delimited. When multiple values like the above are configured only the
</I>&gt;&gt;<i> first in the list is used. Which forces only TLS/1.2
</I>&gt;<i> I changed this to
</I>&gt;<i> 
</I>&gt;<i> sslproxy_options NO_SSLv2,NO_SSLv3,SINGLE_DH_USE,SINGLE_ECDH_USE
</I>&gt;<i> 
</I>&gt;&gt;<i> It is not clear what OpenSSL will do when those conflicting options are
</I>&gt;&gt;<i> handed to it. But it looks like it is down-grading to SSLv3 as L.P.H.
</I>&gt;&gt;<i> said then breaking when something else arrives back.
</I>&gt;<i> quite strange only a few sites don't work, <A HREF="https://www.3bg.at">https://www.3bg.at</A> is an
</I>&gt;<i> example of such;
</I>&gt;<i> many others work as expected;
</I>&gt;<i> 
</I>
That is a bit odd. Though looking at the SSL Labs report for this
www.3bg.at site their restricting to only TLS/1.2 and there are many
clients for which the encryption handshake does not work.

&lt;<A HREF="https://www.ssllabs.com/ssltest/analyze.html?d=www.3bg.at">https://www.ssllabs.com/ssltest/analyze.html?d=www.3bg.at</A>&gt; look to the
list of failures under &quot;Handshake Simulation&quot; and the whole list of &quot;Not
simulated clients&quot; for comparison with UA of any of your clients having
trouble connecting there.


Squid SSL-Bump is limited to negotiating use of TLS versions and
features which are supported by both itself and the client when offering
things to the server. So the problem of some clients agents not
supporting TLS/1.2 or the ciphers the server wants to use can make the
site fail even if your Squid outbound settings support them.


PS. At the technical level that exact error from OpenSSL means that some
data arrived from the server at a time when only TLS alert messages were
supposed to be happening.  I suspect it could be a sign that the
Internet between your proxy and that server is being MITM'd by an agent
that corrupts the protocol for some reason. eg someone elses proxy
rejecting the connection but getting its error response syntax wrong.


Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="020684.html">[squid-users] SQUID_ERR_SSL_HANDSHAKE
</A></li>
	<LI>Next message (by thread): <A HREF="020686.html">[squid-users] SQUID_ERR_SSL_HANDSHAKE
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20685">[ date ]</a>
              <a href="thread.html#20685">[ thread ]</a>
              <a href="subject.html#20685">[ subject ]</a>
              <a href="author.html#20685">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
