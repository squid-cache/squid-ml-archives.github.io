<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] squid in container aborted on low memory server
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid%20in%20container%20aborted%20on%20low%20memory%20server&In-Reply-To=%3Cf620fd2a-e132-76f9-ea46-e2353c9d077e%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="020307.html">
   <LINK REL="Next"  HREF="020337.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] squid in container aborted on low memory server</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid%20in%20container%20aborted%20on%20low%20memory%20server&In-Reply-To=%3Cf620fd2a-e132-76f9-ea46-e2353c9d077e%40treenet.co.nz%3E"
       TITLE="[squid-users] squid in container aborted on low memory server">squid3 at treenet.co.nz
       </A><BR>
    <I>Tue Mar  5 08:13:36 UTC 2019</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="020307.html">[squid-users] squid in container aborted on low memory server
</A></li>
        <LI>Next message (by thread): <A HREF="020337.html">[squid-users] squid in container aborted on low memory server
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20324">[ date ]</a>
              <a href="thread.html#20324">[ thread ]</a>
              <a href="subject.html#20324">[ subject ]</a>
              <a href="author.html#20324">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 4/03/19 9:45 pm, George Xie wrote:
&gt;<i>     &gt; On 4/03/19 5:39 pm, George Xie wrote:
</I>&gt;<i>     &gt; &gt; hi all:
</I>&gt;<i>     &gt; &gt;
</I>&gt;<i>     &gt; &gt; Squid version: 3.5.23-5+deb9u1
</I>&gt;<i>     &gt; &gt; Docker version 18.09.3, build 774a1f4
</I>&gt;<i>     &gt; &gt; Linux instance-4 4.9.0-8-amd64 #1 SMP Debian 4.9.130-2 (2018-10-27)
</I>&gt;<i>     &gt; &gt; x86_64 GNU/Linux
</I>&gt;<i>     &gt; &gt;
</I>&gt;<i>     &gt; &gt; I have the following squid config:
</I>&gt;<i>     &gt; &gt;
</I>&gt;<i>     &gt; &gt;
</I>&gt;<i>     &gt; &gt; &#160; &#160; http_port 127.0.0.1:3128 &lt;<A HREF="http://127.0.0.1:3128">http://127.0.0.1:3128</A>&gt;
</I>&gt;<i>     &gt; &gt; &#160; &#160; cache deny all
</I>&gt;<i>     &gt; &gt; &#160; &#160; access_log none
</I>&gt;<i>     &gt; &gt;
</I>&gt;<i>     &gt; What is it exactly that you think this is doing in regards to Squid
</I>&gt;<i>     &gt; memory needs?
</I>&gt;<i>     &gt;
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> sorry, I don't get your quest.
</I>&gt;<i> &#160;
</I>
I was asking to see what you were thinking was going on with those settings.

As Alex already pointed out the &quot;cache deny all&quot; does not reduce memory
needs of Squid in any way. It just makes 256MB of that RAM become
pointless allocating.

So, if you actually do not want the proxy caching anything, then
disabling the cache_mem (set it to 0 as per Alex response) would be the
best choice of action before you go any further.

Or if you *do* want caching, and were trying to disable it for testing
the memory issue. Then your test was wrong, and produces incorrect
conclusion. Just reducing cache_mem would be best for this case - set it
to a value that should reasonably fit this container and see if the
proxy runs okay.


...
&gt;<i>     &gt; &gt;
</I>&gt;<i>     &gt; &gt; it appears that squid (or glibc) tries to allocate 392m memory,
</I>&gt;<i>     which is
</I>&gt;<i>     &gt; &gt; larger than host free memory 370m.
</I>&gt;<i>     &gt; &gt; but I guess squid don't need that much memory, I have another
</I>&gt;<i>     running
</I>&gt;<i>     &gt; &gt; squid instance, which only uses &lt; 200m memory.
</I>&gt;<i>     &gt; No doubt it is configured to use less memory. For example by reducing
</I>&gt;<i>     &gt; the default memory cache size.
</I>&gt;<i>     &gt;
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> that running squid instance has the same config.
</I>&gt;<i> &#160;
</I>
Then something odd is going on between the two. They should indeed have
had the same behaviour (either work or same error).

Whatever the issue is it is being triggered by the large blocks of RAM
allocated by a default Squid. The easiest to modify is the cache_mem.


&gt;<i> 
</I>&gt;<i>     &gt; &gt; the oddest thing is if I run squid on the host (also Debian 9)
</I>&gt;<i>     directly,
</I>&gt;<i>     &gt; &gt; not in the container, squid could start and run as normal.
</I>&gt;<i>     &gt; &gt;
</I>&gt;<i>     &gt; Linux typically allows RAM over-allocation. Which works okay so
</I>&gt;<i>     long as
</I>&gt;<i>     &gt; there is sufficient swap space and there is time between memory
</I>&gt;<i>     usage to
</I>&gt;<i>     &gt; do the swap in/out process.
</I>&gt;<i>     &gt; Amos
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> swap is disabled in the host server, so do in the container.&#160;
</I>&gt;<i> 
</I>&gt;<i> after all, I wonder why squid would try to claim&#160;392m memory if don't
</I>&gt;<i> need that much.
</I>&gt;<i> 
</I>
Squid thinks it does. All client traffic is denied being cached by that
&quot;deny all&quot;. BUT ... there are internally generated items which also use
cache. So there is 256MB default RAM cache allocated and only those few
small things being put in it.

You could set it to '0' or to some small value and the allocation size
should go down accordingly.


That said, every bit of client traffic headed towards the proxy uses
memory of volatile amount and at peak times it may need to allocate
large blocks.

So disabling swap entirely on the server is not a great idea. It just
moves the error and shutdown to happen at peak traffic times when it is
least wanted.


Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="020307.html">[squid-users] squid in container aborted on low memory server
</A></li>
	<LI>Next message (by thread): <A HREF="020337.html">[squid-users] squid in container aborted on low memory server
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20324">[ date ]</a>
              <a href="thread.html#20324">[ thread ]</a>
              <a href="subject.html#20324">[ subject ]</a>
              <a href="author.html#20324">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
