<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid and url modifying
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20and%20url%20modifying&In-Reply-To=%3Cb64b57df-5f0a-a25c-4a6e-d44b94fc491d%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="020333.html">
   <LINK REL="Next"  HREF="020336.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid and url modifying</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20and%20url%20modifying&In-Reply-To=%3Cb64b57df-5f0a-a25c-4a6e-d44b94fc491d%40measurement-factory.com%3E"
       TITLE="[squid-users] Squid and url modifying">rousskov at measurement-factory.com
       </A><BR>
    <I>Tue Mar  5 17:48:52 UTC 2019</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="020333.html">[squid-users] Squid and url modifying
</A></li>
        <LI>Next message (by thread): <A HREF="020336.html">[squid-users] Squid and url modifying
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20334">[ date ]</a>
              <a href="thread.html#20334">[ thread ]</a>
              <a href="subject.html#20334">[ subject ]</a>
              <a href="author.html#20334">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 3/5/19 9:59 AM, Egoitz Aurrekoetxea wrote:

&gt;<i> El 2019-03-05 17:45, Alex Rousskov escribi&#243;:
</I>&gt;&gt;<i> On 3/5/19 1:57 AM, Egoitz Aurrekoetxea wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> I have Squid configured with the virus scanning software using ICAP and
</I>&gt;&gt;&gt;<i> working. But, when I do :
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> acl matchear_todo url_regex [-i] ^.*$
</I>
&gt;&gt;<i> FYI: &quot;[-i]&quot; is documentation syntax that means an optional flag called
</I>&gt;&gt;<i> &quot;-i&quot;. If you want to use that &quot;-i&quot; flag, then type
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &#160;&#160;acl matchear_todo url_regex -i ^.*$
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> ... but keep in mind that &quot;-i&quot; makes no sense when you regular
</I>&gt;&gt;<i> expression does not contain small or capital characters. Adding &quot;-i&quot;
</I>&gt;&gt;<i> would not change what URLs such a regular expression would match.
</I> &#160;
&gt;<i> I see... I though it was for matching case insensitively...
</I>
You thought correctly. The -i flag enables case insensitive matches
indeed, but you are specifying that flag incorrectly (extra square
brackets), and it makes no sense to specify it at all for your specific
regular expression!


&gt;&gt;&gt;<i> http_reply_access deny matchear_todo
</I>&gt;&gt;&gt;<i> deny_info&#160;&#160; <A HREF="http://172.16.8.61/redirigir.php?url=%s">http://172.16.8.61/redirigir.php?url=%s</A> matchear_todo
</I>
&gt;&gt;<i> Why are you blocking based on URL instead of blocking based on the ICAP
</I>&gt;&gt;<i> scan result? In your earlier specifications, you wanted to
</I>&gt;&gt;<i> block/redirect only those transactions that were certified virus-free by
</I>&gt;&gt;<i> your ICAP client. The above matchear_todo ACL does not do that.
</I> &#160;
&gt;&gt;<i> *That was an attempt of achieving my goal. Redirect requests to a php
</I>&gt;&gt;<i> which does the request to a &quot;next Squid&quot; and then return one thing or
</I>&gt;&gt;<i> another....*
</I>
Sounds like you are asking about one thing and then testing/discussing
another. Doing so makes helping you more difficult. Focus on making the
simplest use case working first.


&gt;&gt;<i> Is it possible to be done from Squid side?
</I>
Probably (as long as your ICAP service can signal clean/dirty status in
a way Squid ACLs can detect). Since you appear to change the
problem/goal, I am not sure what the answer to this question is.


&gt;<i> Or does the own ICAP implementation directly return a 3xx answer?
</I>
That works as well. In that case, you do not need deny_info tricks.

&gt;&gt;<i> Your ACL says nothing about &quot;clean&quot;. It says &quot;always&quot;. How does your
</I>&gt;&gt;<i> ICAP service mark &quot;clean&quot; (or &quot;dirty&quot;) HTTP responses? Your ACL needs to
</I>&gt;&gt;<i> match that marking (or the absence of that marking).
</I> &#160;
&gt;<i> Could you give me a clue of how could I do it?
</I>
I cannot because I do not know what your ICAP service is capable of (and
do not have the time to research that). For example, if your ICAP
service can add an HTTP header to dirty HTTP responses, then you can use
the corresponding Squid ACL to detect the presence of that header in the
adapted response.

Alex.
 &#160;

&gt;&gt;&gt;<i> El 2019-03-05 08:13, Alex Rousskov escribi&#243;:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> On 3/4/19 11:20 AM, Egoitz Aurrekoetxea wrote:
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> Clients, will ask :
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> <A HREF="https://oooeeee.eeee.ttt.thesquidserver.org/">https://oooeeee.eeee.ttt.thesquidserver.org/</A>
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> So the answer [to the second question] I assume should be yes.
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> If I am interpreting your answers correctly, then your setup looks like
</I>&gt;&gt;&gt;&gt;<i> a reverse proxy to me. In that case, you do not need SslBump and
</I>&gt;&gt;&gt;&gt;<i> interception. You do need an web server certificate for the
</I>&gt;&gt;&gt;&gt;<i> oooeeee.eeee.ttt.thesquidserver.org domain, issued by a well-trusted CA.
</I>&gt;&gt;&gt;&gt;<i> Do you already have that?
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> I have DNAT rules, for being able to
</I>&gt;&gt;&gt;&gt;&gt;<i> redirect tcp/80 and tcp/443 to squid's port silently.
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> Please note that your current Squid configuration is not a reverse proxy
</I>&gt;&gt;&gt;&gt;<i> configuration. It is an interception configuration. It also lacks
</I>&gt;&gt;&gt;&gt;<i> https_port for handling port 443 traffic. There are probably some
</I>&gt;&gt;&gt;&gt;<i> documents on Squid wiki (and/or elsewhere) explaining how to configure
</I>&gt;&gt;&gt;&gt;<i> Squid to become a reverse proxy. Follow them.
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> I wanted to setup a proxy machine which I wanted to be able to receive
</I>&gt;&gt;&gt;&gt;&gt;<i> url like :
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> - www.iou.net.theproxy.com/hj.php?ui=9
</I>&gt;&gt;&gt;&gt;&gt;<i> &lt;<A HREF="http://www.iou.net.theproxy.com/hj.php?ui=9">http://www.iou.net.theproxy.com/hj.php?ui=9</A>&gt;
</I>&gt;&gt;&gt;&gt;&gt;<i> &lt;<A HREF="http://www.iou.net.theproxy.com/hj.php?ui=9">http://www.iou.net.theproxy.com/hj.php?ui=9</A>&gt;
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> If this site returns clean content (scanned by Icap server) the url
</I>&gt;&gt;&gt;&gt;&gt;<i> redirector should return :
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> - www.iou.net/hj.php?ui=9 &lt;<A HREF="http://www.iou.net/hj.php?ui=9">http://www.iou.net/hj.php?ui=9</A>&gt;
</I>&gt;&gt;&gt;&gt;&gt;<i> &lt;<A HREF="http://www.iou.net/hj.php?ui=9">http://www.iou.net/hj.php?ui=9</A>&gt;
</I>&gt;&gt;&gt;&gt;&gt;<i> &lt;<A HREF="http://www.iou.net/hj.php?ui=9">http://www.iou.net/hj.php?ui=9</A>&gt; (the real
</I>&gt;&gt;&gt;&gt;&gt;<i> url) as URL.
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> OK.
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> - Is it possible with Squid to achieve my goal?. With Squid, a
</I>&gt;&gt;&gt;&gt;&gt;<i> redirector, and a Icap daemon which performs virus scanning...
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> A redirector seems out of scope here -- it works on requests while you
</I>&gt;&gt;&gt;&gt;<i> want to rewrite (scanned by ICAP) responses.
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> It is probably possible to use deny_info to respond with a redirect
</I>&gt;&gt;&gt;&gt;<i> message. To trigger a deny_info action, you would have to configure your
</I>&gt;&gt;&gt;&gt;<i> Squid to block virus-free responses, which is rather strange!
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> - For plain http the config and the URL seem to be working BUT the
</I>&gt;&gt;&gt;&gt;&gt;<i> virus
</I>&gt;&gt;&gt;&gt;&gt;<i> are not being scanned. Could the config be adjusted for that?.
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> I would start by removing the redirector, &quot;intercept&quot;, SslBump, and
</I>&gt;&gt;&gt;&gt;<i> disabling ICAP. Configure your Squid as a reverse proxy without any
</I>&gt;&gt;&gt;&gt;<i> virus scanning. Then add ICAP. Get the virus scanning working without
</I>&gt;&gt;&gt;&gt;<i> any URL manipulation. Once that is done, you can adjust Squid to block
</I>&gt;&gt;&gt;&gt;<i> virus-free responses (via http_reply_access) and trigger a deny_info
</I>&gt;&gt;&gt;&gt;<i> response containing an HTTP redirect.
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> Please note that once the browser gets a redirect to another site, that
</I>&gt;&gt;&gt;&gt;<i> browser is not going to revisit your reverse proxy for any content
</I>&gt;&gt;&gt;&gt;<i> related to that other site -- all requests for that other site will go
</I>&gt;&gt;&gt;&gt;<i> from the browser to that other site. Your proxy will not be in the loop
</I>&gt;&gt;&gt;&gt;<i> anymore. If that is not what you want, then you cannot use redirects at
</I>&gt;&gt;&gt;&gt;<i> all -- you would have to accelerate that other site for all requests
</I>&gt;&gt;&gt;&gt;<i> instead and make sure that other site does not contain absolute URLs
</I>&gt;&gt;&gt;&gt;<i> pointing the browser away from your reverse proxy.
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> Disclaimer: I have not tested the above ideas and, again, I may be
</I>&gt;&gt;&gt;&gt;<i> misinterpreting what you really want to achieve.
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> Alex.
</I>&gt;&gt;&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;&gt;&gt;<i> squid-users mailing list
</I>&gt;&gt;&gt;&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;&gt;&gt;&gt;<i> &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>&gt;
</I>&gt;&gt;&gt;&gt;<i> &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;&gt;&gt;&gt;<i> &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>&gt;&gt;
</I>&gt;&gt;&gt;&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;&gt;<i> squid-users mailing list
</I>&gt;&gt;&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;&gt;&gt;<i> &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>&gt;
</I>&gt;&gt;&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;<i> squid-users mailing list
</I>&gt;&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;&gt;<i> &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>&gt;
</I>&gt;&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="020333.html">[squid-users] Squid and url modifying
</A></li>
	<LI>Next message (by thread): <A HREF="020336.html">[squid-users] Squid and url modifying
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20334">[ date ]</a>
              <a href="thread.html#20334">[ thread ]</a>
              <a href="subject.html#20334">[ subject ]</a>
              <a href="author.html#20334">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
