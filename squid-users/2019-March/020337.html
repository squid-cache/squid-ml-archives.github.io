<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] squid in container aborted on low memory server
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid%20in%20container%20aborted%20on%20low%20memory%20server&In-Reply-To=%3CCAHsiY%3DcK%3DwvfukGug_z%2BE08ThPJHngy%3DDbuKeETZopKFDtOJdg%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="020324.html">
   <LINK REL="Next"  HREF="020338.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] squid in container aborted on low memory server</H1>
    <B>George Xie</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid%20in%20container%20aborted%20on%20low%20memory%20server&In-Reply-To=%3CCAHsiY%3DcK%3DwvfukGug_z%2BE08ThPJHngy%3DDbuKeETZopKFDtOJdg%40mail.gmail.com%3E"
       TITLE="[squid-users] squid in container aborted on low memory server">georgexsh at gmail.com
       </A><BR>
    <I>Wed Mar  6 18:25:21 UTC 2019</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="020324.html">[squid-users] squid in container aborted on low memory server
</A></li>
        <LI>Next message (by thread): <A HREF="020338.html">[squid-users] squid in container aborted on low memory server
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20337">[ date ]</a>
              <a href="thread.html#20337">[ thread ]</a>
              <a href="subject.html#20337">[ subject ]</a>
              <a href="author.html#20337">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>thanks for your detailed reply, Amos.

now I have found out the culprit is large file descriptor number limit.
Docker CE for Debian package has set this limit (RLIMIT_NOFILE) in the
container to 1048576, thus squid set Squid_MaxFD to 1048576, then
allocates 1048576*392 = 392m memory for `fd_table`.
in the host, RLIMIT_NOFILE is only 1024.

&gt;<i> So, if you actually do not want the proxy caching anything, then
</I>&gt;<i> disabling the cache_mem (set it to 0 as per Alex response) would be the
</I>&gt;<i> best choice of action before you go any further.
</I>
in fact, I have tried this option before but failed.
it is very nice to learn this advice, I will add it to my proxy only
squid config.

&gt;<i> So disabling swap entirely on the server is not a great idea. It just
</I>&gt;<i> moves the error and shutdown to happen at peak traffic times when it is
</I>&gt;<i> least wanted.
</I>
but I guess this is common in the &quot;cloud&quot; era, eg: Google Compute Engine.


Xie Shi
On Tue, Mar 5, 2019 at 4:13 PM Amos Jeffries &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt; wrote:
&gt;<i>
</I>&gt;<i> On 4/03/19 9:45 pm, George Xie wrote:
</I>&gt;<i> &gt;     &gt; On 4/03/19 5:39 pm, George Xie wrote:
</I>&gt;<i> &gt;     &gt; &gt; hi all:
</I>&gt;<i> &gt;     &gt; &gt;
</I>&gt;<i> &gt;     &gt; &gt; Squid version: 3.5.23-5+deb9u1
</I>&gt;<i> &gt;     &gt; &gt; Docker version 18.09.3, build 774a1f4
</I>&gt;<i> &gt;     &gt; &gt; Linux instance-4 4.9.0-8-amd64 #1 SMP Debian 4.9.130-2 (2018-10-27)
</I>&gt;<i> &gt;     &gt; &gt; x86_64 GNU/Linux
</I>&gt;<i> &gt;     &gt; &gt;
</I>&gt;<i> &gt;     &gt; &gt; I have the following squid config:
</I>&gt;<i> &gt;     &gt; &gt;
</I>&gt;<i> &gt;     &gt; &gt;
</I>&gt;<i> &gt;     &gt; &gt;     http_port 127.0.0.1:3128 &lt;<A HREF="http://127.0.0.1:3128">http://127.0.0.1:3128</A>&gt;
</I>&gt;<i> &gt;     &gt; &gt;     cache deny all
</I>&gt;<i> &gt;     &gt; &gt;     access_log none
</I>&gt;<i> &gt;     &gt; &gt;
</I>&gt;<i> &gt;     &gt; What is it exactly that you think this is doing in regards to Squid
</I>&gt;<i> &gt;     &gt; memory needs?
</I>&gt;<i> &gt;     &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; sorry, I don't get your quest.
</I>&gt;<i> &gt;
</I>&gt;<i>
</I>&gt;<i> I was asking to see what you were thinking was going on with those settings.
</I>&gt;<i>
</I>&gt;<i> As Alex already pointed out the &quot;cache deny all&quot; does not reduce memory
</I>&gt;<i> needs of Squid in any way. It just makes 256MB of that RAM become
</I>&gt;<i> pointless allocating.
</I>&gt;<i>
</I>&gt;<i> So, if you actually do not want the proxy caching anything, then
</I>&gt;<i> disabling the cache_mem (set it to 0 as per Alex response) would be the
</I>&gt;<i> best choice of action before you go any further.
</I>&gt;<i>
</I>&gt;<i> Or if you *do* want caching, and were trying to disable it for testing
</I>&gt;<i> the memory issue. Then your test was wrong, and produces incorrect
</I>&gt;<i> conclusion. Just reducing cache_mem would be best for this case - set it
</I>&gt;<i> to a value that should reasonably fit this container and see if the
</I>&gt;<i> proxy runs okay.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> ...
</I>&gt;<i> &gt;     &gt; &gt;
</I>&gt;<i> &gt;     &gt; &gt; it appears that squid (or glibc) tries to allocate 392m memory,
</I>&gt;<i> &gt;     which is
</I>&gt;<i> &gt;     &gt; &gt; larger than host free memory 370m.
</I>&gt;<i> &gt;     &gt; &gt; but I guess squid don't need that much memory, I have another
</I>&gt;<i> &gt;     running
</I>&gt;<i> &gt;     &gt; &gt; squid instance, which only uses &lt; 200m memory.
</I>&gt;<i> &gt;     &gt; No doubt it is configured to use less memory. For example by reducing
</I>&gt;<i> &gt;     &gt; the default memory cache size.
</I>&gt;<i> &gt;     &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; that running squid instance has the same config.
</I>&gt;<i> &gt;
</I>&gt;<i>
</I>&gt;<i> Then something odd is going on between the two. They should indeed have
</I>&gt;<i> had the same behaviour (either work or same error).
</I>&gt;<i>
</I>&gt;<i> Whatever the issue is it is being triggered by the large blocks of RAM
</I>&gt;<i> allocated by a default Squid. The easiest to modify is the cache_mem.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     &gt; &gt; the oddest thing is if I run squid on the host (also Debian 9)
</I>&gt;<i> &gt;     directly,
</I>&gt;<i> &gt;     &gt; &gt; not in the container, squid could start and run as normal.
</I>&gt;<i> &gt;     &gt; &gt;
</I>&gt;<i> &gt;     &gt; Linux typically allows RAM over-allocation. Which works okay so
</I>&gt;<i> &gt;     long as
</I>&gt;<i> &gt;     &gt; there is sufficient swap space and there is time between memory
</I>&gt;<i> &gt;     usage to
</I>&gt;<i> &gt;     &gt; do the swap in/out process.
</I>&gt;<i> &gt;     &gt; Amos
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; swap is disabled in the host server, so do in the container.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; after all, I wonder why squid would try to claim 392m memory if don't
</I>&gt;<i> &gt; need that much.
</I>&gt;<i> &gt;
</I>&gt;<i>
</I>&gt;<i> Squid thinks it does. All client traffic is denied being cached by that
</I>&gt;<i> &quot;deny all&quot;. BUT ... there are internally generated items which also use
</I>&gt;<i> cache. So there is 256MB default RAM cache allocated and only those few
</I>&gt;<i> small things being put in it.
</I>&gt;<i>
</I>&gt;<i> You could set it to '0' or to some small value and the allocation size
</I>&gt;<i> should go down accordingly.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> That said, every bit of client traffic headed towards the proxy uses
</I>&gt;<i> memory of volatile amount and at peak times it may need to allocate
</I>&gt;<i> large blocks.
</I>&gt;<i>
</I>&gt;<i> So disabling swap entirely on the server is not a great idea. It just
</I>&gt;<i> moves the error and shutdown to happen at peak traffic times when it is
</I>&gt;<i> least wanted.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Amos
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="020324.html">[squid-users] squid in container aborted on low memory server
</A></li>
	<LI>Next message (by thread): <A HREF="020338.html">[squid-users] squid in container aborted on low memory server
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20337">[ date ]</a>
              <a href="thread.html#20337">[ thread ]</a>
              <a href="subject.html#20337">[ subject ]</a>
              <a href="author.html#20337">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
