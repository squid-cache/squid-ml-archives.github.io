<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid 4.6 Transparent HTTP &amp; HTTPS Proxy
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%204.6%20Transparent%20HTTP%20%26%20HTTPS%20Proxy&In-Reply-To=%3Ca949d229-40ae-c97b-9c81-7fb30883285f%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="020345.html">
   <LINK REL="Next"  HREF="020347.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid 4.6 Transparent HTTP &amp; HTTPS Proxy</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%204.6%20Transparent%20HTTP%20%26%20HTTPS%20Proxy&In-Reply-To=%3Ca949d229-40ae-c97b-9c81-7fb30883285f%40treenet.co.nz%3E"
       TITLE="[squid-users] Squid 4.6 Transparent HTTP &amp; HTTPS Proxy">squid3 at treenet.co.nz
       </A><BR>
    <I>Thu Mar  7 13:34:14 UTC 2019</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="020345.html">[squid-users] Squid 4.6 Transparent HTTP &amp; HTTPS Proxy
</A></li>
        <LI>Next message (by thread): <A HREF="020347.html">[squid-users] Squid 4.6 Transparent HTTP &amp; HTTPS Proxy
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20346">[ date ]</a>
              <a href="thread.html#20346">[ thread ]</a>
              <a href="subject.html#20346">[ subject ]</a>
              <a href="author.html#20346">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 8/03/19 1:35 am, dkanejs wrote:
&gt;<i> Thanks for the reply and apologies my post didn't include the HTML fragments:
</I>&gt;<i> 
</I>&gt;<i> Configuration:
</I>&gt;<i> 
</I>&gt;<i> ./configure \
</I>&gt;<i>     --enable-ssl \
</I>&gt;<i>     --enable-ssl-crtd \
</I>&gt;<i>     --with-openssl \
</I>&gt;<i>     --disable-arch-native \
</I>&gt;<i>     --prefix=/usr \
</I>&gt;<i>     --localstatedir=/var \
</I>&gt;<i>     --sysconfdir=/etc/squid \
</I>&gt;<i>     --libexecdir=/usr/lib/squid \
</I>&gt;<i>     --datadir=/usr/share/squid \
</I>&gt;<i>     --with-default-user=proxy \
</I>&gt;<i>     --with-logdir=/var/log/squid \
</I>&gt;<i>     --with-pidfile=/var/run/squid.pid
</I>&gt;<i> 
</I>&gt;<i> Squid configuration:
</I>&gt;<i> 
</I>&gt;<i> visible_hostname squid
</I>&gt;<i> http_port 3128
</I>&gt;<i> acl whitelist dstdomain .example.com
</I>&gt;<i> http_access allow whitelist
</I>
You are missing the default security protections against DoS and some
other attack types. Please leave those Safe_ports and SSL_ports access
lines and place your custom rules after them.


&gt;<i> https_port 3129 cert=/etc/squid/squid.pem
</I>&gt;<i> options=NO_SSLv2,NO_SSLv3,NO_TLSv1,NO_TLSv1_1,NO_TICKET 
</I>&gt;<i> cipher=HIGH:MEDIUM:!RC4:!aNULL:!eNULL:!LOW:!3DES:!MD5:!EXP:!PSK:!SRP:!DSS
</I>&gt;<i> ssl-bump intercept
</I>
The NAT 'intercept' mode flag needs to be second, right after the port
number.

The 'ssl-bump' flag should go before the cert= option so the right types
of cert are loaded. Without this ordering Squid-4 cannot warn you about
cert type errors (if any).

The &quot;NO_SSLv2&quot; is invalid. As of Squid-4 all options relating to SSLv2
are no longer supported in any way.


&gt;<i> acl SSL_port port 443
</I>&gt;<i> http_access allow SSL_port
</I>&gt;<i> acl CONNECT method CONNECT
</I>
&quot;CONNECT&quot; ACL is now a built-in. You do not have to define it.

&gt;<i> acl step1 at_step SslBump1
</I>&gt;<i> acl step2 at_step SslBump2
</I>&gt;<i> acl step3 at_step SslBump3
</I>&gt;<i> ssl_bump peek step1 all
</I>&gt;<i> ssl_bump peek step2 whitelist
</I>&gt;<i> ssl_bump splice step3 whitelist
</I>&gt;<i> ssl_bump terminate step2 all
</I>
The use of &quot;all&quot; ACL in the above lines does nothing but confuse people.

Please also be aware the 'whitelist' ACL will not match reliably in TLS
handshake because TLS does not have HTTP message URLs - thus no URL
domain name.

That means you should expect to see only terminated TLS handshakes with
this config. Anything actually being accepted and responded to would be
the anomaly.

I think what you are needing is probably this:

 ssl_bump peek all
 acl tls_whitelist ssl::server_name .example.com
 ssl_bump splice step3 tls_whitelist
 ssl_bump terminate all



Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="020345.html">[squid-users] Squid 4.6 Transparent HTTP &amp; HTTPS Proxy
</A></li>
	<LI>Next message (by thread): <A HREF="020347.html">[squid-users] Squid 4.6 Transparent HTTP &amp; HTTPS Proxy
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20346">[ date ]</a>
              <a href="thread.html#20346">[ thread ]</a>
              <a href="subject.html#20346">[ subject ]</a>
              <a href="author.html#20346">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
