<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] icap not answering
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20icap%20not%20answering&In-Reply-To=%3C6495d662-c132-dd07-8859-01defae41691%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="020350.html">
   <LINK REL="Next"  HREF="020303.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] icap not answering</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20icap%20not%20answering&In-Reply-To=%3C6495d662-c132-dd07-8859-01defae41691%40treenet.co.nz%3E"
       TITLE="[squid-users] icap not answering">squid3 at treenet.co.nz
       </A><BR>
    <I>Mon Mar 11 10:40:05 UTC 2019</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="020350.html">[squid-users] icap not answering
</A></li>
        <LI>Next message (by thread): <A HREF="020303.html">[squid-users] squid in container aborted on low memory server
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20351">[ date ]</a>
              <a href="thread.html#20351">[ thread ]</a>
              <a href="subject.html#20351">[ subject ]</a>
              <a href="author.html#20351">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 11/03/19 8:26 am, steven wrote:
&gt;<i> 
</I>&gt;<i> On 05.03.19 06:13, Amos Jeffries wrote:
</I>&gt;&gt;<i> On 5/03/19 12:10 pm, steven wrote:
</I>&gt;&gt;&gt;<i> Ah thank you for that clarification, the python icap servers i tested so
</I>&gt;&gt;&gt;<i> far are not very promissing but at least theres a connection now.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> sadly squid does not allow http access at all, only https access.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i> Er, that would be because the only http_port you have is configured with
</I>&gt;&gt;<i> 'accl' - making it a reverse-proxy port. But you do not have any
</I>&gt;&gt;<i> cache_peer configured to handle that type of traffic.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> So, is there any particular reason you have that port receiving 'accel'
</I>&gt;&gt;<i> / reverse-proxy mode traffic?
</I>&gt;&gt;<i>  If not remove that mode flag and things should all work for HTTP too.
</I>&gt;&gt;<i>
</I>&gt;<i> 
</I>&gt;<i> removed the accel mode but still no luck with http, when opening the adress:
</I>&gt;<i> 
</I>&gt;<i> <A HREF="http://squid-web-proxy-cache.1019090.n4.nabble.com/http-port-with-quot-transparent-quot-or-quot-intercept-quot-td4677133.html">http://squid-web-proxy-cache.1019090.n4.nabble.com/http-port-with-quot-transparent-quot-or-quot-intercept-quot-td4677133.html</A>
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> The following error was encountered while trying to retrieve the URL:
</I>&gt;<i> /http-port-with-quot-transparent-quot-or-quot-intercept-quot-td4677133.html
</I>&gt;<i> 
</I>
Ah, that is an origin-form URL.


&gt;<i> 
</I>&gt;<i> in this tutorial:
</I>&gt;<i> 
</I>&gt;<i> <A HREF="https://www.reddit.com/r/sysadmin/comments/a67hly/squid_proxy_a_short_guide_forward_transparent/">https://www.reddit.com/r/sysadmin/comments/a67hly/squid_proxy_a_short_guide_forward_transparent/</A>
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> the guy uses two ports for http like this:
</I>&gt;<i> 
</I>&gt;<i> |http_port 3128 # Listen on this HTTP port, intercepting requests
</I>&gt;<i> http_port 3129 intercept and then with iptables he redirects 80 to port
</I>&gt;<i> 3129 which does not work here :( export
</I>
Which should work fine ... provided the right type of traffic is passed
to each port.


&gt;<i> http_proxy=<A HREF="http://192.168.10.215:3140">http://192.168.10.215:3140</A> &amp;&amp; wget google.de # im using 3140
</I>&gt;<i> as intercept port. config at the end. --2019-03-10 20:20:56--
</I>&gt;<i> <A HREF="http://google.de/">http://google.de/</A> Connecting to 192.168.10.215:3140... connected. Proxy
</I>&gt;<i> request sent, awaiting response... 403 Forbidden 2019-03-10 20:20:56
</I>&gt;<i> ERROR 403: Forbidden. |
</I>&gt;<i> 
</I>
Hmm. You keep mixing port modes and traffic types.


Port 3128, 80 and 443 all have different traffic syntax and handling
requirements. The mode flags tell Squid which syntax is expected and
valid arriving at that port. Default mode is forward/explicit-proxy so
there is no flag for that mode/syntax.


Ports with 'intercept' flags must *only* have traffic passed to them
from the OS NAT subsystem.

Clients should be connecting directly to the domain origin on port 80.
Do not configure them with any details about the proxy. Eg passing the
http_proxy environment variable is configuring wget to use an
explicit-proxy port.

Your wget test should be using port 3128 in that http_proxy= setting. Or
not using that setting at all for tests of the port 80 and port 443
traffic (which should be getting intercepted by NAT).


&gt;<i> 
</I>&gt;<i> grep -v '#' squid.conf
</I>&gt;<i> 
</I>...

NP: You are missing the default security rules to protect against DoS
and other nasty attacks.


&gt;<i> http_access allow localnet
</I>&gt;<i> coredump_dir /var/spool/squid
</I>&gt;<i> refresh_pattern ^ftp:&#160;&#160;&#160;&#160;&#160;&#160;&#160; 1440&#160;&#160;&#160; 20%&#160;&#160;&#160; 10080
</I>&gt;<i> refresh_pattern ^gopher:&#160;&#160;&#160; 1440&#160;&#160;&#160; 0%&#160;&#160;&#160; 1440
</I>&gt;<i> refresh_pattern -i (/cgi-bin/|\?) 0&#160;&#160;&#160; 0%&#160;&#160;&#160; 0
</I>&gt;<i> refresh_pattern .&#160;&#160;&#160;&#160;&#160;&#160;&#160; 0&#160;&#160;&#160; 20%&#160;&#160;&#160; 4320
</I>

&gt;<i> http_port 3128
</I>
Above port is for forward-proxy / explicit-proxy traffic. Clients need
to be explicitly configured to send traffic here, or instructed to by
response URLs generated by this proxy.

You do not have 'ssl-bump' so any TLS/SSL/HTTPS traffic from these
clients will go through in CONNECT tunnels without inspection.


&gt;<i> http_port 3140 intercept
</I>
Above port is for NAT intercepted port 80 traffic. Clients are
contacting HTTP origin servers directly.

There is no TLS/SSL/HTTPS traffic on this port. Attempts by the client
to Upgrade to non-HTTP protocols (including HTTPS) will be ignored.


&gt;<i> https_port 3129 ssl-bump intercept generate-host-certificates=on
</I>&gt;<i> dynamic_cert_mem_cache_size=4MB cert=/etc/squid/myCA.pem
</I>

Above port is for NAT intercepted port 443 traffic, with SSL-Bump'ing.
Clients are contacting HTTPS origin servers directly.

There is no plain-text HTTP traffic on this port. Attempts by the client
to Upgrade to non-HTTPS protocols (including HTTP) will be ignored.

on_unsupported_protocol determines what happens to non-TLS traffic
arriving at this port. Internet requirements are that traffic is
rejected, though abuse of port 443 for sneaking other things through
this port is so popular it may not always be possible.



&gt;<i> sslcrtd_program /usr/lib/squid/security_file_certgen -s /var/lib/ssl_db
</I>&gt;<i> -M 4MB
</I>&gt;<i> acl step1 at_step SslBump1
</I>&gt;<i> 
</I>&gt;<i> ssl_bump peek step1
</I>&gt;<i> ssl_bump bump all
</I>&gt;<i> 
</I>
NP: SSL-Bump'ing operations are performed on all traffic without
knowledge of the server X.509 certificate details. This introduces
TLS/SSL errors and several classes of security vulnerability.

Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="020350.html">[squid-users] icap not answering
</A></li>
	<LI>Next message (by thread): <A HREF="020303.html">[squid-users] squid in container aborted on low memory server
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20351">[ date ]</a>
              <a href="thread.html#20351">[ thread ]</a>
              <a href="subject.html#20351">[ subject ]</a>
              <a href="author.html#20351">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
