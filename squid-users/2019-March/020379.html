<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] url_rewrite_program, sslbump and CONNECT = broken redirect page?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20url_rewrite_program%2C%0A%20sslbump%20and%20CONNECT%20%3D%20broken%20redirect%20page%3F&In-Reply-To=%3C631212ab-0323-3146-87b4-4c3a1f055a3b%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="020377.html">
   <LINK REL="Next"  HREF="020381.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] url_rewrite_program, sslbump and CONNECT = broken redirect page?</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20url_rewrite_program%2C%0A%20sslbump%20and%20CONNECT%20%3D%20broken%20redirect%20page%3F&In-Reply-To=%3C631212ab-0323-3146-87b4-4c3a1f055a3b%40treenet.co.nz%3E"
       TITLE="[squid-users] url_rewrite_program, sslbump and CONNECT = broken redirect page?">squid3 at treenet.co.nz
       </A><BR>
    <I>Tue Mar 19 11:25:49 UTC 2019</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="020377.html">[squid-users] url_rewrite_program,	sslbump and CONNECT = broken redirect page?
</A></li>
        <LI>Next message (by thread): <A HREF="020381.html">[squid-users] url_rewrite_program, sslbump and CONNECT = broken redirect page?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20379">[ date ]</a>
              <a href="thread.html#20379">[ thread ]</a>
              <a href="subject.html#20379">[ subject ]</a>
              <a href="author.html#20379">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 19/03/19 10:45 pm, Amish wrote:
&gt;<i> Hello,
</I>&gt;<i> 
</I>&gt;<i> I have perfectly working SSL bump setup (via proxy CONNECT requests)
</I>&gt;<i> except when a site is blocked.
</I>&gt;<i> 
</I>&gt;<i> I have a rewrite program which blocks say foo.com.
</I>&gt;<i> 
</I>
Please remember there is a difference between &quot;rewrite&quot; (what you are
actually doing) and &quot;redirect&quot; (per your subject).

* Redirect is a standardized HTTP mechanism. It works wherever the
client support that basic HTTP mechanism.

* Rewrite is an abuse of the proxy place in the protocol. It more often
causes problems than works.


&gt;<i> Roughly it does this:
</I>&gt;<i> 
</I>&gt;<i> HTTP - non secure
</I>&gt;<i> STDIN: GET <A HREF="http://foo.com">http://foo.com</A>
</I>&gt;<i> STDOUT: rewrite-url=&quot;<A HREF="http://127.0.0.1/blocked">http://127.0.0.1/blocked</A>&quot;
</I>&gt;<i> 
</I>&gt;<i> Above works fine as expected, the page is fetched and shown.
</I>&gt;<i> 
</I>&gt;<i> But now if it is a CONNECT (https) request:
</I>&gt;<i> 
</I>&gt;<i> STDIN: CONNECT foo.com:443
</I>&gt;<i> STDOUT: rewrite-url=&quot;<A HREF="http://127.0.0.1/blocked">http://127.0.0.1/blocked</A>&quot;
</I>&gt;<i> 
</I>&gt;<i> Then instead of fetching the above page it tries to fetch &quot;CONNECT
</I>&gt;<i> http:443&quot; and returns ERR_DNS_FAIL page.
</I>&gt;<i> 
</I>&gt;<i> The problem code begins here: (client_side_request.cc)
</I>&gt;<i> <A HREF="https://github.com/squid-cache/squid/blob/master/src/client_side_request.cc#L1261">https://github.com/squid-cache/squid/blob/master/src/client_side_request.cc#L1261</A>
</I>&gt;<i> 
</I>
No. The problem starts with the helper ignoring the method and original
URI form/structure Squid passed to it.


&gt;<i> 
</I>&gt;<i> which leads to: (AnyP:;Uri parse() function)
</I>&gt;<i> <A HREF="https://github.com/squid-cache/squid/blob/master/src/anyp/Uri.cc#L211">https://github.com/squid-cache/squid/blob/master/src/anyp/Uri.cc#L211</A>
</I>&gt;<i> 
</I>&gt;<i> which treats CONNECT request differently then what is documented.
</I>&gt;<i> 
</I>
The authoritative documentation is the code comment starting at that
files #L212, and the RFC it references. Other documentation which does
not align is outdated and/or incorrect.


Specifically be aware that URI and URL are different things. Your helper
is responsible for delivering whichever URI syntax is valid as
request-target for the message being re-written. Squid passes the method
name to the helper for exactly this case.


&gt;<i> It finds domain as something colon number. And looks like ignores
</I>&gt;<i> urlpath completely.
</I>
authority-form URI have no such thing as a path. They are a hostname (or
raw-IP) a colon, and a port number. Any remainder is garbage.


&gt;<i> 
</I>&gt;<i> So in my case it becomes http:443.
</I>&gt;<i> 
</I>&gt;<i> And hence redirection breaks.
</I>
Redirection would not work regardless of what Squid does with your
helpers output. The client is sending native TLS on the connection - the
redirected-to URL is HTML or something like it.

At best you can hope for is the client to spontaneously abort with a TCP
RST.

At worst the client can enter an infinite series of attempts to
re-connect ... until your proxy machine consumes all available TCP ports
and *all* TCP traffic through the machine halts - even traffic by other
software or the OS itself.


&gt;<i> 
</I>&gt;<i> How do I convert CONNECT requests over ssl bump to GET
</I>&gt;<i> <A HREF="http://127.0.0.1/blocked">http://127.0.0.1/blocked</A>
</I>&gt;<i> 
</I>
You cannot deliver protocol X to a client which is expecting
incompatible protocol Y and have anything good happen.

In this case probably delivering HTML text (or similar) to a client
expecting a TLS serverHello message.


&gt;<i> This exact issue was reported earlier too in 2015 but the person who
</I>&gt;<i> reported it probably couldn't locate the exact reason and bug went
</I>&gt;<i> unnoticed.
</I>
It was not unnoticed. Has been reported many times over the years. The
bug is in the helper.


You should fix the helper (if possible) to cope with CONNECT and other
unusual types of URI input it may receive. There may be protocols other
than &quot;<A HREF="http://">http://</A>&quot;, path-only URLs, URN, or even just an asterisk ('*') on
some methods.
 &lt;<A HREF="https://tools.ietf.org/html/rfc7230#section-5.3">https://tools.ietf.org/html/rfc7230#section-5.3</A>&gt;
 &lt;<A HREF="https://tools.ietf.org/html/rfc3986">https://tools.ietf.org/html/rfc3986</A>&gt;

To re-write the helper output must not only be a valid URI, but also
compatible with the operations the original URI was going to perform.


If that is not possible, you can workaround this particular case by
adding this to your squid.conf to skip processing of the CONNECT
messages entirely:

 url_rewrite_access deny CONNECT


Cheers,
Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="020377.html">[squid-users] url_rewrite_program,	sslbump and CONNECT = broken redirect page?
</A></li>
	<LI>Next message (by thread): <A HREF="020381.html">[squid-users] url_rewrite_program, sslbump and CONNECT = broken redirect page?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20379">[ date ]</a>
              <a href="thread.html#20379">[ thread ]</a>
              <a href="subject.html#20379">[ subject ]</a>
              <a href="author.html#20379">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
