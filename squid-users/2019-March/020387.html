<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Non-transparent proxy with cache_peer and ssl_bump
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Non-transparent%20proxy%20with%20cache_peer%20and%20ssl_bump&In-Reply-To=%3C527c1b32-fd70-ca91-ead9-f9c085390e2a%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="020385.html">
   <LINK REL="Next"  HREF="020390.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Non-transparent proxy with cache_peer and ssl_bump</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Non-transparent%20proxy%20with%20cache_peer%20and%20ssl_bump&In-Reply-To=%3C527c1b32-fd70-ca91-ead9-f9c085390e2a%40measurement-factory.com%3E"
       TITLE="[squid-users] Non-transparent proxy with cache_peer and ssl_bump">rousskov at measurement-factory.com
       </A><BR>
    <I>Wed Mar 20 21:58:17 UTC 2019</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="020385.html">[squid-users] Non-transparent proxy with cache_peer and ssl_bump
</A></li>
        <LI>Next message (by thread): <A HREF="020390.html">[squid-users] Non-transparent proxy with cache_peer and ssl_bump
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20387">[ date ]</a>
              <a href="thread.html#20387">[ thread ]</a>
              <a href="subject.html#20387">[ subject ]</a>
              <a href="author.html#20387">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 3/20/19 3:23 PM, Yosi Greenfield wrote:

&gt;<i> ssl_bump splice step3 NoBump
</I>&gt;<i> ssl_bump bump step3
</I>
&gt;<i> cache_peer proxy2.ourserver.com ... ssl
</I>
Forwarding most SslBump-related connections to cache_peers is still
unsupported by official Squids, including Squid v3 and v4. Measurement
Factory code that implements this feature is being officially reviewed
at <A HREF="https://github.com/squid-cache/squid/pull/380/">https://github.com/squid-cache/squid/pull/380/</A>

If you can test the above-referenced code, please do.

However, even if the above-referenced changes are officially accepted
(into v5), they will not allow you to do &quot;TLS inside TLS&quot; -- you will
not be able to forward most SslBump-related connections to HTTPS proxies
(i.e. your &quot;cache_peer ssl&quot;).

Fortunately, forwarding to HTTPS proxies is not critical in most use
cases -- one layer of TLS encryption is often enough. Unfortunately, you
will expose CONNECT requests between Squid1 and Squid2 until we add that
support or perhaps [controversially] allow bumped traffic to be sent to
HTTPS proxies without additional encryption. I am not aware of anybody
working on either right now.


&gt;<i> 1. Does squid 3.5 even allow sending https between peers? 
</I>
Squid allows sending plain HTTP traffic to an HTTPS peer. That is not
what you are configuring your squid1 to do though: You are telling
squid1 to send bumped HTTPS traffic to an HTTPS peer. The latter is not
supported.


&gt;<i> 2. What file goes into the cache_peer directive sslcert?
</I>
Let's assume that the TCP connection between squid1 and squid2 is
encrypted with TLS (i.e., your configuration with &quot;cache_peer ssl&quot;). TLS
supports certificate-based client authentication: A TLS client (i.e.,
squid1 in your case) sends its SSL certificate to the TLS server (i.e.,
squid2 in your case). The TLS server (i.e. squid2) validates that
certificate against some mutually trusted CA and allows (or denies) the
connection.

&quot;cache_peer sslcert&quot; names the file containing the (client) SSL
certificate that squid1 sends and squid2 expects/validates.


&gt;<i> I'm using the same
</I>&gt;<i> PEM file for cahe_peer on Squid1 and http_port on Squid2. Is that a mistake?
</I>
It is a mistake in most (possibly all) use cases. The former is a
(client) SSL certificate that squid1 sends and squid2 validates. The
latter is an SSL CA certificate to generate fake (server) SSL
certificates. Squid2 sends those generated certificates. A bumping
Squid1 validates them.


HTH,

Alex.

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="020385.html">[squid-users] Non-transparent proxy with cache_peer and ssl_bump
</A></li>
	<LI>Next message (by thread): <A HREF="020390.html">[squid-users] Non-transparent proxy with cache_peer and ssl_bump
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20387">[ date ]</a>
              <a href="thread.html#20387">[ thread ]</a>
              <a href="subject.html#20387">[ subject ]</a>
              <a href="author.html#20387">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
