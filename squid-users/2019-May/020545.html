<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Secure ICAP
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Secure%20ICAP&In-Reply-To=%3CCAFUC1xe7b0kQs%2BUVic1s1H9iib5edD%3Dm-%3DpnAquKOR-gPq4qQA%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="020544.html">
   <LINK REL="Next"  HREF="020546.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Secure ICAP</H1>
    <B>TRAN DAC</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Secure%20ICAP&In-Reply-To=%3CCAFUC1xe7b0kQs%2BUVic1s1H9iib5edD%3Dm-%3DpnAquKOR-gPq4qQA%40mail.gmail.com%3E"
       TITLE="[squid-users] Secure ICAP">dacvinh0993 at gmail.com
       </A><BR>
    <I>Mon May  6 16:19:09 UTC 2019</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="020544.html">[squid-users] security_file_certgen problem
</A></li>
        <LI>Next message (by thread): <A HREF="020546.html">[squid-users] Secure ICAP
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20545">[ date ]</a>
              <a href="thread.html#20545">[ thread ]</a>
              <a href="subject.html#20545">[ subject ]</a>
              <a href="author.html#20545">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello,

I am trying to secure ICAP connections between my Squid proxy and my ICAP
Server. On my ICAP Server, i use stunnel with this configuration file (with
self signed certificate):

*cert = crt.pem*
*key= key.pem*
*CAfile=crt.pem*

*[icaps]*

*accept = 10.2.2.236:11344 &lt;<A HREF="http://10.2.2.236:11344/">http://10.2.2.236:11344/</A>&gt;*
*connect = 10.2.2.236:1344 &lt;<A HREF="http://10.2.2.236:1344/">http://10.2.2.236:1344/</A>&gt;*


squid.conf file on the proxy Squid:

*icap_enable on*
*icap_send_client_ip on*
*icap_service service_req reqmod_precache <A HREF="icaps://10.2.2.236:11344/request">icaps://10.2.2.236:11344/request</A>
&lt;<A HREF="http://10.2.2.236:11344/request">http://10.2.2.236:11344/request</A>&gt; tls-cafile=crt.pem*
*adaptation_access service_req allow all*

*//to decrypt ssl traffic*
*http_port 3128 ssl-bump cert=/usr/local/squid/etc/ssl_cert/myCA.pem
generate-host-certificates=on
dynamic_cert_mem_cache_size=4MBsslcrtd_program
/usr/local/squid/libexec/security_file_certgen -s
/usr/local/squid/var/logs/ssl_db -M 4MBssl_bump bump allssl_bump peek step1*

However i have still these errors:

 *WARNING: Squid got an invalid ICAP OPTIONS response from service
<A HREF="icaps://10.2.2.236:11344/request">icaps://10.2.2.236:11344/request</A> &lt;<A HREF="http://10.2.2.236:11344/request">http://10.2.2.236:11344/request</A>&gt;; error:
unsupported status code of OPTIONS response*
*2019/05/06 17:50:27 kid1| essential ICAP service is down after an options
fetch failure: <A HREF="icaps://10.2.2.236:11344/request">icaps://10.2.2.236:11344/request</A>
&lt;<A HREF="http://10.2.2.236:11344/request">http://10.2.2.236:11344/request</A>&gt; [down,!valid]*
*2019/05/06 17:53:28 kid1| WARNING: Squid got an invalid ICAP OPTIONS
response from service <A HREF="icaps://10.2.2.236:11344/request">icaps://10.2.2.236:11344/request</A>
&lt;<A HREF="http://10.2.2.236:11344/request">http://10.2.2.236:11344/request</A>&gt;; error: unsupported status code of
OPTIONS response*
*2019/05/06 17:56:28 kid1| WARNING: Squid got an invalid ICAP OPTIONS
response from service <A HREF="icaps://10.2.2.236:11344/request">icaps://10.2.2.236:11344/request</A>
&lt;<A HREF="http://10.2.2.236:11344/request">http://10.2.2.236:11344/request</A>&gt;; error: unsupported status code of
OPTIONS response*

And from the ICAP server stunnel logs the ssl initiation worked fine but it
can't connect to the port1344I ensure that non secure ICAP works perfectly
and my iptables rules are fine.

Thanks in advance for your help.

Kind regards,
Tran Dac.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20190506/df005f10/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20190506/df005f10/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="020544.html">[squid-users] security_file_certgen problem
</A></li>
	<LI>Next message (by thread): <A HREF="020546.html">[squid-users] Secure ICAP
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20545">[ date ]</a>
              <a href="thread.html#20545">[ thread ]</a>
              <a href="subject.html#20545">[ subject ]</a>
              <a href="author.html#20545">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
