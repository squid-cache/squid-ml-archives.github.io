<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] ephemeral port selection
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20ephemeral%20port%20selection&In-Reply-To=%3CCAPxJK5CbBchR1awUioXJq7wUxeCOk63h_wrh4-7AVyEs7KKcvg%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="020546.html">
   <LINK REL="Next"  HREF="020548.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] ephemeral port selection</H1>
    <B>Marc</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20ephemeral%20port%20selection&In-Reply-To=%3CCAPxJK5CbBchR1awUioXJq7wUxeCOk63h_wrh4-7AVyEs7KKcvg%40mail.gmail.com%3E"
       TITLE="[squid-users] ephemeral port selection">gaardiolor at gmail.com
       </A><BR>
    <I>Tue May  7 15:37:18 UTC 2019</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="020546.html">[squid-users] Secure ICAP
</A></li>
        <LI>Next message (by thread): <A HREF="020548.html">[squid-users] ephemeral port selection
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20547">[ date ]</a>
              <a href="thread.html#20547">[ thread ]</a>
              <a href="subject.html#20547">[ subject ]</a>
              <a href="author.html#20547">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Dear all,

We're considering running squid for thousands of users. Squid will use
a single parent proxy IP address. A lot of connections will go from
the Child squid to the Parent proxy. Often, the Parent proxy initiates
closing the TCP connecting by sending the first FIN. This results the
connection going to TIME_WAIT at the Parent proxy, but not at the
Child squid proxy, as per RFC. This means, from the perspective of the
Child squid proxy, it's perfectly legal to re-use the same sourceport
immediately. Or, at least, before the TIME_WAIT of the Parent Proxy
(and the Firewalls in between) expires.

This will result in timeouts / slowness. Not very often, since we can
configure an ephemeral port range 1025-65535 = 64511 available ports,
but it does happen occasionaly considering the large amount of
connections we have from the Child squid proxy to the Parent proxy.

This is not a theoretical exercise, we have seen this in the past.
Currently, using other proxy servers, we overcome this issue by
disabling TCP Ephemeral Port Randomization. This mitigates this issue
entirely, since not all 64511 ports are used within the TIME_WAIT
timeout. Security impact is low since it's local traffic.

I think squid relies on the OS to select the ephemeral source port,
and in linux I can see no way to disable this. Is it possible to
disable ephemeral port randomization within squid ? If it is
impossible, can this be considered as a new feature ?

Thanks!

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="020546.html">[squid-users] Secure ICAP
</A></li>
	<LI>Next message (by thread): <A HREF="020548.html">[squid-users] ephemeral port selection
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20547">[ date ]</a>
              <a href="thread.html#20547">[ thread ]</a>
              <a href="subject.html#20547">[ subject ]</a>
              <a href="author.html#20547">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
