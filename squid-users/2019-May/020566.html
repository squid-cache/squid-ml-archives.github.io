<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid V 3.5.23 authenticating in AD: User names not	showing in log
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20V%203.5.23%20authenticating%20in%20AD%3A%20User%20names%20not%0A%09showing%20in%20log&In-Reply-To=%3C1557942322957-0.post%40n4.nabble.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="020573.html">
   <LINK REL="Next"  HREF="020567.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid V 3.5.23 authenticating in AD: User names not	showing in log</H1>
    <B>Rafael Silva Daniel</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20V%203.5.23%20authenticating%20in%20AD%3A%20User%20names%20not%0A%09showing%20in%20log&In-Reply-To=%3C1557942322957-0.post%40n4.nabble.com%3E"
       TITLE="[squid-users] Squid V 3.5.23 authenticating in AD: User names not	showing in log">rafaelsilvadaniel at gmail.com
       </A><BR>
    <I>Wed May 15 17:45:22 UTC 2019</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="020573.html">[squid-users] help with reverse proxy sending user to peer
</A></li>
        <LI>Next message (by thread): <A HREF="020567.html">[squid-users] Squid V 3.5.23 authenticating in AD: User names not showing in log
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20566">[ date ]</a>
              <a href="thread.html#20566">[ thread ]</a>
              <a href="subject.html#20566">[ subject ]</a>
              <a href="author.html#20566">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Helo! im in need of serious help, in my company we need the access logs by
user name, is the only reason the proxy is setted to authenticate. but it
just dont show it, the relevant parts of the .conf is looking like this:

(...)
auth_param ntlm program /usr/bin/ntlm_auth --diagnostics
--helper-protocol=squid-2.5-ntlmssp --domain=XXXXX(domain name)
auth_param ntlm children 100
auth_param ntlm keep_alive off

external_acl_type NT_global_group %LOGIN /usr/lib/squid/ext_wbinfo_group_acl
acl users external NT_global_group &quot;/etc/squid/fapgrp&quot;
(...)

(...)
http_access deny !users
http_access allow users
http_access deny !auth
(...)

***(&quot;/etc/squid/fapgrp&quot; is a text file with the text &quot;Usu&#225;rios do d&#243;minio&quot;,
its &quot;Domain Users&quot; in portuguese)

when i test the helper:

/usr/bin/ntlm_auth --diagnostics --helper-protocol=squid-2.5-ntlmssp
--domain=XXXXX
user password
BH SPNEGO request invalid prefix

i read somewhere that ntlmssp can be tested like this, because we are
sending the credentials as plain text, so i tested with basic and the result
is this:

/usr/bin/ntlm_auth --diagnostics --helper-protocol=squid-2.5-basic
--domain=XXXXX
user password
OK
user password
ERR

so, im assuming that the way squid is processing the challenges are fine, is
it right?

but the part that is making me furious is that the access.log are like this:

1557939698.081    218 10.85.xx.xx TCP_MISS/200 1962 GET
<A HREF="http://squid-web-proxy-cache.1019090.n4.nabble.com/util/minmax.js">http://squid-web-proxy-cache.1019090.n4.nabble.com/util/minmax.js</A> *USERNAME*
HIER_DIRECT/199.38.86.66 application/x-javascript
1557939698.313    231 10.85.xx.xx TCP_MISS/200 1073 GET
<A HREF="http://squid-web-proxy-cache.1019090.n4.nabble.com/images/image.png">http://squid-web-proxy-cache.1019090.n4.nabble.com/images/image.png</A>
*USERNAME* HIER_DIRECT/199.38.86.66 image/png
1557939698.360    263 10.85.xx.xx TCP_MISS/200 738 GET
<A HREF="http://squid-web-proxy-cache.1019090.n4.nabble.com/images/bold.png">http://squid-web-proxy-cache.1019090.n4.nabble.com/images/bold.png</A>
*USERNAME* HIER_DIRECT/199.38.86.66 image/png

when the id is TCP_MISS the user name always shows correctly, but when the
id is:

1557941156.213 240238 10.85.XX.XX TCP_TUNNEL/200 1788 CONNECT
www.google.com:443 - HIER_DIRECT/172.217.29.228 -
1557941156.670 240355 10.85.XX.XX TCP_TUNNEL/200 2892 CONNECT
s2.googleusercontent.com:443 - HIER_DIRECT/172.217.172.129 -
1557941159.712 243740 10.85.XX.XX TCP_TUNNEL/200 132341 CONNECT
www.google.com:443 - HIER_DIRECT/172.217.29.228 -

TCP_TUNNEL the user name is never showed, and the majority of the access log
have these TCP_TUNNEL stuff


theres a way to all the pages that are accessed shows the username? its our
only need, to see the user names in all the logs

Thanks in advance!



--
Sent from: <A HREF="http://squid-web-proxy-cache.1019090.n4.nabble.com/Squid-Users-f1019091.html">http://squid-web-proxy-cache.1019090.n4.nabble.com/Squid-Users-f1019091.html</A>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="020573.html">[squid-users] help with reverse proxy sending user to peer
</A></li>
	<LI>Next message (by thread): <A HREF="020567.html">[squid-users] Squid V 3.5.23 authenticating in AD: User names not showing in log
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20566">[ date ]</a>
              <a href="thread.html#20566">[ thread ]</a>
              <a href="subject.html#20566">[ subject ]</a>
              <a href="author.html#20566">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
