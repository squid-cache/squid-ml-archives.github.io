<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid V 3.5.23 authenticating in AD: User names not showing in log
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20V%203.5.23%20authenticating%20in%20AD%3A%20User%20names%0A%20not%20showing%20in%20log&In-Reply-To=%3Cfe75573b-7e4b-70ed-50a4-8030522786f7%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="020566.html">
   <LINK REL="Next"  HREF="020568.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid V 3.5.23 authenticating in AD: User names not showing in log</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20V%203.5.23%20authenticating%20in%20AD%3A%20User%20names%0A%20not%20showing%20in%20log&In-Reply-To=%3Cfe75573b-7e4b-70ed-50a4-8030522786f7%40treenet.co.nz%3E"
       TITLE="[squid-users] Squid V 3.5.23 authenticating in AD: User names not showing in log">squid3 at treenet.co.nz
       </A><BR>
    <I>Thu May 16 09:13:14 UTC 2019</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="020566.html">[squid-users] Squid V 3.5.23 authenticating in AD: User names not	showing in log
</A></li>
        <LI>Next message (by thread): <A HREF="020568.html">[squid-users] Squid V 3.5.23 authenticating in AD: User names not showing in log
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20567">[ date ]</a>
              <a href="thread.html#20567">[ thread ]</a>
              <a href="subject.html#20567">[ subject ]</a>
              <a href="author.html#20567">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 16/05/19 5:45 am, Rafael Silva Daniel wrote:
&gt;<i> Helo! im in need of serious help, in my company we need the access logs by
</I>&gt;<i> user name, is the only reason the proxy is setted to authenticate. but it
</I>&gt;<i> just dont show it, the relevant parts of the .conf is looking like this:
</I>&gt;<i> 
</I>&gt;<i> (...)
</I>&gt;<i> auth_param ntlm program /usr/bin/ntlm_auth --diagnostics
</I>&gt;<i> --helper-protocol=squid-2.5-ntlmssp --domain=XXXXX(domain name)
</I>&gt;<i> auth_param ntlm children 100
</I>&gt;<i> auth_param ntlm keep_alive off
</I>&gt;<i> 
</I>&gt;<i> external_acl_type NT_global_group %LOGIN /usr/lib/squid/ext_wbinfo_group_acl
</I>&gt;<i> acl users external NT_global_group &quot;/etc/squid/fapgrp&quot;
</I>&gt;<i> (...)
</I>&gt;<i> 
</I>&gt;<i> (...)
</I>&gt;<i> http_access deny !users
</I>&gt;<i> http_access allow users
</I>&gt;<i> http_access deny !auth
</I>&gt;<i> (...)
</I>&gt;<i> 
</I>
There is no natural reason why those CONNECT should be exempt from
authenticating.

I usually find situations like what you describe happen where someone
has misunderstood the default security rules and &quot;customized&quot; them a
bit. They are finely tuned rules, so vast changes to proxy behaviour
(like complete bypass of auth) can result if updates to them are not
done correctly.

Can you please show more of your http_access rules? all of them would be
best. At minimum all of the ones above that &quot;http_access deny !auth&quot;
line, and the definition lines for any ACLs used in those rules (include
that &quot;auth&quot; ACL definition too please).



&gt;<i> ***(&quot;/etc/squid/fapgrp&quot; is a text file with the text &quot;Usu&#225;rios do d&#243;minio&quot;,
</I>&gt;<i> its &quot;Domain Users&quot; in portuguese)
</I>&gt;<i> 
</I>&gt;<i> when i test the helper:
</I>&gt;<i> 
</I>&gt;<i> /usr/bin/ntlm_auth --diagnostics --helper-protocol=squid-2.5-ntlmssp
</I>&gt;<i> --domain=XXXXX
</I>&gt;<i> user password
</I>&gt;<i> BH SPNEGO request invalid prefix
</I>&gt;<i> 
</I>&gt;<i> i read somewhere that ntlmssp can be tested like this, because we are
</I>&gt;<i> sending the credentials as plain text, so i tested with basic and the result
</I>&gt;<i> is this:
</I>&gt;<i> 
</I>&gt;<i> /usr/bin/ntlm_auth --diagnostics --helper-protocol=squid-2.5-basic
</I>&gt;<i> --domain=XXXXX
</I>&gt;<i> user password
</I>&gt;<i> OK
</I>&gt;<i> user password
</I>&gt;<i> ERR
</I>&gt;<i> 
</I>&gt;<i> so, im assuming that the way squid is processing the challenges are fine, is
</I>&gt;<i> it right?
</I>
That is a test that the helper is talking to the AD service okay. It
cannot tell you whether the client and Squid are communicating the NTLM
credentials.


The NTLM protocol does not deliver passwords across the network. NTLM
uses (weak) encrypted tokens instead. All Squid does is pass the token
as-is to the helper. The helper then informs Squid what username to log
for that token (if any).
 So to test that part you need to locate a valid token and pass that to
the helper instead of username/password.

However, before you go to any trouble over that. I do not think the
helper or auth are the problem here. Something is clearly letting the
CONNECT happen without even going near the auth process.


Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="020566.html">[squid-users] Squid V 3.5.23 authenticating in AD: User names not	showing in log
</A></li>
	<LI>Next message (by thread): <A HREF="020568.html">[squid-users] Squid V 3.5.23 authenticating in AD: User names not showing in log
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20567">[ date ]</a>
              <a href="thread.html#20567">[ thread ]</a>
              <a href="subject.html#20567">[ subject ]</a>
              <a href="author.html#20567">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
