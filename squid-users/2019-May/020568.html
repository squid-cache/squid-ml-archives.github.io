<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid V 3.5.23 authenticating in AD: User names not showing in log
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20V%203.5.23%20authenticating%20in%20AD%3A%20User%20names%0A%20not%20showing%20in%20log&In-Reply-To=%3Cvmime.5cdd31f4.5261.29dda5ac16a7bf34%40ms249-lin-003.rotterdam.bazuin.nl%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="020567.html">
   <LINK REL="Next"  HREF="020571.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid V 3.5.23 authenticating in AD: User names not showing in log</H1>
    <B>L.P.H. van Belle</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20V%203.5.23%20authenticating%20in%20AD%3A%20User%20names%0A%20not%20showing%20in%20log&In-Reply-To=%3Cvmime.5cdd31f4.5261.29dda5ac16a7bf34%40ms249-lin-003.rotterdam.bazuin.nl%3E"
       TITLE="[squid-users] Squid V 3.5.23 authenticating in AD: User names not showing in log">belle at bazuin.nl
       </A><BR>
    <I>Thu May 16 09:48:36 UTC 2019</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="020567.html">[squid-users] Squid V 3.5.23 authenticating in AD: User names not showing in log
</A></li>
        <LI>Next message (by thread): <A HREF="020571.html">[squid-users] Squid V 3.5.23 authenticating in AD: User names not showing in log
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20568">[ date ]</a>
              <a href="thread.html#20568">[ thread ]</a>
              <a href="subject.html#20568">[ subject ]</a>
              <a href="author.html#20568">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>This is related to samba and MS disabling NTLM (smb1)
What is the samba version in question and the running OS? 

But first thing you can try is set in smb.conf 

ntlm auth = yes


Greetz, 

Louis


&gt;<i> -----Oorspronkelijk bericht-----
</I>&gt;<i> Van: squid-users 
</I>&gt;<i> [mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>] Namens 
</I>&gt;<i> Amos Jeffries
</I>&gt;<i> Verzonden: donderdag 16 mei 2019 11:13
</I>&gt;<i> Aan: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> Onderwerp: Re: [squid-users] Squid V 3.5.23 authenticating in 
</I>&gt;<i> AD: User names not showing in log
</I>&gt;<i> 
</I>&gt;<i> On 16/05/19 5:45 am, Rafael Silva Daniel wrote:
</I>&gt;<i> &gt; Helo! im in need of serious help, in my company we need the 
</I>&gt;<i> access logs by
</I>&gt;<i> &gt; user name, is the only reason the proxy is setted to 
</I>&gt;<i> authenticate. but it
</I>&gt;<i> &gt; just dont show it, the relevant parts of the .conf is 
</I>&gt;<i> looking like this:
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; (...)
</I>&gt;<i> &gt; auth_param ntlm program /usr/bin/ntlm_auth --diagnostics
</I>&gt;<i> &gt; --helper-protocol=squid-2.5-ntlmssp --domain=XXXXX(domain name)
</I>&gt;<i> &gt; auth_param ntlm children 100
</I>&gt;<i> &gt; auth_param ntlm keep_alive off
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; external_acl_type NT_global_group %LOGIN 
</I>&gt;<i> /usr/lib/squid/ext_wbinfo_group_acl
</I>&gt;<i> &gt; acl users external NT_global_group &quot;/etc/squid/fapgrp&quot;
</I>&gt;<i> &gt; (...)
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; (...)
</I>&gt;<i> &gt; http_access deny !users
</I>&gt;<i> &gt; http_access allow users
</I>&gt;<i> &gt; http_access deny !auth
</I>&gt;<i> &gt; (...)
</I>&gt;<i> &gt; 
</I>&gt;<i> 
</I>&gt;<i> There is no natural reason why those CONNECT should be exempt from
</I>&gt;<i> authenticating.
</I>&gt;<i> 
</I>&gt;<i> I usually find situations like what you describe happen where someone
</I>&gt;<i> has misunderstood the default security rules and &quot;customized&quot; them a
</I>&gt;<i> bit. They are finely tuned rules, so vast changes to proxy behaviour
</I>&gt;<i> (like complete bypass of auth) can result if updates to them are not
</I>&gt;<i> done correctly.
</I>&gt;<i> 
</I>&gt;<i> Can you please show more of your http_access rules? all of 
</I>&gt;<i> them would be
</I>&gt;<i> best. At minimum all of the ones above that &quot;http_access deny !auth&quot;
</I>&gt;<i> line, and the definition lines for any ACLs used in those 
</I>&gt;<i> rules (include
</I>&gt;<i> that &quot;auth&quot; ACL definition too please).
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> &gt; ***(&quot;/etc/squid/fapgrp&quot; is a text file with the text 
</I>&gt;<i> &quot;Usu&#225;rios do d&#243;minio&quot;,
</I>&gt;<i> &gt; its &quot;Domain Users&quot; in portuguese)
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; when i test the helper:
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; /usr/bin/ntlm_auth --diagnostics --helper-protocol=squid-2.5-ntlmssp
</I>&gt;<i> &gt; --domain=XXXXX
</I>&gt;<i> &gt; user password
</I>&gt;<i> &gt; BH SPNEGO request invalid prefix
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; i read somewhere that ntlmssp can be tested like this, 
</I>&gt;<i> because we are
</I>&gt;<i> &gt; sending the credentials as plain text, so i tested with 
</I>&gt;<i> basic and the result
</I>&gt;<i> &gt; is this:
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; /usr/bin/ntlm_auth --diagnostics --helper-protocol=squid-2.5-basic
</I>&gt;<i> &gt; --domain=XXXXX
</I>&gt;<i> &gt; user password
</I>&gt;<i> &gt; OK
</I>&gt;<i> &gt; user password
</I>&gt;<i> &gt; ERR
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; so, im assuming that the way squid is processing the 
</I>&gt;<i> challenges are fine, is
</I>&gt;<i> &gt; it right?
</I>&gt;<i> 
</I>&gt;<i> That is a test that the helper is talking to the AD service okay. It
</I>&gt;<i> cannot tell you whether the client and Squid are 
</I>&gt;<i> communicating the NTLM
</I>&gt;<i> credentials.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> The NTLM protocol does not deliver passwords across the network. NTLM
</I>&gt;<i> uses (weak) encrypted tokens instead. All Squid does is pass the token
</I>&gt;<i> as-is to the helper. The helper then informs Squid what 
</I>&gt;<i> username to log
</I>&gt;<i> for that token (if any).
</I>&gt;<i>  So to test that part you need to locate a valid token and 
</I>&gt;<i> pass that to
</I>&gt;<i> the helper instead of username/password.
</I>&gt;<i> 
</I>&gt;<i> However, before you go to any trouble over that. I do not think the
</I>&gt;<i> helper or auth are the problem here. Something is clearly letting the
</I>&gt;<i> CONNECT happen without even going near the auth process.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Amos
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i> 
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="020567.html">[squid-users] Squid V 3.5.23 authenticating in AD: User names not showing in log
</A></li>
	<LI>Next message (by thread): <A HREF="020571.html">[squid-users] Squid V 3.5.23 authenticating in AD: User names not showing in log
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20568">[ date ]</a>
              <a href="thread.html#20568">[ thread ]</a>
              <a href="subject.html#20568">[ subject ]</a>
              <a href="author.html#20568">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
