<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid V 3.5.23 authenticating in AD: User names not showing in log
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20V%203.5.23%20authenticating%20in%20AD%3A%20User%20names%0A%20not%20showing%20in%20log&In-Reply-To=%3Cb2fe1c8033353b4708d0ee90fbb6f635%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="020571.html">
   <LINK REL="Next"  HREF="020574.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid V 3.5.23 authenticating in AD: User names not showing in log</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20V%203.5.23%20authenticating%20in%20AD%3A%20User%20names%0A%20not%20showing%20in%20log&In-Reply-To=%3Cb2fe1c8033353b4708d0ee90fbb6f635%40treenet.co.nz%3E"
       TITLE="[squid-users] Squid V 3.5.23 authenticating in AD: User names not showing in log">squid3 at treenet.co.nz
       </A><BR>
    <I>Fri May 17 03:06:17 UTC 2019</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="020571.html">[squid-users] Squid V 3.5.23 authenticating in AD: User names not showing in log
</A></li>
        <LI>Next message (by thread): <A HREF="020574.html">[squid-users] Squid V 3.5.23 authenticating in AD: User names not showing in log
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20572">[ date ]</a>
              <a href="thread.html#20572">[ thread ]</a>
              <a href="subject.html#20572">[ subject ]</a>
              <a href="author.html#20572">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 2019-05-17 05:36, Rafael Silva Daniel wrote:
&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> http_port 3128
</I>&gt;<i> 
</I>&gt;<i> dns_nameservers XXXXXXX
</I>&gt;<i> visible_hostname proxy
</I>&gt;<i> cache_dir ufs /var/spool/squid 100 16 256
</I>&gt;<i> coredump_dir /var/spool/squid
</I>&gt;<i> refresh_pattern ^ftp:           1440    20%     10080
</I>&gt;<i> refresh_pattern ^gopher:        1440    0%      1440
</I>&gt;<i> refresh_pattern -i (/cgi-bin/|\?) 0     0%      0
</I>&gt;<i> refresh_pattern .               0       20%     4320
</I>&gt;<i> strip_query_terms off
</I>&gt;<i> err_html_text /usr/share/squid-langpack/pt-br/
</I>
The above directive has not been supported since Squid-3.1. Please 
remove.

You seem to be wanting that pt-br to be your default error page 
language?

If that is correct, then use this instead:
   error_default_language pt-br


&gt;<i> url_rewrite_program /usr/bin/squidGuard
</I>&gt;<i> 
</I>&gt;<i> auth_param ntlm program /usr/bin/ntlm_auth --diagnostics
</I>&gt;<i> --helper-protocol=squid-2.5-ntlmssp --domain=FAPEMIG
</I>&gt;<i> auth_param ntlm children 100
</I>&gt;<i> auth_param ntlm keep_alive off
</I>&gt;<i> 
</I>&gt;<i> external_acl_type NT_global_group %LOGIN 
</I>&gt;<i> /usr/lib/squid/ext_wbinfo_group_acl
</I>&gt;<i> 
</I>&gt;<i> acl SSL_ports port 443
</I>&gt;<i> acl SSL_ports port 8443
</I>&gt;<i> acl Safe_ports port 80 # http
</I>&gt;<i> acl Safe_ports port 90 # metodo
</I>&gt;<i> acl Safe_ports port 21 # ftp
</I>&gt;<i> acl Safe_ports port 443 # https
</I>&gt;<i> acl Safe_ports port 70 # gopher
</I>&gt;<i> acl Safe_ports port 210 # wais
</I>&gt;<i> acl Safe_ports port 1025-65535 # unregistered ports
</I>&gt;<i> acl Safe_ports port 280 # http-mgmt
</I>&gt;<i> acl Safe_ports port 488 # gss-http
</I>&gt;<i> acl Safe_ports port 591 # filemaker
</I>&gt;<i> acl Safe_ports port 777 # multiling http
</I>&gt;<i> acl Safe_ports port 8080 # CNPq
</I>&gt;<i> acl Safe_ports port 3342 #
</I>
8080 and 3342 are already part of the 1024-65535 range. You can remove 
them from the above list.


&gt;<i> acl CONNECT method CONNECT
</I>&gt;<i> acl auth proxy_auth REQUIRED
</I>&gt;<i> 
</I>&gt;<i> acl users external NT_global_group &quot;/etc/squid/fapgrp&quot;
</I>&gt;<i> 
</I>&gt;<i> http_access deny !Safe_ports
</I>&gt;<i> http_access allow CONNECT
</I>
Here is the problem, exactly as suspected. The above line is supposed to 
be:
   http_access deny CONNECT !SSL_Ports

After this change alone you will find that HTTPS is only accessible to 
users once they login.

If you then find out some CONNECT tunnels need to go to any other ports, 
then you can add those numbers to the SSL_Ports list.
Just be careful and investigate whether that is a real need first due to 
how CONNECT lets arbitrary traffic through the proxy.


&gt;<i> http_access allow localhost manager
</I>&gt;<i> http_access deny manager
</I>&gt;<i> http_access allow localhost
</I>
NP: traffic from localhost (127.0.0.1/8 or [::1]/128 IP ranges) will not 
be logged with a username.

&gt;<i> http_access deny !users
</I>&gt;<i> http_access allow users
</I>&gt;<i> http_access deny !auth
</I>&gt;<i> http_access allow auth
</I>&gt;<i> 
</I>
&quot;allow users&quot; is redundant with &quot;allow auth&quot;. And users test relies on 
auth having already happened.

I would reorder these few lines to be:

  http_access deny !auth
  http_access deny !users
  http_access allow auth

That removes several helper lookups from being needed. Which gives a 
small performance gain.
NTLM is still the worst cause of delays with this whole setup though.


&gt;<i> 
</I>&gt;<i> what do you think? if theres a simpler way to get the AD users of the 
</I>&gt;<i> people
</I>&gt;<i> browsing i would use that too,
</I>&gt;<i> 
</I>
I recommend you start looking into Kerberos authentication against AD.
While its not exactly simpler for admin, it is a huge performance boost 
and security improvement.

Microsoft also officially deprecated NTLM in 2006 and been formally 
removing support from their software since Vista.
So there is future-proofing the network security system as another gain.

Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="020571.html">[squid-users] Squid V 3.5.23 authenticating in AD: User names not showing in log
</A></li>
	<LI>Next message (by thread): <A HREF="020574.html">[squid-users] Squid V 3.5.23 authenticating in AD: User names not showing in log
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20572">[ date ]</a>
              <a href="thread.html#20572">[ thread ]</a>
              <a href="subject.html#20572">[ subject ]</a>
              <a href="author.html#20572">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
