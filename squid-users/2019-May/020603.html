<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid Logs Partially duplicated when denied
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20Logs%20Partially%20duplicated%20when%20denied&In-Reply-To=%3C7e1fa213-0173-bd73-7cdf-4ea3eabf0190%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="020601.html">
   
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid Logs Partially duplicated when denied</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20Logs%20Partially%20duplicated%20when%20denied&In-Reply-To=%3C7e1fa213-0173-bd73-7cdf-4ea3eabf0190%40treenet.co.nz%3E"
       TITLE="[squid-users] Squid Logs Partially duplicated when denied">squid3 at treenet.co.nz
       </A><BR>
    <I>Fri May 31 04:53:41 UTC 2019</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="020601.html">[squid-users] Squid Logs Partially duplicated when denied
</A></li>
        
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20603">[ date ]</a>
              <a href="thread.html#20603">[ thread ]</a>
              <a href="subject.html#20603">[ subject ]</a>
              <a href="author.html#20603">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>

On 30/05/19 11:47 pm, Garbacik, Joe wrote:
&gt;<i> I have the following for each of my rules (except for my last rule:
</I>&gt;<i> http_access deny all rule):
</I>&gt;<i> 
</I>&gt;<i> http_access allow AllowedSrc AllowedInternalDst
</I>&gt;<i> 
</I>&gt;<i> note ruleid ACCESS2INTERNAL&#160; AllowedSrc AllowedInternalDst
</I>&gt;<i> 
</I>&gt;<i> note ruletype ALLOW AllowedSrc AllowedInternalDst
</I>&gt;<i> 
</I>&gt;<i> &#160;
</I>&gt;<i> 
</I>&gt;<i> I have the following log-format entry used for all logs (note the last
</I>&gt;<i> two fields now indicate to which rule I matched and the expected behavior):
</I>&gt;<i> 
</I>&gt;<i> logformat MyLogFormat&#160; ---&gt; local_time=&quot;[%tl]&quot;
</I>&gt;<i> squid_service=%{service}note squid_status=%Ss squid_hierarchy_status=%Sh
</I>&gt;<i> ** haproxy_id=%{X-Request-Id}&gt;h orig_src_ip=%{X-Forwarded-For}&gt;h
</I>&gt;<i> haproxy_egress_ip=%&gt;a haproxy_port=%&gt;p squid_ingress_port=%&gt;lp
</I>&gt;<i> squid_egress_port=%&lt;lp dst_ip=%&lt;a dst_host=%&lt;A dst_port=%&lt;p
</I>&gt;<i> ident_username=%[ui username=%[un request_method=%rm request=&quot;%rm %ru
</I>&gt;<i> HTTP/%rv&quot; status_code_from_server=%&gt;Hs status_code_to_client=%&lt;Hs
</I>&gt;<i> referer=&quot;%{Referer}&gt;h&quot; user_agent=&quot;%{User-Agent}&gt;h&quot; protocol_version=%rv
</I>&gt;<i> ** dns_response_time=%dt response_time=%tr mime_type=%mt *XFER*&#160;
</I>&gt;<i> total_request_size=%&gt;st total_reply_size=%&lt;st ** %{src_zone}note
</I>&gt;<i> %{dst_zone}note %{method_category}note %{dst_category}note
</I>&gt;<i> %{file_upload}note ** REQUEST HEADERS %&gt;h *** RESPONSE HEADERS %&lt;h ***
</I>&gt;<i> tag_returned=%et tag_string=&quot;%ea&quot; previous_hop_mac=%&gt;eui
</I>&gt;<i> peer_response_time=%&lt;pt total_response_time=%&lt;tt *SSL*
</I>&gt;<i> src_ssl_negotiated_version=%ssl::&gt;negotiated_version
</I>&gt;<i> dst_ssl_negotiated_version=%ssl::&lt;negotiated_version
</I>&gt;<i> src_tls_hello_version=%ssl::&gt;received_hello_version&#160;
</I>&gt;<i> dst_tls_hello_version=%ssl::&lt;received_hello_version
</I>&gt;<i> src_tls_max_version=%ssl::&gt;received_supported_version
</I>&gt;<i> dst_tls_max_version=%ssl::&lt;received_supported_version
</I>&gt;<i> src_tls_cipher=%ssl::&gt;negotiated_cipher
</I>&gt;<i> dst_tls_cipher=%ssl::&lt;negotiated_cipher ssl_bump=%&lt;bs
</I>&gt;<i> ssl_bump_mode=%ssl::bump_mode ssl_sni=%ssl::&gt;sni
</I>&gt;<i> src_cert_subject=&quot;%ssl::&gt;cert_subject&quot;
</I>&gt;<i> src_cert_issuer=&quot;%ssl::&gt;cert_issuer&quot;
</I>&gt;<i> dst_cert_subject=&quot;%ssl::&lt;cert_subject&quot;
</I>&gt;<i> dst_cert_issuer=&quot;%ssl::&lt;cert_issuer&quot; cert_errors=&quot;%ssl::&lt;cert_errors&quot;
</I>&gt;<i> *** error_page_presented=%err_code err_detail=&quot;%err_detail&quot;&#160;
</I>&gt;<i> rule_id=%{ruleid}note rule_type=%{ruletype}note
</I>&gt;<i> 
</I>
Please be aware that there are length limits to log lines. 8KB is
hard-coded in all current releases. With each logging module having its
own I/O limit - which may be smaller than the general 8KB limit in some
modules.


&gt;<i> 
</I>&gt;<i> So when traffic is allowed, everything works as expected (Note the
</I>&gt;<i> orig_src_ip, rule_id, rule, type are all populated):
</I>&gt;<i> 
</I>&gt;<i> ---&gt; local_time=&quot;[30/May/2019:07:25:12 -0400]&quot; squid_service=explicit
</I>&gt;<i> squid_status=TCP_TUNNEL squid_hierarchy_status=HIER_DIRECT **
</I>&gt;<i> haproxy_id=5CEFBD98_0AFB14CC_0AFB1621_206C_9E79_461F
</I>&gt;<i> orig_src_ip=10.10.2.24 &lt;TRUNCATED&gt;&#160; rule_id=ACCESS2INTERNAL&#160; rule_type=ALLOW
</I>&gt;<i> 
</I>&gt;<i> &#160;
</I>&gt;<i> 
</I>&gt;<i> When a client is denied, it creates two log entries, each with portion
</I>&gt;<i> of the logs filled out (i.e. orig_src_ip in the first log, and the
</I>&gt;<i> requested url and the &#160;rule that I expected to match in second log):
</I>&gt;<i> 
</I>&gt;<i> *---&gt; local_time=&quot;[30/May/2019:07:20:32 -0400]&quot;* squid_service=explicit
</I>&gt;<i> squid_status=TCP_DENIED squid_hierarchy_status=HIER_NONE **
</I>&gt;<i> haproxy_id=5CEFBC7F_0AFB14CC_0AFB1621_206C_9DBE_461F
</I>&gt;<i> orig_src_ip=10.10.2.24 &lt;TRUNCATED&gt;
</I>&gt;<i> error_page_presented=ERR_ACCESS_DENIED err_detail=&quot;-&quot;&#160; rule_id=- rule_type=-
</I>&gt;<i> 
</I>&gt;<i> *&#160;*
</I>&gt;<i> 
</I>&gt;<i> *---&gt; local_time=&quot;[30/May/2019:07:20:32 -0400]&quot;* squid_service=explicit
</I>&gt;<i> squid_status=NONE squid_hierarchy_status=HIER_NONE ** haproxy_id=-
</I>&gt;<i> orig_src_ip=- &lt;TRUNCATED&gt; &#160;request_method=GET request=&quot;GET
</I>&gt;<i> <A HREF="https://example.org/">https://example.org/</A> HTTP/1.1&quot; status_code_from_server=403
</I>&gt;<i> status_code_to_client=- &lt;TRUNCATED&gt;
</I>&gt;<i> error_page_presented=ERR_ACCESS_DENIED err_detail=&quot;-&quot;&#160;
</I>&gt;<i> rule_id=ACCESS2INTERNAL&#160; rule_type=
</I>&gt;<i> 
</I>&gt;<i> ALLOW
</I>&gt;<i> 
</I>&gt;<i> &#160;
</I>&gt;<i> 
</I>&gt;<i> So my questions are these:
</I>&gt;<i> 
</I>&gt;<i>  1. Is there a better way to log which rules a connection matches?
</I>

No. The case you have is a very good example of why.

-&gt; There many ACLs all being evaluated for any one transaction.

-&gt; There are multiple protocol levels. Each with different ACLs being
applied.

-&gt; There are multiple *transactions* at the HTTP level that those ACLs
are all being tested one. With possibly conflicting or otherwise vastly
different results.

In aggregate no one ACL can be said to 'cause' the behaviour. They are
just small steps in a quite large sequence of choices.



&gt;<i>  2. Why does the denied log twice and not as a single log entry? Why
</I>&gt;<i>     isn't the requested URL logged in the first log entry and then done.
</I>
Because there are two transactions to log.



&gt;<i>  3. Why do I see two squid_status types on the denied (TCP_DENIED and NONE)?
</I>&gt;<i> 
</I>
You appear to be using SSL-Bump features. Which means;

The ALLOW case was a spliced transaction. The tunnel data remains
untouched - so only the tunnel layer to log. Thus TCP_TUNNEL

The DENY case requires delivery of a error page to clients. Because of
how Browsers treat error responses to CONNECT requests the TUNNEL must
be bumped to inject the error page in a place where it will get show to
the Browser user, which means two transactions now exist;
 a) the TUNNEL transaction
 b) the decrypted HTTPS request which gets the HTTP format error
response injected.


Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="020601.html">[squid-users] Squid Logs Partially duplicated when denied
</A></li>
	
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20603">[ date ]</a>
              <a href="thread.html#20603">[ thread ]</a>
              <a href="subject.html#20603">[ subject ]</a>
              <a href="author.html#20603">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
