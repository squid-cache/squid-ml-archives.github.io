<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] LDAP authentication from android and iphones
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20LDAP%20authentication%20from%20android%20and%20iphones&In-Reply-To=%3C6afbddd9-fbcd-ef79-f7d5-c41c3362cd33%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="020602.html">
   <LINK REL="Next"  HREF="020601.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] LDAP authentication from android and iphones</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20LDAP%20authentication%20from%20android%20and%20iphones&In-Reply-To=%3C6afbddd9-fbcd-ef79-f7d5-c41c3362cd33%40treenet.co.nz%3E"
       TITLE="[squid-users] LDAP authentication from android and iphones">squid3 at treenet.co.nz
       </A><BR>
    <I>Fri May 31 05:33:43 UTC 2019</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="020602.html">[squid-users] LDAP authentication from android and iphones
</A></li>
        <LI>Next message (by thread): <A HREF="020601.html">[squid-users] Squid Logs Partially duplicated when denied
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20604">[ date ]</a>
              <a href="thread.html#20604">[ thread ]</a>
              <a href="subject.html#20604">[ subject ]</a>
              <a href="author.html#20604">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 31/05/19 10:28 am, Ilias Clifton wrote:
&gt;&gt;&gt;&gt;&gt;<i> Sent: Wednesday, May 29 2019 6:42
</I>&gt;&gt;&gt;&gt;&gt;<i> From: Ilias Clifton
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> I have Squid 3.5.27 running on Ubuntu 18.04.2, and have been unsuccesfull in being able to authenticate users via ldap (kerberos is working well)
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> What else can I do for troubleshooting?
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> What I do is take one of the access.log lines and read through the squid.conf (whole thing) to see what squid would do with that transaction. Most 40* status problems are with http_access ordering, so quickly spotted.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> If you can provide those details in full im happy to do so for you. Or someone experienced with a similar config may spot the issue.
</I>&gt;&gt;<i>
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> See squid.conf below.. Any other config files you need to see?
</I>&gt;<i> 
</I>
This seems sufficient for config. A few possible issues are visible
already, noted below.

If fixing those does not work an access.log line will be needed to do
the troubleshooting sequence check I mentioned.


&gt;<i> The users authenticating via ldap on phones are in an Active directory group listed in the file /etc/squid/full_access.txt - They do get full internet access when authenticating via kerberos.
</I>&gt;<i> 
</I>&gt;<i> I've checked they are entering the correct passwords - although there are special characters in the passwords eg. `^( - Not sure if that could make a difference. Like I said, it works when running basic_ldap_auth on the command line.
</I>&gt;<i> 
</I>&gt;<i> ### cache manager
</I>&gt;<i> cache_mgr <A HREF="https://lists.squid-cache.org/listinfo/squid-users">proxy at domain.com</A>
</I>&gt;<i> 
</I>&gt;<i> auth_param negotiate program /usr/lib/squid/negotiate_kerberos_auth -k /etc/squid/PROXY.keytab -r -s GSS_C_NO_NAME
</I>&gt;<i> auth_param negotiate children 10 startup=2 idle=1
</I>&gt;<i> auth_param negotiate keep_alive on
</I>&gt;<i> 
</I>&gt;<i> auth_param basic program /usr/lib/squid/basic_ldap_auth -d -R -b &quot;DC=domain,DC=com&quot; -D <A HREF="https://lists.squid-cache.org/listinfo/squid-users">proxyuser at domain.com</A> -W /etc/squid/ldappass.txt -f sAMAccountName=%s -h dc.domain.com
</I>&gt;<i> auth_param basic children 10 startup=2 idle=1
</I>&gt;<i> auth_param basic realm Internet Proxy
</I>&gt;<i> auth_param basic credentialsttl 10 minutes
</I>&gt;<i> 
</I>

Ah. Sorry I overlooked this mention of Kerberos existing in your initial
mail. This adds something else to check on.

HTTP auth is negotiated starting with the scheme. Clients are required
to attempt the most secure auth scheme from the servers initial 407
response. That means any client which supports Negotiate is required to
use it - no Basic for them.

One thing about Negotiate is that Kerberos keytabs can be setup on some
clients or types of client (ie all iPhones, all Android etc) in a way
that makes it not work when all others do.

Another thing is that clients can also try to use it for Negotiate/NTLM
flavour of auth. Which is not supported by your proxy.

So you do need to check a cache.log trace made with &quot;debug_options 11,2&quot;
to verify that the clients are actually attempting to use Basic or
Kerberos flavour of Negotiate.



&gt;<i> external_acl_type memberof %LOGIN /usr/lib/squid/ext_ldap_group_acl -R -K -S -b &quot;DC=domain,DC=com&quot; -D <A HREF="https://lists.squid-cache.org/listinfo/squid-users">proxyuser at domain.com</A> -W /etc/squid/ldappass.txt -f &quot;(&amp;(objectclass=person)(sAMAccountName=%v)(memberof=cn=%g,OU=Proxy, DC=domain, DC=com))&quot; -h dc.domain.com
</I>&gt;<i> 
</I>
I see a whitespace in the -f parameter string &quot;OU=Proxy, DC=domain&quot;
section. Squid-3 does not support whitespace in helper command line
parameters. So that alone may be the problem.


&gt;<i> ### acl for proxy auth and ldap authorizations
</I>&gt;<i> acl auth proxy_auth REQUIRED
</I>&gt;<i> acl BlockedAccess   external memberof &quot;/etc/squid/blocked_access.txt&quot;
</I>&gt;<i> acl StandardAccess  external memberof &quot;/etc/squid/standard_access.txt&quot;
</I>&gt;<i> acl FullAccess      external memberof &quot;/etc/squid/full_access.txt&quot;
</I>&gt;<i> 
</I>&gt;<i> acl allowedsites    dstdomain &quot;/etc/squid/allowedsites.txt&quot;
</I>&gt;<i> acl blockedsites    dstdomain &quot;/etc/squid/blockedsites.txt&quot;
</I>&gt;<i> 
</I>&gt;<i> acl macaddresses	arp &quot;/etc/squid/macaddresses.txt&quot;
</I>&gt;<i> 
</I>&gt;<i> acl SSL_ports port 443
</I>&gt;<i> acl Safe_ports port 80          # http
</I>&gt;<i> acl Safe_ports port 21          # ftp
</I>&gt;<i> acl Safe_ports port 443         # https
</I>&gt;<i> acl Safe_ports port 70          # gopher
</I>&gt;<i> acl Safe_ports port 210         # wais
</I>&gt;<i> acl Safe_ports port 1025-65535  # unregistered ports
</I>&gt;<i> acl Safe_ports port 280         # http-mgmt
</I>&gt;<i> acl Safe_ports port 488         # gss-http
</I>&gt;<i> acl Safe_ports port 591         # filemaker
</I>&gt;<i> acl Safe_ports port 777         # multiling http
</I>&gt;<i> acl CONNECT method CONNECT
</I>&gt;<i> 
</I>&gt;<i> http_access allow manager localhost
</I>&gt;<i> http_access deny manager
</I>&gt;<i> http_access deny !Safe_ports
</I>&gt;<i> http_access deny CONNECT !SSL_ports
</I>&gt;<i> http_access allow localhost
</I>&gt;<i> 
</I>
NP: current recommendation/default is to have the manager ACL test after
the localhost one, like so:

 http_access deny !Safe_ports
 http_access deny CONNECT !SSL_ports
 http_access allow localhost
 http_access deny manager


&gt;<i> # allow unauthenticated access to macaddresses in list
</I>&gt;<i> http_access allow macaddresses
</I>&gt;<i> http_access deny !auth
</I>
NP: all users are guaranteed to be logged in from this point onwards. So
any use of &quot;auth&quot; ACL in later http_access lines and (most) other
directives should be pointless. Making those lines more suspect for
issues when troubleshooting.


&gt;<i> http_access deny BlockedAccess all
</I>&gt;<i> 
</I>&gt;<i> http_access allow allowedsites
</I>&gt;<i> http_access allow FullAccess auth
</I>&gt;<i> 
</I>If you want clients to re-login whenever they fail the FullAccess group
check then just remove the auth on this line.

 ==&gt; please be aware that the repeated 407 you report seeing is how
re-login shows up. Though best-case does only one 407 loop, there is no
limitation on how many can actually happen. Safari is known to never
stop trying the non-working credentials.


If you do not want re-logins to happen then replace &quot;auth&quot; with &quot;all&quot;


&gt;<i> http_access deny blockedsites
</I>&gt;<i> http_access allow StandardAccess auth
</I>&gt;<i> 
</I>
Same here.


&gt;<i> http_access deny all
</I>&gt;<i> 
</I>&gt;<i> cache_mem 1024 MB
</I>&gt;<i> cache_dir aufs /var/spool/squid 27648 16 256
</I>&gt;<i> 
</I>&gt;<i> ### logging
</I>&gt;<i> ccess_log /var/log/squid/access.log squid
</I>&gt;<i> err_page_stylesheet /etc/squid/errorpage.css
</I>&gt;<i> error_directory /etc/squid/error_pages
</I>&gt;<i> 
</I>&gt;<i> ### squid Debian defaults
</I>&gt;<i> http_port 3128
</I>&gt;<i> hierarchy_stoplist cgi-bin ?
</I>&gt;<i> coredump_dir /var/spool/squid
</I>&gt;<i> refresh_pattern ^ftp:           1440    20%     10080
</I>&gt;<i> refresh_pattern ^gopher:        1440    0%      1440
</I>&gt;<i> refresh_pattern -i (/cgi-bin/|\?) 0     0%      0
</I>&gt;<i> refresh_pattern .               0       20%     4320
</I>&gt;<i> 
</I>


Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="020602.html">[squid-users] LDAP authentication from android and iphones
</A></li>
	<LI>Next message (by thread): <A HREF="020601.html">[squid-users] Squid Logs Partially duplicated when denied
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20604">[ date ]</a>
              <a href="thread.html#20604">[ thread ]</a>
              <a href="subject.html#20604">[ subject ]</a>
              <a href="author.html#20604">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
