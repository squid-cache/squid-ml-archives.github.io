<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Another &quot;Forwarding loop detected&quot; issue
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Another%20%22Forwarding%20loop%20detected%22%20issue&In-Reply-To=%3Ce11f5b05-84be-ec74-e06d-92ac689ccb45%40howitts.co.uk%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="021251.html">
   <LINK REL="Next"  HREF="021260.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Another &quot;Forwarding loop detected&quot; issue</H1>
    <B>Nick Howitt</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Another%20%22Forwarding%20loop%20detected%22%20issue&In-Reply-To=%3Ce11f5b05-84be-ec74-e06d-92ac689ccb45%40howitts.co.uk%3E"
       TITLE="[squid-users] Another &quot;Forwarding loop detected&quot; issue">nick at howitts.co.uk
       </A><BR>
    <I>Tue Nov  5 12:57:31 UTC 2019</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="021251.html">[squid-users] Another &quot;Forwarding loop detected&quot; issue
</A></li>
        <LI>Next message (by thread): <A HREF="021260.html">[squid-users] Another &quot;Forwarding loop detected&quot; issue
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21252">[ date ]</a>
              <a href="thread.html#21252">[ thread ]</a>
              <a href="subject.html#21252">[ subject ]</a>
              <a href="author.html#21252">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 05/11/2019 11:07, Nick Howitt wrote:
&gt;<i>
</I>&gt;<i>
</I>&gt;<i> On 05/11/2019 10:44, Amos Jeffries wrote:
</I>&gt;&gt;<i> On 5/11/19 10:40 pm, Nick Howitt wrote:
</I>&gt;&gt;&gt;<i> I am trying to help someone who is running squid-3.5.20-12 on a
</I>&gt;&gt;&gt;<i> standalone server with the dansguardian content filter and suddenly
</I>&gt;&gt;&gt;<i> recently has been getting a lot of messages like:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> &#160;&#160;&#160; 2019/10/31 13:48:14 kid1| WARNING: Forwarding loop detected for:
</I>&gt;&gt;&gt;<i> &#160;&#160;&#160; HEAD / HTTP/1.0
</I>&gt;&gt;&gt;<i> &#160;&#160;&#160; Via: 1.0 HSFilterHyperos7.haftr.local (squid/3.5.20)
</I>&gt;&gt;&gt;<i> &#160;&#160;&#160; Cache-Control: max-age=259200
</I>&gt;&gt;&gt;<i> &#160;&#160;&#160; Connection: keep-alive
</I>&gt;&gt;&gt;<i> &#160;&#160;&#160; X-Forwarded-For: 10.10.1.2
</I>&gt;&gt;&gt;<i> &#160;&#160;&#160; Host: 10.10.1.2:8080
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> The access log looks something like:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> &#160;&#160;&#160; 1572545946.383 120000 10.10.1.2 TCP_MISS_ABORTED/000 0 HEAD
</I>&gt;&gt;&gt;<i> &#160;&#160;&#160; <A HREF="http://10.10.1.2:8080/">http://10.10.1.2:8080/</A> - HIER_DIRECT/10.10.1.2 -
</I>&gt;&gt;&gt;<i> &#160;&#160;&#160; 1572545946.477 120000 10.10.1.2 TCP_MISS_ABORTED/000 0 HEAD
</I>&gt;&gt;&gt;<i> &#160;&#160;&#160; <A HREF="http://10.10.1.2:8080/">http://10.10.1.2:8080/</A> - HIER_DIRECT/10.10.1.2 -
</I>&gt;&gt;&gt;<i> &#160;&#160;&#160; 1572545946.493 120000 10.10.1.2 TCP_MISS_ABORTED/000 0 HEAD
</I>&gt;&gt;&gt;<i> &#160;&#160;&#160; <A HREF="http://10.10.1.2:8080/">http://10.10.1.2:8080/</A> - HIER_DIRECT/10.10.1.2 -
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> (but these are for different transactions - they are all the same apart
</I>&gt;&gt;&gt;<i> from the timestamps)
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i> That is what a forwarding loop looks like in the access.log.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> The content filter listens on port 8080 and squid on 3128. The machine
</I>&gt;&gt;&gt;<i> is on 10.10.1.2
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> All the other posts I've seen seem to be for transparent mode or where
</I>&gt;&gt;&gt;<i> there is a User Agent string. I have found nothing to cover this
</I>&gt;&gt;&gt;<i> scenario. How can I troubleshoot to fix it and what information do you
</I>&gt;&gt;&gt;<i> need from me to help diagnose?
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i> Something is telling Squid the origin server being contacted exists at
</I>&gt;&gt;<i> 10.10.1.2:8080. You can see that in the Host header of the message.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I would trace the traffic flow from the client to Squid.
</I>&gt;&gt;<i>
</I>&gt;<i> But isn't everything coming to 8080 as that is the proxy you'd set up 
</I>&gt;<i> in the browser? I'm afraid I don't understand how proxying works at 
</I>&gt;<i> the packet level. I see nothing before these messages to indicate the 
</I>&gt;<i> packets are coming from elsewhere. A cut down startup log looks like:
</I>&gt;<i>
</I>&gt;<i> &#160;&#160; &lt;snip&gt;
</I>&gt;<i> &#160;&#160; 2019/10/31 13:47:40 kid1| helperOpenServers: Starting 5/5
</I>&gt;<i> &#160;&#160; 'ext_unix_group_acl' processes
</I>&gt;<i> &#160;&#160; 2019/10/31 13:47:40 kid1| HTCP Disabled.
</I>&gt;<i> &#160;&#160; 2019/10/31 13:47:40 kid1| Finished loading MIME types and icons.
</I>&gt;<i> &#160;&#160; 2019/10/31 13:47:40 kid1| Accepting HTTP Socket connections at
</I>&gt;<i> &#160;&#160; local=[::1]:3128 remote=[::] FD 2021 flags=9
</I>&gt;<i> &#160;&#160; 2019/10/31 13:47:40 kid1| Accepting HTTP Socket connections at
</I>&gt;<i> &#160;&#160; local=127.0.0.1:3128 remote=[::] FD 2022 flags=9
</I>&gt;<i> &#160;&#160; 2019/10/31 13:47:40 kid1| Accepting HTTP Socket connections at
</I>&gt;<i> &#160;&#160; local=10.10.1.2:3128 remote=[::] FD 2023 flags=9
</I>&gt;<i> &#160;&#160; 2019/10/31 13:48:12 kid1| WARNING: Forwarding loop detected for:
</I>&gt;<i> &#160;&#160; HEAD / HTTP/1.0
</I>&gt;<i> &#160;&#160; Via: 1.0 HSFilterHyperos7.haftr.local (squid/3.5.20)
</I>&gt;<i> &#160;&#160; Cache-Control: max-age=259200
</I>&gt;<i> &#160;&#160; Connection: keep-alive
</I>&gt;<i> &#160;&#160; X-Forwarded-For: 10.10.1.2
</I>&gt;<i> &#160;&#160; Host: 10.10.1.2:8080
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &#160;&#160; 2019/10/31 13:48:14 kid1| WARNING: Forwarding loop detected for:
</I>&gt;<i> &#160;&#160; HEAD / HTTP/1.0
</I>&gt;<i> &#160;&#160; Via: 1.0 HSFilterHyperos7.haftr.local (squid/3.5.20)
</I>&gt;<i> &#160;&#160; Cache-Control: max-age=259200
</I>&gt;<i> &#160;&#160; Connection: keep-alive
</I>&gt;<i> &#160;&#160; X-Forwarded-For: 10.10.1.2
</I>&gt;<i> &#160;&#160; Host: 10.10.1.2:8080
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Is there anything I can look for in my logs or do I need to do some 
</I>&gt;<i> sort of tcpdump with some filters?
</I>&gt;<i>
</I>&gt;<i> Thanks,
</I>&gt;<i>
</I>&gt;<i> Nick
</I>At the moment the wpad file is not pointing to the proxy server so no 
machines should be using it. I have tried a:

    tcpdump -vvvnnn -A -i eth0 port 8080 -s 1500


This gives me bursts of:

    07:50:47.569305 IP (tos 0x0, ttl 128, id 56718, offset 0, flags
    [DF], proto TCP (6), length 52)
     &#160;&#160;&#160; 10.10.11.215.64857 &gt; 10.10.1.2.8080: Flags [S], cksum 0x389b
    (correct), seq 625662051, win 64240, options [mss 1460,nop,wscale
    8,nop,nop,sackOK], length 0
    <A HREF="https://lists.squid-cache.org/listinfo/squid-users">E..4.. at ....H</A>

    ..

    ...Y..%J.c........8...............
    07:50:47.569419 IP (tos 0x0, ttl 64, id 7161, offset 0, flags [DF],
    proto TCP (6), length 40)
     &#160;&#160;&#160; 10.10.1.2.8080 &gt; 10.10.11.215.64857: Flags [R.], cksum 0x744b
    (correct), seq 0, ack 1, win 0, length 0
    E..(<A HREF="https://lists.squid-cache.org/listinfo/squid-users">.. at .</A>@...

    ..

    .....Y....%J.dP...tK..


 From what I've researched so far there are no http headers in these 
packets. The proxy is 10.10.1.2. Does this mean 10.10.11.215 could be 
the offending machine if no other machines should be using the proxy? Or 
do I need to do something cleverer with my tcpdump?


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="021251.html">[squid-users] Another &quot;Forwarding loop detected&quot; issue
</A></li>
	<LI>Next message (by thread): <A HREF="021260.html">[squid-users] Another &quot;Forwarding loop detected&quot; issue
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21252">[ date ]</a>
              <a href="thread.html#21252">[ thread ]</a>
              <a href="subject.html#21252">[ subject ]</a>
              <a href="author.html#21252">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
