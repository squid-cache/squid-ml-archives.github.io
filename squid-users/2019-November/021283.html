<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid crash - 3.5.21
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20crash%20-%203.5.21&In-Reply-To=%3C31926e6a-d867-c8ad-4ad7-c1402867ab59%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="021280.html">
   <LINK REL="Next"  HREF="021284.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid crash - 3.5.21</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20crash%20-%203.5.21&In-Reply-To=%3C31926e6a-d867-c8ad-4ad7-c1402867ab59%40measurement-factory.com%3E"
       TITLE="[squid-users] Squid crash - 3.5.21">rousskov at measurement-factory.com
       </A><BR>
    <I>Mon Nov 11 16:19:16 UTC 2019</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="021280.html">[squid-users] Squid crash - 3.5.21
</A></li>
        <LI>Next message (by thread): <A HREF="021284.html">[squid-users] Squid crash - 3.5.21
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21283">[ date ]</a>
              <a href="thread.html#21283">[ thread ]</a>
              <a href="subject.html#21283">[ subject ]</a>
              <a href="author.html#21283">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Context: hindsight1 was replying to a 2016 email archived at
<A HREF="http://lists.squid-cache.org/pipermail/squid-users/2016-October/012881.html">http://lists.squid-cache.org/pipermail/squid-users/2016-October/012881.html</A>


On 11/10/19 7:13 AM, hindsight1 wrote:
&gt;<i> When running Squid4.8 on the arm using SMP. And setting 4 or 7,9  worker
</I>&gt;<i> ,the same error occurred in the log.
</I>
&gt;&gt;&gt;<i> Received Bus Error...dying, 
</I>
&gt;<i> Debugging the core file with gdb found that the address was not aligned. 
</I>&gt;<i> 
</I>&gt;<i> Does it consider the case where only address-aligned access is supported on
</I>&gt;<i> arm
</I>
I am not sure whether &quot;it&quot; in your sentence refers to gdb or Squid, but
if Squid dereferences an unaligned data field in shared memory, then it
is most likely a Squid bug.


&gt;<i> The question is, why is the type of Item in the PageStack class using
</I>&gt;<i> uint32_t,
</I>
Probably to avoid wasting space: Squid Store does not yet support caches
with more than 16777215 entries (a signed 25-bit integer) and SMP-aware
caches do not support storing responses with more pages than that limit.
Even though response size and the number of responses are conceptually
different limits, the underlying code/structures tie the two together IIRC.


&gt;<i> can it be replaced with uint64_t or size_t?
</I>
I have not checked whether any other adjustments would be required, but
I suspect that the answer is &quot;yes&quot;. Needless to say, this replacement
will waste RAM.


&gt;<i> When I change to uint64_t, the problem disappears.
</I>
If there is an unaligned access bug, we should fix that bug directly
rather than relying on side effects of field sizes or, at least, we
should confirm and document that those side effects are the right fix.

To fix this properly, a stack trace would be very helpful. Can you post
that?


Alex.


&gt;<i> Alex Rousskov wrote
</I>&gt;&gt;<i> On 10/03/2016 04:50 AM, Jasper Van Der Westhuizen wrote:
</I>&gt;&gt;&gt;<i> This morning I had some problems with some of our proxies. 2 Proxies in
</I>&gt;&gt;&gt;<i> cluster A crashed with the below errors. The shortly afterwards 4 in
</I>&gt;&gt;&gt;<i> cluster B did the same. Both clusters are configured to run their cache
</I>&gt;&gt;&gt;<i> in memory with SMP and 4 workers configured.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> FATAL: Received Bus Error...dying.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> There are at least two possible reasons:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>   1. A bug in Squid and
</I>&gt;&gt;<i>   2. Memory overallocation by the OS kernel.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> To fix the former, the developers will need a stack trace (at least). I
</I>&gt;&gt;<i> recommend filing a bug report after getting that trace and excluding
</I>&gt;&gt;<i> reason #2. Squid wiki and various system administration guides explain
</I>&gt;&gt;<i> how to make Squid dump core files.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> To check for memory overallocation, you can temporary start Squid v4.0
</I>&gt;&gt;<i> with &quot;shared_memory_locking on&quot;. Unfortunately, that squid.conf
</I>&gt;&gt;<i> directive is not available in Squid v3. You may be able to emulate it
</I>&gt;&gt;<i> using some OS-specific sysctl or environment variables, but doing so may
</I>&gt;&gt;<i> be far from trivial, and I do not have instructions.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> HTH,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Alex.
</I>
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="021280.html">[squid-users] Squid crash - 3.5.21
</A></li>
	<LI>Next message (by thread): <A HREF="021284.html">[squid-users] Squid crash - 3.5.21
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21283">[ date ]</a>
              <a href="thread.html#21283">[ thread ]</a>
              <a href="subject.html#21283">[ subject ]</a>
              <a href="author.html#21283">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
