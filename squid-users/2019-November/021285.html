<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid crash - 3.5.21
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20crash%20-%203.5.21&In-Reply-To=%3C755aa523-6791-4043-c5cf-1646982e6f71%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="021284.html">
   <LINK REL="Next"  HREF="021304.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid crash - 3.5.21</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20crash%20-%203.5.21&In-Reply-To=%3C755aa523-6791-4043-c5cf-1646982e6f71%40measurement-factory.com%3E"
       TITLE="[squid-users] Squid crash - 3.5.21">rousskov at measurement-factory.com
       </A><BR>
    <I>Tue Nov 12 14:15:20 UTC 2019</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="021284.html">[squid-users] Squid crash - 3.5.21
</A></li>
        <LI>Next message (by thread): <A HREF="021304.html">[squid-users] Squid crash - 3.5.21
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21285">[ date ]</a>
              <a href="thread.html#21285">[ thread ]</a>
              <a href="subject.html#21285">[ subject ]</a>
              <a href="author.html#21285">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>FTR: hindsight1 runs v4.8 despite the email subject saying &quot;3.5.21&quot;.


On 11/11/19 9:34 PM, hindsight1 wrote:

&gt;<i> thank you for your reply
</I>
Thank you for detailing the problem. The best place to discuss these
low-level details is Squid Bugzilla. I suggest that you open a new bug
report there. If you want to continue here, then the primary remaining
question for me is _why_ theLevels array elements are misaligned in your
tests:

* theLevels[0]: The segments are allocated on page-boundaries so the
first level element (i.e. level[0]) should be properly aligned. I
believe your stack trace shows that this zero-offset access is misaligned.

* theLevels[n+1]: The levels array is declared using regular C++
constructs, without any casting, so subsequent elements should be
aligned properly if the first element is aligned properly.

So where does this misalignment originate from? Properly addressing this
bug probably requires answering this question.


Please note that there are GCC v4 bugs that might be relevant here:
<A HREF="https://gcc.gnu.org/bugzilla/show_bug.cgi?id=62259">https://gcc.gnu.org/bugzilla/show_bug.cgi?id=62259</A>
<A HREF="https://gcc.gnu.org/bugzilla/show_bug.cgi?id=65147">https://gcc.gnu.org/bugzilla/show_bug.cgi?id=65147</A>

What is your compiler? Does building with GCC v5.1 fix the problem?


BTW, there is a potentially useful alignas() workaround/trick shown at
<A HREF="https://stackoverflow.com/questions/26703297/alignment-of-atomic-variables">https://stackoverflow.com/questions/26703297/alignment-of-atomic-variables</A>



Thank you,

Alex.


&gt;<i> Sorry for my English&#65292;First of all&#65292;
</I>&gt;&gt;<i> I am not sure whether &quot;it&quot; in your sentence refers to gdb or Squid, but
</I>&gt;&gt;<i> if Squid dereferences an unaligned data field in shared memory, then it
</I>&gt;&gt;<i> is most likely a Squid bug.
</I>&gt;<i> 
</I>&gt;<i> &quot;it&quot; is refers to Squid.
</I>&gt;<i> 
</I>&gt;<i> i want to Explain my problem again 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> I run Squid4.8 using SMP mode on the Arm64 platform. When setting some
</I>&gt;<i> worker numbers, for example 4 or 7,9 the same error Received Bus
</I>&gt;<i> Error...dying appears in the log.
</I>&gt;<i> Using gdb debugging, I found an error when accessing theLevels variable in
</I>&gt;<i> the Ipc::Mem::PagePool::level function, due to the non-aligned address
</I>&gt;<i> access caused by the atomic operation load.
</I>&gt;<i> Here is stacktrace:
</I>&gt;<i> 
</I>&gt;<i> #0  0x0000ffff9c945228 in raise () from /lib64/libc.so.6
</I>&gt;<i> #1  0x0000ffff9c9468a0 in abort () from /lib64/libc.so.6
</I>&gt;<i> #2  0x00000000007c6238 in death (sig=7) at tools.cc:359
</I>&gt;<i> #3  &lt;signal handler called&gt;
</I>&gt;<i> #4  0x00000000007c50a4 in std::__atomic_base&lt;unsigned long&gt;::load
</I>&gt;<i> (this=0xfff9d9d40cec, __m=std::memory_order_seq_cst) at
</I>&gt;<i> /usr/include/c++/4.8.2/bits/atomic_base.h:496
</I>&gt;<i> #5  0x00000000007c4344 in std::__atomic_base&lt;unsigned long&gt;::operator
</I>&gt;<i> unsigned long (this=0xfff9d9d40cec) at
</I>&gt;<i> /usr/include/c++/4.8.2/bits/atomic_base.h:367
</I>&gt;<i> #6  0x0000000000937f2c in Ipc::Mem::PagePool::level (this=0xde9150,
</I>&gt;<i> purpose=0) at mem/PagePool.cc:46
</I>&gt;<i> #7  0x0000000000934ae8 in Ipc::Mem::PageLevel (purpose=0) at mem/Pages.cc:88
</I>&gt;<i> #8  0x00000000007c3db0 in Ipc::Mem::PagesAvailable (purpose=0) at
</I>&gt;<i> ipc/mem/Pages.h:51
</I>&gt;<i> #9  0x00000000009342a4 in Ipc::Mem::GetPage
</I>&gt;<i> (purpose=Ipc::Mem::PageId::cachePage, page=...) at mem/Pages.cc:36
</I>&gt;<i> #10 0x00000000007c241c in MemStore::reserveSapForWriting (this=0x10e3bb0,
</I>&gt;<i> page=...) at MemStore.cc:778
</I>&gt;<i> #11 0x00000000007c1c18 in MemStore::nextAppendableSlice (this=0x10e3bb0,
</I>&gt;<i> fileNo=513735, sliceOffset=@0x10e3bd8: -1) at MemStore.cc:731
</I>&gt;<i> #12 0x00000000007c145c in MemStore::copyToShm (this=0x10e3bb0, e=...) at
</I>&gt;<i> MemStore.cc:682
</I>&gt;<i> #13 0x00000000007c2cdc in MemStore::write (this=0x10e3bb0, e=...) at
</I>&gt;<i> MemStore.cc:856
</I>&gt;<i> #14 0x00000000009f9838 in Store::Controller::memoryOut (this=0xdd2e20,
</I>&gt;<i> e=..., preserveSwappable=true) at Controller.cc:550
</I>&gt;<i> #15 0x00000000007b50e8 in StoreEntry::swapOut (this=0x125e4e0) at
</I>&gt;<i> store_swapout.cc:175
</I>&gt;<i> #16 0x00000000007af4a4 in StoreEntry::invokeHandlers (this=0x125e4e0) at
</I>&gt;<i> store_client.cc:720
</I>&gt;<i> #17 0x00000000007a650c in StoreEntry::flush (this=0x125e4e0) at
</I>&gt;<i> store.cc:1674
</I>&gt;<i> #18 0x00000000007a6dcc in StoreEntry::startWriting (this=0x125e4e0) at
</I>&gt;<i> store.cc:1844
</I>&gt;<i> #19 0x000000000083b7e8 in Client::setFinalReply (this=0x1275b18,
</I>&gt;<i> rep=0x12b36c0) at Client.cc:164
</I>&gt;<i> #20 0x00000000008401bc in Client::adaptOrFinalizeReply (this=0x1275b18) at
</I>&gt;<i> Client.cc:974
</I>&gt;<i> #21 0x0000000000726344 in HttpStateData::processReply (this=0x1275b18) at
</I>&gt;<i> http.cc:1246
</I>&gt;<i> #22 0x0000000000725fec in HttpStateData::readReply (this=0x1275b18, io=...)
</I>&gt;<i> at http.cc:1223
</I>&gt;<i> #23 0x000000000072fc10 in CommCbMemFunT&lt;HttpStateData,
</I>&gt;<i> CommIoCbParams&gt;::doDial (this=0x1285f80) at CommCalls.h:205
</I>&gt;<i> #24 0x0000000000730070 in JobDialer&lt;HttpStateData&gt;::dial (this=0x1285f80,
</I>&gt;<i> call=...) at base/AsyncJobCalls.h:174
</I>&gt;<i> #25 0x000000000072f728 in AsyncCallT&lt;CommCbMemFunT&lt;HttpStateData,
</I>&gt;<i> CommIoCbParams&gt; &gt;::fire (this=0x1285f50) at ../src/base/AsyncCall.h:145
</I>&gt;<i> #26 0x0000000000887728 in AsyncCall::make (this=0x1285f50) at
</I>&gt;<i> AsyncCall.cc:40
</I>&gt;<i> #27 0x0000000000888270 in AsyncCallQueue::fireNext (this=0xe11e80) at
</I>&gt;<i> AsyncCallQueue.cc:56
</I>&gt;<i> #28 0x0000000000888068 in AsyncCallQueue::fire (this=0xe11e80) at
</I>&gt;<i> AsyncCallQueue.cc:42
</I>&gt;<i> #29 0x00000000006f4948 in EventLoop::dispatchCalls (this=0xfffff17422e8) at
</I>&gt;<i> EventLoop.cc:144
</I>&gt;<i> #30 0x00000000006f485c in EventLoop::runOnce (this=0xfffff17422e8) at
</I>&gt;<i> EventLoop.cc:121
</I>&gt;<i> #31 0x00000000006f46a0 in EventLoop::run (this=0xfffff17422e8) at
</I>&gt;<i> EventLoop.cc:83
</I>&gt;<i> #32 0x000000000076090c in SquidMain (argc=4, argv=0xfffff1742638) at
</I>&gt;<i> main.cc:1709
</I>&gt;<i> #33 0x000000000075fe70 in SquidMainSafe (argc=4, argv=0xfffff1742638) at
</I>&gt;<i> main.cc:1417
</I>&gt;<i> #34 0x000000000075fe3c in main (argc=4, argv=0xfffff1742638) at main.cc:1405
</I>&gt;<i> 
</I>&gt;<i> When theLevels is initialized, the assigned value is a multiple of 4 and is
</I>&gt;<i> not aligned with the unsigned long.
</I>&gt;<i> Atomic operations on arm only support aligned address access.
</I>&gt;<i> This problem has not been encountered on the x86 platform.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> In the previous reply, there was another question that was not answered.
</I>&gt;<i> 
</I>&gt;&gt;<i> I tried another way to ensure that the theCapacity  parameter passed in to
</I>&gt;&gt;<i> an even number also solves this problem.
</I>&gt;<i> 
</I>&gt;<i> Keep the item type uint32_t, modify the NoteMemoryNeeds method in the
</I>&gt;<i> IpcIoFile.cc file in NotePageNeed as follows
</I>&gt;<i> 
</I>&gt;<i>  Ipc:: Mem:: NotePageNeed(Ipc::Mem::PageId::ioPage,static_cast
</I>&gt;<i> &lt;int&gt;(itemsCount * 1.1)+ static_cast &lt; Int&gt;(itemsCount * 1.1)%2); 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> This modification ensures that the value obtained by the theCapacity
</I>&gt;<i> parameter is even&#65292;which also solves this problem.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> After your analysis, please evaluate whether this method is reasonable&#65292;thank
</I>&gt;<i> you.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Regards&#65292;
</I>&gt;<i> hindsight
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="021284.html">[squid-users] Squid crash - 3.5.21
</A></li>
	<LI>Next message (by thread): <A HREF="021304.html">[squid-users] Squid crash - 3.5.21
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21285">[ date ]</a>
              <a href="thread.html#21285">[ thread ]</a>
              <a href="subject.html#21285">[ subject ]</a>
              <a href="author.html#21285">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
