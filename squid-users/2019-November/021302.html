<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] acl whitelist ssl::server_name not working
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20acl%20whitelist%20ssl%3A%3Aserver_name%20not%20working&In-Reply-To=%3Cc70eae84-f8f6-4e88-8fc3-52d112237f19%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="021295.html">
   <LINK REL="Next"  HREF="021299.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] acl whitelist ssl::server_name not working</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20acl%20whitelist%20ssl%3A%3Aserver_name%20not%20working&In-Reply-To=%3Cc70eae84-f8f6-4e88-8fc3-52d112237f19%40measurement-factory.com%3E"
       TITLE="[squid-users] acl whitelist ssl::server_name not working">rousskov at measurement-factory.com
       </A><BR>
    <I>Thu Nov 14 23:07:41 UTC 2019</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="021295.html">[squid-users] acl whitelist ssl::server_name not working
</A></li>
        <LI>Next message (by thread): <A HREF="021299.html">[squid-users] difference of settings doing the same as it seems
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21302">[ date ]</a>
              <a href="thread.html#21302">[ thread ]</a>
              <a href="subject.html#21302">[ subject ]</a>
              <a href="author.html#21302">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 11/14/19 12:29 PM, John Lowry wrote:
&gt;<i> I have been able to set up Squid as a transparent proxy that splices
</I>&gt;<i> HTTPS connections.
</I>
&gt;<i> now I'm trying to use ACLs to whitelist by hostname.
</I>&gt;<i> 
</I>&gt;<i> acl whitelist ssl::server_name &quot;/etc/squid/whitelist.txt&quot; --client-requested
</I>

FWIW, I do not know whether the above syntax is supported. I recommend
starting with a single whitelisted name. For example:

  acl whitelist ssl::server_name --client-requested example.com

and then, if the above works, migrate to importing parameters from a
file (but start with one domain name in that file):

  acl whitelist ssl::server_name --client-requested
&quot;/etc/squid/whitelist.txt&quot;


&gt;<i> But I can't get it to work.The logs appeared to indicate that URLs in
</I>&gt;<i> the whitelist were first denied then bumped:
</I>&gt;<i> 
</I>&gt;<i> 14/Nov/2019:08:46:25 -0800 192.168.2.43 TCP_DENIED/- 0 CONNECT
</I>&gt;<i> 104.17.67.73:443 - HIER_NONE/- - www.headroyce.org
</I>&gt;<i> 14/Nov/2019:08:46:25 -0800 192.168.2.43 NONE/- 3793 GET
</I>&gt;<i> <A HREF="https://www.headroyce.org/">https://www.headroyce.org/</A> - HIER_NONE/- text/html www.headroyce.org
</I>&gt;<i> 
</I>&gt;<i> I think that the ACLs are trying to match a spliced connection against
</I>&gt;<i> the IP address rather than SNI server name.
</I>&gt;<i> 
</I>&gt;<i> Any idea what I'm doing wrong here?
</I>
If you only want to act based on SNI, then do not use an http_access
rule during step1 when SNI is not yet known. There may be several ways
to accomplish that. However, in most cases, you want to act ASAP,
regardless of whether the [sufficient] information came from the TCP
layer or the TLS layer. If that is your use case, then it is OK to apply
the http_access rule during step1 as well (assuming your ACL will simply
not match when there is not enough information yet).


&gt;<i> http_access allow whitelist
</I>
Even if the request is for an &quot;unsafe&quot; port? I doubt you want this rule
so high. See squid.conf.default for the recommended access controls order.


&gt;<i> http_access deny !Safe_ports
</I>&gt;<i> http_access deny CONNECT !SSL_ports
</I>&gt;<i> http_access allow localhost manager
</I>&gt;<i> http_access deny manager
</I>&gt;<i> include /etc/squid/conf.d/*
</I>&gt;<i> http_access allow localhost
</I>&gt;<i> http_access deny all
</I>
FYI: The last rule will deny access to non-localhost CONNECT requests
during step1 if they do not carry enough information to qualify for the
whitelist exception.

Keep in mind that http_access rules are evaluated several times during a
single master transaction. For details, please see
<A HREF="https://wiki.squid-cache.org/Features/SslPeekAndSplice">https://wiki.squid-cache.org/Features/SslPeekAndSplice</A>


HTH,

Alex.

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="021295.html">[squid-users] acl whitelist ssl::server_name not working
</A></li>
	<LI>Next message (by thread): <A HREF="021299.html">[squid-users] difference of settings doing the same as it seems
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21302">[ date ]</a>
              <a href="thread.html#21302">[ thread ]</a>
              <a href="subject.html#21302">[ subject ]</a>
              <a href="author.html#21302">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
