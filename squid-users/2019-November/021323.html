<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] squid 4.1 transparent https issue &quot;curl: (60) SSL certificate problem: self signed certificate in certificate chain&quot;
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid%204.1%20transparent%20https%20issue%20%22curl%3A%20%2860%29%20SSL%0A%20certificate%20problem%3A%20self%20signed%20certificate%20in%20certificate%20chain%22&In-Reply-To=%3CHE1PR0401MB2651DA06D0A789EB75BC24E6F84E0%40HE1PR0401MB2651.eurprd04.prod.outlook.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="021319.html">
   <LINK REL="Next"  HREF="021321.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] squid 4.1 transparent https issue &quot;curl: (60) SSL certificate problem: self signed certificate in certificate chain&quot;</H1>
    <B>Berger J Nicklas</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid%204.1%20transparent%20https%20issue%20%22curl%3A%20%2860%29%20SSL%0A%20certificate%20problem%3A%20self%20signed%20certificate%20in%20certificate%20chain%22&In-Reply-To=%3CHE1PR0401MB2651DA06D0A789EB75BC24E6F84E0%40HE1PR0401MB2651.eurprd04.prod.outlook.com%3E"
       TITLE="[squid-users] squid 4.1 transparent https issue &quot;curl: (60) SSL certificate problem: self signed certificate in certificate chain&quot;">nicklas.berger at scania.com
       </A><BR>
    <I>Thu Nov 21 08:21:57 UTC 2019</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="021319.html">[squid-users] squid 4.1 transparent https issue &quot;curl: (60) SSL certificate problem: self signed certificate in certificate chain&quot;
</A></li>
        <LI>Next message (by thread): <A HREF="021321.html">[squid-users] Problem with ssl_choose_client_version:inappropriate fallback on some sites when using TLS1.2
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21323">[ date ]</a>
              <a href="thread.html#21323">[ thread ]</a>
              <a href="subject.html#21323">[ subject ]</a>
              <a href="author.html#21323">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>A colleague provided this squid.conf and now https working fine with curl as well!

visible_hostname localhost

# Handling HTTP requests
http_port 3128
http_port 3129 intercept

acl allowed_http_sites dstdomain .microsoft.com
acl allowed_http_sites dstdomain .google.com
acl allowed_http_sites dstdomain .redhat.com


http_access allow allowed_http_sites

# Handling HTTPS requests
acl SSL_port port 443
http_access allow SSL_port

acl allowed_https_sites ssl::server_name .microsoft.com
acl allowed_https_sites ssl::server_name .google.com
acl allowed_https_sites ssl::server_name .redhat.com

https_port 3130 intercept ssl-bump connection-auth=off generate-host-certificates=on dynamic_cert_mem_cache_size=16MB cert=/etc/squid/ssl/squid.pem key=/etc/squid/ssl/squid.key

acl step1 at_step SslBump1
acl step2 at_step SslBump2
acl step3 at_step SslBump3

ssl_bump peek step1 all
ssl_bump peek step2 allowed_https_sites
ssl_bump splice step3 allowed_https_sites
ssl_bump terminate

http_access deny all
________________________________
From: squid-users &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>&gt; on behalf of Alex Rousskov &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt;
Sent: Wednesday, November 20, 2019 17:43
To: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A> &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>&gt;
Subject: Re: [squid-users] squid 4.1 transparent https issue &quot;curl: (60) SSL certificate problem: self signed certificate in certificate chain&quot;

On 11/20/19 3:31 AM, Berger J Nicklas wrote:

&gt;<i> squid 4.1
</I>
Start by upgrading to the latest Squid v4 available.


&gt;<i> curl: (60) SSL certificate problem: self signed certificate in
</I>&gt;<i> certificate chain
</I>
What was Squid trying to tell curl? Was Squid sending an error response?
Tell curl to run --insecure to find out what happened.


&gt;<i> security_file_certgen helper database '/var/spool/squid/ssl_db' failed:
</I>&gt;<i> Failed to open file /var/spool/squid/ssl_db/index.txt
</I>
You should fix this. Perhaps you did not initialize the database (see
&quot;man security_file_certgen&quot;)? Or perhaps the permissions are wrong
(checks them using something like &quot;ls -Rla /var/spool/squid/ssl_db&quot;)?

&gt;<i> acl allowed_http_sites dstdomain .microsoft.com
</I>&gt;<i> acl allowed_http_sites dstdomain .google.com
</I>&gt;<i> acl allowed_http_sites dstdomain .redhat.com
</I>
&gt;<i> http_access allow allowed_http_sites Safe_ports
</I>
This allows CONNECT to port 80, which is probably not what you want. See
squid.conf.default for the recommended layout of https_access rules.


&gt;<i> #SSL Settings
</I>&gt;<i> acl allowed_https_sites dstdomain .microsoft.com
</I>
Do not add one site twice.


&gt;<i> http_access allow CONNECT allowed_https_sites
</I>
This allows CONNECT to any port of the allowed_https_sites. See
squid.conf.default for the recommended layout of https_access rules.


&gt;<i> options=SINGLE_DH_USE,SINGLE_ECDH_USE tls-dh=/etc/squid/dhparam.pem
</I>
A copy-paste typo? There is no &quot;options=...&quot; directive.


&gt;<i> http_access deny all
</I>&gt;<i> http_access deny !Safe_ports
</I>&gt;<i> http_access deny CONNECT !SSL_ports
</I>
The last two lines are unreachable. You probably want to review how
http_access (and most other) ACL-driven directives work, including the
&quot;first match ends the search&quot; rule.

&gt;<i> ssl_bump peek step1 all
</I>&gt;<i> ssl_bump peek step2 allowed_https_sites
</I>&gt;<i> ssl_bump splice step2 allowed_https_sites
</I>&gt;<i> ssl_bump splice step3 allowed_https_sites
</I>&gt;<i> ssl_bump terminate step2 all
</I>&gt;<i> ssl_bump bump all
</I>
To learn how ssl_bump rules work, please see
<A HREF="https://wiki.squid-cache.org/Features/SslPeekAndSplice">https://wiki.squid-cache.org/Features/SslPeekAndSplice</A>

AFAICT, the above rules are equivalent to:

  ssl_bump peek step1
  ssl_bump peek step2 allowed_https_sites
  ssl_bump terminate step2
  ssl_bump splice all

or, roughly speaking, &quot;splice allowed_https_sites (after peeking at
their server) and terminate everything else (ASAP)&quot;

... which is rather different from what the original rules may have
tried to accomplish (whatever that was).


HTH,

Alex.
_______________________________________________
squid-users mailing list
<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
<A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20191121/ef12b2bc/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20191121/ef12b2bc/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="021319.html">[squid-users] squid 4.1 transparent https issue &quot;curl: (60) SSL certificate problem: self signed certificate in certificate chain&quot;
</A></li>
	<LI>Next message (by thread): <A HREF="021321.html">[squid-users] Problem with ssl_choose_client_version:inappropriate fallback on some sites when using TLS1.2
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21323">[ date ]</a>
              <a href="thread.html#21323">[ thread ]</a>
              <a href="subject.html#21323">[ subject ]</a>
              <a href="author.html#21323">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
