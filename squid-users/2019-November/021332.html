<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] logformat for requests using PROXY protocol
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20logformat%20for%20requests%20using%20PROXY%20protocol&In-Reply-To=%3CCAKZYigFFXj8nojT4YMEEV8qWh1OFV5qA3UP_yJKo7aV6RsuhFg%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="021305.html">
   <LINK REL="Next"  HREF="021334.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] logformat for requests using PROXY protocol</H1>
    <B>Chammi Kumarapathirage</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20logformat%20for%20requests%20using%20PROXY%20protocol&In-Reply-To=%3CCAKZYigFFXj8nojT4YMEEV8qWh1OFV5qA3UP_yJKo7aV6RsuhFg%40mail.gmail.com%3E"
       TITLE="[squid-users] logformat for requests using PROXY protocol">chammidhan at gmail.com
       </A><BR>
    <I>Fri Nov 22 03:05:18 UTC 2019</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="021305.html">[squid-users] logformat for requests using PROXY protocol
</A></li>
        <LI>Next message (by thread): <A HREF="021334.html">[squid-users] logformat for requests using PROXY protocol
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21332">[ date ]</a>
              <a href="thread.html#21332">[ thread ]</a>
              <a href="subject.html#21332">[ subject ]</a>
              <a href="author.html#21332">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I have my logformat as follows.
logformat jsonformat {&quot;Client Hostname&quot;:&quot;%&gt;A&quot;,&quot;Source IP&quot;:&quot;%&gt;a&quot;,&quot;HTTP Method
&quot;:&quot;%rm&quot;,&quot;HTTP Protocol version&quot;:&quot;%rv&quot;,&quot;Request Domain&quot;:&quot;%&gt;rd&quot;,&quot;Port&quot;:&quot;%&gt;rP&quot;,
&quot;User Agent&quot;:&quot;%{User-Agent}&gt;h&quot;,&quot;Request Size&quot;:&quot;%&gt;st&quot;,&quot;Reply
Size&quot;:&quot;%&lt;st&quot;,&quot;Response
Time(ms)&quot;:&quot;%tr&quot;,&quot;Status Code&quot;:&quot;%&gt;Hs&quot;,&quot;Request Status&quot;:&quot;%Ss&quot;,&quot;Server FQDN&quot;:&quot;
%&lt;A&quot;}

The proxy is sitting behind a load balancer in AWS and Proxy Protocol V2 is
enabled on both the LB and Squid. Everything seems to work fine. I can
create rules based on source IP of the client. However. I want to be able
to  create rules based on the hostname of the original client. But it
doesn't seem that Squid sees the original client's hostname. Rather it
takes the hostname of the LB as seen by below log.

{ &quot;Client Hostname&quot;: &quot;ip-10-181-3-213.ap-southeast-2.compute.internal&quot;, &quot;Source
IP&quot;: &quot;10.181.3.10&quot;, &quot;HTTP Method&quot;: &quot;CONNECT&quot;, &quot;HTTP Protocol version&quot;: &quot;1.1&quot;,
&quot;Request Domain&quot;: &quot;clientservices.googleapis.com&quot;, &quot;Port&quot;: &quot;443&quot;, &quot;User
Agent&quot;: &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36
(KHTML, like Gecko) Chrome/78.0.3904.97 Safari/537.36&quot;, &quot;Request Size&quot;:
&quot;253&quot;, &quot;Reply Size&quot;: &quot;4138&quot;, &quot;Response Time(ms)&quot;: &quot;0&quot;, &quot;Status Code&quot;: &quot;403&quot;,
&quot;Request Status&quot;: &quot;TCP_DENIED&quot;, &quot;Server FQDN&quot;: &quot;-&quot; }

On Fri, Nov 15, 2019 at 3:15 PM Amos Jeffries &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt; wrote:

&gt;<i> On 15/11/19 2:56 pm, chammidhan wrote:
</I>&gt;<i> &gt; I have configured a Squid ECS cluster behind a network load balancer in
</I>&gt;<i> AWS.
</I>&gt;<i> &gt; To reflect the original client IP, I needed to enable PROXY Protocol V2
</I>&gt;<i> on
</I>&gt;<i> &gt; the load balancer. The service itself is working fine and I can create
</I>&gt;<i> rules
</I>&gt;<i> &gt; based on the original client IP and these are applied as expected.
</I>&gt;<i> However,
</I>&gt;<i> &gt; it doesn't seem that logformat format codes are working as expected. No
</I>&gt;<i> &gt; matter how I format the logs, I'm always seeing the logs in the same
</I>&gt;<i> format.
</I>&gt;<i> &gt; Which looks like below.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; 1573771498.693 240116 10.181.3.10 TCP_TUNNEL/200 1742 CONNECT
</I>&gt;<i> &gt; id.google.com:443 - HIER_DIRECT/172.217.167.67 -
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; My logformat directive is the default
</I>&gt;<i> &gt; logformat squid %{%Y/%m/%d-%H:%M:%S}tl %&gt;A/%&gt;a %un %rm/%rv %ru %mt
</I>&gt;<i> &gt; %{User-Agent}&gt;h %&gt;st/%&lt;st %tr %&gt;Hs %Ss %Sh/%&lt;A
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Appreciate any insight to what I may be doing wrong. Things were working
</I>&gt;<i> &gt; fine before enabling PROXY protocol on the NLB
</I>&gt;<i> &gt;
</I>&gt;<i>
</I>&gt;<i> Please run &quot;squid -k parse&quot; on your config and fix the errors and
</I>&gt;<i> warnings it produces.
</I>&gt;<i>
</I>&gt;<i> &quot;
</I>&gt;<i> 2019/11/15 18:11:50| Processing: logformat squid %{%Y/%m/%d-...
</I>&gt;<i> 2019/11/15 18:11:50| ERROR: logformat squid is already defined. Ignoring.
</I>&gt;<i> &quot;
</I>&gt;<i>
</I>&gt;<i> To use a custom log format you need a custom name.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Amos
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20191122/e97c68ce/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20191122/e97c68ce/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="021305.html">[squid-users] logformat for requests using PROXY protocol
</A></li>
	<LI>Next message (by thread): <A HREF="021334.html">[squid-users] logformat for requests using PROXY protocol
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21332">[ date ]</a>
              <a href="thread.html#21332">[ thread ]</a>
              <a href="subject.html#21332">[ subject ]</a>
              <a href="author.html#21332">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
