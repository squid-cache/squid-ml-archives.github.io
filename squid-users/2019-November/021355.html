<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] What is the proper way to close an ICAP	transaction?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20What%20is%20the%20proper%20way%20to%20close%20an%20ICAP%0A%09transaction%3F&In-Reply-To=%3CCADcj3%3D6f-WVK2d9rkb9m5MNjNrmmU-70Om3XyABOv0m-nOyyOg%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="021354.html">
   <LINK REL="Next"  HREF="021356.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] What is the proper way to close an ICAP	transaction?</H1>
    <B>Felipe Arturo Polanco</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20What%20is%20the%20proper%20way%20to%20close%20an%20ICAP%0A%09transaction%3F&In-Reply-To=%3CCADcj3%3D6f-WVK2d9rkb9m5MNjNrmmU-70Om3XyABOv0m-nOyyOg%40mail.gmail.com%3E"
       TITLE="[squid-users] What is the proper way to close an ICAP	transaction?">felipeapolanco at gmail.com
       </A><BR>
    <I>Tue Nov 26 19:52:58 UTC 2019</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="021354.html">[squid-users] What is the proper way to close an ICAP	transaction?
</A></li>
        <LI>Next message (by thread): <A HREF="021356.html">[squid-users] What is the proper way to close an ICAP	transaction?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21355">[ date ]</a>
              <a href="thread.html#21355">[ thread ]</a>
              <a href="subject.html#21355">[ subject ]</a>
              <a href="author.html#21355">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

We are sending an encapsulated HTTP 307 redirect webpage header whenever a
Virus is found and stop sending any other data after that, but squid
complains about ICAP failure when we do that:
Adaptation::Icap::Xaction::noteCommRead threw exception: corrupted chunk
size

We are not sending an ICAP header at this point because we already told
Squid ICAP 200 OK header and begun a body transaction, we send some chunks
back to the client for progress and hold the last part for scanning.

Ideally, we would like to just send our 307 to Squid and not having it
count as a failure.

On Tue, Nov 26, 2019 at 3:44 PM Alex Rousskov &lt;
<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt; wrote:

&gt;<i> On 11/26/19 10:15 AM, Felipe Arturo Polanco wrote:
</I>&gt;<i>
</I>&gt;<i> &gt; While we can successfully scan our files and do content adaptation, we
</I>&gt;<i> &gt; have been struggling to find a way to close the ICAP transaction before
</I>&gt;<i> &gt; passing the whole body back to squid and at the same time avoid squid
</I>&gt;<i> &gt; marking one icap failure.
</I>&gt;<i>
</I>&gt;<i> Squid needs a valid ICAP response. The right ICAP response status code
</I>&gt;<i> depends on what you want Squid to do after receiving that response. You
</I>&gt;<i> have mentioned what you do _not_ want Squid to do (i.e. increase the
</I>&gt;<i> failure count), but that still leaves a lot of options.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; This is for an ICAP server that does Virus scanning and if virus found,
</I>&gt;<i> &gt; the body is not sent back.
</I>&gt;<i>
</I>&gt;<i> What do you want Squid to do when the ICAP service finds a virus? For
</I>&gt;<i> example, what message do you want Squid to send to the next HTTP hop?
</I>&gt;<i>
</I>&gt;<i> Alex.
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20191126/180e7ac5/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20191126/180e7ac5/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="021354.html">[squid-users] What is the proper way to close an ICAP	transaction?
</A></li>
	<LI>Next message (by thread): <A HREF="021356.html">[squid-users] What is the proper way to close an ICAP	transaction?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21355">[ date ]</a>
              <a href="thread.html#21355">[ thread ]</a>
              <a href="subject.html#21355">[ subject ]</a>
              <a href="author.html#21355">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
