<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] What is the proper way to close an ICAP	transaction?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20What%20is%20the%20proper%20way%20to%20close%20an%20ICAP%0A%09transaction%3F&In-Reply-To=%3C6b22633b-9daf-71aa-cd91-1e9d48fd2942%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="021370.html">
   <LINK REL="Next"  HREF="021372.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] What is the proper way to close an ICAP	transaction?</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20What%20is%20the%20proper%20way%20to%20close%20an%20ICAP%0A%09transaction%3F&In-Reply-To=%3C6b22633b-9daf-71aa-cd91-1e9d48fd2942%40measurement-factory.com%3E"
       TITLE="[squid-users] What is the proper way to close an ICAP	transaction?">rousskov at measurement-factory.com
       </A><BR>
    <I>Wed Nov 27 16:44:51 UTC 2019</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="021370.html">[squid-users] What is the proper way to close an ICAP	transaction?
</A></li>
        <LI>Next message (by thread): <A HREF="021372.html">[squid-users] What is the proper way to close an ICAP	transaction?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21371">[ date ]</a>
              <a href="thread.html#21371">[ thread ]</a>
              <a href="subject.html#21371">[ subject ]</a>
              <a href="author.html#21371">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 11/27/19 11:01 AM, Felipe Arturo Polanco wrote:

&gt;<i> How can we then terminate an ICAP 200 OK transaction to squid without
</I>&gt;<i> sending the complete body back to it? We don't want squid to mark an
</I>&gt;<i> ICAP failure on us if we just close the TCP connection.
</I>
To properly answer your question, I have to come back to the question I
asked earlier: What do you want Squid to do when your ICAP service finds
a virus after trickling a few virgin HTTP body bytes to the HTTP client?

The &quot;we want Squid to send an HTTP 307 redirect to the client&quot; desire
you responded with earlier was ruled impossible to satisfy in your
trickling environment. A few realistic options remain though, including:

1. Terminate Squid-to-client transmission as if the whole virgin HTTP
response body was sent to the client.

2. Terminate Squid-to-client transmission while indicating (to that same
client) that the HTTP response body was cut short (i.e. that the
delivery of the response was aborted).

3. #2 plus annotate the transaction specially in Squid access.log and/or
detect this special outcome using Squid ACLs.

Alex.


&gt;<i> On Wed, Nov 27, 2019 at 10:54 AM Alex Rousskov wrote:
</I>&gt;<i> 
</I>&gt;<i>     On 11/26/19 4:12 PM, Felipe Arturo Polanco wrote:
</I>&gt;<i> 
</I>&gt;<i>     &gt; The flow is the following:
</I>&gt;<i>     &gt; ICAP transaction is sent to ICAP server with a PREVIEW header
</I>&gt;<i>     &gt; ICAP server sends ICAP header 100 Continue
</I>&gt;<i>     &gt; ICAP server sends ICAP header 200 OK to start data transfer
</I>&gt;<i> 
</I>&gt;<i>     (*) Your notes below imply that the ICAP server also sends the embedded
</I>&gt;<i>     HTTP message header back to Squid (and not just the ICAP 200 header).
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i>     &gt; &lt;data transfer begins&gt;
</I>&gt;<i>     &gt; ICAP server receives a chunk, checks if its the last chunk, if not
</I>&gt;<i>     then
</I>&gt;<i>     &gt; append to temp file and send it back to Squid;
</I>&gt;<i> 
</I>&gt;<i>     The &quot;send it back to Squid&quot; part implies that not only your ICAP server
</I>&gt;<i>     sent an ICAP 200 response header, but it sent the HTTP message header as
</I>&gt;<i>     well. See (*) above. Once the ICAP server sent the HTTP message header,
</I>&gt;<i>     it is committed to finish sending that HTTP message (and nothing else).
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i>     &gt; if it is the last chunk then analyze the temp file for virus.
</I>&gt;<i>     &gt; &lt;repeat for next data transfer&gt;
</I>&gt;<i>     &gt; If virus found then send encapsulated HTTP header 307 redirect.
</I>&gt;<i> 
</I>&gt;<i>     This is an ICAP service bug: One cannot send a second encapsulated HTTP
</I>&gt;<i>     message in one ICAP response. A single ICAP response cannot contain
</I>&gt;<i>     multiple HTTP messages. The ICAP protocol does not allow for that, and
</I>&gt;<i>     there would be no way to actually support something like that in an ICAP
</I>&gt;<i>     client because the HTTP message cannot be interrupted and replaced with
</I>&gt;<i>     another mid-flight. You may assume that the HTTP client is already
</I>&gt;<i>     seeing the beginning of the first HTTP response. The train has left the
</I>&gt;<i>     station.
</I>&gt;<i> 
</I>&gt;<i>     If the above is accurate, and you are using the ICAP service correctly,
</I>&gt;<i>     then the ICAP service that allowed you to do the above is badly broken,
</I>&gt;<i>     probably written by somebody who thought that ICAP is &quot;easy&quot;. You may be
</I>&gt;<i>     better off reusing an existing higher-quality ICAP service instead.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i>     &gt; If virus not found, send the last chunk to squid.
</I>&gt;<i>     &gt;
</I>&gt;<i>     &gt; The part where we send 307 is the part that Squid doesn't like, I
</I>&gt;<i>     &gt; believe is because we are not sending the last chunk since the
</I>&gt;<i>     file is a
</I>&gt;<i>     &gt; virus.
</I>&gt;<i> 
</I>&gt;<i>     Not exactly: Even if you send the last HTTP chunk, you would not be able
</I>&gt;<i>     to follow up with an HTTP 307 message. The HTTP fate of this transaction
</I>&gt;<i>     was sealed when you started trickling virgin HTTP message pieces back to
</I>&gt;<i>     Squid (and, hence, back to the HTTP client talking to Squid).
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i>     HTH,
</I>&gt;<i> 
</I>&gt;<i>     Alex.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i>     &gt; On Tue, Nov 26, 2019 at 4:52 PM Alex Rousskov wrote:
</I>&gt;<i>     &gt;
</I>&gt;<i>     &gt;&#160; &#160; &#160;On 11/26/19 2:52 PM, Felipe Arturo Polanco wrote:
</I>&gt;<i>     &gt;
</I>&gt;<i>     &gt;&#160; &#160; &#160; &gt; We are sending an encapsulated HTTP 307 redirect webpage header
</I>&gt;<i>     &gt;&#160; &#160; &#160;whenever
</I>&gt;<i>     &gt;&#160; &#160; &#160; &gt; a Virus is found and stop sending any other data after that
</I>&gt;<i>     &gt;
</I>&gt;<i>     &gt;&#160; &#160; &#160;You must use ICAP status code 200 then. Make sure your
</I>&gt;<i>     encapsulated HTTP
</I>&gt;<i>     &gt;&#160; &#160; &#160;307 body (if any) is properly sent to Squid.
</I>&gt;<i>     &gt;
</I>&gt;<i>     &gt;
</I>&gt;<i>     &gt;&#160; &#160; &#160; &gt; but squid
</I>&gt;<i>     &gt;&#160; &#160; &#160; &gt; complains about ICAP failure when we do that:
</I>&gt;<i>     &gt;&#160; &#160; &#160; &gt; Adaptation::Icap::Xaction::noteCommRead threw exception:
</I>&gt;<i>     &gt;&#160; &#160; &#160;corrupted chunk
</I>&gt;<i>     &gt;&#160; &#160; &#160; &gt; size
</I>&gt;<i>     &gt;
</I>&gt;<i>     &gt;&#160; &#160; &#160;What chunk size did Squid not like? You should be able to tell by
</I>&gt;<i>     &gt;&#160; &#160; &#160;looking at the packet capture of the failed transaction (or
</I>&gt;<i>     low-level
</I>&gt;<i>     &gt;&#160; &#160; &#160;Squid debugging).
</I>&gt;<i>     &gt;
</I>&gt;<i>     &gt;
</I>&gt;<i>     &gt;&#160; &#160; &#160; &gt; We are not sending an ICAP header at this point because we
</I>&gt;<i>     &gt;&#160; &#160; &#160;already told
</I>&gt;<i>     &gt;&#160; &#160; &#160; &gt; Squid ICAP 200 OK header and begun a body transaction, we
</I>&gt;<i>     send some
</I>&gt;<i>     &gt;&#160; &#160; &#160; &gt; chunks back to the client for progress and hold the last
</I>&gt;<i>     part for
</I>&gt;<i>     &gt;&#160; &#160; &#160;scanning.
</I>&gt;<i>     &gt;
</I>&gt;<i>     &gt;&#160; &#160; &#160;Are you sending HTTP 307 body chunks to Squid? How do you
</I>&gt;<i>     indicate that
</I>&gt;<i>     &gt;&#160; &#160; &#160;no more chunks will be coming?
</I>&gt;<i>     &gt;
</I>&gt;<i>     &gt;&#160; &#160; &#160;It sounds like you are trying to cram two HTTP messages (one
</I>&gt;<i>     with the
</I>&gt;<i>     &gt;&#160; &#160; &#160;original HTTP response body prefix and one with a generated 307
</I>&gt;<i>     &gt;&#160; &#160; &#160;redirect) into one ICAP response, which is impossible, but
</I>&gt;<i>     perhaps I
</I>&gt;<i>     &gt;&#160; &#160; &#160;misunderstood your description. It would help if you post a
</I>&gt;<i>     sample (but
</I>&gt;<i>     &gt;&#160; &#160; &#160;complete) ICAP response that Squid does not like.
</I>&gt;<i>     &gt;
</I>&gt;<i>     &gt;
</I>&gt;<i>     &gt;&#160; &#160; &#160; &gt; Ideally, we would like to just send our 307 to Squid and not
</I>&gt;<i>     &gt;&#160; &#160; &#160;having it
</I>&gt;<i>     &gt;&#160; &#160; &#160; &gt; count as a failure.
</I>&gt;<i>     &gt;
</I>&gt;<i>     &gt;&#160; &#160; &#160;Yes, a 200 ICAP response with an embedded HTTP 307 response
</I>&gt;<i>     should work
</I>&gt;<i>     &gt;&#160; &#160; &#160;just fine, but all its pieces should be properly formed (and there
</I>&gt;<i>     &gt;&#160; &#160; &#160;should be no extras).
</I>&gt;<i>     &gt;
</I>&gt;<i>     &gt;&#160; &#160; &#160;Alex.
</I>&gt;<i>     &gt;
</I>&gt;<i>     &gt;
</I>&gt;<i>     &gt;&#160; &#160; &#160; &gt; On Tue, Nov 26, 2019 at 3:44 PM Alex Rousskov wrote:
</I>&gt;<i>     &gt;&#160; &#160; &#160; &gt;
</I>&gt;<i>     &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160;On 11/26/19 10:15 AM, Felipe Arturo Polanco wrote:
</I>&gt;<i>     &gt;&#160; &#160; &#160; &gt;
</I>&gt;<i>     &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160;&gt; While we can successfully scan our files and do content
</I>&gt;<i>     &gt;&#160; &#160; &#160;adaptation, we
</I>&gt;<i>     &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160;&gt; have been struggling&#160;to find a way to close the ICAP
</I>&gt;<i>     &gt;&#160; &#160; &#160;transaction
</I>&gt;<i>     &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160;before
</I>&gt;<i>     &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160;&gt; passing the whole body back to squid and at the same time
</I>&gt;<i>     &gt;&#160; &#160; &#160;avoid squid
</I>&gt;<i>     &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160;&gt; marking one icap failure.
</I>&gt;<i>     &gt;&#160; &#160; &#160; &gt;
</I>&gt;<i>     &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160;Squid needs a valid ICAP response. The right ICAP response
</I>&gt;<i>     &gt;&#160; &#160; &#160;status code
</I>&gt;<i>     &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160;depends on what you want Squid to do after receiving that
</I>&gt;<i>     &gt;&#160; &#160; &#160;response. You
</I>&gt;<i>     &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160;have mentioned what you do _not_ want Squid to do (i.e.
</I>&gt;<i>     &gt;&#160; &#160; &#160;increase the
</I>&gt;<i>     &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160;failure count), but that still leaves a lot of options.
</I>&gt;<i>     &gt;&#160; &#160; &#160; &gt;
</I>&gt;<i>     &gt;&#160; &#160; &#160; &gt;
</I>&gt;<i>     &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160;&gt; This is for an ICAP server that does Virus scanning
</I>&gt;<i>     and if
</I>&gt;<i>     &gt;&#160; &#160; &#160;virus
</I>&gt;<i>     &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160;found,
</I>&gt;<i>     &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160;&gt; the body is not sent back.
</I>&gt;<i>     &gt;&#160; &#160; &#160; &gt;
</I>&gt;<i>     &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160;What do you want Squid to do when the ICAP service finds a
</I>&gt;<i>     &gt;&#160; &#160; &#160;virus? For
</I>&gt;<i>     &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160;example, what message do you want Squid to send to the next
</I>&gt;<i>     &gt;&#160; &#160; &#160;HTTP hop?
</I>&gt;<i>     &gt;&#160; &#160; &#160; &gt;
</I>&gt;<i>     &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160;Alex.
</I>&gt;<i>     &gt;&#160; &#160; &#160; &gt;
</I>&gt;<i>     &gt;
</I>&gt;<i> 
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="021370.html">[squid-users] What is the proper way to close an ICAP	transaction?
</A></li>
	<LI>Next message (by thread): <A HREF="021372.html">[squid-users] What is the proper way to close an ICAP	transaction?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21371">[ date ]</a>
              <a href="thread.html#21371">[ thread ]</a>
              <a href="subject.html#21371">[ subject ]</a>
              <a href="author.html#21371">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
