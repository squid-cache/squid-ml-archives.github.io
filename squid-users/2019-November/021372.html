<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] What is the proper way to close an ICAP	transaction?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20What%20is%20the%20proper%20way%20to%20close%20an%20ICAP%0A%09transaction%3F&In-Reply-To=%3CCADcj3%3D7WTWzVb2G%2BbnM12BiWPiOb15aXH-fSEp75rbERC%2BMeLw%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="021371.html">
   <LINK REL="Next"  HREF="021373.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] What is the proper way to close an ICAP	transaction?</H1>
    <B>Felipe Arturo Polanco</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20What%20is%20the%20proper%20way%20to%20close%20an%20ICAP%0A%09transaction%3F&In-Reply-To=%3CCADcj3%3D7WTWzVb2G%2BbnM12BiWPiOb15aXH-fSEp75rbERC%2BMeLw%40mail.gmail.com%3E"
       TITLE="[squid-users] What is the proper way to close an ICAP	transaction?">felipeapolanco at gmail.com
       </A><BR>
    <I>Wed Nov 27 18:42:10 UTC 2019</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="021371.html">[squid-users] What is the proper way to close an ICAP	transaction?
</A></li>
        <LI>Next message (by thread): <A HREF="021373.html">[squid-users] What is the proper way to close an ICAP	transaction?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21372">[ date ]</a>
              <a href="thread.html#21372">[ thread ]</a>
              <a href="subject.html#21372">[ subject ]</a>
              <a href="author.html#21372">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Can you describe the process of option 2?

Terminate Squid-to-client transmission while indicating (to that same
client) that the HTTP response body was cut short (i.e. that the
delivery of the response was aborted).

What TCP Flag or ICAP header should the ICAP server send in order to inform
connection aborted??

On Wed, Nov 27, 2019 at 12:44 PM Alex Rousskov &lt;
<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt; wrote:

&gt;<i> On 11/27/19 11:01 AM, Felipe Arturo Polanco wrote:
</I>&gt;<i>
</I>&gt;<i> &gt; How can we then terminate an ICAP 200 OK transaction to squid without
</I>&gt;<i> &gt; sending the complete body back to it? We don't want squid to mark an
</I>&gt;<i> &gt; ICAP failure on us if we just close the TCP connection.
</I>&gt;<i>
</I>&gt;<i> To properly answer your question, I have to come back to the question I
</I>&gt;<i> asked earlier: What do you want Squid to do when your ICAP service finds
</I>&gt;<i> a virus after trickling a few virgin HTTP body bytes to the HTTP client?
</I>&gt;<i>
</I>&gt;<i> The &quot;we want Squid to send an HTTP 307 redirect to the client&quot; desire
</I>&gt;<i> you responded with earlier was ruled impossible to satisfy in your
</I>&gt;<i> trickling environment. A few realistic options remain though, including:
</I>&gt;<i>
</I>&gt;<i> 1. Terminate Squid-to-client transmission as if the whole virgin HTTP
</I>&gt;<i> response body was sent to the client.
</I>&gt;<i>
</I>&gt;<i> 2. Terminate Squid-to-client transmission while indicating (to that same
</I>&gt;<i> client) that the HTTP response body was cut short (i.e. that the
</I>&gt;<i> delivery of the response was aborted).
</I>&gt;<i>
</I>&gt;<i> 3. #2 plus annotate the transaction specially in Squid access.log and/or
</I>&gt;<i> detect this special outcome using Squid ACLs.
</I>&gt;<i>
</I>&gt;<i> Alex.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; On Wed, Nov 27, 2019 at 10:54 AM Alex Rousskov wrote:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     On 11/26/19 4:12 PM, Felipe Arturo Polanco wrote:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     &gt; The flow is the following:
</I>&gt;<i> &gt;     &gt; ICAP transaction is sent to ICAP server with a PREVIEW header
</I>&gt;<i> &gt;     &gt; ICAP server sends ICAP header 100 Continue
</I>&gt;<i> &gt;     &gt; ICAP server sends ICAP header 200 OK to start data transfer
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     (*) Your notes below imply that the ICAP server also sends the
</I>&gt;<i> embedded
</I>&gt;<i> &gt;     HTTP message header back to Squid (and not just the ICAP 200 header).
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     &gt; &lt;data transfer begins&gt;
</I>&gt;<i> &gt;     &gt; ICAP server receives a chunk, checks if its the last chunk, if not
</I>&gt;<i> &gt;     then
</I>&gt;<i> &gt;     &gt; append to temp file and send it back to Squid;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     The &quot;send it back to Squid&quot; part implies that not only your ICAP
</I>&gt;<i> server
</I>&gt;<i> &gt;     sent an ICAP 200 response header, but it sent the HTTP message
</I>&gt;<i> header as
</I>&gt;<i> &gt;     well. See (*) above. Once the ICAP server sent the HTTP message
</I>&gt;<i> header,
</I>&gt;<i> &gt;     it is committed to finish sending that HTTP message (and nothing
</I>&gt;<i> else).
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     &gt; if it is the last chunk then analyze the temp file for virus.
</I>&gt;<i> &gt;     &gt; &lt;repeat for next data transfer&gt;
</I>&gt;<i> &gt;     &gt; If virus found then send encapsulated HTTP header 307 redirect.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     This is an ICAP service bug: One cannot send a second encapsulated
</I>&gt;<i> HTTP
</I>&gt;<i> &gt;     message in one ICAP response. A single ICAP response cannot contain
</I>&gt;<i> &gt;     multiple HTTP messages. The ICAP protocol does not allow for that,
</I>&gt;<i> and
</I>&gt;<i> &gt;     there would be no way to actually support something like that in an
</I>&gt;<i> ICAP
</I>&gt;<i> &gt;     client because the HTTP message cannot be interrupted and replaced
</I>&gt;<i> with
</I>&gt;<i> &gt;     another mid-flight. You may assume that the HTTP client is already
</I>&gt;<i> &gt;     seeing the beginning of the first HTTP response. The train has left
</I>&gt;<i> the
</I>&gt;<i> &gt;     station.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     If the above is accurate, and you are using the ICAP service
</I>&gt;<i> correctly,
</I>&gt;<i> &gt;     then the ICAP service that allowed you to do the above is badly
</I>&gt;<i> broken,
</I>&gt;<i> &gt;     probably written by somebody who thought that ICAP is &quot;easy&quot;. You
</I>&gt;<i> may be
</I>&gt;<i> &gt;     better off reusing an existing higher-quality ICAP service instead.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     &gt; If virus not found, send the last chunk to squid.
</I>&gt;<i> &gt;     &gt;
</I>&gt;<i> &gt;     &gt; The part where we send 307 is the part that Squid doesn't like, I
</I>&gt;<i> &gt;     &gt; believe is because we are not sending the last chunk since the
</I>&gt;<i> &gt;     file is a
</I>&gt;<i> &gt;     &gt; virus.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     Not exactly: Even if you send the last HTTP chunk, you would not be
</I>&gt;<i> able
</I>&gt;<i> &gt;     to follow up with an HTTP 307 message. The HTTP fate of this
</I>&gt;<i> transaction
</I>&gt;<i> &gt;     was sealed when you started trickling virgin HTTP message pieces
</I>&gt;<i> back to
</I>&gt;<i> &gt;     Squid (and, hence, back to the HTTP client talking to Squid).
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     HTH,
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     Alex.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     &gt; On Tue, Nov 26, 2019 at 4:52 PM Alex Rousskov wrote:
</I>&gt;<i> &gt;     &gt;
</I>&gt;<i> &gt;     &gt;     On 11/26/19 2:52 PM, Felipe Arturo Polanco wrote:
</I>&gt;<i> &gt;     &gt;
</I>&gt;<i> &gt;     &gt;      &gt; We are sending an encapsulated HTTP 307 redirect webpage
</I>&gt;<i> header
</I>&gt;<i> &gt;     &gt;     whenever
</I>&gt;<i> &gt;     &gt;      &gt; a Virus is found and stop sending any other data after that
</I>&gt;<i> &gt;     &gt;
</I>&gt;<i> &gt;     &gt;     You must use ICAP status code 200 then. Make sure your
</I>&gt;<i> &gt;     encapsulated HTTP
</I>&gt;<i> &gt;     &gt;     307 body (if any) is properly sent to Squid.
</I>&gt;<i> &gt;     &gt;
</I>&gt;<i> &gt;     &gt;
</I>&gt;<i> &gt;     &gt;      &gt; but squid
</I>&gt;<i> &gt;     &gt;      &gt; complains about ICAP failure when we do that:
</I>&gt;<i> &gt;     &gt;      &gt; Adaptation::Icap::Xaction::noteCommRead threw exception:
</I>&gt;<i> &gt;     &gt;     corrupted chunk
</I>&gt;<i> &gt;     &gt;      &gt; size
</I>&gt;<i> &gt;     &gt;
</I>&gt;<i> &gt;     &gt;     What chunk size did Squid not like? You should be able to tell
</I>&gt;<i> by
</I>&gt;<i> &gt;     &gt;     looking at the packet capture of the failed transaction (or
</I>&gt;<i> &gt;     low-level
</I>&gt;<i> &gt;     &gt;     Squid debugging).
</I>&gt;<i> &gt;     &gt;
</I>&gt;<i> &gt;     &gt;
</I>&gt;<i> &gt;     &gt;      &gt; We are not sending an ICAP header at this point because we
</I>&gt;<i> &gt;     &gt;     already told
</I>&gt;<i> &gt;     &gt;      &gt; Squid ICAP 200 OK header and begun a body transaction, we
</I>&gt;<i> &gt;     send some
</I>&gt;<i> &gt;     &gt;      &gt; chunks back to the client for progress and hold the last
</I>&gt;<i> &gt;     part for
</I>&gt;<i> &gt;     &gt;     scanning.
</I>&gt;<i> &gt;     &gt;
</I>&gt;<i> &gt;     &gt;     Are you sending HTTP 307 body chunks to Squid? How do you
</I>&gt;<i> &gt;     indicate that
</I>&gt;<i> &gt;     &gt;     no more chunks will be coming?
</I>&gt;<i> &gt;     &gt;
</I>&gt;<i> &gt;     &gt;     It sounds like you are trying to cram two HTTP messages (one
</I>&gt;<i> &gt;     with the
</I>&gt;<i> &gt;     &gt;     original HTTP response body prefix and one with a generated 307
</I>&gt;<i> &gt;     &gt;     redirect) into one ICAP response, which is impossible, but
</I>&gt;<i> &gt;     perhaps I
</I>&gt;<i> &gt;     &gt;     misunderstood your description. It would help if you post a
</I>&gt;<i> &gt;     sample (but
</I>&gt;<i> &gt;     &gt;     complete) ICAP response that Squid does not like.
</I>&gt;<i> &gt;     &gt;
</I>&gt;<i> &gt;     &gt;
</I>&gt;<i> &gt;     &gt;      &gt; Ideally, we would like to just send our 307 to Squid and not
</I>&gt;<i> &gt;     &gt;     having it
</I>&gt;<i> &gt;     &gt;      &gt; count as a failure.
</I>&gt;<i> &gt;     &gt;
</I>&gt;<i> &gt;     &gt;     Yes, a 200 ICAP response with an embedded HTTP 307 response
</I>&gt;<i> &gt;     should work
</I>&gt;<i> &gt;     &gt;     just fine, but all its pieces should be properly formed (and
</I>&gt;<i> there
</I>&gt;<i> &gt;     &gt;     should be no extras).
</I>&gt;<i> &gt;     &gt;
</I>&gt;<i> &gt;     &gt;     Alex.
</I>&gt;<i> &gt;     &gt;
</I>&gt;<i> &gt;     &gt;
</I>&gt;<i> &gt;     &gt;      &gt; On Tue, Nov 26, 2019 at 3:44 PM Alex Rousskov wrote:
</I>&gt;<i> &gt;     &gt;      &gt;
</I>&gt;<i> &gt;     &gt;      &gt;     On 11/26/19 10:15 AM, Felipe Arturo Polanco wrote:
</I>&gt;<i> &gt;     &gt;      &gt;
</I>&gt;<i> &gt;     &gt;      &gt;     &gt; While we can successfully scan our files and do
</I>&gt;<i> content
</I>&gt;<i> &gt;     &gt;     adaptation, we
</I>&gt;<i> &gt;     &gt;      &gt;     &gt; have been struggling to find a way to close the ICAP
</I>&gt;<i> &gt;     &gt;     transaction
</I>&gt;<i> &gt;     &gt;      &gt;     before
</I>&gt;<i> &gt;     &gt;      &gt;     &gt; passing the whole body back to squid and at the same
</I>&gt;<i> time
</I>&gt;<i> &gt;     &gt;     avoid squid
</I>&gt;<i> &gt;     &gt;      &gt;     &gt; marking one icap failure.
</I>&gt;<i> &gt;     &gt;      &gt;
</I>&gt;<i> &gt;     &gt;      &gt;     Squid needs a valid ICAP response. The right ICAP
</I>&gt;<i> response
</I>&gt;<i> &gt;     &gt;     status code
</I>&gt;<i> &gt;     &gt;      &gt;     depends on what you want Squid to do after receiving
</I>&gt;<i> that
</I>&gt;<i> &gt;     &gt;     response. You
</I>&gt;<i> &gt;     &gt;      &gt;     have mentioned what you do _not_ want Squid to do (i.e.
</I>&gt;<i> &gt;     &gt;     increase the
</I>&gt;<i> &gt;     &gt;      &gt;     failure count), but that still leaves a lot of options.
</I>&gt;<i> &gt;     &gt;      &gt;
</I>&gt;<i> &gt;     &gt;      &gt;
</I>&gt;<i> &gt;     &gt;      &gt;     &gt; This is for an ICAP server that does Virus scanning
</I>&gt;<i> &gt;     and if
</I>&gt;<i> &gt;     &gt;     virus
</I>&gt;<i> &gt;     &gt;      &gt;     found,
</I>&gt;<i> &gt;     &gt;      &gt;     &gt; the body is not sent back.
</I>&gt;<i> &gt;     &gt;      &gt;
</I>&gt;<i> &gt;     &gt;      &gt;     What do you want Squid to do when the ICAP service
</I>&gt;<i> finds a
</I>&gt;<i> &gt;     &gt;     virus? For
</I>&gt;<i> &gt;     &gt;      &gt;     example, what message do you want Squid to send to the
</I>&gt;<i> next
</I>&gt;<i> &gt;     &gt;     HTTP hop?
</I>&gt;<i> &gt;     &gt;      &gt;
</I>&gt;<i> &gt;     &gt;      &gt;     Alex.
</I>&gt;<i> &gt;     &gt;      &gt;
</I>&gt;<i> &gt;     &gt;
</I>&gt;<i> &gt;
</I>&gt;<i>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20191127/730143d2/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20191127/730143d2/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="021371.html">[squid-users] What is the proper way to close an ICAP	transaction?
</A></li>
	<LI>Next message (by thread): <A HREF="021373.html">[squid-users] What is the proper way to close an ICAP	transaction?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21372">[ date ]</a>
              <a href="thread.html#21372">[ thread ]</a>
              <a href="subject.html#21372">[ subject ]</a>
              <a href="author.html#21372">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
