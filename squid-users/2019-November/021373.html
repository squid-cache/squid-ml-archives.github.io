<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] What is the proper way to close an ICAP	transaction?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20What%20is%20the%20proper%20way%20to%20close%20an%20ICAP%0A%09transaction%3F&In-Reply-To=%3C5e297aa4-c454-a513-f7c1-a30b85b62132%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="021372.html">
   <LINK REL="Next"  HREF="021352.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] What is the proper way to close an ICAP	transaction?</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20What%20is%20the%20proper%20way%20to%20close%20an%20ICAP%0A%09transaction%3F&In-Reply-To=%3C5e297aa4-c454-a513-f7c1-a30b85b62132%40measurement-factory.com%3E"
       TITLE="[squid-users] What is the proper way to close an ICAP	transaction?">rousskov at measurement-factory.com
       </A><BR>
    <I>Wed Nov 27 20:07:47 UTC 2019</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="021372.html">[squid-users] What is the proper way to close an ICAP	transaction?
</A></li>
        <LI>Next message (by thread): <A HREF="021352.html">[squid-users] making proxy-int to talk to proxy-ext
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21373">[ date ]</a>
              <a href="thread.html#21373">[ thread ]</a>
              <a href="subject.html#21373">[ subject ]</a>
              <a href="author.html#21373">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 11/27/19 1:42 PM, Felipe Arturo Polanco wrote:
&gt;<i> Can you describe the process of option 2?
</I>&gt;<i> 
</I>&gt;<i> Terminate Squid-to-client transmission while indicating (to that same
</I>&gt;<i> client) that the HTTP response body was cut short (i.e. that the
</I>&gt;<i> delivery of the response was aborted).&#160;
</I>
For HTTP responses where the body size is determined by the
Content-Length header, this option is already supported by the ICAP
protocol: The ICAP service can send the last-chunk at any time after
sending the HTTP header. A last-chunk sent before the last response body
byte indicates a truncated response. I have not tested Squid support for
this use case, but either Squid already closes the TCP client-to-Squid
connection after delivering the already trickled data, or Squid can be
modified to do that.

For all the other HTTP responses (including chunked), an ICAP extension
would be required to trigger the desired behavior in Squid. That ICAP
extension can be implemented as a chunk extension, similar to the
&quot;use-original-body&quot; chunk extension defined in ICAP 206 Partial Content
responses[1].

[1]
<A HREF="http://www.icap-forum.org/documents/specification/draft-icap-ext-partial-content-07.txt">http://www.icap-forum.org/documents/specification/draft-icap-ext-partial-content-07.txt</A>

I would consider reusing the &quot;ieof&quot; spelling for this new extension
because the semantics of this new ICAP extension is equivalent to the
standard ieof semantics (only their use cases/scope differ). Support for
this &quot;ieof response&quot; extension would need to be signaled by ICAP clients
via the Allow header, similar to how support for ICAP 206 Partial
Content responses is signaled in [1].

Squid will need to be modified to honor response ieof by closing the
corresponding client-to-Squid TCP connection. With a bit more effort,
the ieof response extension can be adjusted to also signal that Squid
does not need to finish sending any buffered response data, but that
enhancement is optional.


If ieof response extension is supported, then there is no need to treat
&quot;HTTP responses where the body size is determined by the Content-Length
header&quot; (discussed as a special use case in the beginning of this email)
specially -- the ICAP service should use ieof for all truncated
responses. I documented that special use case because you do not need
ieof response support if all blocked responses in your use case fall
into that &quot;body size is determined by the Content-Length header&quot;
category; you may still need to modify Squid to abort the TCP
client-to-Squid connection though.


Quality pull requests adding support for the ieof response extension to
Squid (or their sponsorships) are welcomed. Same for fixing Squid
behavior when reacting to a truncated embedded HTTP response (if such a
fix is needed).

<A HREF="https://wiki.squid-cache.org/SquidFaq/AboutSquid#How_to_add_a_new_Squid_feature.2C_enhance.2C_of_fix_something.3F">https://wiki.squid-cache.org/SquidFaq/AboutSquid#How_to_add_a_new_Squid_feature.2C_enhance.2C_of_fix_something.3F</A>


HTH,

Alex.


&gt;<i> What TCP Flag or ICAP header should the ICAP server send in order to
</I>&gt;<i> inform connection aborted??&#160;
</I>&gt;<i> 
</I>&gt;<i> On Wed, Nov 27, 2019 at 12:44 PM Alex Rousskov wrote:
</I>&gt;<i> 
</I>&gt;<i>     On 11/27/19 11:01 AM, Felipe Arturo Polanco wrote:
</I>&gt;<i> 
</I>&gt;<i>     &gt; How can we then terminate an ICAP 200 OK transaction to squid without
</I>&gt;<i>     &gt; sending the complete body back to it? We don't want squid to mark an
</I>&gt;<i>     &gt; ICAP failure on us if we just close the TCP connection.
</I>&gt;<i> 
</I>&gt;<i>     To properly answer your question, I have to come back to the question I
</I>&gt;<i>     asked earlier: What do you want Squid to do when your ICAP service finds
</I>&gt;<i>     a virus after trickling a few virgin HTTP body bytes to the HTTP client?
</I>&gt;<i> 
</I>&gt;<i>     The &quot;we want Squid to send an HTTP 307 redirect to the client&quot; desire
</I>&gt;<i>     you responded with earlier was ruled impossible to satisfy in your
</I>&gt;<i>     trickling environment. A few realistic options remain though, including:
</I>&gt;<i> 
</I>&gt;<i>     1. Terminate Squid-to-client transmission as if the whole virgin HTTP
</I>&gt;<i>     response body was sent to the client.
</I>&gt;<i> 
</I>&gt;<i>     2. Terminate Squid-to-client transmission while indicating (to that same
</I>&gt;<i>     client) that the HTTP response body was cut short (i.e. that the
</I>&gt;<i>     delivery of the response was aborted).
</I>&gt;<i> 
</I>&gt;<i>     3. #2 plus annotate the transaction specially in Squid access.log and/or
</I>&gt;<i>     detect this special outcome using Squid ACLs.
</I>&gt;<i> 
</I>&gt;<i>     Alex.
</I>&gt;<i> 
</I>
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="021372.html">[squid-users] What is the proper way to close an ICAP	transaction?
</A></li>
	<LI>Next message (by thread): <A HREF="021352.html">[squid-users] making proxy-int to talk to proxy-ext
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21373">[ date ]</a>
              <a href="thread.html#21373">[ thread ]</a>
              <a href="subject.html#21373">[ subject ]</a>
              <a href="author.html#21373">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
