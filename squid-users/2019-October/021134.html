<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Peek and splice where SNI not present
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Peek%20and%20splice%20where%20SNI%20not%20present&In-Reply-To=%3Cd0f41b70-e7d6-63de-6a1f-e7671744b094%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="021133.html">
   <LINK REL="Next"  HREF="021139.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Peek and splice where SNI not present</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Peek%20and%20splice%20where%20SNI%20not%20present&In-Reply-To=%3Cd0f41b70-e7d6-63de-6a1f-e7671744b094%40treenet.co.nz%3E"
       TITLE="[squid-users] Peek and splice where SNI not present">squid3 at treenet.co.nz
       </A><BR>
    <I>Sat Oct  5 09:44:26 UTC 2019</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="021133.html">[squid-users] Peek and splice where SNI not present
</A></li>
        <LI>Next message (by thread): <A HREF="021139.html">[squid-users] Peek and splice where SNI not present
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21134">[ date ]</a>
              <a href="thread.html#21134">[ thread ]</a>
              <a href="subject.html#21134">[ subject ]</a>
              <a href="author.html#21134">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 5/10/19 3:34 pm, washuu wrote:
&gt;<i> 
</I>&gt;<i> Hi, 
</I>&gt;<i> 
</I>&gt;<i> I'm using Squid 3.5.27, and I want to filter some HTTPS traffic, based on
</I>&gt;<i> the hostnames.
</I>
When Using SSL-Bump features, even for things like this you should
follow the latest Squid version to make sure the TLS handling is up to
date. Currently Squid-4.8 is minimal for SSL-Bump features to work well.


&gt;<i> 
</I>&gt;<i> my ssl-related config is as follows: 
</I>&gt;<i> 
</I>&gt;<i> acl step1 at_step SslBump1
</I>&gt;<i> acl step2 at_step SslBump2
</I>&gt;<i> ssl_bump peek step1 all
</I>&gt;<i> acl global_https_dst_allow ssl::server_name
</I>&gt;<i> &quot;/chroot/squid/etc/squid/global_dst_whitelist&quot;
</I>&gt;<i> ssl_bump splice step2 global_https_dst_allow
</I>&gt;<i> ssl_bump terminate step2 proxyclients
</I>&gt;<i> http_access allow SSL_ports
</I>&gt;<i> http_access allow proxyclients
</I>
NP: at a guess based on their names these two ACLs are redundant. You
should be able to remove the &quot;allow SSL_Ports&quot; line and let proxyclients
do the allow. Unless you want any random external client to be allowed
just because they want your proxy for HTTPS relay.


&gt;<i> http_access deny all
</I>&gt;<i> 
</I>&gt;<i> Now I see, that several SSL clients do NOT send SNI hostname in the Client
</I>&gt;<i> Hello message, and what I got is denied access, with the following entry in
</I>&gt;<i> the log: 
</I>&gt;<i> 
</I>&gt;<i> 1570241666.136      5 192.168.3.99 TAG_NONE/200 0 CONNECT 52.202.211.224:443
</I>&gt;<i> - HIER_NONE/- - -
</I>&gt;<i> 
</I>
There is no indication of which SSL-Bump step is being performed when
this log entry is recorded. This may be from the initial CONNECT request
before the ClientHello is received.


&gt;<i> I have two questions then: 
</I>&gt;<i> 
</I>&gt;<i> 1) For such cases, is there a possibility to filter traffic based on
</I>&gt;<i> certificate provided by the Server Hello (instead of SNI from Client Hello)
</I>&gt;<i> in step3?
</I>
Only in Squid-4+, with the --server-provided flag. Like so:

 acl foo ssl::server_name --server-provided .example.com


&gt;<i> 2) Is there a way, to allow (by additional ACL rule, perhaps) traffic
</I>&gt;<i> without SNI field set? so actually I would be filtering OUT only the
</I>&gt;<i> sessions where SNI was present, but the hostname did not match my whitelist.
</I>
There is a special value &quot;none&quot; for the ssl::server_name ACL which will
match if there is no server name found. (NP: It is broken prior to
Squid-3.5.23 and Squid-4.1)

You will need the --client-requested flag (also only in Squid-4+) to
limit the server name to SNI.


Be careful using this type of bypass. It essentially makes the whitelist
pointless, clients just avoid sending SNI and they can do whatever they
like with your proxy. That is a major security hole.

Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="021133.html">[squid-users] Peek and splice where SNI not present
</A></li>
	<LI>Next message (by thread): <A HREF="021139.html">[squid-users] Peek and splice where SNI not present
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21134">[ date ]</a>
              <a href="thread.html#21134">[ thread ]</a>
              <a href="subject.html#21134">[ subject ]</a>
              <a href="author.html#21134">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
