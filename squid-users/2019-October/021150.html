<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Clarification on behavior
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Clarification%20on%20behavior&In-Reply-To=%3CCY4PR02MB272512CE602386C773E28F02B0940%40CY4PR02MB2725.namprd02.prod.outlook.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="021203.html">
   <LINK REL="Next"  HREF="021154.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Clarification on behavior</H1>
    <B>Joseph Jones</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Clarification%20on%20behavior&In-Reply-To=%3CCY4PR02MB272512CE602386C773E28F02B0940%40CY4PR02MB2725.namprd02.prod.outlook.com%3E"
       TITLE="[squid-users] Clarification on behavior">josepjones at expediagroup.com
       </A><BR>
    <I>Thu Oct 10 14:43:09 UTC 2019</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="021203.html">[squid-users] RES: How to make only IPV6 visible even incoming via IPV4?
</A></li>
        <LI>Next message (by thread): <A HREF="021154.html">[squid-users] Clarification on behavior
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21150">[ date ]</a>
              <a href="thread.html#21150">[ thread ]</a>
              <a href="subject.html#21150">[ subject ]</a>
              <a href="author.html#21150">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>we are using squid a a perimeter egress filter. one think I've recently noticed is based on my current config it's possible to make a request through squid to an HTTPS endpoint with out doing a CONNECT request. 

I was wondering if this should be allowed behavior for a proxy or if it's just a business requirement to deny that type of request or if that behavior shouldn't be allowed anyway.  My concern being if squid is deployed in an environment that has PCI/PII data I wouldn't want squid to hold that data decrypted even for a little while and the client should have encrypted tunnel through to the server. 

the following request gets rejected and should be. (This is because of the rule: http_access deny CONNECT !SSL_ports)
cat &lt;&lt;EOL | nc localhost 3128
CONNECT ifconfig.io:80 HTTP/1.1
Host: ifconfig.io:80
User-Agent: curl/7.29.0
Proxy-Connection: Keep-Alive

EOL


however this request is allowed unless I add (http_access deny SSL_Ports !CONNECT)
cat &lt;&lt;EOL | nc localhost 3128
GET <A HREF="https://ifconfig.io/ip">https://ifconfig.io/ip</A> HTTP/1.1
User-Agent: curl/7.29.0
Host: ifconfig.io
Accept: */*
Proxy-Connection: Keep-Alive

EOL

This request is of concern because this means squid is doing the https request and decrypting the response before returning it to the client. I can solve this by making the squid endpoint SSL too. but even then I don't want squid to have the data decrypted at all. Which is why I've added the extra rule.

I'm testing this off of latest master commit. 

basically I'm wonder if my extra access rule of http_access deny SSL_PORTS !CONNECT is sufficient enough to make sure squid doesn't decrypt the response. 


$ ./src/squid -v
Squid Cache: Version 5.0.0-VCS
Service Name: squid

This binary uses OpenSSL 1.1.1d FIPS  10 Sep 2019. For legal restrictions on distribution see <A HREF="https://www.openssl.org/source/license.html">https://www.openssl.org/source/license.html</A>

configure options:  '--prefix=/home/josepjones/.local/squid' '--enable-icmp' '--with-openssl'


squid.conf:
debug_options ALL,1 11,3 rotate=0

# tg  - GMT time
# &gt;a  - Client source IP address
# &gt;p  - Client source port
# Ss  - Squid request status
# &gt;Hs - HTTP status code sent to client
# &lt;st - Total size of reply sent to client
# &gt;st - Total size of request received from client. Excluding chunked encoding bytes.
# &gt;rm - Request method from client
# &gt;ru - Request URL received from client
# &gt;rd - Request URL domain from client
# &lt;a  - Server IP address of the last server or peer connection
logformat my_squid [%tl] %&gt;a %6&gt;p %Ss/%03&gt;Hs %&gt;st %&lt;st %&gt;rm %&gt;ru %&gt;rd/%&lt;a

access_log stdio:/dev/stdout logformat=my_squid rotate=0
cache_log stdio:/dev/stderr

acl SSL_ports port 443
acl Safe_ports port 80    # http
acl Safe_ports port 8080  # http
acl Safe_ports port 443   # https
acl CONNECT method CONNECT

acl http_whitelist dstdomain &quot;/home/josepjones/.local/squid/etc/whitelist.txt&quot;
acl http_blacklist dstdomain &quot;/home/josepjones/.local/squid/etc/blacklist.txt&quot;

#
# Recommended minimum Access Permission configuration:
#
# Deny requests to certain unsafe ports
http_access deny !Safe_ports

# Deny CONNECT to other than secure SSL ports
http_access deny CONNECT !SSL_ports

http_access deny SSL_Ports !CONNECT

http_access deny http_blacklist
http_access allow http_whitelist

http_access deny CONNECT http_blacklist
http_access allow CONNECT http_whitelist

http_access deny all

# disable caching
cache deny all


# Squid normally listens to port 3128
http_port 3128
visible_hostname squid

# Uncomment and adjust the following to add a disk cache directory.
cache_mem 0
# cache_dir rock /home/josepjones/.local/squid/var/spool 100

# Leave coredumps in the first cache dir
coredump_dir /home/josepjones/.local/squid

--&#160;



Joseph M Jones




</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="021203.html">[squid-users] RES: How to make only IPV6 visible even incoming via IPV4?
</A></li>
	<LI>Next message (by thread): <A HREF="021154.html">[squid-users] Clarification on behavior
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21150">[ date ]</a>
              <a href="thread.html#21150">[ thread ]</a>
              <a href="subject.html#21150">[ subject ]</a>
              <a href="author.html#21150">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
