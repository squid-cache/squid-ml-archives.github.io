<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Icap redirection issues
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Icap%20redirection%20issues&In-Reply-To=%3Caa0e42b9-a3a7-442f-8b3e-1d2f49339a9f%40www.fastmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="021154.html">
   <LINK REL="Next"  HREF="021152.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Icap redirection issues</H1>
    <B>Darren Breeze</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Icap%20redirection%20issues&In-Reply-To=%3Caa0e42b9-a3a7-442f-8b3e-1d2f49339a9f%40www.fastmail.com%3E"
       TITLE="[squid-users] Icap redirection issues">darren at ksn-systems.com
       </A><BR>
    <I>Thu Oct 10 19:46:57 UTC 2019</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="021154.html">[squid-users] Clarification on behavior
</A></li>
        <LI>Next message (by thread): <A HREF="021152.html">[squid-users] Icap redirection issues
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21151">[ date ]</a>
              <a href="thread.html#21151">[ thread ]</a>
              <a href="subject.html#21151">[ subject ]</a>
              <a href="author.html#21151">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>HI

I am trying to set up redirection via icap for a project I am working on.

my current icap config looks like this

icap_service service_res respmod_precache <A HREF="icap://127.0.0.1:1344/respmode">icap://127.0.0.1:1344/respmode</A> bypass=0
adaptation_access service_res allow all

and I am generating responses that look like this (in the log)

2019/10/10 19:42:48.138 kid1| 93,5| ModXact.cc(654) parseMore:
ICAP/1.0 200 OK
Connection: close
Date: Thu Oct 10 19:42:48 2019 UTC
ISTag: BITZ-1570736568-132184
Server: bitz-server 2.0.0
Encapsulated: req-hdr=0, res-hdr=615

GET <A HREF="http://www.frip.com/favicon.ico">http://www.frip.com/favicon.ico</A> HTTP/1.1
Pragma: no-cache
Cache-Control: no-cache
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/77.0.3865.90 Safari/537.36
Accept: image/webp,image/apng,image/*,*/*;q=0.8
Referer: <A HREF="http://www.frip.com/">http://www.frip.com/</A>
Accept-Encoding: gzip, deflate
Accept-Language: en-US,en;q=0.9
Cookie: viewmode=regular; browser_id=130.211.1.243%3A5d93bd8d5d5f0; language=en-us; _ga=GA1.2.2047886438.1569970932; _gid=GA1.2.1012209846.1570399958; count=12; gamexsess=fbr4qbg0fp4q111jq6pj5r9517; env=%7Bww%3A1903%2Cwh%3A969%7D
Host: www.frip.com

HTTP/1.1 307 Moved Temporarily
Location: <A HREF="http://www.test.com/">http://www.test.com/</A>
Date: Thu, 10 Oct 2019 19:42:48 UTC
Origin: Local


2019/10/10 19:42:48.138 kid1| 93,5| ModXact.cc(749) parseHeaders: parse ICAP headers

looking at the log, there seesm to be something in the header that is not correct

2019/10/10 19:42:48.138 kid1| 93,5| ModXact.cc(1079) parseHead: have 905 head bytes to parse; state: 0
2019/10/10 19:42:48.138 kid1| 93,5| ModXact.cc(1094) parseHead: parse success, consume 170 bytes, return true
2019/10/10 19:42:48.138 kid1| 93,5| ModXact.cc(785) parseIcapHead: found connection close
2019/10/10 19:42:48.138 kid1| 93,7| ModXact.cc(523) stopBackup: will no longer backup [FD 16;RrBp(1)S(2)G/w job23]
2019/10/10 19:42:48.138 kid1| 93,9| ModXact.cc(427) virginConsume: consumption guards: 00001
2019/10/10 19:42:48.138 kid1| 93,8| ModXact.cc(446) virginConsume: postponing consumption from [0&lt;=1066&lt;=1066 1066+981 pipe0x55a883de4f08 cons0x55a883de6208]
2019/10/10 19:42:48.138 kid1| 93,7| ModXact.cc(646) checkConsuming: will stop consuming [FD 16;Rrp(1)S(2)G/w job23]
2019/10/10 19:42:48.138 kid1| 93,5| ModXact.cc(754) parseHeaders: parse HTTP headers
2019/10/10 19:42:48.138 kid1| 93,4| Xaction.cc(514) setOutcome: ICAP_MOD
2019/10/10 19:42:48.138 kid1| 93,5| ModXact.cc(1079) parseHead: have 735 head bytes to parse; state: 1
2019/10/10 19:42:48.138 kid1| 93,3| ../../../src/base/AsyncJobCalls.h(177) dial: Adaptation::Icap::Xaction::noteCommRead threw exception: parsed || !error
2019/10/10 19:42:48.138 kid1| 93,3| Xaction.cc(512) setOutcome: Warning: reseting outcome: from ICAP_MOD to ICAP_ERR_OTHER
2019/10/10 19:42:48.138 kid1| 93,4| ServiceRep.cc(80) noteFailure: failure 2 out of 10 allowed in 0sec [up,fail2]
2019/10/10 19:42:48.138 kid1| 93,5| AsyncJob.cc(84) mustStop: Adaptation::Icap::ModXact will stop, reason: exception
2019/10/10 19:42:48.138 kid1| 93,5| AsyncJob.cc(137) callEnd: Adaptation::Icap::Xaction::noteCommRead(local=127.0.0.1:36938 remote=127.0.0.1:1344 FD 16 flags=1, data=0x55a883de6108, size=905, buf=0x55a883df7190) ends job [FD 16;rp(1)S(2)G/Rw job23]
2019/10/10 19:42:48.138 kid1| 93,5| ModXact.cc(1242) swanSong: swan sings [FD 16;rp(1)S(2)G/Rw job23]


I can't find any further detail / logging for the exception that was thrown.

Am I missing something obvious in my approach or something else?

thanks in advance

Darren B.




















This email and any files transmitted with it are confidential and intended solely for the use of the individual or entity to whom they are addressed. If you have received this email in error please notify the system manager. This message contains confidential information and is intended only for the individual named. If you are not the named addressee you should not disseminate, distribute or copy this e-mail. Please notify the sender immediately by e-mail if you have received this e-mail by mistake and delete this e-mail from your system. If you are not the intended recipient you are notified that disclosing, copying, distributing or taking any action in reliance on the contents of this information is strictly prohibited.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20191011/498f2731/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20191011/498f2731/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="021154.html">[squid-users] Clarification on behavior
</A></li>
	<LI>Next message (by thread): <A HREF="021152.html">[squid-users] Icap redirection issues
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21151">[ date ]</a>
              <a href="thread.html#21151">[ thread ]</a>
              <a href="subject.html#21151">[ subject ]</a>
              <a href="author.html#21151">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
