<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Working peek/splice no longer functioning on some sites
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Working%20peek/splice%20no%20longer%20functioning%20on%20some%0A%20sites&In-Reply-To=%3C7b7cac7d-0acd-5823-d247-5aeb3d2ab7e9%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="021145.html">
   <LINK REL="Next"  HREF="021146.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Working peek/splice no longer functioning on some sites</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Working%20peek/splice%20no%20longer%20functioning%20on%20some%0A%20sites&In-Reply-To=%3C7b7cac7d-0acd-5823-d247-5aeb3d2ab7e9%40treenet.co.nz%3E"
       TITLE="[squid-users] Working peek/splice no longer functioning on some sites">squid3 at treenet.co.nz
       </A><BR>
    <I>Fri Oct 11 06:28:09 UTC 2019</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="021145.html">[squid-users] Working peek/splice no longer functioning on some	sites
</A></li>
        <LI>Next message (by thread): <A HREF="021146.html">[squid-users] re-forwarding questions
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21155">[ date ]</a>
              <a href="thread.html#21155">[ thread ]</a>
              <a href="subject.html#21155">[ subject ]</a>
              <a href="author.html#21155">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 9/10/19 8:36 pm, torson wrote:
&gt;<i> @Amos thank you for your detailed reply. It took me a while to get back to
</I>&gt;<i> this task, sorry.
</I>&gt;<i> I did some changes, added your suggestions, tested some more and here are my
</I>&gt;<i> results using Squid 4.8 with a couple of questions:
</I>&gt;<i> 
</I>&gt;<i> A short summary of my setup: Squid that does only intercept for all servers
</I>&gt;<i> in the same network. There's Dnsmasq set up on the same server and is used
</I>&gt;<i> by Squid and all other servers. 
</I>&gt;<i> 
</I>&gt;<i> ### 1. https certificate check
</I>&gt;<i> I've managed to make it work with &quot;ssl_bump peek all&quot; but it started working
</I>&gt;<i> only after I've switched the order of splice and peek:
</I>&gt;<i> ---
</I>&gt;<i> ssl_bump splice allowed_https_sites
</I>&gt;<i> ssl_bump peek all
</I>&gt;<i> ssl_bump terminate all
</I>&gt;<i> ---
</I>
With an intercept proxy this makes the proxy do:

 step 1)
   peek (allowed_https_sites does not match), then

 step 2)
   splice if allowed_https_sites matched, else peek

 step 3)
   splice if allowed_https_sites matched, else terminate


&gt;<i> 
</I>&gt;<i> Though now I don't get &quot;terminate&quot; entries in the logfile for blocked
</I>&gt;<i> requests for most domains I'm testing with, instead those are now &quot;peek&quot;
</I>&gt;<i> entries. 
</I>&gt;<i> 
</I>
Do you actually understand why?

The earlier setups you were either splicing only at step 1 OR only at
step 2. This new setup can splice at whichever step supplies a
whitelisted domain name.

So now clients which lie are allowed to splice, AND clients which do not
supply SNI but go to an okay server are allowed to splice.

NP: clients which lie may not be as bad as it seems. With splice the
server gets the lie and can reject the request if it is legitimate. For
there to be a security problem the client and server need to collude.

...
&gt;<i> 
</I>&gt;<i> So there seems to be variations on how Squid is handling traffic for various
</I>&gt;<i> sites.
</I>
Of course, you put data-dependent conditions (allowed_https_sites ACL)
on what handling can be performed. Thus making the proxy behaviour
conditional on what Hello data the remote TLS agents are supplying.

As clients and servers differ so will the resulting proxy behaviour.


&gt;<i> I lean more towards having increased security than consistent logging, seems
</I>&gt;<i> like &quot;peek&quot; effectively means &quot;terminate&quot; in this case, so I'll just count
</I>&gt;<i> that together for alerting.
</I>
On the contrary, since this is an interception proxy peek will always
preceed both splice and terminate.

If the logging is working correctly you will see the peek's AND the
splice's AND any terminate's.


&gt;<i> 
</I>&gt;<i> Do you have some suggestion to make this work better or is this just the
</I>&gt;<i> best I can squeeze out of Squid at this time?
</I>&gt;<i> 
</I>
AFAIK this is the best available in Squid-4. The latest Squid-5 may be
slightly better, it has a number of quality-of-life feature additions
for TLS related things.



&gt;<i> ### 2. false host-forgery blocking due to stale DNS record
</I>&gt;<i> 
</I>...
&gt;<i> 
</I>&gt;<i> Do you have some suggestions regarding this? Am I thinking in the right
</I>&gt;<i> direction?
</I>
AFAIK those directions are reasonable for Squid today. We are still
waiting on someone having the time/resources to contribute a refactor to
Squid DNS that further reduces these false-positives.
 I have a plan, but no time to implement it. Factory people have laid a
lot of the groundwork in Squid-5 but we are not completely there yet.

Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="021145.html">[squid-users] Working peek/splice no longer functioning on some	sites
</A></li>
	<LI>Next message (by thread): <A HREF="021146.html">[squid-users] re-forwarding questions
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21155">[ date ]</a>
              <a href="thread.html#21155">[ thread ]</a>
              <a href="subject.html#21155">[ subject ]</a>
              <a href="author.html#21155">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
