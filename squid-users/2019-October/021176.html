<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] How to use &quot;cache&quot;, &quot;store_miss&quot; and &quot;send_hit&quot; directives?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20How%20to%20use%20%22cache%22%2C%0A%20%22store_miss%22%20and%20%22send_hit%22%20directives%3F&In-Reply-To=%3C19a46b4987f3a332160aa74024f135d5383ef066.camel%40lists.microscopium.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="021171.html">
   <LINK REL="Next"  HREF="021168.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] How to use &quot;cache&quot;, &quot;store_miss&quot; and &quot;send_hit&quot; directives?</H1>
    <B>Robert</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20How%20to%20use%20%22cache%22%2C%0A%20%22store_miss%22%20and%20%22send_hit%22%20directives%3F&In-Reply-To=%3C19a46b4987f3a332160aa74024f135d5383ef066.camel%40lists.microscopium.de%3E"
       TITLE="[squid-users] How to use &quot;cache&quot;, &quot;store_miss&quot; and &quot;send_hit&quot; directives?">rs-squid at lists.microscopium.de
       </A><BR>
    <I>Thu Oct 17 12:53:42 UTC 2019</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="021171.html">[squid-users] How to use &quot;cache&quot;, &quot;store_miss&quot; and &quot;send_hit&quot; directives?
</A></li>
        <LI>Next message (by thread): <A HREF="021168.html">[squid-users] Overwrite an URL containing an IP when it is requested with a custom Host header
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21176">[ date ]</a>
              <a href="thread.html#21176">[ thread ]</a>
              <a href="subject.html#21176">[ subject ]</a>
              <a href="author.html#21176">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Am Mittwoch, den 16.10.2019, 22:18 -0400 schrieb Alex Rousskov:
&gt;<i> On 10/16/19 7:17 PM, Robert Senger wrote:
</I>&gt;<i> 
</I>&gt;<i> &gt; I need to encrypt browser-&gt;squid connection (on mobile devices).
</I>&gt;<i> &gt; With
</I>&gt;<i> &gt; squid 3.x, I used stunnel client on the mobile device and stunnel
</I>&gt;<i> &gt; server on squid's machine. With squid 4.6, I wanted to get rid of
</I>&gt;<i> &gt; stunnel server and use squid's https_port directive instead, but
</I>&gt;<i> &gt; https_port + sslbump did not go together. So, I created a loop that
</I>&gt;<i> &gt; forwarded https_port connections with a cache_peer directive to
</I>&gt;<i> &gt; squid's
</I>&gt;<i> &gt; own http_port. 
</I>&gt;<i> 
</I>&gt;<i> IIRC, this trick also creates problems for built-in cache_peer checks
</I>&gt;<i> that may fail because those checks start before Squid starts
</I>&gt;<i> listening
</I>&gt;<i> on its own ports. This problem may be specific to SMP setups. YMMV.
</I>&gt;<i> 
</I>Well, worked for me ;)

&gt;<i> &gt; That worked, except for caching... The http_port ACLs
</I>&gt;<i> &gt; never matched in the cache directive, instead, the https_port ACLs
</I>&gt;<i> &gt; did,
</I>&gt;<i> &gt; but that is not what I want and need. Some coincidence made that
</I>&gt;<i> &gt; tcp_outgoing_address matched and routing was correct, anyway.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> AFAICT, bugs notwithstanding, those ACLs should have matched in the
</I>&gt;<i> &quot;cache&quot; directive context, especially if they actually matched in the
</I>&gt;<i> tcp_outgoing_address context later.
</I>&gt;<i> 
</I>&gt;<i> Alex.
</I>
I am not sure if they matched at all. As I said, by chance, default
rules for tcp_outgoing_address and policy based routing might have
produced right results (at least at where I looked at, there are more
than 2 client ACLs), but based on wrong decisions. Can't check this
right now.

Anyway, I am thinking about running multiple squid instances with
simple setups and chain them rather than just one with a very complex
setup, maybe that would make things easier. It also would make it
possible to query different nameservers (or bind9 views) for different
ACLs, which is not possible within one single instance
(udp_outgoing_address does not take ACLs).

Thanks for the help,

Robert



&gt;<i> 
</I>&gt;<i> &gt; Am Mittwoch, den 16.10.2019, 11:38 -0400 schrieb Alex Rousskov:
</I>&gt;<i> &gt; &gt; On 10/16/19 10:38 AM, Robert wrote:
</I>&gt;<i> &gt; &gt; 
</I>&gt;<i> &gt; &gt; &gt; after upgrading to 4.6 from 3.x
</I>&gt;<i> &gt; &gt; &gt; I am struggling with caching objects. The goal is, to have
</I>&gt;<i> &gt; &gt; &gt; objects
</I>&gt;<i> &gt; &gt; &gt; requested by proxy-basic clients not to be cached, but objects
</I>&gt;<i> &gt; &gt; &gt; requested by proxy-standard to be cached normally.
</I>&gt;<i> &gt; &gt; &gt; 
</I>&gt;<i> &gt; &gt; &gt; Tried this:
</I>&gt;<i> &gt; &gt; &gt; 
</I>&gt;<i> &gt; &gt; &gt;   cache deny proxy-basic
</I>&gt;<i> &gt; &gt; &gt;   cache allow all
</I>&gt;<i> &gt; &gt; &gt; 
</I>&gt;<i> &gt; &gt; &gt; And this:
</I>&gt;<i> &gt; &gt; &gt; 
</I>&gt;<i> &gt; &gt; &gt;   cache allow proxy-standard
</I>&gt;<i> &gt; &gt; &gt;   cache deny all
</I>&gt;<i> &gt; &gt; 
</I>&gt;<i> &gt; &gt; Based on your description, you probably want the former or its
</I>&gt;<i> &gt; &gt; simpler
</I>&gt;<i> &gt; &gt; version:
</I>&gt;<i> &gt; &gt; 
</I>&gt;<i> &gt; &gt;     cache deny proxy-basic
</I>&gt;<i> &gt; &gt; 
</I>&gt;<i> &gt; &gt; 
</I>&gt;<i> &gt; &gt; &gt; If I use ANY &quot;cache ___&quot; directive other than a (useless)
</I>&gt;<i> &gt; &gt; &gt; &quot;cache
</I>&gt;<i> &gt; &gt; &gt; allow
</I>&gt;<i> &gt; &gt; &gt; all&quot;, caching is completely disabled for all ACLs.
</I>&gt;<i> &gt; &gt; 
</I>&gt;<i> &gt; &gt; FYI: Squid does not (yet) treat the &quot;all&quot; ACL specially -- Squid
</I>&gt;<i> &gt; &gt; does
</I>&gt;<i> &gt; &gt; not ignore or automatically apply seemingly &quot;useless&quot; rules with
</I>&gt;<i> &gt; &gt; it.
</I>&gt;<i> &gt; &gt; If
</I>&gt;<i> &gt; &gt; you are getting correct results with &quot;allow all&quot; and incorrect
</I>&gt;<i> &gt; &gt; results
</I>&gt;<i> &gt; &gt; with &quot;allow foo&quot;, then your foo ACL does not match (in that
</I>&gt;<i> &gt; &gt; specific
</I>&gt;<i> &gt; &gt; context). Why it does not match is a separate question.
</I>&gt;<i> &gt; &gt; 
</I>&gt;<i> &gt; &gt; 
</I>&gt;<i> &gt; &gt; &gt; What am I doing wrong?
</I>&gt;<i> &gt; &gt; 
</I>&gt;<i> &gt; &gt; Nothing that warrants discussing here IMO. I suggest trying the
</I>&gt;<i> &gt; &gt; latest
</I>&gt;<i> &gt; &gt; v4 release and, if the problem is still there, filing a bug
</I>&gt;<i> &gt; &gt; report.
</I>&gt;<i> &gt; &gt; If
</I>&gt;<i> &gt; &gt; you can share a compressed ALL,7+ cache.log while reproducing the
</I>&gt;<i> &gt; &gt; problem with a single transaction, we may be able to triage this
</I>&gt;<i> &gt; &gt; problem
</I>&gt;<i> &gt; &gt; faster. Squid wiki has instructions at
</I>&gt;<i> &gt; &gt; 
</I><A HREF="https://wiki.squid-cache.org/SquidFaq/BugReporting#Debugging_a_single_transaction">https://wiki.squid-cache.org/SquidFaq/BugReporting#Debugging_a_single_transaction</A>
&gt;<i> &gt; &gt; 
</I>&gt;<i> &gt; &gt; 
</I>&gt;<i> &gt; &gt; HTH,
</I>&gt;<i> &gt; &gt; 
</I>&gt;<i> &gt; &gt; Alex.
</I>&gt;<i> &gt; &gt; 
</I>&gt;<i> &gt; &gt; &gt; I am using ACLs for different handling of clients connecting to
</I>&gt;<i> &gt; &gt; &gt; different local ports:
</I>&gt;<i> &gt; &gt; &gt; 
</I>&gt;<i> &gt; &gt; &gt;   acl proxy-basic localip 172.16.2.243
</I>&gt;<i> &gt; &gt; &gt;   acl proxy-standard localip 172.16.3.243
</I>&gt;<i> &gt; &gt; &gt; 
</I>&gt;<i> &gt; &gt; &gt; These ACLs are used to determine outgoing address, which are
</I>&gt;<i> &gt; &gt; &gt; routed
</I>&gt;<i> &gt; &gt; &gt; to
</I>&gt;<i> &gt; &gt; &gt; different outgoing interfaces like this:
</I>&gt;<i> &gt; &gt; &gt; 
</I>&gt;<i> &gt; &gt; &gt;   tcp_outgoing_address 172.16.3.244 proxy-basic
</I>&gt;<i> &gt; &gt; &gt;   tcp_outgoing_address 172.16.4.244 proxy-standard
</I>&gt;<i> &gt; &gt; &gt; 
</I>&gt;<i> &gt; &gt; &gt; This works as desired.
</I>&gt;<i> &gt; &gt; 
</I>&gt;<i> &gt; &gt; _______________________________________________
</I>&gt;<i> &gt; &gt; squid-users mailing list
</I>&gt;<i> &gt; &gt; <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> &gt; &gt; <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>-- 
Robert Senger



</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="021171.html">[squid-users] How to use &quot;cache&quot;, &quot;store_miss&quot; and &quot;send_hit&quot; directives?
</A></li>
	<LI>Next message (by thread): <A HREF="021168.html">[squid-users] Overwrite an URL containing an IP when it is requested with a custom Host header
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21176">[ date ]</a>
              <a href="thread.html#21176">[ thread ]</a>
              <a href="subject.html#21176">[ subject ]</a>
              <a href="author.html#21176">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
