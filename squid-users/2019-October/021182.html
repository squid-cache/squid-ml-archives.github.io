<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] SIGBUS attempting to use rock
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20SIGBUS%20attempting%20to%20use%20rock&In-Reply-To=%3Cb03b57ee-02ce-06f5-276f-8cbeb8d58ba1%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="021180.html">
   <LINK REL="Next"  HREF="021183.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] SIGBUS attempting to use rock</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20SIGBUS%20attempting%20to%20use%20rock&In-Reply-To=%3Cb03b57ee-02ce-06f5-276f-8cbeb8d58ba1%40measurement-factory.com%3E"
       TITLE="[squid-users] SIGBUS attempting to use rock">rousskov at measurement-factory.com
       </A><BR>
    <I>Thu Oct 17 21:47:50 UTC 2019</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="021180.html">[squid-users] SIGBUS attempting to use rock
</A></li>
        <LI>Next message (by thread): <A HREF="021183.html">[squid-users] SIGBUS attempting to use rock
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21182">[ date ]</a>
              <a href="thread.html#21182">[ thread ]</a>
              <a href="subject.html#21182">[ subject ]</a>
              <a href="author.html#21182">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 10/17/19 5:07 PM, Antonio SJ Musumeci wrote:

&gt;<i> the option is listed in relation to SMP and not referenced by rock docs.
</I>
The second paragraph in cache_dir rock directive documentation implies
SMP -- it talks about various processes that rock uses to avoid locking
(if it can). SMP usage is the primary rock scalability feature. There is
more info at <A HREF="https://wiki.squid-cache.org/Features/RockStore">https://wiki.squid-cache.org/Features/RockStore</A> (and
<A HREF="https://wiki.squid-cache.org/Features/LargeRockStore">https://wiki.squid-cache.org/Features/LargeRockStore</A>).


&gt;<i> Also it should be possible to check /dev/shm's free space
</I>&gt;<i> and compare that against the file size needed. Clearly it knows based on
</I>&gt;<i> the requested storage and slot sizes. Even a guess with a warning rather
</I>&gt;<i> than leaving it to fail otherwise silently with a SIGBUS.
</I>
Unfortunately, a simple implementation may produce a lot of false
warnings in some environments while a quality implementation may not be
as easy as you think: Accessing free space info may require special
permissions and correctly accounting for the existing shared memory
segments in that partition would be tricky (they can be leftovers from
the previous Squid run that will be overwritten or something completely
unrelated to Squid). Even finding the right partition name in a portable
way may be tricky!

IMHO, the future development directions outlined when adding
shared_memory_locking are more promising in general, but I would be
happy to learn that there are even better options.


Cheers,

Alex.


&gt;<i> On 10/17/2019 2:53 PM, Alex Rousskov wrote:
</I>&gt;&gt;<i> On 10/17/19 12:28 PM, Antonio SJ Musumeci wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> After a lot of tinkering and turning on full debug I realized the reason
</I>&gt;&gt;&gt;<i> rock was failing for me in my container was due to the small default SHM
</I>&gt;&gt;&gt;<i> size allocated by Docker. Increasing the SHM size with `--shm-size`
</I>&gt;&gt;&gt;<i> fixed the issue.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> It'd be significantly more helpful if the Squid reported precisely what
</I>&gt;&gt;&gt;<i> the issue and exited gracefully rather than SIGBUS'ing.
</I>
&gt;&gt;<i> Does enabling shared_memory_locking in squid.conf trigger the behavior
</I>&gt;&gt;<i> you want?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> If yes, then you may be wondering why this is not the default setting.
</I>&gt;&gt;<i> The answer is in the following two squid-dev messages. Message [1] is a
</I>&gt;&gt;<i> high-level description. Message [2] contains more low-level details and
</I>&gt;&gt;<i> examples of ~60 second startup delays that locking may cause.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> [1]
</I>&gt;&gt;<i> <A HREF="http://lists.squid-cache.org/pipermail/squid-dev/2016-March/005260.html">http://lists.squid-cache.org/pipermail/squid-dev/2016-March/005260.html</A>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> [2]
</I>&gt;&gt;<i> <A HREF="http://lists.squid-cache.org/pipermail/squid-dev/2015-December/004112.html">http://lists.squid-cache.org/pipermail/squid-dev/2015-December/004112.html</A>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Enhancing shared memory management (e.g., implementing ideas mentioned
</I>&gt;&gt;<i> in the &quot;As we gain more experience&quot; paragraph of [1]) is welcomed.
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="021180.html">[squid-users] SIGBUS attempting to use rock
</A></li>
	<LI>Next message (by thread): <A HREF="021183.html">[squid-users] SIGBUS attempting to use rock
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21182">[ date ]</a>
              <a href="thread.html#21182">[ thread ]</a>
              <a href="subject.html#21182">[ subject ]</a>
              <a href="author.html#21182">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
