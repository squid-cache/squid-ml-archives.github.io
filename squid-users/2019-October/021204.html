<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] (no subject)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20%28no%20subject%29&In-Reply-To=%3Ca2a3249e-a2fd-74ee-c608-6951c6427743%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="021199.html">
   <LINK REL="Next"  HREF="021205.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] (no subject)</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20%28no%20subject%29&In-Reply-To=%3Ca2a3249e-a2fd-74ee-c608-6951c6427743%40treenet.co.nz%3E"
       TITLE="[squid-users] (no subject)">squid3 at treenet.co.nz
       </A><BR>
    <I>Wed Oct 23 11:06:14 UTC 2019</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="021199.html">[squid-users] (no subject)
</A></li>
        <LI>Next message (by thread): <A HREF="021205.html">[squid-users] (no subject)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21204">[ date ]</a>
              <a href="thread.html#21204">[ thread ]</a>
              <a href="subject.html#21204">[ subject ]</a>
              <a href="author.html#21204">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 23/10/19 1:23 am, Vieri Di Paola wrote:
&gt;<i> On Tue, Oct 22, 2019 at 1:48 PM Amos Jeffries wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I do not see any DIVERT rule at all in your firewall config dump. That
</I>&gt;&gt;<i> is at least part of the problem.
</I>&gt;<i> 
</I>&gt;<i> I opened the previous dump and saw the divert rules here below:
</I>&gt;<i> 
</I>&gt;<i> Chain PREROUTING (policy ACCEPT 573K packets, 462M bytes)
</I>&gt;<i>  pkts bytes target     prot opt in     out     source
</I>&gt;<i> destination
</I>&gt;<i>  573K  462M CONNMARK   all  --  *      *       0.0.0.0/0
</I>&gt;<i> 0.0.0.0/0            CONNMARK restore mask 0xff
</I>&gt;<i>  1213  181K routemark  all  --  ppp1   *       0.0.0.0/0
</I>&gt;<i> 0.0.0.0/0            mark match 0x0/0xff
</I>&gt;<i>  3195  308K routemark  all  --  ppp2   *       0.0.0.0/0
</I>&gt;<i> 0.0.0.0/0            mark match 0x0/0xff
</I>&gt;<i>  1320 79360 routemark  all  --  ppp3   *       0.0.0.0/0
</I>&gt;<i> 0.0.0.0/0            mark match 0x0/0xff
</I>&gt;<i>  311K  277M tcpre      all  --  *      *       0.0.0.0/0
</I>&gt;<i> 0.0.0.0/0            mark match 0x0/0xff
</I>&gt;<i>     0     0 divert     tcp  --  ppp1   *       0.0.0.0/0
</I>&gt;<i> 10.215.144.48       [goto]  tcp spt:80 flags:!0x17/0x02 socket
</I>&gt;<i> --transparent
</I>&gt;<i>     0     0 divert     tcp  --  ppp2   *       0.0.0.0/0
</I>&gt;<i> 10.215.144.48       [goto]  tcp spt:80 flags:!0x17/0x02 socket
</I>&gt;<i> --transparent
</I>&gt;<i>     0     0 divert     tcp  --  ppp3   *       0.0.0.0/0
</I>&gt;<i> 10.215.144.48       [goto]  tcp spt:80 flags:!0x17/0x02 socket
</I>&gt;<i> --transparent
</I>&gt;<i>    76  7484 TPROXY     tcp  --  enp10s0 *       10.215.144.48
</I>&gt;<i> 0.0.0.0/0            tcp dpt:80 TPROXY redirect 0.0.0.0:3129 mark
</I>&gt;<i> 0x200/0x200
</I>&gt;<i>     0     0 divert     tcp  --  ppp1   *       0.0.0.0/0
</I>&gt;<i> 10.215.144.48       [goto]  tcp spt:443 flags:!0x17/0x02 socket
</I>&gt;<i> --transparent
</I>&gt;<i>     0     0 divert     tcp  --  ppp2   *       0.0.0.0/0
</I>&gt;<i> 10.215.144.48       [goto]  tcp spt:443 flags:!0x17/0x02 socket
</I>&gt;<i> --transparent
</I>&gt;<i>     0     0 divert     tcp  --  ppp3   *       0.0.0.0/0
</I>&gt;<i> 10.215.144.48       [goto]  tcp spt:443 flags:!0x17/0x02 socket
</I>&gt;<i> --transparent
</I>&gt;<i>    10  1060 TPROXY     tcp  --  enp10s0 *       10.215.144.48
</I>&gt;<i> 0.0.0.0/0            tcp dpt:443 TPROXY redirect 0.0.0.0:3130 mark
</I>&gt;<i> 0x200/0x200
</I>&gt;<i> 
</I>&gt;<i> Aren't these the DIVERT rules you are referring to?
</I>&gt;<i> 
</I>

Oh, case sensitivity. I was grep'ing for the upper case chain name.

So you have a 'divert' chain.

First problem with these rules is they depend on an IP address. IP is
the one detail guaranteed not to match properly when TPROXY spoofing is
going on.

Second problem is that they also depend on a source port number of 80 or
443. The traffic needing to be marked comes from both directions, so
this will break half the traffic flow.


Third is that you are using the --transparent option. If I am
understanding it correctly, that will cause the connections out of Squid
(which are marked as transparent) to skip divert action and hit the
TPROXY intercept all over again - infinite loop.

Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="021199.html">[squid-users] (no subject)
</A></li>
	<LI>Next message (by thread): <A HREF="021205.html">[squid-users] (no subject)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21204">[ date ]</a>
              <a href="thread.html#21204">[ thread ]</a>
              <a href="subject.html#21204">[ subject ]</a>
              <a href="author.html#21204">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
