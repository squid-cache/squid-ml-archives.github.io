<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Call for adaptation after sni peeked
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Call%20for%20adaptation%20after%20sni%20peeked&In-Reply-To=%3CCAGRJihX7G3qUp2ApFxbJJzrPKifs0LbiSq53CA-i07T6Ny7%2BuA%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="021207.html">
   <LINK REL="Next"  HREF="021208.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Call for adaptation after sni peeked</H1>
    <B>Jatin Bhasin</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Call%20for%20adaptation%20after%20sni%20peeked&In-Reply-To=%3CCAGRJihX7G3qUp2ApFxbJJzrPKifs0LbiSq53CA-i07T6Ny7%2BuA%40mail.gmail.com%3E"
       TITLE="[squid-users] Call for adaptation after sni peeked">jbhasin83 at gmail.com
       </A><BR>
    <I>Mon Oct 28 07:25:16 UTC 2019</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="021207.html">[squid-users] Call for adaptation after sni peeked
</A></li>
        <LI>Next message (by thread): <A HREF="021208.html">[squid-users] acl for matching URLs (non-regex)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21209">[ date ]</a>
              <a href="thread.html#21209">[ thread ]</a>
              <a href="subject.html#21209">[ subject ]</a>
              <a href="author.html#21209">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Alex,

If I use below squid configuration:

    ssl_bump peek step1
    ssl_bump splice all

I would see fake connect request in step 2 as well. I did not check squid
version 4 but squid version 3 will send second fake connect in ecap adapter
only if we splice step 2 which will be true in above configuration.
But I don't want to splice step 2, well not always. I want my ecap adapter
to get fake connect in all cases in step 2 so that I can then make a
decision on step 2 whether to splice or bump in step 2.
In other words at the end of step 1 squid could make a call to adaptation
acl (it does not currently) which will help to make decisions based on sni
(if available).

As per my understanding squid makes call to adaptation acl in following
cases:
Step 1 - At start of connection but here only ip is available.
Step 2 - only when splicing
I did not check any further from here because then mostly its too late to
bump anyway.

I am happy to send following to another group if you can suggest:
I made a manual code change for acl adaptation at the end of step 1 and I
was able to send fake connect with sni to ecap. I wanted to understand from
experts if these changes are incorrect and may causes issues in some cases
I don't know about?

Thanks,
Jatin

On Thu., 24 Oct. 2019, 07:55 Alex Rousskov, &lt;
<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt; wrote:

&gt;<i> On 10/23/19 3:37 PM, Jatin Bhasin wrote:
</I>&gt;<i>
</I>&gt;<i> &gt; This question is related to ssl decryption and ecap adaptation call.
</I>&gt;<i> &gt; When the ssl connection starts then before it even extracts sni squid
</I>&gt;<i> sends
</I>&gt;<i> &gt; fakeConnect which comes to ecap as well.
</I>&gt;<i>
</I>&gt;<i> Yes, this happens during SslBump step1 as described at
</I>&gt;<i> <A HREF="https://wiki.squid-cache.org/Features/SslPeekAndSplice">https://wiki.squid-cache.org/Features/SslPeekAndSplice</A>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; I am using peek in step 1 and after fakeConnect squid extracts the sni,
</I>&gt;<i> &gt; but at this point squid does not make another call to ecap.
</I>&gt;<i>
</I>&gt;<i> According to the above wiki page (and my understanding of how SslBump
</I>&gt;<i> should work), Squid should make another adaptation pass during step2.
</I>&gt;<i> You may want to make sure that your Squid does not discover some error
</I>&gt;<i> _before_ it can start doing eCAP during step2.
</I>&gt;<i>
</I>&gt;<i> If your eCAP service does not see the second CONNECT (during step2), I
</I>&gt;<i> suggest using the latest Squid v4 with the following &quot;minimal&quot; SslBump
</I>&gt;<i> configuration:
</I>&gt;<i>
</I>&gt;<i>     ssl_bump peek step1
</I>&gt;<i>     ssl_bump splice all
</I>&gt;<i>
</I>&gt;<i> Does the above work without problems when eCAP is turned off?
</I>&gt;<i>
</I>&gt;<i> Does the above deliver the second CONNECT to eCAP when it is enabled?
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; This function in squid is startPeekAndSpliceDone in file
</I>&gt;<i> &gt; client_side.cc
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> We should not be discussing code details on squid-users, but the latest
</I>&gt;<i> Squid v4 does not have that function AFAICT:
</I>&gt;<i>
</I>&gt;<i> &gt; $ git grep startPeekAndSpliceDone SQUID_4_8 | wc -l
</I>&gt;<i> &gt; 0
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Alex.
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20191028/d14a43aa/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20191028/d14a43aa/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="021207.html">[squid-users] Call for adaptation after sni peeked
</A></li>
	<LI>Next message (by thread): <A HREF="021208.html">[squid-users] acl for matching URLs (non-regex)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21209">[ date ]</a>
              <a href="thread.html#21209">[ thread ]</a>
              <a href="subject.html#21209">[ subject ]</a>
              <a href="author.html#21209">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
