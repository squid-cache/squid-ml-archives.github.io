<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid proxy will forward message with 'alternating host header' but logs another?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20proxy%20will%20forward%20message%20with%0A%20%27alternating%20host%20header%27%20but%20logs%20another%3F&In-Reply-To=%3CCAK9S3GrGPdXYGBLcyv%3DNHwsS13%2Bv8a93mKtOqYsa0oWHkGoLFg%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="021219.html">
   <LINK REL="Next"  HREF="021221.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid proxy will forward message with 'alternating host header' but logs another?</H1>
    <B>Mark Bergman</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20proxy%20will%20forward%20message%20with%0A%20%27alternating%20host%20header%27%20but%20logs%20another%3F&In-Reply-To=%3CCAK9S3GrGPdXYGBLcyv%3DNHwsS13%2Bv8a93mKtOqYsa0oWHkGoLFg%40mail.gmail.com%3E"
       TITLE="[squid-users] Squid proxy will forward message with 'alternating host header' but logs another?">xychix2011 at gmail.com
       </A><BR>
    <I>Thu Oct 31 11:48:45 UTC 2019</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="021219.html">[squid-users] Squid proxy will forward message with 'alternating host header' but logs another?
</A></li>
        <LI>Next message (by thread): <A HREF="021221.html">[squid-users] Squid proxy will forward message with 'alternating host header' but logs another?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21220">[ date ]</a>
              <a href="thread.html#21220">[ thread ]</a>
              <a href="subject.html#21220">[ subject ]</a>
              <a href="author.html#21220">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>reincluded the list for completeness and archiving.

We're building a setup where I want to be able to find domain fronting [
<A HREF="https://en.wikipedia.org/wiki/Domain_fronting">https://en.wikipedia.org/wiki/Domain_fronting</A>] attempts in the logs

used test script:
&gt;<i>
</I>&gt;<i> import requests
</I>&gt;<i> proxies = {'http': '<A HREF="http://10.0.0.4:8080">http://10.0.0.4:8080</A>',}
</I>&gt;<i> headers = {&quot;Host&quot;:&quot;someevilhost.appspot.com&quot;,&quot;Orig-Host&quot;:&quot;
</I>&gt;<i> someevilhost.appspot.com&quot;}
</I>&gt;<i> s = requests.Session()
</I>&gt;<i> s.proxies = proxies
</I>&gt;<i> r = s.get('<A HREF="http://www.google.com/">http://www.google.com/</A>',headers=headers)
</I>&gt;<i> print(r.status_code)
</I>&gt;<i> print(r.text[:80])
</I>

my loglines keep showing www.google.com in the host header regardless of
how I set my config. Current config (as added in my pfsense setup)

&gt;<i> host_verify_strict on
</I>&gt;<i> strip_query_terms off
</I>&gt;<i> client_dst_passthru off
</I>&gt;<i> logformat combined2 %&gt;a %[ui %[un [%tl] &quot;%rm %ru HTTP/%rv&quot; %&gt;Hs %&lt;st
</I>&gt;<i> &quot;%{Referer}&gt;h&quot; &quot;%{User-Agent}&gt;h&quot; %Ss:%Sh &quot;%&gt;h&quot;
</I>&gt;<i> access_log <A HREF="tcp://10.1.2.15:1025">tcp://10.1.2.15:1025</A> combined2
</I>&gt;<i> #access_log /var/squid/logs/combined2
</I>

example log line:

&gt;<i> 10.1.2.15 - - [31/Oct/2019:11:42:53 +0000] &quot;GET <A HREF="http://www.google.com/">http://www.google.com/</A>
</I>&gt;<i> HTTP/1.1&quot; 200 6261 &quot;-&quot; &quot;python-requests/2.9.1&quot; TCP_MISS:HIER_DIRECT
</I>&gt;<i> &quot;User-Agent: python-requests/2.9.1\r\nAccept: */*\r\nConnection:
</I>&gt;<i> keep-alive\r\nAccept-Encoding: gzip, deflate\r\nOrig-Host:
</I>&gt;<i> someevilhost.appspot.com\r\nHost: www.google.com\r\n&quot;
</I>

I'm looking for a  way to have Squid log the original request, whatever it
does after that is for this particular test less important (/dev/null or
out to the internet.. both are OK for me as long as 'RFC compliant' traffic
from the webbrowser does get out and logged).

regards,

Mark

On Thu, Oct 31, 2019 at 12:35 PM Mark Bergman &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">xychix2011 at gmail.com</A>&gt; wrote:

&gt;<i> Ok, so there is no way I can have Squid act as most corporate other
</I>&gt;<i> proxies (just forward the request without manipulation)?
</I>&gt;<i> We are building a setup where we want people to recognise domain fronting
</I>&gt;<i> from logs.
</I>&gt;<i> <A HREF="https://en.wikipedia.org/wiki/Domain_fronting">https://en.wikipedia.org/wiki/Domain_fronting</A>
</I>&gt;<i>
</I>&gt;<i> But as I understand now this technique would never work trough a Squid
</I>&gt;<i> proxy (if SSL inspection is enabled). Wonder then if there never had been
</I>&gt;<i> complaints from signal (messaging app) users as they relied on this
</I>&gt;<i> technology for years :)
</I>&gt;<i> We might have to switch to a less RCF compliant proxy for that.
</I>&gt;<i>
</I>&gt;<i> Any help and suggestions are really appreciated.
</I>&gt;<i>
</I>&gt;<i> Regards,
</I>&gt;<i>
</I>&gt;<i> Mark / xychix
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> On Thu, Oct 31, 2019 at 10:04 AM Amos Jeffries &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt;
</I>&gt;<i> wrote:
</I>&gt;<i>
</I>&gt;&gt;<i> On 31/10/19 8:48 pm, Mark Bergman wrote:
</I>&gt;&gt;<i> &gt; Can i stop squid from 'repairing' host headers?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Yes.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> For context:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> RFC 7230 :
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &quot;If the target URI includes an authority component, then a
</I>&gt;&gt;<i>    client MUST send a field-value for Host that is identical to that
</I>&gt;&gt;<i>    authority component&quot;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &quot;If the target URI includes an authority component, then a
</I>&gt;&gt;<i>    client MUST send a field-value for Host that is identical to that
</I>&gt;&gt;<i>    authority component&quot;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &quot;A server MUST respond with a 400 (Bad Request) status code to any
</I>&gt;&gt;<i>    HTTP/1.1 request message that ... contains ... a
</I>&gt;&gt;<i>    Host header field with an invalid field-value.&quot;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> When the host_verify_strict directive is set to &quot;on&quot; then Squid will
</I>&gt;&gt;<i> produce a 4XX status code to any traffic received with invalid Host
</I>&gt;&gt;<i> headers. A Host header that conflicts with info in the URL is always
</I>&gt;&gt;<i> invalid.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Amos
</I>&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;<i> squid-users mailing list
</I>&gt;&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20191031/bbe25397/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20191031/bbe25397/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="021219.html">[squid-users] Squid proxy will forward message with 'alternating host header' but logs another?
</A></li>
	<LI>Next message (by thread): <A HREF="021221.html">[squid-users] Squid proxy will forward message with 'alternating host header' but logs another?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21220">[ date ]</a>
              <a href="thread.html#21220">[ thread ]</a>
              <a href="subject.html#21220">[ subject ]</a>
              <a href="author.html#21220">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
