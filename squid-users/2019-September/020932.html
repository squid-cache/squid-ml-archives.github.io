<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Working peek/splice no longer functioning on some	sites
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Working%20peek/splice%20no%20longer%20functioning%20on%20some%0A%09sites&In-Reply-To=%3C1567370644478-0.post%40n4.nabble.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   
   <LINK REL="Next"  HREF="020933.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Working peek/splice no longer functioning on some	sites</H1>
    <B>torson</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Working%20peek/splice%20no%20longer%20functioning%20on%20some%0A%09sites&In-Reply-To=%3C1567370644478-0.post%40n4.nabble.com%3E"
       TITLE="[squid-users] Working peek/splice no longer functioning on some	sites">cofkomail at gmail.com
       </A><BR>
    <I>Sun Sep  1 20:44:04 UTC 2019</I>
    <P><UL>
        
        <LI>Next message (by thread): <A HREF="020933.html">[squid-users] Working peek/splice no longer functioning on some sites
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20932">[ date ]</a>
              <a href="thread.html#20932">[ thread ]</a>
              <a href="subject.html#20932">[ subject ]</a>
              <a href="author.html#20932">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>For me it works with &quot;ssl_bump peek step1&quot;, not with &quot;ssl_bump peek all&quot;.

My working config using Squid 4.8:
---
visible_hostname squid
debug_options ALL,1
positive_dns_ttl 0
negative_dns_ttl 0
client_persistent_connections off
http_port 3128
http_port 3129 intercept
acl allowed_http_sites dstdom_regex &quot;/etc/squid/allow_list.conf&quot;
http_access allow allowed_http_sites
https_port 3130 intercept ssl-bump \
  tls-cert=/etc/squid/ssl/squid-ca-cert-key.pem \
  options=SINGLE_DH_USE,SINGLE_ECDH_USE,NO_SSLv2,NO_SSLv3 \
  tls-dh=/etc/squid/ssl/dhparam.pem
acl SSL_port port 443
http_access allow SSL_port
acl allowed_https_sites ssl::server_name_regex &quot;/etc/squid/allow_list.conf&quot;
tls_outgoing_options cafile=/etc/ssl/certs/ca-certificates.crt
acl step1 at_step SslBump1
ssl_bump peek step1
ssl_bump splice allowed_https_sites
ssl_bump terminate all
http_access deny all
logformat general      %tl %6tr %&gt;a %Ss/%03&gt;Hs %&lt;st %rm %ssl::bump_mode %ru
%ssl::&gt;sni 
access_log daemon:/var/log/squid/access.log general
---

One thing to note are the &quot;positive_dns_ttl 0&quot; and &quot;negative_dns_ttl 0&quot;
directives ; my findings are that DNS caching needs to be set to zero in
cases where DNS records get changed every minute due to roundrobin combined
with hosting in environments where record changes faster than TTL - on AWS
where you're hitting different DNS servers with each having a different TTL.
I was getting a lot of host forgery errors before setting those to 0.
This is in addition to all the servers using the same DNS address.




--
Sent from: <A HREF="http://squid-web-proxy-cache.1019090.n4.nabble.com/Squid-Users-f1019091.html">http://squid-web-proxy-cache.1019090.n4.nabble.com/Squid-Users-f1019091.html</A>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	
	<LI>Next message (by thread): <A HREF="020933.html">[squid-users] Working peek/splice no longer functioning on some sites
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20932">[ date ]</a>
              <a href="thread.html#20932">[ thread ]</a>
              <a href="subject.html#20932">[ subject ]</a>
              <a href="author.html#20932">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
