<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Working peek/splice no longer functioning on some sites
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Working%20peek/splice%20no%20longer%20functioning%20on%20some%0A%20sites&In-Reply-To=%3C43802926-c454-112d-f0bd-c0b377f5b058%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="020932.html">
   <LINK REL="Next"  HREF="020934.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Working peek/splice no longer functioning on some sites</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Working%20peek/splice%20no%20longer%20functioning%20on%20some%0A%20sites&In-Reply-To=%3C43802926-c454-112d-f0bd-c0b377f5b058%40treenet.co.nz%3E"
       TITLE="[squid-users] Working peek/splice no longer functioning on some sites">squid3 at treenet.co.nz
       </A><BR>
    <I>Mon Sep  2 06:36:11 UTC 2019</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="020932.html">[squid-users] Working peek/splice no longer functioning on some	sites
</A></li>
        <LI>Next message (by thread): <A HREF="020934.html">[squid-users] Linearly increasing delays in HTTPS proxy CONNECTS / 3.5.20
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20933">[ date ]</a>
              <a href="thread.html#20933">[ thread ]</a>
              <a href="subject.html#20933">[ subject ]</a>
              <a href="author.html#20933">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 2/09/19 8:44 am, torson wrote:
&gt;<i> For me it works with &quot;ssl_bump peek step1&quot;, not with &quot;ssl_bump peek all&quot;.
</I>&gt;<i> 
</I>
That tells me that your clients are lying to your proxy.

&quot;peek step1&quot; means only the client-provided detail is available. eg the
client says it is going to example.net (a domain which you allow) but
actually goes to othersite.example.com.

&quot;peek all&quot; means Squid also checks at step 2 against the server
certificate. eg Squid now sees the &quot;othersite.example.com&quot; detail and
rejects/terminates the bad client.



&gt;<i> My working config using Squid 4.8:
</I>&gt;<i> ---
</I>&gt;<i> visible_hostname squid
</I>&gt;<i> debug_options ALL,1
</I>&gt;<i> positive_dns_ttl 0
</I>&gt;<i> negative_dns_ttl 0
</I>
Minimum value for negative_dns_ttl is 1. positive_dns_ttl must be
*greater* than negative_dns_ttl.

&gt;<i> client_persistent_connections off
</I>&gt;<i> http_port 3128
</I>&gt;<i> http_port 3129 intercept
</I>
You are missing the basic DoS and cross-protocol smuggling protections
provided in the default squid.conf.

Without those default rules your proxy is far more vulnerable to DoS
attack than it needs to be. This setup it will perform the complex and
slow regex ACL checking for each DoS request arriving. The defaults are
very fast port/method matches.

I suggest you extend the logformat to record the %ssl::&lt;cert_subject
details from server certificate. Then decide whether (and how) to adjust
the server_name ACL rules.

You may want to use %ssl::&lt;cert_errors as well if the problem is due to
server validation errors.



&gt;<i> acl allowed_http_sites dstdom_regex &quot;/etc/squid/allow_list.conf&quot;
</I>&gt;<i> http_access allow allowed_http_sites
</I>&gt;<i> https_port 3130 intercept ssl-bump \
</I>&gt;<i>   tls-cert=/etc/squid/ssl/squid-ca-cert-key.pem \
</I>&gt;<i>   options=SINGLE_DH_USE,SINGLE_ECDH_USE,NO_SSLv2,NO_SSLv3 \
</I>
SSLv2 related settings are obsolete in Squid-4. Even ones disabling it.

&gt;<i>   tls-dh=/etc/squid/ssl/dhparam.pem
</I>&gt;<i> acl SSL_port port 443
</I>&gt;<i> http_access allow SSL_port
</I>&gt;<i> acl allowed_https_sites ssl::server_name_regex &quot;/etc/squid/allow_list.conf&quot;
</I>&gt;<i> tls_outgoing_options cafile=/etc/ssl/certs/ca-certificates.crt
</I>&gt;<i> acl step1 at_step SslBump1
</I>&gt;<i> ssl_bump peek step1
</I>&gt;<i> ssl_bump splice allowed_https_sites
</I>&gt;<i> ssl_bump terminate all
</I>&gt;<i> http_access deny all
</I>&gt;<i> logformat general      %tl %6tr %&gt;a %Ss/%03&gt;Hs %&lt;st %rm %ssl::bump_mode %ru
</I>&gt;<i> %ssl::&gt;sni 
</I>&gt;<i> access_log daemon:/var/log/squid/access.log general
</I>&gt;<i> ---
</I>&gt;<i> 
</I>&gt;<i> One thing to note are the &quot;positive_dns_ttl 0&quot; and &quot;negative_dns_ttl 0&quot;
</I>&gt;<i> directives ; my findings are that DNS caching needs to be set to zero in
</I>&gt;<i> cases where DNS records get changed every minute due to roundrobin combined
</I>&gt;<i> with hosting in environments where record changes faster than TTL - on AWS
</I>&gt;<i> where you're hitting different DNS servers with each having a different TTL.
</I>&gt;<i> I was getting a lot of host forgery errors before setting those to 0.
</I>&gt;<i> This is in addition to all the servers using the same DNS address.
</I>&gt;<i> 
</I>
IMO you are misunderstanding what the problem is and causing yourself
potentially worse problems in the long run.

FYI: Round-robin DNS has almost nothing to do with this issue. Under
round-robin the IPs Squid is checking for are still present, just not
first in the set. So the Host verify passes.
 The only part it might have is when the IP address set is too big for
the DNS packets your network (and your upstreams) allow. EDNS and
Jumbogram support resolves these issues entirely.


 The problem is that the DNS responses from the providers are *entirely*
different from one lookup to the next. This is guaranteed to happen when
Squid and the client are using completely different DNS resolver chains
for their lookups.

 -&gt; If the DNS resolver difference is within your network, you need to
fix *that* instead of hacking away at the DNS cache in Squid to violate
DNS protocol requirements. The client and other DNS caches in your
network are still using those TTLs properly - so you are just shifting
the verify failure from one HTTP transaction to another.

 -&gt; If the DNS chain difference is at the provider end (as it is for
Akamai CDN, and anyone using Google resolvers). Then you need to
*reduce* the number of out-of-sync lookups being done by both Squid and
the client. This TTL hack is the exact opposite of what you need. Best
workaround is to have your internal resolver setup to extend the TTLs
for the known problematic services.


Setting negative_dns_ttl to value less than 1 second causes every
*internal* use of the IP address by Squid to require a new DNS lookup.
This can result is weird behaviour like the arriving request http_access
rules matching against one IP, the server being connected to having a
second IP and the log entry recording yet another one.

Ignoring the proper TTLs can also result in your server being detected
by anti-DoS protection at your upstream DNS provider(s) and blocked from
service entirely.

You have been lucky that your config is so simple it does not do more
than 2 DNS queries per request, and/or that your traffic volume is so
low the premature repeat queries are not being noticed (yet).


FWIW: the use of &quot;client_persistent_connections off&quot; which you have does
more to address the problem those CDN create. It prevents clients
re-using a TCP connection setup with now-stale DNS details. Boosting
Squid's chance of seeing the same DNS the client has.


HTH
Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="020932.html">[squid-users] Working peek/splice no longer functioning on some	sites
</A></li>
	<LI>Next message (by thread): <A HREF="020934.html">[squid-users] Linearly increasing delays in HTTPS proxy CONNECTS / 3.5.20
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20933">[ date ]</a>
              <a href="thread.html#20933">[ thread ]</a>
              <a href="subject.html#20933">[ subject ]</a>
              <a href="author.html#20933">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
