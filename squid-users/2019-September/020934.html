<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Linearly increasing delays in HTTPS proxy CONNECTS / 3.5.20
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Linearly%20increasing%20delays%20in%20HTTPS%20proxy%0A%20CONNECTS%20/%203.5.20&In-Reply-To=%3C380CBB39-AAC1-48D9-823D-3B7312A16399%40iki.fi%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="020933.html">
   <LINK REL="Next"  HREF="020935.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Linearly increasing delays in HTTPS proxy CONNECTS / 3.5.20</H1>
    <B>Ilari Laitinen</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Linearly%20increasing%20delays%20in%20HTTPS%20proxy%0A%20CONNECTS%20/%203.5.20&In-Reply-To=%3C380CBB39-AAC1-48D9-823D-3B7312A16399%40iki.fi%3E"
       TITLE="[squid-users] Linearly increasing delays in HTTPS proxy CONNECTS / 3.5.20">ilari.laitinen at iki.fi
       </A><BR>
    <I>Mon Sep  2 11:22:47 UTC 2019</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="020933.html">[squid-users] Working peek/splice no longer functioning on some sites
</A></li>
        <LI>Next message (by thread): <A HREF="020935.html">[squid-users] Squid 4.8 Issue
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20934">[ date ]</a>
              <a href="thread.html#20934">[ thread ]</a>
              <a href="subject.html#20934">[ subject ]</a>
              <a href="author.html#20934">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>&gt;<i> On 30 Aug 2019, at 16.40, Alex Rousskov &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt; wrote:
</I>&gt;<i> 
</I>&gt;<i> On 8/30/19 8:16 AM, Ilari Laitinen wrote:
</I>&gt;<i> 
</I>&gt;&gt;<i> I suspect Squid might be waiting for local TCP ports from the kernel
</I>&gt;&gt;<i> (or something related).
</I>&gt;<i> 
</I>&gt;<i> IIRC, ephemeral source port allocator is instantaneous -- Squid either
</I>&gt;<i> gets a port or a port allocation error, without waiting. When we
</I>&gt;<i> overload the server with high-performance tests (without an explicit
</I>&gt;<i> port manager), we see port allocation errors rather than stalled tests.
</I>&gt;<i> However, perhaps that is not true in your OS/environment.
</I>
Ah yes, of course. I actually saw this error first-hand when setting up the test environment.

&gt;&gt;<i> Right now, there are four different IP addresses returned for the
</I>&gt;&gt;<i> target cloud service. For practical purposes, they are returned in a
</I>&gt;&gt;<i> random order. The traffic would ideally be spread over all of them.
</I>&gt;&gt;<i> Unfortunately it is evident both from the debug log and from the TCP
</I>&gt;&gt;<i> dump that Squid is using only one of the addresses at a time. The
</I>&gt;&gt;<i> amount of connections in the TIME_WAIT state for that single IP
</I>&gt;&gt;<i> address gets very close to the maximum defined by the
</I>&gt;&gt;<i> net.ipv4.ip_local_port_range sysctl. After a while (a minute or so in
</I>&gt;&gt;<i> the recording) this address changes presumably in response to a new
</I>&gt;&gt;<i> DNS query result.
</I>&gt;<i> 
</I>&gt;<i> In theory, Squid should round-robin across all destination IP addresses
</I>&gt;<i> for a single host name. If your Squid v3 does not, it is probably a
</I>&gt;<i> Squid bug that can be fixed [by upgrading].
</I>&gt;<i> 
</I>&gt;<i> Said that, IIRC, the notion of &quot;round robin&quot; is rather vague in Squid
</I>&gt;<i> because there are several places where an IP may be requested for the
</I>&gt;<i> same host name inside the same transaction. I would not be surprised if
</I>&gt;<i> that low-level round-robin behavior results in the same IP being used
</I>&gt;<i> for most transactions in some environments (until an error or a new DNS
</I>&gt;<i> query reshuffles the IPs). Debugging logs may expose this problem.
</I>
I looked into this further. All our tcp dumps so far show the same: Squid uses (almost always) exactly one remote address at a time. The increasing delays start right after Squid has switched to a new remote IP and last precisely until another switch happens (typically the next one). The problem does not occur every time and is not limited to a single target IP.

Now that I know that this is not expected and is possibly related to a bug, I&#8217;ll look into upgrading Squid from the platform default.

&gt;&gt;<i> One possible workaround that I can think of is setting a short
</I>&gt;&gt;<i> positive_dns_ttl, but this doesn&#8217;t fully guarantee an even
</I>&gt;&gt;<i> distribution, now does it?
</I>&gt;<i> 
</I>&gt;<i> No, it does not. Moreover, Squid v3 had some TTL handling bugs that were
</I>&gt;<i> fixed (in v4 and later code) by the Happy Eyeballs project. Taking all
</I>&gt;<i> the known problems into the account, it is difficult for me to predict
</I>&gt;<i> the effect of changing TTLs. Said that, it does not hurt to try! Maybe
</I>&gt;<i> you will be lucky, and a simple configuration change will remove the
</I>&gt;<i> cause of increasing transaction delays.
</I>
Thank you very much for your informed and timely replies!

I&#8217;ll report our results here.

Best,

-- 
Ilari Laitinen



</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="020933.html">[squid-users] Working peek/splice no longer functioning on some sites
</A></li>
	<LI>Next message (by thread): <A HREF="020935.html">[squid-users] Squid 4.8 Issue
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20934">[ date ]</a>
              <a href="thread.html#20934">[ thread ]</a>
              <a href="subject.html#20934">[ subject ]</a>
              <a href="author.html#20934">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
