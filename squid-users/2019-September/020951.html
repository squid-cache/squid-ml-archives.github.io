<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Cant open some HTTPS with Squid 4.8
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Cant%20open%20some%20HTTPS%20with%20Squid%204.8&In-Reply-To=%3C881f770c-e591-9475-bd52-d604d9847f40%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="020943.html">
   <LINK REL="Next"  HREF="020957.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Cant open some HTTPS with Squid 4.8</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Cant%20open%20some%20HTTPS%20with%20Squid%204.8&In-Reply-To=%3C881f770c-e591-9475-bd52-d604d9847f40%40treenet.co.nz%3E"
       TITLE="[squid-users] Cant open some HTTPS with Squid 4.8">squid3 at treenet.co.nz
       </A><BR>
    <I>Tue Sep  3 13:33:58 UTC 2019</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="020943.html">[squid-users] Cant open some HTTPS with Squid 4.8
</A></li>
        <LI>Next message (by thread): <A HREF="020957.html">[squid-users] Cant open some HTTPS with Squid 4.8
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20951">[ date ]</a>
              <a href="thread.html#20951">[ thread ]</a>
              <a href="subject.html#20951">[ subject ]</a>
              <a href="author.html#20951">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 3/09/19 11:47 pm, KOTOXJle6 wrote:
&gt;<i> Im trying to setup Squid 4.8 on Ubuntu 18.04 LTS with HTTPS redirecting to
</I>&gt;<i> squid error page for sites in ACL's. Yesterday i faced major problem HTTPS
</I>&gt;<i> sites doesnt open normally in IE11/EDGE and show blank page only + squid
</I>&gt;<i> replace certificate. If i tap F5, sometimes site opens like it should and
</I>&gt;<i> certificate replacement doesnt happen...and it works not for all sites. I
</I>&gt;<i> couldn't pinpoint the dependencies. I also can open some sites like
</I>&gt;<i> rambler.ru, kanobu.ru, alexa.com normally. The most interesting thing is
</I>&gt;<i> that other browsers like Chrome, FF and even Opera open all sites like it
</I>&gt;<i> should and spoof cert + redirect to error page only if site persist in ACL.
</I>&gt;<i> 
</I>
Huh? what is &quot;only if site persist in ACL&quot; meaning?


&gt;<i> What i already did:
</I>&gt;<i> - Disabled IPv6 on Squid host
</I>&gt;<i> - Disabled/Enabled TLS in IE in any variations
</I>&gt;<i> - Disabled SPDY/3
</I>&gt;<i> 
</I>&gt;<i> Bump settings in squid.conf:
</I>&gt;<i> 
</I>&gt;<i> /http_port 3128 ssl-bump generate-host-certificates=on
</I>&gt;<i> dynamic_cert_mem_cache_size=4MB cert=/etc/squid/squidCA.pem
</I>&gt;<i> ssl_bump peek all/
</I>&gt;<i> 
</I>&gt;<i> I have this errors in /var/log/squid/cache.log
</I>&gt;<i> 
</I>&gt;<i> /ERROR: negotiating TLS on FD 46: error:1425F175:SSL
</I>&gt;<i> routines:ssl_choose_client_version:inappropriate fallback (1/-1/0)/
</I>&gt;<i> 
</I>&gt;<i> /ERROR: negotiating TLS on FD 104: error:14094410:SSL
</I>&gt;<i> routines:ssl3_read_bytes:sslv3 alert handshake failure (1/-1/0)
</I>&gt;<i> /
</I>&gt;<i> 
</I>&gt;<i> /ERROR: negotiating TLS on FD 27: error:1423406E:SSL
</I>&gt;<i> routines:tls_parse_stoc_sct:bad extension (1/-1/0)/
</I>&gt;<i> 
</I>
Any of the above errors may occur when connecting a specific client to a
specific server. SSL-Bump is riding the fine line of capability/feature
matching between three TLS/SSL librarys and the software using them -
two sets of which are remote machinery.
 All of the above errors (and more) will result in the symptoms you
describe happening. If you don't already know what they mean, use your
favourite search engine. They are quite common and well explained
already by others.

To make any real progress you (or someone) will need to view the TLS
Hello exchanges happening on *both* the client&lt;-&gt;Squid and the
Squid&lt;-&gt;server connections. I suggest combining a tcpdump capture
(_full_ packets) compared with Squid &quot;debug_options 11,2&quot; info about
what the FD are being used for.
 It may be obvious what is going on when you look at that info.


[ If that process is new to you, then I do highly recommend you take a
little time to become familiar. TLS is a changing environment and
SSL-Bump will be presenting you with more these types of error/problem
that need dealing with in future. ]


&gt;<i> Error in access.log
</I>&gt;<i> 
</I>&gt;<i> /TCP_DENIED/407 4141 CONNECT i.ibb.co:443 - HIER_NONE/- text/html/
</I>&gt;<i> 
</I>
407 - HTTP authentication credentials are required for this CONNECT
transaction to happen.

IMPORTANT:  When you have configured proxy authentication and SSL-Bump
you need to be *very* careful to ensure the proxy requests (and gets)
the credentials on  the initial client CONNECT request - *and* that the
credentials remain valid for the entire time the HTTPS tunnel is going
to be open. If their need is only discovered later (or any
refresh/update to them) then all Squid can do is abort the HTTPS with an
error.

Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="020943.html">[squid-users] Cant open some HTTPS with Squid 4.8
</A></li>
	<LI>Next message (by thread): <A HREF="020957.html">[squid-users] Cant open some HTTPS with Squid 4.8
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20951">[ date ]</a>
              <a href="thread.html#20951">[ thread ]</a>
              <a href="subject.html#20951">[ subject ]</a>
              <a href="author.html#20951">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
