<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid CAS integration
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20CAS%20integration&In-Reply-To=%3C9a3e1b8c-f8be-67de-d350-655c399d8ed1%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="020971.html">
   <LINK REL="Next"  HREF="020973.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid CAS integration</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20CAS%20integration&In-Reply-To=%3C9a3e1b8c-f8be-67de-d350-655c399d8ed1%40treenet.co.nz%3E"
       TITLE="[squid-users] Squid CAS integration">squid3 at treenet.co.nz
       </A><BR>
    <I>Fri Sep  6 12:48:42 UTC 2019</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="020971.html">[squid-users] Squid CAS integration
</A></li>
        <LI>Next message (by thread): <A HREF="020973.html">[squid-users] usage of etag
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20972">[ date ]</a>
              <a href="thread.html#20972">[ thread ]</a>
              <a href="subject.html#20972">[ subject ]</a>
              <a href="author.html#20972">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 6/09/19 9:36 pm, Dario Basset wrote:
&gt;<i> Thanks.
</I>&gt;<i> 
</I>&gt;<i> -&gt; &#160;With CAS I mean the Central Authentication Service, which is supported
</I>&gt;<i> here: <A HREF="https://github.com/apereo/cas">https://github.com/apereo/cas</A> &#160;or here:
</I>&gt;<i> <A HREF="https://www.apereo.org/projects/cas">https://www.apereo.org/projects/cas</A> &#160; &#160; It is a system for Single Sign On
</I>&gt;<i> authentication with Service Ticket, and it is quite used in Universities. We
</I>&gt;<i> want to integrate Squid with CAS auth.
</I>&gt;<i> The authentication provided by CAS is based on a mechanism which redirect
</I>&gt;<i> user navigation to CAS University site, and proceed only when credentials
</I>&gt;<i> are valid. In this way the site that picks the credentials is not an
</I>&gt;<i> application site, but it is University CAS itself. The application that uses
</I>&gt;<i> University CAS is simply redirecting user navigation, that it takes the
</I>&gt;<i> control.
</I>&gt;<i> 
</I>&gt;<i> -&gt; &#160;Ok for PHP
</I>&gt;<i> 
</I>&gt;<i> -&gt; &#160;For what concerns Squid helpers, I saw some examples, but most of those
</I>&gt;<i> examples are based never-ending loops that wait for standard input and then
</I>&gt;<i> proceed with authentication. In this loop, the credentials are picked by
</I>&gt;<i> Squid web server. We do not want this. We want credentials to be inputted in
</I>&gt;<i> our CAS portal system. But I don't know how to code configuration file for
</I>&gt;<i> Squid and related helpers.
</I>
Ah, you are misunderstanding the purpose of the helpers.

In order to handle a clients traffic Squid needs to process the rules
you configured. Sometimes those rules need the answers to questions
Squid cannot answer by itself; eg &quot;are the user credentials valid&quot;, or
&quot;should this URL be redirected elsewhere?&quot;

What Squid does then is send a query to the helper which can answer that
question, and the helper responds with OK/ERR (yes or no) and maybe some
parameters Squid can use to continue the processing. To the helper HTTP
traffic is just an infinite series of &quot;Can I do X?&quot; questions from Squid.


Looking at the CAS documentation, they have helpfully provided a message
flow diagram for how web traffic needs to be handled and authenticated
against the CAS server.

see &quot;Web Flow Diagram&quot; at
 &lt;<A HREF="https://apereo.github.io/cas/4.2.x/protocol/CAS-Protocol.html">https://apereo.github.io/cas/4.2.x/protocol/CAS-Protocol.html</A>&gt;

Squid and  URL-redirect helper would be doing the actions in the
&quot;Protected App&quot; column, and generating the 302 responses.

[ It occurs to me, that if you ask about the CAS community you may find
someone who already did this integration and has a Squid helper. Even
though CAS has not been mentioned here before. ]


Your squid.conf would look like this:

 # check every URL to see if 302 redirect is needed
 url_rewrite_helper /path/to/your/helper

 # tell the URL helper about any Cookie header
 url_rewrite_extras %#&gt;h{Cookie}

 # do not try to redirect clients visiting the CAS login page
 acl CAS_server dstdomain cas.example.com
 url_rewrite_access deny !CAS_server

 # add a Set-Cookie header supplied by the URL helper (if any)
 acl CAS_cookie note cas-cookie_
 reply_header_add Cookie &quot;%note{cas-cookie_}&quot; CAS_cookie


For every HTTP request Squid handles, it will send your helper one line
ending with a newline (\n) character. That line will contain the URL the
client was trying to visit, followed by the Cookie header(s) straight
from HTTP message with URL / %-encoding.


The helper needs to respond back with a line containing some values
depending on which of the yellow boxes is happening.

* When there is no CAS Cookie in the ones supplied by Squid (or Squid
cannot deliver any), *and* no CAS ticket on the URL then the first / top
yellow box is happening.
 The helper should produce:

  OK status=302 url=<A HREF="https://cas.example.com/cas/login?service=...">https://cas.example.com/cas/login?service=...</A>

where &quot;...&quot; is the %-encoded value of URL Squid said the client was
trying to fetch. Notice how these details correlate to what the CAS
diagram first column is saying.


* When there is no Cookie etc and there _is_ a ticket parameter. The
second yellow box has been reached.
 The helper needs to do the background GET request to verify the ticket
with the CAS server. GET /serviceValidate request to the CAS server and
process the response to find the value needing to go into Set-Cookie header.
 When it has those details it should produce:

  OK status=302 url=... cas-cookie_=BLAH

where &quot;...&quot; is the URL the client was trying to fetch but without the
&quot;ticket=&quot; parameter; and &quot;BLAH&quot; is the string to put in the Cookie header.

NOTE: since Cookie header values contain quotes, whitespace and special
characters the BLAH string should be %-encoded. Squid should decode it
before use.


* When there is a CAS server Cookie and no ticket parameter. The third
(or fourth) yellow box has been reached. The helper should just validate
the cookie.

If the Cookie validates the helper should produce:

  ERR

Despite what the letters may imply this just means not to redirect.

If the Cookie failed to validate. I guess you redirect to the CAS server
login page as per earlier at the first yellow box, maybe? the diagram
does not mention that situation.



PS. If you are interested the full details of helper protocol for URL
redirector is at:
 &lt;<A HREF="https://wiki.squid-cache.org/Features/AddonHelpers#URL_manipulation">https://wiki.squid-cache.org/Features/AddonHelpers#URL_manipulation</A>&gt;

Since the Cookie handling could be quite slow, you might want to use the
concurrency channels feature to allow parallel processing by the helper.
Get the helper working with the basics first though.

Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="020971.html">[squid-users] Squid CAS integration
</A></li>
	<LI>Next message (by thread): <A HREF="020973.html">[squid-users] usage of etag
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20972">[ date ]</a>
              <a href="thread.html#20972">[ thread ]</a>
              <a href="subject.html#20972">[ subject ]</a>
              <a href="author.html#20972">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
