<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid Transparent Proxy with Coovachilli is not	working
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20Transparent%20Proxy%20with%20Coovachilli%20is%20not%0A%09working&In-Reply-To=%3C1568348861951-0.post%40n4.nabble.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="021027.html">
   <LINK REL="Next"  HREF="021010.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid Transparent Proxy with Coovachilli is not	working</H1>
    <B>sknz</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20Transparent%20Proxy%20with%20Coovachilli%20is%20not%0A%09working&In-Reply-To=%3C1568348861951-0.post%40n4.nabble.com%3E"
       TITLE="[squid-users] Squid Transparent Proxy with Coovachilli is not	working">sakibnizam at gmail.com
       </A><BR>
    <I>Fri Sep 13 04:27:41 UTC 2019</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="021027.html">[squid-users] Multiple LDAP authentication server for Squid
</A></li>
        <LI>Next message (by thread): <A HREF="021010.html">[squid-users] Squid Transparent Proxy with Coovachilli is not	working
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21004">[ date ]</a>
              <a href="thread.html#21004">[ thread ]</a>
              <a href="subject.html#21004">[ subject ]</a>
              <a href="author.html#21004">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I'm running an AP-Hotspot server(coovachilli, freeradius, squid, etc.) with
two NIC(eth0 and eth1). eth0 is for WAN(internet) and eth1 is for managing
LAN(APs). Coovachilli is created tun0 under the eth1 interface. I'm using
squid3 as an HTTP transparent proxy.

Hardware Setup Diagram &lt;<A HREF="https://i.stack.imgur.com/sKF9e.png">https://i.stack.imgur.com/sKF9e.png</A>&gt;  

*SQUID.CONF:*
http_port 3128
http_port 3127 intercept

*IPTABLES Filter &amp; Nat Rules(similar):*
-A PREROUTING -s 10.1.0.0/24 ! -d 10.1.0.1/32 -i tun0 -p tcp -m tcp --dport
80 -j REDIRECT --to-ports 3127 #redirect http to squid intercept port
-A POSTROUTING -o eth0 -j MASQUERADE

-A PREROUTING -s 10.1.0.0/24 -d 10.1.0.1/32 -p tcp -m tcp --dport 3127 -j
DROP #drop direct attempts to proxy intercept port
-A FORWARD -p tcp -m tcp --tcp-flags SYN,RST SYN -j TCPMSS
--clamp-mss-to-pmtu

-A INPUT -i eth1 -j DROP
-A INPUT -d 10.1.0.1/32 -i tun0 -p icmp -j ACCEPT
-A INPUT -d 10.1.0.1/32 -i tun0 -p tcp -m tcp --dport 3128 -j ACCEPT #
opening squid port
-A INPUT -d 10.1.0.1/32 -i tun0 -p tcp -m tcp --dport 3127 -j ACCEPT
-A INPUT -d 10.1.0.1/32 -i tun0 -p tcp -m tcp --dport 443 -j ACCEPT
-A INPUT -d 10.1.0.1/32 -i tun0 -p tcp -m tcp --dport 80 -j ACCEPT
-A INPUT -d 10.1.0.1/32 -i tun0 -j DROP
-A FORWARD -i tun0 -o eth0 -j ACCEPT                                                                                                                            
-A FORWARD -i tun0 ! -o eth0 -j DROP
-A FORWARD -p tcp -m tcp --tcp-flags SYN,RST SYN -j TCPMSS
--clamp-mss-to-pmtu
-A FORWARD -o tun0 -j ACCEPT
-A FORWARD -i tun0 -j ACCEPT
-A FORWARD -o eth1 -j DROP
-A FORWARD -i eth1 -j DROP

HTTPS connection from AP side is working as in squid don't intercept it, but
HTTP connection doesn't work. Squid_3.4.8_Debian starts
normally(active/running), no error in cache.log. If I change squid
configuration(http_port 3127 accel vhost allow-direct) to reverse proxy, it
works. I need a transparent proxy to work. Please help me to figure it out.
Thanks.



--
Sent from: <A HREF="http://squid-web-proxy-cache.1019090.n4.nabble.com/Squid-Users-f1019091.html">http://squid-web-proxy-cache.1019090.n4.nabble.com/Squid-Users-f1019091.html</A>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="021027.html">[squid-users] Multiple LDAP authentication server for Squid
</A></li>
	<LI>Next message (by thread): <A HREF="021010.html">[squid-users] Squid Transparent Proxy with Coovachilli is not	working
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21004">[ date ]</a>
              <a href="thread.html#21004">[ thread ]</a>
              <a href="subject.html#21004">[ subject ]</a>
              <a href="author.html#21004">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
