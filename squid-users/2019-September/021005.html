<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] intercept vs. accel vhost allow-direct
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20intercept%20vs.%20accel%20vhost%20allow-direct&In-Reply-To=%3C68044a53-b15c-2ef7-6817-88e956709bdb%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="020992.html">
   <LINK REL="Next"  HREF="021006.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] intercept vs. accel vhost allow-direct</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20intercept%20vs.%20accel%20vhost%20allow-direct&In-Reply-To=%3C68044a53-b15c-2ef7-6817-88e956709bdb%40treenet.co.nz%3E"
       TITLE="[squid-users] intercept vs. accel vhost allow-direct">squid3 at treenet.co.nz
       </A><BR>
    <I>Fri Sep 13 05:46:25 UTC 2019</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="020992.html">[squid-users] intercept vs. accel vhost allow-direct
</A></li>
        <LI>Next message (by thread): <A HREF="021006.html">[squid-users] intercept vs. accel vhost allow-direct
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21005">[ date ]</a>
              <a href="thread.html#21005">[ thread ]</a>
              <a href="subject.html#21005">[ subject ]</a>
              <a href="author.html#21005">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 12/09/19 9:53 pm, sknz wrote:
&gt;<i> Hello,
</I>&gt;<i> 
</I>&gt;<i> &lt;<A HREF="http://squid-web-proxy-cache.1019090.n4.nabble.com/file/t377788/test.png">http://squid-web-proxy-cache.1019090.n4.nabble.com/file/t377788/test.png</A>&gt; 
</I>&gt;<i> 
</I>&gt;<i> etho0 is for WAN and eth1 is for LAN side.
</I>&gt;<i> 
</I>&gt;<i> and more detailed firewall settings:
</I>&gt;<i> 
</I>&gt;<i> # Generated by iptables-save v1.4.21 on Thu Sep 12 15:46:58 2019
</I>&gt;<i> *nat
</I>&gt;<i> :PREROUTING ACCEPT [3911:298328]
</I>&gt;<i> :INPUT ACCEPT [384:30494]
</I>&gt;<i> :OUTPUT ACCEPT [273:20568]
</I>&gt;<i> :POSTROUTING ACCEPT [13:3456]
</I>&gt;<i> -A PREROUTING -s 10.1.0.0/24 ! -d 10.1.0.1/32 -i tun0 -p tcp -m tcp --dport
</I>&gt;<i> 80 -j REDIRECT --to-ports 3128
</I>

There are two suspect things about this rule.
 1) the port here does not match the port 3129 you mentioned earlier as
having the intercept flag. Those two must be the same. Avoiding port
3128 in these things is a good idea, it is well-known and registered for
other uses.

 2) the interface here is tun0, you said eth1 is your LAN side.

You do not technically need the interface name in this rule, it is just
an extra protection against spoofed IPs coming from the WAN.

I would try without the -i option. If that works, then you can test
which interface is needed to continue working when the -i is added back.


&gt;<i> -A POSTROUTING -o eth0 -j MASQUERADE
</I>&gt;<i> COMMIT
</I>&gt;<i> # Completed on Thu Sep 12 15:46:58 2019
</I>&gt;<i> # Generated by iptables-save v1.4.21 on Thu Sep 12 15:46:58 2019
</I>&gt;<i> *mangle
</I>&gt;<i> :PREROUTING ACCEPT [10761:3310565]
</I>&gt;<i> :INPUT ACCEPT [3211:587384]
</I>&gt;<i> :FORWARD ACCEPT [6306:2611786]
</I>&gt;<i> :OUTPUT ACCEPT [2279:577020]
</I>&gt;<i> :POSTROUTING ACCEPT [5283:2937872]
</I>&gt;<i> -A PREROUTING -s 10.1.0.0/24 -d 10.1.0.1/32 -p tcp -m tcp --dport 3128 -j
</I>&gt;<i> DROP
</I>
The above rule is dropping access to your proxy port 3128. Which is the
forward-proxy port for clients configured properly to use the proxy,
error page icons, and other things needing direct client&lt;-&gt;proxy contact.

The recommended mangle table rule to protect the proxy intercept port
would be just &quot;-A PREROUTING -p tcp -m tcp --dport 3129 -j DROP&quot;

So the proxy is protected from all traffic. Even from localhost, or
outside your network.


&gt;<i> # Completed on Thu Sep 12 15:46:58 2019
</I>&gt;<i> # Generated by iptables-save v1.4.21 on Thu Sep 12 15:46:58 2019
</I>&gt;<i> *filter
</I>&gt;<i> :INPUT ACCEPT [1989:462678]
</I>&gt;<i> :FORWARD ACCEPT [0:0]
</I>&gt;<i> :OUTPUT ACCEPT [2279:577020]
</I>&gt;<i> -A INPUT -i eth1 -j DROP
</I>&gt;<i> -A INPUT -d 10.1.0.1/32 -i tun0 -p icmp -j ACCEPT
</I>&gt;<i> -A INPUT -d 10.1.0.1/32 -i tun0 -p udp -m udp --dport 53 -j ACCEPT
</I>&gt;<i> -A INPUT -d 10.1.0.1/32 -i tun0 -p udp -m udp --dport 67:68 -j ACCEPT
</I>&gt;<i> -A INPUT -d 255.255.255.255/32 -i tun0 -p udp -m udp --dport 67:68 -j ACCEPT
</I>&gt;<i> -A INPUT -d 10.1.0.1/32 -i tun0 -p tcp -m tcp --dport 3128 -j ACCEPT
</I>
If you need this rule to get traffic to &quot; http_port 3128&quot;, then you
probably also need one for the &quot;http_port 3129 intercept&quot;.


Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="020992.html">[squid-users] intercept vs. accel vhost allow-direct
</A></li>
	<LI>Next message (by thread): <A HREF="021006.html">[squid-users] intercept vs. accel vhost allow-direct
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21005">[ date ]</a>
              <a href="thread.html#21005">[ thread ]</a>
              <a href="subject.html#21005">[ subject ]</a>
              <a href="author.html#21005">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
