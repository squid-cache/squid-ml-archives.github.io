<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] intercept vs. accel vhost allow-direct
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20intercept%20vs.%20accel%20vhost%20allow-direct&In-Reply-To=%3C20190913083606.GA21563%40fantomas.sk%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="021006.html">
   <LINK REL="Next"  HREF="021009.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] intercept vs. accel vhost allow-direct</H1>
    <B>Matus UHLAR - fantomas</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20intercept%20vs.%20accel%20vhost%20allow-direct&In-Reply-To=%3C20190913083606.GA21563%40fantomas.sk%3E"
       TITLE="[squid-users] intercept vs. accel vhost allow-direct">uhlar at fantomas.sk
       </A><BR>
    <I>Fri Sep 13 08:36:06 UTC 2019</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="021006.html">[squid-users] intercept vs. accel vhost allow-direct
</A></li>
        <LI>Next message (by thread): <A HREF="021009.html">[squid-users] intercept vs. accel vhost allow-direct
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21007">[ date ]</a>
              <a href="thread.html#21007">[ thread ]</a>
              <a href="subject.html#21007">[ subject ]</a>
              <a href="author.html#21007">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 13.09.19 03:12, sknz wrote:
&gt;<i>For clarification, I'm running an AP-Hotspot server(coovachilli, freeradius,
</I>&gt;<i>squid, etc.) with two NIC(eth0 and eth1). eth0 is for WAN(internet) and eth1
</I>&gt;<i>is for managing LAN(APs). Coovachilli is created tun0 under the eth1
</I>&gt;<i>interface. I'm using squid-3.4.8 as an HTTP transparent proxy.
</I>
you still don't accept nor NAT connections from eth0 to port 80 in the world.

you only do that with tunneled connections.

&gt;<i># This is my updated squid.conf as your suggestion, 3129 for forward-proxy
</I>&gt;<i>and 3130 for intercepting HTTP:
</I>&gt;<i>http_port 3129
</I>&gt;<i>http_port 3130 intercept
</I>
I really wonder why didn't you keep 3128 for forward proxy as before.
People using explicit proxy on port 3128 wouldn't have to change it.

The intercepting port doesn't matter much, because it's only between
firewall/NAT and squid, users won't see it.

&gt;<i>I've tried removing all &quot;-i&quot; options and updating mangle rules as your
</I>&gt;<i>suggestion from iptables; no effects on it. I've opened intercept port also.
</I>&gt;<i>This is my original iptables with adjusted rules:
</I>&gt;<i>
</I>&gt;<i>#nat
</I>&gt;<i>-A PREROUTING -s 10.1.0.0/24 ! -d 10.1.0.1/32 -i tun0 -p tcp -m tcp --dport
</I>&gt;<i>80 -j REDIRECT --to-ports 3130    #redirect http to squid intercept port
</I>&gt;<i>-A POSTROUTING -o eth0 -j MASQUERADE
</I>&gt;<i>
</I>&gt;<i>#mangle
</I>&gt;<i>-A PREROUTING -s 10.1.0.0/24 -d 10.1.0.1/32 -p tcp -m tcp --dport 3130 -j
</I>&gt;<i>DROP    #drop direct attempts to proxy intercept port
</I>
don't you drop all connections that should be natted to 3130 here?
Try dropping this rule.

&gt;<i>-A FORWARD -p tcp -m tcp --tcp-flags SYN,RST SYN -j TCPMSS
</I>&gt;<i>--clamp-mss-to-pmtu
</I>&gt;<i>
</I>&gt;<i>#filters
</I>&gt;<i>-A INPUT -i eth1 -j DROP
</I>
I wonder you can communicate with LAN at all, when you drop anyting coming from it.

&gt;<i>-A INPUT -d 10.1.0.1/32 -i tun0 -p icmp -j ACCEPT
</I>&gt;<i>-A INPUT -d 10.1.0.1/32 -i tun0 -p udp -m udp --dport 53 -j ACCEPT
</I>&gt;<i>-A INPUT -d 10.1.0.1/32 -i tun0 -p udp -m udp --dport 67:68 -j ACCEPT
</I>&gt;<i>-A INPUT -d 255.255.255.255/32 -i tun0 -p udp -m udp --dport 67:68 -j ACCEPT
</I>&gt;<i>-A INPUT -d 10.1.0.1/32 -i tun0 -p tcp -m tcp --dport 3130 -j ACCEPT
</I>&gt;<i>#squid intercept
</I>&gt;<i>-A INPUT -d 10.1.0.1/32 -i tun0 -p tcp -m tcp --dport 3129 -j ACCEPT
</I>&gt;<i>#squid forward
</I>&gt;<i>-A INPUT -d 10.1.0.1/32 -i tun0 -p tcp -m tcp --dport 3990 -j ACCEPT
</I>&gt;<i>#chilli controller
</I>&gt;<i>-A INPUT -d 10.1.0.1/32 -i tun0 -p tcp -m tcp --dport 53 -j ACCEPT
</I>&gt;<i>-A INPUT -d 10.1.0.1/32 -i tun0 -p tcp -m tcp --dport 2812 -j ACCEPT #
</I>&gt;<i>freeradius
</I>&gt;<i>-A INPUT -d 10.1.0.1/32 -i tun0 -p tcp -m tcp --dport 22 -j ACCEPT
</I>&gt;<i>-A INPUT -d 10.1.0.1/32 -i tun0 -p tcp -m tcp --dport 443 -j ACCEPT    #
</I>&gt;<i>https
</I>&gt;<i>-A INPUT -d 10.1.0.1/32 -i tun0 -p tcp -m tcp --dport 80 -j ACCEPT    #http
</I>&gt;<i>-A INPUT -d 10.1.0.1/32 -i tun0 -p tcp -m tcp --dport 4990 -j ACCEPT
</I>&gt;<i>#hotspot UAM
</I>&gt;<i>-A INPUT -d 10.1.0.1/32 -i tun0 -p tcp -m tcp --dport 3990 -j ACCEPT
</I>&gt;<i>-A INPUT -d 10.1.0.1/32 -i tun0 -j DROP
</I>&gt;<i>-A FORWARD -i tun0 -o eth0 -j ACCEPT
</I>&gt;<i>-A FORWARD -i tun0 ! -o eth0 -j DROP
</I>&gt;<i>-A FORWARD -p tcp -m tcp --tcp-flags SYN,RST SYN -j TCPMSS
</I>&gt;<i>--clamp-mss-to-pmtu
</I>&gt;<i>-A FORWARD -o tun0 -j ACCEPT
</I>&gt;<i>-A FORWARD -i tun0 -j ACCEPT
</I>&gt;<i>-A FORWARD -o eth1 -j DROP
</I>&gt;<i>-A FORWARD -i eth1 -j DROP
</I>
-- 
Matus UHLAR - fantomas, <A HREF="https://lists.squid-cache.org/listinfo/squid-users">uhlar at fantomas.sk</A> ; <A HREF="http://www.fantomas.sk/">http://www.fantomas.sk/</A>
Warning: I wish NOT to receive e-mail advertising to this address.
Varovanie: na tuto adresu chcem NEDOSTAVAT akukolvek reklamnu postu.
I wonder how much deeper the ocean would be without sponges.

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="021006.html">[squid-users] intercept vs. accel vhost allow-direct
</A></li>
	<LI>Next message (by thread): <A HREF="021009.html">[squid-users] intercept vs. accel vhost allow-direct
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21007">[ date ]</a>
              <a href="thread.html#21007">[ thread ]</a>
              <a href="subject.html#21007">[ subject ]</a>
              <a href="author.html#21007">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
