<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] How to extend Squid ICAP preview size
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20How%20to%20extend%20Squid%20ICAP%20preview%20size&In-Reply-To=%3Caedf10fe-5b19-5455-6ac0-9e34331fe79d%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="021031.html">
   <LINK REL="Next"  HREF="021033.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] How to extend Squid ICAP preview size</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20How%20to%20extend%20Squid%20ICAP%20preview%20size&In-Reply-To=%3Caedf10fe-5b19-5455-6ac0-9e34331fe79d%40measurement-factory.com%3E"
       TITLE="[squid-users] How to extend Squid ICAP preview size">rousskov at measurement-factory.com
       </A><BR>
    <I>Mon Sep 16 15:54:23 UTC 2019</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="021031.html">[squid-users] How to extend Squid ICAP preview size
</A></li>
        <LI>Next message (by thread): <A HREF="021033.html">[squid-users] How to extend Squid ICAP preview size
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21032">[ date ]</a>
              <a href="thread.html#21032">[ thread ]</a>
              <a href="subject.html#21032">[ subject ]</a>
              <a href="author.html#21032">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 9/16/19 10:37 AM, Felipe Arturo Polanco wrote:

&gt;<i> We would like to add some logic to our custom made ICAP server, one of
</I>&gt;<i> these logics is to analyze up to 10MB of data of a given file and if the
</I>&gt;<i> file is larger than that, squid should not keep sending it to icap,
</I>&gt;<i> basically, a 204 message should be returned.
</I>
&gt;<i> squid has a cap of 64K of preview size that limit us in the aspect.
</I>
True.


&gt;<i> Is there a way to extend this limit? Modifying the source code perhaps?
</I>
Yes, of course.


&gt;<i> If so, what are the disadvantages of doing so? 
</I>
Simply increasing BodyPipe::MaxCapacity might open you up to
difficult-to-find vulnerabilities where some old Squid code still
assumes that the buffers are limited by 64KB and crashes/asserts when
that assumption becomes false. FWIW, I have not audited all
BodyPipe-related code and do not know whether such bad code exists today.

Increasing BodyPipe::MaxCapacity will also increase Squid RAM
requirements if your Squid receives requests (and/or ICAP
REQMOD-generated HTTP responses) that exceed 64KB body limit. I am not
sure about regular responses -- their accumulation is limited by
other/independent restrictions.


&gt;<i> Would it require more RAM per response 
</I>
[You should worry about &quot;per message&quot; accumulation -- requests will use
the same limit, even if you do not have REQMOD services.]

Yes, but only for messages that exceed the limit.


&gt;<i> or is RAM dynamically allocated as the file is being received?
</I>
Yes, the RAM in question is allocated dynamically on &quot;as needed&quot; basis.

YMMV, but Squid may slow down a lot while dealing with the associated
reallocations because of the too-small 64KB increment used for each such
reallocation.


An alternative solution to consider here is extending ICAP features to
allow for splicing of the 10MB prefix (analyzed _and_ returned back by
the ICAP server) and the remaining virgin response suffix (paused
without excessive accumulation on the Squid side). This would be similar
to the existing ICAP 206 use-original-body=&quot;10MB&quot; feature[1], but would
require additional negotiation and changes to disable storage of the
10MB prefix on the Squid side.

This alternative can be implemented without worrying about hidden 64KB
body buffer assumptions, but the implementation will not be trivial.

[1]
<A HREF="http://www.icap-forum.org/documents/specification/draft-icap-ext-partial-content-07.txt">http://www.icap-forum.org/documents/specification/draft-icap-ext-partial-content-07.txt</A>


HTH,

Alex.

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="021031.html">[squid-users] How to extend Squid ICAP preview size
</A></li>
	<LI>Next message (by thread): <A HREF="021033.html">[squid-users] How to extend Squid ICAP preview size
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21032">[ date ]</a>
              <a href="thread.html#21032">[ thread ]</a>
              <a href="subject.html#21032">[ subject ]</a>
              <a href="author.html#21032">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
