<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Peek-and-splice not working when mixing TLS1.3 servers and TLS1.2 clients
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Peek-and-splice%20not%20working%20when%20mixing%20TLS1.3%0A%20servers%20and%20TLS1.2%20clients&In-Reply-To=%3C71523daa-6521-118f-7a59-b47930e562e0%40ntcomputer.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="021098.html">
   <LINK REL="Next"  HREF="021059.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Peek-and-splice not working when mixing TLS1.3 servers and TLS1.2 clients</H1>
    <B>Nikolaus</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Peek-and-splice%20not%20working%20when%20mixing%20TLS1.3%0A%20servers%20and%20TLS1.2%20clients&In-Reply-To=%3C71523daa-6521-118f-7a59-b47930e562e0%40ntcomputer.de%3E"
       TITLE="[squid-users] Peek-and-splice not working when mixing TLS1.3 servers and TLS1.2 clients">dc.sqml at ntcomputer.de
       </A><BR>
    <I>Fri Sep 20 14:53:41 UTC 2019</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="021098.html">[squid-users] Protecting squid against ddos attacks
</A></li>
        <LI>Next message (by thread): <A HREF="021059.html">[squid-users] Peek-and-splice not working when mixing TLS1.3 servers and TLS1.2 clients
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21057">[ date ]</a>
              <a href="thread.html#21057">[ thread ]</a>
              <a href="subject.html#21057">[ subject ]</a>
              <a href="author.html#21057">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I have a transparent squid 4.8 proxy peek-and-splice setup acting as a
TLS domain filtering proxy. The setup worked well, until more and more
servers started adopting TLS 1.3. In this case, depending on the client
TLS version, errors started to appear:

If server, squid and client use TLS 1.3: Everything works as expected.
If server and squid use TLS 1.3, but client only supports TLS 1.2: The
client terminates the connection due to certificate verification errors.

I have had a look at what happens at TLS protocol level using wireshark,
and it seems that in the latter case, squid - for some reason - performs
(something similar to) bumping instead of splicing! That is, squid sends
back certificates to the client which are completely different than the
ones received from the server, and appear to be generated. Any
ClientKeyExchange received from the client also wouldn't be forwarded to
the server.

The following is the relevant part of my squid config:

https_port 3443 intercept ssl-bump cert=/etc/squid/dummy.pem.crt
key=/etc/squid/dummy.pem.key
ssl_bump peek step1 all
ssl_bump peek step2 allowed_https_connections
ssl_bump terminate step2 all
ssl_bump splice step3 allowed_https_connections
ssl_bump terminate all

where allowed_https_connections is an ACL checking ssl::server_name.

How can I get the splicing setup working when mixing TLS 1.3 servers and
TLS 1.2 clients?

Many thanks!
Nikolaus

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="021098.html">[squid-users] Protecting squid against ddos attacks
</A></li>
	<LI>Next message (by thread): <A HREF="021059.html">[squid-users] Peek-and-splice not working when mixing TLS1.3 servers and TLS1.2 clients
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21057">[ date ]</a>
              <a href="thread.html#21057">[ thread ]</a>
              <a href="subject.html#21057">[ subject ]</a>
              <a href="author.html#21057">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
