<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Kerberos nad keytab problem
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Kerberos%20nad%20keytab%20problem&In-Reply-To=%3Cvmime.5d8b815d.644e.66bf9b8b2d7cc2ad%40ms249-lin-003.rotterdam.bazuin.nl%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="021085.html">
   <LINK REL="Next"  HREF="021089.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Kerberos nad keytab problem</H1>
    <B>L.P.H. van Belle</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Kerberos%20nad%20keytab%20problem&In-Reply-To=%3Cvmime.5d8b815d.644e.66bf9b8b2d7cc2ad%40ms249-lin-003.rotterdam.bazuin.nl%3E"
       TITLE="[squid-users] Kerberos nad keytab problem">belle at bazuin.nl
       </A><BR>
    <I>Wed Sep 25 15:01:49 UTC 2019</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="021085.html">[squid-users] Kerberos nad keytab problem
</A></li>
        <LI>Next message (by thread): <A HREF="021089.html">[squid-users] Kerberos nad keytab problem
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21088">[ date ]</a>
              <a href="thread.html#21088">[ thread ]</a>
              <a href="subject.html#21088">[ subject ]</a>
              <a href="author.html#21088">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I also had problems with msktutil.. so i suggest you try this, see below.. 
Im using it for few years and it always works (for me offcourse).. 
&#160;
It&#160;should be pretty simple, but the site squid-cache (wiki) is in my opinion a bit outdated. 
And its for Amos to adapt it on the site.
&#160;
Amos or Alex, please review below, you might want to add it. 
And add your parts to it, like running this without a correct spn. 
&#160;
Its tested in use&#160;and and working since squid 3.1 upto 4.8. 
Tested on debian Wheezy (7) upto Buster (10)
&#160;
Below assumes the server your setting up, does have an A and PTR record. 

(note, which should be added at the&#160;domain join of winbind, as of samba4.x )
&#160;
This is my howto. 
A&#160;Debian based,&#160;with Kerberos Auth against an Samba Active Directory
Should be adaptable for any OS, should also work with MS Active Directory. 
But since i dont have any, im not testing it. 
&#160;
&#160;
# Install a minimal OS, at install only choose base + ssh server. 
# Setup these variable for a copy/past, might be handy, and then &quot;it just works&quot;&#160; 
&#160;
# Obligated to set.&#160; # ADDOM; 
# This should match the netbios (NT4) domain name in caps, per example from a login: NTDOM\username 
ADDOM=&quot;NTDOM&quot; 
&#160;
# These should be fine, but if you have multiple ipnumbers and hostnames, you might want to adjust these. 
FQDN=&quot;$(hostname -f)&quot;
HOSTN=&quot;$(hostname -s)&quot;

# Requirements before you start installing the sofrware like: squid winbind krb5-user
&#160;
# Login, sudo to root.
#&#160;/etc/resolv.conf, set as followed. 
#search must.match.your.primarydnsdomain.tld
# nameserver ip_of_AD_DC
&#160;
# Verify it: 
grep search /etc/resolv.conf
grep nameserver /etc/resolv.conf

&#160;
# If ok, then run : 
apt update&#160;
apt install squid winbind krb5-user -y
&#160;
# Just hit enter on every question, the defaults are fine. (verified in Debian).
&#160;
# And now verify /etc/krb5.conf
less /etc/krb5.conf
&#160;
&#160;
# It should look like this :&#160; 
#[libdefaults]
#&#160;&#160;&#160;&#160;&#160;&#160;&#160; default_realm = YOUR.Detected_REALM.TLD 
#
# The following krb5.conf variables are only for MIT Kerberos.
#&#160;&#160;&#160;&#160;&#160;&#160; kdc_timesync = 1
#&#160;&#160;&#160;&#160;&#160;&#160;&#160; ccache_type = 4
#&#160;&#160;&#160;&#160;&#160;&#160;&#160; forwardable = true
#&#160;&#160;&#160;&#160;&#160;&#160;&#160; proxiable = true
&#160;
# ... and more.. 

#&#160; &gt;&gt;&#160; P.s.&#160; i never touch krb5.conf, never needed, it &quot;just works&quot; &lt;&lt; 
&#160;
# Set REALM Variable now, default should be ok. dont touch it. 
REALM=&quot;$(grep default_realm /etc/krb5.conf |awk {' print $NF '}) &quot;
# It's used for smb.conf and the auth part of squid. 
&#160;

# then stop squid and samba and configure it.
systemctl stop squid winbind
&#160;
# flush the log, so if you start it you&#160;start with a clean log. &#160;
&gt;<i>&#160;/var/log/squid/cache.log
</I>&#160;
#&#160;Configure smb.conf and join the AD domain,&#160; the minimal setting for smb.conf.
cp /etc/samba/smb.conf{,.original}
&#160;
echo &quot;# Auth-Only setup with winbind. ( no Shares )
&#160;
&#160;&#160;&#160; workgroup = ${ADDOM}
&#160;&#160;&#160; security = ADS
&#160;&#160;&#160; realm = ${REALM}
&#160;&#160;&#160; netbios name = $(echo ${HOSTN^^})
&#160;
&#160;&#160;&#160; ## make sure the below number never overlap system ranges, see /etc/adduser.conf 
&#160;&#160;&#160; ## map id's outside to domain to tdb files.
&#160;&#160;&#160; idmap config *: backend = tdb
&#160;&#160;&#160; idmap config *: range = 2000-9999
&#160;
&#160;&#160;&#160; ## map ids from the domain and (*) the range may not overlap !
&#160;&#160;&#160; idmap config ${ADDOM} : backend = rid
&#160;&#160;&#160; idmap config ${ADDOM} : range = 10000-3999999
&#160;
&#160;&#160;&#160; kerberos method = secrets and keytab
&#160;&#160;&#160; dedicated keytab file = /etc/krb5.keytab
&#160;
&#160;&#160;&#160; # renew the kerberos ticket
&#160;&#160;&#160; winbind refresh tickets = yes
&quot; &gt; /etc/samba/smb.conf
&#160;
# And verify it.
less /etc/samba/smb.conf
&#160;
# Next step, join the AD domain. 
# Login/auth with kerberos. 
kinit Administrator
&#160;
# and join the domain.
net ads join -k
&#160;
# Creating the squid keytab file.
&#160;
export KRB5_KTNAME=FILE:/etc/squid/squid-HTTP-${HOSTN}.keytab
net ads keytab ADD HTTP/${FQDN}

#Verify the keytab file : 
klist -ke /etc/squid/squid-HTTP-${HOSTN}.keytab
&#160;
# destroy you authentication ticket for Administrator. 
kdestroy 
&#160;
# set correct rights. 
chmod 640 /etc/squid/squid-HTTP-${HOSTN}.keytab
chown root:proxy /etc/squid/squid-HTTP-${HOSTN}.keytab
# Note, you might need to change the &quot;proxy&quot; group name here. 
&#160;
# and setup you squid auth. 
echo &quot;auth_param negotiate program /usr/lib/squid/negotiate_wrapper_auth \\
&#160;&#160;&#160; --kerberos /usr/lib/squid/negotiate_kerberos_auth \\
&#160;&#160;&#160;&#160;&#160; -k etc/squid/squid-HTTP-${HOSTN}.keytab&quot; \\
&#160;&#160;&#160;&#160;&#160; -s HTTP/&quot;${FQDN}&quot;@&quot;${REALM}&quot;&#160; \\
&#160;&#160;&#160; --ntlm /usr/bin/ntlm_auth \\
&#160;&#160;&#160;&#160;&#160; --helper-protocol=gss-spnego --domain=&quot;${ADDOM}&quot;
&#160;
auth_param negotiate children 30 startup=5 idle=5
auth_param negotiate children 10
auth_param negotiate keep_alive on&quot; &gt; /etc/squid/conf.d/auth.conf
&#160;
systemctl start winbind squid 
&#160;
# Done 
# And check squid log how it started. 
cat /var/log/squid/cache.log

Now go configure the other parts you need of squid. 

And enjoy..&#160; :-) 
&#160;
&#160;
Greetz, 
&#160;
Louis
&#160;
&#160;
&#160;

Van: squid-users [mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>] Namens Tevfik Ceydeliler
Verzonden: woensdag 25 september 2019 13:59
Aan: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
Onderwerp: [squid-users] Kerberos nad keytab problem



Hi, I try to use kerberos in my squid. Nut I get an error message :


############################33
msktutil --auto-update --verbose --computer-name suqidpnb1 --server dctoyo1.toyo.grp -k /etc/squid/PROXY.keytab &#160;
&#160;-- init_password: Wiping the computer password structure
&#160;-- generate_new_password: Generating a new, random password for the computer account
&#160;-- generate_new_password: &#160;Characters read from /dev/urandom = 95
&#160;-- create_fake_krb5_conf: Created a fake krb5.conf file: /tmp/.msktkrb5.conf-QCbGC5
&#160;-- destroy_g_context: Destroying Kerberos Context
&#160;-- initialize_g_context: Creating Kerberos Context
&#160;-- finalize_exec: SAM Account Name is: suqidpnb1$
&#160;-- try_machine_keytab_princ: Trying to authenticate for suqidpnb1$ from local keytab
&#160;-- try_machine_keytab_princ: Error: krb5_get_init_creds_keytab failed (Key table entry not found)
&#160;-- try_machine_keytab_princ: Authentication with keytab failed
&#160;-- try_machine_keytab_princ: Trying to authenticate for SUQIDPNB1$ from local keytab
&#160;-- try_machine_keytab_princ: Error: krb5_get_init_creds_keytab failed (Key table entry not found)
&#160;-- try_machine_keytab_princ: Authentication with keytab failed
&#160;-- try_machine_keytab_princ: Trying to authenticate for host/localhost from local keytab
&#160;-- try_machine_keytab_princ: Error: krb5_get_init_creds_keytab failed (Key table entry not found)
&#160;-- try_machine_keytab_princ: Authentication with keytab failed
&#160;-- try_machine_password: Trying to authenticate for suqidpnb1$ with password
&#160;-- create_default_machine_password: Default machine password for suqidpnb1$ is suqidpnb1
&#160;-- try_machine_password: Error: krb5_get_init_creds_keytab failed (Client not found in Kerberos database)
&#160;-- try_machine_password: Authentication with password failed
&#160;-- try_user_creds: Checking if default ticket cache has tickets
&#160;-- try_user_creds: Error: krb5_cc_get_principal failed (No credentials cache found)
&#160;-- try_user_creds: User ticket cache was not valid
Error: could not find any credentials to authenticate with. Neither keytab,
default machine password, nor calling user's tickets worked. Try
&quot;kinit&quot;ing yourself some tickets with permission to create computer
objects, or pre-creating the computer object in AD and selecting
'reset account'.



#############################33
Can't find why this happen:




My AD is 2012R2 function level
I create keytab with this:
msktutil -c -b &quot;OU=Servers,DC=toyo,DC=grp&quot; -s HTTP/squidtoyopnb1.toyo.grp -k /etc/squid/PROXY.keytab --computer-name SQUIDPNB1 --upn HTTP/squidtoyopnb1.toyo.grp --server dctoyo1.toyo.grp --verbose --enctypes 28



Keytab file permission is:
-rw-r----- 1 root squid 933 Sep 25 13:37 PROXY.keytab



and keytab file (klist -k output):


&#160; &#160;3 SQUIDPNB1$@TOYO.GRP
&#160; &#160;3 SQUIDPNB1$@TOYO.GRP
&#160; &#160;3 SQUIDPNB1$@TOYO.GRP
&#160; &#160;3 HTTP/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squidtoyopnb1.toyo.grp at TOYO.GRP</A>
&#160; &#160;3 HTTP/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squidtoyopnb1.toyo.grp at TOYO.GRP</A>
&#160; &#160;3 HTTP/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squidtoyopnb1.toyo.grp at TOYO.GRP</A>
&#160; &#160;3 host/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squidtoyopnb1 at TOYO.GRP</A>
&#160; &#160;3 host/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squidtoyopnb1 at TOYO.GRP</A>
&#160; &#160;3 host/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squidtoyopnb1 at TOYO.GRP</A>
&#160; &#160;3 host/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squidtoyopnb1.toyo.grp at TOYO.GRP</A>
&#160; &#160;3 host/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squidtoyopnb1.toyo.grp at TOYO.GRP</A>
&#160; &#160;3 host/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squidtoyopnb1.toyo.grp at TOYO.GRP</A>



krb5.conf:
[libdefaults]
default_realm = TOYO.GRP
&#160; &#160; &#160; &#160; dns_lookup_kdc = no
&#160; &#160; &#160; &#160; dns_lookup_realm = no
&#160; &#160; &#160; &#160; ticket_lifetime = 24h
&#160; &#160; &#160; &#160; default_keytab_name = /etc/squid/PROXY.keytab

&#160; &#160; ; for Windows 2008 with AES
&#160; &#160; &#160; &#160; &#160; default_tgs_enctypes = aes256-cts-hmac-sha1-96 rc4-hmac des-cbc-crc des-cbc-md5
&#160; &#160; &#160; &#160; &#160; default_tkt_enctypes = aes256-cts-hmac-sha1-96 rc4-hmac des-cbc-crc des-cbc-md5
&#160; &#160; &#160; &#160; &#160; permitted_enctypes = aes256-cts-hmac-sha1-96 rc4-hmac des-cbc-crc des-cbc-md5

&#160; &#160; [realms]
TOYO.GRP = {
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; kdc = dctoyo1.toyo.grp
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; kdc = DCTOYO2.toyo.grp
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; admin_server = 10.65.12.254
&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; default_domain = toyo.grp
&#160; &#160; &#160;}

&#160; &#160; [domain_realm]
&#160; &#160; &#160;toyo.grp = TOYO.GRP
&#160; &#160; &#160;.toyo.grp = TOYO.GRP

&#160; &#160; [logging]
&#160; &#160; &#160; kdc = FILE:/var/log/kdc.log
&#160; &#160; &#160; admin_server = FILE:/var/log/kadmin.log
&#160; &#160; &#160; default = FILE:/var/log/krb5lib.log









-- 
Tevfik Ceydeliler

-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20190925/cd55eb1c/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20190925/cd55eb1c/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="021085.html">[squid-users] Kerberos nad keytab problem
</A></li>
	<LI>Next message (by thread): <A HREF="021089.html">[squid-users] Kerberos nad keytab problem
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21088">[ date ]</a>
              <a href="thread.html#21088">[ thread ]</a>
              <a href="subject.html#21088">[ subject ]</a>
              <a href="author.html#21088">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
