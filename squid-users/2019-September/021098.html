<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Protecting squid against ddos attacks
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Protecting%20squid%20against%20ddos%20attacks&In-Reply-To=%3Cb0f7061b-6076-49f0-a9f7-a037c7f49b7b%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="021069.html">
   <LINK REL="Next"  HREF="021057.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Protecting squid against ddos attacks</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Protecting%20squid%20against%20ddos%20attacks&In-Reply-To=%3Cb0f7061b-6076-49f0-a9f7-a037c7f49b7b%40treenet.co.nz%3E"
       TITLE="[squid-users] Protecting squid against ddos attacks">squid3 at treenet.co.nz
       </A><BR>
    <I>Thu Sep 26 11:02:42 UTC 2019</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="021069.html">[squid-users] Protecting squid against ddos attacks
</A></li>
        <LI>Next message (by thread): <A HREF="021057.html">[squid-users] Peek-and-splice not working when mixing TLS1.3 servers and TLS1.2 clients
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21098">[ date ]</a>
              <a href="thread.html#21098">[ thread ]</a>
              <a href="subject.html#21098">[ subject ]</a>
              <a href="author.html#21098">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 23/09/19 1:59 am, Chirayu Patel wrote:
&gt;<i> Hi Amos,
</I>&gt;<i> 
</I>&gt;<i> Thanks a lot for giving some amazing insights..
</I>&gt;<i> 
</I>&gt;<i> So currently I am using Squid to achieve 2 things :
</I>&gt;<i> a) Content Filtering - by checking the url against an external db and
</I>&gt;<i> allow and block it accordingly. (using url_rewriter).&#160;
</I>&gt;<i> b) To popup captive portal
</I>&gt;<i> 
</I>&gt;<i> 1) Regarding the use of 4 ports
</I>&gt;<i> Using iptables, I am redirecting the non authenticated users to
</I>&gt;<i> ports&#160;3132&#160; &#160;&amp;&#160;3133. And then in squid i am checking the port on which I
</I>&gt;<i> have received the request from. If its the above ports, then I run the
</I>&gt;<i> captive portal flow
</I>&gt;<i> 
</I>&gt;<i> Once the user is authenticated , then I redirect their traffic to
</I>&gt;<i> ports&#160;3129 and 3131, and for those ports I run the content policy flow.
</I>&gt;<i> 
</I>&gt;<i> I am not sure if this is the right way of choosing the flow. Please
</I>&gt;<i> advise if there is any other way to run two different flows with one squid.
</I>
TOS or NFMARK are designed for that type of traffic control. Squid
integrates with those system features.

The ports design works too though. It is just a matter of choice between
the three mechanisms, up to you.

&gt;<i> 
</I>&gt;<i> 3) Right now I have configured firewall to only allow these 4 ports on
</I>&gt;<i> the INPUT chain, so I am not expecting traffic to come from any other
</I>&gt;<i> ports. In that case, is it okay if I have removed the default config and
</I>&gt;<i> kept&#160; &quot;http_access allow all&quot; ??
</I>&gt;<i> The only issue is that the attacker now has 4 ports to run attacks on.
</I>&gt;<i> 
</I>
I hope you restrict which clients are being NAT'ed into the proxy, *and*
prohibit clients connecting directly to the http(s)_port's (that mangle
rule in our wiki config example).
 That would restrict the 'from anywhere', issues somewhat.


The remaining problem is that clients can instruct the proxy to open
opaque TCP tunnels _to anywhere_. That is buried inside the HTTP syntax
and can occur any distance down the stream of HTTP messages clients
send. Also, some protocols (eg email spam delivery) can be passed
through an HTTP proxy as custom HTTP message headers.
 A firewall can only be used on the Squid&lt;-&gt;server connections. Which
leaves DoS vulnerability from all the resource consumption by the proxy
handling those messages.


&gt;<i> 4)&#160;&gt; on_unsupported_protocol tunnel all&#160;
</I>&gt;<i> 
</I>&gt;<i> I had added this when I faced issue with one of the Apps, Whatsapp which
</I>&gt;<i> send the http traffic on https port. If I replace that with *respond*, I
</I>&gt;<i> guess Whatsapp will become unusable.. right ?
</I>&gt;<i> 
</I>
Yes. The key thing here is being aware of the issue, and handling it as
best you can at the firewall as traffic goes in/out of the proxy.

&gt;<i> 
</I>&gt;<i> 6)&#160;cache_mem 0 MB
</I>&gt;<i> The default cache memory is quite huge (256 MB). That is approx the
</I>&gt;<i> total usable memory I have on the AP. In that case, what do you think
</I>&gt;<i> should be a good starting point in case I keep it to a non zero value ?
</I>
You can gain a fair amount of the benefits from just a few MB. You could
start with 1-2 MB and adjust from there.


&gt;<i> 
</I>&gt;<i> 7) memory_pools off
</I>&gt;<i> Again, I was too concerned about memory use and I got scared because of
</I>&gt;<i> this comment&#160;
</I>&gt;<i> ------ ------ ------ ------ ------ ------ ------ ------ ------ ------
</I>&gt;<i> ------ ------ ------ ------
</I>&gt;<i> If set, Squid will keep pools of allocated (but unused) memory&#160;available
</I>&gt;<i> for future use. If memory is a premium on your&#160;system and you believe
</I>&gt;<i> your malloc library outperforms Squid&#160;&#160;routines, disable this.
</I>&gt;<i> ------------- ------ ------ ------ ------ ------ ------ ------ ------
</I>&gt;<i> ------ ------ ------ &#160;
</I>&gt;<i> But I believe some memory in exchange of performance is OK. So I am
</I>&gt;<i> going to enable it.
</I>
You can use &lt;<A HREF="http://www.squid-cache.org/Doc/config/memory_pools_limit/">http://www.squid-cache.org/Doc/config/memory_pools_limit/</A>&gt;
to restrict how much extra memory Squid holds onto in the pools. You
probably want to try that at 1 MB or 512 KB.


&gt;<i> 
</I>&gt;<i> 9)&#160;max_filedesc 5120.
</I>&gt;<i> I had kept this number bigger because we were getting &quot;out of file
</I>&gt;<i> descriptors error&quot;
</I>
This is still quite small. The default should be 64KB on most systems
these days. The 1024 is used as an absolute minimal value when system
capability detection fails.


&gt;<i> 
</I>&gt;<i> 10) Above all, the best thing would be a way to differentiate between a
</I>&gt;<i> high traffic flow of http(s) requests coming in from legitimate users vs
</I>&gt;<i> a high traffic flow generated by an attacker with a simple script.&#160;
</I>&gt;<i> 
</I>Without knowing in advance what that &quot;simple script&quot; is going to send
that is a very hard problem. It could literally be anything.

You can possibly make an external ACL helper that takes details about
the HTTP request and does some ML processing to decide whether to block
it. But ironically the delays inherent in that processing make the proxy
more at risk for DoS until it detects the attack pattern.


Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="021069.html">[squid-users] Protecting squid against ddos attacks
</A></li>
	<LI>Next message (by thread): <A HREF="021057.html">[squid-users] Peek-and-splice not working when mixing TLS1.3 servers and TLS1.2 clients
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21098">[ date ]</a>
              <a href="thread.html#21098">[ thread ]</a>
              <a href="subject.html#21098">[ subject ]</a>
              <a href="author.html#21098">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
