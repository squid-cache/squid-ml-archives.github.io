<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Need support on HTTPs port forward
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Need%20support%20on%20HTTPs%20port%20forward&In-Reply-To=%3CCAJea6dNw%2Bi0H-eX07Zm3YzKJky76mF4sXjUv8s4RJjsSbozBWw%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   
   <LINK REL="Next"  HREF="021875.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Need support on HTTPs port forward</H1>
    <B>Raghu nathan</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Need%20support%20on%20HTTPs%20port%20forward&In-Reply-To=%3CCAJea6dNw%2Bi0H-eX07Zm3YzKJky76mF4sXjUv8s4RJjsSbozBWw%40mail.gmail.com%3E"
       TITLE="[squid-users] Need support on HTTPs port forward">raghu.vdm at gmail.com
       </A><BR>
    <I>Wed Apr  1 13:34:26 UTC 2020</I>
    <P><UL>
        
        <LI>Next message (by thread): <A HREF="021875.html">[squid-users] Multiple access logs
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21874">[ date ]</a>
              <a href="thread.html#21874">[ thread ]</a>
              <a href="subject.html#21874">[ subject ]</a>
              <a href="author.html#21874">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>*Hello Team,*


I&#8217;m new to Squid and need some support on advance topic, request you to
advice on this requirement.


I&#8217;m trying to achieve below scenario for HTTPs traffic.


Client&#8212;&#8212;&#8212;&gt;VPN&#8212;&#8212;&#8212;&gt;SQUID&#8212;&#8212;&#8212;&#8212;&#8212;&gt;Internet


*Condition:*


   - VPN and SQUID on same machine
   - I didn&#8217;t want end-user (client) to know about proxy, so no
   configuration allowed on client end.
   - I&#8217;m ok to restrict/allow traffic based on SNI, so no need to decrypt
   the SSL packet


I was following this article to achieve this

<A HREF="https://wiki.squid-cache.org/ConfigExamples/Intercept/SslBumpExplicit">https://wiki.squid-cache.org/ConfigExamples/Intercept/SslBumpExplicit</A>


I have success fully rerouted the traffic on CentOS7 machine towards SQUID

HTTP traffic is working as expected, I&#8217;m able to apply policy based on
custom build Helper (Python)

SQUID not able to decode the HTTPs URL even I used ssl-bump with intercept
after going over resources on internet.

Notably I got  below errors,


X-Squid-Error: ERR_INVALID_REQ 0

ERROR: No forward-proxy ports configured.



*Below is the Firewalld config*


  services: http https ipsec

  ports: 500/udp 4500/udp 3127/tcp 3126/tcp

  protocols:


&gt;<i>   masquerade: yes
</I>
  forward-ports: port=80:proto=tcp:toport=3127:toaddr=10.128.0.4

port=443:proto=tcp:toport=3126:toaddr=10.128.0.4


*Below is the Squid.conf*


debug_options ALL,1 11,3 20,3

#

# Recommended minimum configuration:

#


&gt;<i> # Example rule allowing access from your local networks.
</I>
# Adapt to list your (internal) IP networks from where browsing

# should be allowed

acl localnet src 10.0.0.0/8 # RFC1918 possible internal network

acl localnet src 172.16.0.0/12 # RFC1918 possible internal network

acl localnet src 192.168.0.0/16 # RFC1918 possible internal network

acl localnet src fc00::/7       # RFC 4193 local private network range

acl localnet src fe80::/10      # RFC 4291 link-local (directly plugged)
&gt;<i> machines
</I>

&gt;<i> acl SSL_ports port 443
</I>
acl Safe_ports port 80 # http

acl Safe_ports port 21 # ftp

acl Safe_ports port 443 # https

acl Safe_ports port 70 # gopher

acl Safe_ports port 210 # wais

acl Safe_ports port 1025-65535 # unregistered ports

acl Safe_ports port 280 # http-mgmt

acl Safe_ports port 488 # gss-http

acl Safe_ports port 591 # filemaker

acl Safe_ports port 777 # multiling http

acl CONNECT method CONNECT


&gt;<i> #
</I>
# Recommended minimum Access Permission configuration:

#

# Deny requests to certain unsafe ports

#http_access deny !Safe_ports


&gt;<i> # Deny CONNECT to other than secure SSL ports
</I>
#http_access deny CONNECT !SSL_ports


&gt;<i> # Only allow cachemgr access from localhost
</I>
http_access allow localhost manager

http_access deny manager


&gt;<i> # do not cache anything
</I>
cache deny all


&gt;<i> # We strongly recommend the following be uncommented to protect innocent
</I>
# web applications running on the proxy server who think the only

# one who can access services on &quot;localhost&quot; is a local user

#http_access deny to_localhost


&gt;<i> #
</I>
# INSERT YOUR OWN RULE(S) HERE TO ALLOW ACCESS FROM YOUR CLIENTS

#


&gt;<i> # Example rule allowing access from your local networks.
</I>
# Adapt localnet in the ACL section to list your (internal) IP networks

# from where browsing should be allowed

http_access allow localnet

http_access allow localhost


&gt;<i> # And finally deny all other access to this proxy
</I>
http_access allow all


&gt;<i> # Squid normally listens to port 3128
</I>
http_port 3127 intercept

#http_port 3126

http_port 3126 ssl-bump intercept \

  cert=/etc/squid/cert/myCA.pem \

  generate-host-certificates=on dynamic_cert_mem_cache_size=4MB


&gt;<i>
</I>&gt;<i> sslcrtd_program /usr/lib64/squid/ssl_crtd -s /var/spool/squid/ssl_db -M 4MB
</I>

&gt;<i> # Uncomment and adjust the following to add a disk cache directory.
</I>
#cache_dir ufs /var/spool/squid 100 16 256


&gt;<i> # Leave coredumps in the first cache dir
</I>
coredump_dir /var/spool/squid


&gt;<i> #
</I>
# Add any of your own refresh_pattern entries above these.

#

refresh_pattern ^ftp: 1440 20% 10080

refresh_pattern ^gopher: 1440 0% 1440

refresh_pattern -i (/cgi-bin/|\?) 0 0% 0

refresh_pattern . 0 20% 4320


&gt;<i>
</I>&gt;<i> sslproxy_cert_error allow all
</I>

&gt;<i> #ssl bump
</I>
#ssl_bump peek all

ssl_bump stare all

ssl_bump bump all



*Error log:*

2020/04/01 12:55:13.459 kid1| 20,3| store.cc(521) unlock:
&gt;<i> store_client::copy unlocking key 67A641E2D51E4D78DC31FD1B1792BE59
</I>&gt;<i> e:=sXINV/0x5560eb4c70a0*3
</I>
2020/04/01 12:55:13.459 kid1| 20,2| store.cc(949) checkCachable:
&gt;<i> StoreEntry::checkCachable: NO: not cachable
</I>
2020/04/01 12:55:13.459 kid1| 20,3| store.cc(483) lock: storeUnregister
&gt;<i> locked key 67A641E2D51E4D78DC31FD1B1792BE59 e:=sXINV/0x5560eb4c70a0*3
</I>
2020/04/01 12:55:13.459 kid1| 20,3| store.cc(521) unlock: storeUnregister
&gt;<i> unlocking key 67A641E2D51E4D78DC31FD1B1792BE59 e:=sXINV/0x5560eb4c70a0*3
</I>
2020/04/01 12:55:13.459 kid1| 20,3| store.cc(521) unlock:
&gt;<i> clientReplyContext::removeStoreReference unlocking key
</I>&gt;<i> 67A641E2D51E4D78DC31FD1B1792BE59 e:=sXINV/0x5560eb4c70a0*2
</I>
2020/04/01 12:55:13.459 kid1| 20,3| store.cc(521) unlock:
&gt;<i> ClientHttpRequest::loggingEntry unlocking key
</I>&gt;<i> 67A641E2D51E4D78DC31FD1B1792BE59 e:=sXINV/0x5560eb4c70a0*1
</I>
2020/04/01 12:55:13.459 kid1| 20,3| store.cc(1239) release: releasing
&gt;<i> e:=sXINV/0x5560eb4c70a0*0 67A641E2D51E4D78DC31FD1B1792BE59
</I>
2020/04/01 12:55:13.459 kid1| 20,3| store.cc(402) destroyMemObject:
&gt;<i> destroyMemObject 0x5560eb4d0f40
</I>
2020/04/01 12:55:13.459 kid1| 20,3| MemObject.cc(110) ~MemObject: del
&gt;<i> MemObject 0x5560eb4d0f40
</I>
2020/04/01 12:55:13.459 kid1| 20,3| store.cc(420) destroyStoreEntry:
&gt;<i> destroyStoreEntry: destroying 0x5560eb4c70a8
</I>
2020/04/01 12:55:13.459 kid1| 20,3| store.cc(402) destroyMemObject:
&gt;<i> destroyMemObject 0
</I>
2020/04/01 12:55:14.008 kid1| 20,3| store.cc(774) storeCreatePureEntry:
&gt;<i> storeCreateEntry: 'error:invalid-request'
</I>
2020/04/01 12:55:14.008 kid1| 20,3| MemObject.cc(97) MemObject: new
&gt;<i> MemObject 0x5560eb4d0f40
</I>
2020/04/01 12:55:14.008 kid1| 20,3| store.cc(499) setReleaseFlag:
&gt;<i> StoreEntry::setReleaseFlag: '[null_store_key]'
</I>
2020/04/01 12:55:14.008 kid1| 20,3| store_key_md5.cc(89) storeKeyPrivate:
&gt;<i> storeKeyPrivate: NONE error:invalid-request
</I>
2020/04/01 12:55:14.008 kid1| 20,3| store.cc(447) hashInsert:
&gt;<i> StoreEntry::hashInsert: Inserting Entry e:=XI/0x5560eb4c70a0*0 key
</I>&gt;<i> '0255EA5E5890358FC3F4287C4CA0E49F'
</I>
2020/04/01 12:55:14.008 kid1| 20,3| store.cc(483) lock: storeCreateEntry
&gt;<i> locked key 0255EA5E5890358FC3F4287C4CA0E49F e:=XIV/0x5560eb4c70a0*1
</I>
2020/04/01 12:55:14.008 kid1| 20,3| store.cc(483) lock:
&gt;<i> StoreEntry::storeErrorResponse locked key 0255EA5E5890358FC3F4287C4CA0E49F
</I>&gt;<i> e:=XIV/0x5560eb4c70a0*2
</I>
2020/04/01 12:55:14.008 kid1| 20,3| store.cc(1862) replaceHttpReply:
&gt;<i> StoreEntry::replaceHttpReply: error:invalid-request
</I>
2020/04/01 12:55:14.008 kid1| 20,2| store.cc(949) checkCachable:
&gt;<i> StoreEntry::checkCachable: NO: not cachable
</I>
2020/04/01 12:55:14.008 kid1| 20,3| store.cc(1048) complete: storeComplete:
&gt;<i> '0255EA5E5890358FC3F4287C4CA0E49F'
</I>
2020/04/01 12:55:14.008 kid1| 20,3| store.cc(1337) validLength:
&gt;<i> storeEntryValidLength: Checking '0255EA5E5890358FC3F4287C4CA0E49F'
</I>
2020/04/01 12:55:14.008 kid1| 20,2| store.cc(949) checkCachable:
&gt;<i> StoreEntry::checkCachable: NO: not cachable
</I>
2020/04/01 12:55:14.008 kid1| 20,3| store.cc(521) unlock:
&gt;<i> StoreEntry::storeErrorResponse unlocking key
</I>&gt;<i> 0255EA5E5890358FC3F4287C4CA0E49F e:=sXINV/0x5560eb4c70a0*2
</I>
2020/04/01 12:55:14.008 kid1| 20,3| store.cc(483) lock: store_client::copy
&gt;<i> locked key 0255EA5E5890358FC3F4287C4CA0E49F e:=sXINV/0x5560eb4c70a0*2
</I>
2020/04/01 12:55:14.008 kid1| ERROR: No forward-proxy ports configured.

2020/04/01 12:55:14.008 kid1| 20,3| store.cc(483) lock:
&gt;<i> ClientHttpRequest::loggingEntry locked key 0255EA5E5890358FC3F4287C4CA0E49F
</I>&gt;<i> e:=sXINV/0x5560eb4c70a0*3
</I>
2020/04/01 12:55:14.008 kid1| 11,2| client_side.cc(1393)
&gt;<i> sendStartOfMessage: HTTP Client local=172.217.4.46:443 remote=
</I>&gt;<i> 10.15.1.100:53362 FD 10 flags=33
</I>
2020/04/01 12:55:14.008 kid1| 11,2| client_side.cc(1394)
&gt;<i> sendStartOfMessage: HTTP Client REPLY:
</I>
---------

HTTP/1.1 400 Bad Request

Server: squid/3.5.20

Mime-Version: 1.0

Date: Wed, 01 Apr 2020 12:55:14 GMT

Content-Type: text/html;charset=utf-8

Content-Length: 4033

X-Squid-Error: ERR_INVALID_REQ 0

Vary: Accept-Language

Content-Language: en

X-Cache: MISS from proto-vpn

X-Cache-Lookup: NONE from proto-vpn:0

Via: 1.1 proto-vpn (squid/3.5.20)

Connection: close
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20200401/5f136665/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20200401/5f136665/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	
	<LI>Next message (by thread): <A HREF="021875.html">[squid-users] Multiple access logs
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21874">[ date ]</a>
              <a href="thread.html#21874">[ thread ]</a>
              <a href="subject.html#21874">[ subject ]</a>
              <a href="author.html#21874">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
