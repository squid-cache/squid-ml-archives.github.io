<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid transparent not caching apt requests from deb.debian.org
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20transparent%20not%20caching%20apt%20requests%20from%0A%20deb.debian.org&In-Reply-To=%3C841e139c-6795-1275-6f31-9746f1bb36c5%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="021883.html">
   <LINK REL="Next"  HREF="021886.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid transparent not caching apt requests from deb.debian.org</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20transparent%20not%20caching%20apt%20requests%20from%0A%20deb.debian.org&In-Reply-To=%3C841e139c-6795-1275-6f31-9746f1bb36c5%40measurement-factory.com%3E"
       TITLE="[squid-users] Squid transparent not caching apt requests from deb.debian.org">rousskov at measurement-factory.com
       </A><BR>
    <I>Sat Apr  4 14:53:05 UTC 2020</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="021883.html">[squid-users] Squid transparent not caching apt requests from deb.debian.org
</A></li>
        <LI>Next message (by thread): <A HREF="021886.html">[squid-users] Squid transparent not caching apt requests from deb.debian.org
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21885">[ date ]</a>
              <a href="thread.html#21885">[ thread ]</a>
              <a href="subject.html#21885">[ subject ]</a>
              <a href="author.html#21885">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 4/3/20 4:55 PM, zrm wrote:
&gt;<i> On 4/3/20 16:34, Alex Rousskov wrote:
</I>&gt;&gt;<i> On 4/3/20 4:26 PM, zrm wrote:
</I>&gt;&gt;&gt;<i> In the first case we get TCP_MISS every time because it isn't caching
</I>&gt;&gt;&gt;<i> the data, in the second case it's only the first time and after that we
</I>&gt;&gt;&gt;<i> get TCP_REFRESH_UNMODIFIED. But how and why is this happening?
</I>
&gt;<i> squid to apt:
</I>&gt;<i> ---------
</I>&gt;<i> X-Cache: MISS from tproxy
</I>&gt;<i> X-Cache-Lookup: MISS from tproxy:3130
</I>
&gt;<i> squid to wget:
</I>&gt;<i> ---------
</I>&gt;<i> X-Cache: MISS from tproxy
</I>&gt;<i> X-Cache-Lookup: MISS from tproxy:3130
</I>
The headers you have posted tell us that the object was not in Squid
cache when apt and wget transactions started. Since wget was started
after apt, we can speculate that apt transaction did not cache the
object. This is consistent with your observations. I saw nothing in the
posted headers that would explain the difference between apt and wget
outcomes.

Unfortunately, you did not show the headers for the case where the
object actually got cached by Squid. You can probably do that by
repeating the wget transaction twice. I would also repeat the apt
transaction twice after that. It would also be interesting to see the
wget-apt and apt-wget sequences. In summary, I would do
wget-wget-apt-apt-wget-wget. Sleep for 10+ seconds between each
transaction to reduce chances of overlapping cache operations.

BTW, you probably do not need to make ALL,2 logs pretty -- we can figure
out what happens based on Squid messages if you submit one transaction
at a time and disclose transaction sequence. You can just post (a link
to) raw (or sanitized) logs. Compress them if they are too big.

Before sharing the logs, please double check that the problem you want
to address was reproduced during the test.


&gt;<i> Last-Modified: Sat, 15 Jun 2019 17:46:35 GMT
</I>&gt;<i> ETag: &quot;1389dc-58b605823fa6e&quot;
</I>&gt;<i> Cache-Control: public, max-age=2592000
</I>&gt;<i> Content-Length: 1280476
</I>&gt;<i> Age: 4248100
</I>
FWIW: The object is 4'248'100 seconds old. The object max-age is
2'592'000 seconds. Your Squid is probably using an internal max-age of
259'200 seconds, so Squid will require cache hit revalidation during
subsequent transactions after Squid caches the object (if it caches it).


HTH,

Alex.


&gt;<i> apt to squid:
</I>&gt;<i> ---------
</I>&gt;<i> GET /debian/pool/main/v/vim/vim_8.1.0875-5_amd64.deb HTTP/1.1
</I>&gt;<i> Host: deb.debian.org
</I>&gt;<i> User-Agent: Debian APT-HTTP/1.3 (1.8.2)
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> ----------
</I>&gt;<i> squid to deb.debian.org:
</I>&gt;<i> ---------
</I>&gt;<i> GET /debian/pool/main/v/vim/vim_8.1.0875-5_amd64.deb HTTP/1.1
</I>&gt;<i> User-Agent: Debian APT-HTTP/1.3 (1.8.2)
</I>&gt;<i> Host: deb.debian.org
</I>&gt;<i> Via: 1.1 tproxy (squid/4.6)
</I>&gt;<i> X-Forwarded-For: 192.168.111.55
</I>&gt;<i> Cache-Control: max-age=259200
</I>&gt;<i> Connection: keep-alive
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> ----------
</I>&gt;<i> deb.debian.org to squid:
</I>&gt;<i> ---------
</I>&gt;<i> HTTP/1.1 200 OK
</I>&gt;<i> Server: Apache
</I>&gt;<i> X-Content-Type-Options: nosniff
</I>&gt;<i> X-Frame-Options: sameorigin
</I>&gt;<i> Referrer-Policy: no-referrer
</I>&gt;<i> X-Xss-Protection: 1
</I>&gt;<i> Last-Modified: Sat, 15 Jun 2019 17:46:35 GMT
</I>&gt;<i> ETag: &quot;1389dc-58b605823fa6e&quot;
</I>&gt;<i> X-Clacks-Overhead: GNU Terry Pratchett
</I>&gt;<i> Cache-Control: public, max-age=2592000
</I>&gt;<i> Content-Type: application/x-debian-package
</I>&gt;<i> Via: 1.1 varnish
</I>&gt;<i> Content-Length: 1280476
</I>&gt;<i> Accept-Ranges: bytes
</I>&gt;<i> Date: Fri, 03 Apr 2020 05:28:46 GMT
</I>&gt;<i> Via: 1.1 varnish
</I>&gt;<i> Age: 4248100
</I>&gt;<i> Connection: keep-alive
</I>&gt;<i> X-Served-By: cache-ams21028-AMS, cache-wdc5559-WDC
</I>&gt;<i> X-Cache: HIT, HIT
</I>&gt;<i> X-Cache-Hits: 1, 2
</I>&gt;<i> X-Timer: S1585891726.434375,VS0,VE0
</I>&gt;<i> 
</I>&gt;<i> ----------
</I>&gt;<i> squid to apt:
</I>&gt;<i> ---------
</I>&gt;<i> HTTP/1.1 200 OK
</I>&gt;<i> Server: Apache
</I>&gt;<i> X-Content-Type-Options: nosniff
</I>&gt;<i> X-Frame-Options: sameorigin
</I>&gt;<i> Referrer-Policy: no-referrer
</I>&gt;<i> X-Xss-Protection: 1
</I>&gt;<i> Last-Modified: Sat, 15 Jun 2019 17:46:35 GMT
</I>&gt;<i> ETag: &quot;1389dc-58b605823fa6e&quot;
</I>&gt;<i> X-Clacks-Overhead: GNU Terry Pratchett
</I>&gt;<i> Cache-Control: public, max-age=2592000
</I>&gt;<i> Content-Type: application/x-debian-package
</I>&gt;<i> Content-Length: 1280476
</I>&gt;<i> Accept-Ranges: bytes
</I>&gt;<i> Date: Fri, 03 Apr 2020 05:28:46 GMT
</I>&gt;<i> Age: 4248100
</I>&gt;<i> X-Served-By: cache-ams21028-AMS, cache-wdc5559-WDC
</I>&gt;<i> X-Cache: HIT, HIT
</I>&gt;<i> X-Cache-Hits: 1, 2
</I>&gt;<i> X-Timer: S1585891726.434375,VS0,VE0
</I>&gt;<i> X-Cache: MISS from tproxy
</I>&gt;<i> X-Cache-Lookup: MISS from tproxy:3130
</I>&gt;<i> Via: 1.1 varnish, 1.1 varnish, 1.1 tproxy (squid/4.6)
</I>&gt;<i> Connection: keep-alive
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> ----------
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> wget to squid:
</I>&gt;<i> ---------
</I>&gt;<i> GET /debian/pool/main/v/vim/vim_8.1.0875-5_amd64.deb HTTP/1.1
</I>&gt;<i> User-Agent: Wget/1.20.1 (linux-gnu)
</I>&gt;<i> Accept: */*
</I>&gt;<i> Accept-Encoding: identity
</I>&gt;<i> Host: deb.debian.org
</I>&gt;<i> Connection: Keep-Alive
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> ----------
</I>&gt;<i> squid to deb.debian.org:
</I>&gt;<i> ----------
</I>&gt;<i> GET /debian/pool/main/v/vim/vim_8.1.0875-5_amd64.deb HTTP/1.1
</I>&gt;<i> User-Agent: Wget/1.20.1 (linux-gnu)
</I>&gt;<i> Accept: */*
</I>&gt;<i> Accept-Encoding: identity
</I>&gt;<i> Host: deb.debian.org
</I>&gt;<i> Via: 1.1 tproxy (squid/4.6)
</I>&gt;<i> X-Forwarded-For: 192.168.111.55
</I>&gt;<i> Cache-Control: max-age=259200
</I>&gt;<i> Connection: keep-alive
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> ----------
</I>&gt;<i> deb.debian.org to squid:
</I>&gt;<i> ---------
</I>&gt;<i> HTTP/1.1 200 OK
</I>&gt;<i> Server: Apache
</I>&gt;<i> X-Content-Type-Options: nosniff
</I>&gt;<i> X-Frame-Options: sameorigin
</I>&gt;<i> Referrer-Policy: no-referrer
</I>&gt;<i> X-Xss-Protection: 1
</I>&gt;<i> Last-Modified: Sat, 15 Jun 2019 17:46:35 GMT
</I>&gt;<i> ETag: &quot;1389dc-58b605823fa6e&quot;
</I>&gt;<i> X-Clacks-Overhead: GNU Terry Pratchett
</I>&gt;<i> Cache-Control: public, max-age=2592000
</I>&gt;<i> Content-Type: application/x-debian-package
</I>&gt;<i> Via: 1.1 varnish
</I>&gt;<i> Content-Length: 1280476
</I>&gt;<i> Accept-Ranges: bytes
</I>&gt;<i> Date: Fri, 03 Apr 2020 05:28:49 GMT
</I>&gt;<i> Via: 1.1 varnish
</I>&gt;<i> Age: 4248102
</I>&gt;<i> Connection: keep-alive
</I>&gt;<i> X-Served-By: cache-ams21028-AMS, cache-wdc5583-WDC
</I>&gt;<i> X-Cache: HIT, HIT
</I>&gt;<i> X-Cache-Hits: 1, 1
</I>&gt;<i> X-Timer: S1585891729.316362,VS0,VE0
</I>&gt;<i> 
</I>&gt;<i> ----------
</I>&gt;<i> squid to wget:
</I>&gt;<i> ---------
</I>&gt;<i> HTTP/1.1 200 OK
</I>&gt;<i> Server: Apache
</I>&gt;<i> X-Content-Type-Options: nosniff
</I>&gt;<i> X-Frame-Options: sameorigin
</I>&gt;<i> Referrer-Policy: no-referrer
</I>&gt;<i> X-Xss-Protection: 1
</I>&gt;<i> Last-Modified: Sat, 15 Jun 2019 17:46:35 GMT
</I>&gt;<i> ETag: &quot;1389dc-58b605823fa6e&quot;
</I>&gt;<i> X-Clacks-Overhead: GNU Terry Pratchett
</I>&gt;<i> Cache-Control: public, max-age=2592000
</I>&gt;<i> Content-Type: application/x-debian-package
</I>&gt;<i> Content-Length: 1280476
</I>&gt;<i> Accept-Ranges: bytes
</I>&gt;<i> Date: Fri, 03 Apr 2020 05:28:49 GMT
</I>&gt;<i> Age: 4248102
</I>&gt;<i> X-Served-By: cache-ams21028-AMS, cache-wdc5583-WDC
</I>&gt;<i> X-Cache: HIT, HIT
</I>&gt;<i> X-Cache-Hits: 1, 1
</I>&gt;<i> X-Timer: S1585891729.316362,VS0,VE0
</I>&gt;<i> X-Cache: MISS from tproxy
</I>&gt;<i> X-Cache-Lookup: MISS from tproxy:3130
</I>&gt;<i> Via: 1.1 varnish, 1.1 varnish, 1.1 tproxy (squid/4.6)
</I>&gt;<i> Connection: keep-alive
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> ----------
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="021883.html">[squid-users] Squid transparent not caching apt requests from deb.debian.org
</A></li>
	<LI>Next message (by thread): <A HREF="021886.html">[squid-users] Squid transparent not caching apt requests from deb.debian.org
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21885">[ date ]</a>
              <a href="thread.html#21885">[ thread ]</a>
              <a href="subject.html#21885">[ subject ]</a>
              <a href="author.html#21885">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
