<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid transparent not caching apt requests from deb.debian.org
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20transparent%20not%20caching%20apt%20requests%20from%0A%20deb.debian.org&In-Reply-To=%3C66a94023-5f8b-fc79-254e-066ca390a085%40trustiosity.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="021886.html">
   <LINK REL="Next"  HREF="021888.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid transparent not caching apt requests from deb.debian.org</H1>
    <B>zrm</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20transparent%20not%20caching%20apt%20requests%20from%0A%20deb.debian.org&In-Reply-To=%3C66a94023-5f8b-fc79-254e-066ca390a085%40trustiosity.com%3E"
       TITLE="[squid-users] Squid transparent not caching apt requests from deb.debian.org">zrm at trustiosity.com
       </A><BR>
    <I>Sun Apr  5 00:02:31 UTC 2020</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="021886.html">[squid-users] Squid transparent not caching apt requests from deb.debian.org
</A></li>
        <LI>Next message (by thread): <A HREF="021888.html">[squid-users] Squid transparent not caching apt requests from deb.debian.org
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21887">[ date ]</a>
              <a href="thread.html#21887">[ thread ]</a>
              <a href="subject.html#21887">[ subject ]</a>
              <a href="author.html#21887">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 4/4/20 10:53, Alex Rousskov wrote:
&gt;<i> The headers you have posted tell us that the object was not in Squid
</I>&gt;<i> cache when apt and wget transactions started. Since wget was started
</I>&gt;<i> after apt, we can speculate that apt transaction did not cache the
</I>&gt;<i> object. This is consistent with your observations. I saw nothing in the
</I>&gt;<i> posted headers that would explain the difference between apt and wget
</I>&gt;<i> outcomes.
</I>&gt;<i> 
</I>&gt;<i> Unfortunately, you did not show the headers for the case where the
</I>&gt;<i> object actually got cached by Squid. You can probably do that by
</I>&gt;<i> repeating the wget transaction twice. I would also repeat the apt
</I>&gt;<i> transaction twice after that. It would also be interesting to see the
</I>&gt;<i> wget-apt and apt-wget sequences. In summary, I would do
</I>&gt;<i> wget-wget-apt-apt-wget-wget. Sleep for 10+ seconds between each
</I>&gt;<i> transaction to reduce chances of overlapping cache operations.
</I>
Attached cache.log excerpt for wget-wget-apt-apt-wget-wget. It answers 
the apt requests from the cache once it's in there, it just won't cache 
it to begin with when apt makes the request:

[wget] 1586041686.600    725 192.168.111.55 TCP_MISS/200 1281195 GET 
<A HREF="http://deb.debian.org/debian/pool/main/v/vim/vim_8.1.0875-5_amd64.deb">http://deb.debian.org/debian/pool/main/v/vim/vim_8.1.0875-5_amd64.deb</A> - 
ORIGINAL_DST/199.232.66.133 application/x-debian-package
[wget] 1586041710.518    107 192.168.111.55 TCP_REFRESH_UNMODIFIED/200 
1281232 GET 
<A HREF="http://deb.debian.org/debian/pool/main/v/vim/vim_8.1.0875-5_amd64.deb">http://deb.debian.org/debian/pool/main/v/vim/vim_8.1.0875-5_amd64.deb</A> - 
ORIGINAL_DST/199.232.66.133 application/x-debian-package
[apt] 1586041733.058     69 192.168.111.55 TCP_REFRESH_UNMODIFIED/200 
1281234 GET 
<A HREF="http://deb.debian.org/debian/pool/main/v/vim/vim_8.1.0875-5_amd64.deb">http://deb.debian.org/debian/pool/main/v/vim/vim_8.1.0875-5_amd64.deb</A> - 
ORIGINAL_DST/151.101.200.204 application/x-debian-package
[apt] 1586041753.971    101 192.168.111.55 TCP_REFRESH_UNMODIFIED/200 
1281234 GET 
<A HREF="http://deb.debian.org/debian/pool/main/v/vim/vim_8.1.0875-5_amd64.deb">http://deb.debian.org/debian/pool/main/v/vim/vim_8.1.0875-5_amd64.deb</A> - 
ORIGINAL_DST/151.101.200.204 application/x-debian-package
[wget] 1586041769.162    160 192.168.111.55 TCP_REFRESH_UNMODIFIED/200 
1281232 GET 
<A HREF="http://deb.debian.org/debian/pool/main/v/vim/vim_8.1.0875-5_amd64.deb">http://deb.debian.org/debian/pool/main/v/vim/vim_8.1.0875-5_amd64.deb</A> - 
ORIGINAL_DST/199.232.66.133 application/x-debian-package
[wget] 1586041786.916     71 192.168.111.55 TCP_REFRESH_UNMODIFIED/200 
1281232 GET 
<A HREF="http://deb.debian.org/debian/pool/main/v/vim/vim_8.1.0875-5_amd64.deb">http://deb.debian.org/debian/pool/main/v/vim/vim_8.1.0875-5_amd64.deb</A> - 
ORIGINAL_DST/151.101.250.133 application/x-debian-package

&gt;<i> BTW, you probably do not need to make ALL,2 logs pretty -- we can figure
</I>&gt;<i> out what happens based on Squid messages if you submit one transaction
</I>&gt;<i> at a time and disclose transaction sequence. You can just post (a link
</I>&gt;<i> to) raw (or sanitized) logs. Compress them if they are too big.
</I>
&gt;<i> Before sharing the logs, please double check that the problem you want
</I>&gt;<i> to address was reproduced during the test.
</I>
In this case we start with wget and then it is already in the cache for 
the requests made by apt. The problem is the data not being cached when 
apt makes the request and it isn't already there. The apt requests do 
get answered from the cache if it is already there.

The headers from the previous email show what happens when apt makes the 
request and it's not already in the cache.

&gt;&gt;<i> Last-Modified: Sat, 15 Jun 2019 17:46:35 GMT
</I>&gt;&gt;<i> ETag: &quot;1389dc-58b605823fa6e&quot;
</I>&gt;&gt;<i> Cache-Control: public, max-age=2592000
</I>&gt;&gt;<i> Content-Length: 1280476
</I>&gt;&gt;<i> Age: 4248100
</I>&gt;<i> 
</I>&gt;<i> FWIW: The object is 4'248'100 seconds old. The object max-age is
</I>&gt;<i> 2'592'000 seconds. Your Squid is probably using an internal max-age of
</I>&gt;<i> 259'200 seconds, so Squid will require cache hit revalidation during
</I>&gt;<i> subsequent transactions after Squid caches the object (if it caches it).
</I>
That makes sense. These packages never really change at all -- the 
package version is part of the URI so if it's updated the package URI 
changes rather than the data at the old URI. I might set a longer max 
age in the config once this is worked out.

&gt;<i> HTH,
</I>&gt;<i> 
</I>&gt;<i> Alex.
</I>&gt;<i> 
</I>&gt;<i> 
</I>
Thanks.
-------------- next part --------------
A non-text attachment was scrubbed...
Name: cache.log
Type: text/x-log
Size: 30262 bytes
Desc: not available
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20200404/64c9f79b/attachment.bin">http://lists.squid-cache.org/pipermail/squid-users/attachments/20200404/64c9f79b/attachment.bin</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="021886.html">[squid-users] Squid transparent not caching apt requests from deb.debian.org
</A></li>
	<LI>Next message (by thread): <A HREF="021888.html">[squid-users] Squid transparent not caching apt requests from deb.debian.org
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21887">[ date ]</a>
              <a href="thread.html#21887">[ thread ]</a>
              <a href="subject.html#21887">[ subject ]</a>
              <a href="author.html#21887">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
