<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid transparent not caching apt requests from deb.debian.org
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20transparent%20not%20caching%20apt%20requests%20from%0A%20deb.debian.org&In-Reply-To=%3C94789648-3497-9b45-04fd-0aa9e419f0f0%40trustiosity.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="021903.html">
   <LINK REL="Next"  HREF="021905.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid transparent not caching apt requests from deb.debian.org</H1>
    <B>zrm</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20transparent%20not%20caching%20apt%20requests%20from%0A%20deb.debian.org&In-Reply-To=%3C94789648-3497-9b45-04fd-0aa9e419f0f0%40trustiosity.com%3E"
       TITLE="[squid-users] Squid transparent not caching apt requests from deb.debian.org">zrm at trustiosity.com
       </A><BR>
    <I>Wed Apr  8 17:01:25 UTC 2020</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="021903.html">[squid-users] Squid transparent not caching apt requests from deb.debian.org
</A></li>
        <LI>Next message (by thread): <A HREF="021905.html">[squid-users] Squid transparent not caching apt requests from deb.debian.org
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21904">[ date ]</a>
              <a href="thread.html#21904">[ thread ]</a>
              <a href="subject.html#21904">[ subject ]</a>
              <a href="author.html#21904">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 4/8/20 10:46, Alex Rousskov wrote:
&gt;<i> On 4/7/20 8:48 PM, zrm wrote:
</I>&gt;<i> 
</I>&gt;&gt;<i> <A HREF="https://www.trustiosity.com/squid/cache-debug.log.xz">https://www.trustiosity.com/squid/cache-debug.log.xz</A>
</I>&gt;<i> 
</I>&gt;<i> I found the reason for the difference.
</I>&gt;<i> 
</I>&gt;<i> After the destination IP address of your apt requests fails Host header
</I>&gt;<i> validation, Squid marks the request as &quot;not cachable&quot;:
</I>
I checked the DNS query apt is making to see why it's different. It's 
making a SRV query for _http._tcp.deb.debian.org and then using the IP 
address of the name (prod.debian.map.fastly.net) returned in the SRV 
query. By contrast, squid does the A record query for deb.debian.org and 
gets a CNAME for debian.map.fastly.net. Almost the same, but since it's 
a CDN with many IP addresses, enough different that they happen to not 
both return the same address and then validation fails.

Meanwhile wget does the same A record query as squid and gets the same 
address.

The question then becomes what to do about it. Maybe if squid fails the 
validation for the A query, it should try the SRV query and accept the 
address as valid if it matches that. Another possibility would be a 
config option to have squid completely ignore the address the client 
used and always use the address it gets by doing its own DNS query for 
the host, in which case the result would be safe to cache.

But these are obviously changes requiring a new version of squid. Is 
there any way to make it work without that?

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="021903.html">[squid-users] Squid transparent not caching apt requests from deb.debian.org
</A></li>
	<LI>Next message (by thread): <A HREF="021905.html">[squid-users] Squid transparent not caching apt requests from deb.debian.org
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21904">[ date ]</a>
              <a href="thread.html#21904">[ thread ]</a>
              <a href="subject.html#21904">[ subject ]</a>
              <a href="author.html#21904">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
