<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Header Detection Post SSL Bump in Squid 4.10
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Header%20Detection%20Post%20SSL%20Bump%20in%20Squid%204.10&In-Reply-To=%3CCAB4jwzffxXgP_jqoJHozw1v98Sb7CsRXZ19s6s-e_xtmfUmZZA%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="021916.html">
   <LINK REL="Next"  HREF="021918.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Header Detection Post SSL Bump in Squid 4.10</H1>
    <B>shubham jain</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Header%20Detection%20Post%20SSL%20Bump%20in%20Squid%204.10&In-Reply-To=%3CCAB4jwzffxXgP_jqoJHozw1v98Sb7CsRXZ19s6s-e_xtmfUmZZA%40mail.gmail.com%3E"
       TITLE="[squid-users] Header Detection Post SSL Bump in Squid 4.10">csp.shubham at gmail.com
       </A><BR>
    <I>Thu Apr 16 05:15:00 UTC 2020</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="021916.html">[squid-users] Squid proxy configuration for client SSL termination
</A></li>
        <LI>Next message (by thread): <A HREF="021918.html">[squid-users] Header Detection Post SSL Bump in Squid 4.10
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21917">[ date ]</a>
              <a href="thread.html#21917">[ thread ]</a>
              <a href="subject.html#21917">[ subject ]</a>
              <a href="author.html#21917">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

*Context*:
I want to use Squid as a forward proxy, where I want to
1) send all the Image requests directly, presumably using request header
'accept'
2) send all other requests through a cache peer Proxy service

The req_header directive is working fine for HTTP Requests, but not for
HTTPS.

I've done the setup for SSL Bump in here and that's giving decrypted HTTPS
requests in the access.log as well.

*Issue:*
The req_header directive is not working on the decrypted HTTPS requests.

*Squid.conf*

# SSL Bump Port
http_port 127.0.0.1:3128 ssl-bump cert=/usr/local/etc/cert/example.com.cert
key=/usr/local/etc/cert/example.com.private generate-host-certificates=on
version=1 options=SINGLE_DH_USE

# SSL Bump Config
acl step1 at_step SslBump1
acl step2 at_step SslBump2
acl step3 at_step SslBump3

acl imageIsBlocked req_header accept -i image

ssl_bump terminate imageIsBlocked    #terminate is just for testing, to be
replaced by splice
ssl_bump bump all

*Access.log*

1587011751.217    204 127.0.0.1 TCP_MISS/200 393 GET
<A HREF="https://dt.adsafeprotected.com/dt?">https://dt.adsafeprotected.com/dt?</A> - HIER_DIRECT/104.244.39.20 image/gif
1587011751.264   1050 127.0.0.1 NONE/200 0 CONNECT
pagead2.googlesyndication.com:443 - HIER_DIRECT/172.217.13.226 -
1587011751.303    787 127.0.0.1 NONE/200 0 CONNECT
pagead2.googlesyndication.com:443 - HIER_DIRECT/172.217.13.226 -
1587011752.246   2846 127.0.0.1 NONE/200 0 CONNECT
partners.tremorhub.com:443 - HIER_DIRECT/3.224.28.212 -
1587011753.348   1096 127.0.0.1 TCP_MISS/200 1105 GET
<A HREF="https://partners.tremorhub.com/syncnoad?">https://partners.tremorhub.com/syncnoad?</A> - HIER_DIRECT/3.224.28.212 text/xml
1587011754.152    799 127.0.0.1 TCP_MISS/200 1124 GET
<A HREF="https://partners.tremorhub.com/syncnoad?">https://partners.tremorhub.com/syncnoad?</A> - HIER_DIRECT/3.224.28.212 text/xml
1587011756.091   1934 127.0.0.1 TCP_MISS/200 1086 GET
<A HREF="https://partners.tremorhub.com/syncnoad?">https://partners.tremorhub.com/syncnoad?</A> - HIER_DIRECT/3.224.28.212 text/xml
1587011760.264   4169 127.0.0.1 TCP_MISS_ABORTED/200 1113 GET
<A HREF="https://partners.tremorhub.com/syncnoad?">https://partners.tremorhub.com/syncnoad?</A> - HIER_DIRECT/3.224.28.212 text/xml
1587011760.822    367 127.0.0.1 TCP_MISS/200 1185 POST
<A HREF="https://pagead2.googlesyndication.com/pcs/activeview?">https://pagead2.googlesyndication.com/pcs/activeview?</A> - HIER_DIRECT/
172.217.13.226 image/gif
1587011760.862    407 127.0.0.1 TCP_MISS/200 1185 GET
<A HREF="https://pagead2.googlesyndication.com/pcs/activeview?">https://pagead2.googlesyndication.com/pcs/activeview?</A> - HIER_DIRECT/
172.217.13.226 image/gif

Any help would be appreciated, as I have spent weeks trying to get around
the work post SSL Bumping.

*Thanks &amp; Regards,*

*Shubham Jain*
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20200416/350dc071/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20200416/350dc071/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="021916.html">[squid-users] Squid proxy configuration for client SSL termination
</A></li>
	<LI>Next message (by thread): <A HREF="021918.html">[squid-users] Header Detection Post SSL Bump in Squid 4.10
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21917">[ date ]</a>
              <a href="thread.html#21917">[ thread ]</a>
              <a href="subject.html#21917">[ subject ]</a>
              <a href="author.html#21917">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
