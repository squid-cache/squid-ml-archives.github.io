<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Using a Baltimore root certificate in transparent ssl	proxying
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Using%20a%20Baltimore%20root%20certificate%20in%20transparent%20ssl%0A%09proxying&In-Reply-To=%3CCAPu9cN7hDXdRTsFEwfrXO45GpFrd5Oom39pcs8oP4cZBWmP1_g%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="022038.html">
   <LINK REL="Next"  HREF="022017.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Using a Baltimore root certificate in transparent ssl	proxying</H1>
    <B>Lei Wen</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Using%20a%20Baltimore%20root%20certificate%20in%20transparent%20ssl%0A%09proxying&In-Reply-To=%3CCAPu9cN7hDXdRTsFEwfrXO45GpFrd5Oom39pcs8oP4cZBWmP1_g%40mail.gmail.com%3E"
       TITLE="[squid-users] Using a Baltimore root certificate in transparent ssl	proxying">leiwen14 at gmail.com
       </A><BR>
    <I>Mon Apr 27 21:44:41 UTC 2020</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="022038.html">[squid-users] Best way to prevent squid from bumping CONNECTs
</A></li>
        <LI>Next message (by thread): <A HREF="022017.html">[squid-users] Using a Baltimore root certificate in transparent	ssl proxying
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22016">[ date ]</a>
              <a href="thread.html#22016">[ thread ]</a>
              <a href="subject.html#22016">[ subject ]</a>
              <a href="author.html#22016">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,



We were able to set up the squid in a host to container infrastructure.
That is saying the squid is installed on host, proxying traffic from the
container on the same host. With transparent proxy including SSL traffic.

Another feature we enabled is request_header_access and
request_header_replace, to spoof and modify token in HTTP headers sending
to target dstdomain.



The issue we are having right now is the certificate installed on the
container is a self signed cert, we were trying to migrate this cert to a
real trusted CA cert, or a Baltimore root cert.

The issues seems to be in the subject name of the cert. In the self signed
cert, I simply leave everything blank. In the Baltimore root cert(squid.key
and squid.crt in below squid.conf example, request through Microsoft
internal service and it is Baltimore root), even if I have the dstdomain in
squid.conf as subject name(abc.microsoft.com in below squid.conf example),
I am still getting &#8220;server certificate verification failed&#8221; error in CURL.
Is there anything I am missing or it simply doesn&#8217;t support? In my
understanding, it should has no difference with squid as root CA signer in
self signed cert?



P.S. I do notice that it is illegal for a trusted CA to issue official cert
to squid because squid itself is man-in-the-middle, so Squid can only
accept self signed cert and squid as root CA? I tried to search the email
archive but no luck.



I have such a squid.conf



acl abc dstdomain .abc.microsoft.com

request_header_access Authorization deny abc

request_header_replace Authorization Basic
whateverYourTokeisButForBasicItHasToBeBase64Encoded

request_header_access All allow all



https_port 3129 cert=/etc/squid3/squid.crt key=/etc/squid3/squid.key
ssl-bump intercept generate-host-certificates=on
dynamic_cert_mem_cache_size=4MB

acl SSL_port port 443

http_access allow SSL_port

acl allowed_https_sites ssl::server_name &quot;/etc/squid3/ssl_sites.txt&quot;



ssl_bump server-first all

always_direct allow all



acl step1 at_step SslBump1

acl step2 at_step SslBump2

acl step3 at_step SslBump3

ssl_bump peek step1 all

ssl_bump peek step2 allowed_https_sites

ssl_bump splice step3 allowed_https_sites







Thanks,

Lei
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20200427/6034a3ba/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20200427/6034a3ba/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="022038.html">[squid-users] Best way to prevent squid from bumping CONNECTs
</A></li>
	<LI>Next message (by thread): <A HREF="022017.html">[squid-users] Using a Baltimore root certificate in transparent	ssl proxying
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22016">[ date ]</a>
              <a href="thread.html#22016">[ thread ]</a>
              <a href="subject.html#22016">[ subject ]</a>
              <a href="author.html#22016">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
