<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] [EXTERNAL] Re: Ubuntu 18 with Squid 4.11 SSL_BUMP
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20%5BEXTERNAL%5D%20Re%3A%20Ubuntu%2018%20with%20Squid%204.11%20SSL_BUMP&In-Reply-To=%3C39EEF70C-5A29-4C54-90BF-8896C9BDCE56%40progressive.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="022033.html">
   <LINK REL="Next"  HREF="022035.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] [EXTERNAL] Re: Ubuntu 18 with Squid 4.11 SSL_BUMP</H1>
    <B>Anthony Mead</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20%5BEXTERNAL%5D%20Re%3A%20Ubuntu%2018%20with%20Squid%204.11%20SSL_BUMP&In-Reply-To=%3C39EEF70C-5A29-4C54-90BF-8896C9BDCE56%40progressive.com%3E"
       TITLE="[squid-users] [EXTERNAL] Re: Ubuntu 18 with Squid 4.11 SSL_BUMP">ANTHONY_MEAD at progressive.com
       </A><BR>
    <I>Wed Apr 29 21:11:25 UTC 2020</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="022033.html">[squid-users] Ubuntu 18 with Squid 4.11 SSL_BUMP
</A></li>
        <LI>Next message (by thread): <A HREF="022035.html">[squid-users] [EXTERNAL] Re: Ubuntu 18 with Squid 4.11 SSL_BUMP
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22034">[ date ]</a>
              <a href="thread.html#22034">[ thread ]</a>
              <a href="subject.html#22034">[ subject ]</a>
              <a href="author.html#22034">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hmm, if there were more logs I'd share them!  Any reason why I'd only see a access.log line?

I promise if I curl <A HREF="https://google.com">https://google.com</A>  this is the only line I see: 
1588193897.852     20 10.0.1.180 TCP_TUNNEL_ABORTED/200 5103 CONNECT 172.217.15.78:443 - ORIGINAL_DST/172.217.15.78 -

Or curl <A HREF="https://youtube.com">https://youtube.com</A> :
1588194262.880     32 10.0.1.180 TCP_TUNNEL/200 4824 CONNECT 172.217.13.78:443 - ORIGINAL_DST/172.217.13.78 -

Or curl <A HREF="https://github.com/:">https://github.com/:</A>
1588194657.291     45 10.0.1.180 TCP_TUNNEL/200 107344 CONNECT 140.82.113.4:443 - ORIGINAL_DST/140.82.113.4 -

To avoid an X/Y problem the rest of my setup mimics a few blog posts - An EC2 in a private subnet that has all traffic being forwarded to the squid instance, which has iptables forwarding http/https to 3129/3130.  All approved traffic is then forwarded onto a NAT Gateway.  Maybe another piece of the &quot;puzzle&quot; is capturing the logs.

Also I really appreciate your help so far!


&#65279;On 4/29/20, 4:35 PM, &quot;squid-users on behalf of Amos Jeffries&quot; &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A> on behalf of <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt; wrote:

    On 30/04/20 8:15 am, Anthony Mead wrote:
    &gt; Thanks!  I've re-compiled without the unnecessary flag, and restarted the service with a new whitelist, unfortunately i'm getting such a varying of /var/log/squid/access.log messages that I'm not sure what to google anymore.
    &gt; 
    &gt; I want to deny all access to external sites except http/https github.com but some sites seem to connect, while others don't:
    &gt; 

    There are a lot of details missing from your quoted log lines. Details
    such as which server was contacted are important when there are more
    than one TCP connection involved.

    Since this is SSL-Bump _each_ curl request should result in _3_
    access.log lines - with varying client, server and URI values.

    You are only showing us one log line at a time. With only the client and
    URI parts.


    Bellow is a *guess* about what is going on, based on what the status
    says. This is only to demonstrate that for each line you show there is
    at least one situation where your squid.conf file tells Squid to do an
    action which would result in that line. Whether these guesses are right
    requires all the information you are omitting.



    &gt; ~$ # this is correct
    &gt; ~$ curl <A HREF="http://github.com/">http://github.com/</A>
    &gt; 10.0.1.180 TCP_MISS/301 200 GET <A HREF="http://github.com/">http://github.com/</A>
    &gt; 

     acl allowed_http_sites dstdomain &quot;/etc/squid/whitelist.txt&quot;
     http_access allow allowed_http_sites


    &gt; ~$ # this is correct
    &gt; ~$ curl <A HREF="https://github.com/">https://github.com/</A> 
    &gt; 10.0.1.180 TCP_TUNNEL/200 107323 CONNECT 140.82.114.4:443
    &gt; 

      acl SSL_port port 443
      http_access allow SSL_port

      ssl_bump peek all


    &gt; ~$ # this should deny
    &gt; ~$ curl <A HREF="https://youtube.com/">https://youtube.com/</A>
    &gt; 10.0.1.180 TCP_TUNNEL/200 4844 CONNECT 172.217.15.110:443
    &gt; 

      acl SSL_port port 443
      http_access allow SSL_port

      ssl_bump peek all


    &gt; ~$ # this should deny
    &gt; ~$ curl <A HREF="https://google.com/">https://google.com/</A>
    &gt; 10.0.1.180 TCP_TUNNEL_ABORTED/200 5103 CONNECT 172.217.2.110:443
    &gt; 

      acl SSL_port port 443
      http_access allow SSL_port

      ssl_bump peek all


    &gt; ~$ # this is denying - but not from squid, but openssl?
    &gt; ~$ curl <A HREF="https://news.ycombinator.com/">https://news.ycombinator.com/</A>
    &gt; curl: (35) OpenSSL SSL_connect: SSL_ERROR_SYSCALL in connection to news.ycombinator.com:443
    &gt; 10.0.1.180 NONE_ABORTED/200 0 CONNECT 209.216.230.240:443
    &gt; 

      acl SSL_port port 443
      http_access allow SSL_port

      ssl_bump terminate all



    Amos
    _______________________________________________
    squid-users mailing list
    <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
    <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="022033.html">[squid-users] Ubuntu 18 with Squid 4.11 SSL_BUMP
</A></li>
	<LI>Next message (by thread): <A HREF="022035.html">[squid-users] [EXTERNAL] Re: Ubuntu 18 with Squid 4.11 SSL_BUMP
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22034">[ date ]</a>
              <a href="thread.html#22034">[ thread ]</a>
              <a href="subject.html#22034">[ subject ]</a>
              <a href="author.html#22034">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
