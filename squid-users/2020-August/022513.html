<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] High memory usage under load with caching disabled, memory is not being freed even with no load
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20High%20memory%20usage%20under%20load%20with%20caching%0A%20disabled%2C%20memory%20is%20not%20being%20freed%20even%20with%20no%20load&In-Reply-To=%3CCAFJ4_4tiYEBq_i-RfXir3Ek56Jq3nZ8dVzyaYQeQT_GHfavayQ%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="022512.html">
   <LINK REL="Next"  HREF="022514.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] High memory usage under load with caching disabled, memory is not being freed even with no load</H1>
    <B>Ivan Bulatovic</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20High%20memory%20usage%20under%20load%20with%20caching%0A%20disabled%2C%20memory%20is%20not%20being%20freed%20even%20with%20no%20load&In-Reply-To=%3CCAFJ4_4tiYEBq_i-RfXir3Ek56Jq3nZ8dVzyaYQeQT_GHfavayQ%40mail.gmail.com%3E"
       TITLE="[squid-users] High memory usage under load with caching disabled, memory is not being freed even with no load">ivan.bulatovic at gmail.com
       </A><BR>
    <I>Mon Aug  3 13:11:31 UTC 2020</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="022512.html">[squid-users] youtube-dl
</A></li>
        <LI>Next message (by thread): <A HREF="022514.html">[squid-users] High memory usage under load with caching disabled, memory is not being freed even with no load
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22513">[ date ]</a>
              <a href="thread.html#22513">[ thread ]</a>
              <a href="subject.html#22513">[ subject ]</a>
              <a href="author.html#22513">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi all,

I tried with stock squid from Ubuntu 18.04 (version 4.10) and basic
config, but still no luck. Here is the config I tried:
-----------------------------------------
acl localnet src 10.20.0.0/16           # My network
acl localnet src fc00::/7               # RFC 4193 local private network range
acl localnet src fe80::/10              # RFC 4291 link-local
(directly plugged) machines

acl SSL_ports port 443

acl Safe_ports port 80          # http
acl Safe_ports port 21          # ftp
acl Safe_ports port 443         # https
acl Safe_ports port 70          # gopher
acl Safe_ports port 210         # wais
acl Safe_ports port 1025-65535  # unregistered ports
acl Safe_ports port 280         # http-mgmt
acl Safe_ports port 488         # gss-http
acl Safe_ports port 591         # filemaker
acl Safe_ports port 777         # multiling http

acl CONNECT method CONNECT

cache deny all

http_access deny !Safe_ports

http_access deny CONNECT !SSL_ports

http_access allow localhost manager
http_access allow localnet manager
http_access deny manager
http_access deny to_localhost
http_access allow localnet
http_access allow localhost
http_access deny all

http_port localhost:3128
http_port 10.20.6.8:50505

coredump_dir /var/spool/squid

shutdown_lifetime 2 seconds
max_filedescriptors 262143

server_persistent_connections off
client_persistent_connections off

request_header_access Via deny all
request_header_access X-Forwarded-For deny all
dns_v4_first on
------------------------------------

Looks like squid has some serious memory issues when under heavy load
(90 servers that crawl Internet sites). It just eats up memory, and
does not free it up even days after it is being used (with no load on
the proxy for days). So I guess I have to look for another solution.

Best regards,
Ivan Bulatovic


On Mon, Jul 20, 2020 at 10:46 PM Ivan Bulatovic
&lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">ivan.bulatovic at gmail.com</A>&gt; wrote:
&gt;<i>
</I>&gt;<i> Hi all,
</I>&gt;<i>
</I>&gt;<i> I am trying to configure squid to run as a forward proxy with no
</I>&gt;<i> caching (cache deny all) with an option to choose the outgoing IP
</I>&gt;<i> address based on the username. So all squid has to do is to use a
</I>&gt;<i> certain outgoing IP address for a certain user, return the data from
</I>&gt;<i> the server to that user and cache nothing.
</I>&gt;<i>
</I>&gt;<i> For that I created a special authentication helper and used the ACLs
</I>&gt;<i> and tcp_outgoing_address to create a lot of users and outgoing IP
</I>&gt;<i> addresses (about 260 at the moment). Example (not the real IP I use,
</I>&gt;<i> of course):
</I>&gt;<i>
</I>&gt;<i> acl use_IP1 proxy_auth user1
</I>&gt;<i> tcp_outgoing_address 1.2.3.4   use_IP1
</I>&gt;<i>
</I>&gt;<i> I also configured the squid to use 4 workers, but this happens even
</I>&gt;<i> when I use only one worker (default)
</I>&gt;<i>
</I>&gt;<i> And this works. However, under heavy load, Squid eats all of the RAM
</I>&gt;<i> and then starts going to swap. And the memory usage does not drop when
</I>&gt;<i> I remove all the load from squid (I shut down all clients).
</I>&gt;<i>
</I>&gt;<i> I left it to see if the memory will be freed but even after leaving it
</I>&gt;<i> for an hour the info page reports this:
</I>&gt;<i> Cache information for squid:
</I>&gt;<i>         Hits as % of all requests:      5min: 0.0%, 60min: 0.0%
</I>&gt;<i>         Hits as % of bytes sent:        5min: 0.0%, 60min: 1.1%
</I>&gt;<i>         Memory hits as % of hit requests:       5min: 0.0%, 60min: 0.0%
</I>&gt;<i>         Disk hits as % of hit requests: 5min: 0.0%, 60min: 100.0%
</I>&gt;<i>         Storage Swap size:      0 KB
</I>&gt;<i>         Storage Swap capacity:   0.0% used, 100.0% free
</I>&gt;<i>         Storage Mem size:       0 KB
</I>&gt;<i>         Storage Mem capacity:    0.0% used, 100.0% free
</I>&gt;<i>         Mean Object Size:       0.00 KB
</I>&gt;<i>         Requests given to unlinkd:      0
</I>&gt;<i>
</I>&gt;<i> Resource usage for squid:
</I>&gt;<i>         UP Time:        255334.875 seconds
</I>&gt;<i>         CPU Time:       7122.436 seconds
</I>&gt;<i>         CPU Usage:      2.79%
</I>&gt;<i>         CPU Usage, 5 minute avg:        0.05%
</I>&gt;<i>         CPU Usage, 60 minute avg:       37.66%
</I>&gt;<i>         Maximum Resident Size: 41500720 KB
</I>&gt;<i>         Page faults with physical i/o: 1003410
</I>&gt;<i>
</I>&gt;<i> And here is the listing of free and top commands (with no load on the server):
</I>&gt;<i>
</I>&gt;<i> # free -h
</I>&gt;<i>               total        used        free      shared  buff/cache   available
</I>&gt;<i> Mem:            11G         10G        791M        676K        491M        1.0G
</I>&gt;<i> Swap:           11G        5.5G        6.5G
</I>&gt;<i>
</I>&gt;<i> # top
</I>&gt;<i> top - 14:12:32 up 3 days,  1:30,  1 user,  load average: 0.00, 0.00, 0.00
</I>&gt;<i> Tasks: 177 total,   1 running, 102 sleeping,   0 stopped,   0 zombie
</I>&gt;<i> %Cpu0  :  0.0 us,  0.0 sy,  0.0 ni,100.0 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st
</I>&gt;<i> %Cpu1  :  0.0 us,  0.0 sy,  0.0 ni,100.0 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st
</I>&gt;<i> %Cpu2  :  0.0 us,  0.3 sy,  0.0 ni, 99.7 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st
</I>&gt;<i> %Cpu3  :  0.0 us,  0.0 sy,  0.0 ni,100.0 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st
</I>&gt;<i> %Cpu4  :  0.0 us,  0.0 sy,  0.0 ni,100.0 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st
</I>&gt;<i> %Cpu5  :  0.0 us,  0.0 sy,  0.0 ni,100.0 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st
</I>&gt;<i> %Cpu6  :  0.0 us,  0.0 sy,  0.0 ni,100.0 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st
</I>&gt;<i> %Cpu7  :  0.0 us,  0.0 sy,  0.0 ni,100.0 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st
</I>&gt;<i> KiB Mem : 91.2/12251688
</I>&gt;<i> [|||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||
</I>&gt;<i>         ]
</I>&gt;<i> KiB Swap: 45.8/12582904
</I>&gt;<i> [||||||||||||||||||||||||||||||||||||||||||||||
</I>&gt;<i>                               ]
</I>&gt;<i>
</I>&gt;<i>    PID USER      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND
</I>&gt;<i>   7851 proxy     20   0 6946872 2.514g   8084 S   0.0 21.5  29:43.74 squid
</I>&gt;<i>   7832 proxy     20   0 6711480 2.464g   8040 S   0.0 21.1  29:58.17 squid
</I>&gt;<i>   7814 proxy     20   0 6834928 2.454g  10024 S   0.0 21.0  29:47.56 squid
</I>&gt;<i>   7843 proxy     20   0 6906252 2.436g   8208 S   0.0 20.8  29:15.60 squid
</I>&gt;<i>   1329 root      20   0 2416672 167272  12680 S   0.0  1.4 136:18.57 metricbeat
</I>&gt;<i>   1321 root      20   0 1831804  48364  11648 S   0.0  0.4  14:32.10 filebeat
</I>&gt;<i>    474 root      19  -1  127796  17576  17144 S   0.0  0.1   0:27.01
</I>&gt;<i> systemd-journal
</I>&gt;<i>   7811 proxy     20   0  549384  14168   8372 S   0.0  0.1   0:20.87 squid
</I>&gt;<i>   1166 root      20   0 1749724  10596   4468 S   0.0  0.1   0:31.83 snapd
</I>&gt;<i>  43940 proxy     20   0   28884   9608   5384 S   0.0  0.1   0:00.14 python3
</I>&gt;<i>  43941 proxy     20   0   28884   9552   5328 S   0.0  0.1   0:00.10 python3
</I>&gt;<i>  43939 proxy     20   0   28884   9524   5308 S   0.0  0.1   0:00.12 python3
</I>&gt;<i>  43938 proxy     20   0   28884   9452   5232 S   0.0  0.1   0:00.16 python3
</I>&gt;<i>  48848 root      20   0  105688   6960   5968 S   0.0  0.1   0:00.02 sshd
</I>&gt;<i>  48974 janitor   20   0  108120   5380   4372 S   0.0  0.0   0:00.00 sshd
</I>&gt;<i>      1 root      20   0   86360   4364   2488 S   0.0  0.0  32:46.22 systemd
</I>&gt;<i> ...
</I>&gt;<i> ... lines ommited
</I>&gt;<i> ...
</I>&gt;<i>
</I>&gt;<i> In the attachment you can find the printout from squidclient mgr:info
</I>&gt;<i> and squidclient mgr:mem. These are both taken at the moment when there
</I>&gt;<i> is no more load on the proxy. I also included my squid.conf file
</I>&gt;<i> (minus the two files where acls are defined and outgoing IP addresses,
</I>&gt;<i> these two contain only acl and tcp_outgoing_address lines as in the
</I>&gt;<i> example above).
</I>&gt;<i>
</I>&gt;<i> Machine info:
</I>&gt;<i> OS: Ubuntu 18.04 with latest updates
</I>&gt;<i> Squid version 4.12 (from diladele repository)
</I>&gt;<i> Hardware: Hyper-V virtual machine with 8 vCPU, 12GB of RAM
</I>&gt;<i>
</I>&gt;<i> I can not understand what is eating all of the memory, if I disabled the cache.
</I>&gt;<i>
</I>&gt;<i> Maybe I configured something wrong but I can not find what.
</I>&gt;<i>
</I>&gt;<i> Thank you for any help you can provide.
</I>&gt;<i>
</I>&gt;<i> Best regards,
</I>&gt;<i> Ivan
</I>
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="022512.html">[squid-users] youtube-dl
</A></li>
	<LI>Next message (by thread): <A HREF="022514.html">[squid-users] High memory usage under load with caching disabled, memory is not being freed even with no load
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22513">[ date ]</a>
              <a href="thread.html#22513">[ thread ]</a>
              <a href="subject.html#22513">[ subject ]</a>
              <a href="author.html#22513">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
