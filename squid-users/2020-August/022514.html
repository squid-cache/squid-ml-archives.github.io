<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] High memory usage under load with caching disabled, memory is not being freed even with no load
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20High%20memory%20usage%20under%20load%20with%20caching%0A%20disabled%2C%20memory%20is%20not%20being%20freed%20even%20with%20no%20load&In-Reply-To=%3C01642842-e00a-cf95-c7da-b4b6067f7519%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="022513.html">
   <LINK REL="Next"  HREF="022519.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] High memory usage under load with caching disabled, memory is not being freed even with no load</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20High%20memory%20usage%20under%20load%20with%20caching%0A%20disabled%2C%20memory%20is%20not%20being%20freed%20even%20with%20no%20load&In-Reply-To=%3C01642842-e00a-cf95-c7da-b4b6067f7519%40measurement-factory.com%3E"
       TITLE="[squid-users] High memory usage under load with caching disabled, memory is not being freed even with no load">rousskov at measurement-factory.com
       </A><BR>
    <I>Mon Aug  3 20:01:47 UTC 2020</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="022513.html">[squid-users] High memory usage under load with caching disabled, memory is not being freed even with no load
</A></li>
        <LI>Next message (by thread): <A HREF="022519.html">[squid-users] High memory usage under load with caching disabled, memory is not being freed even with no load
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22514">[ date ]</a>
              <a href="thread.html#22514">[ thread ]</a>
              <a href="subject.html#22514">[ subject ]</a>
              <a href="author.html#22514">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 8/3/20 9:11 AM, Ivan Bulatovic wrote:

&gt;<i> Looks like squid has some serious memory issues when under heavy load
</I>&gt;<i> (90 servers that crawl Internet sites). 
</I>
&gt;<i>         Maximum Resident Size: 41500720 KB
</I>
If the above (unreliable) report matches your observations using system
tools like &quot;top&quot;, then it is indeed likely that your Squid is suffering
from a memory leak -- 41GB is usually too much for most non-caching
Squid instances.

Identifying the leak may take some time, and I am not volunteering to do
the necessary legwork personally, but the Squid Project does fix
virtually all runtime leaks that we know about. If you want to speed up
the process, one of the best things you can do is to run Squid under
valgrind with a good suppression file. This requires building Squid with
a special ./configure option. Several testing iterations may be
necessary. If you are willing to do this, please file a bug report and
somebody will guide you through the steps.


&gt;<i> It just eats up memory, and
</I>&gt;<i> does not free it up even days after it is being used (with no load on
</I>&gt;<i> the proxy for days).
</I>
Some memory retention is expected by default. See
<A HREF="http://www.squid-cache.org/Doc/config/memory_pools/">http://www.squid-cache.org/Doc/config/memory_pools/</A>

Unfortunately, AFAICT, your mgr:mem output does not show any obvious
leaks -- all numbers are very small. If something is leaking a lot, then
it is probably not pooled by Squid.


HTH,

Alex.


&gt;<i> On Mon, Jul 20, 2020 at 10:46 PM Ivan Bulatovic wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Hi all,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I am trying to configure squid to run as a forward proxy with no
</I>&gt;&gt;<i> caching (cache deny all) with an option to choose the outgoing IP
</I>&gt;&gt;<i> address based on the username. So all squid has to do is to use a
</I>&gt;&gt;<i> certain outgoing IP address for a certain user, return the data from
</I>&gt;&gt;<i> the server to that user and cache nothing.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> For that I created a special authentication helper and used the ACLs
</I>&gt;&gt;<i> and tcp_outgoing_address to create a lot of users and outgoing IP
</I>&gt;&gt;<i> addresses (about 260 at the moment). Example (not the real IP I use,
</I>&gt;&gt;<i> of course):
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> acl use_IP1 proxy_auth user1
</I>&gt;&gt;<i> tcp_outgoing_address 1.2.3.4   use_IP1
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I also configured the squid to use 4 workers, but this happens even
</I>&gt;&gt;<i> when I use only one worker (default)
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> And this works. However, under heavy load, Squid eats all of the RAM
</I>&gt;&gt;<i> and then starts going to swap. And the memory usage does not drop when
</I>&gt;&gt;<i> I remove all the load from squid (I shut down all clients).
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I left it to see if the memory will be freed but even after leaving it
</I>&gt;&gt;<i> for an hour the info page reports this:
</I>&gt;&gt;<i> Cache information for squid:
</I>&gt;&gt;<i>         Hits as % of all requests:      5min: 0.0%, 60min: 0.0%
</I>&gt;&gt;<i>         Hits as % of bytes sent:        5min: 0.0%, 60min: 1.1%
</I>&gt;&gt;<i>         Memory hits as % of hit requests:       5min: 0.0%, 60min: 0.0%
</I>&gt;&gt;<i>         Disk hits as % of hit requests: 5min: 0.0%, 60min: 100.0%
</I>&gt;&gt;<i>         Storage Swap size:      0 KB
</I>&gt;&gt;<i>         Storage Swap capacity:   0.0% used, 100.0% free
</I>&gt;&gt;<i>         Storage Mem size:       0 KB
</I>&gt;&gt;<i>         Storage Mem capacity:    0.0% used, 100.0% free
</I>&gt;&gt;<i>         Mean Object Size:       0.00 KB
</I>&gt;&gt;<i>         Requests given to unlinkd:      0
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Resource usage for squid:
</I>&gt;&gt;<i>         UP Time:        255334.875 seconds
</I>&gt;&gt;<i>         CPU Time:       7122.436 seconds
</I>&gt;&gt;<i>         CPU Usage:      2.79%
</I>&gt;&gt;<i>         CPU Usage, 5 minute avg:        0.05%
</I>&gt;&gt;<i>         CPU Usage, 60 minute avg:       37.66%
</I>&gt;&gt;<i>         Maximum Resident Size: 41500720 KB
</I>&gt;&gt;<i>         Page faults with physical i/o: 1003410
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> And here is the listing of free and top commands (with no load on the server):
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> # free -h
</I>&gt;&gt;<i>               total        used        free      shared  buff/cache   available
</I>&gt;&gt;<i> Mem:            11G         10G        791M        676K        491M        1.0G
</I>&gt;&gt;<i> Swap:           11G        5.5G        6.5G
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> # top
</I>&gt;&gt;<i> top - 14:12:32 up 3 days,  1:30,  1 user,  load average: 0.00, 0.00, 0.00
</I>&gt;&gt;<i> Tasks: 177 total,   1 running, 102 sleeping,   0 stopped,   0 zombie
</I>&gt;&gt;<i> %Cpu0  :  0.0 us,  0.0 sy,  0.0 ni,100.0 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st
</I>&gt;&gt;<i> %Cpu1  :  0.0 us,  0.0 sy,  0.0 ni,100.0 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st
</I>&gt;&gt;<i> %Cpu2  :  0.0 us,  0.3 sy,  0.0 ni, 99.7 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st
</I>&gt;&gt;<i> %Cpu3  :  0.0 us,  0.0 sy,  0.0 ni,100.0 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st
</I>&gt;&gt;<i> %Cpu4  :  0.0 us,  0.0 sy,  0.0 ni,100.0 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st
</I>&gt;&gt;<i> %Cpu5  :  0.0 us,  0.0 sy,  0.0 ni,100.0 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st
</I>&gt;&gt;<i> %Cpu6  :  0.0 us,  0.0 sy,  0.0 ni,100.0 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st
</I>&gt;&gt;<i> %Cpu7  :  0.0 us,  0.0 sy,  0.0 ni,100.0 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st
</I>&gt;&gt;<i> KiB Mem : 91.2/12251688
</I>&gt;&gt;<i> [|||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||||
</I>&gt;&gt;<i>         ]
</I>&gt;&gt;<i> KiB Swap: 45.8/12582904
</I>&gt;&gt;<i> [||||||||||||||||||||||||||||||||||||||||||||||
</I>&gt;&gt;<i>                               ]
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>    PID USER      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND
</I>&gt;&gt;<i>   7851 proxy     20   0 6946872 2.514g   8084 S   0.0 21.5  29:43.74 squid
</I>&gt;&gt;<i>   7832 proxy     20   0 6711480 2.464g   8040 S   0.0 21.1  29:58.17 squid
</I>&gt;&gt;<i>   7814 proxy     20   0 6834928 2.454g  10024 S   0.0 21.0  29:47.56 squid
</I>&gt;&gt;<i>   7843 proxy     20   0 6906252 2.436g   8208 S   0.0 20.8  29:15.60 squid
</I>&gt;&gt;<i>   1329 root      20   0 2416672 167272  12680 S   0.0  1.4 136:18.57 metricbeat
</I>&gt;&gt;<i>   1321 root      20   0 1831804  48364  11648 S   0.0  0.4  14:32.10 filebeat
</I>&gt;&gt;<i>    474 root      19  -1  127796  17576  17144 S   0.0  0.1   0:27.01
</I>&gt;&gt;<i> systemd-journal
</I>&gt;&gt;<i>   7811 proxy     20   0  549384  14168   8372 S   0.0  0.1   0:20.87 squid
</I>&gt;&gt;<i>   1166 root      20   0 1749724  10596   4468 S   0.0  0.1   0:31.83 snapd
</I>&gt;&gt;<i>  43940 proxy     20   0   28884   9608   5384 S   0.0  0.1   0:00.14 python3
</I>&gt;&gt;<i>  43941 proxy     20   0   28884   9552   5328 S   0.0  0.1   0:00.10 python3
</I>&gt;&gt;<i>  43939 proxy     20   0   28884   9524   5308 S   0.0  0.1   0:00.12 python3
</I>&gt;&gt;<i>  43938 proxy     20   0   28884   9452   5232 S   0.0  0.1   0:00.16 python3
</I>&gt;&gt;<i>  48848 root      20   0  105688   6960   5968 S   0.0  0.1   0:00.02 sshd
</I>&gt;&gt;<i>  48974 janitor   20   0  108120   5380   4372 S   0.0  0.0   0:00.00 sshd
</I>&gt;&gt;<i>      1 root      20   0   86360   4364   2488 S   0.0  0.0  32:46.22 systemd
</I>&gt;&gt;<i> ...
</I>&gt;&gt;<i> ... lines ommited
</I>&gt;&gt;<i> ...
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> In the attachment you can find the printout from squidclient mgr:info
</I>&gt;&gt;<i> and squidclient mgr:mem. These are both taken at the moment when there
</I>&gt;&gt;<i> is no more load on the proxy. I also included my squid.conf file
</I>&gt;&gt;<i> (minus the two files where acls are defined and outgoing IP addresses,
</I>&gt;&gt;<i> these two contain only acl and tcp_outgoing_address lines as in the
</I>&gt;&gt;<i> example above).
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Machine info:
</I>&gt;&gt;<i> OS: Ubuntu 18.04 with latest updates
</I>&gt;&gt;<i> Squid version 4.12 (from diladele repository)
</I>&gt;&gt;<i> Hardware: Hyper-V virtual machine with 8 vCPU, 12GB of RAM
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I can not understand what is eating all of the memory, if I disabled the cache.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Maybe I configured something wrong but I can not find what.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Thank you for any help you can provide.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Best regards,
</I>&gt;&gt;<i> Ivan
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i> 
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="022513.html">[squid-users] High memory usage under load with caching disabled, memory is not being freed even with no load
</A></li>
	<LI>Next message (by thread): <A HREF="022519.html">[squid-users] High memory usage under load with caching disabled, memory is not being freed even with no load
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22514">[ date ]</a>
              <a href="thread.html#22514">[ thread ]</a>
              <a href="subject.html#22514">[ subject ]</a>
              <a href="author.html#22514">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
