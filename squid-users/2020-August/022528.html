<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] High memory usage under load with caching disabled, memory is not being freed even with no load
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20High%20memory%20usage%20under%20load%20with%20caching%0A%20disabled%2C%20memory%20is%20not%20being%20freed%20even%20with%20no%20load&In-Reply-To=%3Cd7b64824-3784-d44c-bced-e9f37580432e%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="022522.html">
   <LINK REL="Next"  HREF="022529.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] High memory usage under load with caching disabled, memory is not being freed even with no load</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20High%20memory%20usage%20under%20load%20with%20caching%0A%20disabled%2C%20memory%20is%20not%20being%20freed%20even%20with%20no%20load&In-Reply-To=%3Cd7b64824-3784-d44c-bced-e9f37580432e%40treenet.co.nz%3E"
       TITLE="[squid-users] High memory usage under load with caching disabled, memory is not being freed even with no load">squid3 at treenet.co.nz
       </A><BR>
    <I>Fri Aug  7 00:13:14 UTC 2020</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="022522.html">[squid-users] High memory usage under load with caching disabled, memory is not being freed even with no load
</A></li>
        <LI>Next message (by thread): <A HREF="022529.html">[squid-users] High memory usage under load with caching disabled, memory is not being freed even with no load
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22528">[ date ]</a>
              <a href="thread.html#22528">[ thread ]</a>
              <a href="subject.html#22528">[ subject ]</a>
              <a href="author.html#22528">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 6/08/20 11:06 am, NgTech LTD wrote:
&gt;<i> Hey Ivan,
</I>&gt;<i> 
</I>&gt;<i> From what i remember there is a calculation for how much k per conn
</I>&gt;<i> should squid use.
</I>
Aye;
 256KB * number of currently open FD
 + read_ahead_gap
 + received size of current in-transit response (if cacheable MISS)


&gt;<i> another thing is that squid is not returning memory once ot took it.
</I>
The calculation for this is _minimum_ 5MB per type of memory allocating
object is retained by Squid for quick re-use. The mgr:mem report lists
details of those allocations.



Alex didn't mention this earlier but what I am seeing in your &quot;top&quot; tool
output is that there are 5x 'squid' processes running. It looks like 4
of them are SMP worker or disker processes each using 2.5GB of RAM.

The &quot;free&quot; tool is confirming this with its report of &quot;used: 10G&quot; (4x
2.5GB) of memory actually being used on the machine.

Most kernels fork() implementation is terrible with virtual memory
calculations. Most of that number will never actually be used. So they
can be ignored so long as the per-process number does not exceed the
actual physical RAM installed (beyond that kernel refuses to spawn with
fork()).
 The numbers your tools are reporting are kind of reasonable - maximum
about 7GB *per process* allocated.


The 41GB &quot;resident size&quot; is from old memory allocation APIs in the
kernel which suffer from 32-bit issues. When this value has odd numbers
and/or conflicts with the system tools - believe the tools instead.



So to summarize; what I am seeing there is that during *Peak* load times
your proxy workers (combined) are *maybe* using up to 41GB of memory. At
the off-peak time you are doing your analysis reports they have dropped
down to 10GB.
 With one data point there is no sign of a memory leak happening. Just a
normal machine handling far more peak traffic than its available amount
of memory can cope with.

 That is not to rule out a leak entirely. More measurements over time
may show a pattern of increasing off-peak memory allocated. But just one
comparison of peak vs off-peak is not going to reveal that type of pattern.


Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="022522.html">[squid-users] High memory usage under load with caching disabled, memory is not being freed even with no load
</A></li>
	<LI>Next message (by thread): <A HREF="022529.html">[squid-users] High memory usage under load with caching disabled, memory is not being freed even with no load
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22528">[ date ]</a>
              <a href="thread.html#22528">[ thread ]</a>
              <a href="subject.html#22528">[ subject ]</a>
              <a href="author.html#22528">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
