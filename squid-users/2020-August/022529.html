<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] High memory usage under load with caching disabled, memory is not being freed even with no load
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20High%20memory%20usage%20under%20load%20with%20caching%0A%20disabled%2C%20memory%20is%20not%20being%20freed%20even%20with%20no%20load&In-Reply-To=%3CCAFJ4_4uvU%2BFtATcU_HOx1FKEDQPWJGm7td-fyO5BJ-dt%2B_ct3w%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="022528.html">
   <LINK REL="Next"  HREF="022530.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] High memory usage under load with caching disabled, memory is not being freed even with no load</H1>
    <B>Ivan Bulatovic</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20High%20memory%20usage%20under%20load%20with%20caching%0A%20disabled%2C%20memory%20is%20not%20being%20freed%20even%20with%20no%20load&In-Reply-To=%3CCAFJ4_4uvU%2BFtATcU_HOx1FKEDQPWJGm7td-fyO5BJ-dt%2B_ct3w%40mail.gmail.com%3E"
       TITLE="[squid-users] High memory usage under load with caching disabled, memory is not being freed even with no load">ivan.bulatovic at gmail.com
       </A><BR>
    <I>Fri Aug  7 17:30:07 UTC 2020</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="022528.html">[squid-users] High memory usage under load with caching disabled, memory is not being freed even with no load
</A></li>
        <LI>Next message (by thread): <A HREF="022530.html">[squid-users] High memory usage under load with caching disabled, memory is not being freed even with no load
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22529">[ date ]</a>
              <a href="thread.html#22529">[ thread ]</a>
              <a href="subject.html#22529">[ subject ]</a>
              <a href="author.html#22529">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Amos,

&gt;<i> &gt; From what i remember there is a calculation for how much k per conn
</I>&gt;<i> &gt; should squid use.
</I>&gt;<i>
</I>&gt;<i> Aye;
</I>&gt;<i>  256KB * number of currently open FD
</I>&gt;<i>  + read_ahead_gap
</I>&gt;<i>  + received size of current in-transit response (if cacheable MISS)
</I>
I tried to reduce the number of in-memory objects using following (I
read somewhere that 4KB is the minimum block of memory that squid can
allocate):
  cache_mem 8 MB
  maximum_object_size 4 KB
  maximum_object_size_in_memory 4 KB
  read_ahead_gap 4 KB

But the above settings did not help much.

At the moment I am running a much lighter load on the squid VM to see
how it behaves.

So, right now, the machine has about 110.000 open TCP connections (I
guess half are from clients and the other half is to the Internet,
which my firewall also confirms). It has been running like this for
the last 4 hours or so.

Here is the situation (in the attachment you will find full command
print-outs and config file):

- Running squid 4.12 from diladele repository on Ubuntu 18.04 LTS

- RAM used: around 9 GB out of 16 GB (no of swap is used)

- I am running 2 squid workers at the moment (see attached squid.conf)

- Top reports this (removed other processes, they practically have no
impact on the memory listing):

top - 10:22:03 up 18:00,  1 user,  load average: 1.88, 1.58, 1.43
Tasks: 169 total,   1 running,  94 sleeping,   0 stopped,   0 zombie
%Cpu(s): 13.6 us,  9.6 sy,  0.0 ni, 72.7 id,  0.1 wa,  0.0 hi,  3.9 si,  0.0 st
KiB Mem : 16380456 total,  5011560 free,  9205660 used,  2163236 buff/cache
KiB Swap: 12582904 total, 12582904 free,        0 used.  7121124 avail Mem

   PID USER      PR  NI    VIRT    RES    SHR S  %CPU %MEM     TIME+ COMMAND
  1515 proxy     20   0 5713808 4.396g  14188 S  36.5 28.1 130:03.34 squid
  1514 proxy     20   0 4360348 3.329g  14380 S  28.9 21.3 104:15.21 squid

 - mgr:info show some weird stats:
    Number of clients accessing cache:      156   (which is exactly
twice the number of actual clients, but this is probably due to the
number of workers)
    Maximum Resident Size: 32467680 KB   (which is 32GB. At no time
during these 4 hours has this value of RAM consumption ever been
reached. The memory is steadily, but slowly increasing to where it is
now - at 9 GB. I have no idea what this value is.)

I have no idea if the rest of the stats from mgr:info are OK or not, I
really have no way of checking that.

I added to the configuration memory pools option, we will see if it
helps (I think I already tried this, but I can not be sure, I ran a
lot of tests trying to fix this myself before I reached out to you):
memory_pools off

If there is anything else I can do to help with debugging this, please
let me know.

Thank you for your time and help,
Ivan


On Fri, Aug 7, 2020 at 2:23 AM Amos Jeffries &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt; wrote:
&gt;<i>
</I>&gt;<i> On 6/08/20 11:06 am, NgTech LTD wrote:
</I>&gt;<i> &gt; Hey Ivan,
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; From what i remember there is a calculation for how much k per conn
</I>&gt;<i> &gt; should squid use.
</I>&gt;<i>
</I>&gt;<i> Aye;
</I>&gt;<i>  256KB * number of currently open FD
</I>&gt;<i>  + read_ahead_gap
</I>&gt;<i>  + received size of current in-transit response (if cacheable MISS)
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; another thing is that squid is not returning memory once ot took it.
</I>&gt;<i>
</I>&gt;<i> The calculation for this is _minimum_ 5MB per type of memory allocating
</I>&gt;<i> object is retained by Squid for quick re-use. The mgr:mem report lists
</I>&gt;<i> details of those allocations.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Alex didn't mention this earlier but what I am seeing in your &quot;top&quot; tool
</I>&gt;<i> output is that there are 5x 'squid' processes running. It looks like 4
</I>&gt;<i> of them are SMP worker or disker processes each using 2.5GB of RAM.
</I>&gt;<i>
</I>&gt;<i> The &quot;free&quot; tool is confirming this with its report of &quot;used: 10G&quot; (4x
</I>&gt;<i> 2.5GB) of memory actually being used on the machine.
</I>&gt;<i>
</I>&gt;<i> Most kernels fork() implementation is terrible with virtual memory
</I>&gt;<i> calculations. Most of that number will never actually be used. So they
</I>&gt;<i> can be ignored so long as the per-process number does not exceed the
</I>&gt;<i> actual physical RAM installed (beyond that kernel refuses to spawn with
</I>&gt;<i> fork()).
</I>&gt;<i>  The numbers your tools are reporting are kind of reasonable - maximum
</I>&gt;<i> about 7GB *per process* allocated.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> The 41GB &quot;resident size&quot; is from old memory allocation APIs in the
</I>&gt;<i> kernel which suffer from 32-bit issues. When this value has odd numbers
</I>&gt;<i> and/or conflicts with the system tools - believe the tools instead.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> So to summarize; what I am seeing there is that during *Peak* load times
</I>&gt;<i> your proxy workers (combined) are *maybe* using up to 41GB of memory. At
</I>&gt;<i> the off-peak time you are doing your analysis reports they have dropped
</I>&gt;<i> down to 10GB.
</I>&gt;<i>  With one data point there is no sign of a memory leak happening. Just a
</I>&gt;<i> normal machine handling far more peak traffic than its available amount
</I>&gt;<i> of memory can cope with.
</I>&gt;<i>
</I>&gt;<i>  That is not to rule out a leak entirely. More measurements over time
</I>&gt;<i> may show a pattern of increasing off-peak memory allocated. But just one
</I>&gt;<i> comparison of peak vs off-peak is not going to reveal that type of pattern.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Amos
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>-------------- next part --------------
A non-text attachment was scrubbed...
Name: Proxy01 test 2020-08-07.zip
Type: application/x-zip-compressed
Size: 8605 bytes
Desc: not available
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20200807/671e6475/attachment.bin">http://lists.squid-cache.org/pipermail/squid-users/attachments/20200807/671e6475/attachment.bin</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="022528.html">[squid-users] High memory usage under load with caching disabled, memory is not being freed even with no load
</A></li>
	<LI>Next message (by thread): <A HREF="022530.html">[squid-users] High memory usage under load with caching disabled, memory is not being freed even with no load
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22529">[ date ]</a>
              <a href="thread.html#22529">[ thread ]</a>
              <a href="subject.html#22529">[ subject ]</a>
              <a href="author.html#22529">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
