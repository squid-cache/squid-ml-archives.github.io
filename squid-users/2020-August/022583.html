<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Strange Squid SSL Interception Behavior
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Strange%20Squid%20SSL%20Interception%20Behavior&In-Reply-To=%3CDB7PR04MB51800B1C539C590A42CA5DCEDF570%40DB7PR04MB5180.eurprd04.prod.outlook.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="022581.html">
   <LINK REL="Next"  HREF="022585.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Strange Squid SSL Interception Behavior</H1>
    <B>Mathew Brown</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Strange%20Squid%20SSL%20Interception%20Behavior&In-Reply-To=%3CDB7PR04MB51800B1C539C590A42CA5DCEDF570%40DB7PR04MB5180.eurprd04.prod.outlook.com%3E"
       TITLE="[squid-users] Strange Squid SSL Interception Behavior">mbrown8918 at outlook.com
       </A><BR>
    <I>Tue Aug 25 01:09:27 UTC 2020</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="022581.html">[squid-users] Strange Squid SSL Interception Behavior
</A></li>
        <LI>Next message (by thread): <A HREF="022585.html">[squid-users] Strange Squid SSL Interception Behavior
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22583">[ date ]</a>
              <a href="thread.html#22583">[ thread ]</a>
              <a href="subject.html#22583">[ subject ]</a>
              <a href="author.html#22583">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Thanks but even with the --no-check-certificate option and using a bump instead of splicing, it still fails as shown above unless I add the localnet rule. The question is: why does the same ACL line:

http_access allow whitelist

suddenly work when I add an unrelated ACL line after it (http_access allow localnet)? Why does it correctly determine the domain httpbin.org in the later case as shown by cache.log?

I updated my splice to a bump instead so my config looks like this:

acl whitelist ssl::server_name .httpbin.org
acl whitelist_http ssl::server_name .httpbin.org

acl step1 at_step SslBump1
acl step2 at_step SslBump2
acl step3 at_step SslBump3
ssl_bump peek step1
ssl_bump bump all

http_access allow whitelist
http_access allow whitelist_http

#http_access allow localnet
http_access deny all

and so it will bump all connections:

I then ran:

wget <A HREF="https://httpbin.org">https://httpbin.org</A> --no-check-certificate

and get the following (it fails):

cat access.log

1598316641.358      3 192.168.123.214 TCP_DENIED/200 0 CONNECT 3.220.112.94:443 - HIER_NONE/- -
1598316641.366      1 192.168.123.214 NONE/403 3789 GET <A HREF="https://httpbin.org/">https://httpbin.org/</A> - HIER_NONE/- text/html

cat cache.log | grep -i httpbin.org

2020/08/24 20:50:41.356 kid1| 28,7| ServerName.cc(32) aclHostDomainCompare: Match:3.220.112.94 &lt;&gt;  .httpbin.org
2020/08/24 20:50:41.356 kid1| 28,7| ServerName.cc(32) aclHostDomainCompare: Match:3.220.112.94 &lt;&gt;  .httpbin.org

while once I add the localnet rule:

http_access allow localnet

it succeeds and access.log looks like this:

1598316682.044    753 192.168.123.214 NONE/200 0 CONNECT 54.236.246.173:443 - ORIGINAL_DST/54.236.246.173 -
1598316682.329    260 192.168.123.214 TCP_REFRESH_MODIFIED/200 9936 GET <A HREF="https://httpbin.org/">https://httpbin.org/</A> - ORIGINAL_DST/54.236.246.173 text/html

and cache.log shows that it actually does the proper domain comparison:

cat cache.log | grep -i httpbin.org

2020/08/24 20:51:21.292 kid1| 28,7| ServerName.cc(32) aclHostDomainCompare: Match:54.236.246.173 &lt;&gt;  .httpbin.org
2020/08/24 20:51:21.292 kid1| 28,7| ServerName.cc(32) aclHostDomainCompare: Match:54.236.246.173 &lt;&gt;  .httpbin.org
2020/08/24 20:51:22.071 kid1| 28,3| RegexData.cc(43) match: checking '<A HREF="https://httpbin.org/">https://httpbin.org/</A>'
2020/08/24 20:51:22.071 kid1| 28,4| ServerName.cc(82) check_cert_domain: Verifying certificate name/subjectAltName httpbin.org
2020/08/24 20:51:22.071 kid1| 28,3| ServerName.cc(42) match: checking 'httpbin.org'
2020/08/24 20:51:22.071 kid1| 28,7| ServerName.cc(32) aclHostDomainCompare: Match:httpbin.org &lt;&gt;  .httpbin.org
2020/08/24 20:51:22.071 kid1| 28,3| ServerName.cc(47) match: 'httpbin.org' found

&gt;<i>From my understanding, Squid should perform the exact same steps in both cases BUT then allow the connection because of the localnet ACL line that it sees right before the deny all line, not because it suddenly was able to match httpbin.org using a domain compare as shown by the debug logs. What am I missing?
</I>
Even if I add a peek at step2, the behavior is still the same for the first scenario although I no longer need to use --no-check-certificate in the 2nd scenario (where I whitelist localnet)

PS. I'm using the current iptable rules and making the wget call from a normal user account (so neither root or proxy):

iptables -t nat -A OUTPUT -p tcp -m tcp --dport 80 -m owner --uid-owner root -j RETURN
iptables -t nat -A OUTPUT -p tcp -m tcp --dport 80 -m owner --uid-owner proxy -j RETURN
iptables -t nat -A OUTPUT -p tcp -m tcp --dport 80 -j REDIRECT --to-ports 3129
iptables -t nat -A OUTPUT -p tcp -m tcp --dport 443 -m owner --uid-owner root -j RETURN
iptables -t nat -A OUTPUT -p tcp -m tcp --dport 443 -m owner --uid-owner proxy -j RETURN
iptables -t nat -A OUTPUT -p tcp -m tcp --dport 443 -j REDIRECT --to-ports 3130


________________________________
From: Alex Rousskov &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt;
Sent: Tuesday, August 25, 2020 8:41 AM
To: Mathew Brown &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">mbrown8918 at outlook.com</A>&gt;; <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A> &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>&gt;
Subject: Re: [squid-users] Strange Squid SSL Interception Behavior

On 8/24/20 6:21 PM, Mathew Brown wrote:

&gt;<i> acl whitelist ssl::server_name .httpbin.org
</I>&gt;<i> acl whitelist_http ssl::server_name .httpbin.org
</I>
&gt;<i> ssl_bump peek step1
</I>&gt;<i> ssl_bump splice all
</I>
&gt;<i> http_access allow whitelist
</I>&gt;<i> http_access allow whitelist_http
</I>&gt;<i> http_access deny all
</I>
The rules above only allow CONNECT requests to .httpbin.org domains.

During step1, when Squid intercepts a TLS connection to an IP address of
an .httpbin.org domain, Squid http_access rules are applied to a (fake)
CONNECT request to the destination IP address. There are no domain names
at that TCP-level bumping stage. Thus, you place your Squid at the mercy
of reverse DSN lookups.

In my environment, reverse DNS does not work for httpbin.org the way you
may expect:

&gt;<i> $ host 54.236.246.173
</I>&gt;<i> 173.246.236.54.in-addr.arpa domain name pointer ec2-54-236-246-173.compute-1.amazonaws.com.
</I>
The above AWS domain name does not match your whitelist ACLs, of course,
and, hence, the fake CONNECT request is denied. Denied requests are
bumped to deliver the error message. Bumped requests require
--no-check-certificate or other means of trusting Squid's CA certificate.

If you cannot explicitly allow CONNECT requests to httpbin.org IP
addresses (e.g., because they change too often), then consider allowing
CONNECT to safe ports at any address at step1. If you only intercept
connections to httpbin.org IPs, then you can probably relax your step1
http_access rules to allow all CONNECTs (to safe addresses).

There are many similar questions about allowing CONNECT to IP addresses
on this mailing list. You may be able to find more detailed advice or
instructions by searching for those mailing list threads.


HTH,

Alex.


&gt;<i> $ wget <A HREF="https://httpbin.org">https://httpbin.org</A>
</I>&gt;<i> --2020-08-24 17:48:34--  <A HREF="https://httpbin.org/">https://httpbin.org/</A>
</I>&gt;<i> Resolving httpbin.org (httpbin.org)... 54.236.246.173, 3.220.112.94
</I>&gt;<i> Connecting to httpbin.org (httpbin.org)|54.236.246.173|:443... connected.
</I>&gt;<i> ERROR: cannot verify httpbin.org's certificate, issued by &#8216;O=Internet
</I>&gt;<i> Widgits Pty Ltd,ST=Some-State,C=AU&#8217;:
</I>&gt;<i>   Self-signed certificate encountered.
</I>&gt;<i> To connect to httpbin.org insecurely, use `--no-check-certificate'.
</I>&gt;<i>
</I>&gt;<i> $ wget <A HREF="https://httpbin.org">https://httpbin.org</A> --no-check-certificate
</I>&gt;<i> --2020-08-24 17:48:40--  <A HREF="https://httpbin.org/">https://httpbin.org/</A>
</I>&gt;<i> Resolving httpbin.org (httpbin.org)... 3.220.112.94, 54.236.246.173
</I>&gt;<i> Connecting to httpbin.org (httpbin.org)|3.220.112.94|:443... connected.
</I>&gt;<i> WARNING: cannot verify httpbin.org's certificate, issued by &#8216;O=Internet
</I>&gt;<i> Widgits Pty Ltd,ST=Some-State,C=AU&#8217;:
</I>&gt;<i>   Self-signed certificate encountered.
</I>&gt;<i> HTTP request sent, awaiting response... 403 Forbidden
</I>&gt;<i> 2020-08-24 17:48:40 ERROR 403: Forbidden.
</I>&gt;<i>
</I>&gt;<i> looking at access.log shows:
</I>&gt;<i>
</I>&gt;<i> 1598305800.974      2 192.168.123.214 TCP_DENIED/200 0 CONNECT
</I>&gt;<i> 54.236.246.173:443 - HIER_NONE/- -
</I>&gt;<i>
</I>&gt;<i> for the first request (without the --no-check-certificate) and the
</I>&gt;<i> following for the 2nd request (with the --no-check-certificate):
</I>&gt;<i>
</I>&gt;<i> 1598305812.292      3 192.168.123.214 TCP_DENIED/200 0 CONNECT
</I>&gt;<i> 54.236.246.173:443 - HIER_NONE/- -
</I>&gt;<i> 1598305812.300      2 192.168.123.214 NONE/403 3795 GET
</I>&gt;<i> <A HREF="https://httpbin.org/">https://httpbin.org/</A> - HIER_NONE/- text/html
</I>&gt;<i>
</I>&gt;<i> looking at cache.log shows:
</I>&gt;<i>
</I>&gt;<i> # cat /var/log/squid/cache.log  | grep -i &quot;28&quot; | grep -i httpbin
</I>&gt;<i> 2020/08/24 17:50:00.972 kid1| 28,7| ServerName.cc(32)
</I>&gt;<i> aclHostDomainCompare: Match:54.236.246.173 &lt;&gt;  .httpbin.org
</I>&gt;<i> 2020/08/24 17:50:00.972 kid1| 28,7| ServerName.cc(32)
</I>&gt;<i> aclHostDomainCompare: Match:54.236.246.173 &lt;&gt;  .httpbin.org
</I>&gt;<i> 2020/08/24 17:50:12.290 kid1| 28,7| ServerName.cc(32)
</I>&gt;<i> aclHostDomainCompare: Match:54.236.246.173 &lt;&gt;  .httpbin.org
</I>&gt;<i> 2020/08/24 17:50:12.290 kid1| 28,7| ServerName.cc(32)
</I>&gt;<i> aclHostDomainCompare: Match:54.236.246.173 &lt;&gt;  .httpbin.org
</I>&gt;<i>
</I>&gt;<i> so it never matches on the httpbin.org
</I>&gt;<i>
</I>&gt;<i> now, if I add the following line to my configuration:
</I>&gt;<i>
</I>&gt;<i> http_access allow localnet
</I>&gt;<i>
</I>&gt;<i> right before the:
</I>&gt;<i>
</I>&gt;<i> http_access deny all
</I>&gt;<i>
</I>&gt;<i> line it works and I see the following in access.log:
</I>&gt;<i>
</I>&gt;<i> 1598305979.004      4 192.168.123.214 NONE/200 0 CONNECT
</I>&gt;<i> 54.236.246.173:443 - HIER_NONE/- -
</I>&gt;<i> 1598305980.016   1012 192.168.123.214 TCP_TUNNEL/200 15370 CONNECT
</I>&gt;<i> httpbin.org:443 - ORIGINAL_DST/54.236.246.173 -
</I>&gt;<i>
</I>&gt;<i> and I see the following in cache.log:
</I>&gt;<i>
</I>&gt;<i> # cat /var/log/squid/cache.log  | grep -i &quot;28&quot; | grep -i httpbin
</I>&gt;<i> 2020/08/24 17:52:59.000 kid1| 28,7| ServerName.cc(32)
</I>&gt;<i> aclHostDomainCompare: Match:54.236.246.173 &lt;&gt;  .httpbin.org
</I>&gt;<i> 2020/08/24 17:52:59.000 kid1| 28,7| ServerName.cc(32)
</I>&gt;<i> aclHostDomainCompare: Match:54.236.246.173 &lt;&gt;  .httpbin.org
</I>&gt;<i> 2020/08/24 17:52:59.005 kid1| 28,3| RegexData.cc(43) match: checking
</I>&gt;<i> 'httpbin.org:443'
</I>&gt;<i> 2020/08/24 17:52:59.005 kid1| 28,3| ServerName.cc(42) match: checking
</I>&gt;<i> 'httpbin.org'
</I>&gt;<i> 2020/08/24 17:52:59.005 kid1| 28,7| ServerName.cc(32)
</I>&gt;<i> aclHostDomainCompare: Match:httpbin.org &lt;&gt;  .httpbin.org
</I>&gt;<i> 2020/08/24 17:52:59.005 kid1| 28,3| ServerName.cc(47) match:
</I>&gt;<i> 'httpbin.org' found
</I>&gt;<i>
</I>&gt;<i> What's puzzling is why adding the 'allow localnet' line changes the ACL
</I>&gt;<i> logic for .httpbin.org and why the original configuration does not work.
</I>&gt;<i> Any ideas? Thanks
</I>&gt;<i>
</I>&gt;<i> PS. I reproduced the exact same scenario on Ubuntu 20.04 with Squid 4.12
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i>
</I>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20200825/b62dfb39/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20200825/b62dfb39/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="022581.html">[squid-users] Strange Squid SSL Interception Behavior
</A></li>
	<LI>Next message (by thread): <A HREF="022585.html">[squid-users] Strange Squid SSL Interception Behavior
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22583">[ date ]</a>
              <a href="thread.html#22583">[ thread ]</a>
              <a href="subject.html#22583">[ subject ]</a>
              <a href="author.html#22583">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
