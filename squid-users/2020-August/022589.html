<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Strange Squid SSL Interception Behavior
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Strange%20Squid%20SSL%20Interception%20Behavior&In-Reply-To=%3C3286fab7-6f19-6a81-9b11-951faac9613f%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="022585.html">
   <LINK REL="Next"  HREF="022597.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Strange Squid SSL Interception Behavior</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Strange%20Squid%20SSL%20Interception%20Behavior&In-Reply-To=%3C3286fab7-6f19-6a81-9b11-951faac9613f%40measurement-factory.com%3E"
       TITLE="[squid-users] Strange Squid SSL Interception Behavior">rousskov at measurement-factory.com
       </A><BR>
    <I>Tue Aug 25 13:24:27 UTC 2020</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="022585.html">[squid-users] Strange Squid SSL Interception Behavior
</A></li>
        <LI>Next message (by thread): <A HREF="022597.html">[squid-users] Strange Squid SSL Interception Behavior
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22589">[ date ]</a>
              <a href="thread.html#22589">[ thread ]</a>
              <a href="subject.html#22589">[ subject ]</a>
              <a href="author.html#22589">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 8/24/20 9:09 PM, Mathew Brown wrote:
&gt;<i> Thanks but even with the --no-check-certificate option and using a bump
</I>&gt;<i> instead of splicing, it still fails as shown above unless I add the
</I>&gt;<i> localnet rule. The question is: why does the same ACL line:
</I>
&gt;<i> http_access allow whitelist
</I>
&gt;<i> suddenly work when I add an unrelated ACL line after it?
</I>
You are misinterpreting the outcome of the test. That whitelist
http_access line did not work (well) for fake CONNECTs before and does
not start working (well) after another http_access rule is added. It is
the added rule that &quot;starts working&quot; instead!

Most ACL-driven directives, including http_access, cannot be correctly
interpreted at single-ACL, single-line, or single-rule scope. You must
consider _all_ rules for a given directive to correctly predict the
outcome of that directive evaluation. When you add a rule, the outcome
of the directive evaluation may change if the previous set of rules did
not match and the added rule does match. The latter is exactly what
happens in your &quot;add an unrelated ACL&quot; test case.

For completeness sake: When no http_access rules match, Squid applies
the action (allow or deny) that is the opposite of the last configured
http_access rule action. If no http_access rules were configured at all,
Squid denies.


There is similar (albeit a bit incomplete) information in the (arguably
misplaced) FAQ section at
<A HREF="https://wiki.squid-cache.org/SquidFaq/SquidAcl#Access_Lists">https://wiki.squid-cache.org/SquidFaq/SquidAcl#Access_Lists</A>


&gt;<i> From my understanding, Squid should perform the exact same steps in both
</I>&gt;<i> cases BUT then allow the connection because of the localnet ACL line
</I>&gt;<i> that it sees right before the deny all line, not because it suddenly was
</I>&gt;<i> able to match httpbin.org using a domain compare as shown by the debug
</I>&gt;<i> logs. What am I missing?
</I>
You may also be missing the fact that http_access directive is applied
several times for one wget execution, once at every SslBump step. The
information available to Squid at each SslBump step differs.
<A HREF="https://wiki.squid-cache.org/Features/SslPeekAndSplice">https://wiki.squid-cache.org/Features/SslPeekAndSplice</A>

Domain-based ACL matches you see in the second test log probably do not
exist in the first test because Squid does not get far enough during the
first test -- Squid denies the fake CONNECT (and bumps the connection)
at step1, when no domain information is available yet.


HTH,

Alex.


&gt;<i> ------------------------------------------------------------------------
</I>&gt;<i> *From:* Alex Rousskov &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt;
</I>&gt;<i> *Sent:* Tuesday, August 25, 2020 8:41 AM
</I>&gt;<i> *To:* Mathew Brown &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">mbrown8918 at outlook.com</A>&gt;;
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A> &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>&gt;
</I>&gt;<i> *Subject:* Re: [squid-users] Strange Squid SSL Interception Behavior
</I>&gt;<i> &#160;
</I>&gt;<i> On 8/24/20 6:21 PM, Mathew Brown wrote:
</I>&gt;<i> 
</I>&gt;&gt;<i> acl whitelist ssl::server_name .httpbin.org
</I>&gt;&gt;<i> acl whitelist_http ssl::server_name .httpbin.org
</I>&gt;<i> 
</I>&gt;&gt;<i> ssl_bump peek step1
</I>&gt;&gt;<i> ssl_bump splice all
</I>&gt;<i> 
</I>&gt;&gt;<i> http_access allow whitelist
</I>&gt;&gt;<i> http_access allow whitelist_http
</I>&gt;&gt;<i> http_access deny all
</I>&gt;<i> 
</I>&gt;<i> The rules above only allow CONNECT requests to .httpbin.org domains.
</I>&gt;<i> 
</I>&gt;<i> During step1, when Squid intercepts a TLS connection to an IP address of
</I>&gt;<i> an .httpbin.org domain, Squid http_access rules are applied to a (fake)
</I>&gt;<i> CONNECT request to the destination IP address. There are no domain names
</I>&gt;<i> at that TCP-level bumping stage. Thus, you place your Squid at the mercy
</I>&gt;<i> of reverse DSN lookups.
</I>&gt;<i> 
</I>&gt;<i> In my environment, reverse DNS does not work for httpbin.org the way you
</I>&gt;<i> may expect:
</I>&gt;<i> 
</I>&gt;&gt;<i> $ host 54.236.246.173
</I>&gt;&gt;<i> 173.246.236.54.in-addr.arpa domain name pointer ec2-54-236-246-173.compute-1.amazonaws.com.
</I>&gt;<i> 
</I>&gt;<i> The above AWS domain name does not match your whitelist ACLs, of course,
</I>&gt;<i> and, hence, the fake CONNECT request is denied. Denied requests are
</I>&gt;<i> bumped to deliver the error message. Bumped requests require
</I>&gt;<i> --no-check-certificate or other means of trusting Squid's CA certificate.
</I>&gt;<i> 
</I>&gt;<i> If you cannot explicitly allow CONNECT requests to httpbin.org IP
</I>&gt;<i> addresses (e.g., because they change too often), then consider allowing
</I>&gt;<i> CONNECT to safe ports at any address at step1. If you only intercept
</I>&gt;<i> connections to httpbin.org IPs, then you can probably relax your step1
</I>&gt;<i> http_access rules to allow all CONNECTs (to safe addresses).
</I>&gt;<i> 
</I>&gt;<i> There are many similar questions about allowing CONNECT to IP addresses
</I>&gt;<i> on this mailing list. You may be able to find more detailed advice or
</I>&gt;<i> instructions by searching for those mailing list threads.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> HTH,
</I>&gt;<i> 
</I>&gt;<i> Alex.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> $ wget <A HREF="https://httpbin.org">https://httpbin.org</A>
</I>&gt;&gt;<i> --2020-08-24 17:48:34-- &#160;<A HREF="https://httpbin.org/">https://httpbin.org/</A>
</I>&gt;&gt;<i> Resolving httpbin.org (httpbin.org)... 54.236.246.173, 3.220.112.94
</I>&gt;&gt;<i> Connecting to httpbin.org (httpbin.org)|54.236.246.173|:443... connected.
</I>&gt;&gt;<i> ERROR: cannot verify httpbin.org's certificate, issued by &#8216;O=Internet
</I>&gt;&gt;<i> Widgits Pty Ltd,ST=Some-State,C=AU&#8217;:
</I>&gt;&gt;<i> &#160; Self-signed certificate encountered.
</I>&gt;&gt;<i> To connect to httpbin.org insecurely, use `--no-check-certificate'.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> $ wget <A HREF="https://httpbin.org">https://httpbin.org</A> --no-check-certificate
</I>&gt;&gt;<i> --2020-08-24 17:48:40-- &#160;<A HREF="https://httpbin.org/">https://httpbin.org/</A>
</I>&gt;&gt;<i> Resolving httpbin.org (httpbin.org)... 3.220.112.94, 54.236.246.173
</I>&gt;&gt;<i> Connecting to httpbin.org (httpbin.org)|3.220.112.94|:443... connected.
</I>&gt;&gt;<i> WARNING: cannot verify httpbin.org's certificate, issued by &#8216;O=Internet
</I>&gt;&gt;<i> Widgits Pty Ltd,ST=Some-State,C=AU&#8217;:
</I>&gt;&gt;<i> &#160; Self-signed certificate encountered.
</I>&gt;&gt;<i> HTTP request sent, awaiting response... 403 Forbidden
</I>&gt;&gt;<i> 2020-08-24 17:48:40 ERROR 403: Forbidden.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> looking at access.log shows:
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> 1598305800.974 &#160; &#160; &#160;2 192.168.123.214 TCP_DENIED/200 0 CONNECT
</I>&gt;&gt;<i> 54.236.246.173:443 - HIER_NONE/- -
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> for the first request (without the --no-check-certificate) and the
</I>&gt;&gt;<i> following for the 2nd request (with the --no-check-certificate):
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> 1598305812.292 &#160; &#160; &#160;3 192.168.123.214 TCP_DENIED/200 0 CONNECT
</I>&gt;&gt;<i> 54.236.246.173:443 - HIER_NONE/- -
</I>&gt;&gt;<i> 1598305812.300 &#160; &#160; &#160;2 192.168.123.214 NONE/403 3795 GET
</I>&gt;&gt;<i> <A HREF="https://httpbin.org/">https://httpbin.org/</A> - HIER_NONE/- text/html
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> looking at cache.log shows:
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> # cat /var/log/squid/cache.log &#160;| grep -i &quot;28&quot; | grep -i httpbin
</I>&gt;&gt;<i> 2020/08/24 17:50:00.972 kid1| 28,7| ServerName.cc(32)
</I>&gt;&gt;<i> aclHostDomainCompare: Match:54.236.246.173 &lt;&gt; &#160;.httpbin.org
</I>&gt;&gt;<i> 2020/08/24 17:50:00.972 kid1| 28,7| ServerName.cc(32)
</I>&gt;&gt;<i> aclHostDomainCompare: Match:54.236.246.173 &lt;&gt; &#160;.httpbin.org
</I>&gt;&gt;<i> 2020/08/24 17:50:12.290 kid1| 28,7| ServerName.cc(32)
</I>&gt;&gt;<i> aclHostDomainCompare: Match:54.236.246.173 &lt;&gt; &#160;.httpbin.org
</I>&gt;&gt;<i> 2020/08/24 17:50:12.290 kid1| 28,7| ServerName.cc(32)
</I>&gt;&gt;<i> aclHostDomainCompare: Match:54.236.246.173 &lt;&gt; &#160;.httpbin.org
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> so it never matches on the httpbin.org
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> now, if I add the following line to my configuration:
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> http_access allow localnet
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> right before the:
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> http_access deny all
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> line it works and I see the following in access.log:
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> 1598305979.004 &#160; &#160; &#160;4 192.168.123.214 NONE/200 0 CONNECT
</I>&gt;&gt;<i> 54.236.246.173:443 - HIER_NONE/- -
</I>&gt;&gt;<i> 1598305980.016 &#160; 1012 192.168.123.214 TCP_TUNNEL/200 15370 CONNECT
</I>&gt;&gt;<i> httpbin.org:443 - ORIGINAL_DST/54.236.246.173 -
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> and I see the following in cache.log:
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> # cat /var/log/squid/cache.log &#160;| grep -i &quot;28&quot; | grep -i httpbin
</I>&gt;&gt;<i> 2020/08/24 17:52:59.000 kid1| 28,7| ServerName.cc(32)
</I>&gt;&gt;<i> aclHostDomainCompare: Match:54.236.246.173 &lt;&gt; &#160;.httpbin.org
</I>&gt;&gt;<i> 2020/08/24 17:52:59.000 kid1| 28,7| ServerName.cc(32)
</I>&gt;&gt;<i> aclHostDomainCompare: Match:54.236.246.173 &lt;&gt; &#160;.httpbin.org
</I>&gt;&gt;<i> 2020/08/24 17:52:59.005 kid1| 28,3| RegexData.cc(43) match: checking
</I>&gt;&gt;<i> 'httpbin.org:443'
</I>&gt;&gt;<i> 2020/08/24 17:52:59.005 kid1| 28,3| ServerName.cc(42) match: checking
</I>&gt;&gt;<i> 'httpbin.org'
</I>&gt;&gt;<i> 2020/08/24 17:52:59.005 kid1| 28,7| ServerName.cc(32)
</I>&gt;&gt;<i> aclHostDomainCompare: Match:httpbin.org &lt;&gt; &#160;.httpbin.org
</I>&gt;&gt;<i> 2020/08/24 17:52:59.005 kid1| 28,3| ServerName.cc(47) match:
</I>&gt;&gt;<i> 'httpbin.org' found
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> What's puzzling is why adding the 'allow localnet' line changes the ACL
</I>&gt;&gt;<i> logic for .httpbin.org and why the original configuration does not work.
</I>&gt;&gt;<i> Any ideas? Thanks
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> PS. I reproduced the exact same scenario on Ubuntu 20.04 with Squid 4.12
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;<i> squid-users mailing list
</I>&gt;&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;&gt;<i> 
</I>&gt;<i> 
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="022585.html">[squid-users] Strange Squid SSL Interception Behavior
</A></li>
	<LI>Next message (by thread): <A HREF="022597.html">[squid-users] Strange Squid SSL Interception Behavior
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22589">[ date ]</a>
              <a href="thread.html#22589">[ thread ]</a>
              <a href="subject.html#22589">[ subject ]</a>
              <a href="author.html#22589">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
