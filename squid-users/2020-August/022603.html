<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid Explicit Proxying
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20Explicit%20Proxying&In-Reply-To=%3C36411430-be53-334a-9ea0-7110adc8953e%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="022588.html">
   <LINK REL="Next"  HREF="022604.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid Explicit Proxying</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20Explicit%20Proxying&In-Reply-To=%3C36411430-be53-334a-9ea0-7110adc8953e%40treenet.co.nz%3E"
       TITLE="[squid-users] Squid Explicit Proxying">squid3 at treenet.co.nz
       </A><BR>
    <I>Wed Aug 26 05:36:44 UTC 2020</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="022588.html">[squid-users] Squid Explicit Proxying
</A></li>
        <LI>Next message (by thread): <A HREF="022604.html">[squid-users] Squid Explicit Proxying
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22603">[ date ]</a>
              <a href="thread.html#22603">[ thread ]</a>
              <a href="subject.html#22603">[ subject ]</a>
              <a href="author.html#22603">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 25/08/20 10:35 pm, Eric F. wrote:
&gt;<i> Hi,
</I>&gt;<i> 
</I>&gt;<i> I use OpenBSD 6.7 with Squid 4.12.
</I>&gt;<i> I want to filter http and https website, so i'm trying to use SSL bumping.
</I>&gt;<i> But unfortunately, my configuration doesn't work. I explain what i did:
</I>&gt;<i> 
</I>&gt;<i> The host is named : proxy.lab.local
</I>&gt;<i> 
</I>&gt;<i> I generated the certificate like that:
</I>&gt;<i> 
</I>&gt;<i> cd /etc/squid
</I>&gt;<i> openssl req -new -newkey rsa:4096 -sha256 -days 365 -nodes -x509 -keyout
</I>&gt;<i> squid.pem -out squid.pem
</I>
This creates keys. The public cert still needs to be signed. Though curl
below indicates a self-signed cert is present in the chain it gets from
Squid.
 That is a bit odd.


&gt;<i> openssl x509 -in /etc/squid/squid.pem -outform DER -out
</I>&gt;<i> /etc/squid/browser.der
</I>
This should be done after signing. Whether you do self-signed or not
export the DER from the same file you put in the --CA parameter for the
signing process.


&gt;<i> chown _squid:_squid *.pem
</I>&gt;<i> 
</I>&gt;<i> run squid with squid -z &amp;&amp; rcctl start squid
</I>&gt;<i> 
</I>&gt;<i> no errors.
</I>&gt;<i> 
</I>&gt;<i> I installed the browser.der on my Windows 10 laptop (added the proxy),
</I>&gt;<i> therefore i can't access any webpage.
</I>
Er. You should still be able to access web pages. The traffic should
just be going via Squid if you &quot;added the proxy&quot; right.


&gt;<i> 
</I>&gt;<i> I tried on the squid server the following tests (curl)
</I>&gt;<i> 
</I>&gt;<i> proxy# curl --proxy <A HREF="http://127.0.0.1:3128">http://127.0.0.1:3128</A> <A HREF="https://www.google.com">https://www.google.com</A>
</I>&gt;<i> curl: (60) SSL certificate problem: self signed certificate in
</I>&gt;<i> certificate chain
</I>&gt;<i> More details here: <A HREF="https://curl.haxx.se/docs/sslcerts.html">https://curl.haxx.se/docs/sslcerts.html</A>
</I>

curl on the proxy machine does not know about browser.der on the Windows
machines. This is expected result.


&gt;<i> 
</I>&gt;<i> curl failed to verify the legitimacy of the server and therefore could not
</I>&gt;<i> establish a secure connection to it. To learn more about this situation and
</I>&gt;<i> how to fix it, please visit the web page mentioned above.
</I>&gt;<i> 
</I>&gt;<i> proxy# curl --proxy <A HREF="http://127.0.0.1:3128">http://127.0.0.1:3128</A> --cacert /etc/squid/squid.pem
</I>&gt;<i> -l <A HREF="https://www.google.com">https://www.google.com</A>
</I>&gt;<i> curl: (35) error:1401E410:SSL routines:CONNECT_CR_FINISHED:sslv3 alert
</I>&gt;<i> handshake failure
</I>&gt;<i> 
</I>
The -l indicates an email or FTP server being connected to. Otherwise
this command looks correct.

I start by looking up the OpenSSL error message. Unfortunately that one
produces no search results for me. You might have better luck. In
absence of any useful info about what the error means next thing is to
get the verbose output from curl to see what is going on.
 And check the Squid cache.log with &quot;debug_options ALL,5&quot; to see what
Squid is doing at its end.

 If that does not provide more useful clues then TCP level packet trace
in wireshark as a last resort.



&gt;<i> Can you help me to troubleshoot this issue ?
</I>&gt;<i> 
</I>&gt;<i> Thank you very much.
</I>&gt;<i> 
</I>&gt;<i> Below my configuration :
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> proxy# squid -v
</I>&gt;<i> Squid Cache: Version 4.12
</I>&gt;<i> Service Name: squid
</I>&gt;<i> 
</I>&gt;<i> This binary uses LibreSSL 3.1.1. For legal restrictions on distribution
</I>&gt;<i> see <A HREF="https://www.openssl.org/source/license.html">https://www.openssl.org/source/license.html</A>
</I>&gt;<i> 
</I>
FYI, LibreSSL is not formally supported due to the number of behavioural
differences it now has with OpenSSL. SSL-Bump is a mix of custom Squid
code and relatively low-level calls into OpenSSL. While LibreSSL usually
builds, we cannot guarantee those low-level calls do what SSL-Bump expects.


...
&gt;<i> 
</I>&gt;<i> acl bad_urls urlpath_regex -i &quot;/etc/squid/bad_urls&quot;
</I>&gt;<i> acl bad_domains dstdomain &quot;/etc/squid/bad_domains&quot;
</I>&gt;<i> 
</I>&gt;<i> http_access deny bad_urls
</I>&gt;<i> http_access deny bad_domains
</I>&gt;<i> 
</I>&gt;<i> #
</I>&gt;<i> # INSERT YOUR OWN RULE(S) HERE TO ALLOW ACCESS FROM YOUR CLIENTS
</I>&gt;<i> #
</I>&gt;<i> 
</I>
Nit: that line means all the bad_* checks should be down here.


&gt;<i> # Example rule allowing access from your local networks.
</I>&gt;<i> # Adapt localnet in the ACL section to list your (internal) IP networks
</I>&gt;<i> # from where browsing should be allowed
</I>&gt;<i> http_access allow localnet
</I>&gt;<i> http_access allow localhost
</I>&gt;<i> 
</I>&gt;<i> # And finally deny all other access to this proxy
</I>&gt;<i> http_access deny all
</I>&gt;<i> 
</I>&gt;<i> # Squid normally listens to port 3128
</I>&gt;<i> http_port 3128 ssl-bump \
</I>&gt;<i> &#160; cert=/etc/squid/squid.pem \
</I>
Nit: the option is now named tls-cert=


&gt;<i> &#160; generate-host-certificates=on dynamic_cert_mem_cache_size=8MB
</I>&gt;<i> 
</I>&gt;<i> sslcrtd_program /usr/local/libexec/squid/security_file_certgen -s
</I>&gt;<i> /var/squid/ssl_db -M 8MB
</I>&gt;<i> 
</I>&gt;<i> acl step1 at_step SslBump1
</I>&gt;<i> ssl_bump peek step1
</I>&gt;<i> ssl_bump bump all
</I>

This makes SSL-Bump generate the certificates without any details from
the actual server. You can expect a lot of issues with TLS features that
need end-to-end negotiation (eg TLS/1.3 connections).

To work around that:

  acl step1 at_step SslBump1
  ssl_bump peek step1

  acl step2 at_step SslBump2
  ssl_bump stare step2

  ssl_bump bump all


&gt;<i> sslcrtd_children 5
</I>&gt;<i> sslproxy_cert_sign signTrusted
</I>&gt;<i> 
</I>

HTH
Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="022588.html">[squid-users] Squid Explicit Proxying
</A></li>
	<LI>Next message (by thread): <A HREF="022604.html">[squid-users] Squid Explicit Proxying
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22603">[ date ]</a>
              <a href="thread.html#22603">[ thread ]</a>
              <a href="subject.html#22603">[ subject ]</a>
              <a href="author.html#22603">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
