<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] IPVS/LVS load balancing Squid servers, anyone did it?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20IPVS/LVS%20load%20balancing%20Squid%20servers%2C%0A%20anyone%20did%20it%3F&In-Reply-To=%3CCAHaxnUJTYRs2y8g0LWJQfG_p0VVGW04vJk%2Brf8mqytUfWv79Yw%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="022612.html">
   <LINK REL="Next"  HREF="022619.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] IPVS/LVS load balancing Squid servers, anyone did it?</H1>
    <B>Bruce Rosenberg</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20IPVS/LVS%20load%20balancing%20Squid%20servers%2C%0A%20anyone%20did%20it%3F&In-Reply-To=%3CCAHaxnUJTYRs2y8g0LWJQfG_p0VVGW04vJk%2Brf8mqytUfWv79Yw%40mail.gmail.com%3E"
       TITLE="[squid-users] IPVS/LVS load balancing Squid servers, anyone did it?">bruce.rosenberg.au at gmail.com
       </A><BR>
    <I>Thu Aug 27 04:35:24 UTC 2020</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="022612.html">[squid-users] IPVS/LVS load balancing Squid servers, anyone did it?
</A></li>
        <LI>Next message (by thread): <A HREF="022619.html">[squid-users] IPVS/LVS load balancing Squid servers, anyone did it?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22617">[ date ]</a>
              <a href="thread.html#22617">[ thread ]</a>
              <a href="subject.html#22617">[ subject ]</a>
              <a href="author.html#22617">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Eliezer,

We are running a couple of Squid proxies (the real servers) in front of a
pair of LVS servers with keepalived and it works flawlessly.
The 2 x Squid proxies are active / active and the LVS servers are active /
passive.
If a Squid proxy dies the remaining proxy takes all the traffic.
If the active LVS server dies, keepalived running on the backup LVS (via
VRRP) moves the VIP to itself and it takes all the traffic, so the only
difference between the two is one has a higher priority so it gets the VIP
first.
I have included some sanitised snippets from a keepalived.conf file that
should help you.
You could easily scale this out if you need more than 2 Squid proxies.

The config I provided is for LVS/DR (Direct Route) mode.
This method rewrites the MAC address of forwarded packets to that of one of
the real servers and is the most scalable way to run LVS.
It does require the LVS and real servers be on the same L2 network.
If that is not possible then consider LVS/TUN mode or LVS/NAT mode.

As LVS/DR rewrites the MAC address, it requires each real server to have
the VIP address plumbed on an interface and also requires the real
servers to ignore ARP requests for the VIP address as the only device that
should respond to ARP requests for the VIP is the active LVS server.
We do this by configuring the VIP on the loopback interface on each real
but there are other methods as well such as dropping the ARP responses
using arptables, iptables or firewalld.
I think back in the kernel 2.4 and 2.6 days people used the noarp kernel
module which could be configured to ignore ARP requests for a particular IP
address but you don't really need this anymore.

More info on the loopback arp blocking method -
<A HREF="https://www.loadbalancer.org/blog/layer-4-direct-routing-lvs-dr-and-layer-4-tun-lvs-tun-in-aws/">https://www.loadbalancer.org/blog/layer-4-direct-routing-lvs-dr-and-layer-4-tun-lvs-tun-in-aws/</A>
More info on firewall type arp blocking methods -
<A HREF="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/load_balancer_administration/s1-lvs-direct-vsa">https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/load_balancer_administration/s1-lvs-direct-vsa</A>
More info about LVS/DR - <A HREF="http://kb.linuxvirtualserver.org/wiki/LVS/DR">http://kb.linuxvirtualserver.org/wiki/LVS/DR</A>

If you are using a RPM based distro then to set up the LVS servers you only
need the ipvsadm and keepalived packages.
Install squid on the reals and configure the VIP on each and disable ARP.
Then build the keepalived.conf on both LVS servers and restart keepalived.

The priority configuration stanza in the vrrp_instance section determines
the primary VRRP node (LVS server) for that virtual router instance.
The secondary LVS server needs a lower priority compared to the primary.
You can configure one as the MASTER and the other as the BACKUP but our
guys make them both BACKUP and let the priority sort the election of the
primary out.
I think this might be to solve a problem of bringing up a BACKUP without a
MASTER but I can't confirm that.


Good luck.


$ cat /etc/keepalived/keepalived.conf

global_defs {

    notification_email {
        # <A HREF="https://lists.squid-cache.org/listinfo/squid-users">rootmail at example.com</A>
    }
    notification_email_from <A HREF="https://lists.squid-cache.org/listinfo/squid-users">keepalive-daemon at lvs01.example.com</A>
    smtp_server 10.1.2.3        # mail.example.com
    smtp_connect_timeout 30
    lvs_id lvs01.example.com    # Name to mention in email.
}

vrrp_instance LVS_example {

    state BACKUP
    priority 150
    interface eth0
    lvs_sync_daemon_interface eth0
    virtual_router_id 5
    preempt_delay 20

    virtual_ipaddress_excluded {

        10.10.10.10   # Squid proxy
    }

    notify_master &quot;some command to log or send an alert&quot;
    notify_backup &quot;some command to log or send an alert&quot;
    notify_fault &quot;some command to log or send an alert&quot;
}


# SQUID Proxy
virtual_server 10.10.10.10 3128 {

    delay_loop 5
    lb_algo wrr
    lb_kind DR
    protocol TCP

    real_server 10.10.10.11 3128 {   # proxy01.example.com
        weight 1
        inhibit_on_failure 1
        TCP_CHECK {
            connect_port 3128
            connect_timeout 5
        }
    }

    real_server 10.10.10.12 3128 {   # proxy02.example.com
        weight 1
        inhibit_on_failure 1
        TCP_CHECK {
            connect_port 3128
            connect_timeout 5
        }
    }
}


On Thu, Aug 27, 2020 at 8:24 AM Eliezer Croitor &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">ngtech1ltd at gmail.com</A>&gt;
wrote:

&gt;<i> Hey All,
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> I am reading about LB and tried to find an up-to-date example or tutorial
</I>&gt;<i> specific to squid with no luck.
</I>&gt;<i>
</I>&gt;<i> I have seen:
</I>&gt;<i> <A HREF="http://kb.linuxvirtualserver.org/wiki/Building_Web_Cache_Cluster_using_LVS">http://kb.linuxvirtualserver.org/wiki/Building_Web_Cache_Cluster_using_LVS</A>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Which makes sense and also is similar or kind of identical to WCCP with
</I>&gt;<i> gre.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Anyone knows about a working Squid setup with IPVS/LVS?
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Thanks,
</I>&gt;<i>
</I>&gt;<i> Eliezer
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> ----
</I>&gt;<i>
</I>&gt;<i> Eliezer Croitoru
</I>&gt;<i>
</I>&gt;<i> Tech Support
</I>&gt;<i>
</I>&gt;<i> Mobile: +972-5-28704261
</I>&gt;<i>
</I>&gt;<i> Email: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">ngtech1ltd at gmail.com</A>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20200827/63096c7d/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20200827/63096c7d/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="022612.html">[squid-users] IPVS/LVS load balancing Squid servers, anyone did it?
</A></li>
	<LI>Next message (by thread): <A HREF="022619.html">[squid-users] IPVS/LVS load balancing Squid servers, anyone did it?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22617">[ date ]</a>
              <a href="thread.html#22617">[ thread ]</a>
              <a href="subject.html#22617">[ subject ]</a>
              <a href="author.html#22617">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
