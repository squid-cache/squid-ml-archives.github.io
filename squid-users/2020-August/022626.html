<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] IPVS/LVS load balancing Squid servers, anyone did it?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20IPVS/LVS%20load%20balancing%20Squid%20servers%2C%0A%20anyone%20did%20it%3F&In-Reply-To=%3C686fc730-10a6-0a54-8527-9e7b5b6a8f47%40thalesgroup.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="022625.html">
   <LINK REL="Next"  HREF="022624.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] IPVS/LVS load balancing Squid servers, anyone did it?</H1>
    <B>FUSTE Emmanuel</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20IPVS/LVS%20load%20balancing%20Squid%20servers%2C%0A%20anyone%20did%20it%3F&In-Reply-To=%3C686fc730-10a6-0a54-8527-9e7b5b6a8f47%40thalesgroup.com%3E"
       TITLE="[squid-users] IPVS/LVS load balancing Squid servers, anyone did it?">emmanuel.fuste at thalesgroup.com
       </A><BR>
    <I>Thu Aug 27 13:07:51 UTC 2020</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="022625.html">[squid-users] IPVS/LVS load balancing Squid servers, anyone did it?
</A></li>
        <LI>Next message (by thread): <A HREF="022624.html">[squid-users] IPVS/LVS load balancing Squid servers, anyone did it?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22626">[ date ]</a>
              <a href="thread.html#22626">[ thread ]</a>
              <a href="subject.html#22626">[ subject ]</a>
              <a href="author.html#22626">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Le 27/08/2020 &#224; 14:14, Eliezer Croitor a &#233;crit&#160;:
&gt;<i> Hey Emmanuel,
</I>&gt;<i>
</I>&gt;<i> I was just trying to understand if and how nftables is can LB and what exactly makes IPVS that fast.
</I>nftlb is simply a rulemanager in front of nftables. And IPVS is not as 
fast as nftables, it is the reverse.
All you could do with IPVS is normally do-able with nftable/nftlb and more.
&gt;<i> It seems that IPVS in DR actually converts the linux box into a Switch.
</I>Technically it is purely hw address mangling not full switching.
&gt;<i> I am still unsure if mac address replacement is better then FWMARK for DR.
</I>FWMARK is just for packet selection grouping for mac address 
replacement. It does not replace it.
And with the expressive capability of nftable this FWMARK dance is no 
longer necessary.

Emmanuel.
&gt;<i>
</I>&gt;<i> Thanks,
</I>&gt;<i> Eliezer
</I>&gt;<i>
</I>&gt;<i> ----
</I>&gt;<i> Eliezer Croitoru
</I>&gt;<i> Tech Support
</I>&gt;<i> Mobile: +972-5-28704261
</I>&gt;<i> Email: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">ngtech1ltd at gmail.com</A>
</I>&gt;<i>
</I>&gt;<i> -----Original Message-----
</I>&gt;<i> From: squid-users &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>&gt; On Behalf Of FUSTE Emmanuel
</I>&gt;<i> Sent: Thursday, August 27, 2020 2:23 PM
</I>&gt;<i> To: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> Subject: Re: [squid-users] IPVS/LVS load balancing Squid servers, anyone did it?
</I>&gt;<i>
</I>&gt;<i> Hi,
</I>&gt;<i>
</I>&gt;<i> To complement this, on modern kernel take the opportunity to try nftlb
</I>&gt;<i> instead of LVS too.
</I>&gt;<i> <A HREF="https://www.zevenet.com/knowledge-base/nftlb/what-is-nftlb/">https://www.zevenet.com/knowledge-base/nftlb/what-is-nftlb/</A>
</I>&gt;<i>
</I>&gt;<i> Emmanuel.
</I>&gt;<i>
</I>&gt;<i> Le 27/08/2020 &#224; 06:35, Bruce Rosenberg a &#233;crit :
</I>&gt;&gt;<i> Hi Eliezer,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> We are running a couple of Squid proxies (the real servers) in front
</I>&gt;&gt;<i> of a pair of LVS servers with keepalived and it works flawlessly.
</I>&gt;&gt;<i> The 2 x Squid proxies are active / active and the LVS servers are
</I>&gt;&gt;<i> active / passive.
</I>&gt;&gt;<i> If a Squid proxy dies the remaining proxy takes all the traffic.
</I>&gt;&gt;<i> If the active LVS server dies, keepalived running on the backup LVS
</I>&gt;&gt;<i> (via VRRP) moves the VIP to itself and it takes all the traffic, so
</I>&gt;&gt;<i> the only difference between the two is one has a higher priority so it
</I>&gt;&gt;<i> gets the VIP first.
</I>&gt;&gt;<i> I have included some sanitised snippets from a keepalived.conf file
</I>&gt;&gt;<i> that should help you.
</I>&gt;&gt;<i> You could easily scale this out if you need more than 2 Squid proxies.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The config I provided is for LVS/DR (Direct Route) mode.
</I>&gt;&gt;<i> This method rewrites the MAC address of forwarded packets to that of
</I>&gt;&gt;<i> one of the real servers and is the most scalable way to run LVS.
</I>&gt;&gt;<i> It does require the LVS and real servers be on the same L2 network.
</I>&gt;&gt;<i> If that is not possible then consider LVS/TUN mode or LVS/NAT mode.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> As LVS/DR rewrites the MAC address, it requires each real server to
</I>&gt;&gt;<i> have the VIP address plumbed on an interface and also requires the
</I>&gt;&gt;<i> real servers to ignore ARP requests for the VIP address as the only
</I>&gt;&gt;<i> device that should respond to ARP requests for the VIP is the active
</I>&gt;&gt;<i> LVS server.
</I>&gt;&gt;<i> We do this by configuring the VIP on the loopback interface on each
</I>&gt;&gt;<i> real but there are other methods as well such as dropping the ARP
</I>&gt;&gt;<i> responses using arptables, iptables or firewalld.
</I>&gt;&gt;<i> I think back in the kernel 2.4 and 2.6 days people used the noarp
</I>&gt;&gt;<i> kernel module which could be configured to ignore ARP requests for a
</I>&gt;&gt;<i> particular IP address but you don't really need this anymore.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> More info on the loopback arp blocking method -
</I>&gt;&gt;<i> <A HREF="https://www.loadbalancer.org/blog/layer-4-direct-routing-lvs-dr-and-layer-4-tun-lvs-tun-in-aws/">https://www.loadbalancer.org/blog/layer-4-direct-routing-lvs-dr-and-layer-4-tun-lvs-tun-in-aws/</A>
</I>&gt;&gt;<i> More info on firewall type arp blocking methods -
</I>&gt;&gt;<i> <A HREF="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/load_balancer_administration/s1-lvs-direct-vsa">https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/load_balancer_administration/s1-lvs-direct-vsa</A>
</I>&gt;&gt;<i> More info about LVS/DR - <A HREF="http://kb.linuxvirtualserver.org/wiki/LVS/DR">http://kb.linuxvirtualserver.org/wiki/LVS/DR</A>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> If you are using a RPM based distro then to set up the LVS servers you
</I>&gt;&gt;<i> only need the ipvsadm and keepalived packages.
</I>&gt;&gt;<i> Install squid on the reals and configure the VIP on each and disable ARP.
</I>&gt;&gt;<i> Then build the keepalived.conf on both LVS servers and restart keepalived.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The priority configuration stanza in the vrrp_instance section
</I>&gt;&gt;<i> determines the primary VRRP node (LVS server) for that virtual router
</I>&gt;&gt;<i> instance.
</I>&gt;&gt;<i> The secondary LVS server needs a lower priority compared to the primary.
</I>&gt;&gt;<i> You can configure one as the MASTER and the other as the BACKUP but
</I>&gt;&gt;<i> our guys make them both BACKUP and let the priority sort the election
</I>&gt;&gt;<i> of the primary out.
</I>&gt;&gt;<i> I think this might be to solve a problem of bringing up a BACKUP
</I>&gt;&gt;<i> without a MASTER but I can't confirm that.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Good luck.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> $ cat /etc/keepalived/keepalived.conf
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> global_defs {
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>      notification_email {
</I>&gt;&gt;<i>          # <A HREF="https://lists.squid-cache.org/listinfo/squid-users">rootmail at example.com</A> &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rootmail at example.com</A>&gt;
</I>&gt;&gt;<i>      }
</I>&gt;&gt;<i>      notification_email_from <A HREF="https://lists.squid-cache.org/listinfo/squid-users">keepalive-daemon at lvs01.example.com</A>
</I>&gt;&gt;<i> &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">keepalive-daemon at lvs01.example.com</A>&gt;
</I>&gt;&gt;<i>      smtp_server 10.1.2.3        # mail.example.com
</I>&gt;&gt;<i> &lt;<A HREF="http://mail.example.com">http://mail.example.com</A>&gt;
</I>&gt;&gt;<i>      smtp_connect_timeout 30
</I>&gt;&gt;<i>      lvs_id lvs01.example.com &lt;<A HREF="http://lvs01.example.com">http://lvs01.example.com</A>&gt;    # Name to
</I>&gt;&gt;<i> mention in email.
</I>&gt;&gt;<i> }
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> vrrp_instance LVS_example {
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>      state BACKUP
</I>&gt;&gt;<i>      priority 150
</I>&gt;&gt;<i>      interface eth0
</I>&gt;&gt;<i>      lvs_sync_daemon_interface eth0
</I>&gt;&gt;<i>      virtual_router_id 5
</I>&gt;&gt;<i>      preempt_delay 20
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>      virtual_ipaddress_excluded {
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>          10.10.10.10   # Squid proxy
</I>&gt;&gt;<i>      }
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>      notify_master &quot;some command to log or send an alert&quot;
</I>&gt;&gt;<i>      notify_backup &quot;some command to log or send an alert&quot;
</I>&gt;&gt;<i>      notify_fault &quot;some command to log or send an alert&quot;
</I>&gt;&gt;<i> }
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> # SQUID Proxy
</I>&gt;&gt;<i> virtual_server 10.10.10.10 3128 {
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>      delay_loop 5
</I>&gt;&gt;<i>      lb_algo wrr
</I>&gt;&gt;<i>      lb_kind DR
</I>&gt;&gt;<i>      protocol TCP
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>      real_server 10.10.10.11 3128 {   # proxy01.example.com
</I>&gt;&gt;<i> &lt;<A HREF="http://proxy01.example.com">http://proxy01.example.com</A>&gt;
</I>&gt;&gt;<i>          weight 1
</I>&gt;&gt;<i>          inhibit_on_failure 1
</I>&gt;&gt;<i>          TCP_CHECK {
</I>&gt;&gt;<i>              connect_port 3128
</I>&gt;&gt;<i>              connect_timeout 5
</I>&gt;&gt;<i>          }
</I>&gt;&gt;<i>      }
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>      real_server 10.10.10.12 3128 {   # proxy02.example.com
</I>&gt;&gt;<i> &lt;<A HREF="http://proxy02.example.com">http://proxy02.example.com</A>&gt;
</I>&gt;&gt;<i>          weight 1
</I>&gt;&gt;<i>          inhibit_on_failure 1
</I>&gt;&gt;<i>          TCP_CHECK {
</I>&gt;&gt;<i>              connect_port 3128
</I>&gt;&gt;<i>              connect_timeout 5
</I>&gt;&gt;<i>          }
</I>&gt;&gt;<i>      }
</I>&gt;&gt;<i> }
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> On Thu, Aug 27, 2020 at 8:24 AM Eliezer Croitor &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">ngtech1ltd at gmail.com</A>
</I>&gt;&gt;<i> &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">ngtech1ltd at gmail.com</A>&gt;&gt; wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>      Hey All,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>      I am reading about LB and tried to find an up-to-date example or
</I>&gt;&gt;<i>      tutorial specific to squid with no luck.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>      I have seen:
</I>&gt;&gt;<i>      <A HREF="http://kb.linuxvirtualserver.org/wiki/Building_Web_Cache_Cluster_using_LVS">http://kb.linuxvirtualserver.org/wiki/Building_Web_Cache_Cluster_using_LVS</A>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>      Which makes sense and also is similar or kind of identical to WCCP
</I>&gt;&gt;<i>      with gre.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>      Anyone knows about a working Squid setup with IPVS/LVS?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>      Thanks,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>      Eliezer
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>      ----
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>      Eliezer Croitoru
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>      Tech Support
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>      Mobile: +972-5-28704261
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>      Email: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">ngtech1ltd at gmail.com</A> &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">ngtech1ltd at gmail.com</A>&gt;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>      _______________________________________________
</I>&gt;&gt;<i>
</I></PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="022625.html">[squid-users] IPVS/LVS load balancing Squid servers, anyone did it?
</A></li>
	<LI>Next message (by thread): <A HREF="022624.html">[squid-users] IPVS/LVS load balancing Squid servers, anyone did it?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22626">[ date ]</a>
              <a href="thread.html#22626">[ thread ]</a>
              <a href="subject.html#22626">[ subject ]</a>
              <a href="author.html#22626">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
