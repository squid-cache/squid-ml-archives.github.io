<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] ACL-by time- not working. Help!
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20ACL-by%20time-%20not%20working.%20Help%21&In-Reply-To=%3C713c45c9-ba43-28d2-f017-7ff1583d2670%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="022627.html">
   <LINK REL="Next"  HREF="022643.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] ACL-by time- not working. Help!</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20ACL-by%20time-%20not%20working.%20Help%21&In-Reply-To=%3C713c45c9-ba43-28d2-f017-7ff1583d2670%40treenet.co.nz%3E"
       TITLE="[squid-users] ACL-by time- not working. Help!">squid3 at treenet.co.nz
       </A><BR>
    <I>Fri Aug 28 03:57:41 UTC 2020</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="022627.html">[squid-users] ACL-by time- not working. Help!
</A></li>
        <LI>Next message (by thread): <A HREF="022643.html">[squid-users] ACL-by time- not working. Help!
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22629">[ date ]</a>
              <a href="thread.html#22629">[ thread ]</a>
              <a href="subject.html#22629">[ subject ]</a>
              <a href="author.html#22629">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 28/08/20 3:40 am, Luis Mario Niedas Hern&#225;ndez wrote:
&gt;<i> Hello. I need restrict some site by time, but i am not doing well.
</I>&gt;<i> This is my squid.conf. Please help me to fix the problem. I don't know
</I>&gt;<i> why it is not working.
</I>&gt;<i> 
</I>
It is not clear what your problem actually is.

An educated guess tells me that you have missed two important details:

 1) your http_access lines are just a long list of allow, allow, allow.
Squid has no reason to deny.

To resolve this you need to write out your policy(s) in the form of
denials. Allowing only the good traffic that remains.

For best performance sort the lines by ACL checking speed and how much
traffic they can drop. The faster it can identify and deny bad traffic
the more speed can go towards the good traffic.


 2) those FB and YT websites use HTTPS and http_access controls only
apply when an HTTPS connection is established. The TLS connection itself
may remain open and continue to be used indefinitely.

You can use the client_lifetime directive to shorten the time CONNECT
tunnels are allowed to remain in use. For your specific case I would set
it to something like 5 minutes. Browsers can auto-recover so this length
should not be visible to clients, but you will want to test that to
confirm what is good for your needs.


There are several other things about your config file that indicate
extremely outdated practices or Squid version. Below is a free audit
report of things that need fixing.


If you are running a Squid older than 3.5 please update ASAP. Then apply
the changes below.

If you are running a Squid v3.5 or newer then you can fix these issues
now with just a check to confirm the change is okay.


&gt;<i> 
</I>&gt;<i> ### autenticacion de los usuarios (http
</I>&gt;<i> b&#225;sica)############################################
</I>&gt;<i> auth_param basic program /usr/lib/squid/basic_ncsa_auth /etc/squid/usuarios_inet
</I>&gt;<i> auth_param basic realm Introduzca su usuario para navegar por la WEB.
</I>&gt;<i> 
</I>&gt;<i> ### por donde responde el squid ###
</I>&gt;<i> ####################################################
</I>&gt;<i> 
</I>&gt;<i> http_port 192.168.1.3:3128
</I>&gt;<i> http_port 127.0.0.1:3128
</I>
Are there other IPs assigned to the machine Squid is running on which
you definitely don't want offering proxy service?

If no, then you can replace both those with this line:
  http_port 3128

If yes, then you should replace just the second one with:
  http_port localhost:3128


&gt;<i> 
</I>&gt;<i> ########## ACL ###########################################################################
</I>&gt;<i> #
</I>&gt;<i> # Recommended minimum configuration:
</I>&gt;<i> 
</I>
You are missing the very critical port safety checks. These are to
prevent your proxy being DoS'ed or uses as an attack vector against
other software in your LAN.

At worst, you may need to &quot;open&quot; some specific ports by adding them to
the Safe_ports and/or SSL_ports ACL definitions. But generally this is
not necessary, and should only be done after investigating carefully
what that port is used for, including things *other* than the reason you
are asked to open it.


&gt;<i> acl all src all
</I>
Since Squid-3.1 the &quot;all &quot;ACL has been built into Squid. You can remove
this line, it does nothing.


&gt;<i> acl localhost src 127.0.0.1/32
</I>
On all modern machines localhost include the ::1/128 address. Even when
the machine is IPv4-only connectivity to the network. Localhost is about
connections within the machine itself and IPv4-only OS no longer exist.


&gt;<i> acl localnet src 192.168.1.0/24
</I>
No LAN IPv6 ranges? that is something everyone should be planning for a
decade ago.


&gt;<i> acl manager_proto_cache proto cache_object
</I>
Since Squid-3.2 the &quot;manager&quot; ACL has been built into Squid. There are
feature changes to the management URLs that need to be controlled by it
and the built-in definition handles those.

Please remove the above ACL line and convert anything that used it to
use the ACL named &quot;manager&quot; instead.


&gt;<i> acl peticion_identificacion proxy_auth REQUIRED
</I>&gt;<i> acl intranet dstdomain intra.xzy
</I>&gt;<i> 
</I>&gt;<i> acl ocio dstdomain  .facebook.com .youtube.com
</I>&gt;<i> 
</I>&gt;<i> acl ocio_medio_dia time MTWHF 12:00-13:10
</I>&gt;<i> acl ocio_tarde time MTWHF 14:00-14:30
</I>&gt;<i> acl ocio_mannana time MTWHF 6:00-8:30
</I>&gt;<i> 
</I>&gt;<i> http_access allow localnet manager_proto_cache
</I>&gt;<i> http_access allow localhost manager_proto_cache
</I>&gt;<i> http_access deny manager_proto_cache
</I>
&gt;<i> http_access allow ocio ocio_tarde
</I>&gt;<i> http_access allow ocio ocio_medio_dia
</I>&gt;<i> http_access allow ocio ocio_mannana
</I>
Do you really want your proxy to be allowing anyone anywhere in the
world to access those websites through your proxy?

I think these &quot;ocio&quot; lines should look like:

  http_access deny ocio !ocio_tarde !ocio_medio_dia !ocio_mannana

Or, you can combine the time periods into one ACL check for better speed
and understanding:

  acl ocio_tempo time MTWHF 12:00-13:10
  acl ocio_tempo time MTWHF 14:00-14:30
  acl ocio_tempo time MTWHF 6:00-8:30

  http_access deny ocio !ocio_tempo


&gt;<i> 
</I>&gt;<i> http_access allow intranet
</I>
I am guessing here. But I think this means you do not want to require
login to access the intranet website.


&gt;<i> http_access allow localnet peticion_identificacion
</I>
For more reliable authentication this should be:

  http_access deny !peticion_identificacion
  http_access allow localnet

Or, assuming the above about intranet:

  http_access deny !intranet !peticion_identificacion
  http_access allow localnet

&gt;<i> 
</I>&gt;<i> always_direct allow intranet
</I>&gt;<i> http_access deny all
</I>&gt;<i> never_direct allow all
</I>&gt;<i> 
</I>
In summary, I think this access control section should look like the
below lines:

  acl SSL_ports port 443

  acl Safe_ports port 80		# http
  acl Safe_ports port 21		# ftp
  acl Safe_ports port 443		# https
  acl Safe_ports port 70		# gopher
  acl Safe_ports port 210		# wais
  acl Safe_ports port 1025-65535	# unregistered ports
  acl Safe_ports port 280		# http-mgmt
  acl Safe_ports port 488		# gss-http
  acl Safe_ports port 591		# filemaker
  acl Safe_ports port 777		# multiling http

  acl localhost src 127.0.0.1/32 ::1/128
  acl localnet src 192.168.1.0/24

  acl peticion_identificacion proxy_auth REQUIRED
  acl intranet dstdomain intra.xzy

  acl ocio dstdomain  .facebook.com .youtube.com

  acl ocio_tempo time MTWHF 12:00-13:10
  acl ocio_tempo time MTWHF 14:00-14:30
  acl ocio_tempo time MTWHF 6:00-8:30

  http_access deny !Safe_ports
  http_access deny CONNECT !SSL_ports
  http_access deny manager !localnet !localhost

  # Prevent occio domains outside permitted times
  http_access deny ocio !ocio_tempo

  # Login required unless visiting intranet site(s)
  http_access deny !intranet !peticion_identificacion

  http_access allow localnet

  http_access deny all

  always_direct allow intranet
  never_direct allow all


&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> ####### cahce padre #################################################
</I>&gt;<i> 
</I>&gt;<i> cache_peer proxy_padre parent 3128 0  proxy-only
</I>&gt;<i> #cache_peer_domain  proxy_padre !intra.xzy
</I>

NP: if you want to restore that !intra.xyz behaviour with modern Squid
use this:

 cache_peer_access proxy_padre allow !intranet


&gt;<i> 
</I>&gt;<i> ##### correo cache manager ####
</I>&gt;<i> 
</I>&gt;<i> cache_mgr lmniedas
</I>
This should be an admin contact email. The documentation is not very
clear, sorry about that. It will receive reports about proxy crashes (if
the feature is built) and is displayed on error pages as the address to
contact about problems using the proxy.

For Example;

 cachemgr  <A HREF="https://lists.squid-cache.org/listinfo/squid-users">lmniedas at example.local</A>

or the prettier version:

 cache_mgr Luis Mario Niedas Hern&#225;ndez &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">lmniedas at example.local</A>&gt;


&gt;<i> cachemgr_passwd ***
</I>
I hope that was not your actual password. If it was you now need to
change it.


&gt;<i> #### tamanno de la cache ####################################
</I>&gt;<i> 
</I>&gt;<i> cache_dir aufs /var/spool/squid 20280 16 256
</I>&gt;<i> 
</I>&gt;<i> #### limites para comenzar a limpiar la cache #####################
</I>&gt;<i> 
</I>&gt;<i> cache_swap_low 90
</I>&gt;<i> cache_swap_high 95
</I>&gt;<i> 
</I>&gt;<i> #### tamanno de los objetos en la cache como maximo ####################
</I>&gt;<i> 
</I>&gt;<i> maximum_object_size  15 MB
</I>&gt;<i> 
</I>&gt;<i> ### memoria cache ###########################
</I>&gt;<i> 
</I>&gt;<i> cache_mem 500 MB
</I>&gt;<i> 
</I>&gt;<i> ### idioma de las paginas de error de squid ##########################
</I>&gt;<i> 
</I>&gt;<i> error_directory /usr/share/squid/errors/Spanish
</I>
Since Squid-3.2 error pages can automatically be delivered in a language
the person receiving it can read.

To allow that to happen, but with Spanish as the default use this
directive instead of error_directory:

 error_default_language es


FYI, you can also apply branding to the pages display by editing
/etc/squid/errorpages.css


&gt;<i> 
</I>&gt;<i> ##### debug_options cantidad de informaci&#243;n en cache_log #################
</I>&gt;<i> 
</I>&gt;<i> debug_options ALL,0 ALL,1 rotate=8760
</I>
This directive applies the options configured left-to-right.

The &quot;ALL&quot; setting resets *ALL* debug sections to the level given.

That means you should only use debug section &quot;ALL&quot; once in the whole of
squid.conf and it should be done before any other N,N pairs.

Your config actually means this:

  debug_options ALL,1 rotate=8760


&gt;<i> 
</I>&gt;<i> ######### LOGS #######################################
</I>&gt;<i> 
</I>&gt;<i> cache_log /var/log/squid/cache.log
</I>&gt;<i> access_log stdio:/var/log/squid/access.log  rotate=8760
</I>&gt;<i> cache_store_log stdio:/var/log/squid/store.log
</I>
Is there any reason you need this log?
It typically is only useful for debugging and this line could be removed
to speed up your proxy and save disk space.


&gt;<i> 
</I>&gt;<i> ##################
</I>&gt;<i> 
</I>&gt;<i> #AFECTA LA CANTIDAD ESPECIFICAMENTE A STORE.LOG
</I>&gt;<i> 
</I>&gt;<i> logfile_rotate 8760
</I>&gt;<i> 
</I>&gt;<i> #### 365 dias * 24 horas es la cantidad de rotaciones de los logs en el crontab
</I>
Does that mean you are running logrotate every hour of every day?

Perhapse there is some better way to do log handling?

Begin with deciding whether you need store.log at all. If that is not
enough and you want assistance with ideas about further improvements
please tell what is the reason why this proxy is rotating to often.


HTH
Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="022627.html">[squid-users] ACL-by time- not working. Help!
</A></li>
	<LI>Next message (by thread): <A HREF="022643.html">[squid-users] ACL-by time- not working. Help!
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22629">[ date ]</a>
              <a href="thread.html#22629">[ thread ]</a>
              <a href="subject.html#22629">[ subject ]</a>
              <a href="author.html#22629">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
