<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] ACL-by time- not working. Help!
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20ACL-by%20time-%20not%20working.%20Help%21&In-Reply-To=%3CCALtjann%2Bq%3D-_OZ5EZ3m3zagiJ%2B0QnhmTKXhGUTQr7%3D6-x77TUA%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="022629.html">
   <LINK REL="Next"  HREF="022644.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] ACL-by time- not working. Help!</H1>
    <B>Luis Mario Niedas Hern&#225;ndez</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20ACL-by%20time-%20not%20working.%20Help%21&In-Reply-To=%3CCALtjann%2Bq%3D-_OZ5EZ3m3zagiJ%2B0QnhmTKXhGUTQr7%3D6-x77TUA%40mail.gmail.com%3E"
       TITLE="[squid-users] ACL-by time- not working. Help!">lmniedas at gmail.com
       </A><BR>
    <I>Fri Aug 28 15:50:38 UTC 2020</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="022629.html">[squid-users] ACL-by time- not working. Help!
</A></li>
        <LI>Next message (by thread): <A HREF="022644.html">[squid-users] ACL-by time- not working. Help!
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22643">[ date ]</a>
              <a href="thread.html#22643">[ thread ]</a>
              <a href="subject.html#22643">[ subject ]</a>
              <a href="author.html#22643">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>El vie., 28 de ago. de 2020 a la(s) 00:03, Amos Jeffries
(<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>) escribi&#243;:
&gt;<i>
</I>&gt;<i> On 28/08/20 3:40 am, Luis Mario Niedas Hern&#225;ndez wrote:
</I>&gt;<i> &gt; Hello. I need restrict some site by time, but i am not doing well.
</I>&gt;<i> &gt; This is my squid.conf. Please help me to fix the problem. I don't know
</I>&gt;<i> &gt; why it is not working.
</I>&gt;<i> &gt;
</I>&gt;<i>
</I>&gt;<i> It is not clear what your problem actually is.
</I>
Well. My problem is that  i had to block facebook and youtube but i
did not how to do it. Your correction works fine. Thanks for
explaining me some stuff. I appreciate that.

&gt;<i>
</I>&gt;<i> An educated guess tells me that you have missed two important details:
</I>&gt;<i>
</I>&gt;<i>  1) your http_access lines are just a long list of allow, allow, allow.
</I>&gt;<i> Squid has no reason to deny.
</I>
 jajajaja Honestly, I don't understand how squid work. I mean, I don't
know what it is the logic to follow with the acl directives and
http_access allow | deny. I am learning about it. If you can recommend
me a book or a place to look for learning about how to build
adequately my rules in squid. I need it. i don't want copy and paste
acl from some plate and put it in my config, I really want to know how
I have to think. LEARN

&gt;<i>
</I>&gt;<i> To resolve this you need to write out your policy(s) in the form of
</I>&gt;<i> denials. Allowing only the good traffic that remains.
</I>&gt;<i>
</I>I guess that when we put  this:

http_access deny all.

we are telling squid that everything that has not a http_access allow,
it is blocked. So,  why I have to put http_access deny
!peticion_identificacion, instead http_access allow
peticion_identificacion ?


&gt;<i> For best performance sort the lines by ACL checking speed and how much
</I>&gt;<i> traffic they can drop. The faster it can identify and deny bad traffic
</I>&gt;<i> the more speed can go towards the good traffic.
</I>&gt;<i>
</I>&gt;<i>  2) those FB and YT websites use HTTPS and http_access controls only
</I>&gt;<i> apply when an HTTPS connection is established. The TLS connection itself
</I>&gt;<i> may remain open and continue to be used indefinitely.
</I>&gt;<i>
</I>&gt;<i> You can use the client_lifetime directive to shorten the time CONNECT
</I>&gt;<i> tunnels are allowed to remain in use. For your specific case I would set
</I>&gt;<i> it to something like 5 minutes. Browsers can auto-recover so this length
</I>&gt;<i> should not be visible to clients, but you will want to test that to
</I>&gt;<i> confirm what is good for your needs.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> There are several other things about your config file that indicate
</I>&gt;<i> extremely outdated practices or Squid version. Below is a free audit
</I>&gt;<i> report of things that need fixing.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> If you are running a Squid older than 3.5 please update ASAP. Then apply
</I>&gt;<i> the changes below.
</I>
I am running squid 4.6.

&gt;<i>
</I>&gt;<i> If you are running a Squid v3.5 or newer then you can fix these issues
</I>&gt;<i> now with just a check to confirm the change is okay.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; ### autenticacion de los usuarios (http
</I>&gt;<i> &gt; b&#225;sica)############################################
</I>&gt;<i> &gt; auth_param basic program /usr/lib/squid/basic_ncsa_auth /etc/squid/usuarios_inet
</I>&gt;<i> &gt; auth_param basic realm Introduzca su usuario para navegar por la WEB.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; ### por donde responde el squid ###
</I>&gt;<i> &gt; ####################################################
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; http_port 192.168.1.3:3128
</I>&gt;<i> &gt; http_port 127.0.0.1:3128
</I>&gt;<i>
</I>&gt;<i> Are there other IPs assigned to the machine Squid is running on which
</I>&gt;<i> you definitely don't want offering proxy service?
</I>
Yes, my machine has two different interfaces with  different ranges
and I want to offer squid service only for one. ;-)

&gt;<i>
</I>&gt;<i> If no, then you can replace both those with this line:
</I>&gt;<i>   http_port 3128
</I>&gt;<i>
</I>&gt;<i> If yes, then you should replace just the second one with:
</I>&gt;<i>   http_port localhost:3128
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; ########## ACL ###########################################################################
</I>&gt;<i> &gt; #
</I>&gt;<i> &gt; # Recommended minimum configuration:
</I>&gt;<i> &gt;
</I>&gt;<i>
</I>&gt;<i> You are missing the very critical port safety checks. These are to
</I>&gt;<i> prevent your proxy being DoS'ed or uses as an attack vector against
</I>&gt;<i> other software in your LAN.
</I>&gt;<i>
</I>&gt;<i> At worst, you may need to &quot;open&quot; some specific ports by adding them to
</I>&gt;<i> the Safe_ports and/or SSL_ports ACL definitions. But generally this is
</I>&gt;<i> not necessary, and should only be done after investigating carefully
</I>&gt;<i> what that port is used for, including things *other* than the reason you
</I>&gt;<i> are asked to open it.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; acl all src all
</I>&gt;<i>
</I>&gt;<i> Since Squid-3.1 the &quot;all &quot;ACL has been built into Squid. You can remove
</I>&gt;<i> this line, it does nothing.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; acl localhost src 127.0.0.1/32
</I>&gt;<i>
</I>&gt;<i> On all modern machines localhost include the ::1/128 address. Even when
</I>&gt;<i> the machine is IPv4-only connectivity to the network. Localhost is about
</I>&gt;<i> connections within the machine itself and IPv4-only OS no longer exist.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; acl localnet src 192.168.1.0/24
</I>&gt;<i>
</I>&gt;<i> No LAN IPv6 ranges? that is something everyone should be planning for a
</I>&gt;<i> decade ago.
</I>
I don't need IPv6. It is a small office.

&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; acl manager_proto_cache proto cache_object
</I>&gt;<i>
</I>&gt;<i> Since Squid-3.2 the &quot;manager&quot; ACL has been built into Squid. There are
</I>&gt;<i> feature changes to the management URLs that need to be controlled by it
</I>&gt;<i> and the built-in definition handles those.
</I>&gt;<i>
</I>&gt;<i> Please remove the above ACL line and convert anything that used it to
</I>&gt;<i> use the ACL named &quot;manager&quot; instead.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; acl peticion_identificacion proxy_auth REQUIRED
</I>&gt;<i> &gt; acl intranet dstdomain intra.xzy
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; acl ocio dstdomain  .facebook.com .youtube.com
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; acl ocio_medio_dia time MTWHF 12:00-13:10
</I>&gt;<i> &gt; acl ocio_tarde time MTWHF 14:00-14:30
</I>&gt;<i> &gt; acl ocio_mannana time MTWHF 6:00-8:30
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; http_access allow localnet manager_proto_cache
</I>&gt;<i> &gt; http_access allow localhost manager_proto_cache
</I>&gt;<i> &gt; http_access deny manager_proto_cache
</I>&gt;<i>
</I>&gt;<i> &gt; http_access allow ocio ocio_tarde
</I>&gt;<i> &gt; http_access allow ocio ocio_medio_dia
</I>&gt;<i> &gt; http_access allow ocio ocio_mannana
</I>&gt;<i>
</I>&gt;<i> Do you really want your proxy to be allowing anyone anywhere in the
</I>&gt;<i> world to access those websites through your proxy?
</I>&gt;<i>
</I>&gt;<i> I think these &quot;ocio&quot; lines should look like:
</I>&gt;<i>
</I>&gt;<i>   http_access deny ocio !ocio_tarde !ocio_medio_dia !ocio_mannana
</I>&gt;<i>
</I>&gt;<i> Or, you can combine the time periods into one ACL check for better speed
</I>&gt;<i> and understanding:
</I>&gt;<i>
</I>&gt;<i>   acl ocio_tempo time MTWHF 12:00-13:10
</I>&gt;<i>   acl ocio_tempo time MTWHF 14:00-14:30
</I>&gt;<i>   acl ocio_tempo time MTWHF 6:00-8:30
</I>&gt;<i>
</I>&gt;<i>   http_access deny ocio !ocio_tempo
</I>
Thanks for this recommendation. I did not know how to do it fine.

&gt;<i>
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; http_access allow intranet
</I>&gt;<i>
</I>&gt;<i> I am guessing here. But I think this means you do not want to require
</I>&gt;<i> login to access the intranet website.
</I>
jajaja No, here i wanted to say: Squid you should allow the connection
to intranet, but with authentication. I thought that we only had to
request authentication only one time and squid will know that every
http request  made for the same user will be checked  again the rest
of ACL.  :-( I am configuring my squid blink, i meant, i read and test
what happens, but it is a little hard. It is the reason that I wrote
to the squid-user list.

&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; http_access allow localnet peticion_identificacion
</I>&gt;<i>
</I>&gt;<i> For more reliable authentication this should be:
</I>&gt;<i>
</I>&gt;<i>   http_access deny !peticion_identificacion
</I>&gt;<i>   http_access allow localnet
</I>&gt;<i>
</I>&gt;<i> Or, assuming the above about intranet:
</I>&gt;<i>
</I>&gt;<i>   http_access deny !intranet !peticion_identificacion
</I>&gt;<i>   http_access allow localnet
</I>&gt;<i>
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; always_direct allow intranet
</I>&gt;<i> &gt; http_access deny all
</I>&gt;<i> &gt; never_direct allow all
</I>&gt;<i> &gt;
</I>&gt;<i>
</I>&gt;<i> In summary, I think this access control section should look like the
</I>&gt;<i> below lines:
</I>&gt;<i>
</I>&gt;<i>   acl SSL_ports port 443
</I>&gt;<i>
</I>&gt;<i>   acl Safe_ports port 80                # http
</I>&gt;<i>   acl Safe_ports port 21                # ftp
</I>&gt;<i>   acl Safe_ports port 443               # https
</I>&gt;<i>   acl Safe_ports port 70                # gopher
</I>&gt;<i>   acl Safe_ports port 210               # wais
</I>&gt;<i>   acl Safe_ports port 1025-65535        # unregistered ports
</I>&gt;<i>   acl Safe_ports port 280               # http-mgmt
</I>&gt;<i>   acl Safe_ports port 488               # gss-http
</I>&gt;<i>   acl Safe_ports port 591               # filemaker
</I>&gt;<i>   acl Safe_ports port 777               # multiling http
</I>&gt;<i>
</I>&gt;<i>   acl localhost src 127.0.0.1/32 ::1/128
</I>&gt;<i>   acl localnet src 192.168.1.0/24
</I>&gt;<i>
</I>&gt;<i>   acl peticion_identificacion proxy_auth REQUIRED
</I>&gt;<i>   acl intranet dstdomain intra.xzy
</I>&gt;<i>
</I>&gt;<i>   acl ocio dstdomain  .facebook.com .youtube.com
</I>&gt;<i>
</I>&gt;<i>   acl ocio_tempo time MTWHF 12:00-13:10
</I>&gt;<i>   acl ocio_tempo time MTWHF 14:00-14:30
</I>&gt;<i>   acl ocio_tempo time MTWHF 6:00-8:30
</I>&gt;<i>
</I>&gt;<i>   http_access deny !Safe_ports
</I>&gt;<i>   http_access deny CONNECT !SSL_ports
</I>&gt;<i>   http_access deny manager !localnet !localhost
</I>&gt;<i>
</I>&gt;<i>   # Prevent occio domains outside permitted times
</I>&gt;<i>   http_access deny ocio !ocio_tempo
</I>&gt;<i>
</I>&gt;<i>   # Login required unless visiting intranet site(s)
</I>&gt;<i>   http_access deny !intranet !peticion_identificacion
</I>&gt;<i>
</I>&gt;<i>   http_access allow localnet
</I>&gt;<i>
</I>&gt;<i>   http_access deny all
</I>&gt;<i>
</I>&gt;<i>   always_direct allow intranet
</I>&gt;<i>   never_direct allow all
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; ####### cahce padre #################################################
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; cache_peer proxy_padre parent 3128 0  proxy-only
</I>&gt;<i> &gt; #cache_peer_domain  proxy_padre !intra.xzy
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> NP: if you want to restore that !intra.xyz behaviour with modern Squid
</I>&gt;<i> use this:
</I>&gt;<i>
</I>&gt;<i>  cache_peer_access proxy_padre allow !intranet
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; ##### correo cache manager ####
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; cache_mgr lmniedas
</I>&gt;<i>
</I>&gt;<i> This should be an admin contact email. The documentation is not very
</I>&gt;<i> clear, sorry about that. It will receive reports about proxy crashes (if
</I>&gt;<i> the feature is built) and is displayed on error pages as the address to
</I>&gt;<i> contact about problems using the proxy.
</I>&gt;<i>
</I>&gt;<i> For Example;
</I>&gt;<i>
</I>&gt;<i>  cachemgr  <A HREF="https://lists.squid-cache.org/listinfo/squid-users">lmniedas at example.local</A>
</I>&gt;<i>
</I>&gt;<i> or the prettier version:
</I>&gt;<i>
</I>&gt;<i>  cache_mgr Luis Mario Niedas Hern&#225;ndez &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">lmniedas at example.local</A>&gt;
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; cachemgr_passwd ***
</I>&gt;<i>
</I>&gt;<i> I hope that was not your actual password. If it was you now need to
</I>&gt;<i> change it.
</I>&gt;<i>
</I>
jajajaja i changed the information, just to not compromise my security
or at least just to not show all the real information about my
network. ;-)
&gt;<i>
</I>&gt;<i> &gt; #### tamanno de la cache ####################################
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; cache_dir aufs /var/spool/squid 20280 16 256
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; #### limites para comenzar a limpiar la cache #####################
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; cache_swap_low 90
</I>&gt;<i> &gt; cache_swap_high 95
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; #### tamanno de los objetos en la cache como maximo ####################
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; maximum_object_size  15 MB
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; ### memoria cache ###########################
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; cache_mem 500 MB
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; ### idioma de las paginas de error de squid ##########################
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; error_directory /usr/share/squid/errors/Spanish
</I>&gt;<i>
</I>&gt;<i> Since Squid-3.2 error pages can automatically be delivered in a language
</I>&gt;<i> the person receiving it can read.
</I>&gt;<i>
</I>&gt;<i> To allow that to happen, but with Spanish as the default use this
</I>&gt;<i> directive instead of error_directory:
</I>&gt;<i>
</I>&gt;<i>  error_default_language es
</I>&gt;<i>
</I>
I didn't know this. thanks again.

&gt;<i> FYI, you can also apply branding to the pages display by editing
</I>&gt;<i> /etc/squid/errorpages.css
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; ##### debug_options cantidad de informaci&#243;n en cache_log #################
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; debug_options ALL,0 ALL,1 rotate=8760
</I>&gt;<i>
</I>&gt;<i> This directive applies the options configured left-to-right.
</I>&gt;<i>
</I>&gt;<i> The &quot;ALL&quot; setting resets *ALL* debug sections to the level given.
</I>&gt;<i>
</I>&gt;<i> That means you should only use debug section &quot;ALL&quot; once in the whole of
</I>&gt;<i> squid.conf and it should be done before any other N,N pairs.
</I>&gt;<i>
</I>&gt;<i> Your config actually means this:
</I>&gt;<i>
</I>&gt;<i>   debug_options ALL,1 rotate=8760
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; ######### LOGS #######################################
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; cache_log /var/log/squid/cache.log
</I>&gt;<i> &gt; access_log stdio:/var/log/squid/access.log  rotate=8760
</I>&gt;<i> &gt; cache_store_log stdio:/var/log/squid/store.log
</I>&gt;<i>
</I>&gt;<i> Is there any reason you need this log?
</I>&gt;<i> It typically is only useful for debugging and this line could be removed
</I>&gt;<i> to speed up your proxy and save disk space.
</I>
My boss told me that I must save  all my logs, just to check later
what the people are doing and where they are surfing on the internet.

&gt;<i>
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; ##################
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; #AFECTA LA CANTIDAD ESPECIFICAMENTE A STORE.LOG
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; logfile_rotate 8760
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; #### 365 dias * 24 horas es la cantidad de rotaciones de los logs en el crontab
</I>&gt;<i>
</I>&gt;<i> Does that mean you are running logrotate every hour of every day?
</I>&gt;<i>
</I>Yes, I am rotating every one hours all squid's logs. Honestly, because
i thought that it is the more easy way to make analytics work. What
you can recommend me??

&gt;<i> Perhapse there is some better way to do log handling?
</I>&gt;<i>
</I>&gt;<i> Begin with deciding whether you need store.log at all. If that is not
</I>&gt;<i> enough and you want assistance with ideas about further improvements
</I>&gt;<i> please tell what is the reason why this proxy is rotating to often.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> HTH
</I>&gt;<i> Amos
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>


--
&quot;El futuro tiene muchos nombres. Para los d&#233;biles es lo inalcanzable.
Para los temerosos, lo desconocido. Para los valientes es la
oportunidad&quot;
Victor Hugo

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="022629.html">[squid-users] ACL-by time- not working. Help!
</A></li>
	<LI>Next message (by thread): <A HREF="022644.html">[squid-users] ACL-by time- not working. Help!
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22643">[ date ]</a>
              <a href="thread.html#22643">[ thread ]</a>
              <a href="subject.html#22643">[ subject ]</a>
              <a href="author.html#22643">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
