<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] ACL-by time- not working. Help!
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20ACL-by%20time-%20not%20working.%20Help%21&In-Reply-To=%3Cbb91242a-60f0-0e05-3b5a-57457e3a363a%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="022643.html">
   <LINK REL="Next"  HREF="022630.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] ACL-by time- not working. Help!</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20ACL-by%20time-%20not%20working.%20Help%21&In-Reply-To=%3Cbb91242a-60f0-0e05-3b5a-57457e3a363a%40treenet.co.nz%3E"
       TITLE="[squid-users] ACL-by time- not working. Help!">squid3 at treenet.co.nz
       </A><BR>
    <I>Fri Aug 28 16:25:10 UTC 2020</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="022643.html">[squid-users] ACL-by time- not working. Help!
</A></li>
        <LI>Next message (by thread): <A HREF="022630.html">[squid-users] deny_info page not shown
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22644">[ date ]</a>
              <a href="thread.html#22644">[ thread ]</a>
              <a href="subject.html#22644">[ subject ]</a>
              <a href="author.html#22644">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 29/08/20 3:50 am, Luis Mario Niedas Hern&#225;ndez wrote:
&gt;<i> El vie., 28 de ago. de 2020 a la(s) 00:03, Amos Jeffries
</I>&gt;<i> (<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>) escribi&#243;:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> On 28/08/20 3:40 am, Luis Mario Niedas Hern&#225;ndez wrote:
</I>&gt;&gt;&gt;<i> Hello. I need restrict some site by time, but i am not doing well.
</I>&gt;&gt;&gt;<i> This is my squid.conf. Please help me to fix the problem. I don't know
</I>&gt;&gt;&gt;<i> why it is not working.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> It is not clear what your problem actually is.
</I>&gt;<i> 
</I>&gt;<i> Well. My problem is that  i had to block facebook and youtube but i
</I>&gt;<i> did not how to do it. Your correction works fine. Thanks for
</I>&gt;<i> explaining me some stuff. I appreciate that.
</I>&gt;<i> 
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> An educated guess tells me that you have missed two important details:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>  1) your http_access lines are just a long list of allow, allow, allow.
</I>&gt;&gt;<i> Squid has no reason to deny.
</I>&gt;<i> 
</I>&gt;<i>  jajajaja Honestly, I don't understand how squid work. I mean, I don't
</I>&gt;<i> know what it is the logic to follow with the acl directives and
</I>&gt;<i> http_access allow | deny. I am learning about it. If you can recommend
</I>&gt;<i> me a book or a place to look for learning about how to build
</I>&gt;<i> adequately my rules in squid. I need it. i don't want copy and paste
</I>&gt;<i> acl from some plate and put it in my config, I really want to know how
</I>&gt;<i> I have to think. LEARN
</I>&gt;<i> 
</I>
Certainly. The details of access controls are all documented at
&lt;<A HREF="http://wiki.squid-cache.org/SquidFaq/SquidAcl">http://wiki.squid-cache.org/SquidFaq/SquidAcl</A>&gt;

or if you prefer a physical book the &quot;Squid 3.1: Beginners Guide&quot; is
still a good learning resource to begin with. What it lacks is mostly
detail on new features.


&gt;&gt;<i>
</I>&gt;&gt;<i> To resolve this you need to write out your policy(s) in the form of
</I>&gt;&gt;<i> denials. Allowing only the good traffic that remains.
</I>&gt;&gt;<i>
</I>&gt;<i> I guess that when we put  this:
</I>&gt;<i> 
</I>&gt;<i> http_access deny all.
</I>&gt;<i> 
</I>&gt;<i> we are telling squid that everything that has not a http_access allow,
</I>&gt;<i> it is blocked. So,  why I have to put http_access deny
</I>&gt;<i> !peticion_identificacion, instead http_access allow
</I>&gt;<i> peticion_identificacion ?
</I>

ACLs actually have three states: YES, NO, UNKNOWN. Authentication is one
ACL type where the third state is important.

&quot;allow peticion_identificacion&quot; lets all the traffic which is-YES through.
 Meaning it will try to get credentials, but if they do not validate as
correct Squid skips on to checking the next access control line.


&quot;deny !peticion_identificacion&quot; blocks all the traffic which is not-YES.

Meaning Squid will block clients who cannot login with valid credentials.


&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> For best performance sort the lines by ACL checking speed and how much
</I>&gt;&gt;<i> traffic they can drop. The faster it can identify and deny bad traffic
</I>&gt;&gt;<i> the more speed can go towards the good traffic.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>  2) those FB and YT websites use HTTPS and http_access controls only
</I>&gt;&gt;<i> apply when an HTTPS connection is established. The TLS connection itself
</I>&gt;&gt;<i> may remain open and continue to be used indefinitely.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> You can use the client_lifetime directive to shorten the time CONNECT
</I>&gt;&gt;<i> tunnels are allowed to remain in use. For your specific case I would set
</I>&gt;&gt;<i> it to something like 5 minutes. Browsers can auto-recover so this length
</I>&gt;&gt;<i> should not be visible to clients, but you will want to test that to
</I>&gt;&gt;<i> confirm what is good for your needs.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> There are several other things about your config file that indicate
</I>&gt;&gt;<i> extremely outdated practices or Squid version. Below is a free audit
</I>&gt;&gt;<i> report of things that need fixing.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> If you are running a Squid older than 3.5 please update ASAP. Then apply
</I>&gt;&gt;<i> the changes below.
</I>&gt;<i> 
</I>&gt;<i> I am running squid 4.6.
</I>&gt;<i> 
</I>
Okay. The changes should all work, but please plan to upgrade ASAP.
There have been quite a few critical security vulnerabilities fixed this
past year.


&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> ######### LOGS #######################################
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> cache_log /var/log/squid/cache.log
</I>&gt;&gt;&gt;<i> access_log stdio:/var/log/squid/access.log  rotate=8760
</I>&gt;&gt;&gt;<i> cache_store_log stdio:/var/log/squid/store.log
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Is there any reason you need this log?
</I>&gt;&gt;<i> It typically is only useful for debugging and this line could be removed
</I>&gt;&gt;<i> to speed up your proxy and save disk space.
</I>&gt;<i> 
</I>&gt;<i> My boss told me that I must save  all my logs, just to check later
</I>&gt;<i> what the people are doing and where they are surfing on the internet.
</I>&gt;<i> 
</I>
Okay. For that you need the access.log. Not the store.log or cache.log.


&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> ##################
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> #AFECTA LA CANTIDAD ESPECIFICAMENTE A STORE.LOG
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> logfile_rotate 8760
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> #### 365 dias * 24 horas es la cantidad de rotaciones de los logs en el crontab
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Does that mean you are running logrotate every hour of every day?
</I>&gt;&gt;<i>
</I>&gt;<i> Yes, I am rotating every one hours all squid's logs. Honestly, because
</I>&gt;<i> i thought that it is the more easy way to make analytics work. What
</I>&gt;<i> you can recommend me??
</I>
Okay. I would double check that assumption.

Modern Squid have the logging modules for different outputs. Depending
on what analytics system you are using it may not need the rotation at
all or takes input directly somehow other than from the disk file.

Some analytics use &quot;tail&quot; or similar to watch the end of the access.log
and update the reports shortly after a transaction is logged. Less
rotating works better for them.

Some tools can take input from syslog. Squid has a log module to write
access.log records to syslog for those.

Then there is the daemon module. A fairly simple helper can deliver the
log lines to anywhere. For example; any unusual APIs the analytics has.

My CDN analytics dashboard and billing work off an SQL database. So I
co-wrote the helper to drop logs into a database and customers can see
their usage real-time.

Just something to think about when you have time.


HTH
Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="022643.html">[squid-users] ACL-by time- not working. Help!
</A></li>
	<LI>Next message (by thread): <A HREF="022630.html">[squid-users] deny_info page not shown
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22644">[ date ]</a>
              <a href="thread.html#22644">[ thread ]</a>
              <a href="subject.html#22644">[ subject ]</a>
              <a href="author.html#22644">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
