<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid 3.5 - icap parsing error
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%203.5%20-%20icap%20parsing%20error&In-Reply-To=%3CAM6PR04MB56533F4A3507C26D4FF704DA9D520%40AM6PR04MB5653.eurprd04.prod.outlook.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="022639.html">
   <LINK REL="Next"  HREF="022647.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid 3.5 - icap parsing error</H1>
    <B>VON EUW Andreas</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%203.5%20-%20icap%20parsing%20error&In-Reply-To=%3CAM6PR04MB56533F4A3507C26D4FF704DA9D520%40AM6PR04MB5653.eurprd04.prod.outlook.com%3E"
       TITLE="[squid-users] Squid 3.5 - icap parsing error">andreas.voneuw at axa.com
       </A><BR>
    <I>Fri Aug 28 20:29:14 UTC 2020</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="022639.html">[squid-users] SSL Bump: I have weekly more sites to whitelist due to HTTP Error 403 on opening site content
</A></li>
        <LI>Next message (by thread): <A HREF="022647.html">[squid-users] Squid 3.5 - icap parsing error
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22646">[ date ]</a>
              <a href="thread.html#22646">[ thread ]</a>
              <a href="subject.html#22646">[ subject ]</a>
              <a href="author.html#22646">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi all,

I'm trying to integrate a Squid Cache version 3.5.20 for x86_64-redhat-linux-gnu with a Symantec Protection Engine 8.1 to do virus scaning in a reverse proxy setup.
I do send all POST requests to our virus scan engine. But icap integration does not work as expected. Squid does send a OPTIONS request to the icap server.
We get a valid answer from Symantec Protection Engine. But squid fails afterwards with a parsing exception:

2020/08/26 10:04:54.590| 58,3| HttpMsg.cc(173) parse: HttpMsg::parse: failed to find end of headers (eof: 0) in 'ICAP/1.0 200 OK
Date: Wed Aug 26 08:04:54 2020 GMT
Methods: REQMOD
Service: Symantec Protection Engine/8.1.0.29
Service-ID: SYMCSCANREQ-AV
ISTag: &quot;0FF01DDE4872272B6F445AED8643888C&quot;
X-Definition-Info: 20200825.022
Max-Connections: 32
X-Allow-Out: X-Outer-Container-Is-Mime, X-Infection-Found, X-Definition-Info, X-AV-License
X-Allow-Out: X-Violations-Found
X-Allow-Out: X-SYMANTEC-URL-Definition-Info, X-CAIC-URL-Definition-Info, X-SYMANTEC-URLReputation-Definition-Info, X-URL-License, X-URL-Reputation-License
Allow: 204
Options-TTL: 3600
Preview: 4
Transfer-Preview: *
X-AV-License: 1
X-URL-License: 1
X-URL-Reputation-License: 1
'

Does somebody has an idea what's going wrong here? Is this a known squid/icap bug?

Attached: log, config and tcpdumps from icap server 1 and 2 (squid does connect thru a loadbalancer to the icap server)


IPs in the tcpdump:

Squid has IP 10.64.7.145

ICAP Server has IP: 10.140.28.144



Relevant Time in squid.log: 2020/08/26 10:04:54 (= 2020/08/26 08:04:54 icap server time)

Thanks and kind regards,
 Andy


Andreas von Euw

Java Dev Support
AXA Group Operations

<A HREF="https://lists.squid-cache.org/listinfo/squid-users">andreas.voneuw at axa.com</A>&lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">andreas.voneuw at axa-tech.com</A>&gt;

Ce message est confidentiel; Son contenu ne represente en aucun cas
un engagement de la part de AXA  sous reserve de tout accord conclu
par ecrit  entre vous et  AXA.  Toute publication,  utilisation  ou 
diffusion,  meme partielle,  doit etre autorisee prealablement.  Si
vous  n'etes pas  destinataire  de ce message,  merci  d'en avertir 
immediatement l'expediteur.

This message is  confidential;  its  contents  do not  constitute a
commitment by AXA  except where provided for in a written agreement 
between you and AXA.  Any unauthorised disclosure,  use or dissemi-
nation, either whole or partial,  is prohibited. If you are not the
intended recipient of the message,  please notify  the sender imme-
diately.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20200828/8178c8ea/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20200828/8178c8ea/attachment.htm</A>&gt;
-------------- next part --------------
A non-text attachment was scrubbed...
Name: squid-icap.conf
Type: application/octet-stream
Size: 393 bytes
Desc: squid-icap.conf
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20200828/8178c8ea/attachment.obj">http://lists.squid-cache.org/pipermail/squid-users/attachments/20200828/8178c8ea/attachment.obj</A>&gt;
-------------- next part --------------
A non-text attachment was scrubbed...
Name: dump.rar
Type: application/octet-stream
Size: 1786 bytes
Desc: dump.rar
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20200828/8178c8ea/attachment-0001.obj">http://lists.squid-cache.org/pipermail/squid-users/attachments/20200828/8178c8ea/attachment-0001.obj</A>&gt;
-------------- next part --------------
A non-text attachment was scrubbed...
Name: squid.log.rar
Type: application/octet-stream
Size: 7146 bytes
Desc: squid.log.rar
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20200828/8178c8ea/attachment-0002.obj">http://lists.squid-cache.org/pipermail/squid-users/attachments/20200828/8178c8ea/attachment-0002.obj</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="022639.html">[squid-users] SSL Bump: I have weekly more sites to whitelist due to HTTP Error 403 on opening site content
</A></li>
	<LI>Next message (by thread): <A HREF="022647.html">[squid-users] Squid 3.5 - icap parsing error
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22646">[ date ]</a>
              <a href="thread.html#22646">[ thread ]</a>
              <a href="subject.html#22646">[ subject ]</a>
              <a href="author.html#22646">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
