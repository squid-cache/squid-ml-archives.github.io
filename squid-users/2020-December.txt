From reskumar at in.ibm.com  Tue Dec  1 07:20:34 2020
From: reskumar at in.ibm.com (Reshma V Kumar)
Date: Tue, 1 Dec 2020 07:20:34 +0000
Subject: [squid-users] ERROR connecting to squid proxy server
Message-ID: <OF9BF640F1.DE7933D6-ON00258631.002172E2-00258631.002855EE@notes.na.collabserv.com>

An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20201201/94381b40/attachment.htm>
-------------- next part --------------
An embedded and charset-unspecified text was scrubbed...
Name: squid_output.txt
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20201201/94381b40/attachment.txt>

From squid3 at treenet.co.nz  Tue Dec  1 11:53:49 2020
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Wed, 2 Dec 2020 00:53:49 +1300
Subject: [squid-users] ERROR connecting to squid proxy server
In-Reply-To: <OF9BF640F1.DE7933D6-ON00258631.002172E2-00258631.002855EE@notes.na.collabserv.com>
References: <OF9BF640F1.DE7933D6-ON00258631.002172E2-00258631.002855EE@notes.na.collabserv.com>
Message-ID: <ef961681-2df4-4733-1eb7-4dce61a6df33@treenet.co.nz>

On 1/12/20 8:20 pm, Reshma V Kumar wrote:
> Hi all,
> I am testing squid 4.13 on AIX 7.2. I started the squid proxy server in 
> the foreground using the following command
> */opt/freeware/sbin/squid_32 -f /opt/freeware/etc/squid/squid.conf -d3 
> --foreground*
> To test if the squid proxy server is working or not, the following curl 
> command is run which always give Service Unavailable error

> *$ curl -x http://x.xx.xx.xxx:3128 <http://9.47.64.198:3128> -I 
> http://www.google.com <http://www.google.com>
> HTTP/1.1 503 Service Unavailable
> Server: squid/4.13
> Mime-Version: 1.0
> Date: Tue, 01 Dec 2020 06:26:43 GMT
> Content-Type: text/html;charset=utf-8
> Content-Length: 3698
> X-Squid-Error: ERR_DNS_FAIL 0
> Vary: Accept-Language
> Content-Language: en
> X-Cache: MISS from fvt-p7a2-lp17.pok.stglabs.ibm.com
> Via: 1.1 fvt-p7a2-lp17.pok.stglabs.ibm.com (squid/4.13)
> Connection: keep-alive*

> I have attached the output of the squid command running in foreground.
> Any idea why this is happening?

The error message tells you what is going wrong. It says: DNS Failure.

The cache.log should contain more details about which DNS server(s) 
failed and where the DNS server details came from.


Amos


From user3849273 at gmail.com  Thu Dec  3 11:49:15 2020
From: user3849273 at gmail.com (Robin Dinse)
Date: Thu, 3 Dec 2020 12:49:15 +0100
Subject: [squid-users] Is there a way to internally resolve 302 redirects?
Message-ID: <CAHYawH42WfeK8TvAcAN6nLjje2_B4xO63BzBhRY4Y81s7-9UdQ@mail.gmail.com>

Hello,

I am using a Squid cache with SSLBump to reduce the bandwidth impact of
Chocolatey upgrades. The setup works fine, however some URLs randomly
redirect to different CDNs which means the files are re-downloaded upon
each request.

I would like Squid to instead resolve the redirects so as to not follow 302
redirects at all in subsequent queries, but to provide the first file that
was encountered in following the redirect(s) the first time it encounters
the query URL.

Best
- Ben
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20201203/987c4bb2/attachment.htm>

From rousskov at measurement-factory.com  Thu Dec  3 16:35:49 2020
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Thu, 3 Dec 2020 11:35:49 -0500
Subject: [squid-users] Is there a way to internally resolve 302
 redirects?
In-Reply-To: <CAHYawH42WfeK8TvAcAN6nLjje2_B4xO63BzBhRY4Y81s7-9UdQ@mail.gmail.com>
References: <CAHYawH42WfeK8TvAcAN6nLjje2_B4xO63BzBhRY4Y81s7-9UdQ@mail.gmail.com>
Message-ID: <5028ddb0-57b8-ea74-04f4-9050c5e2a1ba@measurement-factory.com>

On 12/3/20 6:49 AM, Robin Dinse wrote:

> I am using a Squid cache with SSLBump to reduce the bandwidth impact of
> Chocolatey upgrades. The setup works fine, however some URLs randomly
> redirect to different CDNs which means the files are re-downloaded upon
> each request.
> 
> I would like Squid to instead resolve the redirects so as to not follow
> 302 redirects at all in subsequent queries, but to provide the first
> file that was encountered in following the redirect(s) the first time it
> encounters the query URL.

I am not sure I am parsing your request correctly, but it sounds like
you may need to investigate two solutions:

1. Block or make unnecessary some cache validation requests (because
they result in unwanted redirects).

2. Computing your own Store IDs (so that Squid can answer the redirected
requests using the already stored responses):
https://wiki.squid-cache.org/Features/StoreID


HTH,

Alex.


From obr2pd at gmail.com  Thu Dec  3 17:07:15 2020
From: obr2pd at gmail.com (Ob Rzwo)
Date: Thu, 3 Dec 2020 18:07:15 +0100
Subject: [squid-users] Squid Proxy Performance Limits
Message-ID: <CAEOgqt+wF8pUd4v2uPfVnqR8GJ+o7YdgSA2joyKCqsHyx3W3Fg@mail.gmail.com>

Hello,

I am reaching the performance limits of the Squid Proxy. I have a certain
base load on one instance with 100 to 500 connections at the same time.
First it gets slower then 503s are thrown.

Now the question:

Are there any squid.conf settings that could ease the situation? (Except
for `cache_dir aufs 1000 16 256` I have default settings IIRC.

Greetings, Ob Rzwo
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20201203/3e5b25f4/attachment.htm>

From rousskov at measurement-factory.com  Thu Dec  3 17:40:44 2020
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Thu, 3 Dec 2020 12:40:44 -0500
Subject: [squid-users] Squid Proxy Performance Limits
In-Reply-To: <CAEOgqt+wF8pUd4v2uPfVnqR8GJ+o7YdgSA2joyKCqsHyx3W3Fg@mail.gmail.com>
References: <CAEOgqt+wF8pUd4v2uPfVnqR8GJ+o7YdgSA2joyKCqsHyx3W3Fg@mail.gmail.com>
Message-ID: <beb1bd4e-3409-84c3-7141-2c880881f280@measurement-factory.com>

On 12/3/20 12:07 PM, Ob Rzwo wrote:

> I am reaching the performance limits of the Squid Proxy. I have a
> certain base load on one instance with 100 to 500 connections at the
> same time. First it gets slower then 503s are thrown.
> 
> Now the question:
> 
> Are there any squid.conf settings that could ease the situation? (Except
> for `cache_dir aufs 1000 16 256` I have default settings IIRC.

The correct answer depends on where the bottleneck is (memory, disk,
CPU, network, file descriptors, DNS, etc.). In most cases, that answer
is "yes", but specific configuration changes would depend on the current
bottleneck.

What performance limits is your Squid instance hitting? Where is the
bottleneck? IIRC, there are Squid wiki pages and book chapters dedicated
to that complicated topic, but you can start with something as basic as
atop reports, syslog messages, and cache.log errors/warnings.


HTH,

Alex.


From squid-user at tlinx.org  Sun Dec  6 15:12:02 2020
From: squid-user at tlinx.org (L A Walsh)
Date: Sun, 06 Dec 2020 07:12:02 -0800
Subject: [squid-users] replacement for obsoleted cache controls
 (ign-no-cache; ign-must-reval. + ign-auth)
Message-ID: <5FCCF4C2.6070904@tlinx.org>

Since the early 4.x series and now, the cache control headers:

ignore-no-cache
ignore-must-revalidate
ignore-auth

have been "obsoleted".  Indicating something has replaced them and
there's a new & better way to ignore those headers for
static files (most often web-fonts, though some javascript files
also fall into that category).

Thanks!

-linda



From ml at netfence.it  Sun Dec  6 15:26:26 2020
From: ml at netfence.it (Andrea Venturoli)
Date: Sun, 6 Dec 2020 16:26:26 +0100
Subject: [squid-users] FTP proxy
Message-ID: <06793b33-283b-0474-1dd0-28a7ab41ba08@netfence.it>

Hello.

I'm trying to evaulate FTP proxying with squid and I have a couple of 
questions.
To be clear, I'm not talking about FTP through HTTP, but about the 
ftp_port option.
I've used frox (http://frox.sourceforge.net/) in the past for this.



I see this feature was introduced in 3.5 as an experimental one; at 4.13 
is it still so or is it considered stable and dependable?
(For now I'm not interested in logging, interception, etc..., I just 
need to bypass a firewall easily).

Is there a way to restrict the port range of the additional connections 
(e.g. to 40000-50000)?

  bye & Thanks
	av.


From Antony.Stone at squid.open.source.it  Sun Dec  6 15:44:37 2020
From: Antony.Stone at squid.open.source.it (Antony Stone)
Date: Sun, 6 Dec 2020 16:44:37 +0100
Subject: [squid-users] FTP proxy
In-Reply-To: <06793b33-283b-0474-1dd0-28a7ab41ba08@netfence.it>
References: <06793b33-283b-0474-1dd0-28a7ab41ba08@netfence.it>
Message-ID: <202012061644.37695.Antony.Stone@squid.open.source.it>

On Sunday 06 December 2020 at 16:26:26, Andrea Venturoli wrote:

> Hello.
> 
> I'm trying to evaulate FTP proxying with squid and I have a couple of
> questions.
> To be clear, I'm not talking about FTP through HTTP, but about the
> ftp_port option.
> I've used frox (http://frox.sourceforge.net/) in the past for this.
> 
> I see this feature was introduced in 3.5 as an experimental one; at 4.13
> is it still so or is it considered stable and dependable?

I can't answer your detailed questions above personally; however I'm sure 
someone else here can, but the following point intrigued me...

> (For now I'm not interested in logging, interception, etc..., I just
> need to bypass a firewall easily).

Where is the firewall, compared to your Squid proxy, in the network?

I'm just wondering how you plan to use Squid's native FTP mode to bypass a 
firewall, which is therefore presumably blocking FTP...?

> Is there a way to restrict the port range of the additional connections
> (e.g. to 40000-50000)?
> 
>   bye & Thanks
> 	av.


Regards,


Antony.

-- 
"In fact I wanted to be John Cleese and it took me some time to realise that 
the job was already taken."

 - Douglas Adams

                                                   Please reply to the list;
                                                         please *don't* CC me.


From ml at netfence.it  Sun Dec  6 15:56:10 2020
From: ml at netfence.it (Andrea Venturoli)
Date: Sun, 6 Dec 2020 16:56:10 +0100
Subject: [squid-users] FTP proxy
In-Reply-To: <202012061644.37695.Antony.Stone@squid.open.source.it>
References: <06793b33-283b-0474-1dd0-28a7ab41ba08@netfence.it>
 <202012061644.37695.Antony.Stone@squid.open.source.it>
Message-ID: <3a88f4b8-9e49-8aa2-7836-e1f4e1807905@netfence.it>

On 12/6/20 4:44 PM, Antony Stone wrote:

> Where is the firewall, compared to your Squid proxy, in the network?

Squid runs on the firewall itself.



> I'm just wondering how you plan to use Squid's native FTP mode to bypass a
> firewall, which is therefore presumably blocking FTP...?

It's not blocking FTP for itself, but it's blocking FTP to internal clients.


From Antony.Stone at squid.open.source.it  Sun Dec  6 16:01:24 2020
From: Antony.Stone at squid.open.source.it (Antony Stone)
Date: Sun, 6 Dec 2020 17:01:24 +0100
Subject: [squid-users] FTP proxy
In-Reply-To: <3a88f4b8-9e49-8aa2-7836-e1f4e1807905@netfence.it>
References: <06793b33-283b-0474-1dd0-28a7ab41ba08@netfence.it>
 <202012061644.37695.Antony.Stone@squid.open.source.it>
 <3a88f4b8-9e49-8aa2-7836-e1f4e1807905@netfence.it>
Message-ID: <202012061701.24920.Antony.Stone@squid.open.source.it>

On Sunday 06 December 2020 at 16:56:10, Andrea Venturoli wrote:

> On 12/6/20 4:44 PM, Antony Stone wrote:
> > Where is the firewall, compared to your Squid proxy, in the network?
> 
> Squid runs on the firewall itself.
> 
> > I'm just wondering how you plan to use Squid's native FTP mode to bypass
> > a firewall, which is therefore presumably blocking FTP...?
> 
> It's not blocking FTP for itself, but it's blocking FTP to internal
> clients.

Oh, so you're in charge of both?

That would make sense, then - otherwise I was wondering how a client would get 
FTP out to the Internet via Squid if they weren't allowed to through the 
firewall...

Thanks,


Antony.

-- 
If you were ploughing a field, which would you rather use - two strong oxen or 
1024 chickens?

 - Seymour Cray, pioneer of supercomputing

                                                   Please reply to the list;
                                                         please *don't* CC me.


From ml at netfence.it  Sun Dec  6 16:15:29 2020
From: ml at netfence.it (Andrea Venturoli)
Date: Sun, 6 Dec 2020 17:15:29 +0100
Subject: [squid-users] FTP proxy
In-Reply-To: <202012061701.24920.Antony.Stone@squid.open.source.it>
References: <06793b33-283b-0474-1dd0-28a7ab41ba08@netfence.it>
 <202012061644.37695.Antony.Stone@squid.open.source.it>
 <3a88f4b8-9e49-8aa2-7836-e1f4e1807905@netfence.it>
 <202012061701.24920.Antony.Stone@squid.open.source.it>
Message-ID: <97d20f46-2aaa-d8ac-cc17-6c325361f446@netfence.it>

On 12/6/20 5:01 PM, Antony Stone wrote:

> Oh, so you're in charge of both?

Yes.



From rousskov at measurement-factory.com  Sun Dec  6 19:41:31 2020
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Sun, 6 Dec 2020 14:41:31 -0500
Subject: [squid-users] FTP proxy
In-Reply-To: <06793b33-283b-0474-1dd0-28a7ab41ba08@netfence.it>
References: <06793b33-283b-0474-1dd0-28a7ab41ba08@netfence.it>
Message-ID: <5af0fba9-abc3-b2d3-10ec-532b4e7e4398@measurement-factory.com>

On 12/6/20 10:26 AM, Andrea Venturoli wrote:

> I see this feature was introduced in 3.5 as an experimental one; at 4.13
> is it still so or is it considered stable and dependable?

AFAIK, FTP proxy is successfully used in some production environments,
but I bet that most Squid deployments do not use this feature. YMMV.


> Is there a way to restrict the port range of the additional connections
> (e.g. to 40000-50000)?

I do not know what connections you are talking about (there are at least
four connections when it comes to a typical proxied FTP transaction).

* If you are talking about source ports used by from-Squid TCP
connections, then those are usually handled by your OS ephemeral ports
setting (e.g., sysctl net.ipv4.ip_local_port_range).

* If you are talking about blocking FTP PORT/EPRT commands based on the
ports requested by FTP clients, then, in theory, one should be able to
block such requests using http_access ACLs targeting
fake/internal/wrapping HTTP requests that represent the corresponding
raw FTP command. However, I have not tested whether that works in
practice, and I suspect that Squid does _not_ supply enough details for
the http_access ACLs to work in this use case.

Please note that, AFAICT, Squid code talking to FTP servers does not
support PORT/EPRT commands, so Squid converts each received FTP
PORT/EPRT command into a PASV command (wrapped in an HTTP request for
Squid traversal). In that wrapping HTTP request, the FTP-Command header
field value will be set to PASV, not PORT or EPRT.


HTH,

Alex.


From rousskov at measurement-factory.com  Sun Dec  6 20:14:12 2020
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Sun, 6 Dec 2020 15:14:12 -0500
Subject: [squid-users] replacement for obsoleted cache controls
 (ign-no-cache; ign-must-reval. + ign-auth)
In-Reply-To: <5FCCF4C2.6070904@tlinx.org>
References: <5FCCF4C2.6070904@tlinx.org>
Message-ID: <72ece466-d028-f38f-894f-58d46888b010@measurement-factory.com>

On 12/6/20 10:12 AM, L A Walsh wrote:
> Since the early 4.x series and now, the cache control headers:

> ignore-no-cache
> ignore-must-revalidate
> ignore-auth

> have been "obsoleted".? Indicating something has replaced them and
> there's a new & better way to ignore those headers for
> static files (most often web-fonts, though some javascript files
> also fall into that category).


AFAICT, the options were _not_ removed because there are new/better
options to ignore the corresponding directives. I see how this can be
confusing in a classical "obsoletion" context. I will try to clarify:

* ignore-no-cache

Squid v3.2 release notes imply that Squid does what most admins want
now, without any explicit option: "Its commonly desired behaviour is
obsoleted by correct HTTP/1.1 Cache-Control:no-cache handling." Commit
7ed5335 message details that claim:
https://github.com/squid-cache/squid/commit/7ed5335


* ignore-must-revalidate

Squid v4 release notes claim that "Other more HTTP compliant directives
(cache, store_miss) can be used to prevent objects from caching". That
official statement mismatches the ignore-must-revalidate intent AFAICT:
The ignore-must-revalidate intent was to prevent revalidations rather
than prevent caching.

The corresponding commit message paints a rather different picture by
claiming that ignore-must-revalidate was broken -- it was actually
preventing caching rather preventing revalidation (and caused other
problems):
https://github.com/squid-cache/squid/commit/064679e

If you combine the two together, you may get something like "the option
was removed because it did not do what it promised to do, and what it
actually did can be accomplished with cache and store_miss".


* ignore-auth

Squid v4 release notes imply that Squid does what most admins want now,
without any explicit option: "Its commonly desired behaviour is
performed by default with correct HTTP/1.1 revalidation". More details
at https://github.com/squid-cache/squid/commit/d94cbaa


Please do not shoot the messenger -- I am just relaying and interpreting
the official information. If you have a specific use case that cannot be
addressed using the existing directives, please ask about that specific
use case, detailing what Squid receives and what you want Squid to do.


HTH,

Alex.


From squid3 at treenet.co.nz  Mon Dec  7 00:07:51 2020
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Mon, 7 Dec 2020 13:07:51 +1300
Subject: [squid-users] replacement for obsoleted cache controls
 (ign-no-cache; ign-must-reval. + ign-auth)
In-Reply-To: <72ece466-d028-f38f-894f-58d46888b010@measurement-factory.com>
References: <5FCCF4C2.6070904@tlinx.org>
 <72ece466-d028-f38f-894f-58d46888b010@measurement-factory.com>
Message-ID: <2c7429af-7df5-e119-b655-738ca99311c1@treenet.co.nz>

On 7/12/20 9:14 am, Alex Rousskov wrote:
> On 12/6/20 10:12 AM, L A Walsh wrote:
...
> * ignore-no-cache
> 
> Squid v3.2 release notes imply that Squid does what most admins want
> now, without any explicit option: "Its commonly desired behaviour is
> obsoleted by correct HTTP/1.1 Cache-Control:no-cache handling." Commit
> 7ed5335 message details that claim:
> https://github.com/squid-cache/squid/commit/7ed5335
> 

More details on that change can also be found at 
<https://squidproxy.wordpress.com/2012/10/16/squid-3-2-pragma-cache-control-no-cache-versus-storage/>

Amos


From squid3 at treenet.co.nz  Mon Dec  7 04:48:16 2020
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Mon, 7 Dec 2020 17:48:16 +1300
Subject: [squid-users] WCCPv2 testers needed
Message-ID: <b278c411-af53-8649-8c32-d99d1b43771b@treenet.co.nz>

Hi all,

We have some improvements to the WCCPv2 packet parser which need 
real-traffic testing to verify nothing is broken before being submitted 
for merge.

If you are able to test a patch of WCCPv2 please get in touch with me. 
It will require Squid-4 or later version.


Cheers
Amos


From jascha.sticher at tds.fujitsu.com  Mon Dec  7 07:20:15 2020
From: jascha.sticher at tds.fujitsu.com (Sticher, Jascha)
Date: Mon, 7 Dec 2020 07:20:15 +0000
Subject: [squid-users] FTP proxy
In-Reply-To: <5af0fba9-abc3-b2d3-10ec-532b4e7e4398@measurement-factory.com>
References: <06793b33-283b-0474-1dd0-28a7ab41ba08@netfence.it>
 <5af0fba9-abc3-b2d3-10ec-532b4e7e4398@measurement-factory.com>
Message-ID: <E286ADE35F919742812E3076A36122E702337E7FEE@tdsnsumbx2vp>

Hi Andrea,

> I see this feature was introduced in 3.5 as an experimental one; at 4.13
> is it still so or is it considered stable and dependable?

We are using the squid ftp_port feature for some customers. So far, we have not experienced any issues.
The only downside to using frox (from which we also have migrated) ist the missing feature setting an upstream proxy (proxy-chaining FTP).

> Is there a way to restrict the port range of the additional connections
> (e.g. to 40000-50000)?
As Alex mentioned, squid forces passive FTP, which is the better for firewalled environments anyways.
You should activate automatic FTP detection on your firewall (hint: FTP helper for iptables) - this way you don't need to add any extra rules besides the FTP data connection port.


Kind regards,

Jascha Sticher
Fujitsu

From sampei02 at tiscali.it  Mon Dec  7 08:12:02 2020
From: sampei02 at tiscali.it (sampei02 at tiscali.it)
Date: Mon, 7 Dec 2020 09:12:02 +0100
Subject: [squid-users] Log rotate
Message-ID: <993995F4-0721-472B-B964-567DC6B6ACB4@tiscali.it>

I want to rotate access.log by logrotate system process so I disabled rotation in squid.conf, logfile_rotate has been set to zero; by logrotate I can compress log files and to name them with date suffix.
But what I have to write among postrotate and endscript ? What command to send to squid to start rotation?
It?s right to write "squid -k rotate" in postrotate section if I wanted to manage rotation only by logrotate?


This is my /etc/logorotate.d/ file

var/log/squid/access.log {
        daily
        compress
        rotate 365
        missingok
        nocreate
        sharedscripts
        postrotate
		 test ! -e /var/run/squid.pid || test ! -x /usr/sbin/squid || /usr/sbin/squid -k rotate 2>/dev/null
        endscript
}





From uhlar at fantomas.sk  Mon Dec  7 09:05:39 2020
From: uhlar at fantomas.sk (Matus UHLAR - fantomas)
Date: Mon, 7 Dec 2020 10:05:39 +0100
Subject: [squid-users] FTP proxy
In-Reply-To: <5af0fba9-abc3-b2d3-10ec-532b4e7e4398@measurement-factory.com>
References: <06793b33-283b-0474-1dd0-28a7ab41ba08@netfence.it>
 <5af0fba9-abc3-b2d3-10ec-532b4e7e4398@measurement-factory.com>
Message-ID: <20201207090539.GA20009@fantomas.sk>

>On 12/6/20 10:26 AM, Andrea Venturoli wrote:
>> Is there a way to restrict the port range of the additional connections
>> (e.g. to 40000-50000)?

On 06.12.20 14:41, Alex Rousskov wrote:
>I do not know what connections you are talking about (there are at least
>four connections when it comes to a typical proxied FTP transaction).
>
>* If you are talking about source ports used by from-Squid TCP
>connections, then those are usually handled by your OS ephemeral ports
>setting (e.g., sysctl net.ipv4.ip_local_port_range).

I guess he means the opposite: local port range for passive connections

>* If you are talking about blocking FTP PORT/EPRT commands based on the
>ports requested by FTP clients, then, in theory, one should be able to
>block such requests using http_access ACLs targeting
>fake/internal/wrapping HTTP requests that represent the corresponding
>raw FTP command. However, I have not tested whether that works in
>practice, and I suspect that Squid does _not_ supply enough details for
>the http_access ACLs to work in this use case.

this should be used against https://en.wikipedia.org/wiki/FTP_bounce_attack

>Please note that, AFAICT, Squid code talking to FTP servers does not
>support PORT/EPRT commands, so Squid converts each received FTP
>PORT/EPRT command into a PASV command (wrapped in an HTTP request for
>Squid traversal). In that wrapping HTTP request, the FTP-Command header
>field value will be set to PASV, not PORT or EPRT.

this makes FTP easier to handle on squid.
-- 
Matus UHLAR - fantomas, uhlar at fantomas.sk ; http://www.fantomas.sk/
Warning: I wish NOT to receive e-mail advertising to this address.
Varovanie: na tuto adresu chcem NEDOSTAVAT akukolvek reklamnu postu.
I don't have lysdexia. The Dog wouldn't allow that.


From uhlar at fantomas.sk  Mon Dec  7 09:08:07 2020
From: uhlar at fantomas.sk (Matus UHLAR - fantomas)
Date: Mon, 7 Dec 2020 10:08:07 +0100
Subject: [squid-users] Log rotate
In-Reply-To: <993995F4-0721-472B-B964-567DC6B6ACB4@tiscali.it>
References: <993995F4-0721-472B-B964-567DC6B6ACB4@tiscali.it>
Message-ID: <20201207090807.GB20009@fantomas.sk>

On 07.12.20 09:12, sampei02 at tiscali.it wrote:
>I want to rotate access.log by logrotate system process so I disabled
> rotation in squid.conf, logfile_rotate has been set to zero; by logrotate
> I can compress log files and to name them with date suffix.

>But what I have to write among postrotate and endscript ?  What command to
> send to squid to start rotation?

>It?s right to write "squid -k rotate" in postrotate section if I wanted to
> manage rotation only by logrotate?


this is very common on debian-based systems.

>This is my /etc/logorotate.d/ file
>
>var/log/squid/access.log {
>        daily
>        compress
>        rotate 365
>        missingok
>        nocreate
>        sharedscripts
>        postrotate
>		 test ! -e /var/run/squid.pid || test ! -x /usr/sbin/squid || /usr/sbin/squid -k rotate 2>/dev/null
>        endscript
>}

are you sure you don't run debian? ;-)
I would just like to avoit redirecting stderr to /dev/null
- if something bad happens, you should know it and not flush the info


/var/log/squid/*.log {
        daily
        compress
        delaycompress
        rotate 31
        missingok
        nocreate
        sharedscripts
        prerotate
                test ! -x /usr/sbin/sarg-reports || /usr/sbin/sarg-reports daily
        endscript
        postrotate
                test ! -e /var/run/squid.pid || test ! -x /usr/sbin/squid || /usr/sbin/squid -k rotate
        endscript
}


-- 
Matus UHLAR - fantomas, uhlar at fantomas.sk ; http://www.fantomas.sk/
Warning: I wish NOT to receive e-mail advertising to this address.
Varovanie: na tuto adresu chcem NEDOSTAVAT akukolvek reklamnu postu.
Linux - It's now safe to turn on your computer.
Linux - Teraz mozete pocitac bez obav zapnut.


From sampei02 at tiscali.it  Mon Dec  7 09:35:21 2020
From: sampei02 at tiscali.it (sampei02 at tiscali.it)
Date: Mon, 7 Dec 2020 10:35:21 +0100
Subject: [squid-users] Log rotate
In-Reply-To: <20201207090807.GB20009@fantomas.sk>
References: <993995F4-0721-472B-B964-567DC6B6ACB4@tiscali.it>
 <20201207090807.GB20009@fantomas.sk>
Message-ID: <182D9B4C-CE07-42CA-90E4-97AB028A9846@tiscali.it>

My OS is Centos 7.
But I manage rotation by logrotate, according to your suggestions in /etc/logrotate.d/squid, among postscript and endscript, there is written 'squid -k rotate? so you don?t invoke squid rotation too ?!? We have 2 rotations?



> On 7 Dec 2020, at 10:08, Matus UHLAR - fantomas <uhlar at fantomas.sk> wrote:
> 
> On 07.12.20 09:12, sampei02 at tiscali.it <mailto:sampei02 at tiscali.it> wrote:
>> I want to rotate access.log by logrotate system process so I disabled
>> rotation in squid.conf, logfile_rotate has been set to zero; by logrotate
>> I can compress log files and to name them with date suffix.
> 
>> But what I have to write among postrotate and endscript ?  What command to
>> send to squid to start rotation?
> 
>> It?s right to write "squid -k rotate" in postrotate section if I wanted to
>> manage rotation only by logrotate?
> 
> 
> this is very common on debian-based systems.
> 
>> This is my /etc/logorotate.d/ file
>> 
>> var/log/squid/access.log {
>>       daily
>>       compress
>>       rotate 365
>>       missingok
>>       nocreate
>>       sharedscripts
>>       postrotate
>> 		 test ! -e /var/run/squid.pid || test ! -x /usr/sbin/squid || /usr/sbin/squid -k rotate 2>/dev/null
>>       endscript
>> }
> 
> are you sure you don't run debian? ;-)
> I would just like to avoit redirecting stderr to /dev/null
> - if something bad happens, you should know it and not flush the info
> 
> 
> /var/log/squid/*.log {
>       daily
>       compress
>       delaycompress
>       rotate 31
>       missingok
>       nocreate
>       sharedscripts
>       prerotate
>               test ! -x /usr/sbin/sarg-reports || /usr/sbin/sarg-reports daily
>       endscript
>       postrotate
>               test ! -e /var/run/squid.pid || test ! -x /usr/sbin/squid || /usr/sbin/squid -k rotate
>       endscript
> }
> 
> 
> -- 
> Matus UHLAR - fantomas, uhlar at fantomas.sk <mailto:uhlar at fantomas.sk> ; http://www.fantomas.sk/ <http://www.fantomas.sk/>
> Warning: I wish NOT to receive e-mail advertising to this address.
> Varovanie: na tuto adresu chcem NEDOSTAVAT akukolvek reklamnu postu.
> Linux - It's now safe to turn on your computer.
> Linux - Teraz mozete pocitac bez obav zapnut.
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org <mailto:squid-users at lists.squid-cache.org>
> http://lists.squid-cache.org/listinfo/squid-users <http://lists.squid-cache.org/listinfo/squid-users>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20201207/03d525b7/attachment.htm>

From ml at netfence.it  Mon Dec  7 10:03:50 2020
From: ml at netfence.it (Andrea Venturoli)
Date: Mon, 7 Dec 2020 11:03:50 +0100
Subject: [squid-users] FTP proxy
In-Reply-To: <5af0fba9-abc3-b2d3-10ec-532b4e7e4398@measurement-factory.com>
References: <06793b33-283b-0474-1dd0-28a7ab41ba08@netfence.it>
 <5af0fba9-abc3-b2d3-10ec-532b4e7e4398@measurement-factory.com>
Message-ID: <bcd4ac79-8b6d-f558-6b02-92d5ce2c5e9c@netfence.it>

On 12/6/20 8:41 PM, Alex Rousskov wrote:

> AFAIK, FTP proxy is successfully used in some production environments,
> but I bet that most Squid deployments do not use this feature. YMMV.

Thanks.


>> Is there a way to restrict the port range of the additional connections
>> (e.g. to 40000-50000)?
> 
> I do not know what connections you are talking about (there are at least
> four connections when it comes to a typical proxied FTP transaction).

I'm talking about the ports used by the clients to conect to Squid 
(besides 21), using passive FTP (i.e. those returned by PASV command).

  bye & Thanks
	av.


From uhlar at fantomas.sk  Mon Dec  7 11:07:52 2020
From: uhlar at fantomas.sk (Matus UHLAR - fantomas)
Date: Mon, 7 Dec 2020 12:07:52 +0100
Subject: [squid-users] Log rotate
In-Reply-To: <182D9B4C-CE07-42CA-90E4-97AB028A9846@tiscali.it>
References: <993995F4-0721-472B-B964-567DC6B6ACB4@tiscali.it>
 <20201207090807.GB20009@fantomas.sk>
 <182D9B4C-CE07-42CA-90E4-97AB028A9846@tiscali.it>
Message-ID: <20201207110752.GA23891@fantomas.sk>

On 07.12.20 10:35, sampei02 at tiscali.it wrote:
>My OS is Centos 7.

doesn't centos come with squid package, including logrotate config?

>But I manage rotation by logrotate, according to your suggestions in
> /etc/logrotate.d/squid, among postscript and endscript, there is written
> 'squid -k rotate? so you don?t invoke squid rotation too ?!?  We have 2
> rotations?

you are running squid -k rotate in postrotate too, so what is your question?

according to squid docs, squid only reopens log files in "rotate" request,
so logrotate takes care about renaming and compressing files, while squid
only has to reopen them.

>> On 07.12.20 09:12, sampei02 at tiscali.it <mailto:sampei02 at tiscali.it> wrote:
>>> I want to rotate access.log by logrotate system process so I disabled
>>> rotation in squid.conf, logfile_rotate has been set to zero; by logrotate
>>> I can compress log files and to name them with date suffix.
>>
>>> But what I have to write among postrotate and endscript ?  What command to
>>> send to squid to start rotation?
>>
>>> It?s right to write "squid -k rotate" in postrotate section if I wanted to
>>> manage rotation only by logrotate?
>>
>>
>> this is very common on debian-based systems.
>>
>>> This is my /etc/logorotate.d/ file
>>>
>>> var/log/squid/access.log {
>>>       daily
>>>       compress
>>>       rotate 365
>>>       missingok
>>>       nocreate
>>>       sharedscripts
>>>       postrotate
>>> 		 test ! -e /var/run/squid.pid || test ! -x /usr/sbin/squid || /usr/sbin/squid -k rotate 2>/dev/null
>>>       endscript
>>> }

>> On 7 Dec 2020, at 10:08, Matus UHLAR - fantomas <uhlar at fantomas.sk> wrote:
>> are you sure you don't run debian? ;-)
>> I would just like to avoit redirecting stderr to /dev/null
>> - if something bad happens, you should know it and not flush the info
>>
>>
>> /var/log/squid/*.log {
>>       daily
>>       compress
>>       delaycompress
>>       rotate 31
>>       missingok
>>       nocreate
>>       sharedscripts
>>       prerotate
>>               test ! -x /usr/sbin/sarg-reports || /usr/sbin/sarg-reports daily
>>       endscript
>>       postrotate
>>               test ! -e /var/run/squid.pid || test ! -x /usr/sbin/squid || /usr/sbin/squid -k rotate
>>       endscript
>> }

-- 
Matus UHLAR - fantomas, uhlar at fantomas.sk ; http://www.fantomas.sk/
Warning: I wish NOT to receive e-mail advertising to this address.
Varovanie: na tuto adresu chcem NEDOSTAVAT akukolvek reklamnu postu.
Silvester Stallone: Father of the RISC concept.


From sampei02 at tiscali.it  Mon Dec  7 11:52:30 2020
From: sampei02 at tiscali.it (sampei02 at tiscali.it)
Date: Mon, 7 Dec 2020 12:52:30 +0100
Subject: [squid-users] Log rotate
In-Reply-To: <20201207110752.GA23891@fantomas.sk>
References: <993995F4-0721-472B-B964-567DC6B6ACB4@tiscali.it>
 <20201207090807.GB20009@fantomas.sk>
 <182D9B4C-CE07-42CA-90E4-97AB028A9846@tiscali.it>
 <20201207110752.GA23891@fantomas.sk>
Message-ID: <E56BF236-DF0D-48A9-B5AA-A2A030087AD8@tiscali.it>

> doesn't centos come with squid package, including logrotate config?

I manually installed Squid package 4.8-1 by yum utility while logrotate 3.8.6-19 was already installed.

> you are running squid -k rotate in postrotate too, so what is your question?
When I installed Squid package, It?s has been created automatically /etc/logrotate.d/squid as I showed in previous mails and where there is written 'squid -k rotate?. 
My question is: if I use logrotate process why in /etc/logrotate.d/squid is recalled ''squid -k rotate? ?
I thought 'squid -k rotate? started another file rotation in addition to logrotate.


> On 7 Dec 2020, at 12:07, Matus UHLAR - fantomas <uhlar at fantomas.sk> wrote:
> 
> On 07.12.20 10:35, sampei02 at tiscali.it wrote:
>> My OS is Centos 7.
> 
> doesn't centos come with squid package, including logrotate config?
> 
>> But I manage rotation by logrotate, according to your suggestions in
>> /etc/logrotate.d/squid, among postscript and endscript, there is written
>> 'squid -k rotate? so you don?t invoke squid rotation too ?!?  We have 2
>> rotations?
> 
> you are running squid -k rotate in postrotate too, so what is your question?
> 
> according to squid docs, squid only reopens log files in "rotate" request,
> so logrotate takes care about renaming and compressing files, while squid
> only has to reopen them.
> 
>>> On 07.12.20 09:12, sampei02 at tiscali.it <mailto:sampei02 at tiscali.it> wrote:
>>>> I want to rotate access.log by logrotate system process so I disabled
>>>> rotation in squid.conf, logfile_rotate has been set to zero; by logrotate
>>>> I can compress log files and to name them with date suffix.
>>> 
>>>> But what I have to write among postrotate and endscript ?  What command to
>>>> send to squid to start rotation?
>>> 
>>>> It?s right to write "squid -k rotate" in postrotate section if I wanted to
>>>> manage rotation only by logrotate?
>>> 
>>> 
>>> this is very common on debian-based systems.
>>> 
>>>> This is my /etc/logorotate.d/ file
>>>> 
>>>> var/log/squid/access.log {
>>>>      daily
>>>>      compress
>>>>      rotate 365
>>>>      missingok
>>>>      nocreate
>>>>      sharedscripts
>>>>      postrotate
>>>> 		 test ! -e /var/run/squid.pid || test ! -x /usr/sbin/squid || /usr/sbin/squid -k rotate 2>/dev/null
>>>>      endscript
>>>> }
> 
>>> On 7 Dec 2020, at 10:08, Matus UHLAR - fantomas <uhlar at fantomas.sk> wrote:
>>> are you sure you don't run debian? ;-)
>>> I would just like to avoit redirecting stderr to /dev/null
>>> - if something bad happens, you should know it and not flush the info
>>> 
>>> 
>>> /var/log/squid/*.log {
>>>      daily
>>>      compress
>>>      delaycompress
>>>      rotate 31
>>>      missingok
>>>      nocreate
>>>      sharedscripts
>>>      prerotate
>>>              test ! -x /usr/sbin/sarg-reports || /usr/sbin/sarg-reports daily
>>>      endscript
>>>      postrotate
>>>              test ! -e /var/run/squid.pid || test ! -x /usr/sbin/squid || /usr/sbin/squid -k rotate
>>>      endscript
>>> }
> 
> -- 
> Matus UHLAR - fantomas, uhlar at fantomas.sk ; http://www.fantomas.sk/
> Warning: I wish NOT to receive e-mail advertising to this address.
> Varovanie: na tuto adresu chcem NEDOSTAVAT akukolvek reklamnu postu.
> Silvester Stallone: Father of the RISC concept.
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users



From uhlar at fantomas.sk  Mon Dec  7 12:32:13 2020
From: uhlar at fantomas.sk (Matus UHLAR - fantomas)
Date: Mon, 7 Dec 2020 13:32:13 +0100
Subject: [squid-users] Log rotate
In-Reply-To: <E56BF236-DF0D-48A9-B5AA-A2A030087AD8@tiscali.it>
References: <993995F4-0721-472B-B964-567DC6B6ACB4@tiscali.it>
 <20201207090807.GB20009@fantomas.sk>
 <182D9B4C-CE07-42CA-90E4-97AB028A9846@tiscali.it>
 <20201207110752.GA23891@fantomas.sk>
 <E56BF236-DF0D-48A9-B5AA-A2A030087AD8@tiscali.it>
Message-ID: <20201207123213.GA25862@fantomas.sk>

On 07.12.20 12:52, sampei02 at tiscali.it wrote:
>I manually installed Squid package 4.8-1 by yum utility while logrotate 3.8.6-19 was already installed.
>
>> you are running squid -k rotate in postrotate too, so what is your question?

>When I installed Squid package, It?s has been created automatically /etc/logrotate.d/squid as I showed in previous mails and where there is written 'squid -k rotate?.
>My question is: if I use logrotate process why in /etc/logrotate.d/squid is recalled ''squid -k rotate? ?
>I thought 'squid -k rotate? started another file rotation in addition to logrotate.

in such case I answered in my former mail:

>> On 7 Dec 2020, at 12:07, Matus UHLAR - fantomas <uhlar at fantomas.sk> wrote:
>> according to squid docs, squid only reopens log files in "rotate" request,
>> so logrotate takes care about renaming and compressing files, while squid
>> only has to reopen them.

if squid would not reopen log files, it would continue writing to old log
files, no matter if they were renamed, removed, compressed (due to how unix
systems handle files).

reopening log files makes squid to start writing to new files, so the old
logs aren't touched.

-- 
Matus UHLAR - fantomas, uhlar at fantomas.sk ; http://www.fantomas.sk/
Warning: I wish NOT to receive e-mail advertising to this address.
Varovanie: na tuto adresu chcem NEDOSTAVAT akukolvek reklamnu postu.
It's now safe to throw off your computer.


From rousskov at measurement-factory.com  Mon Dec  7 15:08:42 2020
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Mon, 7 Dec 2020 10:08:42 -0500
Subject: [squid-users] FTP proxy
In-Reply-To: <bcd4ac79-8b6d-f558-6b02-92d5ce2c5e9c@netfence.it>
References: <06793b33-283b-0474-1dd0-28a7ab41ba08@netfence.it>
 <5af0fba9-abc3-b2d3-10ec-532b4e7e4398@measurement-factory.com>
 <bcd4ac79-8b6d-f558-6b02-92d5ce2c5e9c@netfence.it>
Message-ID: <9c926211-84aa-148f-a8b5-181afe9baf00@measurement-factory.com>

On 12/7/20 5:03 AM, Andrea Venturoli wrote:

> I'm talking about the ports used by the clients to conect to Squid
> (besides 21), using passive FTP (i.e. those returned by PASV command).

Just to avoid misunderstanding, "those returned by PASV command" should
be interpreted as "ports returned by Squid to the client in response to
the client PASV command". The PASV command itself does not list ports.

When handling a PASV command, Squid creates a listening socket bound to
an ephemeral TCP port selected by the operating system. Ephemeral port
ranges are usually handled by your OS ephemeral ports setting (e.g.,
sysctl net.ipv4.ip_local_port_range).


HTH,

Alex.


From ml at netfence.it  Tue Dec  8 07:50:12 2020
From: ml at netfence.it (Andrea Venturoli)
Date: Tue, 8 Dec 2020 08:50:12 +0100
Subject: [squid-users] FTP proxy
In-Reply-To: <9c926211-84aa-148f-a8b5-181afe9baf00@measurement-factory.com>
References: <06793b33-283b-0474-1dd0-28a7ab41ba08@netfence.it>
 <5af0fba9-abc3-b2d3-10ec-532b4e7e4398@measurement-factory.com>
 <bcd4ac79-8b6d-f558-6b02-92d5ce2c5e9c@netfence.it>
 <9c926211-84aa-148f-a8b5-181afe9baf00@measurement-factory.com>
Message-ID: <a9e38862-4201-5f08-a739-635e4491124e@netfence.it>

On 12/7/20 4:08 PM, Alex Rousskov wrote:
> On 12/7/20 5:03 AM, Andrea Venturoli wrote:
> 
>> I'm talking about the ports used by the clients to conect to Squid
>> (besides 21), using passive FTP (i.e. those returned by PASV command).
> 
> Just to avoid misunderstanding, "those returned by PASV command" should
> be interpreted as "ports returned by Squid to the client in response to
> the client PASV command". The PASV command itself does not list ports.

Yes, that's what I meant.
Thanks for clarifying.



> When handling a PASV command, Squid creates a listening socket bound to
> an ephemeral TCP port selected by the operating system. Ephemeral port
> ranges are usually handled by your OS ephemeral ports setting (e.g.,
> sysctl net.ipv4.ip_local_port_range).

For the record, since I'm not using Linux, but FreeBSD, I guess that 
would be net.inet.ip.portrange.first/net.inet.ip.portrange.last (or, 
possibly, net.inet.ip.portrange.hifirst/net.inet.ip.portrange.hilast, 
I'd have to check the source).

However those are system wide settings; I guess there is no equivalent 
of frox.conf's "PassivePorts" settings, then.

Thanks.


From rousskov at measurement-factory.com  Tue Dec  8 13:48:39 2020
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Tue, 8 Dec 2020 08:48:39 -0500
Subject: [squid-users] FTP proxy
In-Reply-To: <a9e38862-4201-5f08-a739-635e4491124e@netfence.it>
References: <06793b33-283b-0474-1dd0-28a7ab41ba08@netfence.it>
 <5af0fba9-abc3-b2d3-10ec-532b4e7e4398@measurement-factory.com>
 <bcd4ac79-8b6d-f558-6b02-92d5ce2c5e9c@netfence.it>
 <9c926211-84aa-148f-a8b5-181afe9baf00@measurement-factory.com>
 <a9e38862-4201-5f08-a739-635e4491124e@netfence.it>
Message-ID: <8ab07d81-82a0-c307-ee81-ed3676c4a85f@measurement-factory.com>

On 12/8/20 2:50 AM, Andrea Venturoli wrote:
> On 12/7/20 4:08 PM, Alex Rousskov wrote:
>> When handling a PASV command, Squid creates a listening socket bound to
>> an ephemeral TCP port selected by the operating system. Ephemeral port
>> ranges are usually handled by your OS ephemeral ports setting (e.g.,
>> sysctl net.ipv4.ip_local_port_range).

> For the record, since I'm not using Linux, but FreeBSD, I guess that
> would be net.inet.ip.portrange.first/net.inet.ip.portrange.last (or,
> possibly, net.inet.ip.portrange.hifirst/net.inet.ip.portrange.hilast,
> I'd have to check the source).

> However those are system wide settings; I guess there is no equivalent
> of frox.conf's "PassivePorts" settings, then.

Correct. Squid just bind(2)s the listening socket to port zero.

Alex.


From squid-user at tlinx.org  Tue Dec  8 22:14:40 2020
From: squid-user at tlinx.org (L A Walsh)
Date: Tue, 08 Dec 2020 14:14:40 -0800
Subject: [squid-users] replacement for obsoleted cache controls
 (ign-no-cache; ign-must-reval. + ign-auth)
In-Reply-To: <72ece466-d028-f38f-894f-58d46888b010@measurement-factory.com>
References: <5FCCF4C2.6070904@tlinx.org>
 <72ece466-d028-f38f-894f-58d46888b010@measurement-factory.com>
Message-ID: <5FCFFAD0.2090408@tlinx.org>

On 2020/12/06 12:14, Alex Rousskov wrote:
> On 12/6/20 10:12 AM, L A Walsh wrote:
>> Since the early 4.x series and now, the cache control headers:
> 
>> ignore-no-cache
>> ignore-must-revalidate
>> ignore-auth
...
	Thanks for the followup.  One of the main things I try to use
my proxy for is to cache semi-static content like fonts and scripts to 
minimize or eliminate requests for the same resources but from different
sites so owners of those resources may not be as easily able to track a
user as they move across the web.







From squid3 at treenet.co.nz  Thu Dec 10 06:07:24 2020
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Thu, 10 Dec 2020 19:07:24 +1300
Subject: [squid-users] replacement for obsoleted cache controls
 (ign-no-cache; ign-must-reval. + ign-auth)
In-Reply-To: <5FCFFAD0.2090408@tlinx.org>
References: <5FCCF4C2.6070904@tlinx.org>
 <72ece466-d028-f38f-894f-58d46888b010@measurement-factory.com>
 <5FCFFAD0.2090408@tlinx.org>
Message-ID: <5aa039e4-e9a8-9c1a-7226-0e0788634346@treenet.co.nz>

On 9/12/20 11:14 am, L A Walsh wrote:
> On 2020/12/06 12:14, Alex Rousskov wrote:
>> On 12/6/20 10:12 AM, L A Walsh wrote:
>>> Since the early 4.x series and now, the cache control headers:

FTR: Since Squid-3.2

>>
>>> ignore-no-cache
>>> ignore-must-revalidate
>>> ignore-auth
> ...
>  ????Thanks for the followup.? One of the main things I try to use
> my proxy for is to cache semi-static content like fonts and scripts to 
> minimize or eliminate requests for the same resources but from different
> sites so owners of those resources may not be as easily able to track a
> user as they move across the web.
> 

In HTTP/1.1 and later the server is explicitly passed headers from the 
clients request to check whether the cached entry can be used. So 
forcing caching will not help with your requirement. Caching is purely a 
bandwidth saving and (usually) performance improving measure.

For tracking prevention you need to filter out the details (eg headers) 
which servers use for that tracking and fingerprinting.


Amos


From ngtech1ltd at gmail.com  Thu Dec 10 11:49:48 2020
From: ngtech1ltd at gmail.com (Eliezer Croitor)
Date: Thu, 10 Dec 2020 13:49:48 +0200
Subject: [squid-users] Sqlite3 with Squid
Message-ID: <01d001d6ceea$90bbbc60$b2333520$@gmail.com>

Hey,

 

I am wondering what can I use Sqlite3 with squid?

I was thinking about holding some of the config dynamic parts inside sqlite
db (in a specific setup)

And then generate the config file from sqlite.

 

What do you think?

 

Thanks,

Eliezer

 

----

Eliezer Croitoru

Tech Support

Mobile: +972-5-28704261

Email:  <mailto:ngtech1ltd at gmail.com> ngtech1ltd at gmail.com

 

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20201210/e41da0f2/attachment.htm>

From Antony.Stone at squid.open.source.it  Thu Dec 10 11:54:34 2020
From: Antony.Stone at squid.open.source.it (Antony Stone)
Date: Thu, 10 Dec 2020 12:54:34 +0100
Subject: [squid-users] Sqlite3 with Squid
In-Reply-To: <01d001d6ceea$90bbbc60$b2333520$@gmail.com>
References: <01d001d6ceea$90bbbc60$b2333520$@gmail.com>
Message-ID: <202012101254.34602.Antony.Stone@squid.open.source.it>

On Thursday 10 December 2020 at 12:49:48, Eliezer Croitor wrote:

> Hey,
> 
> I am wondering what can I use Sqlite3 with squid?
> 
> I was thinking about holding some of the config dynamic parts inside sqlite
> db (in a specific setup)

Can you give some examples of such "config dynamic parts"?

> And then generate the config file from sqlite.
> 
> What do you think?

I'm not sure I can see what I might want to be dynamic about a Squid 
configuration.

However, you also say "generate the config file from sqlite".

Any reasonable scripting language can do that for you, and then just tell 
Squid to reload the new config file.  Squid doesn't need to know where it came 
from.


Regards,


Antony.

-- 
"Remember: the S in IoT stands for Security."

 - Jan-Piet Mens

                                                   Please reply to the list;
                                                         please *don't* CC me.


From roeeklinger60 at gmail.com  Thu Dec 10 12:02:19 2020
From: roeeklinger60 at gmail.com (roee klinger)
Date: Thu, 10 Dec 2020 14:02:19 +0200
Subject: [squid-users] Squid with more than 128 ports?
Message-ID: <CAGCa14pzD8FvzEMcpE+8R2=W3qYozB91xB6jSW12k8CED04yCw@mail.gmail.com>

Hello,

We have a few Squid proxy servers with a total of around 400 ports, that we
have been connecting to directly so far. We have decided that we want to
add a cloud instance in the middle of the connections, that will
authenticate users and only then send them to the squid instance.

I was thinking of using Squid for that, but we have to use over 400 ports,
and I know Squid has a limit of 128. I also know that it is possible to
build Squid in a way to will enable more ports than 128, but this comes
with a performance hit.

Is it a smart idea to use Squid for this use case or just use a different
proxy software that doesn't have this limitation?

Thanks,
Roee
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20201210/3d59c44c/attachment.htm>

From Antony.Stone at squid.open.source.it  Thu Dec 10 12:28:35 2020
From: Antony.Stone at squid.open.source.it (Antony Stone)
Date: Thu, 10 Dec 2020 13:28:35 +0100
Subject: [squid-users] Squid with more than 128 ports?
In-Reply-To: <CAGCa14pzD8FvzEMcpE+8R2=W3qYozB91xB6jSW12k8CED04yCw@mail.gmail.com>
References: <CAGCa14pzD8FvzEMcpE+8R2=W3qYozB91xB6jSW12k8CED04yCw@mail.gmail.com>
Message-ID: <202012101328.36037.Antony.Stone@squid.open.source.it>

On Thursday 10 December 2020 at 13:02:19, roee klinger wrote:

> Hello,
> 
> We have a few Squid proxy servers with a total of around 400 ports

What do you mean by that?  What are you using 400 ports for?

> We have decided that we want to add a cloud instance in the middle of the
> connections, that will authenticate users and only then send them to the
> squid instance.

What authentication method / protocol do you want to use?

> Is it a smart idea to use Squid for this use case or just use a different
> proxy software that doesn't have this limitation?

I think the best starting point is to ask what sort of authentication you want 
to perform (ie: what is the authoritative system which holds the information 
about who can authenticate and who cannot), then you can decide on the best 
software to use to do that in front of Squid.


Antony.

-- 
Under UK law, no VAT is charged on biscuits and cakes - they are "zero rated".  
Chocolate covered biscuits, however, are classed as "luxury items" and are 
subject to VAT.  McVitie's classed its Jaffa Cakes as cakes, but in 1991 this 
was challenged by Her Majesty's Customs and Excise in court.

The question which had to be answered was what criteria should be used to 
class something as a cake or a biscuit.  McVitie's defended the classification 
of Jaffa Cakes as a cake by arguing that cakes go hard when stale, whereas 
biscuits go soft.  It was demonstrated that Jaffa Cakes become hard when stale 
and McVitie's won the case.

                                                   Please reply to the list;
                                                         please *don't* CC me.


From sampei02 at tiscali.it  Thu Dec 10 14:55:15 2020
From: sampei02 at tiscali.it (sampei02 at tiscali.it)
Date: Thu, 10 Dec 2020 15:55:15 +0100
Subject: [squid-users] authorized by pcname
Message-ID: <8510941D-1AF1-47E7-8D58-2C8853D03538@tiscali.it>

Can I set acl to authorize specific computer name by http_access directive ?
I used usually acl <name<> src <ip> but I?d like to specify Netbios name, so I Thought  as client IP address is sent to squid It?ll be the same thing with pc name.
It?s possible ?

From roeeklinger60 at gmail.com  Thu Dec 10 18:39:22 2020
From: roeeklinger60 at gmail.com (roee klinger)
Date: Thu, 10 Dec 2020 20:39:22 +0200
Subject: [squid-users] Squid with more than 128 ports?
In-Reply-To: <202012101328.36037.Antony.Stone@squid.open.source.it>
References: <CAGCa14pzD8FvzEMcpE+8R2=W3qYozB91xB6jSW12k8CED04yCw@mail.gmail.com>
 <202012101328.36037.Antony.Stone@squid.open.source.it>
Message-ID: <CAGCa14rTaYzMp-X+E_UoJLM3i5+giHKwubuN3nmKmogRct-4Zw@mail.gmail.com>

Hey Anthony,

Giving this a second thought, I believe I didn't explain myself correctly.

I have 5 Squid servers, each listening on 80 ports, I would like to add
another
Squid server in the middle of the client and these servers to
authenticate users
before sending them to their ports. I already have ACL controls and auth
control tools
which I wrote and are working fine.

My question is regarding how to configure this, I have found this
configuration online
but I am not sure how it will work performance-wise with 500+ proxies
(could be 1000s in
the future):

http_port 3128 name=port_3128
> http_port 3127 name=port_3127
> nonhierarchical_direct off
> acl port_3128_acl myportname port_3128
> acl port_3127_acl myportname port_3127
> always_direct deny port_3128_acl
> always_direct deny port_3127_acl
> never_direct allow port_3128_acl
> never_direct allow port_3127_acl
> # 3128
> cache_peer proxy1 parent 3128 0 proxy-only default name=proxy3128
> cache_peer_access proxy3128 allow port_3128_acl
> cache_peer_access proxy3128 deny all
> # 3127
> cache_peer proxy2 parent 3128 0 proxy-only default name=proxy3127
> cache_peer_access proxy3127 allow port_3127_acl
> cache_peer_access proxy3127 deny all


Combine these 2000+ lines in squid.conf with 2 external ACLs and a custom
authenticator,
can this cause a hit on performance or should it be no problem for squid to
handle?






On Thu, Dec 10, 2020 at 2:29 PM Antony Stone <
Antony.Stone at squid.open.source.it> wrote:

> On Thursday 10 December 2020 at 13:02:19, roee klinger wrote:
>
> > Hello,
> >
> > We have a few Squid proxy servers with a total of around 400 ports
>
> What do you mean by that?  What are you using 400 ports for?
>
> > We have decided that we want to add a cloud instance in the middle of the
> > connections, that will authenticate users and only then send them to the
> > squid instance.
>
> What authentication method / protocol do you want to use?
>
> > Is it a smart idea to use Squid for this use case or just use a different
> > proxy software that doesn't have this limitation?
>
> I think the best starting point is to ask what sort of authentication you
> want
> to perform (ie: what is the authoritative system which holds the
> information
> about who can authenticate and who cannot), then you can decide on the
> best
> software to use to do that in front of Squid.
>
>
> Antony.
>
> --
> Under UK law, no VAT is charged on biscuits and cakes - they are "zero
> rated".
> Chocolate covered biscuits, however, are classed as "luxury items" and are
> subject to VAT.  McVitie's classed its Jaffa Cakes as cakes, but in 1991
> this
> was challenged by Her Majesty's Customs and Excise in court.
>
> The question which had to be answered was what criteria should be used to
> class something as a cake or a biscuit.  McVitie's defended the
> classification
> of Jaffa Cakes as a cake by arguing that cakes go hard when stale, whereas
> biscuits go soft.  It was demonstrated that Jaffa Cakes become hard when
> stale
> and McVitie's won the case.
>
>                                                    Please reply to the
> list;
>                                                          please *don't* CC
> me.
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20201210/f5776ec6/attachment.htm>

From ngtech1ltd at gmail.com  Thu Dec 10 21:14:25 2020
From: ngtech1ltd at gmail.com (Eliezer Croitor)
Date: Thu, 10 Dec 2020 23:14:25 +0200
Subject: [squid-users] Squid with more than 128 ports?
In-Reply-To: <CAGCa14rTaYzMp-X+E_UoJLM3i5+giHKwubuN3nmKmogRct-4Zw@mail.gmail.com>
References: <CAGCa14pzD8FvzEMcpE+8R2=W3qYozB91xB6jSW12k8CED04yCw@mail.gmail.com>
 <202012101328.36037.Antony.Stone@squid.open.source.it>
 <CAGCa14rTaYzMp-X+E_UoJLM3i5+giHKwubuN3nmKmogRct-4Zw@mail.gmail.com>
Message-ID: <024701d6cf39$71186d00$53494700$@gmail.com>

You should use Haproxy in a Fail-over setup.

Squid is great but it?s possible that Haproxy does this much better theses days then Squid.

You can leave the authentication on the Squid servers and use the Haproxy as TCP Load balancer.

If you need the clients Original IP address you can use the PROXY protocol to send these details between the haproxy and squid.

 

Eliezer

 

----

Eliezer Croitoru

Tech Support

Mobile: +972-5-28704261

Email: ngtech1ltd at gmail.com <mailto:ngtech1ltd at gmail.com> 

 

From: squid-users <squid-users-bounces at lists.squid-cache.org> On Behalf Of roee klinger
Sent: Thursday, December 10, 2020 8:39 PM
To: squid-users at lists.squid-cache.org
Subject: Re: [squid-users] Squid with more than 128 ports?

 

Hey Anthony,

 

Giving this a second thought, I believe I didn't explain myself correctly.

 

I have 5 Squid servers, each listening on 80 ports, I would like to add another

Squid server in the middle of the client and these servers to authenticate users

before sending them to their ports. I already have ACL controls and auth control tools

which I wrote and are working fine.

 

My question is regarding how to configure this, I have found this configuration online 

but I am not sure how it will work performance-wise with 500+ proxies (could be 1000s in

the future):

 

http_port 3128 name=port_3128
http_port 3127 name=port_3127
nonhierarchical_direct off
acl port_3128_acl myportname port_3128
acl port_3127_acl myportname port_3127
always_direct deny port_3128_acl
always_direct deny port_3127_acl
never_direct allow port_3128_acl
never_direct allow port_3127_acl
# 3128
cache_peer proxy1 parent 3128 0 proxy-only default name=proxy3128
cache_peer_access proxy3128 allow port_3128_acl
cache_peer_access proxy3128 deny all
# 3127
cache_peer proxy2 parent 3128 0 proxy-only default name=proxy3127
cache_peer_access proxy3127 allow port_3127_acl
cache_peer_access proxy3127 deny all

 

Combine these 2000+ lines in squid.conf with 2 external ACLs and a custom authenticator,

can this cause a hit on performance or should it be no problem for squid to handle?

 
 
 

 

 

On Thu, Dec 10, 2020 at 2:29 PM Antony Stone <Antony.Stone at squid.open.source.it <mailto:Antony.Stone at squid.open.source.it> > wrote:

On Thursday 10 December 2020 at 13:02:19, roee klinger wrote:

> Hello,
> 
> We have a few Squid proxy servers with a total of around 400 ports

What do you mean by that?  What are you using 400 ports for?

> We have decided that we want to add a cloud instance in the middle of the
> connections, that will authenticate users and only then send them to the
> squid instance.

What authentication method / protocol do you want to use?

> Is it a smart idea to use Squid for this use case or just use a different
> proxy software that doesn't have this limitation?

I think the best starting point is to ask what sort of authentication you want 
to perform (ie: what is the authoritative system which holds the information 
about who can authenticate and who cannot), then you can decide on the best 
software to use to do that in front of Squid.


Antony.

-- 
Under UK law, no VAT is charged on biscuits and cakes - they are "zero rated".  
Chocolate covered biscuits, however, are classed as "luxury items" and are 
subject to VAT.  McVitie's classed its Jaffa Cakes as cakes, but in 1991 this 
was challenged by Her Majesty's Customs and Excise in court.

The question which had to be answered was what criteria should be used to 
class something as a cake or a biscuit.  McVitie's defended the classification 
of Jaffa Cakes as a cake by arguing that cakes go hard when stale, whereas 
biscuits go soft.  It was demonstrated that Jaffa Cakes become hard when stale 
and McVitie's won the case.

                                                   Please reply to the list;
                                                         please *don't* CC me.
_______________________________________________
squid-users mailing list
squid-users at lists.squid-cache.org <mailto:squid-users at lists.squid-cache.org> 
http://lists.squid-cache.org/listinfo/squid-users

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20201210/2c9a41a3/attachment.htm>

From ngtech1ltd at gmail.com  Thu Dec 10 23:03:00 2020
From: ngtech1ltd at gmail.com (Eliezer Croitor)
Date: Fri, 11 Dec 2020 01:03:00 +0200
Subject: [squid-users] Sqlite3 with Squid
In-Reply-To: <202012101254.34602.Antony.Stone@squid.open.source.it>
References: <01d001d6ceea$90bbbc60$b2333520$@gmail.com>
 <202012101254.34602.Antony.Stone@squid.open.source.it>
Message-ID: <027201d6cf48$9c7cd530$d5767f90$@gmail.com>

Thanks Antony,

>From what I have seen in the past many embedded devices like Android or iPhone or even Firewalls use Sqlite.
It's good for Firmwares..
Let say I am a vendor of a proxy and I want to be able to pull single config file from one device to the other.
Let say for a testing lab, ie I have a specific test case and I need the to test the proxy\fw\firmware.
If I wrote a perl script it would probably work for then next 20++ years.
It's possible to take a proxy firmware and based on the Sqlite re-produce a very similar setup on different hardware.
We can call this similar pretty exact assuming the hardware and the OS are taking care of the relevant lower levels.

Indeed squid doesn't need to know where it came from, however the input can vary from device to device and environment.
Technically speaking we might be able to script with some help couple of these things.
For example Localnet, Manager, Ports, SSL_SAFE Ports, Certificate creation and Input validation scripts.
I believe that these days some things in squid are pretty static.
For example there were some integer overflow that was detected in the past for something.
Once the input validation is done in another separate process we can separate the logic into an external acl helper and ICAP.
The only issue now is the "cache" cleanup cycle.

Amos or Alex might remember or know how to trigger external_acl helper cache cleanup.
I don't know what it might affect since there is some context code per request or connection or session.

Can someone help me only to grasp this concept?

Thanks,
Eliezer

----
Eliezer Croitoru
Tech Support
Mobile: +972-5-28704261
Email: ngtech1ltd at gmail.com

-----Original Message-----
From: squid-users <squid-users-bounces at lists.squid-cache.org> On Behalf Of Antony Stone
Sent: Thursday, December 10, 2020 1:55 PM
To: squid-users at lists.squid-cache.org
Subject: Re: [squid-users] Sqlite3 with Squid

On Thursday 10 December 2020 at 12:49:48, Eliezer Croitor wrote:

> Hey,
> 
> I am wondering what can I use Sqlite3 with squid?
> 
> I was thinking about holding some of the config dynamic parts inside sqlite
> db (in a specific setup)

Can you give some examples of such "config dynamic parts"?

> And then generate the config file from sqlite.
> 
> What do you think?

I'm not sure I can see what I might want to be dynamic about a Squid 
configuration.

However, you also say "generate the config file from sqlite".

Any reasonable scripting language can do that for you, and then just tell 
Squid to reload the new config file.  Squid doesn't need to know where it came 
from.


Regards,


Antony.

-- 
"Remember: the S in IoT stands for Security."

 - Jan-Piet Mens

                                                   Please reply to the list;
                                                         please *don't* CC me.
_______________________________________________
squid-users mailing list
squid-users at lists.squid-cache.org
http://lists.squid-cache.org/listinfo/squid-users



From tpal at numen.mg  Fri Dec 11 06:42:13 2020
From: tpal at numen.mg (Thomas PALFRAY)
Date: Fri, 11 Dec 2020 06:42:13 +0000
Subject: [squid-users] Questions regarding "store-id" made by helper and log
 system
Message-ID: <0190B4114E037F439F4450CC747234EF015FC34067@srvmail22.numen.mg>

Hi everyone !

I'm trying to use a helper to make custom < store-id > for some requests.
The idea is to increase HIT on theses request types.

Here is some example of my helper input/output :

http://myproject-prod.myhost.com:8080/current/cmis/browser/myproject_prod/root?succinct=true&streamId=207698&nvltToken=27348686-4a4e-4d1e-b3b4-62a7243f5207&publicCache=1296000&cmisselector=content&objectId=146662

OK store-id=http://myproject-prod.myhost.com:8080/current/cmis/browser/myproject_prod/root?cmisselector=content&objectId=146662&streamId=207698&succinct=true

http://myproject-prod.myhost.com:8080/current/cmis/browser/myproject_prod/root?succinct=true&streamId=207698&publicCache=1296000&cmisselector=content&objectId=146662

OK store-id=http://myproject-prod.myhost.com:8080/current/cmis/browser/myproject_prod/root?cmisselector=content&objectId=146662&streamId=207698&succinct=true

I update the squid.conf like this :
store_id_program /usr/local/bin/urlSort2
store_id_children 25 startup=15 idle=5 concurrency=0

And restart the service.

I see urlSort2 in ram using ps so i guess it's called by squid and returning modified store-id :
[root at xxx ~]# ps -eaf | grep urlSort2
squid     15788  15749  0 08:58 ?        00:00:00 (urlSort2)



When i look into access.log and store.log, i see this :

Access.log :
1607599918.911   1245 10.101.20.53 TCP_MISS/200 128832 GET http://myproject-prod.myhost.com:8080/current/cmis/browser/myproject_prod/root?succinct=true&streamId=207698&nvltToken=27348686-4a4e-4d1e-b3b4-62a7243f5207&publicCache=1296000&cmisselector=content&objectId=146662 user HIER_DIRECT/xxx.xxx.xxx.xxx image/jpeg

Store.log :
1607666419.148 SWAPOUT 00 00000543 791B7B07B8004584E9432DA2444EED74  200 1607666417        -1 1608962417 image/jpeg 97165/97165 GET http://myproject-prod.myhost.com:8080/current/cmis/browser/myproject_prod/root?succinct=true&streamId=194324&nvltToken=72f33f50-f267-4025-a373-7b1a00cfe500&publicCache=1296000&cmisselector=content&objectId=129520

When i call the first request of my example of output help, then the second, i get a MISS.
I suppose that there's not using the same store-id.

So i have two questions :

  1.  Is the log system of squid display (or can display) store-id, or only url request ? I didn't found information about this on the documentation.
  2.  Why i get only MISS, and how be sure that the helper is correctly use ?

BR,

Thomas PALFRAY

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20201211/7d8de0d7/attachment.htm>

From sampei02 at tiscali.it  Fri Dec 11 06:48:03 2020
From: sampei02 at tiscali.it (sampei02 at tiscali.it)
Date: Fri, 11 Dec 2020 07:48:03 +0100
Subject: [squid-users] dhcp
Message-ID: <3704C659-E7E6-47C5-8EB3-AD45DF323212@tiscali.it>

Can you suggest way to manage acl for clients which are using DHCP server?


From roeeklinger60 at gmail.com  Fri Dec 11 11:22:52 2020
From: roeeklinger60 at gmail.com (roee klinger)
Date: Fri, 11 Dec 2020 13:22:52 +0200
Subject: [squid-users] Squid with more than 128 ports?
In-Reply-To: <024701d6cf39$71186d00$53494700$@gmail.com>
References: <024701d6cf39$71186d00$53494700$@gmail.com>
Message-ID: <707FCD08-4459-4131-85C6-57CB92886A19@gmail.com>

Hey Eliezer,

Thanks, but actually what I want to achieve is not dynamic load balancing, I want each user to always go to a predefined proxy.

For a failover solution, I will have an outside program checking for failed proxies, and then I will remove them from the list and send the user to a different proxy while I handle the failed ones.

Is Haproxy good for that it is Squid in the way I proposed OK?

Thanks

> 
> On Dec 10, 2020, at 23:14, Eliezer Croitor <ngtech1ltd at gmail.com> wrote:
> 
> ?
> You should use Haproxy in a Fail-over setup.
> Squid is great but it?s possible that Haproxy does this much better theses days then Squid.
> You can leave the authentication on the Squid servers and use the Haproxy as TCP Load balancer.
> If you need the clients Original IP address you can use the PROXY protocol to send these details between the haproxy and squid.
>  
> Eliezer
>  
> ----
> Eliezer Croitoru
> Tech Support
> Mobile: +972-5-28704261
> Email: ngtech1ltd at gmail.com
>  
> From: squid-users <squid-users-bounces at lists.squid-cache.org> On Behalf Of roee klinger
> Sent: Thursday, December 10, 2020 8:39 PM
> To: squid-users at lists.squid-cache.org
> Subject: Re: [squid-users] Squid with more than 128 ports?
>  
> Hey Anthony,
>  
> Giving this a second thought, I believe I didn't explain myself correctly.
>  
> I have 5 Squid servers, each listening on 80 ports, I would like to add another
> Squid server in the middle of the client and these servers to authenticate users
> before sending them to their ports. I already have ACL controls and auth control tools
> which I wrote and are working fine.
>  
> My question is regarding how to configure this, I have found this configuration online 
> but I am not sure how it will work performance-wise with 500+ proxies (could be 1000s in
> the future):
>  
> http_port 3128 name=port_3128
> http_port 3127 name=port_3127
> nonhierarchical_direct off
> acl port_3128_acl myportname port_3128
> acl port_3127_acl myportname port_3127
> always_direct deny port_3128_acl
> always_direct deny port_3127_acl
> never_direct allow port_3128_acl
> never_direct allow port_3127_acl
> # 3128
> cache_peer proxy1 parent 3128 0 proxy-only default name=proxy3128
> cache_peer_access proxy3128 allow port_3128_acl
> cache_peer_access proxy3128 deny all
> # 3127
> cache_peer proxy2 parent 3128 0 proxy-only default name=proxy3127
> cache_peer_access proxy3127 allow port_3127_acl
> cache_peer_access proxy3127 deny all
>  
> Combine these 2000+ lines in squid.conf with 2 external ACLs and a custom authenticator,
> can this cause a hit on performance or should it be no problem for squid to handle?
>  
>  
>  
>  
>  
> On Thu, Dec 10, 2020 at 2:29 PM Antony Stone <Antony.Stone at squid.open.source.it> wrote:
> On Thursday 10 December 2020 at 13:02:19, roee klinger wrote:
> 
> > Hello,
> > 
> > We have a few Squid proxy servers with a total of around 400 ports
> 
> What do you mean by that?  What are you using 400 ports for?
> 
> > We have decided that we want to add a cloud instance in the middle of the
> > connections, that will authenticate users and only then send them to the
> > squid instance.
> 
> What authentication method / protocol do you want to use?
> 
> > Is it a smart idea to use Squid for this use case or just use a different
> > proxy software that doesn't have this limitation?
> 
> I think the best starting point is to ask what sort of authentication you want 
> to perform (ie: what is the authoritative system which holds the information 
> about who can authenticate and who cannot), then you can decide on the best 
> software to use to do that in front of Squid.
> 
> 
> Antony.
> 
> -- 
> Under UK law, no VAT is charged on biscuits and cakes - they are "zero rated".  
> Chocolate covered biscuits, however, are classed as "luxury items" and are 
> subject to VAT.  McVitie's classed its Jaffa Cakes as cakes, but in 1991 this 
> was challenged by Her Majesty's Customs and Excise in court.
> 
> The question which had to be answered was what criteria should be used to 
> class something as a cake or a biscuit.  McVitie's defended the classification 
> of Jaffa Cakes as a cake by arguing that cakes go hard when stale, whereas 
> biscuits go soft.  It was demonstrated that Jaffa Cakes become hard when stale 
> and McVitie's won the case.
> 
>                                                    Please reply to the list;
>                                                          please *don't* CC me.
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20201211/ef00e00a/attachment.htm>

From rousskov at measurement-factory.com  Fri Dec 11 15:01:00 2020
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Fri, 11 Dec 2020 10:01:00 -0500
Subject: [squid-users] Questions regarding "store-id" made by helper and
 log system
In-Reply-To: <0190B4114E037F439F4450CC747234EF015FC34067@srvmail22.numen.mg>
References: <0190B4114E037F439F4450CC747234EF015FC34067@srvmail22.numen.mg>
Message-ID: <5b2ae867-2950-4d5e-8120-7a8e9705ba23@measurement-factory.com>

On 12/11/20 1:42 AM, Thomas PALFRAY wrote:

> When i call the first request of my example of output help, then the
> second, i get a MISS.

For a more complete picture, I would test with four sequential requests,
two with one URL and two with another.


> I suppose that there?s not using the same store-id.

That is one of many possibilities. Your best bet may be to examine Squid
debugging log to understand whether the right Store ID is computed for
each request and, if yes, why the second request misses. See
debug_options in squid.conf.documented.

If setting debug_options to "ALL,7" overwhelms you with noise, try
something like "ALL,3 33,7 47,7 61,7 85,7". If you cannot figure it out,
then use "ALL,9" and share a pointer to compressed cache.log containing
just the two transactions (to start with).


HTH,

Alex.


From tpal at numen.mg  Fri Dec 11 15:11:09 2020
From: tpal at numen.mg (Thomas PALFRAY)
Date: Fri, 11 Dec 2020 15:11:09 +0000
Subject: [squid-users] Questions regarding "store-id" made by helper and
 log system
In-Reply-To: <5b2ae867-2950-4d5e-8120-7a8e9705ba23@measurement-factory.com>
References: <0190B4114E037F439F4450CC747234EF015FC34067@srvmail22.numen.mg>
 <5b2ae867-2950-4d5e-8120-7a8e9705ba23@measurement-factory.com>
Message-ID: <0190B4114E037F439F4450CC747234EF015FC35408@srvmail22.numen.mg>

Hi Alex,

Thanks for your quick answer.

> For a more complete picture, I would test with four sequential requests, two with one URL and two with another.

I get a HIT for the two request when i retry each one which let me think than the store-id computed is not the one from the helper but the plain url.

I also tried to force each request to go through my helper with " store_id_bypass off"
When I do that performance go dramatically down (i have around 400 users behind squid).

>That is one of many possibilities. Your best bet may be to examine Squid debugging log to understand whether the right Store ID is computed for each request and, if yes, why the second request misses. See debug_options in squid.conf.documented.
>If setting debug_options to "ALL,7" overwhelms you with noise, try something like "ALL,3 33,7 47,7 61,7 85,7". If you cannot figure it out, then use "ALL,9" and share a pointer to compressed cache.log containing just the two transactions (to start with).

Ok i will try these settings, i let you know.

BR,

Thomas PALFRAY

-----Message d'origine-----
De?: Alex Rousskov <rousskov at measurement-factory.com> 
Envoy??: vendredi 11 d?cembre 2020 18:01
??: Thomas PALFRAY <tpal at numen.mg>; squid-users at lists.squid-cache.org
Objet?: Re: [squid-users] Questions regarding "store-id" made by helper and log system

On 12/11/20 1:42 AM, Thomas PALFRAY wrote:

> When i call the first request of my example of output help, then the 
> second, i get a MISS.

For a more complete picture, I would test with four sequential requests, two with one URL and two with another.


> I suppose that there's not using the same store-id.

That is one of many possibilities. Your best bet may be to examine Squid debugging log to understand whether the right Store ID is computed for each request and, if yes, why the second request misses. See debug_options in squid.conf.documented.

If setting debug_options to "ALL,7" overwhelms you with noise, try something like "ALL,3 33,7 47,7 61,7 85,7". If you cannot figure it out, then use "ALL,9" and share a pointer to compressed cache.log containing just the two transactions (to start with).


HTH,

Alex.


From squid3 at treenet.co.nz  Fri Dec 11 18:27:42 2020
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Sat, 12 Dec 2020 07:27:42 +1300
Subject: [squid-users] dhcp
In-Reply-To: <3704C659-E7E6-47C5-8EB3-AD45DF323212@tiscali.it>
References: <3704C659-E7E6-47C5-8EB3-AD45DF323212@tiscali.it>
Message-ID: <f60b192e-9a58-3c3c-3d7a-a404b379710f@treenet.co.nz>

On 11/12/20 7:48 pm, sampei02 wrote:
> Can you suggest way to manage acl for clients which are using DHCP server?

Firstly, what does DHCP have to do with clients using HTTP ?

eg, why is it even a consideration for you?


Secondly, what are you trying to have Squid do?

To provide help we need information about what your situation is.

Amos


From sampei02 at tiscali.it  Sat Dec 12 09:34:56 2020
From: sampei02 at tiscali.it (sampei02 at tiscali.it)
Date: Sat, 12 Dec 2020 10:34:56 +0100
Subject: [squid-users] dhcp
In-Reply-To: <f60b192e-9a58-3c3c-3d7a-a404b379710f@treenet.co.nz>
References: <3704C659-E7E6-47C5-8EB3-AD45DF323212@tiscali.it>
 <f60b192e-9a58-3c3c-3d7a-a404b379710f@treenet.co.nz>
Message-ID: <0CF1C9EB-E8D1-44EE-A1A0-DFD5DD0C2E0D@tiscali.it>

I?m using Squid to permit or deny to clients to access to Internet (http/https traffic). 
Squid is dmz and It?s using my public DNS to solve names.
Clients are in Microsoft domain.
Client browser is configured to point squid service on 3128 port to access external network (local addresses are bypassed)  and inside squid.conf I?m referencing clients by IP address because until yesterday I used static addresses.
Today I?m going to use DHCP server too, e.g. for notebook, so I?ll use dynamic addresses too.
So I?d like to manage dynamic address to permit/deny Internet access in the same way.
I thought to specify "pc name?, instead of IP address, in squid.conf but Squid server has set DNS public, so It cannot to resolve client name. 
Thanks


> On 11 Dec 2020, at 19:27, Amos Jeffries <squid3 at treenet.co.nz> wrote:
> 
> On 11/12/20 7:48 pm, sampei02 wrote:
>> Can you suggest way to manage acl for clients which are using DHCP server?
> 
> Firstly, what does DHCP have to do with clients using HTTP ?
> 
> eg, why is it even a consideration for you?
> 
> 
> Secondly, what are you trying to have Squid do?
> 
> To provide help we need information about what your situation is.
> 
> Amos
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users



From squid3 at treenet.co.nz  Sat Dec 12 09:48:59 2020
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Sat, 12 Dec 2020 22:48:59 +1300
Subject: [squid-users] authorized by pcname
In-Reply-To: <8510941D-1AF1-47E7-8D58-2C8853D03538@tiscali.it>
References: <8510941D-1AF1-47E7-8D58-2C8853D03538@tiscali.it>
Message-ID: <2cce1d9b-d21b-3c27-23eb-e97057ac4b01@treenet.co.nz>

On 11/12/20 3:55 am, sampei02 wrote:
> Can I set acl to authorize specific computer name by http_access directive ?

Maybe. That depends on whether there is any mechanism for Squid to 
identify the "computer name".



> I used usually acl <name<> src <ip> but I?d like to specify Netbios name, so I Thought  as client IP address is sent to squid It?ll be the same thing with pc name.


Your thought is both right and wrong.

NetBOIS name plays the same role as IP address - both are the "address" 
of the client machine in their relevant protocols.

However, Squid does not use or implement NetBIOS protocol to talk to 
clients. Squid only uses IP based protocols.

Sometimes NTLM credentials contain the NetBIOS name of a "NetBIOS node" 
machine.

Or IDENT protocol can be used to directly query the client about its 
name. *IF* that protocol is supported and enabled on the client.


Amos


From squid3 at treenet.co.nz  Sat Dec 12 09:56:12 2020
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Sat, 12 Dec 2020 22:56:12 +1300
Subject: [squid-users] Sqlite3 with Squid
In-Reply-To: <027201d6cf48$9c7cd530$d5767f90$@gmail.com>
References: <01d001d6ceea$90bbbc60$b2333520$@gmail.com>
 <202012101254.34602.Antony.Stone@squid.open.source.it>
 <027201d6cf48$9c7cd530$d5767f90$@gmail.com>
Message-ID: <c26bda3b-3634-8b05-2fa9-8ab442133fb7@treenet.co.nz>

On 11/12/20 12:03 pm, Eliezer Croitor wrote:
> Amos or Alex might remember or know how to trigger external_acl helper cache cleanup.
> I don't know what it might affect since there is some context code per request or connection or session.
> 

"squid -k reconfigure" is the best trigger I know of.


> Can someone help me only to grasp this concept?

Like Antony I am not quite understanding what the concept you are trying 
to describe is. It sounds a lot like what tools like Puppet do for 
network wide management.

Amos


From sampei02 at tiscali.it  Sat Dec 12 13:03:23 2020
From: sampei02 at tiscali.it (sampei02 at tiscali.it)
Date: Sat, 12 Dec 2020 14:03:23 +0100
Subject: [squid-users] authorized by pcname
In-Reply-To: <2cce1d9b-d21b-3c27-23eb-e97057ac4b01@treenet.co.nz>
References: <8510941D-1AF1-47E7-8D58-2C8853D03538@tiscali.it>
 <2cce1d9b-d21b-3c27-23eb-e97057ac4b01@treenet.co.nz>
Message-ID: <913BEDBF-CD00-4353-B419-246DF9D1C1C5@tiscali.it>

What Squid mechanism do you suggest me to identify the ?computer name? ?
What solution/corretion can I make to my environment to apply my idea?



> On 12 Dec 2020, at 10:48, Amos Jeffries <squid3 at treenet.co.nz> wrote:
> 
> On 11/12/20 3:55 am, sampei02 wrote:
>> Can I set acl to authorize specific computer name by http_access directive ?
> 
> Maybe. That depends on whether there is any mechanism for Squid to identify the "computer name".
> 
> 
> 
>> I used usually acl <name<> src <ip> but I?d like to specify Netbios name, so I Thought  as client IP address is sent to squid It?ll be the same thing with pc name.
> 
> 
> Your thought is both right and wrong.
> 
> NetBOIS name plays the same role as IP address - both are the "address" of the client machine in their relevant protocols.
> 
> However, Squid does not use or implement NetBIOS protocol to talk to clients. Squid only uses IP based protocols.
> 
> Sometimes NTLM credentials contain the NetBIOS name of a "NetBIOS node" machine.
> 
> Or IDENT protocol can be used to directly query the client about its name. *IF* that protocol is supported and enabled on the client.
> 
> 
> Amos
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users



From Antony.Stone at squid.open.source.it  Sat Dec 12 13:20:13 2020
From: Antony.Stone at squid.open.source.it (Antony Stone)
Date: Sat, 12 Dec 2020 14:20:13 +0100
Subject: [squid-users] authorized by pcname
In-Reply-To: <913BEDBF-CD00-4353-B419-246DF9D1C1C5@tiscali.it>
References: <8510941D-1AF1-47E7-8D58-2C8853D03538@tiscali.it>
 <2cce1d9b-d21b-3c27-23eb-e97057ac4b01@treenet.co.nz>
 <913BEDBF-CD00-4353-B419-246DF9D1C1C5@tiscali.it>
Message-ID: <202012121420.13336.Antony.Stone@squid.open.source.it>

On Saturday 12 December 2020 at 14:03:23, sampei02 at tiscali.it wrote:

> What Squid mechanism do you suggest me to identify the ?computer name? ?
> What solution/corretion can I make to my environment to apply my idea?

A few suggestions:

1. Why not get your DHCP server to allocate IP addresses according to MAC 
address; then your clients will get fixed addresses again and you can use those 
in your ACLs.

2. Alternatively, get your DHCP server to update a local DNS server, and point 
Squid at that so that it can look up the names of the PCs in DNS (without 
needing to know about NetBIOS) and you can use those.

3. Get your users to authenticate to Squid as people, not as computers; then 
you can apply the appropriate rules for who is trying to do stuff instead of 
assuming who is using which computer.

4. Why have you switched from static addressing to DHCP?  If you need DHCP to 
cater for machines which "temporarily visit" your network, how about just 
allocating a subnet range for those and continue to use static addresses for 
the machines you know about?


Regards,


Antony.

-- 
A good conversation is like a miniskirt;
short enought to retain interest,
but long enough to cover the subject.

 - Celeste Headlee


                                                   Please reply to the list;
                                                         please *don't* CC me.


From ngtech1ltd at gmail.com  Sat Dec 12 22:01:30 2020
From: ngtech1ltd at gmail.com (Eliezer Croitor)
Date: Sun, 13 Dec 2020 00:01:30 +0200
Subject: [squid-users] Sqlite3 with Squid
In-Reply-To: <c26bda3b-3634-8b05-2fa9-8ab442133fb7@treenet.co.nz>
References: <01d001d6ceea$90bbbc60$b2333520$@gmail.com>
 <202012101254.34602.Antony.Stone@squid.open.source.it>
 <027201d6cf48$9c7cd530$d5767f90$@gmail.com>
 <c26bda3b-3634-8b05-2fa9-8ab442133fb7@treenet.co.nz>
Message-ID: <008d01d6d0d2$59dfd840$0d9f88c0$@gmail.com>

Well indeed it's very similar.
I would need to think about it a bit more to grasp it again in my mind.
However in the embedded world ruby/perl/python are not usually available so..

----
Eliezer Croitoru
Tech Support
Mobile: +972-5-28704261
Email: ngtech1ltd at gmail.com

-----Original Message-----
From: squid-users <squid-users-bounces at lists.squid-cache.org> On Behalf Of Amos Jeffries
Sent: Saturday, December 12, 2020 11:56 AM
To: squid-users at lists.squid-cache.org
Subject: Re: [squid-users] Sqlite3 with Squid

On 11/12/20 12:03 pm, Eliezer Croitor wrote:
> Amos or Alex might remember or know how to trigger external_acl helper cache cleanup.
> I don't know what it might affect since there is some context code per request or connection or session.
> 

"squid -k reconfigure" is the best trigger I know of.


> Can someone help me only to grasp this concept?

Like Antony I am not quite understanding what the concept you are trying 
to describe is. It sounds a lot like what tools like Puppet do for 
network wide management.

Amos
_______________________________________________
squid-users mailing list
squid-users at lists.squid-cache.org
http://lists.squid-cache.org/listinfo/squid-users



From ngtech1ltd at gmail.com  Sat Dec 12 22:08:04 2020
From: ngtech1ltd at gmail.com (Eliezer Croitor)
Date: Sun, 13 Dec 2020 00:08:04 +0200
Subject: [squid-users] Squid with more than 128 ports?
In-Reply-To: <707FCD08-4459-4131-85C6-57CB92886A19@gmail.com>
References: <024701d6cf39$71186d00$53494700$@gmail.com>
 <707FCD08-4459-4131-85C6-57CB92886A19@gmail.com>
Message-ID: <009101d6d0d3$44776300$cd662900$@gmail.com>

You can use 2 squid servers with VRRP Infront of the other proxies.

I would advise you to learn a little about haproxy authentication methods.

There is a possibility that you will be able to do somethings you haven?t done until now.

 

Eliezer

 

----

Eliezer Croitoru

Tech Support

Mobile: +972-5-28704261

Email: ngtech1ltd at gmail.com <mailto:ngtech1ltd at gmail.com> 

 

From: roee klinger <roeeklinger60 at gmail.com> 
Sent: Friday, December 11, 2020 1:23 PM
To: Eliezer Croitor <ngtech1ltd at gmail.com>; squid-users at lists.squid-cache.org
Subject: Re: [squid-users] Squid with more than 128 ports?

 

Hey Eliezer,

 

Thanks, but actually what I want to achieve is not dynamic load balancing, I want each user to always go to a predefined proxy.

 

For a failover solution, I will have an outside program checking for failed proxies, and then I will remove them from the list and send the user to a different proxy while I handle the failed ones.

 

Is Haproxy good for that it is Squid in the way I proposed OK?

 

Thanks

 


On Dec 10, 2020, at 23:14, Eliezer Croitor <ngtech1ltd at gmail.com <mailto:ngtech1ltd at gmail.com> > wrote:

?

You should use Haproxy in a Fail-over setup.

Squid is great but it?s possible that Haproxy does this much better theses days then Squid.

You can leave the authentication on the Squid servers and use the Haproxy as TCP Load balancer.

If you need the clients Original IP address you can use the PROXY protocol to send these details between the haproxy and squid.

 

Eliezer

 

----

Eliezer Croitoru

Tech Support

Mobile: +972-5-28704261

Email: ngtech1ltd at gmail.com <mailto:ngtech1ltd at gmail.com> 

 

From: squid-users <squid-users-bounces at lists.squid-cache.org <mailto:squid-users-bounces at lists.squid-cache.org> > On Behalf Of roee klinger
Sent: Thursday, December 10, 2020 8:39 PM
To: squid-users at lists.squid-cache.org <mailto:squid-users at lists.squid-cache.org> 
Subject: Re: [squid-users] Squid with more than 128 ports?

 

Hey Anthony,

 

Giving this a second thought, I believe I didn't explain myself correctly.

 

I have 5 Squid servers, each listening on 80 ports, I would like to add another

Squid server in the middle of the client and these servers to authenticate users

before sending them to their ports. I already have ACL controls and auth control tools

which I wrote and are working fine.

 

My question is regarding how to configure this, I have found this configuration online 

but I am not sure how it will work performance-wise with 500+ proxies (could be 1000s in

the future):

 

http_port 3128 name=port_3128
http_port 3127 name=port_3127
nonhierarchical_direct off
acl port_3128_acl myportname port_3128
acl port_3127_acl myportname port_3127
always_direct deny port_3128_acl
always_direct deny port_3127_acl
never_direct allow port_3128_acl
never_direct allow port_3127_acl
# 3128
cache_peer proxy1 parent 3128 0 proxy-only default name=proxy3128
cache_peer_access proxy3128 allow port_3128_acl
cache_peer_access proxy3128 deny all
# 3127
cache_peer proxy2 parent 3128 0 proxy-only default name=proxy3127
cache_peer_access proxy3127 allow port_3127_acl
cache_peer_access proxy3127 deny all

 

Combine these 2000+ lines in squid.conf with 2 external ACLs and a custom authenticator,

can this cause a hit on performance or should it be no problem for squid to handle?

 
 
 

 

 

On Thu, Dec 10, 2020 at 2:29 PM Antony Stone <Antony.Stone at squid.open.source.it <mailto:Antony.Stone at squid.open.source.it> > wrote:

On Thursday 10 December 2020 at 13:02:19, roee klinger wrote:

> Hello,
> 
> We have a few Squid proxy servers with a total of around 400 ports

What do you mean by that?  What are you using 400 ports for?

> We have decided that we want to add a cloud instance in the middle of the
> connections, that will authenticate users and only then send them to the
> squid instance.

What authentication method / protocol do you want to use?

> Is it a smart idea to use Squid for this use case or just use a different
> proxy software that doesn't have this limitation?

I think the best starting point is to ask what sort of authentication you want 
to perform (ie: what is the authoritative system which holds the information 
about who can authenticate and who cannot), then you can decide on the best 
software to use to do that in front of Squid.


Antony.

-- 
Under UK law, no VAT is charged on biscuits and cakes - they are "zero rated".  
Chocolate covered biscuits, however, are classed as "luxury items" and are 
subject to VAT.  McVitie's classed its Jaffa Cakes as cakes, but in 1991 this 
was challenged by Her Majesty's Customs and Excise in court.

The question which had to be answered was what criteria should be used to 
class something as a cake or a biscuit.  McVitie's defended the classification 
of Jaffa Cakes as a cake by arguing that cakes go hard when stale, whereas 
biscuits go soft.  It was demonstrated that Jaffa Cakes become hard when stale 
and McVitie's won the case.

                                                   Please reply to the list;
                                                         please *don't* CC me.
_______________________________________________
squid-users mailing list
squid-users at lists.squid-cache.org <mailto:squid-users at lists.squid-cache.org> 
http://lists.squid-cache.org/listinfo/squid-users

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20201213/72f46130/attachment.htm>

From sampei02 at tiscali.it  Sun Dec 13 09:44:20 2020
From: sampei02 at tiscali.it (sampei02 at tiscali.it)
Date: Sun, 13 Dec 2020 10:44:20 +0100
Subject: [squid-users] authorized by pcname
In-Reply-To: <202012121420.13336.Antony.Stone@squid.open.source.it>
References: <8510941D-1AF1-47E7-8D58-2C8853D03538@tiscali.it>
 <2cce1d9b-d21b-3c27-23eb-e97057ac4b01@treenet.co.nz>
 <913BEDBF-CD00-4353-B419-246DF9D1C1C5@tiscali.it>
 <202012121420.13336.Antony.Stone@squid.open.source.it>
Message-ID: <940492A0-C48B-4561-A08A-8AE1ABC6C807@tiscali.it>

Thanks for your suggestions.
1. In this way I should move problem to another level that is dhcp server.
2. My DHCP server already updates to local DNS, that is Active Directory, but Squid cannot point to this local Microsoft DNS because It?s using external DNS. I have two DNS: Microsoft DNS (AD) for resolve intranet addresses and Linux DNS (public network) to resolve Internet address. Squid uses last DNS.
3. I?m not interesting, I thought already to it.
4.I didn?t switch to DHCP. dhcp is a further service. I?m using dhcp from few months and I?ll use it only for notebook.

When client asks url to Squid, is there way to capture the ?client name? and to check the match to acl? Does It exist trusted application to integrate into Squid to make it?

> On 12 Dec 2020, at 14:20, Antony Stone <Antony.Stone at squid.open.source.it> wrote:
> 
> On Saturday 12 December 2020 at 14:03:23, sampei02 at tiscali.it wrote:
> 
>> What Squid mechanism do you suggest me to identify the ?computer name? ?
>> What solution/corretion can I make to my environment to apply my idea?
> 
> A few suggestions:
> 
> 1. Why not get your DHCP server to allocate IP addresses according to MAC 
> address; then your clients will get fixed addresses again and you can use those 
> in your ACLs.
> 
> 2. Alternatively, get your DHCP server to update a local DNS server, and point 
> Squid at that so that it can look up the names of the PCs in DNS (without 
> needing to know about NetBIOS) and you can use those.
> 
> 3. Get your users to authenticate to Squid as people, not as computers; then 
> you can apply the appropriate rules for who is trying to do stuff instead of 
> assuming who is using which computer.
> 
> 4. Why have you switched from static addressing to DHCP?  If you need DHCP to 
> cater for machines which "temporarily visit" your network, how about just 
> allocating a subnet range for those and continue to use static addresses for 
> the machines you know about?
> 
> 
> Regards,
> 
> 
> Antony.
> 
> -- 
> A good conversation is like a miniskirt;
> short enought to retain interest,
> but long enough to cover the subject.
> 
> - Celeste Headlee
> 
> 
>                                                   Please reply to the list;
>                                                         please *don't* CC me.
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users



From squid3 at treenet.co.nz  Sun Dec 13 10:15:14 2020
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Sun, 13 Dec 2020 23:15:14 +1300
Subject: [squid-users] authorized by pcname
In-Reply-To: <940492A0-C48B-4561-A08A-8AE1ABC6C807@tiscali.it>
References: <8510941D-1AF1-47E7-8D58-2C8853D03538@tiscali.it>
 <2cce1d9b-d21b-3c27-23eb-e97057ac4b01@treenet.co.nz>
 <913BEDBF-CD00-4353-B419-246DF9D1C1C5@tiscali.it>
 <202012121420.13336.Antony.Stone@squid.open.source.it>
 <940492A0-C48B-4561-A08A-8AE1ABC6C807@tiscali.it>
Message-ID: <473a37c9-8be2-ebab-6705-c6f60bc9147d@treenet.co.nz>

On 13/12/20 10:44 pm, sampei02 wrote:
> Thanks for your suggestions.
> 1. In this way I should move problem to another level that is dhcp server.
> 2. My DHCP server already updates to local DNS, that is Active Directory, but Squid cannot point to this local Microsoft DNS because It?s using external DNS. I have two DNS: Microsoft DNS (AD) for resolve intranet addresses and Linux DNS (public network) to resolve Internet address. Squid uses last DNS.

Your recursive resolver (the Linux DNS) should be configured to forward 
queries about the local networks IP range(s) used by DHCP to the 
Microsoft DNS resolver.

Squid should make its queries to the Linux one and get the necessary 
information back about the clients.


> 
> When client asks url to Squid, is there way to capture the ?client name? and to check the match to acl? Does It exist trusted application to integrate into Squid to make it?
> 

That depends on what type of name you are looking for and what protocols 
are available. Humans like to apply names to things and each protocol 
has its own version of one, is the situation gets complicated and messy.

As mentioned already if you can avoid having things depend on "machine 
name" it will help simplify the situation a lot.

Squid should be able to identify the IP ranges that are used by internal 
clients vs others. It can make simple denials based on the IP range.



As a last resort, there is no need to make the policy decision directly 
in squid.conf. You can have an external ACL helper that gets passed some 
details from Squid and tells Squid what to do. That helper could be 
given the URL and client IP - do a lookup in *both* DNS resolvers and 
pass back to Squid whether it is to be allowed (OK) or not (ERR).


Amos


From squid3 at treenet.co.nz  Sun Dec 13 10:27:43 2020
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Sun, 13 Dec 2020 23:27:43 +1300
Subject: [squid-users] Sqlite3 with Squid
In-Reply-To: <008d01d6d0d2$59dfd840$0d9f88c0$@gmail.com>
References: <01d001d6ceea$90bbbc60$b2333520$@gmail.com>
 <202012101254.34602.Antony.Stone@squid.open.source.it>
 <027201d6cf48$9c7cd530$d5767f90$@gmail.com>
 <c26bda3b-3634-8b05-2fa9-8ab442133fb7@treenet.co.nz>
 <008d01d6d0d2$59dfd840$0d9f88c0$@gmail.com>
Message-ID: <075e6baf-0766-cb9c-7902-6bb49d1b4fcf@treenet.co.nz>

On 13/12/20 11:01 am, Eliezer Croitor wrote:
> Well indeed it's very similar.
> I would need to think about it a bit more to grasp it again in my mind.
> However in the embedded world ruby/perl/python are not usually available so..
> 

True. Though for limited devices you can do the same thing they do to 
transfer a pre-built squid.conf (and included files) with scp or just 
telnet.

My understanding is that tools using sqlite like you describe are also 
using it internally for config and/or data storage anyway. Squid is not, 
so it is also in the category of "not usually available" for us.

Long-term we have a wishlist entry to make the cachemgr API accept POST 
requests with config lines to add/replace to its running configuration.


Amos


From ngtech1ltd at gmail.com  Sun Dec 13 12:33:00 2020
From: ngtech1ltd at gmail.com (Eliezer Croitor)
Date: Sun, 13 Dec 2020 14:33:00 +0200
Subject: [squid-users] Sqlite3 with Squid
In-Reply-To: <075e6baf-0766-cb9c-7902-6bb49d1b4fcf@treenet.co.nz>
References: <01d001d6ceea$90bbbc60$b2333520$@gmail.com>
 <202012101254.34602.Antony.Stone@squid.open.source.it>
 <027201d6cf48$9c7cd530$d5767f90$@gmail.com>
 <c26bda3b-3634-8b05-2fa9-8ab442133fb7@treenet.co.nz>
 <008d01d6d0d2$59dfd840$0d9f88c0$@gmail.com>
 <075e6baf-0766-cb9c-7902-6bb49d1b4fcf@treenet.co.nz>
Message-ID: <007a01d6d14c$18f49490$4addbdb0$@gmail.com>

I am not sure I understood but if I understand right, then probably it's better to know add config using POST.
It's better to write some dynamic ACL external helper that  can read config files with ttl of 10-20 seconds.
This will give the overall experience a GOOD ENOUGH.

So the squid is not directly accessible? 

Thanks!

----
Eliezer Croitoru
Tech Support
Mobile: +972-5-28704261
Email: ngtech1ltd at gmail.com

-----Original Message-----
From: squid-users <squid-users-bounces at lists.squid-cache.org> On Behalf Of Amos Jeffries
Sent: Sunday, December 13, 2020 12:28 PM
To: squid-users at lists.squid-cache.org
Subject: Re: [squid-users] Sqlite3 with Squid

On 13/12/20 11:01 am, Eliezer Croitor wrote:
> Well indeed it's very similar.
> I would need to think about it a bit more to grasp it again in my mind.
> However in the embedded world ruby/perl/python are not usually available so..
> 

True. Though for limited devices you can do the same thing they do to 
transfer a pre-built squid.conf (and included files) with scp or just 
telnet.

My understanding is that tools using sqlite like you describe are also 
using it internally for config and/or data storage anyway. Squid is not, 
so it is also in the category of "not usually available" for us.

Long-term we have a wishlist entry to make the cachemgr API accept POST 
requests with config lines to add/replace to its running configuration.


Amos
_______________________________________________
squid-users mailing list
squid-users at lists.squid-cache.org
http://lists.squid-cache.org/listinfo/squid-users



From ngtech1ltd at gmail.com  Sun Dec 13 20:11:02 2020
From: ngtech1ltd at gmail.com (Eliezer Croitor)
Date: Sun, 13 Dec 2020 22:11:02 +0200
Subject: [squid-users] sslcrtvalidator_program
Message-ID: <!&!AAAAAAAAAAAuAAAAAAAAAGg7dk9mYqJGhbBt3m/ghGwBAMO2jhD3dRHOtM0AqgC7tuYAAAAAAA4AABAAAACjNZPYF6/+Qof0xJIlu+dJAQAAAAA=@gmail.com>

I am trying to understand the way the sslcrtvalidator_program  works.
I am pretty sure I have asked this in the past but didn?t found it for some
reason.

I want to read line by line so.
/^-----BEGIN?CERTIFICATE-----$/
***
/^-----END?CERTIFICATE-----$/

What else should I look for? I was thinking about validating with some extra
values in the request, for example ip/domain:port and sni.
Are these available in some way?

Thanks,
Eliezer

----
Eliezer Croitoru
Tech Support
Mobile: +972-5-28704261
Email: ngtech1ltd at gmail.com




From squid3 at treenet.co.nz  Mon Dec 14 08:15:16 2020
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Mon, 14 Dec 2020 21:15:16 +1300
Subject: [squid-users] sslcrtvalidator_program
In-Reply-To: <!&!AAAAAAAAAAAuAAAAAAAAAGg7dk9mYqJGhbBt3m/ghGwBAMO2jhD3dRHOtM0AqgC7tuYAAAAAAA4AABAAAACjNZPYF6/+Qof0xJIlu+dJAQAAAAA=@gmail.com>
References: <!&!AAAAAAAAAAAuAAAAAAAAAGg7dk9mYqJGhbBt3m/ghGwBAMO2jhD3dRHOtM0AqgC7tuYAAAAAAA4AABAAAACjNZPYF6/+Qof0xJIlu+dJAQAAAAA=@gmail.com>
Message-ID: <e1f6a657-5f5f-3c17-c9da-b28e03d50a42@treenet.co.nz>

On 14/12/20 9:11 am, Eliezer Croitor wrote:
> I am trying to understand the way the sslcrtvalidator_program  works.
> I am pretty sure I have asked this in the past but didn?t found it for some
> reason.
> 
> I want to read line by line so.
> /^-----BEGIN?CERTIFICATE-----$/
> ***
> /^-----END?CERTIFICATE-----$/
> 
> What else should I look for? I was thinking about validating with some extra
> values in the request, for example ip/domain:port and sni.
> Are these available in some way?


The details you need are all here:

 
<https://wiki.squid-cache.org/Features/AddonHelpers#SSL_server_certificate_validator>

Notice that it receives chains of certificates - maybe several, and/or 
out of order. Whatever the client sends.


Amos


From ngtech1ltd at gmail.com  Mon Dec 14 09:26:51 2020
From: ngtech1ltd at gmail.com (Eliezer Croitor)
Date: Mon, 14 Dec 2020 11:26:51 +0200
Subject: [squid-users] sslcrtvalidator_program
In-Reply-To: <e1f6a657-5f5f-3c17-c9da-b28e03d50a42@treenet.co.nz>
References: <!&!AAAAAAAAAAAuAAAAAAAAAGg7dk9mYqJGhbBt3m/ghGwBAMO2jhD3dRHOtM0AqgC7tuYAAAAAAA4AABAAAACjNZPYF6/+Qof0xJIlu+dJAQAAAAA=@gmail.com>
 <e1f6a657-5f5f-3c17-c9da-b28e03d50a42@treenet.co.nz>
Message-ID: <02e201d6d1fb$41d06060$c5712120$@gmail.com>

So starts with:
0 cert_validate... line

And ends with?:
error_name_0=X509_V_ERR_DEPTH_ZERO_SELF_SIGNED_CERT
error_cert_0=cert0
?

I am unsure, let me try to re-read this section.
I am missing a fake helper for this..
And a "real world" full example.

Can someone simulate it for me?

Thanks,
Eliezer

----
Eliezer Croitoru
Tech Support
Mobile: +972-5-28704261
Email: ngtech1ltd at gmail.com

-----Original Message-----
From: squid-users <squid-users-bounces at lists.squid-cache.org> On Behalf Of Amos Jeffries
Sent: Monday, December 14, 2020 10:15 AM
To: squid-users at lists.squid-cache.org
Subject: Re: [squid-users] sslcrtvalidator_program

On 14/12/20 9:11 am, Eliezer Croitor wrote:
> I am trying to understand the way the sslcrtvalidator_program  works.
> I am pretty sure I have asked this in the past but didn?t found it for some
> reason.
> 
> I want to read line by line so.
> /^-----BEGIN CERTIFICATE-----$/
> ***
> /^-----END CERTIFICATE-----$/
> 
> What else should I look for? I was thinking about validating with some extra
> values in the request, for example ip/domain:port and sni.
> Are these available in some way?


The details you need are all here:

 
<https://wiki.squid-cache.org/Features/AddonHelpers#SSL_server_certificate_validator>

Notice that it receives chains of certificates - maybe several, and/or 
out of order. Whatever the client sends.


Amos
_______________________________________________
squid-users mailing list
squid-users at lists.squid-cache.org
http://lists.squid-cache.org/listinfo/squid-users



From ngtech1ltd at gmail.com  Mon Dec 14 11:12:20 2020
From: ngtech1ltd at gmail.com (Eliezer Croitor)
Date: Mon, 14 Dec 2020 13:12:20 +0200
Subject: [squid-users] sslcrtvalidator_program
In-Reply-To: <02e201d6d1fb$41d06060$c5712120$@gmail.com>
References: <!&!AAAAAAAAAAAuAAAAAAAAAGg7dk9mYqJGhbBt3m/ghGwBAMO2jhD3dRHOtM0AqgC7tuYAAAAAAA4AABAAAACjNZPYF6/+Qof0xJIlu+dJAQAAAAA=@gmail.com>
 <e1f6a657-5f5f-3c17-c9da-b28e03d50a42@treenet.co.nz>
 <02e201d6d1fb$41d06060$c5712120$@gmail.com>
Message-ID: <030c01d6d209$fe44f900$faceeb00$@gmail.com>

Found the helper at:

https://github.com/squid-cache/squid/blob/9837567dd913854a4deddcc49043bfd7631ab63f/src/security/cert_validators/fake/security_fake_certverify.pl.in


----
Eliezer Croitoru
Tech Support
Mobile: +972-5-28704261
Email: ngtech1ltd at gmail.com

-----Original Message-----
From: Eliezer Croitor <ngtech1ltd at gmail.com> 
Sent: Monday, December 14, 2020 11:27 AM
To: 'Amos Jeffries' <squid3 at treenet.co.nz>
Cc: squid-users at lists.squid-cache.org
Subject: RE: [squid-users] sslcrtvalidator_program

So starts with:
0 cert_validate... line

And ends with?:
error_name_0=X509_V_ERR_DEPTH_ZERO_SELF_SIGNED_CERT
error_cert_0=cert0
?

I am unsure, let me try to re-read this section.
I am missing a fake helper for this..
And a "real world" full example.

Can someone simulate it for me?

Thanks,
Eliezer

----
Eliezer Croitoru
Tech Support
Mobile: +972-5-28704261
Email: ngtech1ltd at gmail.com

-----Original Message-----
From: squid-users <squid-users-bounces at lists.squid-cache.org> On Behalf Of Amos Jeffries
Sent: Monday, December 14, 2020 10:15 AM
To: squid-users at lists.squid-cache.org
Subject: Re: [squid-users] sslcrtvalidator_program

On 14/12/20 9:11 am, Eliezer Croitor wrote:
> I am trying to understand the way the sslcrtvalidator_program  works.
> I am pretty sure I have asked this in the past but didn?t found it for some
> reason.
> 
> I want to read line by line so.
> /^-----BEGIN CERTIFICATE-----$/
> ***
> /^-----END CERTIFICATE-----$/
> 
> What else should I look for? I was thinking about validating with some extra
> values in the request, for example ip/domain:port and sni.
> Are these available in some way?


The details you need are all here:

 
<https://wiki.squid-cache.org/Features/AddonHelpers#SSL_server_certificate_validator>

Notice that it receives chains of certificates - maybe several, and/or 
out of order. Whatever the client sends.


Amos
_______________________________________________
squid-users mailing list
squid-users at lists.squid-cache.org
http://lists.squid-cache.org/listinfo/squid-users




From roierachamim at gmail.com  Mon Dec 14 13:29:02 2020
From: roierachamim at gmail.com (roie rachamim)
Date: Mon, 14 Dec 2020 15:29:02 +0200
Subject: [squid-users] Adding header with destination IP to icap server via
 adaptation_meta
Message-ID: <CAD=NrcA1Thoxn5=yiUAGQDCNOExx73if5MPXftDkcT0kOKcEOA@mail.gmail.com>

Hi,

I was trying to add the value via:

adaptation_meta X-PKuku-Dst-IP "%<a" all

But in the ICAP server i can only see a dash (-)
Any issue with my configuration ?

Many Thanks,
Roie
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20201214/c4758e06/attachment.htm>

From klaus at westkamp.net  Mon Dec 14 15:03:53 2020
From: klaus at westkamp.net (Klaus Westkamp)
Date: Mon, 14 Dec 2020 16:03:53 +0100
Subject: [squid-users] Squid for Windows: negotiate_kerberos_auth helper
 seems to leak(?) handles
Message-ID: <dbd232bc-9dcf-4e4f-28b7-54c91dd85f5f@westkamp.net>

Hi,

i'm uncertain, wether this mailing list is the correct one to ask, but i 
have the disputable honor to make a squid running on a Windows Server 
(if possible). Whilst squid.exe seems to run fine, i constantly run into 
an unresponsive system, when i enable Kerberos authentication via 
auth_param and the negotiate_kerberos_auth.exe helper.

For a while authentication works fine, but all at the sudden the system 
hangs at 100% CPU usage. My Observation is that one of the 
negotiate_kerberos_auth.exe processes has a constantly increasing number 
of handles (Files and events). If i understand the Sysinternals handle 
tool correctly, most handles are event corrolated.

The setting:

Windows 2012 R2 AD Controllers with Windows 2008R2 Domain Level. A 
Windows Server 2016 running Squid 3.5 for Windows. The squid server is a 
VM running on HyperV with 8 Gigs of RAM and 4 vCPUs. The AD Controllers 
are HP Systems with 24 Cores and 64 GByte of RAM.

Any Suggestions, besides changing to Linux, as inn that case the 
customer will favor to look for another proxy,(Sigh) that i might follow.


Best Regards,

Klaus Westkamp



From ngtech1ltd at gmail.com  Mon Dec 14 16:24:00 2020
From: ngtech1ltd at gmail.com (Eliezer Croitor)
Date: Mon, 14 Dec 2020 18:24:00 +0200
Subject: [squid-users] Adding header with destination IP to icap server
 via adaptation_meta
In-Reply-To: <CAD=NrcA1Thoxn5=yiUAGQDCNOExx73if5MPXftDkcT0kOKcEOA@mail.gmail.com>
References: <CAD=NrcA1Thoxn5=yiUAGQDCNOExx73if5MPXftDkcT0kOKcEOA@mail.gmail.com>
Message-ID: <000501d6d235$88e72e40$9ab58ac0$@gmail.com>

Have you tried to use this format log in the logfomat?

I do not remember by heart but I what I see is the docs is:

http://www.squid-cache.org/Versions/v4/cfgman/logformat.html

 

logformat squid      %ts.%03tu %6tr %>a %Ss/%03>Hs %<st %rm %ru %[un %Sh/%<a %mt

 

so it should work.

However I do not see logformat example in the docs at:

http://www.squid-cache.org/Versions/v4/cfgman/adaptation_meta.html

 

so +1 here.

 

Thanks,

Eliezer

 

----

Eliezer Croitoru

Tech Support

Mobile: +972-5-28704261

Email:  <mailto:eliezer at ngtech.co.il> eliezer at ngtech.co.il

 

From: squid-users <squid-users-bounces at lists.squid-cache.org> On Behalf Of roie rachamim
Sent: Monday, December 14, 2020 3:29 PM
To: squid-users at lists.squid-cache.org
Subject: [squid-users] Adding header with destination IP to icap server via adaptation_meta

 

Hi,

 

I was trying to add the value via:

adaptation_meta X-PKuku-Dst-IP "%<a" all

 

But in the ICAP server i can only see a dash (-)

Any issue with my configuration ?

 

Many Thanks,

Roie

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20201214/3d49de6a/attachment.htm>

From roierachamim at gmail.com  Mon Dec 14 16:32:30 2020
From: roierachamim at gmail.com (roie rachamim)
Date: Mon, 14 Dec 2020 18:32:30 +0200
Subject: [squid-users] Adding header with destination IP to icap server
 via adaptation_meta
In-Reply-To: <000501d6d235$88e72e40$9ab58ac0$@gmail.com>
References: <CAD=NrcA1Thoxn5=yiUAGQDCNOExx73if5MPXftDkcT0kOKcEOA@mail.gmail.com>
 <000501d6d235$88e72e40$9ab58ac0$@gmail.com>
Message-ID: <CAD=NrcCCXKvSPNP3zpiB2R2BA42FAhx45NZomiHq5QZxhby5sw@mail.gmail.com>

In access.log this format indeed works

On Mon, Dec 14, 2020, 18:24 Eliezer Croitor <ngtech1ltd at gmail.com> wrote:

> Have you tried to use this format log in the logfomat?
>
> I do not remember by heart but I what I see is the docs is:
>
> http://www.squid-cache.org/Versions/v4/cfgman/logformat.html
>
>
>
> logformat squid      %ts.%03tu %6tr %>a %Ss/%03>Hs %<st %rm %ru %[un
> %Sh/%<a %mt
>
>
>
> so it should work.
>
> However I do not see logformat example in the docs at:
>
> http://www.squid-cache.org/Versions/v4/cfgman/adaptation_meta.html
>
>
>
> so +1 here.
>
>
>
> Thanks,
>
> Eliezer
>
>
>
> ----
>
> Eliezer Croitoru
>
> Tech Support
>
> Mobile: +972-5-28704261
>
> Email: eliezer at ngtech.co.il
>
>
>
> *From:* squid-users <squid-users-bounces at lists.squid-cache.org> *On
> Behalf Of *roie rachamim
> *Sent:* Monday, December 14, 2020 3:29 PM
> *To:* squid-users at lists.squid-cache.org
> *Subject:* [squid-users] Adding header with destination IP to icap server
> via adaptation_meta
>
>
>
> Hi,
>
>
>
> I was trying to add the value via:
>
> adaptation_meta X-PKuku-Dst-IP "%<a" all
>
>
>
> But in the ICAP server i can only see a dash (-)
>
> Any issue with my configuration ?
>
>
>
> Many Thanks,
>
> Roie
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20201214/c38c5cec/attachment.htm>

From rousskov at measurement-factory.com  Mon Dec 14 16:41:54 2020
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Mon, 14 Dec 2020 11:41:54 -0500
Subject: [squid-users] sslcrtvalidator_program
In-Reply-To: <02e201d6d1fb$41d06060$c5712120$@gmail.com>
References: <!&!AAAAAAAAAAAuAAAAAAAAAGg7dk9mYqJGhbBt3m/ghGwBAMO2jhD3dRHOtM0AqgC7tuYAAAAAAA4AABAAAACjNZPYF6/+Qof0xJIlu+dJAQAAAAA=@gmail.com>
 <e1f6a657-5f5f-3c17-c9da-b28e03d50a42@treenet.co.nz>
 <02e201d6d1fb$41d06060$c5712120$@gmail.com>
Message-ID: <23c4a121-c464-e276-b359-f0b5a7262e2f@measurement-factory.com>

On 12/14/20 4:26 AM, Eliezer Croitor wrote:
> So starts with:
> 0 cert_validate... line

> And ends with?:
> error_name_0=X509_V_ERR_DEPTH_ZERO_SELF_SIGNED_CERT
> error_cert_0=cert0
> ?

No. The size of the key=value block is specified on the first request
line. Please try to follow documentation that Amos has pointed you to:
https://wiki.squid-cache.org/Features/AddonHelpers#SSL_server_certificate_validator

If that documentation is missing some details, we should fix it.



> I am unsure, let me try to re-read this section.
> I am missing a fake helper for this..
> And a "real world" full example.

> Can someone simulate it for me?

Glad you found
src/security/cert_validators/fake/security_fake_certverify.pl.in. I hope
it still works!


HTH,

Alex.


> -----Original Message-----
> From: squid-users <squid-users-bounces at lists.squid-cache.org> On Behalf Of Amos Jeffries
> Sent: Monday, December 14, 2020 10:15 AM
> To: squid-users at lists.squid-cache.org
> Subject: Re: [squid-users] sslcrtvalidator_program
> 
> On 14/12/20 9:11 am, Eliezer Croitor wrote:
>> I am trying to understand the way the sslcrtvalidator_program  works.
>> I am pretty sure I have asked this in the past but didn?t found it for some
>> reason.
>>
>> I want to read line by line so.
>> /^-----BEGIN CERTIFICATE-----$/
>> ***
>> /^-----END CERTIFICATE-----$/
>>
>> What else should I look for? I was thinking about validating with some extra
>> values in the request, for example ip/domain:port and sni.
>> Are these available in some way?
> 
> 
> The details you need are all here:
> 
>  
> <https://wiki.squid-cache.org/Features/AddonHelpers#SSL_server_certificate_validator>
> 
> Notice that it receives chains of certificates - maybe several, and/or 
> out of order. Whatever the client sends.
> 
> 
> Amos
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users
> 
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users
> 



From rousskov at measurement-factory.com  Mon Dec 14 16:50:50 2020
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Mon, 14 Dec 2020 11:50:50 -0500
Subject: [squid-users] Adding header with destination IP to icap server
 via adaptation_meta
In-Reply-To: <CAD=NrcA1Thoxn5=yiUAGQDCNOExx73if5MPXftDkcT0kOKcEOA@mail.gmail.com>
References: <CAD=NrcA1Thoxn5=yiUAGQDCNOExx73if5MPXftDkcT0kOKcEOA@mail.gmail.com>
Message-ID: <47e77eb6-da50-79c0-aa91-bfd7ccbc92c7@measurement-factory.com>

On 12/14/20 8:29 AM, roie rachamim wrote:

> I was trying to add the value via:

> adaptation_meta X-PKuku-Dst-IP "%<a" all

> But in the ICAP server i can only see a dash (-)
> Any issue with my configuration ?

Probably not. Most likely, Squid did not know the destination IP address
of the Squid-to-HTTP-server connection when it generated that ICAP
request. If that was a REQMOD request, then this is to be expected. If
that was a RESPMOD request, then this could be a Squid bug.


HTH,

Alex.


From ngtech1ltd at gmail.com  Mon Dec 14 18:04:04 2020
From: ngtech1ltd at gmail.com (Eliezer Croitor)
Date: Mon, 14 Dec 2020 20:04:04 +0200
Subject: [squid-users] dhcp
In-Reply-To: <0CF1C9EB-E8D1-44EE-A1A0-DFD5DD0C2E0D@tiscali.it>
References: <3704C659-E7E6-47C5-8EB3-AD45DF323212@tiscali.it>
 <f60b192e-9a58-3c3c-3d7a-a404b379710f@treenet.co.nz>
 <0CF1C9EB-E8D1-44EE-A1A0-DFD5DD0C2E0D@tiscali.it>
Message-ID: <005501d6d243$83522990$89f67cb0$@gmail.com>

Hey,

I do not know exactly how and on what environment but usually it's done with a Radius server.
Maybe with 802.x integration in the switch level to make sure that no one is un-accounted for in the network.

Eliezer

----
Eliezer Croitoru
Tech Support
Mobile: +972-5-28704261
Email: eliezer at ngtech.co.il

-----Original Message-----
From: squid-users <squid-users-bounces at lists.squid-cache.org> On Behalf Of sampei02 at tiscali.it
Sent: Saturday, December 12, 2020 11:35 AM
To: squid-users at lists.squid-cache.org
Subject: Re: [squid-users] dhcp

I?m using Squid to permit or deny to clients to access to Internet (http/https traffic). 
Squid is dmz and It?s using my public DNS to solve names.
Clients are in Microsoft domain.
Client browser is configured to point squid service on 3128 port to access external network (local addresses are bypassed)  and inside squid.conf I?m referencing clients by IP address because until yesterday I used static addresses.
Today I?m going to use DHCP server too, e.g. for notebook, so I?ll use dynamic addresses too.
So I?d like to manage dynamic address to permit/deny Internet access in the same way.
I thought to specify "pc name?, instead of IP address, in squid.conf but Squid server has set DNS public, so It cannot to resolve client name. 
Thanks


> On 11 Dec 2020, at 19:27, Amos Jeffries <squid3 at treenet.co.nz> wrote:
> 
> On 11/12/20 7:48 pm, sampei02 wrote:
>> Can you suggest way to manage acl for clients which are using DHCP server?
> 
> Firstly, what does DHCP have to do with clients using HTTP ?
> 
> eg, why is it even a consideration for you?
> 
> 
> Secondly, what are you trying to have Squid do?
> 
> To provide help we need information about what your situation is.
> 
> Amos
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users

_______________________________________________
squid-users mailing list
squid-users at lists.squid-cache.org
http://lists.squid-cache.org/listinfo/squid-users



From ngtech1ltd at gmail.com  Mon Dec 14 18:55:55 2020
From: ngtech1ltd at gmail.com (Eliezer Croitor)
Date: Mon, 14 Dec 2020 20:55:55 +0200
Subject: [squid-users] sslcrtvalidator_program
In-Reply-To: <23c4a121-c464-e276-b359-f0b5a7262e2f@measurement-factory.com>
References: <!&!AAAAAAAAAAAuAAAAAAAAAGg7dk9mYqJGhbBt3m/ghGwBAMO2jhD3dRHOtM0AqgC7tuYAAAAAAA4AABAAAACjNZPYF6/+Qof0xJIlu+dJAQAAAAA=@gmail.com>
 <e1f6a657-5f5f-3c17-c9da-b28e03d50a42@treenet.co.nz>
 <02e201d6d1fb$41d06060$c5712120$@gmail.com>
 <23c4a121-c464-e276-b359-f0b5a7262e2f@measurement-factory.com>
Message-ID: <005701d6d24a$c194dde0$44be99a0$@gmail.com>

Seems to work:
This one output stream.
We can use this as an example for a single transaction in the wiki:
https://gist.githubusercontent.com/elico/a0397c879776336eeae569317015edc1/raw/b34dff8ece76e480007a950655efff3564afcccc/cache.log

Let me know if it's enough to document this subject.

Thanks,
Eliezer

----
Eliezer Croitoru
Tech Support
Mobile: +972-5-28704261
Email: eliezer at ngtech.co.il

-----Original Message-----
From: Alex Rousskov <rousskov at measurement-factory.com> 
Sent: Monday, December 14, 2020 6:42 PM
To: squid-users at lists.squid-cache.org
Cc: Eliezer Croitor <ngtech1ltd at gmail.com>
Subject: Re: [squid-users] sslcrtvalidator_program

On 12/14/20 4:26 AM, Eliezer Croitor wrote:
> So starts with:
> 0 cert_validate... line

> And ends with?:
> error_name_0=X509_V_ERR_DEPTH_ZERO_SELF_SIGNED_CERT
> error_cert_0=cert0
> ?

No. The size of the key=value block is specified on the first request
line. Please try to follow documentation that Amos has pointed you to:
https://wiki.squid-cache.org/Features/AddonHelpers#SSL_server_certificate_validator

If that documentation is missing some details, we should fix it.



> I am unsure, let me try to re-read this section.
> I am missing a fake helper for this..
> And a "real world" full example.

> Can someone simulate it for me?

Glad you found
src/security/cert_validators/fake/security_fake_certverify.pl.in. I hope
it still works!


HTH,

Alex.


> -----Original Message-----
> From: squid-users <squid-users-bounces at lists.squid-cache.org> On Behalf Of Amos Jeffries
> Sent: Monday, December 14, 2020 10:15 AM
> To: squid-users at lists.squid-cache.org
> Subject: Re: [squid-users] sslcrtvalidator_program
> 
> On 14/12/20 9:11 am, Eliezer Croitor wrote:
>> I am trying to understand the way the sslcrtvalidator_program  works.
>> I am pretty sure I have asked this in the past but didn?t found it for some
>> reason.
>>
>> I want to read line by line so.
>> /^-----BEGIN CERTIFICATE-----$/
>> ***
>> /^-----END CERTIFICATE-----$/
>>
>> What else should I look for? I was thinking about validating with some extra
>> values in the request, for example ip/domain:port and sni.
>> Are these available in some way?
> 
> 
> The details you need are all here:
> 
>  
> <https://wiki.squid-cache.org/Features/AddonHelpers#SSL_server_certificate_validator>
> 
> Notice that it receives chains of certificates - maybe several, and/or 
> out of order. Whatever the client sends.
> 
> 
> Amos
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users
> 
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users
> 




From rousskov at measurement-factory.com  Mon Dec 14 19:05:13 2020
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Mon, 14 Dec 2020 14:05:13 -0500
Subject: [squid-users] sslcrtvalidator_program
In-Reply-To: <005701d6d24a$c194dde0$44be99a0$@gmail.com>
References: <!&!AAAAAAAAAAAuAAAAAAAAAGg7dk9mYqJGhbBt3m/ghGwBAMO2jhD3dRHOtM0AqgC7tuYAAAAAAA4AABAAAACjNZPYF6/+Qof0xJIlu+dJAQAAAAA=@gmail.com>
 <e1f6a657-5f5f-3c17-c9da-b28e03d50a42@treenet.co.nz>
 <02e201d6d1fb$41d06060$c5712120$@gmail.com>
 <23c4a121-c464-e276-b359-f0b5a7262e2f@measurement-factory.com>
 <005701d6d24a$c194dde0$44be99a0$@gmail.com>
Message-ID: <518aa67f-dcb7-e822-e54f-f2392a03ee5e@measurement-factory.com>

On 12/14/20 1:55 PM, Eliezer Croitor wrote:

> We can use this as an example for a single transaction in the wiki:
> https://gist.githubusercontent.com/elico/a0397c879776336eeae569317015edc1/raw/b34dff8ece76e480007a950655efff3564afcccc/cache.log

> Let me know if it's enough to document this subject.

I am not sure I understand your question -- the format is already
documented. If you think that attaching an example of a raw helper
request to that wiki page would help others, please feel free to do so!
Just avoid the implication that all helper requests would have the same
set of fields.

Alex.


> -----Original Message-----
> From: Alex Rousskov <rousskov at measurement-factory.com> 
> Sent: Monday, December 14, 2020 6:42 PM
> To: squid-users at lists.squid-cache.org
> Cc: Eliezer Croitor <ngtech1ltd at gmail.com>
> Subject: Re: [squid-users] sslcrtvalidator_program
> 
> On 12/14/20 4:26 AM, Eliezer Croitor wrote:
>> So starts with:
>> 0 cert_validate... line
> 
>> And ends with?:
>> error_name_0=X509_V_ERR_DEPTH_ZERO_SELF_SIGNED_CERT
>> error_cert_0=cert0
>> ?
> 
> No. The size of the key=value block is specified on the first request
> line. Please try to follow documentation that Amos has pointed you to:
> https://wiki.squid-cache.org/Features/AddonHelpers#SSL_server_certificate_validator
> 
> If that documentation is missing some details, we should fix it.
> 
> 
> 
>> I am unsure, let me try to re-read this section.
>> I am missing a fake helper for this..
>> And a "real world" full example.
> 
>> Can someone simulate it for me?
> 
> Glad you found
> src/security/cert_validators/fake/security_fake_certverify.pl.in. I hope
> it still works!
> 
> 
> HTH,
> 
> Alex.
> 
> 
>> -----Original Message-----
>> From: squid-users <squid-users-bounces at lists.squid-cache.org> On Behalf Of Amos Jeffries
>> Sent: Monday, December 14, 2020 10:15 AM
>> To: squid-users at lists.squid-cache.org
>> Subject: Re: [squid-users] sslcrtvalidator_program
>>
>> On 14/12/20 9:11 am, Eliezer Croitor wrote:
>>> I am trying to understand the way the sslcrtvalidator_program  works.
>>> I am pretty sure I have asked this in the past but didn?t found it for some
>>> reason.
>>>
>>> I want to read line by line so.
>>> /^-----BEGIN CERTIFICATE-----$/
>>> ***
>>> /^-----END CERTIFICATE-----$/
>>>
>>> What else should I look for? I was thinking about validating with some extra
>>> values in the request, for example ip/domain:port and sni.
>>> Are these available in some way?
>>
>>
>> The details you need are all here:
>>
>>  
>> <https://wiki.squid-cache.org/Features/AddonHelpers#SSL_server_certificate_validator>
>>
>> Notice that it receives chains of certificates - maybe several, and/or 
>> out of order. Whatever the client sends.
>>
>>
>> Amos
>> _______________________________________________
>> squid-users mailing list
>> squid-users at lists.squid-cache.org
>> http://lists.squid-cache.org/listinfo/squid-users
>>
>> _______________________________________________
>> squid-users mailing list
>> squid-users at lists.squid-cache.org
>> http://lists.squid-cache.org/listinfo/squid-users
>>
> 



From ngtech1ltd at gmail.com  Mon Dec 14 19:15:17 2020
From: ngtech1ltd at gmail.com (Eliezer Croitor)
Date: Mon, 14 Dec 2020 21:15:17 +0200
Subject: [squid-users] sslcrtvalidator_program
In-Reply-To: <518aa67f-dcb7-e822-e54f-f2392a03ee5e@measurement-factory.com>
References: <!&!AAAAAAAAAAAuAAAAAAAAAGg7dk9mYqJGhbBt3m/ghGwBAMO2jhD3dRHOtM0AqgC7tuYAAAAAAA4AABAAAACjNZPYF6/+Qof0xJIlu+dJAQAAAAA=@gmail.com>
 <e1f6a657-5f5f-3c17-c9da-b28e03d50a42@treenet.co.nz>
 <02e201d6d1fb$41d06060$c5712120$@gmail.com>
 <23c4a121-c464-e276-b359-f0b5a7262e2f@measurement-factory.com>
 <005701d6d24a$c194dde0$44be99a0$@gmail.com>
 <518aa67f-dcb7-e822-e54f-f2392a03ee5e@measurement-factory.com>
Message-ID: <006601d6d24d$76021110$62063330$@gmail.com>

Hey Alex,

Indeed the format is documented.
However I didn't managed to use the wiki to understand how to parse a single transaction.
I wrote a simple ruby helper but squid claims it crashes rapidly.

Since probably nobody else is willing to do some pipelining job I assume it's on me...
I will try later on the next year to write some ruby code that will make sense to others as well.

I understand what you are saying/writing but from what I see some in the market do not want to pay.
I do not know the reason for this and I am ok in general with BSD style but..
Look at: https://artica-proxy.com/about-webfiltering/

They want a specific price, Should I start charging for my work?

Thanks,
Eliezer

----
Eliezer Croitoru
Tech Support
Mobile: +972-5-28704261
Email: eliezer at ngtech.co.il

-----Original Message-----
From: Alex Rousskov <rousskov at measurement-factory.com> 
Sent: Monday, December 14, 2020 9:05 PM
To: squid-users at lists.squid-cache.org
Cc: Eliezer Croitor <ngtech1ltd at gmail.com>
Subject: Re: [squid-users] sslcrtvalidator_program

On 12/14/20 1:55 PM, Eliezer Croitor wrote:

> We can use this as an example for a single transaction in the wiki:
> https://gist.githubusercontent.com/elico/a0397c879776336eeae569317015edc1/raw/b34dff8ece76e480007a950655efff3564afcccc/cache.log

> Let me know if it's enough to document this subject.

I am not sure I understand your question -- the format is already
documented. If you think that attaching an example of a raw helper
request to that wiki page would help others, please feel free to do so!
Just avoid the implication that all helper requests would have the same
set of fields.

Alex.


> -----Original Message-----
> From: Alex Rousskov <rousskov at measurement-factory.com> 
> Sent: Monday, December 14, 2020 6:42 PM
> To: squid-users at lists.squid-cache.org
> Cc: Eliezer Croitor <ngtech1ltd at gmail.com>
> Subject: Re: [squid-users] sslcrtvalidator_program
> 
> On 12/14/20 4:26 AM, Eliezer Croitor wrote:
>> So starts with:
>> 0 cert_validate... line
> 
>> And ends with?:
>> error_name_0=X509_V_ERR_DEPTH_ZERO_SELF_SIGNED_CERT
>> error_cert_0=cert0
>> ?
> 
> No. The size of the key=value block is specified on the first request
> line. Please try to follow documentation that Amos has pointed you to:
> https://wiki.squid-cache.org/Features/AddonHelpers#SSL_server_certificate_validator
> 
> If that documentation is missing some details, we should fix it.
> 
> 
> 
>> I am unsure, let me try to re-read this section.
>> I am missing a fake helper for this..
>> And a "real world" full example.
> 
>> Can someone simulate it for me?
> 
> Glad you found
> src/security/cert_validators/fake/security_fake_certverify.pl.in. I hope
> it still works!
> 
> 
> HTH,
> 
> Alex.
> 
> 
>> -----Original Message-----
>> From: squid-users <squid-users-bounces at lists.squid-cache.org> On Behalf Of Amos Jeffries
>> Sent: Monday, December 14, 2020 10:15 AM
>> To: squid-users at lists.squid-cache.org
>> Subject: Re: [squid-users] sslcrtvalidator_program
>>
>> On 14/12/20 9:11 am, Eliezer Croitor wrote:
>>> I am trying to understand the way the sslcrtvalidator_program  works.
>>> I am pretty sure I have asked this in the past but didn?t found it for some
>>> reason.
>>>
>>> I want to read line by line so.
>>> /^-----BEGIN CERTIFICATE-----$/
>>> ***
>>> /^-----END CERTIFICATE-----$/
>>>
>>> What else should I look for? I was thinking about validating with some extra
>>> values in the request, for example ip/domain:port and sni.
>>> Are these available in some way?
>>
>>
>> The details you need are all here:
>>
>>  
>> <https://wiki.squid-cache.org/Features/AddonHelpers#SSL_server_certificate_validator>
>>
>> Notice that it receives chains of certificates - maybe several, and/or 
>> out of order. Whatever the client sends.
>>
>>
>> Amos
>> _______________________________________________
>> squid-users mailing list
>> squid-users at lists.squid-cache.org
>> http://lists.squid-cache.org/listinfo/squid-users
>>
>> _______________________________________________
>> squid-users mailing list
>> squid-users at lists.squid-cache.org
>> http://lists.squid-cache.org/listinfo/squid-users
>>
> 




From rousskov at measurement-factory.com  Mon Dec 14 19:31:22 2020
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Mon, 14 Dec 2020 14:31:22 -0500
Subject: [squid-users] sslcrtvalidator_program
In-Reply-To: <006601d6d24d$76021110$62063330$@gmail.com>
References: <!&!AAAAAAAAAAAuAAAAAAAAAGg7dk9mYqJGhbBt3m/ghGwBAMO2jhD3dRHOtM0AqgC7tuYAAAAAAA4AABAAAACjNZPYF6/+Qof0xJIlu+dJAQAAAAA=@gmail.com>
 <e1f6a657-5f5f-3c17-c9da-b28e03d50a42@treenet.co.nz>
 <02e201d6d1fb$41d06060$c5712120$@gmail.com>
 <23c4a121-c464-e276-b359-f0b5a7262e2f@measurement-factory.com>
 <005701d6d24a$c194dde0$44be99a0$@gmail.com>
 <518aa67f-dcb7-e822-e54f-f2392a03ee5e@measurement-factory.com>
 <006601d6d24d$76021110$62063330$@gmail.com>
Message-ID: <7c171444-369b-9253-27c6-88175d4422ce@measurement-factory.com>

On 12/14/20 2:15 PM, Eliezer Croitor wrote:

> I wrote a simple ruby helper but squid claims it crashes rapidly.

> Since probably nobody else is willing to do some pipelining job I
> assume it's on me...

> I understand what you are saying/writing but from what I see some in
> the market do not want to pay.

I am sorry, but you lost me here. I do not understand the connection
between your earlier questions (which Amos and I tried to answer) and
the above statements.

Alex.


> -----Original Message-----
> From: Alex Rousskov <rousskov at measurement-factory.com> 
> Sent: Monday, December 14, 2020 9:05 PM
> To: squid-users at lists.squid-cache.org
> Cc: Eliezer Croitor <ngtech1ltd at gmail.com>
> Subject: Re: [squid-users] sslcrtvalidator_program
> 
> On 12/14/20 1:55 PM, Eliezer Croitor wrote:
> 
>> We can use this as an example for a single transaction in the wiki:
>> https://gist.githubusercontent.com/elico/a0397c879776336eeae569317015edc1/raw/b34dff8ece76e480007a950655efff3564afcccc/cache.log
> 
>> Let me know if it's enough to document this subject.
> 
> I am not sure I understand your question -- the format is already
> documented. If you think that attaching an example of a raw helper
> request to that wiki page would help others, please feel free to do so!
> Just avoid the implication that all helper requests would have the same
> set of fields.
> 
> Alex.
> 
> 
>> -----Original Message-----
>> From: Alex Rousskov <rousskov at measurement-factory.com> 
>> Sent: Monday, December 14, 2020 6:42 PM
>> To: squid-users at lists.squid-cache.org
>> Cc: Eliezer Croitor <ngtech1ltd at gmail.com>
>> Subject: Re: [squid-users] sslcrtvalidator_program
>>
>> On 12/14/20 4:26 AM, Eliezer Croitor wrote:
>>> So starts with:
>>> 0 cert_validate... line
>>
>>> And ends with?:
>>> error_name_0=X509_V_ERR_DEPTH_ZERO_SELF_SIGNED_CERT
>>> error_cert_0=cert0
>>> ?
>>
>> No. The size of the key=value block is specified on the first request
>> line. Please try to follow documentation that Amos has pointed you to:
>> https://wiki.squid-cache.org/Features/AddonHelpers#SSL_server_certificate_validator
>>
>> If that documentation is missing some details, we should fix it.
>>
>>
>>
>>> I am unsure, let me try to re-read this section.
>>> I am missing a fake helper for this..
>>> And a "real world" full example.
>>
>>> Can someone simulate it for me?
>>
>> Glad you found
>> src/security/cert_validators/fake/security_fake_certverify.pl.in. I hope
>> it still works!
>>
>>
>> HTH,
>>
>> Alex.
>>
>>
>>> -----Original Message-----
>>> From: squid-users <squid-users-bounces at lists.squid-cache.org> On Behalf Of Amos Jeffries
>>> Sent: Monday, December 14, 2020 10:15 AM
>>> To: squid-users at lists.squid-cache.org
>>> Subject: Re: [squid-users] sslcrtvalidator_program
>>>
>>> On 14/12/20 9:11 am, Eliezer Croitor wrote:
>>>> I am trying to understand the way the sslcrtvalidator_program  works.
>>>> I am pretty sure I have asked this in the past but didn?t found it for some
>>>> reason.
>>>>
>>>> I want to read line by line so.
>>>> /^-----BEGIN CERTIFICATE-----$/
>>>> ***
>>>> /^-----END CERTIFICATE-----$/
>>>>
>>>> What else should I look for? I was thinking about validating with some extra
>>>> values in the request, for example ip/domain:port and sni.
>>>> Are these available in some way?
>>>
>>>
>>> The details you need are all here:
>>>
>>>  
>>> <https://wiki.squid-cache.org/Features/AddonHelpers#SSL_server_certificate_validator>
>>>
>>> Notice that it receives chains of certificates - maybe several, and/or 
>>> out of order. Whatever the client sends.
>>>
>>>
>>> Amos
>>> _______________________________________________
>>> squid-users mailing list
>>> squid-users at lists.squid-cache.org
>>> http://lists.squid-cache.org/listinfo/squid-users
>>>
>>> _______________________________________________
>>> squid-users mailing list
>>> squid-users at lists.squid-cache.org
>>> http://lists.squid-cache.org/listinfo/squid-users
>>>
>>
> 



From ngtech1ltd at gmail.com  Mon Dec 14 20:52:45 2020
From: ngtech1ltd at gmail.com (Eliezer Croitor)
Date: Mon, 14 Dec 2020 22:52:45 +0200
Subject: [squid-users] sslcrtvalidator_program
In-Reply-To: <7c171444-369b-9253-27c6-88175d4422ce@measurement-factory.com>
References: <!&!AAAAAAAAAAAuAAAAAAAAAGg7dk9mYqJGhbBt3m/ghGwBAMO2jhD3dRHOtM0AqgC7tuYAAAAAAA4AABAAAACjNZPYF6/+Qof0xJIlu+dJAQAAAAA=@gmail.com>
 <e1f6a657-5f5f-3c17-c9da-b28e03d50a42@treenet.co.nz>
 <02e201d6d1fb$41d06060$c5712120$@gmail.com>
 <23c4a121-c464-e276-b359-f0b5a7262e2f@measurement-factory.com>
 <005701d6d24a$c194dde0$44be99a0$@gmail.com>
 <518aa67f-dcb7-e822-e54f-f2392a03ee5e@measurement-factory.com>
 <006601d6d24d$76021110$62063330$@gmail.com>
 <7c171444-369b-9253-27c6-88175d4422ce@measurement-factory.com>
Message-ID: <000001d6d25b$139706d0$3ac51470$@gmail.com>

Alex sorry,

There is no connection between you or this sentence.
I don't know why these things keep popping up while I'm sending emails.
The AV should have blocked this proofing software from pasting things while I'm writing but,
sometimes the desktop works in mysteries ways.
... Delete the quoted sentence in the email...

Both of you indeed are answering so again thanks.
Eliezer

----
Eliezer Croitoru
Tech Support
Mobile: +972-5-28704261
Email: eliezer at ngtech.co.il

-----Original Message-----
From: Alex Rousskov <rousskov at measurement-factory.com> 
Sent: Monday, December 14, 2020 9:31 PM
To: squid-users at lists.squid-cache.org
Cc: Eliezer Croitor <ngtech1ltd at gmail.com>
Subject: Re: [squid-users] sslcrtvalidator_program

On 12/14/20 2:15 PM, Eliezer Croitor wrote:

> I wrote a simple ruby helper but squid claims it crashes rapidly.

> Since probably nobody else is willing to do some pipelining job I
> assume it's on me...

> I understand what you are saying/writing but from what I see some in
> the market do not want to pay.

I am sorry, but you lost me here. I do not understand the connection
between your earlier questions (which Amos and I tried to answer) and
the above statements.

Alex.


> -----Original Message-----
> From: Alex Rousskov <rousskov at measurement-factory.com> 
> Sent: Monday, December 14, 2020 9:05 PM
> To: squid-users at lists.squid-cache.org
> Cc: Eliezer Croitor <ngtech1ltd at gmail.com>
> Subject: Re: [squid-users] sslcrtvalidator_program
> 
> On 12/14/20 1:55 PM, Eliezer Croitor wrote:
> 
>> We can use this as an example for a single transaction in the wiki:
>> https://gist.githubusercontent.com/elico/a0397c879776336eeae569317015edc1/raw/b34dff8ece76e480007a950655efff3564afcccc/cache.log
> 
>> Let me know if it's enough to document this subject.
> 
> I am not sure I understand your question -- the format is already
> documented. If you think that attaching an example of a raw helper
> request to that wiki page would help others, please feel free to do so!
> Just avoid the implication that all helper requests would have the same
> set of fields.
> 
> Alex.
> 
> 
>> -----Original Message-----
>> From: Alex Rousskov <rousskov at measurement-factory.com> 
>> Sent: Monday, December 14, 2020 6:42 PM
>> To: squid-users at lists.squid-cache.org
>> Cc: Eliezer Croitor <ngtech1ltd at gmail.com>
>> Subject: Re: [squid-users] sslcrtvalidator_program
>>
>> On 12/14/20 4:26 AM, Eliezer Croitor wrote:
>>> So starts with:
>>> 0 cert_validate... line
>>
>>> And ends with?:
>>> error_name_0=X509_V_ERR_DEPTH_ZERO_SELF_SIGNED_CERT
>>> error_cert_0=cert0
>>> ?
>>
>> No. The size of the key=value block is specified on the first request
>> line. Please try to follow documentation that Amos has pointed you to:
>> https://wiki.squid-cache.org/Features/AddonHelpers#SSL_server_certificate_validator
>>
>> If that documentation is missing some details, we should fix it.
>>
>>
>>
>>> I am unsure, let me try to re-read this section.
>>> I am missing a fake helper for this..
>>> And a "real world" full example.
>>
>>> Can someone simulate it for me?
>>
>> Glad you found
>> src/security/cert_validators/fake/security_fake_certverify.pl.in. I hope
>> it still works!
>>
>>
>> HTH,
>>
>> Alex.
>>
>>
>>> -----Original Message-----
>>> From: squid-users <squid-users-bounces at lists.squid-cache.org> On Behalf Of Amos Jeffries
>>> Sent: Monday, December 14, 2020 10:15 AM
>>> To: squid-users at lists.squid-cache.org
>>> Subject: Re: [squid-users] sslcrtvalidator_program
>>>
>>> On 14/12/20 9:11 am, Eliezer Croitor wrote:
>>>> I am trying to understand the way the sslcrtvalidator_program  works.
>>>> I am pretty sure I have asked this in the past but didn?t found it for some
>>>> reason.
>>>>
>>>> I want to read line by line so.
>>>> /^-----BEGIN CERTIFICATE-----$/
>>>> ***
>>>> /^-----END CERTIFICATE-----$/
>>>>
>>>> What else should I look for? I was thinking about validating with some extra
>>>> values in the request, for example ip/domain:port and sni.
>>>> Are these available in some way?
>>>
>>>
>>> The details you need are all here:
>>>
>>>  
>>> <https://wiki.squid-cache.org/Features/AddonHelpers#SSL_server_certificate_validator>
>>>
>>> Notice that it receives chains of certificates - maybe several, and/or 
>>> out of order. Whatever the client sends.
>>>
>>>
>>> Amos
>>> _______________________________________________
>>> squid-users mailing list
>>> squid-users at lists.squid-cache.org
>>> http://lists.squid-cache.org/listinfo/squid-users
>>>
>>> _______________________________________________
>>> squid-users mailing list
>>> squid-users at lists.squid-cache.org
>>> http://lists.squid-cache.org/listinfo/squid-users
>>>
>>
> 




From Lily.Zhang at dell.com  Tue Dec 15 03:21:25 2020
From: Lily.Zhang at dell.com (Zhang, Lily (USD))
Date: Tue, 15 Dec 2020 03:21:25 +0000
Subject: [squid-users] Proxy Server closes the connection to http server
 before transferring all application data to http client
In-Reply-To: <CH2PR19MB4085F051C425161521920792F0C60@CH2PR19MB4085.namprd19.prod.outlook.com>
References: <CH2PR19MB408562E2556D30B57562B2F5F0CA0@CH2PR19MB4085.namprd19.prod.outlook.com>
 <CH2PR19MB408598AA41CCA4FBE66E3790F0CA0@CH2PR19MB4085.namprd19.prod.outlook.com>
 <CH2PR19MB408533B96412E569A9499FFCF0C60@CH2PR19MB4085.namprd19.prod.outlook.com>
 <CH2PR19MB4085F0E24297427753F04109F0C60@CH2PR19MB4085.namprd19.prod.outlook.com>
 <CH2PR19MB4085EB136877C4B0962C489DF0C60@CH2PR19MB4085.namprd19.prod.outlook.com>
 <CH2PR19MB4085F051C425161521920792F0C60@CH2PR19MB4085.namprd19.prod.outlook.com>
Message-ID: <CH2PR19MB40856412F76E6FF2C70CCFC6F0C60@CH2PR19MB4085.namprd19.prod.outlook.com>

Hi

I installed 4.13 squid proxy server. See attachment, http server (10.250.16.46) sends FIN, ACK to tells that response is finished.  Proxy server (10.244.102.133) sends FIN, ACK back to http server (10.250.16.46) before "Application Data" is transferred to http client (10.245.166.20).

Would you please help me on questions below:

  1.  Is it normal that proxy server sends FIN, ACK to http server before http client finishes receiving  all the "Application Data" ?
  2.  Does proxy server have option to stop item 1?

Thanks
Lily
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20201215/d252eff4/attachment.htm>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: net_trace.zip
Type: application/x-zip-compressed
Size: 68883 bytes
Desc: net_trace.zip
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20201215/d252eff4/attachment.bin>

From squid3 at treenet.co.nz  Tue Dec 15 07:47:08 2020
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Tue, 15 Dec 2020 20:47:08 +1300
Subject: [squid-users] Proxy Server closes the connection to http server
 before transferring all application data to http client
In-Reply-To: <CH2PR19MB40856412F76E6FF2C70CCFC6F0C60@CH2PR19MB4085.namprd19.prod.outlook.com>
References: <CH2PR19MB408562E2556D30B57562B2F5F0CA0@CH2PR19MB4085.namprd19.prod.outlook.com>
 <CH2PR19MB408598AA41CCA4FBE66E3790F0CA0@CH2PR19MB4085.namprd19.prod.outlook.com>
 <CH2PR19MB408533B96412E569A9499FFCF0C60@CH2PR19MB4085.namprd19.prod.outlook.com>
 <CH2PR19MB4085F0E24297427753F04109F0C60@CH2PR19MB4085.namprd19.prod.outlook.com>
 <CH2PR19MB4085EB136877C4B0962C489DF0C60@CH2PR19MB4085.namprd19.prod.outlook.com>
 <CH2PR19MB4085F051C425161521920792F0C60@CH2PR19MB4085.namprd19.prod.outlook.com>
 <CH2PR19MB40856412F76E6FF2C70CCFC6F0C60@CH2PR19MB4085.namprd19.prod.outlook.com>
Message-ID: <812f6027-e193-548a-7f51-c9ee242e56af@treenet.co.nz>

On 15/12/20 4:21 pm, Zhang, Lily (USD) wrote:
> Hi
> 
> I installed 4.13 squid proxy server. See attachment, http server 
> (10.250.16.46) sends FIN, ACK to tells that response is finished. ?Proxy 
> server (10.244.102.133) sends FIN, ACK back to http server 
> (10.250.16.46) before "Application Data" is transferred to http client 
> (10.245.166.20).
> 
> Would you please help me on questions below:
> 
>  1. Is it normal that proxy server sends FIN, ACK to http server before
>     http client finishes receiving ?all the ?Application Data? ?

That depends on the transaction which is being performed.

If it is a normal HTTP request-response transaction then yes. Once Squid 
has the response the server connection is done with - it may be closed 
or re-used for other transactions.

If it is a tunnel containing non-HTTP traffic then no. Squid should only 
close the server connection when the client closes its end of the tunnel.

Also, note that FIN+ACK in a single packet is a *response* to a FIN 
having come from the server itself. Not initiated by the proxy.



>  2. Does proxy server have option to stop item 1?
> 

In general: No. This is something that is supposed to happen (or not) 
according to the relevant protocol requirements.

In specific, there may be some options that can be configured to change 
how the protocol behaves. Preventing it needing a close. You will have 
to find out what the cause actually is to determine where to look for 
solutions.


Amos



From Lily.Zhang at dell.com  Tue Dec 15 07:52:18 2020
From: Lily.Zhang at dell.com (Zhang, Lily (USD))
Date: Tue, 15 Dec 2020 07:52:18 +0000
Subject: [squid-users] Proxy Server closes the connection to http server
 before transferring all application data to http client
In-Reply-To: <812f6027-e193-548a-7f51-c9ee242e56af@treenet.co.nz>
References: <CH2PR19MB408562E2556D30B57562B2F5F0CA0@CH2PR19MB4085.namprd19.prod.outlook.com>
 <CH2PR19MB408598AA41CCA4FBE66E3790F0CA0@CH2PR19MB4085.namprd19.prod.outlook.com>
 <CH2PR19MB408533B96412E569A9499FFCF0C60@CH2PR19MB4085.namprd19.prod.outlook.com>
 <CH2PR19MB4085F0E24297427753F04109F0C60@CH2PR19MB4085.namprd19.prod.outlook.com>
 <CH2PR19MB4085EB136877C4B0962C489DF0C60@CH2PR19MB4085.namprd19.prod.outlook.com>
 <CH2PR19MB4085F051C425161521920792F0C60@CH2PR19MB4085.namprd19.prod.outlook.com>
 <CH2PR19MB40856412F76E6FF2C70CCFC6F0C60@CH2PR19MB4085.namprd19.prod.outlook.com>
 <812f6027-e193-548a-7f51-c9ee242e56af@treenet.co.nz>
Message-ID: <CH2PR19MB4085702A69D77EB2B710C1A5F0C60@CH2PR19MB4085.namprd19.prod.outlook.com>

Thanks Amos for your quick reply.

Looks we can use "Connection: keep-alive" in http request to solve this issue.

Thanks
Lily

-----Original Message-----
From: squid-users <squid-users-bounces at lists.squid-cache.org> On Behalf Of Amos Jeffries
Sent: Tuesday, December 15, 2020 3:47 PM
To: squid-users at lists.squid-cache.org
Subject: Re: [squid-users] Proxy Server closes the connection to http server before transferring all application data to http client


[EXTERNAL EMAIL] 

On 15/12/20 4:21 pm, Zhang, Lily (USD) wrote:
> Hi
> 
> I installed 4.13 squid proxy server. See attachment, http server
> (10.250.16.46) sends FIN, ACK to tells that response is finished. ?
> Proxy server (10.244.102.133) sends FIN, ACK back to http server
> (10.250.16.46) before "Application Data" is transferred to http client 
> (10.245.166.20).
> 
> Would you please help me on questions below:
> 
>  1. Is it normal that proxy server sends FIN, ACK to http server before
>     http client finishes receiving ?all the ?Application Data? ?

That depends on the transaction which is being performed.

If it is a normal HTTP request-response transaction then yes. Once Squid has the response the server connection is done with - it may be closed or re-used for other transactions.

If it is a tunnel containing non-HTTP traffic then no. Squid should only close the server connection when the client closes its end of the tunnel.

Also, note that FIN+ACK in a single packet is a *response* to a FIN having come from the server itself. Not initiated by the proxy.



>  2. Does proxy server have option to stop item 1?
> 

In general: No. This is something that is supposed to happen (or not) 
according to the relevant protocol requirements.

In specific, there may be some options that can be configured to change 
how the protocol behaves. Preventing it needing a close. You will have 
to find out what the cause actually is to determine where to look for 
solutions.


Amos

_______________________________________________
squid-users mailing list
squid-users at lists.squid-cache.org
http://lists.squid-cache.org/listinfo/squid-users

From squid3 at treenet.co.nz  Tue Dec 15 08:10:03 2020
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Tue, 15 Dec 2020 21:10:03 +1300
Subject: [squid-users] Squid for Windows: negotiate_kerberos_auth helper
 seems to leak(?) handles
In-Reply-To: <dbd232bc-9dcf-4e4f-28b7-54c91dd85f5f@westkamp.net>
References: <dbd232bc-9dcf-4e4f-28b7-54c91dd85f5f@westkamp.net>
Message-ID: <1cbdf070-04b3-5bf4-c987-8c5e7f8222de@treenet.co.nz>

On 15/12/20 4:03 am, Klaus Westkamp wrote:
> Hi,
> 
> i'm uncertain, wether this mailing list is the correct one to ask, but i 
> have the disputable honor to make a squid running on a Windows Server 
> (if possible). Whilst squid.exe seems to run fine, i constantly run into 
> an unresponsive system, when i enable Kerberos authentication via 
> auth_param and the negotiate_kerberos_auth.exe helper.
> 
> For a while authentication works fine, but all at the sudden the system 
> hangs at 100% CPU usage. My Observation is that one of the 
> negotiate_kerberos_auth.exe processes has a constantly increasing number 
> of handles (Files and events). If i understand the Sysinternals handle 
> tool correctly, most handles are event corrolated.
> 
> The setting:
> 
> Windows 2012 R2 AD Controllers with Windows 2008R2 Domain Level. A 
> Windows Server 2016 running Squid 3.5 for Windows.

Is Squid the package built by Diladele or a custom build?

Which exact version number is it? (output of "squid -v" please)


Amos


From ngtech1ltd at gmail.com  Tue Dec 15 14:44:44 2020
From: ngtech1ltd at gmail.com (Eliezer Croitor)
Date: Tue, 15 Dec 2020 16:44:44 +0200
Subject: [squid-users] Proxy Server closes the connection to http server
 before transferring all application data to http client
In-Reply-To: <CH2PR19MB40856412F76E6FF2C70CCFC6F0C60@CH2PR19MB4085.namprd19.prod.outlook.com>
References: <CH2PR19MB408562E2556D30B57562B2F5F0CA0@CH2PR19MB4085.namprd19.prod.outlook.com>
 <CH2PR19MB408598AA41CCA4FBE66E3790F0CA0@CH2PR19MB4085.namprd19.prod.outlook.com>
 <CH2PR19MB408533B96412E569A9499FFCF0C60@CH2PR19MB4085.namprd19.prod.outlook.com>
 <CH2PR19MB4085F0E24297427753F04109F0C60@CH2PR19MB4085.namprd19.prod.outlook.com>
 <CH2PR19MB4085EB136877C4B0962C489DF0C60@CH2PR19MB4085.namprd19.prod.outlook.com>
 <CH2PR19MB4085F051C425161521920792F0C60@CH2PR19MB4085.namprd19.prod.outlook.com>
 <CH2PR19MB40856412F76E6FF2C70CCFC6F0C60@CH2PR19MB4085.namprd19.prod.outlook.com>
Message-ID: <00f301d6d2f0$d4a73440$7df59cc0$@gmail.com>

Hey Lily,

 

Is there any specific issue which made you aware of this issue?

 

Thanks,

Eliezer

 

----

Eliezer Croitoru

Tech Support

Mobile: +972-5-28704261

Email:  <mailto:eliezer at ngtech.co.il> eliezer at ngtech.co.il

 

From: squid-users <squid-users-bounces at lists.squid-cache.org> On Behalf Of
Zhang, Lily (USD)
Sent: Tuesday, December 15, 2020 5:21 AM
To: squid-users at lists.squid-cache.org
Subject: [squid-users] Proxy Server closes the connection to http server
before transferring all application data to http client

 

Hi           

                            

I installed 4.13 squid proxy server. See attachment, http server
(10.250.16.46) sends FIN, ACK to tells that response is finished.  Proxy
server (10.244.102.133) sends FIN, ACK back to http server (10.250.16.46)
before "Application Data" is transferred to http client (10.245.166.20). 

 

Would you please help me on questions below:

1.	Is it normal that proxy server sends FIN, ACK to http server before
http client finishes receiving  all the "Application Data" ?
2.	Does proxy server have option to stop item 1?

 

Thanks

Lily

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20201215/8b4b264c/attachment.htm>

From ngtech1ltd at gmail.com  Tue Dec 15 14:46:54 2020
From: ngtech1ltd at gmail.com (Eliezer Croitor)
Date: Tue, 15 Dec 2020 16:46:54 +0200
Subject: [squid-users] Proxy Server closes the connection to http server
 before transferring all application data to http client
In-Reply-To: <CH2PR19MB40856412F76E6FF2C70CCFC6F0C60@CH2PR19MB4085.namprd19.prod.outlook.com>
References: <CH2PR19MB408562E2556D30B57562B2F5F0CA0@CH2PR19MB4085.namprd19.prod.outlook.com>
 <CH2PR19MB408598AA41CCA4FBE66E3790F0CA0@CH2PR19MB4085.namprd19.prod.outlook.com>
 <CH2PR19MB408533B96412E569A9499FFCF0C60@CH2PR19MB4085.namprd19.prod.outlook.com>
 <CH2PR19MB4085F0E24297427753F04109F0C60@CH2PR19MB4085.namprd19.prod.outlook.com>
 <CH2PR19MB4085EB136877C4B0962C489DF0C60@CH2PR19MB4085.namprd19.prod.outlook.com>
 <CH2PR19MB4085F051C425161521920792F0C60@CH2PR19MB4085.namprd19.prod.outlook.com>
 <CH2PR19MB40856412F76E6FF2C70CCFC6F0C60@CH2PR19MB4085.namprd19.prod.outlook.com>
Message-ID: <010e01d6d2f1$21ee8780$65cb9680$@gmail.com>

Hey Lily,

 

Is there any specific issue which made you aware of this issue?

 

Thanks,

Eliezer

 

----

Eliezer Croitoru

Tech Support

Mobile: +972-5-28704261

Email:  <mailto:eliezer at ngtech.co.il> eliezer at ngtech.co.il

 

From: squid-users <squid-users-bounces at lists.squid-cache.org> On Behalf Of
Zhang, Lily (USD)
Sent: Tuesday, December 15, 2020 5:21 AM
To: squid-users at lists.squid-cache.org
Subject: [squid-users] Proxy Server closes the connection to http server
before transferring all application data to http client

 

Hi           

                            

I installed 4.13 squid proxy server. See attachment, http server
(10.250.16.46) sends FIN, ACK to tells that response is finished.  Proxy
server (10.244.102.133) sends FIN, ACK back to http server (10.250.16.46)
before "Application Data" is transferred to http client (10.245.166.20). 

 

Would you please help me on questions below:

1.	Is it normal that proxy server sends FIN, ACK to http server before
http client finishes receiving  all the "Application Data" ?
2.	Does proxy server have option to stop item 1?

 

Thanks

Lily

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20201215/6a40a5bc/attachment.htm>

From rousskov at measurement-factory.com  Tue Dec 15 15:41:43 2020
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Tue, 15 Dec 2020 10:41:43 -0500
Subject: [squid-users] Proxy Server closes the connection to http server
 before transferring all application data to http client
In-Reply-To: <CH2PR19MB40856412F76E6FF2C70CCFC6F0C60@CH2PR19MB4085.namprd19.prod.outlook.com>
References: <CH2PR19MB408562E2556D30B57562B2F5F0CA0@CH2PR19MB4085.namprd19.prod.outlook.com>
 <CH2PR19MB408598AA41CCA4FBE66E3790F0CA0@CH2PR19MB4085.namprd19.prod.outlook.com>
 <CH2PR19MB408533B96412E569A9499FFCF0C60@CH2PR19MB4085.namprd19.prod.outlook.com>
 <CH2PR19MB4085F0E24297427753F04109F0C60@CH2PR19MB4085.namprd19.prod.outlook.com>
 <CH2PR19MB4085EB136877C4B0962C489DF0C60@CH2PR19MB4085.namprd19.prod.outlook.com>
 <CH2PR19MB4085F051C425161521920792F0C60@CH2PR19MB4085.namprd19.prod.outlook.com>
 <CH2PR19MB40856412F76E6FF2C70CCFC6F0C60@CH2PR19MB4085.namprd19.prod.outlook.com>
Message-ID: <bade1e0f-f11e-889c-ad5e-b832db3ca56c@measurement-factory.com>

On 12/14/20 10:21 PM, Zhang, Lily (USD) wrote:

>  1. Is it normal that proxy server sends FIN, ACK to http server before
>     http client finishes receiving ?all the ?Application Data? ?

Yes, this is how Squid works, even if Squid is tunneling at TCP level.
After Squid notices that the server has closed the Squid-server
connection, Squid closes its end of that connection as well, regardless
of what the client is doing (in some cases, there may be no client at
all at that point).

Some may argue that the lack of accurate closure timing propagation for
TCP tunnels is a Squid bug or a missing Squid feature, but that argument
does not change the answer to your question about the current Squid
behavior.


>  2. Does proxy server have option to stop item 1?

No. If you want to discuss whether adding such an option is a good idea
please detail your use case (i.e. _why_ such an option is needed).


HTH,

Alex.
P.S. Please note that Squid works above the individual TCP packet layer.
Squid operates on TCP sockets and does not see or send individual TCP
packets.


From rousskov at measurement-factory.com  Tue Dec 15 15:52:59 2020
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Tue, 15 Dec 2020 10:52:59 -0500
Subject: [squid-users] Proxy Server closes the connection to http server
 before transferring all application data to http client
In-Reply-To: <CH2PR19MB4085702A69D77EB2B710C1A5F0C60@CH2PR19MB4085.namprd19.prod.outlook.com>
References: <CH2PR19MB408562E2556D30B57562B2F5F0CA0@CH2PR19MB4085.namprd19.prod.outlook.com>
 <CH2PR19MB408598AA41CCA4FBE66E3790F0CA0@CH2PR19MB4085.namprd19.prod.outlook.com>
 <CH2PR19MB408533B96412E569A9499FFCF0C60@CH2PR19MB4085.namprd19.prod.outlook.com>
 <CH2PR19MB4085F0E24297427753F04109F0C60@CH2PR19MB4085.namprd19.prod.outlook.com>
 <CH2PR19MB4085EB136877C4B0962C489DF0C60@CH2PR19MB4085.namprd19.prod.outlook.com>
 <CH2PR19MB4085F051C425161521920792F0C60@CH2PR19MB4085.namprd19.prod.outlook.com>
 <CH2PR19MB40856412F76E6FF2C70CCFC6F0C60@CH2PR19MB4085.namprd19.prod.outlook.com>
 <812f6027-e193-548a-7f51-c9ee242e56af@treenet.co.nz>
 <CH2PR19MB4085702A69D77EB2B710C1A5F0C60@CH2PR19MB4085.namprd19.prod.outlook.com>
Message-ID: <3ae87c34-587a-eb5f-54a7-fde3d10a385f@measurement-factory.com>

On 12/15/20 2:52 AM, Zhang, Lily (USD) wrote:

> Looks we can use "Connection: keep-alive" in http request to solve this issue.

That client request header will not change Squid's reaction to
Squid-server connection closure by the server. It also should not change
the request that Squid sends to the server (if it does, it is a Squid
bug). In HTTP proxying, client-Squid and Squid-server
connections/negotiations are mostly independent.

If changing the client to send Connection:keep-alive to Squid fixes your
problem, then the problem was most likely unrelated to the behavior you
asked about earlier.

If you can configure the HTTP server to keep the connection
open/persistent after delivering the response (and, hence, to send a
Connection:keep-alive _response_ header or otherwise signal HTTP
connection persistency), then, yes, Squid may pool that _open_
Squid-server connection for future reuse (again, regardless of what
headers the HTTP client is using).

Alex.



> -----Original Message-----
> From: squid-users <squid-users-bounces at lists.squid-cache.org> On Behalf Of Amos Jeffries
> Sent: Tuesday, December 15, 2020 3:47 PM
> To: squid-users at lists.squid-cache.org
> Subject: Re: [squid-users] Proxy Server closes the connection to http server before transferring all application data to http client
> 
> 
> [EXTERNAL EMAIL] 
> 
> On 15/12/20 4:21 pm, Zhang, Lily (USD) wrote:
>> Hi
>>
>> I installed 4.13 squid proxy server. See attachment, http server
>> (10.250.16.46) sends FIN, ACK to tells that response is finished. ?
>> Proxy server (10.244.102.133) sends FIN, ACK back to http server
>> (10.250.16.46) before "Application Data" is transferred to http client 
>> (10.245.166.20).
>>
>> Would you please help me on questions below:
>>
>>  1. Is it normal that proxy server sends FIN, ACK to http server before
>>     http client finishes receiving ?all the ?Application Data? ?
> 
> That depends on the transaction which is being performed.
> 
> If it is a normal HTTP request-response transaction then yes. Once Squid has the response the server connection is done with - it may be closed or re-used for other transactions.
> 
> If it is a tunnel containing non-HTTP traffic then no. Squid should only close the server connection when the client closes its end of the tunnel.
> 
> Also, note that FIN+ACK in a single packet is a *response* to a FIN having come from the server itself. Not initiated by the proxy.
> 
> 
> 
>>  2. Does proxy server have option to stop item 1?
>>
> 
> In general: No. This is something that is supposed to happen (or not) 
> according to the relevant protocol requirements.
> 
> In specific, there may be some options that can be configured to change 
> how the protocol behaves. Preventing it needing a close. You will have 
> to find out what the cause actually is to determine where to look for 
> solutions.
> 
> 
> Amos
> 
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users
> 



From Lily.Zhang at dell.com  Wed Dec 16 07:29:13 2020
From: Lily.Zhang at dell.com (Zhang, Lily (USD))
Date: Wed, 16 Dec 2020 07:29:13 +0000
Subject: [squid-users] Proxy Server closes the connection to http server
 before transferring all application data to http client
In-Reply-To: <3ae87c34-587a-eb5f-54a7-fde3d10a385f@measurement-factory.com>
References: <CH2PR19MB408562E2556D30B57562B2F5F0CA0@CH2PR19MB4085.namprd19.prod.outlook.com>
 <CH2PR19MB408598AA41CCA4FBE66E3790F0CA0@CH2PR19MB4085.namprd19.prod.outlook.com>
 <CH2PR19MB408533B96412E569A9499FFCF0C60@CH2PR19MB4085.namprd19.prod.outlook.com>
 <CH2PR19MB4085F0E24297427753F04109F0C60@CH2PR19MB4085.namprd19.prod.outlook.com>
 <CH2PR19MB4085EB136877C4B0962C489DF0C60@CH2PR19MB4085.namprd19.prod.outlook.com>
 <CH2PR19MB4085F051C425161521920792F0C60@CH2PR19MB4085.namprd19.prod.outlook.com>
 <CH2PR19MB40856412F76E6FF2C70CCFC6F0C60@CH2PR19MB4085.namprd19.prod.outlook.com>
 <812f6027-e193-548a-7f51-c9ee242e56af@treenet.co.nz>
 <CH2PR19MB4085702A69D77EB2B710C1A5F0C60@CH2PR19MB4085.namprd19.prod.outlook.com>
 <3ae87c34-587a-eb5f-54a7-fde3d10a385f@measurement-factory.com>
Message-ID: <CH2PR19MB40852144253391BC98A87E3BF0C50@CH2PR19MB4085.namprd19.prod.outlook.com>

Hi Alex,
Thanks for your reply.

At first, http server turns off  keep-alive, then http client can't get the full response sometimes (example 20 0000 char, get 17 0000 chars).

I did a test in the lab, found 

1. If http client uses connection: close, and http server uses connection: keep-alive, then still can transfer data after tcp connection between http server and proxy server is closed.  (don't know how this happens)

2. If http client uses connection: keep-alive, and http server uses connection: keep-alive, then connection between http server and proxy server won't closed first. It is closed after client closes the connection.

Thanks
Lily
-----Original Message-----
From: Alex Rousskov <rousskov at measurement-factory.com> 
Sent: Tuesday, December 15, 2020 11:53 PM
To: squid-users at lists.squid-cache.org
Cc: Zhang, Lily (USD)
Subject: Re: [squid-users] Proxy Server closes the connection to http server before transferring all application data to http client


[EXTERNAL EMAIL] 

On 12/15/20 2:52 AM, Zhang, Lily (USD) wrote:

> Looks we can use "Connection: keep-alive" in http request to solve this issue.

That client request header will not change Squid's reaction to Squid-server connection closure by the server. It also should not change the request that Squid sends to the server (if it does, it is a Squid bug). In HTTP proxying, client-Squid and Squid-server connections/negotiations are mostly independent.

If changing the client to send Connection:keep-alive to Squid fixes your problem, then the problem was most likely unrelated to the behavior you asked about earlier.

If you can configure the HTTP server to keep the connection open/persistent after delivering the response (and, hence, to send a Connection:keep-alive _response_ header or otherwise signal HTTP connection persistency), then, yes, Squid may pool that _open_ Squid-server connection for future reuse (again, regardless of what headers the HTTP client is using).

Alex.



> -----Original Message-----
> From: squid-users <squid-users-bounces at lists.squid-cache.org> On 
> Behalf Of Amos Jeffries
> Sent: Tuesday, December 15, 2020 3:47 PM
> To: squid-users at lists.squid-cache.org
> Subject: Re: [squid-users] Proxy Server closes the connection to http 
> server before transferring all application data to http client
> 
> 
> [EXTERNAL EMAIL]
> 
> On 15/12/20 4:21 pm, Zhang, Lily (USD) wrote:
>> Hi
>>
>> I installed 4.13 squid proxy server. See attachment, http server
>> (10.250.16.46) sends FIN, ACK to tells that response is finished. 
>> Proxy server (10.244.102.133) sends FIN, ACK back to http server
>> (10.250.16.46) before "Application Data" is transferred to http 
>> client (10.245.166.20).
>>
>> Would you please help me on questions below:
>>
>>  1. Is it normal that proxy server sends FIN, ACK to http server before
>>     http client finishes receiving ?all the ?Application Data? ?
> 
> That depends on the transaction which is being performed.
> 
> If it is a normal HTTP request-response transaction then yes. Once Squid has the response the server connection is done with - it may be closed or re-used for other transactions.
> 
> If it is a tunnel containing non-HTTP traffic then no. Squid should only close the server connection when the client closes its end of the tunnel.
> 
> Also, note that FIN+ACK in a single packet is a *response* to a FIN having come from the server itself. Not initiated by the proxy.
> 
> 
> 
>>  2. Does proxy server have option to stop item 1?
>>
> 
> In general: No. This is something that is supposed to happen (or not) 
> according to the relevant protocol requirements.
> 
> In specific, there may be some options that can be configured to 
> change how the protocol behaves. Preventing it needing a close. You 
> will have to find out what the cause actually is to determine where to 
> look for solutions.
> 
> 
> Amos
> 
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users
> 


From Lily.Zhang at dell.com  Wed Dec 16 07:40:11 2020
From: Lily.Zhang at dell.com (Zhang, Lily (USD))
Date: Wed, 16 Dec 2020 07:40:11 +0000
Subject: [squid-users] Proxy Server closes the connection to http server
 before transferring all application data to http client
In-Reply-To: <010e01d6d2f1$21ee8780$65cb9680$@gmail.com>
References: <CH2PR19MB408562E2556D30B57562B2F5F0CA0@CH2PR19MB4085.namprd19.prod.outlook.com>
 <CH2PR19MB408598AA41CCA4FBE66E3790F0CA0@CH2PR19MB4085.namprd19.prod.outlook.com>
 <CH2PR19MB408533B96412E569A9499FFCF0C60@CH2PR19MB4085.namprd19.prod.outlook.com>
 <CH2PR19MB4085F0E24297427753F04109F0C60@CH2PR19MB4085.namprd19.prod.outlook.com>
 <CH2PR19MB4085EB136877C4B0962C489DF0C60@CH2PR19MB4085.namprd19.prod.outlook.com>
 <CH2PR19MB4085F051C425161521920792F0C60@CH2PR19MB4085.namprd19.prod.outlook.com>
 <CH2PR19MB40856412F76E6FF2C70CCFC6F0C60@CH2PR19MB4085.namprd19.prod.outlook.com>
 <010e01d6d2f1$21ee8780$65cb9680$@gmail.com>
Message-ID: <CH2PR19MB408538EE1000A96ACA6734FBF0C50@CH2PR19MB4085.namprd19.prod.outlook.com>

Hi Croitor,


I investigated this issue as I have tickets from customer side.  http client can't get the full response sometimes (example 20 0000 char, get 17 0000 chars).

Thanks
Lily
From: Eliezer Croitor <ngtech1ltd at gmail.com>
Sent: Tuesday, December 15, 2020 10:47 PM
To: Zhang, Lily (USD)
Cc: squid-users at lists.squid-cache.org
Subject: RE: [squid-users] Proxy Server closes the connection to http server before transferring all application data to http client


[EXTERNAL EMAIL]
Hey Lily,

Is there any specific issue which made you aware of this issue?

Thanks,
Eliezer

----
Eliezer Croitoru
Tech Support
Mobile: +972-5-28704261
Email: eliezer at ngtech.co.il<mailto:eliezer at ngtech.co.il>

From: squid-users <squid-users-bounces at lists.squid-cache.org<mailto:squid-users-bounces at lists.squid-cache.org>> On Behalf Of Zhang, Lily (USD)
Sent: Tuesday, December 15, 2020 5:21 AM
To: squid-users at lists.squid-cache.org<mailto:squid-users at lists.squid-cache.org>
Subject: [squid-users] Proxy Server closes the connection to http server before transferring all application data to http client

Hi

I installed 4.13 squid proxy server. See attachment, http server (10.250.16.46) sends FIN, ACK to tells that response is finished.  Proxy server (10.244.102.133) sends FIN, ACK back to http server (10.250.16.46) before "Application Data" is transferred to http client (10.245.166.20).

Would you please help me on questions below:

  1.  Is it normal that proxy server sends FIN, ACK to http server before http client finishes receiving  all the "Application Data" ?
  2.  Does proxy server have option to stop item 1?

Thanks
Lily
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20201216/4131898f/attachment.htm>

From Lily.Zhang at dell.com  Wed Dec 16 09:02:24 2020
From: Lily.Zhang at dell.com (Zhang, Lily (USD))
Date: Wed, 16 Dec 2020 09:02:24 +0000
Subject: [squid-users] Proxy Server closes the connection to http server
 before transferring all application data to http client
In-Reply-To: <CH2PR19MB40852144253391BC98A87E3BF0C50@CH2PR19MB4085.namprd19.prod.outlook.com>
References: <CH2PR19MB408562E2556D30B57562B2F5F0CA0@CH2PR19MB4085.namprd19.prod.outlook.com>
 <CH2PR19MB408598AA41CCA4FBE66E3790F0CA0@CH2PR19MB4085.namprd19.prod.outlook.com>
 <CH2PR19MB408533B96412E569A9499FFCF0C60@CH2PR19MB4085.namprd19.prod.outlook.com>
 <CH2PR19MB4085F0E24297427753F04109F0C60@CH2PR19MB4085.namprd19.prod.outlook.com>
 <CH2PR19MB4085EB136877C4B0962C489DF0C60@CH2PR19MB4085.namprd19.prod.outlook.com>
 <CH2PR19MB4085F051C425161521920792F0C60@CH2PR19MB4085.namprd19.prod.outlook.com>
 <CH2PR19MB40856412F76E6FF2C70CCFC6F0C60@CH2PR19MB4085.namprd19.prod.outlook.com>
 <812f6027-e193-548a-7f51-c9ee242e56af@treenet.co.nz>
 <CH2PR19MB4085702A69D77EB2B710C1A5F0C60@CH2PR19MB4085.namprd19.prod.outlook.com>
 <3ae87c34-587a-eb5f-54a7-fde3d10a385f@measurement-factory.com>
 <CH2PR19MB40852144253391BC98A87E3BF0C50@CH2PR19MB4085.namprd19.prod.outlook.com>
Message-ID: <CH2PR19MB4085700DAD3B2F255E65CBC8F0C50@CH2PR19MB4085.namprd19.prod.outlook.com>

Hi Alex,

Issue still can be reproduced when http client using connection: close, and http server uses connection: keep-alive.
I can't reproduce this issue when both side using keep-alive.

Thanks
Lily

-----Original Message-----
From: Zhang, Lily (USD) 
Sent: Wednesday, December 16, 2020 3:29 PM
To: Alex Rousskov; squid-users at lists.squid-cache.org
Subject: RE: [squid-users] Proxy Server closes the connection to http server before transferring all application data to http client

Hi Alex,
Thanks for your reply.

At first, http server turns off  keep-alive, then http client can't get the full response sometimes (example 20 0000 char, get 17 0000 chars).

I did a test in the lab, found 

1. If http client uses connection: close, and http server uses connection: keep-alive, then still can transfer data after tcp connection between http server and proxy server is closed.  (don't know how this happens)

2. If http client uses connection: keep-alive, and http server uses connection: keep-alive, then connection between http server and proxy server won't closed first. It is closed after client closes the connection.

Thanks
Lily
-----Original Message-----
From: Alex Rousskov <rousskov at measurement-factory.com> 
Sent: Tuesday, December 15, 2020 11:53 PM
To: squid-users at lists.squid-cache.org
Cc: Zhang, Lily (USD)
Subject: Re: [squid-users] Proxy Server closes the connection to http server before transferring all application data to http client


[EXTERNAL EMAIL] 

On 12/15/20 2:52 AM, Zhang, Lily (USD) wrote:

> Looks we can use "Connection: keep-alive" in http request to solve this issue.

That client request header will not change Squid's reaction to Squid-server connection closure by the server. It also should not change the request that Squid sends to the server (if it does, it is a Squid bug). In HTTP proxying, client-Squid and Squid-server connections/negotiations are mostly independent.

If changing the client to send Connection:keep-alive to Squid fixes your problem, then the problem was most likely unrelated to the behavior you asked about earlier.

If you can configure the HTTP server to keep the connection open/persistent after delivering the response (and, hence, to send a Connection:keep-alive _response_ header or otherwise signal HTTP connection persistency), then, yes, Squid may pool that _open_ Squid-server connection for future reuse (again, regardless of what headers the HTTP client is using).

Alex.



> -----Original Message-----
> From: squid-users <squid-users-bounces at lists.squid-cache.org> On 
> Behalf Of Amos Jeffries
> Sent: Tuesday, December 15, 2020 3:47 PM
> To: squid-users at lists.squid-cache.org
> Subject: Re: [squid-users] Proxy Server closes the connection to http 
> server before transferring all application data to http client
> 
> 
> [EXTERNAL EMAIL]
> 
> On 15/12/20 4:21 pm, Zhang, Lily (USD) wrote:
>> Hi
>>
>> I installed 4.13 squid proxy server. See attachment, http server
>> (10.250.16.46) sends FIN, ACK to tells that response is finished. 
>> Proxy server (10.244.102.133) sends FIN, ACK back to http server
>> (10.250.16.46) before "Application Data" is transferred to http 
>> client (10.245.166.20).
>>
>> Would you please help me on questions below:
>>
>>  1. Is it normal that proxy server sends FIN, ACK to http server before
>>     http client finishes receiving ?all the ?Application Data? ?
> 
> That depends on the transaction which is being performed.
> 
> If it is a normal HTTP request-response transaction then yes. Once Squid has the response the server connection is done with - it may be closed or re-used for other transactions.
> 
> If it is a tunnel containing non-HTTP traffic then no. Squid should only close the server connection when the client closes its end of the tunnel.
> 
> Also, note that FIN+ACK in a single packet is a *response* to a FIN having come from the server itself. Not initiated by the proxy.
> 
> 
> 
>>  2. Does proxy server have option to stop item 1?
>>
> 
> In general: No. This is something that is supposed to happen (or not) 
> according to the relevant protocol requirements.
> 
> In specific, there may be some options that can be configured to 
> change how the protocol behaves. Preventing it needing a close. You 
> will have to find out what the cause actually is to determine where to 
> look for solutions.
> 
> 
> Amos
> 
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users
> 


From klaus at westkamp.net  Wed Dec 16 12:46:15 2020
From: klaus at westkamp.net (Klaus Westkamp)
Date: Wed, 16 Dec 2020 13:46:15 +0100
Subject: [squid-users] Squid for Windows: negotiate_kerberos_auth helper
 seems to leak(?) handles
In-Reply-To: <aabdd2ba-5a58-1127-1097-9d5dcfe143db@westkamp.net>
References: <dbd232bc-9dcf-4e4f-28b7-54c91dd85f5f@westkamp.net>
 <1cbdf070-04b3-5bf4-c987-8c5e7f8222de@treenet.co.nz>
 <aabdd2ba-5a58-1127-1097-9d5dcfe143db@westkamp.net>
Message-ID: <8251c91f-1b08-82f2-f6ec-46ef92fe9573@westkamp.net>

Hi,

i digged a little further (but i'm no exert in WinDBG):

Attachimng to the process with the most handles (currently 323 shown by 
Windows Process Manager, as newly started)

!handles gives me:

277 Handles (weired, shows less than process manager)
Type?????????? ??? Count
None?????????? ??? 4
Event????????? ??? 199
Section??????? ??? 7
File?????????? ??? 18
Directory????? ??? 3
SymbolicLink?? ??? 1
Mutant???????? ??? 9
Semaphore????? ??? 5
Key??????????? ??? 8
Token????????? ??? 2
Thread???????? ??? 5
IoCompletion?? ??? 2
TpWorkerFactory??? 2
ALPC Port????? ??? 5
WaitCompletionPacket??? 7

Asking for Handle Details:

0:003> !handle 5e8 f
Handle 5e8
 ? Type???????? ??? Event
 ? Attributes?? ??? 0
 ? GrantedAccess??? 0x1f0003:
 ???????? Delete,ReadControl,WriteDac,WriteOwner,Synch
 ???????? QueryState,ModifyState
 ? HandleCount? ??? 2
 ? PointerCount ??? 32769
 ? Name???????? ??? <none>
 ? Object Specific Information
 ??? Event Type Auto Reset
 ??? Event is Waiting

0:003> !handle 5e0 f
Handle 5e0
 ? Type???????? ??? Event
 ? Attributes?? ??? 0
 ? GrantedAccess??? 0x1f0003:
 ???????? Delete,ReadControl,WriteDac,WriteOwner,Synch
 ???????? QueryState,ModifyState
 ? HandleCount? ??? 2
 ? PointerCount ??? 32769
 ? Name???????? ??? <none>
 ? Object Specific Information
 ??? Event Type Auto Reset
 ??? Event is Waiting

0:003> !handle 374 f
Handle 374
 ? Type???????? ??? Event
 ? Attributes?? ??? 0
 ? GrantedAccess??? 0x1f0003:
 ???????? Delete,ReadControl,WriteDac,WriteOwner,Synch
 ???????? QueryState,ModifyState
 ? HandleCount? ??? 2
 ? PointerCount ??? 32769
 ? Name???????? ??? <none>
 ? Object Specific Information
 ??? Event Type Auto Reset
 ??? Event is Waiting

These events seem to increase, but only one process gets to the limit of 
3x00 handles and then the other processes seem to hang ...


On 15/12/2020 12:18, Klaus Westkamp wrote:
> Hi,
>
>
> yes this is Dildale's last available package. Output of squid -v is as 
> follows:
>
> squid -v
>
> Squid Cache: Version 3.5.28
> Service Name: squid
>
> This binary uses OpenSSL 1.0.2j? 26 Sep 2016. For legal restrictions 
> on distribution see https://www.openssl.org/source/license.html
>
> configure options:? '--bindir=/bin/squid' '--sbindir=/usr/sbin/squid' 
> '--sysconfdir=/etc/squid' '--datadir=/usr/share/squid' 
> '--libexecdir=/usr/lib/squid'
> '--disable-strict-error-checking' '--with-logdir=/var/log/squid' 
> '--with-swapdir=/var/cache/squid' '--with-pidfile=/var/run/squid.pid' 
> '--enable-ssl'
> '--enable-delay-pools' '--enable-ssl-crtd' '--enable-icap-client' 
> '--disable-eui' '--localstatedir=/var/run/squid' 
> '--sharedstatedir=/var/run/squid'
> '--datarootdir=/usr/share/squid' 
> '--enable-disk-io=AIO,Blocking,DiskThreads,IpcIo,Mmapped' 
> '--enable-auth-basic=DB,LDAP,NCSA,POP3,RADIUS,SASL,SMB,fake,getpwnam'
> '--enable-auth-ntlm=fake' '--enable-auth-negotiate=kerberos,wrapper' 
> '--enable-external-acl-helpers=LDAP_group,SQL_session,eDirectory_userip,file_userip,kerberos_ldap_group,session,time_quota,unix_group,wbinfo_group' 
>
> '--with-openssl' '--with-filedescriptors=65536' 
> '--enable-removal-policies=lru,heap'
>
> The helper negotiate_kerberos_auth.exe doesn't produce a Version output.
>
>
> Best regards,
>
> Klaus Westkamp
>
>
> On 15/12/2020 09:10, Amos Jeffries wrote:
>> On 15/12/20 4:03 am, Klaus Westkamp wrote:
>>> Hi,
>>>
>>> i'm uncertain, wether this mailing list is the correct one to ask, 
>>> but i have the disputable honor to make a squid running on a Windows 
>>> Server (if possible). Whilst squid.exe seems to run fine, i 
>>> constantly run into an unresponsive system, when i enable Kerberos 
>>> authentication via auth_param and the negotiate_kerberos_auth.exe 
>>> helper.
>>>
>>> For a while authentication works fine, but all at the sudden the 
>>> system hangs at 100% CPU usage. My Observation is that one of the 
>>> negotiate_kerberos_auth.exe processes has a constantly increasing 
>>> number of handles (Files and events). If i understand the 
>>> Sysinternals handle tool correctly, most handles are event corrolated.
>>>
>>> The setting:
>>>
>>> Windows 2012 R2 AD Controllers with Windows 2008R2 Domain Level. A 
>>> Windows Server 2016 running Squid 3.5 for Windows.
>>
>> Is Squid the package built by Diladele or a custom build?
>>
>> Which exact version number is it? (output of "squid -v" please)
>>
>>
>> Amos
>> _______________________________________________
>> squid-users mailing list
>> squid-users at lists.squid-cache.org
>> http://lists.squid-cache.org/listinfo/squid-users


From ngtech1ltd at gmail.com  Wed Dec 16 12:48:58 2020
From: ngtech1ltd at gmail.com (Eliezer Croitor)
Date: Wed, 16 Dec 2020 14:48:58 +0200
Subject: [squid-users] Proxy Server closes the connection to http server
 before transferring all application data to http client
In-Reply-To: <CH2PR19MB408538EE1000A96ACA6734FBF0C50@CH2PR19MB4085.namprd19.prod.outlook.com>
References: <CH2PR19MB408562E2556D30B57562B2F5F0CA0@CH2PR19MB4085.namprd19.prod.outlook.com>
 <CH2PR19MB408598AA41CCA4FBE66E3790F0CA0@CH2PR19MB4085.namprd19.prod.outlook.com>
 <CH2PR19MB408533B96412E569A9499FFCF0C60@CH2PR19MB4085.namprd19.prod.outlook.com>
 <CH2PR19MB4085F0E24297427753F04109F0C60@CH2PR19MB4085.namprd19.prod.outlook.com>
 <CH2PR19MB4085EB136877C4B0962C489DF0C60@CH2PR19MB4085.namprd19.prod.outlook.com>
 <CH2PR19MB4085F051C425161521920792F0C60@CH2PR19MB4085.namprd19.prod.outlook.com>
 <CH2PR19MB40856412F76E6FF2C70CCFC6F0C60@CH2PR19MB4085.namprd19.prod.outlook.com>
 <010e01d6d2f1$21ee8780$65cb9680$@gmail.com>
 <CH2PR19MB408538EE1000A96ACA6734FBF0C50@CH2PR19MB4085.namprd19.prod.outlook.com>
Message-ID: <011301d6d3a9$d323c980$796b5c80$@gmail.com>

Probably it's the server side that does that.

I have seen such a thing in the past with couple webservers.

Depends on the language that the server uses it's possible to resolve this
issue.

If you have a specific language I can try to reproduce this issue to make
sure what the issue is.

Specifically in PHP there was something combined with nginx and apache.

I have not tried it with caddy or another web server that uses fastcgi.

 

Let me know if you need my assistance. 

Eliezer

 

----

Eliezer Croitoru

Tech Support

Mobile: +972-5-28704261

Email:  <mailto:eliezer at ngtech.co.il> eliezer at ngtech.co.il

 

From: Zhang, Lily (USD) <Lily.Zhang at dell.com> 
Sent: Wednesday, December 16, 2020 9:40 AM
To: Eliezer Croitor <ngtech1ltd at gmail.com>
Cc: squid-users at lists.squid-cache.org
Subject: RE: [squid-users] Proxy Server closes the connection to http server
before transferring all application data to http client

 

Hi Croitor,

 

I investigated this issue as I have tickets from customer side.  http client
can't get the full response sometimes (example 20 0000 char, get 17 0000
chars).

 

Thanks

Lily

From: Eliezer Croitor <ngtech1ltd at gmail.com <mailto:ngtech1ltd at gmail.com> > 
Sent: Tuesday, December 15, 2020 10:47 PM
To: Zhang, Lily (USD)
Cc: squid-users at lists.squid-cache.org
<mailto:squid-users at lists.squid-cache.org> 
Subject: RE: [squid-users] Proxy Server closes the connection to http server
before transferring all application data to http client

 

[EXTERNAL EMAIL] 

Hey Lily,

 

Is there any specific issue which made you aware of this issue?

 

Thanks,

Eliezer

 

----

Eliezer Croitoru

Tech Support

Mobile: +972-5-28704261

Email:  <mailto:eliezer at ngtech.co.il> eliezer at ngtech.co.il

 

From: squid-users <squid-users-bounces at lists.squid-cache.org
<mailto:squid-users-bounces at lists.squid-cache.org> > On Behalf Of Zhang,
Lily (USD)
Sent: Tuesday, December 15, 2020 5:21 AM
To: squid-users at lists.squid-cache.org
<mailto:squid-users at lists.squid-cache.org> 
Subject: [squid-users] Proxy Server closes the connection to http server
before transferring all application data to http client

 

Hi           

                            

I installed 4.13 squid proxy server. See attachment, http server
(10.250.16.46) sends FIN, ACK to tells that response is finished.  Proxy
server (10.244.102.133) sends FIN, ACK back to http server (10.250.16.46)
before "Application Data" is transferred to http client (10.245.166.20). 

 

Would you please help me on questions below:

1.	Is it normal that proxy server sends FIN, ACK to http server before
http client finishes receiving  all the "Application Data" ?
2.	Does proxy server have option to stop item 1?

 

Thanks

Lily

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20201216/56235209/attachment.htm>

From Lily.Zhang at dell.com  Wed Dec 16 12:53:11 2020
From: Lily.Zhang at dell.com (Zhang, Lily (USD))
Date: Wed, 16 Dec 2020 12:53:11 +0000
Subject: [squid-users] Proxy Server closes the connection to http server
 before transferring all application data to http client
In-Reply-To: <011301d6d3a9$d323c980$796b5c80$@gmail.com>
References: <CH2PR19MB408562E2556D30B57562B2F5F0CA0@CH2PR19MB4085.namprd19.prod.outlook.com>
 <CH2PR19MB408598AA41CCA4FBE66E3790F0CA0@CH2PR19MB4085.namprd19.prod.outlook.com>
 <CH2PR19MB408533B96412E569A9499FFCF0C60@CH2PR19MB4085.namprd19.prod.outlook.com>
 <CH2PR19MB4085F0E24297427753F04109F0C60@CH2PR19MB4085.namprd19.prod.outlook.com>
 <CH2PR19MB4085EB136877C4B0962C489DF0C60@CH2PR19MB4085.namprd19.prod.outlook.com>
 <CH2PR19MB4085F051C425161521920792F0C60@CH2PR19MB4085.namprd19.prod.outlook.com>
 <CH2PR19MB40856412F76E6FF2C70CCFC6F0C60@CH2PR19MB4085.namprd19.prod.outlook.com>
 <010e01d6d2f1$21ee8780$65cb9680$@gmail.com>
 <CH2PR19MB408538EE1000A96ACA6734FBF0C50@CH2PR19MB4085.namprd19.prod.outlook.com>
 <011301d6d3a9$d323c980$796b5c80$@gmail.com>
Message-ID: <CH2PR19MB408548D0C504D0BCCBE6C820F0C50@CH2PR19MB4085.namprd19.prod.outlook.com>

Hi Croitor,

Thanks.  Issue disappears after we use "connection: keep-alive" in both http client and http server. Don't need further assistance now.

Thanks
Lily

From: Eliezer Croitor <ngtech1ltd at gmail.com>
Sent: Wednesday, December 16, 2020 8:49 PM
To: Zhang, Lily (USD)
Cc: squid-users at lists.squid-cache.org
Subject: RE: [squid-users] Proxy Server closes the connection to http server before transferring all application data to http client


[EXTERNAL EMAIL]
Probably it's the server side that does that.
I have seen such a thing in the past with couple webservers.
Depends on the language that the server uses it's possible to resolve this issue.
If you have a specific language I can try to reproduce this issue to make sure what the issue is.
Specifically in PHP there was something combined with nginx and apache.
I have not tried it with caddy or another web server that uses fastcgi.

Let me know if you need my assistance.
Eliezer

----
Eliezer Croitoru
Tech Support
Mobile: +972-5-28704261
Email: eliezer at ngtech.co.il<mailto:eliezer at ngtech.co.il>

From: Zhang, Lily (USD) <Lily.Zhang at dell.com<mailto:Lily.Zhang at dell.com>>
Sent: Wednesday, December 16, 2020 9:40 AM
To: Eliezer Croitor <ngtech1ltd at gmail.com<mailto:ngtech1ltd at gmail.com>>
Cc: squid-users at lists.squid-cache.org<mailto:squid-users at lists.squid-cache.org>
Subject: RE: [squid-users] Proxy Server closes the connection to http server before transferring all application data to http client

Hi Croitor,


I investigated this issue as I have tickets from customer side.  http client can't get the full response sometimes (example 20 0000 char, get 17 0000 chars).

Thanks
Lily
From: Eliezer Croitor <ngtech1ltd at gmail.com<mailto:ngtech1ltd at gmail.com>>
Sent: Tuesday, December 15, 2020 10:47 PM
To: Zhang, Lily (USD)
Cc: squid-users at lists.squid-cache.org<mailto:squid-users at lists.squid-cache.org>
Subject: RE: [squid-users] Proxy Server closes the connection to http server before transferring all application data to http client


[EXTERNAL EMAIL]
Hey Lily,

Is there any specific issue which made you aware of this issue?

Thanks,
Eliezer

----
Eliezer Croitoru
Tech Support
Mobile: +972-5-28704261
Email: eliezer at ngtech.co.il<mailto:eliezer at ngtech.co.il>

From: squid-users <squid-users-bounces at lists.squid-cache.org<mailto:squid-users-bounces at lists.squid-cache.org>> On Behalf Of Zhang, Lily (USD)
Sent: Tuesday, December 15, 2020 5:21 AM
To: squid-users at lists.squid-cache.org<mailto:squid-users at lists.squid-cache.org>
Subject: [squid-users] Proxy Server closes the connection to http server before transferring all application data to http client

Hi

I installed 4.13 squid proxy server. See attachment, http server (10.250.16.46) sends FIN, ACK to tells that response is finished.  Proxy server (10.244.102.133) sends FIN, ACK back to http server (10.250.16.46) before "Application Data" is transferred to http client (10.245.166.20).

Would you please help me on questions below:

  1.  Is it normal that proxy server sends FIN, ACK to http server before http client finishes receiving  all the "Application Data" ?
  2.  Does proxy server have option to stop item 1?

Thanks
Lily
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20201216/eb2bc253/attachment.htm>

From rousskov at measurement-factory.com  Wed Dec 16 14:50:02 2020
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Wed, 16 Dec 2020 09:50:02 -0500
Subject: [squid-users] Proxy Server closes the connection to http server
 before transferring all application data to http client
In-Reply-To: <CH2PR19MB4085700DAD3B2F255E65CBC8F0C50@CH2PR19MB4085.namprd19.prod.outlook.com>
References: <CH2PR19MB408562E2556D30B57562B2F5F0CA0@CH2PR19MB4085.namprd19.prod.outlook.com>
 <CH2PR19MB408598AA41CCA4FBE66E3790F0CA0@CH2PR19MB4085.namprd19.prod.outlook.com>
 <CH2PR19MB408533B96412E569A9499FFCF0C60@CH2PR19MB4085.namprd19.prod.outlook.com>
 <CH2PR19MB4085F0E24297427753F04109F0C60@CH2PR19MB4085.namprd19.prod.outlook.com>
 <CH2PR19MB4085EB136877C4B0962C489DF0C60@CH2PR19MB4085.namprd19.prod.outlook.com>
 <CH2PR19MB4085F051C425161521920792F0C60@CH2PR19MB4085.namprd19.prod.outlook.com>
 <CH2PR19MB40856412F76E6FF2C70CCFC6F0C60@CH2PR19MB4085.namprd19.prod.outlook.com>
 <812f6027-e193-548a-7f51-c9ee242e56af@treenet.co.nz>
 <CH2PR19MB4085702A69D77EB2B710C1A5F0C60@CH2PR19MB4085.namprd19.prod.outlook.com>
 <3ae87c34-587a-eb5f-54a7-fde3d10a385f@measurement-factory.com>
 <CH2PR19MB40852144253391BC98A87E3BF0C50@CH2PR19MB4085.namprd19.prod.outlook.com>
 <CH2PR19MB4085700DAD3B2F255E65CBC8F0C50@CH2PR19MB4085.namprd19.prod.outlook.com>
Message-ID: <863fdc6c-66d5-8462-a16a-8b1c0662c45c@measurement-factory.com>

On 12/16/20 4:02 AM, Zhang, Lily (USD) wrote:

> Issue still can be reproduced when http client using connection: close, and http server uses connection: keep-alive.
> I can't reproduce this issue when both side using keep-alive.

When everything works as it should, the HTTP Connection header has no
effect on the data transfer during the transaction that header belongs
to. Both "close" and "keep-alive" instructions tell the agents what to
do _after_ the entire response body is delivered from the server to the
client. This is just how HTTP works... Thus, what you are describing
suggests a bug in client software, server software, Squid, and/or the test.

Going forward:

* If you do not need further assistance and do not want to work to
discover the true cause of the problem, then just ignore this message. I
am glad you found a workaround, and we can leave it at that.

* Otherwise, the best next step may be to share Squid debugging logs
while reproducing the problem in the lab. If you want to work on that,
respond to this message and somebody will send you more detailed
instructions.


Cheers,

Alex.


> -----Original Message-----
> From: Zhang, Lily (USD) 
> Sent: Wednesday, December 16, 2020 3:29 PM
> To: Alex Rousskov; squid-users at lists.squid-cache.org
> Subject: RE: [squid-users] Proxy Server closes the connection to http server before transferring all application data to http client
> 
> Hi Alex,
> Thanks for your reply.
> 
> At first, http server turns off  keep-alive, then http client can't get the full response sometimes (example 20 0000 char, get 17 0000 chars).
> 
> I did a test in the lab, found 
> 
> 1. If http client uses connection: close, and http server uses connection: keep-alive, then still can transfer data after tcp connection between http server and proxy server is closed.  (don't know how this happens)
> 
> 2. If http client uses connection: keep-alive, and http server uses connection: keep-alive, then connection between http server and proxy server won't closed first. It is closed after client closes the connection.
> 
> Thanks
> Lily
> -----Original Message-----
> From: Alex Rousskov <rousskov at measurement-factory.com> 
> Sent: Tuesday, December 15, 2020 11:53 PM
> To: squid-users at lists.squid-cache.org
> Cc: Zhang, Lily (USD)
> Subject: Re: [squid-users] Proxy Server closes the connection to http server before transferring all application data to http client
> 
> 
> [EXTERNAL EMAIL] 
> 
> On 12/15/20 2:52 AM, Zhang, Lily (USD) wrote:
> 
>> Looks we can use "Connection: keep-alive" in http request to solve this issue.
> 
> That client request header will not change Squid's reaction to Squid-server connection closure by the server. It also should not change the request that Squid sends to the server (if it does, it is a Squid bug). In HTTP proxying, client-Squid and Squid-server connections/negotiations are mostly independent.
> 
> If changing the client to send Connection:keep-alive to Squid fixes your problem, then the problem was most likely unrelated to the behavior you asked about earlier.
> 
> If you can configure the HTTP server to keep the connection open/persistent after delivering the response (and, hence, to send a Connection:keep-alive _response_ header or otherwise signal HTTP connection persistency), then, yes, Squid may pool that _open_ Squid-server connection for future reuse (again, regardless of what headers the HTTP client is using).
> 
> Alex.
> 
> 
> 
>> -----Original Message-----
>> From: squid-users <squid-users-bounces at lists.squid-cache.org> On 
>> Behalf Of Amos Jeffries
>> Sent: Tuesday, December 15, 2020 3:47 PM
>> To: squid-users at lists.squid-cache.org
>> Subject: Re: [squid-users] Proxy Server closes the connection to http 
>> server before transferring all application data to http client
>>
>>
>> [EXTERNAL EMAIL]
>>
>> On 15/12/20 4:21 pm, Zhang, Lily (USD) wrote:
>>> Hi
>>>
>>> I installed 4.13 squid proxy server. See attachment, http server
>>> (10.250.16.46) sends FIN, ACK to tells that response is finished. 
>>> Proxy server (10.244.102.133) sends FIN, ACK back to http server
>>> (10.250.16.46) before "Application Data" is transferred to http 
>>> client (10.245.166.20).
>>>
>>> Would you please help me on questions below:
>>>
>>>  1. Is it normal that proxy server sends FIN, ACK to http server before
>>>     http client finishes receiving ?all the ?Application Data? ?
>>
>> That depends on the transaction which is being performed.
>>
>> If it is a normal HTTP request-response transaction then yes. Once Squid has the response the server connection is done with - it may be closed or re-used for other transactions.
>>
>> If it is a tunnel containing non-HTTP traffic then no. Squid should only close the server connection when the client closes its end of the tunnel.
>>
>> Also, note that FIN+ACK in a single packet is a *response* to a FIN having come from the server itself. Not initiated by the proxy.
>>
>>
>>
>>>  2. Does proxy server have option to stop item 1?
>>>
>>
>> In general: No. This is something that is supposed to happen (or not) 
>> according to the relevant protocol requirements.
>>
>> In specific, there may be some options that can be configured to 
>> change how the protocol behaves. Preventing it needing a close. You 
>> will have to find out what the cause actually is to determine where to 
>> look for solutions.
>>
>>
>> Amos
>>
>> _______________________________________________
>> squid-users mailing list
>> squid-users at lists.squid-cache.org
>> http://lists.squid-cache.org/listinfo/squid-users
>> _______________________________________________
>> squid-users mailing list
>> squid-users at lists.squid-cache.org
>> http://lists.squid-cache.org/listinfo/squid-users
>>
> 



From Lily.Zhang at dell.com  Thu Dec 17 08:31:34 2020
From: Lily.Zhang at dell.com (Zhang, Lily (USD))
Date: Thu, 17 Dec 2020 08:31:34 +0000
Subject: [squid-users] Proxy Server closes the connection to http server
 before transferring all application data to http client
In-Reply-To: <863fdc6c-66d5-8462-a16a-8b1c0662c45c@measurement-factory.com>
References: <CH2PR19MB408562E2556D30B57562B2F5F0CA0@CH2PR19MB4085.namprd19.prod.outlook.com>
 <CH2PR19MB408598AA41CCA4FBE66E3790F0CA0@CH2PR19MB4085.namprd19.prod.outlook.com>
 <CH2PR19MB408533B96412E569A9499FFCF0C60@CH2PR19MB4085.namprd19.prod.outlook.com>
 <CH2PR19MB4085F0E24297427753F04109F0C60@CH2PR19MB4085.namprd19.prod.outlook.com>
 <CH2PR19MB4085EB136877C4B0962C489DF0C60@CH2PR19MB4085.namprd19.prod.outlook.com>
 <CH2PR19MB4085F051C425161521920792F0C60@CH2PR19MB4085.namprd19.prod.outlook.com>
 <CH2PR19MB40856412F76E6FF2C70CCFC6F0C60@CH2PR19MB4085.namprd19.prod.outlook.com>
 <812f6027-e193-548a-7f51-c9ee242e56af@treenet.co.nz>
 <CH2PR19MB4085702A69D77EB2B710C1A5F0C60@CH2PR19MB4085.namprd19.prod.outlook.com>
 <3ae87c34-587a-eb5f-54a7-fde3d10a385f@measurement-factory.com>
 <CH2PR19MB40852144253391BC98A87E3BF0C50@CH2PR19MB4085.namprd19.prod.outlook.com>
 <CH2PR19MB4085700DAD3B2F255E65CBC8F0C50@CH2PR19MB4085.namprd19.prod.outlook.com>
 <863fdc6c-66d5-8462-a16a-8b1c0662c45c@measurement-factory.com>
Message-ID: <CH2PR19MB4085EA01668436A8D2AD7064F0C40@CH2PR19MB4085.namprd19.prod.outlook.com>

Hi Alex,

//If you want to work on that, respond to this message and somebody will send you more detailed instructions.//
Yes, please tell me how to do this.  

I am curious of 
1. When http client uses close, and server uses keep-alive, when connection between proxy server and http server is closed, it still can transfer data between client and proxy server, and data transfer to http client is not completed sometimes.

2. When http client uses close, and server uses closes, no data transfer from http client and proxy server after http server closes the connection.  Case 2 meets the description https://curl.se/mail/lib-2013-01/0246.html, client get error code CURLE_UNSUPPORTED_PROTOCOL which tells that connection was shutdown.

Thanks
Lily

-----Original Message-----
From: Alex Rousskov <rousskov at measurement-factory.com> 
Sent: Wednesday, December 16, 2020 10:50 PM
To: Zhang, Lily (USD); squid-users at lists.squid-cache.org
Subject: Re: [squid-users] Proxy Server closes the connection to http server before transferring all application data to http client


[EXTERNAL EMAIL] 

On 12/16/20 4:02 AM, Zhang, Lily (USD) wrote:

> Issue still can be reproduced when http client using connection: close, and http server uses connection: keep-alive.
> I can't reproduce this issue when both side using keep-alive.

When everything works as it should, the HTTP Connection header has no effect on the data transfer during the transaction that header belongs to. Both "close" and "keep-alive" instructions tell the agents what to do _after_ the entire response body is delivered from the server to the client. This is just how HTTP works... Thus, what you are describing suggests a bug in client software, server software, Squid, and/or the test.

Going forward:

* If you do not need further assistance and do not want to work to discover the true cause of the problem, then just ignore this message. I am glad you found a workaround, and we can leave it at that.

* Otherwise, the best next step may be to share Squid debugging logs while reproducing the problem in the lab. If you want to work on that, respond to this message and somebody will send you more detailed instructions.


Cheers,

Alex.


> -----Original Message-----
> From: Zhang, Lily (USD)
> Sent: Wednesday, December 16, 2020 3:29 PM
> To: Alex Rousskov; squid-users at lists.squid-cache.org
> Subject: RE: [squid-users] Proxy Server closes the connection to http 
> server before transferring all application data to http client
> 
> Hi Alex,
> Thanks for your reply.
> 
> At first, http server turns off  keep-alive, then http client can't get the full response sometimes (example 20 0000 char, get 17 0000 chars).
> 
> I did a test in the lab, found
> 
> 1. If http client uses connection: close, and http server uses 
> connection: keep-alive, then still can transfer data after tcp 
> connection between http server and proxy server is closed.  (don't 
> know how this happens)
> 
> 2. If http client uses connection: keep-alive, and http server uses connection: keep-alive, then connection between http server and proxy server won't closed first. It is closed after client closes the connection.
> 
> Thanks
> Lily
> -----Original Message-----
> From: Alex Rousskov <rousskov at measurement-factory.com>
> Sent: Tuesday, December 15, 2020 11:53 PM
> To: squid-users at lists.squid-cache.org
> Cc: Zhang, Lily (USD)
> Subject: Re: [squid-users] Proxy Server closes the connection to http 
> server before transferring all application data to http client
> 
> 
> [EXTERNAL EMAIL]
> 
> On 12/15/20 2:52 AM, Zhang, Lily (USD) wrote:
> 
>> Looks we can use "Connection: keep-alive" in http request to solve this issue.
> 
> That client request header will not change Squid's reaction to Squid-server connection closure by the server. It also should not change the request that Squid sends to the server (if it does, it is a Squid bug). In HTTP proxying, client-Squid and Squid-server connections/negotiations are mostly independent.
> 
> If changing the client to send Connection:keep-alive to Squid fixes your problem, then the problem was most likely unrelated to the behavior you asked about earlier.
> 
> If you can configure the HTTP server to keep the connection open/persistent after delivering the response (and, hence, to send a Connection:keep-alive _response_ header or otherwise signal HTTP connection persistency), then, yes, Squid may pool that _open_ Squid-server connection for future reuse (again, regardless of what headers the HTTP client is using).
> 
> Alex.
> 
> 
> 
>> -----Original Message-----
>> From: squid-users <squid-users-bounces at lists.squid-cache.org> On 
>> Behalf Of Amos Jeffries
>> Sent: Tuesday, December 15, 2020 3:47 PM
>> To: squid-users at lists.squid-cache.org
>> Subject: Re: [squid-users] Proxy Server closes the connection to http 
>> server before transferring all application data to http client
>>
>>
>> [EXTERNAL EMAIL]
>>
>> On 15/12/20 4:21 pm, Zhang, Lily (USD) wrote:
>>> Hi
>>>
>>> I installed 4.13 squid proxy server. See attachment, http server
>>> (10.250.16.46) sends FIN, ACK to tells that response is finished. 
>>> Proxy server (10.244.102.133) sends FIN, ACK back to http server
>>> (10.250.16.46) before "Application Data" is transferred to http 
>>> client (10.245.166.20).
>>>
>>> Would you please help me on questions below:
>>>
>>>  1. Is it normal that proxy server sends FIN, ACK to http server before
>>>     http client finishes receiving ?all the ?Application Data? ?
>>
>> That depends on the transaction which is being performed.
>>
>> If it is a normal HTTP request-response transaction then yes. Once Squid has the response the server connection is done with - it may be closed or re-used for other transactions.
>>
>> If it is a tunnel containing non-HTTP traffic then no. Squid should only close the server connection when the client closes its end of the tunnel.
>>
>> Also, note that FIN+ACK in a single packet is a *response* to a FIN having come from the server itself. Not initiated by the proxy.
>>
>>
>>
>>>  2. Does proxy server have option to stop item 1?
>>>
>>
>> In general: No. This is something that is supposed to happen (or not) 
>> according to the relevant protocol requirements.
>>
>> In specific, there may be some options that can be configured to 
>> change how the protocol behaves. Preventing it needing a close. You 
>> will have to find out what the cause actually is to determine where 
>> to look for solutions.
>>
>>
>> Amos
>>
>> _______________________________________________
>> squid-users mailing list
>> squid-users at lists.squid-cache.org
>> http://lists.squid-cache.org/listinfo/squid-users
>> _______________________________________________
>> squid-users mailing list
>> squid-users at lists.squid-cache.org
>> http://lists.squid-cache.org/listinfo/squid-users
>>
> 


From ngtech1ltd at gmail.com  Thu Dec 17 09:28:49 2020
From: ngtech1ltd at gmail.com (Eliezer Croitor)
Date: Thu, 17 Dec 2020 11:28:49 +0200
Subject: [squid-users] What is the state of V5 branch? Can I try to publish
 some RPMS?
Message-ID: <!&!AAAAAAAAAAAuAAAAAAAAAGg7dk9mYqJGhbBt3m/ghGwBAMO2jhD3dRHOtM0AqgC7tuYAAAAAAA4AABAAAAC83OVyby6rRYk1AIQfIcCyAQAAAAA=@gmail.com>

Hey,

 

Next year I will start publishing RPMs for Squid again.

What is the state of V5? What should be verified or tested with V5?

 

Thanks,

Eliezer

 

----

Eliezer Croitoru

Tech Support

Mobile: +972-5-28704261

Email:  <mailto:eliezer at ngtech.co.il> eliezer at ngtech.co.il

 

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20201217/a671dac3/attachment.htm>

From rousskov at measurement-factory.com  Thu Dec 17 17:33:02 2020
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Thu, 17 Dec 2020 12:33:02 -0500
Subject: [squid-users] Proxy Server closes the connection to http server
 before transferring all application data to http client
In-Reply-To: <CH2PR19MB4085EA01668436A8D2AD7064F0C40@CH2PR19MB4085.namprd19.prod.outlook.com>
References: <CH2PR19MB408562E2556D30B57562B2F5F0CA0@CH2PR19MB4085.namprd19.prod.outlook.com>
 <CH2PR19MB4085F0E24297427753F04109F0C60@CH2PR19MB4085.namprd19.prod.outlook.com>
 <CH2PR19MB4085EB136877C4B0962C489DF0C60@CH2PR19MB4085.namprd19.prod.outlook.com>
 <CH2PR19MB4085F051C425161521920792F0C60@CH2PR19MB4085.namprd19.prod.outlook.com>
 <CH2PR19MB40856412F76E6FF2C70CCFC6F0C60@CH2PR19MB4085.namprd19.prod.outlook.com>
 <812f6027-e193-548a-7f51-c9ee242e56af@treenet.co.nz>
 <CH2PR19MB4085702A69D77EB2B710C1A5F0C60@CH2PR19MB4085.namprd19.prod.outlook.com>
 <3ae87c34-587a-eb5f-54a7-fde3d10a385f@measurement-factory.com>
 <CH2PR19MB40852144253391BC98A87E3BF0C50@CH2PR19MB4085.namprd19.prod.outlook.com>
 <CH2PR19MB4085700DAD3B2F255E65CBC8F0C50@CH2PR19MB4085.namprd19.prod.outlook.com>
 <863fdc6c-66d5-8462-a16a-8b1c0662c45c@measurement-factory.com>
 <CH2PR19MB4085EA01668436A8D2AD7064F0C40@CH2PR19MB4085.namprd19.prod.outlook.com>
Message-ID: <ebeaf6ea-c41e-7c8a-6c95-72fedf103172@measurement-factory.com>

On 12/17/20 3:31 AM, Zhang, Lily (USD) wrote:

>> If you want to work on that, respond to this message and somebody will send you more detailed instructions.

> Yes, please tell me how to do this.  

Please try the procedure described at
https://wiki.squid-cache.org/SquidFaq/BugReporting#Debugging_a_single_transaction

In your case, if possible, use a single problematic master transaction
(including client-Squid and Squid-server HTTP transactions) -- the one
that results in response truncation. I recommend "ALL,9" debugging for
this case. Please share a link to the _compressed_ log.


> I am curious of 

> 1. When http client uses close, and server uses keep-alive, when
> connection between proxy server and http server is closed, it still
> can transfer data between client and proxy server,

Yes, Squid should send the rest of the response to the client after the
server sent the entire response to Squid.

Whether the server closed the connection after sending the entire
response is irrelevant (except for special cases where the end of
response is determined by the connection closure).


> and data transfer to http client is not completed sometimes.

That is a mystery you want to solve.


> 2. When http client uses close, and server uses closes, no data
> transfer from http client and proxy server after http server closes
> the connection.

I assume that by "from http client and proxy" you meant "to http client
from proxy".

That is another mystery you want to solve.

Hopefully, debugging logs will help us solve both mysteries.

Alex.


> -----Original Message-----
> From: Alex Rousskov <rousskov at measurement-factory.com> 
> Sent: Wednesday, December 16, 2020 10:50 PM
> To: Zhang, Lily (USD); squid-users at lists.squid-cache.org
> Subject: Re: [squid-users] Proxy Server closes the connection to http server before transferring all application data to http client
> 
> 
> [EXTERNAL EMAIL] 
> 
> On 12/16/20 4:02 AM, Zhang, Lily (USD) wrote:
> 
>> Issue still can be reproduced when http client using connection: close, and http server uses connection: keep-alive.
>> I can't reproduce this issue when both side using keep-alive.
> 
> When everything works as it should, the HTTP Connection header has no effect on the data transfer during the transaction that header belongs to. Both "close" and "keep-alive" instructions tell the agents what to do _after_ the entire response body is delivered from the server to the client. This is just how HTTP works... Thus, what you are describing suggests a bug in client software, server software, Squid, and/or the test.
> 
> Going forward:
> 
> * If you do not need further assistance and do not want to work to discover the true cause of the problem, then just ignore this message. I am glad you found a workaround, and we can leave it at that.
> 
> * Otherwise, the best next step may be to share Squid debugging logs while reproducing the problem in the lab. If you want to work on that, respond to this message and somebody will send you more detailed instructions.
> 
> 
> Cheers,
> 
> Alex.
> 
> 
>> -----Original Message-----
>> From: Zhang, Lily (USD)
>> Sent: Wednesday, December 16, 2020 3:29 PM
>> To: Alex Rousskov; squid-users at lists.squid-cache.org
>> Subject: RE: [squid-users] Proxy Server closes the connection to http 
>> server before transferring all application data to http client
>>
>> Hi Alex,
>> Thanks for your reply.
>>
>> At first, http server turns off  keep-alive, then http client can't get the full response sometimes (example 20 0000 char, get 17 0000 chars).
>>
>> I did a test in the lab, found
>>
>> 1. If http client uses connection: close, and http server uses 
>> connection: keep-alive, then still can transfer data after tcp 
>> connection between http server and proxy server is closed.  (don't 
>> know how this happens)
>>
>> 2. If http client uses connection: keep-alive, and http server uses connection: keep-alive, then connection between http server and proxy server won't closed first. It is closed after client closes the connection.
>>
>> Thanks
>> Lily
>> -----Original Message-----
>> From: Alex Rousskov <rousskov at measurement-factory.com>
>> Sent: Tuesday, December 15, 2020 11:53 PM
>> To: squid-users at lists.squid-cache.org
>> Cc: Zhang, Lily (USD)
>> Subject: Re: [squid-users] Proxy Server closes the connection to http 
>> server before transferring all application data to http client
>>
>>
>> [EXTERNAL EMAIL]
>>
>> On 12/15/20 2:52 AM, Zhang, Lily (USD) wrote:
>>
>>> Looks we can use "Connection: keep-alive" in http request to solve this issue.
>>
>> That client request header will not change Squid's reaction to Squid-server connection closure by the server. It also should not change the request that Squid sends to the server (if it does, it is a Squid bug). In HTTP proxying, client-Squid and Squid-server connections/negotiations are mostly independent.
>>
>> If changing the client to send Connection:keep-alive to Squid fixes your problem, then the problem was most likely unrelated to the behavior you asked about earlier.
>>
>> If you can configure the HTTP server to keep the connection open/persistent after delivering the response (and, hence, to send a Connection:keep-alive _response_ header or otherwise signal HTTP connection persistency), then, yes, Squid may pool that _open_ Squid-server connection for future reuse (again, regardless of what headers the HTTP client is using).
>>
>> Alex.
>>
>>
>>
>>> -----Original Message-----
>>> From: squid-users <squid-users-bounces at lists.squid-cache.org> On 
>>> Behalf Of Amos Jeffries
>>> Sent: Tuesday, December 15, 2020 3:47 PM
>>> To: squid-users at lists.squid-cache.org
>>> Subject: Re: [squid-users] Proxy Server closes the connection to http 
>>> server before transferring all application data to http client
>>>
>>>
>>> [EXTERNAL EMAIL]
>>>
>>> On 15/12/20 4:21 pm, Zhang, Lily (USD) wrote:
>>>> Hi
>>>>
>>>> I installed 4.13 squid proxy server. See attachment, http server
>>>> (10.250.16.46) sends FIN, ACK to tells that response is finished. 
>>>> Proxy server (10.244.102.133) sends FIN, ACK back to http server
>>>> (10.250.16.46) before "Application Data" is transferred to http 
>>>> client (10.245.166.20).
>>>>
>>>> Would you please help me on questions below:
>>>>
>>>>  1. Is it normal that proxy server sends FIN, ACK to http server before
>>>>     http client finishes receiving ?all the ?Application Data? ?
>>>
>>> That depends on the transaction which is being performed.
>>>
>>> If it is a normal HTTP request-response transaction then yes. Once Squid has the response the server connection is done with - it may be closed or re-used for other transactions.
>>>
>>> If it is a tunnel containing non-HTTP traffic then no. Squid should only close the server connection when the client closes its end of the tunnel.
>>>
>>> Also, note that FIN+ACK in a single packet is a *response* to a FIN having come from the server itself. Not initiated by the proxy.
>>>
>>>
>>>
>>>>  2. Does proxy server have option to stop item 1?
>>>>
>>>
>>> In general: No. This is something that is supposed to happen (or not) 
>>> according to the relevant protocol requirements.
>>>
>>> In specific, there may be some options that can be configured to 
>>> change how the protocol behaves. Preventing it needing a close. You 
>>> will have to find out what the cause actually is to determine where 
>>> to look for solutions.
>>>
>>>
>>> Amos
>>>
>>> _______________________________________________
>>> squid-users mailing list
>>> squid-users at lists.squid-cache.org
>>> http://lists.squid-cache.org/listinfo/squid-users
>>> _______________________________________________
>>> squid-users mailing list
>>> squid-users at lists.squid-cache.org
>>> http://lists.squid-cache.org/listinfo/squid-users
>>>
>>
> 



From Lily.Zhang at dell.com  Fri Dec 18 11:10:51 2020
From: Lily.Zhang at dell.com (Zhang, Lily (USD))
Date: Fri, 18 Dec 2020 11:10:51 +0000
Subject: [squid-users] Proxy Server closes the connection to http server
 before transferring all application data to http client
In-Reply-To: <ebeaf6ea-c41e-7c8a-6c95-72fedf103172@measurement-factory.com>
References: <CH2PR19MB408562E2556D30B57562B2F5F0CA0@CH2PR19MB4085.namprd19.prod.outlook.com>
 <CH2PR19MB4085F0E24297427753F04109F0C60@CH2PR19MB4085.namprd19.prod.outlook.com>
 <CH2PR19MB4085EB136877C4B0962C489DF0C60@CH2PR19MB4085.namprd19.prod.outlook.com>
 <CH2PR19MB4085F051C425161521920792F0C60@CH2PR19MB4085.namprd19.prod.outlook.com>
 <CH2PR19MB40856412F76E6FF2C70CCFC6F0C60@CH2PR19MB4085.namprd19.prod.outlook.com>
 <812f6027-e193-548a-7f51-c9ee242e56af@treenet.co.nz>
 <CH2PR19MB4085702A69D77EB2B710C1A5F0C60@CH2PR19MB4085.namprd19.prod.outlook.com>
 <3ae87c34-587a-eb5f-54a7-fde3d10a385f@measurement-factory.com>
 <CH2PR19MB40852144253391BC98A87E3BF0C50@CH2PR19MB4085.namprd19.prod.outlook.com>
 <CH2PR19MB4085700DAD3B2F255E65CBC8F0C50@CH2PR19MB4085.namprd19.prod.outlook.com>
 <863fdc6c-66d5-8462-a16a-8b1c0662c45c@measurement-factory.com>
 <CH2PR19MB4085EA01668436A8D2AD7064F0C40@CH2PR19MB4085.namprd19.prod.outlook.com>
 <ebeaf6ea-c41e-7c8a-6c95-72fedf103172@measurement-factory.com>
Message-ID: <CH2PR19MB4085F1D80DEDA36FC4ACF6C6F0C30@CH2PR19MB4085.namprd19.prod.outlook.com>

Hi Alex

I reproduced this issue when http client/server uses http connection: close.  See attached log file ( I don't know how to share a link to you). 

Http client use libcurl,  curl_easy_recv API returns CURLE_UNSUPPORTED_PROTOCOL,    /* 1 */
This meets the description https://curl.se/mail/lib-2013-01/0246.html , CURLE_UNSUPPORTED_PROTOCOL  means that connection was shutdown.

10.105.8.55 is http server ip, 10.245.166.20 is the http client ip, 10.244.102.133 is proxy server's ip. 

Thanks
Lily

-----Original Message-----
From: Alex Rousskov <rousskov at measurement-factory.com> 
Sent: Friday, December 18, 2020 1:33 AM
To: Zhang, Lily (USD); squid-users at lists.squid-cache.org
Subject: Re: [squid-users] Proxy Server closes the connection to http server before transferring all application data to http client


[EXTERNAL EMAIL] 

On 12/17/20 3:31 AM, Zhang, Lily (USD) wrote:

>> If you want to work on that, respond to this message and somebody will send you more detailed instructions.

> Yes, please tell me how to do this.  

Please try the procedure described at
https://wiki.squid-cache.org/SquidFaq/BugReporting#Debugging_a_single_transaction

In your case, if possible, use a single problematic master transaction (including client-Squid and Squid-server HTTP transactions) -- the one that results in response truncation. I recommend "ALL,9" debugging for this case. Please share a link to the _compressed_ log.


> I am curious of

> 1. When http client uses close, and server uses keep-alive, when 
> connection between proxy server and http server is closed, it still 
> can transfer data between client and proxy server,

Yes, Squid should send the rest of the response to the client after the server sent the entire response to Squid.

Whether the server closed the connection after sending the entire response is irrelevant (except for special cases where the end of response is determined by the connection closure).


> and data transfer to http client is not completed sometimes.

That is a mystery you want to solve.


> 2. When http client uses close, and server uses closes, no data 
> transfer from http client and proxy server after http server closes 
> the connection.

I assume that by "from http client and proxy" you meant "to http client from proxy".

That is another mystery you want to solve.

Hopefully, debugging logs will help us solve both mysteries.

Alex.


> -----Original Message-----
> From: Alex Rousskov <rousskov at measurement-factory.com>
> Sent: Wednesday, December 16, 2020 10:50 PM
> To: Zhang, Lily (USD); squid-users at lists.squid-cache.org
> Subject: Re: [squid-users] Proxy Server closes the connection to http 
> server before transferring all application data to http client
> 
> 
> [EXTERNAL EMAIL]
> 
> On 12/16/20 4:02 AM, Zhang, Lily (USD) wrote:
> 
>> Issue still can be reproduced when http client using connection: close, and http server uses connection: keep-alive.
>> I can't reproduce this issue when both side using keep-alive.
> 
> When everything works as it should, the HTTP Connection header has no effect on the data transfer during the transaction that header belongs to. Both "close" and "keep-alive" instructions tell the agents what to do _after_ the entire response body is delivered from the server to the client. This is just how HTTP works... Thus, what you are describing suggests a bug in client software, server software, Squid, and/or the test.
> 
> Going forward:
> 
> * If you do not need further assistance and do not want to work to discover the true cause of the problem, then just ignore this message. I am glad you found a workaround, and we can leave it at that.
> 
> * Otherwise, the best next step may be to share Squid debugging logs while reproducing the problem in the lab. If you want to work on that, respond to this message and somebody will send you more detailed instructions.
> 
> 
> Cheers,
> 
> Alex.
> 
> 
>> -----Original Message-----
>> From: Zhang, Lily (USD)
>> Sent: Wednesday, December 16, 2020 3:29 PM
>> To: Alex Rousskov; squid-users at lists.squid-cache.org
>> Subject: RE: [squid-users] Proxy Server closes the connection to http 
>> server before transferring all application data to http client
>>
>> Hi Alex,
>> Thanks for your reply.
>>
>> At first, http server turns off  keep-alive, then http client can't get the full response sometimes (example 20 0000 char, get 17 0000 chars).
>>
>> I did a test in the lab, found
>>
>> 1. If http client uses connection: close, and http server uses
>> connection: keep-alive, then still can transfer data after tcp 
>> connection between http server and proxy server is closed.  (don't 
>> know how this happens)
>>
>> 2. If http client uses connection: keep-alive, and http server uses connection: keep-alive, then connection between http server and proxy server won't closed first. It is closed after client closes the connection.
>>
>> Thanks
>> Lily
>> -----Original Message-----
>> From: Alex Rousskov <rousskov at measurement-factory.com>
>> Sent: Tuesday, December 15, 2020 11:53 PM
>> To: squid-users at lists.squid-cache.org
>> Cc: Zhang, Lily (USD)
>> Subject: Re: [squid-users] Proxy Server closes the connection to http 
>> server before transferring all application data to http client
>>
>>
>> [EXTERNAL EMAIL]
>>
>> On 12/15/20 2:52 AM, Zhang, Lily (USD) wrote:
>>
>>> Looks we can use "Connection: keep-alive" in http request to solve this issue.
>>
>> That client request header will not change Squid's reaction to Squid-server connection closure by the server. It also should not change the request that Squid sends to the server (if it does, it is a Squid bug). In HTTP proxying, client-Squid and Squid-server connections/negotiations are mostly independent.
>>
>> If changing the client to send Connection:keep-alive to Squid fixes your problem, then the problem was most likely unrelated to the behavior you asked about earlier.
>>
>> If you can configure the HTTP server to keep the connection open/persistent after delivering the response (and, hence, to send a Connection:keep-alive _response_ header or otherwise signal HTTP connection persistency), then, yes, Squid may pool that _open_ Squid-server connection for future reuse (again, regardless of what headers the HTTP client is using).
>>
>> Alex.
>>
>>
>>
>>> -----Original Message-----
>>> From: squid-users <squid-users-bounces at lists.squid-cache.org> On 
>>> Behalf Of Amos Jeffries
>>> Sent: Tuesday, December 15, 2020 3:47 PM
>>> To: squid-users at lists.squid-cache.org
>>> Subject: Re: [squid-users] Proxy Server closes the connection to 
>>> http server before transferring all application data to http client
>>>
>>>
>>> [EXTERNAL EMAIL]
>>>
>>> On 15/12/20 4:21 pm, Zhang, Lily (USD) wrote:
>>>> Hi
>>>>
>>>> I installed 4.13 squid proxy server. See attachment, http server
>>>> (10.250.16.46) sends FIN, ACK to tells that response is finished. 
>>>> Proxy server (10.244.102.133) sends FIN, ACK back to http server
>>>> (10.250.16.46) before "Application Data" is transferred to http 
>>>> client (10.245.166.20).
>>>>
>>>> Would you please help me on questions below:
>>>>
>>>>  1. Is it normal that proxy server sends FIN, ACK to http server before
>>>>     http client finishes receiving ?all the ?Application Data? ?
>>>
>>> That depends on the transaction which is being performed.
>>>
>>> If it is a normal HTTP request-response transaction then yes. Once Squid has the response the server connection is done with - it may be closed or re-used for other transactions.
>>>
>>> If it is a tunnel containing non-HTTP traffic then no. Squid should only close the server connection when the client closes its end of the tunnel.
>>>
>>> Also, note that FIN+ACK in a single packet is a *response* to a FIN having come from the server itself. Not initiated by the proxy.
>>>
>>>
>>>
>>>>  2. Does proxy server have option to stop item 1?
>>>>
>>>
>>> In general: No. This is something that is supposed to happen (or 
>>> not) according to the relevant protocol requirements.
>>>
>>> In specific, there may be some options that can be configured to 
>>> change how the protocol behaves. Preventing it needing a close. You 
>>> will have to find out what the cause actually is to determine where 
>>> to look for solutions.
>>>
>>>
>>> Amos
>>>
>>> _______________________________________________
>>> squid-users mailing list
>>> squid-users at lists.squid-cache.org
>>> http://lists.squid-cache.org/listinfo/squid-users
>>> _______________________________________________
>>> squid-users mailing list
>>> squid-users at lists.squid-cache.org
>>> http://lists.squid-cache.org/listinfo/squid-users
>>>
>>
> 

-------------- next part --------------
A non-text attachment was scrubbed...
Name: partial-cache.7z
Type: application/octet-stream
Size: 24038 bytes
Desc: partial-cache.7z
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20201218/0da78270/attachment.obj>

From rousskov at measurement-factory.com  Fri Dec 18 15:44:02 2020
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Fri, 18 Dec 2020 10:44:02 -0500
Subject: [squid-users] Proxy Server closes the connection to http server
 before transferring all application data to http client
In-Reply-To: <CH2PR19MB4085F1D80DEDA36FC4ACF6C6F0C30@CH2PR19MB4085.namprd19.prod.outlook.com>
References: <CH2PR19MB408562E2556D30B57562B2F5F0CA0@CH2PR19MB4085.namprd19.prod.outlook.com>
 <CH2PR19MB4085EB136877C4B0962C489DF0C60@CH2PR19MB4085.namprd19.prod.outlook.com>
 <CH2PR19MB4085F051C425161521920792F0C60@CH2PR19MB4085.namprd19.prod.outlook.com>
 <CH2PR19MB40856412F76E6FF2C70CCFC6F0C60@CH2PR19MB4085.namprd19.prod.outlook.com>
 <812f6027-e193-548a-7f51-c9ee242e56af@treenet.co.nz>
 <CH2PR19MB4085702A69D77EB2B710C1A5F0C60@CH2PR19MB4085.namprd19.prod.outlook.com>
 <3ae87c34-587a-eb5f-54a7-fde3d10a385f@measurement-factory.com>
 <CH2PR19MB40852144253391BC98A87E3BF0C50@CH2PR19MB4085.namprd19.prod.outlook.com>
 <CH2PR19MB4085700DAD3B2F255E65CBC8F0C50@CH2PR19MB4085.namprd19.prod.outlook.com>
 <863fdc6c-66d5-8462-a16a-8b1c0662c45c@measurement-factory.com>
 <CH2PR19MB4085EA01668436A8D2AD7064F0C40@CH2PR19MB4085.namprd19.prod.outlook.com>
 <ebeaf6ea-c41e-7c8a-6c95-72fedf103172@measurement-factory.com>
 <CH2PR19MB4085F1D80DEDA36FC4ACF6C6F0C30@CH2PR19MB4085.namprd19.prod.outlook.com>
Message-ID: <941b044f-c345-635f-3563-2a825d6b2516@measurement-factory.com>

On 12/18/20 6:10 AM, Zhang, Lily (USD) wrote:

> Http client use libcurl,  curl_easy_recv API returns CURLE_UNSUPPORTED_PROTOCOL,    /* 1 */
> This meets the description https://curl.se/mail/lib-2013-01/0246.html , CURLE_UNSUPPORTED_PROTOCOL  means that connection was shutdown.
> 
> 10.105.8.55 is http server ip, 10.245.166.20 is the http client ip, 10.244.102.133 is proxy server's ip. 

The test transaction is an HTTP CONNECT transaction (that is not going
through SslBump decoding in Squid). Thus, after the initial CONNECT
headers exchange, Squid plays a role of a TCP tunnel. I am guessing that
the tunnel contains HTTPS transactions, but Squid does not "see" them --
Squid only sees opaque TCP payload bytes, not TLS- and not HTTP-layer
information. Whatever settings you apply to those HTTPS transactions,
including HTTP Connection headers are _invisible_ to your Squid.

I see several reads/writes from/to the client and several reads/writes
from/to the server. The numbers appear to match -- after the CONNECT
exchange, everything read from one side is written to the other, in both
directions. This observation contradicts the statement in the Subject
line of this thread.

If you disagree, please double check the I/O sizes in the logged
HandleRead and HandleWrite lines for FD 13 (client) and FD 15 (server).
The sizes should match after the CONNECT exchange, which ends with the
39 "HTTP/1.1 200 Connection established\r\n\r\n" bytes written to FD 13
at 10:54:01.882:

    2020/12/18 10:54:01.882 kid1| 5,5| Write.cc(66) HandleWrite:
local=10.244.102.133:3128 remote=10.245.166.20:39906 FD 13 flags=1: off
0, sz 39.


A few exchanges later, Squid reads EOF from the origin server at
10:54:03.944:

    2020/12/18 10:54:03.944 kid1| 5,3| Read.cc(145) HandleRead: FD 15,
size 65535, retval 0, errno 0

At that time, Squid has already written everything (it previously read
from the server) to the client. Squid tunnels do not support half-closed
connections, so Squid closes the server and the client connections. End
of story as far as Squid is concerned. This is normal/expected behavior.

If your client is unhappy about something, and changing HTTP headers
(that Squid does not see!) changes the client or server behavior, then
your problem lies in the client or server, not Squid.

Squid could be enhanced to support half-closed connections (when
tunneling traffic), but there is currently no indication that your
problem is caused by the lack of that support and, IIRC, HTTP CONNECT
does not require such support, so relying on it is a bad idea in general.

Your next step is to understand what the client is unhappy about. While
Factory has done some serious Curl development, I am not familiar with
CURLE_UNSUPPORTED_PROTOCOL specific. If you cannot figure it out on your
own, you may want to contact the Curl project for support, especially if
you found some relevant posts on its mailing lists. I have _not_ studied
that email thread, but if it was a curl bug, make sure you are using the
fixed version of their library (if available).


HTH,

Alex.


> -----Original Message-----
> From: Alex Rousskov <rousskov at measurement-factory.com> 
> Sent: Friday, December 18, 2020 1:33 AM
> To: Zhang, Lily (USD); squid-users at lists.squid-cache.org
> Subject: Re: [squid-users] Proxy Server closes the connection to http server before transferring all application data to http client
> 
> 
> [EXTERNAL EMAIL] 
> 
> On 12/17/20 3:31 AM, Zhang, Lily (USD) wrote:
> 
>>> If you want to work on that, respond to this message and somebody will send you more detailed instructions.
> 
>> Yes, please tell me how to do this.  
> 
> Please try the procedure described at
> https://wiki.squid-cache.org/SquidFaq/BugReporting#Debugging_a_single_transaction
> 
> In your case, if possible, use a single problematic master transaction (including client-Squid and Squid-server HTTP transactions) -- the one that results in response truncation. I recommend "ALL,9" debugging for this case. Please share a link to the _compressed_ log.
> 
> 
>> I am curious of
> 
>> 1. When http client uses close, and server uses keep-alive, when 
>> connection between proxy server and http server is closed, it still 
>> can transfer data between client and proxy server,
> 
> Yes, Squid should send the rest of the response to the client after the server sent the entire response to Squid.
> 
> Whether the server closed the connection after sending the entire response is irrelevant (except for special cases where the end of response is determined by the connection closure).
> 
> 
>> and data transfer to http client is not completed sometimes.
> 
> That is a mystery you want to solve.
> 
> 
>> 2. When http client uses close, and server uses closes, no data 
>> transfer from http client and proxy server after http server closes 
>> the connection.
> 
> I assume that by "from http client and proxy" you meant "to http client from proxy".
> 
> That is another mystery you want to solve.
> 
> Hopefully, debugging logs will help us solve both mysteries.
> 
> Alex.
> 
> 
>> -----Original Message-----
>> From: Alex Rousskov <rousskov at measurement-factory.com>
>> Sent: Wednesday, December 16, 2020 10:50 PM
>> To: Zhang, Lily (USD); squid-users at lists.squid-cache.org
>> Subject: Re: [squid-users] Proxy Server closes the connection to http 
>> server before transferring all application data to http client
>>
>>
>> [EXTERNAL EMAIL]
>>
>> On 12/16/20 4:02 AM, Zhang, Lily (USD) wrote:
>>
>>> Issue still can be reproduced when http client using connection: close, and http server uses connection: keep-alive.
>>> I can't reproduce this issue when both side using keep-alive.
>>
>> When everything works as it should, the HTTP Connection header has no effect on the data transfer during the transaction that header belongs to. Both "close" and "keep-alive" instructions tell the agents what to do _after_ the entire response body is delivered from the server to the client. This is just how HTTP works... Thus, what you are describing suggests a bug in client software, server software, Squid, and/or the test.
>>
>> Going forward:
>>
>> * If you do not need further assistance and do not want to work to discover the true cause of the problem, then just ignore this message. I am glad you found a workaround, and we can leave it at that.
>>
>> * Otherwise, the best next step may be to share Squid debugging logs while reproducing the problem in the lab. If you want to work on that, respond to this message and somebody will send you more detailed instructions.
>>
>>
>> Cheers,
>>
>> Alex.
>>
>>
>>> -----Original Message-----
>>> From: Zhang, Lily (USD)
>>> Sent: Wednesday, December 16, 2020 3:29 PM
>>> To: Alex Rousskov; squid-users at lists.squid-cache.org
>>> Subject: RE: [squid-users] Proxy Server closes the connection to http 
>>> server before transferring all application data to http client
>>>
>>> Hi Alex,
>>> Thanks for your reply.
>>>
>>> At first, http server turns off  keep-alive, then http client can't get the full response sometimes (example 20 0000 char, get 17 0000 chars).
>>>
>>> I did a test in the lab, found
>>>
>>> 1. If http client uses connection: close, and http server uses
>>> connection: keep-alive, then still can transfer data after tcp 
>>> connection between http server and proxy server is closed.  (don't 
>>> know how this happens)
>>>
>>> 2. If http client uses connection: keep-alive, and http server uses connection: keep-alive, then connection between http server and proxy server won't closed first. It is closed after client closes the connection.
>>>
>>> Thanks
>>> Lily
>>> -----Original Message-----
>>> From: Alex Rousskov <rousskov at measurement-factory.com>
>>> Sent: Tuesday, December 15, 2020 11:53 PM
>>> To: squid-users at lists.squid-cache.org
>>> Cc: Zhang, Lily (USD)
>>> Subject: Re: [squid-users] Proxy Server closes the connection to http 
>>> server before transferring all application data to http client
>>>
>>>
>>> [EXTERNAL EMAIL]
>>>
>>> On 12/15/20 2:52 AM, Zhang, Lily (USD) wrote:
>>>
>>>> Looks we can use "Connection: keep-alive" in http request to solve this issue.
>>>
>>> That client request header will not change Squid's reaction to Squid-server connection closure by the server. It also should not change the request that Squid sends to the server (if it does, it is a Squid bug). In HTTP proxying, client-Squid and Squid-server connections/negotiations are mostly independent.
>>>
>>> If changing the client to send Connection:keep-alive to Squid fixes your problem, then the problem was most likely unrelated to the behavior you asked about earlier.
>>>
>>> If you can configure the HTTP server to keep the connection open/persistent after delivering the response (and, hence, to send a Connection:keep-alive _response_ header or otherwise signal HTTP connection persistency), then, yes, Squid may pool that _open_ Squid-server connection for future reuse (again, regardless of what headers the HTTP client is using).
>>>
>>> Alex.
>>>
>>>
>>>
>>>> -----Original Message-----
>>>> From: squid-users <squid-users-bounces at lists.squid-cache.org> On 
>>>> Behalf Of Amos Jeffries
>>>> Sent: Tuesday, December 15, 2020 3:47 PM
>>>> To: squid-users at lists.squid-cache.org
>>>> Subject: Re: [squid-users] Proxy Server closes the connection to 
>>>> http server before transferring all application data to http client
>>>>
>>>>
>>>> [EXTERNAL EMAIL]
>>>>
>>>> On 15/12/20 4:21 pm, Zhang, Lily (USD) wrote:
>>>>> Hi
>>>>>
>>>>> I installed 4.13 squid proxy server. See attachment, http server
>>>>> (10.250.16.46) sends FIN, ACK to tells that response is finished. 
>>>>> Proxy server (10.244.102.133) sends FIN, ACK back to http server
>>>>> (10.250.16.46) before "Application Data" is transferred to http 
>>>>> client (10.245.166.20).
>>>>>
>>>>> Would you please help me on questions below:
>>>>>
>>>>>  1. Is it normal that proxy server sends FIN, ACK to http server before
>>>>>     http client finishes receiving ?all the ?Application Data? ?
>>>>
>>>> That depends on the transaction which is being performed.
>>>>
>>>> If it is a normal HTTP request-response transaction then yes. Once Squid has the response the server connection is done with - it may be closed or re-used for other transactions.
>>>>
>>>> If it is a tunnel containing non-HTTP traffic then no. Squid should only close the server connection when the client closes its end of the tunnel.
>>>>
>>>> Also, note that FIN+ACK in a single packet is a *response* to a FIN having come from the server itself. Not initiated by the proxy.
>>>>
>>>>
>>>>
>>>>>  2. Does proxy server have option to stop item 1?
>>>>>
>>>>
>>>> In general: No. This is something that is supposed to happen (or 
>>>> not) according to the relevant protocol requirements.
>>>>
>>>> In specific, there may be some options that can be configured to 
>>>> change how the protocol behaves. Preventing it needing a close. You 
>>>> will have to find out what the cause actually is to determine where 
>>>> to look for solutions.
>>>>
>>>>
>>>> Amos
>>>>
>>>> _______________________________________________
>>>> squid-users mailing list
>>>> squid-users at lists.squid-cache.org
>>>> http://lists.squid-cache.org/listinfo/squid-users
>>>> _______________________________________________
>>>> squid-users mailing list
>>>> squid-users at lists.squid-cache.org
>>>> http://lists.squid-cache.org/listinfo/squid-users
>>>>
>>>
>>
> 



From mikio.kishi at gmail.com  Sat Dec 19 07:07:09 2020
From: mikio.kishi at gmail.com (mikio.kishi at gmail.com)
Date: Sat, 19 Dec 2020 16:07:09 +0900
Subject: [squid-users] Problem with access.log and when using SMP
Message-ID: <CAMUMefYXkZ=wk4QDheknttFug44gaWN3tS9fzm7btADYjkpXTQ@mail.gmail.com>

Hi,

I have the following same problem using access_log.


http://squid-web-proxy-cache.1019090.n4.nabble.com/Problem-with-access-log-and-when-using-SMP-td4668524.html

In that case, does the following "stdio" logging module also become a
workaround to solve the issue ?

> stdio Write each log line to disk immediately at the completion of each
request.
>       Place: the filename and path to be written.

Regards,
--
Mikio Kishi
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20201219/d7aa87ba/attachment.htm>

From squid3 at treenet.co.nz  Sat Dec 19 08:37:16 2020
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Sat, 19 Dec 2020 21:37:16 +1300
Subject: [squid-users] Problem with access.log and when using SMP
In-Reply-To: <CAMUMefYXkZ=wk4QDheknttFug44gaWN3tS9fzm7btADYjkpXTQ@mail.gmail.com>
References: <CAMUMefYXkZ=wk4QDheknttFug44gaWN3tS9fzm7btADYjkpXTQ@mail.gmail.com>
Message-ID: <55acb0d3-44ba-8ce8-f8e2-0d3d70cffdac@treenet.co.nz>

On 19/12/20 8:07 pm, mikio.kishi at gmail.com wrote:
> Hi,
> 
> I have the following same problem using access_log.
> 

What version of Squid are you using? I thought that problem was solved 
long ago.


> In that case, does the following "stdio" logging module also become a 
> workaround to solve the issue ?
> 

No. That issue is multiple processes trying to write to one disk file.
Only workarounds are writing to different files. Or not using a 
file-based module (eg syslog, UDP, TCP) or a daemon that does not output 
straight to files (eg the DB one).


Amos


From squid3 at treenet.co.nz  Sat Dec 19 09:11:20 2020
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Sat, 19 Dec 2020 22:11:20 +1300
Subject: [squid-users] What is the state of V5 branch? Can I try to
 publish some RPMS?
In-Reply-To: <!&!AAAAAAAAAAAuAAAAAAAAAGg7dk9mYqJGhbBt3m/ghGwBAMO2jhD3dRHOtM0AqgC7tuYAAAAAAA4AABAAAAC83OVyby6rRYk1AIQfIcCyAQAAAAA=@gmail.com>
References: <!&!AAAAAAAAAAAuAAAAAAAAAGg7dk9mYqJGhbBt3m/ghGwBAMO2jhD3dRHOtM0AqgC7tuYAAAAAAA4AABAAAAC83OVyby6rRYk1AIQfIcCyAQAAAAA=@gmail.com>
Message-ID: <f971c5f5-0c07-bb95-235c-41365a145ac0@treenet.co.nz>

On 17/12/20 10:28 pm, Eliezer Croitor wrote:
> Hey,
> 
> Next year I will start publishing RPMs for Squid again.
> 
> What is the state of V5? What should be verified or tested with V5?
> 


Status of Squid-5 is that there are three major bugs to be resolved or 
proven not to be as important as they seem now (limited impact or 
existence in older Squid versions):

  <https://bugs.squid-cache.org/show_bug.cgi?id=4806>
  <https://bugs.squid-cache.org/show_bug.cgi?id=4832>
  <https://bugs.squid-cache.org/show_bug.cgi?id=4872>


When those are resolved it will be reviewed for production release.


Amos


From sampei02 at tiscali.it  Mon Dec 21 07:07:43 2020
From: sampei02 at tiscali.it (sampei02 at tiscali.it)
Date: Mon, 21 Dec 2020 08:07:43 +0100
Subject: [squid-users] squid writes to /var/log/messages
Message-ID: <54E44A11-6033-4BC6-BEA4-F220FAF6A46D@tiscali.it>

With Squid 4.8 and rsyslogd 8.24, I noted some Squid logs in /var/log/messages, .e.g " ipcacheParse No Address records?? or ? Starting new redirector helpers??.
I configured log Squid to default options, excluded for "access_log /var/log/squid/access.log? instead of "access_log /var/log/squid/access.log squid?
Where can I find answer because Squid writes to /var/log/messages too?




From sampei02 at tiscali.it  Mon Dec 21 08:55:44 2020
From: sampei02 at tiscali.it (sampei02 at tiscali.it)
Date: Mon, 21 Dec 2020 09:55:44 +0100
Subject: [squid-users] squid writes to /var/log/messages
In-Reply-To: <CABA8h=TA1JTuC6rxjMA9tikASEfz_sNTtbWVEDAk35SOv6MCLQ@mail.gmail.com>
References: <54E44A11-6033-4BC6-BEA4-F220FAF6A46D@tiscali.it>
 <CABA8h=TA1JTuC6rxjMA9tikASEfz_sNTtbWVEDAk35SOv6MCLQ@mail.gmail.com>
Message-ID: <BE660CBB-37C4-4307-B698-F1A87CD4F978@tiscali.it>

Ok, I noted these 2 squid processes:

root		/usr/sbin/squid -sYC
squid       (squid-1) --kid squid-1 -sYC

-s means "Enable logging to syslog?

This option ?-s? could explain writing to messages ?

> On 21 Dec 2020, at 09:14, NgTech LTD <ngtech1ltd at gmail.com> wrote:
> 
> Hey Sampei,
> 
> It's recommended you would send a squid.conf so we would try to
> understand what might cause the issue you are writing about.
> 
> Thanks,
> Eliezer
> 
> On Mon, Dec 21, 2020 at 9:07 AM sampei02 at tiscali.it <sampei02 at tiscali.it> wrote:
>> 
>> With Squid 4.8 and rsyslogd 8.24, I noted some Squid logs in /var/log/messages, .e.g " ipcacheParse No Address records?? or ? Starting new redirector helpers??.
>> I configured log Squid to default options, excluded for "access_log /var/log/squid/access.log? instead of "access_log /var/log/squid/access.log squid?
>> Where can I find answer because Squid writes to /var/log/messages too?
>> 
>> 
>> _______________________________________________
>> squid-users mailing list
>> squid-users at lists.squid-cache.org
>> http://lists.squid-cache.org/listinfo/squid-users



From Lily.Zhang at dell.com  Mon Dec 21 09:11:30 2020
From: Lily.Zhang at dell.com (Zhang, Lily (USD))
Date: Mon, 21 Dec 2020 09:11:30 +0000
Subject: [squid-users] Proxy Server closes the connection to http server
 before transferring all application data to http client
In-Reply-To: <941b044f-c345-635f-3563-2a825d6b2516@measurement-factory.com>
References: <CH2PR19MB408562E2556D30B57562B2F5F0CA0@CH2PR19MB4085.namprd19.prod.outlook.com>
 <CH2PR19MB4085EB136877C4B0962C489DF0C60@CH2PR19MB4085.namprd19.prod.outlook.com>
 <CH2PR19MB4085F051C425161521920792F0C60@CH2PR19MB4085.namprd19.prod.outlook.com>
 <CH2PR19MB40856412F76E6FF2C70CCFC6F0C60@CH2PR19MB4085.namprd19.prod.outlook.com>
 <812f6027-e193-548a-7f51-c9ee242e56af@treenet.co.nz>
 <CH2PR19MB4085702A69D77EB2B710C1A5F0C60@CH2PR19MB4085.namprd19.prod.outlook.com>
 <3ae87c34-587a-eb5f-54a7-fde3d10a385f@measurement-factory.com>
 <CH2PR19MB40852144253391BC98A87E3BF0C50@CH2PR19MB4085.namprd19.prod.outlook.com>
 <CH2PR19MB4085700DAD3B2F255E65CBC8F0C50@CH2PR19MB4085.namprd19.prod.outlook.com>
 <863fdc6c-66d5-8462-a16a-8b1c0662c45c@measurement-factory.com>
 <CH2PR19MB4085EA01668436A8D2AD7064F0C40@CH2PR19MB4085.namprd19.prod.outlook.com>
 <ebeaf6ea-c41e-7c8a-6c95-72fedf103172@measurement-factory.com>
 <CH2PR19MB4085F1D80DEDA36FC4ACF6C6F0C30@CH2PR19MB4085.namprd19.prod.outlook.com>
 <941b044f-c345-635f-3563-2a825d6b2516@measurement-factory.com>
Message-ID: <CH2PR19MB4085FAC9948B948A83E70681F0C00@CH2PR19MB4085.namprd19.prod.outlook.com>

Thanks Alex! 
I will contact curl project to take a look.


Thanks
Lily

-----Original Message-----
From: Alex Rousskov <rousskov at measurement-factory.com> 
Sent: Friday, December 18, 2020 11:44 PM
To: Zhang, Lily (USD); squid-users at lists.squid-cache.org
Subject: Re: [squid-users] Proxy Server closes the connection to http server before transferring all application data to http client


[EXTERNAL EMAIL] 

On 12/18/20 6:10 AM, Zhang, Lily (USD) wrote:

> Http client use libcurl,  curl_easy_recv API returns CURLE_UNSUPPORTED_PROTOCOL,    /* 1 */
> This meets the description https://curl.se/mail/lib-2013-01/0246.html , CURLE_UNSUPPORTED_PROTOCOL  means that connection was shutdown.
> 
> 10.105.8.55 is http server ip, 10.245.166.20 is the http client ip, 10.244.102.133 is proxy server's ip. 

The test transaction is an HTTP CONNECT transaction (that is not going through SslBump decoding in Squid). Thus, after the initial CONNECT headers exchange, Squid plays a role of a TCP tunnel. I am guessing that the tunnel contains HTTPS transactions, but Squid does not "see" them -- Squid only sees opaque TCP payload bytes, not TLS- and not HTTP-layer information. Whatever settings you apply to those HTTPS transactions, including HTTP Connection headers are _invisible_ to your Squid.

I see several reads/writes from/to the client and several reads/writes from/to the server. The numbers appear to match -- after the CONNECT exchange, everything read from one side is written to the other, in both directions. This observation contradicts the statement in the Subject line of this thread.

If you disagree, please double check the I/O sizes in the logged HandleRead and HandleWrite lines for FD 13 (client) and FD 15 (server).
The sizes should match after the CONNECT exchange, which ends with the
39 "HTTP/1.1 200 Connection established\r\n\r\n" bytes written to FD 13 at 10:54:01.882:

    2020/12/18 10:54:01.882 kid1| 5,5| Write.cc(66) HandleWrite:
local=10.244.102.133:3128 remote=10.245.166.20:39906 FD 13 flags=1: off 0, sz 39.


A few exchanges later, Squid reads EOF from the origin server at
10:54:03.944:

    2020/12/18 10:54:03.944 kid1| 5,3| Read.cc(145) HandleRead: FD 15, size 65535, retval 0, errno 0

At that time, Squid has already written everything (it previously read from the server) to the client. Squid tunnels do not support half-closed connections, so Squid closes the server and the client connections. End of story as far as Squid is concerned. This is normal/expected behavior.

If your client is unhappy about something, and changing HTTP headers (that Squid does not see!) changes the client or server behavior, then your problem lies in the client or server, not Squid.

Squid could be enhanced to support half-closed connections (when tunneling traffic), but there is currently no indication that your problem is caused by the lack of that support and, IIRC, HTTP CONNECT does not require such support, so relying on it is a bad idea in general.

Your next step is to understand what the client is unhappy about. While Factory has done some serious Curl development, I am not familiar with CURLE_UNSUPPORTED_PROTOCOL specific. If you cannot figure it out on your own, you may want to contact the Curl project for support, especially if you found some relevant posts on its mailing lists. I have _not_ studied that email thread, but if it was a curl bug, make sure you are using the fixed version of their library (if available).


HTH,

Alex.


> -----Original Message-----
> From: Alex Rousskov <rousskov at measurement-factory.com>
> Sent: Friday, December 18, 2020 1:33 AM
> To: Zhang, Lily (USD); squid-users at lists.squid-cache.org
> Subject: Re: [squid-users] Proxy Server closes the connection to http 
> server before transferring all application data to http client
> 
> 
> [EXTERNAL EMAIL]
> 
> On 12/17/20 3:31 AM, Zhang, Lily (USD) wrote:
> 
>>> If you want to work on that, respond to this message and somebody will send you more detailed instructions.
> 
>> Yes, please tell me how to do this.  
> 
> Please try the procedure described at
> https://wiki.squid-cache.org/SquidFaq/BugReporting#Debugging_a_single_
> transaction
> 
> In your case, if possible, use a single problematic master transaction (including client-Squid and Squid-server HTTP transactions) -- the one that results in response truncation. I recommend "ALL,9" debugging for this case. Please share a link to the _compressed_ log.
> 
> 
>> I am curious of
> 
>> 1. When http client uses close, and server uses keep-alive, when 
>> connection between proxy server and http server is closed, it still 
>> can transfer data between client and proxy server,
> 
> Yes, Squid should send the rest of the response to the client after the server sent the entire response to Squid.
> 
> Whether the server closed the connection after sending the entire response is irrelevant (except for special cases where the end of response is determined by the connection closure).
> 
> 
>> and data transfer to http client is not completed sometimes.
> 
> That is a mystery you want to solve.
> 
> 
>> 2. When http client uses close, and server uses closes, no data 
>> transfer from http client and proxy server after http server closes 
>> the connection.
> 
> I assume that by "from http client and proxy" you meant "to http client from proxy".
> 
> That is another mystery you want to solve.
> 
> Hopefully, debugging logs will help us solve both mysteries.
> 
> Alex.
> 
> 
>> -----Original Message-----
>> From: Alex Rousskov <rousskov at measurement-factory.com>
>> Sent: Wednesday, December 16, 2020 10:50 PM
>> To: Zhang, Lily (USD); squid-users at lists.squid-cache.org
>> Subject: Re: [squid-users] Proxy Server closes the connection to http 
>> server before transferring all application data to http client
>>
>>
>> [EXTERNAL EMAIL]
>>
>> On 12/16/20 4:02 AM, Zhang, Lily (USD) wrote:
>>
>>> Issue still can be reproduced when http client using connection: close, and http server uses connection: keep-alive.
>>> I can't reproduce this issue when both side using keep-alive.
>>
>> When everything works as it should, the HTTP Connection header has no effect on the data transfer during the transaction that header belongs to. Both "close" and "keep-alive" instructions tell the agents what to do _after_ the entire response body is delivered from the server to the client. This is just how HTTP works... Thus, what you are describing suggests a bug in client software, server software, Squid, and/or the test.
>>
>> Going forward:
>>
>> * If you do not need further assistance and do not want to work to discover the true cause of the problem, then just ignore this message. I am glad you found a workaround, and we can leave it at that.
>>
>> * Otherwise, the best next step may be to share Squid debugging logs while reproducing the problem in the lab. If you want to work on that, respond to this message and somebody will send you more detailed instructions.
>>
>>
>> Cheers,
>>
>> Alex.
>>
>>
>>> -----Original Message-----
>>> From: Zhang, Lily (USD)
>>> Sent: Wednesday, December 16, 2020 3:29 PM
>>> To: Alex Rousskov; squid-users at lists.squid-cache.org
>>> Subject: RE: [squid-users] Proxy Server closes the connection to 
>>> http server before transferring all application data to http client
>>>
>>> Hi Alex,
>>> Thanks for your reply.
>>>
>>> At first, http server turns off  keep-alive, then http client can't get the full response sometimes (example 20 0000 char, get 17 0000 chars).
>>>
>>> I did a test in the lab, found
>>>
>>> 1. If http client uses connection: close, and http server uses
>>> connection: keep-alive, then still can transfer data after tcp 
>>> connection between http server and proxy server is closed.  (don't 
>>> know how this happens)
>>>
>>> 2. If http client uses connection: keep-alive, and http server uses connection: keep-alive, then connection between http server and proxy server won't closed first. It is closed after client closes the connection.
>>>
>>> Thanks
>>> Lily
>>> -----Original Message-----
>>> From: Alex Rousskov <rousskov at measurement-factory.com>
>>> Sent: Tuesday, December 15, 2020 11:53 PM
>>> To: squid-users at lists.squid-cache.org
>>> Cc: Zhang, Lily (USD)
>>> Subject: Re: [squid-users] Proxy Server closes the connection to 
>>> http server before transferring all application data to http client
>>>
>>>
>>> [EXTERNAL EMAIL]
>>>
>>> On 12/15/20 2:52 AM, Zhang, Lily (USD) wrote:
>>>
>>>> Looks we can use "Connection: keep-alive" in http request to solve this issue.
>>>
>>> That client request header will not change Squid's reaction to Squid-server connection closure by the server. It also should not change the request that Squid sends to the server (if it does, it is a Squid bug). In HTTP proxying, client-Squid and Squid-server connections/negotiations are mostly independent.
>>>
>>> If changing the client to send Connection:keep-alive to Squid fixes your problem, then the problem was most likely unrelated to the behavior you asked about earlier.
>>>
>>> If you can configure the HTTP server to keep the connection open/persistent after delivering the response (and, hence, to send a Connection:keep-alive _response_ header or otherwise signal HTTP connection persistency), then, yes, Squid may pool that _open_ Squid-server connection for future reuse (again, regardless of what headers the HTTP client is using).
>>>
>>> Alex.
>>>
>>>
>>>
>>>> -----Original Message-----
>>>> From: squid-users <squid-users-bounces at lists.squid-cache.org> On 
>>>> Behalf Of Amos Jeffries
>>>> Sent: Tuesday, December 15, 2020 3:47 PM
>>>> To: squid-users at lists.squid-cache.org
>>>> Subject: Re: [squid-users] Proxy Server closes the connection to 
>>>> http server before transferring all application data to http client
>>>>
>>>>
>>>> [EXTERNAL EMAIL]
>>>>
>>>> On 15/12/20 4:21 pm, Zhang, Lily (USD) wrote:
>>>>> Hi
>>>>>
>>>>> I installed 4.13 squid proxy server. See attachment, http server
>>>>> (10.250.16.46) sends FIN, ACK to tells that response is finished. 
>>>>> Proxy server (10.244.102.133) sends FIN, ACK back to http server
>>>>> (10.250.16.46) before "Application Data" is transferred to http 
>>>>> client (10.245.166.20).
>>>>>
>>>>> Would you please help me on questions below:
>>>>>
>>>>>  1. Is it normal that proxy server sends FIN, ACK to http server before
>>>>>     http client finishes receiving ?all the ?Application Data? ?
>>>>
>>>> That depends on the transaction which is being performed.
>>>>
>>>> If it is a normal HTTP request-response transaction then yes. Once Squid has the response the server connection is done with - it may be closed or re-used for other transactions.
>>>>
>>>> If it is a tunnel containing non-HTTP traffic then no. Squid should only close the server connection when the client closes its end of the tunnel.
>>>>
>>>> Also, note that FIN+ACK in a single packet is a *response* to a FIN having come from the server itself. Not initiated by the proxy.
>>>>
>>>>
>>>>
>>>>>  2. Does proxy server have option to stop item 1?
>>>>>
>>>>
>>>> In general: No. This is something that is supposed to happen (or
>>>> not) according to the relevant protocol requirements.
>>>>
>>>> In specific, there may be some options that can be configured to 
>>>> change how the protocol behaves. Preventing it needing a close. You 
>>>> will have to find out what the cause actually is to determine where 
>>>> to look for solutions.
>>>>
>>>>
>>>> Amos
>>>>
>>>> _______________________________________________
>>>> squid-users mailing list
>>>> squid-users at lists.squid-cache.org
>>>> http://lists.squid-cache.org/listinfo/squid-users
>>>> _______________________________________________
>>>> squid-users mailing list
>>>> squid-users at lists.squid-cache.org
>>>> http://lists.squid-cache.org/listinfo/squid-users
>>>>
>>>
>>
> 


From Ralf.Hildebrandt at charite.de  Mon Dec 21 09:20:35 2020
From: Ralf.Hildebrandt at charite.de (Ralf Hildebrandt)
Date: Mon, 21 Dec 2020 10:20:35 +0100
Subject: [squid-users] [ext] Re: What is the state of V5 branch? Can I
 try to publish some RPMS?
In-Reply-To: <f971c5f5-0c07-bb95-235c-41365a145ac0@treenet.co.nz>
References: <!&!AAAAAAAAAAAuAAAAAAAAAGg7dk9mYqJGhbBt3m/ghGwBAMO2jhD3dRHOtM0AqgC7tuYAAAAAAA4AABAAAAC83OVyby6rRYk1AIQfIcCyAQAAAAA=@gmail.com>
 <f971c5f5-0c07-bb95-235c-41365a145ac0@treenet.co.nz>
Message-ID: <20201221092035.mfxr6jqugl4gbwkg@charite.de>

* Amos Jeffries <squid3 at treenet.co.nz>:

> Status of Squid-5 is that there are three major bugs to be resolved or
> proven not to be as important as they seem now (limited impact or existence
> in older Squid versions):
> 
>  <https://bugs.squid-cache.org/show_bug.cgi?id=4806>
>  <https://bugs.squid-cache.org/show_bug.cgi?id=4832>
>  <https://bugs.squid-cache.org/show_bug.cgi?id=4872>

And of course http://bugs.squid-cache.org/show_bug.cgi?id=5055
which is affecting v5 and v6.

Ralf Hildebrandt
Charit? - Universit?tsmedizin Berlin
Gesch?ftsbereich IT | Abteilung Netzwerk

Campus Benjamin Franklin (CBF)
Haus I | 1. OG | Raum 105
Hindenburgdamm 30 | D-12203 Berlin

Tel. +49 30 450 570 155
ralf.hildebrandt at charite.de
https://www.charite.de


From squid3 at treenet.co.nz  Mon Dec 21 10:01:07 2020
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Mon, 21 Dec 2020 23:01:07 +1300
Subject: [squid-users] squid writes to /var/log/messages
In-Reply-To: <BE660CBB-37C4-4307-B698-F1A87CD4F978@tiscali.it>
References: <54E44A11-6033-4BC6-BEA4-F220FAF6A46D@tiscali.it>
 <CABA8h=TA1JTuC6rxjMA9tikASEfz_sNTtbWVEDAk35SOv6MCLQ@mail.gmail.com>
 <BE660CBB-37C4-4307-B698-F1A87CD4F978@tiscali.it>
Message-ID: <41657549-4600-c94f-bbac-f53a8ff19171@treenet.co.nz>

On 21/12/20 9:55 pm, sampei02 at tiscali.it wrote:
> Ok, I noted these 2 squid processes:
> 
> root		/usr/sbin/squid -sYC
> squid       (squid-1) --kid squid-1 -sYC
> 
> -s means "Enable logging to syslog?
> 
> This option ?-s? could explain writing to messages ?

Squid does not write to /var/log/messages. On startup before Squid reads 
any configuration about whether cache.log or syslog is to be used it 
logs to stderr.

That stderr channel is handled by whatever init system or shell is 
starting Squid. /var/log/messages is the init system log file.


Amos


From ambrose.li at gmail.com  Mon Dec 21 10:31:16 2020
From: ambrose.li at gmail.com (Ambrose Li)
Date: Mon, 21 Dec 2020 05:31:16 -0500
Subject: [squid-users] squid writes to /var/log/messages
In-Reply-To: <41657549-4600-c94f-bbac-f53a8ff19171@treenet.co.nz>
References: <54E44A11-6033-4BC6-BEA4-F220FAF6A46D@tiscali.it>
 <CABA8h=TA1JTuC6rxjMA9tikASEfz_sNTtbWVEDAk35SOv6MCLQ@mail.gmail.com>
 <BE660CBB-37C4-4307-B698-F1A87CD4F978@tiscali.it>
 <41657549-4600-c94f-bbac-f53a8ff19171@treenet.co.nz>
Message-ID: <20201221103116.GE11324@pingviini>

On Mon, Dec 21, 2020 at 11:01:07PM +1300, Amos Jeffries wrote:
> On 21/12/20 9:55 pm, sampei02 at tiscali.it wrote:
> > Ok, I noted these 2 squid processes:
> > 
> > root		/usr/sbin/squid -sYC
> > squid       (squid-1) --kid squid-1 -sYC
> > 
> > -s means "Enable logging to syslog?
> > 
> > This option ?-s? could explain writing to messages ?
> 
> Squid does not write to /var/log/messages. On startup before Squid reads any
> configuration about whether cache.log or syslog is to be used it logs to
> stderr.
> 
> That stderr channel is handled by whatever init system or shell is starting
> Squid. /var/log/messages is the init system log file.

Actually no, /var/log/messages is not an init system log file; on some Linux
distros it is a default log location for syslog.

I can confirm that squid will write to /var/log/messages if syslog logging is
enabled AND syslog is configured to write to /var/log/messages (this is the
default behaviour on some Linux distributions, such as Debian, but not Ubuntu).


-- 
Ambrose Li <ambrose.li at gmail.com> | Time zone: GMT-5 (Eastern)
ambroseli.ca

?Any organization which designs a system? will inevitably produce a
 design whose structure is a copy of the organization?s communication
 structure.? ? Conway?s Law



From sampei02 at tiscali.it  Mon Dec 21 13:29:27 2020
From: sampei02 at tiscali.it (sampei02 at tiscali.it)
Date: Mon, 21 Dec 2020 14:29:27 +0100
Subject: [squid-users] squid writes to /var/log/messages
In-Reply-To: <20201221103116.GE11324@pingviini>
References: <54E44A11-6033-4BC6-BEA4-F220FAF6A46D@tiscali.it>
 <CABA8h=TA1JTuC6rxjMA9tikASEfz_sNTtbWVEDAk35SOv6MCLQ@mail.gmail.com>
 <BE660CBB-37C4-4307-B698-F1A87CD4F978@tiscali.it>
 <41657549-4600-c94f-bbac-f53a8ff19171@treenet.co.nz>
 <20201221103116.GE11324@pingviini>
Message-ID: <D8DECF38-3015-4526-870B-1B1A4B74E5C3@tiscali.it>

> I can confirm that squid will write to /var/log/messages if syslog logging is
> enabled AND syslog is configured to write to /var/log/messages (this is the
> default behaviour on some Linux distributions, such as Debian, but not Ubuntu).



My distro is Centos7 and rsyslog is enabled and It?s  configured to write to /var/log/messages; it?s the default behaviour.
But how can I avoid Squid writes into this file? I chose the Squid default log files which are contained into /var/log/squid/ folder.



> On 21 Dec 2020, at 11:31, Ambrose Li <ambrose.li at gmail.com> wrote:
> 
> On Mon, Dec 21, 2020 at 11:01:07PM +1300, Amos Jeffries wrote:
>> On 21/12/20 9:55 pm, sampei02 at tiscali.it wrote:
>>> Ok, I noted these 2 squid processes:
>>> 
>>> root		/usr/sbin/squid -sYC
>>> squid       (squid-1) --kid squid-1 -sYC
>>> 
>>> -s means "Enable logging to syslog?
>>> 
>>> This option ?-s? could explain writing to messages ?
>> 
>> Squid does not write to /var/log/messages. On startup before Squid reads any
>> configuration about whether cache.log or syslog is to be used it logs to
>> stderr.
>> 
>> That stderr channel is handled by whatever init system or shell is starting
>> Squid. /var/log/messages is the init system log file.
> 
> Actually no, /var/log/messages is not an init system log file; on some Linux
> distros it is a default log location for syslog.
> 
> I can confirm that squid will write to /var/log/messages if syslog logging is
> enabled AND syslog is configured to write to /var/log/messages (this is the
> default behaviour on some Linux distributions, such as Debian, but not Ubuntu).
> 
> 
> -- 
> Ambrose Li <ambrose.li at gmail.com> | Time zone: GMT-5 (Eastern)
> ambroseli.ca
> 
> ?Any organization which designs a system? will inevitably produce a
> design whose structure is a copy of the organization?s communication
> structure.? ? Conway?s Law
> 
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users



From squid3 at treenet.co.nz  Mon Dec 21 13:36:20 2020
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Tue, 22 Dec 2020 02:36:20 +1300
Subject: [squid-users] squid writes to /var/log/messages
In-Reply-To: <D8DECF38-3015-4526-870B-1B1A4B74E5C3@tiscali.it>
References: <54E44A11-6033-4BC6-BEA4-F220FAF6A46D@tiscali.it>
 <CABA8h=TA1JTuC6rxjMA9tikASEfz_sNTtbWVEDAk35SOv6MCLQ@mail.gmail.com>
 <BE660CBB-37C4-4307-B698-F1A87CD4F978@tiscali.it>
 <41657549-4600-c94f-bbac-f53a8ff19171@treenet.co.nz>
 <20201221103116.GE11324@pingviini>
 <D8DECF38-3015-4526-870B-1B1A4B74E5C3@tiscali.it>
Message-ID: <33e7cad3-0cce-0fee-4779-cca4e132a3fd@treenet.co.nz>

On 22/12/20 2:29 am, sampei02 wrote:
>> I can confirm that squid will write to /var/log/messages if syslog logging is
>> enabled AND syslog is configured to write to /var/log/messages (this is the
>> default behaviour on some Linux distributions, such as Debian, but not Ubuntu).
> 
> 
> 
> My distro is Centos7 and rsyslog is enabled and It?s  configured to write to /var/log/messages; it?s the default behaviour.
> But how can I avoid Squid writes into this file? I chose the Squid default log files which are contained into /var/log/squid/ folder.
> 


Removing that "s" command line parameter will indeed stop the rsyslog 
output. You may still get some /var/log/messages entries from the init 
scripts etc.

Amos


From uhlar at fantomas.sk  Mon Dec 21 13:44:00 2020
From: uhlar at fantomas.sk (Matus UHLAR - fantomas)
Date: Mon, 21 Dec 2020 14:44:00 +0100
Subject: [squid-users] squid writes to /var/log/messages
In-Reply-To: <D8DECF38-3015-4526-870B-1B1A4B74E5C3@tiscali.it>
References: <54E44A11-6033-4BC6-BEA4-F220FAF6A46D@tiscali.it>
 <CABA8h=TA1JTuC6rxjMA9tikASEfz_sNTtbWVEDAk35SOv6MCLQ@mail.gmail.com>
 <BE660CBB-37C4-4307-B698-F1A87CD4F978@tiscali.it>
 <41657549-4600-c94f-bbac-f53a8ff19171@treenet.co.nz>
 <20201221103116.GE11324@pingviini>
 <D8DECF38-3015-4526-870B-1B1A4B74E5C3@tiscali.it>
Message-ID: <20201221134400.GA8455@fantomas.sk>

>> I can confirm that squid will write to /var/log/messages if syslog logging is
>> enabled AND syslog is configured to write to /var/log/messages (this is the
>> default behaviour on some Linux distributions, such as Debian, but not Ubuntu).

On 21.12.20 14:29, sampei02 at tiscali.it wrote:
>My distro is Centos7 and rsyslog is enabled and It?s  configured to write
>to /var/log/messages; it?s the default behaviour.  But how can I avoid
>Squid writes into this file?  I chose the Squid default log files which are
>contained into /var/log/squid/ folder.

note that the messages you poster are usually sent to cache_log, not
access_log, so check your cache_log settings.

as noted below, the "-s" option for squid makes it log to syslog, so you
need to remove that option off your systemd unit file or init.d file,
whichever is used on centos7.

>> On 21 Dec 2020, at 11:31, Ambrose Li <ambrose.li at gmail.com> wrote:
>>
>> On Mon, Dec 21, 2020 at 11:01:07PM +1300, Amos Jeffries wrote:
>>> On 21/12/20 9:55 pm, sampei02 at tiscali.it wrote:
>>>> Ok, I noted these 2 squid processes:
>>>>
>>>> root		/usr/sbin/squid -sYC
>>>> squid       (squid-1) --kid squid-1 -sYC
>>>>
>>>> -s means "Enable logging to syslog?
>>>>
>>>> This option ?-s? could explain writing to messages ?
>>>
>>> Squid does not write to /var/log/messages. On startup before Squid reads any
>>> configuration about whether cache.log or syslog is to be used it logs to
>>> stderr.
>>>
>>> That stderr channel is handled by whatever init system or shell is starting
>>> Squid. /var/log/messages is the init system log file.
>>
>> Actually no, /var/log/messages is not an init system log file; on some Linux
>> distros it is a default log location for syslog.
>>
>> I can confirm that squid will write to /var/log/messages if syslog logging is
>> enabled AND syslog is configured to write to /var/log/messages (this is the
>> default behaviour on some Linux distributions, such as Debian, but not Ubuntu).

-- 
Matus UHLAR - fantomas, uhlar at fantomas.sk ; http://www.fantomas.sk/
Warning: I wish NOT to receive e-mail advertising to this address.
Varovanie: na tuto adresu chcem NEDOSTAVAT akukolvek reklamnu postu.
- Holmes, what kind of school did you study to be a detective?
- Elementary, Watkins.  -- Daffy Duck & Porky Pig


From rousskov at measurement-factory.com  Mon Dec 21 14:36:15 2020
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Mon, 21 Dec 2020 09:36:15 -0500
Subject: [squid-users] squid writes to /var/log/messages
In-Reply-To: <D8DECF38-3015-4526-870B-1B1A4B74E5C3@tiscali.it>
References: <54E44A11-6033-4BC6-BEA4-F220FAF6A46D@tiscali.it>
 <CABA8h=TA1JTuC6rxjMA9tikASEfz_sNTtbWVEDAk35SOv6MCLQ@mail.gmail.com>
 <BE660CBB-37C4-4307-B698-F1A87CD4F978@tiscali.it>
 <41657549-4600-c94f-bbac-f53a8ff19171@treenet.co.nz>
 <20201221103116.GE11324@pingviini>
 <D8DECF38-3015-4526-870B-1B1A4B74E5C3@tiscali.it>
Message-ID: <1e559d12-ba17-6622-6b3d-c3a3d151e77c@measurement-factory.com>

On 12/21/20 8:29 AM, sampei02 at tiscali.it wrote:

> My distro is Centos7 and rsyslog is enabled and It?s  configured to
> write to /var/log/messages; it?s the default behaviour. But how can I
> avoid Squid writes into this file? I chose the Squid default log
> files which are contained into /var/log/squid/ folder.

You already know from other responses that removing "-s" from your Squid
command line options is the primary solution for stopping Squid from
logging to syslog, but I wanted to add a caveat:

* Some Squid messages are only logged to syslog.
  Those messages are logged to syslog regardless of the "-s" presence.
  I suspect they may also disregard the "-l facility" setting.

... where "logged to syslog" should be interpreted as "sent to the
syslog daemon", of course.

IMO, this caveat is essentially a Squid bug.

You can prevent all Squid messages from appearing in system log files by
configuring your syslog daemon accordingly.


HTH,

Alex.


>> On 21 Dec 2020, at 11:31, Ambrose Li wrote:
>>
>> On Mon, Dec 21, 2020 at 11:01:07PM +1300, Amos Jeffries wrote:
>>> On 21/12/20 9:55 pm, sampei02 at tiscali.it wrote:
>>>> Ok, I noted these 2 squid processes:
>>>>
>>>> root		/usr/sbin/squid -sYC
>>>> squid       (squid-1) --kid squid-1 -sYC
>>>>
>>>> -s means "Enable logging to syslog?
>>>>
>>>> This option ?-s? could explain writing to messages ?
>>>
>>> Squid does not write to /var/log/messages. On startup before Squid reads any
>>> configuration about whether cache.log or syslog is to be used it logs to
>>> stderr.
>>>
>>> That stderr channel is handled by whatever init system or shell is starting
>>> Squid. /var/log/messages is the init system log file.
>>
>> Actually no, /var/log/messages is not an init system log file; on some Linux
>> distros it is a default log location for syslog.
>>
>> I can confirm that squid will write to /var/log/messages if syslog logging is
>> enabled AND syslog is configured to write to /var/log/messages (this is the
>> default behaviour on some Linux distributions, such as Debian, but not Ubuntu).
>>
>>
>> -- 
>> Ambrose Li <ambrose.li at gmail.com> | Time zone: GMT-5 (Eastern)
>> ambroseli.ca
>>
>> ?Any organization which designs a system? will inevitably produce a
>> design whose structure is a copy of the organization?s communication
>> structure.? ? Conway?s Law
>>
>> _______________________________________________
>> squid-users mailing list
>> squid-users at lists.squid-cache.org
>> http://lists.squid-cache.org/listinfo/squid-users
> 
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users
> 



From sampei02 at tiscali.it  Tue Dec 22 13:32:10 2020
From: sampei02 at tiscali.it (sampei02 at tiscali.it)
Date: Tue, 22 Dec 2020 14:32:10 +0100
Subject: [squid-users] skype
Message-ID: <FBA692E0-9E22-47A3-ADE7-63E22B9C901C@tiscali.it>

What is your experience with Windows Skype with latest Squid version ? 
I think Skype uses UDP protocol too.
I  have issue with start call to all computers, It works only chat.



From sampei02 at tiscali.it  Tue Dec 22 14:19:37 2020
From: sampei02 at tiscali.it (sampei02 at tiscali.it)
Date: Tue, 22 Dec 2020 15:19:37 +0100
Subject: [squid-users] squid writes to /var/log/messages
In-Reply-To: <1e559d12-ba17-6622-6b3d-c3a3d151e77c@measurement-factory.com>
References: <54E44A11-6033-4BC6-BEA4-F220FAF6A46D@tiscali.it>
 <CABA8h=TA1JTuC6rxjMA9tikASEfz_sNTtbWVEDAk35SOv6MCLQ@mail.gmail.com>
 <BE660CBB-37C4-4307-B698-F1A87CD4F978@tiscali.it>
 <41657549-4600-c94f-bbac-f53a8ff19171@treenet.co.nz>
 <20201221103116.GE11324@pingviini>
 <D8DECF38-3015-4526-870B-1B1A4B74E5C3@tiscali.it>
 <1e559d12-ba17-6622-6b3d-c3a3d151e77c@measurement-factory.com>
Message-ID: <694270F3-79CB-4D38-967B-CDE91C37D999@tiscali.it>

I solved disabling ?-s' option in squid startup script.
Thanks



> On 21 Dec 2020, at 15:36, Alex Rousskov <rousskov at measurement-factory.com> wrote:
> 
> On 12/21/20 8:29 AM, sampei02 at tiscali.it <mailto:sampei02 at tiscali.it> wrote:
> 
>> My distro is Centos7 and rsyslog is enabled and It?s  configured to
>> write to /var/log/messages; it?s the default behaviour. But how can I
>> avoid Squid writes into this file? I chose the Squid default log
>> files which are contained into /var/log/squid/ folder.
> 
> You already know from other responses that removing "-s" from your Squid
> command line options is the primary solution for stopping Squid from
> logging to syslog, but I wanted to add a caveat:
> 
> * Some Squid messages are only logged to syslog.
>  Those messages are logged to syslog regardless of the "-s" presence.
>  I suspect they may also disregard the "-l facility" setting.
> 
> ... where "logged to syslog" should be interpreted as "sent to the
> syslog daemon", of course.
> 
> IMO, this caveat is essentially a Squid bug.
> 
> You can prevent all Squid messages from appearing in system log files by
> configuring your syslog daemon accordingly.
> 
> 
> HTH,
> 
> Alex.
> 
> 
>>> On 21 Dec 2020, at 11:31, Ambrose Li wrote:
>>> 
>>> On Mon, Dec 21, 2020 at 11:01:07PM +1300, Amos Jeffries wrote:
>>>> On 21/12/20 9:55 pm, sampei02 at tiscali.it <mailto:sampei02 at tiscali.it> wrote:
>>>>> Ok, I noted these 2 squid processes:
>>>>> 
>>>>> root		/usr/sbin/squid -sYC
>>>>> squid       (squid-1) --kid squid-1 -sYC
>>>>> 
>>>>> -s means "Enable logging to syslog?
>>>>> 
>>>>> This option ?-s? could explain writing to messages ?
>>>> 
>>>> Squid does not write to /var/log/messages. On startup before Squid reads any
>>>> configuration about whether cache.log or syslog is to be used it logs to
>>>> stderr.
>>>> 
>>>> That stderr channel is handled by whatever init system or shell is starting
>>>> Squid. /var/log/messages is the init system log file.
>>> 
>>> Actually no, /var/log/messages is not an init system log file; on some Linux
>>> distros it is a default log location for syslog.
>>> 
>>> I can confirm that squid will write to /var/log/messages if syslog logging is
>>> enabled AND syslog is configured to write to /var/log/messages (this is the
>>> default behaviour on some Linux distributions, such as Debian, but not Ubuntu).
>>> 
>>> 
>>> -- 
>>> Ambrose Li <ambrose.li at gmail.com> | Time zone: GMT-5 (Eastern)
>>> ambroseli.ca
>>> 
>>> ?Any organization which designs a system? will inevitably produce a
>>> design whose structure is a copy of the organization?s communication
>>> structure.? ? Conway?s Law
>>> 
>>> _______________________________________________
>>> squid-users mailing list
>>> squid-users at lists.squid-cache.org
>>> http://lists.squid-cache.org/listinfo/squid-users
>> 
>> _______________________________________________
>> squid-users mailing list
>> squid-users at lists.squid-cache.org <mailto:squid-users at lists.squid-cache.org>
>> http://lists.squid-cache.org/listinfo/squid-users <http://lists.squid-cache.org/listinfo/squid-users>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20201222/51bd1821/attachment.htm>

From mikio.kishi at gmail.com  Wed Dec 23 06:10:38 2020
From: mikio.kishi at gmail.com (mikio.kishi at gmail.com)
Date: Wed, 23 Dec 2020 15:10:38 +0900
Subject: [squid-users] Problem with access.log and when using SMP
In-Reply-To: <55acb0d3-44ba-8ce8-f8e2-0d3d70cffdac@treenet.co.nz>
References: <CAMUMefYXkZ=wk4QDheknttFug44gaWN3tS9fzm7btADYjkpXTQ@mail.gmail.com>
 <55acb0d3-44ba-8ce8-f8e2-0d3d70cffdac@treenet.co.nz>
Message-ID: <CAMUMefYSbLq+qRtCtz7KWT__Z2ERSWpUWwqFARYM_c5cW_s2Qw@mail.gmail.com>

Hi Amos,

Thank you for your reply.

> What version of Squid are you using? I thought that problem was solved
> long ago.

I'm using squid-3.5. I would like to know which version was solved.
I checked the difference codes of log_file_daemon.cc between squid-3.5 and
squid-4.13,
however could not find out the fixed codes..

Regards,
--
Mikio Kishi

On Sat, Dec 19, 2020 at 5:39 PM Amos Jeffries <squid3 at treenet.co.nz> wrote:

> On 19/12/20 8:07 pm, mikio.kishi at gmail.com wrote:
> > Hi,
> >
> > I have the following same problem using access_log.
> >
>
>   What version of Squid are you using? I thought that problem was solved
> long ago.
>
> > In that case, does the following "stdio" logging module also become a
> > workaround to solve the issue ?
> >
>
> No. That issue is multiple processes trying to write to one disk file.
> Only workarounds are writing to different files. Or not using a
> file-based module (eg syslog, UDP, TCP) or a daemon that does not output
> straight to files (eg the DB one).
>
>
> Amos
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20201223/6f508643/attachment.htm>

From ngtech1ltd at gmail.com  Wed Dec 23 19:06:25 2020
From: ngtech1ltd at gmail.com (NgTech LTD)
Date: Wed, 23 Dec 2020 21:06:25 +0200
Subject: [squid-users] NgTech REPO is up for now.
Message-ID: <CABA8h=QrhrmqeD+LH4N-uBO1od3Fh1DT8JcpRMWSs9fj9_XDyg@mail.gmail.com>

Hey,

The ngtech repo is up and running.
I cannot guarantee that network bursts will not interrupt the service
from time to time.

However The repo now is at:
http://ngtech.co.il/repo/

There is no HTTPS at all on this service so.. if the browser forces
you to use HTTPS I recommend curl or wget.
If someone need a copy of the repo for CentOS it can be found at:
http://linuxsoft.cern.ch/mirror/www1.ngtech.co.il/repo/centos/7/x86_64/

The new release includes the fedora 33 RPMs' for Squid 4.13.
I will try to release an ansible for example usage in case someone
will want to install squid on Debian.
Maybe later I will add a CentOS/RHEL/Fedora playbooks.

Eliezer

* Maybe I will add a story in the next release.


From akashmm425 at gmail.com  Thu Dec 24 17:44:21 2020
From: akashmm425 at gmail.com (Song & Movie)
Date: Thu, 24 Dec 2020 11:44:21 -0600
Subject: [squid-users] squid writes to /var/log/messages
In-Reply-To: <20201221103116.GE11324@pingviini>
References: <54E44A11-6033-4BC6-BEA4-F220FAF6A46D@tiscali.it>
 <CABA8h=TA1JTuC6rxjMA9tikASEfz_sNTtbWVEDAk35SOv6MCLQ@mail.gmail.com>
 <BE660CBB-37C4-4307-B698-F1A87CD4F978@tiscali.it>
 <41657549-4600-c94f-bbac-f53a8ff19171@treenet.co.nz>
 <20201221103116.GE11324@pingviini>
Message-ID: <CA+=P9qkj_oyXmEWSPkOhDMPDcmVHP2UtFaAPWFFm_Cf+__1hiw@mail.gmail.com>

Can any one help me to create http proxy ?

On Mon, Dec 21, 2020 at 4:31 AM Ambrose Li <ambrose.li at gmail.com> wrote:

> On Mon, Dec 21, 2020 at 11:01:07PM +1300, Amos Jeffries wrote:
> > On 21/12/20 9:55 pm, sampei02 at tiscali.it wrote:
> > > Ok, I noted these 2 squid processes:
> > >
> > > root                /usr/sbin/squid -sYC
> > > squid       (squid-1) --kid squid-1 -sYC
> > >
> > > -s means "Enable logging to syslog?
> > >
> > > This option ?-s? could explain writing to messages ?
> >
> > Squid does not write to /var/log/messages. On startup before Squid reads
> any
> > configuration about whether cache.log or syslog is to be used it logs to
> > stderr.
> >
> > That stderr channel is handled by whatever init system or shell is
> starting
> > Squid. /var/log/messages is the init system log file.
>
> Actually no, /var/log/messages is not an init system log file; on some
> Linux
> distros it is a default log location for syslog.
>
> I can confirm that squid will write to /var/log/messages if syslog logging
> is
> enabled AND syslog is configured to write to /var/log/messages (this is the
> default behaviour on some Linux distributions, such as Debian, but not
> Ubuntu).
>
>
> --
> Ambrose Li <ambrose.li at gmail.com> | Time zone: GMT-5 (Eastern)
> ambroseli.ca
>
> ?Any organization which designs a system? will inevitably produce a
>  design whose structure is a copy of the organization?s communication
>  structure.? ? Conway?s Law
>
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20201224/282e35a4/attachment.htm>

From Antony.Stone at squid.open.source.it  Thu Dec 24 19:06:26 2020
From: Antony.Stone at squid.open.source.it (Antony Stone)
Date: Thu, 24 Dec 2020 20:06:26 +0100
Subject: [squid-users] squid writes to /var/log/messages
In-Reply-To: <CA+=P9qkj_oyXmEWSPkOhDMPDcmVHP2UtFaAPWFFm_Cf+__1hiw@mail.gmail.com>
References: <54E44A11-6033-4BC6-BEA4-F220FAF6A46D@tiscali.it>
 <20201221103116.GE11324@pingviini>
 <CA+=P9qkj_oyXmEWSPkOhDMPDcmVHP2UtFaAPWFFm_Cf+__1hiw@mail.gmail.com>
Message-ID: <202012242006.26406.Antony.Stone@squid.open.source.it>

On Thursday 24 December 2020 at 18:44:21, Song & Movie wrote:

> Can any one help me to create http proxy ?

1. Please do not hijack an unrelated thread on the list.  Please start a new 
thread by posting to squid-users at lists.squid-cache.org with an appropriate 
subject.

2. Please give us at least *some* information about:

a) what you're trying to achieve
b) what system you want to install it on
c) what you've done already
d) what problems you've run into

Regards,


Antony,

-- 
Late in 1972 President Richard Nixon announced that the rate of increase of 
inflation was decreasing.   This was the first time a sitting president used a 
third derivative to advance his case for re-election.

 - Hugo Rossi, Notices of the American Mathematical Society

                                                   Please reply to the list;
                                                         please *don't* CC me.


From roeeklinger60 at gmail.com  Tue Dec 29 15:36:31 2020
From: roeeklinger60 at gmail.com (roee klinger)
Date: Tue, 29 Dec 2020 17:36:31 +0200
Subject: [squid-users] How do I rotate access.log?
Message-ID: <CAGCa14roPU4h0n=Z_f8VXFWKAU2s7wL53LUnS_qMmFJ9pOOVkg@mail.gmail.com>

Hey,

I know there is plenty of information on this online but for some reason,
this feature is simply not working for me. I have set logfile_rotate to 10
like so:

logfile_rotate 10


However, when I run "squid -k rotate" only the cache.log file rotates. I am
using a custom log format and have also tried setting it like so according
to the documentation:

logformat xxxx %ts.%03tu %6tr %>a %>lp %Ss/%03>Hs %<st %rm %ru %[un %Sh/%<a
%mt
access_log daemon:/var/log/squid/access.log logformat=xxxx rotate=10


However, running "squid -k rotate" still does nothing for the access.log
file.
I have also checked the proxy user has the proper permissions but it's
still not working, any tips on what is going on and how to get this to work?

Best regards,
Roee Klinger
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20201229/d29f2cd0/attachment.htm>

From ngtech1ltd at gmail.com  Tue Dec 29 16:16:25 2020
From: ngtech1ltd at gmail.com (NgTech LTD)
Date: Tue, 29 Dec 2020 18:16:25 +0200
Subject: [squid-users] How do I rotate access.log?
In-Reply-To: <CAGCa14roPU4h0n=Z_f8VXFWKAU2s7wL53LUnS_qMmFJ9pOOVkg@mail.gmail.com>
References: <CAGCa14roPU4h0n=Z_f8VXFWKAU2s7wL53LUnS_qMmFJ9pOOVkg@mail.gmail.com>
Message-ID: <CABA8h=TZQxOPLrJkYfNgidWz3Ehzv0-fH2pijQKjjoDMrjv+MQ@mail.gmail.com>

Hey Roee,

On what version of OS can it be tested, also is the package from the
distribution or self compiler?

Eliezer

On Tue, Dec 29, 2020 at 5:36 PM roee klinger <roeeklinger60 at gmail.com> wrote:
>
> Hey,
>
> I know there is plenty of information on this online but for some reason, this feature is simply not working for me. I have set logfile_rotate to 10 like so:
>
> logfile_rotate 10
>
>
> However, when I run "squid -k rotate" only the cache.log file rotates. I am using a custom log format and have also tried setting it like so according to the documentation:
>
> logformat xxxx %ts.%03tu %6tr %>a %>lp %Ss/%03>Hs %<st %rm %ru %[un %Sh/%<a %mt
> access_log daemon:/var/log/squid/access.log logformat=xxxx rotate=10
>
>
> However, running "squid -k rotate" still does nothing for the access.log file.
> I have also checked the proxy user has the proper permissions but it's still not working, any tips on what is going on and how to get this to work?
>
> Best regards,
> Roee Klinger
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users


From rousskov at measurement-factory.com  Tue Dec 29 16:40:46 2020
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Tue, 29 Dec 2020 11:40:46 -0500
Subject: [squid-users] How do I rotate access.log?
In-Reply-To: <CAGCa14roPU4h0n=Z_f8VXFWKAU2s7wL53LUnS_qMmFJ9pOOVkg@mail.gmail.com>
References: <CAGCa14roPU4h0n=Z_f8VXFWKAU2s7wL53LUnS_qMmFJ9pOOVkg@mail.gmail.com>
Message-ID: <19017c1c-ab07-1693-d5a0-3af88afc13f7@measurement-factory.com>

On 12/29/20 10:36 AM, roee klinger wrote:

>     logfile_rotate 10
>     access_log daemon:/var/log/squid/access.log logformat=xxxx rotate=10

> running "squid -k rotate" still does nothing for the access.log file.

Please note that, according to Squid documentation, your Squid is
slightly misconfigured:

> 	rotate=N		Specifies the number of log file rotations to
> 				make when you run 'squid -k rotate'. [...]
> 				Only supported by the stdio module.

You are not using an "stdio" module. You are using a "daemon" module.

This minor misconfiguraiton, if any, does not explain the lack of
rotations. The deamon module should still rotate based on your global
logfile_rotate directive setting.

What is your Squid version? What logging and rotation-related messages
do you see in your cache.log (check both the pre-rotation and
post-rotation files)?

Alex.


From roeeklinger60 at gmail.com  Tue Dec 29 17:33:40 2020
From: roeeklinger60 at gmail.com (roee klinger)
Date: Tue, 29 Dec 2020 19:33:40 +0200
Subject: [squid-users] How do I rotate access.log?
In-Reply-To: <19017c1c-ab07-1693-d5a0-3af88afc13f7@measurement-factory.com>
References: <CAGCa14roPU4h0n=Z_f8VXFWKAU2s7wL53LUnS_qMmFJ9pOOVkg@mail.gmail.com>
 <19017c1c-ab07-1693-d5a0-3af88afc13f7@measurement-factory.com>
Message-ID: <CAGCa14rfbj0CgavkbstQNYE0zp519x1J65aaFGCPsD=LjdR98A@mail.gmail.com>

Thanks for your reply,

I am using a Raspberry Pi and the latest version of Squid which I installed
from apt.

In my cache.log, here are all my logging and rotation-related messages:

2020/12/29 17:37:14 kid1| logfileRotate: daemon:/var/log/squid/access.log
2020/12/29 17:37:14 kid1| logfileRotate: daemon:/var/log/squid/access.log
2020/12/29 17:37:14 kid1| Logfile: opening log
daemon:/var/log/squid/access.log
2020/12/29 17:37:14 kid1| Logfile Daemon: opening log
/var/log/squid/access.log
2020/12/29 17:37:14 kid1| Store logging disabled
2020/12/29 18:22:39 kid1| Logfile: opening log
stdio:/var/spool/squid/netdb.state
2020/12/29 18:22:39 kid1| Logfile: closing log
stdio:/var/spool/squid/netdb.state

Thanks.


On Tue, Dec 29, 2020 at 6:40 PM Alex Rousskov <
rousskov at measurement-factory.com> wrote:

> On 12/29/20 10:36 AM, roee klinger wrote:
>
> >     logfile_rotate 10
> >     access_log daemon:/var/log/squid/access.log logformat=xxxx rotate=10
>
> > running "squid -k rotate" still does nothing for the access.log file.
>
> Please note that, according to Squid documentation, your Squid is
> slightly misconfigured:
>
> >       rotate=N                Specifies the number of log file rotations
> to
> >                               make when you run 'squid -k rotate'. [...]
> >                               Only supported by the stdio module.
>
> You are not using an "stdio" module. You are using a "daemon" module.
>
> This minor misconfiguraiton, if any, does not explain the lack of
> rotations. The deamon module should still rotate based on your global
> logfile_rotate directive setting.
>
> What is your Squid version? What logging and rotation-related messages
> do you see in your cache.log (check both the pre-rotation and
> post-rotation files)?
>
> Alex.
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20201229/558db1d0/attachment.htm>

From rousskov at measurement-factory.com  Tue Dec 29 18:37:20 2020
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Tue, 29 Dec 2020 13:37:20 -0500
Subject: [squid-users] How do I rotate access.log?
In-Reply-To: <CAGCa14rfbj0CgavkbstQNYE0zp519x1J65aaFGCPsD=LjdR98A@mail.gmail.com>
References: <CAGCa14roPU4h0n=Z_f8VXFWKAU2s7wL53LUnS_qMmFJ9pOOVkg@mail.gmail.com>
 <19017c1c-ab07-1693-d5a0-3af88afc13f7@measurement-factory.com>
 <CAGCa14rfbj0CgavkbstQNYE0zp519x1J65aaFGCPsD=LjdR98A@mail.gmail.com>
Message-ID: <32d4ef6f-583a-40b1-80a0-148f945d0788@measurement-factory.com>

On 12/29/20 12:33 PM, roee klinger wrote:

> I am using a Raspberry Pi and the latest version?of Squid which I
> installed from apt.
> 
> In my cache.log, here are all my logging and rotation-related messages:
> 
> 2020/12/29 17:37:14 kid1| logfileRotate: daemon:/var/log/squid/access.log
> 2020/12/29 17:37:14 kid1| logfileRotate: daemon:/var/log/squid/access.log
> 2020/12/29 17:37:14 kid1| Logfile: opening log daemon:/var/log/squid/access.log
> 2020/12/29 17:37:14 kid1| Logfile Daemon: opening log /var/log/squid/access.log
> 2020/12/29 17:37:14 kid1| Store logging disabled

What is your Squid version? "squid --version" may answer that question.

The "opening log" lines in your cache.log look strange. I do not see
them in my tests, but my version of Squid is probably different from
yours. If you shut down Squid completely, then remove all cache.log
files, then start Squid, and then rotate once, what logging and rotation
messages do you see in all the resulting cache.log files (including the
rotated ones)? Do not shut down or restart Squid until you collect all
those lines. Include all lines that mention "log" or "rotate".

Do you see transactions getting logged to access.log?

Is the logging daemon running? "ps aux | grep 'logfile[-]daemon'" or a
similar command may answer that question.

How do you know that your access.log was _not_ rotated?

Alex.



> On Tue, Dec 29, 2020 at 6:40 PM Alex Rousskov wrote:
> 
>     On 12/29/20 10:36 AM, roee klinger wrote:
> 
>     >? ? ?logfile_rotate 10
>     >? ? ?access_log daemon:/var/log/squid/access.log logformat=xxxx
>     rotate=10
> 
>     > running "squid -k rotate" still does nothing for the access.log file.
> 
>     Please note that, according to Squid documentation, your Squid is
>     slightly misconfigured:
> 
>     >? ? ? ?rotate=N? ? ? ? ? ? ? ? Specifies the number of log file
>     rotations to
>     >? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ?make when you run 'squid -k rotate'.
>     [...]
>     >? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ?Only supported by the stdio module.
> 
>     You are not using an "stdio" module. You are using a "daemon" module.
> 
>     This minor misconfiguraiton, if any, does not explain the lack of
>     rotations. The deamon module should still rotate based on your global
>     logfile_rotate directive setting.
> 
>     What is your Squid version? What logging and rotation-related messages
>     do you see in your cache.log (check both the pre-rotation and
>     post-rotation files)?
> 
>     Alex.
> 



From ngtech1ltd at gmail.com  Tue Dec 29 20:02:22 2020
From: ngtech1ltd at gmail.com (NgTech LTD)
Date: Tue, 29 Dec 2020 22:02:22 +0200
Subject: [squid-users] Anyone has experience with Windows clients DNS timeout
Message-ID: <CABA8h=SW8SSgMa0Xyks=aJfw2k3B2kZ_mWBgtJ75b5v1fc+M6Q@mail.gmail.com>

I have seen this issue on Windows clients over the past.
Windows nslookup shows that the query has timed out after 2 seconds.
On Linux and xBSD I have researched this issue and have seen that:
the DNS server is doing a recursive lookup and it takes from 7 to 10++
seconds sometimes.
When I pre-warn the DNS cache and the results are cached it takes
lower then 500 ms for a response to be on the client side and then
everything works fine.

I understand that Windows DNS client times out..
When using froward proxy with squid or any other it works as expected
since the DNS resolution is done on the proxy server.
However for this issue I believe that this timeout should be increased
instead of moving to DNS over HTTPS.

I would like to hear if anyone has any resolution for this issue on
the Windows clients side.

Thanks,
Eliezer

----
Eliezer Croitoru
Tech Support
Mobile: +972-5-28704261
Email: ngtech1ltd at gmail.com


From squid3 at treenet.co.nz  Wed Dec 30 04:15:19 2020
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Wed, 30 Dec 2020 17:15:19 +1300
Subject: [squid-users] Anyone has experience with Windows clients DNS
 timeout
In-Reply-To: <CABA8h=SW8SSgMa0Xyks=aJfw2k3B2kZ_mWBgtJ75b5v1fc+M6Q@mail.gmail.com>
References: <CABA8h=SW8SSgMa0Xyks=aJfw2k3B2kZ_mWBgtJ75b5v1fc+M6Q@mail.gmail.com>
Message-ID: <a0fa06ea-040d-0993-12a8-1c402176e623@treenet.co.nz>

On 30/12/20 9:02 am, NgTech LTD wrote:
> I have seen this issue on Windows clients over the past.
> Windows nslookup shows that the query has timed out after 2 seconds.
> On Linux and xBSD I have researched this issue and have seen that:
> the DNS server is doing a recursive lookup and it takes from 7 to 10++
> seconds sometimes.
> When I pre-warn the DNS cache and the results are cached it takes
> lower then 500 ms for a response to be on the client side and then
> everything works fine.
> 
> I understand that Windows DNS client times out..
> When using froward proxy with squid or any other it works as expected
> since the DNS resolution is done on the proxy server.
> However for this issue I believe that this timeout should be increased
> instead of moving to DNS over HTTPS.


The DNS timeout in Squid is 30sec for exactly this type of reason. 2 
seconds is far too short to *guarantee* a recursive resolver is able to 
perform all the work and many round-trip lookups that are needed.

Amos


From belle at bazuin.nl  Wed Dec 30 08:07:50 2020
From: belle at bazuin.nl (=?windows-1252?Q?L.P.H._van_Belle?=)
Date: Wed, 30 Dec 2020 09:07:50 +0100
Subject: [squid-users] Anyone has experience with Windows clients DNS
 timeout
In-Reply-To: <CABA8h=SW8SSgMa0Xyks=aJfw2k3B2kZ_mWBgtJ75b5v1fc+M6Q@mail.gmail.com>
References: <CABA8h=SW8SSgMa0Xyks=aJfw2k3B2kZ_mWBgtJ75b5v1fc+M6Q@mail.gmail.com>
Message-ID: <vmime.5fec3556.184c.372ab7535569aa25@ms249-lin-003.rotterdam.bazuin.nl>

Hai Elizer

Sorry, im not fully agreeing with Amos here.. 

If you DNS is taking 7-10 sec, i would investigate why the dns is that slow.
Something is off, that simple. 


A small example of my dns resolving to internet and my lan dnsservers. 

time dig a www.google.nl @8.8.8.8  @internet dns
real    0m0.115s

real    0m0.031s	@lan dns, lookup 1. 
real    0m0.016s	@lan dns, lookup 2. (cached one) 

So, in my opinion 7-10 seconds timeout is really off. 
In the last we.. 

Is the lan dns set as an authoritive server.
Are the pc's correctly registering in the dns with there primary DNS domain. 

in resolv.conf make sure the primaryDns domain is first in resolv.conf
primary.dnsdomain.tld = output of $(hostname -d)

search primary.dnsdomain.tld  (optional extra, other.dnsdomain.tld dnsdomain.tld ) 
nameserver 192.168.1.1
nameserver 192.168.1.2
nameserver 192.168.1.3
nameserver 192.168.1.4
nameserver 192.168.1.5

# these are the options to look into also. ( in this order ) 
options edns0		# allowed 4096 byte packages. 
options rotate		# if you have more then 1 dns server this can help. 
options timeout:3	
options no-check-names	# dont check for invalid characters such as underscore (_), non-ASCII, or control characters.


Check the following. 
- the DNS server tries to query first to the internet. 
fix might be, resolving (search line) in /etc/resolv.conf

ipv4 / ipv6, try disableing ipv6 on the windows clients.
Dns is Non authoritive where it might be needed to set it to Authoritive.
Dns server is missing forwaring to the authoritive server. 
Routing and routing orders
Are EDNS (4096bytes) big packages allowed
And is the firewall allowing UDP and TCP packages on port 53

I run 3 samba-AD dns servers with Bind9_DLZ
My proxy runs a Bind9 caching and forwarding setup. 
The primay DNS domain is forwarded to the Samba-AD dns server. 
These are the Authoritive servers. 

This is on average my slowest querie 0.1-0.2 sec  ( on the samba dns ) 
i checked the last year in my monitoring. 
Normal is 0.03-0.01 sec 

If there are problems in samba these days its 80% of all cases a resolving setup problem. 

I hope this gave you some ideas. 


Greetz, 

Louis

> -----Oorspronkelijk bericht-----
> Van: squid-users [mailto:squid-users-bounces at lists.squid-cache.org] Namens
> NgTech LTD
> Verzonden: dinsdag 29 december 2020 21:02
> Aan: Squid Users
> Onderwerp: [squid-users] Anyone has experience with Windows clients DNS
> timeout
> 
> I have seen this issue on Windows clients over the past.
> Windows nslookup shows that the query has timed out after 2 seconds.
> On Linux and xBSD I have researched this issue and have seen that:
> the DNS server is doing a recursive lookup and it takes from 7 to 10++
> seconds sometimes.
> When I pre-warn the DNS cache and the results are cached it takes
> lower then 500 ms for a response to be on the client side and then
> everything works fine.
> 
> I understand that Windows DNS client times out..
> When using froward proxy with squid or any other it works as expected
> since the DNS resolution is done on the proxy server.
> However for this issue I believe that this timeout should be increased
> instead of moving to DNS over HTTPS.
> 
> I would like to hear if anyone has any resolution for this issue on
> the Windows clients side.
> 
> Thanks,
> Eliezer
> 
> ----
> Eliezer Croitoru
> Tech Support
> Mobile: +972-5-28704261
> Email: ngtech1ltd at gmail.com
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users



From klaus at westkamp.net  Wed Dec 30 09:57:21 2020
From: klaus at westkamp.net (Klaus Westkamp)
Date: Wed, 30 Dec 2020 10:57:21 +0100
Subject: [squid-users] Anyone has experience with Windows clients DNS
 timeout
In-Reply-To: <vmime.5fec3556.184c.372ab7535569aa25@ms249-lin-003.rotterdam.bazuin.nl>
References: <CABA8h=SW8SSgMa0Xyks=aJfw2k3B2kZ_mWBgtJ75b5v1fc+M6Q@mail.gmail.com>
 <vmime.5fec3556.184c.372ab7535569aa25@ms249-lin-003.rotterdam.bazuin.nl>
Message-ID: <dcbb5e74-da52-23be-c4bf-552e20ca6d92@westkamp.net>


Hi,

i fully agree with Amos. I experience several seconds delay these days 
in resolving names.

Using google, which is having a very fast and heavily caching dns,
is not a good example for recreating this effect.

I could imagine that the seveal DNS encryption methods,
DNS-over-TLS and -over-HTTPS, that are only supported by some
adding to that delay, as they require more overhead
and also the client has to find out which method is supported and which not

Cheers,

Klaus Westkamp


On 30/12/2020 09:07, L.P.H. van Belle wrote:
> Hai Elizer
>
> Sorry, im not fully agreeing with Amos here..
>
> If you DNS is taking 7-10 sec, i would investigate why the dns is that slow.
> Something is off, that simple.
>
>
> A small example of my dns resolving to internet and my lan dnsservers.
>
> time dig a www.google.nl @8.8.8.8  @internet dns
> real    0m0.115s
>
> real    0m0.031s	@lan dns, lookup 1.
> real    0m0.016s	@lan dns, lookup 2. (cached one)
>
> So, in my opinion 7-10 seconds timeout is really off.
> In the last we..
>
> Is the lan dns set as an authoritive server.
> Are the pc's correctly registering in the dns with there primary DNS domain.
>
> in resolv.conf make sure the primaryDns domain is first in resolv.conf
> primary.dnsdomain.tld = output of $(hostname -d)
>
> search primary.dnsdomain.tld  (optional extra, other.dnsdomain.tld dnsdomain.tld )
> nameserver 192.168.1.1
> nameserver 192.168.1.2
> nameserver 192.168.1.3
> nameserver 192.168.1.4
> nameserver 192.168.1.5
>
> # these are the options to look into also. ( in this order )
> options edns0		# allowed 4096 byte packages.
> options rotate		# if you have more then 1 dns server this can help.
> options timeout:3	
> options no-check-names	# dont check for invalid characters such as underscore (_), non-ASCII, or control characters.
>
>
> Check the following.
> - the DNS server tries to query first to the internet.
> fix might be, resolving (search line) in /etc/resolv.conf
>
> ipv4 / ipv6, try disableing ipv6 on the windows clients.
> Dns is Non authoritive where it might be needed to set it to Authoritive.
> Dns server is missing forwaring to the authoritive server.
> Routing and routing orders
> Are EDNS (4096bytes) big packages allowed
> And is the firewall allowing UDP and TCP packages on port 53
>
> I run 3 samba-AD dns servers with Bind9_DLZ
> My proxy runs a Bind9 caching and forwarding setup.
> The primay DNS domain is forwarded to the Samba-AD dns server.
> These are the Authoritive servers.
>
> This is on average my slowest querie 0.1-0.2 sec  ( on the samba dns )
> i checked the last year in my monitoring.
> Normal is 0.03-0.01 sec
>
> If there are problems in samba these days its 80% of all cases a resolving setup problem.
>
> I hope this gave you some ideas.
>
>
> Greetz,
>
> Louis
>
>> -----Oorspronkelijk bericht-----
>> Van: squid-users [mailto:squid-users-bounces at lists.squid-cache.org] Namens
>> NgTech LTD
>> Verzonden: dinsdag 29 december 2020 21:02
>> Aan: Squid Users
>> Onderwerp: [squid-users] Anyone has experience with Windows clients DNS
>> timeout
>>
>> I have seen this issue on Windows clients over the past.
>> Windows nslookup shows that the query has timed out after 2 seconds.
>> On Linux and xBSD I have researched this issue and have seen that:
>> the DNS server is doing a recursive lookup and it takes from 7 to 10++
>> seconds sometimes.
>> When I pre-warn the DNS cache and the results are cached it takes
>> lower then 500 ms for a response to be on the client side and then
>> everything works fine.
>>
>> I understand that Windows DNS client times out..
>> When using froward proxy with squid or any other it works as expected
>> since the DNS resolution is done on the proxy server.
>> However for this issue I believe that this timeout should be increased
>> instead of moving to DNS over HTTPS.
>>
>> I would like to hear if anyone has any resolution for this issue on
>> the Windows clients side.
>>
>> Thanks,
>> Eliezer
>>
>> ----
>> Eliezer Croitoru
>> Tech Support
>> Mobile: +972-5-28704261
>> Email: ngtech1ltd at gmail.com
>> _______________________________________________
>> squid-users mailing list
>> squid-users at lists.squid-cache.org
>> http://lists.squid-cache.org/listinfo/squid-users
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users



From belle at bazuin.nl  Wed Dec 30 10:56:55 2020
From: belle at bazuin.nl (=?windows-1252?Q?L.P.H._van_Belle?=)
Date: Wed, 30 Dec 2020 11:56:55 +0100
Subject: [squid-users] Anyone has experience with Windows clients DNS
 timeout
In-Reply-To: <dcbb5e74-da52-23be-c4bf-552e20ca6d92@westkamp.net>
References: <vmime.5fec3556.184c.372ab7535569aa25@ms249-lin-003.rotterdam.bazuin.nl>
Message-ID: <vmime.5fec5cf7.d9c.5e6680c11b8efee7@ms249-lin-003.rotterdam.bazuin.nl>

And, yes i agree, DNS over TLS might be slower, but really, if you have to wait seconds for a DNS reply... imagine.. 
Lots of websites have 10-20 hosts in them, if you have to wait 10 sec for a website, well, im gone already then.

Thats why i also showed the direct tests my internal Authoritive DNS servers. ( and i can pick any host, will show the same results ). 

All im saying is, before you are going to hunt for "possible" problems.
Make sure the resolving is perfectly setup. 
It will fix at least a lot of problems.

I just dont like Dns over HTTPS.. 
https://www.zdnet.com/article/dns-over-https-causes-more-problems-than-it-solves-experts-say/ 

https://www.samknows.com/blog/dns-over-https-performance

Good articles to read. 

Enjoy. 

Greetz,

Louis


> -----Oorspronkelijk bericht-----
> Van: squid-users [mailto:squid-users-bounces at lists.squid-cache.org] Namens
> Klaus Westkamp
> Verzonden: woensdag 30 december 2020 10:57
> Aan: squid-users at lists.squid-cache.org
> Onderwerp: Re: [squid-users] Anyone has experience with Windows clients
> DNS timeout
> 
> 
> Hi,
> 
> i fully agree with Amos. I experience several seconds delay these days
> in resolving names.
> 
> Using google, which is having a very fast and heavily caching dns,
> is not a good example for recreating this effect.
> 
> I could imagine that the seveal DNS encryption methods,
> DNS-over-TLS and -over-HTTPS, that are only supported by some
> adding to that delay, as they require more overhead
> and also the client has to find out which method is supported and which
> not
> 
> Cheers,
> 
> Klaus Westkamp
> 
> 
> On 30/12/2020 09:07, L.P.H. van Belle wrote:
> > Hai Elizer
> >
> > Sorry, im not fully agreeing with Amos here..
> >
> > If you DNS is taking 7-10 sec, i would investigate why the dns is that
> slow.
> > Something is off, that simple.
> >
> >
> > A small example of my dns resolving to internet and my lan dnsservers.
> >
> > time dig a www.google.nl @8.8.8.8  @internet dns
> > real    0m0.115s
> >
> > real    0m0.031s	@lan dns, lookup 1.
> > real    0m0.016s	@lan dns, lookup 2. (cached one)
> >
> > So, in my opinion 7-10 seconds timeout is really off.
> > In the last we..
> >
> > Is the lan dns set as an authoritive server.
> > Are the pc's correctly registering in the dns with there primary DNS
> domain.
> >
> > in resolv.conf make sure the primaryDns domain is first in resolv.conf
> > primary.dnsdomain.tld = output of $(hostname -d)
> >
> > search primary.dnsdomain.tld  (optional extra, other.dnsdomain.tld
> dnsdomain.tld )
> > nameserver 192.168.1.1
> > nameserver 192.168.1.2
> > nameserver 192.168.1.3
> > nameserver 192.168.1.4
> > nameserver 192.168.1.5
> >
> > # these are the options to look into also. ( in this order )
> > options edns0		# allowed 4096 byte packages.
> > options rotate		# if you have more then 1 dns server this can
> help.
> > options timeout:3
> > options no-check-names	# dont check for invalid characters such as
> underscore (_), non-ASCII, or control characters.
> >
> >
> > Check the following.
> > - the DNS server tries to query first to the internet.
> > fix might be, resolving (search line) in /etc/resolv.conf
> >
> > ipv4 / ipv6, try disableing ipv6 on the windows clients.
> > Dns is Non authoritive where it might be needed to set it to
> Authoritive.
> > Dns server is missing forwaring to the authoritive server.
> > Routing and routing orders
> > Are EDNS (4096bytes) big packages allowed
> > And is the firewall allowing UDP and TCP packages on port 53
> >
> > I run 3 samba-AD dns servers with Bind9_DLZ
> > My proxy runs a Bind9 caching and forwarding setup.
> > The primay DNS domain is forwarded to the Samba-AD dns server.
> > These are the Authoritive servers.
> >
> > This is on average my slowest querie 0.1-0.2 sec  ( on the samba dns )
> > i checked the last year in my monitoring.
> > Normal is 0.03-0.01 sec
> >
> > If there are problems in samba these days its 80% of all cases a
> resolving setup problem.
> >
> > I hope this gave you some ideas.
> >
> >
> > Greetz,
> >
> > Louis
> >
> >> -----Oorspronkelijk bericht-----
> >> Van: squid-users [mailto:squid-users-bounces at lists.squid-cache.org]
> Namens
> >> NgTech LTD
> >> Verzonden: dinsdag 29 december 2020 21:02
> >> Aan: Squid Users
> >> Onderwerp: [squid-users] Anyone has experience with Windows clients DNS
> >> timeout
> >>
> >> I have seen this issue on Windows clients over the past.
> >> Windows nslookup shows that the query has timed out after 2 seconds.
> >> On Linux and xBSD I have researched this issue and have seen that:
> >> the DNS server is doing a recursive lookup and it takes from 7 to 10++
> >> seconds sometimes.
> >> When I pre-warn the DNS cache and the results are cached it takes
> >> lower then 500 ms for a response to be on the client side and then
> >> everything works fine.
> >>
> >> I understand that Windows DNS client times out..
> >> When using froward proxy with squid or any other it works as expected
> >> since the DNS resolution is done on the proxy server.
> >> However for this issue I believe that this timeout should be increased
> >> instead of moving to DNS over HTTPS.
> >>
> >> I would like to hear if anyone has any resolution for this issue on
> >> the Windows clients side.
> >>
> >> Thanks,
> >> Eliezer
> >>
> >> ----
> >> Eliezer Croitoru
> >> Tech Support
> >> Mobile: +972-5-28704261
> >> Email: ngtech1ltd at gmail.com
> >> _______________________________________________
> >> squid-users mailing list
> >> squid-users at lists.squid-cache.org
> >> http://lists.squid-cache.org/listinfo/squid-users
> > _______________________________________________
> > squid-users mailing list
> > squid-users at lists.squid-cache.org
> > http://lists.squid-cache.org/listinfo/squid-users
> 
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users



From ngtech1ltd at gmail.com  Wed Dec 30 12:37:00 2020
From: ngtech1ltd at gmail.com (NgTech LTD)
Date: Wed, 30 Dec 2020 14:37:00 +0200
Subject: [squid-users] Anyone has experience with Windows clients DNS
 timeout
In-Reply-To: <vmime.5fec5cf7.d9c.5e6680c11b8efee7@ms249-lin-003.rotterdam.bazuin.nl>
References: <vmime.5fec3556.184c.372ab7535569aa25@ms249-lin-003.rotterdam.bazuin.nl>
 <dcbb5e74-da52-23be-c4bf-552e20ca6d92@westkamp.net>
 <vmime.5fec5cf7.d9c.5e6680c11b8efee7@ms249-lin-003.rotterdam.bazuin.nl>
Message-ID: <CABA8h=Ss6UHRLXuqN4WcMWst4NVmM0mpkgcf2PfvcOL4nG11uA@mail.gmail.com>

Hey Louis,
Thanks For the feedback.

Indeed I do understand if someone want to have a fast DNS resolution.
However there are things which are not under our domain and control.
For example the root DNS servers can be unreachable for a second or
more sometimes to specific areas.
I cannot change the way how optic communication cables are managed but
I can control my windows or proxy.
Since the proxy can be tuned easily compared to the root servers
themselves or any other lower level DNS services I might choose to use
a proxy.
In the ISP world the provider have two or more DNS servers which
sometimes can respond slower then expected.
It's a fact that we need two or more DNS servers but when you manage a
DNS server or start a BIND recursive server you will able to see this
issue.
On the first recursive request for a link with 20-80+ ms delay it is
possible that either a packet lost on the way or that the overall
response is higher then 10 seconds.
The only reasonable solution I can see is to set the clients or the
proxy according to the environment.

For example a local on premise DNS caching service(dnsmasq, unbound,
bind) should help a bit to some cases.
The next level is to pre-warm the cache for the root servers.
If this doesn't help fix the Clients windows timeout from 2 seconds to
more..(10-15).
If the above seems to not resolve the issues then and only then it's
the proxy time.

I think I found the basic way to define this in The Windows registry
but not sure.
These documents can describe this issue at:

https://docs.microsoft.com/en-us/previous-versions//cc977482(v=technet.10)?redirectedfrom=MSDN
https://serverfault.com/questions/431207/adjust-windows-dns-timeout-similar-to-the-linux-resolv-conf
https://thehotery.name/windows/network/dns
https://groups.google.com/g/microsoft.public.windows.inetexplorer.ie6.browser/c/TrUhaEZEtIw/m/dZOB6Z8AvN0J

The default registry key is not present but the value is:
## START of text file
Windows Registry Editor Version 5.00

[HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters]
"DNSQueryTimeouts"=hex(7):31,00,00,00,32,00,00,00,32,00,00,00,34,00,00,00,38,00,00,00,00,00
## END of text file

A modified one is:
## START of text file
Windows Registry Editor Version 5.00

[HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters]
"DNSQueryTimeouts"=hex(7):34,00,00,00,38,00,00,00,38,00,00,00,31,00,36,00,00,00,33,00,32,00,00,00,00,00
## END of text file


I have not tested it yet but if it does but in Windows nslookup you
can change the timeout using:
set timeout=10

and test the server for timeout issues.
This is common to see in windows that the first lookup would fail
after 2 seconds but the next one will get a result.
If the client will wait enough he will receive the packet and the
resolution fast compared to a fully recursive one every time.

I think that this timeout deserve a wiki page.

Thanks,
Eliezer

----
Eliezer Croitoru
Tech Support
Mobile: +972-5-28704261
Email: ngtech1ltd at gmail.com
On Wed, Dec 30, 2020 at 12:57 PM L.P.H. van Belle <belle at bazuin.nl> wrote:
>
> And, yes i agree, DNS over TLS might be slower, but really, if you have to wait seconds for a DNS reply... imagine..
> Lots of websites have 10-20 hosts in them, if you have to wait 10 sec for a website, well, im gone already then.
>
> Thats why i also showed the direct tests my internal Authoritive DNS servers. ( and i can pick any host, will show the same results ).
>
> All im saying is, before you are going to hunt for "possible" problems.
> Make sure the resolving is perfectly setup.
> It will fix at least a lot of problems.
>
> I just dont like Dns over HTTPS..
> https://www.zdnet.com/article/dns-over-https-causes-more-problems-than-it-solves-experts-say/
>
> https://www.samknows.com/blog/dns-over-https-performance
>
> Good articles to read.
>
> Enjoy.
>
> Greetz,
>
> Louis
>
>
> > -----Oorspronkelijk bericht-----
> > Van: squid-users [mailto:squid-users-bounces at lists.squid-cache.org] Namens
> > Klaus Westkamp
> > Verzonden: woensdag 30 december 2020 10:57
> > Aan: squid-users at lists.squid-cache.org
> > Onderwerp: Re: [squid-users] Anyone has experience with Windows clients
> > DNS timeout
> >
> >
> > Hi,
> >
> > i fully agree with Amos. I experience several seconds delay these days
> > in resolving names.
> >
> > Using google, which is having a very fast and heavily caching dns,
> > is not a good example for recreating this effect.
> >
> > I could imagine that the seveal DNS encryption methods,
> > DNS-over-TLS and -over-HTTPS, that are only supported by some
> > adding to that delay, as they require more overhead
> > and also the client has to find out which method is supported and which
> > not
> >
> > Cheers,
> >
> > Klaus Westkamp
> >
> >
> > On 30/12/2020 09:07, L.P.H. van Belle wrote:
> > > Hai Elizer
> > >
> > > Sorry, im not fully agreeing with Amos here..
> > >
> > > If you DNS is taking 7-10 sec, i would investigate why the dns is that
> > slow.
> > > Something is off, that simple.
> > >
> > >
> > > A small example of my dns resolving to internet and my lan dnsservers.
> > >
> > > time dig a www.google.nl @8.8.8.8  @internet dns
> > > real    0m0.115s
> > >
> > > real    0m0.031s    @lan dns, lookup 1.
> > > real    0m0.016s    @lan dns, lookup 2. (cached one)
> > >
> > > So, in my opinion 7-10 seconds timeout is really off.
> > > In the last we..
> > >
> > > Is the lan dns set as an authoritive server.
> > > Are the pc's correctly registering in the dns with there primary DNS
> > domain.
> > >
> > > in resolv.conf make sure the primaryDns domain is first in resolv.conf
> > > primary.dnsdomain.tld = output of $(hostname -d)
> > >
> > > search primary.dnsdomain.tld  (optional extra, other.dnsdomain.tld
> > dnsdomain.tld )
> > > nameserver 192.168.1.1
> > > nameserver 192.168.1.2
> > > nameserver 192.168.1.3
> > > nameserver 192.168.1.4
> > > nameserver 192.168.1.5
> > >
> > > # these are the options to look into also. ( in this order )
> > > options edns0               # allowed 4096 byte packages.
> > > options rotate              # if you have more then 1 dns server this can
> > help.
> > > options timeout:3
> > > options no-check-names      # dont check for invalid characters such as
> > underscore (_), non-ASCII, or control characters.
> > >
> > >
> > > Check the following.
> > > - the DNS server tries to query first to the internet.
> > > fix might be, resolving (search line) in /etc/resolv.conf
> > >
> > > ipv4 / ipv6, try disableing ipv6 on the windows clients.
> > > Dns is Non authoritive where it might be needed to set it to
> > Authoritive.
> > > Dns server is missing forwaring to the authoritive server.
> > > Routing and routing orders
> > > Are EDNS (4096bytes) big packages allowed
> > > And is the firewall allowing UDP and TCP packages on port 53
> > >
> > > I run 3 samba-AD dns servers with Bind9_DLZ
> > > My proxy runs a Bind9 caching and forwarding setup.
> > > The primay DNS domain is forwarded to the Samba-AD dns server.
> > > These are the Authoritive servers.
> > >
> > > This is on average my slowest querie 0.1-0.2 sec  ( on the samba dns )
> > > i checked the last year in my monitoring.
> > > Normal is 0.03-0.01 sec
> > >
> > > If there are problems in samba these days its 80% of all cases a
> > resolving setup problem.
> > >
> > > I hope this gave you some ideas.
> > >
> > >
> > > Greetz,
> > >
> > > Louis
> > >
> > >> -----Oorspronkelijk bericht-----
> > >> Van: squid-users [mailto:squid-users-bounces at lists.squid-cache.org]
> > Namens
> > >> NgTech LTD
> > >> Verzonden: dinsdag 29 december 2020 21:02
> > >> Aan: Squid Users
> > >> Onderwerp: [squid-users] Anyone has experience with Windows clients DNS
> > >> timeout
> > >>
> > >> I have seen this issue on Windows clients over the past.
> > >> Windows nslookup shows that the query has timed out after 2 seconds.
> > >> On Linux and xBSD I have researched this issue and have seen that:
> > >> the DNS server is doing a recursive lookup and it takes from 7 to 10++
> > >> seconds sometimes.
> > >> When I pre-warn the DNS cache and the results are cached it takes
> > >> lower then 500 ms for a response to be on the client side and then
> > >> everything works fine.
> > >>
> > >> I understand that Windows DNS client times out..
> > >> When using froward proxy with squid or any other it works as expected
> > >> since the DNS resolution is done on the proxy server.
> > >> However for this issue I believe that this timeout should be increased
> > >> instead of moving to DNS over HTTPS.
> > >>
> > >> I would like to hear if anyone has any resolution for this issue on
> > >> the Windows clients side.
> > >>
> > >> Thanks,
> > >> Eliezer
> > >>
> > >> ----
> > >> Eliezer Croitoru
> > >> Tech Support
> > >> Mobile: +972-5-28704261
> > >> Email: ngtech1ltd at gmail.com
> > >> _______________________________________________
> > >> squid-users mailing list
> > >> squid-users at lists.squid-cache.org
> > >> http://lists.squid-cache.org/listinfo/squid-users
> > > _______________________________________________
> > > squid-users mailing list
> > > squid-users at lists.squid-cache.org
> > > http://lists.squid-cache.org/listinfo/squid-users
> >
> > _______________________________________________
> > squid-users mailing list
> > squid-users at lists.squid-cache.org
> > http://lists.squid-cache.org/listinfo/squid-users
>
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users


From belle at bazuin.nl  Wed Dec 30 13:38:16 2020
From: belle at bazuin.nl (=?windows-1252?Q?L.P.H._van_Belle?=)
Date: Wed, 30 Dec 2020 14:38:16 +0100
Subject: [squid-users] Anyone has experience with Windows clients DNS
 timeout
In-Reply-To: <CABA8h=Ss6UHRLXuqN4WcMWst4NVmM0mpkgcf2PfvcOL4nG11uA@mail.gmail.com>
References: <vmime.5fec5cf7.d9c.5e6680c11b8efee7@ms249-lin-003.rotterdam.bazuin.nl>
Message-ID: <vmime.5fec82c8.71a2.7618e3785bfddb48@ms249-lin-003.rotterdam.bazuin.nl>

Hai Elizer,

> -----Oorspronkelijk bericht-----
> Van: NgTech LTD [mailto:ngtech1ltd at gmail.com]
> Verzonden: woensdag 30 december 2020 13:37
> Aan: L.P.H. van Belle
> CC: squid-users at lists.squid-cache.org
> Onderwerp: Re: [squid-users] Anyone has experience with Windows clients
> DNS timeout
> 
> Hey Louis,
> Thanks For the feedback.
> 
> Indeed I do understand if someone want to have a fast DNS resolution.
> However there are things which are not under our domain and control.

> For example the root DNS servers can be unreachable for a second or
> more sometimes to specific areas.
Now this im having here also, took me 6 months but my internet provider 
is now finaly going to fix it. Often its out of bandwith.. 
in my case this was a change they did in the background. 
In the netherlands i know lots of fiber providers dont monitor there bandwith, i builded some monitoring servers for one of them, thats how i know. They dont care because the just say, ah.. fiber sufficient bandwith..
:-/ 

> I cannot change the way how optic communication cables are managed but
> I can control my windows or proxy.
> Since the proxy can be tuned easily compared to the root servers
> themselves or any other lower level DNS services I might choose to use
> a proxy.
Test agains other dns servers and track the route there are using.. 
in my above problem i tracked this from 5 different providers to find the problem point. 

> In the ISP world the provider have two or more DNS servers which
> sometimes can respond slower then expected.
> It's a fact that we need two or more DNS servers but when you manage a
> DNS server or start a BIND recursive server you will able to see this
> issue.
> On the first recursive request for a link with 20-80+ ms delay it is
> possible that either a packet lost on the way or that the overall
> response is higher then 10 seconds.
Also here, if you can monitor your devices, check if you see UDP loss/reject. 

> The only reasonable solution I can see is to set the clients or the
> proxy according to the environment.
both will and should work.. 

> 
> For example a local on premise DNS caching service(dnsmasq, unbound,
> bind) should help a bit to some cases.
> The next level is to pre-warm the cache for the root servers.
> If this doesn't help fix the Clients windows timeout from 2 seconds to
> more..(10-15).

Thats still in my opinion the first one you need to track and find where 
The delay is happening. 

> If the above seems to not resolve the issues then and only then it's
> the proxy time.
> 
> I think I found the basic way to define this in The Windows registry
> but not sure.
> These documents can describe this issue at:
> 
> https://docs.microsoft.com/en-us/previous-
> versions//cc977482(v=technet.10)?redirectedfrom=MSDN
> https://serverfault.com/questions/431207/adjust-windows-dns-timeout-
> similar-to-the-linux-resolv-conf
> https://thehotery.name/windows/network/dns
> https://groups.google.com/g/microsoft.public.windows.inetexplorer.ie6.brow
> ser/c/TrUhaEZEtIw/m/dZOB6Z8AvN0J
> 
> The default registry key is not present but the value is:
> ## START of text file
> Windows Registry Editor Version 5.00
> 
> [HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters]
> "DNSQueryTimeouts"=hex(7):31,00,00,00,32,00,00,00,32,00,00,00,34,00,00,00,
> 38,00,00,00,00,00
> ## END of text file
> 
> A modified one is:
> ## START of text file
> Windows Registry Editor Version 5.00
> 
> [HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters]
> "DNSQueryTimeouts"=hex(7):34,00,00,00,38,00,00,00,38,00,00,00,31,00,36,00,
> 00,00,33,00,32,00,00,00,00,00
> ## END of text file
> 

Beware, you can change that, but i know some parts in windows use some windowsDNS, and if you disable/change that, you MS Store might also stop working. fingered that out the hard way. :-( 

> 
> I have not tested it yet but if it does but in Windows nslookup you
> can change the timeout using:
> set timeout=10
> 
> and test the server for timeout issues.
> This is common to see in windows that the first lookup would fail
> after 2 seconds but the next one will get a result.
> If the client will wait enough he will receive the packet and the
> resolution fast compared to a fully recursive one every time.
> 
> I think that this timeout deserve a wiki page.
> 
> Thanks,
> Eliezer
> 
> ----
> Eliezer Croitoru
> Tech Support
> Mobile: +972-5-28704261
> Email: ngtech1ltd at gmail.com
> On Wed, Dec 30, 2020 at 12:57 PM L.P.H. van Belle <belle at bazuin.nl> wrote:
> >
> > And, yes i agree, DNS over TLS might be slower, but really, if you have
> to wait seconds for a DNS reply... imagine..
> > Lots of websites have 10-20 hosts in them, if you have to wait 10 sec
> for a website, well, im gone already then.
> >
> > Thats why i also showed the direct tests my internal Authoritive DNS
> servers. ( and i can pick any host, will show the same results ).
> >
> > All im saying is, before you are going to hunt for "possible" problems.
> > Make sure the resolving is perfectly setup.
> > It will fix at least a lot of problems.
> >
> > I just dont like Dns over HTTPS..
> > https://www.zdnet.com/article/dns-over-https-causes-more-problems-than-
> it-solves-experts-say/
> >
> > https://www.samknows.com/blog/dns-over-https-performance
> >
> > Good articles to read.
> >
> > Enjoy.
> >
> > Greetz,
> >
> > Louis
> >
> >
> > > -----Oorspronkelijk bericht-----
> > > Van: squid-users [mailto:squid-users-bounces at lists.squid-cache.org]
> Namens
> > > Klaus Westkamp
> > > Verzonden: woensdag 30 december 2020 10:57
> > > Aan: squid-users at lists.squid-cache.org
> > > Onderwerp: Re: [squid-users] Anyone has experience with Windows
> clients
> > > DNS timeout
> > >
> > >
> > > Hi,
> > >
> > > i fully agree with Amos. I experience several seconds delay these days
> > > in resolving names.
> > >
> > > Using google, which is having a very fast and heavily caching dns,
> > > is not a good example for recreating this effect.
> > >
> > > I could imagine that the seveal DNS encryption methods,
> > > DNS-over-TLS and -over-HTTPS, that are only supported by some
> > > adding to that delay, as they require more overhead
> > > and also the client has to find out which method is supported and
> which
> > > not
> > >
> > > Cheers,
> > >
> > > Klaus Westkamp
> > >
> > >
> > > On 30/12/2020 09:07, L.P.H. van Belle wrote:
> > > > Hai Elizer
> > > >
> > > > Sorry, im not fully agreeing with Amos here..
> > > >
> > > > If you DNS is taking 7-10 sec, i would investigate why the dns is
> that
> > > slow.
> > > > Something is off, that simple.
> > > >
> > > >
> > > > A small example of my dns resolving to internet and my lan
> dnsservers.
> > > >
> > > > time dig a www.google.nl @8.8.8.8  @internet dns
> > > > real    0m0.115s
> > > >
> > > > real    0m0.031s    @lan dns, lookup 1.
> > > > real    0m0.016s    @lan dns, lookup 2. (cached one)
> > > >
> > > > So, in my opinion 7-10 seconds timeout is really off.
> > > > In the last we..
> > > >
> > > > Is the lan dns set as an authoritive server.
> > > > Are the pc's correctly registering in the dns with there primary DNS
> > > domain.
> > > >
> > > > in resolv.conf make sure the primaryDns domain is first in
> resolv.conf
> > > > primary.dnsdomain.tld = output of $(hostname -d)
> > > >
> > > > search primary.dnsdomain.tld  (optional extra, other.dnsdomain.tld
> > > dnsdomain.tld )
> > > > nameserver 192.168.1.1
> > > > nameserver 192.168.1.2
> > > > nameserver 192.168.1.3
> > > > nameserver 192.168.1.4
> > > > nameserver 192.168.1.5
> > > >
> > > > # these are the options to look into also. ( in this order )
> > > > options edns0               # allowed 4096 byte packages.
> > > > options rotate              # if you have more then 1 dns server
> this can
> > > help.
> > > > options timeout:3
> > > > options no-check-names      # dont check for invalid characters such
> as
> > > underscore (_), non-ASCII, or control characters.
> > > >
> > > >
> > > > Check the following.
> > > > - the DNS server tries to query first to the internet.
> > > > fix might be, resolving (search line) in /etc/resolv.conf
> > > >
> > > > ipv4 / ipv6, try disableing ipv6 on the windows clients.
> > > > Dns is Non authoritive where it might be needed to set it to
> > > Authoritive.
> > > > Dns server is missing forwaring to the authoritive server.
> > > > Routing and routing orders
> > > > Are EDNS (4096bytes) big packages allowed
> > > > And is the firewall allowing UDP and TCP packages on port 53
> > > >
> > > > I run 3 samba-AD dns servers with Bind9_DLZ
> > > > My proxy runs a Bind9 caching and forwarding setup.
> > > > The primay DNS domain is forwarded to the Samba-AD dns server.
> > > > These are the Authoritive servers.
> > > >
> > > > This is on average my slowest querie 0.1-0.2 sec  ( on the samba dns
> )
> > > > i checked the last year in my monitoring.
> > > > Normal is 0.03-0.01 sec
> > > >
> > > > If there are problems in samba these days its 80% of all cases a
> > > resolving setup problem.
> > > >
> > > > I hope this gave you some ideas.
> > > >
> > > >
> > > > Greetz,
> > > >
> > > > Louis
> > > >
> > > >> -----Oorspronkelijk bericht-----
> > > >> Van: squid-users [mailto:squid-users-bounces at lists.squid-cache.org]
> > > Namens
> > > >> NgTech LTD
> > > >> Verzonden: dinsdag 29 december 2020 21:02
> > > >> Aan: Squid Users
> > > >> Onderwerp: [squid-users] Anyone has experience with Windows clients
> DNS
> > > >> timeout
> > > >>
> > > >> I have seen this issue on Windows clients over the past.
> > > >> Windows nslookup shows that the query has timed out after 2
> seconds.
> > > >> On Linux and xBSD I have researched this issue and have seen that:
> > > >> the DNS server is doing a recursive lookup and it takes from 7 to
> 10++
> > > >> seconds sometimes.
> > > >> When I pre-warn the DNS cache and the results are cached it takes
> > > >> lower then 500 ms for a response to be on the client side and then
> > > >> everything works fine.
> > > >>
> > > >> I understand that Windows DNS client times out..
> > > >> When using froward proxy with squid or any other it works as
> expected
> > > >> since the DNS resolution is done on the proxy server.
> > > >> However for this issue I believe that this timeout should be
> increased
> > > >> instead of moving to DNS over HTTPS.
> > > >>
> > > >> I would like to hear if anyone has any resolution for this issue on
> > > >> the Windows clients side.
> > > >>
> > > >> Thanks,
> > > >> Eliezer
> > > >>
> > > >> ----
> > > >> Eliezer Croitoru
> > > >> Tech Support
> > > >> Mobile: +972-5-28704261
> > > >> Email: ngtech1ltd at gmail.com
> > > >> _______________________________________________
> > > >> squid-users mailing list
> > > >> squid-users at lists.squid-cache.org
> > > >> http://lists.squid-cache.org/listinfo/squid-users
> > > > _______________________________________________
> > > > squid-users mailing list
> > > > squid-users at lists.squid-cache.org
> > > > http://lists.squid-cache.org/listinfo/squid-users
> > >
> > > _______________________________________________
> > > squid-users mailing list
> > > squid-users at lists.squid-cache.org
> > > http://lists.squid-cache.org/listinfo/squid-users
> >
> > _______________________________________________
> > squid-users mailing list
> > squid-users at lists.squid-cache.org
> > http://lists.squid-cache.org/listinfo/squid-users




From moberger at metanetworks.com  Wed Dec 30 14:09:54 2020
From: moberger at metanetworks.com (Moti Berger)
Date: Wed, 30 Dec 2020 16:09:54 +0200
Subject: [squid-users] Connection occasionally not ending after adapting
 response with ICAP
Message-ID: <CAGSk-43G+r-2LPkNNjPR-O8+SZLi_583XRiJnCOOq6Emnb_w3w@mail.gmail.com>

I have a setup with squid 5.0.4 with ICAP server handling responses. The
ICAP server redirects based on some parameters of the response.

To test this setup, I use cURL like this:

> curl -k -s --proxy localhost:8000 -o /dev/null -v <URL>


Now, for some URLs, cURL hangs and for others it exits after receiving the
307 response.
When it hangs, I see this as the output of cURL (I removed what seemed to
me as non-related logs from the beginning):

> } [5 bytes data]
> * TLSv1.3 (OUT), TLS Unknown, Unknown (23):
> } [1 bytes data]
> > GET / HTTP/1.1
> > Host: www.one.co.il
> > User-Agent: curl/7.58.0
> > Accept: */*
> >
> { [5 bytes data]
> * TLSv1.3 (IN), TLS Unknown, Certificate Status (22):
> { [1 bytes data]
> * TLSv1.3 (IN), TLS handshake, Newsession Ticket (4):
> { [217 bytes data]
> * TLSv1.3 (IN), TLS Unknown, Certificate Status (22):
> { [1 bytes data]
> * TLSv1.3 (IN), TLS handshake, Newsession Ticket (4):
> { [217 bytes data]
> * TLSv1.3 (IN), TLS Unknown, Unknown (23):
> { [1 bytes data]
> < HTTP/1.1 307 Temporary Redirect
> < Location: <REDIRECTION-URL>
> < Cache-Control: no-cache, no-store, must-revalidate
> < Pragma: no-cache
> < Date: Wed, 30 Dec 2020 13:58:51 GMT
> < X-Cache: MISS from a0e59ea22cf8
> < X-Cache-Lookup: MISS from a0e59ea22cf8:3128
> < Transfer-Encoding: chunked
> < Via: 1.1 a0e59ea22cf8 (squid/5.0.4)
> < Connection: keep-alive
> <


Using tcpdump I didn't see squid send any other ICAP requests (besides
OPTIONS which the ICAP server replied to properly).
For some of the URLs where it hangs, I saw that running the same cURL
command with the --compressed switch, makes cURL exit as expected:

> } [5 bytes data]
> * TLSv1.3 (OUT), TLS Unknown, Unknown (23):
> } [1 bytes data]
> > GET / HTTP/1.1
> > Host: www.one.co.il
> > User-Agent: curl/7.58.0
> > Accept: */*
> > Accept-Encoding: deflate, gzip
> >
> { [5 bytes data]
> * TLSv1.3 (IN), TLS Unknown, Certificate Status (22):
> { [1 bytes data]
> * TLSv1.3 (IN), TLS handshake, Newsession Ticket (4):
> { [217 bytes data]
> * TLSv1.3 (IN), TLS Unknown, Certificate Status (22):
> { [1 bytes data]
> * TLSv1.3 (IN), TLS handshake, Newsession Ticket (4):
> { [217 bytes data]
> * TLSv1.3 (IN), TLS Unknown, Unknown (23):
> { [1 bytes data]
> < HTTP/1.1 307 Temporary Redirect
> < Location: <REDIRECTION URL>
> < Cache-Control: no-cache, no-store, must-revalidate
> < Pragma: no-cache
> < Date: Wed, 30 Dec 2020 14:00:31 GMT
> < X-Cache: MISS from a0e59ea22cf8
> < X-Cache-Lookup: MISS from a0e59ea22cf8:3128
> < Transfer-Encoding: chunked
> < Via: 1.1 a0e59ea22cf8 (squid/5.0.4)
> < Connection: keep-alive
> <
> { [5 bytes data]
> * TLSv1.3 (IN), TLS Unknown, Unknown (23):
> { [1 bytes data]
> * Connection #0 to host localhost left intact


When I skip the adaptation in REQMOD, I get the page and the connection is
terminated.
When the ICAP works in REQMOD and redirects on the same URLs, everything
seems to work properly.

What could make squid not to terminate the connection? Could it be that it
still holds connection with the HTTP server?

Thanks
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20201230/f6a97439/attachment.htm>

From ngtech1ltd at gmail.com  Wed Dec 30 14:46:16 2020
From: ngtech1ltd at gmail.com (NgTech LTD)
Date: Wed, 30 Dec 2020 16:46:16 +0200
Subject: [squid-users] Connection occasionally not ending after adapting
 response with ICAP
In-Reply-To: <CAGSk-43G+r-2LPkNNjPR-O8+SZLi_583XRiJnCOOq6Emnb_w3w@mail.gmail.com>
References: <CAGSk-43G+r-2LPkNNjPR-O8+SZLi_583XRiJnCOOq6Emnb_w3w@mail.gmail.com>
Message-ID: <CABA8h=RZORuFBUFFWPxwj7VOvjj6oty9nhcewbjt6P=mqOq=3g@mail.gmail.com>

An icap tcpdump pcap file might help to understand something.

Eliezer

On Wed, Dec 30, 2020, 16:10 Moti Berger <moberger at metanetworks.com> wrote:

> I have a setup with squid 5.0.4 with ICAP server handling responses. The
> ICAP server redirects based on some parameters of the response.
>
> To test this setup, I use cURL like this:
>
>> curl -k -s --proxy localhost:8000 -o /dev/null -v <URL>
>
>
> Now, for some URLs, cURL hangs and for others it exits after receiving the
> 307 response.
> When it hangs, I see this as the output of cURL (I removed what seemed to
> me as non-related logs from the beginning):
>
>> } [5 bytes data]
>> * TLSv1.3 (OUT), TLS Unknown, Unknown (23):
>> } [1 bytes data]
>> > GET / HTTP/1.1
>> > Host: www.one.co.il
>> > User-Agent: curl/7.58.0
>> > Accept: */*
>> >
>> { [5 bytes data]
>> * TLSv1.3 (IN), TLS Unknown, Certificate Status (22):
>> { [1 bytes data]
>> * TLSv1.3 (IN), TLS handshake, Newsession Ticket (4):
>> { [217 bytes data]
>> * TLSv1.3 (IN), TLS Unknown, Certificate Status (22):
>> { [1 bytes data]
>> * TLSv1.3 (IN), TLS handshake, Newsession Ticket (4):
>> { [217 bytes data]
>> * TLSv1.3 (IN), TLS Unknown, Unknown (23):
>> { [1 bytes data]
>> < HTTP/1.1 307 Temporary Redirect
>> < Location: <REDIRECTION-URL>
>> < Cache-Control: no-cache, no-store, must-revalidate
>> < Pragma: no-cache
>> < Date: Wed, 30 Dec 2020 13:58:51 GMT
>> < X-Cache: MISS from a0e59ea22cf8
>> < X-Cache-Lookup: MISS from a0e59ea22cf8:3128
>> < Transfer-Encoding: chunked
>> < Via: 1.1 a0e59ea22cf8 (squid/5.0.4)
>> < Connection: keep-alive
>> <
>
>
> Using tcpdump I didn't see squid send any other ICAP requests (besides
> OPTIONS which the ICAP server replied to properly).
> For some of the URLs where it hangs, I saw that running the same cURL
> command with the --compressed switch, makes cURL exit as expected:
>
>> } [5 bytes data]
>> * TLSv1.3 (OUT), TLS Unknown, Unknown (23):
>> } [1 bytes data]
>> > GET / HTTP/1.1
>> > Host: www.one.co.il
>> > User-Agent: curl/7.58.0
>> > Accept: */*
>> > Accept-Encoding: deflate, gzip
>> >
>> { [5 bytes data]
>> * TLSv1.3 (IN), TLS Unknown, Certificate Status (22):
>> { [1 bytes data]
>> * TLSv1.3 (IN), TLS handshake, Newsession Ticket (4):
>> { [217 bytes data]
>> * TLSv1.3 (IN), TLS Unknown, Certificate Status (22):
>> { [1 bytes data]
>> * TLSv1.3 (IN), TLS handshake, Newsession Ticket (4):
>> { [217 bytes data]
>> * TLSv1.3 (IN), TLS Unknown, Unknown (23):
>> { [1 bytes data]
>> < HTTP/1.1 307 Temporary Redirect
>> < Location: <REDIRECTION URL>
>> < Cache-Control: no-cache, no-store, must-revalidate
>> < Pragma: no-cache
>> < Date: Wed, 30 Dec 2020 14:00:31 GMT
>> < X-Cache: MISS from a0e59ea22cf8
>> < X-Cache-Lookup: MISS from a0e59ea22cf8:3128
>> < Transfer-Encoding: chunked
>> < Via: 1.1 a0e59ea22cf8 (squid/5.0.4)
>> < Connection: keep-alive
>> <
>> { [5 bytes data]
>> * TLSv1.3 (IN), TLS Unknown, Unknown (23):
>> { [1 bytes data]
>> * Connection #0 to host localhost left intact
>
>
> When I skip the adaptation in REQMOD, I get the page and the connection is
> terminated.
> When the ICAP works in REQMOD and redirects on the same URLs, everything
> seems to work properly.
>
> What could make squid not to terminate the connection? Could it be that it
> still holds connection with the HTTP server?
>
> Thanks
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20201230/b42afd66/attachment.htm>

From rousskov at measurement-factory.com  Wed Dec 30 14:54:05 2020
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Wed, 30 Dec 2020 09:54:05 -0500
Subject: [squid-users] Connection occasionally not ending after adapting
 response with ICAP
In-Reply-To: <CAGSk-43G+r-2LPkNNjPR-O8+SZLi_583XRiJnCOOq6Emnb_w3w@mail.gmail.com>
References: <CAGSk-43G+r-2LPkNNjPR-O8+SZLi_583XRiJnCOOq6Emnb_w3w@mail.gmail.com>
Message-ID: <29fd337c-1bf5-ef98-16c6-02b8aaf02d4b@measurement-factory.com>

On 12/30/20 9:09 AM, Moti Berger wrote:
> I have a setup with squid 5.0.4 with ICAP server handling responses. 

FTR: This part seems to be about an ICAP RESPMOD service generating a
307 redirect (AFAICT).


> When it hangs, I see this as the output of cURL 

>     > GET / HTTP/1.1
>     > Host: www.one.co.il <http://www.one.co.il>
>     > User-Agent: curl/7.58.0
>     > Accept: */*

>     < HTTP/1.1 307 Temporary Redirect
>     < Location: <REDIRECTION-URL>
>     < Cache-Control: no-cache, no-store, must-revalidate
>     < Pragma: no-cache
>     < Date: Wed, 30 Dec 2020 13:58:51 GMT
>     < X-Cache: MISS from a0e59ea22cf8
>     < X-Cache-Lookup: MISS from a0e59ea22cf8:3128
>     < Transfer-Encoding: chunked
>     < Via: 1.1 a0e59ea22cf8 (squid/5.0.4)
>     < Connection: keep-alive

Did curl receive the last-chunk from Squid? If not, did Squid received
the last-chunk from the ICAP service? See below for more details.


> For some of the URLs where it hangs, I saw that running the same cURL
> command with the --compressed switch, makes cURL exit as expected:

Squid ignores Accept-Encoding so the --compressed switch is not relevant
to Squid. Perhaps the ICAP service or the origin server react to it, but
the headers you have provided do not show any important differences:

>     > GET / HTTP/1.1
>     > Host: www.one.co.il <http://www.one.co.il>
>     > User-Agent: curl/7.58.0
>     > Accept: */*
>     > Accept-Encoding: deflate, gzip

>     < HTTP/1.1 307 Temporary Redirect
>     < Location: <REDIRECTION URL>
>     < Cache-Control: no-cache, no-store, must-revalidate
>     < Pragma: no-cache
>     < Date: Wed, 30 Dec 2020 14:00:31 GMT
>     < X-Cache: MISS from a0e59ea22cf8
>     < X-Cache-Lookup: MISS from a0e59ea22cf8:3128
>     < Transfer-Encoding: chunked
>     < Via: 1.1 a0e59ea22cf8 (squid/5.0.4)
>     < Connection: keep-alive

> When I skip the adaptation in REQMOD, I get the page and the connection
> is terminated.

... but REQMOD does not redirect when you do _not_ skip it, right? That
is, it is RESPMOD that always redirects (until a separate test below)?
If that is what happens, then it is possible that something goes wrong
inside the ICAP service, and turning off REQMOD that does not redirect
fixes the redirect in RESPMOD. However, it is a bit difficult for me to
follow the REQMOD/RESPMOD roles in your email so I may be
misunderstanding something.


> When the ICAP works in REQMOD and redirects on the same URLs, everything
> seems to work properly.

OK. Redirection in REQMOD is quite a different beast -- a lot of things
change, on both Squid and ICAP sides.


> What could make squid not to terminate the connection? Could it be that
> it still holds connection with the HTTP server?

The actual question here is not about the connections but about the
messages inside those connections. It sounds like Squid does not send
the entire redirect response body to curl in some cases. _That_ could be
caused by the ICAP service not sending the entire redirect response body
to Squid.

You can probably confirm or deny the last bit by looking at ICAP traffic
in wireshark. Does the ICAP response contain the last-chunk (which is
usually the "0 CR LF CR LF" sequence in the chunked-encoded message body)?

* If the last-chunk is missing, then Squid is waiting for the ICAP
service. I do not know what the ICAP RESPMOD service is waiting for, but
it could be the last-chunk of the virgin HTTP response that Squid is
supposed to send to the RESPMOD service. Wireshark should show that
exchange as well.

* Otherwise, it could be a Squid bug -- post a link to a compressed
ALL,9 cache.log of the problematic transaction as discussed at
https://wiki.squid-cache.org/SquidFaq/BugReporting#Debugging_a_single_transaction


HTH,

Alex.


From moberger at metanetworks.com  Wed Dec 30 15:40:10 2020
From: moberger at metanetworks.com (Moti Berger)
Date: Wed, 30 Dec 2020 17:40:10 +0200
Subject: [squid-users] Connection occasionally not ending after adapting
 response with ICAP
In-Reply-To: <29fd337c-1bf5-ef98-16c6-02b8aaf02d4b@measurement-factory.com>
References: <CAGSk-43G+r-2LPkNNjPR-O8+SZLi_583XRiJnCOOq6Emnb_w3w@mail.gmail.com>
 <29fd337c-1bf5-ef98-16c6-02b8aaf02d4b@measurement-factory.com>
Message-ID: <CAGSk-41WJuNdy5AO4Y7hRyvJwXNhmrMXXuNYf7rgz78dyJKKFQ@mail.gmail.com>

On Wed, Dec 30, 2020 at 4:54 PM Alex Rousskov <
rousskov at measurement-factory.com> wrote:

> On 12/30/20 9:09 AM, Moti Berger wrote:
> > I have a setup with squid 5.0.4 with ICAP server handling responses.
>
> FTR: This part seems to be about an ICAP RESPMOD service generating a
> 307 redirect (AFAICT).
>
>
> > When it hangs, I see this as the output of cURL
>
> >     > GET / HTTP/1.1
> >     > Host: www.one.co.il <http://www.one.co.il>
> >     > User-Agent: curl/7.58.0
> >     > Accept: */*
>
> >     < HTTP/1.1 307 Temporary Redirect
> >     < Location: <REDIRECTION-URL>
> >     < Cache-Control: no-cache, no-store, must-revalidate
> >     < Pragma: no-cache
> >     < Date: Wed, 30 Dec 2020 13:58:51 GMT
> >     < X-Cache: MISS from a0e59ea22cf8
> >     < X-Cache-Lookup: MISS from a0e59ea22cf8:3128
> >     < Transfer-Encoding: chunked
> >     < Via: 1.1 a0e59ea22cf8 (squid/5.0.4)
> >     < Connection: keep-alive
>
> Did curl receive the last-chunk from Squid? If not, did Squid received
> the last-chunk from the ICAP service? See below for more details.
>
>
> > For some of the URLs where it hangs, I saw that running the same cURL
> > command with the --compressed switch, makes cURL exit as expected:
>
> Squid ignores Accept-Encoding so the --compressed switch is not relevant
> to Squid. Perhaps the ICAP service or the origin server react to it, but
> the headers you have provided do not show any important differences:
>
> >     > GET / HTTP/1.1
> >     > Host: www.one.co.il <http://www.one.co.il>
> >     > User-Agent: curl/7.58.0
> >     > Accept: */*
> >     > Accept-Encoding: deflate, gzip
>
> >     < HTTP/1.1 307 Temporary Redirect
> >     < Location: <REDIRECTION URL>
> >     < Cache-Control: no-cache, no-store, must-revalidate
> >     < Pragma: no-cache
> >     < Date: Wed, 30 Dec 2020 14:00:31 GMT
> >     < X-Cache: MISS from a0e59ea22cf8
> >     < X-Cache-Lookup: MISS from a0e59ea22cf8:3128
> >     < Transfer-Encoding: chunked
> >     < Via: 1.1 a0e59ea22cf8 (squid/5.0.4)
> >     < Connection: keep-alive
>
> > When I skip the adaptation in REQMOD, I get the page and the connection
> > is terminated.
>
> ... but REQMOD does not redirect when you do _not_ skip it, right? That
> is, it is RESPMOD that always redirects (until a separate test below)?
> If that is what happens, then it is possible that something goes wrong
> inside the ICAP service, and turning off REQMOD that does not redirect
> fixes the redirect in RESPMOD. However, it is a bit difficult for me to
> follow the REQMOD/RESPMOD roles in your email so I may be
> misunderstanding something.


>>> My ICAP server handles both REQMOD and RESPMOD. I can switch on and off
the adaptation in both modes. The adaptation, when take place, is to do
redirects.
So, for example, when I turn on the adaptation in REQMOD, meaning,
redirecting,
the connection terminates like expected.
When the adaptation in REQMOD is turned off (meaning, the ICAP server still
receives
requests to modify, but it doesn't change them), and RESPMOD is turned on
and
adaptation occurs (meaning, redirecting) for some URLs, it get stuck and
for some it doesn't.
Regarding no adaptation in REQMOD that might affect the RESPMOD, I removed
from
squid.conf the related configs and the issue persists.

>
>

> > When the ICAP works in REQMOD and redirects on the same URLs, everything
> > seems to work properly.
>
> OK. Redirection in REQMOD is quite a different beast -- a lot of things
> change, on both Squid and ICAP sides.
>
>
> > What could make squid not to terminate the connection? Could it be that
> > it still holds connection with the HTTP server?
>
> The actual question here is not about the connections but about the
> messages inside those connections. It sounds like Squid does not send
> the entire redirect response body to curl in some cases. _That_ could be
> caused by the ICAP service not sending the entire redirect response body
> to Squid.
>
> You can probably confirm or deny the last bit by looking at ICAP traffic
> in wireshark. Does the ICAP response contain the last-chunk (which is
> usually the "0 CR LF CR LF" sequence in the chunked-encoded message body)?
>
> >>> I don't see the "0 CR LF CR LF" at all, not only for those URLs that
cause the curl to hang.

> * If the last-chunk is missing, then Squid is waiting for the ICAP
> service. I do not know what the ICAP RESPMOD service is waiting for, but
> it could be the last-chunk of the virgin HTTP response that Squid is
> supposed to send to the RESPMOD service. Wireshark should show that
> exchange as well.
>

>>> I'm attaching a tcpdump file.

>
> * Otherwise, it could be a Squid bug -- post a link to a compressed
> ALL,9 cache.log of the problematic transaction as discussed at
>
> https://wiki.squid-cache.org/SquidFaq/BugReporting#Debugging_a_single_transaction
>
>
> HTH,
>
> Alex.
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20201230/2e754567/attachment.htm>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: squid_icap_tcpdump
Type: application/octet-stream
Size: 3556 bytes
Desc: not available
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20201230/2e754567/attachment.obj>

From rousskov at measurement-factory.com  Wed Dec 30 16:48:37 2020
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Wed, 30 Dec 2020 11:48:37 -0500
Subject: [squid-users] Connection occasionally not ending after adapting
 response with ICAP
In-Reply-To: <CAGSk-41WJuNdy5AO4Y7hRyvJwXNhmrMXXuNYf7rgz78dyJKKFQ@mail.gmail.com>
References: <CAGSk-43G+r-2LPkNNjPR-O8+SZLi_583XRiJnCOOq6Emnb_w3w@mail.gmail.com>
 <29fd337c-1bf5-ef98-16c6-02b8aaf02d4b@measurement-factory.com>
 <CAGSk-41WJuNdy5AO4Y7hRyvJwXNhmrMXXuNYf7rgz78dyJKKFQ@mail.gmail.com>
Message-ID: <0170ef34-f03b-ad80-ca95-3a0e5e5e0189@measurement-factory.com>

On 12/30/20 10:40 AM, Moti Berger wrote:

>>>> I don't see the "0 CR LF CR LF" at all, not only for those URLs that
> cause the curl to hang.

I suspect that none of those ICAP responses have HTTP bodies. An ICAP
response without an HTTP body, in itself, is not a bug, but it probably
explains the problem you are having. See below for more details.


> I'm attaching a tcpdump file.

FWIW, my wireshark cannot read your packet capture file: "The capture
file appears to be damaged or corrupt. File has 1852785440-byte packet,
bigger than maximum of 262144". In the future, you should compress such
files before sharing them via email.

However, looking at the ASCII parts of that capture file, I probably see
the likely culprit. The ICAP response below can be considered invalid
or, at least, rather difficult to handle correctly:

> ICAP/1.0 200 OK
> ISTag: "tmrCy72n1Qgsn1mxBipIb4jdEYdce3"
> Date: Wed, 30 Dec 2020 15:07:52 GMT
> Server: BaseICAP/1.0 Python/3.6.12
> Encapsulated: res-hdr=0, null-body=140
> 
> HTTP/1.1 307 Temporary Redirect
> location: http://www.redirect.url
> Cache-Control: no-cache, no-store, must-revalidate
> Pragma: no-cache


The HTTP 307 response header sent by the ICAP server promises an HTTP
response body (per HTTP rules), but the ICAP response has no HTTP body
(per the "null-body" value in the Encapsulated header).

I do not remember what Squid does in this problematic case, but I
suspect the outcome is a stuck HTTP transaction.

You should fix the ICAP service to either stop promising an HTTP
response body or provide one. The easiest (but ugly) fix may be to add
Content-Length:0 to the HTTP header returned by the ICAP service. A
better fix would be to include a real body that explains why the request
was redirected or provides some reference to the corresponding decision,
for triage.


HTH,

Alex.


From ngtech1ltd at gmail.com  Wed Dec 30 19:43:50 2020
From: ngtech1ltd at gmail.com (NgTech LTD)
Date: Wed, 30 Dec 2020 21:43:50 +0200
Subject: [squid-users] Youtube and other search engines strict enfrocment in
 Squid?
Message-ID: <CABA8h=SiXnXMy04rYGy=uLk=Dj2qm5pFReAWmcjJej0NVKQ4-w@mail.gmail.com>

I have seen this article at:
https://support.opendns.com/hc/en-us/articles/227986807-How-to-Enforcing-Google-SafeSearch-YouTube-and-Bing

Which offers a solution in the DNS resolution level from one domain to
another using CNAME records.
The basic example would be:
www.youtube.com
TO
restrict.youtube.com

The restrict.youtube.com host/service requires the destinations to be
legal ie not the CNAME itself.
This is a basc DNS based solution and I was wondering about a solution for this.
For now the real solution I have found was to install a local BIND
which forwards the queries to an upstream caching service.
On/In the local BIND we can define using RPZ these CNAMES like the example at:
https://www.cwssoft.com/?p=1577

I have not found another solution else then using hosts file on the
Squid host and updating it accordingly.
I have found a tiny update script at:
https://discourse.pi-hole.net/t/use-dns-to-force-youtube-into-restricted-mode-and-pi-hole/1996/7

Which seems to do the job and I am pretty sure it can work good enough for many.

Are there any other known ways to do this?

Thanks,
Eliezer

----
Eliezer Croitoru
Tech Support
Mobile: +972-5-28704261
Email: ngtech1ltd at gmail.com


From jfhasson at club-internet.fr  Thu Dec 31 09:10:11 2020
From: jfhasson at club-internet.fr (jean francois hasson)
Date: Thu, 31 Dec 2020 10:10:11 +0100
Subject: [squid-users] Setting up a transparent http and https proxy server
 using squid 4.6
Message-ID: <c4c855ec-64af-548e-1b07-ed376ba17737@club-internet.fr>

Hi,

I am trying to create for my home network a transparent proxy to 
implement filtering rules based on website names mainly.

I have been looking at using a Raspberry pi 3B+ running pi OS. I 
configured it to be a Wifi access point using RaspAP quick install. The 
Wifi network on which the filtering option is to be implemented is with 
IP 10.3.141.xxx. The router is at address 10.3.141.1.

I have the following squid.conf file which I tried to create based on 
different mails, websites and blogs I read :

    acl SSL_ports port 443 #https
    acl SSL_ports port 563 # snews
    acl SSL_ports port 873 # rsync
    acl Safe_ports port 80 # http
    acl Safe_ports port 21 # ftp
    acl Safe_ports port 443 # https
    acl Safe_ports port 70 # gopher
    acl Safe_ports port 210 # wais
    acl Safe_ports port 1025-65535 # unregistered ports
    acl Safe_ports port 280 # http-mgmt
    acl Safe_ports port 488 # gss-http
    acl Safe_ports port 591 # filemaker
    acl Safe_ports port 777 # multiling http

    #Le r?seau local
    acl LocalNet src 10.3.141.0/24

    acl bump_step1 at_step SslBump1
    acl bump_step2 at_step SslBump2
    acl bump_step3 at_step SslBump3

    #D?finition des autorisations
    http_access deny !Safe_ports
    #http_access deny CONNECT !SSL_ports
    http_access allow localhost manager
    http_access deny manager
    http_access allow localhost
    http_access allow LocalNet
    http_access deny all

    #D?finition des ports d'?coute
    http_port 8080
    http_port 3128 intercept
    https_port 3129 intercept ssl-bump \
     ? tls-cert=/etc/squid/cert/example.crt \
     ? tls-key=/etc/squid/cert/example.key \
     ? generate-host-certificates=on? dynamic_cert_mem_cache_size=4MB

    sslcrtd_program /usr/lib/squid/security_file_certgen -s
    /var/lib/ssl_db -M 4MB
    sslcrtd_children 5

    ssl_bump peek all
    acl tls_whitelist ssl::server_name .example.com
    ssl_bump splice tls_whitelist
    ssl_bump terminate all

    coredump_dir /var/spool/squid

    refresh_pattern ^ftp: 1440 20% 10080
    refresh_pattern ^gopher: 1440 0% 1440
    refresh_pattern -i (/cgi-bin/|\?) 0 0% 0
    refresh_pattern . 0 20% 4320

    cache_dir ufs /cache 400 16 256
    cache_access_log /var/log/squid/access.log
    cache_effective_user proxy

If I set up on a device connected to the access point a proxy manually 
ie 10.3.141.1 on port 8080, I can access the internet. If I put the 
following rules for iptables to use in files rules.v4 :

*nat
-A PREROUTING -i eth0 -p tcp -m tcp --dport 80 -j DNAT --to-destination 
10.3.141.1:3128
-A PREROUTING -i eth0 -p tcp -m tcp --dport 80 -j REDIRECT --to-ports 3128
-A PREROUTING -i eth0 -p tcp -m tcp --dport 443 -j DNAT --to-destination 
10.3.141.1:3129
-A PREROUTING -i eth0 -p tcp -m tcp --dport 443 -j REDIRECT --to-ports 3129
-A POSTROUTING -s 10.3.141.0/24 -o eth0 -j MASQUERADE
COMMIT
Now, if I remove the manual proxy configuration of the device connected 
to the access point, I can't connect to the internet. If I leave the 
manual proxy configuration it does work and there is activity logged in 
/var/log/squid/access.log.

Please let me know what might be wrong in my configuration if possible.

Best regards,

JF


-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20201231/0efd75b5/attachment.htm>

From Antony.Stone at squid.open.source.it  Thu Dec 31 09:14:45 2020
From: Antony.Stone at squid.open.source.it (Antony Stone)
Date: Thu, 31 Dec 2020 10:14:45 +0100
Subject: [squid-users] Setting up a transparent http and https proxy
 server using squid 4.6
In-Reply-To: <c4c855ec-64af-548e-1b07-ed376ba17737@club-internet.fr>
References: <c4c855ec-64af-548e-1b07-ed376ba17737@club-internet.fr>
Message-ID: <202012311014.45914.Antony.Stone@squid.open.source.it>

On Thursday 31 December 2020 at 10:10:11, jean francois hasson wrote:

> If I set up on a device connected to the access point a proxy manually
> ie 10.3.141.1 on port 8080, I can access the internet. If I put the
> following rules for iptables to use in files rules.v4 :
> 
> *nat
> -A PREROUTING -i eth0 -p tcp -m tcp --dport 80 -j DNAT --to-destination
> 10.3.141.1:3128
> -A PREROUTING -i eth0 -p tcp -m tcp --dport 80 -j REDIRECT --to-ports 3128
> -A PREROUTING -i eth0 -p tcp -m tcp --dport 443 -j DNAT --to-destination
> 10.3.141.1:3129
> -A PREROUTING -i eth0 -p tcp -m tcp --dport 443 -j REDIRECT --to-ports 3129
> -A POSTROUTING -s 10.3.141.0/24 -o eth0 -j MASQUERADE

Try removing the DNAT rules above.  You should be using REDIRECT for intercept 
mode to work correctly.


Antony.

-- 
If you can smile when all about you things are going wrong, you must have 
someone in mind to take the blame.

                                                   Please reply to the list;
                                                         please *don't* CC me.


From moberger at metanetworks.com  Thu Dec 31 12:14:55 2020
From: moberger at metanetworks.com (Moti Berger)
Date: Thu, 31 Dec 2020 14:14:55 +0200
Subject: [squid-users] Connection occasionally not ending after adapting
 response with ICAP
In-Reply-To: <0170ef34-f03b-ad80-ca95-3a0e5e5e0189@measurement-factory.com>
References: <CAGSk-43G+r-2LPkNNjPR-O8+SZLi_583XRiJnCOOq6Emnb_w3w@mail.gmail.com>
 <29fd337c-1bf5-ef98-16c6-02b8aaf02d4b@measurement-factory.com>
 <CAGSk-41WJuNdy5AO4Y7hRyvJwXNhmrMXXuNYf7rgz78dyJKKFQ@mail.gmail.com>
 <0170ef34-f03b-ad80-ca95-3a0e5e5e0189@measurement-factory.com>
Message-ID: <CAGSk-41wcGF=9t2usfKKOHSwZ7-dPuUvV4F0FkSc+vSO=0Ec+Q@mail.gmail.com>

I'm sorry for the bad format and for the uncompressed file.
Indeed adding a Content-Length:0 solved the issue.
This is BTW the preferred way for me since the URL I'm redirecting to
explains
why the redirection occurred.

Thanks a lot for your help.

On Wed, Dec 30, 2020 at 6:48 PM Alex Rousskov <
rousskov at measurement-factory.com> wrote:

> On 12/30/20 10:40 AM, Moti Berger wrote:
>
> >>>> I don't see the "0 CR LF CR LF" at all, not only for those URLs that
> > cause the curl to hang.
>
> I suspect that none of those ICAP responses have HTTP bodies. An ICAP
> response without an HTTP body, in itself, is not a bug, but it probably
> explains the problem you are having. See below for more details.
>
>
> > I'm attaching a tcpdump file.
>
> FWIW, my wireshark cannot read your packet capture file: "The capture
> file appears to be damaged or corrupt. File has 1852785440-byte packet,
> bigger than maximum of 262144". In the future, you should compress such
> files before sharing them via email.
>
> However, looking at the ASCII parts of that capture file, I probably see
> the likely culprit. The ICAP response below can be considered invalid
> or, at least, rather difficult to handle correctly:
>
> > ICAP/1.0 200 OK
> > ISTag: "tmrCy72n1Qgsn1mxBipIb4jdEYdce3"
> > Date: Wed, 30 Dec 2020 15:07:52 GMT
> > Server: BaseICAP/1.0 Python/3.6.12
> > Encapsulated: res-hdr=0, null-body=140
> >
> > HTTP/1.1 307 Temporary Redirect
> > location: http://www.redirect.url
> > Cache-Control: no-cache, no-store, must-revalidate
> > Pragma: no-cache
>
>
> The HTTP 307 response header sent by the ICAP server promises an HTTP
> response body (per HTTP rules), but the ICAP response has no HTTP body
> (per the "null-body" value in the Encapsulated header).
>
> I do not remember what Squid does in this problematic case, but I
> suspect the outcome is a stuck HTTP transaction.
>
> You should fix the ICAP service to either stop promising an HTTP
> response body or provide one. The easiest (but ugly) fix may be to add
> Content-Length:0 to the HTTP header returned by the ICAP service. A
> better fix would be to include a real body that explains why the request
> was redirected or provides some reference to the corresponding decision,
> for triage.
>
>
> HTH,
>
> Alex.
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20201231/615f0f19/attachment.htm>

From rousskov at measurement-factory.com  Thu Dec 31 15:57:40 2020
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Thu, 31 Dec 2020 10:57:40 -0500
Subject: [squid-users] Connection occasionally not ending after adapting
 response with ICAP
In-Reply-To: <CAGSk-41wcGF=9t2usfKKOHSwZ7-dPuUvV4F0FkSc+vSO=0Ec+Q@mail.gmail.com>
References: <CAGSk-43G+r-2LPkNNjPR-O8+SZLi_583XRiJnCOOq6Emnb_w3w@mail.gmail.com>
 <29fd337c-1bf5-ef98-16c6-02b8aaf02d4b@measurement-factory.com>
 <CAGSk-41WJuNdy5AO4Y7hRyvJwXNhmrMXXuNYf7rgz78dyJKKFQ@mail.gmail.com>
 <0170ef34-f03b-ad80-ca95-3a0e5e5e0189@measurement-factory.com>
 <CAGSk-41wcGF=9t2usfKKOHSwZ7-dPuUvV4F0FkSc+vSO=0Ec+Q@mail.gmail.com>
Message-ID: <b16d02f6-140b-7fbd-7f41-39478d732aea@measurement-factory.com>

On 12/31/20 7:14 AM, Moti Berger wrote:
> Indeed adding a Content-Length:0 solved the issue.
> This is BTW the preferred?way for me since the URL I'm redirecting to
> explains why the redirection occurred. 

FYI: You probably assume that the user agent will automatically follow
the redirect URL. That is usually the case, but there are exceptions. It
is best to provide some basic information (like a contact link and
transaction ID) in the response body. It also helps in triage.

Glad you found a solution.

Alex.


> On Wed, Dec 30, 2020 at 6:48 PM Alex Rousskov wrote:
> 
>     On 12/30/20 10:40 AM, Moti Berger wrote:
> 
>     >>>> I don't see the "0 CR LF CR LF" at all, not only for those URLs
>     that
>     > cause the curl to hang.
> 
>     I suspect that none of those ICAP responses have HTTP bodies. An ICAP
>     response without an HTTP body, in itself, is not a bug, but it probably
>     explains the problem you are having. See below for more details.
> 
> 
>     > I'm attaching a tcpdump file.
> 
>     FWIW, my wireshark cannot read your packet capture file: "The capture
>     file appears to be damaged or corrupt. File has 1852785440-byte packet,
>     bigger than maximum of 262144". In the future, you should compress such
>     files before sharing them via email.
> 
>     However, looking at the ASCII parts of that capture file, I probably see
>     the likely culprit. The ICAP response below can be considered invalid
>     or, at least, rather difficult to handle correctly:
> 
>     > ICAP/1.0 200 OK
>     > ISTag: "tmrCy72n1Qgsn1mxBipIb4jdEYdce3"
>     > Date: Wed, 30 Dec 2020 15:07:52 GMT
>     > Server: BaseICAP/1.0 Python/3.6.12
>     > Encapsulated: res-hdr=0, null-body=140
>     >
>     > HTTP/1.1 307 Temporary Redirect
>     > location: http://www.redirect.url
>     > Cache-Control: no-cache, no-store, must-revalidate
>     > Pragma: no-cache
> 
> 
>     The HTTP 307 response header sent by the ICAP server promises an HTTP
>     response body (per HTTP rules), but the ICAP response has no HTTP body
>     (per the "null-body" value in the Encapsulated header).
> 
>     I do not remember what Squid does in this problematic case, but I
>     suspect the outcome is a stuck HTTP transaction.
> 
>     You should fix the ICAP service to either stop promising an HTTP
>     response body or provide one. The easiest (but ugly) fix may be to add
>     Content-Length:0 to the HTTP header returned by the ICAP service. A
>     better fix would be to include a real body that explains why the request
>     was redirected or provides some reference to the corresponding decision,
>     for triage.
> 
> 
>     HTH,
> 
>     Alex.
> 



From roeeklinger60 at gmail.com  Thu Dec 31 18:39:08 2020
From: roeeklinger60 at gmail.com (roee klinger)
Date: Thu, 31 Dec 2020 20:39:08 +0200
Subject: [squid-users] How do I rotate access.log?
In-Reply-To: <32d4ef6f-583a-40b1-80a0-148f945d0788@measurement-factory.com>
References: <CAGCa14roPU4h0n=Z_f8VXFWKAU2s7wL53LUnS_qMmFJ9pOOVkg@mail.gmail.com>
 <19017c1c-ab07-1693-d5a0-3af88afc13f7@measurement-factory.com>
 <CAGCa14rfbj0CgavkbstQNYE0zp519x1J65aaFGCPsD=LjdR98A@mail.gmail.com>
 <32d4ef6f-583a-40b1-80a0-148f945d0788@measurement-factory.com>
Message-ID: <CAGCa14o_pNEPRUkY2-GwzfW0KGpszCeuNyrOw84JhNQLzTyi8g@mail.gmail.com>

Hey Alex, thanks for the reply.

This is my Squid --version:

Squid Cache: Version 4.6
Service Name: squid
Debian linux
configure options:  '--build=i686-linux-gnu' '--prefix=/usr'
'--includedir=${prefix}/include' '--mandir=${prefix}/share/man'
'--infodir=${prefix}/share/info' '--sysconfdir=/etc' '--localstatedir=/var'
'--libexecdir=${prefix}/lib/squid' '--srcdir=.' '--disable-maintainer-mode'
'--disable-dependency-tracking' '--disable-silent-rules' 'BUILDCXXFLAGS=-g
-O2 -fdebug-prefix-map=/build/squid-wx8Sif/squid-4.6=.
-fstack-protector-strong -Wformat -Werror=format-security -Wdate-time
-D_FORTIFY_SOURCE=2 -Wl,-z,relro -Wl,-z,now -Wl,--as-needed -latomic'
'BUILDCXX=i686-linux-gnu-g++' '--with-build-environment=default'
'--enable-build-info=Debian linux' '--datadir=/usr/share/squid'
'--sysconfdir=/etc/squid' '--libexecdir=/usr/lib/squid'
'--mandir=/usr/share/man' '--enable-inline' '--disable-arch-native'
'--enable-async-io=8' '--enable-storeio=ufs,aufs,diskd,rock'
'--enable-removal-policies=lru,heap' '--enable-delay-pools'
'--enable-cache-digests' '--enable-icap-client'
'--enable-follow-x-forwarded-for'
'--enable-auth-basic=DB,fake,getpwnam,LDAP,NCSA,NIS,PAM,POP3,RADIUS,SASL,SMB'
'--enable-auth-digest=file,LDAP' '--enable-auth-negotiate=kerberos,wrapper'
'--enable-auth-ntlm=fake,SMB_LM'
'--enable-external-acl-helpers=file_userip,kerberos_ldap_group,LDAP_group,session,SQL_session,time_quota,unix_group,wbinfo_group'
'--enable-security-cert-validators=fake'
'--enable-storeid-rewrite-helpers=file' '--enable-url-rewrite-helpers=fake'
'--enable-eui' '--enable-esi' '--enable-icmp' '--enable-zph-qos'
'--enable-ecap' '--disable-translation' '--with-swapdir=/var/spool/squid'
'--with-logdir=/var/log/squid' '--with-pidfile=/var/run/squid.pid'
'--with-filedescriptors=65536' '--with-large-files'
'--with-default-user=proxy' '--with-gnutls' '--enable-linux-netfilter'
'build_alias=i686-linux-gnu' 'CC=i686-linux-gnu-gcc' 'CFLAGS=-g -O2
-fdebug-prefix-map=/build/squid-wx8Sif/squid-4.6=. -fstack-protector-strong
-Wformat -Werror=format-security -Wall' 'LDFLAGS=-Wl,-z,relro -Wl,-z,now
-Wl,--as-needed -latomic' 'CPPFLAGS=-Wdate-time -D_FORTIFY_SOURCE=2'
'CXX=i686-linux-gnu-g++' 'CXXFLAGS=-g -O2
-fdebug-prefix-map=/build/squid-wx8Sif/squid-4.6=. -fstack-protector-strong
-Wformat -Werror=format-security


If I follow your instructions, this is what I get:

2020/12/31 20:33:49 kid1| Logfile: opening log
daemon:/var/log/squid/access.log
2020/12/31 20:33:49 kid1| Logfile Daemon: opening log
/var/log/squid/access.log
2020/12/31 20:33:49 kid1| Store logging disabled
2020/12/31 20:33:57 kid1| logfileRotate: daemon:/var/log/squid/access.log
2020/12/31 20:33:57 kid1| logfileRotate: daemon:/var/log/squid/access.log
2020/12/31 20:33:57 kid1| Logfile: opening log
daemon:/var/log/squid/access.log
2020/12/31 20:33:57 kid1| Logfile Daemon: opening log
/var/log/squid/access.log
2020/12/31 20:33:57 kid1| Store logging disabled


For "rotate" I am getting nothing, but I do however see transactions
getting logged to access.log and my logging daemon is running properly.

> How do you know that your access.log was _not_ rotated?


Well, for cache.log I can that the file size is getting smaller and there
are several cache.log.N files getting created, for access.log nothing is
happening.

Any tips?


On Tue, Dec 29, 2020 at 8:37 PM Alex Rousskov <
rousskov at measurement-factory.com> wrote:

> On 12/29/20 12:33 PM, roee klinger wrote:
>
> > I am using a Raspberry Pi and the latest version of Squid which I
> > installed from apt.
> >
> > In my cache.log, here are all my logging and rotation-related messages:
> >
> > 2020/12/29 17:37:14 kid1| logfileRotate: daemon:/var/log/squid/access.log
> > 2020/12/29 17:37:14 kid1| logfileRotate: daemon:/var/log/squid/access.log
> > 2020/12/29 17:37:14 kid1| Logfile: opening log
> daemon:/var/log/squid/access.log
> > 2020/12/29 17:37:14 kid1| Logfile Daemon: opening log
> /var/log/squid/access.log
> > 2020/12/29 17:37:14 kid1| Store logging disabled
>
> What is your Squid version? "squid --version" may answer that question.
>
> The "opening log" lines in your cache.log look strange. I do not see
> them in my tests, but my version of Squid is probably different from
> yours. If you shut down Squid completely, then remove all cache.log
> files, then start Squid, and then rotate once, what logging and rotation
> messages do you see in all the resulting cache.log files (including the
> rotated ones)? Do not shut down or restart Squid until you collect all
> those lines. Include all lines that mention "log" or "rotate".
>
> Do you see transactions getting logged to access.log?
>
> Is the logging daemon running? "ps aux | grep 'logfile[-]daemon'" or a
> similar command may answer that question.
>
> How do you know that your access.log was _not_ rotated?
>
> Alex.
>
>
>
> > On Tue, Dec 29, 2020 at 6:40 PM Alex Rousskov wrote:
> >
> >     On 12/29/20 10:36 AM, roee klinger wrote:
> >
> >     >     logfile_rotate 10
> >     >     access_log daemon:/var/log/squid/access.log logformat=xxxx
> >     rotate=10
> >
> >     > running "squid -k rotate" still does nothing for the access.log
> file.
> >
> >     Please note that, according to Squid documentation, your Squid is
> >     slightly misconfigured:
> >
> >     >       rotate=N                Specifies the number of log file
> >     rotations to
> >     >                               make when you run 'squid -k rotate'.
> >     [...]
> >     >                               Only supported by the stdio module.
> >
> >     You are not using an "stdio" module. You are using a "daemon" module.
> >
> >     This minor misconfiguraiton, if any, does not explain the lack of
> >     rotations. The deamon module should still rotate based on your global
> >     logfile_rotate directive setting.
> >
> >     What is your Squid version? What logging and rotation-related
> messages
> >     do you see in your cache.log (check both the pre-rotation and
> >     post-rotation files)?
> >
> >     Alex.
> >
>
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20201231/48618185/attachment.htm>

From rousskov at measurement-factory.com  Thu Dec 31 23:38:46 2020
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Thu, 31 Dec 2020 18:38:46 -0500
Subject: [squid-users] How do I rotate access.log?
In-Reply-To: <CAGCa14o_pNEPRUkY2-GwzfW0KGpszCeuNyrOw84JhNQLzTyi8g@mail.gmail.com>
References: <CAGCa14roPU4h0n=Z_f8VXFWKAU2s7wL53LUnS_qMmFJ9pOOVkg@mail.gmail.com>
 <19017c1c-ab07-1693-d5a0-3af88afc13f7@measurement-factory.com>
 <CAGCa14rfbj0CgavkbstQNYE0zp519x1J65aaFGCPsD=LjdR98A@mail.gmail.com>
 <32d4ef6f-583a-40b1-80a0-148f945d0788@measurement-factory.com>
 <CAGCa14o_pNEPRUkY2-GwzfW0KGpszCeuNyrOw84JhNQLzTyi8g@mail.gmail.com>
Message-ID: <12630169-3781-0f11-487b-b0c7f9cd4f7a@measurement-factory.com>

On 12/31/20 1:39 PM, roee klinger wrote:

>     2020/12/31 20:33:49 kid1| Logfile: opening log daemon:/var/log/squid/access.log
>     2020/12/31 20:33:49 kid1| Logfile Daemon: opening log /var/log/squid/access.log
>     2020/12/31 20:33:49 kid1| Store logging disabled
>     2020/12/31 20:33:57 kid1| logfileRotate: daemon:/var/log/squid/access.log
>     2020/12/31 20:33:57 kid1| logfileRotate: daemon:/var/log/squid/access.log
>     2020/12/31 20:33:57 kid1| Logfile: opening log daemon:/var/log/squid/access.log
>     2020/12/31 20:33:57 kid1| Logfile Daemon: opening log /var/log/squid/access.log
>     2020/12/31 20:33:57 kid1| Store logging disabled

The second set of the "opening log" lines at 20:33:57 concern me -- why
would somebody start opening those files when you are asking Squid to
rotate the logs. However, this could be a red herring. Do you get the
same kind of output when you send USR1 signal to the process identifier
in the PID file (instead of running "squid -k rotate")?


> Any tips?

I have not looked at v4.6 code, but I do not see anything in the more
recent code that would make the visible effects of access.log rotation
conditional except setting logfile_rotate to zero. I also do not see any
obviously relevant changes in v4 change.log (although there was one
access-logging bug fixed).

A few thing could go wrong. If you do not get better advice, I can
suggest the following:

* If you are a developer, I would recommend attaching a debugger to the
logging daemon process to (a) make sure it gets the rotation command
from Squid and (b) to understand why it ignores that command.

* If you are a sysadmin, you may be able to attach strace to the logging
daemon process and share its output. This is best done without user
traffic going through Squid to avoid accidentally sharing user info.
Here are rough steps:

1. Attach strace to the running daemon process (-p). Configure strace to
log at least 100 bytes of system call data (-s 100). Tell strace to
write the output into a file.

2. Rotate.

3. Wait a few seconds.

4. Stop strace. Compress and share a link to its output file.


Cheers,

Alex.


