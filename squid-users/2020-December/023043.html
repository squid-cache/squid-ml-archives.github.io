<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Proxy Server closes the connection to http server before transferring all application data to http client
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Proxy%20Server%20closes%20the%20connection%20to%20http%20server%0A%20before%20transferring%20all%20application%20data%20to%20http%20client&In-Reply-To=%3CCH2PR19MB4085700DAD3B2F255E65CBC8F0C50%40CH2PR19MB4085.namprd19.prod.outlook.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="023041.html">
   <LINK REL="Next"  HREF="023047.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Proxy Server closes the connection to http server before transferring all application data to http client</H1>
    <B>Zhang, Lily (USD)</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Proxy%20Server%20closes%20the%20connection%20to%20http%20server%0A%20before%20transferring%20all%20application%20data%20to%20http%20client&In-Reply-To=%3CCH2PR19MB4085700DAD3B2F255E65CBC8F0C50%40CH2PR19MB4085.namprd19.prod.outlook.com%3E"
       TITLE="[squid-users] Proxy Server closes the connection to http server before transferring all application data to http client">Lily.Zhang at dell.com
       </A><BR>
    <I>Wed Dec 16 09:02:24 UTC 2020</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="023041.html">[squid-users] Proxy Server closes the connection to http server before transferring all application data to http client
</A></li>
        <LI>Next message (by thread): <A HREF="023047.html">[squid-users] Proxy Server closes the connection to http server before transferring all application data to http client
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23043">[ date ]</a>
              <a href="thread.html#23043">[ thread ]</a>
              <a href="subject.html#23043">[ subject ]</a>
              <a href="author.html#23043">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Alex,

Issue still can be reproduced when http client using connection: close, and http server uses connection: keep-alive.
I can't reproduce this issue when both side using keep-alive.

Thanks
Lily

-----Original Message-----
From: Zhang, Lily (USD) 
Sent: Wednesday, December 16, 2020 3:29 PM
To: Alex Rousskov; <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
Subject: RE: [squid-users] Proxy Server closes the connection to http server before transferring all application data to http client

Hi Alex,
Thanks for your reply.

At first, http server turns off  keep-alive, then http client can't get the full response sometimes (example 20 0000 char, get 17 0000 chars).

I did a test in the lab, found 

1. If http client uses connection: close, and http server uses connection: keep-alive, then still can transfer data after tcp connection between http server and proxy server is closed.  (don't know how this happens)

2. If http client uses connection: keep-alive, and http server uses connection: keep-alive, then connection between http server and proxy server won't closed first. It is closed after client closes the connection.

Thanks
Lily
-----Original Message-----
From: Alex Rousskov &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt; 
Sent: Tuesday, December 15, 2020 11:53 PM
To: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
Cc: Zhang, Lily (USD)
Subject: Re: [squid-users] Proxy Server closes the connection to http server before transferring all application data to http client


[EXTERNAL EMAIL] 

On 12/15/20 2:52 AM, Zhang, Lily (USD) wrote:

&gt;<i> Looks we can use &quot;Connection: keep-alive&quot; in http request to solve this issue.
</I>
That client request header will not change Squid's reaction to Squid-server connection closure by the server. It also should not change the request that Squid sends to the server (if it does, it is a Squid bug). In HTTP proxying, client-Squid and Squid-server connections/negotiations are mostly independent.

If changing the client to send Connection:keep-alive to Squid fixes your problem, then the problem was most likely unrelated to the behavior you asked about earlier.

If you can configure the HTTP server to keep the connection open/persistent after delivering the response (and, hence, to send a Connection:keep-alive _response_ header or otherwise signal HTTP connection persistency), then, yes, Squid may pool that _open_ Squid-server connection for future reuse (again, regardless of what headers the HTTP client is using).

Alex.



&gt;<i> -----Original Message-----
</I>&gt;<i> From: squid-users &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>&gt; On 
</I>&gt;<i> Behalf Of Amos Jeffries
</I>&gt;<i> Sent: Tuesday, December 15, 2020 3:47 PM
</I>&gt;<i> To: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> Subject: Re: [squid-users] Proxy Server closes the connection to http 
</I>&gt;<i> server before transferring all application data to http client
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> [EXTERNAL EMAIL]
</I>&gt;<i> 
</I>&gt;<i> On 15/12/20 4:21 pm, Zhang, Lily (USD) wrote:
</I>&gt;&gt;<i> Hi
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I installed 4.13 squid proxy server. See attachment, http server
</I>&gt;&gt;<i> (10.250.16.46) sends FIN, ACK to tells that response is finished. 
</I>&gt;&gt;<i> Proxy server (10.244.102.133) sends FIN, ACK back to http server
</I>&gt;&gt;<i> (10.250.16.46) before &quot;Application Data&quot; is transferred to http 
</I>&gt;&gt;<i> client (10.245.166.20).
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Would you please help me on questions below:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>  1. Is it normal that proxy server sends FIN, ACK to http server before
</I>&gt;&gt;<i>     http client finishes receiving &#160;all the &#8220;Application Data&#8221; ?
</I>&gt;<i> 
</I>&gt;<i> That depends on the transaction which is being performed.
</I>&gt;<i> 
</I>&gt;<i> If it is a normal HTTP request-response transaction then yes. Once Squid has the response the server connection is done with - it may be closed or re-used for other transactions.
</I>&gt;<i> 
</I>&gt;<i> If it is a tunnel containing non-HTTP traffic then no. Squid should only close the server connection when the client closes its end of the tunnel.
</I>&gt;<i> 
</I>&gt;<i> Also, note that FIN+ACK in a single packet is a *response* to a FIN having come from the server itself. Not initiated by the proxy.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i>  2. Does proxy server have option to stop item 1?
</I>&gt;&gt;<i>
</I>&gt;<i> 
</I>&gt;<i> In general: No. This is something that is supposed to happen (or not) 
</I>&gt;<i> according to the relevant protocol requirements.
</I>&gt;<i> 
</I>&gt;<i> In specific, there may be some options that can be configured to 
</I>&gt;<i> change how the protocol behaves. Preventing it needing a close. You 
</I>&gt;<i> will have to find out what the cause actually is to determine where to 
</I>&gt;<i> look for solutions.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Amos
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i> 
</I>
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="023041.html">[squid-users] Proxy Server closes the connection to http server before transferring all application data to http client
</A></li>
	<LI>Next message (by thread): <A HREF="023047.html">[squid-users] Proxy Server closes the connection to http server before transferring all application data to http client
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23043">[ date ]</a>
              <a href="thread.html#23043">[ thread ]</a>
              <a href="subject.html#23043">[ subject ]</a>
              <a href="author.html#23043">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
