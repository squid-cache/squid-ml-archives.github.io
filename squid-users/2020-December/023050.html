<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Proxy Server closes the connection to http server before transferring all application data to http client
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Proxy%20Server%20closes%20the%20connection%20to%20http%20server%0A%20before%20transferring%20all%20application%20data%20to%20http%20client&In-Reply-To=%3Cebeaf6ea-c41e-7c8a-6c95-72fedf103172%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="023048.html">
   <LINK REL="Next"  HREF="023051.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Proxy Server closes the connection to http server before transferring all application data to http client</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Proxy%20Server%20closes%20the%20connection%20to%20http%20server%0A%20before%20transferring%20all%20application%20data%20to%20http%20client&In-Reply-To=%3Cebeaf6ea-c41e-7c8a-6c95-72fedf103172%40measurement-factory.com%3E"
       TITLE="[squid-users] Proxy Server closes the connection to http server before transferring all application data to http client">rousskov at measurement-factory.com
       </A><BR>
    <I>Thu Dec 17 17:33:02 UTC 2020</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="023048.html">[squid-users] Proxy Server closes the connection to http server before transferring all application data to http client
</A></li>
        <LI>Next message (by thread): <A HREF="023051.html">[squid-users] Proxy Server closes the connection to http server before transferring all application data to http client
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23050">[ date ]</a>
              <a href="thread.html#23050">[ thread ]</a>
              <a href="subject.html#23050">[ subject ]</a>
              <a href="author.html#23050">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 12/17/20 3:31 AM, Zhang, Lily (USD) wrote:

&gt;&gt;<i> If you want to work on that, respond to this message and somebody will send you more detailed instructions.
</I>
&gt;<i> Yes, please tell me how to do this.  
</I>
Please try the procedure described at
<A HREF="https://wiki.squid-cache.org/SquidFaq/BugReporting#Debugging_a_single_transaction">https://wiki.squid-cache.org/SquidFaq/BugReporting#Debugging_a_single_transaction</A>

In your case, if possible, use a single problematic master transaction
(including client-Squid and Squid-server HTTP transactions) -- the one
that results in response truncation. I recommend &quot;ALL,9&quot; debugging for
this case. Please share a link to the _compressed_ log.


&gt;<i> I am curious of 
</I>
&gt;<i> 1. When http client uses close, and server uses keep-alive, when
</I>&gt;<i> connection between proxy server and http server is closed, it still
</I>&gt;<i> can transfer data between client and proxy server,
</I>
Yes, Squid should send the rest of the response to the client after the
server sent the entire response to Squid.

Whether the server closed the connection after sending the entire
response is irrelevant (except for special cases where the end of
response is determined by the connection closure).


&gt;<i> and data transfer to http client is not completed sometimes.
</I>
That is a mystery you want to solve.


&gt;<i> 2. When http client uses close, and server uses closes, no data
</I>&gt;<i> transfer from http client and proxy server after http server closes
</I>&gt;<i> the connection.
</I>
I assume that by &quot;from http client and proxy&quot; you meant &quot;to http client
from proxy&quot;.

That is another mystery you want to solve.

Hopefully, debugging logs will help us solve both mysteries.

Alex.


&gt;<i> -----Original Message-----
</I>&gt;<i> From: Alex Rousskov &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt; 
</I>&gt;<i> Sent: Wednesday, December 16, 2020 10:50 PM
</I>&gt;<i> To: Zhang, Lily (USD); <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> Subject: Re: [squid-users] Proxy Server closes the connection to http server before transferring all application data to http client
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> [EXTERNAL EMAIL] 
</I>&gt;<i> 
</I>&gt;<i> On 12/16/20 4:02 AM, Zhang, Lily (USD) wrote:
</I>&gt;<i> 
</I>&gt;&gt;<i> Issue still can be reproduced when http client using connection: close, and http server uses connection: keep-alive.
</I>&gt;&gt;<i> I can't reproduce this issue when both side using keep-alive.
</I>&gt;<i> 
</I>&gt;<i> When everything works as it should, the HTTP Connection header has no effect on the data transfer during the transaction that header belongs to. Both &quot;close&quot; and &quot;keep-alive&quot; instructions tell the agents what to do _after_ the entire response body is delivered from the server to the client. This is just how HTTP works... Thus, what you are describing suggests a bug in client software, server software, Squid, and/or the test.
</I>&gt;<i> 
</I>&gt;<i> Going forward:
</I>&gt;<i> 
</I>&gt;<i> * If you do not need further assistance and do not want to work to discover the true cause of the problem, then just ignore this message. I am glad you found a workaround, and we can leave it at that.
</I>&gt;<i> 
</I>&gt;<i> * Otherwise, the best next step may be to share Squid debugging logs while reproducing the problem in the lab. If you want to work on that, respond to this message and somebody will send you more detailed instructions.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Cheers,
</I>&gt;<i> 
</I>&gt;<i> Alex.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> -----Original Message-----
</I>&gt;&gt;<i> From: Zhang, Lily (USD)
</I>&gt;&gt;<i> Sent: Wednesday, December 16, 2020 3:29 PM
</I>&gt;&gt;<i> To: Alex Rousskov; <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;&gt;<i> Subject: RE: [squid-users] Proxy Server closes the connection to http 
</I>&gt;&gt;<i> server before transferring all application data to http client
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Hi Alex,
</I>&gt;&gt;<i> Thanks for your reply.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> At first, http server turns off  keep-alive, then http client can't get the full response sometimes (example 20 0000 char, get 17 0000 chars).
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I did a test in the lab, found
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> 1. If http client uses connection: close, and http server uses 
</I>&gt;&gt;<i> connection: keep-alive, then still can transfer data after tcp 
</I>&gt;&gt;<i> connection between http server and proxy server is closed.  (don't 
</I>&gt;&gt;<i> know how this happens)
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> 2. If http client uses connection: keep-alive, and http server uses connection: keep-alive, then connection between http server and proxy server won't closed first. It is closed after client closes the connection.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Thanks
</I>&gt;&gt;<i> Lily
</I>&gt;&gt;<i> -----Original Message-----
</I>&gt;&gt;<i> From: Alex Rousskov &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt;
</I>&gt;&gt;<i> Sent: Tuesday, December 15, 2020 11:53 PM
</I>&gt;&gt;<i> To: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;&gt;<i> Cc: Zhang, Lily (USD)
</I>&gt;&gt;<i> Subject: Re: [squid-users] Proxy Server closes the connection to http 
</I>&gt;&gt;<i> server before transferring all application data to http client
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> [EXTERNAL EMAIL]
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> On 12/15/20 2:52 AM, Zhang, Lily (USD) wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Looks we can use &quot;Connection: keep-alive&quot; in http request to solve this issue.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> That client request header will not change Squid's reaction to Squid-server connection closure by the server. It also should not change the request that Squid sends to the server (if it does, it is a Squid bug). In HTTP proxying, client-Squid and Squid-server connections/negotiations are mostly independent.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> If changing the client to send Connection:keep-alive to Squid fixes your problem, then the problem was most likely unrelated to the behavior you asked about earlier.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> If you can configure the HTTP server to keep the connection open/persistent after delivering the response (and, hence, to send a Connection:keep-alive _response_ header or otherwise signal HTTP connection persistency), then, yes, Squid may pool that _open_ Squid-server connection for future reuse (again, regardless of what headers the HTTP client is using).
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Alex.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> -----Original Message-----
</I>&gt;&gt;&gt;<i> From: squid-users &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>&gt; On 
</I>&gt;&gt;&gt;<i> Behalf Of Amos Jeffries
</I>&gt;&gt;&gt;<i> Sent: Tuesday, December 15, 2020 3:47 PM
</I>&gt;&gt;&gt;<i> To: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;&gt;&gt;<i> Subject: Re: [squid-users] Proxy Server closes the connection to http 
</I>&gt;&gt;&gt;<i> server before transferring all application data to http client
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> [EXTERNAL EMAIL]
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> On 15/12/20 4:21 pm, Zhang, Lily (USD) wrote:
</I>&gt;&gt;&gt;&gt;<i> Hi
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> I installed 4.13 squid proxy server. See attachment, http server
</I>&gt;&gt;&gt;&gt;<i> (10.250.16.46) sends FIN, ACK to tells that response is finished. 
</I>&gt;&gt;&gt;&gt;<i> Proxy server (10.244.102.133) sends FIN, ACK back to http server
</I>&gt;&gt;&gt;&gt;<i> (10.250.16.46) before &quot;Application Data&quot; is transferred to http 
</I>&gt;&gt;&gt;&gt;<i> client (10.245.166.20).
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> Would you please help me on questions below:
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>  1. Is it normal that proxy server sends FIN, ACK to http server before
</I>&gt;&gt;&gt;&gt;<i>     http client finishes receiving &#160;all the &#8220;Application Data&#8221; ?
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> That depends on the transaction which is being performed.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> If it is a normal HTTP request-response transaction then yes. Once Squid has the response the server connection is done with - it may be closed or re-used for other transactions.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> If it is a tunnel containing non-HTTP traffic then no. Squid should only close the server connection when the client closes its end of the tunnel.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Also, note that FIN+ACK in a single packet is a *response* to a FIN having come from the server itself. Not initiated by the proxy.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>  2. Does proxy server have option to stop item 1?
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> In general: No. This is something that is supposed to happen (or not) 
</I>&gt;&gt;&gt;<i> according to the relevant protocol requirements.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> In specific, there may be some options that can be configured to 
</I>&gt;&gt;&gt;<i> change how the protocol behaves. Preventing it needing a close. You 
</I>&gt;&gt;&gt;<i> will have to find out what the cause actually is to determine where 
</I>&gt;&gt;&gt;<i> to look for solutions.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Amos
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;&gt;<i> squid-users mailing list
</I>&gt;&gt;&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;&gt;&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;&gt;<i> squid-users mailing list
</I>&gt;&gt;&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;&gt;&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;<i> 
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="023048.html">[squid-users] Proxy Server closes the connection to http server before transferring all application data to http client
</A></li>
	<LI>Next message (by thread): <A HREF="023051.html">[squid-users] Proxy Server closes the connection to http server before transferring all application data to http client
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23050">[ date ]</a>
              <a href="thread.html#23050">[ thread ]</a>
              <a href="subject.html#23050">[ subject ]</a>
              <a href="author.html#23050">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
