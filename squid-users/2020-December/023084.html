<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Connection occasionally not ending after adapting response with ICAP
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Connection%20occasionally%20not%20ending%20after%20adapting%0A%20response%20with%20ICAP&In-Reply-To=%3CCAGSk-43G%2Br-2LPkNNjPR-O8%2BSZLi_583XRiJnCOOq6Emnb_w3w%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="023083.html">
   <LINK REL="Next"  HREF="023085.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Connection occasionally not ending after adapting response with ICAP</H1>
    <B>Moti Berger</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Connection%20occasionally%20not%20ending%20after%20adapting%0A%20response%20with%20ICAP&In-Reply-To=%3CCAGSk-43G%2Br-2LPkNNjPR-O8%2BSZLi_583XRiJnCOOq6Emnb_w3w%40mail.gmail.com%3E"
       TITLE="[squid-users] Connection occasionally not ending after adapting response with ICAP">moberger at metanetworks.com
       </A><BR>
    <I>Wed Dec 30 14:09:54 UTC 2020</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="023083.html">[squid-users] Anyone has experience with Windows clients DNS timeout
</A></li>
        <LI>Next message (by thread): <A HREF="023085.html">[squid-users] Connection occasionally not ending after adapting response with ICAP
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23084">[ date ]</a>
              <a href="thread.html#23084">[ thread ]</a>
              <a href="subject.html#23084">[ subject ]</a>
              <a href="author.html#23084">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I have a setup with squid 5.0.4 with ICAP server handling responses. The
ICAP server redirects based on some parameters of the response.

To test this setup, I use cURL like this:

&gt;<i> curl -k -s --proxy localhost:8000 -o /dev/null -v &lt;URL&gt;
</I>

Now, for some URLs, cURL hangs and for others it exits after receiving the
307 response.
When it hangs, I see this as the output of cURL (I removed what seemed to
me as non-related logs from the beginning):

&gt;<i> } [5 bytes data]
</I>&gt;<i> * TLSv1.3 (OUT), TLS Unknown, Unknown (23):
</I>&gt;<i> } [1 bytes data]
</I>&gt;<i> &gt; GET / HTTP/1.1
</I>&gt;<i> &gt; Host: www.one.co.il
</I>&gt;<i> &gt; User-Agent: curl/7.58.0
</I>&gt;<i> &gt; Accept: */*
</I>&gt;<i> &gt;
</I>&gt;<i> { [5 bytes data]
</I>&gt;<i> * TLSv1.3 (IN), TLS Unknown, Certificate Status (22):
</I>&gt;<i> { [1 bytes data]
</I>&gt;<i> * TLSv1.3 (IN), TLS handshake, Newsession Ticket (4):
</I>&gt;<i> { [217 bytes data]
</I>&gt;<i> * TLSv1.3 (IN), TLS Unknown, Certificate Status (22):
</I>&gt;<i> { [1 bytes data]
</I>&gt;<i> * TLSv1.3 (IN), TLS handshake, Newsession Ticket (4):
</I>&gt;<i> { [217 bytes data]
</I>&gt;<i> * TLSv1.3 (IN), TLS Unknown, Unknown (23):
</I>&gt;<i> { [1 bytes data]
</I>&gt;<i> &lt; HTTP/1.1 307 Temporary Redirect
</I>&gt;<i> &lt; Location: &lt;REDIRECTION-URL&gt;
</I>&gt;<i> &lt; Cache-Control: no-cache, no-store, must-revalidate
</I>&gt;<i> &lt; Pragma: no-cache
</I>&gt;<i> &lt; Date: Wed, 30 Dec 2020 13:58:51 GMT
</I>&gt;<i> &lt; X-Cache: MISS from a0e59ea22cf8
</I>&gt;<i> &lt; X-Cache-Lookup: MISS from a0e59ea22cf8:3128
</I>&gt;<i> &lt; Transfer-Encoding: chunked
</I>&gt;<i> &lt; Via: 1.1 a0e59ea22cf8 (squid/5.0.4)
</I>&gt;<i> &lt; Connection: keep-alive
</I>&gt;<i> &lt;
</I>

Using tcpdump I didn't see squid send any other ICAP requests (besides
OPTIONS which the ICAP server replied to properly).
For some of the URLs where it hangs, I saw that running the same cURL
command with the --compressed switch, makes cURL exit as expected:

&gt;<i> } [5 bytes data]
</I>&gt;<i> * TLSv1.3 (OUT), TLS Unknown, Unknown (23):
</I>&gt;<i> } [1 bytes data]
</I>&gt;<i> &gt; GET / HTTP/1.1
</I>&gt;<i> &gt; Host: www.one.co.il
</I>&gt;<i> &gt; User-Agent: curl/7.58.0
</I>&gt;<i> &gt; Accept: */*
</I>&gt;<i> &gt; Accept-Encoding: deflate, gzip
</I>&gt;<i> &gt;
</I>&gt;<i> { [5 bytes data]
</I>&gt;<i> * TLSv1.3 (IN), TLS Unknown, Certificate Status (22):
</I>&gt;<i> { [1 bytes data]
</I>&gt;<i> * TLSv1.3 (IN), TLS handshake, Newsession Ticket (4):
</I>&gt;<i> { [217 bytes data]
</I>&gt;<i> * TLSv1.3 (IN), TLS Unknown, Certificate Status (22):
</I>&gt;<i> { [1 bytes data]
</I>&gt;<i> * TLSv1.3 (IN), TLS handshake, Newsession Ticket (4):
</I>&gt;<i> { [217 bytes data]
</I>&gt;<i> * TLSv1.3 (IN), TLS Unknown, Unknown (23):
</I>&gt;<i> { [1 bytes data]
</I>&gt;<i> &lt; HTTP/1.1 307 Temporary Redirect
</I>&gt;<i> &lt; Location: &lt;REDIRECTION URL&gt;
</I>&gt;<i> &lt; Cache-Control: no-cache, no-store, must-revalidate
</I>&gt;<i> &lt; Pragma: no-cache
</I>&gt;<i> &lt; Date: Wed, 30 Dec 2020 14:00:31 GMT
</I>&gt;<i> &lt; X-Cache: MISS from a0e59ea22cf8
</I>&gt;<i> &lt; X-Cache-Lookup: MISS from a0e59ea22cf8:3128
</I>&gt;<i> &lt; Transfer-Encoding: chunked
</I>&gt;<i> &lt; Via: 1.1 a0e59ea22cf8 (squid/5.0.4)
</I>&gt;<i> &lt; Connection: keep-alive
</I>&gt;<i> &lt;
</I>&gt;<i> { [5 bytes data]
</I>&gt;<i> * TLSv1.3 (IN), TLS Unknown, Unknown (23):
</I>&gt;<i> { [1 bytes data]
</I>&gt;<i> * Connection #0 to host localhost left intact
</I>

When I skip the adaptation in REQMOD, I get the page and the connection is
terminated.
When the ICAP works in REQMOD and redirects on the same URLs, everything
seems to work properly.

What could make squid not to terminate the connection? Could it be that it
still holds connection with the HTTP server?

Thanks
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20201230/f6a97439/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20201230/f6a97439/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="023083.html">[squid-users] Anyone has experience with Windows clients DNS timeout
</A></li>
	<LI>Next message (by thread): <A HREF="023085.html">[squid-users] Connection occasionally not ending after adapting response with ICAP
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23084">[ date ]</a>
              <a href="thread.html#23084">[ thread ]</a>
              <a href="subject.html#23084">[ subject ]</a>
              <a href="author.html#23084">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
