<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Connection occasionally not ending after adapting response with ICAP
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Connection%20occasionally%20not%20ending%20after%20adapting%0A%20response%20with%20ICAP&In-Reply-To=%3C29fd337c-1bf5-ef98-16c6-02b8aaf02d4b%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="023085.html">
   <LINK REL="Next"  HREF="023087.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Connection occasionally not ending after adapting response with ICAP</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Connection%20occasionally%20not%20ending%20after%20adapting%0A%20response%20with%20ICAP&In-Reply-To=%3C29fd337c-1bf5-ef98-16c6-02b8aaf02d4b%40measurement-factory.com%3E"
       TITLE="[squid-users] Connection occasionally not ending after adapting response with ICAP">rousskov at measurement-factory.com
       </A><BR>
    <I>Wed Dec 30 14:54:05 UTC 2020</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="023085.html">[squid-users] Connection occasionally not ending after adapting response with ICAP
</A></li>
        <LI>Next message (by thread): <A HREF="023087.html">[squid-users] Connection occasionally not ending after adapting response with ICAP
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23086">[ date ]</a>
              <a href="thread.html#23086">[ thread ]</a>
              <a href="subject.html#23086">[ subject ]</a>
              <a href="author.html#23086">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 12/30/20 9:09 AM, Moti Berger wrote:
&gt;<i> I have a setup with squid 5.0.4 with ICAP server handling responses. 
</I>
FTR: This part seems to be about an ICAP RESPMOD service generating a
307 redirect (AFAICT).


&gt;<i> When it hangs, I see this as the output of cURL 
</I>
&gt;<i>     &gt; GET / HTTP/1.1
</I>&gt;<i>     &gt; Host: www.one.co.il &lt;<A HREF="http://www.one.co.il">http://www.one.co.il</A>&gt;
</I>&gt;<i>     &gt; User-Agent: curl/7.58.0
</I>&gt;<i>     &gt; Accept: */*
</I>
&gt;<i>     &lt; HTTP/1.1 307 Temporary Redirect
</I>&gt;<i>     &lt; Location: &lt;REDIRECTION-URL&gt;
</I>&gt;<i>     &lt; Cache-Control: no-cache, no-store, must-revalidate
</I>&gt;<i>     &lt; Pragma: no-cache
</I>&gt;<i>     &lt; Date: Wed, 30 Dec 2020 13:58:51 GMT
</I>&gt;<i>     &lt; X-Cache: MISS from a0e59ea22cf8
</I>&gt;<i>     &lt; X-Cache-Lookup: MISS from a0e59ea22cf8:3128
</I>&gt;<i>     &lt; Transfer-Encoding: chunked
</I>&gt;<i>     &lt; Via: 1.1 a0e59ea22cf8 (squid/5.0.4)
</I>&gt;<i>     &lt; Connection: keep-alive
</I>
Did curl receive the last-chunk from Squid? If not, did Squid received
the last-chunk from the ICAP service? See below for more details.


&gt;<i> For some of the URLs where it hangs, I saw that running the same cURL
</I>&gt;<i> command with the --compressed switch, makes cURL exit as expected:
</I>
Squid ignores Accept-Encoding so the --compressed switch is not relevant
to Squid. Perhaps the ICAP service or the origin server react to it, but
the headers you have provided do not show any important differences:

&gt;<i>     &gt; GET / HTTP/1.1
</I>&gt;<i>     &gt; Host: www.one.co.il &lt;<A HREF="http://www.one.co.il">http://www.one.co.il</A>&gt;
</I>&gt;<i>     &gt; User-Agent: curl/7.58.0
</I>&gt;<i>     &gt; Accept: */*
</I>&gt;<i>     &gt; Accept-Encoding: deflate, gzip
</I>
&gt;<i>     &lt; HTTP/1.1 307 Temporary Redirect
</I>&gt;<i>     &lt; Location: &lt;REDIRECTION URL&gt;
</I>&gt;<i>     &lt; Cache-Control: no-cache, no-store, must-revalidate
</I>&gt;<i>     &lt; Pragma: no-cache
</I>&gt;<i>     &lt; Date: Wed, 30 Dec 2020 14:00:31 GMT
</I>&gt;<i>     &lt; X-Cache: MISS from a0e59ea22cf8
</I>&gt;<i>     &lt; X-Cache-Lookup: MISS from a0e59ea22cf8:3128
</I>&gt;<i>     &lt; Transfer-Encoding: chunked
</I>&gt;<i>     &lt; Via: 1.1 a0e59ea22cf8 (squid/5.0.4)
</I>&gt;<i>     &lt; Connection: keep-alive
</I>
&gt;<i> When I skip the adaptation in REQMOD, I get the page and the connection
</I>&gt;<i> is terminated.
</I>
... but REQMOD does not redirect when you do _not_ skip it, right? That
is, it is RESPMOD that always redirects (until a separate test below)?
If that is what happens, then it is possible that something goes wrong
inside the ICAP service, and turning off REQMOD that does not redirect
fixes the redirect in RESPMOD. However, it is a bit difficult for me to
follow the REQMOD/RESPMOD roles in your email so I may be
misunderstanding something.


&gt;<i> When the ICAP works in REQMOD and redirects on the same URLs, everything
</I>&gt;<i> seems to work properly.
</I>
OK. Redirection in REQMOD is quite a different beast -- a lot of things
change, on both Squid and ICAP sides.


&gt;<i> What could make squid not to terminate the connection? Could it be that
</I>&gt;<i> it still holds connection with the HTTP server?
</I>
The actual question here is not about the connections but about the
messages inside those connections. It sounds like Squid does not send
the entire redirect response body to curl in some cases. _That_ could be
caused by the ICAP service not sending the entire redirect response body
to Squid.

You can probably confirm or deny the last bit by looking at ICAP traffic
in wireshark. Does the ICAP response contain the last-chunk (which is
usually the &quot;0 CR LF CR LF&quot; sequence in the chunked-encoded message body)?

* If the last-chunk is missing, then Squid is waiting for the ICAP
service. I do not know what the ICAP RESPMOD service is waiting for, but
it could be the last-chunk of the virgin HTTP response that Squid is
supposed to send to the RESPMOD service. Wireshark should show that
exchange as well.

* Otherwise, it could be a Squid bug -- post a link to a compressed
ALL,9 cache.log of the problematic transaction as discussed at
<A HREF="https://wiki.squid-cache.org/SquidFaq/BugReporting#Debugging_a_single_transaction">https://wiki.squid-cache.org/SquidFaq/BugReporting#Debugging_a_single_transaction</A>


HTH,

Alex.

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="023085.html">[squid-users] Connection occasionally not ending after adapting response with ICAP
</A></li>
	<LI>Next message (by thread): <A HREF="023087.html">[squid-users] Connection occasionally not ending after adapting response with ICAP
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23086">[ date ]</a>
              <a href="thread.html#23086">[ thread ]</a>
              <a href="subject.html#23086">[ subject ]</a>
              <a href="author.html#23086">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
