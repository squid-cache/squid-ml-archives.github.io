<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Connection occasionally not ending after adapting response with ICAP
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Connection%20occasionally%20not%20ending%20after%20adapting%0A%20response%20with%20ICAP&In-Reply-To=%3CCAGSk-41WJuNdy5AO4Y7hRyvJwXNhmrMXXuNYf7rgz78dyJKKFQ%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="023086.html">
   <LINK REL="Next"  HREF="023088.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Connection occasionally not ending after adapting response with ICAP</H1>
    <B>Moti Berger</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Connection%20occasionally%20not%20ending%20after%20adapting%0A%20response%20with%20ICAP&In-Reply-To=%3CCAGSk-41WJuNdy5AO4Y7hRyvJwXNhmrMXXuNYf7rgz78dyJKKFQ%40mail.gmail.com%3E"
       TITLE="[squid-users] Connection occasionally not ending after adapting response with ICAP">moberger at metanetworks.com
       </A><BR>
    <I>Wed Dec 30 15:40:10 UTC 2020</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="023086.html">[squid-users] Connection occasionally not ending after adapting response with ICAP
</A></li>
        <LI>Next message (by thread): <A HREF="023088.html">[squid-users] Connection occasionally not ending after adapting response with ICAP
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23087">[ date ]</a>
              <a href="thread.html#23087">[ thread ]</a>
              <a href="subject.html#23087">[ subject ]</a>
              <a href="author.html#23087">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Wed, Dec 30, 2020 at 4:54 PM Alex Rousskov &lt;
<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt; wrote:

&gt;<i> On 12/30/20 9:09 AM, Moti Berger wrote:
</I>&gt;<i> &gt; I have a setup with squid 5.0.4 with ICAP server handling responses.
</I>&gt;<i>
</I>&gt;<i> FTR: This part seems to be about an ICAP RESPMOD service generating a
</I>&gt;<i> 307 redirect (AFAICT).
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; When it hangs, I see this as the output of cURL
</I>&gt;<i>
</I>&gt;<i> &gt;     &gt; GET / HTTP/1.1
</I>&gt;<i> &gt;     &gt; Host: www.one.co.il &lt;<A HREF="http://www.one.co.il">http://www.one.co.il</A>&gt;
</I>&gt;<i> &gt;     &gt; User-Agent: curl/7.58.0
</I>&gt;<i> &gt;     &gt; Accept: */*
</I>&gt;<i>
</I>&gt;<i> &gt;     &lt; HTTP/1.1 307 Temporary Redirect
</I>&gt;<i> &gt;     &lt; Location: &lt;REDIRECTION-URL&gt;
</I>&gt;<i> &gt;     &lt; Cache-Control: no-cache, no-store, must-revalidate
</I>&gt;<i> &gt;     &lt; Pragma: no-cache
</I>&gt;<i> &gt;     &lt; Date: Wed, 30 Dec 2020 13:58:51 GMT
</I>&gt;<i> &gt;     &lt; X-Cache: MISS from a0e59ea22cf8
</I>&gt;<i> &gt;     &lt; X-Cache-Lookup: MISS from a0e59ea22cf8:3128
</I>&gt;<i> &gt;     &lt; Transfer-Encoding: chunked
</I>&gt;<i> &gt;     &lt; Via: 1.1 a0e59ea22cf8 (squid/5.0.4)
</I>&gt;<i> &gt;     &lt; Connection: keep-alive
</I>&gt;<i>
</I>&gt;<i> Did curl receive the last-chunk from Squid? If not, did Squid received
</I>&gt;<i> the last-chunk from the ICAP service? See below for more details.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; For some of the URLs where it hangs, I saw that running the same cURL
</I>&gt;<i> &gt; command with the --compressed switch, makes cURL exit as expected:
</I>&gt;<i>
</I>&gt;<i> Squid ignores Accept-Encoding so the --compressed switch is not relevant
</I>&gt;<i> to Squid. Perhaps the ICAP service or the origin server react to it, but
</I>&gt;<i> the headers you have provided do not show any important differences:
</I>&gt;<i>
</I>&gt;<i> &gt;     &gt; GET / HTTP/1.1
</I>&gt;<i> &gt;     &gt; Host: www.one.co.il &lt;<A HREF="http://www.one.co.il">http://www.one.co.il</A>&gt;
</I>&gt;<i> &gt;     &gt; User-Agent: curl/7.58.0
</I>&gt;<i> &gt;     &gt; Accept: */*
</I>&gt;<i> &gt;     &gt; Accept-Encoding: deflate, gzip
</I>&gt;<i>
</I>&gt;<i> &gt;     &lt; HTTP/1.1 307 Temporary Redirect
</I>&gt;<i> &gt;     &lt; Location: &lt;REDIRECTION URL&gt;
</I>&gt;<i> &gt;     &lt; Cache-Control: no-cache, no-store, must-revalidate
</I>&gt;<i> &gt;     &lt; Pragma: no-cache
</I>&gt;<i> &gt;     &lt; Date: Wed, 30 Dec 2020 14:00:31 GMT
</I>&gt;<i> &gt;     &lt; X-Cache: MISS from a0e59ea22cf8
</I>&gt;<i> &gt;     &lt; X-Cache-Lookup: MISS from a0e59ea22cf8:3128
</I>&gt;<i> &gt;     &lt; Transfer-Encoding: chunked
</I>&gt;<i> &gt;     &lt; Via: 1.1 a0e59ea22cf8 (squid/5.0.4)
</I>&gt;<i> &gt;     &lt; Connection: keep-alive
</I>&gt;<i>
</I>&gt;<i> &gt; When I skip the adaptation in REQMOD, I get the page and the connection
</I>&gt;<i> &gt; is terminated.
</I>&gt;<i>
</I>&gt;<i> ... but REQMOD does not redirect when you do _not_ skip it, right? That
</I>&gt;<i> is, it is RESPMOD that always redirects (until a separate test below)?
</I>&gt;<i> If that is what happens, then it is possible that something goes wrong
</I>&gt;<i> inside the ICAP service, and turning off REQMOD that does not redirect
</I>&gt;<i> fixes the redirect in RESPMOD. However, it is a bit difficult for me to
</I>&gt;<i> follow the REQMOD/RESPMOD roles in your email so I may be
</I>&gt;<i> misunderstanding something.
</I>

&gt;&gt;&gt;<i> My ICAP server handles both REQMOD and RESPMOD. I can switch on and off
</I>the adaptation in both modes. The adaptation, when take place, is to do
redirects.
So, for example, when I turn on the adaptation in REQMOD, meaning,
redirecting,
the connection terminates like expected.
When the adaptation in REQMOD is turned off (meaning, the ICAP server still
receives
requests to modify, but it doesn't change them), and RESPMOD is turned on
and
adaptation occurs (meaning, redirecting) for some URLs, it get stuck and
for some it doesn't.
Regarding no adaptation in REQMOD that might affect the RESPMOD, I removed
from
squid.conf the related configs and the issue persists.

&gt;<i>
</I>&gt;<i>
</I>
&gt;<i> &gt; When the ICAP works in REQMOD and redirects on the same URLs, everything
</I>&gt;<i> &gt; seems to work properly.
</I>&gt;<i>
</I>&gt;<i> OK. Redirection in REQMOD is quite a different beast -- a lot of things
</I>&gt;<i> change, on both Squid and ICAP sides.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; What could make squid not to terminate the connection? Could it be that
</I>&gt;<i> &gt; it still holds connection with the HTTP server?
</I>&gt;<i>
</I>&gt;<i> The actual question here is not about the connections but about the
</I>&gt;<i> messages inside those connections. It sounds like Squid does not send
</I>&gt;<i> the entire redirect response body to curl in some cases. _That_ could be
</I>&gt;<i> caused by the ICAP service not sending the entire redirect response body
</I>&gt;<i> to Squid.
</I>&gt;<i>
</I>&gt;<i> You can probably confirm or deny the last bit by looking at ICAP traffic
</I>&gt;<i> in wireshark. Does the ICAP response contain the last-chunk (which is
</I>&gt;<i> usually the &quot;0 CR LF CR LF&quot; sequence in the chunked-encoded message body)?
</I>&gt;<i>
</I>&gt;<i> &gt;&gt;&gt; I don't see the &quot;0 CR LF CR LF&quot; at all, not only for those URLs that
</I>cause the curl to hang.

&gt;<i> * If the last-chunk is missing, then Squid is waiting for the ICAP
</I>&gt;<i> service. I do not know what the ICAP RESPMOD service is waiting for, but
</I>&gt;<i> it could be the last-chunk of the virgin HTTP response that Squid is
</I>&gt;<i> supposed to send to the RESPMOD service. Wireshark should show that
</I>&gt;<i> exchange as well.
</I>&gt;<i>
</I>
&gt;&gt;&gt;<i> I'm attaching a tcpdump file.
</I>
&gt;<i>
</I>&gt;<i> * Otherwise, it could be a Squid bug -- post a link to a compressed
</I>&gt;<i> ALL,9 cache.log of the problematic transaction as discussed at
</I>&gt;<i>
</I>&gt;<i> <A HREF="https://wiki.squid-cache.org/SquidFaq/BugReporting#Debugging_a_single_transaction">https://wiki.squid-cache.org/SquidFaq/BugReporting#Debugging_a_single_transaction</A>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> HTH,
</I>&gt;<i>
</I>&gt;<i> Alex.
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20201230/2e754567/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20201230/2e754567/attachment.htm</A>&gt;
-------------- next part --------------
A non-text attachment was scrubbed...
Name: squid_icap_tcpdump
Type: application/octet-stream
Size: 3556 bytes
Desc: not available
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20201230/2e754567/attachment.obj">http://lists.squid-cache.org/pipermail/squid-users/attachments/20201230/2e754567/attachment.obj</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="023086.html">[squid-users] Connection occasionally not ending after adapting response with ICAP
</A></li>
	<LI>Next message (by thread): <A HREF="023088.html">[squid-users] Connection occasionally not ending after adapting response with ICAP
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23087">[ date ]</a>
              <a href="thread.html#23087">[ thread ]</a>
              <a href="subject.html#23087">[ subject ]</a>
              <a href="author.html#23087">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
