<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Connection occasionally not ending after adapting response with ICAP
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Connection%20occasionally%20not%20ending%20after%20adapting%0A%20response%20with%20ICAP&In-Reply-To=%3Cb16d02f6-140b-7fbd-7f41-39478d732aea%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="023092.html">
   <LINK REL="Next"  HREF="023089.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Connection occasionally not ending after adapting response with ICAP</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Connection%20occasionally%20not%20ending%20after%20adapting%0A%20response%20with%20ICAP&In-Reply-To=%3Cb16d02f6-140b-7fbd-7f41-39478d732aea%40measurement-factory.com%3E"
       TITLE="[squid-users] Connection occasionally not ending after adapting response with ICAP">rousskov at measurement-factory.com
       </A><BR>
    <I>Thu Dec 31 15:57:40 UTC 2020</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="023092.html">[squid-users] Connection occasionally not ending after adapting response with ICAP
</A></li>
        <LI>Next message (by thread): <A HREF="023089.html">[squid-users] Youtube and other search engines strict enfrocment in Squid?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23093">[ date ]</a>
              <a href="thread.html#23093">[ thread ]</a>
              <a href="subject.html#23093">[ subject ]</a>
              <a href="author.html#23093">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 12/31/20 7:14 AM, Moti Berger wrote:
&gt;<i> Indeed adding a Content-Length:0 solved the issue.
</I>&gt;<i> This is BTW the preferred&#160;way for me since the URL I'm redirecting to
</I>&gt;<i> explains why the redirection occurred. 
</I>
FYI: You probably assume that the user agent will automatically follow
the redirect URL. That is usually the case, but there are exceptions. It
is best to provide some basic information (like a contact link and
transaction ID) in the response body. It also helps in triage.

Glad you found a solution.

Alex.


&gt;<i> On Wed, Dec 30, 2020 at 6:48 PM Alex Rousskov wrote:
</I>&gt;<i> 
</I>&gt;<i>     On 12/30/20 10:40 AM, Moti Berger wrote:
</I>&gt;<i> 
</I>&gt;<i>     &gt;&gt;&gt;&gt; I don't see the &quot;0 CR LF CR LF&quot; at all, not only for those URLs
</I>&gt;<i>     that
</I>&gt;<i>     &gt; cause the curl to hang.
</I>&gt;<i> 
</I>&gt;<i>     I suspect that none of those ICAP responses have HTTP bodies. An ICAP
</I>&gt;<i>     response without an HTTP body, in itself, is not a bug, but it probably
</I>&gt;<i>     explains the problem you are having. See below for more details.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i>     &gt; I'm attaching a tcpdump file.
</I>&gt;<i> 
</I>&gt;<i>     FWIW, my wireshark cannot read your packet capture file: &quot;The capture
</I>&gt;<i>     file appears to be damaged or corrupt. File has 1852785440-byte packet,
</I>&gt;<i>     bigger than maximum of 262144&quot;. In the future, you should compress such
</I>&gt;<i>     files before sharing them via email.
</I>&gt;<i> 
</I>&gt;<i>     However, looking at the ASCII parts of that capture file, I probably see
</I>&gt;<i>     the likely culprit. The ICAP response below can be considered invalid
</I>&gt;<i>     or, at least, rather difficult to handle correctly:
</I>&gt;<i> 
</I>&gt;<i>     &gt; ICAP/1.0 200 OK
</I>&gt;<i>     &gt; ISTag: &quot;tmrCy72n1Qgsn1mxBipIb4jdEYdce3&quot;
</I>&gt;<i>     &gt; Date: Wed, 30 Dec 2020 15:07:52 GMT
</I>&gt;<i>     &gt; Server: BaseICAP/1.0 Python/3.6.12
</I>&gt;<i>     &gt; Encapsulated: res-hdr=0, null-body=140
</I>&gt;<i>     &gt;
</I>&gt;<i>     &gt; HTTP/1.1 307 Temporary Redirect
</I>&gt;<i>     &gt; location: <A HREF="http://www.redirect.url">http://www.redirect.url</A>
</I>&gt;<i>     &gt; Cache-Control: no-cache, no-store, must-revalidate
</I>&gt;<i>     &gt; Pragma: no-cache
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i>     The HTTP 307 response header sent by the ICAP server promises an HTTP
</I>&gt;<i>     response body (per HTTP rules), but the ICAP response has no HTTP body
</I>&gt;<i>     (per the &quot;null-body&quot; value in the Encapsulated header).
</I>&gt;<i> 
</I>&gt;<i>     I do not remember what Squid does in this problematic case, but I
</I>&gt;<i>     suspect the outcome is a stuck HTTP transaction.
</I>&gt;<i> 
</I>&gt;<i>     You should fix the ICAP service to either stop promising an HTTP
</I>&gt;<i>     response body or provide one. The easiest (but ugly) fix may be to add
</I>&gt;<i>     Content-Length:0 to the HTTP header returned by the ICAP service. A
</I>&gt;<i>     better fix would be to include a real body that explains why the request
</I>&gt;<i>     was redirected or provides some reference to the corresponding decision,
</I>&gt;<i>     for triage.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i>     HTH,
</I>&gt;<i> 
</I>&gt;<i>     Alex.
</I>&gt;<i> 
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="023092.html">[squid-users] Connection occasionally not ending after adapting response with ICAP
</A></li>
	<LI>Next message (by thread): <A HREF="023089.html">[squid-users] Youtube and other search engines strict enfrocment in Squid?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23093">[ date ]</a>
              <a href="thread.html#23093">[ thread ]</a>
              <a href="subject.html#23093">[ subject ]</a>
              <a href="author.html#23093">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
