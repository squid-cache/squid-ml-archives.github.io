<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid and iptables
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20and%20iptables&In-Reply-To=%3Ce099efd0-b389-fbb2-4357-e3dba9f7c6d7%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="021729.html">
   <LINK REL="Next"  HREF="021730.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid and iptables</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20and%20iptables&In-Reply-To=%3Ce099efd0-b389-fbb2-4357-e3dba9f7c6d7%40treenet.co.nz%3E"
       TITLE="[squid-users] Squid and iptables">squid3 at treenet.co.nz
       </A><BR>
    <I>Fri Feb 14 08:21:32 UTC 2020</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="021729.html">[squid-users] Squid and iptables
</A></li>
        <LI>Next message (by thread): <A HREF="021730.html">[squid-users] Ubuntu 18 LTS repository for Squid 4.10 (rebuilt with sslbump support from sources in Debian unstable)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21744">[ date ]</a>
              <a href="thread.html#21744">[ thread ]</a>
              <a href="subject.html#21744">[ subject ]</a>
              <a href="author.html#21744">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 11/02/20 4:48 am, L.P.H. van Belle wrote:
&gt;<i> Hai, 
</I>&gt;<i>  
</I>&gt;<i> I'm having a squid 4.10 on Debian 10 running ( with strongswan VPN ) and ufw firewall (iptables) 
</I>&gt;<i> Most is running fine but i still see some error and i somehow miss here what im doing wrong. 
</I>&gt;<i> 
</I>
You may not be doing anything.

INVALID from Conntrack means the packet is either corrupted at the
binary level, or not supposed to exist, maybe both if the corruption
makes something that looks like a valid but wrong packet.


&gt;<i> So if someone has suggestions that would be great. I see for example these lines in the UFW log. 
</I>&gt;<i> 
</I>&gt;<i> Feb 10 15:42:21 rtd-proxy1 kernel: [14315.762249] [UFW AUDIT INVALID] IN=eth0 OUT= MAC=56:30:b7:fd:da:24:84:2b:2b:90:a5:f1:08:00 SRC=192.168.0.101 DST=192.168.0.1 LEN=40 TOS=0x00 PREC=0x00 TTL=128 ID=22171 DF PROTO=TCP SPT=52273 DPT=8080 WINDOW=0 RES=0x00 ACK RST URGP=0
</I>&gt;<i> Feb 10 15:42:21 rtd-proxy1 kernel: [14315.762308] [UFW BLOCK] IN=eth0 OUT= MAC=56:30:b7:fd:da:24:84:2b:2b:90:a5:f1:08:00 SRC=192.168.0.101 DST=192.168.0.1 LEN=40 TOS=0x00 PREC=0x00 TTL=128 ID=22171 DF PROTO=TCP SPT=52273 DPT=8080 WINDOW=0 RES=0x00 ACK RST URGP=0
</I>&gt;<i> 
</I>&gt;<i> Now, strange thing here is im allowing my traffic on my lan interface fully, so i dont see/get why i get these INVALID/BLOCK.
</I>&gt;<i> Im out of ideas, i looked to much at it, i done see it anymore..  :-( 
</I>&gt;<i> 
</I>&gt;<i> The needed parts of my squid and iptables (ufw) setup. 
</I>&gt;<i> ETH0 = LAN  192.168.0.1.0/24 	(ip: 192.168.0.1.1/24  )
</I>
Too many dots for an IP address. I hope that is manual obfuscation...


&gt;<i> ETH1 = WAN  1.2.4.4/32	
</I>&gt;<i>   
</I>&gt;<i> The squid part 
</I>&gt;<i> # From squid cache.log the needed lines from a start of squid with the lines from squid.conf 
</I>&gt;<i> 
</I>&gt;<i> # http_port localhost:3128 connection-auth=off
</I>&gt;<i> 2020/02/10 11:44:13 kid1| Accepting HTTP Socket connections at local=[::1]:3128 remote=[::] FD 17 flags=1 
</I>&gt;<i> # all requests for and on loclhost are trusted, so fully allowed withouth authenticationn. 
</I>

NP: &quot;connection-auth=&quot; has nothing to do with whether the connection is
trusted or not. It is about whether the HTTP auth schemes are going to
be used. Disabling it breaks NTLM and Negotiate - the &quot;connection based&quot;
auth schemes.


&gt;<i> 
</I>&gt;<i> # http_port 192.168.249.221:3128 intercept  ( no-authentication possbible on intercept ) 
</I>&gt;<i> 2020/02/10 11:44:13 kid1| Accepting NAT intercepted HTTP Socket connections at local=192.168.0.1.1:3128 remote=[::] FD 21 flags=33
</I>&gt;<i> 
</I>
 ... looks to be botched obfuscate. The config line does not match IPs
with the mentioned log line.

BTW, standardized IP ranges like 192.168.* do not really need
obfuscating. They are not (or should not be) globally accessible.


&gt;<i> # https_port 192.168.249.221:3129 intercept ssl-bump \ .. (plus the cert - key parts, not relevant this works ). 
</I>&gt;<i> 2020/02/10 11:44:13 kid1| Accepting NAT intercepted SSL bumped HTTPS Socket connections at local=192.168.0.1.1:3129 remote=[::] FD 25 flags=33
</I>&gt;<i> 
</I>&gt;<i> # Non-proxy aware  (with authentication)
</I>&gt;<i> # http_port 192.168.249.221:8080
</I>&gt;<i> 2020/02/10 11:44:13 kid1| Accepting HTTP Socket connections at local=192.168.0.1.1:8080 remote=[::] FD 29 flags=1
</I>&gt;<i> 
</I>&gt;<i> # http_port 192.168.249.221:8081 ssl-bump \ .. (plus the cert - key parts, not relevant this works ). 
</I>&gt;<i> 2020/02/10 11:44:13 kid1| Accepting SSL bumped HTTP Socket connections at local=192.168.0.1.1:8081 remote=[::] FD 37 flags=1
</I>&gt;<i> 
</I>

[ I have unwound the nested tree of sub-chains to follow what is going
on more simply. ]

&gt;<i> 
</I>&gt;<i> # Generated by xtables-save v1.8.2 on Mon Feb 10 15:16:26 2020
</I>&gt;<i> *filter
</I>&gt;<i> :INPUT DROP [213:54000]
</I>&gt;<i> :FORWARD ACCEPT [704:28436]
</I>&gt;<i> :OUTPUT ACCEPT [57:19155]
</I>
&gt;<i> -A INPUT -m conntrack --ctstate NEW -m limit --limit 3/min --limit-burst 10 -j LOG --log-prefix &quot;[UFW AUDIT] &quot;&gt; -A INPUT -i lo -j ACCEPT
</I>
This should probably be done *after* the checks and handling of INVALID
traffic.

&gt;<i> -A INPUT -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
</I>&gt;<i> -A INPUT -m conntrack --ctstate INVALID -m conntrack --ctstate INVALID -m limit --limit 3/min --limit-burst 10 -j LOG --log-prefix &quot;[UFW AUDIT INVALID] &quot;
</I>&gt;<i> -A INPUT -m conntrack --ctstate INVALID -m limit --limit 3/min --limit-burst 10 -j LOG --log-prefix &quot;[UFW BLOCK] &quot;
</I>&gt;<i> -A INPUT -m conntrack --ctstate INVALID -j DROP&gt; -A INPUT -i eth0 -p udp -m multiport --dports 80,443 -j DROP
</I>
Use REJECT here. HTTP/3 uses these ports and DROP will cause Browsers
etc to have long timeouts on initial connection setup.

&gt;<i> -A INPUT -m limit --limit 3/min --limit-burst 10 -j LOG --log-prefix &quot;[UFW BLOCK] &quot;
</I>
&gt;<i> -A FORWARD -m conntrack --ctstate NEW -m limit --limit 3/min --limit-burst 10 -j LOG --log-prefix &quot;[UFW AUDIT] &quot;
</I>&gt;<i> -A FORWARD -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
</I>&gt;<i> -A FORWARD -m limit --limit 3/min --limit-burst 10 -j LOG --log-prefix &quot;[UFW ALLOW] &quot;
</I>&gt;<i> -A FORWARD -p tcp -m conntrack --ctstate NEW -j ACCEPT
</I>&gt;<i> -A FORWARD -p udp -m conntrack --ctstate NEW -j ACCEPT
</I>
&gt;<i> -A OUTPUT -m conntrack --ctstate NEW -m limit --limit 3/min
</I>--limit-burst 10 -j LOG --log-prefix &quot;[UFW AUDIT] &quot;
&gt;<i> -A OUTPUT -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
</I>&gt;<i> -A OUTPUT -o lo -j ACCEPT
</I>&gt;<i> -A OUTPUT -m limit --limit 3/min --limit-burst 10 -j LOG --log-prefix &quot;[UFW ALLOW] &quot;
</I>&gt;<i> -A OUTPUT -p tcp -m conntrack --ctstate NEW -j ACCEPT
</I>&gt;<i> -A OUTPUT -p udp -m conntrack --ctstate NEW -j ACCEPT
</I>
&gt;<i> 
</I>&gt;<i> *nat
</I>&gt;<i> :PREROUTING ACCEPT [0:0]
</I>&gt;<i> :INPUT ACCEPT [0:0]
</I>&gt;<i> :POSTROUTING ACCEPT [0:0]
</I>&gt;<i> :OUTPUT ACCEPT [0:0]
</I>
&gt;<i> -A PREROUTING -i eth0 -p tcp -m tcp --dport 443 -m comment --comment &quot;Squid-Intercept 443-&gt;3129&quot; -j REDIRECT --to-ports 3129
</I>&gt;<i> -A PREROUTING -i eth0 -p tcp -m tcp --dport 80 -m comment --comment &quot;Squid-Intercept 80-&gt;3128&quot; -j REDIRECT --to-ports 3128
</I>
 1) Your Log lines above say that Squid is accepting *forward proxy*
traffic on port localhost:3128. The above rules will intercept that traffic.
  One of several reasons why one should avoid using a standard port for
purposes other than its officially registered use.

 2) there are no lines preventing NAT catching the traffic leaving Squid
to those ports and looping it back into Squid.


&gt;<i> -A POSTROUTING -s 192.168.0.1.0/24 -o eth1 -m comment --comment &quot;IP-Masq Lan via eth1&quot; -j MASQUERADE
</I>

&gt;<i> 
</I>&gt;<i> *mangle
</I>&gt;<i> :PREROUTING ACCEPT [0:0]
</I>&gt;<i> :INPUT ACCEPT [0:0]
</I>&gt;<i> :FORWARD ACCEPT [0:0]
</I>&gt;<i> :OUTPUT ACCEPT [0:0]
</I>&gt;<i> :POSTROUTING ACCEPT [0:0]
</I>

Missing rule(s) to prevent other machines and software sending traffic
directly to the NAT intercept ports Squid is using. You need those ports
to be locked down so only the NAT system can cause packets to arrive there.


&gt;<i> 
</I>&gt;<i> Thanks for looking at it.. 
</I>&gt;<i> I hope someone see what im doing wrong here..
</I>&gt;<i> 
</I>
There are a few other things (ICMP handling etc.), But I am restricting
my comments to the rules that are processed for HTTP(S) traffic.


Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="021729.html">[squid-users] Squid and iptables
</A></li>
	<LI>Next message (by thread): <A HREF="021730.html">[squid-users] Ubuntu 18 LTS repository for Squid 4.10 (rebuilt with sslbump support from sources in Debian unstable)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21744">[ date ]</a>
              <a href="thread.html#21744">[ thread ]</a>
              <a href="subject.html#21744">[ subject ]</a>
              <a href="author.html#21744">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
