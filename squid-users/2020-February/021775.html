<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] please, can someone help me with the negotiate kerberos?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20please%2C%0A%20can%20someone%20help%20me%20with%20the%20negotiate%20kerberos%3F&In-Reply-To=%3Cvmime.5e4a6983.4515.6f50909512442633%40ms249-lin-003.rotterdam.bazuin.nl%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="021774.html">
   <LINK REL="Next"  HREF="021776.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] please, can someone help me with the negotiate kerberos?</H1>
    <B>L.P.H. van Belle</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20please%2C%0A%20can%20someone%20help%20me%20with%20the%20negotiate%20kerberos%3F&In-Reply-To=%3Cvmime.5e4a6983.4515.6f50909512442633%40ms249-lin-003.rotterdam.bazuin.nl%3E"
       TITLE="[squid-users] please, can someone help me with the negotiate kerberos?">belle at bazuin.nl
       </A><BR>
    <I>Mon Feb 17 10:22:59 UTC 2020</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="021774.html">[squid-users] please, can someone help me with the negotiate kerberos?
</A></li>
        <LI>Next message (by thread): <A HREF="021776.html">[squid-users] please, can someone help me with the negotiate kerberos?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21775">[ date ]</a>
              <a href="thread.html#21775">[ thread ]</a>
              <a href="subject.html#21775">[ subject ]</a>
              <a href="author.html#21775">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hai Rafeal, 

Yes, i agree, this is the other most simple way, but i suggest, you remove/change on this page:

<A HREF="https://docs.diladele.com/administrator_guide_stable/active_directory/kerberos/keytab.html">https://docs.diladele.com/administrator_guide_stable/active_directory/kerberos/keytab.html</A> 
The generated Kerberos configuration file will usually look like:

[libdefaults]
default_realm = EXAMPLE.LAN
default_tgs_enctypes = rc4-hmac des3-hmac-sha1
default_tkt_enctypes = rc4-hmac des3-hmac-sha1 

These are really outdated. ;-) 


To ( just the default )

[libdefaults]
    default_realm = EXAMPLE.LAN
    dns_lookup_kdc = true
    dns_lookup_realm = false


Keytabs and samba, read: 
<A HREF="https://wiki.samba.org/index.php/Generating_Keytabs">https://wiki.samba.org/index.php/Generating_Keytabs</A>

<A HREF="https://wiki.samba.org/index.php/Keytab_Extraction">https://wiki.samba.org/index.php/Keytab_Extraction</A> 



Greetz, 

Louis




&gt;<i> -----Oorspronkelijk bericht-----
</I>&gt;<i> Van: squid-users 
</I>&gt;<i> [mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>] Namens 
</I>&gt;<i> Rafael Akchurin
</I>&gt;<i> Verzonden: maandag 17 februari 2020 11:06
</I>&gt;<i> Aan: Rafael Silva Daniel; <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> Onderwerp: Re: [squid-users] please, can someone help me with 
</I>&gt;<i> the negotiate kerberos?
</I>&gt;<i> 
</I>&gt;<i> Hello Rafael,
</I>&gt;<i> 
</I>&gt;<i> There is an easier option *without* joining the Squid machine 
</I>&gt;<i> to the domain,
</I>&gt;<i> See tutorial at 
</I>&gt;<i> <A HREF="https://docs.diladele.com/administrator_guide_stable/active_di">https://docs.diladele.com/administrator_guide_stable/active_di</A>
</I>&gt;<i> rectory/index.html (it also applies to vanilla Squid without 
</I>&gt;<i> our UI - just you would need to do more manual steps).
</I>&gt;<i> 
</I>&gt;<i> Raf
</I>&gt;<i> 
</I>&gt;<i> -----Original Message-----
</I>&gt;<i> From: squid-users &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>&gt; 
</I>&gt;<i> On Behalf Of Rafael Silva Daniel
</I>&gt;<i> Sent: Saturday, 15 February 2020 21:08
</I>&gt;<i> To: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> Subject: [squid-users] please, can someone help me with the 
</I>&gt;<i> negotiate kerberos?
</I>&gt;<i> 
</I>&gt;<i> Helo! i think i did almost everything right, firstly i made 
</I>&gt;<i> it in a test enviroment with debian stretch running squid 3.5 
</I>&gt;<i> and a windows server 2008 based domain controller, and it worked!
</I>&gt;<i> 
</I>&gt;<i> but when i tried to deploy it in the production enviroment 
</I>&gt;<i> running debian stretch, squid 3.5 and windows server 2012 as 
</I>&gt;<i> the domain controller the authentication never works, the 
</I>&gt;<i> file /var/log/squid/cache.log shows this:
</I>&gt;<i> 
</I>&gt;<i> 2020/02/14 15:40:21 kid1| ERROR: Negotiate Authentication 
</I>&gt;<i> validating user.
</I>&gt;<i> Result: {result=BH, notes={message: gss_acquire_cred() 
</I>&gt;<i> failed: Unspecified GSS failure.  Minor code may provide more 
</I>&gt;<i> information. No principal in keytab matches desired name; }}
</I>&gt;<i> negotiate_kerberos_auth.cc(610): pid=13887 :2020/02/14 15:40:22|
</I>&gt;<i> negotiate_kerberos_auth: DEBUG: Got 'YR (LETTERS AND 
</I>&gt;<i> NUMBERS)' from squid
</I>&gt;<i> (length: 2439).
</I>&gt;<i> negotiate_kerberos_auth.cc(663): pid=13887 :2020/02/14 15:40:22|
</I>&gt;<i> negotiate_kerberos_auth: DEBUG: Decode '(LETTERS AND 
</I>&gt;<i> NUMBERS)' (decoded
</I>&gt;<i> length: 1826).
</I>&gt;<i> 
</I>&gt;<i> Obs1:I replaced a big string with letters and numbers by 
</I>&gt;<i> &quot;(LETTERS AND NUMBERS)&quot;
</I>&gt;<i> Obs2: i posted more of the file in this link 
</I>&gt;<i> <A HREF="https://pastebin.com/Z2fe98dB">https://pastebin.com/Z2fe98dB</A>
</I>&gt;<i> 
</I>&gt;<i> well, the results of running: kinit -kt /etc/squid/HTTP.keytab
</I>&gt;<i> HTTP/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid2.domain.local at DOMAIN.LOCAL</A>:
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at SERVER</A>:~# klist
</I>&gt;<i> Ticket cache: FILE:/tmp/krb5cc_0
</I>&gt;<i> Default principal: HTTP/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid2.domain.local at DOMAIN.LOCAL</A>
</I>&gt;<i> 
</I>&gt;<i> Valid starting       Expires              Service principal
</I>&gt;<i> 02/15/2020 10:55:32  02/15/2020 20:55:32  
</I>&gt;<i> krbtgt/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">DOMAIN.LOCAL at DOMAIN.LOCAL</A>
</I>&gt;<i>         renew until 02/16/2020 09:55:32
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> The results of running:klist -kte /etc/squid/HTTP.keytab
</I>&gt;<i> 
</I>&gt;<i> Keytab name: FILE:/etc/squid/HTTP.keytab
</I>&gt;<i> KVNO Timestamp           Principal
</I>&gt;<i> ---- -------------------
</I>&gt;<i> ------------------------------------------------------
</I>&gt;<i>    1 02/12/2020 17:33:15 squid2$@DOMAIN.LOCAL (arcfour-hmac)
</I>&gt;<i>    1 02/12/2020 17:33:16 squid2$@DOMAIN.LOCAL 
</I>&gt;<i> (aes128-cts-hmac-sha1-96)
</I>&gt;<i>    1 02/12/2020 17:33:16 squid2$@DOMAIN.LOCAL 
</I>&gt;<i> (aes256-cts-hmac-sha1-96)
</I>&gt;<i>    1 02/12/2020 17:33:16 SQUID2$@DOMAIN.LOCAL (arcfour-hmac)
</I>&gt;<i>    1 02/12/2020 17:33:16 SQUID2$@DOMAIN.LOCAL 
</I>&gt;<i> (aes128-cts-hmac-sha1-96)
</I>&gt;<i>    1 02/12/2020 17:33:16 SQUID2$@DOMAIN.LOCAL 
</I>&gt;<i> (aes256-cts-hmac-sha1-96)
</I>&gt;<i>    1 02/12/2020 17:33:16 HTTP/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid2.domain.local at DOMAIN.LOCAL</A>
</I>&gt;<i> (arcfour-hmac)
</I>&gt;<i>    1 02/12/2020 17:33:16 HTTP/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid2.domain.local at DOMAIN.LOCAL</A>
</I>&gt;<i> (aes128-cts-hmac-sha1-96)
</I>&gt;<i>    1 02/12/2020 17:33:16 HTTP/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid2.domain.local at DOMAIN.LOCAL</A>
</I>&gt;<i> (aes256-cts-hmac-sha1-96)
</I>&gt;<i>    1 02/12/2020 17:33:16 host/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid2 at DOMAIN.LOCAL</A> (arcfour-hmac)
</I>&gt;<i>    1 02/12/2020 17:33:16 host/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid2 at DOMAIN.LOCAL</A> 
</I>&gt;<i> (aes128-cts-hmac-sha1-96)
</I>&gt;<i>    1 02/12/2020 17:33:16 host/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid2 at DOMAIN.LOCAL</A> 
</I>&gt;<i> (aes256-cts-hmac-sha1-96)
</I>&gt;<i>    3 02/12/2020 17:36:59 squid2$@DOMAIN.LOCAL (arcfour-hmac)
</I>&gt;<i>    3 02/12/2020 17:36:59 squid2$@DOMAIN.LOCAL 
</I>&gt;<i> (aes128-cts-hmac-sha1-96)
</I>&gt;<i>    3 02/12/2020 17:36:59 squid2$@DOMAIN.LOCAL 
</I>&gt;<i> (aes256-cts-hmac-sha1-96)
</I>&gt;<i>    3 02/12/2020 17:36:59 SQUID2$@DOMAIN.LOCAL (arcfour-hmac)
</I>&gt;<i>    3 02/12/2020 17:36:59 SQUID2$@DOMAIN.LOCAL 
</I>&gt;<i> (aes128-cts-hmac-sha1-96)
</I>&gt;<i>    3 02/12/2020 17:36:59 SQUID2$@DOMAIN.LOCAL 
</I>&gt;<i> (aes256-cts-hmac-sha1-96)
</I>&gt;<i>    3 02/12/2020 17:36:59 HTTP/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid2.domain.local at DOMAIN.LOCAL</A>
</I>&gt;<i> (arcfour-hmac)
</I>&gt;<i>    3 02/12/2020 17:36:59 HTTP/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid2.domain.local at DOMAIN.LOCAL</A>
</I>&gt;<i> (aes128-cts-hmac-sha1-96)
</I>&gt;<i>    3 02/12/2020 17:36:59 HTTP/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid2.domain.local at DOMAIN.LOCAL</A>
</I>&gt;<i> (aes256-cts-hmac-sha1-96)
</I>&gt;<i>    3 02/12/2020 17:36:59 host/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid2 at DOMAIN.LOCAL</A> (arcfour-hmac)
</I>&gt;<i>    3 02/12/2020 17:36:59 host/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid2 at DOMAIN.LOCAL</A> 
</I>&gt;<i> (aes128-cts-hmac-sha1-96)
</I>&gt;<i>    3 02/12/2020 17:36:59 host/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid2 at DOMAIN.LOCAL</A> 
</I>&gt;<i> (aes256-cts-hmac-sha1-96)
</I>&gt;<i> 
</I>&gt;<i> And the results of running: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at SERVER</A>:~# 
</I>&gt;<i> /usr/lib/squid/negotiate_kerberos_auth_test server.domain.local
</I>&gt;<i> Token: (Alonglinewithnumbersandletters)
</I>&gt;<i> 
</I>&gt;<i> the configs of the /etc/krb5.conf:
</I>&gt;<i> 
</I>&gt;<i> [libdefaults]
</I>&gt;<i>     default_realm = DOMAIN.LOCAL
</I>&gt;<i>     dns_lookup_kdc = no
</I>&gt;<i>     dns_lookup_realm = no
</I>&gt;<i>     ticket_lifetime = 24h
</I>&gt;<i>     default_keytab_name = /etc/squid/HTTP.keytab
</I>&gt;<i> 
</I>&gt;<i>     default_tgs_enctypes = aes256-cts-hmac-sha1-96 rc4-hmac 
</I>&gt;<i> des-cbc-crc
</I>&gt;<i> des-cbc-md5
</I>&gt;<i>     default_tkt_enctypes = aes256-cts-hmac-sha1-96 rc4-hmac 
</I>&gt;<i> des-cbc-crc
</I>&gt;<i> des-cbc-md5
</I>&gt;<i>     permitted_enctypes = aes256-cts-hmac-sha1-96 rc4-hmac des-cbc-crc
</I>&gt;<i> des-cbc-md5
</I>&gt;<i> 
</I>&gt;<i> [realms]
</I>&gt;<i>     DOMAIN.LOCAL = {
</I>&gt;<i>         kdc = dc01.domain.local
</I>&gt;<i>         admin_server = dc01.domain.local
</I>&gt;<i>         default_domain = domain.local
</I>&gt;<i>     }
</I>&gt;<i> 
</I>&gt;<i> [domain_realm]
</I>&gt;<i>     .domain.local = DOMAIN.LOCAL
</I>&gt;<i>     domain.local = DOMAIN.LOCAL
</I>&gt;<i> 
</I>&gt;<i> and the /etc/squid/squid.conf:
</I>&gt;<i> 
</I>&gt;<i> http_port 3128
</I>&gt;<i> dns_nameservers 200.198.5.4 200.198.5.5
</I>&gt;<i> visible_hostname PROXY
</I>&gt;<i> cache_dir ufs /var/spool/squid 100 16 256 coredump_dir 
</I>&gt;<i> /var/spool/squid
</I>&gt;<i> 
</I>&gt;<i> url_rewrite_program /usr/bin/squidGuard
</I>&gt;<i> 
</I>&gt;<i> #auth parameter NEGOTIATE
</I>&gt;<i> auth_param negotiate program 
</I>&gt;<i> /usr/lib/squid/negotiate_kerberos_auth -d -s 
</I>&gt;<i> HTTP/squid.domain.local -k /etc/squid/HTTP.keytab auth_param 
</I>&gt;<i> negotiate children 30 auth_param negotiate keep_alive on
</I>&gt;<i> 
</I>&gt;<i> acl Safe_ports port 80 # http
</I>&gt;<i> acl Safe_ports port 443 # https
</I>&gt;<i> acl Safe_ports port 90 # metodo
</I>&gt;<i> acl Safe_ports port 21 # ftp
</I>&gt;<i> acl Safe_ports port 443 # https
</I>&gt;<i> acl Safe_ports port 70 # gopher
</I>&gt;<i> acl Safe_ports port 210 # wais
</I>&gt;<i> acl Safe_ports port 1025-65535 # unregistered ports acl 
</I>&gt;<i> CONNECT method CONNECT acl auth proxy_auth REQUIRED
</I>&gt;<i> 
</I>&gt;<i> http_access deny !Safe_ports
</I>&gt;<i> http_access deny CONNECT !Safe_ports
</I>&gt;<i> http_access allow localhost manager
</I>&gt;<i> http_access deny manager
</I>&gt;<i> http_access allow localhost
</I>&gt;<i> http_access deny !auth
</I>&gt;<i> http_access allow auth
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> In the domain controller i created in the two zones the 
</I>&gt;<i> proper dns records, the host with squid can have his ip 
</I>&gt;<i> resolved to its right hostname, and its hostname resolved to 
</I>&gt;<i> its right ip, in the clients i setted the proxy as 
</I>&gt;<i> server.domain.local, and in the squid access.log the requests 
</I>&gt;<i> came but are all denied and a prompt for user and password 
</I>&gt;<i> are showed to the user
</I>&gt;<i> 
</I>&gt;<i> Obs: the only data edited while posting was that i replaced 
</I>&gt;<i> our domain by domain.local, the name of the host by SERVER, 
</I>&gt;<i> and long strings of data in the cache log  and negotiate 
</I>&gt;<i> kerberos test out, all the rest is what is really running in 
</I>&gt;<i> the files.
</I>&gt;<i> 
</I>&gt;<i> please someone help me, i tried to read everything i could 
</I>&gt;<i> find but i am not finding how to understand what i am doing 
</I>&gt;<i> wrong, thanks in advance, D:
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> --
</I>&gt;<i> Sent from: 
</I>&gt;<i> <A HREF="http://squid-web-proxy-cache.1019090.n4.nabble.com/Squid-Users">http://squid-web-proxy-cache.1019090.n4.nabble.com/Squid-Users</A>
</I>&gt;<i> -f1019091.html
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i> 
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="021774.html">[squid-users] please, can someone help me with the negotiate kerberos?
</A></li>
	<LI>Next message (by thread): <A HREF="021776.html">[squid-users] please, can someone help me with the negotiate kerberos?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21775">[ date ]</a>
              <a href="thread.html#21775">[ thread ]</a>
              <a href="subject.html#21775">[ subject ]</a>
              <a href="author.html#21775">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
