<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Bump and Splice
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Bump%20and%20Splice&In-Reply-To=%3C38806b27-9e34-7145-bc90-44c49a31cf74%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="021779.html">
   <LINK REL="Next"  HREF="021781.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Bump and Splice</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Bump%20and%20Splice&In-Reply-To=%3C38806b27-9e34-7145-bc90-44c49a31cf74%40measurement-factory.com%3E"
       TITLE="[squid-users] Bump and Splice">rousskov at measurement-factory.com
       </A><BR>
    <I>Tue Feb 18 18:42:30 UTC 2020</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="021779.html">[squid-users] Bump and Splice
</A></li>
        <LI>Next message (by thread): <A HREF="021781.html">[squid-users] Bump and Splice
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21780">[ date ]</a>
              <a href="thread.html#21780">[ thread ]</a>
              <a href="subject.html#21780">[ subject ]</a>
              <a href="author.html#21780">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 2/17/20 9:56 AM, <A HREF="https://lists.squid-cache.org/listinfo/squid-users">AndyBinder at gmx.de</A> wrote:
&gt;<i> i think i am doing something wrong..
</I>
What exactly is not working now? You have not disclosed what new problem
you are facing, and Amos has given you the correct answer to your
original question.


&gt;<i> In brackets there are the changes i have made.
</I>&gt;<i> 
</I>&gt;<i> Sample snippet from my squid.conf:
</I>&gt;<i> 
</I>&gt;<i>     http_port 127.0.0.1:3128 name=transparent intercept ssl-bump ..
</I>&gt;<i>     https_port 127.0.0.1:3129 name=transparent intercept ssl-bump ...
</I>
I have not checked, but I would not be surprised if some Squid parts
assume (or will assume) that port name is unique. I recommend avoiding
using the same name=value for two *_ports.


&gt;<i>     http_port 192.168.1.1:3128  ssl-bump ...
</I>
&gt;<i>     tls_outgoing_options ...
</I>
&gt;<i>     acl bump_nobumpsites ssl::server_name ...
</I>&gt;<i> --&gt; (acl bump_nobumpport myportname transparent)
</I>&gt;<i> 
</I>&gt;<i>     ssl_bump peek bump_step1 all
</I>&gt;<i>     ssl_bump peek bump_step2 bump_nobumpsites
</I>&gt;<i> --&gt; (ssl_bump peek bump_step2 bump_nobumpport)
</I>&gt;<i>     ssl_bump splice bump_step3 bump_nobumpsites
</I>&gt;<i> --&gt; (ssl_bump splice bump_step3 bump_nobumpport)
</I>&gt;<i>     ssl_bump stare bump_step2
</I>&gt;<i>     ssl_bump bump bump_step3
</I>
&gt;<i>     sslproxy_cert_error deny all
</I>
I will reorder/polish your rules slightly for clarity sake:

  ssl_bump peek bump_step1
  ssl_bump peek bump_step2 bump_nobumpsites
  ssl_bump peek bump_step2 bump_nobumpport
  ssl_bump stare bump_step2
  ssl_bump splice bump_step3 bump_nobumpsites
  ssl_bump splice bump_step3 bump_nobumpport
  ssl_bump bump bump_step3

It looks like you are trying to make a splice-or-bump decision at step3.
That is impossible because staring at step2 makes splicing (at step 3)
impossible and, similarly, peeking at step2 makes bumping (at step3)
impossible. Squid skips impossible actions (and provides step2-based
defaults) so your configuration is, essentially:

  # step1
  ssl_bump peek bump_step1

  # step2
  ssl_bump peek bump_step2 bump_nobumpport
  ssl_bump peek bump_step2 bump_nobumpsites
  ssl_bump stare all

  # step3
  ssl_bump splice all
  ssl_bump bump all

In other words, you were trying to make a splice-or-bump decision at
step3, but modern Squid has to (and does) make that decision at step2.


If you are not peeking at step2 for some useful side effect, then you
can simplify further:

  # step1
  ssl_bump peek bump_step1

  # step2
  ssl_bump splice bump_step2 bump_nobumpport
  ssl_bump splice bump_step2 bump_nobumpsites
  ssl_bump stare all

  # step3
  ssl_bump bump all


Please note that since I do not know what you are trying to accomplish
and what does not work, I cannot say why the above simplified
configuration does not do what you want it to do.


HTH,

Alex.

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="021779.html">[squid-users] Bump and Splice
</A></li>
	<LI>Next message (by thread): <A HREF="021781.html">[squid-users] Bump and Splice
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21780">[ date ]</a>
              <a href="thread.html#21780">[ thread ]</a>
              <a href="subject.html#21780">[ subject ]</a>
              <a href="author.html#21780">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
