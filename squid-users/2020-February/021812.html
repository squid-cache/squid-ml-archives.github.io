<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] using &quot;acl &lt;name&gt; user_cert CN &lt;cn&gt;&quot;
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20using%20%22acl%20%3Cname%3E%20user_cert%20CN%20%3Ccn%3E%22&In-Reply-To=%3C0f2072cb-4d12-8172-6e25-714aa4e21e71%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="021810.html">
   <LINK REL="Next"  HREF="021818.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] using &quot;acl &lt;name&gt; user_cert CN &lt;cn&gt;&quot;</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20using%20%22acl%20%3Cname%3E%20user_cert%20CN%20%3Ccn%3E%22&In-Reply-To=%3C0f2072cb-4d12-8172-6e25-714aa4e21e71%40treenet.co.nz%3E"
       TITLE="[squid-users] using &quot;acl &lt;name&gt; user_cert CN &lt;cn&gt;&quot;">squid3 at treenet.co.nz
       </A><BR>
    <I>Sat Feb 29 09:43:08 UTC 2020</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="021810.html">[squid-users] using &quot;acl &lt;name&gt; user_cert CN &lt;cn&gt;&quot;
</A></li>
        <LI>Next message (by thread): <A HREF="021818.html">[squid-users] Invalid URL when trying to access cachemgr
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21812">[ date ]</a>
              <a href="thread.html#21812">[ thread ]</a>
              <a href="subject.html#21812">[ subject ]</a>
              <a href="author.html#21812">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 29/02/20 2:35 am, claudiu vasadi wrote:
&gt;<i> Hello list,
</I>&gt;<i> 
</I>&gt;<i> I&#8217;m currently trying to wrap my head around the concept of using &#8220;acl
</I>&gt;<i> name user_cert CN cn&#8221; on squid 3.5. What I would like to achieve is a
</I>&gt;<i> setup where the client needs to pass a certificate and squid
</I>&gt;<i> allows/denies access to the internet based on said certificate CN. So
</I>&gt;<i> far I came up empty.
</I>

Well, first you need that part of getting the client to send its
certificate.

http_port ... clientca=/path/to/clients/ca.pem


&gt;<i> 
</I>&gt;<i> My current config:
</I>&gt;<i> 
</I>&gt;<i> acl ssl_authentication user_cert CN user.cn.com
</I>&gt;<i> http_access allow all ssl_authentication
</I>&gt;<i> 
</I>
The &quot;all&quot; in that line is completely pointless.


&gt;<i> http_port 443 ssl-bump  \
</I>&gt;<i>   cert=/etc/squid/myCA.pem \
</I>&gt;<i>   generate-host-certificates=on dynamic_cert_mem_cache_size=4MB
</I>&gt;<i> 
</I>&gt;<i> #this is what generates certs on the fly. Point to the CA you generated above.
</I>&gt;<i> sslcrtd_program /usr/lib64/squid/ssl_crtd -s /tmp/squid/ssl_db -M 4MB
</I>&gt;<i> sslcrtd_children 5
</I>&gt;<i> 
</I>&gt;<i> acl step1 at_step SslBump1
</I>&gt;<i> ssl_bump peek step1
</I>&gt;<i> ssl_bump bump all
</I>&gt;<i> ssl_bump stare all
</I>&gt;<i> always_direct allow all
</I>&gt;<i> 
</I>
Where are the cache_peer's this always_direct rule is bypassing?

Hint: pointless config again. Remove it.

&gt;<i> 
</I>&gt;<i> From the client side I do:
</I>&gt;<i> 
</I>&gt;<i> curl -E certificate.pem -k -x <A HREF="http://myproxy:443">http://myproxy:443</A> <A HREF="https://www.google.de">https://www.google.de</A>
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> but I get the access denied page.
</I>&gt;<i> 
</I>&gt;<i> Checking cache.log I see:
</I>&gt;<i> matches: checking ssl_authentication = 0
</I>&gt;<i> clientAccessCheckDone: The request CONNECT www.google.de:443 is
</I>&gt;<i> DENIED; last ACL checked: all
</I>&gt;<i> 
</I>&gt;<i> So it&#8217;s clear the acl doesn&#8217;t match.
</I>
Indeed. TLS has not started yet. Not even the handshake parts.

Your config says that HTTP messages (lacking client TLS certs) are to be
denied. That means everything arriving in an http_port.


Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="021810.html">[squid-users] using &quot;acl &lt;name&gt; user_cert CN &lt;cn&gt;&quot;
</A></li>
	<LI>Next message (by thread): <A HREF="021818.html">[squid-users] Invalid URL when trying to access cachemgr
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21812">[ date ]</a>
              <a href="thread.html#21812">[ thread ]</a>
              <a href="subject.html#21812">[ subject ]</a>
              <a href="author.html#21812">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
