<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Fwd: Squid 4.8 with OpenSSL 1.1.1d
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Fwd%3A%20Squid%204.8%20with%20OpenSSL%201.1.1d&In-Reply-To=%3CCADSgaCSEgoPUorknDxw-CPxVbJ7LfWsS-bTg79L%2BU-qweuFbzg%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="021584.html">
   <LINK REL="Next"  HREF="021595.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Fwd: Squid 4.8 with OpenSSL 1.1.1d</H1>
    <B>Yaroslav Pushko</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Fwd%3A%20Squid%204.8%20with%20OpenSSL%201.1.1d&In-Reply-To=%3CCADSgaCSEgoPUorknDxw-CPxVbJ7LfWsS-bTg79L%2BU-qweuFbzg%40mail.gmail.com%3E"
       TITLE="[squid-users] Fwd: Squid 4.8 with OpenSSL 1.1.1d">yaroslav.pushko at globallogic.com
       </A><BR>
    <I>Fri Jan  3 13:40:52 UTC 2020</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="021584.html">[squid-users] Exclude dstdomain in access.log file
</A></li>
        <LI>Next message (by thread): <A HREF="021595.html">[squid-users] Fwd: Squid 4.8 with OpenSSL 1.1.1d
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21585">[ date ]</a>
              <a href="thread.html#21585">[ thread ]</a>
              <a href="subject.html#21585">[ subject ]</a>
              <a href="author.html#21585">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Alex,

Thank you for the reply, we update our patch with provided changes.

One more thing, with TLSv1.3.

There is site <A HREF="https://3frontoffice.tre.se/login">https://3frontoffice.tre.se/login</A> with specific behavior in
the Chrome browser OS X El Capitan.

During establishing TLSv1.3 handshake after successfully send our Client
Hello, the server answers us with Hello Retry Request.

In Squid this behavior interprets next Client Hello peek successfully and
Hello Retry Request peeks as Server Hello.
After that, we splice it and send to OpenSSL and fail handshake
establishing.

Did you already notice such behavior?
Did you have some investigation on this issue, any advice will be pleasant?

Best regards,
Yaroslav.


On Tue, Dec 17, 2019 at 4:39 PM Alex Rousskov &lt;
<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt; wrote:

&gt;<i> On 12/17/19 9:00 AM, Yaroslav Pushko wrote:
</I>&gt;<i> &gt; Hi All
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; We use Squid 4.8 with OpenSSL 1.1.1d in a transparent mode for peek and
</I>&gt;<i> &gt; splice interception.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; With this version, we lost the possibility to connect to any HTTPS site.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; There are a few issues:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;   * support TLSv1.2 sites (already discussed in
</I>&gt;<i> &gt;     thread
</I>&gt;<i> <A HREF="http://squid-web-proxy-cache.1019090.n4.nabble.com/Problem-with-ssl-choose-client-version-inappropriate-fallback-on-some-sites-when-using-TLS1-2-td4688258.html">http://squid-web-proxy-cache.1019090.n4.nabble.com/Problem-with-ssl-choose-client-version-inappropriate-fallback-on-some-sites-when-using-TLS1-2-td4688258.html</A>
</I>&gt;<i>  )
</I>&gt;<i> &gt;   * support TLSv1.3 sites.
</I>&gt;<i>
</I>&gt;<i> Please see
</I>&gt;<i>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/pipermail/squid-users/2019-December/021435.html">http://lists.squid-cache.org/pipermail/squid-users/2019-December/021435.html</A>
</I>&gt;<i> for several alternative fixes. AFAICT, those fixes are more flexible
</I>&gt;<i> and, after polishing, appropriate for the official inclusion because
</I>&gt;<i> they make fewer assumptions about the values sent via the supported
</I>&gt;<i> versions extension.
</I>&gt;<i>
</I>&gt;<i> It is possible that your SSL_MODE_SEND_FALLBACK_SCSV change needs to be
</I>&gt;<i> integrated with the other fixes. Thank you for sharing that idea!
</I>&gt;<i>
</I>&gt;<i> Alex.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; Support TLSv1.2.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     OpenSSL 1.1.1d adds support of TLSv1.3. These changes added some
</I>&gt;<i> &gt;     kind of guard if we perform a handshake with a lower version of the
</I>&gt;<i> &gt;     TLS protocol than we support. In this scenario, we receive downgrade
</I>&gt;<i> &gt;     fallback error.
</I>&gt;<i> &gt;     Handshake version TLSv1.2 vs. max support TLSv1.3.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     In such case, we have the next error:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;         ERROR: negotiating TLS on FD 19: error:1425F175:SSL
</I>&gt;<i> &gt;         routines:ssl_choose_client_version:inappropriate fallback
</I>&gt;<i> (1/-1/0)
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     OpenSSL already provided a fix for it. You can configure SSL session
</I>&gt;<i> &gt;     to use option SSL_MODE_SEND_FALLBACK_SCSV and setting SSL max proto
</I>&gt;<i> &gt;     version for current SSL session, but squid not yet supported these
</I>&gt;<i> &gt;     features.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     You can find a patch in the attachments, will be grateful for the
</I>&gt;<i> &gt;     review.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; The issue with TLS 1.3 support, we are still investigating, any advice
</I>&gt;<i> &gt; will be pleasant.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Best regards,
</I>&gt;<i> &gt; Yaroslav Pushko.
</I>&gt;<i> &gt; --
</I>&gt;<i> &gt; Best Regards,
</I>&gt;<i> &gt; Yaroslav Pushko | Senior *Software Engineer*
</I>&gt;<i> &gt; GlobalLogic
</I>&gt;<i> &gt; P +380971842774  M +380634232226 S dithard
</I>&gt;<i> &gt; www.globallogic.com &lt;<A HREF="http://www.globallogic.com/">http://www.globallogic.com/</A>&gt;
</I>&gt;<i> &gt; <A HREF="http://www.globallogic.com/email_disclaimer.txt">http://www.globallogic.com/email_disclaimer.txt</A>
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; _______________________________________________
</I>&gt;<i> &gt; squid-users mailing list
</I>&gt;<i> &gt; <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> &gt; <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i> &gt;
</I>&gt;<i>
</I>&gt;<i>
</I>
-- 
Best Regards,
Yaroslav Pushko | Senior *Software Engineer*
GlobalLogic
P +380971842774  M +380634232226 S dithard
www.globallogic.com
&lt;<A HREF="http://www.globallogic.com/">http://www.globallogic.com/</A>&gt;
<A HREF="http://www.globallogic.com/email_disclaimer.txt">http://www.globallogic.com/email_disclaimer.txt</A>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20200103/887e7e76/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20200103/887e7e76/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="021584.html">[squid-users] Exclude dstdomain in access.log file
</A></li>
	<LI>Next message (by thread): <A HREF="021595.html">[squid-users] Fwd: Squid 4.8 with OpenSSL 1.1.1d
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21585">[ date ]</a>
              <a href="thread.html#21585">[ thread ]</a>
              <a href="subject.html#21585">[ subject ]</a>
              <a href="author.html#21585">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
