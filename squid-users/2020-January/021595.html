<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Fwd: Squid 4.8 with OpenSSL 1.1.1d
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Fwd%3A%20Squid%204.8%20with%20OpenSSL%201.1.1d&In-Reply-To=%3C95c21e62-8918-c872-583b-232ef954e9bd%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="021585.html">
   <LINK REL="Next"  HREF="021599.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Fwd: Squid 4.8 with OpenSSL 1.1.1d</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Fwd%3A%20Squid%204.8%20with%20OpenSSL%201.1.1d&In-Reply-To=%3C95c21e62-8918-c872-583b-232ef954e9bd%40measurement-factory.com%3E"
       TITLE="[squid-users] Fwd: Squid 4.8 with OpenSSL 1.1.1d">rousskov at measurement-factory.com
       </A><BR>
    <I>Mon Jan  6 14:52:45 UTC 2020</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="021585.html">[squid-users] Fwd: Squid 4.8 with OpenSSL 1.1.1d
</A></li>
        <LI>Next message (by thread): <A HREF="021599.html">[squid-users] Fwd: Squid 4.8 with OpenSSL 1.1.1d
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21595">[ date ]</a>
              <a href="thread.html#21595">[ thread ]</a>
              <a href="subject.html#21595">[ subject ]</a>
              <a href="author.html#21595">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 1/3/20 8:40 AM, Yaroslav Pushko wrote:

&gt;<i> During&#160;establishing TLSv1.3 handshake after&#160;successfully&#160;send our Client
</I>&gt;<i> Hello, the server answers us with Hello Retry Request.
</I>
HelloRetryRequest is a TLS v1.3 feature that tells the client to restart
the negotiation (with additional info). Please keep in mind that:

1. If Squid peeks at TLS v1.3 data from the server, bumping the
connection is likely to be impossible. Since plain text TLS v1.3 server
bytes should not contain useful information, and encrypted TLS v1.3
server bytes are useless for a peeking transaction (and deadly for a
bumping transaction), the decision to bump such a transaction has to be
done no later than step2 (i.e. no later than after receiving TLS Client
Hello).

2. Squid TLS parser does not know about TLS v1.3 HelloRetryRequest
messages yet. Thus, if Squid is asked to parse from-server traffic
containing that message, Squid may not do what it should do (whatever
that is).

The changes discussed earlier in this email thread do not include adding
support for HelloRetryRequest, but they may help with the overall
situation by correctly identifying TLS v1.3 traffic. I think we are very
close to submitting an official pull request with these changes.

HTH,

Alex.


&gt;<i> In Squid this behavior interprets next Client Hello peek
</I>&gt;<i> successfully&#160;and Hello Retry Request peeks&#160;as Server Hello.
</I>&gt;<i> After that, we splice it and send to OpenSSL and fail handshake
</I>&gt;<i> establishing.
</I>&gt;<i> 
</I>&gt;<i> Did you already notice such behavior?&#160;
</I>&gt;<i> Did you have some investigation on this issue,&#160;any advice will be pleasant?
</I>&gt;<i> 
</I>&gt;<i> Best regards,
</I>&gt;<i> Yaroslav.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> On Tue, Dec 17, 2019 at 4:39 PM Alex Rousskov wrote:
</I>&gt;<i> 
</I>&gt;<i>     On 12/17/19 9:00 AM, Yaroslav Pushko wrote:
</I>&gt;<i>     &gt; Hi All
</I>&gt;<i>     &gt;
</I>&gt;<i>     &gt; We use&#160;Squid 4.8 with OpenSSL 1.1.1d in a transparent mode for
</I>&gt;<i>     peek and
</I>&gt;<i>     &gt; splice interception.
</I>&gt;<i>     &gt;
</I>&gt;<i>     &gt; With this version, we lost the&#160;possibility&#160;to connect to any HTTPS
</I>&gt;<i>     site.
</I>&gt;<i>     &gt;
</I>&gt;<i>     &gt; There are a few issues:&#160;
</I>&gt;<i>     &gt;
</I>&gt;<i>     &gt;&#160; &#160;* support TLSv1.2 sites (already discussed in
</I>&gt;<i>     &gt;&#160; &#160;
</I>&gt;<i>     &#160;thread&#160;<A HREF="http://squid-web-proxy-cache.1019090.n4.nabble.com/Problem-with-ssl-choose-client-version-inappropriate-fallback-on-some-sites-when-using-TLS1-2-td4688258.html&#160;">http://squid-web-proxy-cache.1019090.n4.nabble.com/Problem-with-ssl-choose-client-version-inappropriate-fallback-on-some-sites-when-using-TLS1-2-td4688258.html&#160;</A>)
</I>&gt;<i>     &gt;&#160; &#160;* support TLSv1.3 sites.
</I>&gt;<i> 
</I>&gt;<i>     Please see
</I>&gt;<i>     <A HREF="http://lists.squid-cache.org/pipermail/squid-users/2019-December/021435.html">http://lists.squid-cache.org/pipermail/squid-users/2019-December/021435.html</A>
</I>&gt;<i>     for several alternative fixes. AFAICT, those fixes are more flexible
</I>&gt;<i>     and, after polishing, appropriate for the official inclusion because
</I>&gt;<i>     they make fewer assumptions about the values sent via the supported
</I>&gt;<i>     versions extension.
</I>&gt;<i> 
</I>&gt;<i>     It is possible that your SSL_MODE_SEND_FALLBACK_SCSV change needs to be
</I>&gt;<i>     integrated with the other fixes. Thank you for sharing that idea!
</I>&gt;<i> 
</I>&gt;<i>     Alex.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i>     &gt; Support TLSv1.2.
</I>&gt;<i>     &gt;
</I>&gt;<i>     &gt;&#160; &#160; &#160;OpenSSL 1.1.1d adds support of TLSv1.3. These changes added some
</I>&gt;<i>     &gt;&#160; &#160; &#160;kind of guard if we perform a handshake with a lower version
</I>&gt;<i>     of the
</I>&gt;<i>     &gt;&#160; &#160; &#160;TLS protocol than we support. In this scenario, we receive
</I>&gt;<i>     downgrade
</I>&gt;<i>     &gt;&#160; &#160; &#160;fallback&#160;error.
</I>&gt;<i>     &gt;&#160; &#160; &#160;Handshake version TLSv1.2 vs. max support TLSv1.3.
</I>&gt;<i>     &gt;
</I>&gt;<i>     &gt;&#160; &#160; &#160;In such case, we have the next error:
</I>&gt;<i>     &gt;
</I>&gt;<i>     &gt;&#160; &#160; &#160; &#160; &#160;ERROR: negotiating TLS on FD 19: error:1425F175:SSL
</I>&gt;<i>     &gt;&#160; &#160; &#160; &#160; &#160;routines:ssl_choose_client_version:inappropriate fallback
</I>&gt;<i>     (1/-1/0)
</I>&gt;<i>     &gt;
</I>&gt;<i>     &gt;
</I>&gt;<i>     &gt;&#160; &#160; &#160;OpenSSL already&#160;provided&#160;a fix for it. You can configure SSL
</I>&gt;<i>     session
</I>&gt;<i>     &gt;&#160; &#160; &#160;to use option&#160;SSL_MODE_SEND_FALLBACK_SCSV and setting SSL max
</I>&gt;<i>     proto
</I>&gt;<i>     &gt;&#160; &#160; &#160;version for current SSL session, but squid not yet supported these
</I>&gt;<i>     &gt;&#160; &#160; &#160;features.
</I>&gt;<i>     &gt;
</I>&gt;<i>     &gt;&#160; &#160; &#160;You can find a patch in the attachments, will be grateful for the
</I>&gt;<i>     &gt;&#160; &#160; &#160;review.
</I>&gt;<i>     &gt;
</I>&gt;<i>     &gt;
</I>&gt;<i>     &gt; The issue with TLS 1.3 support, we are still investigating, any advice
</I>&gt;<i>     &gt; will be pleasant.
</I>&gt;<i>     &gt;
</I>&gt;<i>     &gt; Best regards,
</I>&gt;<i>     &gt; Yaroslav Pushko.
</I>&gt;<i>     &gt; --&#160;
</I>&gt;<i>     &gt; Best Regards,
</I>&gt;<i>     &gt; Yaroslav Pushko | Senior&#160;*Software Engineer*
</I>&gt;<i>     &gt; GlobalLogic
</I>&gt;<i>     &gt; P +380971842774 &#160;M +380634232226 S&#160;dithard
</I>&gt;<i>     &gt; www.globallogic.com &lt;<A HREF="http://www.globallogic.com">http://www.globallogic.com</A>&gt;
</I>&gt;<i>     &lt;<A HREF="http://www.globallogic.com/">http://www.globallogic.com/</A>&gt;
</I>&gt;<i>     &gt; <A HREF="http://www.globallogic.com/email_disclaimer.txt">http://www.globallogic.com/email_disclaimer.txt</A>
</I>&gt;<i>     &gt;
</I>&gt;<i>     &gt; _______________________________________________
</I>&gt;<i>     &gt; squid-users mailing list
</I>&gt;<i>     &gt; <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i>     &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>&gt;
</I>&gt;<i>     &gt; <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i>     &gt;
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> -- 
</I>&gt;<i> Best Regards,
</I>&gt;<i> Yaroslav Pushko | Senior&#160;*Software Engineer*
</I>&gt;<i> GlobalLogic
</I>&gt;<i> P +380971842774 &#160;M +380634232226 S&#160;dithard
</I>&gt;<i> www.globallogic.com &lt;<A HREF="http://www.globallogic.com/">http://www.globallogic.com/</A>&gt;
</I>&gt;<i> &lt;<A HREF="http://www.globallogic.com/">http://www.globallogic.com/</A>&gt;
</I>&gt;<i> <A HREF="http://www.globallogic.com/email_disclaimer.txt">http://www.globallogic.com/email_disclaimer.txt</A>
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="021585.html">[squid-users] Fwd: Squid 4.8 with OpenSSL 1.1.1d
</A></li>
	<LI>Next message (by thread): <A HREF="021599.html">[squid-users] Fwd: Squid 4.8 with OpenSSL 1.1.1d
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21595">[ date ]</a>
              <a href="thread.html#21595">[ thread ]</a>
              <a href="subject.html#21595">[ subject ]</a>
              <a href="author.html#21595">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
