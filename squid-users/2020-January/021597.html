<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] squid-cache proxy which does it all
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid-cache%20proxy%20which%20does%20it%20all&In-Reply-To=%3CCAGU_CiL2jPDeEpYheTsEV-Tfw%2BvMEYtOnsEi2uW%3DJ1o-%2BBC31Q%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="021601.html">
   <LINK REL="Next"  HREF="021600.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] squid-cache proxy which does it all</H1>
    <B>robert k Wild</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid-cache%20proxy%20which%20does%20it%20all&In-Reply-To=%3CCAGU_CiL2jPDeEpYheTsEV-Tfw%2BvMEYtOnsEi2uW%3DJ1o-%2BBC31Q%40mail.gmail.com%3E"
       TITLE="[squid-users] squid-cache proxy which does it all">robertkwild at gmail.com
       </A><BR>
    <I>Thu Jan  9 07:34:22 UTC 2020</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="021601.html">[squid-users] Parent proxy expects Digest based authentication
</A></li>
        <LI>Next message (by thread): <A HREF="021600.html">[squid-users] squid-cache proxy which does it all
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21597">[ date ]</a>
              <a href="thread.html#21597">[ thread ]</a>
              <a href="subject.html#21597">[ subject ]</a>
              <a href="author.html#21597">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>hi all,

I have made a script for squid that installs the following &#8211;

Squid &#8211; http proxy server
Squid ssl-bump &#8211; https interception for squid
C-ICAP &#8211; icap server
clamAV &#8211; AV engine to detect trojan viruses malware etc
squidclamav &#8211; to make it all integrated with squid

what do you think?

#!/bin/bash
#squid on DMZ host
#
#first things first lets disable firewalld and SElinux
#
systemctl stop firewalld
systemctl disable firewalld
sed -i -e 's/SELINUX=enforcing/SELINUX=disabled/g' /etc/selinux/config
#
#squid packages
#
yum install -y epel-release swaks sed tar zip unzip curl telnet openssl
openssl-devel bzip2-devel libarchive libarchive-devel perl perl-Data-Dumper
gcc gcc-c++ binutils autoconf automake make sudo wget libxml2-devel
libcap-devel libtool-ltdl-devel
#
#clamAV packages
#
yum install -y clamav-server clamav-data clamav-update clamav-filesystem
clamav clamav-scanner-systemd clamav-devel clamav-lib clamav-server-systemd
#
#download and compile from source
#
cd /tmp
wget <A HREF="http://www.squid-cache.org/Versions/v4/squid-4.9.tar.gz">http://www.squid-cache.org/Versions/v4/squid-4.9.tar.gz</A>
wget
<A HREF="http://sourceforge.net/projects/c-icap/files/c-icap/0.5.x/c_icap-0.5.6.tar.gz">http://sourceforge.net/projects/c-icap/files/c-icap/0.5.x/c_icap-0.5.6.tar.gz</A>
wget
<A HREF="http://sourceforge.net/projects/c-icap/files/c-icap-modules/0.5.x/c_icap_modules-0.5.4.tar.gz">http://sourceforge.net/projects/c-icap/files/c-icap-modules/0.5.x/c_icap_modules-0.5.4.tar.gz</A>
wget
<A HREF="https://sourceforge.net/projects/squidclamav/files/squidclamav/7.1/squidclamav-7.1.tar.gz">https://sourceforge.net/projects/squidclamav/files/squidclamav/7.1/squidclamav-7.1.tar.gz</A>
for f in *.tar.gz; do tar xf &quot;$f&quot;; done
cd /tmp/squid-4.9
./configure --with-openssl --enable-ssl-crtd --enable-icap-client &amp;&amp; make
&amp;&amp; make install
#
cd /tmp/c_icap-0.5.6
./configure 'CXXFLAGS=-O2 -m64 -pipe' 'CFLAGS=-O2 -m64 -pipe' --without-bdb
--prefix=/usr/local &amp;&amp; make &amp;&amp; make install
#
cd /tmp/squidclamav-7.1
./configure 'CXXFLAGS=-O2 -m64 -pipe' 'CFLAGS=-O2 -m64 -pipe'
--with-c-icap=/usr/local --with-libarchive &amp;&amp; make &amp;&amp; make install
#
cd /tmp/c_icap_modules-0.5.4
./configure 'CFLAGS=-O3 -m64 -pipe' 'CPPFLAGS=-I/usr/local/clamav/include'
'LDFLAGS=-L/usr/local/lib -L/usr/local/clamav/lib/' &amp;&amp; make &amp;&amp; make install
#
#creating shortcuts and copying files
#
cp -f /usr/local/squid/etc/squid.conf /usr/local/squid/etc/squid.conf.orig
cp -f /usr/local/etc/c-icap.conf /usr/local/etc/c-icap.conf.orig
cp -f /usr/local/etc/squidclamav.conf /usr/local/etc/squidclamav.conf.orig
cp -f /usr/local/etc/clamav_mod.conf /usr/local/etc/clamav_mod.conf.orig
cp -f /usr/local/etc/virus_scan.conf /usr/local/etc/virus_scan.conf.orig
#
ln -s /usr/local/squid/etc/squid.conf /etc
ln -s /usr/local/etc/c-icap.conf /etc
ln -s /usr/local/etc/squidclamav.conf /etc
ln -s /usr/local/etc/clamav_mod.conf /etc
ln -s /usr/local/etc/virus_scan.conf /etc
#
mkdir -p /usr/local/clamav/share/clamav
ln -s /var/lib/clamav /usr/local/clamav/share/clamav
#
#tmpfiles for run files
#
echo &quot;d /var/run/c-icap 0755 root root -&quot; &gt;&gt; /etc/tmpfiles.d/c-icap.conf
echo &quot;d /var/run/clamav 0755 root root -&quot; &gt;&gt; /etc/tmpfiles.d/clamav.conf
#
#delete a few lines in squid
#
sed -i '/http_port 3128/d' /usr/local/squid/etc/squid.conf
sed -i '/http_access deny all/d' /usr/local/squid/etc/squid.conf
#
#whitelist in squid
#
sed -i '50i#HTTP_HTTPS whitelist websites' /usr/local/squid/etc/squid.conf
sed -i '51iacl whitelist ssl::server_name
&quot;/usr/local/squid/etc/urlwhite.txt&quot;' /usr/local/squid/etc/squid.conf
sed -i '52ihttp_access allow whitelist' /usr/local/squid/etc/squid.conf
sed -i '53ihttp_access deny all' /usr/local/squid/etc/squid.conf
echo &quot;#Microsoft&quot; &gt;&gt; /usr/local/squid/etc/urlwhite.txt
echo &quot;.bing.com&quot; &gt;&gt; /usr/local/squid/etc/urlwhite.txt
echo &quot;.msn.com&quot; &gt;&gt; /usr/local/squid/etc/urlwhite.txt
echo &quot;.msedge.net&quot; &gt;&gt; /usr/local/squid/etc/urlwhite.txt
echo &quot;.msftauth.net&quot; &gt;&gt; /usr/local/squid/etc/urlwhite.txt
echo &quot;.msauth.net&quot; &gt;&gt; /usr/local/squid/etc/urlwhite.txt
echo &quot;.msocdn.com&quot; &gt;&gt; /usr/local/squid/etc/urlwhite.txt
echo &quot;.outlook.com&quot; &gt;&gt; /usr/local/squid/etc/urlwhite.txt
echo &quot;.onedrive.com&quot; &gt;&gt; /usr/local/squid/etc/urlwhite.txt
echo &quot;.office.net&quot; &gt;&gt; /usr/local/squid/etc/urlwhite.txt
echo &quot;.office.com&quot; &gt;&gt; /usr/local/squid/etc/urlwhite.txt
echo &quot;.office365.com&quot; &gt;&gt; /usr/local/squid/etc/urlwhite.txt
echo &quot;.microsoft.com&quot; &gt;&gt; /usr/local/squid/etc/urlwhite.txt
echo &quot;.microsoftonline.com&quot; &gt;&gt; /usr/local/squid/etc/urlwhite.txt
echo &quot;.live.com&quot; &gt;&gt; /usr/local/squid/etc/urlwhite.txt
echo &quot;.live.net&quot; &gt;&gt; /usr/local/squid/etc/urlwhite.txt
echo &quot;.akamaized.net&quot; &gt;&gt; /usr/local/squid/etc/urlwhite.txt
echo &quot;.akamaihd.net&quot; &gt;&gt; /usr/local/squid/etc/urlwhite.txt
echo &quot;.svc.ms&quot; &gt;&gt; /usr/local/squid/etc/urlwhite.txt
echo &quot;.lync.com&quot; &gt;&gt; /usr/local/squid/etc/urlwhite.txt
echo &quot;.skype.com&quot; &gt;&gt; /usr/local/squid/etc/urlwhite.txt
echo &quot;.gfx.ms&quot; &gt;&gt; /usr/local/squid/etc/urlwhite.txt
echo &quot;.sharepoint.com&quot; &gt;&gt; /usr/local/squid/etc/urlwhite.txt
echo &quot;.sharepointonline.com&quot; &gt;&gt; /usr/local/squid/etc/urlwhite.txt
echo &quot;.windowsupdate.com&quot; &gt;&gt; /usr/local/squid/etc/urlwhite.txt
echo &quot;.windows.net&quot; &gt;&gt; /usr/local/squid/etc/urlwhite.txt
echo &quot;.edgesuite.net&quot; &gt;&gt; /usr/local/squid/etc/urlwhite.txt
echo &quot;.a-msedge.net&quot; &gt;&gt; /usr/local/squid/etc/urlwhite.txt
echo &quot;.akamaiedge.net&quot; &gt;&gt; /usr/local/squid/etc/urlwhite.txt
echo &quot;.sfx.ms&quot; &gt;&gt; /usr/local/squid/etc/urlwhite.txt
echo &quot;.azureedge.net&quot; &gt;&gt; /usr/local/squid/etc/urlwhite.txt
echo &quot;.trafficmanager.net&quot; &gt;&gt; /usr/local/squid/etc/urlwhite.txt
echo &quot;.azure.com&quot; &gt;&gt; /usr/local/squid/etc/urlwhite.txt
echo &quot;.s-microsoft.com&quot; &gt;&gt; /usr/local/squid/etc/urlwhite.txt
echo &quot;.onestore.ms&quot; &gt;&gt; /usr/local/squid/etc/urlwhite.txt
echo &quot;#Google&quot; &gt;&gt; /usr/local/squid/etc/urlwhite.txt
echo &quot;.google.com&quot; &gt;&gt; /usr/local/squid/etc/urlwhite.txt
echo &quot;.google.co.uk&quot; &gt;&gt; /usr/local/squid/etc/urlwhite.txt
echo &quot;.googleusercontent.com&quot; &gt;&gt; /usr/local/squid/etc/urlwhite.txt
echo &quot;.googleapis.com&quot; &gt;&gt; /usr/local/squid/etc/urlwhite.txt
echo &quot;.withgoogle.com&quot; &gt;&gt; /usr/local/squid/etc/urlwhite.txt
echo &quot;.gstatic.com&quot; &gt;&gt; /usr/local/squid/etc/urlwhite.txt
echo &quot;#Adobe&quot; &gt;&gt; /usr/local/squid/etc/urlwhite.txt
echo &quot;.adobedtm.com&quot; &gt;&gt; /usr/local/squid/etc/urlwhite.txt
echo &quot;.adobe.io&quot; &gt;&gt; /usr/local/squid/etc/urlwhite.txt
echo &quot;.adobe.com&quot; &gt;&gt; /usr/local/squid/etc/urlwhite.txt
echo &quot;.adobelogin.com&quot; &gt;&gt; /usr/local/squid/etc/urlwhite.txt
echo &quot;#others&quot; &gt;&gt; /usr/local/squid/etc/urlwhite.txt
echo &quot;.digicert.com&quot; &gt;&gt; /usr/local/squid/etc/urlwhite.txt
echo &quot;.pixelogicmedia.com&quot; &gt;&gt; /usr/local/squid/etc/urlwhite.txt
#
#ICAP in squid
#
echo &quot;#ICAP&quot; &gt;&gt; /usr/local/squid/etc/squid.conf
echo &quot;icap_enable on&quot; &gt;&gt; /usr/local/squid/etc/squid.conf
echo &quot;adaptation_uses_indirect_client on&quot; &gt;&gt; /usr/local/squid/etc/squid.conf
echo &quot;icap_send_client_ip on&quot; &gt;&gt; /usr/local/squid/etc/squid.conf
echo &quot;icap_send_client_username on&quot; &gt;&gt; /usr/local/squid/etc/squid.conf
echo &quot;icap_client_username_header X-Authenticated-User&quot; &gt;&gt;
/usr/local/squid/etc/squid.conf
echo &quot;icap_service service_req reqmod_precache bypass=0 <A HREF="icap://">icap://</A>
127.0.0.1:1344/squidclamav&quot; &gt;&gt; /usr/local/squid/etc/squid.conf
echo &quot;adaptation_access service_req allow all&quot; &gt;&gt;
/usr/local/squid/etc/squid.conf
echo &quot;icap_service service_resp respmod_precache bypass=0 <A HREF="icap://">icap://</A>
127.0.0.1:1344/squidclamav&quot; &gt;&gt; /usr/local/squid/etc/squid.conf
echo &quot;adaptation_access service_resp allow all&quot; &gt;&gt;
/usr/local/squid/etc/squid.conf
#
#squid with SSL
#
mkdir -p /usr/local/squid/etc/ssl_cert
cd /usr/local/squid/etc/ssl_cert
adduser squid
chown squid:squid /usr/local/squid/etc/ssl_cert
chmod 700 /usr/local/squid/etc/ssl_cert
openssl req -new -newkey rsa:2048 -sha256 -days 365 -nodes -x509
-extensions v3_ca -keyout myCA.pem -out myCA.pem -batch
#must import the below cert on hosts in trusted root cert ie the .der file
openssl x509 -in myCA.pem -outform DER -out myCA.der
/usr/local/squid/libexec/security_file_certgen -c -s /var/lib/ssl_db -M 4MB
chown squid:squid -R /var/lib/ssl_db
chmod -R 777 /usr/local/squid/var/logs
sed -i '1ihttp_port 3128 ssl-bump
cert=/usr/local/squid/etc/ssl_cert/myCA.pem generate-host-certificates=on
dynamic_cert_mem_cache_size=4MB' /usr/local/squid/etc/squid.conf
sed -i '2isslcrtd_program /usr/local/squid/libexec/security_file_certgen -s
/var/lib/ssl_db -M 4MB' /usr/local/squid/etc/squid.conf
sed -i '3iacl step1 at_step SslBump1' /usr/local/squid/etc/squid.conf
sed -i '4issl_bump peek step1' /usr/local/squid/etc/squid.conf
sed -i '5issl_bump bump all' /usr/local/squid/etc/squid.conf
#
#squidclamav conf
#
sed -i -e 's%redirect <A HREF="http://proxy.domain.dom/cgi-bin/clwarn.cgi%#redirect">http://proxy.domain.dom/cgi-bin/clwarn.cgi%#redirect</A>
<A HREF="http://proxy.domain.dom/cgi-bin/clwarn.cgi%g">http://proxy.domain.dom/cgi-bin/clwarn.cgi%g</A>' /etc/squidclamav.conf
#sed -i -e 's%clamd_local /var/run/clamav/clamd.ctl%clamd_local
/run/clamd.scan/clamd.sock%g' /etc/squidclamav.conf
sed -i -e 's%enable_libarchive 0%enable_libarchive 1%g'
/etc/squidclamav.conf
#
#clamav conf
#
sed -i -e 's%#LocalSocket /run/clamd.scan/clamd.sock%LocalSocket
/var/run/clamav/clamd.ctl%g' /etc/clamd.d/scan.conf
sed -i -e 's%Example%#Example%g' /etc/clamd.d/scan.conf
sed -i -e 's%User clamscan%User root%g' /etc/clamd.d/scan.conf
sed -i -e 's%#StreamMaxLength 10M%StreamMaxLength 5M%g'
/etc/clamd.d/scan.conf
freshclam
echo &quot;00 01,13 * * * /usr/bin/freshclam --quiet&quot; &gt;&gt; /var/spool/cron/root
systemctl enable <A HREF="https://lists.squid-cache.org/listinfo/squid-users">clamd at scan</A>
#
#c-icap and c-icap modules
#
#sed -i -e 's%PidFile /var/run/c-icap/c-icap.pid%PidFile
/run/c-icap/c-icap.pid%g' /etc/c-icap.conf
#sed -i -e 's%CommandsSocket /var/run/c-icap/c-icap.ctl%CommandsSocket
/run/c-icap/c-icap.ctl%g' /etc/c-icap.conf
sed -i -e 's%#.*User wwwrun%User root%g' /etc/c-icap.conf
sed -i -e 's%#.*Group nogroup%Group root%g' /etc/c-icap.conf
sed -i -e 's%#.*Service echo_service srv_echo.so%Service squidclamav
squidclamav.so%g' /etc/c-icap.conf
sed -i -e 's%DebugLevel 1%DebugLevel 0%g' /etc/c-icap.conf
sed -i -e 's%StartServers 3%StartServers 1%g' /etc/c-icap.conf
sed -i -e 's%MaxServers 10%MaxServers 20%g' /etc/c-icap.conf
sed -i -e 's%MaxRequestsPerChild 0%MaxRequestsPerChild 100%g'
/etc/c-icap.conf
sed -i '520iacl localhost src 127.0.0.1/255.255.255.255' /etc/c-icap.conf
sed -i '521iacl PERMIT_REQUESTS type REQMOD RESPMOD' /etc/c-icap.conf
sed -i '522iicap_access allow localhost PERMIT_REQUESTS' /etc/c-icap.conf
sed -i '523iicap_access deny all' /etc/c-icap.conf
echo &quot;clamav_mod.TmpDir /var/tmp&quot; &gt;&gt; /etc/clamav_mod.conf
echo &quot;clamav_mod.MaxFilesInArchive 1000&quot; &gt;&gt; /etc/clamav_mod.conf
echo &quot;clamav_mod.MaxScanSize 5M&quot; &gt;&gt; /etc/clamav_mod.conf
echo &quot;clamav_mod.HeuristicScanPrecedence on&quot; &gt;&gt; /etc/clamav_mod.conf
echo &quot;clamav_mod.OLE2BlockMacros on&quot; &gt;&gt; /etc/clamav_mod.conf
echo &quot;virus_scan.ScanFileTypes TEXT DATA EXECUTABLE ARCHIVE DOCUMENT&quot; &gt;&gt;
/etc/virus_scan.conf
echo &quot;virus_scan.SendPercentData 5&quot; &gt;&gt; /etc/virus_scan.conf
echo &quot;virus_scan.PassOnError on&quot; &gt;&gt; /etc/virus_scan.conf
echo &quot;virus_scan.MaxObjectSize 5M&quot; &gt;&gt; /etc/virus_scan.conf
echo &quot;virus_scan.DefaultEngine clamav&quot; &gt;&gt; /etc/virus_scan.conf
echo &quot;Include clamav_mod.conf&quot; &gt;&gt; /etc/virus_scan.conf
echo &quot;Include virus_scan.conf&quot; &gt;&gt; /etc/c-icap.conf
#
#make c-icap service
#
echo &quot;[Unit]&quot; &gt;&gt; /usr/lib/systemd/system/c-icap.service
echo &quot;Description=c-icap service&quot; &gt;&gt; /usr/lib/systemd/system/c-icap.service
echo &quot;After=network.target&quot; &gt;&gt; /usr/lib/systemd/system/c-icap.service
echo &quot;[Service]&quot; &gt;&gt; /usr/lib/systemd/system/c-icap.service
echo &quot;Type=forking&quot; &gt;&gt; /usr/lib/systemd/system/c-icap.service
echo &quot;PIDFile=/var/run/c-icap/c-icap.pid&quot; &gt;&gt;
/usr/lib/systemd/system/c-icap.service
echo &quot;ExecStart=/usr/local/bin/c-icap -f /etc/c-icap.conf&quot; &gt;&gt;
/usr/lib/systemd/system/c-icap.service
echo &quot;KillMode=process&quot; &gt;&gt; /usr/lib/systemd/system/c-icap.service
echo &quot;[Install]&quot; &gt;&gt; /usr/lib/systemd/system/c-icap.service
echo &quot;WantedBy=multi-user.target&quot; &gt;&gt; /usr/lib/systemd/system/c-icap.service
systemctl enable c-icap
reboot

thanks,

rob


-- 
Regards,

Robert K Wild.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20200109/740bbf6f/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20200109/740bbf6f/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="021601.html">[squid-users] Parent proxy expects Digest based authentication
</A></li>
	<LI>Next message (by thread): <A HREF="021600.html">[squid-users] squid-cache proxy which does it all
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21597">[ date ]</a>
              <a href="thread.html#21597">[ thread ]</a>
              <a href="subject.html#21597">[ subject ]</a>
              <a href="author.html#21597">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
