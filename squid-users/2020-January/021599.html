<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Fwd: Squid 4.8 with OpenSSL 1.1.1d
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Fwd%3A%20Squid%204.8%20with%20OpenSSL%201.1.1d&In-Reply-To=%3C1A113AB5-AD03-4F7F-A188-2BA0BAF18DA0%40gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="021595.html">
   <LINK REL="Next"  HREF="021586.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Fwd: Squid 4.8 with OpenSSL 1.1.1d</H1>
    <B>John Sweet-Escott</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Fwd%3A%20Squid%204.8%20with%20OpenSSL%201.1.1d&In-Reply-To=%3C1A113AB5-AD03-4F7F-A188-2BA0BAF18DA0%40gmail.com%3E"
       TITLE="[squid-users] Fwd: Squid 4.8 with OpenSSL 1.1.1d">eype69 at gmail.com
       </A><BR>
    <I>Thu Jan  9 13:08:07 UTC 2020</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="021595.html">[squid-users] Fwd: Squid 4.8 with OpenSSL 1.1.1d
</A></li>
        <LI>Next message (by thread): <A HREF="021586.html">[squid-users] Question: Force the caching of 302 responses without Expires header and with Strict-Transport-Security max-age header?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21599">[ date ]</a>
              <a href="thread.html#21599">[ thread ]</a>
              <a href="subject.html#21599">[ subject ]</a>
              <a href="author.html#21599">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Alex

Really looking forward to this patch being submitted and hopefully accepted. Let me know if it would be helpful for me to do some independent testing of the patch. 

John 

&gt;<i> On 6 Jan 2020, at 14:53, Alex Rousskov &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt; wrote:
</I>&gt;<i> 
</I>&gt;<i> &#65279;On 1/3/20 8:40 AM, Yaroslav Pushko wrote:
</I>&gt;<i> 
</I>&gt;&gt;<i> During establishing TLSv1.3 handshake after successfully send our Client
</I>&gt;&gt;<i> Hello, the server answers us with Hello Retry Request.
</I>&gt;<i> 
</I>&gt;<i> HelloRetryRequest is a TLS v1.3 feature that tells the client to restart
</I>&gt;<i> the negotiation (with additional info). Please keep in mind that:
</I>&gt;<i> 
</I>&gt;<i> 1. If Squid peeks at TLS v1.3 data from the server, bumping the
</I>&gt;<i> connection is likely to be impossible. Since plain text TLS v1.3 server
</I>&gt;<i> bytes should not contain useful information, and encrypted TLS v1.3
</I>&gt;<i> server bytes are useless for a peeking transaction (and deadly for a
</I>&gt;<i> bumping transaction), the decision to bump such a transaction has to be
</I>&gt;<i> done no later than step2 (i.e. no later than after receiving TLS Client
</I>&gt;<i> Hello).
</I>&gt;<i> 
</I>&gt;<i> 2. Squid TLS parser does not know about TLS v1.3 HelloRetryRequest
</I>&gt;<i> messages yet. Thus, if Squid is asked to parse from-server traffic
</I>&gt;<i> containing that message, Squid may not do what it should do (whatever
</I>&gt;<i> that is).
</I>&gt;<i> 
</I>&gt;<i> The changes discussed earlier in this email thread do not include adding
</I>&gt;<i> support for HelloRetryRequest, but they may help with the overall
</I>&gt;<i> situation by correctly identifying TLS v1.3 traffic. I think we are very
</I>&gt;<i> close to submitting an official pull request with these changes.
</I>&gt;<i> 
</I>&gt;<i> HTH,
</I>&gt;<i> 
</I>&gt;<i> Alex.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> In Squid this behavior interprets next Client Hello peek
</I>&gt;&gt;<i> successfully and Hello Retry Request peeks as Server Hello.
</I>&gt;&gt;<i> After that, we splice it and send to OpenSSL and fail handshake
</I>&gt;&gt;<i> establishing.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> Did you already notice such behavior? 
</I>&gt;&gt;<i> Did you have some investigation on this issue, any advice will be pleasant?
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> Best regards,
</I>&gt;&gt;<i> Yaroslav.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> On Tue, Dec 17, 2019 at 4:39 PM Alex Rousskov wrote:
</I>&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i>    On 12/17/19 9:00 AM, Yaroslav Pushko wrote:
</I>&gt;&gt;&gt;<i> Hi All
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> We use Squid 4.8 with OpenSSL 1.1.1d in a transparent mode for
</I>&gt;&gt;<i>    peek and
</I>&gt;&gt;&gt;<i> splice interception.
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> With this version, we lost the possibility to connect to any HTTPS
</I>&gt;&gt;<i>    site.
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> There are a few issues: 
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i>    * support TLSv1.2 sites (already discussed in
</I>&gt;&gt;&gt;<i>    
</I>&gt;&gt;<i>     thread <A HREF="http://squid-web-proxy-cache.1019090.n4.nabble.com/Problem-with-ssl-choose-client-version-inappropriate-fallback-on-some-sites-when-using-TLS1-2-td4688258.html">http://squid-web-proxy-cache.1019090.n4.nabble.com/Problem-with-ssl-choose-client-version-inappropriate-fallback-on-some-sites-when-using-TLS1-2-td4688258.html</A> )
</I>&gt;&gt;&gt;<i>    * support TLSv1.3 sites.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i>    Please see
</I>&gt;&gt;<i>    <A HREF="http://lists.squid-cache.org/pipermail/squid-users/2019-December/021435.html">http://lists.squid-cache.org/pipermail/squid-users/2019-December/021435.html</A>
</I>&gt;&gt;<i>    for several alternative fixes. AFAICT, those fixes are more flexible
</I>&gt;&gt;<i>    and, after polishing, appropriate for the official inclusion because
</I>&gt;&gt;<i>    they make fewer assumptions about the values sent via the supported
</I>&gt;&gt;<i>    versions extension.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i>    It is possible that your SSL_MODE_SEND_FALLBACK_SCSV change needs to be
</I>&gt;&gt;<i>    integrated with the other fixes. Thank you for sharing that idea!
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i>    Alex.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> Support TLSv1.2.
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i>      OpenSSL 1.1.1d adds support of TLSv1.3. These changes added some
</I>&gt;&gt;&gt;<i>      kind of guard if we perform a handshake with a lower version
</I>&gt;&gt;<i>    of the
</I>&gt;&gt;&gt;<i>      TLS protocol than we support. In this scenario, we receive
</I>&gt;&gt;<i>    downgrade
</I>&gt;&gt;&gt;<i>      fallback error.
</I>&gt;&gt;&gt;<i>      Handshake version TLSv1.2 vs. max support TLSv1.3.
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i>      In such case, we have the next error:
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i>          ERROR: negotiating TLS on FD 19: error:1425F175:SSL
</I>&gt;&gt;&gt;<i>          routines:ssl_choose_client_version:inappropriate fallback
</I>&gt;&gt;<i>    (1/-1/0)
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i>      OpenSSL already provided a fix for it. You can configure SSL
</I>&gt;&gt;<i>    session
</I>&gt;&gt;&gt;<i>      to use option SSL_MODE_SEND_FALLBACK_SCSV and setting SSL max
</I>&gt;&gt;<i>    proto
</I>&gt;&gt;&gt;<i>      version for current SSL session, but squid not yet supported these
</I>&gt;&gt;&gt;<i>      features.
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i>      You can find a patch in the attachments, will be grateful for the
</I>&gt;&gt;&gt;<i>      review.
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> The issue with TLS 1.3 support, we are still investigating, any advice
</I>&gt;&gt;&gt;<i> will be pleasant.
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> Best regards,
</I>&gt;&gt;&gt;<i> Yaroslav Pushko.
</I>&gt;&gt;&gt;<i> -- 
</I>&gt;&gt;&gt;<i> Best Regards,
</I>&gt;&gt;&gt;<i> Yaroslav Pushko | Senior *Software Engineer*
</I>&gt;&gt;&gt;<i> GlobalLogic
</I>&gt;&gt;&gt;<i> P +380971842774  M +380634232226 S dithard
</I>&gt;&gt;&gt;<i> www.globallogic.com &lt;<A HREF="http://www.globallogic.com">http://www.globallogic.com</A>&gt;
</I>&gt;&gt;<i>    &lt;<A HREF="http://www.globallogic.com/">http://www.globallogic.com/</A>&gt;
</I>&gt;&gt;&gt;<i> <A HREF="http://www.globallogic.com/email_disclaimer.txt">http://www.globallogic.com/email_disclaimer.txt</A>
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;&gt;<i> squid-users mailing list
</I>&gt;&gt;&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;&gt;<i>    &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>&gt;
</I>&gt;&gt;&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> -- 
</I>&gt;&gt;<i> Best Regards,
</I>&gt;&gt;<i> Yaroslav Pushko | Senior *Software Engineer*
</I>&gt;&gt;<i> GlobalLogic
</I>&gt;&gt;<i> P +380971842774  M +380634232226 S dithard
</I>&gt;&gt;<i> www.globallogic.com &lt;<A HREF="http://www.globallogic.com/">http://www.globallogic.com/</A>&gt;
</I>&gt;&gt;<i> &lt;<A HREF="http://www.globallogic.com/">http://www.globallogic.com/</A>&gt;
</I>&gt;&gt;<i> <A HREF="http://www.globallogic.com/email_disclaimer.txt">http://www.globallogic.com/email_disclaimer.txt</A>
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="021595.html">[squid-users] Fwd: Squid 4.8 with OpenSSL 1.1.1d
</A></li>
	<LI>Next message (by thread): <A HREF="021586.html">[squid-users] Question: Force the caching of 302 responses without Expires header and with Strict-Transport-Security max-age header?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21599">[ date ]</a>
              <a href="thread.html#21599">[ thread ]</a>
              <a href="subject.html#21599">[ subject ]</a>
              <a href="author.html#21599">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
