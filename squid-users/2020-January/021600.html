<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] squid-cache proxy which does it all
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid-cache%20proxy%20which%20does%20it%20all&In-Reply-To=%3Cd05fa165-e8f4-2cc0-595c-de76f389a240%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="021597.html">
   <LINK REL="Next"  HREF="021602.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] squid-cache proxy which does it all</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid-cache%20proxy%20which%20does%20it%20all&In-Reply-To=%3Cd05fa165-e8f4-2cc0-595c-de76f389a240%40treenet.co.nz%3E"
       TITLE="[squid-users] squid-cache proxy which does it all">squid3 at treenet.co.nz
       </A><BR>
    <I>Thu Jan  9 19:00:13 UTC 2020</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="021597.html">[squid-users] squid-cache proxy which does it all
</A></li>
        <LI>Next message (by thread): <A HREF="021602.html">[squid-users] squid-cache proxy which does it all
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21600">[ date ]</a>
              <a href="thread.html#21600">[ thread ]</a>
              <a href="subject.html#21600">[ subject ]</a>
              <a href="author.html#21600">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 9/01/20 8:34 pm, robert k Wild wrote:
&gt;<i> hi all,
</I>&gt;<i> 
</I>&gt;<i> I have made a script for squid that installs the following &#8211;
</I>&gt;<i> 
</I>&gt;<i> Squid &#8211; http proxy server
</I>&gt;<i> Squid ssl-bump &#8211; https interception for squid
</I>&gt;<i> C-ICAP &#8211; icap server
</I>&gt;<i> clamAV &#8211; AV engine to detect trojan viruses malware etc
</I>&gt;<i> squidclamav &#8211; to make it all integrated with squid
</I>&gt;<i> 
</I>&gt;<i> what do you think?
</I>&gt;<i> 
</I>&gt;<i> #!/bin/bash
</I>&gt;<i> #squid on DMZ host
</I>&gt;<i> #
</I>&gt;<i> #first things first lets disable firewalld and SElinux
</I>&gt;<i> #
</I>&gt;<i> systemctl stop firewalld
</I>&gt;<i> systemctl disable firewalld
</I>&gt;<i> sed -i -e 's/SELINUX=enforcing/SELINUX=disabled/g' /etc/selinux/config
</I>&gt;<i> #
</I>
Why?



&gt;<i> #squid packages
</I>&gt;<i> #
</I>&gt;<i> yum install -y epel-release swaks sed tar zip unzip curl telnet openssl
</I>&gt;<i> openssl-devel bzip2-devel libarchive libarchive-devel perl
</I>&gt;<i> perl-Data-Dumper gcc gcc-c++ binutils autoconf automake make sudo wget
</I>&gt;<i> libxml2-devel libcap-devel libtool-ltdl-devel
</I>&gt;<i> #
</I>&gt;<i> #clamAV packages
</I>&gt;<i> #
</I>&gt;<i> yum install -y clamav-server clamav-data clamav-update clamav-filesystem
</I>&gt;<i> clamav clamav-scanner-systemd clamav-devel clamav-lib clamav-server-systemd
</I>&gt;<i> #
</I>&gt;<i> #download and compile from source
</I>&gt;<i> #
</I>&gt;<i> cd /tmp
</I>&gt;<i> wget <A HREF="http://www.squid-cache.org/Versions/v4/squid-4.9.tar.gz">http://www.squid-cache.org/Versions/v4/squid-4.9.tar.gz</A>
</I>
Please use rsync for this, and verify against the *.asc file signature
that you got the file correctly.

&gt;<i> wget
</I>&gt;<i> <A HREF="http://sourceforge.net/projects/c-icap/files/c-icap/0.5.x/c_icap-0.5.6.tar.gz">http://sourceforge.net/projects/c-icap/files/c-icap/0.5.x/c_icap-0.5.6.tar.gz</A>
</I>&gt;<i> wget
</I>&gt;<i> <A HREF="http://sourceforge.net/projects/c-icap/files/c-icap-modules/0.5.x/c_icap_modules-0.5.4.tar.gz">http://sourceforge.net/projects/c-icap/files/c-icap-modules/0.5.x/c_icap_modules-0.5.4.tar.gz</A>
</I>&gt;<i> wget
</I>&gt;<i> <A HREF="https://sourceforge.net/projects/squidclamav/files/squidclamav/7.1/squidclamav-7.1.tar.gz">https://sourceforge.net/projects/squidclamav/files/squidclamav/7.1/squidclamav-7.1.tar.gz</A>
</I>&gt;<i> for f in *.tar.gz; do tar xf &quot;$f&quot;; done
</I>&gt;<i> cd /tmp/squid-4.9
</I>&gt;<i> ./configure --with-openssl --enable-ssl-crtd --enable-icap-client &amp;&amp;
</I>&gt;<i> make &amp;&amp; make install
</I>&gt;<i> #
</I>
IIRC this was a CentoOS machine right?
If so, see &lt;<A HREF="https://wiki.squid-cache.org/KnowledgeBase/CentOS#Compiling">https://wiki.squid-cache.org/KnowledgeBase/CentOS#Compiling</A>&gt;
otherwise see the equivalent wiki page for your chosen OS compile.

Those settings install Squid as a system application. So no need for the
/usr/local stuff.


&gt;<i> cd /tmp/c_icap-0.5.6
</I>&gt;<i> ./configure 'CXXFLAGS=-O2 -m64 -pipe' 'CFLAGS=-O2 -m64 -pipe'
</I>&gt;<i> --without-bdb --prefix=/usr/local &amp;&amp; make &amp;&amp; make install
</I>&gt;<i> #
</I>&gt;<i> cd /tmp/squidclamav-7.1
</I>&gt;<i> ./configure 'CXXFLAGS=-O2 -m64 -pipe' 'CFLAGS=-O2 -m64 -pipe'
</I>&gt;<i> --with-c-icap=/usr/local --with-libarchive &amp;&amp; make &amp;&amp; make install
</I>&gt;<i> #
</I>&gt;<i> cd /tmp/c_icap_modules-0.5.4
</I>&gt;<i> ./configure 'CFLAGS=-O3 -m64 -pipe'
</I>&gt;<i> 'CPPFLAGS=-I/usr/local/clamav/include' 'LDFLAGS=-L/usr/local/lib
</I>&gt;<i> -L/usr/local/clamav/lib/' &amp;&amp; make &amp;&amp; make install
</I>&gt;<i> #
</I>&gt;<i> #creating shortcuts and copying files
</I>&gt;<i> #
</I>&gt;<i> cp -f /usr/local/squid/etc/squid.conf /usr/local/squid/etc/squid.conf.orig
</I>&gt;<i> cp -f /usr/local/etc/c-icap.conf /usr/local/etc/c-icap.conf.orig
</I>&gt;<i> cp -f /usr/local/etc/squidclamav.conf /usr/local/etc/squidclamav.conf.orig
</I>&gt;<i> cp -f /usr/local/etc/clamav_mod.conf /usr/local/etc/clamav_mod.conf.orig
</I>&gt;<i> cp -f /usr/local/etc/virus_scan.conf /usr/local/etc/virus_scan.conf.orig
</I>&gt;<i> #
</I>&gt;<i> ln -s /usr/local/squid/etc/squid.conf /etc
</I>&gt;<i> ln -s /usr/local/etc/c-icap.conf /etc
</I>&gt;<i> ln -s /usr/local/etc/squidclamav.conf /etc
</I>&gt;<i> ln -s /usr/local/etc/clamav_mod.conf /etc
</I>&gt;<i> ln -s /usr/local/etc/virus_scan.conf /etc
</I>&gt;<i> #
</I>&gt;<i> mkdir -p /usr/local/clamav/share/clamav
</I>&gt;<i> ln -s /var/lib/clamav /usr/local/clamav/share/clamav
</I>&gt;<i> #
</I>&gt;<i> #tmpfiles for run files
</I>&gt;<i> #
</I>&gt;<i> echo &quot;d /var/run/c-icap 0755 root root -&quot; &gt;&gt; /etc/tmpfiles.d/c-icap.conf
</I>&gt;<i> echo &quot;d /var/run/clamav 0755 root root -&quot; &gt;&gt; /etc/tmpfiles.d/clamav.conf
</I>&gt;<i> #
</I>&gt;<i> #delete a few lines in squid
</I>&gt;<i> #
</I>&gt;<i> sed -i '/http_port 3128/d' /usr/local/squid/etc/squid.conf
</I>&gt;<i> sed -i '/http_access deny all/d' /usr/local/squid/etc/squid.conf
</I>
Please do not remove that second line from yoru squid.conf. It will
result in unpredictable default allow/deny behaviour from your proxy.

Instead I recommend (mind the wrap):

 sed -i '/# INSERT YOUR OWN RULE(S) HERE TO ALLOW ACCESS FROM YOUR
CLIENTS/include &quot;/etc/squid/squid.conf.d/*&quot;/'
/usr/local/squid/etc/squid.conf

Then you can just drop files into the /etc/squid/squid.conf.d/ directory
and they will be loaded as config on next start or reconfigure.



HTH
Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="021597.html">[squid-users] squid-cache proxy which does it all
</A></li>
	<LI>Next message (by thread): <A HREF="021602.html">[squid-users] squid-cache proxy which does it all
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21600">[ date ]</a>
              <a href="thread.html#21600">[ thread ]</a>
              <a href="subject.html#21600">[ subject ]</a>
              <a href="author.html#21600">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
