<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] squid-cache proxy which does it all
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid-cache%20proxy%20which%20does%20it%20all&In-Reply-To=%3CCAGU_CiJHFJOK4%3Dgo53eYbtpB4v-NAz-URy379uE-m-N1pTeQNA%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="021600.html">
   <LINK REL="Next"  HREF="021598.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] squid-cache proxy which does it all</H1>
    <B>robert k Wild</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid-cache%20proxy%20which%20does%20it%20all&In-Reply-To=%3CCAGU_CiJHFJOK4%3Dgo53eYbtpB4v-NAz-URy379uE-m-N1pTeQNA%40mail.gmail.com%3E"
       TITLE="[squid-users] squid-cache proxy which does it all">robertkwild at gmail.com
       </A><BR>
    <I>Thu Jan  9 19:42:51 UTC 2020</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="021600.html">[squid-users] squid-cache proxy which does it all
</A></li>
        <LI>Next message (by thread): <A HREF="021598.html">[squid-users] icap SOPHOS SAVDI and custom errorpage
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21602">[ date ]</a>
              <a href="thread.html#21602">[ thread ]</a>
              <a href="subject.html#21602">[ subject ]</a>
              <a href="author.html#21602">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>thanks for this Amos, really appreciate it :)

On Thu, 9 Jan 2020 at 19:00, Amos Jeffries &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt; wrote:

&gt;<i> On 9/01/20 8:34 pm, robert k Wild wrote:
</I>&gt;<i> &gt; hi all,
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I have made a script for squid that installs the following &#8211;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Squid &#8211; http proxy server
</I>&gt;<i> &gt; Squid ssl-bump &#8211; https interception for squid
</I>&gt;<i> &gt; C-ICAP &#8211; icap server
</I>&gt;<i> &gt; clamAV &#8211; AV engine to detect trojan viruses malware etc
</I>&gt;<i> &gt; squidclamav &#8211; to make it all integrated with squid
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; what do you think?
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; #!/bin/bash
</I>&gt;<i> &gt; #squid on DMZ host
</I>&gt;<i> &gt; #
</I>&gt;<i> &gt; #first things first lets disable firewalld and SElinux
</I>&gt;<i> &gt; #
</I>&gt;<i> &gt; systemctl stop firewalld
</I>&gt;<i> &gt; systemctl disable firewalld
</I>&gt;<i> &gt; sed -i -e 's/SELINUX=enforcing/SELINUX=disabled/g' /etc/selinux/config
</I>&gt;<i> &gt; #
</I>&gt;<i>
</I>&gt;<i> Why?
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; #squid packages
</I>&gt;<i> &gt; #
</I>&gt;<i> &gt; yum install -y epel-release swaks sed tar zip unzip curl telnet openssl
</I>&gt;<i> &gt; openssl-devel bzip2-devel libarchive libarchive-devel perl
</I>&gt;<i> &gt; perl-Data-Dumper gcc gcc-c++ binutils autoconf automake make sudo wget
</I>&gt;<i> &gt; libxml2-devel libcap-devel libtool-ltdl-devel
</I>&gt;<i> &gt; #
</I>&gt;<i> &gt; #clamAV packages
</I>&gt;<i> &gt; #
</I>&gt;<i> &gt; yum install -y clamav-server clamav-data clamav-update clamav-filesystem
</I>&gt;<i> &gt; clamav clamav-scanner-systemd clamav-devel clamav-lib
</I>&gt;<i> clamav-server-systemd
</I>&gt;<i> &gt; #
</I>&gt;<i> &gt; #download and compile from source
</I>&gt;<i> &gt; #
</I>&gt;<i> &gt; cd /tmp
</I>&gt;<i> &gt; wget <A HREF="http://www.squid-cache.org/Versions/v4/squid-4.9.tar.gz">http://www.squid-cache.org/Versions/v4/squid-4.9.tar.gz</A>
</I>&gt;<i>
</I>&gt;<i> Please use rsync for this, and verify against the *.asc file signature
</I>&gt;<i> that you got the file correctly.
</I>&gt;<i>
</I>&gt;<i> &gt; wget
</I>&gt;<i> &gt;
</I>&gt;<i> <A HREF="http://sourceforge.net/projects/c-icap/files/c-icap/0.5.x/c_icap-0.5.6.tar.gz">http://sourceforge.net/projects/c-icap/files/c-icap/0.5.x/c_icap-0.5.6.tar.gz</A>
</I>&gt;<i> &gt; wget
</I>&gt;<i> &gt;
</I>&gt;<i> <A HREF="http://sourceforge.net/projects/c-icap/files/c-icap-modules/0.5.x/c_icap_modules-0.5.4.tar.gz">http://sourceforge.net/projects/c-icap/files/c-icap-modules/0.5.x/c_icap_modules-0.5.4.tar.gz</A>
</I>&gt;<i> &gt; wget
</I>&gt;<i> &gt;
</I>&gt;<i> <A HREF="https://sourceforge.net/projects/squidclamav/files/squidclamav/7.1/squidclamav-7.1.tar.gz">https://sourceforge.net/projects/squidclamav/files/squidclamav/7.1/squidclamav-7.1.tar.gz</A>
</I>&gt;<i> &gt; for f in *.tar.gz; do tar xf &quot;$f&quot;; done
</I>&gt;<i> &gt; cd /tmp/squid-4.9
</I>&gt;<i> &gt; ./configure --with-openssl --enable-ssl-crtd --enable-icap-client &amp;&amp;
</I>&gt;<i> &gt; make &amp;&amp; make install
</I>&gt;<i> &gt; #
</I>&gt;<i>
</I>&gt;<i> IIRC this was a CentoOS machine right?
</I>&gt;<i> If so, see &lt;<A HREF="https://wiki.squid-cache.org/KnowledgeBase/CentOS#Compiling">https://wiki.squid-cache.org/KnowledgeBase/CentOS#Compiling</A>&gt;
</I>&gt;<i> otherwise see the equivalent wiki page for your chosen OS compile.
</I>&gt;<i>
</I>&gt;<i> Those settings install Squid as a system application. So no need for the
</I>&gt;<i> /usr/local stuff.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; cd /tmp/c_icap-0.5.6
</I>&gt;<i> &gt; ./configure 'CXXFLAGS=-O2 -m64 -pipe' 'CFLAGS=-O2 -m64 -pipe'
</I>&gt;<i> &gt; --without-bdb --prefix=/usr/local &amp;&amp; make &amp;&amp; make install
</I>&gt;<i> &gt; #
</I>&gt;<i> &gt; cd /tmp/squidclamav-7.1
</I>&gt;<i> &gt; ./configure 'CXXFLAGS=-O2 -m64 -pipe' 'CFLAGS=-O2 -m64 -pipe'
</I>&gt;<i> &gt; --with-c-icap=/usr/local --with-libarchive &amp;&amp; make &amp;&amp; make install
</I>&gt;<i> &gt; #
</I>&gt;<i> &gt; cd /tmp/c_icap_modules-0.5.4
</I>&gt;<i> &gt; ./configure 'CFLAGS=-O3 -m64 -pipe'
</I>&gt;<i> &gt; 'CPPFLAGS=-I/usr/local/clamav/include' 'LDFLAGS=-L/usr/local/lib
</I>&gt;<i> &gt; -L/usr/local/clamav/lib/' &amp;&amp; make &amp;&amp; make install
</I>&gt;<i> &gt; #
</I>&gt;<i> &gt; #creating shortcuts and copying files
</I>&gt;<i> &gt; #
</I>&gt;<i> &gt; cp -f /usr/local/squid/etc/squid.conf
</I>&gt;<i> /usr/local/squid/etc/squid.conf.orig
</I>&gt;<i> &gt; cp -f /usr/local/etc/c-icap.conf /usr/local/etc/c-icap.conf.orig
</I>&gt;<i> &gt; cp -f /usr/local/etc/squidclamav.conf
</I>&gt;<i> /usr/local/etc/squidclamav.conf.orig
</I>&gt;<i> &gt; cp -f /usr/local/etc/clamav_mod.conf /usr/local/etc/clamav_mod.conf.orig
</I>&gt;<i> &gt; cp -f /usr/local/etc/virus_scan.conf /usr/local/etc/virus_scan.conf.orig
</I>&gt;<i> &gt; #
</I>&gt;<i> &gt; ln -s /usr/local/squid/etc/squid.conf /etc
</I>&gt;<i> &gt; ln -s /usr/local/etc/c-icap.conf /etc
</I>&gt;<i> &gt; ln -s /usr/local/etc/squidclamav.conf /etc
</I>&gt;<i> &gt; ln -s /usr/local/etc/clamav_mod.conf /etc
</I>&gt;<i> &gt; ln -s /usr/local/etc/virus_scan.conf /etc
</I>&gt;<i> &gt; #
</I>&gt;<i> &gt; mkdir -p /usr/local/clamav/share/clamav
</I>&gt;<i> &gt; ln -s /var/lib/clamav /usr/local/clamav/share/clamav
</I>&gt;<i> &gt; #
</I>&gt;<i> &gt; #tmpfiles for run files
</I>&gt;<i> &gt; #
</I>&gt;<i> &gt; echo &quot;d /var/run/c-icap 0755 root root -&quot; &gt;&gt; /etc/tmpfiles.d/c-icap.conf
</I>&gt;<i> &gt; echo &quot;d /var/run/clamav 0755 root root -&quot; &gt;&gt; /etc/tmpfiles.d/clamav.conf
</I>&gt;<i> &gt; #
</I>&gt;<i> &gt; #delete a few lines in squid
</I>&gt;<i> &gt; #
</I>&gt;<i> &gt; sed -i '/http_port 3128/d' /usr/local/squid/etc/squid.conf
</I>&gt;<i> &gt; sed -i '/http_access deny all/d' /usr/local/squid/etc/squid.conf
</I>&gt;<i>
</I>&gt;<i> Please do not remove that second line from yoru squid.conf. It will
</I>&gt;<i> result in unpredictable default allow/deny behaviour from your proxy.
</I>&gt;<i>
</I>&gt;<i> Instead I recommend (mind the wrap):
</I>&gt;<i>
</I>&gt;<i>  sed -i '/# INSERT YOUR OWN RULE(S) HERE TO ALLOW ACCESS FROM YOUR
</I>&gt;<i> CLIENTS/include &quot;/etc/squid/squid.conf.d/*&quot;/'
</I>&gt;<i> /usr/local/squid/etc/squid.conf
</I>&gt;<i>
</I>&gt;<i> Then you can just drop files into the /etc/squid/squid.conf.d/ directory
</I>&gt;<i> and they will be loaded as config on next start or reconfigure.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> HTH
</I>&gt;<i> Amos
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i>
</I>

-- 
Regards,

Robert K Wild.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20200109/4ef69df3/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20200109/4ef69df3/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="021600.html">[squid-users] squid-cache proxy which does it all
</A></li>
	<LI>Next message (by thread): <A HREF="021598.html">[squid-users] icap SOPHOS SAVDI and custom errorpage
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21602">[ date ]</a>
              <a href="thread.html#21602">[ thread ]</a>
              <a href="subject.html#21602">[ subject ]</a>
              <a href="author.html#21602">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
