<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] follow_x_forwarded_for to get client ip instead of sibling proxy
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20follow_x_forwarded_for%20to%20get%20client%20ip%20instead%0A%20of%20sibling%20proxy&In-Reply-To=%3Cb9207af5-5aa6-b939-01a6-de18b4cd1d96%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="021646.html">
   <LINK REL="Next"  HREF="021650.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] follow_x_forwarded_for to get client ip instead of sibling proxy</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20follow_x_forwarded_for%20to%20get%20client%20ip%20instead%0A%20of%20sibling%20proxy&In-Reply-To=%3Cb9207af5-5aa6-b939-01a6-de18b4cd1d96%40measurement-factory.com%3E"
       TITLE="[squid-users] follow_x_forwarded_for to get client ip instead of sibling proxy">rousskov at measurement-factory.com
       </A><BR>
    <I>Thu Jan 16 16:47:54 UTC 2020</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="021646.html">[squid-users] follow_x_forwarded_for to get client ip instead of	sibling proxy
</A></li>
        <LI>Next message (by thread): <A HREF="021650.html">[squid-users] follow_x_forwarded_for to get client ip instead of sibling proxy
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21648">[ date ]</a>
              <a href="thread.html#21648">[ thread ]</a>
              <a href="subject.html#21648">[ subject ]</a>
              <a href="author.html#21648">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 1/16/20 9:59 AM, robert k Wild wrote:

&gt;<i> i have two proxies (one sibling going to a parent)
</I>
FYI: &quot;siblings&quot; are proxies that fetch hits from each other. The proxy
&quot;going to the parent&quot; is usually called a &quot;child&quot; proxy:

    clients -&gt; child -&gt; parent -&gt; servers


&gt;<i> when i look at the parent proxy access logs, it just logs the ip address
</I>&gt;<i> of the sibling proxy
</I>&gt;<i> 
</I>&gt;<i> if i add the lines below in my sibling proxy
</I>&gt;<i> 
</I>&gt;<i> acl localhost src 127.0.0.1
</I>&gt;<i> acl my_other_proxy srcdomain .proxy.example.com
</I>&gt;<i> follow_x_forwarded_for allow localhost
</I>&gt;<i> follow_x_forwarded_for allow my_other_proxy
</I>&gt;<i> 
</I>&gt;<i> when i next look at the logs, will it show the ip of my clients?
</I>

No, it will not (by default) AFAICT. For the parent proxy logs to
contain IP addresses of the clients,

a) The child proxy must send the X-Forwarded-For header to the parent.
b) The parent proxy must trust X-Forwarded-For received from the child
   (as far as logging is concerned).

Your configuration changes at the child proxy do neither (a) nor (b).

IIRC, (a) will happen by default, while (b) requires
follow_x_forwarded_for and log_uses_indirect_client rules at the parent
proxy.

 I did not review your follow_x_forwarded_for rules.

The follow_x_forwarded_for rules at the child proxy are needed if and
only if you want the child proxy to trust the X-Forwarded-For headers
received by that child proxy (from its clients). That is only necessary
in deeper hierarchies:

    clients -&gt; child1 -&gt; child2 -&gt; parent

Alex.

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="021646.html">[squid-users] follow_x_forwarded_for to get client ip instead of	sibling proxy
</A></li>
	<LI>Next message (by thread): <A HREF="021650.html">[squid-users] follow_x_forwarded_for to get client ip instead of sibling proxy
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21648">[ date ]</a>
              <a href="thread.html#21648">[ thread ]</a>
              <a href="subject.html#21648">[ subject ]</a>
              <a href="author.html#21648">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
