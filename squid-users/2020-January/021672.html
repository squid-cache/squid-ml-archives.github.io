<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Fail and empty response instead cached resource
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Fail%20and%20empty%20response%20instead%20cached%20resource&In-Reply-To=%3CAM7PR09MB3798C2374CC6543D287111E4800D0%40AM7PR09MB3798.eurprd09.prod.outlook.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="021683.html">
   <LINK REL="Next"  HREF="021673.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Fail and empty response instead cached resource</H1>
    <B>Kuznetsov Sergei</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Fail%20and%20empty%20response%20instead%20cached%20resource&In-Reply-To=%3CAM7PR09MB3798C2374CC6543D287111E4800D0%40AM7PR09MB3798.eurprd09.prod.outlook.com%3E"
       TITLE="[squid-users] Fail and empty response instead cached resource">skz169 at outlook.com
       </A><BR>
    <I>Tue Jan 21 09:36:25 UTC 2020</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="021683.html">[squid-users] squid and netdata causes squid to drop SYN?
</A></li>
        <LI>Next message (by thread): <A HREF="021673.html">[squid-users] Fail and empty response instead cached resource
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21672">[ date ]</a>
              <a href="thread.html#21672">[ thread ]</a>
              <a href="subject.html#21672">[ subject ]</a>
              <a href="author.html#21672">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello

I run Squid 4.9 in non transparent mode with OPNsense (FreeBSD 
11.2-RELEASE-p16-HBSD FreeBSD 11.2-RELEASE-p16-HBSD 
87a7fc985c3(stable/19.7)&#160; amd64).

Everything works except access to one website.

Squid startup log is clean:

&gt;<i> 2020/01/21 13:56:43 kid1| Startup: Initializing Authentication Schemes ...
</I>&gt;<i> 2020/01/21 13:56:43 kid1| Startup: Initialized Authentication Scheme 
</I>&gt;<i> 'basic'
</I>&gt;<i> 2020/01/21 13:56:43 kid1| Startup: Initialized Authentication Scheme 
</I>&gt;<i> 'digest'
</I>&gt;<i> 2020/01/21 13:56:43 kid1| Startup: Initialized Authentication Scheme 
</I>&gt;<i> 'negotiate'
</I>&gt;<i> 2020/01/21 13:56:43 kid1| Startup: Initialized Authentication Scheme 
</I>&gt;<i> 'ntlm'
</I>&gt;<i> 2020/01/21 13:56:43 kid1| Startup: Initialized Authentication.
</I>&gt;<i> 2020/01/21 13:56:43 kid1| Processing Configuration File: 
</I>&gt;<i> /usr/local/etc/squid/squid.conf (depth 0)
</I>&gt;<i> 2020/01/21 13:56:43 kid1| Processing Configuration File: 
</I>&gt;<i> /usr/local/etc/squid/pre-auth/40-snmp.conf (depth 1)
</I>&gt;<i> 2020/01/21 13:56:43 kid1| Processing Configuration File: 
</I>&gt;<i> /usr/local/etc/squid/pre-auth/dummy.conf (depth 1)
</I>&gt;<i> 2020/01/21 13:56:43 kid1| Processing Configuration File: 
</I>&gt;<i> /usr/local/etc/squid/pre-auth/parentproxy.conf (depth 1)
</I>&gt;<i> 2020/01/21 13:56:43 kid1| Processing Configuration File: 
</I>&gt;<i> /usr/local/etc/squid/auth/ProxyUserACL.conf (depth 1)
</I>&gt;<i> 2020/01/21 13:56:43 kid1| Processing Configuration File: 
</I>&gt;<i> /usr/local/etc/squid/auth/dummy.conf (depth 1)
</I>&gt;<i> 2020/01/21 13:56:43 kid1| Processing Configuration File: 
</I>&gt;<i> /usr/local/etc/squid/post-auth/dummy.conf (depth 1)
</I>&gt;<i> 2020/01/21 13:56:43 kid1| Initializing <A HREF="https://">https://</A> proxy context
</I>&gt;<i> 2020/01/21 13:56:43 kid1| Logfile: opening log 
</I>&gt;<i> stdio:/var/log/squid/access.log
</I>&gt;<i> 2020/01/21 13:56:43 kid1| Squid plugin modules loaded: 0
</I>&gt;<i> 2020/01/21 13:56:43 kid1| Adaptation support is off.
</I>&gt;<i> 2020/01/21 13:56:43 kid1| Logfile: opening log 
</I>&gt;<i> stdio:/var/log/squid/store.log
</I>&gt;<i> 2020/01/21 13:56:43 kid1| DNS Socket created at [::], FD 9
</I>&gt;<i> 2020/01/21 13:56:43 kid1| DNS Socket created at 0.0.0.0, FD 11
</I>&gt;<i> 2020/01/21 13:56:43 kid1| Adding nameserver 127.0.0.1 from squid.conf
</I>&gt;<i> 2020/01/21 13:56:43 kid1| HTCP Disabled.
</I>&gt;<i> 2020/01/21 13:56:43 kid1| Pinger socket opened on FD 15
</I>&gt;<i> 2020/01/21 13:56:43 kid1| Finished loading MIME types and icons.
</I>&gt;<i> 2020/01/21 13:56:43 kid1| Accepting HTTP Socket connections at 
</I>&gt;<i> local=192.168.0.4:3128 remote=[::] FD 12 flags=9
</I>&gt;<i> 2020/01/21 13:56:43| pinger: Initialising ICMP pinger ...
</I>&gt;<i> 2020/01/21 13:56:43| pinger: ICMP socket opened.
</I>&gt;<i> 2020/01/21 13:56:43| pinger: ICMPv6 socket opened
</I>&gt;<i> 2020/01/21 13:59:54 kid1| Logfile: opening log 
</I>&gt;<i> stdio:/var/squid/cache/netdb.state
</I>&gt;<i> 2020/01/21 13:59:54 kid1| Logfile: closing log 
</I>&gt;<i> stdio:/var/squid/cache/netdb.state
</I>&gt;<i> 2020/01/21 13:59:54 kid1| NETDB state saved; 680 entries, 7 msec
</I>

When I make a request for the first time, everything is fine and I get 
correct result.

&gt;<i> curl --proxy 192.168.0.4:3128 -v -O 
</I>&gt;<i> <A HREF="http://tehspb.kodeks.ru/js/jquery-1.4.2.min.js">http://tehspb.kodeks.ru/js/jquery-1.4.2.min.js</A>
</I>&gt;<i> * STATE: INIT =&gt; CONNECT handle 0x600092d68; line 1491 (connection #-5000)
</I>&gt;<i> * Added connection 0. The cache now contains 1 members
</I>&gt;<i> *&#160;&#160; Trying 192.168.0.4:3128...
</I>&gt;<i> * TCP_NODELAY set
</I>&gt;<i> * STATE: CONNECT =&gt; WAITCONNECT handle 0x600092d68; line 1547 
</I>&gt;<i> (connection #0)
</I>&gt;<i> * Connected to 192.168.0.4 (192.168.0.4) port 3128 (#0)
</I>&gt;<i> * STATE: WAITCONNECT =&gt; SENDPROTOCONNECT handle 0x600092d68; line 1665 
</I>&gt;<i> (connection #0)
</I>&gt;<i> * Marked for [keep alive]: HTTP default
</I>&gt;<i> * STATE: SENDPROTOCONNECT =&gt; DO handle 0x600092d68; line 1685 
</I>&gt;<i> (connection #0)
</I>&gt;<i> &gt; GET <A HREF="http://tehspb.kodeks.ru/js/jquery-1.4.2.min.js">http://tehspb.kodeks.ru/js/jquery-1.4.2.min.js</A> HTTP/1.1
</I>&gt;<i> &gt; Host: tehspb.kodeks.ru
</I>&gt;<i> &gt; User-Agent: curl/7.67.0
</I>&gt;<i> &gt; Accept: */*
</I>&gt;<i> &gt; Proxy-Connection: Keep-Alive
</I>&gt;<i> &gt;
</I>&gt;<i> * STATE: DO =&gt; DO_DONE handle 0x600092d68; line 1756 (connection #0)
</I>&gt;<i> * STATE: DO_DONE =&gt; PERFORM handle 0x600092d68; line 1877 (connection #0)
</I>&gt;<i> * Mark bundle as not supporting multiuse
</I>&gt;<i> * HTTP 1.1 or later with persistent connection
</I>&gt;<i> &lt; HTTP/1.1 200 OK
</I>&gt;<i> &lt; Server: nginx/1.4.6 (Ubuntu)
</I>&gt;<i> &lt; Date: Tue, 21 Jan 2020 07:10:43 GMT
</I>&gt;<i> &lt; Content-Type: text/javascript; charset=UTF-8
</I>&gt;<i> &lt; Content-Length: 72175
</I>&gt;<i> &lt; X-PaperRoute: Node
</I>&gt;<i> &lt; ETag: &quot;800439-72175-1534779018000&quot;
</I>&gt;<i> &lt; Last-Modified: Mon, 20 Aug 2018 15:30:18 GMT
</I>&gt;<i> &lt; Access-Control-Allow-Origin: *
</I>&gt;<i> &lt; Cache-Control: no-cache
</I>&gt;<i> &lt; X-Cache: MISS from opnsense.lan
</I>&gt;<i> &lt; X-Cache-Lookup: MISS from opnsense.lan:3128
</I>&gt;<i> &lt; Via: 1.1 opnsense.lan (squid/4.9)
</I>&gt;<i> &lt; Connection: keep-alive
</I>&gt;<i> &lt;
</I>&gt;<i> { [1460 bytes data]
</I>&gt;<i> * STATE: PERFORM =&gt; DONE handle 0x600092d68; line 2067 (connection #0)
</I>&gt;<i> * multi_done
</I>&gt;<i> 100 72175&#160; 100 72175&#160;&#160;&#160; 0&#160;&#160;&#160;&#160; 0&#160;&#160; 175k&#160;&#160;&#160;&#160;&#160; 0 --:--:-- --:--:-- 
</I>&gt;<i> --:--:--&#160; 176k
</I>&gt;<i> * Connection #0 to host 192.168.0.4 left intact
</I>Squid access log:
&gt;<i> 2020/01/21 12:10:43 &#160;&#160;&#160; 184 192.168.0.5 TCP_MISS/200 72647 GET 
</I>&gt;<i> <A HREF="http://tehspb.kodeks.ru/js/jquery-1.4.2.min.js">http://tehspb.kodeks.ru/js/jquery-1.4.2.min.js</A> - 
</I>&gt;<i> HIER_DIRECT/5.61.15.55 text/javascript
</I>
However, all subsequent requests fail and return an empty response.

&gt;<i> curl --proxy 192.168.0.4:3128 -v -O 
</I>&gt;<i> <A HREF="http://tehspb.kodeks.ru/js/jquery-1.4.2.min.js">http://tehspb.kodeks.ru/js/jquery-1.4.2.min.js</A>
</I>&gt;<i> * STATE: INIT =&gt; CONNECT handle 0x600092d68; line 1491 (connection #-5000)
</I>&gt;<i> * Added connection 0. The cache now contains 1 members
</I>&gt;<i> *&#160;&#160; Trying 192.168.0.4:3128...
</I>&gt;<i> * TCP_NODELAY set
</I>&gt;<i> * STATE: CONNECT =&gt; WAITCONNECT handle 0x600092d68; line 1547 
</I>&gt;<i> (connection #0)
</I>&gt;<i> * Connected to 192.168.0.4 (192.168.0.4) port 3128 (#0)
</I>&gt;<i> * STATE: WAITCONNECT =&gt; SENDPROTOCONNECT handle 0x600092d68; line 1665 
</I>&gt;<i> (connection #0)
</I>&gt;<i> * Marked for [keep alive]: HTTP default
</I>&gt;<i> * STATE: SENDPROTOCONNECT =&gt; DO handle 0x600092d68; line 1685 
</I>&gt;<i> (connection #0)
</I>&gt;<i> &gt; GET <A HREF="http://tehspb.kodeks.ru/js/jquery-1.4.2.min.js">http://tehspb.kodeks.ru/js/jquery-1.4.2.min.js</A> HTTP/1.1
</I>&gt;<i> &gt; Host: tehspb.kodeks.ru
</I>&gt;<i> &gt; User-Agent: curl/7.67.0
</I>&gt;<i> &gt; Accept: */*
</I>&gt;<i> &gt; Proxy-Connection: Keep-Alive
</I>&gt;<i> &gt;
</I>&gt;<i> * STATE: DO =&gt; DO_DONE handle 0x600092d68; line 1756 (connection #0)
</I>&gt;<i> * STATE: DO_DONE =&gt; PERFORM handle 0x600092d68; line 1877 (connection #0)
</I>&gt;<i> * Mark bundle as not supporting multiuse
</I>&gt;<i> * HTTP 1.1 or later with persistent connection
</I>&gt;<i> &lt; HTTP/1.1 200 OK
</I>&gt;<i> &lt; Server: nginx/1.4.6 (Ubuntu)
</I>&gt;<i> &lt; Date: Tue, 21 Jan 2020 07:14:20 GMT
</I>&gt;<i> &lt; Content-Type: text/javascript; charset=UTF-8
</I>&gt;<i> &lt; Content-Length: 0
</I>&gt;<i> &lt; X-PaperRoute: Node
</I>&gt;<i> &lt; ETag: &quot;800439-72175-1534779018000&quot;
</I>&gt;<i> &lt; Last-Modified: Mon, 20 Aug 2018 15:30:18 GMT
</I>&gt;<i> &lt; Access-Control-Allow-Origin: *
</I>&gt;<i> &lt; Cache-Control: no-cache
</I>&gt;<i> &lt; Age: 0
</I>&gt;<i> &lt; X-Cache: HIT from opnsense.lan
</I>&gt;<i> &lt; X-Cache-Lookup: HIT from opnsense.lan:3128
</I>&gt;<i> &lt; Via: 1.1 opnsense.lan (squid/4.9)
</I>&gt;<i> &lt; Connection: keep-alive
</I>&gt;<i> &lt;
</I>&gt;<i> * Excess found: excess = 986 url = /js/jquery-1.4.2.min.js 
</I>&gt;<i> (zero-length body)
</I>&gt;<i> * STATE: PERFORM =&gt; DONE handle 0x600092d68; line 2067 (connection #0)
</I>&gt;<i> * multi_done
</I>&gt;<i> &#160; 0&#160;&#160;&#160;&#160; 0&#160;&#160;&#160; 0&#160;&#160;&#160;&#160; 0&#160;&#160;&#160; 0&#160;&#160;&#160;&#160; 0&#160;&#160;&#160;&#160;&#160; 0&#160;&#160;&#160;&#160;&#160; 0 --:--:-- --:--:-- 
</I>&gt;<i> --:--:--&#160;&#160;&#160;&#160; 0
</I>&gt;<i> * Connection #0 to host 192.168.0.4 left intact
</I>&gt;<i> * Expire cleared (transfer 0x600092d68)
</I>
Squid access log:

&gt;<i> 2020/01/21 12:14:20 &#160;&#160;&#160; 102 192.168.0.5 
</I>&gt;<i> TCP_REFRESH_UNMODIFIED_ABORTED/200 65672 GET 
</I>&gt;<i> <A HREF="http://tehspb.kodeks.ru/js/jquery-1.4.2.min.js">http://tehspb.kodeks.ru/js/jquery-1.4.2.min.js</A> - 
</I>&gt;<i> HIER_DIRECT/5.61.15.55 text/javascript
</I>

Direct access without proxy works so this is not network issue. I 
thought it was a server setup problem but support guy say they have 
thousands of customers and everything's fine :-) Maybe someone has faced 
similar problems?

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="021683.html">[squid-users] squid and netdata causes squid to drop SYN?
</A></li>
	<LI>Next message (by thread): <A HREF="021673.html">[squid-users] Fail and empty response instead cached resource
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21672">[ date ]</a>
              <a href="thread.html#21672">[ thread ]</a>
              <a href="subject.html#21672">[ subject ]</a>
              <a href="author.html#21672">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
