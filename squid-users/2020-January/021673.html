<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Fail and empty response instead cached resource
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Fail%20and%20empty%20response%20instead%20cached%20resource&In-Reply-To=%3C84cd067a-c962-4d37-764e-8b69ef759df2%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="021672.html">
   <LINK REL="Next"  HREF="021676.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Fail and empty response instead cached resource</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Fail%20and%20empty%20response%20instead%20cached%20resource&In-Reply-To=%3C84cd067a-c962-4d37-764e-8b69ef759df2%40treenet.co.nz%3E"
       TITLE="[squid-users] Fail and empty response instead cached resource">squid3 at treenet.co.nz
       </A><BR>
    <I>Tue Jan 21 11:54:51 UTC 2020</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="021672.html">[squid-users] Fail and empty response instead cached resource
</A></li>
        <LI>Next message (by thread): <A HREF="021676.html">[squid-users] Fail and empty response instead cached resource
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21673">[ date ]</a>
              <a href="thread.html#21673">[ thread ]</a>
              <a href="subject.html#21673">[ subject ]</a>
              <a href="author.html#21673">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 21/01/20 10:36 pm, Kuznetsov Sergei wrote:
&gt;<i> Hello
</I>&gt;<i> 
</I>&gt;<i> I run Squid 4.9 in non transparent mode with OPNsense (FreeBSD 
</I>&gt;<i> 11.2-RELEASE-p16-HBSD FreeBSD 11.2-RELEASE-p16-HBSD 
</I>&gt;<i> 87a7fc985c3(stable/19.7)&#160; amd64).
</I>&gt;<i> 
</I>&gt;<i> Everything works except access to one website.
</I>&gt;<i> 
</I>
Which is broken. More on that below...

&gt;<i> 
</I>&gt;<i> When I make a request for the first time, everything is fine and I get 
</I>&gt;<i> correct result.
</I>&gt;<i> 
</I>...
&gt;&gt;<i> &lt; HTTP/1.1 200 OK
</I>&gt;&gt;<i> &lt; Server: nginx/1.4.6 (Ubuntu)
</I>&gt;&gt;<i> &lt; Date: Tue, 21 Jan 2020 07:10:43 GMT
</I>&gt;&gt;<i> &lt; Content-Type: text/javascript; charset=UTF-8
</I>&gt;&gt;<i> &lt; Content-Length: 72175
</I>&gt;&gt;<i> &lt; X-PaperRoute: Node
</I>&gt;&gt;<i> &lt; ETag: &quot;800439-72175-1534779018000&quot;
</I>&gt;&gt;<i> &lt; Last-Modified: Mon, 20 Aug 2018 15:30:18 GMT
</I>&gt;&gt;<i> &lt; Access-Control-Allow-Origin: *
</I>&gt;&gt;<i> &lt; Cache-Control: no-cache
</I>&gt;&gt;<i> &lt; X-Cache: MISS from opnsense.lan
</I>&gt;&gt;<i> &lt; X-Cache-Lookup: MISS from opnsense.lan:3128
</I>&gt;&gt;<i> &lt; Via: 1.1 opnsense.lan (squid/4.9)
</I>&gt;&gt;<i> &lt; Connection: keep-alive
</I>&gt;&gt;<i> &lt;
</I>
The full object contains &quot;Cache-Control: no-cache&quot; which requires a
revalidate/refresh before the object can be used from cache.


&gt;<i> However, all subsequent requests fail and return an empty response.
</I>&gt;<i> 
</I>

&gt;<i> Squid access log:
</I>&gt;<i>
</I>&gt;&gt;<i> 2020/01/21 12:14:20     102 192.168.0.5
</I>&gt;&gt;<i> TCP_REFRESH_UNMODIFIED_ABORTED/200 65672 GET
</I>&gt;&gt;<i> <A HREF="http://tehspb.kodeks.ru/js/jquery-1.4.2.min.js">http://tehspb.kodeks.ru/js/jquery-1.4.2.min.js</A> -
</I>&gt;&gt;<i> HIER_DIRECT/5.61.15.55 text/javascript
</I>&gt;<i>
</I>
... access.log indicates that Squid performed the revalidate (aka
refresh) on the content.


When the revalidation request is sent, the origin server updates the
HTTP headers to say that the object is now 0 bytes in length:

    HTTP/1.1 304 Not Modified
    Server: nginx/1.4.6 (Ubuntu)
    Date: Tue, 21 Jan 2020 11:27:17 GMT
    Content-Type: text/javascript; charset=UTF-8
=&gt;  Content-Length: 0
    Connection: keep-alive
    X-PaperRoute: Node
    ETag: &quot;800439-72175-1534779018000&quot;
    last-modified: Mon, 20 Aug 2018 15:30:18 GMT
    Access-Control-Allow-Origin: *
    Cache-Control: no-cache


So Squid is relaying that change to the clients :

&gt;&gt;<i> &lt; HTTP/1.1 200 OK
</I>&gt;&gt;<i> &lt; Server: nginx/1.4.6 (Ubuntu)
</I>&gt;&gt;<i> &lt; Date: Tue, 21 Jan 2020 07:14:20 GMT
</I>&gt;&gt;<i> &lt; Content-Type: text/javascript; charset=UTF-8
</I>&gt;&gt;<i> &lt; Content-Length: 0
</I>
==&gt; ^^

&gt;&gt;<i> &lt; X-PaperRoute: Node
</I>&gt;&gt;<i> &lt; ETag: &quot;800439-72175-1534779018000&quot;
</I>&gt;&gt;<i> &lt; Last-Modified: Mon, 20 Aug 2018 15:30:18 GMT
</I>&gt;&gt;<i> &lt; Access-Control-Allow-Origin: *
</I>&gt;&gt;<i> &lt; Cache-Control: no-cache
</I>&gt;&gt;<i> &lt; Age: 0
</I>&gt;&gt;<i> &lt; X-Cache: HIT from opnsense.lan
</I>&gt;&gt;<i> &lt; X-Cache-Lookup: HIT from opnsense.lan:3128
</I>&gt;&gt;<i> &lt; Via: 1.1 opnsense.lan (squid/4.9)
</I>&gt;&gt;<i> &lt; Connection: keep-alive
</I>&gt;&gt;<i> &lt;
</I>&gt;&gt;<i> * Excess found: excess = 986 url = /js/jquery-1.4.2.min.js 
</I>&gt;&gt;<i> (zero-length body)
</I>



Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="021672.html">[squid-users] Fail and empty response instead cached resource
</A></li>
	<LI>Next message (by thread): <A HREF="021676.html">[squid-users] Fail and empty response instead cached resource
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21673">[ date ]</a>
              <a href="thread.html#21673">[ thread ]</a>
              <a href="subject.html#21673">[ subject ]</a>
              <a href="author.html#21673">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
