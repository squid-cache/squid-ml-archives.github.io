<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Issues with TLS inspection Intercept Mode.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Issues%20with%20TLS%20inspection%20Intercept%20Mode.&In-Reply-To=%3C2fa147c4-e499-9244-d2d1-c52438e2f4f4%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="021677.html">
   <LINK REL="Next"  HREF="021684.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Issues with TLS inspection Intercept Mode.</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Issues%20with%20TLS%20inspection%20Intercept%20Mode.&In-Reply-To=%3C2fa147c4-e499-9244-d2d1-c52438e2f4f4%40treenet.co.nz%3E"
       TITLE="[squid-users] Issues with TLS inspection Intercept Mode.">squid3 at treenet.co.nz
       </A><BR>
    <I>Wed Jan 22 05:36:37 UTC 2020</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="021677.html">[squid-users] Issues with TLS inspection Intercept Mode.
</A></li>
        <LI>Next message (by thread): <A HREF="021684.html">[squid-users] Issues with TLS inspection-2
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21678">[ date ]</a>
              <a href="thread.html#21678">[ thread ]</a>
              <a href="subject.html#21678">[ subject ]</a>
              <a href="author.html#21678">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 22/01/20 7:39 am, aashutosh kalyankar wrote:
&gt;<i> The problem I am seeing is the intercept port initiates HTTP connection
</I>&gt;<i> to self-IP instead of the web server IP it gets from the DNS request.
</I>
Neither of those IPs should be used.

Self-IP indicates that the traffic is being delivered to the proxy port
as explicit proxy traffic. Or that the NAT system is broken. We usually
get this complaint from people who are testing their proxy by sending
traffic directly to the proxy port.

DNS is only involved to validate the HTTP Host header against the IP
address to forbid caching dangerous contents.


&gt;<i> &#160;Filtered&#160;Tcpdump
</I>&gt;<i> screenshot&#160;@&#160;<A HREF="https://drive.google.com/open?id=0ByReiwdSAAY_VXBPTjF1M3dYTnBTTnhFVnRocXFveUlNSlNj">https://drive.google.com/open?id=0ByReiwdSAAY_VXBPTjF1M3dYTnBTTnhFVnRocXFveUlNSlNj</A>
</I>&gt;<i> 
</I>
Screenshots are rarely useful. You are logging level 11,3 to cache.log,
so there should be full HTTP message traces with related connection
details and flow direction (client vs server). That would be more useful.


What I do see in the image is several &quot;GET <A HREF="http://">http://</A>&quot; lines. That
absolute-form URL syntax is for explicit proxy traffic. Traffic
intercepted from port 80 or 443 would use origin-form URLs.
 - This reinforces the idea that you are probably testing the proxy
wrong - eg direct curl requests to the proxy?



&gt;<i> Server IP: Eth0: IP: 172.22.22.148/26 (Same
</I>&gt;<i> eth0 interface reaches the internet gateway).
</I>&gt;<i> Configurations for&#160;
</I>&gt;<i> 1) Nat table:&#160;
</I>&gt;<i> Chain PREROUTING(policy ACCEPT 23 packets, 1632 bytes)
</I>&gt;<i> num &#160; pkts bytes target &#160; &#160; prot opt in&#160; &#160; out &#160; source&#160; &#160; &#160; &#160; &#160; &#160; &#160;
</I>&gt;<i> destination &#160; &#160;
</I>&gt;<i> 1 &#160; &#160; &#160; 66 3960 REDIRECT &#160; tcp -- eth0 * &#160; &#160; 0.0.0.0/0
</I>&gt;<i> 0.0.0.0/0&#160; &#160; &#160; &#160; &#160; &#160; tcp dpt:80 /*
</I>&gt;<i> Redirect http traffic eth0:80 to eth0:3128 */ redir ports 3128
</I>&gt;<i> 
</I>
You are missing the PREROUTING rule which would ACCEPT traffic outbound
from the proxy to port 80.

This config page details what you need for REDIRECT interception on
iptables:
 &lt;<A HREF="https://wiki.squid-cache.org/ConfigExamples/Intercept/LinuxRedirect">https://wiki.squid-cache.org/ConfigExamples/Intercept/LinuxRedirect</A>&gt;


Note that it does not place the intercept flag on port 3128. That is
because Squid will generate URLs with its hostname and that port for
clients to use directly when needed (error page contents, manager
reports, etc).



&gt;<i> Please let me know if I am missing some conf or the next steps I should
</I>&gt;<i> try to get this running.
</I>&gt;<i>
</I>
Firstly, add that missing NAT rule.

Secondly, make sure that your tests are accurately emulating how clients
would &quot;use&quot; the proxy. That means making connections from a test machine
directly to the Internet and seeing if the routing and NAT delivers the
traffic to Squid properly.

 - Use cache.log to view the traffic coming into the proxy. It will be
request messages with a prefix line indicating &quot;Client HTTP request&quot;.
Make sure that prefix line says the remote Internet IP address and port
80/443 you were testing with.
 - If you want confirm that access.log has a transaction entry for the
URL you tested with ORIGINAL_DST and the server IP.



Thirdly, some squid.conf improvements for other problems you have either
not noticed or not encountered yet:

&gt;<i> 3) Squid.conf
</I>&gt;<i> 
</I>...
&gt;<i> acl my_machine src 172.22.22.0/24
</I>&gt;<i> http_access allow my_machine
</I>&gt;<i> acl ap_clients src 172.16.10.0/24
</I>&gt;<i> acl local_clients src 172.18.10.0/24
</I>&gt;<i> acl localnet src 10.0.0.0/8	
</I>...
&gt;<i> http_access allow localnet
</I>&gt;<i> http_access allow ap_clients
</I>&gt;<i> http_access allow local_clients
</I>
It looks sub-optimal to have these as separate ACLs. May as well use
config comments to document what ranges are which clients and put them
all in localnet (that is what it is for).

eg:
 # AP clients
 acl localnet src 172.16.10.0/24
 # Local clients
 acl localnet src 172.18.10.0/24
 # LAN
 acl localnet src 10.0.0.0/8

 http_access allow localnet



&gt;<i> acl purge method PURGE
</I>&gt;<i> http_access deny purge
</I>
PURGE is largely obsoleted (by HTCP CLR feature) and requires Squid to
perform a relatively large amount of processing per-request. Unless you
have tools that use it specifically it is best to remove all mention of
it from the config file to let Squid avoid all that work. If any mention
remains Squid will auto-activate the cache indexing work.

If you do have tools using it. Then it is past time to consider/plan
moving those tools and Squid to using HTCP CLR instead.


&gt;<i> http_access deny !Safe_ports
</I>&gt;<i> http_access deny CONNECT !SSL_ports
</I>
 ... this is where all your custom http_access rules are supposed to be.
The Safe_ports and SSL_Ports lines above are DoS and hijack protections.

 * DoS protections need to be first to do their job of minimizing the
CPU impact effectively. It is counter productive to have allow's earlier
than here.

 * It is risky to let clients hijack the proxy and Squid cannot handle
native traffic to or from those ports anyway. If you need a specific
port available



&gt;<i> http_reply_access allow all
</I>
Above is the default reply handling. No need to specify.

&gt;<i> http_access deny all
</I>
&gt;<i> http_port 8080
</I>&gt;<i> http_port 172.22.22.148:3128 intercept
</I>&gt;<i> https_port 172.22.22.148:3129 intercept ssl-bump cert=/etc/squid/ssl_certs/myCA.pem generate-host-certificates=on dynamic_cert_mem_cache_size=4MB
</I>&gt;<i> sslcrtd_program /usr/lib/squid/ssl_crtd -s /var/lib/ssl_db -M 4MB
</I>
You do need at least one non-intercept port for the direct-to-proxy
communications that are needed occasionally. Port 3128 is reserved for
that. It is best to pick a random other port number for the intercepted
traffic to arrive at and leave 3128 for the normal proxy traffic.



&gt;<i> acl step1 at_step SslBump1
</I>&gt;<i> ssl_bump peek step1
</I>&gt;<i> ssl_bump bump all
</I>
NP: while this &quot;works&quot; bumping without any details about the server
(obtained at step2) can cause a lot of connection compatibility problems
and undesirable security side effects.  Prefer to stare at step2 and
bump at step 3. Do this step2 bump only as a last-resort (ie restrict it
to sites that are broken and cannot be worked around in other ways).


&gt;<i> host_verify_strict off
</I>
The above is the default, no need to specify.

&gt;<i> acl oyster-vpn-test dstdomain .oyster-vpn-test.com
</I>&gt;<i> cache deny oyster-vpn-test
</I>&gt;<i> visible_hostname togo.mtv.corp.google.com
</I>
Er ... AFAIK Google does not use that domain for their machine
hostnames. You sure you want to advertise your network as *.google.com ?

Also, you only need a visible_hostname line if Squid is unable to pull
the machines hostname from the OS configuration.


Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="021677.html">[squid-users] Issues with TLS inspection Intercept Mode.
</A></li>
	<LI>Next message (by thread): <A HREF="021684.html">[squid-users] Issues with TLS inspection-2
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21678">[ date ]</a>
              <a href="thread.html#21678">[ thread ]</a>
              <a href="subject.html#21678">[ subject ]</a>
              <a href="author.html#21678">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
