<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] squid and netdata causes squid to drop SYN?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid%20and%20netdata%20causes%20squid%20to%20drop%20SYN%3F&In-Reply-To=%3C875781fa-8d5c-2e08-5277-6d0de2006edc%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="021679.html">
   <LINK REL="Next"  HREF="021682.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] squid and netdata causes squid to drop SYN?</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid%20and%20netdata%20causes%20squid%20to%20drop%20SYN%3F&In-Reply-To=%3C875781fa-8d5c-2e08-5277-6d0de2006edc%40treenet.co.nz%3E"
       TITLE="[squid-users] squid and netdata causes squid to drop SYN?">squid3 at treenet.co.nz
       </A><BR>
    <I>Wed Jan 22 06:40:48 UTC 2020</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="021679.html">[squid-users] squid and netdata causes squid to drop SYN?
</A></li>
        <LI>Next message (by thread): <A HREF="021682.html">[squid-users] squid and netdata causes squid to drop SYN?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21681">[ date ]</a>
              <a href="thread.html#21681">[ thread ]</a>
              <a href="subject.html#21681">[ subject ]</a>
              <a href="author.html#21681">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 22/01/20 6:55 pm, Amish wrote:
&gt;<i> On 21/01/20 9:09 pm, Alex Rousskov wrote:
</I>&gt;&gt;<i> On 1/20/20 11:28 PM, Amish wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> 2) Is calling squidclient so frequently a right thing to do by netdata?
</I>&gt;&gt;<i> The answer depends on what cache manager query (or queries) your netdata
</I>&gt;&gt;<i> is sending to Squid. Sending some queries every second is perfectly
</I>&gt;&gt;<i> fine, but there are other, &quot;heavy&quot; queries that should not be sent so
</I>&gt;&gt;<i> often and could, if sent with a high enough concurrency level,
</I>&gt;&gt;<i> effectively DoS a Squid instance. For example, queries that require
</I>&gt;&gt;<i> iterating all cached objects should not be sent to busy Squids.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> If netdata does not document the queries it uses, you can probably use
</I>&gt;&gt;<i> Squid access.log to figure out what queries netdata is sending (and how
</I>&gt;&gt;<i> long they take).
</I>&gt;<i> 
</I>&gt;<i> Thanks Matus UHLAR and Alex for responses.
</I>&gt;<i> 
</I>&gt;<i> I have not gone in detail through netdata sources but here is whatever I
</I>&gt;<i> could find.
</I>&gt;<i> 
</I>&gt;<i> Squid python code that runs HTTP query on squid: (I have never coded in
</I>&gt;<i> python)
</I>&gt;<i> <A HREF="https://github.com/netdata/netdata/blob/master/collectors/python.d.plugin/squid/squid.chart.py">https://github.com/netdata/netdata/blob/master/collectors/python.d.plugin/squid/squid.chart.py</A>
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Configuration that decides what to query. (netdata chooses one of
</I>&gt;<i> options specified)
</I>&gt;<i> <A HREF="https://github.com/netdata/netdata/blob/master/collectors/python.d.plugin/squid/squid.conf">https://github.com/netdata/netdata/blob/master/collectors/python.d.plugin/squid/squid.conf</A>
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> It appears that it runs a query on &quot;counters&quot;. But I dont know if that
</I>&gt;<i> is counted as a &quot;heavy&quot; query or not.
</I>
It is one of the light ones. So if that were all that is going on I
would not be expecting a problem.

The worst case I have seen with the quick reports is tools not closing
the sockets properly and running out FD numbers. But at 1/sec there
would only be 900 FD held up for the TCP 15min TIMEWAIT, not enough
relative to your 16K available to cause the level of issues you are seeing.


Your mention of intercepting traffic to port 3128 makes me wonder if the
netdata auto-detect is trying to use that port.
 If that is happening there would be some visible effects:
 A) if you have firewall protection DROP'ing direct connections to the
intercept port. That would show up exactly as SYN with no SYN+ACK on any
auto-detect probes the tool used to that port. (This is one reason I am
so vocal about people not using port 3128 to intercept).

 B) if you are missing that mandatory firewall protection, the tool may
be triggering forwarding loops. Which use many more FD than it should
(up to all of them) with the visible effects being clients not able to
connect around peak times and SYN being dropped when limits are hit
(either the loop limit, or interception port protection.
 If the tool is smart enough to detect the error state and move to
another port for a while that might explain the intermittent nature.



&gt;<i> 
</I>&gt;&gt;<i> N.B. If netdata is killing the previous query when starting a new
</I>&gt;&gt;<i> would-be-concurrent query, then there should be no DoS conditions -- a
</I>&gt;&gt;<i> single &quot;heavy&quot; query may slow Squid down a bit but should not stall the
</I>&gt;&gt;<i> whole Squid instance. Thus, if netdata ensures that the number of
</I>&gt;&gt;<i> concurrent cache manager queries is small, then there may be a Squid bug
</I>&gt;&gt;<i> related to terminating an aborted query. Otherwise, one could argue that
</I>&gt;&gt;<i> the lack of concurrency controls is a netdata bug.
</I>&gt;<i> 
</I>&gt;<i> Not sure if netdata terminates previous query or not. But I do see use
</I>&gt;<i> of keep-alive in netdata code.
</I>&gt;<i> 
</I>&gt;<i> And also I completely understand that this area needs to be looked upon
</I>&gt;<i> by netdata team. I will follow up with them.
</I>&gt;<i> 
</I>&gt;<i> But posting here just case, a quick glance can reveal a squid bug (or
</I>&gt;<i> buggy approach by netdata) somewhere.
</I>

Since Squid is sending chunked header, the response should be chunked
like they expect and keep-alive pipeline available for use on their
followup requests. If the connection is closed with proper TCP closure
sequence, that is not a problem though.

(NP: Just a &quot;should&quot; because I have run out of time today to confirm
that particular mgr report is acting properly - some do, others not so
nice.)

Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="021679.html">[squid-users] squid and netdata causes squid to drop SYN?
</A></li>
	<LI>Next message (by thread): <A HREF="021682.html">[squid-users] squid and netdata causes squid to drop SYN?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21681">[ date ]</a>
              <a href="thread.html#21681">[ thread ]</a>
              <a href="subject.html#21681">[ subject ]</a>
              <a href="author.html#21681">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
