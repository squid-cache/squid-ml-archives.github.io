<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] squid and netdata causes squid to drop SYN?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid%20and%20netdata%20causes%20squid%20to%20drop%20SYN%3F&In-Reply-To=%3C136226b4-2239-3d32-3d39-0e38882389e2%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="021682.html">
   <LINK REL="Next"  HREF="021672.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] squid and netdata causes squid to drop SYN?</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid%20and%20netdata%20causes%20squid%20to%20drop%20SYN%3F&In-Reply-To=%3C136226b4-2239-3d32-3d39-0e38882389e2%40treenet.co.nz%3E"
       TITLE="[squid-users] squid and netdata causes squid to drop SYN?">squid3 at treenet.co.nz
       </A><BR>
    <I>Wed Jan 22 10:25:03 UTC 2020</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="021682.html">[squid-users] squid and netdata causes squid to drop SYN?
</A></li>
        <LI>Next message (by thread): <A HREF="021672.html">[squid-users] Fail and empty response instead cached resource
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21683">[ date ]</a>
              <a href="thread.html#21683">[ thread ]</a>
              <a href="subject.html#21683">[ subject ]</a>
              <a href="author.html#21683">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 22/01/20 8:54 pm, Amish wrote:
&gt;<i> 
</I>&gt;<i> On 22/01/20 12:10 pm, Amos Jeffries wrote:
</I>&gt;&gt;<i> On 22/01/20 6:55 pm, Amish wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> It appears that it runs a query on &quot;counters&quot;. But I dont know if that
</I>&gt;&gt;&gt;&gt;<i> is counted as a &quot;heavy&quot; query or not.
</I>&gt;&gt;<i> It is one of the light ones. So if that were all that is going on I
</I>&gt;&gt;<i> would not be expecting a problem.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> ...
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Your mention of intercepting traffic to port 3128 makes me wonder if the
</I>&gt;&gt;<i> netdata auto-detect is trying to use that port.
</I>&gt;&gt;<i> &#160; If that is happening there would be some visible effects:
</I>&gt;&gt;<i> &#160; A) if you have firewall protection DROP'ing direct connections to the
</I>&gt;&gt;<i> intercept port. That would show up exactly as SYN with no SYN+ACK on any
</I>&gt;&gt;<i> auto-detect probes the tool used to that port. (This is one reason I am
</I>&gt;&gt;<i> so vocal about people not using port 3128 to intercept).
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &#160; B) if you are missing that mandatory firewall protection, the tool may
</I>&gt;&gt;<i> be triggering forwarding loops. Which use many more FD than it should
</I>&gt;&gt;<i> (up to all of them) with the visible effects being clients not able to
</I>&gt;&gt;<i> connect around peak times and SYN being dropped when limits are hit
</I>&gt;&gt;<i> (either the loop limit, or interception port protection.
</I>&gt;&gt;<i> &#160; If the tool is smart enough to detect the error state and move to
</I>&gt;&gt;<i> another port for a while that might explain the intermittent nature.
</I>&gt;<i> 
</I>&gt;<i> Connection from 127.0.0.1 (loopback interface) are not blocked. (DROPped)
</I>
It should be. *No* traffic can be allowed to connect directly to a Squid
'intercept' port. It is exclusively for use by NAT&lt;-&gt;Squid communication.

Anything that does connect directly will start a loop which can consume
up to all of the resources on the server (TCP sockets, TCP ports, NAT
table entries, file descriptors, memory, CPU ... whichever exhausts
first). Squid uses Via header and some other details to try to detect
loops before they become a problem and forbid ASAP. But there may be
ways around the detection - since Via is often disabled and/or stripped
from traffic.

&gt;<i> 
</I>&gt;<i> Also, if it was due to DROP then it should not work from beginning but
</I>&gt;<i> here it works for a while (few hours) and then suddenly starts blocking.
</I>&gt;<i> 
</I>
The netdata tool at least has multiple different ways to connect to the
proxy. It has some logic to auto-detect which work and which don't. One
of those ways is port 3128 and another is port 8080 - which on your
proxy are the intercept and explicit proxy ports respectively. It may
try a working port some executions and then a non-working port next
execution.


&gt;<i> Also I grepped whole cache.log for word &quot;descriptor&quot;, it showed me no
</I>&gt;<i> error. Only line I saw is that 16384 descriptors are available (when
</I>&gt;<i> squid starts)
</I>
That is not what you should be looking at anyway. Look at the HTTP
messages arriving, where they are coming from and what happens to them.

&gt;<i> 
</I>&gt;<i> I will try to reproduce the error when I get some time. Currently I have
</I>&gt;<i> disabled netdata's squid module and things are stable.
</I>&gt;<i> 
</I>&gt;<i> Thank you very much for your response,
</I>
Aye, hope this info helps for that troubleshooting.

Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="021682.html">[squid-users] squid and netdata causes squid to drop SYN?
</A></li>
	<LI>Next message (by thread): <A HREF="021672.html">[squid-users] Fail and empty response instead cached resource
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21683">[ date ]</a>
              <a href="thread.html#21683">[ thread ]</a>
              <a href="subject.html#21683">[ subject ]</a>
              <a href="author.html#21683">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
