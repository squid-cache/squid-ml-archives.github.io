<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Issues with TLS inspection-2
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Issues%20with%20TLS%20inspection-2&In-Reply-To=%3CCABi%2BORKQuZV-tOOU5F7W5dPAetkk%2B%3D7ra%3DiHsGJ_72OveGQ%2B1A%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="021678.html">
   <LINK REL="Next"  HREF="021685.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Issues with TLS inspection-2</H1>
    <B>aashutosh kalyankar</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Issues%20with%20TLS%20inspection-2&In-Reply-To=%3CCABi%2BORKQuZV-tOOU5F7W5dPAetkk%2B%3D7ra%3DiHsGJ_72OveGQ%2B1A%40mail.gmail.com%3E"
       TITLE="[squid-users] Issues with TLS inspection-2">aashutosh.xyz at gmail.com
       </A><BR>
    <I>Thu Jan 23 02:11:55 UTC 2020</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="021678.html">[squid-users] Issues with TLS inspection Intercept Mode.
</A></li>
        <LI>Next message (by thread): <A HREF="021685.html">[squid-users] Issues with TLS inspection-2
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21684">[ date ]</a>
              <a href="thread.html#21684">[ thread ]</a>
              <a href="subject.html#21684">[ subject ]</a>
              <a href="author.html#21684">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Message: 5
</I>&gt;<i> Date: Wed, 22 Jan 2020 18:36:37 +1300
</I>&gt;<i> From: Amos Jeffries &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt;
</I>&gt;<i> To: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> Subject: Re: [squid-users] Issues with TLS inspection Intercept Mode.
</I>&gt;<i> Message-ID: &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">2fa147c4-e499-9244-d2d1-c52438e2f4f4 at treenet.co.nz</A>&gt;
</I>&gt;<i> Content-Type: text/plain; charset=utf-8
</I>&gt;<i>
</I>&gt;<i> On 22/01/20 7:39 am, aashutosh kalyankar wrote:
</I>&gt;<i> &gt; The problem I am seeing is the intercept port initiates HTTP connection
</I>&gt;<i> &gt; to self-IP instead of the web server IP it gets from the DNS request.
</I>&gt;<i>
</I>&gt;<i> Neither of those IPs should be used.
</I>&gt;<i>
</I>&gt;<i> Self-IP indicates that the traffic is being delivered to the proxy port
</I>&gt;<i> as explicit proxy traffic. Or that the NAT system is broken. We usually
</I>&gt;<i> get this complaint from people who are testing their proxy by sending
</I>&gt;<i> traffic directly to the proxy port.
</I>&gt;<i>
</I>&gt;<i> DNS is only involved to validate the HTTP Host header against the IP
</I>&gt;<i> address to forbid caching dangerous contents.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt;  Filtered Tcpdump
</I>&gt;<i> &gt; screenshot @
</I>&gt;<i> <A HREF="https://drive.google.com/open?id=0ByReiwdSAAY_VXBPTjF1M3dYTnBTTnhFVnRocXFveUlNSlNj">https://drive.google.com/open?id=0ByReiwdSAAY_VXBPTjF1M3dYTnBTTnhFVnRocXFveUlNSlNj</A>
</I>&gt;<i> &gt;
</I>&gt;<i>
</I>&gt;<i> Screenshots are rarely useful. You are logging level 11,3 to cache.log,
</I>&gt;<i> so there should be full HTTP message traces with related connection
</I>&gt;<i> details and flow direction (client vs server). That would be more useful.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> What I do see in the image is several &quot;GET <A HREF="http://">http://</A>&quot; lines. That
</I>&gt;<i> absolute-form URL syntax is for explicit proxy traffic. Traffic
</I>&gt;<i> intercepted from port 80 or 443 would use origin-form URLs.
</I>&gt;<i>  - This reinforces the idea that you are probably testing the proxy
</I>&gt;<i> wrong - eg direct curl requests to the proxy?
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; Server IP: Eth0: IP: 172.22.22.148/26 (Same
</I>&gt;<i> &gt; eth0 interface reaches the internet gateway).
</I>&gt;<i> &gt; Configurations for
</I>&gt;<i> &gt; 1) Nat table:
</I>&gt;<i> &gt; Chain PREROUTING(policy ACCEPT 23 packets, 1632 bytes)
</I>&gt;<i> &gt; num   pkts bytes target     prot opt in    out   source
</I>&gt;<i> &gt; destination
</I>&gt;<i> &gt; 1       66 3960 REDIRECT   tcp -- eth0 *     0.0.0.0/0
</I>&gt;<i> &gt; 0.0.0.0/0            tcp dpt:80 /*
</I>&gt;<i> &gt; Redirect http traffic eth0:80 to eth0:3128 */ redir ports 3128
</I>&gt;<i> &gt;
</I>&gt;<i>
</I>&gt;<i> You are missing the PREROUTING rule which would ACCEPT traffic outbound
</I>&gt;<i> from the proxy to port 80.
</I>&gt;<i>
</I>&gt;<i> As suggested, taking reference from
</I><A HREF="https://wiki.squid-cache.org/ConfigExamples/Intercept/LinuxRedirect,">https://wiki.squid-cache.org/ConfigExamples/Intercept/LinuxRedirect,</A> I
added the following rules. The only additional part is the Separation of
HTTP and HTTPS traffic rules.
*NAT TABLE*
* Chain PREROUTING*
 1        0     0 ACCEPT     tcp  --  *      *       172.22.22.148
0.0.0.0/0            tcp dpt:80 /* Accept http traffic at 172.22.22.148:80
*/

2       79  4740 REDIRECT   tcp  --  *      *       0.0.0.0/0
0.0.0.0/0            tcp dpt:80 /* Redirect eth0:80 to eth0:3129 */ redir
ports 3129

3        0     0 ACCEPT     tcp  --  *      *       172.22.22.148
0.0.0.0/0            tcp dpt:443 /* Accept https traffic at
172.22.22.148:443 */

4      565 33900 REDIRECT   tcp  --  *      *       0.0.0.0/0
0.0.0.0/0            tcp dpt:443 /* Redirect eth0:443 to eth0:3130 */ redir
ports 3130

*Chain POSTROUTING*
1     365K   23M MASQUERADE  all  --  *      *       0.0.0.0/0
0.0.0.0/0            /*  Allows NAT To happen */

*Mangle Table *

*Chain PREROUTING*
1        0     0 DROP       tcp  --  *      *       0.0.0.0/0
0.0.0.0/0            tcp dpt:3129
2        0     0 DROP       tcp  --  *      *       0.0.0.0/0
0.0.0.0/0            tcp dpt:3130

 This config page details what you need for REDIRECT interception on
&gt;<i> iptables:
</I>&gt;<i>  &lt;<A HREF="https://wiki.squid-cache.org/ConfigExamples/Intercept/LinuxRedirect">https://wiki.squid-cache.org/ConfigExamples/Intercept/LinuxRedirect</A>&gt;
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Note that it does not place the intercept flag on port 3128. That is
</I>&gt;<i> because Squid will generate URLs with its hostname and that port for
</I>&gt;<i> clients to use directly when needed (error page contents, manager
</I>&gt;<i> reports, etc).
</I>&gt;<i>
</I>&gt;<i> Using ports 3129 for http and 3130 for https.
</I>http_port 172.22.22.148:3129 intercept
https_port 172.22.22.148:3130 intercept ssl-bump
cert=/etc/squid/ssl_certs/myCA.pem generate-host-certificates=on
dynamic_cert_mem_cache_size=4MB


&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; Please let me know if I am missing some conf or the next steps I should
</I>&gt;<i> &gt; try to get this running.
</I>&gt;<i> &gt;
</I>&gt;<i>
</I>&gt;<i> Firstly, add that missing NAT rule.
</I>&gt;<i>
</I>

&gt;<i> Secondly, make sure that your tests are accurately emulating how clients
</I>&gt;<i> would &quot;use&quot; the proxy. That means making connections from a test machine
</I>&gt;<i> directly to the Internet and seeing if the routing and NAT delivers the
</I>&gt;<i> traffic to Squid properly.
</I>&gt;<i>
</I>
I am using a chromebook to test. In the configuration section of the
wireless network there is an option to add proxy hostname and proxy port
based on protocols.
Http proxy     :  proxy-tls 80
HTTPS proxy:  proxy-tls 443


&gt;<i>  - Use cache.log to view the traffic coming into the proxy. It will be
</I>&gt;<i> request messages with a prefix line indicating &quot;Client HTTP request&quot;.
</I>&gt;<i> Make sure that prefix line says the remote Internet IP address and port
</I>&gt;<i> 80/443 you were testing with.
</I>&gt;<i>  - If you want confirm that access.log has a transaction entry for the
</I>&gt;<i> URL you tested with ORIGINAL_DST and the server IP.
</I>&gt;<i>
</I>&gt;<i> Sample cache.log for a test I did for neverssl.com
</I>
2020/01/22 17:08:30.236 kid1| 11,2| client_side.cc(2346) parseHttpRequest:
HTTP Client local=172.22.22.148:80 remote=172.22.22.151:34728 FD 12 flags=33
2020/01/22 17:08:30.236 kid1| 11,2| client_side.cc(2347) parseHttpRequest:
HTTP Client REQUEST:
---------
GET <A HREF="http://neverssl.com/">http://neverssl.com/</A> HTTP/1.1
Host: neverssl.com
Proxy-Connection: keep-alive
DNT: 1
Upgrade-Insecure-Requests: 1
User-Agent: Mozilla/5.0 (X11; CrOS x86_64 12499.12.0) AppleWebKit/537.36
(KHTML, like Gecko) Chrome/78.0.3904.26 Safari/537.36
Accept:
text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3
Accept-Encoding: gzip, deflate
Accept-Language: en-US,en;q=0.9,en-GB;q=0.8,ar;q=0.7


----------
2020/01/22 17:08:30.249 kid1| 20,3| store.cc(774) storeCreatePureEntry:
storeCreateEntry: '<A HREF="http://neverssl.com/">http://neverssl.com/</A>'
2020/01/22 17:08:30.250 kid1| 20,3| MemObject.cc(97) MemObject: new
MemObject 0x7f3055a51990
2020/01/22 17:08:30.250 kid1| 20,3| store.cc(499) setReleaseFlag:
StoreEntry::setReleaseFlag: '[null_store_key]'
2020/01/22 17:08:30.250 kid1| 20,3| store_key_md5.cc(89) storeKeyPrivate:
storeKeyPrivate: GET <A HREF="http://neverssl.com/">http://neverssl.com/</A>
2020/01/22 17:08:30.250 kid1| 20,3| store.cc(447) hashInsert:
StoreEntry::hashInsert: Inserting Entry e:=XI/0x7f3055a51910*0 key
'17D405610D6C945224B64DBB3180E9CB'
2020/01/22 17:08:30.250 kid1| 20,3| store.cc(483) lock: storeCreateEntry
locked key 17D405610D6C945224B64DBB3180E9CB e:=XIV/0x7f3055a51910*1
2020/01/22 17:08:30.250 kid1| 20,3| store.cc(483) lock:
clientReplyContext::setReplyToStoreEntry locked key
17D405610D6C945224B64DBB3180E9CB e:=XIV/0x7f3055a51910*2
2020/01/22 17:08:30.258 kid1| 20,3| store.cc(483) lock:
StoreEntry::storeErrorResponse locked key 17D405610D6C945224B64DBB3180E9CB
e:=XIV/0x7f3055a51910*3
2020/01/22 17:08:30.258 kid1| 20,3| store.cc(1862) replaceHttpReply:
StoreEntry::replaceHttpReply: <A HREF="http://neverssl.com/">http://neverssl.com/</A>
2020/01/22 17:08:30.258 kid1| 20,2| store.cc(949) checkCachable:
StoreEntry::checkCachable: NO: not cachable
2020/01/22 17:08:30.258 kid1| 20,3| store.cc(1048) complete: storeComplete:
'17D405610D6C945224B64DBB3180E9CB'
2020/01/22 17:08:30.258 kid1| 20,3| store.cc(1337) validLength:
storeEntryValidLength: Checking '17D405610D6C945224B64DBB3180E9CB'
2020/01/22 17:08:30.258 kid1| 20,2| store.cc(949) checkCachable:
StoreEntry::checkCachable: NO: not cachable
2020/01/22 17:08:30.258 kid1| 20,3| store.cc(521) unlock:
StoreEntry::storeErrorResponse unlocking key
17D405610D6C945224B64DBB3180E9CB e:=sXINV/0x7f3055a51910*3
2020/01/22 17:08:30.259 kid1| 20,3| store.cc(483) lock: store_client::copy
locked key 17D405610D6C945224B64DBB3180E9CB e:=sXINV/0x7f3055a51910*3
2020/01/22 17:08:30.259 kid1| 20,3| store.cc(483) lock:
ClientHttpRequest::loggingEntry locked key 17D405610D6C945224B64DBB3180E9CB
e:=sXINV/0x7f3055a51910*4
2020/01/22 17:08:30.259 kid1| 11,2| client_side.cc(1392)
sendStartOfMessage: HTTP Client local=172.22.22.148:80 remote=
172.22.22.151:34728 FD 12 flags=33
2020/01/22 17:08:30.259 kid1| 11,2| client_side.cc(1393)
sendStartOfMessage: HTTP Client REPLY:
---------
HTTP/1.1 403 Forbidden
Server: squid/3.5.19
Mime-Version: 1.0
Date: Thu, 23 Jan 2020 01:08:30 GMT
Content-Type: text/html;charset=utf-8
Content-Length: 3861
X-Squid-Error: ERR_ACCESS_DENIED 0
Vary: Accept-Language
Content-Language: en-us
X-Cache: MISS from proxy-tls
X-Cache-Lookup: NONE from proxy-tls:8080
Via: 1.1 proxy-tls (squid/3.5.19)
Connection: keep-alive

complete file:<A HREF="https://pastebin.com/iBvy9naz">https://pastebin.com/iBvy9naz</A>
----------

&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Thirdly, some squid.conf improvements for other problems you have either
</I>&gt;<i> not noticed or not encountered yet:
</I>&gt;<i>
</I>&gt;<i> &gt; 3) Squid.conf
</I>&gt;<i> &gt;
</I>&gt;<i> ...
</I>&gt;<i> &gt; acl my_machine src 172.22.22.0/24
</I>&gt;<i> &gt; http_access allow my_machine
</I>&gt;<i> &gt; acl ap_clients src 172.16.10.0/24
</I>&gt;<i> &gt; acl local_clients src 172.18.10.0/24
</I>&gt;<i> &gt; acl localnet src 10.0.0.0/8
</I>&gt;<i> ...
</I>&gt;<i> &gt; http_access allow localnet
</I>&gt;<i> &gt; http_access allow ap_clients
</I>&gt;<i> &gt; http_access allow local_clients
</I>&gt;<i>
</I>&gt;<i> It looks sub-optimal to have these as separate ACLs. May as well use
</I>&gt;<i> config comments to document what ranges are which clients and put them
</I>&gt;<i> all in localnet (that is what it is for).
</I>&gt;<i>
</I>&gt;<i> eg:
</I>&gt;<i>  # AP clients
</I>&gt;<i>  acl localnet src 172.16.10.0/24
</I>&gt;<i>  # Local clients
</I>&gt;<i>  acl localnet src 172.18.10.0/24
</I>&gt;<i>  # LAN
</I>&gt;<i>  acl localnet src 10.0.0.0/8
</I>&gt;<i>
</I>&gt;<i>  http_access allow localnet
</I>&gt;<i>
</I>
Updated as suggested:)

&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; acl purge method PURGE
</I>&gt;<i> &gt; http_access deny purge
</I>&gt;<i>
</I>&gt;<i> PURGE is largely obsoleted (by HTCP CLR feature) and requires Squid to
</I>&gt;<i> perform a relatively large amount of processing per-request. Unless you
</I>&gt;<i> have tools that use it specifically it is best to remove all mention of
</I>&gt;<i> it from the config file to let Squid avoid all that work. If any mention
</I>&gt;<i> remains Squid will auto-activate the cache indexing work.
</I>&gt;<i>
</I>&gt;<i> If you do have tools using it. Then it is past time to consider/plan
</I>&gt;<i> moving those tools and Squid to using HTCP CLR instead.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; http_access deny !Safe_ports
</I>&gt;<i> &gt; http_access deny CONNECT !SSL_ports
</I>&gt;<i>
</I>&gt;<i>  ... this is where all your custom http_access rules are supposed to be.
</I>&gt;<i> The Safe_ports and SSL_Ports lines above are DoS and hijack protections.
</I>&gt;<i>
</I>
IIUC, These are not required to be here so I commented out those lines.


&gt;<i>  * DoS protections need to be first to do their job of minimizing the
</I>&gt;<i> CPU impact effectively. It is counter productive to have allow's earlier
</I>&gt;<i> than here.
</I>&gt;<i>
</I>&gt;<i>  * It is risky to let clients hijack the proxy and Squid cannot handle
</I>&gt;<i> native traffic to or from those ports anyway. If you need a specific
</I>&gt;<i> port available
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; http_reply_access allow all
</I>&gt;<i>
</I>&gt;<i> Above is the default reply handling. No need to specify.
</I>&gt;<i>
</I>&gt;<i> &gt; http_access deny all
</I>&gt;<i>
</I>&gt;<i> &gt; http_port 8080
</I>&gt;<i> &gt; http_port 172.22.22.148:3128 intercept
</I>&gt;<i> &gt; https_port 172.22.22.148:3129 intercept ssl-bump
</I>&gt;<i> cert=/etc/squid/ssl_certs/myCA.pem generate-host-certificates=on
</I>&gt;<i> dynamic_cert_mem_cache_size=4MB
</I>&gt;<i> &gt; sslcrtd_program /usr/lib/squid/ssl_crtd -s /var/lib/ssl_db -M 4MB
</I>&gt;<i>
</I>&gt;<i> You do need at least one non-intercept port for the direct-to-proxy
</I>&gt;<i> communications that are needed occasionally. Port 3128 is reserved for
</I>&gt;<i> that. It is best to pick a random other port number for the intercepted
</I>&gt;<i> traffic to arrive at and leave 3128 for the normal proxy traffic.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; acl step1 at_step SslBump1
</I>&gt;<i> &gt; ssl_bump peek step1
</I>&gt;<i> &gt; ssl_bump bump all
</I>&gt;<i>
</I>&gt;<i> NP: while this &quot;works&quot; bumping without any details about the server
</I>&gt;<i> (obtained at step2) can cause a lot of connection compatibility problems
</I>&gt;<i> and undesirable security side effects.  Prefer to stare at step2 and
</I>&gt;<i> bump at step 3. Do this step2 bump only as a last-resort (ie restrict it
</I>&gt;<i> to sites that are broken and cannot be worked around in other ways).
</I>&gt;<i>
</I>
As suggested, updated it to
acl step1 at_step SslBump1
acl step2 at_step SslBump2
acl step3 at_step SslBump3

ssl_bump peek step1 all
ssl_bump stare step2
ssl_bump bump step3


&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; host_verify_strict off
</I>&gt;<i>
</I>&gt;<i> The above is the default, no need to specify.
</I>&gt;<i>
</I>&gt;<i> &gt; acl oyster-vpn-test dstdomain .oyster-vpn-test.com
</I>&gt;<i> &gt; cache deny oyster-vpn-test
</I>&gt;<i> &gt; visible_hostname togo.mtv.corp.google.com
</I>&gt;<i>
</I>&gt;<i> Er ... AFAIK Google does not use that domain for their machine
</I>&gt;<i> hostnames. You sure you want to advertise your network as *.google.com ?
</I>&gt;<i>
</I>&gt;<i> Also, you only need a visible_hostname line if Squid is unable to pull
</I>&gt;<i> the machines hostname from the OS configuration.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Amos
</I>&gt;<i>
</I>&gt;<i> Thanks for your time and help  Amos.
</I>
&gt;<i>
</I>&gt;<i> ------------------------------
</I>&gt;<i>
</I>&gt;<i> Subject: Digest Footer
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> ------------------------------
</I>&gt;<i>
</I>&gt;<i> End of squid-users Digest, Vol 65, Issue 30
</I>&gt;<i> *******************************************
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20200122/e96b17b7/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20200122/e96b17b7/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="021678.html">[squid-users] Issues with TLS inspection Intercept Mode.
</A></li>
	<LI>Next message (by thread): <A HREF="021685.html">[squid-users] Issues with TLS inspection-2
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21684">[ date ]</a>
              <a href="thread.html#21684">[ thread ]</a>
              <a href="subject.html#21684">[ subject ]</a>
              <a href="author.html#21684">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
