<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid ICAP -&gt; Sophos SAVDI -&gt; read_ahead_gap question
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20ICAP%20-%3E%20Sophos%20SAVDI%20-%3E%20read_ahead_gap%0A%20question&In-Reply-To=%3C7d3fd5e9-07ce-9140-c484-96c80b95c7d9%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="021691.html">
   <LINK REL="Next"  HREF="021694.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid ICAP -&gt; Sophos SAVDI -&gt; read_ahead_gap question</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20ICAP%20-%3E%20Sophos%20SAVDI%20-%3E%20read_ahead_gap%0A%20question&In-Reply-To=%3C7d3fd5e9-07ce-9140-c484-96c80b95c7d9%40measurement-factory.com%3E"
       TITLE="[squid-users] Squid ICAP -&gt; Sophos SAVDI -&gt; read_ahead_gap question">rousskov at measurement-factory.com
       </A><BR>
    <I>Mon Jan 27 19:28:33 UTC 2020</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="021691.html">[squid-users] Squid ICAP -&gt; Sophos SAVDI -&gt; read_ahead_gap question
</A></li>
        <LI>Next message (by thread): <A HREF="021694.html">[squid-users] Squid ICAP -&gt; Sophos SAVDI -&gt; read_ahead_gap	question
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21692">[ date ]</a>
              <a href="thread.html#21692">[ thread ]</a>
              <a href="subject.html#21692">[ subject ]</a>
              <a href="author.html#21692">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 1/27/20 1:52 PM, netadmin wrote:

&gt;<i> reply_body_max_size 20 MB localnet
</I>
I would not set this option unless there is a good reason for setting it.


&gt;<i> maximum_object_size_in_memory 20 MB
</I>
If you want to cache objects that approach 20MB in body size, then raise
this to at least 21MB to account for overheads. The overheads (e.g.,
HTTP headers) are not that large, but it is easier and safer than
computing them directly.


&gt;<i> read_ahead_gap 20 MB
</I>
FYI: Due to Squid implementation deficiencies/limitations, a huge gap
like this is likely to cause large, unpooled memory allocations on
virtually every received HTTP response with a body, regardless of that
response body size. This should not cause bugs or transaction aborts,
but you should be aware of the high performance cost of such
allocations, including stalling the entire Squid worker for a few
milliseconds (at least).


&gt;<i> If I try to download a 20 MB file on all workstations at the same time,
</I>&gt;<i> without the option &quot;read_ahead_gap 20 MB&quot;, the download fails on a small
</I>&gt;<i> number of workstations.
</I>
This is an indication of a bug somewhere. The usual suspects are: Squid,
the ICAP service, the HTTP origin server.


&gt;<i> If I use disk storage for the 20 MB file, during the simultaneous download
</I>&gt;<i> the processor load reaches 100% - this I think not because of the ICAP
</I>&gt;<i> server - and download errors occur.
</I>
Persistent 100% CPU usage with 20 concurrent transactions on decent
hardware is also a red flag.


&gt;<i> Is the maximum supported size for a file transmitted to the ICAP server 20
</I>&gt;<i> MB?
</I>
No. There is virtually no maximum.


&gt;<i> Is there anything wrong with my settings?
</I>
What you want should &quot;work&quot; (in principle) without any special settings.
And it should work with/through a memory cache given a large-enough
maximum_object_size_in_memory setting.

Some of your settings might stress Squid because they set very tight
limits for 20MB objects, with no room for overheads (see above for
specifics), but even that should not really break things (especially in
your non-SMP setup) -- it may cause more cache misses and such.

I would suspect a bug (possible, but not necessarily in Squid).
Analyzing a cache.log with debug_options set to ALL,9 will probably be
enough to pin-point the culprit but may require some developer
knowledge/effort because those 20 concurrent transactions will create a
lot of debugging noise.

Alex.

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="021691.html">[squid-users] Squid ICAP -&gt; Sophos SAVDI -&gt; read_ahead_gap question
</A></li>
	<LI>Next message (by thread): <A HREF="021694.html">[squid-users] Squid ICAP -&gt; Sophos SAVDI -&gt; read_ahead_gap	question
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21692">[ date ]</a>
              <a href="thread.html#21692">[ thread ]</a>
              <a href="subject.html#21692">[ subject ]</a>
              <a href="author.html#21692">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
