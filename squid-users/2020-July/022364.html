<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] squid 5.0.3 Segment Violation when using ssl bump and	cache peer
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid%205.0.3%20Segment%20Violation%20when%20using%20ssl%20bump%0A%20and%09cache%20peer&In-Reply-To=%3CBL0PR14MB38591C38D670621C697A6EA0DF6B0%40BL0PR14MB3859.namprd14.prod.outlook.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="022363.html">
   <LINK REL="Next"  HREF="022365.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] squid 5.0.3 Segment Violation when using ssl bump and	cache peer</H1>
    <B>Brandon Doyle</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid%205.0.3%20Segment%20Violation%20when%20using%20ssl%20bump%0A%20and%09cache%20peer&In-Reply-To=%3CBL0PR14MB38591C38D670621C697A6EA0DF6B0%40BL0PR14MB3859.namprd14.prod.outlook.com%3E"
       TITLE="[squid-users] squid 5.0.3 Segment Violation when using ssl bump and	cache peer">bjd2385 at aperiodicity.com
       </A><BR>
    <I>Sat Jul  4 00:01:18 UTC 2020</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="022363.html">[squid-users] squid 5.0.3 Segment Violation when using ssl bump and	cache peer
</A></li>
        <LI>Next message (by thread): <A HREF="022365.html">[squid-users] squid 5.0.3 Segment Violation when using ssl bump and cache peer
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22364">[ date ]</a>
              <a href="thread.html#22364">[ thread ]</a>
              <a href="subject.html#22364">[ subject ]</a>
              <a href="author.html#22364">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>How do I unsubscribe from this? Been a good couple years, but I'd appreciate some help :)
________________________________
From: squid-users &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>&gt; on behalf of &#27211;&#26412;&#32024;&#24076; &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">hsmtkk at gmail.com</A>&gt;
Sent: Friday, July 3, 2020 7:49:57 PM
To: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A> &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>&gt;
Subject: [squid-users] squid 5.0.3 Segment Violation when using ssl bump and cache peer

I have a problem with squid 5.0.3.

I would like to use &quot;Peering support for SSL-Bump&quot; introduced in squid 5.
<A HREF="http://squid.mirror.colo-serv.net/archive/5/squid-5.0.2-RELEASENOTES.html#ss2.6">http://squid.mirror.colo-serv.net/archive/5/squid-5.0.2-RELEASENOTES.html#ss2.6</A>

I configured this environment using docker-compose.
client -&gt; childproxy -&gt; parentproxy -&gt; server

When I communicated client to server via childproxy and parentproxy,
&quot;Segment Violation&quot; happened and squid exited abnormally.

Do I need any extra configuration to use &quot;Peering support for SSL-Bump&quot; feature?


* squid --version output
Squid Cache: Version 5.0.3
Service Name: squid

This binary uses OpenSSL 1.1.1g  21 Apr 2020. For legal restrictions
on distribution see <A HREF="https://www.openssl.org/source/license.html">https://www.openssl.org/source/license.html</A>

configure options:  '--prefix=/usr/local/squid' '--enable-ssl-crtd'
'--disable-optimizations' '--with-openssl=/usr/local/openssl'
--enable-ltdl-convenience

* executed command and its output

$ docker exec client curl -k -x childproxy:3128 <A HREF="https://server/hello.html">https://server/hello.html</A>
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
  0     0    0     0    0     0      0      0 --:--:-- --:--:-- --:--:--     0
curl: (35) OpenSSL SSL_connect: SSL_ERROR_SYSCALL in connection to server:443

* error log

childproxy     | 2020/07/03 22:55:53 kid1| FATAL: Received Segment
Violation...dying.
childproxy     |     current master transaction: master53
childproxy     | 2020/07/03 22:55:53 kid1| Closing HTTP(S) port 0.0.0.0:3128
childproxy     |     current master transaction: master53
childproxy     | 2020/07/03 22:55:53 kid1| storeDirWriteCleanLogs: Starting...
childproxy     |     current master transaction: master53
childproxy     | 2020/07/03 22:55:53 kid1|   Finished.  Wrote 0 entries.
childproxy     |     current master transaction: master53
childproxy     | 2020/07/03 22:55:53 kid1|   Took 0.00 seconds (  0.00
entries/sec).
childproxy     |     current master transaction: master53
childproxy     | CPU Usage: 0.235 seconds = 0.106 user + 0.129 sys
childproxy     | Maximum Resident Size: 600336 KB
childproxy     | Page faults with physical i/o: 0

* core dump backtrace

#0  0x00007f8b433da387 in raise () from /lib64/libc.so.6
#1  0x00007f8b433dba78 in abort () from /lib64/libc.so.6
#2  0x000000000088b4bc in death (sig=11) at tools.cc:359
#3  &lt;signal handler called&gt;
#4  0x00000000009dbd12 in Comm::Connection::getPeer (this=0x0) at
Connection.cc:102
#5  0x00000000009dbed8 in Comm::Connection::connectTimeout (this=0x0,
fwdStart=1593816953) at Connection.cc:143
#6  0x00000000007b1332 in FwdState::connectingTimeout (this=0x2870a48,
conn=...) at FwdState.cc:1381
#7  0x00000000007ae351 in FwdState::establishTunnelThruProxy
(this=0x2870a48, conn=...) at FwdState.cc:850
#8  0x00000000007adba5 in FwdState::__lambda2::operator()
(__closure=0x7ffead0888f0) at FwdState.cc:836
#9  0x00000000007b1ca7 in
FwdState::advanceDestination&lt;FwdState::noteConnection(HappyConnOpener::Answer&amp;)::__lambda2&gt;(const
char *, const Comm::ConnectionPointer &amp;, const FwdState::__lambda2 &amp;)
(this=0x2870a48,
    stepDescription=0xb487f0 &quot;establish tunnel through proxy&quot;,
conn=..., startStep=...) at FwdState.cc:777
#10 0x00000000007ae1ca in FwdState::noteConnection (this=0x2870a48,
answer=...) at FwdState.cc:837
#11 0x00000000007b5f64 in HappyConnOpener::CbDialer&lt;FwdState&gt;::dial
(this=0x2871af8) at HappyConnOpener.h:120
#12 0x00000000007b56ed in
AsyncCallT&lt;HappyConnOpener::CbDialer&lt;FwdState&gt; &gt;::fire
(this=0x2871ac0)
    at ../src/base/AsyncCall.h:150
#13 0x000000000096c293 in AsyncCall::make (this=0x2871ac0) at AsyncCall.cc:44
#14 0x000000000096cfca in AsyncCallQueue::fireNext (this=0x23b6ec0) at
AsyncCallQueue.cc:60
#15 0x000000000096cd43 in AsyncCallQueue::fire (this=0x23b6ec0) at
AsyncCallQueue.cc:43
#16 0x000000000079afbf in EventLoop::dispatchCalls
(this=0x7ffead088c80) at EventLoop.cc:144
#17 0x000000000079aee7 in EventLoop::runOnce (this=0x7ffead088c80) at
EventLoop.cc:121
#18 0x000000000079ad4e in EventLoop::run (this=0x7ffead088c80) at
EventLoop.cc:83
#19 0x000000000081ce58 in SquidMain (argc=3, argv=0x7ffead088fb8) at
main.cc:1716
#20 0x000000000081c2c3 in SquidMainSafe (argc=3, argv=0x7ffead088fb8)
at main.cc:1403
#21 0x000000000081c296 in main (argc=3, argv=0x7ffead088fb8) at main.cc:1391

* I submitted all my configs and logs to my github page.
<A HREF="https://github.com/hsmtkk/squid5_sslbump_cachepeer/issues/1">https://github.com/hsmtkk/squid5_sslbump_cachepeer/issues/1</A>


Best regards,
Kouki Hashimoto
<A HREF="https://lists.squid-cache.org/listinfo/squid-users">hsmtkk at gmail.com</A>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20200704/5938de61/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20200704/5938de61/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="022363.html">[squid-users] squid 5.0.3 Segment Violation when using ssl bump and	cache peer
</A></li>
	<LI>Next message (by thread): <A HREF="022365.html">[squid-users] squid 5.0.3 Segment Violation when using ssl bump and cache peer
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22364">[ date ]</a>
              <a href="thread.html#22364">[ thread ]</a>
              <a href="subject.html#22364">[ subject ]</a>
              <a href="author.html#22364">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
