<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Explicitly use direct client IP in acl
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Explicitly%20use%20direct%20client%20IP%20in%20acl&In-Reply-To=%3Cc9411cf4-ae35-6bbb-0d7e-25202e17f27f%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="022398.html">
   <LINK REL="Next"  HREF="022405.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Explicitly use direct client IP in acl</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Explicitly%20use%20direct%20client%20IP%20in%20acl&In-Reply-To=%3Cc9411cf4-ae35-6bbb-0d7e-25202e17f27f%40treenet.co.nz%3E"
       TITLE="[squid-users] Explicitly use direct client IP in acl">squid3 at treenet.co.nz
       </A><BR>
    <I>Fri Jul 10 04:47:44 UTC 2020</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="022398.html">[squid-users] Explicitly use direct client IP in acl
</A></li>
        <LI>Next message (by thread): <A HREF="022405.html">[squid-users] Explicitly use direct client IP in acl
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22399">[ date ]</a>
              <a href="thread.html#22399">[ thread ]</a>
              <a href="subject.html#22399">[ subject ]</a>
              <a href="author.html#22399">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 10/07/20 2:10 pm, Orion Poplawski wrote:
&gt;<i> On 7/9/20 6:50 PM, Amos Jeffries wrote:
</I>&gt;&gt;<i> On 10/07/20 9:54 am, Orion Poplawski wrote:
</I>&gt;&gt;&gt;<i> Hello -
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> &#160;&#160; We're using a setup like this:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> client -&gt; e2guardian -&gt; squid -&gt; internet
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> e2guardian is providing filtering and SSL inspection.&#160; Currently we only
</I>&gt;&gt;&gt;<i> allow access to e2guardian from our internal network.&#160; Currently we
</I>&gt;&gt;&gt;<i> enforce access to squid come from localhost, except for some specific
</I>&gt;&gt;&gt;<i> sites which do not work with SSL inspection.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Then we allow:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> client -&gt; squid -&gt; internet
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> this is based on the (non-forwarded) client IP.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> We would like to open up access to e2g from the internet but require
</I>&gt;&gt;&gt;<i> authentication in that case.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Okay.
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> &#160;&#160; This would require the use of forwarded
</I>&gt;&gt;&gt;<i> IPs so the squid could distinguish between them (e2g does not do auth
</I>&gt;&gt;&gt;<i> directly - it lets squid handle that).&#160; But then this breaks our config
</I>&gt;&gt;&gt;<i> above because we no longer can distinguish between connections from e2g
</I>&gt;&gt;&gt;<i> and direct ones.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> How do you come to that conclusion?
</I>&gt;<i> 
</I>&gt;<i> I don't know how to distinguish between connections that go through e2g
</I>&gt;<i> and connections that do not.&#160; Currently anything with a client IP of
</I>&gt;<i> localhost has gone through e2g.&#160; Anything with a different client IP has
</I>&gt;<i> not.&#160; If I use the X-Forwarded-As IP to distinguish between internal and
</I>&gt;<i> external (for auth purposes) I no longer know how to distinguish between
</I>&gt;<i> forwarded connections and non-forwarded connections.&#160; Is there a
</I>&gt;<i> forwarded flag that can be used as an acl?&#160; I couldn't see anything in
</I>&gt;<i> the acl docs.
</I>
The purpose of XFF feature is to see the IP beyond the e2g relay.
Properly configured Squid will have no problem determining the
difference between LAN and WAN IP ranges.

Configure e2g to set the header (if needed, it may do so by default).
Then make the following squid.conf adjustments to have only the
non-localnet clients authenticate.


&gt;<i> 
</I>&gt;&gt;<i> What is your Squid version?
</I>&gt;<i> 
</I>&gt;<i> 3.5.20 (EL7), though I may be able to update 4.4 (EL8).
</I>&gt;<i> 
</I>&gt;&gt;<i> What is your current squid.conf contents?
</I>&gt;<i> 
</I>&gt;<i> This part of our ansible template.&#160; Essentially we have a list of hosts
</I>&gt;<i> in &quot;Allowed_SSL_Hosts&quot; and &quot;Allowed_HTTP_Hosts: that we allow any client
</I>&gt;<i> to connect directly through squid to (via HTTPS/HTTP respectively).
</I>&gt;<i> 
</I>&gt;<i> acl localnet src 10.0.0.0/8&#160;&#160;&#160;&#160; # RFC1918 possible internal network
</I>&gt;<i> acl localnet src 192.168.0.0/16 # RFC1918 possible internal network
</I>&gt;<i> 
</I>&gt;<i> acl SSL_ports port 443
</I>&gt;<i> acl SSL_Ports port 563&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; # smtps
</I>&gt;<i> acl SSL_Ports port 5228&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; # mtalk.google.com
</I>&gt;<i> acl Safe_ports port 80&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; # http
</I>&gt;<i> acl Safe_ports port 21&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; # ftp
</I>&gt;<i> acl Safe_ports port 443&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; # https
</I>&gt;<i> acl CONNECT method CONNECT
</I>&gt;<i> 
</I>&gt;<i> acl Allowed_SSL_Hosts ssl::server_name {{ ansible_nodename }}
</I>&gt;<i> 
</I>&gt;<i> # We can't MITM these, but allow them through the proxy
</I>&gt;<i> {% for domain in allowed_ssl_hosts %}
</I>&gt;<i> acl Allowed_SSL_Hosts ssl::server_name {{ domain }}
</I>&gt;<i> {% endfor %}
</I>&gt;<i> # Some hosts present problems for e2guardian for unknown reasons
</I>&gt;<i> {% for domain in allowed_http_hosts %}
</I>&gt;<i> acl Allowed_HTTP_Hosts dstdomain {{ domain }}
</I>&gt;<i> {% endfor %}
</I>&gt;<i> 
</I>&gt;<i> # Deny requests to certain unsafe ports
</I>&gt;<i> http_access deny !Safe_ports
</I>&gt;<i> 
</I>&gt;<i> # macOS Catalina is using CONNECT to gs.apple.com:80
</I>&gt;<i> http_access allow localnet Allowed_HTTP_Hosts
</I>&gt;<i> 
</I>&gt;<i> # Deny CONNECT to other than secure SSL ports
</I>&gt;<i> http_access deny CONNECT !SSL_ports
</I>&gt;<i> 
</I>&gt;<i> # Only allow cachemgr access from localhost
</I>&gt;<i> http_access allow localhost manager
</I>&gt;<i> http_access deny manager
</I>&gt;<i> 
</I>&gt;<i> # We strongly recommend the following be uncommented to protect innocent
</I>&gt;<i> # web applications running on the proxy server who think the only
</I>&gt;<i> # one who can access services on &quot;localhost&quot; is a local user
</I>&gt;<i> http_access deny to_localhost
</I>&gt;<i> 
</I>&gt;<i> # All traffic should be coming via e2guardian on localhost
</I>
Instead use:

 # only use the XFF header(s) set by e2guardian
 follow_x_forwarded_for allow localhost
 follow_x_forwarded_for deny all

Which updates the IP Squid sees on traffic coming through e2g.


&gt;<i> 
</I>&gt;<i> # Allow certain sites to be connected to directly
</I>&gt;<i> http_access allow CONNECT localnet Allowed_SSL_Hosts
</I>
Move this down ...

&gt;<i> 
</I>&gt;<i> # Allow some users/applications to connect from outside
</I>&gt;<i> auth_param digest realm &quot;NWRA Proxy&quot;
</I>&gt;<i> auth_param digest program /usr/lib64/squid/digest_file_auth
</I>&gt;<i> /etc/squid/passwd
</I>&gt;<i> # freshclam only supports basic auth -
</I>&gt;<i> <A HREF="https://bugzilla.clamav.net/show_bug.cgi?id=12468">https://bugzilla.clamav.net/show_bug.cgi?id=12468</A>
</I>&gt;<i> auth_param basic realm &quot;NWRA Proxy&quot;
</I>&gt;<i> auth_param basic program /usr/lib64/squid/basic_ncsa_auth
</I>&gt;<i> /etc/squid/htpasswd
</I>&gt;<i> acl authenticated_users proxy_auth REQUIRED
</I>&gt;<i> http_access allow CONNECT authenticated_users Allowed_SSL_Hosts
</I>
Instead use:
  http_access deny !localnet !authenticated_users


... to here:
  http_access allow CONNECT Allowed_SSL_Hosts

&gt;<i> # freshclam 0.101.5 uses HTTP
</I>&gt;<i> http_access allow authenticated_users Allowed_HTTP_Hosts
</I>&gt;<i> 
</I>
Instead use:
  http_access allow !localnet Allowed_HTTP_Hosts


&gt;<i> # And finally deny all other access to this proxy
</I>&gt;<i> http_access deny all
</I>&gt;<i> 
</I>&gt;<i> Thank you,
</I>&gt;<i> 
</I>&gt;<i> &#160; Orion
</I>&gt;<i> 
</I>

HTH
Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="022398.html">[squid-users] Explicitly use direct client IP in acl
</A></li>
	<LI>Next message (by thread): <A HREF="022405.html">[squid-users] Explicitly use direct client IP in acl
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22399">[ date ]</a>
              <a href="thread.html#22399">[ thread ]</a>
              <a href="subject.html#22399">[ subject ]</a>
              <a href="author.html#22399">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
