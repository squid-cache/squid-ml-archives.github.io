<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Problem with HAProxy + Squid 4.11 + Kerberos authentication
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Problem%20with%20HAProxy%20%2B%20Squid%204.11%20%2B%20Kerberos%0A%20authentication&In-Reply-To=%3C6f4e066f-f95c-c1e8-bfe8-29a106d3d7a8%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="022450.html">
   <LINK REL="Next"  HREF="022462.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Problem with HAProxy + Squid 4.11 + Kerberos authentication</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Problem%20with%20HAProxy%20%2B%20Squid%204.11%20%2B%20Kerberos%0A%20authentication&In-Reply-To=%3C6f4e066f-f95c-c1e8-bfe8-29a106d3d7a8%40treenet.co.nz%3E"
       TITLE="[squid-users] Problem with HAProxy + Squid 4.11 + Kerberos authentication">squid3 at treenet.co.nz
       </A><BR>
    <I>Fri Jul 24 03:06:18 UTC 2020</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="022450.html">[squid-users] Problem with HAProxy + Squid 4.11 + Kerberos	authentication
</A></li>
        <LI>Next message (by thread): <A HREF="022462.html">[squid-users] Problem with HAProxy + Squid 4.11 + Kerberos	authentication
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22452">[ date ]</a>
              <a href="thread.html#22452">[ thread ]</a>
              <a href="subject.html#22452">[ subject ]</a>
              <a href="author.html#22452">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 24/07/20 5:09 am, Service MV wrote:
&gt;<i> Hi Klaus,
</I>&gt;<i> I think something similar. But I understand that you can use the
</I>&gt;<i> Kerberos delegation in AD. That's partly why I'm not convinced by the
</I>&gt;<i> documentation I read, which tells me to create a user account in Active
</I>&gt;<i> Directory. And I don't understand what a user account has to do here.
</I>&gt;<i> Maybe the documentation is wrong and actually refers to a computer
</I>&gt;<i> account, and the operation of adding a Service Principal Name should be
</I>&gt;<i> done to the computer object. I don't know. But I'm going to try to do it
</I>&gt;<i> and see what I can achieve.
</I>&gt;<i> 
</I>
Kerberos authentication in HTTP uses the Negotiate scheme. The model for
that scheme is that it authenticates the exact TCP connection over which
the credentials are transmitted.

So for it to work *through* a proxy (eg HAProxy) that proxy must ensure
the *two* TCP connections it is handling (from-client and to-Squid) are
pinned together with all HTTP multiplexing features disabled _and_ the
Proxy-Auth* headers are not touched or used along the way.

 =&gt; If either of those conditions is broken the auth will not work and
users will definitely get the behaviour you are seeing. That behaviour
may also occur anyway if later stages are broken - this is just the
first and most non-obvious problem for beginners.


[ below is simplified a bit/lot to ensure you have the basic
understanding. There is a steep learning curve for Kerberos tools and
one needs basics before troubleshooting exposes the gory details ]

The HTTP agent which is doing the Kerberos auth validation (eg Squid)
must be configured with an account that can perform authentication tasks
with the central domain server.
 This can be either User or Machine account as you know. The important
difference is their policy on passwords. User accounts need password
rotation, machines are effectively permanent. Since keytab used by Squid
has to be re-generated every time the account password changes User
accounts are naturally far more complex to administrate for reliable auth.

 =&gt; So ... your choice and YMMV. But we recommend a machine account
unless you have reason to go the more complex way.


At the other end the client software needs a keytab with a &quot;Principal&quot;
name telling it what to request from the central domain server when it
needs a token that Squid can validate.

 =&gt; The principal name has to match up with the account details used by
the proxy which is checking the auth credentials. This is why the middle
proxy (eg HAProxy) cannot touch the authentication on its way to Squid.

 =&gt; The principal name is also case-sensitive and and must survive
*exact* string comparisons despite DNS resolve being involved [ because
reasons :( ].  So be sure to use full FQDN rather than host name
abbreviations.



&gt;<i> I'll be back.
</I>&gt;<i> 
</I>&gt;<i> El jue., 23 de jul. de 2020 a la(s) 13:16, Klaus Brandl escribi&#243;:
</I>&gt;<i> 
</I>&gt;<i>     Hi Gabriel,
</I>&gt;<i> 
</I>&gt;<i>     same problem here on our HA systems.
</I>&gt;<i>     I think, this is caused by kerberos overall, the tickets are always
</I>&gt;<i>     bound to
</I>&gt;<i>     the hosts realname and address, look at &quot;klist&quot; on your client, and
</I>&gt;<i>     only
</I>&gt;<i>     exactly this name could be used as proxy entry.
</I>

Indeed. Use of wrong names (eg not using the full FQDN), wrong case, or
the hostnames not being DNS resolvable are common causes of Kerberos not
working.


Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="022450.html">[squid-users] Problem with HAProxy + Squid 4.11 + Kerberos	authentication
</A></li>
	<LI>Next message (by thread): <A HREF="022462.html">[squid-users] Problem with HAProxy + Squid 4.11 + Kerberos	authentication
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22452">[ date ]</a>
              <a href="thread.html#22452">[ thread ]</a>
              <a href="subject.html#22452">[ subject ]</a>
              <a href="author.html#22452">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
