<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Problem with HAProxy + Squid 4.11 + Kerberos authentication
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Problem%20with%20HAProxy%20%2B%20Squid%204.11%20%2B%20Kerberos%0A%20authentication&In-Reply-To=%3Cvmime.5f1a9fd1.21b1.710fb8b73f27f661%40ms249-lin-003.rotterdam.bazuin.nl%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="022460.html">
   <LINK REL="Next"  HREF="022456.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Problem with HAProxy + Squid 4.11 + Kerberos authentication</H1>
    <B>L.P.H. van Belle</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Problem%20with%20HAProxy%20%2B%20Squid%204.11%20%2B%20Kerberos%0A%20authentication&In-Reply-To=%3Cvmime.5f1a9fd1.21b1.710fb8b73f27f661%40ms249-lin-003.rotterdam.bazuin.nl%3E"
       TITLE="[squid-users] Problem with HAProxy + Squid 4.11 + Kerberos authentication">belle at bazuin.nl
       </A><BR>
    <I>Fri Jul 24 08:46:09 UTC 2020</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="022460.html">[squid-users] Problem with HAProxy + Squid 4.11 + Kerberos	authentication
</A></li>
        <LI>Next message (by thread): <A HREF="022456.html">[squid-users] Problem with HAProxy + Squid 4.11 + Kerberos authentication
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22455">[ date ]</a>
              <a href="thread.html#22455">[ thread ]</a>
              <a href="subject.html#22455">[ subject ]</a>
              <a href="author.html#22455">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>i would recommend to ..
1) use debian buster,
2) use squid 4.12
3) use samba (winbind). 
&#160;
needed&#160;&#160;in smb.conf ( only shown whats really needed ), there is more offcourse. 

&#160;&#160;&#160; dedicated keytab file = /etc/krb5.keytab
&#160;&#160;&#160; kerberos method = secrets and keytab
&#160;
&#160;&#160;&#160; # renew the kerberos ticket
&#160;&#160;&#160; winbind refresh tickets = yes

&#160;&#160;&#160; # Added for freeradius support
&#160;&#160;&#160;&#160;#ntlm auth = mschapv2-and-ntlmv2-only


apt install winbind krb5-user&#160;should be sufficient. 

samba joins the domain. 
/etc/krb5.keytab contains the default part and refreshed the server kerberos passworks/tickes. 

And for squid its keytab. 

kinit Administrator
export KRB5_KTNAME=FILE:/etc/squid/HTTP-$(hostname -s).keytab
net ads keytab add_update_ads&#160;HTTP/$(hostname -f) -U Administrator

# alias name to keytab
net ads keytab ADD HTTP/CNAME.FQDN&#160;

# check keytab file.
klist -ke /etc/squid/HTTP-$(hostname -s).keytab
unset KRB5_KTNAME

# set rights.
chgrp proxy /etc/squid/HTTP-$(hostname -s).keytab
chmod g+r /etc/squid/HTTP-$(hostname -s).keytab

And i use&#160; in squid 
auth_param negotiate program /usr/lib/squid/negotiate_wrapper_auth \
&#160;&#160;&#160; --kerberos /usr/lib/squid/negotiate_kerberos_auth -k /etc/squid/HTTP-hostname.keytab \
&#160;&#160;&#160; -s HTTP/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">hostname.fqdn at REALM</A>&#160;-s HTTP/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">CNAME.FQDN at REALM</A> 
&#160;&#160;&#160; --ntlm /usr/bin/ntlm_auth --helper-protocol=gss-spnego --domain=NTDOM 

Point to think about. 


server IP's needs&#160;A + PTR&#160;
use CNAMEs in the DNS. 
and make sure the resolving is setup correctly. 

Add a caching DNS to the proxy. ( and let squid use it also ) 

I had this working (without HAproxy) but with keepalived. 

As far i can tel, your problem is in how the hostnames and ip are used.&#160;
but above might give you ideas. 


Greetz, 


Louis


&#160;

Van: squid-users [mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>] Namens Service MV
Verzonden: donderdag 23 juli 2020 17:36
Aan: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
Onderwerp: [squid-users] Problem with HAProxy + Squid 4.11 + Kerberos authentication



Hi, everybody.
I have a SQUID 4.11 compiled on Debian 9.8 with kerberos integration authenticating and browsing without problems:
cache.log
squid_kerb_auth: User some.user authenticated
access.log
10.10.10.203 TCP_TUNNEL/200 5264 CONNECT update.googleapis.com:443 some.user HIER_DIRECT/MailScanner warning: numerical links are often malicious: 172.217.162.3 -

The problem starts when I try to configure a HAProxy 1.8 load balancer to which by redundancy I configured a virtual IP with the keepalived service. When I point my browser to the DNS A record (balancer.mydomain.local) which in turn points to the keepalived virtual IP, the authentication stops working:
cache.log no records
access.log
10.10.8.207 TCP_DENIED/407 4142 CONNECT update.googleapis.com:443 - HIER_NONE/- text/


In the client browser a prompt appears requesting authentication.

I find it strange that the IP registered by SQUID is 10.10.8.207, which is the physical IP of my VM, instead of the virtual IP configured in HAProxy, which is the IP 10.10.8.213.

I send you all the configurations that I have made to see if you can help me to find where my configuration error is.

keepalived.conf &#160; global_defs {
&#160; &#160; &#160;notification_email {
&#160; &#160; &#160; &#160;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">some.user at mydomain.local</A>
&#160; &#160; &#160;}
&#160; &#160; &#160;notification_email_from <A HREF="https://lists.squid-cache.org/listinfo/squid-users">balancer1 at mydomain.local</A>
&#160; &#160; &#160;smtp_server smtp. mydomain.local 
&#160; &#160; &#160;smtp_connect_timeout 60
&#160; }

&#160; vrrp_instance VI_1 {
&#160; &#160; &#160; state MASTER
&#160; &#160; &#160; interface eth0
&#160; &#160; &#160; virtual_router_id 101
&#160; &#160; &#160; priority 101
&#160; &#160; &#160; advert_int 1
&#160; &#160; &#160; authentication {
&#160; &#160; &#160; &#160; &#160; auth_type PASS
&#160; &#160; &#160; &#160; &#160; auth_pass somepass123
&#160; &#160; &#160; }
&#160; &#160; &#160; virtual_ipaddress {
&#160; &#160; &#160; &#160; &#160; 10.10.8.213
&#160; &#160; &#160; }
&#160; }




haproxy.conf
global
log /dev/log local0
log /dev/log local1 notice
chroot /var/lib/haproxy
stats socket /run/haproxy/admin.sock mode 660 level admin
stats timeout 30s
user haproxy
group haproxy
daemon
maxconn 4000
ca-base /etc/ssl/certs
crt-base /etc/ssl/private
server=haproxy
ssl-default-bind-ciphers ECDH+AESGCM:DH+AESGCM:ECDH+AES256:DH+AES256:ECDH+AES128:DH+AES:RSA+AESGCM:RSA+AES:!aNULL:!MD5:!DSS
ssl-default-bind-options no-sslv3

defaults
balance source
log global
mode http
option httplog
option dontlognull
option http-server-close
option forwardfor except MailScanner warning: numerical links are often malicious: 127.0.0.0/8
timeout connect 5000
timeout client 50000
timeout server 50000

errorfile 400 /etc/haproxy/errors/400.http
errorfile 403 /etc/haproxy/errors/403.http
errorfile 408 /etc/haproxy/errors/408.http
errorfile 500 /etc/haproxy/errors/500.http
errorfile 502 /etc/haproxy/errors/502.http
errorfile 503 /etc/haproxy/errors/503.http
errorfile 504 /etc/haproxy/errors/504.http

### statistics
listen stats
bind MailScanner warning: numerical links are often malicious: 10.10.8.213:1936
mode http
stats enable
stats hide-version
stats realm Haproxy\ Statistics
stats uri /haproxy?stats
stats auth haproxy:somepass123

### balancer
listen squid
bind MailScanner warning: numerical links are often malicious: 10.10.8.213:3128
&#160; mode http
&#160; option httplog
&#160; balance source
&#160; hash-type consistent
&#160; option httpclose
&#160; cookie SERVERID insert indirect nocache
&#160; option forwardfor header X-Client
&#160; server proxy1 MailScanner warning: numerical links are often malicious: 10.10.8.205:3128 check inter 2000 rise 2 fall 5

&#160; server proxy2 MailScanner warning: numerical links are often malicious: 10.10.8.206:3128 check inter 2000 rise 2 fall 5







squid.conf
# minimal configuration for testing
visible_hostname proxy1.mydomain.local
http_port 3128
debug_options ALL, 1 33, 2 28, 9
maximum_object_size 8192 KB
error_directory /opt/squid411/share/errors/es-ar
shutdown_lifetime 0 seconds
forwarded_for on
auth_param negotiate program /usr/local/bin/squid_kerb_auth -i -r -s GSS_C_NO_NAME
auth_param negotiate children 300 startup=150 idle=10
auth_param negotiate keep_alive on
acl auth proxy_auth REQUIRED
http_access allow auth
acl SSL_ports port 443
acl Safe_ports port 80
acl CONNECT method CONNECT
http_access deny !Safe_ports
http_access deny CONNECT !SSL_ports
http_access deny all





squid -v
Squid Cache: Version 4.11
Service Name: squid

This binary uses OpenSSL 1.0.2u &#160;20 Dec 2019. For legal restrictions on distribution see <A HREF="https://www.openssl.org/source/license.html">https://www.openssl.org/source/license.html</A>

configure options: &#160;'--prefix=/opt/squid411' '--includedir=/include' '--mandir=/share/man' '--infodir=/share/info' '--localstatedir=/opt/squid411/var' '--disable-maintainer-mode' '--disable-dependency-tracking' '--disable-silent-rules' '--enable-inline' '--enable-async-io' '--enable-storeio=ufs,aufs,diskd' '--enable-removal-policies=lru,heap' '--enable-delay-pools' '--enable-cache-digests' '--enable-underscores' '--enable-icap-client' '--enable-follow-x-forwarded-for' '--enable-auth' '--enable-digest-auth-helpers' '--enable-negotiate-auth-helpers' '--enable-auth-ntlm' '--enable-arp-acl' '--enable-esi--disable-translation' '--with-logdir=/var/log/squid411' '--with-pidfile=/var/run/squid411.pid' '--with-filedescriptors=65536' '--with-large-files' '--with-default-user=proxy' '--enable-linux-netfilter' '--enable-ltdl-convenience' '--with-openssl' '--enable-ssl' '--enable-ssl-crtd'





env
KRB5_KTNAME=/opt/squid411/etc/PROXY.keytab
KRB5RCACHETYPE=none





/etc/krb5.conf
[libdefaults]
&#160; &#160; default_realm = MYDOMAIN.LOCAL
&#160; &#160; dns_lookup_kdc = yes
&#160; &#160; dns_lookup_realm = yes 
&#160; &#160; ticket_lifetime = 24h

&#160; &#160; &#160; &#160; default_tgs_enctypes = aes256-cts-hmac-sha1-96 rc4-hmac des-cbc-crc des-cbc-md5
&#160; &#160; &#160; &#160; default_tkt_enctypes = aes256-cts-hmac-sha1-96 rc4-hmac des-cbc-crc des-cbc-md5
&#160; &#160; &#160; &#160; permitted_enctypes = aes256-cts-hmac-sha1-96 rc4-hmac des-cbc-crc des-cbc-md5

[realms]
&#160; &#160; MYDOMAIN.LOCAL = {
&#160; &#160; &#160; &#160; kdc = s-dc00.mydomain.local
&#160; &#160; &#160; &#160; kdc = s-dc01.mydomain.local
&#160; &#160; &#160; &#160; kdc = s-dc02.mydomain.local
&#160; &#160; &#160; &#160; admin_server = s-dc00.mydomain.local
&#160; &#160; }

[domain_realm]
&#160; &#160; .mydomain.local = MYDOMAIN.LOCAL
&#160; &#160; mydomain.local = MYDOMAIN.LOCAL





msktutil -c -b &quot;OU=SERVIDORES&quot; -s HTTP/debian-proxy.mydomain.local -k /opt/squid411/etc/PROXY.keytab --computer-name DEBIAN-PROXY --upn HTTP/debian-proxy.mydomain.local --server s-dc00.mydomain.local --verbose --enctypes 28





# permissions for kaytab file
chgrp proxy /opt/squid411/etc/PROXY.keytab
chmod g+r /opt/squid411/etc/PROXY.keytab





klist
Ticket cache: FILE:/tmp/krb5cc_0
Default principal: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">some.user at MYDOMAIN.LOCAL</A>

Valid starting &#160; &#160; &#160; Expires &#160; &#160; &#160; &#160; &#160; &#160; &#160;Service principal
07/23/2020 11:59:45 &#160;07/23/2020 21:59:45 &#160;krbtgt/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">MYDOMAIN.LOCAL at MYDOMAIN.LOCAL</A>
&#160; &#160; &#160; &#160; renew until 07/24/2020 11:59:40





One thing I didn't quite understand is the procedure to authenticate from HAProxy. According to the documentation I read, I did the following:

I created a DNS A record and its PTR in my DNS server pointing to the virtual IP of the keepalived (10.10.8.213) in the HAProxy.&#160;
Then I created a &quot;HTTP_inet&quot; user account in Active Directory.
Then on my domain controller, in a CMD with administrator permissions, I ran:
setspn -S HTTP/inet.mydomain.local HTTP_inet
setspn -S HTTP/inet HTTP_inet 
In both cases the message was: object updated.
Then in my SQUID servers, I executed:
kinit <A HREF="https://lists.squid-cache.org/listinfo/squid-users">HTTP_inet at MYDOMAIN.LOCAL</A>
It asks for the user's password.
Start the ktutil tool
That's where I write:
addent -password -p HTTP/inet.mydomain.local -k 2 -e rc4-hmac
Ask the user password
addent -password -p HTTP/inet -k 2 -e rc4-hmac
Ask the user password
wkt /opt/squid411/etc/PROXY.keytab
quit

list the keys in keytab:
ktutil
read_kt /opt/squid411/etc/PROXY.keytab
&#160; &#160;1 1 DEBIAN-PROXY$@MYDOMAIN.LOCAL
&#160; &#160;2 1 DEBIAN-PROXY$@MYDOMAIN.LOCAL
&#160; &#160;3 1 DEBIAN-PROXY$@MYDOMAIN.LOCAL
&#160; &#160;4 1 HTTP/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">debian-proxy.mydomain.local at MYDOMAIN.LOCAL</A>
&#160; &#160;5 1 HTTP/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">debian-proxy.mydomain.local at MYDOMAIN.LOCAL</A>
&#160; &#160;6 1 HTTP/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">debian-proxy.mydomain.local at MYDOMAIN.LOCAL</A>
&#160; &#160;7 1 host/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">DEBIAN-PROXY at MYDOMAIN.LOCAL</A>
&#160; &#160;8 1 host/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">DEBIAN-PROXY at MYDOMAIN.LOCAL</A>
&#160; &#160;9 1 host/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">DEBIAN-PROXY at MYDOMAIN.LOCAL</A>
&#160; 10 1 host/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">debian-proxy.mydomain.local at MYDOMAIN.LOCAL</A>
&#160; 11 1 host/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">debian-proxy.mydomain.local at MYDOMAIN.LOCAL</A>
&#160; 12 1 host/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">debian-proxy.mydomain.local at MYDOMAIN.LOCAL</A>
&#160; 13 2 HTTP/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">inet.mydomain.local at MYDOMAIN.LOCAL</A>
&#160; 14 2 HTTP/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">inet at MYDOMAIN.LOCAL</A>

It's this last part I understand the least, maybe the mistake is there. Or somewhere else.
I appreciate any help you can offer me. 

Best regards,

Gabriel





-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20200724/7434a12f/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20200724/7434a12f/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="022460.html">[squid-users] Problem with HAProxy + Squid 4.11 + Kerberos	authentication
</A></li>
	<LI>Next message (by thread): <A HREF="022456.html">[squid-users] Problem with HAProxy + Squid 4.11 + Kerberos authentication
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22455">[ date ]</a>
              <a href="thread.html#22455">[ thread ]</a>
              <a href="subject.html#22455">[ subject ]</a>
              <a href="author.html#22455">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
