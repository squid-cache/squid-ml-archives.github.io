<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Problem with HAProxy + Squid 4.11 + Kerberos authentication
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Problem%20with%20HAProxy%20%2B%20Squid%204.11%20%2B%20Kerberos%0A%20authentication&In-Reply-To=%3CAM0PR04MB4753F781987A43938D17D9FB8F770%40AM0PR04MB4753.eurprd04.prod.outlook.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="022469.html">
   <LINK REL="Next"  HREF="022459.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Problem with HAProxy + Squid 4.11 + Kerberos authentication</H1>
    <B>Rafael Akchurin</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Problem%20with%20HAProxy%20%2B%20Squid%204.11%20%2B%20Kerberos%0A%20authentication&In-Reply-To=%3CAM0PR04MB4753F781987A43938D17D9FB8F770%40AM0PR04MB4753.eurprd04.prod.outlook.com%3E"
       TITLE="[squid-users] Problem with HAProxy + Squid 4.11 + Kerberos authentication">rafael.akchurin at diladele.com
       </A><BR>
    <I>Fri Jul 24 09:39:08 UTC 2020</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="022469.html">[squid-users] Problem with HAProxy + Squid 4.11 + Kerberos authentication
</A></li>
        <LI>Next message (by thread): <A HREF="022459.html">[squid-users] Problem with HAProxy + Squid 4.11 + Kerberos authentication
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22457">[ date ]</a>
              <a href="thread.html#22457">[ thread ]</a>
              <a href="subject.html#22457">[ subject ]</a>
              <a href="author.html#22457">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello Klaus, Brett, all list members,

This is the scheme with haproxy and Squid we use all the time in our test lab for Web Safety - we need to constantly add/remove test nodes to the cluster without breaking/changing anything in Kerberos settings for the constantly running client pool - <A HREF="https://docs.diladele.com/administrator_guide_stable/active_directory_extra/redundancy/haproxy_proxy_protocol.html">https://docs.diladele.com/administrator_guide_stable/active_directory_extra/redundancy/haproxy_proxy_protocol.html</A>

And yes we do *not* use computer account, we use *user* account instead.
See the reasoning  in the tutorial.

Best regards,
Rafael Akchurin
Diladele B.V.

  

-----Original Message-----
From: squid-users &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>&gt; On Behalf Of Brett Lymn
Sent: Friday, July 24, 2020 2:23 AM
To: Klaus Brandl &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">klaus_brandl at genua.de</A>&gt;
Cc: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
Subject: Re: [squid-users] Problem with HAProxy + Squid 4.11 + Kerberos authentication

On Thu, Jul 23, 2020 at 06:07:39PM +0200, Klaus Brandl wrote:
&gt;<i> 
</I>&gt;<i> But if anyone knows a solution, i will spread my ears :)
</I>&gt;<i> 
</I>
What we do is:

1) create a user account in AD that will be used for the HA front end, set a password and export the keytab for this user
2) Use ktadmin to import the keytab entries for the user created in step
1 into the keytab for squid on the squid servers.
3) Set a SPN (setspn) in AD that maps <A HREF="HTTP://ha.fqdn.address">HTTP://ha.fqdn.address</A> to the user created in 1

The SPN (service principal name) tells kerberos to use the user details set up in step 1 to authenticate http requests.  This works for us, has been for years.

One thing, if you want to know the IP addresses of your clients in the squid logs you will need to do some extra stuff because all accesses will appear to come from the HA loadbalancer.  We have configured our load balancers to insert the X-Forwarded-For header into the http traffic and then modified the logging to log both the loadblancer and client IP.

--
Brett Lymn
This email has been sent on behalf of one of the following companies within the BAE Systems Australia group of companies:

BAE Systems Australia Limited - Australian Company Number 008 423 005 BAE Systems Australia Defence Pty Limited - Australian Company Number 006 870 846 ASC Shipbuilding Pty Limited - Australian Company Number 051 899 864

BAE Systems Australia's registered office is Evans Building, Taranaki Road, Edinburgh Parks, Edindurgh, South Australia, 5111.
ASC Shipbuilding's registered office is Level 2, 80 Flinders Street, Adelaide, South Australia, 5000.
If the identity of the sending company is not clear from the content of this email, please contact the sender.

This email and any attachments may contain confidential and legally privileged information. If you are not the intended recipient, do not copy or disclose its content, but please reply to this email immediately and highlight the error to the sender and then immediately delete the message.

_______________________________________________
squid-users mailing list
<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
<A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="022469.html">[squid-users] Problem with HAProxy + Squid 4.11 + Kerberos authentication
</A></li>
	<LI>Next message (by thread): <A HREF="022459.html">[squid-users] Problem with HAProxy + Squid 4.11 + Kerberos authentication
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22457">[ date ]</a>
              <a href="thread.html#22457">[ thread ]</a>
              <a href="subject.html#22457">[ subject ]</a>
              <a href="author.html#22457">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
