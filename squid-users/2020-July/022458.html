<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Problem with HAProxy + Squid 4.11 + Kerberos authentication
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Problem%20with%20HAProxy%20%2B%20Squid%204.11%20%2B%20Kerberos%0A%20authentication&In-Reply-To=%3CAM0PR04MB475399C21B6BFEDDB8F155008F770%40AM0PR04MB4753.eurprd04.prod.outlook.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="022454.html">
   <LINK REL="Next"  HREF="022476.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Problem with HAProxy + Squid 4.11 + Kerberos authentication</H1>
    <B>Rafael Akchurin</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Problem%20with%20HAProxy%20%2B%20Squid%204.11%20%2B%20Kerberos%0A%20authentication&In-Reply-To=%3CAM0PR04MB475399C21B6BFEDDB8F155008F770%40AM0PR04MB4753.eurprd04.prod.outlook.com%3E"
       TITLE="[squid-users] Problem with HAProxy + Squid 4.11 + Kerberos authentication">rafael.akchurin at diladele.com
       </A><BR>
    <I>Fri Jul 24 09:44:48 UTC 2020</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="022454.html">[squid-users] Problem with HAProxy + Squid 4.11 + Kerberos authentication
</A></li>
        <LI>Next message (by thread): <A HREF="022476.html">[squid-users] Problem with HAProxy + Squid 4.11 + Kerberos authentication
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22458">[ date ]</a>
              <a href="thread.html#22458">[ thread ]</a>
              <a href="subject.html#22458">[ subject ]</a>
              <a href="author.html#22458">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Sorry forgot to add to Amos'es answer - use haproxy to handle *tcp* connections and let the sslbump/authentication run on the cluster of squids - thus you would get working auth on squid side and use keepalived/haproxy on the client side.

I do not see any reason why it cannot work unless you specifically desire to use some haproxy's features for l7 loadbalancing.

Best regards,
Rafael Akchurin
Diladele B.V.

-----Original Message-----
From: squid-users &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>&gt; On Behalf Of Klaus Brandl
Sent: Friday, July 24, 2020 10:45 AM
To: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
Subject: Re: [squid-users] Problem with HAProxy + Squid 4.11 + Kerberos authentication

Hi Brett,

but then you have a single point of failure, if your loadbalancer is down, 
nothing will work. We need a solution, that each system can work by itself. So 
at the moment we merge the keytabs of each system together, and we are able to 
takeover the addresses of the other systems. Then we have no loadbalancing, 
but a fallback solution, what is more important on our systems.

On Friday 24 July 2020 09:53:03 Brett Lymn wrote:
&gt;<i> On Thu, Jul 23, 2020 at 06:07:39PM +0200, Klaus Brandl wrote:
</I>&gt;<i> &gt; But if anyone knows a solution, i will spread my ears :)
</I>&gt;<i> 
</I>&gt;<i> What we do is:
</I>&gt;<i> 
</I>&gt;<i> 1) create a user account in AD that will be used for the HA front end,
</I>&gt;<i> set a password and export the keytab for this user
</I>&gt;<i> 2) Use ktadmin to import the keytab entries for the user created in step
</I>&gt;<i> 1 into the keytab for squid on the squid servers.
</I>&gt;<i> 3) Set a SPN (setspn) in AD that maps <A HREF="HTTP://ha.fqdn.address">HTTP://ha.fqdn.address</A> to the user
</I>&gt;<i> created in 1
</I>&gt;<i> 
</I>&gt;<i> The SPN (service principal name) tells kerberos to use the user details
</I>&gt;<i> set up in step 1 to authenticate http requests.  This works for us, has
</I>&gt;<i> been for years.
</I>&gt;<i> 
</I>&gt;<i> One thing, if you want to know the IP addresses of your clients in the
</I>&gt;<i> squid logs you will need to do some extra stuff because all accesses
</I>&gt;<i> will appear to come from the HA loadbalancer.  We have configured our
</I>&gt;<i> load balancers to insert the X-Forwarded-For header into the http
</I>&gt;<i> traffic and then modified the logging to log both the loadblancer and
</I>&gt;<i> client IP.
</I>
Klaus

---

genua GmbH
Domagkstrasse 7, 85551 Kirchheim bei Muenchen
tel +49 89 991950-0, fax -999, www.genua.de

Geschaeftsfuehrer: Matthias Ochs, Marc Tesch
Amtsgericht Muenchen HRB 98238
genua ist ein Unternehmen der Bundesdruckerei-Gruppe.
_______________________________________________
squid-users mailing list
<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
<A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="022454.html">[squid-users] Problem with HAProxy + Squid 4.11 + Kerberos authentication
</A></li>
	<LI>Next message (by thread): <A HREF="022476.html">[squid-users] Problem with HAProxy + Squid 4.11 + Kerberos authentication
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22458">[ date ]</a>
              <a href="thread.html#22458">[ thread ]</a>
              <a href="subject.html#22458">[ subject ]</a>
              <a href="author.html#22458">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
