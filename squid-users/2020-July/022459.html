<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Problem with HAProxy + Squid 4.11 + Kerberos authentication
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Problem%20with%20HAProxy%20%2B%20Squid%204.11%20%2B%20Kerberos%0A%20authentication&In-Reply-To=%3Cvmime.5f1ab883.6cc6.6e8b99518efe533%40ms249-lin-003.rotterdam.bazuin.nl%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="022457.html">
   <LINK REL="Next"  HREF="022460.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Problem with HAProxy + Squid 4.11 + Kerberos authentication</H1>
    <B>L.P.H. van Belle</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Problem%20with%20HAProxy%20%2B%20Squid%204.11%20%2B%20Kerberos%0A%20authentication&In-Reply-To=%3Cvmime.5f1ab883.6cc6.6e8b99518efe533%40ms249-lin-003.rotterdam.bazuin.nl%3E"
       TITLE="[squid-users] Problem with HAProxy + Squid 4.11 + Kerberos authentication">belle at bazuin.nl
       </A><BR>
    <I>Fri Jul 24 10:31:31 UTC 2020</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="022457.html">[squid-users] Problem with HAProxy + Squid 4.11 + Kerberos authentication
</A></li>
        <LI>Next message (by thread): <A HREF="022460.html">[squid-users] Problem with HAProxy + Squid 4.11 + Kerberos	authentication
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22459">[ date ]</a>
              <a href="thread.html#22459">[ thread ]</a>
              <a href="subject.html#22459">[ subject ]</a>
              <a href="author.html#22459">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hai Rafael,

First, thank you for maintaining diladele, each time i read them,
i learned something :-) As usual, your manuals look great. 

I have a few suggestion if i may point these out, just small update for the site. 

<A HREF="https://docs.diladele.com/administrator_guide_stable/active_directory/kerberos/keytab.html">https://docs.diladele.com/administrator_guide_stable/active_directory/kerberos/keytab.html</A>
This part, The krb5.conf should be updated it with. 

; for Windows 2008+ with AES support ( you might want to remove rc4 and des, its there for compatibility)
    default_tgs_enctypes = aes128-cts-hmac-sha1-96 aes256-cts-hmac-sha1-96 rc4-hmac des-cbc-crc des-cbc-md5
    default_tkt_enctypes = aes128-cts-hmac-sha1-96 aes256-cts-hmac-sha1-96 rc4-hmac des-cbc-crc des-cbc-md5
    permitted_enctypes = aes128-cts-hmac-sha1-96 aes256-cts-hmac-sha1-96 rc4-hmac des-cbc-crc des-cbc-md5


<A HREF="https://docs.diladele.com/administrator_guide_stable/active_directory/create_user/index.html">https://docs.diladele.com/administrator_guide_stable/active_directory/create_user/index.html</A>
/quote: 
Some tutorials describing integration of Squid with Active Directory rely on creating special computer account in AD for the same goal. Unfortunately it ties the proxy machine to Active Directory and prevents us from making and restoring VM snapshots because the restored snapshot loses the AD join state and needs to be rejoined manually.
/quote.

Well, all i can say here is, this works fine for me, but i understand where its coming from. 
As your pointing out, yes, i did use a &quot;user&quot; account also in the past.
But if samba/winbind is setup correcty with its hostName, and you use CNAMES for the proxy it's serviceName, 
after a backup/restore of a VM and samba/winbind starts, winbind handles the &quot;computername&quot; keytab and its password.
Squid has its own keytab file and CNAME and is untouched. 

Resulting in, you can restore a VM. I do this on XenServers, i suggest, give it a try. 
But note, i dont have HAProxy running (yet), so i cant say anyting about that part,
The logical parts should be the same (hostname A - PTR and CNAMES for serices) 

The COMPUTER needs A and PTR (this is the real hostname) 
Now you can setup any CNAME SPN for the proxy it's &quot;ServiceName&quot; 
You can use or the computer account or a separated account for the Squid CNAME-ed SPN's. 
Als long these are somewhere to findable in AD. 

You might want to test this, this setup removed the need of ktpass in windows, 
which was always giving problems at my side. 

And last, if winbind is use and you want to add a automounted homedir with NFS or CIFS.
Then half of the work is already done. 
It basicly only needs : nfs-common nfs4-acl-tools 
And : 
net ads keytab add_update_ads nfs/$(hostname -f) -U Administrator
And/or 
net ads keytab add_update_ads cifs/$(hostname -f) -U Administrator

In the Haproxy setup, well, thats next on my list, 
i saw something i liked and dont have it running yet.  
Learning a lot here. :-) 

Main difference between your setups, i dont have any windows servers. 
I running fully on Samba AD-DC's and member servers and my client PC's are windows 10. 

I hope I could give you someone ideas here and people can use them. 
If you have questions, just ask. 


Greetz, 

Louis



&gt;<i> -----Oorspronkelijk bericht-----
</I>&gt;<i> Van: squid-users 
</I>&gt;<i> [mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>] Namens 
</I>&gt;<i> Rafael Akchurin
</I>&gt;<i> Verzonden: vrijdag 24 juli 2020 11:39
</I>&gt;<i> Aan: Brett Lymn; Klaus Brandl
</I>&gt;<i> CC: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> Onderwerp: Re: [squid-users] Problem with HAProxy + Squid 
</I>&gt;<i> 4.11 + Kerberos authentication
</I>&gt;<i> 
</I>&gt;<i> Hello Klaus, Brett, all list members,
</I>&gt;<i> 
</I>&gt;<i> This is the scheme with haproxy and Squid we use all the time 
</I>&gt;<i> in our test lab for Web Safety - we need to constantly 
</I>&gt;<i> add/remove test nodes to the cluster without 
</I>&gt;<i> breaking/changing anything in Kerberos settings for the 
</I>&gt;<i> constantly running client pool - 
</I>&gt;<i> <A HREF="https://docs.diladele.com/administrator_guide_stable/active_di">https://docs.diladele.com/administrator_guide_stable/active_di</A>
</I>&gt;<i> rectory_extra/redundancy/haproxy_proxy_protocol.html
</I>&gt;<i> 
</I>&gt;<i> And yes we do *not* use computer account, we use *user* 
</I>&gt;<i> account instead.
</I>&gt;<i> See the reasoning  in the tutorial.
</I>&gt;<i> 
</I>&gt;<i> Best regards,
</I>&gt;<i> Rafael Akchurin
</I>&gt;<i> Diladele B.V.
</I>&gt;<i> 
</I>&gt;<i>   
</I>&gt;<i> 
</I>&gt;<i> -----Original Message-----
</I>&gt;<i> From: squid-users &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>&gt; 
</I>&gt;<i> On Behalf Of Brett Lymn
</I>&gt;<i> Sent: Friday, July 24, 2020 2:23 AM
</I>&gt;<i> To: Klaus Brandl &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">klaus_brandl at genua.de</A>&gt;
</I>&gt;<i> Cc: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> Subject: Re: [squid-users] Problem with HAProxy + Squid 4.11 
</I>&gt;<i> + Kerberos authentication
</I>&gt;<i> 
</I>&gt;<i> On Thu, Jul 23, 2020 at 06:07:39PM +0200, Klaus Brandl wrote:
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; But if anyone knows a solution, i will spread my ears :)
</I>&gt;<i> &gt; 
</I>&gt;<i> 
</I>&gt;<i> What we do is:
</I>&gt;<i> 
</I>&gt;<i> 1) create a user account in AD that will be used for the HA 
</I>&gt;<i> front end, set a password and export the keytab for this user
</I>&gt;<i> 2) Use ktadmin to import the keytab entries for the user 
</I>&gt;<i> created in step
</I>&gt;<i> 1 into the keytab for squid on the squid servers.
</I>&gt;<i> 3) Set a SPN (setspn) in AD that maps <A HREF="HTTP://ha.fqdn.address">HTTP://ha.fqdn.address</A> 
</I>&gt;<i> to the user created in 1
</I>&gt;<i> 
</I>&gt;<i> The SPN (service principal name) tells kerberos to use the 
</I>&gt;<i> user details set up in step 1 to authenticate http requests.  
</I>&gt;<i> This works for us, has been for years.
</I>&gt;<i> 
</I>&gt;<i> One thing, if you want to know the IP addresses of your 
</I>&gt;<i> clients in the squid logs you will need to do some extra 
</I>&gt;<i> stuff because all accesses will appear to come from the HA 
</I>&gt;<i> loadbalancer.  We have configured our load balancers to 
</I>&gt;<i> insert the X-Forwarded-For header into the http traffic and 
</I>&gt;<i> then modified the logging to log both the loadblancer and client IP.
</I>&gt;<i> 
</I>&gt;<i> --
</I>&gt;<i> Brett Lymn
</I>&gt;<i> This email has been sent on behalf of one of the following 
</I>&gt;<i> companies within the BAE Systems Australia group of companies:
</I>&gt;<i> 
</I>&gt;<i> BAE Systems Australia Limited - Australian Company Number 008 
</I>&gt;<i> 423 005 BAE Systems Australia Defence Pty Limited - 
</I>&gt;<i> Australian Company Number 006 870 846 ASC Shipbuilding Pty 
</I>&gt;<i> Limited - Australian Company Number 051 899 864
</I>&gt;<i> 
</I>&gt;<i> BAE Systems Australia's registered office is Evans Building, 
</I>&gt;<i> Taranaki Road, Edinburgh Parks, Edindurgh, South Australia, 5111.
</I>&gt;<i> ASC Shipbuilding's registered office is Level 2, 80 Flinders 
</I>&gt;<i> Street, Adelaide, South Australia, 5000.
</I>&gt;<i> If the identity of the sending company is not clear from the 
</I>&gt;<i> content of this email, please contact the sender.
</I>&gt;<i> 
</I>&gt;<i> This email and any attachments may contain confidential and 
</I>&gt;<i> legally privileged information. If you are not the intended 
</I>&gt;<i> recipient, do not copy or disclose its content, but please 
</I>&gt;<i> reply to this email immediately and highlight the error to 
</I>&gt;<i> the sender and then immediately delete the message.
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i> 
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="022457.html">[squid-users] Problem with HAProxy + Squid 4.11 + Kerberos authentication
</A></li>
	<LI>Next message (by thread): <A HREF="022460.html">[squid-users] Problem with HAProxy + Squid 4.11 + Kerberos	authentication
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22459">[ date ]</a>
              <a href="thread.html#22459">[ thread ]</a>
              <a href="subject.html#22459">[ subject ]</a>
              <a href="author.html#22459">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
