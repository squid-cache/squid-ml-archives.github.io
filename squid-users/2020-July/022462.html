<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Problem with HAProxy + Squid 4.11 + Kerberos	authentication
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Problem%20with%20HAProxy%20%2B%20Squid%204.11%20%2B%20Kerberos%0A%09authentication&In-Reply-To=%3CCA%2Bd%3D%3DoEJ08CsFz4DZyjbcZqN04dbMdCyV1%2BPzCDCnfMJ%2B_GH2w%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="022452.html">
   <LINK REL="Next"  HREF="022451.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Problem with HAProxy + Squid 4.11 + Kerberos	authentication</H1>
    <B>Service MV</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Problem%20with%20HAProxy%20%2B%20Squid%204.11%20%2B%20Kerberos%0A%09authentication&In-Reply-To=%3CCA%2Bd%3D%3DoEJ08CsFz4DZyjbcZqN04dbMdCyV1%2BPzCDCnfMJ%2B_GH2w%40mail.gmail.com%3E"
       TITLE="[squid-users] Problem with HAProxy + Squid 4.11 + Kerberos	authentication">service.mv at gmail.com
       </A><BR>
    <I>Fri Jul 24 14:23:27 UTC 2020</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="022452.html">[squid-users] Problem with HAProxy + Squid 4.11 + Kerberos authentication
</A></li>
        <LI>Next message (by thread): <A HREF="022451.html">[squid-users] Problem with HAProxy + Squid 4.11 + Kerberos authentication
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22462">[ date ]</a>
              <a href="thread.html#22462">[ thread ]</a>
              <a href="subject.html#22462">[ subject ]</a>
              <a href="author.html#22462">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Thanks Amos, Kerberos is really hard to learn for a rookie like me, but you
explained it in an excellent and concise way.
In my case, the SQUID servers are joined to the domain with their
respective SPN and UPN that I mentioned in the msktutil command.
And in the case of the Load Balancer HAProxy I used a user account and I
set that the password does not expire. I know this may not be the safest
way to do it, but I couldn't find a way to do it with a computer account. I
guess I should join the HAProxy to the domain as well.
The detail, as you mentioned, is that the DNS A record (eg
inet.mydomain.local) is to match exactly the SPN for that user account,
which at this point is a service account.

Thanks again

Gabriel

El vie., 24 de jul. de 2020 a la(s) 00:10, Amos Jeffries (
<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>) escribi&#243;:

&gt;<i> On 24/07/20 5:09 am, Service MV wrote:
</I>&gt;<i> &gt; Hi Klaus,
</I>&gt;<i> &gt; I think something similar. But I understand that you can use the
</I>&gt;<i> &gt; Kerberos delegation in AD. That's partly why I'm not convinced by the
</I>&gt;<i> &gt; documentation I read, which tells me to create a user account in Active
</I>&gt;<i> &gt; Directory. And I don't understand what a user account has to do here.
</I>&gt;<i> &gt; Maybe the documentation is wrong and actually refers to a computer
</I>&gt;<i> &gt; account, and the operation of adding a Service Principal Name should be
</I>&gt;<i> &gt; done to the computer object. I don't know. But I'm going to try to do it
</I>&gt;<i> &gt; and see what I can achieve.
</I>&gt;<i> &gt;
</I>&gt;<i>
</I>&gt;<i> Kerberos authentication in HTTP uses the Negotiate scheme. The model for
</I>&gt;<i> that scheme is that it authenticates the exact TCP connection over which
</I>&gt;<i> the credentials are transmitted.
</I>&gt;<i>
</I>&gt;<i> So for it to work *through* a proxy (eg HAProxy) that proxy must ensure
</I>&gt;<i> the *two* TCP connections it is handling (from-client and to-Squid) are
</I>&gt;<i> pinned together with all HTTP multiplexing features disabled _and_ the
</I>&gt;<i> Proxy-Auth* headers are not touched or used along the way.
</I>&gt;<i>
</I>&gt;<i>  =&gt; If either of those conditions is broken the auth will not work and
</I>&gt;<i> users will definitely get the behaviour you are seeing. That behaviour
</I>&gt;<i> may also occur anyway if later stages are broken - this is just the
</I>&gt;<i> first and most non-obvious problem for beginners.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> [ below is simplified a bit/lot to ensure you have the basic
</I>&gt;<i> understanding. There is a steep learning curve for Kerberos tools and
</I>&gt;<i> one needs basics before troubleshooting exposes the gory details ]
</I>&gt;<i>
</I>&gt;<i> The HTTP agent which is doing the Kerberos auth validation (eg Squid)
</I>&gt;<i> must be configured with an account that can perform authentication tasks
</I>&gt;<i> with the central domain server.
</I>&gt;<i>  This can be either User or Machine account as you know. The important
</I>&gt;<i> difference is their policy on passwords. User accounts need password
</I>&gt;<i> rotation, machines are effectively permanent. Since keytab used by Squid
</I>&gt;<i> has to be re-generated every time the account password changes User
</I>&gt;<i> accounts are naturally far more complex to administrate for reliable auth.
</I>&gt;<i>
</I>&gt;<i>  =&gt; So ... your choice and YMMV. But we recommend a machine account
</I>&gt;<i> unless you have reason to go the more complex way.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> At the other end the client software needs a keytab with a &quot;Principal&quot;
</I>&gt;<i> name telling it what to request from the central domain server when it
</I>&gt;<i> needs a token that Squid can validate.
</I>&gt;<i>
</I>&gt;<i>  =&gt; The principal name has to match up with the account details used by
</I>&gt;<i> the proxy which is checking the auth credentials. This is why the middle
</I>&gt;<i> proxy (eg HAProxy) cannot touch the authentication on its way to Squid.
</I>&gt;<i>
</I>&gt;<i>  =&gt; The principal name is also case-sensitive and and must survive
</I>&gt;<i> *exact* string comparisons despite DNS resolve being involved [ because
</I>&gt;<i> reasons :( ].  So be sure to use full FQDN rather than host name
</I>&gt;<i> abbreviations.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; I'll be back.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; El jue., 23 de jul. de 2020 a la(s) 13:16, Klaus Brandl escribi&#243;:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     Hi Gabriel,
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     same problem here on our HA systems.
</I>&gt;<i> &gt;     I think, this is caused by kerberos overall, the tickets are always
</I>&gt;<i> &gt;     bound to
</I>&gt;<i> &gt;     the hosts realname and address, look at &quot;klist&quot; on your client, and
</I>&gt;<i> &gt;     only
</I>&gt;<i> &gt;     exactly this name could be used as proxy entry.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Indeed. Use of wrong names (eg not using the full FQDN), wrong case, or
</I>&gt;<i> the hostnames not being DNS resolvable are common causes of Kerberos not
</I>&gt;<i> working.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Amos
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20200724/f18afcff/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20200724/f18afcff/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="022452.html">[squid-users] Problem with HAProxy + Squid 4.11 + Kerberos authentication
</A></li>
	<LI>Next message (by thread): <A HREF="022451.html">[squid-users] Problem with HAProxy + Squid 4.11 + Kerberos authentication
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22462">[ date ]</a>
              <a href="thread.html#22462">[ thread ]</a>
              <a href="subject.html#22462">[ subject ]</a>
              <a href="author.html#22462">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
