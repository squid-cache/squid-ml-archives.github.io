<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Problem with HAProxy + Squid 4.11 + Kerberos authentication
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Problem%20with%20HAProxy%20%2B%20Squid%204.11%20%2B%20Kerberos%0A%20authentication&In-Reply-To=%3CCA%2Bd%3D%3DoFG0TBgbS%2B-OsEgyeegaAjtzANoUmDGSEugE0YyeB_a9Q%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="022458.html">
   <LINK REL="Next"  HREF="022469.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Problem with HAProxy + Squid 4.11 + Kerberos authentication</H1>
    <B>Service MV</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Problem%20with%20HAProxy%20%2B%20Squid%204.11%20%2B%20Kerberos%0A%20authentication&In-Reply-To=%3CCA%2Bd%3D%3DoFG0TBgbS%2B-OsEgyeegaAjtzANoUmDGSEugE0YyeB_a9Q%40mail.gmail.com%3E"
       TITLE="[squid-users] Problem with HAProxy + Squid 4.11 + Kerberos authentication">service.mv at gmail.com
       </A><BR>
    <I>Mon Jul 27 21:12:50 UTC 2020</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="022458.html">[squid-users] Problem with HAProxy + Squid 4.11 + Kerberos authentication
</A></li>
        <LI>Next message (by thread): <A HREF="022469.html">[squid-users] Problem with HAProxy + Squid 4.11 + Kerberos authentication
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22476">[ date ]</a>
              <a href="thread.html#22476">[ thread ]</a>
              <a href="subject.html#22476">[ subject ]</a>
              <a href="author.html#22476">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi everybody!
I am just writing to thank you all for the excellent comments, you have
been very helpful.

I also take this opportunity to mention which operating model I decided to
use, which is working well so far.

DNS A and PTR record &quot;balancer.mydomain.local&quot; pointing to keepalived
virtual IP of HAProxy. This is my HA frontend.
Haproxy server in TCP mode.
The SQUID nodes joined to the domain and authenticated by Kerberos and LDAP.
In each SQUID node I added the credentials of the AD user account in the
keytab. I configured the AD user account 'without expiring the password'
and 'not requiring pre-authentication kerberos'.
If anyone wants or needs more information just let me know.

Best regards

Gabriel


squid.conf
visible_hostname debian-proxy.mydomain.local
http_port 3128 require-proxy-header
acl haproxy src 10.10.8.213
proxy_protocol_access allow haproxy
debug_options ALL, 1 33, 2 28, 9
maximum_object_size 8192 KB
error_directory /opt/squid411/share/errors/es-ar
shutdown_lifetime 0 seconds
forwarded_for transparent
auth_param negotiate program /usr/local/bin/squid_kerb_auth -i -r -s
GSS_C_NO_NAME
auth_param negotiate children 300 startup=150 idle=10
auth_param negotiate keep_alive on
auth_param basic program /opt/squid411/libexec/basic_ldap_auth -P -R -b
&quot;dc=mydomain,dc=local&quot; -D &quot;cn=ldap,cn=Users,dc=mydomain,dc=local&quot; -W
/opt/squid411/etc/ldappass.txt -f sAMAccountName=%s -h dc1.mydomain.local
auth_param basic children 30
auth_param basic realm Proxy Authentication
auth_param basic credentialsttl 4 hour
acl auth proxy_auth REQUIRED
http_access allow auth
acl SSL_ports port 443
acl Safe_ports port 80
acl CONNECT method CONNECT
http_access deny !Safe_ports
http_access deny CONNECT !SSL_ports

http_access deny all


haproxy.cfg
global
    log /dev/log    local0
    log /dev/log    local1 notice
    chroot /var/lib/haproxy
    stats socket /run/haproxy/admin.sock mode 660 level admin
    stats timeout 30s
    user haproxy
    group haproxy
    daemon

defaults
    log     global
    mode    tcp
    option  tcplog
    option  dontlognull
    timeout connect 5000
    timeout client  50000
    timeout server  50000

frontend squid
    bind 10.10.8.213:3128
    default_backend squid_pool

backend squid_pool
    balance source
    mode tcp
    option tcp-check
    tcp-check connect port 3128
    server squid1 10.10.8.205:3128 check inter 2000 rise 2 fall 3 send-proxy
    server squid2 10.10.8.214:3128 check inter 2000 rise 2 fall 3 send-proxy

ktutil
read_kt /opt/squid411/etc/PROXY.keytab
list
   1 1 DEBIAN-PROXY$@MYDOMAIN.LOCAL
   2 1 DEBIAN-PROXY$@MYDOMAIN.LOCAL
   3 1 DEBIAN-PROXY$@MYDOMAIN.LOCAL
   4 1 HTTP/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">debian-proxy.mydomain.local at MYDOMAIN.LOCAL</A>
   5 1 HTTP/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">debian-proxy.mydomain.local at MYDOMAIN.LOCAL</A>
   6 1 HTTP/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">debian-proxy.mydomain.local at MYDOMAIN.LOCAL</A>
   7 1 host/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">DEBIAN-PROXY at MYDOMAIN.LOCAL</A>
   8 1 host/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">DEBIAN-PROXY at MYDOMAIN.LOCAL</A>
   9 1 host/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">DEBIAN-PROXY at MYDOMAIN.LOCAL</A>
  10 1 host/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">debian-proxy.mydomain.local at MYDOMAIN.LOCAL</A>
  11 1 host/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">debian-proxy.mydomain.local at MYDOMAIN.LOCAL</A>
  12 1 host/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">debian-proxy.mydomain.local at MYDOMAIN.LOCAL</A>
  13 2 HTTP/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">inet.mydomain.local at MYDOMAIN.LOCAL</A>
  14 2 HTTP/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">inet at MYDOMAIN.LOCAL</A>

global_defs {
    notification_email {
      <A HREF="https://lists.squid-cache.org/listinfo/squid-users">some.user at mydomain.local</A>
    }
    notification_email_from <A HREF="https://lists.squid-cache.org/listinfo/squid-users">pxbalancer01 at mydomain.local</A>
    smtp_server smtp.mydomain.local
    smtp_connect_timeout 60
    router_id pxbalancer01
    }

    vrrp_instance VI_1 {
      state MASTER
      interface eth0
      virtual_router_id 114
      priority 110
      advert_int 1
      authentication {
        auth_type PASS
        auth_pass SomePASS123
        }
      virtual_ipaddress {
        10.10.8.213
        }
      virtual_routes {
        10.10.8.0/22 via 10.10.8.207 src 10.10.8.213
        }
}


El vie., 24 de jul. de 2020 a la(s) 06:44, Rafael Akchurin (
<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rafael.akchurin at diladele.com</A>) escribi&#243;:

&gt;<i> Sorry forgot to add to Amos'es answer - use haproxy to handle *tcp*
</I>&gt;<i> connections and let the sslbump/authentication run on the cluster of squids
</I>&gt;<i> - thus you would get working auth on squid side and use keepalived/haproxy
</I>&gt;<i> on the client side.
</I>&gt;<i>
</I>&gt;<i> I do not see any reason why it cannot work unless you specifically desire
</I>&gt;<i> to use some haproxy's features for l7 loadbalancing.
</I>&gt;<i>
</I>&gt;<i> Best regards,
</I>&gt;<i> Rafael Akchurin
</I>&gt;<i> Diladele B.V.
</I>&gt;<i>
</I>&gt;<i> -----Original Message-----
</I>&gt;<i> From: squid-users &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>&gt; On Behalf
</I>&gt;<i> Of Klaus Brandl
</I>&gt;<i> Sent: Friday, July 24, 2020 10:45 AM
</I>&gt;<i> To: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> Subject: Re: [squid-users] Problem with HAProxy + Squid 4.11 + Kerberos
</I>&gt;<i> authentication
</I>&gt;<i>
</I>&gt;<i> Hi Brett,
</I>&gt;<i>
</I>&gt;<i> but then you have a single point of failure, if your loadbalancer is down,
</I>&gt;<i> nothing will work. We need a solution, that each system can work by
</I>&gt;<i> itself. So
</I>&gt;<i> at the moment we merge the keytabs of each system together, and we are
</I>&gt;<i> able to
</I>&gt;<i> takeover the addresses of the other systems. Then we have no
</I>&gt;<i> loadbalancing,
</I>&gt;<i> but a fallback solution, what is more important on our systems.
</I>&gt;<i>
</I>&gt;<i> On Friday 24 July 2020 09:53:03 Brett Lymn wrote:
</I>&gt;<i> &gt; On Thu, Jul 23, 2020 at 06:07:39PM +0200, Klaus Brandl wrote:
</I>&gt;<i> &gt; &gt; But if anyone knows a solution, i will spread my ears :)
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; What we do is:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; 1) create a user account in AD that will be used for the HA front end,
</I>&gt;<i> &gt; set a password and export the keytab for this user
</I>&gt;<i> &gt; 2) Use ktadmin to import the keytab entries for the user created in step
</I>&gt;<i> &gt; 1 into the keytab for squid on the squid servers.
</I>&gt;<i> &gt; 3) Set a SPN (setspn) in AD that maps <A HREF="HTTP://ha.fqdn.address">HTTP://ha.fqdn.address</A> to the user
</I>&gt;<i> &gt; created in 1
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; The SPN (service principal name) tells kerberos to use the user details
</I>&gt;<i> &gt; set up in step 1 to authenticate http requests.  This works for us, has
</I>&gt;<i> &gt; been for years.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; One thing, if you want to know the IP addresses of your clients in the
</I>&gt;<i> &gt; squid logs you will need to do some extra stuff because all accesses
</I>&gt;<i> &gt; will appear to come from the HA loadbalancer.  We have configured our
</I>&gt;<i> &gt; load balancers to insert the X-Forwarded-For header into the http
</I>&gt;<i> &gt; traffic and then modified the logging to log both the loadblancer and
</I>&gt;<i> &gt; client IP.
</I>&gt;<i>
</I>&gt;<i> Klaus
</I>&gt;<i>
</I>&gt;<i> ---
</I>&gt;<i>
</I>&gt;<i> genua GmbH
</I>&gt;<i> Domagkstrasse 7, 85551 Kirchheim bei Muenchen
</I>&gt;<i> tel +49 89 991950-0, fax -999, www.genua.de
</I>&gt;<i>
</I>&gt;<i> Geschaeftsfuehrer: Matthias Ochs, Marc Tesch
</I>&gt;<i> Amtsgericht Muenchen HRB 98238
</I>&gt;<i> genua ist ein Unternehmen der Bundesdruckerei-Gruppe.
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20200727/11458cde/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20200727/11458cde/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="022458.html">[squid-users] Problem with HAProxy + Squid 4.11 + Kerberos authentication
</A></li>
	<LI>Next message (by thread): <A HREF="022469.html">[squid-users] Problem with HAProxy + Squid 4.11 + Kerberos authentication
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22476">[ date ]</a>
              <a href="thread.html#22476">[ thread ]</a>
              <a href="subject.html#22476">[ subject ]</a>
              <a href="author.html#22476">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
