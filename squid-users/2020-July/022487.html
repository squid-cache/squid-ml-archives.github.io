<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] SQUID with cache_peer config + E2guardian - too many connections
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20SQUID%20with%20cache_peer%20config%20%2B%20E2guardian%20-%20too%0A%20many%20connections&In-Reply-To=%3C908969db-4b54-70a7-3758-a295d2f7f4a4%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="022486.html">
   <LINK REL="Next"  HREF="022488.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] SQUID with cache_peer config + E2guardian - too many connections</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20SQUID%20with%20cache_peer%20config%20%2B%20E2guardian%20-%20too%0A%20many%20connections&In-Reply-To=%3C908969db-4b54-70a7-3758-a295d2f7f4a4%40treenet.co.nz%3E"
       TITLE="[squid-users] SQUID with cache_peer config + E2guardian - too many connections">squid3 at treenet.co.nz
       </A><BR>
    <I>Wed Jul 29 02:50:11 UTC 2020</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="022486.html">[squid-users] SQUID with cache_peer config + E2guardian - too many connections
</A></li>
        <LI>Next message (by thread): <A HREF="022488.html">[squid-users] SQUID with cache_peer config + E2guardian - too many connections
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22487">[ date ]</a>
              <a href="thread.html#22487">[ thread ]</a>
              <a href="subject.html#22487">[ subject ]</a>
              <a href="author.html#22487">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 29/07/20 1:07 pm, Contato - KONNTROL wrote:
&gt;<i> Hello Everyone,
</I>&gt;<i> Greetings.
</I>&gt;<i> 
</I>&gt;<i> Background:
</I>&gt;<i> OS - FreeBSD 12.1
</I>&gt;<i> SQUID ver 4.10
</I>&gt;<i> OpenSSL 1.0.2u
</I>&gt;<i> 
</I>&gt;<i> I am trying to use SQUID in front of E2Guardian (content filter) with the
</I>&gt;<i> following configuration at the SQUID side.
</I>&gt;<i> 
</I>&gt;<i> ###
</I>&gt;<i> cache_peer 127.0.0.1 parent 8080 0 login=*:password
</I>&gt;<i> client_persistent_connections on
</I>&gt;<i> always_direct deny all
</I>&gt;<i> never_direct allow all
</I>&gt;<i> ###
</I>&gt;<i> 
</I>&gt;<i> It works fine till the point  SQUID exhausts all E2Guardian threads/workers,
</I>&gt;<i> no matter the amount you set. If 1000, SQUID is opening 1000 connections. If
</I>&gt;<i> 10.000, squid also opens 10.000 connections.
</I>&gt;<i> I tried the directive &quot;client_persistent_connections on and off&quot; with no
</I>&gt;<i> success.
</I>&gt;<i> Even using a single browser for testing purposes, for some reason SQUID
</I>&gt;<i> opens thousands of connections against the E2guardian.
</I>&gt;<i> I did a wireshark capture to &quot;see&quot; what is  happening and it seems like a
</I>&gt;<i> lot of ACK/SYN with no payload.
</I>&gt;<i> 
</I>&gt;<i> Any idea? Maybe I am using a wrong configuration.
</I>&gt;<i> 
</I>
You are. BUT, I think you have a forwarding loop happening so the
correct config for limiting connections will not help.

You should be able to test for loops by enabling the Via header. If your
squid.conf contains &quot;via off&quot; remove that line. Assuming e2g is not
removing that header Squid will reject loops with an error message.


Check that the traffic leaving e2g is not going back into Squid. With
the setup described e2g should be connecting directly to
upstream/Internet servers - it should have no settings about Squid
except those for processing the X-Forwarded-For header.

If you are intercepting traffic to deliver it to Squid make sure the
connections leaving e2g are not being caught by those firewall rules.


If you are certain there is no loop the cache_peer max-conn=N is the way
to limit the connections made to a peer. This will only help if the
problem is high traffic flow. It will not help if there is a forwarding
loop happening.


&gt;<i> By the way, I am using SQUID in front of E2Guardian cause I use Kerberos
</I>&gt;<i> authentication (not supported by E2guardian) with FORWARDX option enable.
</I>&gt;<i> 
</I>
Sure. You may want to look at the features of e2g you are using and see
whether Squid can do them instead. The idea there being to make deny
decisions early as possible to minimize the total amount of processing
work those transactions consume.
 You may find you can get rid of e2g entirely, which will improve
overall performance and reduce management headaches from layers of proxy.


Cheers
Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="022486.html">[squid-users] SQUID with cache_peer config + E2guardian - too many connections
</A></li>
	<LI>Next message (by thread): <A HREF="022488.html">[squid-users] SQUID with cache_peer config + E2guardian - too many connections
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22487">[ date ]</a>
              <a href="thread.html#22487">[ thread ]</a>
              <a href="subject.html#22487">[ subject ]</a>
              <a href="author.html#22487">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
