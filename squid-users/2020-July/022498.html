<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid and multipart form decode
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20and%20multipart%20form%20decode&In-Reply-To=%3Cb3b8f9ad-e46a-2c64-5502-1c9864ed047c%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="022497.html">
   <LINK REL="Next"  HREF="022500.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid and multipart form decode</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20and%20multipart%20form%20decode&In-Reply-To=%3Cb3b8f9ad-e46a-2c64-5502-1c9864ed047c%40measurement-factory.com%3E"
       TITLE="[squid-users] Squid and multipart form decode">rousskov at measurement-factory.com
       </A><BR>
    <I>Wed Jul 29 16:16:15 UTC 2020</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="022497.html">[squid-users] Squid and multipart form decode
</A></li>
        <LI>Next message (by thread): <A HREF="022500.html">[squid-users] Squid and multipart form decode
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22498">[ date ]</a>
              <a href="thread.html#22498">[ thread ]</a>
              <a href="subject.html#22498">[ subject ]</a>
              <a href="author.html#22498">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 7/29/20 11:38 AM, Ryan Le wrote:
&gt;<i> Even though it looks like TeChunkedParser is getting all the
</I>&gt;<i> additional&#160;headers 
</I>
TeChunkedParser has nothing to do with multipart/form-data bodies.
TeChunkedParser parses chunked encoding, and even then it is applied to
remove _transfer_ encoding, not to interpret the actual resource content
inside the chunks.

I am not sure, but it looks like you have pasted a part of an ICAP
message. TeChunkedParser is used to parse chunked transfer encoding used
for a part of the ICAP message body. Beyond decoding those chunks, it is
all opaque data to Squid.

To avoid misunderstanding, in your pasted example, the contents of the
first chunk starts with these two lines:

&gt;<i> -----------------------------328901485836611227811186534509
</I>&gt;<i> Content-Disposition: form-data; name=&quot;action&quot;
</I>
It does _not_ start with the &quot;Content-Disposition:...&quot; line or the
&quot;frm_submit_dropzone&quot; line.


&gt;<i> I can't seem to create ACL or output them using
</I>&gt;<i> logformat. I was trying to request these headers with
</I>&gt;<i> req_mime_type/resp_mime_type. 
</I>
If by &quot;them&quot; you mean MIME headers inside multipart parts, then Squid
does not see them and does not operate on them. The insides of each
chunk is opaque data to Squid.


&gt;<i> and alos had log_mime_hdrs on and then in
</I>&gt;<i> logformat just had all.
</I>
You should be able to log the HTTP request header values using %&gt;h or
%&gt;ha. You will not be able to log or match any message body snippets,
including things like MIME Content-Disposition values. Squid does not
look inside the body of the POSTed resource.


If you need further help, you may want to clarify what you are trying to
achieve. You said &quot;send multipart form data to another service&quot;. Are you
trying to _route_ request messages based on multipart form _contents_?


HTH,

Alex.


&gt;<i> On Thu, Jul 23, 2020 at 11:46 AM Ryan Le wrote:
</I>&gt;<i> 
</I>&gt;<i>     Thanks,&#160;
</I>&gt;<i> 
</I>&gt;<i>     I have been looking at the squid debug and can see that it is
</I>&gt;<i>     getting the multipart.
</I>&gt;<i> 
</I>&gt;<i>     POST <A HREF="http://bbbbbb.com">http://bbbbbb.com</A>
</I>&gt;<i>     User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:78.0)
</I>&gt;<i>     Gecko/20100101 Firefox/78.0
</I>&gt;<i>     Accept: application/json
</I>&gt;<i>     Accept-Language: en-US,en;q=0.5
</I>&gt;<i>     Accept-Encoding: gzip, deflate
</I>&gt;<i>     Referer: <A HREF="http://bbbbb.com">http://bbbbb.com</A>
</I>&gt;<i>     Cache-Control: no-cache
</I>&gt;<i>     X-Requested-With: XMLHttpRequest
</I>&gt;<i>     Content-Type: multipart/form-data;
</I>&gt;<i>     boundary=---------------------------328901485836611227811186534509
</I>&gt;<i>     Content-Length: 1245
</I>&gt;<i>     Origin: <A HREF="http://bbbbb.com">http://bbbbb.com</A>
</I>&gt;<i>     Cookie: cookie
</I>&gt;<i>     Host: bbbbbbb.com &lt;<A HREF="http://bbbbbbb.com">http://bbbbbbb.com</A>&gt;
</I>&gt;<i>     Via: ICAP/1.0&#160;
</I>&gt;<i> 
</I>&gt;<i>     4dd
</I>&gt;<i>     -----------------------------328901485836611227811186534509
</I>&gt;<i>     Content-Disposition: form-data; name=&quot;action&quot;
</I>&gt;<i> 
</I>&gt;<i>     frm_submit_dropzone
</I>&gt;<i>     -----------------------------328901485836611227811186534509
</I>&gt;<i>     Content-Disposition: form-data; name=&quot;field_id&quot;
</I>&gt;<i> 
</I>&gt;<i>     8
</I>&gt;<i>     -----------------------------328901485836611227811186534509
</I>&gt;<i>     Content-Disposition: form-data; name=&quot;form_id&quot;
</I>&gt;<i> 
</I>&gt;<i>     5
</I>&gt;<i>     -----------------------------328901485836611227811186534509
</I>&gt;<i>     Content-Disposition: form-data; name=&quot;nonce&quot;
</I>&gt;<i> 
</I>&gt;<i>     e1aca92777
</I>&gt;<i>     -----------------------------328901485836611227811186534509
</I>&gt;<i>     Content-Disposition: form-data; name=&quot;file8&quot;; filename=&quot;translate.zip&quot;
</I>&gt;<i>     Content-Type: application/x-zip-compressed
</I>&gt;<i> 
</I>&gt;<i>     On Thu, Jul 23, 2020 at 11:16 AM Alex Rousskov
</I>&gt;<i>     &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>
</I>&gt;<i>     &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt;&gt; wrote:
</I>&gt;<i> 
</I>&gt;<i>         On 7/23/20 9:22 AM, Ryan Le wrote:
</I>&gt;<i>         &gt; I have been trying to configure squid to decode and send
</I>&gt;<i>         multipart form
</I>&gt;<i>         &gt; data to another service. Is there an acl or build parameter
</I>&gt;<i>         needed for
</I>&gt;<i>         &gt; multipart form data support?
</I>&gt;<i> 
</I>&gt;<i>         No, there is no need to allow any specific Content-Type, including
</I>&gt;<i>         multipart. Squid does not know anything about
</I>&gt;<i>         multipart/form-data. If a
</I>&gt;<i>         multipart/form-data message is well-formed from HTTP point of
</I>&gt;<i>         view, then
</I>&gt;<i>         Squid will process it as any other message, including passing it to
</I>&gt;<i>         ICAP/eCAP (where configured).
</I>&gt;<i> 
</I>&gt;<i>         Cheers,
</I>&gt;<i> 
</I>&gt;<i>         Alex.
</I>&gt;<i> 
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="022497.html">[squid-users] Squid and multipart form decode
</A></li>
	<LI>Next message (by thread): <A HREF="022500.html">[squid-users] Squid and multipart form decode
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22498">[ date ]</a>
              <a href="thread.html#22498">[ thread ]</a>
              <a href="subject.html#22498">[ subject ]</a>
              <a href="author.html#22498">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
