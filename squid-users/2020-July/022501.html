<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid and multipart form decode
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20and%20multipart%20form%20decode&In-Reply-To=%3C7f759101-c7e3-f07c-9564-4c6bfd2c4d1a%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="022500.html">
   <LINK REL="Next"  HREF="022447.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid and multipart form decode</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20and%20multipart%20form%20decode&In-Reply-To=%3C7f759101-c7e3-f07c-9564-4c6bfd2c4d1a%40measurement-factory.com%3E"
       TITLE="[squid-users] Squid and multipart form decode">rousskov at measurement-factory.com
       </A><BR>
    <I>Wed Jul 29 17:49:41 UTC 2020</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="022500.html">[squid-users] Squid and multipart form decode
</A></li>
        <LI>Next message (by thread): <A HREF="022447.html">[squid-users] Problem with HAProxy + Squid 4.11 + Kerberos	authentication
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22501">[ date ]</a>
              <a href="thread.html#22501">[ thread ]</a>
              <a href="subject.html#22501">[ subject ]</a>
              <a href="author.html#22501">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 7/29/20 12:47 PM, Ryan Le wrote:

&gt;&gt;&gt;<i> Even though it looks like TeChunkedParser is getting all the
</I>&gt;&gt;&gt;<i> additional&#160;headers
</I>
&gt;&gt;<i> TeChunkedParser has nothing to do with multipart/form-data bodies.
</I>
&gt;<i> I do see it in two locations.
</I>
&gt;<i> 2020/07/26 23:11:12.921 kid6| 74,9| TeChunkedParser.cc(45) parse: Parse
</I>&gt;<i> buf={length=3667, data='e47
</I>&gt;<i> -----------------------------351645264024548376901231954897
</I>&gt;<i> Content-Disposition: form-data; name=&quot;action&quot;
</I>...

You see the parser reporting the raw input buffer that it is about to
parse. The parser will treat everything you see after the first &quot;e47&quot;
line (which specifies the chunk size in hex) as opaque body bytes (until
the start of the next chunk metadata).


&gt;<i> As well as the following location
</I>
&gt;<i> 2020/07/26 23:11:12.921 kid6| 58,9| HttpMsg.cc(198) parse:
</I>&gt;<i> HttpMsg::parse success (689 bytes) near 'POST <A HREF="http://bbbb.com/post">http://bbbb.com/post</A> HTTP/1.1
</I>&gt;<i> User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:78.0)
</I>...

Same problem. It is just a raw input buffer dump.


&gt;<i> What I am ultimately trying to accomplish is to see the best way to get
</I>&gt;<i> more detail and have an action on sites&#160;
</I>&gt;<i> that are posting using multipart/form-data as the Content-Type header.
</I>
ACL-driven actions based on the Content-Type header value should work
fine. Logging of the Content-Type header value to access.log should work
fine.  If something does not work, please provide a specific non-working
configuration example.

Some of your earlier messages sounded like you want Squid to act based
on MIME headers inside the message body or even the values of HTML form
entries. Squid cannot do that on its own. To analyze message bodies
(even in read-only mode), you will need a custom ICAP or eCAP service:
<A HREF="https://wiki.squid-cache.org/SquidFaq/ContentAdaptation">https://wiki.squid-cache.org/SquidFaq/ContentAdaptation</A>


HTH,

Alex.



&gt;<i> On Wed, Jul 29, 2020 at 12:16 PM Alex Rousskov wrote:
</I>&gt;<i> 
</I>&gt;<i>     On 7/29/20 11:38 AM, Ryan Le wrote:
</I>&gt;<i>     &gt; Even though it looks like TeChunkedParser is getting all the
</I>&gt;<i>     &gt; additional&#160;headers
</I>&gt;<i> 
</I>&gt;<i>     TeChunkedParser has nothing to do with multipart/form-data bodies.
</I>&gt;<i>     TeChunkedParser parses chunked encoding, and even then it is applied to
</I>&gt;<i>     remove _transfer_ encoding, not to interpret the actual resource content
</I>&gt;<i>     inside the chunks.
</I>&gt;<i> 
</I>&gt;<i>     I am not sure, but it looks like you have pasted a part of an ICAP
</I>&gt;<i>     message. TeChunkedParser is used to parse chunked transfer encoding used
</I>&gt;<i>     for a part of the ICAP message body. Beyond decoding those chunks, it is
</I>&gt;<i>     all opaque data to Squid.
</I>&gt;<i> 
</I>&gt;<i>     To avoid misunderstanding, in your pasted example, the contents of the
</I>&gt;<i>     first chunk starts with these two lines:
</I>&gt;<i> 
</I>&gt;<i>     &gt; -----------------------------328901485836611227811186534509
</I>&gt;<i>     &gt; Content-Disposition: form-data; name=&quot;action&quot;
</I>&gt;<i> 
</I>&gt;<i>     It does _not_ start with the &quot;Content-Disposition:...&quot; line or the
</I>&gt;<i>     &quot;frm_submit_dropzone&quot; line.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i>     &gt; I can't seem to create ACL or output them using
</I>&gt;<i>     &gt; logformat. I was trying to request these headers with
</I>&gt;<i>     &gt; req_mime_type/resp_mime_type.
</I>&gt;<i> 
</I>&gt;<i>     If by &quot;them&quot; you mean MIME headers inside multipart parts, then Squid
</I>&gt;<i>     does not see them and does not operate on them. The insides of each
</I>&gt;<i>     chunk is opaque data to Squid.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i>     &gt; and alos had log_mime_hdrs on and then in
</I>&gt;<i>     &gt; logformat just had all.
</I>&gt;<i> 
</I>&gt;<i>     You should be able to log the HTTP request header values using %&gt;h or
</I>&gt;<i>     %&gt;ha. You will not be able to log or match any message body snippets,
</I>&gt;<i>     including things like MIME Content-Disposition values. Squid does not
</I>&gt;<i>     look inside the body of the POSTed resource.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i>     If you need further help, you may want to clarify what you are trying to
</I>&gt;<i>     achieve. You said &quot;send multipart form data to another service&quot;. Are you
</I>&gt;<i>     trying to _route_ request messages based on multipart form _contents_?
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i>     HTH,
</I>&gt;<i> 
</I>&gt;<i>     Alex.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i>     &gt; On Thu, Jul 23, 2020 at 11:46 AM Ryan Le wrote:
</I>&gt;<i>     &gt;
</I>&gt;<i>     &gt;&#160; &#160; &#160;Thanks,&#160;
</I>&gt;<i>     &gt;
</I>&gt;<i>     &gt;&#160; &#160; &#160;I have been looking at the squid debug and can see that it is
</I>&gt;<i>     &gt;&#160; &#160; &#160;getting the multipart.
</I>&gt;<i>     &gt;
</I>&gt;<i>     &gt;&#160; &#160; &#160;POST <A HREF="http://bbbbbb.com">http://bbbbbb.com</A>
</I>&gt;<i>     &gt;&#160; &#160; &#160;User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:78.0)
</I>&gt;<i>     &gt;&#160; &#160; &#160;Gecko/20100101 Firefox/78.0
</I>&gt;<i>     &gt;&#160; &#160; &#160;Accept: application/json
</I>&gt;<i>     &gt;&#160; &#160; &#160;Accept-Language: en-US,en;q=0.5
</I>&gt;<i>     &gt;&#160; &#160; &#160;Accept-Encoding: gzip, deflate
</I>&gt;<i>     &gt;&#160; &#160; &#160;Referer: <A HREF="http://bbbbb.com">http://bbbbb.com</A>
</I>&gt;<i>     &gt;&#160; &#160; &#160;Cache-Control: no-cache
</I>&gt;<i>     &gt;&#160; &#160; &#160;X-Requested-With: XMLHttpRequest
</I>&gt;<i>     &gt;&#160; &#160; &#160;Content-Type: multipart/form-data;
</I>&gt;<i>     &gt;&#160; &#160; &#160;boundary=---------------------------328901485836611227811186534509
</I>&gt;<i>     &gt;&#160; &#160; &#160;Content-Length: 1245
</I>&gt;<i>     &gt;&#160; &#160; &#160;Origin: <A HREF="http://bbbbb.com">http://bbbbb.com</A>
</I>&gt;<i>     &gt;&#160; &#160; &#160;Cookie: cookie
</I>&gt;<i>     &gt;&#160; &#160; &#160;Host: bbbbbbb.com &lt;<A HREF="http://bbbbbbb.com">http://bbbbbbb.com</A>&gt; &lt;<A HREF="http://bbbbbbb.com">http://bbbbbbb.com</A>&gt;
</I>&gt;<i>     &gt;&#160; &#160; &#160;Via: ICAP/1.0&#160;
</I>&gt;<i>     &gt;
</I>&gt;<i>     &gt;&#160; &#160; &#160;4dd
</I>&gt;<i>     &gt;&#160; &#160; &#160;-----------------------------328901485836611227811186534509
</I>&gt;<i>     &gt;&#160; &#160; &#160;Content-Disposition: form-data; name=&quot;action&quot;
</I>&gt;<i>     &gt;
</I>&gt;<i>     &gt;&#160; &#160; &#160;frm_submit_dropzone
</I>&gt;<i>     &gt;&#160; &#160; &#160;-----------------------------328901485836611227811186534509
</I>&gt;<i>     &gt;&#160; &#160; &#160;Content-Disposition: form-data; name=&quot;field_id&quot;
</I>&gt;<i>     &gt;
</I>&gt;<i>     &gt;&#160; &#160; &#160;8
</I>&gt;<i>     &gt;&#160; &#160; &#160;-----------------------------328901485836611227811186534509
</I>&gt;<i>     &gt;&#160; &#160; &#160;Content-Disposition: form-data; name=&quot;form_id&quot;
</I>&gt;<i>     &gt;
</I>&gt;<i>     &gt;&#160; &#160; &#160;5
</I>&gt;<i>     &gt;&#160; &#160; &#160;-----------------------------328901485836611227811186534509
</I>&gt;<i>     &gt;&#160; &#160; &#160;Content-Disposition: form-data; name=&quot;nonce&quot;
</I>&gt;<i>     &gt;
</I>&gt;<i>     &gt;&#160; &#160; &#160;e1aca92777
</I>&gt;<i>     &gt;&#160; &#160; &#160;-----------------------------328901485836611227811186534509
</I>&gt;<i>     &gt;&#160; &#160; &#160;Content-Disposition: form-data; name=&quot;file8&quot;;
</I>&gt;<i>     filename=&quot;translate.zip&quot;
</I>&gt;<i>     &gt;&#160; &#160; &#160;Content-Type: application/x-zip-compressed
</I>&gt;<i>     &gt;
</I>&gt;<i>     &gt;&#160; &#160; &#160;On Thu, Jul 23, 2020 at 11:16 AM Alex Rousskov
</I>&gt;<i>     &gt;&#160; &#160; &#160;&lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>
</I>&gt;<i>     &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt;
</I>&gt;<i>     &gt;&#160; &#160; &#160;&lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>
</I>&gt;<i>     &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt;&gt;&gt; wrote:
</I>&gt;<i>     &gt;
</I>&gt;<i>     &gt;&#160; &#160; &#160; &#160; &#160;On 7/23/20 9:22 AM, Ryan Le wrote:
</I>&gt;<i>     &gt;&#160; &#160; &#160; &#160; &#160;&gt; I have been trying to configure squid to decode and send
</I>&gt;<i>     &gt;&#160; &#160; &#160; &#160; &#160;multipart form
</I>&gt;<i>     &gt;&#160; &#160; &#160; &#160; &#160;&gt; data to another service. Is there an acl or build parameter
</I>&gt;<i>     &gt;&#160; &#160; &#160; &#160; &#160;needed for
</I>&gt;<i>     &gt;&#160; &#160; &#160; &#160; &#160;&gt; multipart form data support?
</I>&gt;<i>     &gt;
</I>&gt;<i>     &gt;&#160; &#160; &#160; &#160; &#160;No, there is no need to allow any specific Content-Type,
</I>&gt;<i>     including
</I>&gt;<i>     &gt;&#160; &#160; &#160; &#160; &#160;multipart. Squid does not know anything about
</I>&gt;<i>     &gt;&#160; &#160; &#160; &#160; &#160;multipart/form-data. If a
</I>&gt;<i>     &gt;&#160; &#160; &#160; &#160; &#160;multipart/form-data message is well-formed from HTTP point of
</I>&gt;<i>     &gt;&#160; &#160; &#160; &#160; &#160;view, then
</I>&gt;<i>     &gt;&#160; &#160; &#160; &#160; &#160;Squid will process it as any other message, including
</I>&gt;<i>     passing it to
</I>&gt;<i>     &gt;&#160; &#160; &#160; &#160; &#160;ICAP/eCAP (where configured).
</I>&gt;<i>     &gt;
</I>&gt;<i>     &gt;&#160; &#160; &#160; &#160; &#160;Cheers,
</I>&gt;<i>     &gt;
</I>&gt;<i>     &gt;&#160; &#160; &#160; &#160; &#160;Alex.
</I>&gt;<i>     &gt;
</I>&gt;<i> 
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="022500.html">[squid-users] Squid and multipart form decode
</A></li>
	<LI>Next message (by thread): <A HREF="022447.html">[squid-users] Problem with HAProxy + Squid 4.11 + Kerberos	authentication
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22501">[ date ]</a>
              <a href="thread.html#22501">[ thread ]</a>
              <a href="subject.html#22501">[ subject ]</a>
              <a href="author.html#22501">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
