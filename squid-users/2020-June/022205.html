<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] squid-4.9 TCP_MISS_ABORTED  and memory leak
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid-4.9%20TCP_MISS_ABORTED%20%20and%20memory%20leak&In-Reply-To=%3C202006021944529635161%40eeoa.com%3E%2B61563EA9255EC2BD">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="022204.html">
   <LINK REL="Next"  HREF="022206.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] squid-4.9 TCP_MISS_ABORTED  and memory leak</H1>
    <B>biao.wei at eeoa.com</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid-4.9%20TCP_MISS_ABORTED%20%20and%20memory%20leak&In-Reply-To=%3C202006021944529635161%40eeoa.com%3E%2B61563EA9255EC2BD"
       TITLE="[squid-users] squid-4.9 TCP_MISS_ABORTED  and memory leak">biao.wei at eeoa.com
       </A><BR>
    <I>Tue Jun  2 11:44:53 UTC 2020</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="022204.html">[squid-users] Squid 4.4 https_port and ssl-bump : Fatal bungled	line
</A></li>
        <LI>Next message (by thread): <A HREF="022206.html">[squid-users] squid-4.9 TCP_MISS_ABORTED and memory leak
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22205">[ date ]</a>
              <a href="thread.html#22205">[ thread ]</a>
              <a href="subject.html#22205">[ subject ]</a>
              <a href="author.html#22205">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>hi squid developer:
    we use squid-4.9 meet two questions&#65306;
      (1)some request have timeout, not response to user data neither to request upstream from log information.
      (2)memory leak, now we need restart squid to release memory.

       look forward to response.

1. log format
logformat logfmt_cdn [%{%Y-%m-%d:%H:%M:%S}tl.%03tu] %{X-Real-IP}&gt;h %&gt;a:%&gt;p %&lt;a:%&lt;p %rm %03&gt;Hs %&lt;st %&gt;st HTTP/%&gt;rv &quot;%&gt;<A HREF="rs://%">rs://%</A>&gt;rd:%&gt;rP&quot; &quot;%&gt;rp&quot; &quot;%{Referer}&gt;h&quot; &quot;%{User-Agent}&gt;h&quot; %tr %&lt;pt %03&lt;Hs %Ss %Sh/%&lt;A &quot;%{Range}&gt;h&quot; &quot;%{xxx-ComeFrom}&gt;h&quot; &quot;%{xxx-Origin-Domain}&gt;h&quot;

2. log infomation
[2020-06-01:10:59:40.346] 123.124.197.113 10.8.120.9:40680 -:- GET 206 396 740 HTTP/1.1 &quot;<A HREF="http://download.xx.com:80">http://download.xx.com:80</A>&quot; &quot;/xx_mac_install_1.0.0.114_s.dmg&quot; &quot;-&quot; &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/83.0.4103.61 Safari/537.36&quot; 850826 - - TCP_MISS_ABORTED HIER_NONE/- &quot;bytes=25165824-25165824&quot; &quot;tcdn&quot; &quot;download.xx.com&quot;
[2020-06-01:11:02:12.629] 123.124.197.113 10.8.120.10:49318 -:- GET 206 402 743 HTTP/1.1 &quot;<A HREF="http://download.xx.com:80">http://download.xx.com:80</A>&quot; &quot;/xx_mac_install_1.0.0.114_s.dmg&quot; &quot;-&quot; &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/83.0.4103.61 Safari/537.36&quot; 850299 - - TCP_MISS_ABORTED HIER_NONE/- &quot;bytes=48234496-49283071&quot; &quot;tcdn&quot; &quot;download.xx.com&quot;

3. topology
  origin site &lt;---  [squid &lt;- nginx]  &lt;--- bussiness cdn &lt;--- users

4.  config files

squid.conf
coredump_dir /var/spool/squid
pid_filename /var/run/squid.pid
httpd_suppress_version_string on
via off
cache_effective_user squid
cache_effective_group squid

max_filedescriptors 65535 
cache_swap_low 90
cache_swap_high 95
minimum_object_size 0 KB
maximum_object_size 200 MB

acl urlpath_QUERY urlpath_regex -i cgi-bin \? \.php \.xml
no_cache deny urlpath_QUERY  
# acl urlpath_denyssl urlpath_regex -i ^https:\\
# no_cache deny urlpath_denyssl

logformat logfmt_cdn [%{%Y-%m-%d:%H:%M:%S}tl.%03tu] %{X-Real-IP}&gt;h %&gt;a:%&gt;p %&lt;a:%&lt;p %rm %03&gt;Hs %&lt;st %&gt;st HTTP/%&gt;rv &quot;%&gt;<A HREF="rs://%">rs://%</A>&gt;rd:%&gt;rP&quot; &quot;%&gt;rp&quot; &quot;%{Referer}&gt;h&quot; &quot;%{User-Agent}&gt;h&quot; %tr %&lt;pt %03&lt;Hs %Ss %Sh/%&lt;A &quot;%{Range}&gt;h&quot; &quot;%{EEO-ComeFrom}&gt;h&quot; &quot;%{xxx-Origin-Domain}&gt;h&quot;
acl nolog_url url_regex -i cache_object

cache_log /data/cache.log
cache_store_log none 
logfile_rotate 1

quick_abort_min 512 KB
quick_abort_max 512 KB
quick_abort_pct 80

range_offset_limit -1
reload_into_ims on
# collapsed_forwarding on

client_db off
dns_v4_first on
dns_nameservers 127.0.0.1
dns_retransmit_interval 0.01 second
dns_timeout 0.01 second
dns_defnames off
ignore_unknown_nameservers on
ipcache_size 10240
ipcache_low 90
ipcache_high 95
fqdncache_size 1024
positive_dns_ttl 365 days
negative_dns_ttl 365 days

peer_connect_timeout 30 seconds

connect_timeout 10 minutes
client_idle_pconn_timeout 10 minutes
server_idle_pconn_timeout 10 minutes

client_persistent_connections on
server_persistent_connections off
half_closed_clients off
request_entities off

reply_header_access Server deny all
reply_header_access X-Cache-Lookup deny all

include /etc/squid/upstream.conf
include /etc/squid/node.conf


upstream.conf
acl dstdomain_www.xxx.com  dstdomain www.xxx.com
cache_peer_access peer2www1 allow dstdomain_ www.xxx.com
cache_peer_access peer2www1 deny all
cache_peer_access peer2www2 allow dstdomain_ www.xxx.com
cache_peer_access peer2www2 deny all
access_log daemon:/data/squid/ www.xxx.com_all.access.log logfmt_cdn dstdomain_ www.xxx.com !nolog_url



node.conf
workers 6
hopeless_kid_revival_delay 1 year
cpu_affinity_map process_numbers=1,2,3,4,5,6 cores=1,3,5,7,9,11
cache_mem 60 GB
maximum_object_size_in_memory 100 MB

cache_dir rock /data1/squid/cache1 400000 max-size=204800000

cache_peer 10.1.1.13 parent 61160 0 no-query no-digest no-netdb-exchange originserver forceddomain=www.xxx.com   name=peer2www1   round-robin weight=1 connect-fail-limit=3
cache_peer 10.1.1.14 parent 61160 0 no-query no-digest no-netdb-exchange originserver forceddomain=www.xxx.com   name=peer2www2   round-robin weight=1 connect-fail-limit=3

-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20200602/f23768a7/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20200602/f23768a7/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="022204.html">[squid-users] Squid 4.4 https_port and ssl-bump : Fatal bungled	line
</A></li>
	<LI>Next message (by thread): <A HREF="022206.html">[squid-users] squid-4.9 TCP_MISS_ABORTED and memory leak
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22205">[ date ]</a>
              <a href="thread.html#22205">[ thread ]</a>
              <a href="subject.html#22205">[ subject ]</a>
              <a href="author.html#22205">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
