<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] squid-4.9 TCP_MISS_ABORTED and memory leak
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid-4.9%20TCP_MISS_ABORTED%20and%20memory%20leak&In-Reply-To=%3Cb8c7acab-d5d8-17f7-2bb1-5108f2903cab%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="022205.html">
   <LINK REL="Next"  HREF="022207.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] squid-4.9 TCP_MISS_ABORTED and memory leak</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid-4.9%20TCP_MISS_ABORTED%20and%20memory%20leak&In-Reply-To=%3Cb8c7acab-d5d8-17f7-2bb1-5108f2903cab%40treenet.co.nz%3E"
       TITLE="[squid-users] squid-4.9 TCP_MISS_ABORTED and memory leak">squid3 at treenet.co.nz
       </A><BR>
    <I>Thu Jun  4 08:12:12 UTC 2020</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="022205.html">[squid-users] squid-4.9 TCP_MISS_ABORTED  and memory leak
</A></li>
        <LI>Next message (by thread): <A HREF="022207.html">[squid-users] Adaptation error
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22206">[ date ]</a>
              <a href="thread.html#22206">[ thread ]</a>
              <a href="subject.html#22206">[ subject ]</a>
              <a href="author.html#22206">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 2/06/20 11:44 pm, biao.wei wrote:
&gt;<i> hi squid developer:
</I>&gt;<i> &#160; &#160; we use squid-4.9 meet two questions&#65306;
</I>&gt;<i> &#160; &#160;&#160;&#160; (1)some request have timeout, not response to user data neither to
</I>&gt;<i> request upstream from log information.
</I>
Your logs are showing just over 14min to deliver 360 bytes to the
client. That smells like a routing MTU issue, probably ICMP packets
being dropped.



&gt;<i> &#160; &#160; &#160; (2)memory leak, now we need restart squid to release memory.
</I>
memory leaks are a rarity these days. Note that your large caches
require up to 530 GB of RAM spread over the 8 Squid processes. Plus
whatever the active traffic may be consuming - which may be some GB.
That is not all going to be allocated on startup, it will grow as the
caches fill, particularly the in-memory ones.

If you still think there is a leak - details are required.


&gt;<i> 
</I>&gt;<i> &#160; &#160;&#160; &#160; look forward to response.
</I>&gt;<i> 
</I>&gt;<i> 1. log format
</I>&gt;<i> logformat logfmt_cdn [%{%Y-%m-%d:%H:%M:%S}tl.%03tu] %{X-Real-IP}&gt;h
</I>&gt;<i> %&gt;a:%&gt;p %&lt;a:%&lt;p %rm %03&gt;Hs %&lt;st %&gt;st HTTP/%&gt;rv &quot;%&gt;<A HREF="rs://%">rs://%</A>&gt;rd:%&gt;rP&quot; &quot;%&gt;rp&quot;
</I>&gt;<i> &quot;%{Referer}&gt;h&quot; &quot;%{User-Agent}&gt;h&quot; %tr %&lt;pt %03&lt;Hs %Ss %Sh/%&lt;A
</I>&gt;<i> &quot;%{Range}&gt;h&quot; &quot;%{xxx-ComeFrom}&gt;h&quot; &quot;%{xxx-Origin-Domain}&gt;h&quot;
</I>&gt;<i> 
</I>&gt;<i> 2. log infomation
</I>&gt;<i> [2020-06-01:10:59:40.346] 123.124.197.113 10.8.120.9:40680 -:- GET 206
</I>&gt;<i> 396 740 HTTP/1.1 &quot;<A HREF="http://download.xx.com:80">http://download.xx.com:80</A>&quot;
</I>&gt;<i> &quot;/xx_mac_install_1.0.0.114_s.dmg&quot; &quot;-&quot; &quot;Mozilla/5.0 (Windows NT 10.0;
</I>&gt;<i> Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/83.0.4103.61
</I>&gt;<i> Safari/537.36&quot; 850826 - - TCP_MISS_ABORTED HIER_NONE/-
</I>&gt;<i> &quot;bytes=25165824-25165824&quot; &quot;tcdn&quot; &quot;download.xx.com&quot;
</I>&gt;<i> [2020-06-01:11:02:12.629] 123.124.197.113 10.8.120.10:49318 -:- GET 206
</I>&gt;<i> 402 743 HTTP/1.1 &quot;<A HREF="http://download.xx.com:80">http://download.xx.com:80</A>&quot;
</I>&gt;<i> &quot;/xx_mac_install_1.0.0.114_s.dmg&quot; &quot;-&quot; &quot;Mozilla/5.0 (Windows NT 10.0;
</I>&gt;<i> Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/83.0.4103.61
</I>&gt;<i> Safari/537.36&quot; 850299 - - TCP_MISS_ABORTED HIER_NONE/-
</I>&gt;<i> &quot;bytes=48234496-49283071&quot; &quot;tcdn&quot; &quot;download.xx.com&quot;
</I>&gt;<i> 
</I>&gt;<i> 3. topology
</I>&gt;<i> &#160; origin site &lt;--- &#160;[squid &lt;- nginx] &#160;&lt;--- bussiness cdn &lt;--- users
</I>&gt;<i> 
</I>&gt;<i> 4. &#160;config files
</I>&gt;<i> 
</I>&gt;<i> squid.conf
</I>&gt;<i> coredump_dir /var/spool/squid
</I>&gt;<i> pid_filename /var/run/squid.pid
</I>&gt;<i> httpd_suppress_version_string on
</I>&gt;<i> via off
</I>&gt;<i> cache_effective_user squid
</I>&gt;<i> cache_effective_group squid
</I>&gt;<i> 
</I>&gt;<i> max_filedescriptors 65535&#160;
</I>&gt;<i> cache_swap_low 90
</I>&gt;<i> cache_swap_high 95
</I>&gt;<i> minimum_object_size 0 KB
</I>&gt;<i> maximum_object_size 200 MB
</I>&gt;<i> 
</I>&gt;<i> acl urlpath_QUERY urlpath_regex -i cgi-bin \? \.php \.xml
</I>&gt;<i> no_cache deny urlpath_QUERY &#160;
</I>&gt;<i> # acl urlpath_denyssl urlpath_regex -i ^https:\\
</I>&gt;<i> # no_cache deny urlpath_denyssl
</I>
The name &quot;no_cache&quot; is obsolete since *very*, *very* long ago.

Remove the &quot;no_&quot; characters from the start of those config lines.


&gt;<i> 
</I>&gt;<i> logformat logfmt_cdn [%{%Y-%m-%d:%H:%M:%S}tl.%03tu] %{X-Real-IP}&gt;h
</I>&gt;<i> %&gt;a:%&gt;p %&lt;a:%&lt;p %rm %03&gt;Hs %&lt;st %&gt;st HTTP/%&gt;rv &quot;%&gt;<A HREF="rs://%">rs://%</A>&gt;rd:%&gt;rP&quot; &quot;%&gt;rp&quot;
</I>&gt;<i> &quot;%{Referer}&gt;h&quot; &quot;%{User-Agent}&gt;h&quot; %tr %&lt;pt %03&lt;Hs %Ss %Sh/%&lt;A
</I>&gt;<i> &quot;%{Range}&gt;h&quot; &quot;%{EEO-ComeFrom}&gt;h&quot; &quot;%{xxx-Origin-Domain}&gt;h&quot;
</I>&gt;<i> acl nolog_url url_regex -i cache_object
</I>&gt;<i> 
</I>&gt;<i> cache_log /data/cache.log
</I>&gt;<i> cache_store_log none
</I>&gt;<i> logfile_rotate 1
</I>&gt;<i> 
</I>&gt;<i> quick_abort_min 512 KB
</I>&gt;<i> quick_abort_max 512 KB
</I>&gt;<i> quick_abort_pct 80
</I>&gt;<i> 
</I>&gt;<i> range_offset_limit -1
</I>&gt;<i> reload_into_ims on
</I>&gt;<i> # collapsed_forwarding on
</I>&gt;<i> 
</I>&gt;<i> client_db off
</I>&gt;<i> dns_v4_first on
</I>&gt;<i> dns_nameservers 127.0.0.1
</I>&gt;<i> dns_retransmit_interval 0.01 second
</I>&gt;<i> dns_timeout 0.01 second
</I>&gt;<i> dns_defnames off
</I>&gt;<i> ignore_unknown_nameservers on
</I>&gt;<i> ipcache_size 10240
</I>&gt;<i> ipcache_low 90
</I>&gt;<i> ipcache_high 95
</I>&gt;<i> fqdncache_size 1024
</I>
Many of the above settings are irrelevant. They are setting things to
the default value things things use anyway. You can simplify by removing
those lines entirely from your config file.


&gt;<i> positive_dns_ttl 365 days
</I>&gt;<i> negative_dns_ttl 365 days
</I>
This is very bad. negative_dns_ttl is a *minimum* limit for DNS value
storage. There will be up to a years delay before Squid notices any time
servers are added, renumbered, or removed from the network your diagram
labels &quot;origin site&quot;.
 negative_dns_ttl should be in the order of seconds or minutes.

 positive_dns_ttl is okay with large values, but also should be in the
order of days or weeks to avoid long-term timeouts trying to connect to
servers that no longer exist.


&gt;<i> 
</I>&gt;<i> peer_connect_timeout 30 seconds
</I>
This is the default, no need to configure it to this value.


&gt;<i> 
</I>&gt;<i> connect_timeout 10 minutes
</I>
Really 10min for a TCP SYN+ACK packet exchange?

This is a major DoS risk, and not just for Squid. It allows an attacker
to consume the systems networking resources completely. Causing the
entire machine to become non-responsive.


Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="022205.html">[squid-users] squid-4.9 TCP_MISS_ABORTED  and memory leak
</A></li>
	<LI>Next message (by thread): <A HREF="022207.html">[squid-users] Adaptation error
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22206">[ date ]</a>
              <a href="thread.html#22206">[ thread ]</a>
              <a href="subject.html#22206">[ subject ]</a>
              <a href="author.html#22206">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
