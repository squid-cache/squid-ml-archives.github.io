<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Issue with SSL_BUMP and Office365 (for one...)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Issue%20with%20SSL_BUMP%20and%20Office365%20%28for%20one...%29&In-Reply-To=%3CMailbird-38e389fb-e59b-4ebc-bb7f-54a0953d44b6%40madeo.nl%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="022210.html">
   <LINK REL="Next"  HREF="022214.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Issue with SSL_BUMP and Office365 (for one...)</H1>
    <B>J. Dierkse</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Issue%20with%20SSL_BUMP%20and%20Office365%20%28for%20one...%29&In-Reply-To=%3CMailbird-38e389fb-e59b-4ebc-bb7f-54a0953d44b6%40madeo.nl%3E"
       TITLE="[squid-users] Issue with SSL_BUMP and Office365 (for one...)">j.dierkse at madeo.nl
       </A><BR>
    <I>Fri Jun  5 06:55:07 UTC 2020</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="022210.html">[squid-users] Issue with SSL_BUMP and Office365 (for one...)
</A></li>
        <LI>Next message (by thread): <A HREF="022214.html">[squid-users] Issue with SSL_BUMP and Office365 (for one...)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22212">[ date ]</a>
              <a href="thread.html#22212">[ thread ]</a>
              <a href="subject.html#22212">[ subject ]</a>
              <a href="author.html#22212">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
On 05-Jun-20 00:11:44, Alex Rousskov &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt; wrote:
On 6/4/20 4:21 PM, J. Dierkse wrote:

&gt;<i> I use it to intercept HTTP and HTTPS traffic in my network, and based on
</I>&gt;<i> several ACLs forward it to different peer proxies.
</I>&gt;<i> This is where the DNS load balancing trickery becomes a hassle for HTTPS
</I>&gt;<i> connections;
</I>
&gt;<i> What I would like to do is if the request hostname matches an ACL
</I>&gt;<i> (dstdomain or ssl::server_name), only do a splice for all ssl_bump
</I>&gt;<i> steps.
</I>
That goal needs polishing or rephrasing -- one cannot splice more than
once -- but I think I know what you mean.


Correct, of course splice is the end of the chain, my bad.
The main thing I want to achieve is to setup the connection through different types of privacy proxies, depending on the target domain.
For this I don't really need bumping, if I understand the protocol correctly, I just need to peek to check what the target domain is.
Unfortunately, peeking has the side effect of detecting false-positive host forgery errors, due to Microsoft's DNS load balancing strategy.


&gt;<i> Otherwise do a peek for step1 and a splice afterwards.
</I>

Here is a sketch for v5. Sorry, I do not remember if v4 is equally
capable (but it very well may be):

# splice as soon as we detect specialHost
ssl_bump splice specialHost
# peek to get more info if needed
ssl_bump peek all
# optional: splice if we never detect specialHost
ssl_bump splice all

... where specialHost is an ssl::server_name ACL.


I tried this configuration, but it doesn't give the desired effect.
In 4.11 it doesn't seem to splice at all, but bump for some reason (is it correct not to refer to any bump steps?)


&gt;<i> without having to build a version of squid with the host forgery detection turned
</I>&gt;<i> off...? :))
</I>
Those errors are a separate issue. Even the best possible ssl_bump
configuration can trigger them. They have been discussed many times on
this list before but if you have some new questions about them, please ask.


I know these errors have been a hot topic, and from what I can find (also in this mailing list) is that it should not block the connection.
Frankly, I couldn't care less about the errors themselves, as long as the connection is still allowed.
However, this is not what I'm experiencing. What I'm seeing is that when the error occurs, my outlook apps can no longer connect to the server.
What am I doing wrong...?


Thanks!


J. Dierkse


HTH,

Alex.




&gt;<i>
</I>&gt;<i> The relevant portion of my configuration is as follows.
</I>&gt;<i>
</I>&gt;<i> -snip-
</I>&gt;<i>
</I>&gt;<i> acl local dst 192.168.0.0/16
</I>&gt;<i>
</I>&gt;<i> acl microsoft dstdomain .microsoft.com
</I>&gt;<i> acl microsoft dstdomain .teams.microsoft.com
</I>&gt;<i> acl microsoft dstdomain .office365.com
</I>&gt;<i> acl microsoft dstdomain .office.com
</I>&gt;<i> acl microsoft dstdomain .office.net
</I>&gt;<i> acl microsoft dstdomain .outlook.com
</I>&gt;<i>
</I>&gt;<i> http_port 3128
</I>&gt;<i> http_port 3129 intercept
</I>&gt;<i> https_port 3130 intercept ssl-bump cert=/etc/certificates/SquidCA.pem
</I>&gt;<i> key=/etc/certificates/SquidCA.pem
</I>&gt;<i>
</I>&gt;<i> sslcrtd_program /usr/lib/squid/security_file_certgen -s /var/lib/ssl_db
</I>&gt;<i> -M 16MB
</I>&gt;<i> sslcrtd_children 8 startup=1 idle=1
</I>&gt;<i>
</I>&gt;<i> acl step1 at_step SslBump1
</I>&gt;<i> acl step2 at_step SslBump2
</I>&gt;<i> acl step3 at_step SslBump3
</I>&gt;<i>
</I>&gt;<i> ssl_bump peek&#160; &#160;step1 !microsoft !local
</I>&gt;<i> ssl_bump splice step2 !microsoft !local
</I>&gt;<i> ssl_bump splice step3 !microsoft !local
</I>&gt;<i>
</I>&gt;<i> -snip-
</I>&gt;<i>
</I>&gt;<i> Thanks!
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Best Regards,
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> J. Dierkse
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i>
</I>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20200605/eb0cd035/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20200605/eb0cd035/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="022210.html">[squid-users] Issue with SSL_BUMP and Office365 (for one...)
</A></li>
	<LI>Next message (by thread): <A HREF="022214.html">[squid-users] Issue with SSL_BUMP and Office365 (for one...)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22212">[ date ]</a>
              <a href="thread.html#22212">[ thread ]</a>
              <a href="subject.html#22212">[ subject ]</a>
              <a href="author.html#22212">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
