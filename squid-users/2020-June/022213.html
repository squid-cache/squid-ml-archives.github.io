<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Adaptation error
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Adaptation%20error&In-Reply-To=%3C9d453255-5b11-57b6-092f-f63aaee3fb34%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="022211.html">
   <LINK REL="Next"  HREF="022208.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Adaptation error</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Adaptation%20error&In-Reply-To=%3C9d453255-5b11-57b6-092f-f63aaee3fb34%40measurement-factory.com%3E"
       TITLE="[squid-users] Adaptation error">rousskov at measurement-factory.com
       </A><BR>
    <I>Fri Jun  5 13:00:31 UTC 2020</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="022211.html">[squid-users] Adaptation error
</A></li>
        <LI>Next message (by thread): <A HREF="022208.html">[squid-users] Issue with SSL_BUMP and Office365 (for one...)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22213">[ date ]</a>
              <a href="thread.html#22213">[ thread ]</a>
              <a href="subject.html#22213">[ subject ]</a>
              <a href="author.html#22213">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 6/4/20 7:56 PM, senor wrote:

&gt;<i> The only solution we had come up with was to eliminate the assert
</I>&gt;<i> because it didn't seem to be of concern. Unless you think eliminating
</I>&gt;<i> the assert is not a good idea, I think my question is answered.
</I>
AFAICT, the code should continue to work despite the violation of the
asserted condition. Needless to say, that conclusion may change in
future Squid versions, and my superficial analysis itself can be wrong.

I recommend filing a bug report in Squid bugzilla with a stack trace and
a reference to this email thread.


Thank you,

Alex.


&gt;<i> From: Alex Rousskov &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt;
</I>&gt;<i> Sent: Thursday, June 4, 2020 2:55 PM
</I>&gt;<i> To: senor; <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> Subject: Re: [squid-users] Adaptation error
</I>&gt;<i> 
</I>&gt;<i> On 6/4/20 4:15 PM, senor wrote:
</I>&gt;<i> 
</I>&gt;&gt;<i> I occasionally get an assert and core dump on a worker here:
</I>&gt;<i> 
</I>&gt;&gt;<i> #3  in ClientHttpRequest::resetRequest () at client_side_request.cc:1676
</I>&gt;<i> 
</I>&gt;<i> I assume you are hitting assert(request != newRequest).
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> #4  in ClientHttpRequest::handleAdaptedHeader () at client_side_request.cc:2005
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> As I understand it, the request returned from adaptation is compared
</I>&gt;&gt;<i> with pre-adapted request and it is considered a fail if they match.
</I>&gt;&gt;<i> Since there is no requirement that adaptation make a change, I assume
</I>&gt;&gt;<i> it should not be in that code unless adaptation indicated there was a
</I>&gt;&gt;<i> change.
</I>&gt;<i> 
</I>&gt;<i> IIRC, Squid ICAP client code creates a new request structure even if no
</I>&gt;<i> adaptation happened at the ICAP service. This is a deficiency of that
</I>&gt;<i> old code (some may say a bug, but there could have been good reasons to
</I>&gt;<i> make it that way back then because that request structure is &quot;special&quot;
</I>&gt;<i> and may have been difficult to reuse -- I am not sure).
</I>&gt;<i> 
</I>&gt;<i> Apparently, there is some other adaptation code that does not create a
</I>&gt;<i> new request structure. I speculate that it may be the request routing
</I>&gt;<i> code that lives outside the ICAP space (it also serves eCAP adapters).
</I>&gt;<i> For a specific example, see Adaptation::Iterator::step() -- I see no
</I>&gt;<i> obvious/immediate signs there that theMsg is a new message and not the
</I>&gt;<i> virgin one. IIRC, theMsg starts as a virgin message structure.
</I>&gt;<i> 
</I>&gt;<i> I suspect that the correct fix would be to stop requiring a new request
</I>&gt;<i> structure for the akForward Answers. Instead, handleAdaptedHeader()
</I>&gt;<i> should accommodate the case where the request structure was preserved
</I>&gt;<i> and does not need to be reset. In other words, a Forward(x) answer
</I>&gt;<i> should not imply that the original message was (not) adapted.
</I>&gt;<i> 
</I>&gt;<i> Other Answer recipients should be checked for a similar problem.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> HTH,
</I>&gt;<i> 
</I>&gt;<i> Alex.
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i> 
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="022211.html">[squid-users] Adaptation error
</A></li>
	<LI>Next message (by thread): <A HREF="022208.html">[squid-users] Issue with SSL_BUMP and Office365 (for one...)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22213">[ date ]</a>
              <a href="thread.html#22213">[ thread ]</a>
              <a href="subject.html#22213">[ subject ]</a>
              <a href="author.html#22213">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
