<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Problem with squid proxy authentication	configuration
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Problem%20with%20squid%20proxy%20authentication%0A%09configuration&In-Reply-To=%3CCAPicJaE%2Btz0O_%2BXJm0oT8Lg9epwJNuvAZ-2xFCo2WqwsM%2Bvvzw%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="022225.html">
   <LINK REL="Next"  HREF="022236.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Problem with squid proxy authentication	configuration</H1>
    <B>Amiq Nahas</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Problem%20with%20squid%20proxy%20authentication%0A%09configuration&In-Reply-To=%3CCAPicJaE%2Btz0O_%2BXJm0oT8Lg9epwJNuvAZ-2xFCo2WqwsM%2Bvvzw%40mail.gmail.com%3E"
       TITLE="[squid-users] Problem with squid proxy authentication	configuration">m992493 at gmail.com
       </A><BR>
    <I>Thu Jun 11 12:29:18 UTC 2020</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="022225.html">[squid-users] Problem with squid proxy authentication configuration
</A></li>
        <LI>Next message (by thread): <A HREF="022236.html">[squid-users] Problem with squid proxy authentication configuration
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22234">[ date ]</a>
              <a href="thread.html#22234">[ thread ]</a>
              <a href="subject.html#22234">[ subject ]</a>
              <a href="author.html#22234">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Wed, Jun 10, 2020 at 8:07 PM Amos Jeffries &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt; wrote:
&gt;<i>
</I>&gt;<i> On 10/06/20 9:26 pm, Amiq Nahas wrote:
</I>&gt;<i> &gt; Hi Guys,
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I am trying to configure squid so as to have user proxy
</I>&gt;<i> &gt; authentication, below is how my squid.conf file looks like:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; -----
</I>&gt;<i> &gt; acl SSL_ports port 443
</I>&gt;<i> &gt; acl Safe_ports port 80        # http
</I>&gt;<i> &gt; acl Safe_ports port 21        # ftp
</I>&gt;<i> &gt; acl Safe_ports port 443        # https
</I>&gt;<i> &gt; acl Safe_ports port 70        # gopher
</I>&gt;<i> &gt; acl Safe_ports port 210        # wais
</I>&gt;<i> &gt; acl Safe_ports port 1025-65535    # unregistered ports
</I>&gt;<i> &gt; acl Safe_ports port 280        # http-mgmt
</I>&gt;<i> &gt; acl Safe_ports port 488        # gss-http
</I>&gt;<i> &gt; acl Safe_ports port 591        # filemaker
</I>&gt;<i> &gt; acl Safe_ports port 777        # multiling http
</I>&gt;<i> &gt; acl CONNECT method CONNECT
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; http_access deny !Safe_ports
</I>&gt;<i> &gt; http_access deny CONNECT !SSL_ports
</I>&gt;<i> &gt; http_access allow localhost manager
</I>&gt;<i> &gt; http_access deny manager
</I>&gt;<i> &gt; http_access allow localhost
</I>&gt;<i> &gt; http_access deny all
</I>&gt;<i> &gt; http_port 3128
</I>&gt;<i> &gt; coredump_dir /var/spool/squid
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; refresh_pattern ^ftp:        1440    20%    10080
</I>&gt;<i> &gt; refresh_pattern ^gopher:    1440    0%    1440
</I>&gt;<i> &gt; refresh_pattern -i (/cgi-bin/|\?) 0    0%    0
</I>&gt;<i> &gt; refresh_pattern (Release|Packages(.gz)*)$      0       20%     2880
</I>&gt;<i> &gt; refresh_pattern .        0    20%    4320
</I>&gt;<i> &gt; -----
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; The above lines were default in squid.conf file.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I have added below lines:
</I>&gt;<i> &gt;
</I>&gt;<i>
</I>&gt;<i> *Where* did you add them? order is important.
</I>
I have added the below lines exactly in this order at the end of the
file squid.conf.

&gt;<i> &gt; -----
</I>&gt;<i> &gt; icap_enable on
</I>&gt;<i> &gt; icap_send_client_ip on
</I>&gt;<i> &gt; icap_send_client_username on
</I>&gt;<i> &gt; icap_client_username_header X-Authenticated-User
</I>&gt;<i> &gt; icap_preview_enable on
</I>&gt;<i> &gt; icap_preview_size 1024
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; icap_service service_req reqmod_precache bypass=1 <A HREF="icap://127.0.0.1:1344/echo">icap://127.0.0.1:1344/echo</A>
</I>&gt;<i> &gt; adaptation_access service_req allow all
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; icap_service service_resp respmod_precache bypass=0 <A HREF="icap://127.0.0.1:1344/echo">icap://127.0.0.1:1344/echo</A>
</I>&gt;<i> &gt; adaptation_access service_resp allow all
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; acl ncsa src 0.0.0.0/0.0.0.0
</I>&gt;<i>
</I>&gt;<i> Don't do that. Use &quot;all&quot; to match any IP address.
</I>&gt;<i>
</I>&gt;<i> If you want to match IPv4-only clients there is a special value &quot;ipv4&quot;
</I>&gt;<i> which is used like so:
</I>&gt;<i>   acl ipv4_only src ipv4
</I>&gt;<i>
</I>&gt;<i> Be careful with these type of control. Different access behaviours for
</I>&gt;<i> IPv4 and IPv6 is how security bypass issues are created.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; auth_param basic program /usr/lib/squid/basic_ncsa_auth /etc/squid/squid_passwd
</I>&gt;<i> &gt; auth_param basic realm proxy
</I>&gt;<i> &gt; acl ncsa proxy_auth REQUIRED
</I>&gt;<i>
</I>&gt;<i> &quot;ncsa&quot; was already defined as a IP address matching ACL.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; http access allow ncsa
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> This will only allow clients who are already trying to send credentials.
</I>&gt;<i> It will not inform clients that they need to and no sane client will
</I>&gt;<i> broadcast its credential secrets unless it has to.
</I>&gt;<i>
</I>&gt;<i> To have HTTP auth work in the usual way it is best to *deny*
</I>&gt;<i> non-authenticated traffic and allow based on any other criteria you
</I>&gt;<i> have. Like so:
</I>&gt;<i>
</I>&gt;<i>   http_access deny !ncsa
</I>&gt;<i>   http_access allow localnet
</I>&gt;<i>
</I>&gt;<i> or
</I>&gt;<i>
</I>&gt;<i>   http_access deny !ncsa
</I>&gt;<i>   http_access allow ncsa
</I>
So I changed the configuration according to what you suggested and now
I can access the internet.
Below is how the configuration now looks like:

acl ncsa src all
auth_param basic program /usr/lib/squid/basic_ncsa_auth /etc/squid/squid_passwd
auth_param basic realm proxy
acl authenticated proxy_auth REQUIRED
http_access allow authenticated ncsa

I am able to access the internet now, does this mean that everything
worked fine? I am asking because I will be using this proxy
authentication setup in c-icap for setting up the url_check service.
Also I am not prompted for any password, I am able to access the
internet just like that. Is that how it is supposed to work because if
I don't need to enter the password before browsing the web what would
be the point of it all. Right? or am I missing something here?
I have been using this article for reference
<A HREF="http://hevi.info/do-it-yourself/install-and-setup-squid3-on-ubuntu-14-04-with-authentication/">http://hevi.info/do-it-yourself/install-and-setup-squid3-on-ubuntu-14-04-with-authentication/</A>

Thanks
Amiq

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="022225.html">[squid-users] Problem with squid proxy authentication configuration
</A></li>
	<LI>Next message (by thread): <A HREF="022236.html">[squid-users] Problem with squid proxy authentication configuration
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22234">[ date ]</a>
              <a href="thread.html#22234">[ thread ]</a>
              <a href="subject.html#22234">[ subject ]</a>
              <a href="author.html#22234">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
