<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Problem with squid proxy authentication configuration
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Problem%20with%20squid%20proxy%20authentication%0A%20configuration&In-Reply-To=%3Cd0cf2d65-dcff-73a5-40d8-ba43b72cea5b%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="022234.html">
   <LINK REL="Next"  HREF="022220.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Problem with squid proxy authentication configuration</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Problem%20with%20squid%20proxy%20authentication%0A%20configuration&In-Reply-To=%3Cd0cf2d65-dcff-73a5-40d8-ba43b72cea5b%40treenet.co.nz%3E"
       TITLE="[squid-users] Problem with squid proxy authentication configuration">squid3 at treenet.co.nz
       </A><BR>
    <I>Thu Jun 11 16:55:02 UTC 2020</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="022234.html">[squid-users] Problem with squid proxy authentication	configuration
</A></li>
        <LI>Next message (by thread): <A HREF="022220.html">[squid-users] Switch cache peer Parent server for every 30 minutes
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22236">[ date ]</a>
              <a href="thread.html#22236">[ thread ]</a>
              <a href="subject.html#22236">[ subject ]</a>
              <a href="author.html#22236">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 12/06/20 12:29 am, Amiq Nahas wrote:
&gt;<i> On Wed, Jun 10, 2020 at 8:07 PM Amos Jeffries wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> On 10/06/20 9:26 pm, Amiq Nahas wrote:
</I>&gt;&gt;&gt;<i> Hi Guys,
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> I am trying to configure squid so as to have user proxy
</I>&gt;&gt;&gt;<i> authentication, below is how my squid.conf file looks like:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> -----
</I>&gt;&gt;&gt;<i> acl SSL_ports port 443
</I>&gt;&gt;&gt;<i> acl Safe_ports port 80        # http
</I>&gt;&gt;&gt;<i> acl Safe_ports port 21        # ftp
</I>&gt;&gt;&gt;<i> acl Safe_ports port 443        # https
</I>&gt;&gt;&gt;<i> acl Safe_ports port 70        # gopher
</I>&gt;&gt;&gt;<i> acl Safe_ports port 210        # wais
</I>&gt;&gt;&gt;<i> acl Safe_ports port 1025-65535    # unregistered ports
</I>&gt;&gt;&gt;<i> acl Safe_ports port 280        # http-mgmt
</I>&gt;&gt;&gt;<i> acl Safe_ports port 488        # gss-http
</I>&gt;&gt;&gt;<i> acl Safe_ports port 591        # filemaker
</I>&gt;&gt;&gt;<i> acl Safe_ports port 777        # multiling http
</I>&gt;&gt;&gt;<i> acl CONNECT method CONNECT
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> http_access deny !Safe_ports
</I>&gt;&gt;&gt;<i> http_access deny CONNECT !SSL_ports
</I>&gt;&gt;&gt;<i> http_access allow localhost manager
</I>&gt;&gt;&gt;<i> http_access deny manager
</I>&gt;&gt;&gt;<i> http_access allow localhost
</I>&gt;&gt;&gt;<i> http_access deny all
</I>&gt;&gt;&gt;<i> http_port 3128
</I>&gt;&gt;&gt;<i> coredump_dir /var/spool/squid
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> refresh_pattern ^ftp:        1440    20%    10080
</I>&gt;&gt;&gt;<i> refresh_pattern ^gopher:    1440    0%    1440
</I>&gt;&gt;&gt;<i> refresh_pattern -i (/cgi-bin/|\?) 0    0%    0
</I>&gt;&gt;&gt;<i> refresh_pattern (Release|Packages(.gz)*)$      0       20%     2880
</I>&gt;&gt;&gt;<i> refresh_pattern .        0    20%    4320
</I>&gt;&gt;&gt;<i> -----
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> The above lines were default in squid.conf file.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> I have added below lines:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> *Where* did you add them? order is important.
</I>&gt;<i> 
</I>&gt;<i> I have added the below lines exactly in this order at the end of the
</I>&gt;<i> file squid.conf.
</I>&gt;<i> 
</I>
That is the wrong place to be adding the http_access part of your custom
config.


&gt;&gt;&gt;<i> -----
</I>&gt;&gt;&gt;<i> icap_enable on
</I>&gt;&gt;&gt;<i> icap_send_client_ip on
</I>&gt;&gt;&gt;<i> icap_send_client_username on
</I>&gt;&gt;&gt;<i> icap_client_username_header X-Authenticated-User
</I>&gt;&gt;&gt;<i> icap_preview_enable on
</I>&gt;&gt;&gt;<i> icap_preview_size 1024
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> icap_service service_req reqmod_precache bypass=1 <A HREF="icap://127.0.0.1:1344/echo">icap://127.0.0.1:1344/echo</A>
</I>&gt;&gt;&gt;<i> adaptation_access service_req allow all
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> icap_service service_resp respmod_precache bypass=0 <A HREF="icap://127.0.0.1:1344/echo">icap://127.0.0.1:1344/echo</A>
</I>&gt;&gt;&gt;<i> adaptation_access service_resp allow all
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> acl ncsa src 0.0.0.0/0.0.0.0
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Don't do that. Use &quot;all&quot; to match any IP address.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> If you want to match IPv4-only clients there is a special value &quot;ipv4&quot;
</I>&gt;&gt;<i> which is used like so:
</I>&gt;&gt;<i>   acl ipv4_only src ipv4
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Be careful with these type of control. Different access behaviours for
</I>&gt;&gt;<i> IPv4 and IPv6 is how security bypass issues are created.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> auth_param basic program /usr/lib/squid/basic_ncsa_auth /etc/squid/squid_passwd
</I>&gt;&gt;&gt;<i> auth_param basic realm proxy
</I>&gt;&gt;&gt;<i> acl ncsa proxy_auth REQUIRED
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &quot;ncsa&quot; was already defined as a IP address matching ACL.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> http access allow ncsa
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> This will only allow clients who are already trying to send credentials.
</I>&gt;&gt;<i> It will not inform clients that they need to and no sane client will
</I>&gt;&gt;<i> broadcast its credential secrets unless it has to.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> To have HTTP auth work in the usual way it is best to *deny*
</I>&gt;&gt;<i> non-authenticated traffic and allow based on any other criteria you
</I>&gt;&gt;<i> have. Like so:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>   http_access deny !ncsa
</I>&gt;&gt;<i>   http_access allow localnet
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> or
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>   http_access deny !ncsa
</I>&gt;&gt;<i>   http_access allow ncsa
</I>&gt;<i> 
</I>&gt;<i> So I changed the configuration according to what you suggested and now
</I>&gt;<i> I can access the internet.
</I>&gt;<i> Below is how the configuration now looks like:
</I>&gt;<i> 
</I>&gt;<i> acl ncsa src all
</I>
That is the same as the built-in &quot;all&quot; ACL ...


&gt;<i> auth_param basic program /usr/lib/squid/basic_ncsa_auth /etc/squid/squid_passwd
</I>&gt;<i> auth_param basic realm proxy
</I>&gt;<i> acl authenticated proxy_auth REQUIRED
</I>&gt;<i> http_access allow authenticated ncsa
</I>
... which makes the above line same as:

  http_access allow authenticated all

Which actively *prevents* Squid from requesting credentials from clients.

&gt;<i> 
</I>&gt;<i> I am able to access the internet now, does this mean that everything
</I>&gt;<i> worked fine?
</I>
No. There are many ways to configure Squid to allow traffic through.
Most of them do not in any way match your policy.


&gt;<i> I am asking because I will be using this proxy
</I>&gt;<i> authentication setup in c-icap for setting up the url_check service.
</I>&gt;<i> Also I am not prompted for any password, I am able to access the
</I>&gt;<i> internet just like that. Is that how it is supposed to work
</I>
It is what you currently configured to be happening.
I wrote earlier that you needed something like this:

  http_access deny !ncsa
  http_access allow localnet


That needs to be in sequence with the other http_access rules in your
config:


  http_access deny !Safe_ports
  http_access deny CONNECT !SSL_ports
  http_access allow localhost manager
  http_access deny manager

  acl authenticated proxy_auth REQUIRED
  http_access deny !authenticated

  http_access allow localhost
  http_access deny all


&gt;<i> because if
</I>&gt;<i> I don't need to enter the password before browsing the web what would
</I>&gt;<i> be the point of it all. Right? or am I missing something here?
</I>
You are missing the order http_access rules are applied.


&gt;<i> I have been using this article for reference
</I>&gt;<i> <A HREF="http://hevi.info/do-it-yourself/install-and-setup-squid3-on-ubuntu-14-04-with-authentication/">http://hevi.info/do-it-yourself/install-and-setup-squid3-on-ubuntu-14-04-with-authentication/</A>
</I>&gt;<i> 
</I>
Please notice that while the individual steps of the tutorial itself are
correct they omit very important details like where to place the config
settings. Like I said at the beginning order is important.
  And the followup comments are from people with non-working setups or
wrong answers.

The Squid wiki contains the authoritative information on how to use HTTP
authentication in Squid
&lt;<A HREF="https://wiki.squid-cache.org/Features/Authentication">https://wiki.squid-cache.org/Features/Authentication</A>&gt;


Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="022234.html">[squid-users] Problem with squid proxy authentication	configuration
</A></li>
	<LI>Next message (by thread): <A HREF="022220.html">[squid-users] Switch cache peer Parent server for every 30 minutes
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22236">[ date ]</a>
              <a href="thread.html#22236">[ thread ]</a>
              <a href="subject.html#22236">[ subject ]</a>
              <a href="author.html#22236">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
