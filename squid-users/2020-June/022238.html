<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Switch cache peer Parent server for every 30	minutes
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Switch%20cache%20peer%20Parent%20server%20for%20every%2030%0A%09minutes&In-Reply-To=%3CCACbtF4PGhKts-U96Y3nGFZauWduzfwDh3D3UAycGcpXMqeutRA%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="022233.html">
   <LINK REL="Next"  HREF="022239.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Switch cache peer Parent server for every 30	minutes</H1>
    <B>Prem Chand</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Switch%20cache%20peer%20Parent%20server%20for%20every%2030%0A%09minutes&In-Reply-To=%3CCACbtF4PGhKts-U96Y3nGFZauWduzfwDh3D3UAycGcpXMqeutRA%40mail.gmail.com%3E"
       TITLE="[squid-users] Switch cache peer Parent server for every 30	minutes">premchand142 at gmail.com
       </A><BR>
    <I>Fri Jun 12 03:52:05 UTC 2020</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="022233.html">[squid-users] Switch cache peer Parent server for every 30 minutes
</A></li>
        <LI>Next message (by thread): <A HREF="022239.html">[squid-users] Switch cache peer Parent server for every 30 minutes
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22238">[ date ]</a>
              <a href="thread.html#22238">[ thread ]</a>
              <a href="subject.html#22238">[ subject ]</a>
              <a href="author.html#22238">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Alex,

It's working as expected. I tried to allow only specific domains during the
time by adding below acl but I'm getting HTTP status code 503 in my
access.log, below is my configuration. Could you please let me know what
I'm missing here.

acl usePeerB time 00:30-00:59
acl usePeerB time 02:00-02:29
acl alloweddomains dstdomain google.com facebook.com


cache_peer_access peerA allow usePeerA allowedomains
cache_peer_access peerB allow usePeerB allowedomains
cache_peer_access peerC allow !usePeerA !userPeerB alloweddomains

On Thu, Jun 11, 2020 at 4:54 AM Alex Rousskov &lt;
<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt; wrote:

&gt;<i> On 6/10/20 12:20 PM, Antony Stone wrote:
</I>&gt;<i> &gt; On Wednesday 10 June 2020 at 18:11:03, Prem Chand wrote:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;&gt; Hi Alex,
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; Thanks for responding to my issue  . I didn't get how the math was
</I>&gt;<i> done(why
</I>&gt;<i> &gt;&gt; it's multiplied by 2) to get 16 slots if possible could you please
</I>&gt;<i> elaborate
</I>&gt;<i> &gt;&gt; with an example.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I believe what Alex meant was:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; You want 30 minute timeslots for each of 3 peers, which is 48 half-hour
</I>&gt;<i> &gt; timeslots throughout the day.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; However, you only need to define 48/3 of these for peer A, and 48/3 of
</I>&gt;<i> them for
</I>&gt;<i> &gt; peer B, and then let peer C deal with anything not already handled (so
</I>&gt;<i> it
</I>&gt;<i> &gt; doesn't need its own definitions).
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; 48/3 = 16, therefore you define 16 half-hour periods when you want peer
</I>&gt;<i> A to do
</I>&gt;<i> &gt; the work, 16 half-hour periods for peer B, and then just say &quot;peer C,
</I>&gt;<i> handle
</I>&gt;<i> &gt; anything left over&quot;.
</I>&gt;<i>
</I>&gt;<i> Thank you, Antony! Here is an untested sketch:
</I>&gt;<i>
</I>&gt;<i>   acl usePeerA time 00:00-00:29
</I>&gt;<i>   acl usePeerA time 01:30-01:59
</I>&gt;<i>   ... a total of 16 ORed lines for the first peer ...
</I>&gt;<i>   ... each line matches a unique 30 minute period ...
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>   acl usePeerB time 00:30-00:59
</I>&gt;<i>   acl usePeerB time 02:00-02:29
</I>&gt;<i>   ... a total of 16 ORed lines for the second peer ...
</I>&gt;<i>   ... each line matches a unique 30 minute period ...
</I>&gt;<i>
</I>&gt;<i>   # and now match peer to its time slots
</I>&gt;<i>   cache_peer_access peerA allow usePeerA
</I>&gt;<i>   cache_peer_access peerB allow usePeerB
</I>&gt;<i>   cache_peer_access peerC allow !usePeerA !userPeerB
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> The above may need further adjustments and polishing. For example, I am
</I>&gt;<i> not sure how Squid will round these time values. The above assumes that
</I>&gt;<i> 00:29 limit includes all 60 seconds up to (but excluding) 00:30:00.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> HTH,
</I>&gt;<i>
</I>&gt;<i> Alex.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt;&gt; On Wed, Jun 10, 2020 at 7:12 PM Alex Rousskov wrote:
</I>&gt;<i> &gt;&gt;&gt; On 6/10/20 6:09 AM, Prem Chand wrote:
</I>&gt;<i> &gt;&gt;&gt;&gt; My squid cache peer has 3 parent IP&#8217;s configured. I need to send HTTPS
</I>&gt;<i> &gt;&gt;&gt;&gt; requests to the first parent IP for 30 minutes and after to the 2nd
</I>&gt;<i> &gt;&gt;&gt;&gt; parent IP for 30 minutes and then to 3rd IP for 30 minutes and this
</I>&gt;<i> &gt;&gt;&gt;&gt; switching needs to happen continuously .Could you please let us know
</I>&gt;<i> &gt;&gt;&gt;&gt; how I can achieve this?
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt; If you are OK with hard-coded usage time slots for each peer, then I
</I>&gt;<i> &gt;&gt;&gt; would use two[1] &quot;time&quot; ACLs and cache_peer_access rules. Look for
</I>&gt;<i> &gt;&gt;&gt; &quot;aclname time&quot; in squid.conf.documented. You will have to generate a
</I>&gt;<i> &gt;&gt;&gt; list of (24*2/3=16) staggered time slots for each of the two ACLs, but
</I>&gt;<i> &gt;&gt;&gt; it should work. This may be the simplest solution.
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt; [1] You need two ACLs for three peers because the third peer should get
</I>&gt;<i> &gt;&gt;&gt; the requests that the first two peers were not allowed to get.
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt; ----
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt; With a modern Squid, you could also implement this using a more
</I>&gt;<i> flexible
</I>&gt;<i> &gt;&gt;&gt; (and more expensive, on several layers!) architecture with two ACLs:
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt; 1. An external ACL that returns the right cache peer name to use via a
</I>&gt;<i> &gt;&gt;&gt; keyword=value annotation API. This always-matching ACL should be
</I>&gt;<i> &gt;&gt;&gt; attached to http_access or a similar directive that supports slow ACLs.
</I>&gt;<i> &gt;&gt;&gt; Its goal is to annotate the request. You will need to write a
</I>&gt;<i> &gt;&gt;&gt; script/program that will compute the right annotations based on time or
</I>&gt;<i> &gt;&gt;&gt; some other factors. This is where the flexibility of this solution is
</I>&gt;<i> &gt;&gt;&gt; coming from.
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt; 2. A &quot;note&quot; ACL attached to cache_peer_access directives, allowing
</I>&gt;<i> &gt;&gt;&gt; access to peer X if the external ACL in item 1 returned
</I>&gt;<i> &gt;&gt;&gt; use_cache_peer_=X. The &quot;note&quot; ACL is a fast ACL and, hence, can be
</I>&gt;<i> &gt;&gt;&gt; reliably used with cache_peer_access.
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt; If you already have another external ACL, you may be able to piggyback
</I>&gt;<i> &gt;&gt;&gt; annotations in item 1 to whatever that ACL is already doing.
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt; For more information, search for &quot;keyword=value&quot; and &quot;acl aclname note&quot;
</I>&gt;<i> &gt;&gt;&gt; in your squid.conf.documented and see
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> <A HREF="https://wiki.squid-cache.org/Features/AddonHelpers#Access_Control_.28ACL.">https://wiki.squid-cache.org/Features/AddonHelpers#Access_Control_.28ACL.</A>
</I>&gt;<i> &gt;&gt;&gt; 29
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt; HTH,
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt; Alex.
</I>&gt;<i> &gt;
</I>&gt;<i>
</I>&gt;<i>
</I>
-- 
prem
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20200612/f739d4bb/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20200612/f739d4bb/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="022233.html">[squid-users] Switch cache peer Parent server for every 30 minutes
</A></li>
	<LI>Next message (by thread): <A HREF="022239.html">[squid-users] Switch cache peer Parent server for every 30 minutes
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22238">[ date ]</a>
              <a href="thread.html#22238">[ thread ]</a>
              <a href="subject.html#22238">[ subject ]</a>
              <a href="author.html#22238">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
