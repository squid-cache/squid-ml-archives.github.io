<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Switch cache peer Parent server for every 30	minutes
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Switch%20cache%20peer%20Parent%20server%20for%20every%2030%0A%09minutes&In-Reply-To=%3CCACbtF4PZmAw5NdMhY80Bb_q86Uf0SvPeUjP2nWLjNtgCe1%2BLaw%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="022244.html">
   <LINK REL="Next"  HREF="022229.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Switch cache peer Parent server for every 30	minutes</H1>
    <B>Prem Chand</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Switch%20cache%20peer%20Parent%20server%20for%20every%2030%0A%09minutes&In-Reply-To=%3CCACbtF4PZmAw5NdMhY80Bb_q86Uf0SvPeUjP2nWLjNtgCe1%2BLaw%40mail.gmail.com%3E"
       TITLE="[squid-users] Switch cache peer Parent server for every 30	minutes">premchand142 at gmail.com
       </A><BR>
    <I>Wed Jun 17 06:20:59 UTC 2020</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="022244.html">[squid-users] Switch cache peer Parent server for every 30 minutes
</A></li>
        <LI>Next message (by thread): <A HREF="022229.html">[squid-users] Server monitoring
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22253">[ date ]</a>
              <a href="thread.html#22253">[ thread ]</a>
              <a href="subject.html#22253">[ subject ]</a>
              <a href="author.html#22253">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Alex,

Could you please share with me a rough sketch example for the below
statement.
&quot;but I suspect that a clever
combination of annotate_transaction and &quot;note&quot; ACLs in cache_peer_access
rules can be used to force a particular cache peer selection order.&quot;

On Mon, Jun 15, 2020 at 7:14 PM Alex Rousskov &lt;
<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt; wrote:

&gt;<i> On 6/15/20 3:26 AM, Prem Chand wrote:
</I>&gt;<i>
</I>&gt;<i> &gt; I stopped the peerA(purposefully)  and noticed that requests are failing
</I>&gt;<i> &gt; for the time slots that are going through peerA. I used
</I>&gt;<i> &gt; &quot;connect-fail-limit&quot; in cache_peer  but it's not working. Is there any
</I>&gt;<i> &gt; way we can address this issue using the same solution considering how to
</I>&gt;<i> &gt; handle the requests if any of the parent  peer goes down?
</I>&gt;<i>
</I>&gt;<i> I am not sure, but I think it should be possible to always give Squid
</I>&gt;<i> three peers to use, in the right order. There is no peer selection
</I>&gt;<i> algorithm that will do that automatically, but I suspect that a clever
</I>&gt;<i> combination of annotate_transaction and &quot;note&quot; ACLs in cache_peer_access
</I>&gt;<i> rules can be used to force a particular cache peer selection order.
</I>&gt;<i>
</I>&gt;<i> <A HREF="https://wiki.squid-cache.org/Features/LoadBalance#Go_through_a_peer">https://wiki.squid-cache.org/Features/LoadBalance#Go_through_a_peer</A>
</I>&gt;<i>
</I>&gt;<i> The trick is to place one &quot;best&quot; peer into the first group (your rules
</I>&gt;<i> already do that!), but then stop banning peers so that the other two
</I>&gt;<i> peers are added to the &quot;All Alive Parents&quot; group (your rules currently
</I>&gt;<i> deny those two peers from being considered). It may be possible to stop
</I>&gt;<i> banning peers while the peer selection code is running its second pass
</I>&gt;<i> by changing request annotation.
</I>&gt;<i>
</I>&gt;<i> I am sorry that I do not have enough time to sketch an example.
</I>&gt;<i>
</I>&gt;<i> Alex.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; On Fri, Jun 12, 2020 at 6:47 PM Alex Rousskov wrote:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     On 6/11/20 11:52 PM, Prem Chand wrote:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     &gt; It's working as expected. I tried to allow only specific domains
</I>&gt;<i> &gt;     during
</I>&gt;<i> &gt;     &gt; the time by adding below acl but I'm getting HTTP status code 503
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     &gt; acl usePeerB time 00:30-00:59
</I>&gt;<i> &gt;     &gt; acl usePeerB time 02:00-02:29
</I>&gt;<i> &gt;     &gt; acl alloweddomains dstdomain google.com &lt;<A HREF="http://google.com">http://google.com</A>&gt;
</I>&gt;<i> &gt;     facebook.com &lt;<A HREF="http://facebook.com">http://facebook.com</A>&gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     &gt; cache_peer_access peerA allow usePeerA allowedomains
</I>&gt;<i> &gt;     &gt; cache_peer_access peerB allow usePeerB allowedomains
</I>&gt;<i> &gt;     &gt; cache_peer_access peerC allow !usePeerA !userPeerB alloweddomains
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     Assuming there are no other cache peers, the above rules leave no
</I>&gt;<i> &gt;     forwarding path for a request to a banned domain. If you want to ban
</I>&gt;<i> &gt;     such requests, http_access instead of cache_peer_access.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     HTH,
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     Alex.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     &gt; On Thu, Jun 11, 2020 at 4:54 AM Alex Rousskov wrote:
</I>&gt;<i> &gt;     &gt;
</I>&gt;<i> &gt;     &gt;     On 6/10/20 12:20 PM, Antony Stone wrote:
</I>&gt;<i> &gt;     &gt;     &gt; On Wednesday 10 June 2020 at 18:11:03, Prem Chand wrote:
</I>&gt;<i> &gt;     &gt;     &gt;
</I>&gt;<i> &gt;     &gt;     &gt;&gt; Hi Alex,
</I>&gt;<i> &gt;     &gt;     &gt;&gt;
</I>&gt;<i> &gt;     &gt;     &gt;&gt; Thanks for responding to my issue  . I didn't get how the
</I>&gt;<i> math
</I>&gt;<i> &gt;     &gt;     was done(why
</I>&gt;<i> &gt;     &gt;     &gt;&gt; it's multiplied by 2) to get 16 slots if possible could you
</I>&gt;<i> &gt;     &gt;     please elaborate
</I>&gt;<i> &gt;     &gt;     &gt;&gt; with an example.
</I>&gt;<i> &gt;     &gt;     &gt;
</I>&gt;<i> &gt;     &gt;     &gt; I believe what Alex meant was:
</I>&gt;<i> &gt;     &gt;     &gt;
</I>&gt;<i> &gt;     &gt;     &gt; You want 30 minute timeslots for each of 3 peers, which is 48
</I>&gt;<i> &gt;     &gt;     half-hour
</I>&gt;<i> &gt;     &gt;     &gt; timeslots throughout the day.
</I>&gt;<i> &gt;     &gt;     &gt;
</I>&gt;<i> &gt;     &gt;     &gt; However, you only need to define 48/3 of these for peer A,
</I>&gt;<i> and
</I>&gt;<i> &gt;     &gt;     48/3 of them for
</I>&gt;<i> &gt;     &gt;     &gt; peer B, and then let peer C deal with anything not already
</I>&gt;<i> &gt;     handled
</I>&gt;<i> &gt;     &gt;     (so it
</I>&gt;<i> &gt;     &gt;     &gt; doesn't need its own definitions).
</I>&gt;<i> &gt;     &gt;     &gt;
</I>&gt;<i> &gt;     &gt;     &gt; 48/3 = 16, therefore you define 16 half-hour periods when
</I>&gt;<i> &gt;     you want
</I>&gt;<i> &gt;     &gt;     peer A to do
</I>&gt;<i> &gt;     &gt;     &gt; the work, 16 half-hour periods for peer B, and then just say
</I>&gt;<i> &gt;     &quot;peer
</I>&gt;<i> &gt;     &gt;     C, handle
</I>&gt;<i> &gt;     &gt;     &gt; anything left over&quot;.
</I>&gt;<i> &gt;     &gt;
</I>&gt;<i> &gt;     &gt;     Thank you, Antony! Here is an untested sketch:
</I>&gt;<i> &gt;     &gt;
</I>&gt;<i> &gt;     &gt;       acl usePeerA time 00:00-00:29
</I>&gt;<i> &gt;     &gt;       acl usePeerA time 01:30-01:59
</I>&gt;<i> &gt;     &gt;       ... a total of 16 ORed lines for the first peer ...
</I>&gt;<i> &gt;     &gt;       ... each line matches a unique 30 minute period ...
</I>&gt;<i> &gt;     &gt;
</I>&gt;<i> &gt;     &gt;
</I>&gt;<i> &gt;     &gt;       acl usePeerB time 00:30-00:59
</I>&gt;<i> &gt;     &gt;       acl usePeerB time 02:00-02:29
</I>&gt;<i> &gt;     &gt;       ... a total of 16 ORed lines for the second peer ...
</I>&gt;<i> &gt;     &gt;       ... each line matches a unique 30 minute period ...
</I>&gt;<i> &gt;     &gt;
</I>&gt;<i> &gt;     &gt;       # and now match peer to its time slots
</I>&gt;<i> &gt;     &gt;       cache_peer_access peerA allow usePeerA
</I>&gt;<i> &gt;     &gt;       cache_peer_access peerB allow usePeerB
</I>&gt;<i> &gt;     &gt;       cache_peer_access peerC allow !usePeerA !userPeerB
</I>&gt;<i> &gt;     &gt;
</I>&gt;<i> &gt;     &gt;
</I>&gt;<i> &gt;     &gt;     The above may need further adjustments and polishing. For
</I>&gt;<i> &gt;     example, I am
</I>&gt;<i> &gt;     &gt;     not sure how Squid will round these time values. The above
</I>&gt;<i> &gt;     assumes that
</I>&gt;<i> &gt;     &gt;     00:29 limit includes all 60 seconds up to (but excluding)
</I>&gt;<i> &gt;     00:30:00.
</I>&gt;<i> &gt;     &gt;
</I>&gt;<i> &gt;     &gt;
</I>&gt;<i> &gt;     &gt;     HTH,
</I>&gt;<i> &gt;     &gt;
</I>&gt;<i> &gt;     &gt;     Alex.
</I>&gt;<i> &gt;     &gt;
</I>&gt;<i> &gt;     &gt;
</I>&gt;<i> &gt;     &gt;     &gt;&gt; On Wed, Jun 10, 2020 at 7:12 PM Alex Rousskov wrote:
</I>&gt;<i> &gt;     &gt;     &gt;&gt;&gt; On 6/10/20 6:09 AM, Prem Chand wrote:
</I>&gt;<i> &gt;     &gt;     &gt;&gt;&gt;&gt; My squid cache peer has 3 parent IP&#8217;s configured. I need
</I>&gt;<i> to
</I>&gt;<i> &gt;     &gt;     send HTTPS
</I>&gt;<i> &gt;     &gt;     &gt;&gt;&gt;&gt; requests to the first parent IP for 30 minutes and after
</I>&gt;<i> &gt;     to the 2nd
</I>&gt;<i> &gt;     &gt;     &gt;&gt;&gt;&gt; parent IP for 30 minutes and then to 3rd IP for 30
</I>&gt;<i> &gt;     minutes and this
</I>&gt;<i> &gt;     &gt;     &gt;&gt;&gt;&gt; switching needs to happen continuously .Could you please
</I>&gt;<i> &gt;     let us
</I>&gt;<i> &gt;     &gt;     know
</I>&gt;<i> &gt;     &gt;     &gt;&gt;&gt;&gt; how I can achieve this?
</I>&gt;<i> &gt;     &gt;     &gt;&gt;&gt;
</I>&gt;<i> &gt;     &gt;     &gt;&gt;&gt; If you are OK with hard-coded usage time slots for each
</I>&gt;<i> &gt;     peer, then I
</I>&gt;<i> &gt;     &gt;     &gt;&gt;&gt; would use two[1] &quot;time&quot; ACLs and cache_peer_access rules.
</I>&gt;<i> &gt;     Look for
</I>&gt;<i> &gt;     &gt;     &gt;&gt;&gt; &quot;aclname time&quot; in squid.conf.documented. You will have to
</I>&gt;<i> &gt;     generate a
</I>&gt;<i> &gt;     &gt;     &gt;&gt;&gt; list of (24*2/3=16) staggered time slots for each of the
</I>&gt;<i> two
</I>&gt;<i> &gt;     &gt;     ACLs, but
</I>&gt;<i> &gt;     &gt;     &gt;&gt;&gt; it should work. This may be the simplest solution.
</I>&gt;<i> &gt;     &gt;     &gt;&gt;&gt;
</I>&gt;<i> &gt;     &gt;     &gt;&gt;&gt; [1] You need two ACLs for three peers because the third
</I>&gt;<i> peer
</I>&gt;<i> &gt;     &gt;     should get
</I>&gt;<i> &gt;     &gt;     &gt;&gt;&gt; the requests that the first two peers were not allowed to
</I>&gt;<i> get.
</I>&gt;<i> &gt;     &gt;     &gt;&gt;&gt;
</I>&gt;<i> &gt;     &gt;     &gt;&gt;&gt; ----
</I>&gt;<i> &gt;     &gt;     &gt;&gt;&gt;
</I>&gt;<i> &gt;     &gt;     &gt;&gt;&gt; With a modern Squid, you could also implement this using a
</I>&gt;<i> &gt;     more
</I>&gt;<i> &gt;     &gt;     flexible
</I>&gt;<i> &gt;     &gt;     &gt;&gt;&gt; (and more expensive, on several layers!) architecture with
</I>&gt;<i> &gt;     two ACLs:
</I>&gt;<i> &gt;     &gt;     &gt;&gt;&gt;
</I>&gt;<i> &gt;     &gt;     &gt;&gt;&gt; 1. An external ACL that returns the right cache peer name
</I>&gt;<i> &gt;     to use
</I>&gt;<i> &gt;     &gt;     via a
</I>&gt;<i> &gt;     &gt;     &gt;&gt;&gt; keyword=value annotation API. This always-matching ACL
</I>&gt;<i> &gt;     should be
</I>&gt;<i> &gt;     &gt;     &gt;&gt;&gt; attached to http_access or a similar directive that
</I>&gt;<i> supports
</I>&gt;<i> &gt;     &gt;     slow ACLs.
</I>&gt;<i> &gt;     &gt;     &gt;&gt;&gt; Its goal is to annotate the request. You will need to
</I>&gt;<i> write a
</I>&gt;<i> &gt;     &gt;     &gt;&gt;&gt; script/program that will compute the right annotations
</I>&gt;<i> &gt;     based on
</I>&gt;<i> &gt;     &gt;     time or
</I>&gt;<i> &gt;     &gt;     &gt;&gt;&gt; some other factors. This is where the flexibility of this
</I>&gt;<i> &gt;     &gt;     solution is
</I>&gt;<i> &gt;     &gt;     &gt;&gt;&gt; coming from.
</I>&gt;<i> &gt;     &gt;     &gt;&gt;&gt;
</I>&gt;<i> &gt;     &gt;     &gt;&gt;&gt; 2. A &quot;note&quot; ACL attached to cache_peer_access directives,
</I>&gt;<i> &gt;     allowing
</I>&gt;<i> &gt;     &gt;     &gt;&gt;&gt; access to peer X if the external ACL in item 1 returned
</I>&gt;<i> &gt;     &gt;     &gt;&gt;&gt; use_cache_peer_=X. The &quot;note&quot; ACL is a fast ACL and,
</I>&gt;<i> &gt;     hence, can be
</I>&gt;<i> &gt;     &gt;     &gt;&gt;&gt; reliably used with cache_peer_access.
</I>&gt;<i> &gt;     &gt;     &gt;&gt;&gt;
</I>&gt;<i> &gt;     &gt;     &gt;&gt;&gt; If you already have another external ACL, you may be able
</I>&gt;<i> to
</I>&gt;<i> &gt;     &gt;     piggyback
</I>&gt;<i> &gt;     &gt;     &gt;&gt;&gt; annotations in item 1 to whatever that ACL is already
</I>&gt;<i> doing.
</I>&gt;<i> &gt;     &gt;     &gt;&gt;&gt;
</I>&gt;<i> &gt;     &gt;     &gt;&gt;&gt; For more information, search for &quot;keyword=value&quot; and &quot;acl
</I>&gt;<i> &gt;     &gt;     aclname note&quot;
</I>&gt;<i> &gt;     &gt;     &gt;&gt;&gt; in your squid.conf.documented and see
</I>&gt;<i> &gt;     &gt;     &gt;&gt;&gt;
</I>&gt;<i> &gt;     &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> <A HREF="https://wiki.squid-cache.org/Features/AddonHelpers#Access_Control_.28ACL.">https://wiki.squid-cache.org/Features/AddonHelpers#Access_Control_.28ACL.</A>
</I>&gt;<i> &gt;     &gt;     &gt;&gt;&gt; 29
</I>&gt;<i> &gt;     &gt;     &gt;&gt;&gt;
</I>&gt;<i> &gt;     &gt;     &gt;&gt;&gt;
</I>&gt;<i> &gt;     &gt;     &gt;&gt;&gt; HTH,
</I>&gt;<i> &gt;     &gt;     &gt;&gt;&gt;
</I>&gt;<i> &gt;     &gt;     &gt;&gt;&gt; Alex.
</I>&gt;<i> &gt;     &gt;     &gt;
</I>&gt;<i> &gt;     &gt;
</I>&gt;<i> &gt;     &gt;
</I>&gt;<i> &gt;     &gt;
</I>&gt;<i> &gt;     &gt; --
</I>&gt;<i> &gt;     &gt; prem
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; --
</I>&gt;<i> &gt; prem
</I>&gt;<i>
</I>&gt;<i>
</I>
-- 
prem
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20200617/3ca84064/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20200617/3ca84064/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="022244.html">[squid-users] Switch cache peer Parent server for every 30 minutes
</A></li>
	<LI>Next message (by thread): <A HREF="022229.html">[squid-users] Server monitoring
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22253">[ date ]</a>
              <a href="thread.html#22253">[ thread ]</a>
              <a href="subject.html#22253">[ subject ]</a>
              <a href="author.html#22253">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
