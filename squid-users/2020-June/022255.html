<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] SQUID 4.12 (Debian 10,	OpenSSL 1.1.1d) - SSL bump no server helllo
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20SQUID%204.12%20%28Debian%2010%2C%0A%09OpenSSL%201.1.1d%29%20-%20SSL%20bump%20no%20server%20helllo&In-Reply-To=%3C72DD5D5CF661B5459DC08A060BF26B530108933A%40kjj-server.KJJ.local%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="022254.html">
   <LINK REL="Next"  HREF="022256.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] SQUID 4.12 (Debian 10,	OpenSSL 1.1.1d) - SSL bump no server helllo</H1>
    <B>Lou&#269;ansk&#253; Luk&#225;&#353;</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20SQUID%204.12%20%28Debian%2010%2C%0A%09OpenSSL%201.1.1d%29%20-%20SSL%20bump%20no%20server%20helllo&In-Reply-To=%3C72DD5D5CF661B5459DC08A060BF26B530108933A%40kjj-server.KJJ.local%3E"
       TITLE="[squid-users] SQUID 4.12 (Debian 10,	OpenSSL 1.1.1d) - SSL bump no server helllo">Loucansky.Lukas at kjj.cz
       </A><BR>
    <I>Wed Jun 17 09:29:54 UTC 2020</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="022254.html">[squid-users] SQUID 4.12 (Debian 10,	OpenSSL 1.1.1d) - SSL bump no server helllo
</A></li>
        <LI>Next message (by thread): <A HREF="022256.html">[squid-users] SQUID 4.12 (Debian 10,	OpenSSL 1.1.1d) - SSL bump no server helllo
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22255">[ date ]</a>
              <a href="thread.html#22255">[ thread ]</a>
              <a href="subject.html#22255">[ subject ]</a>
              <a href="author.html#22255">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Found this:

2020/06/17 08:06:31.292 kid2| 24,7| BinaryTokenizer.cc(74) got: SupportedVersions.octets= caca0304030303020301 occupying 10 bytes @1 in 0x7ffd9ba4a0b0.
0x0301 - 0x0304 -&gt; TLS versions to TLS1.3

0xcaca = non-existent

(a few lines further:)
BinaryTokenizer.cc(65) got: supported_version.major=202 occupying 1 bytes @0 in 0x7ffd9ba4a0f0. 

Note 0xCA = 202 dec

Another examples:
2020/06/17 08:06:31.312 kid1| 24,7| BinaryTokenizer.cc(74) got: SupportedVersions.octets= 3a3a0304030303020301 occupying 10 bytes @1 in 0x7ffe348a1f30.

2020/06/17 08:06:31.312 kid1| 24,7| BinaryTokenizer.cc(65) got: supported_version.major=58 occupying 1 bytes @0 in 0x7ffe348a1f70.

Note 0x3A = 58 dec

2020/06/17 08:06:31.324 kid1| 24,7| BinaryTokenizer.cc(74) got: SupportedVersions.octets= aaaa0304030303020301 occupying 10 bytes @1 in 0x7ffe348a1f30.
2020/06/17 08:06:31.324 kid1| 24,7| BinaryTokenizer.cc(65) got: supported_version.minor=170 occupying 1 bytes @1 in 0x7ffe348a1f70.

Note 0xAA = 170 dec


So - I think this is a) badly pased string in /parser/BinaryTokenizer.cc (not likely), or b) in /security/HandShake.cc (line 526 and beyond)
Security::HandShakeParser does not ignore obviously nonse version

What I see is - that it calls tokenizer to get tkVersions, then asks ParseProtocolVersion to check it. I think that code ParseProtocolVersion checks for version 0.2 OR expects version 3.x - but gets versions 202 or 58 etc.

It seems logical to my limited knowledge to check for and ignore uknown versions (GREASed????). I think this is the while statement involved

while (!tkVersions.atEnd()) {
            const auto version = ParseProtocolVersion(tkVersions, &quot;supported_version&quot;);
            if (!supportedVersionMax || TlsVersionEarlierThan(supportedVersionMax, version))
                supportedVersionMax = version;
        }

It calls parser - according to
2020/06/17 08:06:31.312 kid1| 0,3| Handshake.cc(119) ParseProtocolVersion: check failed: vMajor == 3    exception location: Handshake.cc(119) ParseProtocolVersion

It fails while calling it - so the check must be before calling ParseProtocolVersion or while in it - there is statement Must(vMajor==3) on line 119 - so I think this is the breakpoint call. Would simple if (vMajor &lt;= 3)... Statement be  sufficient? What value it should return in case of non-parsable version? Sure not any value or some arbitrary value such as TLS1.something or SSLv3 ... It goes through SSLv2 to SSLv3 (implies vMajor = 3) and for versions &gt;3.0 returns TLS1.vMinor-1 (???). So what it should do if it's called with version 0xCACA or 0x3A3A - I think that there should be check in the mentioned while statement - but it involves parsing major and minor version. This already does ParseProtocolVersion. But I think the goal of this is to find the max supported TLS version - so it should not fail on non-existent versions. So I think the mentioned while statement should sort this out, not calling parser to ask for TLS version for &quot;random&quot; numbers.

LL



-----Original Message-----
From: squid-users [mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>] On Behalf Of Lou&#269;ansk&#253; Luk&#225;&#353;
Sent: Wednesday, June 17, 2020 9:11 AM
To: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
Subject: Re: [squid-users] SQUID 4.12 (Debian 10,OpenSSL 1.1.1d) - SSL bump no server helllo


&gt;<i> That is somewhat useful. TLS version being received is not valid.
</I>
Ok - although this is squid users phorum - this could be even more useful:

Firefox - <A HREF="http://download.kjj.cz/pub/ssl/firefox.txt">http://download.kjj.cz/pub/ssl/firefox.txt</A> it goes throught everything to the GET / HTTP/1.1 request

Chrome - <A HREF="http://download.kjj.cz/pub/ssl/chrome.txt">http://download.kjj.cz/pub/ssl/chrome.txt</A> - it goes from
2020/06/17 08:06:31.292 kid1| 93,7| HttpRequest.cc(63) ~HttpRequest: destructed, this=0x55e730f38e50
2020/06/17 08:06:31.292 kid2| 24,7| BinaryTokenizer.cc(65) got: supported_version.major=202 occupying 1 bytes @0 in 0x7ffd9ba4a0f0.
2020/06/17 08:06:31.292 kid1| 24,8| SBuf.cc(70) ~SBuf: SBuf71215602 destructed
2020/06/17 08:06:31.292 kid2| 24,7| BinaryTokenizer.cc(65) got: supported_version.minor=202 occupying 1 bytes @1 in 0x7ffd9ba4a0f0.
2020/06/17 08:06:31.292 kid1| 24,8| SBuf.cc(70) ~SBuf: SBuf71215601 destructed

to
2020/06/17 08:06:31.292 kid2| 0,3| Handshake.cc(119) ParseProtocolVersion: check failed: vMajor == 3
    exception location: Handshake.cc(119) ParseProtocolVersion

It is not working in all chrome based browsers - Edge, Opera... It is working in the MSIE and FF

LL

_______________________________________________
squid-users mailing list
<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
<A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="022254.html">[squid-users] SQUID 4.12 (Debian 10,	OpenSSL 1.1.1d) - SSL bump no server helllo
</A></li>
	<LI>Next message (by thread): <A HREF="022256.html">[squid-users] SQUID 4.12 (Debian 10,	OpenSSL 1.1.1d) - SSL bump no server helllo
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22255">[ date ]</a>
              <a href="thread.html#22255">[ thread ]</a>
              <a href="subject.html#22255">[ subject ]</a>
              <a href="author.html#22255">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
