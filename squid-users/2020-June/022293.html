<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] (92) Protocol error (TLS code: X509_V_ERR_CERT_HAS_EXPIRED)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20%2892%29%20Protocol%20error%20%28TLS%20code%3A%0A%20X509_V_ERR_CERT_HAS_EXPIRED%29&In-Reply-To=%3C19001981-ec9c-4bf7-5e1b-a441dfd33a2d%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="022292.html">
   <LINK REL="Next"  HREF="022294.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] (92) Protocol error (TLS code: X509_V_ERR_CERT_HAS_EXPIRED)</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20%2892%29%20Protocol%20error%20%28TLS%20code%3A%0A%20X509_V_ERR_CERT_HAS_EXPIRED%29&In-Reply-To=%3C19001981-ec9c-4bf7-5e1b-a441dfd33a2d%40measurement-factory.com%3E"
       TITLE="[squid-users] (92) Protocol error (TLS code: X509_V_ERR_CERT_HAS_EXPIRED)">rousskov at measurement-factory.com
       </A><BR>
    <I>Tue Jun 23 15:42:19 UTC 2020</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="022292.html">[squid-users] (92) Protocol error (TLS code:	X509_V_ERR_CERT_HAS_EXPIRED)
</A></li>
        <LI>Next message (by thread): <A HREF="022294.html">[squid-users] no response from the proxy squid parent
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22293">[ date ]</a>
              <a href="thread.html#22293">[ thread ]</a>
              <a href="subject.html#22293">[ subject ]</a>
              <a href="author.html#22293">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 6/23/20 11:04 AM, Andrea Venturoli wrote:

&gt;<i> Running Squid 4.11 on FreeBSD 11.3 with SSLBump, since a few days, I've
</I>&gt;<i> got several sites (e.g. <A HREF="https://www.kawsaki.it/">https://www.kawsaki.it/</A>) failing with:
</I>&gt;<i> 
</I>&gt;&gt;<i> The following error was encountered while trying to retrieve the URL:
</I>&gt;&gt;<i> <A HREF="https://www.kawasaki.it/*">https://www.kawasaki.it/*</A>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &#160;&#160;&#160; Failed to establish a secure connection to 54.39.161.167
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The system returned:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &#160;&#160;&#160; (92) Protocol error (TLS code: X509_V_ERR_CERT_HAS_EXPIRED)
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &#160;&#160;&#160; SSL Certificate expired on: May 30 10:48:38 2020 GMT
</I>
&gt;<i> When this happens, in cache.log I see:
</I>&gt;&gt;<i> 2020/06/23 15:03:31 kid1| ERROR: negotiating TLS on FD 33:
</I>&gt;&gt;<i> error:14090086:SSL routines:ssl3_get_server_certificate:certificate
</I>&gt;&gt;<i> verify failed (1/-1/0)
</I>
&gt;<i> I know an intermediate certificate expired, but a new one should have
</I>&gt;<i> been published.
</I>

&gt;<i> Does Squid perform something different from OpenSSL?
</I>
Yes, Squid has custom TLS-related code, including certificate
validation, generation, and fetching code.


&gt;<i> Does it have some certificate cache
</I>
Yes, there can be two or even four caches in play here:

1. The in-RAM cache of generated fake certificates (see
dynamic_cert_mem_cache_size),

2. on-disk cache of generated fake certificates (see sslcrtd_program),

3. a regular HTTP in-RAM cache (see cache_mem) that may keep a copy of
the intermediate certificate downloaded by Squid.

4. a regular HTTP on-disk cache (see cache_dir) that may keep a copy of
the intermediate certificate downloaded by Squid.


&gt;<i> I should clear?
</I>
*If* Squid is caching an expired certificate without revalidation, then
this is essentially a Squid bug. There are many unknowns here, so I
cannot confirm or deny the existence of such a bug without spending more
free time which I do not have (unfortunately). I also do not know (did
not check) whether Squid is caching the expired fake certificate and/or
the real intermediate one.

You can try to fix the problem or workaround the Squid bug by clearing
the caches.


&gt;<i> How?
</I>
I would begin with a full Squid shutdown and start. This will clear all
in-RAM caches.

If the problem persists, you can remove the entire on-disk certificate
generator cache (or extract the bad certificates from it, but that
requires even more work). See sslcrtd_program for more info on that
cache location. Do not forget to re-initialize it!

If the problem persists, you can remove the entire on-disk HTTP cache
(or extract the bad certificates from it, but that requires even more
work). See cache_dir for more info on that cache location. Do not forget
to re-initialize it!


I cannot give you step-by-step instructions, but others on the list may
pitch in as you make progress in your triage using the above hints.


HTH,

Alex.

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="022292.html">[squid-users] (92) Protocol error (TLS code:	X509_V_ERR_CERT_HAS_EXPIRED)
</A></li>
	<LI>Next message (by thread): <A HREF="022294.html">[squid-users] no response from the proxy squid parent
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22293">[ date ]</a>
              <a href="thread.html#22293">[ thread ]</a>
              <a href="subject.html#22293">[ subject ]</a>
              <a href="author.html#22293">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
