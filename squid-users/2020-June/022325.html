<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] squid+apache+php-fpm How squid could mark DEAD a peer where Apache is alive and php-fpm dead?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid%2Bapache%2Bphp-fpm%20How%20squid%20could%20mark%20DEAD%20a%0A%20peer%20where%20Apache%20is%20alive%20and%20php-fpm%20dead%3F&In-Reply-To=%3Cacb0f91a-854e-f5d7-1f41-658bc2b3ea5c%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="022324.html">
   <LINK REL="Next"  HREF="022332.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] squid+apache+php-fpm How squid could mark DEAD a peer where Apache is alive and php-fpm dead?</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid%2Bapache%2Bphp-fpm%20How%20squid%20could%20mark%20DEAD%20a%0A%20peer%20where%20Apache%20is%20alive%20and%20php-fpm%20dead%3F&In-Reply-To=%3Cacb0f91a-854e-f5d7-1f41-658bc2b3ea5c%40measurement-factory.com%3E"
       TITLE="[squid-users] squid+apache+php-fpm How squid could mark DEAD a peer where Apache is alive and php-fpm dead?">rousskov at measurement-factory.com
       </A><BR>
    <I>Sun Jun 28 16:44:14 UTC 2020</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="022324.html">[squid-users] squid+apache+php-fpm How squid could mark DEAD a peer where Apache is alive and php-fpm dead?
</A></li>
        <LI>Next message (by thread): <A HREF="022332.html">[squid-users] Squid 4.11 Howto create SSL Bump certificates with only 3-12 months date of expiry
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22325">[ date ]</a>
              <a href="thread.html#22325">[ thread ]</a>
              <a href="subject.html#22325">[ subject ]</a>
              <a href="author.html#22325">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 6/28/20 10:56 AM, Patrick Chemla wrote:

&gt;<i> I got last week a bad &quot;issue&quot; where a squid Version 4.0.23 
</I>
Please upgrade to the latest Squid v4 (or v5). While the problem you are
writing about is unlikely to disappear, there are other problems in your
Squid version. My answer is based on Squid v5, but I hope it applies to
the latest v4 as well.


&gt;<i> But how to tell squid to mark dead a peer that returns 504 code ?
</I>
I did not check closely, but I believe that Squid's peer viability
decisions are based primarily on transport layer problems -- valid HTTP
responses will not mark a peer dead, regardless of the HTTP status code.

Modern Squids should reforward HTTP 504 responses to other peers (where
possible). See the last bullet in reforwarding _exceptions_ list at
<A HREF="https://wiki.squid-cache.org/SquidFaq/InnerWorkings#When_does_Squid_re-forward_a_client_request.3F">https://wiki.squid-cache.org/SquidFaq/InnerWorkings#When_does_Squid_re-forward_a_client_request.3F</A>

Please note that your configuration may not have any peers eligible for
reforwarding the request to. For example, if you have no parent caches,
then a sourcehash peer will be the only candidate, with no reforwarding
candidates at all AFAICT. The algorithm that computes the list of
peering candidates (including candidates for reforwarding) is documented
at
<A HREF="https://wiki.squid-cache.org/Features/LoadBalance#Overall_peer_selection_logic">https://wiki.squid-cache.org/Features/LoadBalance#Overall_peer_selection_logic</A>

If reforwarding is not good enough in your use case, you should be able
to ban a peer using cache_peer_access ACLs. The trigger for a ban would
probably be an annotate_transaction ACL in http_reply_access. Turning
the ban off would probably require an external ACL (or adding a
counter-like ACL support to Squid itself).

Alternatively, one could enhance Squid with a new ACL-driven
cache_peer_failure directive that would allow the admin to determine
which valid HTTP responses should qualify for marking a cache peer as
dead. Adding this feature would be straightforward AFAICT. It would be a
generally useful option. IIRC, there were requests for a similar feature
in the past. Quality pull requests or development sponsorship should be
welcomed IMO.


HTH,

Alex.

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="022324.html">[squid-users] squid+apache+php-fpm How squid could mark DEAD a peer where Apache is alive and php-fpm dead?
</A></li>
	<LI>Next message (by thread): <A HREF="022332.html">[squid-users] Squid 4.11 Howto create SSL Bump certificates with only 3-12 months date of expiry
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22325">[ date ]</a>
              <a href="thread.html#22325">[ thread ]</a>
              <a href="subject.html#22325">[ subject ]</a>
              <a href="author.html#22325">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
