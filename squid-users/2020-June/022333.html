<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid 4.12 Arch Linux Google Chrome fails - OpenSSL 1.1.1g (was Re: SQUID 4.12 (Debian 10, OpenSSL 1.1.1d) - SSL bump no server helllo)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%204.12%20Arch%20Linux%20Google%20Chrome%20fails%20-%20OpenSSL%0A%201.1.1g%20%28was%20Re%3A%20SQUID%204.12%20%28Debian%2010%2C%0A%20OpenSSL%201.1.1d%29%20-%20SSL%20bump%20no%20server%20helllo%29&In-Reply-To=%3C17949f91-f48e-2558-bf76-969affa77d03%40gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="022260.html">
   <LINK REL="Next"  HREF="022336.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid 4.12 Arch Linux Google Chrome fails - OpenSSL 1.1.1g (was Re: SQUID 4.12 (Debian 10, OpenSSL 1.1.1d) - SSL bump no server helllo)</H1>
    <B>Amish</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%204.12%20Arch%20Linux%20Google%20Chrome%20fails%20-%20OpenSSL%0A%201.1.1g%20%28was%20Re%3A%20SQUID%204.12%20%28Debian%2010%2C%0A%20OpenSSL%201.1.1d%29%20-%20SSL%20bump%20no%20server%20helllo%29&In-Reply-To=%3C17949f91-f48e-2558-bf76-969affa77d03%40gmail.com%3E"
       TITLE="[squid-users] Squid 4.12 Arch Linux Google Chrome fails - OpenSSL 1.1.1g (was Re: SQUID 4.12 (Debian 10, OpenSSL 1.1.1d) - SSL bump no server helllo)">anon.amish at gmail.com
       </A><BR>
    <I>Mon Jun 29 15:18:12 UTC 2020</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="022260.html">[squid-users] SQUID 4.12 (Debian 10, OpenSSL 1.1.1d) - SSL bump no server helllo
</A></li>
        <LI>Next message (by thread): <A HREF="022336.html">[squid-users] Squid 4.12 Arch Linux Google Chrome fails - OpenSSL 1.1.1g
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22333">[ date ]</a>
              <a href="thread.html#22333">[ thread ]</a>
              <a href="subject.html#22333">[ subject ]</a>
              <a href="author.html#22333">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
On 16/06/20 1:13 pm, Lou&#269;ansk&#253; Luk&#225;&#353; wrote:
&gt;<i> But the client on the intercepted connection (via changed routing table under mikrotik and then prerouted to correct squid ports for http and ssl traffic) running Chrome 83 <A HREF="http://download.kjj.cz/pub/ssl/idnes.cz_chrome.83.0.4103.97.pcapng">http://download.kjj.cz/pub/ssl/idnes.cz_chrome.83.0.4103.97.pcapng</A> sends ClientHello - and no ServerHello is received. I've tcpdumped outgoing interface on the squid box - and there was no actual connection to the desired server.
</I>&gt;<i> In the access.log there is something like 1592212170.495      2 10.0.0.40 NONE_ABORTED/200 0 CONNECT 185.17.117.32:443 - HIER_NONE/- -
</I>&gt;<i>   
</I>&gt;<i> But - same client, same network, same network running Firefox 77 <A HREF="http://download.kjj.cz/pub/ssl/idnes.cz_firefox.77.0.1.pcapng">http://download.kjj.cz/pub/ssl/idnes.cz_firefox.77.0.1.pcapng</A>  gets ServerHello after it's ClientHello - they exchange information, exchange ciphers etc. and the web page is loaded. I've checked https certificate details - it's been issued by my CA.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> access.log:
</I>&gt;<i>   
</I>&gt;<i> 1592212156.764      8 10.0.0.40 TCP_MISS/301 196 GET <A HREF="http://idnes.cz/">http://idnes.cz/</A> - ORIGINAL_DST/185.17.117.32 -
</I>&gt;<i> 1592212156.774      2 10.0.0.40 NONE/200 0 CONNECT 185.17.117.32:443 - HIER_NONE/- -
</I>&gt;<i> 1592212156.825     38 10.0.0.40 TCP_MISS/302 777 GET <A HREF="https://idnes.cz/">https://idnes.cz/</A> - ORIGINAL_DST/185.17.117.32 text/html
</I>&gt;<i> 1592212156.840      7 10.0.0.40 NONE/200 0 CONNECT 185.17.117.32:443 - HIER_NONE/- -
</I>&gt;<i> 1592212156.893     28 10.0.0.40 TCP_CLIENT_REFRESH_MISS/200 40086 GET <A HREF="https://www.idnes.cz/">https://www.idnes.cz/</A> - ORIGINAL_DST/185.17.117.32 text/html
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> So in Firefox - it seems to be working
</I>
I am using Arch Linux and today I upgraded squid to 4.12 (from 4.10)

I am observing very similar issue.

Clients make HTTPS request via CONNECT to port 8080.

I have configured SSL bump but it is &quot;effectively&quot; deactivated via 
following ACL

http_port 8080 ssl-bump generate-host-certificates=on 
tls-cert=/etc/squid/ssl_cert/squid.pem 
tls-dh=prime256v1:/etc/squid/ssl_cert/dhparam.pem

tls_outgoing_options cafile=/etc/ssl/cert.pem

tls_outgoing_options 
cipher=ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA:ECDHE-RSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA:DHE-RSA-AES256-SHA256:DHE-RSA-AES256-SHA:ECDHE-ECDSA-DES-CBC3-SHA:ECDHE-RSA-DES-CBC3-SHA:EDH-RSA-DES-CBC3-SHA:AES128-GCM-SHA256:AES256-GCM-SHA384:AES128-SHA256:AES256-SHA256:AES128-SHA:AES256-SHA:DES-CBC3-SHA:!DSS

ssl_bump splice ssl_step1 nosslbump_ips # (acl type src)
ssl_bump peek ssl_step1
ssl_bump splice nosslbump_domains # (acl type ssl::server_name_regex)
(more ssl_bump lines not shown)

nosslbump_domains contains &quot;.*&quot; - so effectively nothing is bumped.

Firefox and IE work fine. But in Google chrome - sites dont open.

Access log shows NONE_ABORTED (for google chrome).

And packet sniffer shows FIN, ACK sent by squid. (I have not gone in 
details as I dont understand packet details)

Am I doing anything wrong? If not, then is there any temporary 
workaround without downgrading squid?

Please guide,

Thank you

Amish.


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="022260.html">[squid-users] SQUID 4.12 (Debian 10, OpenSSL 1.1.1d) - SSL bump no server helllo
</A></li>
	<LI>Next message (by thread): <A HREF="022336.html">[squid-users] Squid 4.12 Arch Linux Google Chrome fails - OpenSSL 1.1.1g
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22333">[ date ]</a>
              <a href="thread.html#22333">[ thread ]</a>
              <a href="subject.html#22333">[ subject ]</a>
              <a href="author.html#22333">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
