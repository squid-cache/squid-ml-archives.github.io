<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] ssl bump and url_rewrite_program (like squidguard)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20ssl%20bump%20and%20url_rewrite_program%20%28like%20squidguard%29&In-Reply-To=%3Cc4b81f45-bac4-015d-b85a-3a90d43dc0c3%40e-gaulue.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="021844.html">
   <LINK REL="Next"  HREF="021845.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] ssl bump and url_rewrite_program (like squidguard)</H1>
    <B>Edouard Gaulu&#233;</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20ssl%20bump%20and%20url_rewrite_program%20%28like%20squidguard%29&In-Reply-To=%3Cc4b81f45-bac4-015d-b85a-3a90d43dc0c3%40e-gaulue.com%3E"
       TITLE="[squid-users] ssl bump and url_rewrite_program (like squidguard)">listes at e-gaulue.com
       </A><BR>
    <I>Tue Mar 10 11:43:58 UTC 2020</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="021844.html">[squid-users] ssl bump and url_rewrite_program (like squidguard)
</A></li>
        <LI>Next message (by thread): <A HREF="021845.html">[squid-users] [icap] Web Safety 7.3 web filter for Squid proxy is	available
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21846">[ date ]</a>
              <a href="thread.html#21846">[ thread ]</a>
              <a href="subject.html#21846">[ subject ]</a>
              <a href="author.html#21846">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

Sorry for the noise. In fact, it works. It's just squid couldn't connect 
to the local cgi page (while it could for squidclamav), and then did its 
best that was rather strange.

I confirm &quot;url_rewrite_access deny CONNECT&quot; works like a charm to avoid 
redirection during connection establishment and squid getting mad.

Best regards,

Le 10/03/2020 &#224; 10:53, Edouard Gaulu&#233; a &#233;crit&#160;:
&gt;<i> Hi all,
</I>&gt;<i>
</I>&gt;<i> I know it's an old subject but I come back on it as I moved my old 
</I>&gt;<i> proxy server to Debian Buster.
</I>&gt;<i>
</I>&gt;<i> I now have a 4.10 version from git.
</I>&gt;<i>
</I>&gt;<i> Here are my last tests regarding this subject :
</I>&gt;<i> &#160;* Using c-icap for virus detection works well. I mean if I download a 
</I>&gt;<i> virus from an HTTPS server like 
</I>&gt;<i> <A HREF="https://www.blablasecurity.com/wp-content/downloads/eicar_com.zip,">https://www.blablasecurity.com/wp-content/downloads/eicar_com.zip,</A> I 
</I>&gt;<i> get redirected to the squidclamav cgi page (even if it is HTTP, I mean 
</I>&gt;<i> HTTPS redirect to HTTP).
</I>&gt;<i> &#160;* url_rewrite_program with squidguard using a basic configuration 
</I>&gt;<i> works well with all non-HTTPS request. With HTTPS, it shows a SQUID 
</I>&gt;<i> error : *Unable to determine IP address from host name &quot;http&quot;*
</I>&gt;<i> &#160;* url_rewrite_program with squidguard that is not triggered by the 
</I>&gt;<i> CONNECT method (through this configuration: url_rewrite_access deny 
</I>&gt;<i> CONNECT) but by the subsequent one gives a 404 coming from the remote 
</I>&gt;<i> site. In the log, you see squid get the redirection from the 
</I>&gt;<i> url_rewrite_program but at the end it forges a request to the remote 
</I>&gt;<i> HTTPS site with a GET content of the redirection.
</I>&gt;<i>
</I>&gt;<i> So c-icap manages to handle it well but url_rewrite_program doesn't.
</I>&gt;<i>
</I>&gt;<i> Is there any new option since 3.4.8, that I could try to manage it as 
</I>&gt;<i> good as c-icap redirection?
</I>&gt;<i>
</I>&gt;<i> Best regards, Edouard
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Le 04/05/2017 &#224; 11:03, Edouard Gaulu&#233; a &#233;crit&#160;:
</I>&gt;&gt;<i> Hi community,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Any news about this?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I've tried 3.5.25 but still observe this behaviour.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I understand it well since I read: 
</I>&gt;&gt;<i> <A HREF="https://serverfault.com/questions/727262/how-to-redirect-https-connect-request-with-squid-explicit-proxy">https://serverfault.com/questions/727262/how-to-redirect-https-connect-request-with-squid-explicit-proxy</A>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> But how to let the CONNECT request succeed and later block/redirect 
</I>&gt;&gt;<i> next HTTP request coming through this established connection tunnel?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Best Regards,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Le 03/11/2015 &#224; 23:48, Edouard Gaulu&#233; a &#233;crit :
</I>&gt;&gt;&gt;<i> Hi community,
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> I've followed
</I>&gt;&gt;&gt;<i> <A HREF="http://wiki.squid-cache.org/ConfigExamples/Intercept/SslBumpExplicit&#160;">http://wiki.squid-cache.org/ConfigExamples/Intercept/SslBumpExplicit&#160;</A> 
</I>&gt;&gt;&gt;<i> to
</I>&gt;&gt;&gt;<i> set my server. It looks really interesting and it's said to be the more
</I>&gt;&gt;&gt;<i> common configuration.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> I often observe (example here withwww.youtube.com) :
</I>&gt;&gt;&gt;<i> ***************************
</I>&gt;&gt;&gt;<i> The following error was encountered while trying to retrieve the URL:
</I>&gt;&gt;&gt;<i> <A HREF="https://http/*">https://http/*</A>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> &#160;&#160;&#160; *Unable to determine IP address from host name &quot;http&quot;*
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> The DNS server returned:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> &#160;&#160;&#160; Name Error: The domain name does not exist.
</I>&gt;&gt;&gt;<i> ****************************
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> This happens while the navigator (Mozilla) is trying to get a frame at
</I>&gt;&gt;&gt;<i> <A HREF="https://ad.doubleclick.net/N4061/adi/com.ythome/_default;sz=970x250;tile=1;ssl=1;dc_yt=1;kbsg=HPFR151103;kga=-1;kgg=-1;klg=fr;kmyd=ad_creative_1;ytexp=9406852,9408210,9408502,9417689,9419444,9419802,9420440,9420473,9421645,9421711,9422141,9422865,9423510,9423563,9423789;ord=968558538238386?">https://ad.doubleclick.net/N4061/adi/com.ythome/_default;sz=970x250;tile=1;ssl=1;dc_yt=1;kbsg=HPFR151103;kga=-1;kgg=-1;klg=fr;kmyd=ad_creative_1;ytexp=9406852,9408210,9408502,9417689,9419444,9419802,9420440,9420473,9421645,9421711,9422141,9422865,9423510,9423563,9423789;ord=968558538238386?</A> 
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> That's ads so I'm not so fond of it...
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> But this leads me to the fact I get this behavior each time the site is
</I>&gt;&gt;&gt;<i> banned by squidguard.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Is there something to do to avoid this behavior? I mean, squidguard
</I>&gt;&gt;&gt;<i> should send :
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> *********************************
</I>&gt;&gt;&gt;<i> &#160; Access denied
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Supplementary info&#160;&#160;&#160;&#160; :
</I>&gt;&gt;&gt;<i> Client address&#160;&#160;&#160;&#160; =&#160;&#160;&#160;&#160; 192.168.XXX.XXX
</I>&gt;&gt;&gt;<i> Client name&#160;&#160;&#160;&#160; =&#160;&#160;&#160;&#160; 192.168.XXX.XXX
</I>&gt;&gt;&gt;<i> User ident&#160;&#160;&#160;&#160; =
</I>&gt;&gt;&gt;<i> Client group&#160;&#160;&#160;&#160; =&#160;&#160;&#160;&#160; XXXXXXX
</I>&gt;&gt;&gt;<i> URL&#160;&#160;&#160;&#160; =&#160;&#160;&#160;&#160; <A HREF="https://ad.doubleclick.net/">https://ad.doubleclick.net/</A>
</I>&gt;&gt;&gt;<i> Target class&#160;&#160;&#160;&#160; =&#160;&#160;&#160;&#160; ads
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> If this is wrong, contact your administrator
</I>&gt;&gt;&gt;<i> **********************************
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> squidguard is an url_rewrite_program that looks to respect squid
</I>&gt;&gt;&gt;<i> requirements. Redirect looks like this :
</I>&gt;&gt;&gt;<i> <A HREF="http://proxyweb.myserver.mydomain/cgi-bin/squidGuard-simple.cgi?clientaddr=...">http://proxyweb.myserver.mydomain/cgi-bin/squidGuard-simple.cgi?clientaddr=...</A> 
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> I've played arround trying to change the redirect URL and it leads 
</I>&gt;&gt;&gt;<i> me to
</I>&gt;&gt;&gt;<i> the idea ssl_bump tries to analyse the part until the &quot;:&quot;. Is there 
</I>&gt;&gt;&gt;<i> a way
</I>&gt;&gt;&gt;<i> to avoid this? Is this just a configuration matter?
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Could putting a ssl_bump rule saying &quot;every server that name match 
</I>&gt;&gt;&gt;<i> &quot;http&quot; or
</I>&gt;&gt;&gt;<i> &quot;https&quot; should splice&quot; solve the problem?
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Regards, EG
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;&gt;<i> squid-users mailing list
</I>&gt;&gt;&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;&gt;&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;<i> squid-users mailing list
</I>&gt;&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="021844.html">[squid-users] ssl bump and url_rewrite_program (like squidguard)
</A></li>
	<LI>Next message (by thread): <A HREF="021845.html">[squid-users] [icap] Web Safety 7.3 web filter for Squid proxy is	available
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#21846">[ date ]</a>
              <a href="thread.html#21846">[ thread ]</a>
              <a href="subject.html#21846">[ subject ]</a>
              <a href="author.html#21846">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
