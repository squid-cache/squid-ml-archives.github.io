<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Best way to prevent squid from bumping CONNECTs
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Best%20way%20to%20prevent%20squid%20from%20bumping%20CONNECTs&In-Reply-To=%3C6f609033-54d4-db72-0e69-66c54fc085af%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="022049.html">
   <LINK REL="Next"  HREF="022054.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Best way to prevent squid from bumping CONNECTs</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Best%20way%20to%20prevent%20squid%20from%20bumping%20CONNECTs&In-Reply-To=%3C6f609033-54d4-db72-0e69-66c54fc085af%40measurement-factory.com%3E"
       TITLE="[squid-users] Best way to prevent squid from bumping CONNECTs">rousskov at measurement-factory.com
       </A><BR>
    <I>Mon May  4 16:31:57 UTC 2020</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="022049.html">[squid-users] Best way to prevent squid from bumping CONNECTs
</A></li>
        <LI>Next message (by thread): <A HREF="022054.html">[squid-users] Best way to prevent squid from bumping CONNECTs
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22050">[ date ]</a>
              <a href="thread.html#22050">[ thread ]</a>
              <a href="subject.html#22050">[ subject ]</a>
              <a href="author.html#22050">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 5/3/20 10:41 PM, Scott wrote:

&gt;<i> acl tcp_open_connect_sslbump at_step SslBump1
</I>&gt;<i> acl ssl_splice_sni ssl::server_name &quot;/usr/local/etc/squid/acls/splice_sni&quot;
</I>&gt;<i> acl guest_net_src src x.y.z.0/24
</I>&gt;<i> 
</I>&gt;<i> ssl_bump peek tcp_open_connect_sslbump
</I>&gt;<i> ssl_bump splice ssl_splice_sni
</I>&gt;<i> ssl_bump bump guest_net_src
</I>&gt;<i> ssl_bump splice
</I>

&gt;<i> where I splice instead of bump for destinations that are often used with 
</I>&gt;<i> certificate pinning software (.apple.com with iOS for example).
</I>

&gt;<i> <A HREF="https://wiki.squid-cache.org/Features/SslPeekAndSplice">https://wiki.squid-cache.org/Features/SslPeekAndSplice</A> says &quot;At no point 
</I>&gt;<i> during ssl_bump processing will dstdomain ACL work&quot;.
</I>
I have not tested this, but I would expect the dstdomain ACL to work
during SslBump steps using the destination address from the (real or
fake) CONNECT request URI. It is possible that, for the author of that
wiki statement, that kind of functionality is equivalent to &quot;not work&quot;,
but I personally would not phrase it that way.


&gt;<i> Does that also imply that `ssl::server_name' won't work
</I>&gt;<i> for `http_access' statements?
</I>
No, it does not. Both ACLs should &quot;work&quot;. Naturally, both ACLs have
their own limitations and intended purposes. If you find problems with
their documentation in squid.conf.documented (or want to improve it),
please consider filing a bug report (or submitting a pull request). You
can also improve the wiki page, of course, but I recommend coordinating
with the paragraph author before changing that paragraph:

<A HREF="https://wiki.squid-cache.org/action/diff/Features/SslPeekAndSplice?action=diff&amp;rev1=19&amp;rev2=20">https://wiki.squid-cache.org/action/diff/Features/SslPeekAndSplice?action=diff&amp;rev1=19&amp;rev2=20</A>



&gt;<i> I have config like this:
</I>
&gt;<i> acl no_proxy_dstdomain dstdomain &quot;/usr/local/etc/squid/acls/no_proxy_dstdomain&quot;
</I>&gt;<i> http_access deny no_proxy_dstdomain
</I>&gt;<i> acl no_proxy_sni ssl::server_name &quot;/usr/local/etc/squid/acls/no_proxy_dstdomain&quot;
</I>&gt;<i> http_access deny no_proxy_sni
</I>
&gt;<i> Are the last two lines redundant?
</I>
I bet there are transactions (or transaction processing steps) that
either one of the two ACLs will match while the other will not, but I
have not studied this in detail.


&gt;<i> Or are they required for spliced connections?
</I>
&quot;Required&quot; may be too strong of a word because, as you said below, you
can probably accomplish similar outcome using terminate rules. However,
the details of that outcome would differ, so I can imagine that
http_access is the right or the best approach in _some_ cases.


&gt;<i> Or should I just convert those lines into ssl_bump terminate no_proxy_sni ?
</I>
A matching &quot;http_access deny&quot; forces Squid to generate an HTTP error
response. If that happens during SslBump processing, the connection with
the client will be bumped (in hope) to deliver that response. If such
bumping is no longer possible, I am not sure what happens, but I would
expect Squid to close the underlying TLS/TCP connection.

A matching &quot;ssl_bump terminate&quot; rule closes the client TLS/TCP
connection without generating an HTTP error response. It can only match
during SslBump processing.

Use appropriate rule(s) to accomplish what you actually want to
accomplish. And test that your expectations match what Squid is doing.

I apologize that I cannot give simpler yes/no answers to your
(implicitly loaded) questions. I hope the above responses give you
enough information to find the answers you are looking for.


&gt;<i> And finally, I want to use a different outgoing tcp address for intercepted 
</I>&gt;<i> connections.  What's the best ACL to match those?  Or should I just match 
</I>&gt;<i> explicit proxy connections by port? (ie !myport 3128)
</I>
I would start by testing the myportname ACL(s).


HTH,

Alex.

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="022049.html">[squid-users] Best way to prevent squid from bumping CONNECTs
</A></li>
	<LI>Next message (by thread): <A HREF="022054.html">[squid-users] Best way to prevent squid from bumping CONNECTs
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22050">[ date ]</a>
              <a href="thread.html#22050">[ thread ]</a>
              <a href="subject.html#22050">[ subject ]</a>
              <a href="author.html#22050">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
