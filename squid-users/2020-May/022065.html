<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Best way to prevent squid from bumping CONNECTs
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Best%20way%20to%20prevent%20squid%20from%20bumping%20CONNECTs&In-Reply-To=%3C4768ba15-a9c4-f57d-8719-18fd5a313735%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="022054.html">
   <LINK REL="Next"  HREF="022051.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Best way to prevent squid from bumping CONNECTs</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Best%20way%20to%20prevent%20squid%20from%20bumping%20CONNECTs&In-Reply-To=%3C4768ba15-a9c4-f57d-8719-18fd5a313735%40measurement-factory.com%3E"
       TITLE="[squid-users] Best way to prevent squid from bumping CONNECTs">rousskov at measurement-factory.com
       </A><BR>
    <I>Tue May  5 13:02:34 UTC 2020</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="022054.html">[squid-users] Best way to prevent squid from bumping CONNECTs
</A></li>
        <LI>Next message (by thread): <A HREF="022051.html">[squid-users] Let Squid use SSL certificate for a parent cache peer
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22065">[ date ]</a>
              <a href="thread.html#22065">[ thread ]</a>
              <a href="subject.html#22065">[ subject ]</a>
              <a href="author.html#22065">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 5/5/20 5:38 AM, Amos Jeffries wrote:
&gt;<i> On 5/05/20 4:31 am, Alex Rousskov wrote:
</I>&gt;&gt;<i> On 5/3/20 10:41 PM, Scott wrote:
</I>&gt;&gt;&gt;<i> <A HREF="https://wiki.squid-cache.org/Features/SslPeekAndSplice">https://wiki.squid-cache.org/Features/SslPeekAndSplice</A> says &quot;At no point 
</I>&gt;&gt;&gt;<i> during ssl_bump processing will dstdomain ACL work&quot;.
</I>
&gt;&gt;<i> I have not tested this, but I would expect the dstdomain ACL to work
</I>&gt;&gt;<i> during SslBump steps using the destination address from the (real or
</I>&gt;&gt;<i> fake) CONNECT request URI.
</I>
&gt;<i> We do not save the CONNECT tunnel message objects in the TLS handshake
</I>&gt;<i> state objects. As such the state needed by dstdomain is not available
</I>&gt;<i> during ssl_bump ACL processing.
</I>
I do not know what you mean by &quot;CONNECT tunnel message objects&quot; and &quot;TLS
handshake state objects&quot; exactly but HttpRequest with the (real or fake)
CONNECT request should exist and be available to ssl_bump and
http_access ACLs during SslBump steps. The dstdomain ACL uses
HttpRequest AFAICT.

Most deployed http_access configurations allow those CONNECT requests
while peeking at TLS; and many broken configurations deny them (too
soon), triggering support queries on this mailing list.


&gt;<i> Only state from the TCP connection and the underway TLS handshake are
</I>&gt;<i> guaranteed to be available to the ssl_bump ACLs. Anything else is
</I>&gt;<i> best-effort.
</I>
For intercepted connections, the fake CONNECT request carries
information extracted from the TCP connection and the TLS handshake.

For other cases, there is a real CONNECT request to carry that
information (and more). It is adjusted with SNI info if possible.

At least that is the way SslBump should work in modern Squids. I agree
that many SslBump bugs have been fixed since the quoted wiki paragraph
was written, but the presence of the CONNECT HttpRequest is rather
fundamental since the beginning of Peek and Splice approach because
http_access rules are difficult to write without it, especially because
we did not want to make &quot;step&quot; ACLs officially available for the
http_access rules.


HTH,

Alex.

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="022054.html">[squid-users] Best way to prevent squid from bumping CONNECTs
</A></li>
	<LI>Next message (by thread): <A HREF="022051.html">[squid-users] Let Squid use SSL certificate for a parent cache peer
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22065">[ date ]</a>
              <a href="thread.html#22065">[ thread ]</a>
              <a href="subject.html#22065">[ subject ]</a>
              <a href="author.html#22065">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
