<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Client IP PTR lookup on connect
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Client%20IP%20PTR%20lookup%20on%20connect&In-Reply-To=%3C16d9af75-cb1b-7117-62a0-fcb4c6046f19%40ssrk.sk%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="022124.html">
   <LINK REL="Next"  HREF="022118.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Client IP PTR lookup on connect</H1>
    <B>Michal Bruncko</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Client%20IP%20PTR%20lookup%20on%20connect&In-Reply-To=%3C16d9af75-cb1b-7117-62a0-fcb4c6046f19%40ssrk.sk%3E"
       TITLE="[squid-users] Client IP PTR lookup on connect">michal.bruncko at ssrk.sk
       </A><BR>
    <I>Wed May 13 13:44:31 UTC 2020</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="022124.html">[squid-users] Squid 4.x acl server_cert_fingerprint for bump no matches
</A></li>
        <LI>Next message (by thread): <A HREF="022118.html">[squid-users] Client IP PTR lookup on connect
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22113">[ date ]</a>
              <a href="thread.html#22113">[ thread ]</a>
              <a href="subject.html#22113">[ subject ]</a>
              <a href="author.html#22113">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello guys

following the original thread &quot;[squid-users] Squid 4.9 Client IP PTR 
lookup on connect&quot;

I am observing exactly same bahavour on 
squid-4.4-8.module_el8.1.0+197+0c39cdc8.x86_64 on CentOS 8.
Almost for each client connection to squid port 3128 is squid doing a 
client IP PTR resolution request. I am not using &quot;srcdomain&quot;-based ACLs 
nor icap_log setting.
Normally I wouldnt notice this, but today our proxy server get flooded 
by huge amount of requests (which were actually all denied on this 
proxy) coming from awesome nvidia control panel/tool (immediate 
connection request repeat after rejection from proxy) from newly 
deployed workstations and this flood of proxy requests caused another 
flood of DNS PTR lookups of randomized IPv6 client IPs which werent in 
reverse zones at all.
At first I was suspecting some squid module (auth helper 
(gssapi/ntlm/basic), URL rewriter) or syslog (which we use for sending 
access logs to remote server) but those DNS queries are coming directly 
from squid process (same as the one doing standard forward DNS lookups).

here is snip from strace of squid where you can see incoming connection 
from client and basically immediate DNS PTR lookup

accept(144, {sa_family=AF_INET6, sin6_port=htons(58574), 
inet_pton(AF_INET6, &quot;2001:4118:804:f000::103&quot;, &amp;sin6_addr), 
sin6_flowinfo=htonl(0), sin6_scope_id=0}, [28]) = 12
getsockname(12, {sa_family=AF_INET6, sin6_port=htons(3128), 
inet_pton(AF_INET6, &quot;2001:4118:804:f000::200&quot;, &amp;sin6_addr), 
sin6_flowinfo=htonl(0), sin6_scope_id=0}, [28]) = 0
fcntl(12, F_GETFD)&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; = 0
fcntl(12, F_SETFD, FD_CLOEXEC)&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; = 0
fcntl(12, F_GETFL)&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; = 0x2 (flags O_RDWR)
fcntl(12, F_SETFL, O_RDWR|O_NONBLOCK)&#160;&#160; = 0
sendto(10, 
&quot;l\370\1\0\0\1\0\0\0\0\0\0\0013\0010\0011\0010\0010\0010\0010\0010\0010\0010\0010\0010\0010\0010\0010\0010\0010\0010\0010\1f\0014\0010\18\0010\18\0011\0011\0014\0011\0010\0010\0012\3ip6\4arpa\0\0\f\0\1&quot;, 
90, 0, {sa_family=AF_INET, sin_port=htons(53), 
sin_addr=inet_addr(&quot;10.20.10.18&quot;)}, 16) = 90
epoll_ctl(6, EPOLL_CTL_ADD, 12, {EPOLLIN|EPOLLERR|EPOLLHUP, {u32=12, 
u64=12}}) = 0
epoll_wait(6, [{EPOLLIN, {u32=12, u64=12}}], 4096, 987) = 1
read(12, &quot;GET 
<A HREF="http://i5.c.eset.com:80/v1/auth/851A4855CEEAB5292C10/updlist/0/eid/7033368/lid/7033484">http://i5.c.eset.com:80/v1/auth/851A4855CEEAB5292C10/updlist/0/eid/7033368/lid/7033484</A> 
HTTP/1.1\r\nHost: i5.c.eset.com:80\r\nCon&quot;..., 4096) = 181
sendto(10, 
&quot;\342|\1\0\0\1\0\0\0\0\0\0\0013\0010\0011\0010\0010\0010\0010\0010\0010\0010\0010\0010\0010\0010\0010\0010\0010\0010\0010\1f\0014\0010\18\0010\18\0011\0011\0014\0011\0010\0010\0012\3ip6\4arpa\0\0\f\0\1&quot;, 
90, 0, {sa_family=AF_INET, sin_port=htons(53), 
sin_addr=inet_addr(&quot;10.20.10.18&quot;)}, 16) = 90
epoll_ctl(6, EPOLL_CTL_MOD, 16, {EPOLLIN|EPOLLOUT|EPOLLERR|EPOLLHUP, 
{u32=16, u64=16}}) = 0
epoll_wait(6, [{EPOLLOUT, {u32=16, u64=16}}], 4096, 972) = 1
write(16, 
&quot;<A HREF="http://i5.c.eset.com/v1/auth/851A4855CEEAB5292C10/updlist/0/eid/7033368/lid/7033484">http://i5.c.eset.com/v1/auth/851A4855CEEAB5292C10/updlist/0/eid/7033368/lid/7033484</A> 
2001:4118:804:f000::103/2001:4118:804:f000::&quot;..., 179) = 179
epoll_wait(6, [{EPOLLIN|EPOLLOUT, {u32=16, u64=16}}], 4096, 970) = 1
read(16, &quot;\n&quot;, 32767)&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; = 1
epoll_ctl(6, EPOLL_CTL_MOD, 16, {EPOLLIN|EPOLLERR|EPOLLHUP, {u32=16, 
u64=16}}) = 0
sendto(10, &quot;!6\1\0\0\1\0\0\0\0\0\0\2i5\1c\4eset\3com\0\0\1\0\1&quot;, 31, 0, 
{sa_family=AF_INET, sin_port=htons(53), 
sin_addr=inet_addr(&quot;10.20.10.18&quot;)}, 16) = 31
sendto(10, &quot;\367$\1\0\0\1\0\0\0\0\0\0\2i5\1c\4eset\3com\0\0\34\0\1&quot;, 31, 
0, {sa_family=AF_INET, sin_port=htons(53), 
sin_addr=inet_addr(&quot;10.20.10.18&quot;)}, 16) = 31
epoll_wait(6, [{EPOLLIN, {u32=10, u64=10}}], 4096, 970) = 1
recvfrom(10, 
&quot;l\370\205\200\0\1\0\1\0\0\0\0\0013\0010\0011\0010\0010\0010\0010\0010\0010\0010\0010\0010\0010\0010\0010\0010\0010\0010\0010\1f\0014\0010\18\0010\18\0011\0011\0014\0011\0010\0010\0012\3ip6\4arpa\0\0\f\0\1\300\f\0\f\0\1\0\0\4\260\0\23\6server\2ad\4example\2sk\0&quot;, 
16384, 0, {sa_family=AF_INET, sin_port=htons(53), 
sin_addr=inet_addr(&quot;10.20.10.18&quot;)}, [28-&gt;16]) = 121
recvfrom(10, 0x556dee0c0020, 16384, 0, 0x556df02562c0, [28]) = -1 EAGAIN 
(Resource temporarily unavailable)
epoll_wait(6, [{EPOLLIN, {u32=10, u64=10}}], 4096, 762) = 1
recvfrom(10, 
&quot;\342|\205\200\0\1\0\1\0\0\0\0\0013\0010\0011\0010\0010\0010\0010\0010\0010\0010\0010\0010\0010\0010\0010\0010\0010\0010\0010\1f\0014\0010\18\0010\18\0011\0011\0014\0011\0010\0010\0012\3ip6\4arpa\0\0\f\0\1\300\f\0\f\0\1\0\0\4\260\0\23\6server\2ad\4example\2sk\0&quot;, 
16384, 0, {sa_family=AF_INET, sin_port=htons(53), 
sin_addr=inet_addr(&quot;10.20.10.18&quot;)}, [28-&gt;16]) = 121
recvfrom(10, 0x556dee0c0020, 16384, 0, 0x556df02562c0, [28]) = -1 EAGAIN 
(Resource temporarily unavailable)
epoll_wait(6, [{EPOLLIN, {u32=10, u64=10}}], 4096, 635) = 1
recvfrom(10, 
&quot;\367$\201\200\0\1\0\1\0\1\0\0\2i5\1c\4eset\3com\0\0\34\0\1\300\f\0\5\0\1\0\5\315\351\0\n\2i5\4cwip\300\21\300.\0\6\0\1\0\0\t[\0/\vh1-f5lb01-s\300\21\nhostmaster\300\21\0\0\0034\0\0\250\300\0\0\3\204\0\22u\0\0\1Q\200&quot;, 
16384, 0, {sa_family=AF_INET, sin_port=htons(53), 
sin_addr=inet_addr(&quot;10.20.10.18&quot;)}, [28-&gt;16]) = 112
recvfrom(10, 0x556dee0c0020, 16384, 0, 0x556df02562c0, [28]) = -1 EAGAIN 
(Resource temporarily unavailable)
epoll_wait(6, [{EPOLLIN, {u32=10, u64=10}}], 4096, 626) = 1
recvfrom(10, 
&quot;!6\201\200\0\1\0\3\0\0\0\0\2i5\1c\4eset\3com\0\0\1\0\1\300\f\0\5\0\1\0\5\315\351\0\n\2i5\4cwip\300\21\300+\0\1\0\1\0\0\0\36\0\4[\344\245,\300+\0\1\0\1\0\0\0\36\0\4[\344\247.&quot;, 
16384, 0, {sa_family=AF_INET, sin_port=htons(53), 
sin_addr=inet_addr(&quot;10.20.10.18&quot;)}, [28-&gt;16]) = 85
..

anybody has any idea why is this happening?

thanks

michal




</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="022124.html">[squid-users] Squid 4.x acl server_cert_fingerprint for bump no matches
</A></li>
	<LI>Next message (by thread): <A HREF="022118.html">[squid-users] Client IP PTR lookup on connect
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22113">[ date ]</a>
              <a href="thread.html#22113">[ thread ]</a>
              <a href="subject.html#22113">[ subject ]</a>
              <a href="author.html#22113">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
