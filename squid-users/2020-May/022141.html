<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Sending CONNECT method requests over HTTPS
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Sending%20CONNECT%20method%20requests%20over%20HTTPS&In-Reply-To=%3CCAF-5T9GAudOSLB-D%3DaB3rCdF6%3DgZ7tR%2B60OS20PPZVcDWuAVNA%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="022135.html">
   <LINK REL="Next"  HREF="022142.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Sending CONNECT method requests over HTTPS</H1>
    <B>Ronan Lucio</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Sending%20CONNECT%20method%20requests%20over%20HTTPS&In-Reply-To=%3CCAF-5T9GAudOSLB-D%3DaB3rCdF6%3DgZ7tR%2B60OS20PPZVcDWuAVNA%40mail.gmail.com%3E"
       TITLE="[squid-users] Sending CONNECT method requests over HTTPS">ronanlucio at gmail.com
       </A><BR>
    <I>Wed May 20 17:00:23 UTC 2020</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="022135.html">[squid-users] Sending CONNECT method requests over HTTPS
</A></li>
        <LI>Next message (by thread): <A HREF="022142.html">[squid-users] Sending CONNECT method requests over HTTPS
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22141">[ date ]</a>
              <a href="thread.html#22141">[ thread ]</a>
              <a href="subject.html#22141">[ subject ]</a>
              <a href="author.html#22141">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>OK guys, I think you got my point.
@Alex, thank you for the well-detailed answer.

My main need is to encrypt/protect username and password (or
Proxy-Authentication header) sent on the first CONNECT to the proxy
server, in a way this username and password can't be sniffed.

The other need is creating a rule allowing only some dstdomain's.

So I understand that I can achieve that:
1. Enabling &quot;https_port&quot; directive (on a specific port)
2. Using an ACL rule like
    acl allowed_target dstdomain api.mydomain.com
    http_access allow auth_users allowed_target

Is that right?

My scenario is:
I have a serverless API that needs to connect to a couple specific
targets from a static IP.
As this serverless API doesn't have a static IP, I thought to do this
through a proxy server.
That's why I need to enforce security on the authentication layer.

Thanks
Ronan

On Thu, May 21, 2020 at 1:43 AM Alex Rousskov
&lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt; wrote:
&gt;<i>
</I>&gt;<i> On 5/20/20 6:07 AM, Matus UHLAR - fantomas wrote:
</I>&gt;<i> &gt; On 20.05.20 05:07, Ronan Lucio wrote:
</I>&gt;<i> &gt;&gt; I read a similar thread a couple of weeks ago, but my scenario has
</I>&gt;<i> &gt;&gt; some differences.
</I>&gt;<i> &gt;&gt; Anyway, my need is sending CONNECT method requests over HTTPS as well.
</I>&gt;<i>
</I>&gt;<i> &gt; already possible.
</I>&gt;<i>
</I>&gt;<i> I assume that, here and below, &quot;over HTTPS&quot; means &quot;to an HTTPS proxy&quot;.
</I>&gt;<i>
</I>&gt;<i> Yes, any HTTP request, including CONNECT can be sent to an HTTPS proxy.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt;&gt; 1) To send CONNECT method requests over HTTPS I'm supposed to use
</I>&gt;<i> &gt;&gt; https_port.
</I>&gt;<i>
</I>&gt;<i> &gt; no. It's very common to use HTTP proxy over HTTP, and the CONNECT requests
</I>&gt;<i> &gt; creates communication between client and server
</I>&gt;<i>
</I>&gt;<i> The question is difficult to interpret correctly. Here are arguably
</I>&gt;<i> better questions (with answers):
</I>&gt;<i>
</I>&gt;<i> Q: If I want to use an HTTPS proxy, what Squid port should I configure?
</I>&gt;<i> A: You must use an https_port directive.
</I>&gt;<i>
</I>&gt;<i> Q: Does https_port support CONNECT requests?
</I>&gt;<i> A: Yes. Squid https_port supports all HTTP requests supported by
</I>&gt;<i>    http_port, including CONNECT.
</I>&gt;<i>
</I>&gt;<i> Q: How does Squid, in an HTTPS proxy mode, handle a CONNECT request?
</I>&gt;<i> A: Squid handles it as it would handle a CONNECT request
</I>&gt;<i>    received over an http_port (by default) -- by establishing a TCP
</I>&gt;<i>    tunnel to the origin server and shoveling bytes back and force.
</I>&gt;<i>    The client-Squid portion of that tunnel would be protected by
</I>&gt;<i>    TLS in this case, of course -- that is always true for an HTTPS
</I>&gt;<i>    proxy. SslBump features are not supported in HTTPS mode (yet).
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt;&gt; May I use it on the same way as http_port (without intercept, proxy,
</I>&gt;<i> &gt;&gt; or accelerate)?
</I>&gt;<i>
</I>&gt;<i> &gt; yes.
</I>&gt;<i>
</I>&gt;<i> Q: Can https_port be used without an explicit mode (i.e., without
</I>&gt;<i>    an intercept, tproxy, accel, or ssl-bump parameter)?
</I>&gt;<i> A: Yes. The https_port directive supports the default (i.e. forward
</I>&gt;<i>    proxy) mode.
</I>&gt;<i>
</I>&gt;<i> Q: What happens when https_port is used without an explicit mode?
</I>&gt;<i> A: Traffic on such https_port is treated as if Squid was an HTTPS proxy.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt;&gt; 2) If I need to apply ACL rules to restrict some destinations, I'm
</I>&gt;<i> &gt;&gt; supposed to use bump_ssl.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; without bumping, you can only see the destination host:port and possible
</I>&gt;<i> &gt; hostname sent in the SNI request and contents of the SSL certificate.
</I>&gt;<i>
</I>&gt;<i> Again, it is difficult to interpret this question correctly. Here are a
</I>&gt;<i> few versions with correct answers:
</I>&gt;<i>
</I>&gt;<i> Q: Can I use ssl_bump with an HTTPS proxy?
</I>&gt;<i> A: No, that is not supported yet.
</I>&gt;<i>
</I>&gt;<i> Q: What ACLs can I use in an HTTPS proxy mode?
</I>&gt;<i> A: All ACLs that do not require inspecting packets inside
</I>&gt;<i>    TLS connections from client to origin. Please note that
</I>&gt;<i>    a single client-origin TLS connection involves two
</I>&gt;<i>    TCP connections. That inspection is what SslBump does (among
</I>&gt;<i>    other things). This answer is (too) complex. Unfortunately,
</I>&gt;<i>    there is currently no documentation that, for every ACL,
</I>&gt;<i>    details precisely what information sources are required for
</I>&gt;<i>    that ACL to work. Some ACLs use multiple information sources,
</I>&gt;<i>    depending on Squid configuration and/or transaction state,
</I>&gt;<i>    complicating the matters further.
</I>&gt;<i>
</I>&gt;<i> Q: Is TLS origin SNI available to Squid ACLs in HTTPS proxy mode?
</I>&gt;<i> A: No, not today. SslBump features are not yet supported in that mode.
</I>&gt;<i>
</I>&gt;<i> Q: Are URL paths of HTTP requests inside CONNECT tunnels
</I>&gt;<i>    available to Squid ACLS in HTTPS proxy mode?
</I>&gt;<i> A: No, not today. SslBump features are not yet supported in that mode.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> HTH,
</I>&gt;<i>
</I>&gt;<i> Alex.
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="022135.html">[squid-users] Sending CONNECT method requests over HTTPS
</A></li>
	<LI>Next message (by thread): <A HREF="022142.html">[squid-users] Sending CONNECT method requests over HTTPS
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22141">[ date ]</a>
              <a href="thread.html#22141">[ thread ]</a>
              <a href="subject.html#22141">[ subject ]</a>
              <a href="author.html#22141">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
