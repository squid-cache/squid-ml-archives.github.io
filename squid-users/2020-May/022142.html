<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Sending CONNECT method requests over HTTPS
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Sending%20CONNECT%20method%20requests%20over%20HTTPS&In-Reply-To=%3Cd87832fb-acac-4721-ec10-88a8fba0735c%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="022141.html">
   <LINK REL="Next"  HREF="022143.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Sending CONNECT method requests over HTTPS</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Sending%20CONNECT%20method%20requests%20over%20HTTPS&In-Reply-To=%3Cd87832fb-acac-4721-ec10-88a8fba0735c%40measurement-factory.com%3E"
       TITLE="[squid-users] Sending CONNECT method requests over HTTPS">rousskov at measurement-factory.com
       </A><BR>
    <I>Wed May 20 17:09:22 UTC 2020</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="022141.html">[squid-users] Sending CONNECT method requests over HTTPS
</A></li>
        <LI>Next message (by thread): <A HREF="022143.html">[squid-users] Sending CONNECT method requests over HTTPS
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22142">[ date ]</a>
              <a href="thread.html#22142">[ thread ]</a>
              <a href="subject.html#22142">[ subject ]</a>
              <a href="author.html#22142">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 5/20/20 1:00 PM, Ronan Lucio wrote:
&gt;<i> My main need is to encrypt/protect username and password (or
</I>&gt;<i> Proxy-Authentication header) sent on the first CONNECT to the proxy
</I>&gt;<i> server, in a way this username and password can't be sniffed.
</I>&gt;<i> 
</I>&gt;<i> The other need is creating a rule allowing only some dstdomain's.
</I>&gt;<i> 
</I>&gt;<i> So I understand that I can achieve that:
</I>&gt;<i> 1. Enabling &quot;https_port&quot; directive (on a specific port)
</I>&gt;<i> 2. Using an ACL rule like
</I>&gt;<i>     acl allowed_target dstdomain api.mydomain.com
</I>&gt;<i>     http_access allow auth_users allowed_target
</I>&gt;<i> 
</I>&gt;<i> Is that right?
</I>
Your plan looks OK to me if the client is going to send domain names in
its CONNECT requests. Many clients use IP addresses instead. The
dstdomain ACL will attempt to do a reverse DNS lookup for an IP address,
but that is often not reliable.


&gt;<i> My scenario is:
</I>&gt;<i> I have a serverless API that needs to connect to a couple specific
</I>&gt;<i> targets from a static IP.
</I>&gt;<i> As this serverless API doesn't have a static IP, I thought to do this
</I>&gt;<i> through a proxy server.
</I>&gt;<i> That's why I need to enforce security on the authentication layer.
</I>
And, I presume, you do not trust the API to only request what it should.
If you trust the API, then you do not need the allowed_target check.

Also, if possible, consider using certificate-based authentication
rather than HTTP authentication to authenticate your clients to Squid.
Certificate-based authentication happens earlier, before Squid has to
deal with all the dangers of HTTP negotiations.

Alex.


&gt;<i> On Thu, May 21, 2020 at 1:43 AM Alex Rousskov wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> On 5/20/20 6:07 AM, Matus UHLAR - fantomas wrote:
</I>&gt;&gt;&gt;<i> On 20.05.20 05:07, Ronan Lucio wrote:
</I>&gt;&gt;&gt;&gt;<i> I read a similar thread a couple of weeks ago, but my scenario has
</I>&gt;&gt;&gt;&gt;<i> some differences.
</I>&gt;&gt;&gt;&gt;<i> Anyway, my need is sending CONNECT method requests over HTTPS as well.
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> already possible.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I assume that, here and below, &quot;over HTTPS&quot; means &quot;to an HTTPS proxy&quot;.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Yes, any HTTP request, including CONNECT can be sent to an HTTPS proxy.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> 1) To send CONNECT method requests over HTTPS I'm supposed to use
</I>&gt;&gt;&gt;&gt;<i> https_port.
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> no. It's very common to use HTTP proxy over HTTP, and the CONNECT requests
</I>&gt;&gt;&gt;<i> creates communication between client and server
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The question is difficult to interpret correctly. Here are arguably
</I>&gt;&gt;<i> better questions (with answers):
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Q: If I want to use an HTTPS proxy, what Squid port should I configure?
</I>&gt;&gt;<i> A: You must use an https_port directive.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Q: Does https_port support CONNECT requests?
</I>&gt;&gt;<i> A: Yes. Squid https_port supports all HTTP requests supported by
</I>&gt;&gt;<i>    http_port, including CONNECT.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Q: How does Squid, in an HTTPS proxy mode, handle a CONNECT request?
</I>&gt;&gt;<i> A: Squid handles it as it would handle a CONNECT request
</I>&gt;&gt;<i>    received over an http_port (by default) -- by establishing a TCP
</I>&gt;&gt;<i>    tunnel to the origin server and shoveling bytes back and force.
</I>&gt;&gt;<i>    The client-Squid portion of that tunnel would be protected by
</I>&gt;&gt;<i>    TLS in this case, of course -- that is always true for an HTTPS
</I>&gt;&gt;<i>    proxy. SslBump features are not supported in HTTPS mode (yet).
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> May I use it on the same way as http_port (without intercept, proxy,
</I>&gt;&gt;&gt;&gt;<i> or accelerate)?
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> yes.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Q: Can https_port be used without an explicit mode (i.e., without
</I>&gt;&gt;<i>    an intercept, tproxy, accel, or ssl-bump parameter)?
</I>&gt;&gt;<i> A: Yes. The https_port directive supports the default (i.e. forward
</I>&gt;&gt;<i>    proxy) mode.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Q: What happens when https_port is used without an explicit mode?
</I>&gt;&gt;<i> A: Traffic on such https_port is treated as if Squid was an HTTPS proxy.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> 2) If I need to apply ACL rules to restrict some destinations, I'm
</I>&gt;&gt;&gt;&gt;<i> supposed to use bump_ssl.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> without bumping, you can only see the destination host:port and possible
</I>&gt;&gt;&gt;<i> hostname sent in the SNI request and contents of the SSL certificate.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Again, it is difficult to interpret this question correctly. Here are a
</I>&gt;&gt;<i> few versions with correct answers:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Q: Can I use ssl_bump with an HTTPS proxy?
</I>&gt;&gt;<i> A: No, that is not supported yet.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Q: What ACLs can I use in an HTTPS proxy mode?
</I>&gt;&gt;<i> A: All ACLs that do not require inspecting packets inside
</I>&gt;&gt;<i>    TLS connections from client to origin. Please note that
</I>&gt;&gt;<i>    a single client-origin TLS connection involves two
</I>&gt;&gt;<i>    TCP connections. That inspection is what SslBump does (among
</I>&gt;&gt;<i>    other things). This answer is (too) complex. Unfortunately,
</I>&gt;&gt;<i>    there is currently no documentation that, for every ACL,
</I>&gt;&gt;<i>    details precisely what information sources are required for
</I>&gt;&gt;<i>    that ACL to work. Some ACLs use multiple information sources,
</I>&gt;&gt;<i>    depending on Squid configuration and/or transaction state,
</I>&gt;&gt;<i>    complicating the matters further.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Q: Is TLS origin SNI available to Squid ACLs in HTTPS proxy mode?
</I>&gt;&gt;<i> A: No, not today. SslBump features are not yet supported in that mode.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Q: Are URL paths of HTTP requests inside CONNECT tunnels
</I>&gt;&gt;<i>    available to Squid ACLS in HTTPS proxy mode?
</I>&gt;&gt;<i> A: No, not today. SslBump features are not yet supported in that mode.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> HTH,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Alex.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;<i> squid-users mailing list
</I>&gt;&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i> 
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="022141.html">[squid-users] Sending CONNECT method requests over HTTPS
</A></li>
	<LI>Next message (by thread): <A HREF="022143.html">[squid-users] Sending CONNECT method requests over HTTPS
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22142">[ date ]</a>
              <a href="thread.html#22142">[ thread ]</a>
              <a href="subject.html#22142">[ subject ]</a>
              <a href="author.html#22142">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
