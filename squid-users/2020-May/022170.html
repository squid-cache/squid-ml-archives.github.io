<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid cache with SSL
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20cache%20with%20SSL&In-Reply-To=%3C5b565926-53ea-5a38-53ba-13b93d3ab243%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="022166.html">
   <LINK REL="Next"  HREF="022189.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid cache with SSL</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20cache%20with%20SSL&In-Reply-To=%3C5b565926-53ea-5a38-53ba-13b93d3ab243%40treenet.co.nz%3E"
       TITLE="[squid-users] Squid cache with SSL">squid3 at treenet.co.nz
       </A><BR>
    <I>Mon May 25 09:55:00 UTC 2020</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="022166.html">[squid-users] Squid cache with SSL
</A></li>
        <LI>Next message (by thread): <A HREF="022189.html">[squid-users] Squid cache with SSL
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22170">[ date ]</a>
              <a href="thread.html#22170">[ thread ]</a>
              <a href="subject.html#22170">[ subject ]</a>
              <a href="author.html#22170">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 25/05/20 8:09 pm, Andrey Etush-Koukharenko wrote:
&gt;<i> Hello, I'm trying to set up a cache for GCP signed URLs using squid 4.10
</I>&gt;<i> I've set ssl_bump:
</I>&gt;<i> *http_port 3128 ssl-bump cert=/etc/ssl/squid_ca.pem
</I>&gt;<i> generate-host-certificates=on dynamic_cert_mem_cache_size=4MB
</I>&gt;<i> 
</I>&gt;<i> sslcrtd_program /usr/lib/squid/security_file_certgen -s /var/lib/ssl_db
</I>&gt;<i> -M 4MB
</I>&gt;<i> 
</I>&gt;<i> acl step1 at_step SslBump1
</I>&gt;<i> 
</I>&gt;<i> ssl_bump peek step1
</I>&gt;<i> ssl_bump bump all*
</I>
The above SSL-Bump configuration tries to auto-generate server
certificates based only on details in the TLS client handshake. This
leads to a huge number of problems, not least of which is completely
breaking TLS security properties.

Prefer doing the bump at step3,


&gt;<i> *
</I>&gt;<i> I've set cache like this:
</I>&gt;<i> 
</I>&gt;<i> *refresh_pattern -i&#160;my-dev.storage.googleapis.com/.* 
</I>&gt;<i> 4320 80% 43200&#160;override-expire ignore-reload ignore-no-store ignore-private*
</I>&gt;<i> *
</I>
FYI: that does not setup the cache. It provides *default* parameters for
the heuristic expiry algorithm.

* override-expire replaces the max-age (or Expires header) parameter
with 43200 minutes from object creation.
  This often has the effect of forcing objects to expire from cache long
before they normally would.

* ignore-reload makes Squid ignore requests from the client to update
its cached content.
 This forces content which is stale, outdated, corrupt, or plain wrong
to remain in cache no matter how many times clients try to re-fetch for
a valid response.

* ignore-private makes Squid content that is never supposed to be shared
between clients.
 To prevent personal data being shared between clients who should never
see it Squid will revalidate these objects. Usually different data will
return, making this just a waste of cache space.

* ignore-no-store makes Squid cache objects that are explicitly
*forbidden* to be stored in a cache.
  80% of 0 seconds == 0 seconds before these objects become stale and
expire from cache.

Given that you described this as a problem with an API doing *signing*
of things I expect that at least some of those objects will be security
keys. Possibly generated specifically per-item keys, where forced
caching is a *BAD* idea.

I recommend removing that line entirely from your config file and
letting the Google developers instructions do what they are intended to
do with the cacheability. At the very least start from the default
caching behaviour and see how it works normally before adding protocol
violations and unusual (mis)behvaviours to how the proxy caches things.


&gt;<i> *
</I>&gt;<i> In the cache directory, I see that object was stored after the first
</I>&gt;<i> call, but when I try to re-run the URL I get always
</I>&gt;<i> get:&#160;*TCP_REFRESH_UNMODIFIED_ABORTED/200*
</I>
What makes you think anything is going wrong?

 Squid found the object in cache (HIT).
 The object requirements were to check with the origin server about
whether it could still be used (HIT becomes REFRESH).
 The origin server said it was fine to deliver (UNMODIFIED).
 Squid started delivery (status 200).
 The client disconnected before the response could be completed delivery
(ABORTED).

Clients are allowed to disconnect at any time, for any reason.


Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="022166.html">[squid-users] Squid cache with SSL
</A></li>
	<LI>Next message (by thread): <A HREF="022189.html">[squid-users] Squid cache with SSL
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22170">[ date ]</a>
              <a href="thread.html#22170">[ thread ]</a>
              <a href="subject.html#22170">[ subject ]</a>
              <a href="author.html#22170">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
