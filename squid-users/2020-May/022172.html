<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid marking QOS and matching marks with linux iptables problem !
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20marking%20QOS%20and%20matching%20marks%20with%20linux%0A%20iptables%20problem%20%21&In-Reply-To=%3C3815057c-54a6-79f3-ed87-ad6fa1a02698%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="022167.html">
   <LINK REL="Next"  HREF="022147.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid marking QOS and matching marks with linux iptables problem !</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20marking%20QOS%20and%20matching%20marks%20with%20linux%0A%20iptables%20problem%20%21&In-Reply-To=%3C3815057c-54a6-79f3-ed87-ad6fa1a02698%40treenet.co.nz%3E"
       TITLE="[squid-users] Squid marking QOS and matching marks with linux iptables problem !">squid3 at treenet.co.nz
       </A><BR>
    <I>Mon May 25 10:15:43 UTC 2020</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="022167.html">[squid-users] Squid marking QOS and matching marks with linux iptables problem !
</A></li>
        <LI>Next message (by thread): <A HREF="022147.html">[squid-users] Squid does not cache file download by FileZilla and apache FTPCLIENT
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22172">[ date ]</a>
              <a href="thread.html#22172">[ thread ]</a>
              <a href="subject.html#22172">[ subject ]</a>
              <a href="author.html#22172">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 25/05/20 9:25 pm, Ahmad Alzaeem wrote:
&gt;<i> Here is debug result :
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 2020/05/25 12:04:58.043 kid1| 33,5| client_side.cc
</I>&gt;<i> &lt;<A HREF="http://client_side.cc">http://client_side.cc</A>&gt;(1375) parseHttpRequest: Prepare absolute URL from&#160;
</I>&gt;<i> 2020/05/25 12:04:58.043 kid1| 33,5| client_side.cc
</I>&gt;<i> &lt;<A HREF="http://client_side.cc">http://client_side.cc</A>&gt;(2106) clientParseRequests:
</I>&gt;<i> local=45.150.17.10:3128 remote=50.254.22.18:62916 FD 540 flags=1: done
</I>&gt;<i> parsing a request
</I>
The client connection on FD 540 was open long before this log trace
begins. Any netfilter details fetched are back at the point it was accepted.



&gt;<i> 2020/05/25 12:04:58.043 kid1| 33,3| http/Stream.h(141) mayUseConnection:
</I>&gt;<i> This 0x41e43f0 marked 1
</I>
NP: this is a different kind of marking, about whether it is persistent
or not. Not relevant.


...
&gt;<i> 2020/05/25 12:04:58.056 kid1| 17,3| FwdState.cc
</I>&gt;<i> &lt;<A HREF="http://FwdState.cc">http://FwdState.cc</A>&gt;(1339) GetMarkingsToServer: from 45.150.17.10
</I>&gt;<i> netfilter mark 0
</I>
This 0 mark is what iptables has set on returning packets for the origin
server connection.

That lien existing at least confirms absolutely that the library and
relevant code is built properly - what Eliezer was looking for with the
squid -v request.


&gt;<i> 2020/05/25 12:04:58.056 kid1| 50,3| comm.cc &lt;<A HREF="http://comm.cc">http://comm.cc</A>&gt;(350)
</I>&gt;<i> comm_openex: comm_openex: Attempt open socket for: 45.150.17.10
</I>&gt;<i> 2020/05/25 12:04:58.056 kid1| 50,3| comm.cc &lt;<A HREF="http://comm.cc">http://comm.cc</A>&gt;(393)
</I>&gt;<i> comm_openex: comm_openex: Opened socket local=45.150.17.10 remote=[::]
</I>&gt;<i> FD 542 flags=1 : family=2, type=1, protocol=6
</I>
New connection opened, but the log snippet ends before the per-message
socket options are updated for the outgoing HTTP request message.

...



To find the most relevant lines look for &quot;doNfmarkLocalHit&quot;,
&quot;doNfmarkLocalMiss&quot; and &quot;setSockNfmark&quot;.

If there are errors receiving a MARK from iptables
&quot;getNfmarkFromConnection&quot; will show up too.

When you have found the relevant places, use the FD value on those lines
to grep for more details on what is happening on that connection.


Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="022167.html">[squid-users] Squid marking QOS and matching marks with linux iptables problem !
</A></li>
	<LI>Next message (by thread): <A HREF="022147.html">[squid-users] Squid does not cache file download by FileZilla and apache FTPCLIENT
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22172">[ date ]</a>
              <a href="thread.html#22172">[ thread ]</a>
              <a href="subject.html#22172">[ subject ]</a>
              <a href="author.html#22172">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
