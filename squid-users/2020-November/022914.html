<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] issues with sslbump and &quot;Host header forgery detected&quot; warnings
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20issues%20with%20sslbump%20and%20%22Host%20header%20forgery%0A%20detected%22%20warnings&In-Reply-To=%3Cbbb0cd4a-50f7-b584-5304-652b2fb58a9c%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="022918.html">
   <LINK REL="Next"  HREF="022917.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] issues with sslbump and &quot;Host header forgery detected&quot; warnings</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20issues%20with%20sslbump%20and%20%22Host%20header%20forgery%0A%20detected%22%20warnings&In-Reply-To=%3Cbbb0cd4a-50f7-b584-5304-652b2fb58a9c%40measurement-factory.com%3E"
       TITLE="[squid-users] issues with sslbump and &quot;Host header forgery detected&quot; warnings">rousskov at measurement-factory.com
       </A><BR>
    <I>Sat Nov  7 16:18:04 UTC 2020</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="022918.html">[squid-users] issues with sslbump and &quot;Host header forgery detected&quot; warnings
</A></li>
        <LI>Next message (by thread): <A HREF="022917.html">[squid-users] issues with sslbump and &quot;Host header forgery detected&quot; warnings
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22914">[ date ]</a>
              <a href="thread.html#22914">[ thread ]</a>
              <a href="subject.html#22914">[ subject ]</a>
              <a href="author.html#22914">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 11/6/20 4:18 PM, Leonardo Rodrigues wrote:

&gt;<i> 2020/11/06 18:04:21 kid1| SECURITY ALERT: Host header forgery detected...
</I>&gt;<i> 2020/11/06 18:04:21 kid1| SECURITY ALERT: on URL:...
</I>
&gt;<i> - without using WPAD or without configuring proxy on the client
</I>&gt;<i> devices, is this somehow &quot;fixable&quot; ?
</I>
Yes, it is possible to modify Squid to correctly forward the intercepted
TCP connection where it was going despite the host validation failure.
Squid already does that for some use cases, but that code currently
excludes intercepted TLS connections (among other cases).


&gt;<i> &#160;&#160;&#160; - is there any chance the NONE/409 (Conflict) logs i'm seeing are
</I>&gt;<i> not related to this? Maybe these are just WARNINGs and not ERRORs, or
</I>&gt;<i> these would really cause a fail to the intercepted connection?
</I>
Bugs notwithstanding, your Squid is terminating the TLS connection after
printing the _second_ ALERT line above:

&gt;<i> debugs(85, DBG_IMPORTANT, &quot;SECURITY ALERT: on URL: &quot; &lt;&lt; ...
</I>&gt;<i> // IP address validation for Host: failed. reject the connection.
</I>&gt;<i> repContext-&gt;setReplyToError(ERR_CONFLICT_HOST, Http::scConflict,
</I>
The documented intent of that code path is to eventually terminate the
TLS connection without contacting the origin server. I suspect that is
what actually happens, but I did not check. You can check this
(indirectly) by reproducing the problem while capturing client&lt;-&gt;Squid
and Squid-&gt;server traffic.


&gt;<i> &#160;&#160;&#160; - any other hint on this one without having to set proxy, in any
</I>&gt;<i> way, on the clients? I just wanna have hostnames (and traffic generated)
</I>&gt;<i> logged, no need for full decrypt (bumping) of the connections.
</I>
You have a use case where connection rejection is not the best handling
option. Implementing and defending proper support for that specific use
case is probably not trivial, but I think it is doable.

<A HREF="https://wiki.squid-cache.org/SquidFaq/AboutSquid#How_to_add_a_new_Squid_feature.2C_enhance.2C_of_fix_something.3F">https://wiki.squid-cache.org/SquidFaq/AboutSquid#How_to_add_a_new_Squid_feature.2C_enhance.2C_of_fix_something.3F</A>

Alex.

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="022918.html">[squid-users] issues with sslbump and &quot;Host header forgery detected&quot; warnings
</A></li>
	<LI>Next message (by thread): <A HREF="022917.html">[squid-users] issues with sslbump and &quot;Host header forgery detected&quot; warnings
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22914">[ date ]</a>
              <a href="thread.html#22914">[ thread ]</a>
              <a href="subject.html#22914">[ subject ]</a>
              <a href="author.html#22914">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
