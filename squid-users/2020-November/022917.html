<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] issues with sslbump and &quot;Host header forgery detected&quot; warnings
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20issues%20with%20sslbump%20and%20%22Host%20header%20forgery%0A%20detected%22%20warnings&In-Reply-To=%3C006f01d6b56d%24297b0880%247c711980%24%40gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="022914.html">
   <LINK REL="Next"  HREF="022919.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] issues with sslbump and &quot;Host header forgery detected&quot; warnings</H1>
    <B>Eliezer Croitor</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20issues%20with%20sslbump%20and%20%22Host%20header%20forgery%0A%20detected%22%20warnings&In-Reply-To=%3C006f01d6b56d%24297b0880%247c711980%24%40gmail.com%3E"
       TITLE="[squid-users] issues with sslbump and &quot;Host header forgery detected&quot; warnings">ngtech1ltd at gmail.com
       </A><BR>
    <I>Sun Nov  8 01:19:09 UTC 2020</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="022914.html">[squid-users] issues with sslbump and &quot;Host header forgery detected&quot; warnings
</A></li>
        <LI>Next message (by thread): <A HREF="022919.html">[squid-users] issues with sslbump and &quot;Host header forgery detected&quot; warnings
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22917">[ date ]</a>
              <a href="thread.html#22917">[ thread ]</a>
              <a href="subject.html#22917">[ subject ]</a>
              <a href="author.html#22917">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hey Leonardo,

I assume The best solution for you is a simple SNI proxy.
Squid does also that and you can try to debug this issue to make sure you understand what is wrong.
It clearly states that Squid doesn't see this specific address: local=216.58.222.106:443
As the domain: chromesyncpasswords-pa.googleapis.com:443 &quot;real&quot; destination address.

Maybe Alex or Amos remember the exact and relevant debug_options:
<A HREF="https://wiki.squid-cache.org/KnowledgeBase/DebugSections">https://wiki.squid-cache.org/KnowledgeBase/DebugSections</A>

I assume section 78 would be of help.
debug_options ALL,1 78,3

Is probably enough to discover what are the DNS responses and from where these are.
On what OS are you running this Squid?

Thanks,

----
Eliezer Croitoru
Tech Support
Mobile: +972-5-28704261
Email: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">ngtech1ltd at gmail.com</A>

-----Original Message-----
From: squid-users &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>&gt; On Behalf Of Leonardo Rodrigues
Sent: Friday, November 6, 2020 11:18 PM
To: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
Subject: [squid-users] issues with sslbump and &quot;Host header forgery detected&quot; warnings


     Hello Everyone,

     I'm trying to setup sslbump for the first time (on squid-4.13) and, 
at first, things seems to be working. After taking some time to 
understand the new terms (splice, bump, stare, etc), seems to got things 
somehow working.

     Actually i'm NOT looking for complete bumping (and decrypting) the 
connections. During my lab studies, I found out that simply 'splice' the 
connections is enough for me. I just wanna intercept https connections 
and have them logged, just the hostname, and that seems to be 
acchievable without even installing my certificates on the client, as 
i'm not changing anything, just 'taking a look' on the SNI values of the 
connection. The connection itself remains end-to-end protected, and 
that's fine to me. I just wanna have things logged. And that's working 
just fine.

     However, some connections are failing with the &quot;Host header forgery 
detected&quot; warnings. Example:

2020/11/06 18:04:21 kid1| SECURITY ALERT: Host header forgery detected 
on local=216.58.222.106:443 remote=10.4.1.123:39994 FD 73 flags=33 
(local IP does not match any domain IP)
2020/11/06 18:04:21 kid1| SECURITY ALERT: on URL: 
chromesyncpasswords-pa.googleapis.com:443

     and usually a NONE/409 (Conflict) log entry is generated on those. 
Refreshing once or twice and it will eventually work.

     I have found several discussions on this and I can confirm it 
happens on hostnames that resolvs to several different IPs or hostnames 
that, somehow, keeps changing IPs (CDNs or something like that).

     Clients are already using the same DNS server as the squid box, as 
recommended, but problem is still happening quite a lot. For regular 
hostnames who translates for a single IP address, things are 100% working.

     Questions:

     - without using WPAD or without configuring proxy on the client 
devices, is this somehow &quot;fixable&quot; ? Same DNS already being used ...
     - is there any chance the NONE/409 (Conflict) logs i'm seeing are 
not related to this? Maybe these are just WARNINGs and not ERRORs, or 
these would really cause a fail to the intercepted connection?
     - any other hint on this one without having to set proxy, in any 
way, on the clients? I just wanna have hostnames (and traffic generated) 
logged, no need for full decrypt (bumping) of the connections.


     Thanks !!!






-- 


	Atenciosamente / Sincerily,
	Leonardo Rodrigues
	Solutti Tecnologia
	<A HREF="http://www.solutti.com.br">http://www.solutti.com.br</A>

	Minha armadilha de SPAM, N&#195;O mandem email
	<A HREF="https://lists.squid-cache.org/listinfo/squid-users">gertrudes at solutti.com.br</A>
	My SPAMTRAP, do not email it



_______________________________________________
squid-users mailing list
<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
<A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="022914.html">[squid-users] issues with sslbump and &quot;Host header forgery detected&quot; warnings
</A></li>
	<LI>Next message (by thread): <A HREF="022919.html">[squid-users] issues with sslbump and &quot;Host header forgery detected&quot; warnings
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22917">[ date ]</a>
              <a href="thread.html#22917">[ thread ]</a>
              <a href="subject.html#22917">[ subject ]</a>
              <a href="author.html#22917">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
