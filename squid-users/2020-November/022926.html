<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] TLS renegotiation failing between squids in hierarchy in Squid 4.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20TLS%20renegotiation%20failing%20between%20squids%20in%0A%20hierarchy%20in%20Squid%204.&In-Reply-To=%3C6841aad3-09a1-c0b5-6d7f-35e7b754ee6e%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="022923.html">
   <LINK REL="Next"  HREF="022928.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] TLS renegotiation failing between squids in hierarchy in Squid 4.</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20TLS%20renegotiation%20failing%20between%20squids%20in%0A%20hierarchy%20in%20Squid%204.&In-Reply-To=%3C6841aad3-09a1-c0b5-6d7f-35e7b754ee6e%40measurement-factory.com%3E"
       TITLE="[squid-users] TLS renegotiation failing between squids in hierarchy in Squid 4.">rousskov at measurement-factory.com
       </A><BR>
    <I>Wed Nov 11 17:15:14 UTC 2020</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="022923.html">[squid-users] TLS renegotiation failing between squids in hierarchy in Squid 4.
</A></li>
        <LI>Next message (by thread): <A HREF="022928.html">[squid-users] TLS renegotiation failing between squids in hierarchy in Squid 4.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22926">[ date ]</a>
              <a href="thread.html#22926">[ thread ]</a>
              <a href="subject.html#22926">[ subject ]</a>
              <a href="author.html#22926">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 11/11/20 10:19 AM, Manoj Wajekar wrote:

&gt;<i> I am currently squid-cache in hierarchy setup, with TLS enabled throughout.
</I>&gt;<i> 
</I>&gt;<i> client --&gt; child Squid --&gt; parent Squid --&gt; web server
</I>
Do you use SslBump anywhere?


&gt;<i> Openssl version: 1.0.2k
</I>&gt;<i> This setup is working for 3.5.20.
</I>
&gt;<i> But when I updated to squid 4(tried 4.8, 4.11 and 4.13),
</I>
Does all of the above apply to both child and parent Squids? Or just the
child?


&gt;<i> initial HTTP request goes through, but TLS renegotiation is failing
</I>&gt;<i> between child and parent squid for the following requests.
</I>&gt;<i> 
</I>&gt;<i> From the logs, it looks like child squid is trying to initialize TLS
</I>&gt;<i> renegotiating using old TLS session ID, but parent squid is rejecting
</I>&gt;<i> session resumption.
</I>&gt;<i> 
</I>&gt;<i> I confirm this behavior using openssl s_client --reconnect option.
</I>&gt;<i> &#160;
</I>&gt;<i> I tried to disabled client initialed TLS renegotiating by setting
</I>&gt;<i> tls-options=NO_TICKET (on child squid), but it is affecting the behavior.
</I>
Did you mean to say &quot;_not_ affecting the behavior&quot;?


&gt;<i> Are there any changes in default TLS renegotiation behavior between
</I>&gt;<i> squid 3.5 and 4.x?
</I>
It is difficult for me to say for sure -- too many changes in the
surrounding code, too long ago. &quot;Maybe&quot; is the best answer I can give.
Hopefully, others can be more specific.


&gt;<i> Is there a way to disable the client (child squid) initialized TLS
</I>&gt;<i> renegotiation in squid 4?
</I>
OpenSSL v1.1 docs have the following paragraph:

&gt;<i> By default OpenSSL will use stateless tickets. The SSL_OP_NO_TICKET
</I>&gt;<i> option will cause stateless tickets to not be issued. In TLSv1.2 and
</I>&gt;<i> below this means no ticket gets sent to the client at all. In TLSv1.3
</I>&gt;<i> a stateful ticket will be sent. This is a server-side option only.
</I>
The last sentence is interesting. However, OpenSSL v1.0 documentation
does not have that last caveat. It has another somewhat vague or open to
interpretation statement. Perhaps OpenSSL behavior changed with v1.1. In
that case, ignore this caveat.

You can try options discussed in the SECURE RENEGOTIATION section of
<A HREF="https://www.openssl.org/docs/man1.0.2/man3/SSL_CTX_set_options.html">https://www.openssl.org/docs/man1.0.2/man3/SSL_CTX_set_options.html</A>
but it is not clear to me whether they apply to your environment.


Alex.

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="022923.html">[squid-users] TLS renegotiation failing between squids in hierarchy in Squid 4.
</A></li>
	<LI>Next message (by thread): <A HREF="022928.html">[squid-users] TLS renegotiation failing between squids in hierarchy in Squid 4.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22926">[ date ]</a>
              <a href="thread.html#22926">[ thread ]</a>
              <a href="subject.html#22926">[ subject ]</a>
              <a href="author.html#22926">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
