<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] TLS renegotiation failing between squids in hierarchy in Squid 4.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20TLS%20renegotiation%20failing%20between%20squids%20in%0A%20hierarchy%20in%20Squid%204.&In-Reply-To=%3CCABrhxqsBbcnAP5Lpiosfr7GSUmzz-xnmFwC%3DPwGNdYjJuy2J9w%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="022926.html">
   <LINK REL="Next"  HREF="022929.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] TLS renegotiation failing between squids in hierarchy in Squid 4.</H1>
    <B>Manoj Wajekar</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20TLS%20renegotiation%20failing%20between%20squids%20in%0A%20hierarchy%20in%20Squid%204.&In-Reply-To=%3CCABrhxqsBbcnAP5Lpiosfr7GSUmzz-xnmFwC%3DPwGNdYjJuy2J9w%40mail.gmail.com%3E"
       TITLE="[squid-users] TLS renegotiation failing between squids in hierarchy in Squid 4.">manojwajekar93 at gmail.com
       </A><BR>
    <I>Wed Nov 11 19:35:15 UTC 2020</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="022926.html">[squid-users] TLS renegotiation failing between squids in hierarchy in Squid 4.
</A></li>
        <LI>Next message (by thread): <A HREF="022929.html">[squid-users] mime deny not working anymore
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22928">[ date ]</a>
              <a href="thread.html#22928">[ thread ]</a>
              <a href="subject.html#22928">[ subject ]</a>
              <a href="author.html#22928">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>   &gt; I am currently squid-cache in hierarchy setup, with TLS enabled
throughout.

&gt;<i> &gt; client --&gt; child Squid --&gt; parent Squid --&gt; web server
</I>&gt;<i>
</I>&gt;<i> &gt;&gt; Do you use SslBump anywhere?
</I>&gt;<i>
</I>       I am not using  SslBump. Part of my child squid config looks like:


https_port 3128\
 accel\
 no-vhost\
 defaultsite=origin\
 cert=/squid/certs/server/cert.pem\
 key=/squid/certs/server/key.pem\
 cafile=/squid/certs/server/ca.pem\
 clientca=/squid/certs/server/ca.pem

cache_peer\
 parentsquid.com\
 parent\
 3128\
 0\
 no-query\
 originserver\
 no-digest\
 no-netdb-exchange\
 login=PASSTHRU\
 tls\
 tls-options=NO_TICKET\
 sslcert=/squid/certs/client/cert.pem\
 sslkey=/squid/certs/client/key.pem\
 tls-cafile=/squid/certs/client/ca.pem


&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; Openssl version: 1.0.2k
</I>&gt;<i> &gt; This setup is working for 3.5.20.
</I>&gt;<i>
</I>&gt;<i> &gt; But when I updated to squid 4(tried 4.8, 4.11 and 4.13),
</I>&gt;<i>
</I>&gt;<i> &gt;&gt; Does all of the above apply to both child and parent Squids? Or just the
</I>&gt;<i> &gt;&gt; child?
</I>&gt;<i>
</I>    Following scenarios are working:
    client --&gt; child Squid 3.5.20 --&gt; parent Squid 3.5.20 --&gt; web server
    client --&gt; child Squid 4 --&gt; parent Squid 3.5.20 --&gt; web server
    client --&gt; Squid 4  --&gt; web server

    But this scenarios is failing:
  client --&gt; child Squid 4 --&gt; parent Squid 4 --&gt; web server

&gt;<i>
</I>&gt;<i> &gt; initial HTTP request goes through, but TLS renegotiation is failing
</I>&gt;<i> &gt; between child and parent squid for the following requests.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; From the logs, it looks like child squid is trying to initialize TLS
</I>&gt;<i> &gt; renegotiating using old TLS session ID, but parent squid is rejecting
</I>&gt;<i> &gt; session resumption.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I confirm this behavior using openssl s_client --reconnect option.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I tried to disabled client initialed TLS renegotiating by setting
</I>&gt;<i> &gt; tls-options=NO_TICKET (on child squid), but it is affecting the behavior.
</I>&gt;<i>
</I>&gt;<i> &gt;&gt; Did you mean to say &quot;_not_ affecting the behavior&quot;?
</I>&gt;<i>
</I>      Sorry for typo. Yes, with NO_TICKET set, I am encountering same
issue.

&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; Are there any changes in default TLS renegotiation behavior between
</I>&gt;<i> &gt; squid 3.5 and 4.x?
</I>&gt;<i>
</I>&gt;<i> It is difficult for me to say for sure -- too many changes in the
</I>&gt;<i> surrounding code, too long ago. &quot;Maybe&quot; is the best answer I can give.
</I>&gt;<i> Hopefully, others can be more specific.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; Is there a way to disable the client (child squid) initialized TLS
</I>&gt;<i> &gt; renegotiation in squid 4?
</I>&gt;<i>
</I>&gt;<i> &gt;&gt; OpenSSL v1.1 docs have the following paragraph:
</I>&gt;<i>
</I>&gt;<i> &gt; By default OpenSSL will use stateless tickets. The SSL_OP_NO_TICKET
</I>&gt;<i> &gt; option will cause stateless tickets to not be issued. In TLSv1.2 and
</I>&gt;<i> &gt; below this means no ticket gets sent to the client at all. In TLSv1.3
</I>&gt;<i> &gt; a stateful ticket will be sent. This is a server-side option only.
</I>&gt;<i> &gt;&gt; The last sentence is interesting. However, OpenSSL v1.0 documentation
</I>&gt;<i> &gt;&gt; does not have that last caveat. It has another somewhat vague or open to
</I>&gt;<i> &gt;&gt; interpretation statement. Perhaps OpenSSL behavior changed with v1.1. In
</I>&gt;<i> &gt;&gt; that case, ignore this caveat.
</I>&gt;<i>
</I>&gt;<i> &gt;&gt; You can try options discussed in the SECURE RENEGOTIATION section of
</I>&gt;<i> &gt;&gt; <A HREF="https://www.openssl.org/docs/man1.0.2/man3/SSL_CTX_set_options.html">https://www.openssl.org/docs/man1.0.2/man3/SSL_CTX_set_options.html</A>
</I>&gt;<i> &lt;<A HREF="https://www.openssl.org/docs/man1.0.2/man3/SSL_CTX_set_options.html">https://www.openssl.org/docs/man1.0.2/man3/SSL_CTX_set_options.html</A>&gt;
</I>&gt;<i> &gt;&gt; but it is not clear to me whether they apply to your environment.
</I>&gt;<i>
</I>
  I tried SSL_OP_NO_SESSION_RESUMPTION_ON_RENEGOTIATION,
SSL_OP_ALLOW_UNSAFE_LEGACY_RENEGOTIATION, etc in
 openssl option.
  but it did not changed the behaviour.
  Unfortunately, I can't update to OpenSSL v1.1 because of OS dependency
issues.


&gt;<i> Manoj
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20201111/e46ad9b9/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20201111/e46ad9b9/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="022926.html">[squid-users] TLS renegotiation failing between squids in hierarchy in Squid 4.
</A></li>
	<LI>Next message (by thread): <A HREF="022929.html">[squid-users] mime deny not working anymore
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22928">[ date ]</a>
              <a href="thread.html#22928">[ thread ]</a>
              <a href="subject.html#22928">[ subject ]</a>
              <a href="author.html#22928">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
