<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] BUG 3556
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20BUG%203556&In-Reply-To=%3Cce35e7b8-db00-aee1-6dbf-a1c5e09a9edd%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="022826.html">
   <LINK REL="Next"  HREF="022828.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] BUG 3556</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20BUG%203556&In-Reply-To=%3Cce35e7b8-db00-aee1-6dbf-a1c5e09a9edd%40measurement-factory.com%3E"
       TITLE="[squid-users] BUG 3556">rousskov at measurement-factory.com
       </A><BR>
    <I>Thu Oct 15 13:59:03 UTC 2020</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="022826.html">[squid-users] BUG 3556
</A></li>
        <LI>Next message (by thread): <A HREF="022828.html">[squid-users] BUG 3556
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22827">[ date ]</a>
              <a href="thread.html#22827">[ thread ]</a>
              <a href="subject.html#22827">[ subject ]</a>
              <a href="author.html#22827">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 10/15/20 4:07 AM, Stephen Borrill wrote:
&gt;<i> At a few installations of squid 4.12 (patched for GREASE) on NetBSD
</I>&gt;<i> 9, I'm seeing that occasionally one of the listening ports no longer 
</I>&gt;<i> accepts connections (it doesn't reject them, but a connection does
</I>&gt;<i> not get established).&gt; The port appears random; it's not the same
</I>&gt;<i> every time and isn't related to ports with SSL interception. A
</I>&gt;<i> restart of squid fixes it.
</I>
&gt;<i> Looking through the logs, this appears to coincide with lines such as:
</I>&gt;<i> 
</I>&gt;<i> 2020/10/14 22:32:16 kid1| ERROR: getsockname() failed to locate local-IP
</I>&gt;<i> on local=[::] remote=10.0.106.147:61996 FD 25 flags=1: (22) Invalid argument
</I>&gt;<i> 2020/10/14 22:32:16 kid1| BUG 3556: FD 25 is not an open socket.
</I>&gt;<i> 
</I>&gt;<i> This looks similar to Alex Rousskov's recent observations:
</I>&gt;<i> <A HREF="https://bugs.squid-cache.org/show_bug.cgi?id=3556#c15">https://bugs.squid-cache.org/show_bug.cgi?id=3556#c15</A>
</I>
Please keep in mind that those &quot;BUG 3556&quot; messages warn us about Squid
bugs elsewhere/somewhere in Squid code. For each particular message
instance, the exact bug is unknown a priori, and several different bugs
have triggered these messages in the past. While the original bug 3556
report was for a specific bug, the log messages were not (and are not).


&gt;<i> However, we have also seen with at sites where there is no SSL
</I>&gt;<i> interception (the above lines are from such an installation).
</I>
&gt;<i> 1) Am I right that triggering BUG 3556 could lead to the described symptoms?
</I>
I would rephrase this as &quot;Failure to obtain the (intended) IP address of
an (intercepted) connection leads to BUG 3556 messages.&quot;


&gt;<i> 2) Is this a squid bug or triggered by a problem in the underlying OS?
</I>
Those &quot;BUG 3556&quot; messages indicate a Squid bug. There is no question
about that. However, the ERROR messages may indicate a Squid
bug/deficiency and/or an environment (OS configuration, etc.) problem.
In summary, you are dealing with multiple problems here. You should
focus on the ERROR messages, not &quot;BUG 3556&quot; messages.


&gt;<i> If the latter, where to start looking?
</I>
Check system log for errors. Perhaps you are exhausting some system
resource?

I would also try to map ERROR messages to client transactions in hope to
spot some common pattern behind those failed transactions.
Unfortunately, I do not know whether Squid (especially Squid v4) would
log these failed transactions.


&gt;<i> 3) What workarounds are there?
</I>
a) Monitor logs and automatically restart the Squid instance if needed.

b) Patch Squid to kill the affected process. Adding &quot;assert(false);&quot;
after the ERROR message is printed in Comm::TcpAcceptor::oldAccept()
will kill the process. Killing a single worker may or may not be enough
in SMP mode; it would be interesting and potentially useful to know
whether that is enough.

You may be able to easily test your workaround using the trick I
outlined in <A HREF="https://bugs.squid-cache.org/show_bug.cgi?id=3556#c15">https://bugs.squid-cache.org/show_bug.cgi?id=3556#c15</A>


&gt;<i> Given that a restart fixes it, in some
</I>&gt;<i> respects it would be better for squid to quit so it can be restarted
</I>&gt;<i> rather than continue to run in a half-working state.
</I>
Yes, earlier Squids were written using the &quot;Do whatever you can to stay
up&quot; or &quot;Damn the torpedoes!&quot; principle. FWIW, I am pushing for reversing
the relevant code logic to follow the &quot;Squid instance that cannot
provide an essential service explicitly requested by the admin should
quit with an error&quot; principle, but it will take time to achieve that ideal.


&gt;<i> 4) Related to 3), are there any other ways to detect the problem when it
</I>&gt;<i> is happening besides parsing logs or testing if all ports are accepting
</I>&gt;<i> connections? This could be used to trigger an automated restart as a
</I>&gt;<i> temporary workaround.
</I>
Yes, see suggestion 3b above.


HTH,

Alex.

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="022826.html">[squid-users] BUG 3556
</A></li>
	<LI>Next message (by thread): <A HREF="022828.html">[squid-users] BUG 3556
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22827">[ date ]</a>
              <a href="thread.html#22827">[ thread ]</a>
              <a href="subject.html#22827">[ subject ]</a>
              <a href="author.html#22827">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
