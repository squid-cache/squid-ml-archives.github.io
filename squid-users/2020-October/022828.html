<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] BUG 3556
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20BUG%203556&In-Reply-To=%3Cba47da5d-4694-a25b-e63e-b5fb0293a8b7%40borrill.org.uk%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="022827.html">
   <LINK REL="Next"  HREF="022830.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] BUG 3556</H1>
    <B>Stephen Borrill</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20BUG%203556&In-Reply-To=%3Cba47da5d-4694-a25b-e63e-b5fb0293a8b7%40borrill.org.uk%3E"
       TITLE="[squid-users] BUG 3556">squid at borrill.org.uk
       </A><BR>
    <I>Thu Oct 15 14:06:04 UTC 2020</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="022827.html">[squid-users] BUG 3556
</A></li>
        <LI>Next message (by thread): <A HREF="022830.html">[squid-users] BUG 3556
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22828">[ date ]</a>
              <a href="thread.html#22828">[ thread ]</a>
              <a href="subject.html#22828">[ subject ]</a>
              <a href="author.html#22828">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 15/10/2020 14:59, Alex Rousskov wrote:
&gt;<i> On 10/15/20 4:07 AM, Stephen Borrill wrote:
</I>&gt;&gt;<i> At a few installations of squid 4.12 (patched for GREASE) on NetBSD
</I>&gt;&gt;<i> 9, I'm seeing that occasionally one of the listening ports no longer 
</I>&gt;&gt;<i> accepts connections (it doesn't reject them, but a connection does
</I>&gt;&gt;<i> not get established).&gt; The port appears random; it's not the same
</I>&gt;&gt;<i> every time and isn't related to ports with SSL interception. A
</I>&gt;&gt;<i> restart of squid fixes it.
</I>&gt;<i> 
</I>&gt;&gt;<i> Looking through the logs, this appears to coincide with lines such as:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> 2020/10/14 22:32:16 kid1| ERROR: getsockname() failed to locate local-IP
</I>&gt;&gt;<i> on local=[::] remote=10.0.106.147:61996 FD 25 flags=1: (22) Invalid argument
</I>&gt;&gt;<i> 2020/10/14 22:32:16 kid1| BUG 3556: FD 25 is not an open socket.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> This looks similar to Alex Rousskov's recent observations:
</I>&gt;&gt;<i> <A HREF="https://bugs.squid-cache.org/show_bug.cgi?id=3556#c15">https://bugs.squid-cache.org/show_bug.cgi?id=3556#c15</A>
</I>&gt;<i> 
</I>&gt;<i> Please keep in mind that those &quot;BUG 3556&quot; messages warn us about Squid
</I>&gt;<i> bugs elsewhere/somewhere in Squid code. For each particular message
</I>&gt;<i> instance, the exact bug is unknown a priori, and several different bugs
</I>&gt;<i> have triggered these messages in the past. While the original bug 3556
</I>&gt;<i> report was for a specific bug, the log messages were not (and are not).
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> However, we have also seen with at sites where there is no SSL
</I>&gt;&gt;<i> interception (the above lines are from such an installation).
</I>&gt;<i> 
</I>&gt;&gt;<i> 1) Am I right that triggering BUG 3556 could lead to the described symptoms?
</I>&gt;<i> 
</I>&gt;<i> I would rephrase this as &quot;Failure to obtain the (intended) IP address of
</I>&gt;<i> an (intercepted) connection leads to BUG 3556 messages.&quot;
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> 2) Is this a squid bug or triggered by a problem in the underlying OS?
</I>&gt;<i> 
</I>&gt;<i> Those &quot;BUG 3556&quot; messages indicate a Squid bug. There is no question
</I>&gt;<i> about that. However, the ERROR messages may indicate a Squid
</I>&gt;<i> bug/deficiency and/or an environment (OS configuration, etc.) problem.
</I>&gt;<i> In summary, you are dealing with multiple problems here. You should
</I>&gt;<i> focus on the ERROR messages, not &quot;BUG 3556&quot; messages.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> If the latter, where to start looking?
</I>&gt;<i> 
</I>&gt;<i> Check system log for errors. Perhaps you are exhausting some system
</I>&gt;<i> resource?
</I>
That's always my first port of call anyway, there are no reports.

&gt;<i> I would also try to map ERROR messages to client transactions in hope to
</I>&gt;<i> spot some common pattern behind those failed transactions.
</I>&gt;<i> Unfortunately, I do not know whether Squid (especially Squid v4) would
</I>&gt;<i> log these failed transactions.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> 3) What workarounds are there?
</I>&gt;<i> 
</I>&gt;<i> a) Monitor logs and automatically restart the Squid instance if needed.
</I>&gt;<i> 
</I>&gt;<i> b) Patch Squid to kill the affected process. Adding &quot;assert(false);&quot;
</I>&gt;<i> after the ERROR message is printed in Comm::TcpAcceptor::oldAccept()
</I>&gt;<i> will kill the process. Killing a single worker may or may not be enough
</I>&gt;<i> in SMP mode; it would be interesting and potentially useful to know
</I>&gt;<i> whether that is enough.
</I>
We aren't using SMP mode.

&gt;<i> You may be able to easily test your workaround using the trick I
</I>&gt;<i> outlined in <A HREF="https://bugs.squid-cache.org/show_bug.cgi?id=3556#c15">https://bugs.squid-cache.org/show_bug.cgi?id=3556#c15</A>
</I>
I have also been pointed to your comment here:
<A HREF="https://bugs.squid-cache.org/show_bug.cgi?id=5069#c1">https://bugs.squid-cache.org/show_bug.cgi?id=5069#c1</A>

I'm currently testing the COMM_ERROR -&gt; NOMESSAGE patch as bug 5069
sounds identical.

&gt;&gt;<i> Given that a restart fixes it, in some
</I>&gt;&gt;<i> respects it would be better for squid to quit so it can be restarted
</I>&gt;&gt;<i> rather than continue to run in a half-working state.
</I>&gt;<i> 
</I>&gt;<i> Yes, earlier Squids were written using the &quot;Do whatever you can to stay
</I>&gt;<i> up&quot; or &quot;Damn the torpedoes!&quot; principle. FWIW, I am pushing for reversing
</I>&gt;<i> the relevant code logic to follow the &quot;Squid instance that cannot
</I>&gt;<i> provide an essential service explicitly requested by the admin should
</I>&gt;<i> quit with an error&quot; principle, but it will take time to achieve that ideal.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> 4) Related to 3), are there any other ways to detect the problem when it
</I>&gt;&gt;<i> is happening besides parsing logs or testing if all ports are accepting
</I>&gt;&gt;<i> connections? This could be used to trigger an automated restart as a
</I>&gt;&gt;<i> temporary workaround.
</I>&gt;<i> 
</I>&gt;<i> Yes, see suggestion 3b above.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> HTH,
</I>&gt;<i> 
</I>&gt;<i> Alex.
</I>&gt;<i> 
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="022827.html">[squid-users] BUG 3556
</A></li>
	<LI>Next message (by thread): <A HREF="022830.html">[squid-users] BUG 3556
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22828">[ date ]</a>
              <a href="thread.html#22828">[ thread ]</a>
              <a href="subject.html#22828">[ subject ]</a>
              <a href="author.html#22828">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
