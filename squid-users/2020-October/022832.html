<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] websockets through Squid
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20websockets%20through%20Squid&In-Reply-To=%3C6d6f7953-b550-4aa5-2cee-f87501772834%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="022829.html">
   <LINK REL="Next"  HREF="022834.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] websockets through Squid</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20websockets%20through%20Squid&In-Reply-To=%3C6d6f7953-b550-4aa5-2cee-f87501772834%40measurement-factory.com%3E"
       TITLE="[squid-users] websockets through Squid">rousskov at measurement-factory.com
       </A><BR>
    <I>Thu Oct 15 15:28:01 UTC 2020</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="022829.html">[squid-users] websockets through Squid
</A></li>
        <LI>Next message (by thread): <A HREF="022834.html">[squid-users] websockets through Squid
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22832">[ date ]</a>
              <a href="thread.html#22832">[ thread ]</a>
              <a href="subject.html#22832">[ subject ]</a>
              <a href="author.html#22832">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 10/15/20 10:08 AM, Vieri wrote:
&gt;<i>  On Tuesday, October 13, 2020, 6:14:18 PM GMT+2, Alex Rousskov wrote: 
</I>&gt;&gt;<i> You should probably follow up with Gentoo folks responsible for this Squid customization.
</I>
&gt;<i> Squid 5 now builds and installs perfectly on Gentoo Linux with a few
</I>&gt;<i> custom changes to the distro's package installation script. I hope
</I>&gt;<i> the devs will include these changes so Squid 5 can be readily
</I>&gt;<i> available to everyone.
</I>
Thank you for reporting your fixes to Gentoo.


&gt;<i> I added this to Squid 5:
</I>
&gt;<i> http_upgrade_request_protocols OTHER allow all
</I>
&gt;<i> Am I right if I state that this should allow any protocol not just WebSockets?
</I>
Yes.

&gt;<i> In other words, I do not need to be specific with
</I>&gt;<i> 'http_upgrade_request_protocols WebSocket allow all' unless I want
</I>&gt;<i> to, right?
</I>
Just in case somebody else starts copy-pasting the above rule into their
configurations: The standard (RFC 6455) WebSocket protocol name in HTTP
Upgrade requests is &quot;websocket&quot;. Squid uses case-sensitive comparison
for those names so you should use &quot;websocket&quot; in squid.conf.

Other than that correction, you are right -- a bare OTHER rule is more
risky in general but is sufficient for allowing WebSocket upgrades.


&gt;<i> Unfortunately, after reloading Squid 5 the client browser still states the same:
</I>&gt;<i> 
</I>&gt;<i> The connection to <A HREF="wss://ed1lncb65702.webex.com/direct?type=websocket&amp;dtype=binary&amp;rand=1602769907574&amp;uuidtag=9E73C14G-1580-43B4-B8D4-91453FCF1939&amp;gatewayip=MY_IP_ADDR">wss://ed1lncb65702.webex.com/direct?type=websocket&amp;dtype=binary&amp;rand=1602769907574&amp;uuidtag=9E73C14G-1580-43B4-B8D4-91453FCF1939&amp;gatewayip=MY_IP_ADDR</A> was interrupted while the page was loading.
</I>&gt;<i> 
</I>&gt;<i> And in access.log I can see this:
</I>&gt;<i> 
</I>&gt;<i> [Thu Oct 15 15:52:27 2020].411&#160; 29846 10.215.144.48 TCP_TUNNEL/101 0 GET <A HREF="https://ed1lncb65702.webex.com/direct?">https://ed1lncb65702.webex.com/direct?</A> - ORIGINAL_DST/62.109.225.174 -
</I>&gt;<i> [Thu Oct 15 15:52:27 2020].831&#160;&#160;&#160; 125 10.215.144.48 NONE_NONE/000 0 CONNECT 62.109.225.174:443 - ORIGINAL_DST/62.109.225.174 -
</I>&gt;<i> [Thu Oct 15 15:52:28 2020].786&#160;&#160;&#160;&#160; 11 10.215.111.210 NONE_NONE_ABORTED/000 0 CONNECT 44.233.111.149:443 - HIER_NONE/- -
</I>&gt;<i> [Thu Oct 15 15:52:37 2020].414&#160; 29870 10.215.144.48 TCP_TUNNEL/101 0 GET <A HREF="https://ed1lncb65702.webex.com/direct?">https://ed1lncb65702.webex.com/direct?</A> - ORIGINAL_DST/62.109.225.174 -
</I>&gt;<i> [Thu Oct 15 15:52:37 2020].919&#160;&#160;&#160; 107 10.215.144.48 NONE_NONE/000 0 CONNECT 62.109.225.174:443 - ORIGINAL_DST/62.109.225.174 -
</I>
&gt;<i> What does NONE_NONE/000 mean?
</I>
It is a (relatively minor) bug in Squid. Squid probably forgot to set
the exact outcome of the transaction at transaction logging time and
probably logged absent status code as 000. We already have a project
that should fix the status code handling in such cases.

The important part here is the existence of those extra transactions.
They may be related to SslBump if you are bumbing this traffic, but then
I would expect a slightly different access.log composition.


&gt;<i> Where can I go from here?
</I>&gt;<i> What can I try to debug this further?
</I>
The log shows successful tunnel negotiation (two TCP_TUNNEL/101 entries)
and potentially problematic transactions. It is not clear (to me)
whether they all correspond to the same client interaction. It is
possible that the client successfully tunneled some websocket
transactions but failed to tunnel others. It is also possible, although
less likely, that the client has detected a proxy presence and refused
to tunnel despite receiving a successful 101 response from Squid.

IMO, further triage requires analyzing debugging cache.log. In my
experience, such analysis usually requires developer expertise. You can
try posting a link to compressed cache.log containing just the
corresponding transactions/interactions with debug_options set to
&quot;ALL,9&quot; (this may log passwords, keys, and such so be careful). Somebody
here may volunteer to analyze your log for you.

<A HREF="https://wiki.squid-cache.org/SquidFaq/BugReporting#Debugging_a_single_transaction">https://wiki.squid-cache.org/SquidFaq/BugReporting#Debugging_a_single_transaction</A>


HTH,

Alex.

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="022829.html">[squid-users] websockets through Squid
</A></li>
	<LI>Next message (by thread): <A HREF="022834.html">[squid-users] websockets through Squid
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22832">[ date ]</a>
              <a href="thread.html#22832">[ thread ]</a>
              <a href="subject.html#22832">[ subject ]</a>
              <a href="author.html#22832">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
