<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Reverse proxying Exchange OWA wembail with SSL offloading - not working on IE/Chrome
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Reverse%20proxying%20Exchange%20OWA%20wembail%20with%20SSL%0A%20offloading%20-%20not%20working%20on%20IE/Chrome&In-Reply-To=%3C20201028122505.GA62082%40thismonkey.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="022884.html">
   <LINK REL="Next"  HREF="022886.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Reverse proxying Exchange OWA wembail with SSL offloading - not working on IE/Chrome</H1>
    <B>Scott</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Reverse%20proxying%20Exchange%20OWA%20wembail%20with%20SSL%0A%20offloading%20-%20not%20working%20on%20IE/Chrome&In-Reply-To=%3C20201028122505.GA62082%40thismonkey.com%3E"
       TITLE="[squid-users] Reverse proxying Exchange OWA wembail with SSL offloading - not working on IE/Chrome">3m9n51s2ewut at thismonkey.com
       </A><BR>
    <I>Wed Oct 28 12:25:05 UTC 2020</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="022884.html">[squid-users] Reverse proxying Exchange OWA wembail with SSL offloading - not working on IE/Chrome
</A></li>
        <LI>Next message (by thread): <A HREF="022886.html">[squid-users] Reverse proxying Exchange OWA wembail with SSL offloading
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22885">[ date ]</a>
              <a href="thread.html#22885">[ thread ]</a>
              <a href="subject.html#22885">[ subject ]</a>
              <a href="author.html#22885">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Wed, Oct 28, 2020 at 12:00:01PM +0000, <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-request at lists.squid-cache.org</A> wrote:
&gt;<i> Date: Thu, 29 Oct 2020 00:08:34 +1300
</I>&gt;<i> From: Amos Jeffries &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt;
</I>&gt;<i> To: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> Subject: Re: [squid-users] Reverse proxying Exchange OWA wembail with SSL
</I>&gt;<i>  offloading - not working on IE/Chrome
</I>&gt;<i> 
</I>&gt;<i> On 28/10/20 5:25 pm, Scott wrote:
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; Here are the logs (first not working, followed by working).
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; Note this is the login attempt, not the loading of the initial page.  You'll
</I>&gt;<i> &gt; see in the NOT WORKING section that the browser does NOT return a cookie to
</I>&gt;<i> &gt; the server, which is where the problem may be.  Again, I'm not sure why - I'm
</I>&gt;<i> &gt; thinking perhaps the browser/javascript is rejecting the cookie as it's
</I>&gt;<i> &gt; missing the &quot;secure&quot; attribute (because the back-end is talking plain HTTP).
</I>&gt;<i> &gt; 
</I>&gt;<i> 
</I>&gt;<i> The complete absence of a cookie may be expected to break something.
</I>&gt;<i> 
</I>&gt;<i> The absence of a &quot;secure&quot; flag should only make the cookie vulnerable to 
</I>&gt;<i> leaking. It should not affect anything depending on that cookies value.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Amos
</I>&gt;<i> 
</I>
My current theory is that the browser ignores the server-supplied cookie 
because it is missing the &quot;secure&quot; flag.  I could be completely wrong of 
course.  But that flag is one of the few differences between a working 
session and a not-working session.

I did find this site: 
<A HREF="https://support.kemptechnologies.com/hc/en-us/articles/202154165-How-to-Add-an-SSL-Secure-and-HTTP-only-flag-to-cookies-from-a-Real-Server">https://support.kemptechnologies.com/hc/en-us/articles/202154165-How-to-Add-an-SSL-Secure-and-HTTP-only-flag-to-cookies-from-a-Real-Server</A> 
that is in the same ball park of my suspicions.

I've tried building an ICAP server using the examples from PyICAP and have 
got as far as receiving the data and altering the header but I can't work out 
how to send the modified header and data back to Squid.

My code is:

   def cookie_RESPMOD(self):
       self.set_icap_response(200)

       self.set_enc_status(b' '.join(self.enc_res_status))
       for h in self.enc_res_headers:
           for v in self.enc_res_headers[h]:
               if h == &quot;set-cookie&quot; and re.search(r'HttpOnly', v) and not re.search(r'secure', v):
                   v = v.replace('; HttpOnly', '; secure; HttpOnly')
                   print(&quot;h: &quot;, h, &quot;v: &quot;, v)
               self.set_enc_header(h, v)

       if not self.has_body:
           self.send_headers(False)
           return

       self.send_headers(True)
           return

I'm sure it's something simple like not sending the body.  I really need to read the ICAP docs/RFCs.

The script generates the following:
10.2.255.1 - - [28/Oct/2020 23:17:21] &quot;OPTIONS <A HREF="icap://10.2.255.1:40000/cookie">icap://10.2.255.1:40000/cookie</A> ICAP/1.0&quot; 200 -
10.2.255.1 - - [28/Oct/2020 23:17:21] &quot;RESPMOD <A HREF="icap://10.2.255.1:40000/cookie">icap://10.2.255.1:40000/cookie</A> ICAP/1.0&quot; 200 -
10.2.255.1 - - [28/Oct/2020 23:17:21] code 400, message B
10.2.255.1 - - [28/Oct/2020 23:17:31] &quot;RESPMOD <A HREF="icap://10.2.255.1:40000/cookie">icap://10.2.255.1:40000/cookie</A> ICAP/1.0&quot; 200 -
10.2.255.1 - - [28/Oct/2020 23:17:31] code 400, message B
10.2.255.1 - - [28/Oct/2020 23:17:31] &quot;RESPMOD <A HREF="icap://10.2.255.1:40000/cookie">icap://10.2.255.1:40000/cookie</A> ICAP/1.0&quot; 200 -
10.2.255.1 - - [28/Oct/2020 23:17:31] code 400, message B

I might look into a code hack as a means of testing.

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="022884.html">[squid-users] Reverse proxying Exchange OWA wembail with SSL offloading - not working on IE/Chrome
</A></li>
	<LI>Next message (by thread): <A HREF="022886.html">[squid-users] Reverse proxying Exchange OWA wembail with SSL offloading
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22885">[ date ]</a>
              <a href="thread.html#22885">[ thread ]</a>
              <a href="subject.html#22885">[ subject ]</a>
              <a href="author.html#22885">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
