<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Reverse proxying Exchange OWA wembail with SSL offloading
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Reverse%20proxying%20Exchange%20OWA%20wembail%20with%20SSL%0A%20offloading&In-Reply-To=%3C005101d6adeb%24d39f4a80%247adddf80%24%40gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="022892.html">
   <LINK REL="Next"  HREF="022893.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Reverse proxying Exchange OWA wembail with SSL offloading</H1>
    <B>Eliezer Croitor</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Reverse%20proxying%20Exchange%20OWA%20wembail%20with%20SSL%0A%20offloading&In-Reply-To=%3C005101d6adeb%24d39f4a80%247adddf80%24%40gmail.com%3E"
       TITLE="[squid-users] Reverse proxying Exchange OWA wembail with SSL offloading">ngtech1ltd at gmail.com
       </A><BR>
    <I>Thu Oct 29 12:05:42 UTC 2020</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="022892.html">[squid-users] Reverse proxying Exchange OWA wembail with SSL offloading
</A></li>
        <LI>Next message (by thread): <A HREF="022893.html">[squid-users] Best practice for adding or removing ACLs dynamically ?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22888">[ date ]</a>
              <a href="thread.html#22888">[ thread ]</a>
              <a href="subject.html#22888">[ subject ]</a>
              <a href="author.html#22888">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hey Scott,

In many frontends there is a basic way to signal about the existence of a Frontend and the relevant
details about the client and other factors of the connection.

Specifically with haproxy these settings are used:
    http-request set-header X-Forwarded-Host %[req.hdr(Host)]
    http-request set-header X-Forwarded-Proto https

<A HREF="https://www.haproxy.com/blog/ssl-offloading-impact-on-web-applications/">https://www.haproxy.com/blog/ssl-offloading-impact-on-web-applications/</A>
<A HREF="https://www.digitalocean.com/community/tutorials/how-to-implement-ssl-termination-with-haproxy-on-ubuntu-14-04">https://www.digitalocean.com/community/tutorials/how-to-implement-ssl-termination-with-haproxy-on-ubuntu-14-04</A>

In nginx:
<A HREF="https://www.nginx.com/resources/wiki/start/topics/examples/forwarded/">https://www.nginx.com/resources/wiki/start/topics/examples/forwarded/</A>
<A HREF="https://www.digitalocean.com/community/tutorials/how-to-set-up-nginx-load-balancing-with-ssl-termination">https://www.digitalocean.com/community/tutorials/how-to-set-up-nginx-load-balancing-with-ssl-termination</A>


In squid you can use:
<A HREF="http://www.squid-cache.org/Doc/config/request_header_replace/">http://www.squid-cache.org/Doc/config/request_header_replace/</A>
<A HREF="http://www.squid-cache.org/Doc/config/request_header_add/">http://www.squid-cache.org/Doc/config/request_header_add/</A>

An example should be provided in wiki some day be someone(not me).

----
Eliezer Croitoru
Tech Support
Mobile: +972-5-28704261
Email: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">ngtech1ltd at gmail.com</A>

-----Original Message-----
From: squid-users &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>&gt; On Behalf Of Scott
Sent: Thursday, October 29, 2020 1:07 AM
To: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
Subject: Re: [squid-users] Reverse proxying Exchange OWA wembail with SSL offloading

On Wed, Oct 28, 2020 at 12:00:01PM +0000, <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-request at lists.squid-cache.org</A> wrote:
&gt;<i> Date: Thu, 29 Oct 2020 00:08:34 +1300
</I>&gt;<i> From: Amos Jeffries &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt;
</I>&gt;<i> To: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> Subject: Re: [squid-users] Reverse proxying Exchange OWA wembail with SSL
</I>&gt;<i>  offloading - not working on IE/Chrome
</I>&gt;<i> 
</I>&gt;<i> On 28/10/20 5:25 pm, Scott wrote:
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; Here are the logs (first not working, followed by working).
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; Note this is the login attempt, not the loading of the initial page.  You'll
</I>&gt;<i> &gt; see in the NOT WORKING section that the browser does NOT return a cookie to
</I>&gt;<i> &gt; the server, which is where the problem may be.  Again, I'm not sure why - I'm
</I>&gt;<i> &gt; thinking perhaps the browser/javascript is rejecting the cookie as it's
</I>&gt;<i> &gt; missing the &quot;secure&quot; attribute (because the back-end is talking plain HTTP).
</I>&gt;<i> &gt; 
</I>&gt;<i> 
</I>&gt;<i> The complete absence of a cookie may be expected to break something.
</I>&gt;<i> 
</I>&gt;<i> The absence of a &quot;secure&quot; flag should only make the cookie vulnerable to 
</I>&gt;<i> leaking. It should not affect anything depending on that cookies value.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Amos
</I>&gt;<i> 
</I>
After some more research and experimentation I've confirmed that my 
suspicions are correct.

Recent browsers are no longer accepting cookies with the SameSite flag set 
without the Secure flag set.

It's not an issue with Squid (although one Squid could solve - but I'm unsure 
of the implications).

Here is a useful link:
<A HREF="https://docs.microsoft.com/en-us/office365/troubleshoot/miscellaneous/chrome-behavior-affects-applications">https://docs.microsoft.com/en-us/office365/troubleshoot/miscellaneous/chrome-behavior-affects-applications</A>

I tested Chrome 85 on Windows - the default settings DO NOT allow for these 
cookies.  However after setting
	Cookies without SameSite must be secure
to Disabled, these cookies are permitted and OWA works.

There are obvious implications for sites doing SSL offloading here.  Are 
sites no longer doing SSL offload?  Or are reverse proxies adding the Secure 
flag?

Interesting.
_______________________________________________
squid-users mailing list
<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
<A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="022892.html">[squid-users] Reverse proxying Exchange OWA wembail with SSL offloading
</A></li>
	<LI>Next message (by thread): <A HREF="022893.html">[squid-users] Best practice for adding or removing ACLs dynamically ?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22888">[ date ]</a>
              <a href="thread.html#22888">[ thread ]</a>
              <a href="subject.html#22888">[ subject ]</a>
              <a href="author.html#22888">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
