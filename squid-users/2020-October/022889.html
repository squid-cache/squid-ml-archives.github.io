<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Reverse proxying Exchange OWA wembail with SSL offloading
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Reverse%20proxying%20Exchange%20OWA%20wembail%20with%20SSL%0A%20offloading&In-Reply-To=%3C20201030022731.GA76846%40thismonkey.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="022887.html">
   <LINK REL="Next"  HREF="022890.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Reverse proxying Exchange OWA wembail with SSL offloading</H1>
    <B>Scott</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Reverse%20proxying%20Exchange%20OWA%20wembail%20with%20SSL%0A%20offloading&In-Reply-To=%3C20201030022731.GA76846%40thismonkey.com%3E"
       TITLE="[squid-users] Reverse proxying Exchange OWA wembail with SSL offloading">3m9n51s2ewut at thismonkey.com
       </A><BR>
    <I>Fri Oct 30 02:27:31 UTC 2020</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="022887.html">[squid-users] Reverse proxying Exchange OWA wembail with SSL offloading
</A></li>
        <LI>Next message (by thread): <A HREF="022890.html">[squid-users] Reverse proxying Exchange OWA wembail with SSL offloading
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22889">[ date ]</a>
              <a href="thread.html#22889">[ thread ]</a>
              <a href="subject.html#22889">[ subject ]</a>
              <a href="author.html#22889">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Thu, Oct 29, 2020 at 10:08:42PM +1300, Amos Jeffries wrote:
&gt;<i> On 29/10/20 12:06 pm, Scott wrote:
</I>&gt;<i> &gt; On Wed, Oct 28, 2020 at 12:00:01PM +0000, squid-users-reques wrote:
</I>&gt;<i> &gt;&gt; Date: Thu, 29 Oct 2020 00:08:34 +1300
</I>&gt;<i> &gt;&gt; From: Amos Jeffries
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; On 28/10/20 5:25 pm, Scott wrote:
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt; Here are the logs (first not working, followed by working).
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt; Note this is the login attempt, not the loading of the initial page.  You'll
</I>&gt;<i> &gt;&gt;&gt; see in the NOT WORKING section that the browser does NOT return a cookie to
</I>&gt;<i> &gt;&gt;&gt; the server, which is where the problem may be.  Again, I'm not sure why - I'm
</I>&gt;<i> &gt;&gt;&gt; thinking perhaps the browser/javascript is rejecting the cookie as it's
</I>&gt;<i> &gt;&gt;&gt; missing the &quot;secure&quot; attribute (because the back-end is talking plain HTTP).
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; The complete absence of a cookie may be expected to break something.
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; The absence of a &quot;secure&quot; flag should only make the cookie vulnerable to
</I>&gt;<i> &gt;&gt; leaking. It should not affect anything depending on that cookies value.
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; Amos
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; After some more research and experimentation I've confirmed that my
</I>&gt;<i> &gt; suspicions are correct.
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; Recent browsers are no longer accepting cookies with the SameSite flag set
</I>&gt;<i> &gt; without the Secure flag set.
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; It's not an issue with Squid (although one Squid could solve - but I'm unsure
</I>&gt;<i> &gt; of the implications).
</I>&gt;<i> 
</I>&gt;<i> Implications are that the server may have intentionally used the 
</I>&gt;<i> combination it did, no mistakes.
</I>&gt;<i> 
</I>&gt;<i> The server is given &quot;Front-End-Https: On&quot; so that it is aware the client 
</I>&gt;<i> is using HTTPS and can set (or not) the secure flag appropriately to 
</I>&gt;<i> what it needs. Squid is not aware of whether the cookie is safe to use 
</I>&gt;<i> on HTTP or restrict to just HTTPS.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; Here is a useful link:
</I>&gt;<i> &gt; <A HREF="https://docs.microsoft.com/en-us/office365/troubleshoot/miscellaneous/chrome-behavior-affects-applications">https://docs.microsoft.com/en-us/office365/troubleshoot/miscellaneous/chrome-behavior-affects-applications</A>
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; I tested Chrome 85 on Windows - the default settings DO NOT allow for these
</I>&gt;<i> &gt; cookies.  However after setting
</I>&gt;<i> &gt; 	Cookies without SameSite must be secure
</I>&gt;<i> &gt; to Disabled, these cookies are permitted and OWA works.
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; There are obvious implications for sites doing SSL offloading here.  Are
</I>&gt;<i> &gt; sites no longer doing SSL offload?  Or are reverse proxies adding the Secure
</I>&gt;<i> &gt; flag?
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Neither. When a site frontend is entirely <A HREF="https://">https://</A> with no <A HREF="http://">http://</A> 
</I>&gt;<i> resources mixed in the Secure flag can be used by the server regardless 
</I>&gt;<i> of what the internal connections are.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Amos
</I>
My point is that, assuming browsers are now enforcing SameSite cookies must 
be secure, then doing SSL offload (whereby the origin server does NOT flag 
the cookie as secure) will break.

In this particular case, I use squid to do reverse proxy with SSL offload to 
a MS Exchange server.
Because the requests are HTTP IIS does not set the secure flag on cookies, 
and browsers now reject them.  This breaks things.

I've fixed it by switching back to HTTPS on the backend (no SSL offload), and 
so the secure flag is now being set by IIS.  Problem solved.

In the long term it seems doing SSL offload to MS Exchange (and Sharepoint I 
think) will not be an option.  I've seen other proxy manufacturers provide 
cookie manipulation; I assume for this kind of issue.

Do you think Squid should have such a feature?

Thanks

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="022887.html">[squid-users] Reverse proxying Exchange OWA wembail with SSL offloading
</A></li>
	<LI>Next message (by thread): <A HREF="022890.html">[squid-users] Reverse proxying Exchange OWA wembail with SSL offloading
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22889">[ date ]</a>
              <a href="thread.html#22889">[ thread ]</a>
              <a href="subject.html#22889">[ subject ]</a>
              <a href="author.html#22889">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
