<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Reverse proxying Exchange OWA wembail with SSL offloading
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Reverse%20proxying%20Exchange%20OWA%20wembail%20with%20SSL%0A%20offloading&In-Reply-To=%3C048c5f54-64ff-1c73-7c0b-b9ad235341f0%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="022889.html">
   <LINK REL="Next"  HREF="022891.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Reverse proxying Exchange OWA wembail with SSL offloading</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Reverse%20proxying%20Exchange%20OWA%20wembail%20with%20SSL%0A%20offloading&In-Reply-To=%3C048c5f54-64ff-1c73-7c0b-b9ad235341f0%40treenet.co.nz%3E"
       TITLE="[squid-users] Reverse proxying Exchange OWA wembail with SSL offloading">squid3 at treenet.co.nz
       </A><BR>
    <I>Fri Oct 30 11:49:16 UTC 2020</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="022889.html">[squid-users] Reverse proxying Exchange OWA wembail with SSL offloading
</A></li>
        <LI>Next message (by thread): <A HREF="022891.html">[squid-users] Reverse proxying Exchange OWA wembail with SSL offloading
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22890">[ date ]</a>
              <a href="thread.html#22890">[ thread ]</a>
              <a href="subject.html#22890">[ subject ]</a>
              <a href="author.html#22890">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 30/10/20 3:27 pm, Scott wrote:
&gt;<i> On Thu, Oct 29, 2020 at 10:08:42PM +1300, Amos Jeffries wrote:
</I>&gt;&gt;<i> On 29/10/20 12:06 pm, Scott wrote:
</I>&gt;&gt;&gt;<i> On Wed, Oct 28, 2020 at 12:00:01PM +0000, squid-users-reques wrote:
</I>&gt;&gt;&gt;&gt;<i> Date: Thu, 29 Oct 2020 00:08:34 +1300
</I>&gt;&gt;&gt;&gt;<i> From: Amos Jeffries
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> On 28/10/20 5:25 pm, Scott wrote:
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> Here are the logs (first not working, followed by working).
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> Note this is the login attempt, not the loading of the initial page.  You'll
</I>&gt;&gt;&gt;&gt;&gt;<i> see in the NOT WORKING section that the browser does NOT return a cookie to
</I>&gt;&gt;&gt;&gt;&gt;<i> the server, which is where the problem may be.  Again, I'm not sure why - I'm
</I>&gt;&gt;&gt;&gt;&gt;<i> thinking perhaps the browser/javascript is rejecting the cookie as it's
</I>&gt;&gt;&gt;&gt;&gt;<i> missing the &quot;secure&quot; attribute (because the back-end is talking plain HTTP).
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> The complete absence of a cookie may be expected to break something.
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> The absence of a &quot;secure&quot; flag should only make the cookie vulnerable to
</I>&gt;&gt;&gt;&gt;<i> leaking. It should not affect anything depending on that cookies value.
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> Amos
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> After some more research and experimentation I've confirmed that my
</I>&gt;&gt;&gt;<i> suspicions are correct.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Recent browsers are no longer accepting cookies with the SameSite flag set
</I>&gt;&gt;&gt;<i> without the Secure flag set.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> It's not an issue with Squid (although one Squid could solve - but I'm unsure
</I>&gt;&gt;&gt;<i> of the implications).
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Implications are that the server may have intentionally used the
</I>&gt;&gt;<i> combination it did, no mistakes.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The server is given &quot;Front-End-Https: On&quot; so that it is aware the client
</I>&gt;&gt;<i> is using HTTPS and can set (or not) the secure flag appropriately to
</I>&gt;&gt;<i> what it needs. Squid is not aware of whether the cookie is safe to use
</I>&gt;&gt;<i> on HTTP or restrict to just HTTPS.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Here is a useful link:
</I>&gt;&gt;&gt;<i> <A HREF="https://docs.microsoft.com/en-us/office365/troubleshoot/miscellaneous/chrome-behavior-affects-applications">https://docs.microsoft.com/en-us/office365/troubleshoot/miscellaneous/chrome-behavior-affects-applications</A>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> I tested Chrome 85 on Windows - the default settings DO NOT allow for these
</I>&gt;&gt;&gt;<i> cookies.  However after setting
</I>&gt;&gt;&gt;<i> 	Cookies without SameSite must be secure
</I>&gt;&gt;&gt;<i> to Disabled, these cookies are permitted and OWA works.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> There are obvious implications for sites doing SSL offloading here.  Are
</I>&gt;&gt;&gt;<i> sites no longer doing SSL offload?  Or are reverse proxies adding the Secure
</I>&gt;&gt;&gt;<i> flag?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Neither. When a site frontend is entirely <A HREF="https://">https://</A> with no <A HREF="http://">http://</A>
</I>&gt;&gt;<i> resources mixed in the Secure flag can be used by the server regardless
</I>&gt;&gt;<i> of what the internal connections are.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Amos
</I>&gt;<i> 
</I>&gt;<i> My point is that, assuming browsers are now enforcing SameSite cookies must
</I>&gt;<i> be secure, then doing SSL offload (whereby the origin server does NOT flag
</I>&gt;<i> the cookie as secure) will break.
</I>
But offloading does not mean the server omits the secure flag.

Servers which choose to send it when offloading work fine. Servers that 
choose to omit it have problems with the Google paranoid interpretation 
of security.


&gt;<i> 
</I>&gt;<i> In this particular case, I use squid to do reverse proxy with SSL offload to
</I>&gt;<i> a MS Exchange server.
</I>
You also have a TLS connection to the exchange:443 peer.

Notice that in the logs you showed transactions sent to that peer get 
the secure flag set, despite the SSL offload being done by Squid at the 
same time.



&gt;<i> Because the requests are HTTP IIS does not set the secure flag on cookies,
</I>&gt;<i> and browsers now reject them.  This breaks things.
</I>&gt;<i> 
</I>&gt;<i> I've fixed it by switching back to HTTPS on the backend (no SSL offload), and
</I>&gt;<i> so the secure flag is now being set by IIS.  Problem solved.
</I>&gt;<i> 
</I>&gt;<i> In the long term it seems doing SSL offload to MS Exchange (and Sharepoint I
</I>&gt;<i> think) will not be an option.  I've seen other proxy manufacturers provide
</I>&gt;<i> cookie manipulation; I assume for this kind of issue.
</I>&gt;<i> 
</I>&gt;<i> Do you think Squid should have such a feature?
</I>
We have ICAP, eCAP, and *_header_replace features already. So any 
proposed new feature would have to be better than what they already provide.


Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="022889.html">[squid-users] Reverse proxying Exchange OWA wembail with SSL offloading
</A></li>
	<LI>Next message (by thread): <A HREF="022891.html">[squid-users] Reverse proxying Exchange OWA wembail with SSL offloading
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22890">[ date ]</a>
              <a href="thread.html#22890">[ thread ]</a>
              <a href="subject.html#22890">[ subject ]</a>
              <a href="author.html#22890">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
