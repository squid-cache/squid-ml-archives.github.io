<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Reverse proxying Exchange OWA wembail with SSL offloading
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Reverse%20proxying%20Exchange%20OWA%20wembail%20with%20SSL%0A%20offloading&In-Reply-To=%3C49d903ca-8723-0a6a-fcd2-c6a892a36e21%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="022891.html">
   <LINK REL="Next"  HREF="022898.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Reverse proxying Exchange OWA wembail with SSL offloading</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Reverse%20proxying%20Exchange%20OWA%20wembail%20with%20SSL%0A%20offloading&In-Reply-To=%3C49d903ca-8723-0a6a-fcd2-c6a892a36e21%40treenet.co.nz%3E"
       TITLE="[squid-users] Reverse proxying Exchange OWA wembail with SSL offloading">squid3 at treenet.co.nz
       </A><BR>
    <I>Sat Oct 31 16:09:09 UTC 2020</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="022891.html">[squid-users] Reverse proxying Exchange OWA wembail with SSL offloading
</A></li>
        <LI>Next message (by thread): <A HREF="022898.html">[squid-users] Reverse proxying Exchange OWA wembail with SSL offloading
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22897">[ date ]</a>
              <a href="thread.html#22897">[ thread ]</a>
              <a href="subject.html#22897">[ subject ]</a>
              <a href="author.html#22897">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 31/10/20 3:20 am, Scott wrote:
&gt;<i> On Sat, Oct 31, 2020 at 12:49:16AM +1300, Amos Jeffries wrote:
</I>&gt;&gt;<i> On 30/10/20 3:27 pm, Scott wrote:
</I>&gt;&gt;&gt;<i> On Thu, Oct 29, 2020 at 10:08:42PM +1300, Amos Jeffries wrote:
</I>&gt;&gt;&gt;&gt;<i> On 29/10/20 12:06 pm, Scott wrote:
</I>&gt;&gt;&gt;&gt;&gt;<i> On Wed, Oct 28, 2020 at 12:00:01PM +0000, squid-users-reques wrote:
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> Date: Thu, 29 Oct 2020 00:08:34 +1300
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> From: Amos Jeffries
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> On 28/10/20 5:25 pm, Scott wrote:
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> Here are the logs (first not working, followed by working).
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> Note this is the login attempt, not the loading of the initial page.  You'll
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> see in the NOT WORKING section that the browser does NOT return a cookie to
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> the server, which is where the problem may be.  Again, I'm not sure why - I'm
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> thinking perhaps the browser/javascript is rejecting the cookie as it's
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> missing the &quot;secure&quot; attribute (because the back-end is talking plain HTTP).
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> The complete absence of a cookie may be expected to break something.
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> The absence of a &quot;secure&quot; flag should only make the cookie vulnerable to
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> leaking. It should not affect anything depending on that cookies value.
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> Amos
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> After some more research and experimentation I've confirmed that my
</I>&gt;&gt;&gt;&gt;&gt;<i> suspicions are correct.
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> Recent browsers are no longer accepting cookies with the SameSite flag set
</I>&gt;&gt;&gt;&gt;&gt;<i> without the Secure flag set.
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> It's not an issue with Squid (although one Squid could solve - but I'm unsure
</I>&gt;&gt;&gt;&gt;&gt;<i> of the implications).
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> Implications are that the server may have intentionally used the
</I>&gt;&gt;&gt;&gt;<i> combination it did, no mistakes.
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> The server is given &quot;Front-End-Https: On&quot; so that it is aware the client
</I>&gt;&gt;&gt;&gt;<i> is using HTTPS and can set (or not) the secure flag appropriately to
</I>&gt;&gt;&gt;&gt;<i> what it needs. Squid is not aware of whether the cookie is safe to use
</I>&gt;&gt;&gt;&gt;<i> on HTTP or restrict to just HTTPS.
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> Here is a useful link:
</I>&gt;&gt;&gt;&gt;&gt;<i> <A HREF="https://docs.microsoft.com/en-us/office365/troubleshoot/miscellaneous/chrome-behavior-affects-applications">https://docs.microsoft.com/en-us/office365/troubleshoot/miscellaneous/chrome-behavior-affects-applications</A>
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> I tested Chrome 85 on Windows - the default settings DO NOT allow for these
</I>&gt;&gt;&gt;&gt;&gt;<i> cookies.  However after setting
</I>&gt;&gt;&gt;&gt;&gt;<i> 	Cookies without SameSite must be secure
</I>&gt;&gt;&gt;&gt;&gt;<i> to Disabled, these cookies are permitted and OWA works.
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> There are obvious implications for sites doing SSL offloading here.  Are
</I>&gt;&gt;&gt;&gt;&gt;<i> sites no longer doing SSL offload?  Or are reverse proxies adding the Secure
</I>&gt;&gt;&gt;&gt;&gt;<i> flag?
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> Neither. When a site frontend is entirely <A HREF="https://">https://</A> with no <A HREF="http://">http://</A>
</I>&gt;&gt;&gt;&gt;<i> resources mixed in the Secure flag can be used by the server regardless
</I>&gt;&gt;&gt;&gt;<i> of what the internal connections are.
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> Amos
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> My point is that, assuming browsers are now enforcing SameSite cookies must
</I>&gt;&gt;&gt;<i> be secure, then doing SSL offload (whereby the origin server does NOT flag
</I>&gt;&gt;&gt;<i> the cookie as secure) will break.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> But offloading does not mean the server omits the secure flag.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Servers which choose to send it when offloading work fine. Servers that
</I>&gt;&gt;<i> choose to omit it have problems with the Google paranoid interpretation
</I>&gt;&gt;<i> of security.
</I>&gt;<i> 
</I>&gt;<i> Aren't origin servers oblivious to SSL offloading?  I thought they just
</I>&gt;<i> happily accepted HTTP connections with no knowledge of any secure channel
</I>&gt;<i> between client and reverse proxy.
</I>

It varies.  Mozilla have a brief writeup about the headers used:
&lt;<A HREF="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/X-Forwarded-Proto">https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/X-Forwarded-Proto</A>&gt;


&gt;<i> 
</I>&gt;<i> If that's correct then, although not proscribed by the RFC, it's unlikely
</I>&gt;<i> that a Set-Cookie header would ever contain a Secure flag because the server
</I>&gt;<i> would be saying &quot;I insist this Cookie be transmitted securely, but here it is
</I>&gt;<i> over an insecure channel&quot;.
</I>&gt;<i> 
</I>
That assumes the only type of security is HTTPS. The channel between 
proxy and server may be secured via other means than TLS, even as it 
transmits &quot;plain text&quot; HTTP.

There should be server settings to administrate that. I do not use OWA 
or IIS though, so now sure if they are available for your case.


&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> In this particular case, I use squid to do reverse proxy with SSL offload to
</I>&gt;&gt;&gt;<i> a MS Exchange server.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> You also have a TLS connection to the exchange:443 peer.
</I>&gt;<i> 
</I>&gt;<i> I have both for testing, but only one is active at any one time (as
</I>&gt;<i> referenced in a cache_peer_access).  Yes I now use the 443 peer because
</I>&gt;<i> Chrome/IE/Edge + SSL Offloading no longer works.
</I>&gt;<i> 
</I>
Please understand that with Squid acting as a reverse-proxy &quot;offloading&quot; 
is still happening. It is the cert you put in the https_port in 
Squid.conf that the clients are dealing with, and Squid which is doing 
any client cert validation.


For working security on the cache_peer you should identify the CA cert 
which signed the peer server's TLS certificate. Load that into Squid as 
cache_peer tls-cafile=  and you can drop the DONT_VERIFY_PEER flag.


&gt;&gt;<i>
</I>&gt;&gt;<i> Notice that in the logs you showed transactions sent to that peer get
</I>&gt;&gt;<i> the secure flag set, despite the SSL offload being done by Squid at the
</I>&gt;&gt;<i> same time.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;<i> 
</I>&gt;<i> Not true AFAICT.  Any cookies you see in those logs with Secure set are shown
</I>&gt;<i> under the &quot;WORKING&quot; heading whose entries are:
</I>&gt;<i> 2020/10/28 12:01:23.549 kid1| 11,2| http.cc(2263) sendRequest: HTTP Server local=squid-internal:62597 remote=exchange:443 FD 30 flags=1
</I>&gt;<i> 
</I>&gt;<i> No SSL offloading there.  Otherwise it would say &quot;remote=exchange:80&quot;
</I>&gt;<i> 
</I>
Squid is receiving the HTTP(S) message. That means Squid is terminating 
the TLS from client, decrypting the traffic. Which is offloading.

The connection to the server is independent. Squid will actually be 
multiplexing traffic for multiple clients on that connection. No client 
has participation or knowledge of that TLS existence.


A non-offloading setup would be a CONNECT tunnel through Squid to the 
server so TLS can be negotiated between client and server.




&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Because the requests are HTTP IIS does not set the secure flag on cookies,
</I>&gt;&gt;&gt;<i> and browsers now reject them.  This breaks things.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> I've fixed it by switching back to HTTPS on the backend (no SSL offload), and
</I>&gt;&gt;&gt;<i> so the secure flag is now being set by IIS.  Problem solved.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> In the long term it seems doing SSL offload to MS Exchange (and Sharepoint I
</I>&gt;&gt;&gt;<i> think) will not be an option.  I've seen other proxy manufacturers provide
</I>&gt;&gt;&gt;<i> cookie manipulation; I assume for this kind of issue.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Do you think Squid should have such a feature?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> We have ICAP, eCAP, and *_header_replace features already. So any
</I>&gt;&gt;<i> proposed new feature would have to be better than what they already provide.
</I>&gt;&gt;<i>
</I>&gt;<i> 
</I>&gt;<i> Unless I'm reading the online command reference incorrectly, *_header_replace
</I>&gt;<i> does not allow for the insertion of text so can't help here.  Please tell me
</I>&gt;<i> I'm wrong - I'd love for Squid to have this capability like other proxies.
</I>

Aye. There are limits and issues with all those features. I was speaking 
there about what a new feature proposal would need to work with for 
consideration.


The options right now are (in order of preference):

* create an eCAP module that just edits the headers as-needed.

* create an ICAP service to do header edits as-needed.

* create an external_acl_type helper that takes the reply headers as 
input and delivers Squid a set of annotations that can be injected as 
Set-Cookie headers by http_reply_header_add. With *header_access to 
remove broken values first.

* new feature in Squid.


Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="022891.html">[squid-users] Reverse proxying Exchange OWA wembail with SSL offloading
</A></li>
	<LI>Next message (by thread): <A HREF="022898.html">[squid-users] Reverse proxying Exchange OWA wembail with SSL offloading
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22897">[ date ]</a>
              <a href="thread.html#22897">[ thread ]</a>
              <a href="subject.html#22897">[ subject ]</a>
              <a href="author.html#22897">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
