<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Best practice for adding or removing ACLs dynamically ?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Best%20practice%20for%20adding%20or%20removing%20ACLs%0A%20dynamically%20%3F&In-Reply-To=%3CCAGCa14qSmFGD3%2BercC2JDEa3WKeLmU1d9scEgoWYWCUzztx7ww%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="022896.html">
   <LINK REL="Next"  HREF="022894.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Best practice for adding or removing ACLs dynamically ?</H1>
    <B>roee klinger</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Best%20practice%20for%20adding%20or%20removing%20ACLs%0A%20dynamically%20%3F&In-Reply-To=%3CCAGCa14qSmFGD3%2BercC2JDEa3WKeLmU1d9scEgoWYWCUzztx7ww%40mail.gmail.com%3E"
       TITLE="[squid-users] Best practice for adding or removing ACLs dynamically ?">roeeklinger60 at gmail.com
       </A><BR>
    <I>Sat Oct 31 23:27:06 UTC 2020</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="022896.html">[squid-users] Best practice for adding or removing ACLs dynamically ?
</A></li>
        <LI>Next message (by thread): <A HREF="022894.html">[squid-users] squid restart
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22899">[ date ]</a>
              <a href="thread.html#22899">[ thread ]</a>
              <a href="subject.html#22899">[ subject ]</a>
              <a href="author.html#22899">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Thanks Amos!

I updated &quot;auth_param basic credentialsttl&quot; according to your advice and it
is working great.

I am still having issues with the &quot;tcp_outgoing_address 192.168.8.12
acl_for_user3002&quot; part, you mentioned:
&gt;<i> For ACLs with values that are expected to change often it is best to use
</I>&gt;<i> an external_acl_type helper that manages the updates or fetches from
</I>&gt;<i> somewhere the updates are handled without a reload.
</I>
My script updates the authenticator successfully, but when I update &quot;acl
acl_for_user3002 proxy_auth user2&quot; to the new username I have to
reconfigure to take effect.
I read online for hours but to my best understanding external_acl_type are
for auth and access control, but they don't work for my needs I believe.

Is there any way to use external_acl_type in a way I don't understand to
solve this problem? Do I have to reconfigure every time I make changes to
an ACL in squid.conf?

Thanks again for your help.

On Sat, Oct 31, 2020 at 5:48 PM Amos Jeffries &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt; wrote:

&gt;<i> On 31/10/20 1:34 pm, roee klinger wrote:
</I>&gt;<i> &gt; &#65279;
</I>&gt;<i> &gt; Hey,
</I>&gt;<i> &gt; I have Squid configured to send users to different outgoing interface
</I>&gt;<i> like so:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; ..
</I>&gt;<i> &gt; auth_param basic program /usr/lib/squid/basic_ncsa_auth
</I>&gt;<i> /etc/squid/htpassword
</I>&gt;<i> &gt; acl acl_for_user3002 proxy_auth user2
</I>&gt;<i> &gt; tcp_outgoing_address 192.168.8.12 acl_for_user3002
</I>&gt;<i> &gt; http_port 3002 name=3002
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> No need to name a *_port like this. The default name is the first
</I>&gt;<i> parameter string (&quot;3002&quot; on this line).
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; http_access allow authenticated
</I>&gt;<i> &gt; ..
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; When I wanted to change the username:password for user2, I run a bash
</I>&gt;<i> script to change it in squid.conf and also in htpassword and then I run
</I>&gt;<i> &quot;squid -k reconfigure&quot;, if I don't reconfigure the old user still has
</I>&gt;<i> access to the proxy and the new one doesn't for about 30 minutes.
</I>&gt;<i> &gt;
</I>&gt;<i>
</I>&gt;<i> No need to restart for that change. The helper you have there will
</I>&gt;<i> automatically detect changes to the htpassword file and reload it.
</I>&gt;<i>
</I>&gt;<i> It is a little odd that the new user was not able to authenticate. Check
</I>&gt;<i> that your test did not lookup and cache a non-existence result for them
</I>&gt;<i> prior to being added.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> The delay is due to the credentials being valid for a period of time. To
</I>&gt;<i> reduce workload on the auth system Squid caches credential details for a
</I>&gt;<i> while.
</I>&gt;<i>
</I>&gt;<i> Set &quot;auth_param basic credentialsttl &quot; to shorter values to reduce the
</I>&gt;<i> delay (default is 2hrs).
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; I am expecting to have 100s of users soon that will change credentials
</I>&gt;<i> often, and also I would like to blacklist websites often and on the fly, so
</I>&gt;<i> I was searching for a better way to manage this without reconfiguring every
</I>&gt;<i> time, since sometimes a reconfigure can take up to 10-15 seconds.
</I>&gt;<i> &gt;
</I>&gt;<i>
</I>&gt;<i> This helper does not need a reconfigure at all as far as I can tell from
</I>&gt;<i> the code.
</I>&gt;<i>
</I>&gt;<i> All the reconfigure was doing for you previously was triggering an early
</I>&gt;<i> prune of the records in the credentials cache. Probably why you saw
</I>&gt;<i> about 30min delay instead of about 2hrs.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; I am new to Squid and wasn't able to find any info on this, am I doing
</I>&gt;<i> this currently or there is a better way to change users/ACLs on the fly
</I>&gt;<i> without reloading Squid?
</I>&gt;<i> &gt;
</I>&gt;<i>
</I>&gt;<i> Config changes in squid.conf itself needs a reconfigure or sometimes a
</I>&gt;<i> restart.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> For auth and ACLs whose values that come into Squid from a helper it
</I>&gt;<i> depends on the helper itself. Most can auto-detect changes to their
</I>&gt;<i> background databases and not need anything from Squid to update the
</I>&gt;<i> outputs. All helpers do have some form of caching of their results by
</I>&gt;<i> Squid, so there are settings in squid.conf to tune that to your needs -
</I>&gt;<i> as you can see from the auth issue above.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> For ACLs with values that are expected to change often it is best to use
</I>&gt;<i> an external_acl_type helper that manages the updates or fetches from
</I>&gt;<i> somewhere the updates are handled without a reload.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Amos
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20201101/3a8c242e/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20201101/3a8c242e/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="022896.html">[squid-users] Best practice for adding or removing ACLs dynamically ?
</A></li>
	<LI>Next message (by thread): <A HREF="022894.html">[squid-users] squid restart
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22899">[ date ]</a>
              <a href="thread.html#22899">[ thread ]</a>
              <a href="subject.html#22899">[ subject ]</a>
              <a href="author.html#22899">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
