<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] squid.service with Type=Notify is not always reliable (Arch Linux)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid.service%20with%20Type%3DNotify%20is%20not%20always%0A%20reliable%20%28Arch%20Linux%29&In-Reply-To=%3C83425264-67f7-6337-d8b9-70c83a2b8bbf%40gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="022661.html">
   <LINK REL="Next"  HREF="022665.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] squid.service with Type=Notify is not always reliable (Arch Linux)</H1>
    <B>Amish</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid.service%20with%20Type%3DNotify%20is%20not%20always%0A%20reliable%20%28Arch%20Linux%29&In-Reply-To=%3C83425264-67f7-6337-d8b9-70c83a2b8bbf%40gmail.com%3E"
       TITLE="[squid-users] squid.service with Type=Notify is not always reliable (Arch Linux)">anon.amish at gmail.com
       </A><BR>
    <I>Wed Sep  2 07:01:20 UTC 2020</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="022661.html">[squid-users] squid.service with Type=Notify is not always reliable (Arch Linux)
</A></li>
        <LI>Next message (by thread): <A HREF="022665.html">[squid-users] squid.service with Type=Notify is not always reliable (Arch Linux)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22664">[ date ]</a>
              <a href="thread.html#22664">[ thread ]</a>
              <a href="subject.html#22664">[ subject ]</a>
              <a href="author.html#22664">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
On 01/09/20 8:31 pm, Alex Rousskov wrote:
&gt;<i> On 9/1/20 10:27 AM, Amish wrote:
</I>&gt;<i>
</I>&gt;&gt;<i> Accepting ... connections at ...&#160; message came almost immediately (in 1
</I>&gt;&gt;<i> second).
</I>&gt;&gt;<i> Sep 01 06:40:05 foo squid[8446]: Accepting SSL bumped HTTP Socket
</I>&gt;&gt;<i> connections at local=[::]:3128 remote=[::] FD 27 flags=9
</I>&gt;<i> OK, so you are not using SMP Squid and, assuming your Squid build
</I>&gt;<i> supports calling sd_notify(), sd_notify() was called. We need to figure
</I>&gt;<i> out why it had no effect. Suggested next steps:
</I>&gt;<i>
</I>&gt;<i> 1. Adjust Squid to print the value of $NOTIFY_SOCKET together with the
</I>&gt;<i> &quot;Accepting...&quot; line. This will confirm that the variable is set. It
</I>&gt;<i> should be set. This debugging can be added without fear of producing too
</I>&gt;<i> much info but it is unlikely to be insightful.
</I>&gt;<i>
</I>&gt;<i> 2. Add some kind of sd_notify() debugging that would show us what the
</I>&gt;<i> first sd_notify() call was doing and when/whether systemd received the
</I>&gt;<i> notification from Squid. I have not researched how to do that, but I am
</I>&gt;<i> sure it is possible. I bet there are not enough notifications happening
</I>&gt;<i> on your production server to cause problems, but you should practice on
</I>&gt;<i> a lab server first, of course.
</I>
Ok. I will try above. But here is a note from &quot;man sd_notify&quot; about race 
condition that MAY occur.

Conversely, if an auxiliary process of the unit sends an sd_notify() 
message and immediately exits, the service manager might not be able to 
properly attribute the message to the unit, and thus will ignore it, 
even if NotifyAccess=all is set for it.

Hence, to eliminate all race conditions involving lookup of the client's 
unit and attribution of notifications to units correctly, 
sd_notify_barrier() may be used. This call acts as a synchronization 
point and ensures all notifications sent before this call have been 
picked up by the service manager when it returns successfully. Use of 
sd_notify_barrier() is needed for clients which are not invoked by the 
service manager, otherwise this synchronization mechanism is unnecessary 
for attribution of notifications to the unit.

Example 5. Eliminating race conditions

When the client sending the notifications is not spawned by the service 
manager, it may exit too quickly and the service manager may fail to 
attribute them correctly to the unit. To prevent such races, use 
sd_notify_barrier() to synchronize against reception of all 
notifications sent before this call is made.

 &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; sd_notify(0, &quot;READY=1&quot;);
 &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; /* set timeout to 5 seconds */
 &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; sd_notify_barrier(0, 5 * 1000000);


I am not sure if this is related. I have no clue about sd_notify(). But 
can it be the reason?

Amish


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="022661.html">[squid-users] squid.service with Type=Notify is not always reliable (Arch Linux)
</A></li>
	<LI>Next message (by thread): <A HREF="022665.html">[squid-users] squid.service with Type=Notify is not always reliable (Arch Linux)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22664">[ date ]</a>
              <a href="thread.html#22664">[ thread ]</a>
              <a href="subject.html#22664">[ subject ]</a>
              <a href="author.html#22664">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
