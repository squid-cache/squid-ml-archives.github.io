<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] squid.service with Type=Notify is not always reliable (Arch Linux)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid.service%20with%20Type%3DNotify%20is%20not%20always%0A%20reliable%20%28Arch%20Linux%29&In-Reply-To=%3C5899cdab-bce9-6b95-4551-8d3c023bf019%40gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="022666.html">
   <LINK REL="Next"  HREF="022662.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] squid.service with Type=Notify is not always reliable (Arch Linux)</H1>
    <B>Amish</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid.service%20with%20Type%3DNotify%20is%20not%20always%0A%20reliable%20%28Arch%20Linux%29&In-Reply-To=%3C5899cdab-bce9-6b95-4551-8d3c023bf019%40gmail.com%3E"
       TITLE="[squid-users] squid.service with Type=Notify is not always reliable (Arch Linux)">anon.amish at gmail.com
       </A><BR>
    <I>Thu Sep  3 00:38:19 UTC 2020</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="022666.html">[squid-users] squid.service with Type=Notify is not always reliable (Arch Linux)
</A></li>
        <LI>Next message (by thread): <A HREF="022662.html">[squid-users] limit bandwidth
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22668">[ date ]</a>
              <a href="thread.html#22668">[ thread ]</a>
              <a href="subject.html#22668">[ subject ]</a>
              <a href="author.html#22668">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
On 02/09/20 8:05 pm, Amos Jeffries wrote:
&gt;<i> On 2/09/20 7:01 pm, Amish wrote:
</I>&gt;&gt;<i> On 01/09/20 8:31 pm, Alex Rousskov wrote:
</I>&gt;&gt;&gt;<i> On 9/1/20 10:27 AM, Amish wrote:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> Accepting ... connections at ...&#160; message came almost immediately (in 1
</I>&gt;&gt;&gt;&gt;<i> second).
</I>&gt;&gt;&gt;&gt;<i> Sep 01 06:40:05 foo squid[8446]: Accepting SSL bumped HTTP Socket
</I>&gt;&gt;&gt;&gt;<i> connections at local=[::]:3128 remote=[::] FD 27 flags=9
</I>&gt;&gt;&gt;<i> OK, so you are not using SMP Squid and, assuming your Squid build
</I>&gt;&gt;&gt;<i> supports calling sd_notify(), sd_notify() was called. We need to figure
</I>&gt;&gt;&gt;<i> out why it had no effect. Suggested next steps:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> 1. Adjust Squid to print the value of $NOTIFY_SOCKET together with the
</I>&gt;&gt;&gt;<i> &quot;Accepting...&quot; line. This will confirm that the variable is set. It
</I>&gt;&gt;&gt;<i> should be set. This debugging can be added without fear of producing too
</I>&gt;&gt;&gt;<i> much info but it is unlikely to be insightful.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> 2. Add some kind of sd_notify() debugging that would show us what the
</I>&gt;&gt;&gt;<i> first sd_notify() call was doing and when/whether systemd received the
</I>&gt;&gt;&gt;<i> notification from Squid. I have not researched how to do that, but I am
</I>&gt;&gt;&gt;<i> sure it is possible. I bet there are not enough notifications happening
</I>&gt;&gt;&gt;<i> on your production server to cause problems, but you should practice on
</I>&gt;&gt;&gt;<i> a lab server first, of course.
</I>&gt;&gt;<i> Ok. I will try above. But here is a note from &quot;man sd_notify&quot; about race
</I>&gt;&gt;<i> condition that MAY occur.
</I>&gt;<i> You are guessing now. Please don't do that until every possible check
</I>&gt;<i> has been done and narrowed the vast range of possibilities down.
</I>&gt;<i>
</I>&gt;<i> The purpose of the checks suggested by Alex was to identify whether a
</I>&gt;<i> race is occuring or not.
</I>
For initial testing, I had already added debug message for step 1. And I 
tried replicate the problem at my end.

But I simply could not replicate the problem at my end. Debug output was 
on expected lines. (on my own machine)

Sep 03 05:11:54 amish squid[1086]: Accepting NAT intercepted HTTP Socket 
connections at local=[::]:3128 remote=[::] FD 33 flags=41
Sep 03 05:11:54 amish squid[1086]: NOTIFY_SOCKET before sd_notify() is 
/run/systemd/notify
Sep 03 05:11:54 amish systemd[1]: Started Squid Web Proxy Server.
Sep 03 05:11:54 amish squid[1086]: NOTIFY_SOCKET after sd_notify() is
Sep 03 05:11:54 amish squid[1086]: Accepting SSL bumped HTTP Socket 
connections at local=[::]:8080 remote=[::] FD 34 flags=9
Sep 03 05:11:54 amish squid[1086]: NOTIFY_SOCKET before sd_notify() is
Sep 03 05:11:54 amish squid[1086]: NOTIFY_SOCKET after sd_notify() is
Sep 03 05:11:54 amish squid[1086]: Accepting NAT intercepted SSL bumped 
HTTPS Socket connections at local=[::]:8081 remote=[::] FD 35 flags=41
Sep 03 05:11:54 amish squid[1086]: NOTIFY_SOCKET before sd_notify() is
Sep 03 05:11:54 amish squid[1086]: NOTIFY_SOCKET after sd_notify() is

For step 2, I first need to read systemd documentation about sd_notify() 
and thats when I came across mention of above race condition.

Race conditions are not easy to reproduce. That's when you look at the 
code and guess where the race can be, if there can be a race. Since 
sd_notify() documentation kind of insists on using sd_notify_barrier() 
and that does not exist in squid code. I thought that could be missing 
piece.

What is strange is I had observed that when there was this issue, no 
matter how many times I restart the squid, the problem came every single 
time. And then changing Type=forking worked. May be there is no race. 
But something else?

But now based on your and Alex replies, I will go ahead and find a way 
to add more debug to code for tracking systemd and squid notify 
communication. And then hope that issue occurs in my system.

Now I will post back about this, if at all I can do something and find 
something. :)

Thank you to both and regards,

Amish.


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="022666.html">[squid-users] squid.service with Type=Notify is not always reliable (Arch Linux)
</A></li>
	<LI>Next message (by thread): <A HREF="022662.html">[squid-users] limit bandwidth
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22668">[ date ]</a>
              <a href="thread.html#22668">[ thread ]</a>
              <a href="subject.html#22668">[ subject ]</a>
              <a href="author.html#22668">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
