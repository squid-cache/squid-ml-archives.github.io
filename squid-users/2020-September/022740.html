<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] squid 5.0.4 cache_peer bug on https outgoing
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid%205.0.4%20cache_peer%20bug%20on%20https%20outgoing&In-Reply-To=%3CCAL4_ukdQMq9Z22-%3DUvk_0gn9qnfqPShLzhnzo9O1EnCLnm58nA%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="022739.html">
   <LINK REL="Next"  HREF="022742.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] squid 5.0.4 cache_peer bug on https outgoing</H1>
    <B>openwrt</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid%205.0.4%20cache_peer%20bug%20on%20https%20outgoing&In-Reply-To=%3CCAL4_ukdQMq9Z22-%3DUvk_0gn9qnfqPShLzhnzo9O1EnCLnm58nA%40mail.gmail.com%3E"
       TITLE="[squid-users] squid 5.0.4 cache_peer bug on https outgoing">openwrt.jp at gmail.com
       </A><BR>
    <I>Mon Sep 28 09:39:51 UTC 2020</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="022739.html">[squid-users] squid 5.0.4 cache_peer bug on https outgoing
</A></li>
        <LI>Next message (by thread): <A HREF="022742.html">[squid-users] squid 5.0.4 cache_peer bug on https outgoing
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22740">[ date ]</a>
              <a href="thread.html#22740">[ thread ]</a>
              <a href="subject.html#22740">[ subject ]</a>
              <a href="author.html#22740">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I located the bug and found a another way to deal with it.

The bug is that cache_peer https CONNECT drops the port number

If you do the compatibility treatment on the back of the agent software,
you can solve this problem

However, it would be best if it was resolved on squid.

### 0x01 wireshare packet

1) squid cache_peer https CONNECT packet.

CONNECT d.qqq.win  HTTP/1.1 (bad format: without port)

0040   d1 d8 43 4f 4e 4e 45 43 54 20 64 2e 71 71 71 2e   ..CONNECT d.qqq.

0050   77 69 6e 20 48 54 54 50 2f 31 2e 31 0d 0a 55 73   win HTTP/1.1

2) glider verbose log

2020/09/28 17:19:58 forward.go:118: [forwarder] DIRECT recorded 1 failures,
maxfailures: 0

2020/09/28 17:19:58 server.go:98: [http] *.*.*.*:53848 &lt;-&gt; d.qqq.win [c]
via DIRECT, error in dial: dial tcp: address d.qqq.win: missing port in
address

### 0x02 solution

Locate the cache_peer code in squid and add the missing port to the
CONNETCT function.

or, you can do the compatibility treatment on the background proxy soft
(bad idea)



openwrt &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">openwrt.jp at gmail.com</A>&gt; &#20110;2020&#24180;9&#26376;28&#26085;&#21608;&#19968; &#19979;&#21320;1:41&#20889;&#36947;&#65306;

&gt;<i> Yes, I've tried all of these combinations.
</I>&gt;<i>
</I>&gt;<i> ### 0x00 cache_peer no ssl
</I>&gt;<i>
</I>&gt;<i> &gt; ssl_bump allow all
</I>&gt;<i> &gt; cache_peer 127.0.0.1 parent 3129 0 &#12304;no ssl&#12305;
</I>&gt;<i>
</I>&gt;<i> curl <A HREF="http://google.com">http://google.com</A> &lt;<A HREF="https://google.com/">https://google.com/</A>&gt; -x
</I>&gt;<i> <A HREF="http://admin:squid@localhost:3128">http://admin:squid@localhost:3128</A> -v  -k   &#12304;it is ok&#12305;
</I>&gt;<i>
</I>&gt;<i> curl <A HREF="https://google.com">https://google.com</A> -x <A HREF="https://admin:squid@localhost:3128">https://admin:squid@localhost:3128</A> -v  -k
</I>&gt;<i>  &#12304;Get 502&#12305;
</I>&gt;<i> curl <A HREF="https://google.com">https://google.com</A> -x <A HREF="http://admin:squid@localhost:3128">http://admin:squid@localhost:3128</A> -v  -k
</I>&gt;<i>  &#12304;Get 502&#12305;
</I>&gt;<i>
</I>&gt;<i> &lt; HTTP/1.1 502 Bad Gateway
</I>&gt;<i> &lt; X-Cache: MISS from example.com
</I>&gt;<i> &lt; Transfer-Encoding: chunked
</I>&gt;<i> &lt; Connection: keep-alive
</I>&gt;<i>
</I>&gt;<i> log json:
</I>&gt;<i>
</I>&gt;<i> { &quot;clientip&quot;: &quot;127.0.0.1&quot;, &quot;ident&quot;: &quot;-&quot;, &quot;uname&quot;: &quot;admin&quot;, &quot;timestamp&quot;:
</I>&gt;<i> &quot;2020-09-28T04:16:28+0000&quot;, &quot;verb&quot;: &quot;CONNECT&quot;, &quot;request&quot;: &quot;google.com:443&quot;,
</I>&gt;<i> &quot;httpversion&quot;: &quot;HTTP/1.1&quot;, &quot;response&quot;: 200, &quot;bytes&quot;: 0, &quot;referer&quot;: &quot;-&quot;,
</I>&gt;<i> &quot;agent&quot;: &quot;curl/7.47.0&quot;, &quot;request_status&quot;: &quot;HIER_NONE&quot;, &quot;hierarchy_status&quot;:
</I>&gt;<i> &quot;HIER_NONE&quot; }
</I>&gt;<i>
</I>&gt;<i> { &quot;clientip&quot;: &quot;127.0.0.1&quot;, &quot;ident&quot;: &quot;-&quot;, &quot;uname&quot;: &quot;admin&quot;, &quot;timestamp&quot;:
</I>&gt;<i> &quot;2020-09-28T04:16:28+0000&quot;, &quot;verb&quot;: &quot;GET&quot;, &quot;request&quot;: &quot;<A HREF="https://google.com/">https://google.com/</A>
</I>&gt;<i> &quot;, &quot;httpversion&quot;: &quot;HTTP/1.1&quot;, &quot;response&quot;: 502, &quot;bytes&quot;: 117, &quot;referer&quot;:
</I>&gt;<i> &quot;-&quot;, &quot;agent&quot;: &quot;curl/7.47.0&quot;, &quot;request_status&quot;: &quot;HIER_NONE&quot;,
</I>&gt;<i> &quot;hierarchy_status&quot;: &quot;HIER_NONE&quot; }
</I>&gt;<i>
</I>&gt;<i> ### 0x01 cache_peer with ssl
</I>&gt;<i>
</I>&gt;<i> &gt; ssl_bump allow all
</I>&gt;<i> &gt; cache_peer 127.0.0.1 parent 3129 0  ssk
</I>&gt;<i>
</I>&gt;<i> curl <A HREF="http://google.com">http://google.com</A> &lt;<A HREF="https://google.com/">https://google.com/</A>&gt; -x
</I>&gt;<i> <A HREF="http://admin:squid@localhost:3128">http://admin:squid@localhost:3128</A> -v  -k   &#12304;Get 502&#12305;
</I>&gt;<i> curl <A HREF="https://google.com">https://google.com</A> -x <A HREF="https://admin:squid@localhost:3128">https://admin:squid@localhost:3128</A> -v  -k
</I>&gt;<i>  &#12304;Get 502&#12305;
</I>&gt;<i>
</I>&gt;<i> &lt; HTTP/1.1 503 Service Unavailable
</I>&gt;<i>
</I>&gt;<i> &lt; Server: squid/5.0.4
</I>&gt;<i>
</I>&gt;<i> &lt; Mime-Version: 1.0
</I>&gt;<i>
</I>&gt;<i> &lt; Date: Mon, 28 Sep 2020 04:21:00 GMT
</I>&gt;<i>
</I>&gt;<i> &lt; Content-Type: text/html;charset=utf-8
</I>&gt;<i>
</I>&gt;<i> &lt; Content-Length: 1649
</I>&gt;<i>
</I>&gt;<i> &lt; X-Squid-Error: ERR_SECURE_CONNECT_FAIL 71
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &lt;p&gt;The system returned:&lt;/p&gt;
</I>&gt;<i>
</I>&gt;<i> &lt;blockquote id=&quot;data&quot;&gt;
</I>&gt;<i>
</I>&gt;<i> &lt;pre&gt;(71) Protocol error (TLS code: SQUID_ERR_SSL_HANDSHAKE)&lt;/pre&gt;
</I>&gt;<i>
</I>&gt;<i> &lt;p&gt;Handshake with SSL server failed: [No Error]&lt;/p&gt;
</I>&gt;<i>
</I>&gt;<i> &lt;/blockquote&gt;
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> ### 0x02 how to outgoing https request by cache_peer (on squid
</I>&gt;<i> 5.0.4/Chains proxy)
</I>&gt;<i>
</I>&gt;<i> Similar features to Charles OR Fiddler. ( open http(s) proxy  on 8080,
</I>&gt;<i> then capture the request , outgoing on another http(s)/socks4/5 proxy.)
</I>&gt;<i>
</I>&gt;<i> 1. Fiddler gateway:
</I>&gt;<i> <A HREF="https://docs.telerik.com/fiddler-everywhere/user-guide/settings/gateway">https://docs.telerik.com/fiddler-everywhere/user-guide/settings/gateway</A>
</I>&gt;<i>
</I>&gt;<i> curl <A HREF="https://google.com">https://google.com</A> -x <A HREF="http://squid:3128">http://squid:3128</A> --&gt; outgoing(cache_peer:
</I>&gt;<i> like Fiddler gateway) --&gt; google.com:443
</I>&gt;<i>
</I>&gt;<i> The cache_peer should be ignore ssl VERIFY. !!! like other software.
</I>&gt;<i>
</I>&gt;<i> On squid 5.0.4, http is ok, https will get ERR_SECURE_CONNECT_FAIL error.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Alex Rousskov &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt; &#20110;2020&#24180;9&#26376;28&#26085;&#21608;&#19968; &#19978;&#21320;6:48&#20889;&#36947;&#65306;
</I>&gt;<i>
</I>&gt;&gt;<i> On 9/27/20 12:07 PM, sec wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &gt; http_port 3128 ssl-bump ...
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &gt; curl <A HREF="http://google.com">http://google.com</A> -x <A HREF="https://admin:squid@localhost:3128">https://admin:squid@localhost:3128</A> -v  -k
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The above two lines do not match AFAICT: You tell curl to use an HTTPS
</I>&gt;&gt;<i> proxy, but you tell Squid to expect plain HTTP proxy requests.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Also, please note that if you fix the above problem by moving &quot;https&quot;
</I>&gt;&gt;<i> from &quot;-x&quot; to the origin server URL, then you will probably face another
</I>&gt;&gt;<i> problem:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> curl <A HREF="https://google.com">https://google.com</A> -x <A HREF="http://admin:squid@localhost:3128">http://admin:squid@localhost:3128</A> -v  -k
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &gt; ssl_bump allow all
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &gt; cache_peer 127.0.0.1 parent 3129 0 ssl
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Squid does not (yet) support &quot;TLS inside TLS&quot;: Talking TLS with the
</I>&gt;&gt;<i> origin server through a cache_peer that also expects a TLS connection.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> HTH,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Alex.
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20200928/788fbfbf/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20200928/788fbfbf/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="022739.html">[squid-users] squid 5.0.4 cache_peer bug on https outgoing
</A></li>
	<LI>Next message (by thread): <A HREF="022742.html">[squid-users] squid 5.0.4 cache_peer bug on https outgoing
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22740">[ date ]</a>
              <a href="thread.html#22740">[ thread ]</a>
              <a href="subject.html#22740">[ subject ]</a>
              <a href="author.html#22740">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
