<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] squid 5.0.4 cache_peer bug on https outgoing
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid%205.0.4%20cache_peer%20bug%20on%20https%20outgoing&In-Reply-To=%3Cea659439-020a-1ce7-835a-2c9177e3831e%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="022746.html">
   <LINK REL="Next"  HREF="022743.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] squid 5.0.4 cache_peer bug on https outgoing</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid%205.0.4%20cache_peer%20bug%20on%20https%20outgoing&In-Reply-To=%3Cea659439-020a-1ce7-835a-2c9177e3831e%40treenet.co.nz%3E"
       TITLE="[squid-users] squid 5.0.4 cache_peer bug on https outgoing">squid3 at treenet.co.nz
       </A><BR>
    <I>Mon Sep 28 10:14:54 UTC 2020</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="022746.html">[squid-users] squid 5.0.4 cache_peer bug on https outgoing
</A></li>
        <LI>Next message (by thread): <A HREF="022743.html">[squid-users] measuring latency of squid in different scenarios
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22741">[ date ]</a>
              <a href="thread.html#22741">[ thread ]</a>
              <a href="subject.html#22741">[ subject ]</a>
              <a href="author.html#22741">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 28/09/20 6:41 pm, openwrt wrote:
&gt;<i> Yes, I've tried all of these combinations.
</I>&gt;<i> 
</I>&gt;<i> ### 0x00&#160;cache_peer no ssl
</I>&gt;<i> 
</I>&gt;&gt;<i> ssl_bump allow all
</I>
&quot;allow&quot; is not a SSL-Bump action type for any version of Squid.
&lt;<A HREF="https://wiki.squid-cache.org/Features/SslPeekAndSplice#Actions">https://wiki.squid-cache.org/Features/SslPeekAndSplice#Actions</A>&gt;

AFAIK, SSL-Bump falls back to default &quot;bump all&quot; as the action performed.


&gt;&gt;<i> cache_peer&#160;127.0.0.1 parent&#160;3129&#160;0 &#12304;no ssl&#12305;
</I>&gt;<i> 
</I>&gt;<i> curl&#160;<A HREF="http://google.com">http://google.com</A> &lt;<A HREF="https://google.com/">https://google.com/</A>&gt;&#160;-x
</I>&gt;<i> <A HREF="http://admin:squid@localhost:3128">http://admin:squid@localhost:3128</A> -v&#160; -k&#160; &#160;&#12304;it is ok&#12305;
</I>&gt;<i> 
</I>
This does HTTP(-over-TCP) to Squid asking for HTTP to origin. A
non-TLS/SSL peer is perfectly capable of fetching that.


&gt;<i> curl&#160;<A HREF="https://google.com">https://google.com</A> &lt;<A HREF="https://google.com/">https://google.com/</A>&gt;&#160;-x
</I>&gt;<i> <A HREF="https://admin:squid@localhost:3128">https://admin:squid@localhost:3128</A> -v&#160; -k&#160; &#160;&#12304;Get 502&#12305;
</I>
This does HTTP(-over-TL)S to Squid which told to accept HTTP(-over-TCP).
Expect 502 generated by the frontend Squid.


&gt;<i> curl&#160;<A HREF="https://google.com">https://google.com</A> &lt;<A HREF="https://google.com/">https://google.com/</A>&gt;&#160;-x
</I>&gt;<i> <A HREF="http://admin:squid@localhost:3128">http://admin:squid@localhost:3128</A> -v&#160; -k&#160; &#160; &#160;&#12304;Get 502&#12305;
</I>&gt;<i> 
</I>
This does HTTP(-over-TCP) to Squid asking for CONNECT tunnel
containing HTTP-over-TLS to origin.

Expect that the tunnel be accepted fro decryption by the frontend Squid
(200 status), then another CONNECT tunnel generated to fetch the
decrypted traffic via the insecure peer.


&gt;<i> 
</I>&gt;<i> log json:
</I>&gt;<i> 
</I>&gt;<i> { &quot;clientip&quot;: &quot;127.0.0.1&quot;, &quot;ident&quot;: &quot;-&quot;, &quot;uname&quot;: &quot;admin&quot;, &quot;timestamp&quot;:
</I>&gt;<i> &quot;2020-09-28T04:16:28+0000&quot;, &quot;verb&quot;: &quot;CONNECT&quot;, &quot;request&quot;:
</I>&gt;<i> &quot;google.com:443 &lt;<A HREF="http://google.com:443">http://google.com:443</A>&gt;&quot;, &quot;httpversion&quot;: &quot;HTTP/1.1&quot;,
</I>&gt;<i> &quot;response&quot;: 200, &quot;bytes&quot;: 0, &quot;referer&quot;: &quot;-&quot;, &quot;agent&quot;: &quot;curl/7.47.0&quot;,
</I>&gt;<i> &quot;request_status&quot;: &quot;HIER_NONE&quot;, &quot;hierarchy_status&quot;: &quot;HIER_NONE&quot;}
</I>&gt;<i> 
</I>
CONNECT tunnel received and decrypted. This says that you actually
received a 200 status to at least one of your tests. I expect it was for
that third one.


&gt;<i> { &quot;clientip&quot;: &quot;127.0.0.1&quot;, &quot;ident&quot;: &quot;-&quot;, &quot;uname&quot;: &quot;admin&quot;, &quot;timestamp&quot;:
</I>&gt;<i> &quot;2020-09-28T04:16:28+0000&quot;, &quot;verb&quot;: &quot;GET&quot;, &quot;request&quot;:
</I>&gt;<i> &quot;<A HREF="https://google.com/">https://google.com/</A>&quot;, &quot;httpversion&quot;: &quot;HTTP/1.1&quot;, &quot;response&quot;: 502,
</I>&gt;<i> &quot;bytes&quot;: 117, &quot;referer&quot;: &quot;-&quot;, &quot;agent&quot;: &quot;curl/7.47.0&quot;, &quot;request_status&quot;:
</I>&gt;<i> &quot;HIER_NONE&quot;, &quot;hierarchy_status&quot;: &quot;HIER_NONE&quot;}
</I>&gt;<i> 
</I>
Decrypted request was not able to be sent anywhere. This is your main
problem - made worse by the ssl_bump misconfiguration. The 502 message
contains a brief description about what went wrong. cache.log may
contain more details - if not, increase the verbosity for
troubleshooting with &quot;debug_options ALL,2 83,7&quot;


&gt;<i> 
</I>&gt;<i> ### 0x01&#160;cache_peer with ssl
</I>&gt;<i> 
</I>&gt;&gt;<i> ssl_bump allow all
</I>&gt;&gt;<i> cache_peer&#160;127.0.0.1 parent&#160;3129&#160;0&#160; ssk
</I>&gt;<i> 
</I>&gt;<i> curl&#160;<A HREF="http://google.com">http://google.com</A> &lt;<A HREF="https://google.com/">https://google.com/</A>&gt;&#160;-x
</I>&gt;<i> <A HREF="http://admin:squid@localhost:3128">http://admin:squid@localhost:3128</A> -v&#160; -k&#160; &#160;&#12304;Get 502&#12305;
</I>&gt;<i> curl&#160;<A HREF="https://google.com">https://google.com</A> &lt;<A HREF="https://google.com/">https://google.com/</A>&gt;&#160;-x
</I>&gt;<i> <A HREF="https://admin:squid@localhost:3128">https://admin:squid@localhost:3128</A> -v&#160; -k&#160; &#160;&#12304;Get 502&#12305;
</I>&gt;<i> 
</I>&gt;<i> &lt; HTTP/1.1 503 Service Unavailable
</I>&gt;<i> 
</I>
This is 503, not the 502 you mention above.

 * Which of the two different test commands produced it?

 * It says that there is a TLS protocol syntax problem talking TLS/SSL
to the server or peer.

&gt;<i> 
</I>&gt;<i> &lt; X-Squid-Error: ERR_SECURE_CONNECT_FAIL 71
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> &lt;p&gt;The system returned:&lt;/p&gt;
</I>&gt;<i> 
</I>&gt;<i> &lt;blockquote id=&quot;data&quot;&gt;
</I>&gt;<i> 
</I>&gt;<i> &lt;pre&gt;(71) Protocol error (TLS code: SQUID_ERR_SSL_HANDSHAKE)&lt;/pre&gt;
</I>&gt;<i> 
</I>&gt;<i> &lt;p&gt;Handshake with SSL server failed: [No Error]&lt;/p&gt;
</I>&gt;<i> 
</I>&gt;<i> &lt;/blockquote&gt;
</I>&gt;<i> 
</I>

&gt;<i> 
</I>&gt;<i> ### 0x02 how to outgoing https request by&#160;cache_peer (on squid
</I>&gt;<i> 5.0.4/Chains proxy)
</I>&gt;<i> 
</I>&gt;<i> Similar features to Charles OR&#160;Fiddler. ( open http(s) proxy&#160; on 8080,
</I>&gt;<i> then capture the request , outgoing on another http(s)/socks4/5 proxy.)
</I>&gt;<i> 
</I>&gt;<i> 1.&#160;Fiddler
</I>&gt;<i> gateway:&#160;<A HREF="https://docs.telerik.com/fiddler-everywhere/user-guide/settings/gateway">https://docs.telerik.com/fiddler-everywhere/user-guide/settings/gateway</A>
</I>&gt;<i> 
</I>&gt;<i> curl <A HREF="https://google.com">https://google.com</A> -x <A HREF="http://squid:3128">http://squid:3128</A> --&gt; outgoing(cache_peer:
</I>&gt;<i> like Fiddler gateway) --&gt; google.com:443 &lt;<A HREF="http://google.com:443">http://google.com:443</A>&gt;
</I>&gt;<i> 
</I>&gt;<i> The&#160;cache_peer should be ignore ssl&#160;VERIFY. !!! like other software.
</I>&gt;<i> 
</I>
No. There is no use using TLS if you are going to disable *all* the
security.

What Squid should actually happen is that you configure Squid to know
what CA signed the peer SSL certificate (with cache_peer tls-cafile=
option). So that connections properly going to that peer will verify
successfully. The default you have with just the &quot;ssl &quot;flag (FYI: that
should be &quot;tls&quot; nowdays) uses the operating systems default Global
Trusted CA's to verify.

Allowing interception attacks and transfer corruption on the peer
traffic to be identified if/when any happen is the entire purpose of
using TLS/SSL on peer connections.


Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="022746.html">[squid-users] squid 5.0.4 cache_peer bug on https outgoing
</A></li>
	<LI>Next message (by thread): <A HREF="022743.html">[squid-users] measuring latency of squid in different scenarios
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#22741">[ date ]</a>
              <a href="thread.html#22741">[ thread ]</a>
              <a href="subject.html#22741">[ subject ]</a>
              <a href="author.html#22741">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
