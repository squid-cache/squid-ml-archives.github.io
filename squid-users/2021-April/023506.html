<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Linking Squid Logs
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Linking%20Squid%20Logs&In-Reply-To=%3Cdab07231-f876-0dc9-a3b8-b3125833185c%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   
   <LINK REL="Next"  HREF="023526.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Linking Squid Logs</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Linking%20Squid%20Logs&In-Reply-To=%3Cdab07231-f876-0dc9-a3b8-b3125833185c%40treenet.co.nz%3E"
       TITLE="[squid-users] Linking Squid Logs">squid3 at treenet.co.nz
       </A><BR>
    <I>Thu Apr  1 07:13:14 UTC 2021</I>
    <P><UL>
        
        <LI>Next message (by thread): <A HREF="023526.html">[squid-users] Linking Squid Logs
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23506">[ date ]</a>
              <a href="thread.html#23506">[ thread ]</a>
              <a href="subject.html#23506">[ subject ]</a>
              <a href="author.html#23506">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 1/04/21 6:59 am, Garbacik, Joe wrote:
&gt;<i> In my squid.conf, I have the following logformat which passes all the 
</I>&gt;<i> data from the client via the load balancer to the squid server as headers:
</I>&gt;<i>
</I>
...
&gt;<i> 
</I>&gt;<i> This creates the two logs at the end of this message, What I am 
</I>&gt;<i> wondering is:
</I>&gt;<i> 
</I>&gt;<i>  1. Why aren't all the request headers (look between *&#160;** *REQUEST
</I>&gt;<i>     HEADERS and *** RESPONSE HEADERSin each log) seen in the first log
</I>&gt;<i>     present in the second log
</I>
They are different transactions.


&gt;<i>  2. I'm assuming since squid is then making the request in the second
</I>&gt;<i>     log, it leaves the items in Flow0 (client &#61664;load balancer) empty but
</I>&gt;<i>     does retain the data for flow1 (load-balancer-&gt; squid)and flow2
</I>&gt;<i>     (squid -&gt; destination). Even the XFF is not passed. It there anyway
</I>&gt;<i>     to included retain this data?
</I>


First log entry is an HTTP request to initiate (CONNECT) a tunnel.

Second log entry is an HTTPS request to fetch (GET) data from a server.

What is happening is;

In the beginning there exists a TCP connection between Haproxy and 
Squid. Transferring HTTP messages.

One of those messages is a CONNECT request. Meaning connect this current 
TCP connection to the named server:port and stop performing HTTP - all 
following bytes will be some other protocol.

When Squid acknowledges the tunnel is connected bytes initiating a TLS 
connection start arriving. Squid does its SSL-Bump things to look inside.

The CONNECT message and state related to it are now complete. It gets 
logged and discarded.
   ** this messages is your log line #1.


What is found inside the TLS is a private HTTP communication channel 
with its own *fully separate* HTTP messages going on between the client 
and server. Squid starts acting as an interception proxy for those messages.
   ** one of these messages is your log line #2.


Notice firstly that the CONNECT message is only between the client and 
Squid. There are no HTTP headers or such going to the server for tunnel 
setup - just a TCP CYN packet.

Notice secondly that the intercept-proxy/SSL-bump decrypted HTTP 
messages have no relationship to the CONNECT or any prior forward-proxy 
HTTP messages on the TCP connection. They only thing they have in common 
is that they arrived on the same TCP connection between haproxy and Squid.
  If there is actually a relationship between them it might be visible 
in the fact that haproxy received both from the same client at its end

    ...  or not. Because we don't know whether haproxy can actually see 
the origin client or just another proxy multiplexing traffic into _that_ 
TCP connection.



&gt;<i>  3. Is there a way to generate an unique Id for each flow so, besides
</I>&gt;<i>     the data in flow0, once can easily link these logs together? 
</I>&gt;<i> 
</I>
That can only be done reliably by the client itself sending an HTTP 
header in all messages with its flow ID.

Otherwise the closest you can get is to define &quot;flow&quot; as everything from 
a haproxy ingress = { src-IP, src-port, dst-IP, dst-port, squid 
local-IP, squid local-port } to Squids egress = { src-IP, src-port, 
dst-IP, dst-port, dst-domain }.



Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	
	<LI>Next message (by thread): <A HREF="023526.html">[squid-users] Linking Squid Logs
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23506">[ date ]</a>
              <a href="thread.html#23506">[ thread ]</a>
              <a href="subject.html#23506">[ subject ]</a>
              <a href="author.html#23506">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
