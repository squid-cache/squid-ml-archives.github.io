<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Linking Squid Logs
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Linking%20Squid%20Logs&In-Reply-To=%3C9edfd60c-f170-142b-9cca-e7829d87a37c%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="023506.html">
   <LINK REL="Next"  HREF="023507.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Linking Squid Logs</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Linking%20Squid%20Logs&In-Reply-To=%3C9edfd60c-f170-142b-9cca-e7829d87a37c%40measurement-factory.com%3E"
       TITLE="[squid-users] Linking Squid Logs">rousskov at measurement-factory.com
       </A><BR>
    <I>Mon Apr  5 04:02:29 UTC 2021</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="023506.html">[squid-users] Linking Squid Logs
</A></li>
        <LI>Next message (by thread): <A HREF="023507.html">[squid-users] icap adaptation chains with adaptation sets
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23526">[ date ]</a>
              <a href="thread.html#23526">[ thread ]</a>
              <a href="subject.html#23526">[ subject ]</a>
              <a href="author.html#23526">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 3/31/21 1:59 PM, Garbacik, Joe wrote:
&gt;<i>  3. Is there a way to generate an unique Id for each flow so, besides
</I>&gt;<i>     the data in flow0, once can easily link these logs together? &#160;
</I>
I could not spend enough time to grok the true meaning behind all those
logformat %codes and the corresponding logged values in your questions,
but if you are trying to tie CONNECT requests with bumped transactions
inside those CONNECT tunnels, then you can do that using
%transport::&gt;connection_id. Unfortunately, that logformat %code is only
available in master (future v6) branch.

If you cannot use master/v6 code, then you may be able to accomplish the
same effect by annotating the connection during CONNECT request and then
logging that annotation. See the annotate_client ACL and %note logformat
%code. The difficulty with this older solution is what to use for the
annotation value -- the value has to be unique in a worker process scope
(at least).

I have not tested that, but you can try to use %master_xaction as the
annotation _value_. If it is supported (again, I have not checked), then
you will need to &quot;quote&quot; the annotation value string for Squid to start
interpreting %codes in an annotation value.

If you are using SMP Squid, then you will also need to log something
like &quot;kid${process_number}&quot; to make those master transaction IDs unique
across workers OR give each worker a dedicated access.log. You will also
have to move logs across Squid restarts, for similar uniqueness reasons.

You can also generate globally unique IDs using a key=value pair
returned by an external ACL and use those IDs instead of
%master_xaction. That is supported for sure. The clt_conn_tag=value pair
may be especially handy here.

All this requires testing/experimentation, but I suspect that there is a
way to make it work in modern Squids without source code modifications.


HTH,

Alex.



&gt;<i> In my squid.conf, I have the following logformat which passes all the
</I>&gt;<i> data from the client via the load balancer to the squid server as headers:
</I>&gt;<i>
</I>&gt;<i> logformat MyLogFormat  ---&gt; local_time=&quot;[%tl]&quot;
</I>&gt;<i> squid_service=%{service}note squid_status=%Ss squid_hierarchy_status=%Sh
</I>&gt;<i> ** haproxy_id=%{X-Request-Id}&gt;h orig_src_ip=%{X-Client-Egress-Ip}&gt;h
</I>&gt;<i> orig_src_port=%{X-Client-Egress-Port}&gt;h
</I>&gt;<i> haproxy_ingress_ip=%{X-Haproxy-Ingress-Ip}&gt;h
</I>&gt;<i> haproxy_ingress_port=%{X-Haproxy-Ingress-Port}&gt;h haproxy_egress_ip=%&gt;a
</I>&gt;<i> haproxy_egress_port=%&gt;p squid_ingress_ip=%&gt;la squid_ingress_port=%&gt;lp
</I>&gt;<i> squid_egress_ip=%&lt;la squid_egress_port=%&lt;lp dst_ip=%&lt;a dst_host=%&lt;A
</I>&gt;<i> dst_port=%&lt;p ident_username=%[ui username=%[un request_method=%rm
</I>&gt;<i> request=&quot;%rm %ru HTTP/%rv&quot; status_code_from_server=%&gt;Hs
</I>&gt;<i> status_code_to_client=%&lt;Hs referer=&quot;%{Referer}&gt;h&quot;
</I>&gt;<i> user_agent=&quot;%{User-Agent}&gt;h&quot; protocol_version=%rv **
</I>&gt;<i> dns_response_time=%dt response_time=%tr mime_type=%mt *XFER*
</I>&gt;<i> total_request_size=%&gt;st total_reply_size=%&lt;st ** %{src_zone}note
</I>&gt;<i> %{dst_zone}note %{method_category}note %{dst_category}note
</I>&gt;<i> %{file_upload}note ** REQUEST HEADERS %&gt;h *** RESPONSE HEADERS %&lt;h ***
</I>&gt;<i> tag_returned=%et tag_string=&quot;%ea&quot; previous_hop_mac=%&gt;eui
</I>&gt;<i> peer_response_time=%&lt;pt total_response_time=%&lt;tt *SSL*
</I>&gt;<i> src_ssl_negotiated_version=%ssl::&gt;negotiated_version
</I>&gt;<i> dst_ssl_negotiated_version=%ssl::&lt;negotiated_version
</I>&gt;<i> src_tls_hello_version=%ssl::&gt;received_hello_version
</I>&gt;<i> dst_tls_hello_version=%ssl::&lt;received_hello_version
</I>&gt;<i> src_tls_max_version=%ssl::&gt;received_supported_version
</I>&gt;<i> dst_tls_max_version=%ssl::&lt;received_supported_version
</I>&gt;<i> src_tls_cipher=%ssl::&gt;negotiated_cipher
</I>&gt;<i> dst_tls_cipher=%ssl::&lt;negotiated_cipher ssl_bump=%&lt;bs
</I>&gt;<i> ssl_bump_mode=%ssl::bump_mode ssl_sni=%ssl::&gt;sni
</I>&gt;<i> src_cert_subject=&quot;%ssl::&gt;cert_subject&quot;
</I>&gt;<i> src_cert_issuer=&quot;%ssl::&gt;cert_issuer&quot;
</I>&gt;<i> dst_cert_subject=&quot;%ssl::&lt;cert_subject&quot;
</I>&gt;<i> dst_cert_issuer=&quot;%ssl::&lt;cert_issuer&quot; cert_errors=&quot;%ssl::&lt;cert_errors&quot;
</I>&gt;<i> *** error_page_presented=%err_code err_detail=&quot;%err_detail&quot;
</I>&gt;<i> rule_id=%{ruleid}note rule_type=%{ruletype}note
</I>&gt;<i> XFF=%{X-Forwarded-For}&gt;h dst_app=%{dst_app}note
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> This creates the two logs at the end of this message, What I am
</I>&gt;<i> wondering is:
</I>&gt;<i>
</I>&gt;<i>  1. Why aren't all the request headers (look between * ** *REQUEST
</I>&gt;<i>     HEADERS and *** RESPONSE HEADERSin each log) seen in the first log
</I>&gt;<i>     present in the second log
</I>&gt;<i>  2. I'm assuming since squid is then making the request in the second
</I>&gt;<i>     log, it leaves the items in Flow0 (client &#61664;load balancer) empty but
</I>&gt;<i>     does retain the data for flow1 (load-balancer-&gt; squid)and flow2
</I>&gt;<i>     (squid -&gt; destination). Even the XFF is not passed. It there anyway
</I>&gt;<i>     to included retain this data?
</I>



&gt;<i> Which generates these two logs when doing SSL intercept
</I>&gt;<i> 
</I>&gt;<i> Log 1-----
</I>&gt;<i> 
</I>&gt;<i> 2021-03-31T12:22:08.402609+00:00 squid1 ---&gt;
</I>&gt;<i> local_time=&quot;[31/Mar/2021:08:22:08 -0400]&quot; squid_service=explicit
</I>&gt;<i> squid_status=NONE squid_hierarchy_status=HIER_DIRECT **
</I>&gt;<i> haproxy_id=73834348 | **Flow0** src_ip=10.11.63.205 src_port=55624
</I>&gt;<i> haproxy_ingress_ip=192.16.8.1.33 haproxy_ingress_port=3128 | ** Flow1**
</I>&gt;<i> haproxy_egress_ip=192.16.8.1.39 haproxy_egress_port=6079
</I>&gt;<i> squid_ingress_ip=192.16.8.1.36 squid_ingress_port=3128 | ** Flow2*
</I>&gt;<i> squid_egress_ip=192.16.8.1.40 squid_egress_port=55984
</I>&gt;<i> dst_ip=10.51.129.182 dst_host=myhost.foo.com dst_port=443
</I>&gt;<i> ident_username=- username=- request_method=CONNECT request=&quot;CONNECT
</I>&gt;<i> myhost.foo.com:443 HTTP/1.1&quot; status_code_from_server=200
</I>&gt;<i> status_code_to_client=- referer=&quot;-&quot; user_agent=&quot;git/2.7.4&quot;
</I>&gt;<i> protocol_version=1.1 ** dns_response_time=- response_time=174
</I>&gt;<i> mime_type=- *XFER* total_request_size=763 total_reply_size=0 **
</I>&gt;<i> src_zone=CoreLab - method_category=Safe - - ** REQUEST HEADERS
</I>&gt;<i> User-Agent=git/2.7.4 HDR_Proxy-Connection=Keep-Alive
</I>&gt;<i> HDR_X-Client-Environment=SecLab HDR_X-Client-Environment=Corporate
</I>&gt;<i> HDR_X-Client-IP=10.11.63.205 HDR_X-Proxy-Channel=3128
</I>&gt;<i> HDR_X-Haproxy-Role=Squid HDR_X-Correlation-ID=73834348
</I>&gt;<i> &#160;HDR_X-Client-Egress-Ip=10.11.63.205 HDR_X-Client-Egress-Port=55624
</I>&gt;<i> HDR_X-Haproxy-Ingress-Ip=192.16.8.1.33 HDR_X-Haproxy-Ingress-Port=3128
</I>&gt;<i> HDR_X-Haproxy-Egress-Ip=&quot;&quot; HDR_X-Haproxy-Egress-Port=&quot;&quot;
</I>&gt;<i> HDR_X-Server-Ingress-Ip=&quot;&quot; HDR_X-Server-Ingress-Port=&quot;&quot;
</I>&gt;<i> HDR_X-Server-Queue=0 HDR_X-App-Node=%3CNOSRV%3E HDR_X-SSL-Cipher=&quot;&quot;
</I>&gt;<i> HDR_X-SSL-Version=&quot;&quot; HDR_X-Request-Id=73834348
</I>&gt;<i> HDR_X-Forwarded-For=10.11.63.205 HDR_Connection=close
</I>&gt;<i> HDR_Host=myhost.foo.com:443 HDR_ *** RESPONSE HEADERS - ***
</I>&gt;<i> tag_returned=- tag_string=&quot;-&quot; previous_hop_mac=00:50:56:b8:03:73
</I>&gt;<i> peer_response_time=- total_response_time=98 *SSL*
</I>&gt;<i> src_ssl_negotiated_version=- dst_ssl_negotiated_version=TLS/1.2
</I>&gt;<i> src_tls_hello_version=TLS/1.0 dst_tls_hello_version=TLS/1.2
</I>&gt;<i> src_tls_max_version=TLS/1.2 dst_tls_max_version=TLS/1.2 src_tls_cipher=-
</I>&gt;<i> dst_tls_cipher=ECDHE-RSA-AES256-GCM-SHA384 ssl_bump=- ssl_bump_mode=bump
</I>&gt;<i> ssl_sni=myhost.foo.com src_cert_subject=&quot;-&quot; src_cert_issuer=&quot;-&quot;
</I>&gt;<i> dst_cert_subject=&quot;/C=US/postalCode=12345/ST=California/L=Sunnyvale/street=123
</I>&gt;<i> Any Street/O=Demo, Inc./OU=None/CN=foo.com&quot;
</I>&gt;<i> dst_cert_issuer=&quot;/C=GB/ST=Greater Manchester/L=Salford/O=Sectigo
</I>&gt;<i> Limited/CN=Sectigo RSA Organization Validation Secure Server CA&quot;
</I>&gt;<i> cert_errors=&quot;-&quot; *** error_page_presented=- err_detail=&quot;-&quot;
</I>&gt;<i> rule_id=Explicit-45-Rule1.conf_2 rule_type=ALLOW XFF=&quot;10.11.63.205&quot;
</I>&gt;<i> squid_dst_app=MyApp
</I>&gt;<i> 
</I>&gt;<i> &#160;
</I>&gt;<i> 
</I>&gt;<i> Log 2----
</I>&gt;<i> 
</I>&gt;<i> 2021-03-31T12:22:08.495914+00:00 squid1 ---&gt;
</I>&gt;<i> local_time=&quot;[31/Mar/2021:08:22:08 -0400]&quot; squid_service=explicit
</I>&gt;<i> squid_status=TCP_MISS squid_hierarchy_status=HIER_DIRECT ** haproxy_id=-
</I>&gt;<i> | **Flow0** src_ip=- src_port=- haproxy_ingress_ip=-
</I>&gt;<i> haproxy_ingress_port=- | ** Flow1** haproxy_egress_ip=192.16.8.1.39
</I>&gt;<i> haproxy_egress_port=6079 squid_ingress_ip=192.16.8.1.36
</I>&gt;<i> squid_ingress_port=3128 | ** Flow2** squid_egress_ip=192.16.8.1.40
</I>&gt;<i> squid_egress_port=55984 dst_ip=10.51.129.182 dst_host=myhost.foo.com
</I>&gt;<i> dst_port=443 ident_username=- username=- request_method=GET request=&quot;GET
</I>&gt;<i> <A HREF="https://myhost.foo.com/test.js">https://myhost.foo.com/test.js</A> HTTP/1.1&quot; status_code_from_server=401
</I>&gt;<i> status_code_to_client=401 referer=&quot;-&quot; user_agent=&quot;git/2.7.4&quot;
</I>&gt;<i> protocol_version=1.1 ** dns_response_time=- response_time=33 mime_type=-
</I>&gt;<i> *XFER* total_request_size=231 total_reply_size=434 ** src_zone=CoreLab -
</I>&gt;<i> method_category=Safe - - ** REQUEST HEADERS User-Agent=git/2.7.4
</I>&gt;<i> HDR_Accept=*/* HDR_Accept-Encoding=gzip HDR_Accept-Language=en-US,
</I>&gt;<i> *;q=0.9 HDR_Pragma=no-cache HDR_Host=myhost.foo.com HDR_ *** RESPONSE
</I>&gt;<i> HEADERS HTTP/1.1 401 Unauthorized HDR_Date=Wed, 31 Mar 2021 12:22:07 GMT
</I>&gt;<i> HDR_%0D *** tag_returned=- tag_string=&quot;-&quot;
</I>&gt;<i> previous_hop_mac=00:50:56:b8:03:73 peer_response_time=32
</I>&gt;<i> total_response_time=33 *SSL* src_ssl_negotiated_version=TLS/1.2
</I>&gt;<i> dst_ssl_negotiated_version=TLS/1.2 src_tls_hello_version=TLS/1.0
</I>&gt;<i> dst_tls_hello_version=TLS/1.2 src_tls_max_version=TLS/1.2
</I>&gt;<i> dst_tls_max_version=TLS/1.2 src_tls_cipher=ECDHE-RSA-AES256-GCM-SHA384
</I>&gt;<i> dst_tls_cipher=ECDHE-RSA-AES256-GCM-SHA384 ssl_bump=0 ssl_bump_mode=bump
</I>&gt;<i> ssl_sni=myhost.foo.com src_cert_subject=&quot;-&quot; src_cert_issuer=&quot;-&quot;
</I>&gt;<i> dst_cert_subject=&quot;/C=US/postalCode=12345/ST=California/L=Sunnyvale/street=123
</I>&gt;<i> Any Street/O=Demo, Inc./OU=None/CN=foo.com&quot;
</I>&gt;<i> dst_cert_issuer=&quot;/C=GB/ST=Greater Manchester/L=Salford/O=Sectigo
</I>&gt;<i> Limited/CN=Sectigo RSA Organization Validation Secure Server CA&quot;
</I>&gt;<i> cert_errors=&quot;-&quot; *** error_page_presented=- err_detail=&quot;-&quot;
</I>&gt;<i> rule_id=Explicit-45-Rule1.conf_2 rule_type=ALLOW XFF=&quot;-&quot; squid_dst_app=MyApp
</I>&gt;<i> 
</I>&gt;<i> &#160;
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i> 
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="023506.html">[squid-users] Linking Squid Logs
</A></li>
	<LI>Next message (by thread): <A HREF="023507.html">[squid-users] icap adaptation chains with adaptation sets
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23526">[ date ]</a>
              <a href="thread.html#23526">[ thread ]</a>
              <a href="subject.html#23526">[ subject ]</a>
              <a href="author.html#23526">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
