<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Cache Peers and traffic handling
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Cache%20Peers%20and%20traffic%20handling&In-Reply-To=%3CCAPeL7PGmK-Kfqvb-U%3DuU%2BDcXMpsjtGAeSRpM_jt0e%2BShNJGVEQ%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="023550.html">
   <LINK REL="Next"  HREF="023552.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Cache Peers and traffic handling</H1>
    <B>koshik moshik</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Cache%20Peers%20and%20traffic%20handling&In-Reply-To=%3CCAPeL7PGmK-Kfqvb-U%3DuU%2BDcXMpsjtGAeSRpM_jt0e%2BShNJGVEQ%40mail.gmail.com%3E"
       TITLE="[squid-users] Cache Peers and traffic handling">koshikmoshik at gmail.com
       </A><BR>
    <I>Wed Apr 14 18:49:13 UTC 2021</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="023550.html">[squid-users] Cache Peers and traffic handling
</A></li>
        <LI>Next message (by thread): <A HREF="023552.html">[squid-users] Cache Peers and traffic handling
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23551">[ date ]</a>
              <a href="thread.html#23551">[ thread ]</a>
              <a href="subject.html#23551">[ subject ]</a>
              <a href="author.html#23551">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>First of all thank you for trying to help me. Let me describe my current
issue: I have 5000 proxies and would like to hide them. My plan was using
another proxy server with 5000 cache peers and 5000 users. Each user would
get one peer and one proxy attached to that peer. So basically the outer
world would not see my &quot;main proxy&quot; and only the one from the new proxy
server.

Is there any better solution than cache peers for that?

On Wed, Apr 14, 2021 at 8:37 PM Alex Rousskov &lt;
<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt; wrote:

&gt;<i> On 4/14/21 2:29 AM, koshik moshik wrote:
</I>&gt;<i> &gt; Thank you! Yes, it works fine with 5 peers. So, what would be the best
</I>&gt;<i> &gt; solution to handle 5000 peers?
</I>&gt;<i>
</I>&gt;<i> As you can tell by other responses, you might be asking the wrong
</I>&gt;<i> question. However, I will still try to answer your question. The best
</I>&gt;<i> option may be to add support for a new Squid configuration parameter
</I>&gt;<i> that tells Squid to limit cache_peer candidate accumulation to N peers,
</I>&gt;<i> effectively making all those linear searches fast.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> <A HREF="https://wiki.squid-cache.org/SquidFaq/AboutSquid#How_to_add_a_new_Squid_feature.2C_enhance.2C_of_fix_something.3F">https://wiki.squid-cache.org/SquidFaq/AboutSquid#How_to_add_a_new_Squid_feature.2C_enhance.2C_of_fix_something.3F</A>
</I>&gt;<i>
</I>&gt;<i> Alex.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; On Mon, Apr 12, 2021 at 6:03 PM Alex Rousskov wrote:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     On 4/10/21 5:03 PM, koshik moshik wrote:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     &gt; I am trying to run a Squid proxy Server witth about 5000 cache
</I>&gt;<i> &gt;     peers. I
</I>&gt;<i> &gt;     &gt; am running a dedicated server with 6 cores and 32GB RAM on Ubuntu
</I>&gt;<i> 16.
</I>&gt;<i> &gt;     &gt;
</I>&gt;<i> &gt;     &gt;
</I>&gt;<i> &gt;     &gt; Could you tell me what else is needed / not needed in my
</I>&gt;<i> &gt;     squid.config? I
</I>&gt;<i> &gt;     &gt; am encountering a high CPU usage and would like to create a very
</I>&gt;<i> &gt;     &gt; efficient proxy server.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     IIRC, Squid code is not optimized for handling a large number of
</I>&gt;<i> &gt;     cache_peers: Several cache peer selection steps involve linear
</I>&gt;<i> searches.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     I do not know what exactly causes high CPU usage in your environment
</I>&gt;<i> but
</I>&gt;<i> &gt;     it could be those linear searches. You can test that (indirectly) by
</I>&gt;<i> &gt;     decreasing the number of cache_peers from 5000 to, say, 5. That is a
</I>&gt;<i> &gt;     weak test, of course, because other cache_peer-related overheads
</I>&gt;<i> could
</I>&gt;<i> &gt;     be to blame, but I would start there.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     HTH,
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     Alex.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     &gt; Down below you can find my squid.config(I deleted the other
</I>&gt;<i> cache_peer
</I>&gt;<i> &gt;     &gt; lines):
</I>&gt;<i> &gt;     &gt;
</I>&gt;<i> &gt;     &gt; -----------
</I>&gt;<i> &gt;     &gt;
</I>&gt;<i> &gt;     &gt; http_port 3128
</I>&gt;<i> &gt;     &gt;
</I>&gt;<i> &gt;     &gt; dns_v4_first on
</I>&gt;<i> &gt;     &gt;
</I>&gt;<i> &gt;     &gt; acl SSL_ports port 1-65535
</I>&gt;<i> &gt;     &gt;
</I>&gt;<i> &gt;     &gt; acl Safe_ports port 1-65535
</I>&gt;<i> &gt;     &gt;
</I>&gt;<i> &gt;     &gt; acl CONNECT method CONNECT
</I>&gt;<i> &gt;     &gt;
</I>&gt;<i> &gt;     &gt; http_access deny !Safe_ports
</I>&gt;<i> &gt;     &gt;
</I>&gt;<i> &gt;     &gt; http_access deny CONNECT !SSL_ports
</I>&gt;<i> &gt;     &gt;
</I>&gt;<i> &gt;     &gt; auth_param basic program /usr/lib/squid/basic_ncsa_auth
</I>&gt;<i> &gt;     /etc/squid/.htpasswd
</I>&gt;<i> &gt;     &gt;
</I>&gt;<i> &gt;     &gt; auth_param basic children 5
</I>&gt;<i> &gt;     &gt;
</I>&gt;<i> &gt;     &gt; auth_param basic realm Squid Basic Authentication
</I>&gt;<i> &gt;     &gt;
</I>&gt;<i> &gt;     &gt; auth_param basic credentialsttl 5 hours
</I>&gt;<i> &gt;     &gt;
</I>&gt;<i> &gt;     &gt; acl password proxy_auth REQUIRED
</I>&gt;<i> &gt;     &gt;
</I>&gt;<i> &gt;     &gt; http_access allow password
</I>&gt;<i> &gt;     &gt;
</I>&gt;<i> &gt;     &gt; #http_access deny all
</I>&gt;<i> &gt;     &gt;
</I>&gt;<i> &gt;     &gt; cache allow all
</I>&gt;<i> &gt;     &gt;
</I>&gt;<i> &gt;     &gt; never_direct allow all
</I>&gt;<i> &gt;     &gt;
</I>&gt;<i> &gt;     &gt; ident_access deny all
</I>&gt;<i> &gt;     &gt;
</I>&gt;<i> &gt;     &gt;
</I>&gt;<i> &gt;     &gt;
</I>&gt;<i> &gt;     &gt;
</I>&gt;<i> &gt;     &gt;
</I>&gt;<i> &gt;     &gt; cache_mem 1 GB
</I>&gt;<i> &gt;     &gt;
</I>&gt;<i> &gt;     &gt; maximum_object_size_in_memory 16 MB
</I>&gt;<i> &gt;     &gt;
</I>&gt;<i> &gt;     &gt;
</I>&gt;<i> &gt;     &gt;
</I>&gt;<i> &gt;     &gt;
</I>&gt;<i> &gt;     &gt;
</I>&gt;<i> &gt;     &gt; # Leave coredumps in the first cache dir
</I>&gt;<i> &gt;     &gt;
</I>&gt;<i> &gt;     &gt; coredump_dir /var/spool/squid
</I>&gt;<i> &gt;     &gt;
</I>&gt;<i> &gt;     &gt;
</I>&gt;<i> &gt;     &gt; #Rules to anonymize http headers
</I>&gt;<i> &gt;     &gt;
</I>&gt;<i> &gt;     &gt; forwarded_for off
</I>&gt;<i> &gt;     &gt;
</I>&gt;<i> &gt;     &gt; request_header_access Allow allow all
</I>&gt;<i> &gt;     &gt;
</I>&gt;<i> &gt;     &gt; request_header_access Authorization allow all
</I>&gt;<i> &gt;     &gt;
</I>&gt;<i> &gt;     &gt; request_header_access WWW-Authenticate allow all
</I>&gt;<i> &gt;     &gt;
</I>&gt;<i> &gt;     &gt; request_header_access Proxy-Authorization allow all
</I>&gt;<i> &gt;     &gt;
</I>&gt;<i> &gt;     &gt; request_header_access Proxy-Authenticate allow all
</I>&gt;<i> &gt;     &gt;
</I>&gt;<i> &gt;     &gt; request_header_access Cache-Control allow all
</I>&gt;<i> &gt;     &gt;
</I>&gt;<i> &gt;     &gt; request_header_access Content-Encoding allow all
</I>&gt;<i> &gt;     &gt;
</I>&gt;<i> &gt;     &gt; request_header_access Content-Length allow all
</I>&gt;<i> &gt;     &gt;
</I>&gt;<i> &gt;     &gt; request_header_access Content-Type allow all
</I>&gt;<i> &gt;     &gt;
</I>&gt;<i> &gt;     &gt; request_header_access Date allow all
</I>&gt;<i> &gt;     &gt;
</I>&gt;<i> &gt;     &gt; request_header_access Expires allow all
</I>&gt;<i> &gt;     &gt;
</I>&gt;<i> &gt;     &gt; request_header_access Host allow all
</I>&gt;<i> &gt;     &gt;
</I>&gt;<i> &gt;     &gt; request_header_access If-Modified-Since allow all
</I>&gt;<i> &gt;     &gt;
</I>&gt;<i> &gt;     &gt; request_header_access Last-Modified allow all
</I>&gt;<i> &gt;     &gt;
</I>&gt;<i> &gt;     &gt; request_header_access Location allow all
</I>&gt;<i> &gt;     &gt;
</I>&gt;<i> &gt;     &gt; request_header_access Pragma allow all
</I>&gt;<i> &gt;     &gt;
</I>&gt;<i> &gt;     &gt; request_header_access Accept allow all
</I>&gt;<i> &gt;     &gt;
</I>&gt;<i> &gt;     &gt; request_header_access Accept-Charset allow all
</I>&gt;<i> &gt;     &gt;
</I>&gt;<i> &gt;     &gt; request_header_access Accept-Encoding allow all
</I>&gt;<i> &gt;     &gt;
</I>&gt;<i> &gt;     &gt; request_header_access Accept-Language allow all
</I>&gt;<i> &gt;     &gt;
</I>&gt;<i> &gt;     &gt; request_header_access Content-Language allow all
</I>&gt;<i> &gt;     &gt;
</I>&gt;<i> &gt;     &gt; request_header_access Mime-Version allow all
</I>&gt;<i> &gt;     &gt;
</I>&gt;<i> &gt;     &gt; request_header_access Retry-After allow all
</I>&gt;<i> &gt;     &gt;
</I>&gt;<i> &gt;     &gt; request_header_access Title allow all
</I>&gt;<i> &gt;     &gt;
</I>&gt;<i> &gt;     &gt; request_header_access Connection allow all
</I>&gt;<i> &gt;     &gt;
</I>&gt;<i> &gt;     &gt; request_header_access Proxy-Connection allow all
</I>&gt;<i> &gt;     &gt;
</I>&gt;<i> &gt;     &gt; request_header_access User-Agent allow all
</I>&gt;<i> &gt;     &gt;
</I>&gt;<i> &gt;     &gt; request_header_access Cookie allow all
</I>&gt;<i> &gt;     &gt;
</I>&gt;<i> &gt;     &gt; request_header_access All deny all
</I>&gt;<i> &gt;     &gt;
</I>&gt;<i> &gt;     &gt;
</I>&gt;<i> &gt;     &gt;
</I>&gt;<i> &gt;     &gt;
</I>&gt;<i> &gt;     &gt;
</I>&gt;<i> &gt;     &gt; #
</I>&gt;<i> &gt;     &gt;
</I>&gt;<i> &gt;     &gt; # Add any of your own refresh_pattern entries above these.
</I>&gt;<i> &gt;     &gt;
</I>&gt;<i> &gt;     &gt; #
</I>&gt;<i> &gt;     &gt;
</I>&gt;<i> &gt;     &gt; #refresh_pattern ^ftp:           1440    20%     10080
</I>&gt;<i> &gt;     &gt;
</I>&gt;<i> &gt;     &gt; #refresh_pattern ^gopher:        1440    0%      1440
</I>&gt;<i> &gt;     &gt;
</I>&gt;<i> &gt;     &gt; #refresh_pattern -i (/cgi-bin/|\?) 0     0%      0
</I>&gt;<i> &gt;     &gt;
</I>&gt;<i> &gt;     &gt; #refresh_pattern (Release|Packages(.gz)*)$      0       20%
</I>&gt;<i> 2880
</I>&gt;<i> &gt;     &gt;
</I>&gt;<i> &gt;     &gt; #refresh_pattern .               0       20%     4320
</I>&gt;<i> &gt;     &gt;
</I>&gt;<i> &gt;     &gt;
</I>&gt;<i> &gt;     &gt; ################################
</I>&gt;<i> &gt;     &gt;
</I>&gt;<i> &gt;     &gt; acl me proxy_auth ye-1
</I>&gt;<i> &gt;     &gt;
</I>&gt;<i> &gt;     &gt; cache_peer my.proxy.com &lt;<A HREF="http://my.proxy.com">http://my.proxy.com</A>&gt;
</I>&gt;<i> &gt;     &lt;<A HREF="http://my.proxy.com/">http://my.proxy.com/</A> &lt;<A HREF="http://my.proxy.com/">http://my.proxy.com/</A>&gt;&gt; parent 31280
</I>&gt;<i> &gt;     &gt; login=user1:password1 no-query name=a1
</I>&gt;<i> &gt;     &gt;
</I>&gt;<i> &gt;     &gt; cache_peer_access a1 allow me
</I>&gt;<i> &gt;     &gt;
</I>&gt;<i> &gt;     &gt; cache_peer_access a1 deny all
</I>&gt;<i> &gt;     &gt;
</I>&gt;<i> &gt;     &gt;
</I>&gt;<i> &gt;     &gt; _______________________________________________
</I>&gt;<i> &gt;     &gt; squid-users mailing list
</I>&gt;<i> &gt;     &gt; <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> &gt;     &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>&gt;
</I>&gt;<i> &gt;     &gt; <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i> &gt;     &lt;<A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>&gt;
</I>&gt;<i> &gt;     &gt;
</I>&gt;<i> &gt;
</I>&gt;<i>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20210414/846b874f/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20210414/846b874f/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="023550.html">[squid-users] Cache Peers and traffic handling
</A></li>
	<LI>Next message (by thread): <A HREF="023552.html">[squid-users] Cache Peers and traffic handling
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23551">[ date ]</a>
              <a href="thread.html#23551">[ thread ]</a>
              <a href="subject.html#23551">[ subject ]</a>
              <a href="author.html#23551">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
