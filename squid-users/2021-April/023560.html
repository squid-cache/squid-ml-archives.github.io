<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] allow update domain and block everything else
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20allow%20update%20domain%20and%20block%20everything%20else&In-Reply-To=%3CCAJtdwuuDBTacmqtoOC7%3DYtn%3DrmuKJGvWWLqHFmWqhb%2B6qu9Txw%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="023556.html">
   <LINK REL="Next"  HREF="023561.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] allow update domain and block everything else</H1>
    <B>Miroslaw Malinowski</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20allow%20update%20domain%20and%20block%20everything%20else&In-Reply-To=%3CCAJtdwuuDBTacmqtoOC7%3DYtn%3DrmuKJGvWWLqHFmWqhb%2B6qu9Txw%40mail.gmail.com%3E"
       TITLE="[squid-users] allow update domain and block everything else">mr.miroslaw.malinowski at gmail.com
       </A><BR>
    <I>Thu Apr 15 20:52:03 UTC 2021</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="023556.html">[squid-users] allow update domain and block everything else
</A></li>
        <LI>Next message (by thread): <A HREF="023561.html">[squid-users] allow update domain and block everything else
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23560">[ date ]</a>
              <a href="thread.html#23560">[ thread ]</a>
              <a href="subject.html#23560">[ subject ]</a>
              <a href="author.html#23560">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I've found a resolution using a bit better regex:

acl blackList url_regex ^https?:\/\/.*$

looking at the debug it doing exactly what I wanted, however, I now have a
different issue how to handle a 302 MOVED when the move is to a different
domain, e.g. packages.gitlab.com are moved to d20rj4el6vkp4c.cloudfront.net.
Is squid stateful in a way that it's able to remember those packets are
coming from the same session? What would be the best way to resolve the
issue other than just keep adding domain if a thing like this happens.


Thanks


On Thu, Apr 15, 2021 at 1:03 PM Miroslaw Malinowski &lt;
<A HREF="https://lists.squid-cache.org/listinfo/squid-users">mr.miroslaw.malinowski at gmail.com</A>&gt; wrote:

&gt;<i> Hi,
</I>&gt;<i>
</I>&gt;<i> I'm trying to use Opnsense built-in squid config to set up a transparent
</I>&gt;<i> proxy for server updates and block everything else.
</I>&gt;<i> In GUI they use url_regex for whitelist and blacklist, when I simple per
</I>&gt;<i> domain whitelist and blacklist it's working as expected, e.g.
</I>&gt;<i> # ACL - Whitelist - User defined (whiteList)
</I>&gt;<i> acl whiteList url_regex archive\.ubuntu\.com
</I>&gt;<i> # ACL - Blacklist - User defined (blackList)
</I>&gt;<i> acl blackList url_regex packages\.gitlab\.com
</I>&gt;<i> # ACL list (Allow) whitelist
</I>&gt;<i> http_access allow whiteList
</I>&gt;<i> # ACL list (Deny) blacklist
</I>&gt;<i> http_access deny blackList
</I>&gt;<i>
</I>&gt;<i> However, when I do wildcard in blacklist I also get all https domain
</I>&gt;<i> blocked even when I've tried to explicitly allow it with <A HREF="https://archive\.ubuntu\.com">https://archive\.ubuntu\.com</A>
</I>&gt;<i> , e.g.
</I>&gt;<i> # ACL - Whitelist - User defined (whiteList)
</I>&gt;<i> acl whiteList url_regex archive\.ubuntu\.com
</I>&gt;<i> # ACL - Blacklist - User defined (blackList)
</I>&gt;<i> acl blackList url_regex .*
</I>&gt;<i> # ACL list (Allow) whitelist
</I>&gt;<i> http_access allow whiteList
</I>&gt;<i> # ACL list (Deny) blacklist
</I>&gt;<i> http_access deny blackList
</I>&gt;<i>
</I>&gt;<i> I get:
</I>&gt;<i> Err:7 <A HREF="https://repos.influxdata.com/ubuntu">https://repos.influxdata.com/ubuntu</A> focal InRelease
</I>&gt;<i>  403  Forbidden [IP: 52.84.95.46 443]
</I>&gt;<i>
</I>&gt;<i> What I'm trying to say is with blacklist as . is blocking all https
</I>&gt;<i> traffic even if whitelisted, is this an expected behaviour or I'm doing
</I>&gt;<i> something wrong or it can't be done with url_regex and I should do it at
</I>&gt;<i> backend manually.
</I>&gt;<i>
</I>&gt;<i> My config:
</I>&gt;<i> #
</I>&gt;<i> # Automatic generated configuration for Squid.
</I>&gt;<i> # Do not edit this file manually.
</I>&gt;<i> #
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> # Setup transparent mode listeners on loopback interfaces
</I>&gt;<i> http_port 127.0.0.1:3128 intercept ssl-bump cert=/var/squid/ssl/ca.pem
</I>&gt;<i> dynamic_cert_mem_cache_size=10MB generate-host-certificates=on
</I>&gt;<i> http_port [::1]:3128 intercept ssl-bump cert=/var/squid/ssl/ca.pem
</I>&gt;<i> dynamic_cert_mem_cache_size=10MB generate-host-certificates=on
</I>&gt;<i> https_port 127.0.0.1:3129 intercept ssl-bump cert=/var/squid/ssl/ca.pem
</I>&gt;<i> dynamic_cert_mem_cache_size=10MB generate-host-certificates=on
</I>&gt;<i> https_port [::1]:3129 intercept ssl-bump cert=/var/squid/ssl/ca.pem
</I>&gt;<i> dynamic_cert_mem_cache_size=10MB generate-host-certificates=on
</I>&gt;<i>
</I>&gt;<i> # Setup regular listeners configuration
</I>&gt;<i> http_port 172.16.230.252:3128  ssl-bump cert=/var/squid/ssl/ca.pem
</I>&gt;<i> dynamic_cert_mem_cache_size=10MB generate-host-certificates=on
</I>&gt;<i> http_port 172.16.230.254:3128  ssl-bump cert=/var/squid/ssl/ca.pem
</I>&gt;<i> dynamic_cert_mem_cache_size=10MB generate-host-certificates=on
</I>&gt;<i>
</I>&gt;<i> # setup ssl re-cert
</I>&gt;<i> sslcrtd_program /usr/local/libexec/squid/security_file_certgen -s
</I>&gt;<i> /var/squid/ssl_crtd -M 10MB
</I>&gt;<i> sslcrtd_children 5
</I>&gt;<i>
</I>&gt;<i> tls_outgoing_options options=NO_TLSv1
</I>&gt;<i> cipher=HIGH:MEDIUM:!RC4:!aNULL:!eNULL:!LOW:!3DES:!MD5:!EXP:!PSK:!SRP:!DSS
</I>&gt;<i>
</I>&gt;<i> # setup ssl bump acl's
</I>&gt;<i> acl bump_step1 at_step SslBump1
</I>&gt;<i> acl bump_step2 at_step SslBump2
</I>&gt;<i> acl bump_step3 at_step SslBump3
</I>&gt;<i> acl bump_nobumpsites ssl::server_name
</I>&gt;<i> &quot;/usr/local/etc/squid/nobumpsites.acl&quot;
</I>&gt;<i>
</I>&gt;<i> # configure bump
</I>&gt;<i> ssl_bump peek bump_step1 all
</I>&gt;<i> ssl_bump peek bump_step2 bump_nobumpsites
</I>&gt;<i> ssl_bump splice bump_step3 bump_nobumpsites
</I>&gt;<i> ssl_bump stare bump_step2
</I>&gt;<i> ssl_bump bump bump_step3
</I>&gt;<i>
</I>&gt;<i> sslproxy_cert_error deny all
</I>&gt;<i>
</I>&gt;<i> acl ftp proto FTP
</I>&gt;<i> http_access allow ftp
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> # Setup ftp proxy
</I>&gt;<i>
</I>&gt;<i> # Rules allowing access from your local networks.
</I>&gt;<i> # Generated list of (internal) IP networks from where browsing
</I>&gt;<i> # should be allowed. (Allow interface subnets).
</I>&gt;<i> acl localnet src &lt;net&gt;/24 # Possible internal network (interfaces v4)
</I>&gt;<i> # Default allow for local-link and private networks
</I>&gt;<i> acl localnet src fc00::/7       # RFC 4193 local private network range
</I>&gt;<i> acl localnet src fe80::/10      # RFC 4291 link-local (directly plugged)
</I>&gt;<i> machines
</I>&gt;<i>
</I>&gt;<i> # ACL - Allow localhost for PURGE cache if enabled
</I>&gt;<i> acl PURGE method PURGE
</I>&gt;<i> http_access allow localhost PURGE
</I>&gt;<i> http_access deny PURGE
</I>&gt;<i>
</I>&gt;<i> # ACL lists
</I>&gt;<i> # ACL - Whitelist - User defined (whiteList)
</I>&gt;<i> acl whiteList url_regex packages\.wazuh\.com
</I>&gt;<i> acl whiteList url_regex archive\.ubuntu\.com
</I>&gt;<i> acl whiteList url_regex security\.ubuntu\.com
</I>&gt;<i> acl whiteList url_regex repos\.influxdata\.com
</I>&gt;<i>
</I>&gt;<i> # ACL - Blacklist - User defined (blackList)
</I>&gt;<i> acl blackList url_regex .*
</I>&gt;<i>
</I>&gt;<i> # ACL - Remote fetched Blacklist (remoteblacklist)
</I>&gt;<i>
</I>&gt;<i> # ACL - Block browser/user-agent - User defined (browser)
</I>&gt;<i>
</I>&gt;<i> # ACL - SSL ports, default are configured in config.xml
</I>&gt;<i> # Configured SSL ports (if defaults are not listed, then they have been
</I>&gt;<i> removed from the configuration!):
</I>&gt;<i> acl SSL_ports port 443 # https
</I>&gt;<i>
</I>&gt;<i> # Default Safe ports are now defined in config.xml
</I>&gt;<i> # Configured Safe ports (if defaults are not listed, then they have been
</I>&gt;<i> removed from the configuration!):
</I>&gt;<i> # ACL - Safe_ports
</I>&gt;<i> acl Safe_ports port 80 # http
</I>&gt;<i> acl Safe_ports port 21 # ftp
</I>&gt;<i> acl Safe_ports port 443 # https
</I>&gt;<i> acl Safe_ports port 70 # gopher
</I>&gt;<i> acl Safe_ports port 210 # wais
</I>&gt;<i> acl Safe_ports port 1025-65535 # unregistered ports
</I>&gt;<i> acl Safe_ports port 280 # http-mgmt
</I>&gt;<i> acl Safe_ports port 488 # gss-http
</I>&gt;<i> acl Safe_ports port 591 # filemaker
</I>&gt;<i> acl Safe_ports port 777 # multiling http
</I>&gt;<i> acl CONNECT method CONNECT
</I>&gt;<i>
</I>&gt;<i> # ICAP SETTINGS
</I>&gt;<i> # disable icap
</I>&gt;<i> icap_enable off
</I>&gt;<i>
</I>&gt;<i> # Pre-auth plugins
</I>&gt;<i> include /usr/local/etc/squid/pre-auth/*.conf
</I>&gt;<i>
</I>&gt;<i> # Authentication Settings
</I>&gt;<i>
</I>&gt;<i> # ACL list (Allow) whitelist
</I>&gt;<i> http_access allow whiteList
</I>&gt;<i>
</I>&gt;<i> #
</I>&gt;<i> # ACL list (Deny) blacklist
</I>&gt;<i> http_access deny blackList
</I>&gt;<i>
</I>&gt;<i> # Google Suite Filter
</I>&gt;<i>
</I>&gt;<i> # YouTube Filter
</I>&gt;<i>
</I>&gt;<i> # Deny requests to certain unsafe ports
</I>&gt;<i>
</I>&gt;<i> http_access deny !Safe_ports
</I>&gt;<i> # Deny CONNECT to other than secure SSL ports
</I>&gt;<i>
</I>&gt;<i> http_access deny CONNECT !SSL_ports
</I>&gt;<i>
</I>&gt;<i> # Only allow cachemgr access from localhost
</I>&gt;<i> http_access allow localhost manager
</I>&gt;<i> http_access deny manager
</I>&gt;<i>
</I>&gt;<i> # We strongly recommend the following be uncommented to protect innocent
</I>&gt;<i> # web applications running on the proxy server who think the only
</I>&gt;<i> # one who can access services on &quot;localhost&quot; is a local user
</I>&gt;<i> http_access deny to_localhost
</I>&gt;<i>
</I>&gt;<i> # Auth plugins
</I>&gt;<i> include /usr/local/etc/squid/auth/*.conf
</I>&gt;<i>
</I>&gt;<i> #
</I>&gt;<i> # Access Permission configuration:
</I>&gt;<i> #
</I>&gt;<i> # Deny request from unauthorized clients
</I>&gt;<i>
</I>&gt;<i> #
</I>&gt;<i> # ACL - localnet - default these include ranges from selected interfaces
</I>&gt;<i> (Allow local subnets)
</I>&gt;<i> http_access allow localnet
</I>&gt;<i>
</I>&gt;<i> # ACL - localhost
</I>&gt;<i> http_access allow localhost
</I>&gt;<i>
</I>&gt;<i> # Deny all other access to this proxy
</I>&gt;<i> http_access deny all
</I>&gt;<i> # Post-auth plugins
</I>&gt;<i> include /usr/local/etc/squid/post-auth/*.conf
</I>&gt;<i>
</I>&gt;<i> # Caching settings
</I>&gt;<i> cache_mem 1000 MB
</I>&gt;<i> maximum_object_size 200 MB
</I>&gt;<i> cache_replacement_policy heap LFUDA
</I>&gt;<i> cache_dir ufs /var/squid/cache 100000 16 256
</I>&gt;<i>
</I>&gt;<i> # Leave coredumps in the first cache dir
</I>&gt;<i> coredump_dir /var/squid/cache
</I>&gt;<i>
</I>&gt;<i> #
</I>&gt;<i> # Add any of your own refresh_pattern entries above these.
</I>&gt;<i> #
</I>&gt;<i>
</I>&gt;<i> # Linux package cache:
</I>&gt;<i> refresh_pattern pkg\.tar\.xz$   0       20%     4320 refresh-ims
</I>&gt;<i> refresh_pattern d?rpm$          0       20%     4320 refresh-ims
</I>&gt;<i> refresh_pattern deb$            0       20%     4320 refresh-ims
</I>&gt;<i> refresh_pattern udeb$           0       20%     4320 refresh-ims
</I>&gt;<i> refresh_pattern Packages\.bz2$  0       20%     4320 refresh-ims
</I>&gt;<i> refresh_pattern Sources\.bz2$   0       20%     4320 refresh-ims
</I>&gt;<i> refresh_pattern Release\.gpg$   0       20%     4320 refresh-ims
</I>&gt;<i> refresh_pattern Release$        0       20%     4320 refresh-ims
</I>&gt;<i> # <A HREF="http://wiki.squid-cache.org/SquidFaq/WindowsUpdate">http://wiki.squid-cache.org/SquidFaq/WindowsUpdate</A>
</I>&gt;<i> refresh_pattern -i
</I>&gt;<i> microsoft.com/.*\.(cab|exe|ms[i|u|f]|[ap]sf|wm[v|a]|dat|zip|esd)
</I>&gt;<i> &lt;<A HREF="http://microsoft.com/.*%5C.(cab%7Cexe%7Cms%5Bi%7Cu%7Cf%5D%7C%5Bap%5Dsf%7Cwm%5Bv%7Ca%5D%7Cdat%7Czip%7Cesd">http://microsoft.com/.*%5C.(cab%7Cexe%7Cms%5Bi%7Cu%7Cf%5D%7C%5Bap%5Dsf%7Cwm%5Bv%7Ca%5D%7Cdat%7Czip%7Cesd</A>)&gt;
</I>&gt;<i>     4320 80% 129600 reload-into-ims
</I>&gt;<i> refresh_pattern -i
</I>&gt;<i> windowsupdate.com/.*\.(cab|exe|ms[i|u|f]|[ap]sf|wm[v|a]|dat|zip|esd)
</I>&gt;<i> &lt;<A HREF="http://windowsupdate.com/.*%5C.(cab%7Cexe%7Cms%5Bi%7Cu%7Cf%5D%7C%5Bap%5Dsf%7Cwm%5Bv%7Ca%5D%7Cdat%7Czip%7Cesd">http://windowsupdate.com/.*%5C.(cab%7Cexe%7Cms%5Bi%7Cu%7Cf%5D%7C%5Bap%5Dsf%7Cwm%5Bv%7Ca%5D%7Cdat%7Czip%7Cesd</A>)&gt;
</I>&gt;<i> 4320 80% 129600 reload-into-ims
</I>&gt;<i> refresh_pattern -i
</I>&gt;<i> windows.com/.*\.(cab|exe|ms[i|u|f]|[ap]sf|wm[v|a]|dat|zip|esd)
</I>&gt;<i> &lt;<A HREF="http://windows.com/.*%5C.(cab%7Cexe%7Cms%5Bi%7Cu%7Cf%5D%7C%5Bap%5Dsf%7Cwm%5Bv%7Ca%5D%7Cdat%7Czip%7Cesd">http://windows.com/.*%5C.(cab%7Cexe%7Cms%5Bi%7Cu%7Cf%5D%7C%5Bap%5Dsf%7Cwm%5Bv%7Ca%5D%7Cdat%7Czip%7Cesd</A>)&gt;
</I>&gt;<i>       4320 80% 129600 reload-into-ims
</I>&gt;<i>
</I>&gt;<i> refresh_pattern ^ftp:           1440    20%     10080
</I>&gt;<i> refresh_pattern ^gopher:        1440    0%      1440
</I>&gt;<i> refresh_pattern -i (/cgi-bin/|\?) 0     0%      0
</I>&gt;<i> refresh_pattern .               0       20%     4320
</I>&gt;<i>
</I>&gt;<i> # Squid Options
</I>&gt;<i> # dns_v4_first reverses the order of preference to make Squid contact
</I>&gt;<i> dual-stack websites over IPv4 first
</I>&gt;<i> dns_v4_first on
</I>&gt;<i> pinger_enable off
</I>&gt;<i> access_log stdio:/var/log/squid/access.log squid
</I>&gt;<i> cache_store_log stdio:/var/log/squid/store.log
</I>&gt;<i> # URI hanlding with Whitespaces (default=strip)
</I>&gt;<i> uri_whitespace strip
</I>&gt;<i> # X-Forwarded header handling (default=on)
</I>&gt;<i> forwarded_for on
</I>&gt;<i> # Disable squid logfile rotate to use system defaults
</I>&gt;<i> logfile_rotate 0
</I>&gt;<i> # Define visible email
</I>&gt;<i> cache_mgr <A HREF="https://lists.squid-cache.org/listinfo/squid-users">admin at localhost.local</A>
</I>&gt;<i> error_directory /usr/local/etc/squid/errors/local
</I>&gt;<i>
</I>&gt;<i> Thanks
</I>&gt;<i>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20210415/de47b848/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20210415/de47b848/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="023556.html">[squid-users] allow update domain and block everything else
</A></li>
	<LI>Next message (by thread): <A HREF="023561.html">[squid-users] allow update domain and block everything else
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23560">[ date ]</a>
              <a href="thread.html#23560">[ thread ]</a>
              <a href="subject.html#23560">[ subject ]</a>
              <a href="author.html#23560">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
