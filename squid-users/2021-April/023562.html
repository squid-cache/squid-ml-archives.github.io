<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] All Adaptation ICAPs go down at the same time
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20All%20Adaptation%20ICAPs%20go%20down%20at%20the%20same%20time&In-Reply-To=%3C000001d734fb%246081bd70%2421853850%24%40gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="023542.html">
   <LINK REL="Next"  HREF="023555.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] All Adaptation ICAPs go down at the same time</H1>
    <B>Eliezer Croitoru</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20All%20Adaptation%20ICAPs%20go%20down%20at%20the%20same%20time&In-Reply-To=%3C000001d734fb%246081bd70%2421853850%24%40gmail.com%3E"
       TITLE="[squid-users] All Adaptation ICAPs go down at the same time">ngtech1ltd at gmail.com
       </A><BR>
    <I>Mon Apr 19 09:07:08 UTC 2021</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="023542.html">[squid-users] All Adaptation ICAPs go down at the same time
</A></li>
        <LI>Next message (by thread): <A HREF="023555.html">[squid-users] ssl bump Cannot create /var/lib/squid/ssl_db
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23562">[ date ]</a>
              <a href="thread.html#23562">[ thread ]</a>
              <a href="subject.html#23562">[ subject ]</a>
              <a href="author.html#23562">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hey Roie,

 

&gt;<i>From the output I assume it&#8217;s a dns resolution issue.
</I>
In the past I remember that Docker was updating the hosts file with the relevant names but  it&#8217;s not working the same way now.

Currently Docker is using a local network dns service which is being accessed via 127.0.0.53.

&gt;<i>From I remember Squid is resolving the icap service name only at startup or reload.
</I>
Lately Alex published a testable patch that might fix specific issues with icap services which are resolved by dns. ( sorry I don&#8217;t remember the bug report)

I assume you can try to test this patch first.

If these services are static to some degree you might be able to create a script that updates the hosts file and reload squid on each change.

When using the hosts file it&#8217;s possible that some issues will disappear.


There is also another possibility which is a malformed ICAP response or wrong sessions handling which cause this issue.

You might be able to use tcpdump from either the host or the container side to capture traffic when these goes down.

Depends on your preference of debug level you might even be able to debug specific debug_options like for ICAP services
and/or requests to the degree you might be able to see what happens on the basic level of the ICAP encapsulation.

If you really need help with a diagnosis and a solution you might be able to use Alex and the measurement factory.



All The Bests,

Eliezer

 

From: squid-users &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>&gt; On Behalf Of roie rachamim
Sent: Monday, April 12, 2021 12:54 PM
To: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
Subject: [squid-users] All Adaptation ICAPs go down at the same time

 

Hi,

 

Our setup includes squid that runs in docker container with several ICAP servers in additional containers.

&gt;<i>From time to time we see in cache.log the following messages:
</I>2021/04/12 00:22:39| optional ICAP service is down after an options fetch failure: <A HREF="icap://icap1.proxy:14590/censor">icap://icap1.proxy:14590/censor</A> [down,!opt]
2021/04/12 00:22:39| optional ICAP service is down after an options fetch failure: <A HREF="icap://icap2.proxy:1344/request">icap://icap2.proxy:1344/request</A> [down,!opt]
2021/04/12 00:22:39| optional ICAP service is down after an options fetch failure: <A HREF="icap://icap3.proxy:14590/response">icap://icap3.proxy:14590/response</A> [down,!opt]

2021/04/12 06:10:45| optional ICAP service is down after an options fetch failure: <A HREF="icap://icap1.proxy:14590/censor">icap://icap1.proxy:14590/censor</A> [down,!opt]
2021/04/12 06:10:45| optional ICAP service is down after an options fetch failure: <A HREF="icap://icap2.proxy:1344/request">icap://icap2.proxy:1344/request</A> [down,!opt]
2021/04/12 06:10:45| optional ICAP service is down after an options fetch failure: <A HREF="icap://icap3.proxy:14590/response">icap://icap3.proxy:14590/response</A> [down,!opt]

 

We're trying to understand why it happens to all ICAPs at once. This happens in 4.14 and in 5.0.4

Any thoughts about what might cause this ?

Many Thanks,

Roie

-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20210419/4513191b/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20210419/4513191b/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="023542.html">[squid-users] All Adaptation ICAPs go down at the same time
</A></li>
	<LI>Next message (by thread): <A HREF="023555.html">[squid-users] ssl bump Cannot create /var/lib/squid/ssl_db
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23562">[ date ]</a>
              <a href="thread.html#23562">[ thread ]</a>
              <a href="subject.html#23562">[ subject ]</a>
              <a href="author.html#23562">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
