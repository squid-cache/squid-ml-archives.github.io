<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Client certificate authentication problem
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Client%20certificate%20authentication%20problem&In-Reply-To=%3CCAF7xqN7TiWhdZS_WJjkROWrL_0SYYGvta0V6dGdNDs%2B_csZH%2Bw%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="023568.html">
   <LINK REL="Next"  HREF="023582.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Client certificate authentication problem</H1>
    <B>Neven Vrenko</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Client%20certificate%20authentication%20problem&In-Reply-To=%3CCAF7xqN7TiWhdZS_WJjkROWrL_0SYYGvta0V6dGdNDs%2B_csZH%2Bw%40mail.gmail.com%3E"
       TITLE="[squid-users] Client certificate authentication problem">neven.vrenko at gmail.com
       </A><BR>
    <I>Fri Apr 30 08:40:50 UTC 2021</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="023568.html">[squid-users] Client certificate authentication problem
</A></li>
        <LI>Next message (by thread): <A HREF="023582.html">[squid-users] Client certificate authentication problem
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23581">[ date ]</a>
              <a href="thread.html#23581">[ thread ]</a>
              <a href="subject.html#23581">[ subject ]</a>
              <a href="author.html#23581">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello Alex,

thank you for your answer. I was little bit puzzled since I haven't got any
error when using &quot;clientca&quot; with &quot;http_port&quot;. I thought, maybe it was
somehow possible, beyond my understanding. :)

The reason why I didn't respond immediately, because I wanted to test
everything with the &quot;https_port&quot; configuration.

Now my configuration looks like this:

&gt;<i> https_port 443 tls-cert=/etc/squid/certs/new-squid.cert
</I>tls-key=/etc/squid/certs/new-squid.key clientca=/etc/squid/certs/autn.pem
capath=/etc/squid/certs/CAs sslcontext=id

This works...

What I'm trying to do is access control with *user_cert* ACL based on CN
information.

My ACL configuration is super minimal:

&gt;<i> acl ssl_auth user_cert CN &quot;/etc/squid/allowed.cn&quot;
</I>&gt;<i> http_access allow ssl_auth
</I>&gt;<i>
</I>&gt;<i> http_access deny all
</I>
File &quot;/etc/squid/allowed.cn&quot; contains one row/entry: &quot;Doe John PKI
1234567890&quot; (without quotes)

However this doesn't work.

&gt;<i>From the cache.log, it is visible that client certificate information is
</I>fetched:

&gt;<i> clientNegotiateSSL: New session 0x11415a0 on FD 12 (10.x.x.x:60308)
</I>&gt;<i> retrieveNegotiatedInfo: SSL connection info on FD 12 SSL version TLS/1.2
</I>negotiated cipher AES128-GCM-SHA256
&gt;<i> clientNegotiateSSL: FD 12 client certificate: subject: /DC=tst/CN=Doe
</I>John PKI 1234567890
&gt;<i> clientNegotiateSSL: FD 12 client certificate: issuer:
</I>/DC=com/DC=tst/DC=PKI/CN=CA-AUTH-01
&gt;<i> Server.cc(90) readSomeData: conn7 local=10.x.x.x:443
</I>remote=10.x.x.x:60308 FD 12 flags=1: reading request...

&gt;<i>From the cache.log is as well visible that ssl_auth ACL is checked, but
</I>there is NO MATCH:

&gt;<i> Acl.cc(124) matches: checking http_access
</I>&gt;<i> Checklist.cc(398) bannedAction: Action 'ALLOWED/0' is not banned
</I>&gt;<i> Acl.cc(124) matches: checking http_access#1
</I>&gt;<i> Acl.cc(124) matches: checking ssl_auth     &lt; --- Access list
</I>&gt;<i>
</I>&gt;<i> CertificateData.cc(68) match: CN=Doe John PKI 1234567890   &lt; --- Client
</I>certificate CN
&gt;<i>
</I>&gt;<i> MemBlob.cc(56) MemBlob: constructed, this=0x14dccc0 id=blob1388
</I>reserveSize=35
&gt;<i> MemBlob.cc(101) memAlloc: blob1388 memAlloc: requested=35, received=40
</I>&gt;<i> SBuf.cc(866) reAlloc: SBuf5096 new store capacity: 40
</I>&gt;<i> StringData.cc(33) match: aclMatchStringList: checking 'Doe John PKI
</I>1234567890'
&gt;<i>
</I>&gt;<i> StringData.cc(36) match: aclMatchStringList: 'Doe John PKI 1234567890'
</I>NOT found   &lt; --- doesn't match
&gt;<i>
</I>&gt;<i> Acl.cc(151) matches: checked: ssl_auth = 0
</I>&gt;<i> Acl.cc(151) matches: checked: http_access#1 = 0
</I>

I'm really not sure what I have missed...
I tried to put CN directly in the ACL, so with no reference to thefile.
I tried to put single and double quotes around CN in allowed.cn file, as
well.

Could you please help me further? What am I doing wrong here?

Thank you and regards,
Neven
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20210430/f6af83eb/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20210430/f6af83eb/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="023568.html">[squid-users] Client certificate authentication problem
</A></li>
	<LI>Next message (by thread): <A HREF="023582.html">[squid-users] Client certificate authentication problem
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23581">[ date ]</a>
              <a href="thread.html#23581">[ thread ]</a>
              <a href="subject.html#23581">[ subject ]</a>
              <a href="author.html#23581">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
