<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Client certificate authentication problem
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Client%20certificate%20authentication%20problem&In-Reply-To=%3C248ca98d-1862-0ead-87c0-67a0aa408ea8%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="023581.html">
   <LINK REL="Next"  HREF="023569.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Client certificate authentication problem</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Client%20certificate%20authentication%20problem&In-Reply-To=%3C248ca98d-1862-0ead-87c0-67a0aa408ea8%40measurement-factory.com%3E"
       TITLE="[squid-users] Client certificate authentication problem">rousskov at measurement-factory.com
       </A><BR>
    <I>Fri Apr 30 15:22:03 UTC 2021</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="023581.html">[squid-users] Client certificate authentication problem
</A></li>
        <LI>Next message (by thread): <A HREF="023569.html">[squid-users] Errors Compiling Squid on Windows Server using Cygwin
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23582">[ date ]</a>
              <a href="thread.html#23582">[ thread ]</a>
              <a href="subject.html#23582">[ subject ]</a>
              <a href="author.html#23582">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 4/30/21 4:40 AM, Neven Vrenko wrote:
&gt;<i> Hello Alex,
</I>&gt;<i> 
</I>&gt;<i> thank you for your answer. I was little bit puzzled since I haven't got
</I>&gt;<i> any error when using &quot;clientca&quot; with &quot;http_port&quot;. I thought, maybe it
</I>&gt;<i> was somehow possible, beyond my understanding. :)
</I>&gt;<i> 
</I>&gt;<i> The reason why I didn't respond immediately, because I wanted to test
</I>&gt;<i> everything with the &quot;https_port&quot; configuration.
</I>&gt;<i> 
</I>&gt;<i> Now my configuration looks like this:
</I>&gt;<i> 
</I>&gt;&gt;<i> https_port 443 tls-cert=/etc/squid/certs/new-squid.cert
</I>&gt;<i> tls-key=/etc/squid/certs/new-squid.key
</I>&gt;<i> clientca=/etc/squid/certs/autn.pem capath=/etc/squid/certs/CAs sslcontext=id
</I>&gt;<i> 
</I>&gt;<i> This works...
</I>&gt;<i> 
</I>&gt;<i> What I'm trying to do is access control with *user_cert* ACL based on CN
</I>&gt;<i> information.
</I>&gt;<i> 
</I>&gt;<i> My ACL configuration is super minimal:
</I>&gt;<i> 
</I>&gt;&gt;<i> acl ssl_auth user_cert CN &quot;/etc/squid/allowed.cn &lt;<A HREF="http://allowed.cn">http://allowed.cn</A>&gt;&quot;
</I>&gt;&gt;<i> http_access allow ssl_auth
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> http_access deny all
</I>&gt;<i> 
</I>&gt;<i> File &quot;/etc/squid/allowed.cn&quot; contains one row/entry:
</I>&gt;<i> &quot;Doe John PKI 1234567890&quot; (without quotes)
</I>&gt;<i> 
</I>&gt;<i> However this doesn't work.
</I>&gt;<i> 
</I>&gt;<i> From the cache.log, it is visible that client certificate information is
</I>&gt;<i> fetched:
</I>&gt;<i> 
</I>&gt;&gt;<i> clientNegotiateSSL: New session 0x11415a0 on FD 12 (10.x.x.x:60308)
</I>&gt;&gt;<i> retrieveNegotiatedInfo: SSL connection info on FD 12 SSL version
</I>&gt;<i> TLS/1.2 negotiated cipher AES128-GCM-SHA256
</I>&gt;&gt;<i> clientNegotiateSSL: FD 12 client certificate: subject: /DC=tst/CN=Doe
</I>&gt;<i> John PKI 1234567890
</I>&gt;&gt;<i> clientNegotiateSSL: FD 12 client certificate: issuer:
</I>&gt;<i> /DC=com/DC=tst/DC=PKI/CN=CA-AUTH-01
</I>&gt;&gt;<i> Server.cc(90) readSomeData: conn7 local=10.x.x.x:443
</I>&gt;<i> remote=10.x.x.x:60308 FD 12 flags=1: reading request...
</I>&gt;<i> 
</I>&gt;<i> From the cache.log is as well visible that ssl_auth ACL is checked, but
</I>&gt;<i> there is NO MATCH:
</I>&gt;<i> 
</I>&gt;&gt;<i> Acl.cc(124) matches: checking http_access
</I>&gt;&gt;<i> Checklist.cc(398) bannedAction: Action 'ALLOWED/0' is not banned
</I>&gt;&gt;<i> Acl.cc(124) matches: checking http_access#1
</I>&gt;&gt;<i> Acl.cc(124) matches: checking ssl_auth&#160;&#160;&#160;&#160; &lt; --- Access list
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> CertificateData.cc(68) match: CN=Doe John PKI 1234567890&#160;&#160; &lt; ---
</I>&gt;<i> Client certificate CN
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> MemBlob.cc(56) MemBlob: constructed, this=0x14dccc0 id=blob1388
</I>&gt;<i> reserveSize=35
</I>&gt;&gt;<i> MemBlob.cc(101) memAlloc: blob1388 memAlloc: requested=35, received=40
</I>&gt;&gt;<i> SBuf.cc(866) reAlloc: SBuf5096 new store capacity: 40
</I>&gt;&gt;<i> StringData.cc(33) match: aclMatchStringList: checking 'Doe John PKI
</I>&gt;<i> 1234567890'
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> StringData.cc(36) match: aclMatchStringList: 'Doe John PKI 1234567890'
</I>&gt;<i> NOT found&#160;&#160; &lt; --- doesn't match
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Acl.cc(151) matches: checked: ssl_auth = 0
</I>&gt;&gt;<i> Acl.cc(151) matches: checked: http_access#1 = 0
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> I'm really not sure what I have missed...
</I>&gt;<i> I tried to put CN directly in the ACL, so with no reference to thefile.
</I>&gt;<i> I tried to put single and double quotes around CN in allowed.cn
</I>&gt;<i> &lt;<A HREF="http://allowed.cn">http://allowed.cn</A>&gt; file, as well.
</I>&gt;<i> 
</I>&gt;<i> Could you please help me further? What am I doing wrong here?
</I>
I see no red flags in what you are describing and in the provided logs.
Unfortunately, ACLStringData::match() does not log the strings it is
comparing the configured ACL value against, and I lack the free time
necessary to triage this further for you right now. Hopefully, somebody
else will volunteer to triage this. It should not be very difficult to
get to the bottom of it.


Sorry,

Alex.

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="023581.html">[squid-users] Client certificate authentication problem
</A></li>
	<LI>Next message (by thread): <A HREF="023569.html">[squid-users] Errors Compiling Squid on Windows Server using Cygwin
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23582">[ date ]</a>
              <a href="thread.html#23582">[ thread ]</a>
              <a href="subject.html#23582">[ subject ]</a>
              <a href="author.html#23582">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
