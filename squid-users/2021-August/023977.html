<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] ftp_port and squidclamav
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20ftp_port%20and%20squidclamav&In-Reply-To=%3C5eef8506-331d-a5cd-0204-2553b671c97b%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="023976.html">
   <LINK REL="Next"  HREF="023978.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] ftp_port and squidclamav</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20ftp_port%20and%20squidclamav&In-Reply-To=%3C5eef8506-331d-a5cd-0204-2553b671c97b%40measurement-factory.com%3E"
       TITLE="[squid-users] ftp_port and squidclamav">rousskov at measurement-factory.com
       </A><BR>
    <I>Sat Aug 28 15:10:23 UTC 2021</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="023976.html">[squid-users] ftp_port and squidclamav
</A></li>
        <LI>Next message (by thread): <A HREF="023978.html">[squid-users] Setting Squid to work with a remote DB?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23977">[ date ]</a>
              <a href="thread.html#23977">[ thread ]</a>
              <a href="subject.html#23977">[ subject ]</a>
              <a href="author.html#23977">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 8/28/21 8:36 AM, Andrea Venturoli wrote:

&gt;<i> I've got Squid (4.15) configured as an HTTP[s] server, with squidclamav:
</I>
&gt;&gt;<i> icap_enable on
</I>&gt;&gt;<i> icap_send_client_ip on
</I>&gt;&gt;<i> icap_preview_enable on
</I>&gt;&gt;<i> icap_preview_size 1024
</I>&gt;&gt;<i> icap_service service_req reqmod_precache bypass=0 <A HREF="icap://127.0.0.1:1344/squidclamav">icap://127.0.0.1:1344/squidclamav</A>
</I>&gt;&gt;<i> adaptation_access service_req allow all
</I>&gt;&gt;<i> icap_service service_resp respmod_precache bypass=0 <A HREF="icap://127.0.0.1:1344/squidclamav">icap://127.0.0.1:1344/squidclamav</A>
</I>&gt;&gt;<i> adaptation_access service_resp allow all
</I>
&gt;<i> Everything is fine on this side.
</I>
&gt;<i> Now I'm trying to make it act as an FTP proxy, with:
</I>
&gt;&gt;<i> ftp_port 2121
</I>
&gt;<i> This works partially: I'm usually able to see remote directories, but
</I>&gt;<i> uploads will fail (timing out on the client side).
</I>
&gt;<i> If I disable ICAP at all (comment the above lines), then the FTP proxy
</I>&gt;<i> works properly.
</I>
This can be a Squid bug or an ICAP service bug/incompatibility with fake
HTTP messages that Squid is using to represent native FTP traffic. FWIW,
the mapping between native FTP traffic (that Squid sees) and fake HTTP
messages (that your ICAP service sees) is described at
<A HREF="https://wiki.squid-cache.org/Features/FtpRelay">https://wiki.squid-cache.org/Features/FtpRelay</A>


&gt;<i> I'm failing to understand the interaction between the two: even simple
</I>&gt;<i> files fail to upload and I see no signs of ClamAV taking much time to
</I>&gt;<i> scan them.
</I>&gt;<i> Is this some known problem?
</I>
FWIW, I am not aware of it.


&gt;<i> Any suggestion on how to gain a better understanding?
</I>
Reproduce the problem using a single transaction on an otherwise idle
Squid with full debugging enabled and share the corresponding cache.log:
<A HREF="https://wiki.squid-cache.org/SquidFaq/BugReporting#Debugging_a_single_transaction">https://wiki.squid-cache.org/SquidFaq/BugReporting#Debugging_a_single_transaction</A>

If the above is not feasible, collect ICAP requests and responses for
the failing transaction and share them instead (a packet capture may be
the easiest way to do that, but you can also try ALL,2 debugging if you
can reproduce with a single transaction on an otherwise idle Squid).


&gt;<i> Or, is there any way I can tell Squid to avoid passing FTP traffic
</I>&gt;<i> (coming on port 2121) to ICAP (while of course doing that for the rest)?
</I>
Yes, the adaptation_access directive controls what traffic goes to your
ICAP services. To match ftp_port traffic, I would give the ftp_port a
name and then try using that name in a myportname ACL. Other ACLs may
also work, but I would start with myportname. If myportname does not
work for ftp_port traffic, it is a Squid bug.


HTH,

Alex.

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="023976.html">[squid-users] ftp_port and squidclamav
</A></li>
	<LI>Next message (by thread): <A HREF="023978.html">[squid-users] Setting Squid to work with a remote DB?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23977">[ date ]</a>
              <a href="thread.html#23977">[ thread ]</a>
              <a href="subject.html#23977">[ subject ]</a>
              <a href="author.html#23977">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
