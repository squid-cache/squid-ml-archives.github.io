From kinkie at squid-cache.org  Wed Dec  1 07:38:50 2021
From: kinkie at squid-cache.org (Francesco Chemolli)
Date: Wed, 1 Dec 2021 07:38:50 +0000
Subject: [squid-users] [NOC] Squid Proxy stable version
In-Reply-To: <MN2P114MB122569A4D6F82173D1573E1D8B629@MN2P114MB1225.NAMP114.PROD.OUTLOOK.COM>
References: <MN2P114MB122569A4D6F82173D1573E1D8B629@MN2P114MB1225.NAMP114.PROD.OUTLOOK.COM>
Message-ID: <CA+Y8hcNeFYQFJ8yCAucSJVT+2JYZfg=n4K4sM28Bb4dMB7O7eg@mail.gmail.com>

Hi,
   the current stable version is 5.2 (http://www.squid-cache.org/Versions/).
In most cases upgrades are drop-in: save the configuration, replace the
package in your system, and restart squid. Any issues will be highlighted
in cache.log

Francesco

On Wed, Dec 1, 2021 at 7:23 AM Kumar Gupta, Sujeet C. <
sujeet.c.kumar.gupta at accenture.com> wrote:

> Hi Team,
>
>
>
> Can you please share the stable version of the Squid proxy. Also share the
> upgrade Path with Article.
>
> Is there any vulnerable in current version : 3.5.20 ?
>
>
>
> Current version : squid -v
>
> Squid Cache: Version 3.5.20
>
>
>
> *Thanks & Regards,*
>
> *Sujeet Gupta*
>
> Security Senior Analyst  |   Accenture Security
>
> Mobile:  +91 9910913565
>
> sujeet.c.kumar.gupta at accenture.com
>
> Email <sujeet.c.kumar.gupta at accenture.com> | Teams
>
> [image: A picture containing drawing Description automatically generated]
> [image: Image result for black twitter logo]
> <https://twitter.com/AccentureSecure>
> [image: Related image]
> <https://www.linkedin.com/showcase/accenture_security/>
>
>
>
>
> ------------------------------
>
> This message is for the designated recipient only and may contain
> privileged, proprietary, or otherwise confidential information. If you have
> received it in error, please notify the sender immediately and delete the
> original. Any other use of the e-mail by you is prohibited. Where allowed
> by local law, electronic communications with Accenture and its affiliates,
> including e-mail and instant messaging (including content), may be scanned
> by our systems for the purposes of information security and assessment of
> internal compliance with Accenture policy. Your privacy is important to us.
> Accenture uses your personal data only in compliance with data protection
> laws. For further information on how Accenture processes your personal
> data, please see our privacy statement at
> https://www.accenture.com/us-en/privacy-policy.
>
> ______________________________________________________________________________________
>
> www.accenture.com
> _______________________________________________
> NOC mailing list
> NOC at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/noc
>


-- 
    Francesco Chemolli
    Squid Software Foundation
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20211201/cc2d3958/attachment.htm>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: image004.png
Type: image/png
Size: 2077 bytes
Desc: not available
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20211201/cc2d3958/attachment.png>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: image005.png
Type: image/png
Size: 601 bytes
Desc: not available
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20211201/cc2d3958/attachment-0001.png>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: image006.png
Type: image/png
Size: 434 bytes
Desc: not available
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20211201/cc2d3958/attachment-0002.png>

From david at articatech.com  Wed Dec  1 17:06:40 2021
From: david at articatech.com (David Touzeau)
Date: Wed, 1 Dec 2021 18:06:40 +0100
Subject: [squid-users] security_file_certgen I/O
Message-ID: <7ba71e9a-dfdd-e2bb-79cb-2f97eb09915b@articatech.com>


Hi

We used Squid 5.2 and we see that security_file_certgen consume I/O
Is there any way to put the ssldb in memory without need to mount a tmpfs ?

regards
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20211201/d67d0dad/attachment.htm>

From rousskov at measurement-factory.com  Wed Dec  1 18:29:16 2021
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Wed, 1 Dec 2021 13:29:16 -0500
Subject: [squid-users] security_file_certgen I/O
In-Reply-To: <7ba71e9a-dfdd-e2bb-79cb-2f97eb09915b@articatech.com>
References: <7ba71e9a-dfdd-e2bb-79cb-2f97eb09915b@articatech.com>
Message-ID: <3e786f1a-b370-d304-b3a6-ab10bcbac6da@measurement-factory.com>

On 12/1/21 12:06 PM, David Touzeau wrote:
> 
> Hi
> 
> We used Squid 5.2 and we see that security_file_certgen consume I/O
> Is there any way to put the ssldb in memory without need to mount a tmpfs ?

Yes, there are at least two other ways to reduce disk I/O related to
certificate generation:

1) Tell the official certificate generator helper not to cache the
generated certificates. See sslcrtd_program documentation for details.

2) Write your own certificate generator helper.

Alex.


From jason.spashett at menlosecurity.com  Wed Dec  1 18:55:21 2021
From: jason.spashett at menlosecurity.com (Jason Spashett)
Date: Wed, 1 Dec 2021 18:55:21 +0000
Subject: [squid-users] security_file_certgen I/O
In-Reply-To: <3e786f1a-b370-d304-b3a6-ab10bcbac6da@measurement-factory.com>
References: <7ba71e9a-dfdd-e2bb-79cb-2f97eb09915b@articatech.com>
 <3e786f1a-b370-d304-b3a6-ab10bcbac6da@measurement-factory.com>
Message-ID: <CANj0NToPe6ptViFJrHXi1sKascRS0uoP_7UMq_nhXOWzqJ-J2g@mail.gmail.com>

On Wed, 1 Dec 2021 at 18:29, Alex Rousskov
<rousskov at measurement-factory.com> wrote:
>
> On 12/1/21 12:06 PM, David Touzeau wrote:
> >
> > Hi
> >
> > We used Squid 5.2 and we see that security_file_certgen consume I/O
> > Is there any way to put the ssldb in memory without need to mount a tmpfs ?
>
> Yes, there are at least two other ways to reduce disk I/O related to
> certificate generation:
>
> 1) Tell the official certificate generator helper not to cache the
> generated certificates. See sslcrtd_program documentation for details.
>
> 2) Write your own certificate generator helper.
>
> Alex.

We have found that the certificate helpers perform strictly worse with
the disk cache turned on, over approximately 3 processes. It is
something that perhaps one day, with luck, we may be able to
contribute something. The problems are the way in which the disk cache
is stored and accessed.

I do have a large spreadsheet with some performance results, which (at
some point) I do plan to share.

I feel it's likely that the process of generating the certificates
could, or should be separate from their caching on disk (or in
memory). Currently the helper does both, and the disk caching does
seem detrimental in a multi process setting.
Another reason for separating these concerns is that some people may
wish to use HSM facilities (Hardware Security Module), and so it may
make sense to separate out the caching, and; in light of the
consideration that the HSM interface may vary widely, and require a
specific HSM helper type for each HSM.


From rousskov at measurement-factory.com  Wed Dec  1 19:03:45 2021
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Wed, 1 Dec 2021 14:03:45 -0500
Subject: [squid-users] security_file_certgen I/O
In-Reply-To: <CANj0NToPe6ptViFJrHXi1sKascRS0uoP_7UMq_nhXOWzqJ-J2g@mail.gmail.com>
References: <7ba71e9a-dfdd-e2bb-79cb-2f97eb09915b@articatech.com>
 <3e786f1a-b370-d304-b3a6-ab10bcbac6da@measurement-factory.com>
 <CANj0NToPe6ptViFJrHXi1sKascRS0uoP_7UMq_nhXOWzqJ-J2g@mail.gmail.com>
Message-ID: <8d757af8-5577-b33a-6d5a-feefce143b33@measurement-factory.com>

On 12/1/21 1:55 PM, Jason Spashett wrote:

> We have found that the certificate helpers perform strictly worse with
> the disk cache turned on, over approximately 3 processes. It is
> something that perhaps one day, with luck, we may be able to
> contribute something. The problems are the way in which the disk cache
> is stored and accessed.

Yes, there are many potential optimizations in that area. I hope these
performance problems can be reduced _without Squid code modifications_
by using RAM-based filesystems and/or multiple certificate databases
(e.g., one helper/database for each two workers).

Alex.


From squid3 at treenet.co.nz  Thu Dec  2 02:06:30 2021
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Thu, 2 Dec 2021 15:06:30 +1300
Subject: [squid-users] security_file_certgen I/O
In-Reply-To: <CANj0NToPe6ptViFJrHXi1sKascRS0uoP_7UMq_nhXOWzqJ-J2g@mail.gmail.com>
References: <7ba71e9a-dfdd-e2bb-79cb-2f97eb09915b@articatech.com>
 <3e786f1a-b370-d304-b3a6-ab10bcbac6da@measurement-factory.com>
 <CANj0NToPe6ptViFJrHXi1sKascRS0uoP_7UMq_nhXOWzqJ-J2g@mail.gmail.com>
Message-ID: <0716cede-4e88-8a79-7e3e-838ca68d8058@treenet.co.nz>

On 2/12/21 07:55, Jason Spashett wrote:
> On Wed, 1 Dec 2021 at 18:29, Alex Rousskov
> <rousskov at measurement-factory.com> wrote:
>>
>> On 12/1/21 12:06 PM, David Touzeau wrote:
>>>
>>> Hi
>>>
>>> We used Squid 5.2 and we see that security_file_certgen consume I/O
>>> Is there any way to put the ssldb in memory without need to mount a tmpfs ?
>>
>> Yes, there are at least two other ways to reduce disk I/O related to
>> certificate generation:
>>
>> 1) Tell the official certificate generator helper not to cache the
>> generated certificates. See sslcrtd_program documentation for details.
>>
>> 2) Write your own certificate generator helper.
>>
>> Alex.
> 
> We have found that the certificate helpers perform strictly worse with
> the disk cache turned on, over approximately 3 processes. It is
> something that perhaps one day, with luck, we may be able to
> contribute something. The problems are the way in which the disk cache
> is stored and accessed.

The "file" in the helper name means one file per object, which is quite 
crude type of storage but very easy to implement as a proof of concept 
helper.

As Alex mentioned there are a lot of optimizations that can still be 
made (and bugs to fix) with the current helper code - and still not be 
best possible performance still due to the "file" nature of storage and 
relatively slow nature of disk I/O.

Improvements here and/or new helper implementations with better forms of 
storage are welcome.


Cheers
Amos


From sebastian.kirschner at volkswagen-groupservices.com  Thu Dec  2 13:13:57 2021
From: sebastian.kirschner at volkswagen-groupservices.com (Kirschner, Sebastian (A-GTSI-DDP))
Date: Thu, 2 Dec 2021 13:13:57 +0000
Subject: [squid-users] Changing cache_log format
Message-ID: <VI1PR05MB556882A533B46E64C8881633D5699@VI1PR05MB5568.eurprd05.prod.outlook.com>

Hi all,
is it possible to change log_format of cache_log? We would like to add also timezone information to this kind of log by specifying local time:

2021/11/23 09:56:17| Logfile: opening log stdio:/var/log/squid/netdb.state

Mit freundlichen Gr??en / Best regards 
Sebastian Kirschner


From squid3 at treenet.co.nz  Thu Dec  2 15:54:51 2021
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Fri, 3 Dec 2021 04:54:51 +1300
Subject: [squid-users] Changing cache_log format
In-Reply-To: <VI1PR05MB556882A533B46E64C8881633D5699@VI1PR05MB5568.eurprd05.prod.outlook.com>
References: <VI1PR05MB556882A533B46E64C8881633D5699@VI1PR05MB5568.eurprd05.prod.outlook.com>
Message-ID: <0dca54d5-3b0c-846f-434a-6829285bf4ca@treenet.co.nz>

On 3/12/21 02:13, Kirschner, Sebastian (A-GTSI-DDP) wrote:
> Hi all,
> is it possible to change log_format of cache_log? We would like to add also timezone information to this kind of log by specifying local time:
> 
> 2021/11/23 09:56:17| Logfile: opening log stdio:/var/log/squid/netdb.state
> 

No. TZ is omitted for privacy when sharing these logs.

The log time is UTC. If you wish to covert it to anything else use a 
converter script to read the file. Same should be done to covert the 
access.log machine timestamp to human readable.

Amos


From rousskov at measurement-factory.com  Thu Dec  2 16:15:15 2021
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Thu, 2 Dec 2021 11:15:15 -0500
Subject: [squid-users] security_file_certgen I/O
In-Reply-To: <0716cede-4e88-8a79-7e3e-838ca68d8058@treenet.co.nz>
References: <7ba71e9a-dfdd-e2bb-79cb-2f97eb09915b@articatech.com>
 <3e786f1a-b370-d304-b3a6-ab10bcbac6da@measurement-factory.com>
 <CANj0NToPe6ptViFJrHXi1sKascRS0uoP_7UMq_nhXOWzqJ-J2g@mail.gmail.com>
 <0716cede-4e88-8a79-7e3e-838ca68d8058@treenet.co.nz>
Message-ID: <314ba866-ecb5-07d0-f8ac-4bff1e5c6337@measurement-factory.com>

On 12/1/21 9:06 PM, Amos Jeffries wrote:

> The "file" in the helper name means one file per object, which is quite
> crude type of storage but very easy to implement as a proof of concept
> helper.
> 
> As Alex mentioned there are a lot of optimizations that can still be
> made (and bugs to fix) with the current helper code - and still not be
> best possible performance still due to the "file" nature of storage and
> relatively slow nature of disk I/O.
> 
> Improvements here and/or new helper implementations with better forms of
> storage are welcome.

I agree regarding generally useful improvements being welcomed.

I disagree regarding alternative implementations: The Project does not
have enough resources to properly support one implementation, so adding
another one does not sound like the best move at this time. Needless to
say, such unofficial alternatives can happily exist outside the Project,
where we do not have to support/maintain them. If somebody wants to
develop a second official certificate generator despite these concerns,
they should start with an RFC on squid-dev (rather than spending
resources on that at-risk-of-being-rejected development).


Cheers,

Alex.


From paulo_baptista at brown.edu  Mon Dec  6 14:13:24 2021
From: paulo_baptista at brown.edu (Baptista, Paulo)
Date: Mon, 6 Dec 2021 09:13:24 -0500
Subject: [squid-users] TLS whitelist traffic based on URL_REGEX
Message-ID: <CAMKPAzh7RY-F+Ujj+yJifpstTysx7wNEMQLZNOhKN9mEUvZCKw@mail.gmail.com>

Hello,

Is it possible to create ACL, using URL_REGEX, for SQUID when using
SSLBUMP for HTTPS sites? If so, is there a guide I can follow?

I am running Squid 3.5.20

Thanks,

Paulo
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20211206/a2d54e21/attachment.htm>

From numsys at free.fr  Mon Dec  6 20:03:09 2021
From: numsys at free.fr (FredB)
Date: Mon, 6 Dec 2021 21:03:09 +0100
Subject: [squid-users] Squid 4.16, docker many CLOSE_WAIT
Message-ID: <cf5d8053-7f7d-36b8-a218-58811702daba@free.fr>

Hello,

I'm struggling with close_wait and squid in docker, after some hours I 
have thousand of close_wait , a lot more than the others status

I tried some sysctl options but without more success, I guess because 
the close_wait can be related to my clients (many simultaneous)

Maybe this is related with docker, for now I don't know, but after a 
while some "randomly" users can't reach some https websites, it's like 
the session is just dropped without any information in cache.log

As a quick fix I'm thinking about client_lifetime, reduce the value to 4 
hours -> Just to calm my users and try to understand without stress

But I found nothing about impact, what happen exactly to a user when the 
time is out ?


Regards
Fred



From rousskov at measurement-factory.com  Mon Dec  6 23:13:27 2021
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Mon, 6 Dec 2021 18:13:27 -0500
Subject: [squid-users] Squid 4.16, docker many CLOSE_WAIT
In-Reply-To: <cf5d8053-7f7d-36b8-a218-58811702daba@free.fr>
References: <cf5d8053-7f7d-36b8-a218-58811702daba@free.fr>
Message-ID: <0b5b6075-220c-f8ee-c1bd-443d7c7ffcd3@measurement-factory.com>

On 12/6/21 3:03 PM, FredB wrote:

> I found nothing about impact, what happen exactly to a user when the
> [client_lifetime] time is out ?

Bugs notwithstanding, Squid closes the client-to-Squid TCP connection
when client_lifetime expires. If that happens in the middle of an HTTP
transaction (or tunnel), the client will get no or truncated response.


I have not checked this carefully, but, AFAICT, client_lifetime
documentation is rather misleading:

* The timer (re)starts with _each_ HTTP request received on the
client-to-Squid connection. A client might be able to keep a
client-to-Squid persistent connection open forever by sending
back-to-back HTTP requests to Squid forever, each short enough to avoid
triggering client_lifetime. This is not a "client" timeout (in a sense
Squid uses "client" in many other contexts) but a "client transaction"
timeout.

* Idle client-to-Squid persistent connections ignore client_lifetime.

* The timeout is also used for busy Squid-to-server connections. This is
not a "client" (or "server") timeout but more of a "transaction" timeout.


HTH,

Alex.
P.S. I doubt client_lifetime is a CLOSE_WAIT solution.


From squid3 at treenet.co.nz  Tue Dec  7 01:25:16 2021
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Tue, 7 Dec 2021 14:25:16 +1300
Subject: [squid-users] TLS whitelist traffic based on URL_REGEX
In-Reply-To: <CAMKPAzh7RY-F+Ujj+yJifpstTysx7wNEMQLZNOhKN9mEUvZCKw@mail.gmail.com>
References: <CAMKPAzh7RY-F+Ujj+yJifpstTysx7wNEMQLZNOhKN9mEUvZCKw@mail.gmail.com>
Message-ID: <6e868685-6668-739b-6475-c3190db71f5f@treenet.co.nz>

On 7/12/21 03:13, Baptista, Paulo wrote:
> Hello,
> 
> Is it possible to create ACL, using URL_REGEX, for SQUID when using 
> SSLBUMP?for HTTPS sites? If so, is there a guide I can follow?
> 

url_regex ACL works the same way for SSL-Bump'ed HTTPS and it does for 
HTTP. Once the TLS is decrypted what Squid is handling is a normal HTTP 
request with a https:// URL.


> I am running Squid 3.5.20
> 

Please upgrade. The current Squid release is v5.3.

When using SSL-Bump it is especially important to track the latest 
version(s) in order to be able to handle the volatile TLS protocol 
changes going on in the Internet these days.


Amos


From frio_cervesa at hotmail.com  Tue Dec  7 05:10:57 2021
From: frio_cervesa at hotmail.com (senor)
Date: Tue, 7 Dec 2021 05:10:57 +0000
Subject: [squid-users] process_name macro usage
Message-ID: <DM8PR01MB70166A089F8D61D5E41073AFF76E9@DM8PR01MB7016.prod.exchangelabs.com>

Hi All,

I'm attempting to use the process_name macro in include file names to isolate the worker-specific directives from the disker and coordinator. I have not found any references to directives that are required by those 2 processes. I'm currently doing a trial and error loop to determine best config but would appreciate any pointers. 

Some directives seem required due to leftover dependencies from pre-SMP days and I don't expect documentation on that. I don't want to do anything that shouldn't be production worthy so avoiding gotchas without the pain of discovering them is all I'm looking for.

Thanks
Senor

From numsys at free.fr  Tue Dec  7 07:11:20 2021
From: numsys at free.fr (FredB)
Date: Tue, 7 Dec 2021 08:11:20 +0100
Subject: [squid-users] Squid 4.16, docker many CLOSE_WAIT
In-Reply-To: <0b5b6075-220c-f8ee-c1bd-443d7c7ffcd3@measurement-factory.com>
References: <cf5d8053-7f7d-36b8-a218-58811702daba@free.fr>
 <0b5b6075-220c-f8ee-c1bd-443d7c7ffcd3@measurement-factory.com>
Message-ID: <04f3c12e-a1fa-38d0-7002-38242983f7ed@free.fr>

Thanks, I will try with one proxy

For now I'm trying with the latest version of docker without more success

Do you think a wrong configuration parameters related with close_wait 
could be set in squid ?

At the end of the days I have more than 35 000 close wait for each squid 
...




From numsys at free.fr  Tue Dec  7 08:03:31 2021
From: numsys at free.fr (FredB)
Date: Tue, 7 Dec 2021 09:03:31 +0100
Subject: [squid-users] Squid 4.16, docker many CLOSE_WAIT
In-Reply-To: <04f3c12e-a1fa-38d0-7002-38242983f7ed@free.fr>
References: <cf5d8053-7f7d-36b8-a218-58811702daba@free.fr>
 <0b5b6075-220c-f8ee-c1bd-443d7c7ffcd3@measurement-factory.com>
 <04f3c12e-a1fa-38d0-7002-38242983f7ed@free.fr>
Message-ID: <00f4fc0d-06de-43e2-8e88-97a4e9160b0c@free.fr>


Le 07/12/2021 ? 08:11, FredB a ?crit?:
> Thanks, I will try with one proxy
>
FI: The close_wait are well deleted, but I don't know if there is an 
important impact or not for my users

My browser was still connected to a secure website, but I did nothing




From numsys at free.fr  Tue Dec  7 11:13:04 2021
From: numsys at free.fr (FredB)
Date: Tue, 7 Dec 2021 12:13:04 +0100
Subject: [squid-users] Squid 4.16, docker many CLOSE_WAIT
In-Reply-To: <00f4fc0d-06de-43e2-8e88-97a4e9160b0c@free.fr>
References: <cf5d8053-7f7d-36b8-a218-58811702daba@free.fr>
 <0b5b6075-220c-f8ee-c1bd-443d7c7ffcd3@measurement-factory.com>
 <04f3c12e-a1fa-38d0-7002-38242983f7ed@free.fr>
 <00f4fc0d-06de-43e2-8e88-97a4e9160b0c@free.fr>
Message-ID: <d9fc7595-8139-714b-5ea5-0f3f5fc7392e@free.fr>

Do you think, client lifetime 1 minute works (there is no minimal value 
in documentation)

For testing purpose I'm trying in a test platform and I'm seeing no 
impact, for example download a large file is not interrupted

There is no error in squid parse but I found nothing in debug about 
lifetime



From squid3 at treenet.co.nz  Tue Dec  7 11:27:21 2021
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Wed, 8 Dec 2021 00:27:21 +1300
Subject: [squid-users] process_name macro usage
In-Reply-To: <DM8PR01MB70166A089F8D61D5E41073AFF76E9@DM8PR01MB7016.prod.exchangelabs.com>
References: <DM8PR01MB70166A089F8D61D5E41073AFF76E9@DM8PR01MB7016.prod.exchangelabs.com>
Message-ID: <b8c99ae2-7737-a3d8-d4d5-c854f193224c@treenet.co.nz>

On 7/12/21 18:10, senor wrote:
> Hi All,
> 
> I'm attempting to use the process_name macro in include file names to isolate the worker-specific directives from the disker and coordinator. I have not found any references to directives that are required by those 2 processes. I'm currently doing a trial and error loop to determine best config but would appreciate any pointers.
> 

I do not think this is a good idea. The special processes like these 
should be ignoring directives irrelevant to them. If they are not, then 
they will be affected by the default values for those directives even if 
you put your local config in a different include file.

The directives relevant to SMP-awareness are listed at 
<https://wiki.squid-cache.org/MultipleInstances>

Amos


From rousskov at measurement-factory.com  Tue Dec  7 13:51:21 2021
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Tue, 7 Dec 2021 08:51:21 -0500
Subject: [squid-users] Squid 4.16, docker many CLOSE_WAIT
In-Reply-To: <d9fc7595-8139-714b-5ea5-0f3f5fc7392e@free.fr>
References: <cf5d8053-7f7d-36b8-a218-58811702daba@free.fr>
 <0b5b6075-220c-f8ee-c1bd-443d7c7ffcd3@measurement-factory.com>
 <04f3c12e-a1fa-38d0-7002-38242983f7ed@free.fr>
 <00f4fc0d-06de-43e2-8e88-97a4e9160b0c@free.fr>
 <d9fc7595-8139-714b-5ea5-0f3f5fc7392e@free.fr>
Message-ID: <48442831-7c45-47f4-2371-83ad4c21d027@measurement-factory.com>

On 12/7/21 6:13 AM, FredB wrote:
> Do you think, client lifetime 1 minute works (there is no minimal value
> in documentation)

IIRC, Squid does not impose any special restrictions on client_lifetime
values. The type of that directive is time-units. In Squid v5+, that
time-units type is documented to support a minimum value of 1
millisecond. There is no corresponding v4 documentation, and I do not
recall what v4 actually supports, but it may be the same.

Needless to say, bugs notwithstanding, too small client_lifetime values
will kill too many innocent transactions. Please see my first response
on this thread for more caveats in the latest Squid code (I did not
check v4).

Alex.


From rousskov at measurement-factory.com  Tue Dec  7 13:59:45 2021
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Tue, 7 Dec 2021 08:59:45 -0500
Subject: [squid-users] process_name macro usage
In-Reply-To: <b8c99ae2-7737-a3d8-d4d5-c854f193224c@treenet.co.nz>
References: <DM8PR01MB70166A089F8D61D5E41073AFF76E9@DM8PR01MB7016.prod.exchangelabs.com>
 <b8c99ae2-7737-a3d8-d4d5-c854f193224c@treenet.co.nz>
Message-ID: <aac960f9-6d5e-beeb-59f2-83324b5269fa@measurement-factory.com>

On 12/7/21 6:27 AM, Amos Jeffries wrote:

> The directives relevant to SMP-awareness are listed at
> https://wiki.squid-cache.org/MultipleInstances

I do not see information on SMP awareness of modern Squid features on
the above wiki page. There is a lot more info about that at
https://wiki.squid-cache.org/Features/SmpScale#What_can_workers_share.3F

Alex.


From numsys at free.fr  Tue Dec  7 14:14:59 2021
From: numsys at free.fr (FredB)
Date: Tue, 7 Dec 2021 15:14:59 +0100 (CET)
Subject: [squid-users] Squid 4.16, docker many CLOSE_WAIT
In-Reply-To: <48442831-7c45-47f4-2371-83ad4c21d027@measurement-factory.com>
Message-ID: <1114506339.23055899.1638886499911.JavaMail.root@zimbra30-e5.priv.proxad.net>

s, but it may be the same.
> 
> Needless to say, bugs notwithstanding, too small client_lifetime
> values
> will kill too many innocent transactions. Please see my first
> response

Yes It's just for testing purpose, I'm seeing no impact but only for my usage case ...
For now I will try client_lifetime 4 hours in production to reduce the complaints and try to understand the close_wait issue 

 



From frio_cervesa at hotmail.com  Tue Dec  7 18:47:49 2021
From: frio_cervesa at hotmail.com (senor)
Date: Tue, 7 Dec 2021 18:47:49 +0000
Subject: [squid-users] process_name macro usage
In-Reply-To: <aac960f9-6d5e-beeb-59f2-83324b5269fa@measurement-factory.com>
References: <DM8PR01MB70166A089F8D61D5E41073AFF76E9@DM8PR01MB7016.prod.exchangelabs.com>
 <b8c99ae2-7737-a3d8-d4d5-c854f193224c@treenet.co.nz>
 <aac960f9-6d5e-beeb-59f2-83324b5269fa@measurement-factory.com>
Message-ID: <DM8PR01MB70164DB48D31CF99B3D913EEF76E9@DM8PR01MB7016.prod.exchangelabs.com>

Thanks Amos and Alex,

I am aware of those 2 links. They are the basis for what I think I know so far. What I'm really wanting though is which directives can be safely omitted from the disker and coordinator process config. As Amos pointed out there is the possibility of inadvertently allowing those processes to use defaults instead of "no config".

I will admit that the primary reason for this exercise is to remove anything with helpers from those processes due to helper design issues. They will eventually be re-coded but currently the disker and coordinator are starting the helpers needlessly. Using idle= is not an option here.

I'm open to alternative methods and agree that those processes should not act on directives that are not useful. I was under the impression that ${process_name} was for that purpose since it is not usable in conditionals. I guess it boils down to which directives are safe to apply to workers but not the others? I'm working with squid-4.16 and starting to test on 5.

Thanks again for the help
Senor

________________________________________
From: squid-users <squid-users-bounces at lists.squid-cache.org> on behalf of Alex Rousskov <rousskov at measurement-factory.com>
Sent: Tuesday, December 7, 2021 5:59 AM
To: squid-users at lists.squid-cache.org
Subject: Re: [squid-users] process_name macro usage

On 12/7/21 6:27 AM, Amos Jeffries wrote:

> The directives relevant to SMP-awareness are listed at
> https://wiki.squid-cache.org/MultipleInstances

I do not see information on SMP awareness of modern Squid features on
the above wiki page. There is a lot more info about that at
https://wiki.squid-cache.org/Features/SmpScale#What_can_workers_share.3F

Alex.
_______________________________________________
squid-users mailing list
squid-users at lists.squid-cache.org
http://lists.squid-cache.org/listinfo/squid-users


From rousskov at measurement-factory.com  Tue Dec  7 20:03:41 2021
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Tue, 7 Dec 2021 15:03:41 -0500
Subject: [squid-users] process_name macro usage
In-Reply-To: <DM8PR01MB70164DB48D31CF99B3D913EEF76E9@DM8PR01MB7016.prod.exchangelabs.com>
References: <DM8PR01MB70166A089F8D61D5E41073AFF76E9@DM8PR01MB7016.prod.exchangelabs.com>
 <b8c99ae2-7737-a3d8-d4d5-c854f193224c@treenet.co.nz>
 <aac960f9-6d5e-beeb-59f2-83324b5269fa@measurement-factory.com>
 <DM8PR01MB70164DB48D31CF99B3D913EEF76E9@DM8PR01MB7016.prod.exchangelabs.com>
Message-ID: <a51c8101-81e9-9686-51fa-6eb7cd92ae0c@measurement-factory.com>

On 12/7/21 1:47 PM, senor wrote:

> What I'm really wanting though is which directives can be safely
> omitted from the disker and coordinator process config

> I'm open to alternative methods and agree that those processes should
> not act on directives that are not useful.

I do not have a list, unfortunately. Eventually, Squid code will be
modified to do what you want automatically, but I am not aware of
anybody working on that right now. Until that happens, try using
process_number macros (at your own risk) to disable (or not enable)
unnecessary services.


> I was under the impression that ${process_name} was for that purpose

I do not think that was the intention. IIRC, we added that configuration
macro for naming kid-specific files. There is no configuration support
for detecting process _roles_ (which is what you need, ideally, for this
configuration hack to be stable across changes in the number of workers
and "squid -N" detours).

Alex.


From andre.bolinhas at articatech.com  Wed Dec  8 01:39:43 2021
From: andre.bolinhas at articatech.com (=?iso-8859-1?Q?Andr=E9_Bolinhas?=)
Date: Wed, 8 Dec 2021 01:39:43 -0000
Subject: [squid-users] deny squid to bump deny_info
Message-ID: <!&!AAAAAAAAAAAuAAAAAAAAAJJD97gEMN5Ch2HBNn/5W3IBAMO2jhD3dRHOtM0AqgC7tuYAAAAAAA4AABAAAAA/vsnzXWfeQoQx+2MBa2hmAQAAAAA=@articatech.com>

Hi
We use Squid v5 with ssl_bump to decrypt only google domains.
With a special configuration we also need to deny important websites. 
So far so good, but for performance reasons we don't want Squid to return
the error pages.
Since we have a lot of denied sites, it seems that Squid tries to bump
returned error pages, which increases the resource consumption of the
external plugin security_file_cert_gen considerably.
We have tried using a TCP_RESET deny_info but this does not fix the bump
operation

In this peace of log, you can see that squid is forcing bump for Access
Denied website under https:
2021/12/08 05:05:53.774 kid2| 85,5| client_side_request.cc(769)
clientAccessCheckDone: Access Denied: beacons2.gvt2.com:443
2021/12/08 05:05:53.774 kid2| 85,5| client_side_request.cc(770)
clientAccessCheckDone: AclMatchedName = all
2021/12/08 05:05:53.774 kid2| 83,7| LogTags.cc(57) update: TAG_NONE to
TCP_DENIED
2021/12/08 05:05:53.774 kid2| 28,4| FilledChecklist.cc(67)
~ACLFilledChecklist: ACLFilledChecklist destroyed 0x7ffc945c5b40
2021/12/08 05:05:53.774 kid2| 28,4| Checklist.cc(197) ~ACLChecklist:
ACLChecklist::~ACLChecklist: destroyed 0x7ffc945c5b40
2021/12/08 05:05:53.774 kid2| 85,5| client_side_request.cc(1461)
sslBumpAccessCheck: SslBump applies. Force bump action on error UNKNOWN
2021/12/08 05:05:53.774 kid2| 83,3| client_side_request.cc(1562)
sslBumpNeed: sslBump required: bump
2021/12/08 05:05:53.774 kid2| 73,3| HttpRequest.cc(683) storeId: sent back
effectiveRequestUrl: beacons2.gvt2.com:443
2021/12/08 05:05:53.774 kid2| 24,7| SBuf.cc(160) rawSpace: reserving 1 for
SBuf77493929
2021/12/08 05:05:53.774 kid2| 24,7| SBuf.cc(866) reAlloc: SBuf77493929 new
store capacity: 40
2021/12/08 05:05:53.774 kid2| 20,3| store.cc(769) storeCreatePureEntry:
storeCreateEntry: 'beacons2.gvt2.com:443'
2021/12/08 05:05:53.774 kid2| 20,5| store.cc(349) StoreEntry: StoreEntry
constructed, this=0x5561d9347e90
2021/12/08 05:05:53.774 kid2| 20,3| MemObject.cc(100) MemObject: MemObject
constructed, this=0x5561d5e66f50
2021/12/08 05:05:53.774 kid2| 55,7| HttpHeader.cc(155) HttpHeader: init-ing
hdr: 0x5561d80af128 owner: 3
2021/12/08 05:05:53.774 kid2| 88,3| MemObject.cc(83) setUris: 0x5561d5e66f50
storeId: beacons2.gvt2.com:443
2021/12/08 05:05:53.774 kid2| 24,7| SBuf.cc(85) assign: assigning
SBuf77493930 from SBuf77493860
2021/12/08 05:05:53.774 kid2| 20,3| store.cc(443) lock: storeCreateEntry
locked key [null_store_key] e:=V/0x5561d9347e90*1
2021/12/08 05:05:53.774 kid2| 20,3| store.cc(569) setPrivateKey: 01
e:=V/0x5561d9347e90*1
2021/12/08 05:05:53.774 kid2| 20,3| store.cc(421) hashInsert:
StoreEntry::hashInsert: Inserting Entry e:=XIV/0x5561d9347e90*1 key
'71570400000000002412000002000000'
2021/12/08 05:05:53.774 kid2| 83,3| client_side_request.cc(1562)
sslBumpNeed: sslBump required: client-first
2021/12/08 05:05:53.774 kid2| 33,4| ServerBump.cc(28) ServerBump: will peek
at beacons2.gvt2.com:443
2021/12/08 05:05:53.774 kid2| 20,3| store.cc(443) lock: Ssl::ServerBump
locked key 71570400000000002412000002000000 e:=XIV/0x5561d9347e90*2
2021/12/08 05:05:53.774 kid2| 4,4| errorpage.cc(720) errorAppendEntry:
storing TEMPLATE_5 in e:=XIV/0x5561d9347e90*2
2021/12/08 05:05:53.774 kid2| 55,7| HttpHeader.cc(155) HttpHeader: init-ing
hdr: 0x5561d66a8078 owner: 3
2021/12/08 05:05:53.774 kid2| 4,2| errorpage.cc(1389) buildBody: No existing
error page language negotiated for TEMPLATE_5. Using default error file.

Ssl.conf
# SSL used for port ID 1, :3128 on
# Patch 2020 - 08 - 03 SquidMikrotikEnabled = 0 # SSL Proxy options  Proxy
version:5.2 [134] sslcrtd_program /lib/squid3/security_file_certgen
sslcrtd_children 32 startup=5 idle=1 queue-size=64 #The AppStore application
in IOS (iPhone, iPad, MacOS) uses SSL Certificate Pinning, #it means the
application knows what certificate to expect when accessing AppStore.
#When you enable SSL Bump of HTTPS connections Squid replaces the default
certificate with a  ^`^xmimicked ^`^y one;

#the application detects that and refuses to function.
#
acl FakeCert ssl::server_name .apple.com acl FakeCert ssl::server_name
.icloud.com acl FakeCert ssl::server_name .mzstatic.com acl FakeCert
ssl::server_name .dropbox.com acl FakeCert ssl::server_name .bnpparisbas acl
notbump ssl::server_name .redtube.com acl ssl_step1 at_step SslBump1 acl
ssl_step2 at_step SslBump2 acl ssl_step3 at_step SslBump3

acl Me dst 127.0.0.1 192.168.58.11
acl GlobalWhitelistDSTNet dst "/etc/squid3/acls_whitelist.dst.conf"

ssl_bump splice notbump all
ssl_bump splice GlobalWhitelistDSTNet

ssl_bump splice ssl_step1 Me
ssl_bump splice ByPassRBL
ssl_bump splice FakeCert

# SNI Group sni_domains/ssl_sni
# id:7 Type: ssl_sni
acl SNIGroup7 ssl::server_name_regex -i account\.google\.com acl SNIGroup7
ssl::server_name_regex -i accounts\.google\.com ssl_bump peek ssl_step1 all
# 0 Splice rules...
ssl_bump splice ByPassRBL
ssl_bump splice GlobalWhitelistDSTNet

# Rules (spliced) added by admins....

# 1 BUMP rules...
ssl_bump bump ssl_step2 SNIGroup7
ssl_bump splice all

tls_outgoing_options options=NO_SSLv3,NO_TICKET
cipher=ALL:!SSLv2:!SSLv3:!ADH:!DSS:!MD5:!EXP:!DES:!PSK:!SRP:!RC4:!IDEA:!SEED
:!aNULL:!eNULL flags=DONT_VERIFY_PEER sslproxy_cert_error allow all

http_access.conf
#### tcp_outgoing_tos ####
#### tcp_outgoing_tos 0 Rules ####
# SquidUrgency = 0 exec.squid.global.access.php[2233]
#       HaClusterClient=0 class.squid.acls.groups.inc/buildacls_order
#       mysql_for_port='' aclgpid=0 [L.174]
#       [3] rules [220]


# webfilters_sqacls #2 : aclport=0 (  ) [239] [class.squid.acls.groups.inc]
# [L.292]: rule id: 2 access_allow Port Direction=0 () # [L.320]:
class.squid.acls.groups.inc buildacls_bytype_items(2,..) acl AnnotateRule2
annotate_transaction accessrule=Rule2 http_access allow Group2 AnnotateRule2
# webfilters_sqacls #4 : aclport=0 (  ) [239] [class.squid.acls.groups.inc]
# [L.292]: rule id: 4 access_allow Port Direction=0 () # [L.320]:
class.squid.acls.groups.inc buildacls_bytype_items(4,..) acl AnnotateRule4
annotate_transaction accessrule=Rule4 http_access allow Group8 AnnotateRule4
# webfilters_sqacls #3 : aclport=0 (  ) [239] [class.squid.acls.groups.inc]
# [L.292]: rule id: 3 access_deny Port Direction=0 () # [L.320]:
class.squid.acls.groups.inc buildacls_bytype_items(3,..) # Template Enabled
for this ACL.
# Final acl is all, Template ID=1
acl AnnotateRule3 annotate_transaction accessrule=Rule3 http_access deny
CONNECT  AnnotateRule3 deny_info TCP_RESET AnnotateRule3

acl MyAll dst 0.0.0.0/0
http_access deny Myall
deny_info 302:http://artica/me Myall
#
#
# ------------------ HTTP ACCESS -------------------- # 0 rule(s) from
engine (Line 2240)


#
# SquidStandardLDAPAuth = 0
# EnableOpenLDAP = 0
# SquidRadiusAuth = 0
# LDAP_AUTH = 0 caused by EnableOpenLDAP acl MyBlockedIPs src
"/etc/squid3/acls/DenyIPSrc"
acl AnnotateWindowsUpdates annotate_transaction
accessrule=AllowWindowsUpdates http_access allow WindowsUpdates
AnnotateWindowsUpdates # # -------------------- AUTH Schemes Squid
v5.2-----------------------

# ----------------------------------------------------------

# LDAP Auth = 0
acl AnnotateSafePorts annotate_transaction accessrule=deny_remote_ports
http_access deny HTTP !Safe_ports all  AnnotateSafePorts http_access deny
CONNECT !SSL_ports all  AnnotateSafePorts deny_info TCP_RESET all

acl AnnotateBLK annotate_transaction accessrule=global_blacklist http_access
deny MyBlockedIPs AnnotateBLK http_access deny blockedsites AnnotateBLK
http_access deny DomainsBlackLists AnnotateBLK http_access deny
NetworksBlackLists AnnotateBLK include /etc/squid3/http_access_final.conf
# END http_access (defaults)



From rousskov at measurement-factory.com  Wed Dec  8 15:13:15 2021
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Wed, 8 Dec 2021 10:13:15 -0500
Subject: [squid-users] deny squid to bump deny_info
In-Reply-To: <!&!AAAAAAAAAAAuAAAAAAAAAJJD97gEMN5Ch2HBNn/5W3IBAMO2jhD3dRHOtM0AqgC7tuYAAAAAAA4AABAAAAA/vsnzXWfeQoQx+2MBa2hmAQAAAAA=@articatech.com>
References: <!&!AAAAAAAAAAAuAAAAAAAAAJJD97gEMN5Ch2HBNn/5W3IBAMO2jhD3dRHOtM0AqgC7tuYAAAAAAA4AABAAAAA/vsnzXWfeQoQx+2MBa2hmAQAAAAA=@articatech.com>
Message-ID: <58f4c84a-35ca-aa62-43bb-3c4d0fff939f@measurement-factory.com>

On 12/7/21 8:39 PM, Andr? Bolinhas wrote:

> We use Squid v5 with ssl_bump to decrypt only google domains. With a
> special configuration we also need to deny important websites. Squid
> tries to bump returned error pages

Yes, when SslBump encounters an error, it tries to bump the client
connection to deliver the error response.

One way to prevent that error handling algorithm from kicking in is to
close the offending client connection using an "ssl_bump terminate" rule
(instead[1] of blocking client access using "http_access").


> We have tried using a TCP_RESET deny_info but this does not fix the bump
> operation

I suspect the TCP_RESET feature is checked at error delivery time, after
the client connection is bumped to prepare it for error delivery. This
suspect behavior should be considered a Squid bug/deficiency IMO --
Squid should not be bumping the TLS connection to deliver a TCP RST or
FIN packet.

HTH,

Alex.
[1] It may be a good idea to also/still block client access using
http_access rules, as an additional safety layer, but it has to be done
carefully so that "ssl_bump terminate" rule matches _before_ any of the
corresponding "http_access deny" rules may match.



> In this peace of log, you can see that squid is forcing bump for Access
> Denied website under https:
> 2021/12/08 05:05:53.774 kid2| 85,5| client_side_request.cc(769)
> clientAccessCheckDone: Access Denied: beacons2.gvt2.com:443
> 2021/12/08 05:05:53.774 kid2| 85,5| client_side_request.cc(770)
> clientAccessCheckDone: AclMatchedName = all
> 2021/12/08 05:05:53.774 kid2| 83,7| LogTags.cc(57) update: TAG_NONE to
> TCP_DENIED
> 2021/12/08 05:05:53.774 kid2| 28,4| FilledChecklist.cc(67)
> ~ACLFilledChecklist: ACLFilledChecklist destroyed 0x7ffc945c5b40
> 2021/12/08 05:05:53.774 kid2| 28,4| Checklist.cc(197) ~ACLChecklist:
> ACLChecklist::~ACLChecklist: destroyed 0x7ffc945c5b40
> 2021/12/08 05:05:53.774 kid2| 85,5| client_side_request.cc(1461)
> sslBumpAccessCheck: SslBump applies. Force bump action on error UNKNOWN
> 2021/12/08 05:05:53.774 kid2| 83,3| client_side_request.cc(1562)
> sslBumpNeed: sslBump required: bump
> 2021/12/08 05:05:53.774 kid2| 73,3| HttpRequest.cc(683) storeId: sent back
> effectiveRequestUrl: beacons2.gvt2.com:443
> 2021/12/08 05:05:53.774 kid2| 24,7| SBuf.cc(160) rawSpace: reserving 1 for
> SBuf77493929
> 2021/12/08 05:05:53.774 kid2| 24,7| SBuf.cc(866) reAlloc: SBuf77493929 new
> store capacity: 40
> 2021/12/08 05:05:53.774 kid2| 20,3| store.cc(769) storeCreatePureEntry:
> storeCreateEntry: 'beacons2.gvt2.com:443'
> 2021/12/08 05:05:53.774 kid2| 20,5| store.cc(349) StoreEntry: StoreEntry
> constructed, this=0x5561d9347e90
> 2021/12/08 05:05:53.774 kid2| 20,3| MemObject.cc(100) MemObject: MemObject
> constructed, this=0x5561d5e66f50
> 2021/12/08 05:05:53.774 kid2| 55,7| HttpHeader.cc(155) HttpHeader: init-ing
> hdr: 0x5561d80af128 owner: 3
> 2021/12/08 05:05:53.774 kid2| 88,3| MemObject.cc(83) setUris: 0x5561d5e66f50
> storeId: beacons2.gvt2.com:443
> 2021/12/08 05:05:53.774 kid2| 24,7| SBuf.cc(85) assign: assigning
> SBuf77493930 from SBuf77493860
> 2021/12/08 05:05:53.774 kid2| 20,3| store.cc(443) lock: storeCreateEntry
> locked key [null_store_key] e:=V/0x5561d9347e90*1
> 2021/12/08 05:05:53.774 kid2| 20,3| store.cc(569) setPrivateKey: 01
> e:=V/0x5561d9347e90*1
> 2021/12/08 05:05:53.774 kid2| 20,3| store.cc(421) hashInsert:
> StoreEntry::hashInsert: Inserting Entry e:=XIV/0x5561d9347e90*1 key
> '71570400000000002412000002000000'
> 2021/12/08 05:05:53.774 kid2| 83,3| client_side_request.cc(1562)
> sslBumpNeed: sslBump required: client-first
> 2021/12/08 05:05:53.774 kid2| 33,4| ServerBump.cc(28) ServerBump: will peek
> at beacons2.gvt2.com:443
> 2021/12/08 05:05:53.774 kid2| 20,3| store.cc(443) lock: Ssl::ServerBump
> locked key 71570400000000002412000002000000 e:=XIV/0x5561d9347e90*2
> 2021/12/08 05:05:53.774 kid2| 4,4| errorpage.cc(720) errorAppendEntry:
> storing TEMPLATE_5 in e:=XIV/0x5561d9347e90*2
> 2021/12/08 05:05:53.774 kid2| 55,7| HttpHeader.cc(155) HttpHeader: init-ing
> hdr: 0x5561d66a8078 owner: 3
> 2021/12/08 05:05:53.774 kid2| 4,2| errorpage.cc(1389) buildBody: No existing
> error page language negotiated for TEMPLATE_5. Using default error file.
> 
> Ssl.conf
> # SSL used for port ID 1, :3128 on
> # Patch 2020 - 08 - 03 SquidMikrotikEnabled = 0 # SSL Proxy options  Proxy
> version:5.2 [134] sslcrtd_program /lib/squid3/security_file_certgen
> sslcrtd_children 32 startup=5 idle=1 queue-size=64 #The AppStore application
> in IOS (iPhone, iPad, MacOS) uses SSL Certificate Pinning, #it means the
> application knows what certificate to expect when accessing AppStore.
> #When you enable SSL Bump of HTTPS connections Squid replaces the default
> certificate with a  ^`^xmimicked ^`^y one;
> 
> #the application detects that and refuses to function.
> #
> acl FakeCert ssl::server_name .apple.com acl FakeCert ssl::server_name
> .icloud.com acl FakeCert ssl::server_name .mzstatic.com acl FakeCert
> ssl::server_name .dropbox.com acl FakeCert ssl::server_name .bnpparisbas acl
> notbump ssl::server_name .redtube.com acl ssl_step1 at_step SslBump1 acl
> ssl_step2 at_step SslBump2 acl ssl_step3 at_step SslBump3
> 
> acl Me dst 127.0.0.1 192.168.58.11
> acl GlobalWhitelistDSTNet dst "/etc/squid3/acls_whitelist.dst.conf"
> 
> ssl_bump splice notbump all
> ssl_bump splice GlobalWhitelistDSTNet
> 
> ssl_bump splice ssl_step1 Me
> ssl_bump splice ByPassRBL
> ssl_bump splice FakeCert
> 
> # SNI Group sni_domains/ssl_sni
> # id:7 Type: ssl_sni
> acl SNIGroup7 ssl::server_name_regex -i account\.google\.com acl SNIGroup7
> ssl::server_name_regex -i accounts\.google\.com ssl_bump peek ssl_step1 all
> # 0 Splice rules...
> ssl_bump splice ByPassRBL
> ssl_bump splice GlobalWhitelistDSTNet
> 
> # Rules (spliced) added by admins....
> 
> # 1 BUMP rules...
> ssl_bump bump ssl_step2 SNIGroup7
> ssl_bump splice all
> 
> tls_outgoing_options options=NO_SSLv3,NO_TICKET
> cipher=ALL:!SSLv2:!SSLv3:!ADH:!DSS:!MD5:!EXP:!DES:!PSK:!SRP:!RC4:!IDEA:!SEED
> :!aNULL:!eNULL flags=DONT_VERIFY_PEER sslproxy_cert_error allow all
> 
> http_access.conf
> #### tcp_outgoing_tos ####
> #### tcp_outgoing_tos 0 Rules ####
> # SquidUrgency = 0 exec.squid.global.access.php[2233]
> #       HaClusterClient=0 class.squid.acls.groups.inc/buildacls_order
> #       mysql_for_port='' aclgpid=0 [L.174]
> #       [3] rules [220]
> 
> 
> # webfilters_sqacls #2 : aclport=0 (  ) [239] [class.squid.acls.groups.inc]
> # [L.292]: rule id: 2 access_allow Port Direction=0 () # [L.320]:
> class.squid.acls.groups.inc buildacls_bytype_items(2,..) acl AnnotateRule2
> annotate_transaction accessrule=Rule2 http_access allow Group2 AnnotateRule2
> # webfilters_sqacls #4 : aclport=0 (  ) [239] [class.squid.acls.groups.inc]
> # [L.292]: rule id: 4 access_allow Port Direction=0 () # [L.320]:
> class.squid.acls.groups.inc buildacls_bytype_items(4,..) acl AnnotateRule4
> annotate_transaction accessrule=Rule4 http_access allow Group8 AnnotateRule4
> # webfilters_sqacls #3 : aclport=0 (  ) [239] [class.squid.acls.groups.inc]
> # [L.292]: rule id: 3 access_deny Port Direction=0 () # [L.320]:
> class.squid.acls.groups.inc buildacls_bytype_items(3,..) # Template Enabled
> for this ACL.
> # Final acl is all, Template ID=1
> acl AnnotateRule3 annotate_transaction accessrule=Rule3 http_access deny
> CONNECT  AnnotateRule3 deny_info TCP_RESET AnnotateRule3
> 
> acl MyAll dst 0.0.0.0/0
> http_access deny Myall
> deny_info 302:http://artica/me Myall
> #
> #
> # ------------------ HTTP ACCESS -------------------- # 0 rule(s) from
> engine (Line 2240)
> 
> 
> #
> # SquidStandardLDAPAuth = 0
> # EnableOpenLDAP = 0
> # SquidRadiusAuth = 0
> # LDAP_AUTH = 0 caused by EnableOpenLDAP acl MyBlockedIPs src
> "/etc/squid3/acls/DenyIPSrc"
> acl AnnotateWindowsUpdates annotate_transaction
> accessrule=AllowWindowsUpdates http_access allow WindowsUpdates
> AnnotateWindowsUpdates # # -------------------- AUTH Schemes Squid
> v5.2-----------------------
> 
> # ----------------------------------------------------------
> 
> # LDAP Auth = 0
> acl AnnotateSafePorts annotate_transaction accessrule=deny_remote_ports
> http_access deny HTTP !Safe_ports all  AnnotateSafePorts http_access deny
> CONNECT !SSL_ports all  AnnotateSafePorts deny_info TCP_RESET all
> 
> acl AnnotateBLK annotate_transaction accessrule=global_blacklist http_access
> deny MyBlockedIPs AnnotateBLK http_access deny blockedsites AnnotateBLK
> http_access deny DomainsBlackLists AnnotateBLK http_access deny
> NetworksBlackLists AnnotateBLK include /etc/squid3/http_access_final.conf
> # END http_access (defaults)
> 
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users
> 



From andre.bolinhas at articatech.com  Wed Dec  8 15:40:03 2021
From: andre.bolinhas at articatech.com (=?UTF-8?Q?Andr=C3=A9_Bolinhas?=)
Date: Wed, 8 Dec 2021 15:40:03 -0000
Subject: [squid-users] deny squid to bump deny_info
In-Reply-To: <58f4c84a-35ca-aa62-43bb-3c4d0fff939f@measurement-factory.com>
References: <!&!AAAAAAAAAAAuAAAAAAAAAJJD97gEMN5Ch2HBNn/5W3IBAMO2jhD3dRHOtM0AqgC7tuYAAAAAAA4AABAAAAA/vsnzXWfeQoQx+2MBa2hmAQAAAAA=@articatech.com>
 <58f4c84a-35ca-aa62-43bb-3c4d0fff939f@measurement-factory.com>
Message-ID: <!&!AAAAAAAAAAAuAAAAAAAAAJJD97gEMN5Ch2HBNn/5W3IBAMO2jhD3dRHOtM0AqgC7tuYAAAAAAA4AABAAAAC9RiWUcHCrQb7c2n+RZsgSAQAAAAA=@articatech.com>

Thanks for the quick reply, where I need to add the ssl_bump terminate rule? Inside ssl.conf or http_access.conf?
I have tried in both both but continues to bump the error page.
Also tried ssl_bump terminate all in the top of both files and always bump ther error_page.

This is my current files:
http_access.conf
#### tcp_outgoing_tos ####
#### tcp_outgoing_tos 0 Rules ####
# webfilters_sqacls HaClusterClient=0 2 rules [202] [class.squid.acls.groups.inc]
# webfilters_sqacls #10 : aclport=0 (  ) [212] [class.squid.acls.groups.inc]
# [L.268]: rule id: 10 access_allow Port Direction=0 ()
# [L.303]: class.squid.acls.groups.inc buildacls_bytype_items(10,..)
http_access allow Group17
# webfilters_sqacls #5 : aclport=0 (  ) [212] [class.squid.acls.groups.inc]
# [L.268]: rule id: 5 access_deny Port Direction=0 ()
# [L.303]: class.squid.acls.groups.inc buildacls_bytype_items(5,..)
# Template Enabled for this ACL.
# Final acl is all, Template ID=1
deny_info TEMPLATE_5 all
http_access deny all
#
#
# ------------------ HTTP ACCESS --------------------
# 0 rule(s) from engine (Line 2170)


# SquidStandardLDAPAuth = 0
# EnableOpenLDAP = 0
# SquidRadiusAuth = 0
# LDAP_AUTH = 0 caused by EnableOpenLDAP
acl MyBlockedIPs src "/etc/squid3/acls/DenyIPSrc"
http_access allow WindowsUpdates

# LDAP Auth = 0
http_access deny HTTP !Safe_ports all
http_access deny CONNECT !SSL_ports all
http_access deny MyBlockedIPs
http_access deny blockedsites
http_access deny DomainsBlackLists
http_access deny NetworksBlackLists
include /etc/squid3/http_access_final.conf
# END http_access (defaults)

# Allow all networks to finally pass trough proxy.
http_access allow all

ssl.conf
# SSL used for port ID 1, :3128 on
# Patch 2020 - 08 - 03 SquidMikrotikEnabled = 0
# SSL Proxy options  Proxy version:5.2 [134]
sslcrtd_program /lib/squid3/security_file_certgen -s /var/lib/squid/session/ssl/ssl_db -M 32MB
sslcrtd_children 32 startup=5 idle=1 queue-size=64
#The AppStore application in IOS (iPhone, iPad, MacOS) uses SSL Certificate Pinning,
#it means the application knows what certificate to expect when accessing AppStore.
#When you enable SSL Bump of HTTPS connections Squid replaces the default certificate with a  ^`^xmimicked ^`^y one;
#the application detects that and refuses to function.
#
acl FakeCert ssl::server_name .apple.com
acl FakeCert ssl::server_name .icloud.com
acl FakeCert ssl::server_name .mzstatic.com
acl FakeCert ssl::server_name .dropbox.com
acl FakeCert ssl::server_name .bnpparisbas
acl ssl_step1 at_step SslBump1
acl ssl_step2 at_step SslBump2
acl ssl_step3 at_step SslBump3
ssl_bump peek ssl_step1
ssl_bump splice GlobalWhitelistDSTNet
ssl_bump splice GlobalWhitelistDomainsRx
ssl_bump splice GlobalWhitelistDomains
ssl_bump splice FakeCert

# SNI Group google_sni/ssl_sni
# id:16 Type: ssl_sni
acl SNIGroup16 ssl::server_name_regex -i accounts\.google\.com

# 0 Splice rules...
acl KeepSSL ssl::server_name "/etc/squid3/acls_whitelist.dstdomain.conf"
ssl_bump splice KeepSSL
ssl_bump splice GlobalWhitelistDSTNet

# Rules (spliced) added by admins....

# 1 BUMP rules...
#ssl_bump stare all
ssl_bump bump ssl_step2 SNIGroup16
ssl_bump splice all

tls_outgoing_options options=NO_SSLv3,NO_TICKET cipher=ALL:!SSLv2:!SSLv3:!ADH:!DSS:!MD5:!EXP:!DES:!PSK:!SRP:!RC4:!IDEA:!SEED:!aNULL:!eNULL flags=DONT_VERIFY_PEER
sslproxy_cert_error allow all
on_unsupported_protocol tunnel all


-----Mensagem original-----
De: Alex Rousskov <rousskov at measurement-factory.com> 
Enviada: 8 de dezembro de 2021 15:13
Para: Andr? Bolinhas <andre.bolinhas at articatech.com>; squid-users at lists.squid-cache.org
Assunto: Re: [squid-users] deny squid to bump deny_info

On 12/7/21 8:39 PM, Andr? Bolinhas wrote:

> We use Squid v5 with ssl_bump to decrypt only google domains. With a 
> special configuration we also need to deny important websites. Squid 
> tries to bump returned error pages

Yes, when SslBump encounters an error, it tries to bump the client connection to deliver the error response.

One way to prevent that error handling algorithm from kicking in is to close the offending client connection using an "ssl_bump terminate" rule (instead[1] of blocking client access using "http_access").


> We have tried using a TCP_RESET deny_info but this does not fix the 
> bump operation

I suspect the TCP_RESET feature is checked at error delivery time, after the client connection is bumped to prepare it for error delivery. This suspect behavior should be considered a Squid bug/deficiency IMO -- Squid should not be bumping the TLS connection to deliver a TCP RST or FIN packet.

HTH,

Alex.
[1] It may be a good idea to also/still block client access using http_access rules, as an additional safety layer, but it has to be done carefully so that "ssl_bump terminate" rule matches _before_ any of the corresponding "http_access deny" rules may match.



> In this peace of log, you can see that squid is forcing bump for 
> Access Denied website under https:
> 2021/12/08 05:05:53.774 kid2| 85,5| client_side_request.cc(769)
> clientAccessCheckDone: Access Denied: beacons2.gvt2.com:443
> 2021/12/08 05:05:53.774 kid2| 85,5| client_side_request.cc(770)
> clientAccessCheckDone: AclMatchedName = all
> 2021/12/08 05:05:53.774 kid2| 83,7| LogTags.cc(57) update: TAG_NONE to 
> TCP_DENIED
> 2021/12/08 05:05:53.774 kid2| 28,4| FilledChecklist.cc(67)
> ~ACLFilledChecklist: ACLFilledChecklist destroyed 0x7ffc945c5b40
> 2021/12/08 05:05:53.774 kid2| 28,4| Checklist.cc(197) ~ACLChecklist:
> ACLChecklist::~ACLChecklist: destroyed 0x7ffc945c5b40
> 2021/12/08 05:05:53.774 kid2| 85,5| client_side_request.cc(1461)
> sslBumpAccessCheck: SslBump applies. Force bump action on error 
> UNKNOWN
> 2021/12/08 05:05:53.774 kid2| 83,3| client_side_request.cc(1562)
> sslBumpNeed: sslBump required: bump
> 2021/12/08 05:05:53.774 kid2| 73,3| HttpRequest.cc(683) storeId: sent 
> back
> effectiveRequestUrl: beacons2.gvt2.com:443
> 2021/12/08 05:05:53.774 kid2| 24,7| SBuf.cc(160) rawSpace: reserving 1 
> for
> SBuf77493929
> 2021/12/08 05:05:53.774 kid2| 24,7| SBuf.cc(866) reAlloc: SBuf77493929 
> new store capacity: 40
> 2021/12/08 05:05:53.774 kid2| 20,3| store.cc(769) storeCreatePureEntry:
> storeCreateEntry: 'beacons2.gvt2.com:443'
> 2021/12/08 05:05:53.774 kid2| 20,5| store.cc(349) StoreEntry: 
> StoreEntry constructed, this=0x5561d9347e90
> 2021/12/08 05:05:53.774 kid2| 20,3| MemObject.cc(100) MemObject: 
> MemObject constructed, this=0x5561d5e66f50
> 2021/12/08 05:05:53.774 kid2| 55,7| HttpHeader.cc(155) HttpHeader: 
> init-ing
> hdr: 0x5561d80af128 owner: 3
> 2021/12/08 05:05:53.774 kid2| 88,3| MemObject.cc(83) setUris: 
> 0x5561d5e66f50
> storeId: beacons2.gvt2.com:443
> 2021/12/08 05:05:53.774 kid2| 24,7| SBuf.cc(85) assign: assigning
> SBuf77493930 from SBuf77493860
> 2021/12/08 05:05:53.774 kid2| 20,3| store.cc(443) lock: 
> storeCreateEntry locked key [null_store_key] e:=V/0x5561d9347e90*1
> 2021/12/08 05:05:53.774 kid2| 20,3| store.cc(569) setPrivateKey: 01
> e:=V/0x5561d9347e90*1
> 2021/12/08 05:05:53.774 kid2| 20,3| store.cc(421) hashInsert:
> StoreEntry::hashInsert: Inserting Entry e:=XIV/0x5561d9347e90*1 key 
> '71570400000000002412000002000000'
> 2021/12/08 05:05:53.774 kid2| 83,3| client_side_request.cc(1562)
> sslBumpNeed: sslBump required: client-first
> 2021/12/08 05:05:53.774 kid2| 33,4| ServerBump.cc(28) ServerBump: will 
> peek at beacons2.gvt2.com:443
> 2021/12/08 05:05:53.774 kid2| 20,3| store.cc(443) lock: 
> Ssl::ServerBump locked key 71570400000000002412000002000000 
> e:=XIV/0x5561d9347e90*2
> 2021/12/08 05:05:53.774 kid2| 4,4| errorpage.cc(720) errorAppendEntry:
> storing TEMPLATE_5 in e:=XIV/0x5561d9347e90*2
> 2021/12/08 05:05:53.774 kid2| 55,7| HttpHeader.cc(155) HttpHeader: 
> init-ing
> hdr: 0x5561d66a8078 owner: 3
> 2021/12/08 05:05:53.774 kid2| 4,2| errorpage.cc(1389) buildBody: No 
> existing error page language negotiated for TEMPLATE_5. Using default error file.
> 
> Ssl.conf
> # SSL used for port ID 1, :3128 on
> # Patch 2020 - 08 - 03 SquidMikrotikEnabled = 0 # SSL Proxy options  
> Proxy
> version:5.2 [134] sslcrtd_program /lib/squid3/security_file_certgen 
> sslcrtd_children 32 startup=5 idle=1 queue-size=64 #The AppStore 
> application in IOS (iPhone, iPad, MacOS) uses SSL Certificate Pinning, 
> #it means the application knows what certificate to expect when accessing AppStore.
> #When you enable SSL Bump of HTTPS connections Squid replaces the 
> default certificate with a  ^`^xmimicked ^`^y one;
> 
> #the application detects that and refuses to function.
> #
> acl FakeCert ssl::server_name .apple.com acl FakeCert ssl::server_name 
> .icloud.com acl FakeCert ssl::server_name .mzstatic.com acl FakeCert 
> ssl::server_name .dropbox.com acl FakeCert ssl::server_name 
> .bnpparisbas acl notbump ssl::server_name .redtube.com acl ssl_step1 
> at_step SslBump1 acl
> ssl_step2 at_step SslBump2 acl ssl_step3 at_step SslBump3
> 
> acl Me dst 127.0.0.1 192.168.58.11
> acl GlobalWhitelistDSTNet dst "/etc/squid3/acls_whitelist.dst.conf"
> 
> ssl_bump splice notbump all
> ssl_bump splice GlobalWhitelistDSTNet
> 
> ssl_bump splice ssl_step1 Me
> ssl_bump splice ByPassRBL
> ssl_bump splice FakeCert
> 
> # SNI Group sni_domains/ssl_sni
> # id:7 Type: ssl_sni
> acl SNIGroup7 ssl::server_name_regex -i account\.google\.com acl 
> SNIGroup7 ssl::server_name_regex -i accounts\.google\.com ssl_bump 
> peek ssl_step1 all # 0 Splice rules...
> ssl_bump splice ByPassRBL
> ssl_bump splice GlobalWhitelistDSTNet
> 
> # Rules (spliced) added by admins....
> 
> # 1 BUMP rules...
> ssl_bump bump ssl_step2 SNIGroup7
> ssl_bump splice all
> 
> tls_outgoing_options options=NO_SSLv3,NO_TICKET 
> cipher=ALL:!SSLv2:!SSLv3:!ADH:!DSS:!MD5:!EXP:!DES:!PSK:!SRP:!RC4:!IDEA
> :!SEED :!aNULL:!eNULL flags=DONT_VERIFY_PEER sslproxy_cert_error allow 
> all
> 
> http_access.conf
> #### tcp_outgoing_tos ####
> #### tcp_outgoing_tos 0 Rules ####
> # SquidUrgency = 0 exec.squid.global.access.php[2233]
> #       HaClusterClient=0 class.squid.acls.groups.inc/buildacls_order
> #       mysql_for_port='' aclgpid=0 [L.174]
> #       [3] rules [220]
> 
> 
> # webfilters_sqacls #2 : aclport=0 (  ) [239] 
> [class.squid.acls.groups.inc] # [L.292]: rule id: 2 access_allow Port Direction=0 () # [L.320]:
> class.squid.acls.groups.inc buildacls_bytype_items(2,..) acl 
> AnnotateRule2 annotate_transaction accessrule=Rule2 http_access allow 
> Group2 AnnotateRule2 # webfilters_sqacls #4 : aclport=0 (  ) [239] 
> [class.squid.acls.groups.inc] # [L.292]: rule id: 4 access_allow Port Direction=0 () # [L.320]:
> class.squid.acls.groups.inc buildacls_bytype_items(4,..) acl 
> AnnotateRule4 annotate_transaction accessrule=Rule4 http_access allow 
> Group8 AnnotateRule4 # webfilters_sqacls #3 : aclport=0 (  ) [239] 
> [class.squid.acls.groups.inc] # [L.292]: rule id: 3 access_deny Port Direction=0 () # [L.320]:
> class.squid.acls.groups.inc buildacls_bytype_items(3,..) # Template 
> Enabled for this ACL.
> # Final acl is all, Template ID=1
> acl AnnotateRule3 annotate_transaction accessrule=Rule3 http_access 
> deny CONNECT  AnnotateRule3 deny_info TCP_RESET AnnotateRule3
> 
> acl MyAll dst 0.0.0.0/0
> http_access deny Myall
> deny_info 302:http://artica/me Myall
> #
> #
> # ------------------ HTTP ACCESS -------------------- # 0 rule(s) from 
> engine (Line 2240)
> 
> 
> #
> # SquidStandardLDAPAuth = 0
> # EnableOpenLDAP = 0
> # SquidRadiusAuth = 0
> # LDAP_AUTH = 0 caused by EnableOpenLDAP acl MyBlockedIPs src 
> "/etc/squid3/acls/DenyIPSrc"
> acl AnnotateWindowsUpdates annotate_transaction 
> accessrule=AllowWindowsUpdates http_access allow WindowsUpdates 
> AnnotateWindowsUpdates # # -------------------- AUTH Schemes Squid
> v5.2-----------------------
> 
> # ----------------------------------------------------------
> 
> # LDAP Auth = 0
> acl AnnotateSafePorts annotate_transaction 
> accessrule=deny_remote_ports http_access deny HTTP !Safe_ports all  
> AnnotateSafePorts http_access deny CONNECT !SSL_ports all  
> AnnotateSafePorts deny_info TCP_RESET all
> 
> acl AnnotateBLK annotate_transaction accessrule=global_blacklist 
> http_access deny MyBlockedIPs AnnotateBLK http_access deny 
> blockedsites AnnotateBLK http_access deny DomainsBlackLists 
> AnnotateBLK http_access deny NetworksBlackLists AnnotateBLK include 
> /etc/squid3/http_access_final.conf
> # END http_access (defaults)
> 
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users
> 




From rousskov at measurement-factory.com  Wed Dec  8 16:01:31 2021
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Wed, 8 Dec 2021 11:01:31 -0500
Subject: [squid-users] deny squid to bump deny_info
In-Reply-To: <!&!AAAAAAAAAAAuAAAAAAAAAJJD97gEMN5Ch2HBNn/5W3IBAMO2jhD3dRHOtM0AqgC7tuYAAAAAAA4AABAAAAC9RiWUcHCrQb7c2n+RZsgSAQAAAAA=@articatech.com>
References: <!&!AAAAAAAAAAAuAAAAAAAAAJJD97gEMN5Ch2HBNn/5W3IBAMO2jhD3dRHOtM0AqgC7tuYAAAAAAA4AABAAAAA/vsnzXWfeQoQx+2MBa2hmAQAAAAA=@articatech.com>
 <58f4c84a-35ca-aa62-43bb-3c4d0fff939f@measurement-factory.com>
 <!&!AAAAAAAAAAAuAAAAAAAAAJJD97gEMN5Ch2HBNn/5W3IBAMO2jhD3dRHOtM0AqgC7tuYAAAAAAA4AABAAAAC9RiWUcHCrQb7c2n+RZsgSAQAAAAA=@articatech.com>
Message-ID: <f2368559-5b77-171c-b82f-0ca4b9160677@measurement-factory.com>

On 12/8/21 10:40 AM, Andr? Bolinhas wrote:
> where I need to add the ssl_bump terminate rule? Inside ssl.conf or http_access.conf?
> I have tried in both both but continues to bump the error page.

Unfortunately, I cannot edit your configuration right now, but others on
the mailing list may be able to help you. Please note that we do not
know how those two files are included into your primary configuration
file and whether that primary configuration file contains any relevant
settings itself. The primary configuration file is what Squid parses
first (e.g., it may be specified using "squid -f").


> Also tried ssl_bump terminate all in the top of both files and always
> bump ther error_page.

I am not sure, but AFAICT, Squid bugs notwithstanding, if "ssl_bump
terminate all" is the very first ssl_bump rule in the entire Squid
configuration, and Squid still bumps traffic, then you may be denying
explicit CONNECT requests _before_ SslBump kicks in.

Alex.


> This is my current files:
> http_access.conf
> #### tcp_outgoing_tos ####
> #### tcp_outgoing_tos 0 Rules ####
> # webfilters_sqacls HaClusterClient=0 2 rules [202] [class.squid.acls.groups.inc]
> # webfilters_sqacls #10 : aclport=0 (  ) [212] [class.squid.acls.groups.inc]
> # [L.268]: rule id: 10 access_allow Port Direction=0 ()
> # [L.303]: class.squid.acls.groups.inc buildacls_bytype_items(10,..)
> http_access allow Group17
> # webfilters_sqacls #5 : aclport=0 (  ) [212] [class.squid.acls.groups.inc]
> # [L.268]: rule id: 5 access_deny Port Direction=0 ()
> # [L.303]: class.squid.acls.groups.inc buildacls_bytype_items(5,..)
> # Template Enabled for this ACL.
> # Final acl is all, Template ID=1
> deny_info TEMPLATE_5 all
> http_access deny all
> #
> #
> # ------------------ HTTP ACCESS --------------------
> # 0 rule(s) from engine (Line 2170)
> 
> 
> # SquidStandardLDAPAuth = 0
> # EnableOpenLDAP = 0
> # SquidRadiusAuth = 0
> # LDAP_AUTH = 0 caused by EnableOpenLDAP
> acl MyBlockedIPs src "/etc/squid3/acls/DenyIPSrc"
> http_access allow WindowsUpdates
> 
> # LDAP Auth = 0
> http_access deny HTTP !Safe_ports all
> http_access deny CONNECT !SSL_ports all
> http_access deny MyBlockedIPs
> http_access deny blockedsites
> http_access deny DomainsBlackLists
> http_access deny NetworksBlackLists
> include /etc/squid3/http_access_final.conf
> # END http_access (defaults)
> 
> # Allow all networks to finally pass trough proxy.
> http_access allow all
> 
> ssl.conf
> # SSL used for port ID 1, :3128 on
> # Patch 2020 - 08 - 03 SquidMikrotikEnabled = 0
> # SSL Proxy options  Proxy version:5.2 [134]
> sslcrtd_program /lib/squid3/security_file_certgen -s /var/lib/squid/session/ssl/ssl_db -M 32MB
> sslcrtd_children 32 startup=5 idle=1 queue-size=64
> #The AppStore application in IOS (iPhone, iPad, MacOS) uses SSL Certificate Pinning,
> #it means the application knows what certificate to expect when accessing AppStore.
> #When you enable SSL Bump of HTTPS connections Squid replaces the default certificate with a  ^`^xmimicked ^`^y one;
> #the application detects that and refuses to function.
> #
> acl FakeCert ssl::server_name .apple.com
> acl FakeCert ssl::server_name .icloud.com
> acl FakeCert ssl::server_name .mzstatic.com
> acl FakeCert ssl::server_name .dropbox.com
> acl FakeCert ssl::server_name .bnpparisbas
> acl ssl_step1 at_step SslBump1
> acl ssl_step2 at_step SslBump2
> acl ssl_step3 at_step SslBump3
> ssl_bump peek ssl_step1
> ssl_bump splice GlobalWhitelistDSTNet
> ssl_bump splice GlobalWhitelistDomainsRx
> ssl_bump splice GlobalWhitelistDomains
> ssl_bump splice FakeCert
> 
> # SNI Group google_sni/ssl_sni
> # id:16 Type: ssl_sni
> acl SNIGroup16 ssl::server_name_regex -i accounts\.google\.com
> 
> # 0 Splice rules...
> acl KeepSSL ssl::server_name "/etc/squid3/acls_whitelist.dstdomain.conf"
> ssl_bump splice KeepSSL
> ssl_bump splice GlobalWhitelistDSTNet
> 
> # Rules (spliced) added by admins....
> 
> # 1 BUMP rules...
> #ssl_bump stare all
> ssl_bump bump ssl_step2 SNIGroup16
> ssl_bump splice all
> 
> tls_outgoing_options options=NO_SSLv3,NO_TICKET cipher=ALL:!SSLv2:!SSLv3:!ADH:!DSS:!MD5:!EXP:!DES:!PSK:!SRP:!RC4:!IDEA:!SEED:!aNULL:!eNULL flags=DONT_VERIFY_PEER
> sslproxy_cert_error allow all
> on_unsupported_protocol tunnel all
> 
> 
> -----Mensagem original-----
> De: Alex Rousskov <rousskov at measurement-factory.com> 
> Enviada: 8 de dezembro de 2021 15:13
> Para: Andr? Bolinhas <andre.bolinhas at articatech.com>; squid-users at lists.squid-cache.org
> Assunto: Re: [squid-users] deny squid to bump deny_info
> 
> On 12/7/21 8:39 PM, Andr? Bolinhas wrote:
> 
>> We use Squid v5 with ssl_bump to decrypt only google domains. With a 
>> special configuration we also need to deny important websites. Squid 
>> tries to bump returned error pages
> 
> Yes, when SslBump encounters an error, it tries to bump the client connection to deliver the error response.
> 
> One way to prevent that error handling algorithm from kicking in is to close the offending client connection using an "ssl_bump terminate" rule (instead[1] of blocking client access using "http_access").
> 
> 
>> We have tried using a TCP_RESET deny_info but this does not fix the 
>> bump operation
> 
> I suspect the TCP_RESET feature is checked at error delivery time, after the client connection is bumped to prepare it for error delivery. This suspect behavior should be considered a Squid bug/deficiency IMO -- Squid should not be bumping the TLS connection to deliver a TCP RST or FIN packet.
> 
> HTH,
> 
> Alex.
> [1] It may be a good idea to also/still block client access using http_access rules, as an additional safety layer, but it has to be done carefully so that "ssl_bump terminate" rule matches _before_ any of the corresponding "http_access deny" rules may match.
> 
> 
> 
>> In this peace of log, you can see that squid is forcing bump for 
>> Access Denied website under https:
>> 2021/12/08 05:05:53.774 kid2| 85,5| client_side_request.cc(769)
>> clientAccessCheckDone: Access Denied: beacons2.gvt2.com:443
>> 2021/12/08 05:05:53.774 kid2| 85,5| client_side_request.cc(770)
>> clientAccessCheckDone: AclMatchedName = all
>> 2021/12/08 05:05:53.774 kid2| 83,7| LogTags.cc(57) update: TAG_NONE to 
>> TCP_DENIED
>> 2021/12/08 05:05:53.774 kid2| 28,4| FilledChecklist.cc(67)
>> ~ACLFilledChecklist: ACLFilledChecklist destroyed 0x7ffc945c5b40
>> 2021/12/08 05:05:53.774 kid2| 28,4| Checklist.cc(197) ~ACLChecklist:
>> ACLChecklist::~ACLChecklist: destroyed 0x7ffc945c5b40
>> 2021/12/08 05:05:53.774 kid2| 85,5| client_side_request.cc(1461)
>> sslBumpAccessCheck: SslBump applies. Force bump action on error 
>> UNKNOWN
>> 2021/12/08 05:05:53.774 kid2| 83,3| client_side_request.cc(1562)
>> sslBumpNeed: sslBump required: bump
>> 2021/12/08 05:05:53.774 kid2| 73,3| HttpRequest.cc(683) storeId: sent 
>> back
>> effectiveRequestUrl: beacons2.gvt2.com:443
>> 2021/12/08 05:05:53.774 kid2| 24,7| SBuf.cc(160) rawSpace: reserving 1 
>> for
>> SBuf77493929
>> 2021/12/08 05:05:53.774 kid2| 24,7| SBuf.cc(866) reAlloc: SBuf77493929 
>> new store capacity: 40
>> 2021/12/08 05:05:53.774 kid2| 20,3| store.cc(769) storeCreatePureEntry:
>> storeCreateEntry: 'beacons2.gvt2.com:443'
>> 2021/12/08 05:05:53.774 kid2| 20,5| store.cc(349) StoreEntry: 
>> StoreEntry constructed, this=0x5561d9347e90
>> 2021/12/08 05:05:53.774 kid2| 20,3| MemObject.cc(100) MemObject: 
>> MemObject constructed, this=0x5561d5e66f50
>> 2021/12/08 05:05:53.774 kid2| 55,7| HttpHeader.cc(155) HttpHeader: 
>> init-ing
>> hdr: 0x5561d80af128 owner: 3
>> 2021/12/08 05:05:53.774 kid2| 88,3| MemObject.cc(83) setUris: 
>> 0x5561d5e66f50
>> storeId: beacons2.gvt2.com:443
>> 2021/12/08 05:05:53.774 kid2| 24,7| SBuf.cc(85) assign: assigning
>> SBuf77493930 from SBuf77493860
>> 2021/12/08 05:05:53.774 kid2| 20,3| store.cc(443) lock: 
>> storeCreateEntry locked key [null_store_key] e:=V/0x5561d9347e90*1
>> 2021/12/08 05:05:53.774 kid2| 20,3| store.cc(569) setPrivateKey: 01
>> e:=V/0x5561d9347e90*1
>> 2021/12/08 05:05:53.774 kid2| 20,3| store.cc(421) hashInsert:
>> StoreEntry::hashInsert: Inserting Entry e:=XIV/0x5561d9347e90*1 key 
>> '71570400000000002412000002000000'
>> 2021/12/08 05:05:53.774 kid2| 83,3| client_side_request.cc(1562)
>> sslBumpNeed: sslBump required: client-first
>> 2021/12/08 05:05:53.774 kid2| 33,4| ServerBump.cc(28) ServerBump: will 
>> peek at beacons2.gvt2.com:443
>> 2021/12/08 05:05:53.774 kid2| 20,3| store.cc(443) lock: 
>> Ssl::ServerBump locked key 71570400000000002412000002000000 
>> e:=XIV/0x5561d9347e90*2
>> 2021/12/08 05:05:53.774 kid2| 4,4| errorpage.cc(720) errorAppendEntry:
>> storing TEMPLATE_5 in e:=XIV/0x5561d9347e90*2
>> 2021/12/08 05:05:53.774 kid2| 55,7| HttpHeader.cc(155) HttpHeader: 
>> init-ing
>> hdr: 0x5561d66a8078 owner: 3
>> 2021/12/08 05:05:53.774 kid2| 4,2| errorpage.cc(1389) buildBody: No 
>> existing error page language negotiated for TEMPLATE_5. Using default error file.
>>
>> Ssl.conf
>> # SSL used for port ID 1, :3128 on
>> # Patch 2020 - 08 - 03 SquidMikrotikEnabled = 0 # SSL Proxy options  
>> Proxy
>> version:5.2 [134] sslcrtd_program /lib/squid3/security_file_certgen 
>> sslcrtd_children 32 startup=5 idle=1 queue-size=64 #The AppStore 
>> application in IOS (iPhone, iPad, MacOS) uses SSL Certificate Pinning, 
>> #it means the application knows what certificate to expect when accessing AppStore.
>> #When you enable SSL Bump of HTTPS connections Squid replaces the 
>> default certificate with a  ^`^xmimicked ^`^y one;
>>
>> #the application detects that and refuses to function.
>> #
>> acl FakeCert ssl::server_name .apple.com acl FakeCert ssl::server_name 
>> .icloud.com acl FakeCert ssl::server_name .mzstatic.com acl FakeCert 
>> ssl::server_name .dropbox.com acl FakeCert ssl::server_name 
>> .bnpparisbas acl notbump ssl::server_name .redtube.com acl ssl_step1 
>> at_step SslBump1 acl
>> ssl_step2 at_step SslBump2 acl ssl_step3 at_step SslBump3
>>
>> acl Me dst 127.0.0.1 192.168.58.11
>> acl GlobalWhitelistDSTNet dst "/etc/squid3/acls_whitelist.dst.conf"
>>
>> ssl_bump splice notbump all
>> ssl_bump splice GlobalWhitelistDSTNet
>>
>> ssl_bump splice ssl_step1 Me
>> ssl_bump splice ByPassRBL
>> ssl_bump splice FakeCert
>>
>> # SNI Group sni_domains/ssl_sni
>> # id:7 Type: ssl_sni
>> acl SNIGroup7 ssl::server_name_regex -i account\.google\.com acl 
>> SNIGroup7 ssl::server_name_regex -i accounts\.google\.com ssl_bump 
>> peek ssl_step1 all # 0 Splice rules...
>> ssl_bump splice ByPassRBL
>> ssl_bump splice GlobalWhitelistDSTNet
>>
>> # Rules (spliced) added by admins....
>>
>> # 1 BUMP rules...
>> ssl_bump bump ssl_step2 SNIGroup7
>> ssl_bump splice all
>>
>> tls_outgoing_options options=NO_SSLv3,NO_TICKET 
>> cipher=ALL:!SSLv2:!SSLv3:!ADH:!DSS:!MD5:!EXP:!DES:!PSK:!SRP:!RC4:!IDEA
>> :!SEED :!aNULL:!eNULL flags=DONT_VERIFY_PEER sslproxy_cert_error allow 
>> all
>>
>> http_access.conf
>> #### tcp_outgoing_tos ####
>> #### tcp_outgoing_tos 0 Rules ####
>> # SquidUrgency = 0 exec.squid.global.access.php[2233]
>> #       HaClusterClient=0 class.squid.acls.groups.inc/buildacls_order
>> #       mysql_for_port='' aclgpid=0 [L.174]
>> #       [3] rules [220]
>>
>>
>> # webfilters_sqacls #2 : aclport=0 (  ) [239] 
>> [class.squid.acls.groups.inc] # [L.292]: rule id: 2 access_allow Port Direction=0 () # [L.320]:
>> class.squid.acls.groups.inc buildacls_bytype_items(2,..) acl 
>> AnnotateRule2 annotate_transaction accessrule=Rule2 http_access allow 
>> Group2 AnnotateRule2 # webfilters_sqacls #4 : aclport=0 (  ) [239] 
>> [class.squid.acls.groups.inc] # [L.292]: rule id: 4 access_allow Port Direction=0 () # [L.320]:
>> class.squid.acls.groups.inc buildacls_bytype_items(4,..) acl 
>> AnnotateRule4 annotate_transaction accessrule=Rule4 http_access allow 
>> Group8 AnnotateRule4 # webfilters_sqacls #3 : aclport=0 (  ) [239] 
>> [class.squid.acls.groups.inc] # [L.292]: rule id: 3 access_deny Port Direction=0 () # [L.320]:
>> class.squid.acls.groups.inc buildacls_bytype_items(3,..) # Template 
>> Enabled for this ACL.
>> # Final acl is all, Template ID=1
>> acl AnnotateRule3 annotate_transaction accessrule=Rule3 http_access 
>> deny CONNECT  AnnotateRule3 deny_info TCP_RESET AnnotateRule3
>>
>> acl MyAll dst 0.0.0.0/0
>> http_access deny Myall
>> deny_info 302:http://artica/me Myall
>> #
>> #
>> # ------------------ HTTP ACCESS -------------------- # 0 rule(s) from 
>> engine (Line 2240)
>>
>>
>> #
>> # SquidStandardLDAPAuth = 0
>> # EnableOpenLDAP = 0
>> # SquidRadiusAuth = 0
>> # LDAP_AUTH = 0 caused by EnableOpenLDAP acl MyBlockedIPs src 
>> "/etc/squid3/acls/DenyIPSrc"
>> acl AnnotateWindowsUpdates annotate_transaction 
>> accessrule=AllowWindowsUpdates http_access allow WindowsUpdates 
>> AnnotateWindowsUpdates # # -------------------- AUTH Schemes Squid
>> v5.2-----------------------
>>
>> # ----------------------------------------------------------
>>
>> # LDAP Auth = 0
>> acl AnnotateSafePorts annotate_transaction 
>> accessrule=deny_remote_ports http_access deny HTTP !Safe_ports all  
>> AnnotateSafePorts http_access deny CONNECT !SSL_ports all  
>> AnnotateSafePorts deny_info TCP_RESET all
>>
>> acl AnnotateBLK annotate_transaction accessrule=global_blacklist 
>> http_access deny MyBlockedIPs AnnotateBLK http_access deny 
>> blockedsites AnnotateBLK http_access deny DomainsBlackLists 
>> AnnotateBLK http_access deny NetworksBlackLists AnnotateBLK include 
>> /etc/squid3/http_access_final.conf
>> # END http_access (defaults)
>>
>> _______________________________________________
>> squid-users mailing list
>> squid-users at lists.squid-cache.org
>> http://lists.squid-cache.org/listinfo/squid-users
>>
> 



From los.mateusz at gmail.com  Thu Dec  9 13:18:02 2021
From: los.mateusz at gmail.com (=?utf-8?B?TWF0ZXVzeiDFgW/Fmw==?=)
Date: Thu, 9 Dec 2021 14:18:02 +0100
Subject: [squid-users] missing response body with https requests
Message-ID: <753F6D18-4F96-4584-BFE0-494ABFE6C5D2@gmail.com>

Hello Everyone,

I have a squid running as a caching proxy. Some users of proxy noticed that in their java applications they are getting improper response from squid.
While connecting to https site through parent proxy we can see 407 response with Content-Length header but with empty body content which causes applications to fail as they are trying to read that body

lHttpAsyncClient [exchange: 71] connection aborted||The problematic lines are:|...|Consume content|-1 bytes read

with squid 5 I can see missing body in logs

2021/10/26 07:17:32.684 kid1| 11,2| src/clients/HttpTunneler.cc(324) handleResponse: Tunnel Server RESPONSE:
---------
<HTML><HEAD>

<TITLE>Access Denied</TITLE>

<STYLE TYPE="text/css">

	TABLE.DETAILS TD{

	  font-family: Helvetica;

	  font-size: 9pt;

	}

</STYLE>

</HEAD>

<BODY>

<FONT face="Helvetica">

<big><strong></strong></big><BR>

</FON----------
2021/10/26 07:17:32.684 kid1| TCP connection to <parent_proxy_ip>/8080 failed
    current master transaction: master95
2021/10/26 07:17:32.684 kid1| Detected DEAD Parent: <parent_proxy_ip>
    current master transaction: master95

Parent proxy configuration:
cache_peer myparentproxy_ipaddress parent 8080 0 no-query no-digest no-netdb-exchange login=PASSTHRU

While connecting through parent proxy directly there is no issue and response can be parsed properly.

I was unable to find configuration options to change this, while connecting to http site there is no such issue and body is being send properly with 407 answer.

root at testvm:~# curl -x 192.168.3.19:3128 https://webhook.site -Lv
*   Trying 192.168.3.19:3128...
* TCP_NODELAY set
* Connected to 192.168.3.19 (192.168.3.19) port 3128 (#0)
* allocate connect buffer!
* Establish HTTP proxy tunnel to webhook.site:443
> CONNECT webhook.site:443 HTTP/1.1
> Host: webhook.site:443
> User-Agent: curl/7.68.0
> Proxy-Connection: Keep-Alive
>
< HTTP/1.1 407 Proxy Authentication Required
< Proxy-Authenticate: BASIC realm="LDAP"
< Cache-Control: no-cache
< Pragma: no-cache
< X-XSS-Protection: 1
< Content-Type: text/html; charset=utf-8
< Proxy-Connection: close
< Connection: close
< Content-Length: 1590
<
* Ignore 1590 bytes of response-body
* Proxy CONNECT connection closed
* Closing connection 9
* Hostname 192.168.3.19 was found in DNS cache
*   Trying 192.168.3.19:3128...
* TCP_NODELAY set
* Connected to 192.168.3.19 (192.168.3.19) port 3128 (#10)
* allocate connect buffer!
* Establish HTTP proxy tunnel to webhook.site:443
> CONNECT webhook.site:443 HTTP/1.1
> Host: webhook.site:443
> User-Agent: curl/7.68.0
> Proxy-Connection: Keep-Alive
>
< HTTP/1.1 500 Internal Server Error
< Server: squid/5.2-VCS
< Mime-Version: 1.0
< Date: Tue, 26 Oct 2021 07:17:32 GMT
< Content-Type: text/html;charset=utf-8
< Content-Length: 3814
< X-Squid-Error: ERR_CANNOT_FORWARD 0
< Content-Language: en
<
* Received HTTP code 500 from proxy after CONNECT
* CONNECT phase completed!
* Closing connection 10
curl: (56) Received HTTP code 500 from proxy after CONNECT

root at testvm:~# curl -x 192.168.3.19:3128 http://webhook.site -Lv
*   Trying 192.168.3.19:3128...
* TCP_NODELAY set
* Connected to 192.168.3.19 (192.168.3.19) port 3128 (#0)
> GET http://webhook.site/ HTTP/1.1
> Host: webhook.site
> User-Agent: curl/7.68.0
> Accept: */*
> Proxy-Connection: Keep-Alive
>
* Mark bundle as not supporting multiuse
< HTTP/1.1 407 Proxy Authentication Required
< Proxy-Authenticate: BASIC realm="LDAP"
< Cache-Control: no-cache
< Pragma: no-cache
< X-XSS-Protection: 1
< Content-Type: text/html; charset=utf-8
< Set-Cookie: BCSI-CS-53409a6e5b6816df=2; Path=/
< Content-Length: 1582
< Date: Tue, 26 Oct 2021 07:17:01 GMT
< X-Cache: MISS from testvm
< Via: 1.1 testvm (squid/5.2-VCS)
< Connection: keep-alive
<
<HTML><HEAD>

<TITLE>Access Denied</TITLE>

<STYLE TYPE="text/css">




Is there anything that can be done on configuration level to make it work?


Regards,
Mateusz
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20211209/202c4df1/attachment.htm>

From rousskov at measurement-factory.com  Thu Dec  9 14:51:56 2021
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Thu, 9 Dec 2021 09:51:56 -0500
Subject: [squid-users] missing response body with https requests
In-Reply-To: <753F6D18-4F96-4584-BFE0-494ABFE6C5D2@gmail.com>
References: <753F6D18-4F96-4584-BFE0-494ABFE6C5D2@gmail.com>
Message-ID: <2804eae6-c35f-65a7-4577-07a958230380@measurement-factory.com>

On 12/9/21 8:18 AM, Mateusz ?o? wrote:

> While connecting to https site through parent proxy we can see 407
> response with Content-Length header but with empty body content which
> causes applications to fail as they are trying to read that body

Squid does not yet have the code to support multi-step HTTP CONNECT
authentication with parent proxies. Your options for going forward may
include:

A1) Adjust the parent proxy configuration so that it does not respond
with HTTP 407 Proxy Authentication Required responses to the child
CONNECT requests.

A2) Adjust the child proxy configuration so that the parent proxy does
not respond with HTTP 407 Proxy Authentication Required responses to the
child.

B) Adjust the child proxy configuration so that it goes direct (rather
than through the parent proxy) when tunneling TLS connections.

C) Add proper support for multi-step HTTP CONNECT authentication to
Squid. It is a difficult/serious project that would require significant
code refactoring, but it can (and should) be done:
https://wiki.squid-cache.org/SquidFaq/AboutSquid#How_to_add_a_new_Squid_feature.2C_enhance.2C_of_fix_something.3F

Options A1 and A2 may need to be combined for the desired effect.

I do not know enough about your environment to say which of the above
options are viable/applicable, and cannot recommend specific
configuration adjustments (but others on this list may be able to help
with that).


HTH,

Alex.
P.S. Squid also does not have the code to read (large) CONNECT error
response bodies, but that is not the root cause of your problems. Even
if Squid could read the entire HTTP 407 response body in this case, it
would not help.


> lHttpAsyncClient [exchange: 71] connection aborted||The problematic lines are:|...|Consume content|-1 bytes read
> 
> with squid 5 I can see missing body in logs
> 
> 2021/10/26 07:17:32.684 kid1| 11,2| src/clients/HttpTunneler.cc(324) handleResponse: Tunnel Server RESPONSE:
> ---------
> <HTML><HEAD>
> 
> <TITLE>Access Denied</TITLE>
> 
> <STYLE TYPE="text/css">
> 
> 	TABLE.DETAILS TD{
> 
> 	  font-family: Helvetica;
> 
> 	  font-size: 9pt;
> 
> 	}
> 
> </STYLE>
> 
> </HEAD>
> 
> <BODY>
> 
> <FONT face="Helvetica">
> 
> <big><strong></strong></big><BR>
> 
> </FON----------
> 2021/10/26 07:17:32.684 kid1| TCP connection to <parent_proxy_ip>/8080
> failed
> ? ? current master transaction: master95
> 2021/10/26 07:17:32.684 kid1| Detected DEAD Parent: <parent_proxy_ip>
> ? ? current master transaction: master95
> 
> Parent proxy configuration:
> cache_peer myparentproxy_ipaddress parent 8080 0 no-query no-digest
> no-netdb-exchange login=PASSTHRU
> 
> While connecting through parent proxy directly there is no issue and
> response can be parsed properly.
> 
> I was unable to find configuration options to change this, while
> connecting to http site there is no such issue and body is being send
> properly with 407 answer.
> 
> root at testvm:~# curl -x 192.168.3.19:3128 https://webhook.site
> <https://webhook.site> -Lv
> * ? Trying 192.168.3.19:3128...
> * TCP_NODELAY set
> * Connected to 192.168.3.19 (192.168.3.19) port 3128 (#0)
> * allocate connect buffer!
> * Establish HTTP proxy tunnel to webhook.site:443 <http://webhook.site:443>
>> CONNECT webhook.site:443 <http://webhook.site:443> HTTP/1.1
>> Host: webhook.site:443 <http://webhook.site:443>
>> User-Agent: curl/7.68.0
>> Proxy-Connection: Keep-Alive
>>
> < HTTP/1.1 407 Proxy Authentication Required
> < Proxy-Authenticate: BASIC realm="LDAP"
> < Cache-Control: no-cache
> < Pragma: no-cache
> < X-XSS-Protection: 1
> < Content-Type: text/html; charset=utf-8
> < Proxy-Connection: close
> < Connection: close
> < Content-Length: 1590
> <
> * Ignore 1590 bytes of response-body
> * Proxy CONNECT connection closed
> * Closing connection 9
> * Hostname 192.168.3.19 was found in DNS cache
> * ? Trying 192.168.3.19:3128...
> * TCP_NODELAY set
> * Connected to 192.168.3.19 (192.168.3.19) port 3128 (#10)
> * allocate connect buffer!
> * Establish HTTP proxy tunnel to webhook.site:443 <http://webhook.site:443>
>> CONNECT webhook.site:443 <http://webhook.site:443> HTTP/1.1
>> Host: webhook.site:443 <http://webhook.site:443>
>> User-Agent: curl/7.68.0
>> Proxy-Connection: Keep-Alive
>>
> < HTTP/1.1 500 Internal Server Error
> < Server: squid/5.2-VCS
> < Mime-Version: 1.0
> < Date: Tue, 26 Oct 2021 07:17:32 GMT
> < Content-Type: text/html;charset=utf-8
> < Content-Length: 3814
> < X-Squid-Error: ERR_CANNOT_FORWARD 0
> < Content-Language: en
> <
> * Received HTTP code 500 from proxy after CONNECT
> * CONNECT phase completed!
> * Closing connection 10
> curl: (56) Received HTTP code 500 from proxy after CONNECT
> 
> root at testvm:~# curl -x 192.168.3.19:3128 http://webhook.site
> <http://webhook.site> -Lv
> * ? Trying 192.168.3.19:3128...
> * TCP_NODELAY set
> * Connected to 192.168.3.19 (192.168.3.19) port 3128 (#0)
>> GET http://webhook.site/ <http://webhook.site/> HTTP/1.1
>> Host: webhook.site <http://webhook.site>
>> User-Agent: curl/7.68.0
>> Accept: */*
>> Proxy-Connection: Keep-Alive
>>
> * Mark bundle as not supporting multiuse
> < HTTP/1.1 407 Proxy Authentication Required
> < Proxy-Authenticate: BASIC realm="LDAP"
> < Cache-Control: no-cache
> < Pragma: no-cache
> < X-XSS-Protection: 1
> < Content-Type: text/html; charset=utf-8
> < Set-Cookie: BCSI-CS-53409a6e5b6816df=2; Path=/
> < Content-Length: 1582
> < Date: Tue, 26 Oct 2021 07:17:01 GMT
> < X-Cache: MISS from testvm
> < Via: 1.1 testvm (squid/5.2-VCS)
> < Connection: keep-alive
> <
> <HTML><HEAD>
> 
> <TITLE>Access Denied</TITLE>
> 
> <STYLE TYPE="text/css">
> 
> 
> 
> 
> Is there anything that can be done on configuration level to make it work?
> 
> 
> Regards,
> Mateusz
> 
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users
> 



From andre.bolinhas at articatech.com  Fri Dec 10 16:01:37 2021
From: andre.bolinhas at articatech.com (=?UTF-8?Q?Andr=C3=A9_Bolinhas?=)
Date: Fri, 10 Dec 2021 16:01:37 -0000
Subject: [squid-users] deny squid to bump deny_info
In-Reply-To: <f2368559-5b77-171c-b82f-0ca4b9160677@measurement-factory.com>
References: <!&!AAAAAAAAAAAuAAAAAAAAAJJD97gEMN5Ch2HBNn/5W3IBAMO2jhD3dRHOtM0AqgC7tuYAAAAAAA4AABAAAAA/vsnzXWfeQoQx+2MBa2hmAQAAAAA=@articatech.com>
 <58f4c84a-35ca-aa62-43bb-3c4d0fff939f@measurement-factory.com>
 <!&!AAAAAAAAAAAuAAAAAAAAAJJD97gEMN5Ch2HBNn/5W3IBAMO2jhD3dRHOtM0AqgC7tuYAAAAAAA4AABAAAAC9RiWUcHCrQb7c2n+RZsgSAQAAAAA=@articatech.com>
 <f2368559-5b77-171c-b82f-0ca4b9160677@measurement-factory.com>
Message-ID: <00fc01d7eddf$36da11f0$a48e35d0$@articatech.com>

Hi
I put this code at the beginning of squid.conf, just after listen_ports:

http_port 0.0.0.0:3128  name=MyPortNameID1 ssl-bump  generate-host-certificates=on dynamic_cert_mem_cache_size=4MB cert=/etc/squid3/ssl/861be42112afac3b82f6b992bcc464aa.dyn sslflags=VERIFY_CRL_ALL options=NO_SSLv3,No_Compression tls-dh=/etc/squid3/ssl/dhparam.pem

acl denybump dstdomain .xvideos.com
acl CONNECT1 method CONNECT
http_access deny CONNECT1 denybump
ssl_bump terminate denybump
http_access deny denybump

but still don't work, squid continues to bump the error page.

If I change the code to terminat all
acl denybump dstdomain .xvideos.com
acl CONNECT1 method CONNECT
http_access deny CONNECT1 denybump
ssl_bump terminate all
http_access deny denybump

Squid is able to terminate all connections except the xvideos, because xvideos is denied, squid continues to bump it to shot the error page.

You can see the result images here:
gmail bump terminated - https://ibb.co/3MsMt0C
Xvideos bump not terminated - https://ibb.co/b24hL44


-----Mensagem original-----
De: Alex Rousskov <rousskov at measurement-factory.com>
Enviada: 8 de dezembro de 2021 16:02
Para: Andr? Bolinhas <andre.bolinhas at articatech.com>; 
squid-users at lists.squid-cache.org
Assunto: Re: [squid-users] deny squid to bump deny_info

On 12/8/21 10:40 AM, Andr? Bolinhas wrote:
> where I need to add the ssl_bump terminate rule? Inside ssl.conf or 
> http_access.conf?
> I have tried in both both but continues to bump the error page.

Unfortunately, I cannot edit your configuration right now, but others on the 
mailing list may be able to help you. Please note that we do not know how 
those two files are included into your primary configuration file and 
whether that primary configuration file contains any relevant settings 
itself. The primary configuration file is what Squid parses first (e.g., it 
may be specified using "squid -f").


> Also tried ssl_bump terminate all in the top of both files and always
> bump ther error_page.

I am not sure, but AFAICT, Squid bugs notwithstanding, if "ssl_bump 
terminate all" is the very first ssl_bump rule in the entire Squid 
configuration, and Squid still bumps traffic, then you may be denying 
explicit CONNECT requests _before_ SslBump kicks in.

Alex.


> This is my current files:
> http_access.conf
> #### tcp_outgoing_tos ####
> #### tcp_outgoing_tos 0 Rules ####
> # webfilters_sqacls HaClusterClient=0 2 rules [202]
> [class.squid.acls.groups.inc] # webfilters_sqacls #10 : aclport=0 (  )
> [212] [class.squid.acls.groups.inc] # [L.268]: rule id: 10
> access_allow Port Direction=0 () # [L.303]:
> class.squid.acls.groups.inc buildacls_bytype_items(10,..) http_access
> allow Group17 # webfilters_sqacls #5 : aclport=0 (  ) [212]
> [class.squid.acls.groups.inc] # [L.268]: rule id: 5 access_deny Port
> Direction=0 () # [L.303]: class.squid.acls.groups.inc
> buildacls_bytype_items(5,..) # Template Enabled for this ACL.
> # Final acl is all, Template ID=1
> deny_info TEMPLATE_5 all
> http_access deny all
> #
> #
> # ------------------ HTTP ACCESS -------------------- # 0 rule(s) from
> engine (Line 2170)
>
>
> # SquidStandardLDAPAuth = 0
> # EnableOpenLDAP = 0
> # SquidRadiusAuth = 0
> # LDAP_AUTH = 0 caused by EnableOpenLDAP acl MyBlockedIPs src
> "/etc/squid3/acls/DenyIPSrc"
> http_access allow WindowsUpdates
>
> # LDAP Auth = 0
> http_access deny HTTP !Safe_ports all
> http_access deny CONNECT !SSL_ports all http_access deny MyBlockedIPs
> http_access deny blockedsites http_access deny DomainsBlackLists
> http_access deny NetworksBlackLists include
> /etc/squid3/http_access_final.conf
> # END http_access (defaults)
>
> # Allow all networks to finally pass trough proxy.
> http_access allow all
>
> ssl.conf
> # SSL used for port ID 1, :3128 on
> # Patch 2020 - 08 - 03 SquidMikrotikEnabled = 0 # SSL Proxy options
> Proxy version:5.2 [134] sslcrtd_program
> /lib/squid3/security_file_certgen -s /var/lib/squid/session/ssl/ssl_db
> -M 32MB sslcrtd_children 32 startup=5 idle=1 queue-size=64 #The
> AppStore application in IOS (iPhone, iPad, MacOS) uses SSL Certificate
> Pinning, #it means the application knows what certificate to expect when 
> accessing AppStore.
> #When you enable SSL Bump of HTTPS connections Squid replaces the
> default certificate with a  ^`^xmimicked ^`^y one; #the application 
> detects that and refuses to function.
> #
> acl FakeCert ssl::server_name .apple.com acl FakeCert ssl::server_name
> .icloud.com acl FakeCert ssl::server_name .mzstatic.com acl FakeCert
> ssl::server_name .dropbox.com acl FakeCert ssl::server_name
> .bnpparisbas acl ssl_step1 at_step SslBump1 acl ssl_step2 at_step
> SslBump2 acl ssl_step3 at_step SslBump3 ssl_bump peek ssl_step1
> ssl_bump splice GlobalWhitelistDSTNet ssl_bump splice
> GlobalWhitelistDomainsRx ssl_bump splice GlobalWhitelistDomains
> ssl_bump splice FakeCert
>
> # SNI Group google_sni/ssl_sni
> # id:16 Type: ssl_sni
> acl SNIGroup16 ssl::server_name_regex -i accounts\.google\.com
>
> # 0 Splice rules...
> acl KeepSSL ssl::server_name "/etc/squid3/acls_whitelist.dstdomain.conf"
> ssl_bump splice KeepSSL
> ssl_bump splice GlobalWhitelistDSTNet
>
> # Rules (spliced) added by admins....
>
> # 1 BUMP rules...
> #ssl_bump stare all
> ssl_bump bump ssl_step2 SNIGroup16
> ssl_bump splice all
>
> tls_outgoing_options options=NO_SSLv3,NO_TICKET
> cipher=ALL:!SSLv2:!SSLv3:!ADH:!DSS:!MD5:!EXP:!DES:!PSK:!SRP:!RC4:!IDEA
> :!SEED:!aNULL:!eNULL flags=DONT_VERIFY_PEER sslproxy_cert_error allow
> all on_unsupported_protocol tunnel all
>
>
> -----Mensagem original-----
> De: Alex Rousskov <rousskov at measurement-factory.com>
> Enviada: 8 de dezembro de 2021 15:13
> Para: Andr? Bolinhas <andre.bolinhas at articatech.com>;
> squid-users at lists.squid-cache.org
> Assunto: Re: [squid-users] deny squid to bump deny_info
>
> On 12/7/21 8:39 PM, Andr? Bolinhas wrote:
>
>> We use Squid v5 with ssl_bump to decrypt only google domains. With a
>> special configuration we also need to deny important websites. Squid
>> tries to bump returned error pages
>
> Yes, when SslBump encounters an error, it tries to bump the client 
> connection to deliver the error response.
>
> One way to prevent that error handling algorithm from kicking in is to 
> close the offending client connection using an "ssl_bump terminate" rule 
> (instead[1] of blocking client access using "http_access").
>
>
>> We have tried using a TCP_RESET deny_info but this does not fix the
>> bump operation
>
> I suspect the TCP_RESET feature is checked at error delivery time, after 
> the client connection is bumped to prepare it for error delivery. This 
> suspect behavior should be considered a Squid bug/deficiency IMO -- Squid 
> should not be bumping the TLS connection to deliver a TCP RST or FIN 
> packet.
>
> HTH,
>
> Alex.
> [1] It may be a good idea to also/still block client access using 
> http_access rules, as an additional safety layer, but it has to be done 
> carefully so that "ssl_bump terminate" rule matches _before_ any of the 
> corresponding "http_access deny" rules may match.
>
>
>
>> In this peace of log, you can see that squid is forcing bump for
>> Access Denied website under https:
>> 2021/12/08 05:05:53.774 kid2| 85,5| client_side_request.cc(769)
>> clientAccessCheckDone: Access Denied: beacons2.gvt2.com:443
>> 2021/12/08 05:05:53.774 kid2| 85,5| client_side_request.cc(770)
>> clientAccessCheckDone: AclMatchedName = all
>> 2021/12/08 05:05:53.774 kid2| 83,7| LogTags.cc(57) update: TAG_NONE
>> to TCP_DENIED
>> 2021/12/08 05:05:53.774 kid2| 28,4| FilledChecklist.cc(67)
>> ~ACLFilledChecklist: ACLFilledChecklist destroyed 0x7ffc945c5b40
>> 2021/12/08 05:05:53.774 kid2| 28,4| Checklist.cc(197) ~ACLChecklist:
>> ACLChecklist::~ACLChecklist: destroyed 0x7ffc945c5b40
>> 2021/12/08 05:05:53.774 kid2| 85,5| client_side_request.cc(1461)
>> sslBumpAccessCheck: SslBump applies. Force bump action on error
>> UNKNOWN
>> 2021/12/08 05:05:53.774 kid2| 83,3| client_side_request.cc(1562)
>> sslBumpNeed: sslBump required: bump
>> 2021/12/08 05:05:53.774 kid2| 73,3| HttpRequest.cc(683) storeId: sent
>> back
>> effectiveRequestUrl: beacons2.gvt2.com:443
>> 2021/12/08 05:05:53.774 kid2| 24,7| SBuf.cc(160) rawSpace: reserving
>> 1 for
>> SBuf77493929
>> 2021/12/08 05:05:53.774 kid2| 24,7| SBuf.cc(866) reAlloc:
>> SBuf77493929 new store capacity: 40
>> 2021/12/08 05:05:53.774 kid2| 20,3| store.cc(769) storeCreatePureEntry:
>> storeCreateEntry: 'beacons2.gvt2.com:443'
>> 2021/12/08 05:05:53.774 kid2| 20,5| store.cc(349) StoreEntry:
>> StoreEntry constructed, this=0x5561d9347e90
>> 2021/12/08 05:05:53.774 kid2| 20,3| MemObject.cc(100) MemObject:
>> MemObject constructed, this=0x5561d5e66f50
>> 2021/12/08 05:05:53.774 kid2| 55,7| HttpHeader.cc(155) HttpHeader:
>> init-ing
>> hdr: 0x5561d80af128 owner: 3
>> 2021/12/08 05:05:53.774 kid2| 88,3| MemObject.cc(83) setUris:
>> 0x5561d5e66f50
>> storeId: beacons2.gvt2.com:443
>> 2021/12/08 05:05:53.774 kid2| 24,7| SBuf.cc(85) assign: assigning
>> SBuf77493930 from SBuf77493860
>> 2021/12/08 05:05:53.774 kid2| 20,3| store.cc(443) lock:
>> storeCreateEntry locked key [null_store_key] e:=V/0x5561d9347e90*1
>> 2021/12/08 05:05:53.774 kid2| 20,3| store.cc(569) setPrivateKey: 01
>> e:=V/0x5561d9347e90*1
>> 2021/12/08 05:05:53.774 kid2| 20,3| store.cc(421) hashInsert:
>> StoreEntry::hashInsert: Inserting Entry e:=XIV/0x5561d9347e90*1 key
>> '71570400000000002412000002000000'
>> 2021/12/08 05:05:53.774 kid2| 83,3| client_side_request.cc(1562)
>> sslBumpNeed: sslBump required: client-first
>> 2021/12/08 05:05:53.774 kid2| 33,4| ServerBump.cc(28) ServerBump:
>> will peek at beacons2.gvt2.com:443
>> 2021/12/08 05:05:53.774 kid2| 20,3| store.cc(443) lock:
>> Ssl::ServerBump locked key 71570400000000002412000002000000
>> e:=XIV/0x5561d9347e90*2
>> 2021/12/08 05:05:53.774 kid2| 4,4| errorpage.cc(720) errorAppendEntry:
>> storing TEMPLATE_5 in e:=XIV/0x5561d9347e90*2
>> 2021/12/08 05:05:53.774 kid2| 55,7| HttpHeader.cc(155) HttpHeader:
>> init-ing
>> hdr: 0x5561d66a8078 owner: 3
>> 2021/12/08 05:05:53.774 kid2| 4,2| errorpage.cc(1389) buildBody: No
>> existing error page language negotiated for TEMPLATE_5. Using default 
>> error file.
>>
>> Ssl.conf
>> # SSL used for port ID 1, :3128 on
>> # Patch 2020 - 08 - 03 SquidMikrotikEnabled = 0 # SSL Proxy options
>> Proxy
>> version:5.2 [134] sslcrtd_program /lib/squid3/security_file_certgen
>> sslcrtd_children 32 startup=5 idle=1 queue-size=64 #The AppStore
>> application in IOS (iPhone, iPad, MacOS) uses SSL Certificate
>> Pinning, #it means the application knows what certificate to expect when 
>> accessing AppStore.
>> #When you enable SSL Bump of HTTPS connections Squid replaces the
>> default certificate with a  ^`^xmimicked ^`^y one;
>>
>> #the application detects that and refuses to function.
>> #
>> acl FakeCert ssl::server_name .apple.com acl FakeCert
>> ssl::server_name .icloud.com acl FakeCert ssl::server_name
>> .mzstatic.com acl FakeCert ssl::server_name .dropbox.com acl FakeCert
>> ssl::server_name .bnpparisbas acl notbump ssl::server_name
>> .redtube.com acl ssl_step1 at_step SslBump1 acl
>> ssl_step2 at_step SslBump2 acl ssl_step3 at_step SslBump3
>>
>> acl Me dst 127.0.0.1 192.168.58.11
>> acl GlobalWhitelistDSTNet dst "/etc/squid3/acls_whitelist.dst.conf"
>>
>> ssl_bump splice notbump all
>> ssl_bump splice GlobalWhitelistDSTNet
>>
>> ssl_bump splice ssl_step1 Me
>> ssl_bump splice ByPassRBL
>> ssl_bump splice FakeCert
>>
>> # SNI Group sni_domains/ssl_sni
>> # id:7 Type: ssl_sni
>> acl SNIGroup7 ssl::server_name_regex -i account\.google\.com acl
>> SNIGroup7 ssl::server_name_regex -i accounts\.google\.com ssl_bump
>> peek ssl_step1 all # 0 Splice rules...
>> ssl_bump splice ByPassRBL
>> ssl_bump splice GlobalWhitelistDSTNet
>>
>> # Rules (spliced) added by admins....
>>
>> # 1 BUMP rules...
>> ssl_bump bump ssl_step2 SNIGroup7
>> ssl_bump splice all
>>
>> tls_outgoing_options options=NO_SSLv3,NO_TICKET
>> cipher=ALL:!SSLv2:!SSLv3:!ADH:!DSS:!MD5:!EXP:!DES:!PSK:!SRP:!RC4:!IDE
>> A :!SEED :!aNULL:!eNULL flags=DONT_VERIFY_PEER sslproxy_cert_error
>> allow all
>>
>> http_access.conf
>> #### tcp_outgoing_tos ####
>> #### tcp_outgoing_tos 0 Rules ####
>> # SquidUrgency = 0 exec.squid.global.access.php[2233]
>> #       HaClusterClient=0 class.squid.acls.groups.inc/buildacls_order
>> #       mysql_for_port='' aclgpid=0 [L.174]
>> #       [3] rules [220]
>>
>>
>> # webfilters_sqacls #2 : aclport=0 (  ) [239]
>> [class.squid.acls.groups.inc] # [L.292]: rule id: 2 access_allow Port 
>> Direction=0 () # [L.320]:
>> class.squid.acls.groups.inc buildacls_bytype_items(2,..) acl
>> AnnotateRule2 annotate_transaction accessrule=Rule2 http_access allow
>> Group2 AnnotateRule2 # webfilters_sqacls #4 : aclport=0 (  ) [239]
>> [class.squid.acls.groups.inc] # [L.292]: rule id: 4 access_allow Port 
>> Direction=0 () # [L.320]:
>> class.squid.acls.groups.inc buildacls_bytype_items(4,..) acl
>> AnnotateRule4 annotate_transaction accessrule=Rule4 http_access allow
>> Group8 AnnotateRule4 # webfilters_sqacls #3 : aclport=0 (  ) [239]
>> [class.squid.acls.groups.inc] # [L.292]: rule id: 3 access_deny Port 
>> Direction=0 () # [L.320]:
>> class.squid.acls.groups.inc buildacls_bytype_items(3,..) # Template
>> Enabled for this ACL.
>> # Final acl is all, Template ID=1
>> acl AnnotateRule3 annotate_transaction accessrule=Rule3 http_access
>> deny CONNECT  AnnotateRule3 deny_info TCP_RESET AnnotateRule3
>>
>> acl MyAll dst 0.0.0.0/0
>> http_access deny Myall
>> deny_info 302:http://artica/me Myall
>> #
>> #
>> # ------------------ HTTP ACCESS -------------------- # 0 rule(s)
>> from engine (Line 2240)
>>
>>
>> #
>> # SquidStandardLDAPAuth = 0
>> # EnableOpenLDAP = 0
>> # SquidRadiusAuth = 0
>> # LDAP_AUTH = 0 caused by EnableOpenLDAP acl MyBlockedIPs src
>> "/etc/squid3/acls/DenyIPSrc"
>> acl AnnotateWindowsUpdates annotate_transaction
>> accessrule=AllowWindowsUpdates http_access allow WindowsUpdates
>> AnnotateWindowsUpdates # # -------------------- AUTH Schemes Squid
>> v5.2-----------------------
>>
>> # ----------------------------------------------------------
>>
>> # LDAP Auth = 0
>> acl AnnotateSafePorts annotate_transaction
>> accessrule=deny_remote_ports http_access deny HTTP !Safe_ports all
>> AnnotateSafePorts http_access deny CONNECT !SSL_ports all
>> AnnotateSafePorts deny_info TCP_RESET all
>>
>> acl AnnotateBLK annotate_transaction accessrule=global_blacklist
>> http_access deny MyBlockedIPs AnnotateBLK http_access deny
>> blockedsites AnnotateBLK http_access deny DomainsBlackLists
>> AnnotateBLK http_access deny NetworksBlackLists AnnotateBLK include
>> /etc/squid3/http_access_final.conf
>> # END http_access (defaults)
>>
>> _______________________________________________
>> squid-users mailing list
>> squid-users at lists.squid-cache.org
>> http://lists.squid-cache.org/listinfo/squid-users
>>
>




From rousskov at measurement-factory.com  Fri Dec 10 16:42:17 2021
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Fri, 10 Dec 2021 11:42:17 -0500
Subject: [squid-users] deny squid to bump deny_info
In-Reply-To: <00fc01d7eddf$36da11f0$a48e35d0$@articatech.com>
References: <!&!AAAAAAAAAAAuAAAAAAAAAJJD97gEMN5Ch2HBNn/5W3IBAMO2jhD3dRHOtM0AqgC7tuYAAAAAAA4AABAAAAA/vsnzXWfeQoQx+2MBa2hmAQAAAAA=@articatech.com>
 <58f4c84a-35ca-aa62-43bb-3c4d0fff939f@measurement-factory.com>
 <!&!AAAAAAAAAAAuAAAAAAAAAJJD97gEMN5Ch2HBNn/5W3IBAMO2jhD3dRHOtM0AqgC7tuYAAAAAAA4AABAAAAC9RiWUcHCrQb7c2n+RZsgSAQAAAAA=@articatech.com>
 <f2368559-5b77-171c-b82f-0ca4b9160677@measurement-factory.com>
 <00fc01d7eddf$36da11f0$a48e35d0$@articatech.com>
Message-ID: <22104749-ae04-10e6-2e4e-50ce1d76c83d@measurement-factory.com>

On 12/10/21 11:01 AM, Andr? Bolinhas wrote:

> I put this code at the beginning of squid.conf, just after listen_ports:
> 
> http_port 0.0.0.0:3128  name=MyPortNameID1 ssl-bump  generate-host-certificates=on dynamic_cert_mem_cache_size=4MB cert=/etc/squid3/ssl/861be42112afac3b82f6b992bcc464aa.dyn sslflags=VERIFY_CRL_ALL options=NO_SSLv3,No_Compression tls-dh=/etc/squid3/ssl/dhparam.pem
> 
> acl denybump dstdomain .xvideos.com
> acl CONNECT1 method CONNECT
> http_access deny CONNECT1 denybump
> ssl_bump terminate denybump
> http_access deny denybump
> 
> but still don't work, squid continues to bump the error page.
> 
> If I change the code to terminat all
> acl denybump dstdomain .xvideos.com
> acl CONNECT1 method CONNECT
> http_access deny CONNECT1 denybump
> ssl_bump terminate all
> http_access deny denybump
> 
> Squid is able to terminate all connections except the xvideos, because xvideos is denied, squid continues to bump it to shot the error page.

AFAICT, your configuration denies CONNECT requests _before_ "ssl_bump
terminate" logic kicks in. The existing SslBump documentation can be
interpreted as matching what is going on in your tests; see steps 1.ii
and 1.iii at https://wiki.squid-cache.org/Features/SslPeekAndSplice

We probably should document that a step1 http_access denial (which
happens during step 1.ii) blocks/prevents ssl_bump rules evaluation
(which happens in step 1.iii).

My recommendation from the very first response on this email thread
still stands: Close the offending client connection using an "ssl_bump
terminate" rule instead[1] of blocking client access using "http_access".

[1] It may be a good idea to also/still block client access using
http_access rules, as an additional safety layer, but it has to be done
carefully so that "ssl_bump terminate" rule matches _before_ any of the
corresponding "http_access deny" rules may match. For example, the two
rules cannot have exactly the same condition because step 1.ii happens
before step 1.iii.


HTH,

Alex.

> You can see the result images here:
> gmail bump terminated - https://ibb.co/3MsMt0C
> Xvideos bump not terminated - https://ibb.co/b24hL44
> 
> 
> -----Mensagem original-----
> De: Alex Rousskov <rousskov at measurement-factory.com>
> Enviada: 8 de dezembro de 2021 16:02
> Para: Andr? Bolinhas <andre.bolinhas at articatech.com>; 
> squid-users at lists.squid-cache.org
> Assunto: Re: [squid-users] deny squid to bump deny_info
> 
> On 12/8/21 10:40 AM, Andr? Bolinhas wrote:
>> where I need to add the ssl_bump terminate rule? Inside ssl.conf or 
>> http_access.conf?
>> I have tried in both both but continues to bump the error page.
> 
> Unfortunately, I cannot edit your configuration right now, but others on the 
> mailing list may be able to help you. Please note that we do not know how 
> those two files are included into your primary configuration file and 
> whether that primary configuration file contains any relevant settings 
> itself. The primary configuration file is what Squid parses first (e.g., it 
> may be specified using "squid -f").
> 
> 
>> Also tried ssl_bump terminate all in the top of both files and always
>> bump ther error_page.
> 
> I am not sure, but AFAICT, Squid bugs notwithstanding, if "ssl_bump 
> terminate all" is the very first ssl_bump rule in the entire Squid 
> configuration, and Squid still bumps traffic, then you may be denying 
> explicit CONNECT requests _before_ SslBump kicks in.
> 
> Alex.
> 
> 
>> This is my current files:
>> http_access.conf
>> #### tcp_outgoing_tos ####
>> #### tcp_outgoing_tos 0 Rules ####
>> # webfilters_sqacls HaClusterClient=0 2 rules [202]
>> [class.squid.acls.groups.inc] # webfilters_sqacls #10 : aclport=0 (  )
>> [212] [class.squid.acls.groups.inc] # [L.268]: rule id: 10
>> access_allow Port Direction=0 () # [L.303]:
>> class.squid.acls.groups.inc buildacls_bytype_items(10,..) http_access
>> allow Group17 # webfilters_sqacls #5 : aclport=0 (  ) [212]
>> [class.squid.acls.groups.inc] # [L.268]: rule id: 5 access_deny Port
>> Direction=0 () # [L.303]: class.squid.acls.groups.inc
>> buildacls_bytype_items(5,..) # Template Enabled for this ACL.
>> # Final acl is all, Template ID=1
>> deny_info TEMPLATE_5 all
>> http_access deny all
>> #
>> #
>> # ------------------ HTTP ACCESS -------------------- # 0 rule(s) from
>> engine (Line 2170)
>>
>>
>> # SquidStandardLDAPAuth = 0
>> # EnableOpenLDAP = 0
>> # SquidRadiusAuth = 0
>> # LDAP_AUTH = 0 caused by EnableOpenLDAP acl MyBlockedIPs src
>> "/etc/squid3/acls/DenyIPSrc"
>> http_access allow WindowsUpdates
>>
>> # LDAP Auth = 0
>> http_access deny HTTP !Safe_ports all
>> http_access deny CONNECT !SSL_ports all http_access deny MyBlockedIPs
>> http_access deny blockedsites http_access deny DomainsBlackLists
>> http_access deny NetworksBlackLists include
>> /etc/squid3/http_access_final.conf
>> # END http_access (defaults)
>>
>> # Allow all networks to finally pass trough proxy.
>> http_access allow all
>>
>> ssl.conf
>> # SSL used for port ID 1, :3128 on
>> # Patch 2020 - 08 - 03 SquidMikrotikEnabled = 0 # SSL Proxy options
>> Proxy version:5.2 [134] sslcrtd_program
>> /lib/squid3/security_file_certgen -s /var/lib/squid/session/ssl/ssl_db
>> -M 32MB sslcrtd_children 32 startup=5 idle=1 queue-size=64 #The
>> AppStore application in IOS (iPhone, iPad, MacOS) uses SSL Certificate
>> Pinning, #it means the application knows what certificate to expect when 
>> accessing AppStore.
>> #When you enable SSL Bump of HTTPS connections Squid replaces the
>> default certificate with a  ^`^xmimicked ^`^y one; #the application 
>> detects that and refuses to function.
>> #
>> acl FakeCert ssl::server_name .apple.com acl FakeCert ssl::server_name
>> .icloud.com acl FakeCert ssl::server_name .mzstatic.com acl FakeCert
>> ssl::server_name .dropbox.com acl FakeCert ssl::server_name
>> .bnpparisbas acl ssl_step1 at_step SslBump1 acl ssl_step2 at_step
>> SslBump2 acl ssl_step3 at_step SslBump3 ssl_bump peek ssl_step1
>> ssl_bump splice GlobalWhitelistDSTNet ssl_bump splice
>> GlobalWhitelistDomainsRx ssl_bump splice GlobalWhitelistDomains
>> ssl_bump splice FakeCert
>>
>> # SNI Group google_sni/ssl_sni
>> # id:16 Type: ssl_sni
>> acl SNIGroup16 ssl::server_name_regex -i accounts\.google\.com
>>
>> # 0 Splice rules...
>> acl KeepSSL ssl::server_name "/etc/squid3/acls_whitelist.dstdomain.conf"
>> ssl_bump splice KeepSSL
>> ssl_bump splice GlobalWhitelistDSTNet
>>
>> # Rules (spliced) added by admins....
>>
>> # 1 BUMP rules...
>> #ssl_bump stare all
>> ssl_bump bump ssl_step2 SNIGroup16
>> ssl_bump splice all
>>
>> tls_outgoing_options options=NO_SSLv3,NO_TICKET
>> cipher=ALL:!SSLv2:!SSLv3:!ADH:!DSS:!MD5:!EXP:!DES:!PSK:!SRP:!RC4:!IDEA
>> :!SEED:!aNULL:!eNULL flags=DONT_VERIFY_PEER sslproxy_cert_error allow
>> all on_unsupported_protocol tunnel all
>>
>>
>> -----Mensagem original-----
>> De: Alex Rousskov <rousskov at measurement-factory.com>
>> Enviada: 8 de dezembro de 2021 15:13
>> Para: Andr? Bolinhas <andre.bolinhas at articatech.com>;
>> squid-users at lists.squid-cache.org
>> Assunto: Re: [squid-users] deny squid to bump deny_info
>>
>> On 12/7/21 8:39 PM, Andr? Bolinhas wrote:
>>
>>> We use Squid v5 with ssl_bump to decrypt only google domains. With a
>>> special configuration we also need to deny important websites. Squid
>>> tries to bump returned error pages
>>
>> Yes, when SslBump encounters an error, it tries to bump the client 
>> connection to deliver the error response.
>>
>> One way to prevent that error handling algorithm from kicking in is to 
>> close the offending client connection using an "ssl_bump terminate" rule 
>> (instead[1] of blocking client access using "http_access").
>>
>>
>>> We have tried using a TCP_RESET deny_info but this does not fix the
>>> bump operation
>>
>> I suspect the TCP_RESET feature is checked at error delivery time, after 
>> the client connection is bumped to prepare it for error delivery. This 
>> suspect behavior should be considered a Squid bug/deficiency IMO -- Squid 
>> should not be bumping the TLS connection to deliver a TCP RST or FIN 
>> packet.
>>
>> HTH,
>>
>> Alex.
>> [1] It may be a good idea to also/still block client access using 
>> http_access rules, as an additional safety layer, but it has to be done 
>> carefully so that "ssl_bump terminate" rule matches _before_ any of the 
>> corresponding "http_access deny" rules may match.
>>
>>
>>
>>> In this peace of log, you can see that squid is forcing bump for
>>> Access Denied website under https:
>>> 2021/12/08 05:05:53.774 kid2| 85,5| client_side_request.cc(769)
>>> clientAccessCheckDone: Access Denied: beacons2.gvt2.com:443
>>> 2021/12/08 05:05:53.774 kid2| 85,5| client_side_request.cc(770)
>>> clientAccessCheckDone: AclMatchedName = all
>>> 2021/12/08 05:05:53.774 kid2| 83,7| LogTags.cc(57) update: TAG_NONE
>>> to TCP_DENIED
>>> 2021/12/08 05:05:53.774 kid2| 28,4| FilledChecklist.cc(67)
>>> ~ACLFilledChecklist: ACLFilledChecklist destroyed 0x7ffc945c5b40
>>> 2021/12/08 05:05:53.774 kid2| 28,4| Checklist.cc(197) ~ACLChecklist:
>>> ACLChecklist::~ACLChecklist: destroyed 0x7ffc945c5b40
>>> 2021/12/08 05:05:53.774 kid2| 85,5| client_side_request.cc(1461)
>>> sslBumpAccessCheck: SslBump applies. Force bump action on error
>>> UNKNOWN
>>> 2021/12/08 05:05:53.774 kid2| 83,3| client_side_request.cc(1562)
>>> sslBumpNeed: sslBump required: bump
>>> 2021/12/08 05:05:53.774 kid2| 73,3| HttpRequest.cc(683) storeId: sent
>>> back
>>> effectiveRequestUrl: beacons2.gvt2.com:443
>>> 2021/12/08 05:05:53.774 kid2| 24,7| SBuf.cc(160) rawSpace: reserving
>>> 1 for
>>> SBuf77493929
>>> 2021/12/08 05:05:53.774 kid2| 24,7| SBuf.cc(866) reAlloc:
>>> SBuf77493929 new store capacity: 40
>>> 2021/12/08 05:05:53.774 kid2| 20,3| store.cc(769) storeCreatePureEntry:
>>> storeCreateEntry: 'beacons2.gvt2.com:443'
>>> 2021/12/08 05:05:53.774 kid2| 20,5| store.cc(349) StoreEntry:
>>> StoreEntry constructed, this=0x5561d9347e90
>>> 2021/12/08 05:05:53.774 kid2| 20,3| MemObject.cc(100) MemObject:
>>> MemObject constructed, this=0x5561d5e66f50
>>> 2021/12/08 05:05:53.774 kid2| 55,7| HttpHeader.cc(155) HttpHeader:
>>> init-ing
>>> hdr: 0x5561d80af128 owner: 3
>>> 2021/12/08 05:05:53.774 kid2| 88,3| MemObject.cc(83) setUris:
>>> 0x5561d5e66f50
>>> storeId: beacons2.gvt2.com:443
>>> 2021/12/08 05:05:53.774 kid2| 24,7| SBuf.cc(85) assign: assigning
>>> SBuf77493930 from SBuf77493860
>>> 2021/12/08 05:05:53.774 kid2| 20,3| store.cc(443) lock:
>>> storeCreateEntry locked key [null_store_key] e:=V/0x5561d9347e90*1
>>> 2021/12/08 05:05:53.774 kid2| 20,3| store.cc(569) setPrivateKey: 01
>>> e:=V/0x5561d9347e90*1
>>> 2021/12/08 05:05:53.774 kid2| 20,3| store.cc(421) hashInsert:
>>> StoreEntry::hashInsert: Inserting Entry e:=XIV/0x5561d9347e90*1 key
>>> '71570400000000002412000002000000'
>>> 2021/12/08 05:05:53.774 kid2| 83,3| client_side_request.cc(1562)
>>> sslBumpNeed: sslBump required: client-first
>>> 2021/12/08 05:05:53.774 kid2| 33,4| ServerBump.cc(28) ServerBump:
>>> will peek at beacons2.gvt2.com:443
>>> 2021/12/08 05:05:53.774 kid2| 20,3| store.cc(443) lock:
>>> Ssl::ServerBump locked key 71570400000000002412000002000000
>>> e:=XIV/0x5561d9347e90*2
>>> 2021/12/08 05:05:53.774 kid2| 4,4| errorpage.cc(720) errorAppendEntry:
>>> storing TEMPLATE_5 in e:=XIV/0x5561d9347e90*2
>>> 2021/12/08 05:05:53.774 kid2| 55,7| HttpHeader.cc(155) HttpHeader:
>>> init-ing
>>> hdr: 0x5561d66a8078 owner: 3
>>> 2021/12/08 05:05:53.774 kid2| 4,2| errorpage.cc(1389) buildBody: No
>>> existing error page language negotiated for TEMPLATE_5. Using default 
>>> error file.
>>>
>>> Ssl.conf
>>> # SSL used for port ID 1, :3128 on
>>> # Patch 2020 - 08 - 03 SquidMikrotikEnabled = 0 # SSL Proxy options
>>> Proxy
>>> version:5.2 [134] sslcrtd_program /lib/squid3/security_file_certgen
>>> sslcrtd_children 32 startup=5 idle=1 queue-size=64 #The AppStore
>>> application in IOS (iPhone, iPad, MacOS) uses SSL Certificate
>>> Pinning, #it means the application knows what certificate to expect when 
>>> accessing AppStore.
>>> #When you enable SSL Bump of HTTPS connections Squid replaces the
>>> default certificate with a  ^`^xmimicked ^`^y one;
>>>
>>> #the application detects that and refuses to function.
>>> #
>>> acl FakeCert ssl::server_name .apple.com acl FakeCert
>>> ssl::server_name .icloud.com acl FakeCert ssl::server_name
>>> .mzstatic.com acl FakeCert ssl::server_name .dropbox.com acl FakeCert
>>> ssl::server_name .bnpparisbas acl notbump ssl::server_name
>>> .redtube.com acl ssl_step1 at_step SslBump1 acl
>>> ssl_step2 at_step SslBump2 acl ssl_step3 at_step SslBump3
>>>
>>> acl Me dst 127.0.0.1 192.168.58.11
>>> acl GlobalWhitelistDSTNet dst "/etc/squid3/acls_whitelist.dst.conf"
>>>
>>> ssl_bump splice notbump all
>>> ssl_bump splice GlobalWhitelistDSTNet
>>>
>>> ssl_bump splice ssl_step1 Me
>>> ssl_bump splice ByPassRBL
>>> ssl_bump splice FakeCert
>>>
>>> # SNI Group sni_domains/ssl_sni
>>> # id:7 Type: ssl_sni
>>> acl SNIGroup7 ssl::server_name_regex -i account\.google\.com acl
>>> SNIGroup7 ssl::server_name_regex -i accounts\.google\.com ssl_bump
>>> peek ssl_step1 all # 0 Splice rules...
>>> ssl_bump splice ByPassRBL
>>> ssl_bump splice GlobalWhitelistDSTNet
>>>
>>> # Rules (spliced) added by admins....
>>>
>>> # 1 BUMP rules...
>>> ssl_bump bump ssl_step2 SNIGroup7
>>> ssl_bump splice all
>>>
>>> tls_outgoing_options options=NO_SSLv3,NO_TICKET
>>> cipher=ALL:!SSLv2:!SSLv3:!ADH:!DSS:!MD5:!EXP:!DES:!PSK:!SRP:!RC4:!IDE
>>> A :!SEED :!aNULL:!eNULL flags=DONT_VERIFY_PEER sslproxy_cert_error
>>> allow all
>>>
>>> http_access.conf
>>> #### tcp_outgoing_tos ####
>>> #### tcp_outgoing_tos 0 Rules ####
>>> # SquidUrgency = 0 exec.squid.global.access.php[2233]
>>> #       HaClusterClient=0 class.squid.acls.groups.inc/buildacls_order
>>> #       mysql_for_port='' aclgpid=0 [L.174]
>>> #       [3] rules [220]
>>>
>>>
>>> # webfilters_sqacls #2 : aclport=0 (  ) [239]
>>> [class.squid.acls.groups.inc] # [L.292]: rule id: 2 access_allow Port 
>>> Direction=0 () # [L.320]:
>>> class.squid.acls.groups.inc buildacls_bytype_items(2,..) acl
>>> AnnotateRule2 annotate_transaction accessrule=Rule2 http_access allow
>>> Group2 AnnotateRule2 # webfilters_sqacls #4 : aclport=0 (  ) [239]
>>> [class.squid.acls.groups.inc] # [L.292]: rule id: 4 access_allow Port 
>>> Direction=0 () # [L.320]:
>>> class.squid.acls.groups.inc buildacls_bytype_items(4,..) acl
>>> AnnotateRule4 annotate_transaction accessrule=Rule4 http_access allow
>>> Group8 AnnotateRule4 # webfilters_sqacls #3 : aclport=0 (  ) [239]
>>> [class.squid.acls.groups.inc] # [L.292]: rule id: 3 access_deny Port 
>>> Direction=0 () # [L.320]:
>>> class.squid.acls.groups.inc buildacls_bytype_items(3,..) # Template
>>> Enabled for this ACL.
>>> # Final acl is all, Template ID=1
>>> acl AnnotateRule3 annotate_transaction accessrule=Rule3 http_access
>>> deny CONNECT  AnnotateRule3 deny_info TCP_RESET AnnotateRule3
>>>
>>> acl MyAll dst 0.0.0.0/0
>>> http_access deny Myall
>>> deny_info 302:http://artica/me Myall
>>> #
>>> #
>>> # ------------------ HTTP ACCESS -------------------- # 0 rule(s)
>>> from engine (Line 2240)
>>>
>>>
>>> #
>>> # SquidStandardLDAPAuth = 0
>>> # EnableOpenLDAP = 0
>>> # SquidRadiusAuth = 0
>>> # LDAP_AUTH = 0 caused by EnableOpenLDAP acl MyBlockedIPs src
>>> "/etc/squid3/acls/DenyIPSrc"
>>> acl AnnotateWindowsUpdates annotate_transaction
>>> accessrule=AllowWindowsUpdates http_access allow WindowsUpdates
>>> AnnotateWindowsUpdates # # -------------------- AUTH Schemes Squid
>>> v5.2-----------------------
>>>
>>> # ----------------------------------------------------------
>>>
>>> # LDAP Auth = 0
>>> acl AnnotateSafePorts annotate_transaction
>>> accessrule=deny_remote_ports http_access deny HTTP !Safe_ports all
>>> AnnotateSafePorts http_access deny CONNECT !SSL_ports all
>>> AnnotateSafePorts deny_info TCP_RESET all
>>>
>>> acl AnnotateBLK annotate_transaction accessrule=global_blacklist
>>> http_access deny MyBlockedIPs AnnotateBLK http_access deny
>>> blockedsites AnnotateBLK http_access deny DomainsBlackLists
>>> AnnotateBLK http_access deny NetworksBlackLists AnnotateBLK include
>>> /etc/squid3/http_access_final.conf
>>> # END http_access (defaults)
>>>
>>> _______________________________________________
>>> squid-users mailing list
>>> squid-users at lists.squid-cache.org
>>> http://lists.squid-cache.org/listinfo/squid-users
>>>
>>
> 



From andre.bolinhas at articatech.com  Fri Dec 10 23:03:10 2021
From: andre.bolinhas at articatech.com (=?UTF-8?Q?Andr=C3=A9_Bolinhas?=)
Date: Fri, 10 Dec 2021 23:03:10 -0000
Subject: [squid-users] deny squid to bump deny_info
In-Reply-To: <22104749-ae04-10e6-2e4e-50ce1d76c83d@measurement-factory.com>
References: <!&!AAAAAAAAAAAuAAAAAAAAAJJD97gEMN5Ch2HBNn/5W3IBAMO2jhD3dRHOtM0AqgC7tuYAAAAAAA4AABAAAAA/vsnzXWfeQoQx+2MBa2hmAQAAAAA=@articatech.com>
 <58f4c84a-35ca-aa62-43bb-3c4d0fff939f@measurement-factory.com>
 <!&!AAAAAAAAAAAuAAAAAAAAAJJD97gEMN5Ch2HBNn/5W3IBAMO2jhD3dRHOtM0AqgC7tuYAAAAAAA4AABAAAAC9RiWUcHCrQb7c2n+RZsgSAQAAAAA=@articatech.com>
 <f2368559-5b77-171c-b82f-0ca4b9160677@measurement-factory.com>
 <00fc01d7eddf$36da11f0$a48e35d0$@articatech.com>
 <22104749-ae04-10e6-2e4e-50ce1d76c83d@measurement-factory.com>
Message-ID: <!&!AAAAAAAAAAAuAAAAAAAAAJJD97gEMN5Ch2HBNn/5W3IBAMO2jhD3dRHOtM0AqgC7tuYAAAAAAA4AABAAAAC+XiB/A/C0QZAesfoTnTsTAQAAAAA=@articatech.com>

Hi, 
Actually if I remove http_access deny I works, squid is manage to terminate the connection for the https blocked sites, but this causes a new issue, even mange to block all https request without bump it, now all http request are allowed now.


-----Mensagem original-----
De: Alex Rousskov <rousskov at measurement-factory.com> 
Enviada: 10 de dezembro de 2021 16:42
Para: Andr? Bolinhas <andre.bolinhas at articatech.com>; squid-users at lists.squid-cache.org
Assunto: Re: [squid-users] deny squid to bump deny_info

On 12/10/21 11:01 AM, Andr? Bolinhas wrote:

> I put this code at the beginning of squid.conf, just after listen_ports:
> 
> http_port 0.0.0.0:3128  name=MyPortNameID1 ssl-bump  
> generate-host-certificates=on dynamic_cert_mem_cache_size=4MB 
> cert=/etc/squid3/ssl/861be42112afac3b82f6b992bcc464aa.dyn 
> sslflags=VERIFY_CRL_ALL options=NO_SSLv3,No_Compression 
> tls-dh=/etc/squid3/ssl/dhparam.pem
> 
> acl denybump dstdomain .xvideos.com
> acl CONNECT1 method CONNECT
> http_access deny CONNECT1 denybump
> ssl_bump terminate denybump
> http_access deny denybump
> 
> but still don't work, squid continues to bump the error page.
> 
> If I change the code to terminat all
> acl denybump dstdomain .xvideos.com
> acl CONNECT1 method CONNECT
> http_access deny CONNECT1 denybump
> ssl_bump terminate all
> http_access deny denybump
> 
> Squid is able to terminate all connections except the xvideos, because xvideos is denied, squid continues to bump it to shot the error page.

AFAICT, your configuration denies CONNECT requests _before_ "ssl_bump terminate" logic kicks in. The existing SslBump documentation can be interpreted as matching what is going on in your tests; see steps 1.ii and 1.iii at https://wiki.squid-cache.org/Features/SslPeekAndSplice

We probably should document that a step1 http_access denial (which happens during step 1.ii) blocks/prevents ssl_bump rules evaluation (which happens in step 1.iii).

My recommendation from the very first response on this email thread still stands: Close the offending client connection using an "ssl_bump terminate" rule instead[1] of blocking client access using "http_access".

[1] It may be a good idea to also/still block client access using http_access rules, as an additional safety layer, but it has to be done carefully so that "ssl_bump terminate" rule matches _before_ any of the corresponding "http_access deny" rules may match. For example, the two rules cannot have exactly the same condition because step 1.ii happens before step 1.iii.


HTH,

Alex.

> You can see the result images here:
> gmail bump terminated - https://ibb.co/3MsMt0C Xvideos bump not 
> terminated - https://ibb.co/b24hL44
> 
> 
> -----Mensagem original-----
> De: Alex Rousskov <rousskov at measurement-factory.com>
> Enviada: 8 de dezembro de 2021 16:02
> Para: Andr? Bolinhas <andre.bolinhas at articatech.com>; 
> squid-users at lists.squid-cache.org
> Assunto: Re: [squid-users] deny squid to bump deny_info
> 
> On 12/8/21 10:40 AM, Andr? Bolinhas wrote:
>> where I need to add the ssl_bump terminate rule? Inside ssl.conf or 
>> http_access.conf?
>> I have tried in both both but continues to bump the error page.
> 
> Unfortunately, I cannot edit your configuration right now, but others 
> on the mailing list may be able to help you. Please note that we do 
> not know how those two files are included into your primary 
> configuration file and whether that primary configuration file 
> contains any relevant settings itself. The primary configuration file 
> is what Squid parses first (e.g., it may be specified using "squid -f").
> 
> 
>> Also tried ssl_bump terminate all in the top of both files and always 
>> bump ther error_page.
> 
> I am not sure, but AFAICT, Squid bugs notwithstanding, if "ssl_bump 
> terminate all" is the very first ssl_bump rule in the entire Squid 
> configuration, and Squid still bumps traffic, then you may be denying 
> explicit CONNECT requests _before_ SslBump kicks in.
> 
> Alex.
> 
> 
>> This is my current files:
>> http_access.conf
>> #### tcp_outgoing_tos ####
>> #### tcp_outgoing_tos 0 Rules ####
>> # webfilters_sqacls HaClusterClient=0 2 rules [202] 
>> [class.squid.acls.groups.inc] # webfilters_sqacls #10 : aclport=0 (  
>> ) [212] [class.squid.acls.groups.inc] # [L.268]: rule id: 10 
>> access_allow Port Direction=0 () # [L.303]:
>> class.squid.acls.groups.inc buildacls_bytype_items(10,..) http_access 
>> allow Group17 # webfilters_sqacls #5 : aclport=0 (  ) [212] 
>> [class.squid.acls.groups.inc] # [L.268]: rule id: 5 access_deny Port
>> Direction=0 () # [L.303]: class.squid.acls.groups.inc
>> buildacls_bytype_items(5,..) # Template Enabled for this ACL.
>> # Final acl is all, Template ID=1
>> deny_info TEMPLATE_5 all
>> http_access deny all
>> #
>> #
>> # ------------------ HTTP ACCESS -------------------- # 0 rule(s) 
>> from engine (Line 2170)
>>
>>
>> # SquidStandardLDAPAuth = 0
>> # EnableOpenLDAP = 0
>> # SquidRadiusAuth = 0
>> # LDAP_AUTH = 0 caused by EnableOpenLDAP acl MyBlockedIPs src 
>> "/etc/squid3/acls/DenyIPSrc"
>> http_access allow WindowsUpdates
>>
>> # LDAP Auth = 0
>> http_access deny HTTP !Safe_ports all http_access deny CONNECT 
>> !SSL_ports all http_access deny MyBlockedIPs http_access deny 
>> blockedsites http_access deny DomainsBlackLists http_access deny 
>> NetworksBlackLists include /etc/squid3/http_access_final.conf
>> # END http_access (defaults)
>>
>> # Allow all networks to finally pass trough proxy.
>> http_access allow all
>>
>> ssl.conf
>> # SSL used for port ID 1, :3128 on
>> # Patch 2020 - 08 - 03 SquidMikrotikEnabled = 0 # SSL Proxy options 
>> Proxy version:5.2 [134] sslcrtd_program 
>> /lib/squid3/security_file_certgen -s 
>> /var/lib/squid/session/ssl/ssl_db -M 32MB sslcrtd_children 32 
>> startup=5 idle=1 queue-size=64 #The AppStore application in IOS 
>> (iPhone, iPad, MacOS) uses SSL Certificate Pinning, #it means the 
>> application knows what certificate to expect when accessing AppStore.
>> #When you enable SSL Bump of HTTPS connections Squid replaces the 
>> default certificate with a  ^`^xmimicked ^`^y one; #the application 
>> detects that and refuses to function.
>> #
>> acl FakeCert ssl::server_name .apple.com acl FakeCert 
>> ssl::server_name .icloud.com acl FakeCert ssl::server_name 
>> .mzstatic.com acl FakeCert ssl::server_name .dropbox.com acl FakeCert 
>> ssl::server_name .bnpparisbas acl ssl_step1 at_step SslBump1 acl 
>> ssl_step2 at_step
>> SslBump2 acl ssl_step3 at_step SslBump3 ssl_bump peek ssl_step1 
>> ssl_bump splice GlobalWhitelistDSTNet ssl_bump splice 
>> GlobalWhitelistDomainsRx ssl_bump splice GlobalWhitelistDomains 
>> ssl_bump splice FakeCert
>>
>> # SNI Group google_sni/ssl_sni
>> # id:16 Type: ssl_sni
>> acl SNIGroup16 ssl::server_name_regex -i accounts\.google\.com
>>
>> # 0 Splice rules...
>> acl KeepSSL ssl::server_name "/etc/squid3/acls_whitelist.dstdomain.conf"
>> ssl_bump splice KeepSSL
>> ssl_bump splice GlobalWhitelistDSTNet
>>
>> # Rules (spliced) added by admins....
>>
>> # 1 BUMP rules...
>> #ssl_bump stare all
>> ssl_bump bump ssl_step2 SNIGroup16
>> ssl_bump splice all
>>
>> tls_outgoing_options options=NO_SSLv3,NO_TICKET 
>> cipher=ALL:!SSLv2:!SSLv3:!ADH:!DSS:!MD5:!EXP:!DES:!PSK:!SRP:!RC4:!IDE
>> A :!SEED:!aNULL:!eNULL flags=DONT_VERIFY_PEER sslproxy_cert_error 
>> allow all on_unsupported_protocol tunnel all
>>
>>
>> -----Mensagem original-----
>> De: Alex Rousskov <rousskov at measurement-factory.com>
>> Enviada: 8 de dezembro de 2021 15:13
>> Para: Andr? Bolinhas <andre.bolinhas at articatech.com>; 
>> squid-users at lists.squid-cache.org
>> Assunto: Re: [squid-users] deny squid to bump deny_info
>>
>> On 12/7/21 8:39 PM, Andr? Bolinhas wrote:
>>
>>> We use Squid v5 with ssl_bump to decrypt only google domains. With a 
>>> special configuration we also need to deny important websites. Squid 
>>> tries to bump returned error pages
>>
>> Yes, when SslBump encounters an error, it tries to bump the client 
>> connection to deliver the error response.
>>
>> One way to prevent that error handling algorithm from kicking in is 
>> to close the offending client connection using an "ssl_bump 
>> terminate" rule (instead[1] of blocking client access using "http_access").
>>
>>
>>> We have tried using a TCP_RESET deny_info but this does not fix the 
>>> bump operation
>>
>> I suspect the TCP_RESET feature is checked at error delivery time, 
>> after the client connection is bumped to prepare it for error 
>> delivery. This suspect behavior should be considered a Squid 
>> bug/deficiency IMO -- Squid should not be bumping the TLS connection 
>> to deliver a TCP RST or FIN packet.
>>
>> HTH,
>>
>> Alex.
>> [1] It may be a good idea to also/still block client access using 
>> http_access rules, as an additional safety layer, but it has to be 
>> done carefully so that "ssl_bump terminate" rule matches _before_ any 
>> of the corresponding "http_access deny" rules may match.
>>
>>
>>
>>> In this peace of log, you can see that squid is forcing bump for 
>>> Access Denied website under https:
>>> 2021/12/08 05:05:53.774 kid2| 85,5| client_side_request.cc(769)
>>> clientAccessCheckDone: Access Denied: beacons2.gvt2.com:443
>>> 2021/12/08 05:05:53.774 kid2| 85,5| client_side_request.cc(770)
>>> clientAccessCheckDone: AclMatchedName = all
>>> 2021/12/08 05:05:53.774 kid2| 83,7| LogTags.cc(57) update: TAG_NONE 
>>> to TCP_DENIED
>>> 2021/12/08 05:05:53.774 kid2| 28,4| FilledChecklist.cc(67)
>>> ~ACLFilledChecklist: ACLFilledChecklist destroyed 0x7ffc945c5b40
>>> 2021/12/08 05:05:53.774 kid2| 28,4| Checklist.cc(197) ~ACLChecklist:
>>> ACLChecklist::~ACLChecklist: destroyed 0x7ffc945c5b40
>>> 2021/12/08 05:05:53.774 kid2| 85,5| client_side_request.cc(1461)
>>> sslBumpAccessCheck: SslBump applies. Force bump action on error 
>>> UNKNOWN
>>> 2021/12/08 05:05:53.774 kid2| 83,3| client_side_request.cc(1562)
>>> sslBumpNeed: sslBump required: bump
>>> 2021/12/08 05:05:53.774 kid2| 73,3| HttpRequest.cc(683) storeId: 
>>> sent back
>>> effectiveRequestUrl: beacons2.gvt2.com:443
>>> 2021/12/08 05:05:53.774 kid2| 24,7| SBuf.cc(160) rawSpace: reserving
>>> 1 for
>>> SBuf77493929
>>> 2021/12/08 05:05:53.774 kid2| 24,7| SBuf.cc(866) reAlloc:
>>> SBuf77493929 new store capacity: 40
>>> 2021/12/08 05:05:53.774 kid2| 20,3| store.cc(769) storeCreatePureEntry:
>>> storeCreateEntry: 'beacons2.gvt2.com:443'
>>> 2021/12/08 05:05:53.774 kid2| 20,5| store.cc(349) StoreEntry:
>>> StoreEntry constructed, this=0x5561d9347e90
>>> 2021/12/08 05:05:53.774 kid2| 20,3| MemObject.cc(100) MemObject:
>>> MemObject constructed, this=0x5561d5e66f50
>>> 2021/12/08 05:05:53.774 kid2| 55,7| HttpHeader.cc(155) HttpHeader:
>>> init-ing
>>> hdr: 0x5561d80af128 owner: 3
>>> 2021/12/08 05:05:53.774 kid2| 88,3| MemObject.cc(83) setUris:
>>> 0x5561d5e66f50
>>> storeId: beacons2.gvt2.com:443
>>> 2021/12/08 05:05:53.774 kid2| 24,7| SBuf.cc(85) assign: assigning
>>> SBuf77493930 from SBuf77493860
>>> 2021/12/08 05:05:53.774 kid2| 20,3| store.cc(443) lock:
>>> storeCreateEntry locked key [null_store_key] e:=V/0x5561d9347e90*1
>>> 2021/12/08 05:05:53.774 kid2| 20,3| store.cc(569) setPrivateKey: 01
>>> e:=V/0x5561d9347e90*1
>>> 2021/12/08 05:05:53.774 kid2| 20,3| store.cc(421) hashInsert:
>>> StoreEntry::hashInsert: Inserting Entry e:=XIV/0x5561d9347e90*1 key 
>>> '71570400000000002412000002000000'
>>> 2021/12/08 05:05:53.774 kid2| 83,3| client_side_request.cc(1562)
>>> sslBumpNeed: sslBump required: client-first
>>> 2021/12/08 05:05:53.774 kid2| 33,4| ServerBump.cc(28) ServerBump:
>>> will peek at beacons2.gvt2.com:443
>>> 2021/12/08 05:05:53.774 kid2| 20,3| store.cc(443) lock:
>>> Ssl::ServerBump locked key 71570400000000002412000002000000
>>> e:=XIV/0x5561d9347e90*2
>>> 2021/12/08 05:05:53.774 kid2| 4,4| errorpage.cc(720) errorAppendEntry:
>>> storing TEMPLATE_5 in e:=XIV/0x5561d9347e90*2
>>> 2021/12/08 05:05:53.774 kid2| 55,7| HttpHeader.cc(155) HttpHeader:
>>> init-ing
>>> hdr: 0x5561d66a8078 owner: 3
>>> 2021/12/08 05:05:53.774 kid2| 4,2| errorpage.cc(1389) buildBody: No 
>>> existing error page language negotiated for TEMPLATE_5. Using 
>>> default error file.
>>>
>>> Ssl.conf
>>> # SSL used for port ID 1, :3128 on
>>> # Patch 2020 - 08 - 03 SquidMikrotikEnabled = 0 # SSL Proxy options 
>>> Proxy
>>> version:5.2 [134] sslcrtd_program /lib/squid3/security_file_certgen 
>>> sslcrtd_children 32 startup=5 idle=1 queue-size=64 #The AppStore 
>>> application in IOS (iPhone, iPad, MacOS) uses SSL Certificate 
>>> Pinning, #it means the application knows what certificate to expect 
>>> when accessing AppStore.
>>> #When you enable SSL Bump of HTTPS connections Squid replaces the 
>>> default certificate with a  ^`^xmimicked ^`^y one;
>>>
>>> #the application detects that and refuses to function.
>>> #
>>> acl FakeCert ssl::server_name .apple.com acl FakeCert 
>>> ssl::server_name .icloud.com acl FakeCert ssl::server_name 
>>> .mzstatic.com acl FakeCert ssl::server_name .dropbox.com acl 
>>> FakeCert ssl::server_name .bnpparisbas acl notbump ssl::server_name 
>>> .redtube.com acl ssl_step1 at_step SslBump1 acl
>>> ssl_step2 at_step SslBump2 acl ssl_step3 at_step SslBump3
>>>
>>> acl Me dst 127.0.0.1 192.168.58.11
>>> acl GlobalWhitelistDSTNet dst "/etc/squid3/acls_whitelist.dst.conf"
>>>
>>> ssl_bump splice notbump all
>>> ssl_bump splice GlobalWhitelistDSTNet
>>>
>>> ssl_bump splice ssl_step1 Me
>>> ssl_bump splice ByPassRBL
>>> ssl_bump splice FakeCert
>>>
>>> # SNI Group sni_domains/ssl_sni
>>> # id:7 Type: ssl_sni
>>> acl SNIGroup7 ssl::server_name_regex -i account\.google\.com acl
>>> SNIGroup7 ssl::server_name_regex -i accounts\.google\.com ssl_bump 
>>> peek ssl_step1 all # 0 Splice rules...
>>> ssl_bump splice ByPassRBL
>>> ssl_bump splice GlobalWhitelistDSTNet
>>>
>>> # Rules (spliced) added by admins....
>>>
>>> # 1 BUMP rules...
>>> ssl_bump bump ssl_step2 SNIGroup7
>>> ssl_bump splice all
>>>
>>> tls_outgoing_options options=NO_SSLv3,NO_TICKET 
>>> cipher=ALL:!SSLv2:!SSLv3:!ADH:!DSS:!MD5:!EXP:!DES:!PSK:!SRP:!RC4:!ID
>>> E A :!SEED :!aNULL:!eNULL flags=DONT_VERIFY_PEER sslproxy_cert_error 
>>> allow all
>>>
>>> http_access.conf
>>> #### tcp_outgoing_tos ####
>>> #### tcp_outgoing_tos 0 Rules ####
>>> # SquidUrgency = 0 exec.squid.global.access.php[2233]
>>> #       HaClusterClient=0 class.squid.acls.groups.inc/buildacls_order
>>> #       mysql_for_port='' aclgpid=0 [L.174]
>>> #       [3] rules [220]
>>>
>>>
>>> # webfilters_sqacls #2 : aclport=0 (  ) [239] 
>>> [class.squid.acls.groups.inc] # [L.292]: rule id: 2 access_allow 
>>> Port
>>> Direction=0 () # [L.320]:
>>> class.squid.acls.groups.inc buildacls_bytype_items(2,..) acl
>>> AnnotateRule2 annotate_transaction accessrule=Rule2 http_access 
>>> allow
>>> Group2 AnnotateRule2 # webfilters_sqacls #4 : aclport=0 (  ) [239] 
>>> [class.squid.acls.groups.inc] # [L.292]: rule id: 4 access_allow 
>>> Port
>>> Direction=0 () # [L.320]:
>>> class.squid.acls.groups.inc buildacls_bytype_items(4,..) acl
>>> AnnotateRule4 annotate_transaction accessrule=Rule4 http_access 
>>> allow
>>> Group8 AnnotateRule4 # webfilters_sqacls #3 : aclport=0 (  ) [239] 
>>> [class.squid.acls.groups.inc] # [L.292]: rule id: 3 access_deny Port
>>> Direction=0 () # [L.320]:
>>> class.squid.acls.groups.inc buildacls_bytype_items(3,..) # Template 
>>> Enabled for this ACL.
>>> # Final acl is all, Template ID=1
>>> acl AnnotateRule3 annotate_transaction accessrule=Rule3 http_access 
>>> deny CONNECT  AnnotateRule3 deny_info TCP_RESET AnnotateRule3
>>>
>>> acl MyAll dst 0.0.0.0/0
>>> http_access deny Myall
>>> deny_info 302:http://artica/me Myall # # # ------------------ HTTP 
>>> ACCESS -------------------- # 0 rule(s) from engine (Line 2240)
>>>
>>>
>>> #
>>> # SquidStandardLDAPAuth = 0
>>> # EnableOpenLDAP = 0
>>> # SquidRadiusAuth = 0
>>> # LDAP_AUTH = 0 caused by EnableOpenLDAP acl MyBlockedIPs src 
>>> "/etc/squid3/acls/DenyIPSrc"
>>> acl AnnotateWindowsUpdates annotate_transaction 
>>> accessrule=AllowWindowsUpdates http_access allow WindowsUpdates 
>>> AnnotateWindowsUpdates # # -------------------- AUTH Schemes Squid
>>> v5.2-----------------------
>>>
>>> # ----------------------------------------------------------
>>>
>>> # LDAP Auth = 0
>>> acl AnnotateSafePorts annotate_transaction 
>>> accessrule=deny_remote_ports http_access deny HTTP !Safe_ports all 
>>> AnnotateSafePorts http_access deny CONNECT !SSL_ports all 
>>> AnnotateSafePorts deny_info TCP_RESET all
>>>
>>> acl AnnotateBLK annotate_transaction accessrule=global_blacklist 
>>> http_access deny MyBlockedIPs AnnotateBLK http_access deny 
>>> blockedsites AnnotateBLK http_access deny DomainsBlackLists 
>>> AnnotateBLK http_access deny NetworksBlackLists AnnotateBLK include 
>>> /etc/squid3/http_access_final.conf
>>> # END http_access (defaults)
>>>
>>> _______________________________________________
>>> squid-users mailing list
>>> squid-users at lists.squid-cache.org
>>> http://lists.squid-cache.org/listinfo/squid-users
>>>
>>
> 




From rousskov at measurement-factory.com  Sat Dec 11 14:59:20 2021
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Sat, 11 Dec 2021 09:59:20 -0500
Subject: [squid-users] deny squid to bump deny_info
In-Reply-To: <!&!AAAAAAAAAAAuAAAAAAAAAJJD97gEMN5Ch2HBNn/5W3IBAMO2jhD3dRHOtM0AqgC7tuYAAAAAAA4AABAAAAC+XiB/A/C0QZAesfoTnTsTAQAAAAA=@articatech.com>
References: <!&!AAAAAAAAAAAuAAAAAAAAAJJD97gEMN5Ch2HBNn/5W3IBAMO2jhD3dRHOtM0AqgC7tuYAAAAAAA4AABAAAAA/vsnzXWfeQoQx+2MBa2hmAQAAAAA=@articatech.com>
 <58f4c84a-35ca-aa62-43bb-3c4d0fff939f@measurement-factory.com>
 <!&!AAAAAAAAAAAuAAAAAAAAAJJD97gEMN5Ch2HBNn/5W3IBAMO2jhD3dRHOtM0AqgC7tuYAAAAAAA4AABAAAAC9RiWUcHCrQb7c2n+RZsgSAQAAAAA=@articatech.com>
 <f2368559-5b77-171c-b82f-0ca4b9160677@measurement-factory.com>
 <00fc01d7eddf$36da11f0$a48e35d0$@articatech.com>
 <22104749-ae04-10e6-2e4e-50ce1d76c83d@measurement-factory.com>
 <!&!AAAAAAAAAAAuAAAAAAAAAJJD97gEMN5Ch2HBNn/5W3IBAMO2jhD3dRHOtM0AqgC7tuYAAAAAAA4AABAAAAC+XiB/A/C0QZAesfoTnTsTAQAAAAA=@articatech.com>
Message-ID: <5b0d43a3-f91d-849d-c02c-1a86aac995d8@measurement-factory.com>

On 12/10/21 6:03 PM, Andr? Bolinhas wrote:

> Actually if I remove http_access deny I works

There are many ways to misconfigure Squid. Removing all "http_access
deny" rules (that apply to CONNECT requests) is one of them.

I recommend learning how Squid applies http_access and ssl_bump rules
based on available documentation and this mailing list help. Please ask
questions as needed. Once you understand how Squid works, you should be
able to configure Squid correctly and/or file bug reports.

If you just want to follow specific configuration instructions instead,
then you will probably have to wait for somebody to detail what I have
suggested earlier. Please note that I did not recommend removal of all
"http_access deny" rules. I recommended making sure that CONNECT
requests that match "ssl_bump terminate" rule are allowed. Everything
else should be allowed/denied as usual.

HTH,

Alex.

> -----Mensagem original-----
> De: Alex Rousskov <rousskov at measurement-factory.com> 
> Enviada: 10 de dezembro de 2021 16:42
> Para: Andr? Bolinhas <andre.bolinhas at articatech.com>; squid-users at lists.squid-cache.org
> Assunto: Re: [squid-users] deny squid to bump deny_info
> 
> On 12/10/21 11:01 AM, Andr? Bolinhas wrote:
> 
>> I put this code at the beginning of squid.conf, just after listen_ports:
>>
>> http_port 0.0.0.0:3128  name=MyPortNameID1 ssl-bump  
>> generate-host-certificates=on dynamic_cert_mem_cache_size=4MB 
>> cert=/etc/squid3/ssl/861be42112afac3b82f6b992bcc464aa.dyn 
>> sslflags=VERIFY_CRL_ALL options=NO_SSLv3,No_Compression 
>> tls-dh=/etc/squid3/ssl/dhparam.pem
>>
>> acl denybump dstdomain .xvideos.com
>> acl CONNECT1 method CONNECT
>> http_access deny CONNECT1 denybump
>> ssl_bump terminate denybump
>> http_access deny denybump
>>
>> but still don't work, squid continues to bump the error page.
>>
>> If I change the code to terminat all
>> acl denybump dstdomain .xvideos.com
>> acl CONNECT1 method CONNECT
>> http_access deny CONNECT1 denybump
>> ssl_bump terminate all
>> http_access deny denybump
>>
>> Squid is able to terminate all connections except the xvideos, because xvideos is denied, squid continues to bump it to shot the error page.
> 
> AFAICT, your configuration denies CONNECT requests _before_ "ssl_bump terminate" logic kicks in. The existing SslBump documentation can be interpreted as matching what is going on in your tests; see steps 1.ii and 1.iii at https://wiki.squid-cache.org/Features/SslPeekAndSplice
> 
> We probably should document that a step1 http_access denial (which happens during step 1.ii) blocks/prevents ssl_bump rules evaluation (which happens in step 1.iii).
> 
> My recommendation from the very first response on this email thread still stands: Close the offending client connection using an "ssl_bump terminate" rule instead[1] of blocking client access using "http_access".
> 
> [1] It may be a good idea to also/still block client access using http_access rules, as an additional safety layer, but it has to be done carefully so that "ssl_bump terminate" rule matches _before_ any of the corresponding "http_access deny" rules may match. For example, the two rules cannot have exactly the same condition because step 1.ii happens before step 1.iii.
> 
> 
> HTH,
> 
> Alex.
> 
>> You can see the result images here:
>> gmail bump terminated - https://ibb.co/3MsMt0C Xvideos bump not 
>> terminated - https://ibb.co/b24hL44
>>
>>
>> -----Mensagem original-----
>> De: Alex Rousskov <rousskov at measurement-factory.com>
>> Enviada: 8 de dezembro de 2021 16:02
>> Para: Andr? Bolinhas <andre.bolinhas at articatech.com>; 
>> squid-users at lists.squid-cache.org
>> Assunto: Re: [squid-users] deny squid to bump deny_info
>>
>> On 12/8/21 10:40 AM, Andr? Bolinhas wrote:
>>> where I need to add the ssl_bump terminate rule? Inside ssl.conf or 
>>> http_access.conf?
>>> I have tried in both both but continues to bump the error page.
>>
>> Unfortunately, I cannot edit your configuration right now, but others 
>> on the mailing list may be able to help you. Please note that we do 
>> not know how those two files are included into your primary 
>> configuration file and whether that primary configuration file 
>> contains any relevant settings itself. The primary configuration file 
>> is what Squid parses first (e.g., it may be specified using "squid -f").
>>
>>
>>> Also tried ssl_bump terminate all in the top of both files and always 
>>> bump ther error_page.
>>
>> I am not sure, but AFAICT, Squid bugs notwithstanding, if "ssl_bump 
>> terminate all" is the very first ssl_bump rule in the entire Squid 
>> configuration, and Squid still bumps traffic, then you may be denying 
>> explicit CONNECT requests _before_ SslBump kicks in.
>>
>> Alex.
>>
>>
>>> This is my current files:
>>> http_access.conf
>>> #### tcp_outgoing_tos ####
>>> #### tcp_outgoing_tos 0 Rules ####
>>> # webfilters_sqacls HaClusterClient=0 2 rules [202] 
>>> [class.squid.acls.groups.inc] # webfilters_sqacls #10 : aclport=0 (  
>>> ) [212] [class.squid.acls.groups.inc] # [L.268]: rule id: 10 
>>> access_allow Port Direction=0 () # [L.303]:
>>> class.squid.acls.groups.inc buildacls_bytype_items(10,..) http_access 
>>> allow Group17 # webfilters_sqacls #5 : aclport=0 (  ) [212] 
>>> [class.squid.acls.groups.inc] # [L.268]: rule id: 5 access_deny Port
>>> Direction=0 () # [L.303]: class.squid.acls.groups.inc
>>> buildacls_bytype_items(5,..) # Template Enabled for this ACL.
>>> # Final acl is all, Template ID=1
>>> deny_info TEMPLATE_5 all
>>> http_access deny all
>>> #
>>> #
>>> # ------------------ HTTP ACCESS -------------------- # 0 rule(s) 
>>> from engine (Line 2170)
>>>
>>>
>>> # SquidStandardLDAPAuth = 0
>>> # EnableOpenLDAP = 0
>>> # SquidRadiusAuth = 0
>>> # LDAP_AUTH = 0 caused by EnableOpenLDAP acl MyBlockedIPs src 
>>> "/etc/squid3/acls/DenyIPSrc"
>>> http_access allow WindowsUpdates
>>>
>>> # LDAP Auth = 0
>>> http_access deny HTTP !Safe_ports all http_access deny CONNECT 
>>> !SSL_ports all http_access deny MyBlockedIPs http_access deny 
>>> blockedsites http_access deny DomainsBlackLists http_access deny 
>>> NetworksBlackLists include /etc/squid3/http_access_final.conf
>>> # END http_access (defaults)
>>>
>>> # Allow all networks to finally pass trough proxy.
>>> http_access allow all
>>>
>>> ssl.conf
>>> # SSL used for port ID 1, :3128 on
>>> # Patch 2020 - 08 - 03 SquidMikrotikEnabled = 0 # SSL Proxy options 
>>> Proxy version:5.2 [134] sslcrtd_program 
>>> /lib/squid3/security_file_certgen -s 
>>> /var/lib/squid/session/ssl/ssl_db -M 32MB sslcrtd_children 32 
>>> startup=5 idle=1 queue-size=64 #The AppStore application in IOS 
>>> (iPhone, iPad, MacOS) uses SSL Certificate Pinning, #it means the 
>>> application knows what certificate to expect when accessing AppStore.
>>> #When you enable SSL Bump of HTTPS connections Squid replaces the 
>>> default certificate with a  ^`^xmimicked ^`^y one; #the application 
>>> detects that and refuses to function.
>>> #
>>> acl FakeCert ssl::server_name .apple.com acl FakeCert 
>>> ssl::server_name .icloud.com acl FakeCert ssl::server_name 
>>> .mzstatic.com acl FakeCert ssl::server_name .dropbox.com acl FakeCert 
>>> ssl::server_name .bnpparisbas acl ssl_step1 at_step SslBump1 acl 
>>> ssl_step2 at_step
>>> SslBump2 acl ssl_step3 at_step SslBump3 ssl_bump peek ssl_step1 
>>> ssl_bump splice GlobalWhitelistDSTNet ssl_bump splice 
>>> GlobalWhitelistDomainsRx ssl_bump splice GlobalWhitelistDomains 
>>> ssl_bump splice FakeCert
>>>
>>> # SNI Group google_sni/ssl_sni
>>> # id:16 Type: ssl_sni
>>> acl SNIGroup16 ssl::server_name_regex -i accounts\.google\.com
>>>
>>> # 0 Splice rules...
>>> acl KeepSSL ssl::server_name "/etc/squid3/acls_whitelist.dstdomain.conf"
>>> ssl_bump splice KeepSSL
>>> ssl_bump splice GlobalWhitelistDSTNet
>>>
>>> # Rules (spliced) added by admins....
>>>
>>> # 1 BUMP rules...
>>> #ssl_bump stare all
>>> ssl_bump bump ssl_step2 SNIGroup16
>>> ssl_bump splice all
>>>
>>> tls_outgoing_options options=NO_SSLv3,NO_TICKET 
>>> cipher=ALL:!SSLv2:!SSLv3:!ADH:!DSS:!MD5:!EXP:!DES:!PSK:!SRP:!RC4:!IDE
>>> A :!SEED:!aNULL:!eNULL flags=DONT_VERIFY_PEER sslproxy_cert_error 
>>> allow all on_unsupported_protocol tunnel all
>>>
>>>
>>> -----Mensagem original-----
>>> De: Alex Rousskov <rousskov at measurement-factory.com>
>>> Enviada: 8 de dezembro de 2021 15:13
>>> Para: Andr? Bolinhas <andre.bolinhas at articatech.com>; 
>>> squid-users at lists.squid-cache.org
>>> Assunto: Re: [squid-users] deny squid to bump deny_info
>>>
>>> On 12/7/21 8:39 PM, Andr? Bolinhas wrote:
>>>
>>>> We use Squid v5 with ssl_bump to decrypt only google domains. With a 
>>>> special configuration we also need to deny important websites. Squid 
>>>> tries to bump returned error pages
>>>
>>> Yes, when SslBump encounters an error, it tries to bump the client 
>>> connection to deliver the error response.
>>>
>>> One way to prevent that error handling algorithm from kicking in is 
>>> to close the offending client connection using an "ssl_bump 
>>> terminate" rule (instead[1] of blocking client access using "http_access").
>>>
>>>
>>>> We have tried using a TCP_RESET deny_info but this does not fix the 
>>>> bump operation
>>>
>>> I suspect the TCP_RESET feature is checked at error delivery time, 
>>> after the client connection is bumped to prepare it for error 
>>> delivery. This suspect behavior should be considered a Squid 
>>> bug/deficiency IMO -- Squid should not be bumping the TLS connection 
>>> to deliver a TCP RST or FIN packet.
>>>
>>> HTH,
>>>
>>> Alex.
>>> [1] It may be a good idea to also/still block client access using 
>>> http_access rules, as an additional safety layer, but it has to be 
>>> done carefully so that "ssl_bump terminate" rule matches _before_ any 
>>> of the corresponding "http_access deny" rules may match.
>>>
>>>
>>>
>>>> In this peace of log, you can see that squid is forcing bump for 
>>>> Access Denied website under https:
>>>> 2021/12/08 05:05:53.774 kid2| 85,5| client_side_request.cc(769)
>>>> clientAccessCheckDone: Access Denied: beacons2.gvt2.com:443
>>>> 2021/12/08 05:05:53.774 kid2| 85,5| client_side_request.cc(770)
>>>> clientAccessCheckDone: AclMatchedName = all
>>>> 2021/12/08 05:05:53.774 kid2| 83,7| LogTags.cc(57) update: TAG_NONE 
>>>> to TCP_DENIED
>>>> 2021/12/08 05:05:53.774 kid2| 28,4| FilledChecklist.cc(67)
>>>> ~ACLFilledChecklist: ACLFilledChecklist destroyed 0x7ffc945c5b40
>>>> 2021/12/08 05:05:53.774 kid2| 28,4| Checklist.cc(197) ~ACLChecklist:
>>>> ACLChecklist::~ACLChecklist: destroyed 0x7ffc945c5b40
>>>> 2021/12/08 05:05:53.774 kid2| 85,5| client_side_request.cc(1461)
>>>> sslBumpAccessCheck: SslBump applies. Force bump action on error 
>>>> UNKNOWN
>>>> 2021/12/08 05:05:53.774 kid2| 83,3| client_side_request.cc(1562)
>>>> sslBumpNeed: sslBump required: bump
>>>> 2021/12/08 05:05:53.774 kid2| 73,3| HttpRequest.cc(683) storeId: 
>>>> sent back
>>>> effectiveRequestUrl: beacons2.gvt2.com:443
>>>> 2021/12/08 05:05:53.774 kid2| 24,7| SBuf.cc(160) rawSpace: reserving
>>>> 1 for
>>>> SBuf77493929
>>>> 2021/12/08 05:05:53.774 kid2| 24,7| SBuf.cc(866) reAlloc:
>>>> SBuf77493929 new store capacity: 40
>>>> 2021/12/08 05:05:53.774 kid2| 20,3| store.cc(769) storeCreatePureEntry:
>>>> storeCreateEntry: 'beacons2.gvt2.com:443'
>>>> 2021/12/08 05:05:53.774 kid2| 20,5| store.cc(349) StoreEntry:
>>>> StoreEntry constructed, this=0x5561d9347e90
>>>> 2021/12/08 05:05:53.774 kid2| 20,3| MemObject.cc(100) MemObject:
>>>> MemObject constructed, this=0x5561d5e66f50
>>>> 2021/12/08 05:05:53.774 kid2| 55,7| HttpHeader.cc(155) HttpHeader:
>>>> init-ing
>>>> hdr: 0x5561d80af128 owner: 3
>>>> 2021/12/08 05:05:53.774 kid2| 88,3| MemObject.cc(83) setUris:
>>>> 0x5561d5e66f50
>>>> storeId: beacons2.gvt2.com:443
>>>> 2021/12/08 05:05:53.774 kid2| 24,7| SBuf.cc(85) assign: assigning
>>>> SBuf77493930 from SBuf77493860
>>>> 2021/12/08 05:05:53.774 kid2| 20,3| store.cc(443) lock:
>>>> storeCreateEntry locked key [null_store_key] e:=V/0x5561d9347e90*1
>>>> 2021/12/08 05:05:53.774 kid2| 20,3| store.cc(569) setPrivateKey: 01
>>>> e:=V/0x5561d9347e90*1
>>>> 2021/12/08 05:05:53.774 kid2| 20,3| store.cc(421) hashInsert:
>>>> StoreEntry::hashInsert: Inserting Entry e:=XIV/0x5561d9347e90*1 key 
>>>> '71570400000000002412000002000000'
>>>> 2021/12/08 05:05:53.774 kid2| 83,3| client_side_request.cc(1562)
>>>> sslBumpNeed: sslBump required: client-first
>>>> 2021/12/08 05:05:53.774 kid2| 33,4| ServerBump.cc(28) ServerBump:
>>>> will peek at beacons2.gvt2.com:443
>>>> 2021/12/08 05:05:53.774 kid2| 20,3| store.cc(443) lock:
>>>> Ssl::ServerBump locked key 71570400000000002412000002000000
>>>> e:=XIV/0x5561d9347e90*2
>>>> 2021/12/08 05:05:53.774 kid2| 4,4| errorpage.cc(720) errorAppendEntry:
>>>> storing TEMPLATE_5 in e:=XIV/0x5561d9347e90*2
>>>> 2021/12/08 05:05:53.774 kid2| 55,7| HttpHeader.cc(155) HttpHeader:
>>>> init-ing
>>>> hdr: 0x5561d66a8078 owner: 3
>>>> 2021/12/08 05:05:53.774 kid2| 4,2| errorpage.cc(1389) buildBody: No 
>>>> existing error page language negotiated for TEMPLATE_5. Using 
>>>> default error file.
>>>>
>>>> Ssl.conf
>>>> # SSL used for port ID 1, :3128 on
>>>> # Patch 2020 - 08 - 03 SquidMikrotikEnabled = 0 # SSL Proxy options 
>>>> Proxy
>>>> version:5.2 [134] sslcrtd_program /lib/squid3/security_file_certgen 
>>>> sslcrtd_children 32 startup=5 idle=1 queue-size=64 #The AppStore 
>>>> application in IOS (iPhone, iPad, MacOS) uses SSL Certificate 
>>>> Pinning, #it means the application knows what certificate to expect 
>>>> when accessing AppStore.
>>>> #When you enable SSL Bump of HTTPS connections Squid replaces the 
>>>> default certificate with a  ^`^xmimicked ^`^y one;
>>>>
>>>> #the application detects that and refuses to function.
>>>> #
>>>> acl FakeCert ssl::server_name .apple.com acl FakeCert 
>>>> ssl::server_name .icloud.com acl FakeCert ssl::server_name 
>>>> .mzstatic.com acl FakeCert ssl::server_name .dropbox.com acl 
>>>> FakeCert ssl::server_name .bnpparisbas acl notbump ssl::server_name 
>>>> .redtube.com acl ssl_step1 at_step SslBump1 acl
>>>> ssl_step2 at_step SslBump2 acl ssl_step3 at_step SslBump3
>>>>
>>>> acl Me dst 127.0.0.1 192.168.58.11
>>>> acl GlobalWhitelistDSTNet dst "/etc/squid3/acls_whitelist.dst.conf"
>>>>
>>>> ssl_bump splice notbump all
>>>> ssl_bump splice GlobalWhitelistDSTNet
>>>>
>>>> ssl_bump splice ssl_step1 Me
>>>> ssl_bump splice ByPassRBL
>>>> ssl_bump splice FakeCert
>>>>
>>>> # SNI Group sni_domains/ssl_sni
>>>> # id:7 Type: ssl_sni
>>>> acl SNIGroup7 ssl::server_name_regex -i account\.google\.com acl
>>>> SNIGroup7 ssl::server_name_regex -i accounts\.google\.com ssl_bump 
>>>> peek ssl_step1 all # 0 Splice rules...
>>>> ssl_bump splice ByPassRBL
>>>> ssl_bump splice GlobalWhitelistDSTNet
>>>>
>>>> # Rules (spliced) added by admins....
>>>>
>>>> # 1 BUMP rules...
>>>> ssl_bump bump ssl_step2 SNIGroup7
>>>> ssl_bump splice all
>>>>
>>>> tls_outgoing_options options=NO_SSLv3,NO_TICKET 
>>>> cipher=ALL:!SSLv2:!SSLv3:!ADH:!DSS:!MD5:!EXP:!DES:!PSK:!SRP:!RC4:!ID
>>>> E A :!SEED :!aNULL:!eNULL flags=DONT_VERIFY_PEER sslproxy_cert_error 
>>>> allow all
>>>>
>>>> http_access.conf
>>>> #### tcp_outgoing_tos ####
>>>> #### tcp_outgoing_tos 0 Rules ####
>>>> # SquidUrgency = 0 exec.squid.global.access.php[2233]
>>>> #       HaClusterClient=0 class.squid.acls.groups.inc/buildacls_order
>>>> #       mysql_for_port='' aclgpid=0 [L.174]
>>>> #       [3] rules [220]
>>>>
>>>>
>>>> # webfilters_sqacls #2 : aclport=0 (  ) [239] 
>>>> [class.squid.acls.groups.inc] # [L.292]: rule id: 2 access_allow 
>>>> Port
>>>> Direction=0 () # [L.320]:
>>>> class.squid.acls.groups.inc buildacls_bytype_items(2,..) acl
>>>> AnnotateRule2 annotate_transaction accessrule=Rule2 http_access 
>>>> allow
>>>> Group2 AnnotateRule2 # webfilters_sqacls #4 : aclport=0 (  ) [239] 
>>>> [class.squid.acls.groups.inc] # [L.292]: rule id: 4 access_allow 
>>>> Port
>>>> Direction=0 () # [L.320]:
>>>> class.squid.acls.groups.inc buildacls_bytype_items(4,..) acl
>>>> AnnotateRule4 annotate_transaction accessrule=Rule4 http_access 
>>>> allow
>>>> Group8 AnnotateRule4 # webfilters_sqacls #3 : aclport=0 (  ) [239] 
>>>> [class.squid.acls.groups.inc] # [L.292]: rule id: 3 access_deny Port
>>>> Direction=0 () # [L.320]:
>>>> class.squid.acls.groups.inc buildacls_bytype_items(3,..) # Template 
>>>> Enabled for this ACL.
>>>> # Final acl is all, Template ID=1
>>>> acl AnnotateRule3 annotate_transaction accessrule=Rule3 http_access 
>>>> deny CONNECT  AnnotateRule3 deny_info TCP_RESET AnnotateRule3
>>>>
>>>> acl MyAll dst 0.0.0.0/0
>>>> http_access deny Myall
>>>> deny_info 302:http://artica/me Myall # # # ------------------ HTTP 
>>>> ACCESS -------------------- # 0 rule(s) from engine (Line 2240)
>>>>
>>>>
>>>> #
>>>> # SquidStandardLDAPAuth = 0
>>>> # EnableOpenLDAP = 0
>>>> # SquidRadiusAuth = 0
>>>> # LDAP_AUTH = 0 caused by EnableOpenLDAP acl MyBlockedIPs src 
>>>> "/etc/squid3/acls/DenyIPSrc"
>>>> acl AnnotateWindowsUpdates annotate_transaction 
>>>> accessrule=AllowWindowsUpdates http_access allow WindowsUpdates 
>>>> AnnotateWindowsUpdates # # -------------------- AUTH Schemes Squid
>>>> v5.2-----------------------
>>>>
>>>> # ----------------------------------------------------------
>>>>
>>>> # LDAP Auth = 0
>>>> acl AnnotateSafePorts annotate_transaction 
>>>> accessrule=deny_remote_ports http_access deny HTTP !Safe_ports all 
>>>> AnnotateSafePorts http_access deny CONNECT !SSL_ports all 
>>>> AnnotateSafePorts deny_info TCP_RESET all
>>>>
>>>> acl AnnotateBLK annotate_transaction accessrule=global_blacklist 
>>>> http_access deny MyBlockedIPs AnnotateBLK http_access deny 
>>>> blockedsites AnnotateBLK http_access deny DomainsBlackLists 
>>>> AnnotateBLK http_access deny NetworksBlackLists AnnotateBLK include 
>>>> /etc/squid3/http_access_final.conf
>>>> # END http_access (defaults)
>>>>
>>>> _______________________________________________
>>>> squid-users mailing list
>>>> squid-users at lists.squid-cache.org
>>>> http://lists.squid-cache.org/listinfo/squid-users
>>>>
>>>
>>
> 



From binoyaf at yahoo.com  Wed Dec 15 16:56:08 2021
From: binoyaf at yahoo.com (Binoy Fernandez)
Date: Wed, 15 Dec 2021 16:56:08 +0000 (UTC)
Subject: [squid-users] IPcache and mixed case domain names
References: <801995541.1556870.1639587368085.ref@mail.yahoo.com>
Message-ID: <801995541.1556870.1639587368085@mail.yahoo.com>

hi everyone,

I hope all is well. I have a question on the behaviour of IPcache with mixed case domain names that I hope you can help clarify.

Environment: Squid version 4.15 as a forward proxy, using sslbump peek (step 1) and splice (step 2) and TProxy.

I noticed a low cache hit ratio on the IPcache module in an environment where a large proportion (90%) of requests is to mixed case domain names. On reviewing the code, it seems the lookup is done using the domain name as-is (mixed case) whereas the entries in IPcache are stored in lower case. I had a brief review of the code and logs and this is what I think is happening:

- curl a mixed case domain (e.g. 2D3755028EC4F578005E3EDC9A7E34F3.gr7.us-east-2.eks.amazonaws.com)
?-- On this first request, Squid tries to lookup the domain name (ipcache_get) after it gets the Client Hello from the client and before it initiates a TCP connection to the upstream. This results in a cache miss (expected). Domain name here comes from the Client Hello SNI.
?-- It then creates an instance of ipcache_entry and requests the internal DNS module to resolve the domain name. ipcache_entry's constructor lower cases the domain name and stores it in the hash.key field.
?-- Once the DNS response comes in, the callback function (ipcacheHandleReply) is invoked. This adds an entry (ipcacheAddEntry) for this DNS lookup to IPcache. The key here is the domain name in lower case.

- curl the same domain a second time (before the TTL expires)
?-- Squid tries to lookup the domain name (ipcache_get) as before but results in a cache miss (not expected). The argument to ipcache_get I believe is in mixed case at this point and hence the cache miss?

Access logs is as follows for the connection from Squid to upstream:
Request 1 -
[15/Dec/2021:16:12:12]? ?2409 11 10.1.3.204:49852 3129 TCP_TUNNEL/200 2978 CONNECT 2D3755028EC4F578005E3EDC9A7E34F3.gr7.us-east-2.eks.amazonaws.com:443 - HIER_DIRECT/2D3755028EC4F578005E3EDC9A7E34F3.gr7.us-east-2.eks.amazonaws.com 3.17.195.231

Request 2 -
[15/Dec/2021:16:12:51]? ?2394 2 10.1.3.204:58366 3129 TCP_TUNNEL/200 3000 CONNECT 2D3755028EC4F578005E3EDC9A7E34F3.gr7.us-east-2.eks.amazonaws.com:443 - HIER_DIRECT/2D3755028EC4F578005E3EDC9A7E34F3.gr7.us-east-2.eks.amazonaws.com 3.143.136.45

Log format - [%tg] %6tr %dt %>a:%>p %lp %Ss/%03Hs %<st %rm %ru %ue %Sh/%<A %<a

If I repeat the same test case but with the domain name in lower case (2d3755028ec4f578005e3edc9a7e34f3.gr7.us-east-2.eks.amazonaws.com) then the second request has a "-" for DNS resolution time (%dt) in the access log indicating a cache hit. (same is also reflected in the cache logs)

Assuming the IPcache at all times contains lower case domain names then I think a change might be needed to the ipcache_get function to lower case the second argument to hash_lookup.
- github.com/squid-cache/squid/blob/master/src/ipcache.cc#L325?

Apologies if this way off the mark, I am not familiar with the Squid code base. Please advise if this observation is incorrect and I can then shift focus to other areas to troubleshoot.

Thank you,?
Binoy Fernandez


From rousskov at measurement-factory.com  Wed Dec 15 18:08:14 2021
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Wed, 15 Dec 2021 13:08:14 -0500
Subject: [squid-users] IPcache and mixed case domain names
In-Reply-To: <801995541.1556870.1639587368085@mail.yahoo.com>
References: <801995541.1556870.1639587368085.ref@mail.yahoo.com>
 <801995541.1556870.1639587368085@mail.yahoo.com>
Message-ID: <06518943-ff4f-c285-1d74-8eea4d0de86d@measurement-factory.com>

On 12/15/21 11:56 AM, Binoy Fernandez wrote:

> Assuming the IPcache at all times contains lower case domain names
> then I think a change might be needed to the ipcache_get function to
> lower case

It sounds like you found a bug. The fix you suggest may work, but it is

* rather fragile (sooner or later we will forget to lower the name
before looking it up inside ipcache_get() or another function) and

* possibly more expensive that the alternative below (most names do not
need any case conversion but all names need hash computation).

I suspect a better fix would be to replace the legacy C hash used by the
IP cache code with a modern case-insensitive unordered set or map. At
that replacement time, the developer should investigate whether our
ClpMap should be enhanced to be reusable in this context.


Thank you,

Alex.


From squid3 at treenet.co.nz  Sat Dec 18 18:56:39 2021
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Sun, 19 Dec 2021 07:56:39 +1300
Subject: [squid-users] IPcache and mixed case domain names
In-Reply-To: <06518943-ff4f-c285-1d74-8eea4d0de86d@measurement-factory.com>
References: <801995541.1556870.1639587368085.ref@mail.yahoo.com>
 <801995541.1556870.1639587368085@mail.yahoo.com>
 <06518943-ff4f-c285-1d74-8eea4d0de86d@measurement-factory.com>
Message-ID: <23a589a8-f816-af60-a28d-95bd9585793b@treenet.co.nz>

On 16/12/21 07:08, Alex Rousskov wrote:
> On 12/15/21 11:56 AM, Binoy Fernandez wrote:
> 
>> Assuming the IPcache at all times contains lower case domain names
>> then I think a change might be needed to the ipcache_get function to
>> lower case
> 
> It sounds like you found a bug.


Indeed. Please report it via <https://bugs.squid-cache.org> so this does 
not get forgotten and the fix can make it to stable releases when 
implemented.


Amos


From Othmar.Truniger at zkb.ch  Tue Dec 21 11:42:34 2021
From: Othmar.Truniger at zkb.ch (Truniger Othmar)
Date: Tue, 21 Dec 2021 11:42:34 +0000
Subject: [squid-users] Many new ERROR lines in cache.log after upgrade
Message-ID: <42bf0993a4c34328be7ad6d0369d23ac@zkb.ch>

Hi
we have been successfully running Squid for authentication and authorization for almost two decades. We don't cache and no SSL-bumping, just many access rules.

Last weekend I migrated from self-compiled 3.5.x on RHEL7 to RHEL8 with official RPM squid-4.11-4 using the same configuration file. We want to get advantage from official RPMs.

Now we get many log entries in cache.log like this (a few hundred pairs a day):
2021/12/21 11:52:24 kid3| ERROR: helper: {result=BH, notes={message: Success; }}, attempt #1 of 2
2021/12/21 11:52:24 kid3| ERROR: helper: {result=BH, notes={message: Success; message: Success; }}, attempt #2 of 2

Because nothing in the environment changed I must assume that it's only a matter of more intensive logging. But I'm not sure if I have to worry about.

I understand it's related to basic helpers. Since ever we use the original basic_ldap_auth and ext_ldap_group_acl and never experienced any problems with them. Also cachemgr now reports 100% successful requests/replies for the helpers and I see not any indication for any problem.
It just looks a little awkward to see ERROR in these lines but Success for everything at the same time.
I have set "debug_options ALL,1 rotate=2"
The helpers don't use persistent connections.

Maybe this point could be significant: I used "--disable-ipv6" when self-compiling while the RHEL8 RPM probably has full IPv6 support included. Our servers have all IPv6 support disabled though.

I could not find much about this topic. It was once said that one should check for strange behaviour of the basic helpers if these messages occur.

Should I worry about it?
Is it just an artefact for logging in this redhat RPM version?
Could it be related with the way squid helpers deals with IPv6 on systems without IPv6?
How could I specifically debug the helpers without flooding the cache.log (what section)?
Any advice?

many thanks and regards, Othmar

________________________________

Disclaimer:


Diese E-Mail enth?lt m?glicherweise vertrauliche Informationen und ist einzig f?r den beabsichtigten Empf?nger bestimmt. Sollten Sie diese E-Mail irrt?mlicherweise erhalten haben, bitten wir Sie, die Z?rcher Kantonalbank unverz?glich zu benachrichtigen und diese E-Mail sowie deren Anh?nge sofort zu l?schen. Unbefugte Verwendung kann geahndet werden.

Vielen Dank.

From squid3 at treenet.co.nz  Tue Dec 21 13:00:54 2021
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Wed, 22 Dec 2021 02:00:54 +1300
Subject: [squid-users] Many new ERROR lines in cache.log after upgrade
In-Reply-To: <42bf0993a4c34328be7ad6d0369d23ac@zkb.ch>
References: <42bf0993a4c34328be7ad6d0369d23ac@zkb.ch>
Message-ID: <bbcf5bbd-8c62-095f-8ffb-7601c151d58e@treenet.co.nz>

On 22/12/21 00:42, Truniger Othmar wrote:
> Hi
> we have been successfully running Squid for authentication and authorization for almost two decades. We don't cache and no SSL-bumping, just many access rules.
> 
> Last weekend I migrated from self-compiled 3.5.x on RHEL7 to RHEL8 with official RPM squid-4.11-4 using the same configuration file. We want to get advantage from official RPMs.
> 
> Now we get many log entries in cache.log like this (a few hundred pairs a day):
> 2021/12/21 11:52:24 kid3| ERROR: helper: {result=BH, notes={message: Success; }}, attempt #1 of 2
> 2021/12/21 11:52:24 kid3| ERROR: helper: {result=BH, notes={message: Success; message: Success; }}, attempt #2 of 2
> 
> Because nothing in the environment changed I must assume that it's only a matter of more intensive logging. But I'm not sure if I have to worry about.
> 

Or an old helper that has been producing garbage output that v3.5 
ignored and v4 rejects.


> I understand it's related to basic helpers. Since ever we use the original basic_ldap_auth and ext_ldap_group_acl and never experienced any problems with them. Also cachemgr now reports 100% successful requests/replies for the helpers and I see not any indication for any problem.
> It just looks a little awkward to see ERROR in these lines but Success for everything at the same time.
> I have set "debug_options ALL,1 rotate=2"
> The helpers don't use persistent connections.
> 

The lines shown do not indicate which type of helper is involved.

Squid is receiving one of the following lines from the helper:

   BH message="Success;"
   BH Success;


You will have to track down which helper is actually producing the BH 
output. Each helper API has its own debug section, so you need to know 
which one to enable debugging for first.

Once you know that debug_options will show you the Squid side of the API 
communication. Most helpers support "-d" parameter to debug their 
internal operations for the other side of the picture.


> Maybe this point could be significant: I used "--disable-ipv6" when self-compiling while the RHEL8 RPM probably has full IPv6 support included. Our servers have all IPv6 support disabled though.
> 

AFAIK only the external ACL helper is affected by that issue. You can 
use the 'ipv4' option on the external_acl_type directive to fix it.



> I could not find much about this topic. It was once said that one should check for strange behaviour of the basic helpers if these messages occur.
> 
> Should I worry about it?

Maybe, a little bit anyway. It will be affecting some transactions at 
least and should be fixed.


> Is it just an artefact for logging in this redhat RPM version?
> Could it be related with the way squid helpers deals with IPv6 on systems without IPv6?
> How could I specifically debug the helpers without flooding the cache.log (what section)?

The "ERROR" logs you see are from section 84 which is the logic shared 
used by all helper APIs. That covers the I/O channel and splitting the 
helper response line into concurrency-id, code and kv-pairs. You also 
need the section for whichever helper is actually producing that output 
to see how those details are being treated.


Amos



From Othmar.Truniger at zkb.ch  Tue Dec 21 17:04:06 2021
From: Othmar.Truniger at zkb.ch (Truniger Othmar)
Date: Tue, 21 Dec 2021 17:04:06 +0000
Subject: [squid-users] Many new ERROR lines in cache.log after upgrade
Message-ID: <a3a6c6d046d24982bc6718583d30f4ed@zkb.ch>

Hi Amos,
thank you very much for your reply. It already helped me a lot.

> > I understand it's related to basic helpers. Since ever we use the original
> basic_ldap_auth and ext_ldap_group_acl and never experienced any problems
> with them. Also cachemgr now reports 100% successful requests/replies for the
> helpers and I see not any indication for any problem.
> > It just looks a little awkward to see ERROR in these lines but Success for
> everything at the same time.
> > I have set "debug_options ALL,1 rotate=2"
> > The helpers don't use persistent connections.
> >
>
> The lines shown do not indicate which type of helper is involved.
>
> Squid is receiving one of the following lines from the helper:
>
>    BH message="Success;"
>    BH Success;

it turned out it's the basic_ldap_auth helper which produces this output.

> Maybe, a little bit anyway. It will be affecting some transactions at
> least and should be fixed.

it turned out that I don't have to worry. I'm now able to reproduce it easily: the log lines occur every time when a user is sending an invalid password.
Fortunately that does not happen too often and I don't have to care anyway. It's just an annoyance to have it all logged in cache.log.

Regards, Othmar

________________________________

Disclaimer:


Diese E-Mail enth?lt m?glicherweise vertrauliche Informationen und ist einzig f?r den beabsichtigten Empf?nger bestimmt. Sollten Sie diese E-Mail irrt?mlicherweise erhalten haben, bitten wir Sie, die Z?rcher Kantonalbank unverz?glich zu benachrichtigen und diese E-Mail sowie deren Anh?nge sofort zu l?schen. Unbefugte Verwendung kann geahndet werden.

Vielen Dank.

From pponakanti at roblox.com  Wed Dec 22 00:48:03 2021
From: pponakanti at roblox.com (Praveen Ponakanti)
Date: Tue, 21 Dec 2021 16:48:03 -0800
Subject: [squid-users] Significant memory leak with version 5.x (not with
 4.17)
Message-ID: <CACabJxOfSqVkN63DN=N=_J=B7CtH-ahRkFaAtM93H67BpQx9eA@mail.gmail.com>

Hi,


We are running the squid proxy for servicing outbound HTTP quests from our
network and have observed a significant memory leak with 5.x versions.
While there are several discussions about memory leaks with recent
versions, just wanted to list out what we have observed in case this is an
unknown leak.



   - The request-rate through our squid proxy currently ranges between a
   daily low of 10 rps to a daily high 125 rps.
   - About mid-way during the daily ramp in request rates, the memory usage
   of the squid proxy starts to increase by about 1-2.5 G / day before
   leveling off till the next day's ramp in reqs. 4.17 does not exhibit this
   memory leak (or at least not at anything close to this rate).
   - We are running 30 squid workers and the cache is set to deny all.
   Besides this, we have a single tcp_outgoing_address, some site specific
   ACL?s (both IP & domain acl's), and a custom access log format with a UDP
   target.
   - Both versions of squid run on similar hosts (64 cores each) and
   receive identical traffic patterns throughout the day. Version 5.3 & 5.1
   have similar rates of memory leak.


We are unable to use version 5.X in our production environment as we will
have a much higher rate of requests through the proxy later on.


Due to the nature of the memory leak, it appears something with the memory
pool management has been broken with version 5.x.


I have attempted to build squid with -with-valgrind-debug, and run it in a
test env. However valgrind appears to collect some data from the parse
config functions and then the squid proxy restarts. Valgrind no longer
reports memory leak stats afterwards.


Snips from squid-internal-mgr/info. Note the data below does not appear to
account for all the memory used by the squid process(es), which is also
reported by the squid-exporter container. Our node level stats show that
the 5.x squid is currently using up more than 28G, while the 4.17 version
is under 7G. Both instances were setup to take traffic about 10 days ago.


Thanks

Praveen


Version 5.3

??????


Memory accounted for:

Total accounted:       1215892 KB

memPoolAlloc calls: 7529400915

memPoolFree calls:  7624989161

File descriptor usage for squid:

Maximum number of file descriptors:   31457280

Largest file desc currently in use:   24962

Number of file desc currently in use: 4486

Files queued for open:                   0

Available number of file descriptors: 31452794

Reserved number of file descriptors:  3000

Store Disk files open:                   0


Version 4.17

??????


Memory accounted for:

Total accounted:        76878 KB

memPoolAlloc calls: 6217787434

memPoolFree calls:  6301483686

File descriptor usage for squid:

Maximum number of file descriptors:   31457280

Largest file desc currently in use:   20184

Number of file desc currently in use: 4419

Files queued for open:                   0

Available number of file descriptors: 31452861

Reserved number of file descriptors:  3000

Store Disk files open:                   0
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20211221/429cffd2/attachment.htm>

From loucansky.lukas at kjj.cz  Wed Dec 22 09:36:59 2021
From: loucansky.lukas at kjj.cz (=?UTF-8?B?THVrw6HFoSBMb3XEjWFuc2vDvQ==?=)
Date: Wed, 22 Dec 2021 10:36:59 +0100
Subject: [squid-users] Significant memory leak with version 5.x (not
 with 4.17)
In-Reply-To: <CACabJxOfSqVkN63DN=N=_J=B7CtH-ahRkFaAtM93H67BpQx9eA@mail.gmail.com>
References: <CACabJxOfSqVkN63DN=N=_J=B7CtH-ahRkFaAtM93H67BpQx9eA@mail.gmail.com>
Message-ID: <b6a228c7-2b57-31e3-e2b3-1a386cfb63f1@kjj.cz>

ok - I'dont want to tell stories how I went from rockd and workers back 
to non-SMP and aufs. But I want to mention I face these kind of issues 
too. I do not have too much evidence nor expirience to call it memory 
leak - but - whatever I set to cache_mem, all buffers, timeouts etc., 
reducing sysctl buffer bloat for tcp/udp connections etc. my squid eats 
all my RAM and starts to swap - and then crash by low memory (could not 
start storeid helpers etc.)

After one day the resources taken look like this

15487 proxy???? 20?? 0 8478512?? 7.9g? 17280 S?? 6.0? 50.5 64:15.84 squid

and raising. I have about 370 clients, avg rps (now) 480 and about 1000 
peak. In this config 2GB (of 16GB) cache_mem (same behaviour with 256MB) 
and about 80GB in two aufs cache dirs. I'm doing an ssl "inspection" by 
looking at sni server names and cert fingerprints during peek and splice 
steps (peek and terminate to be precise), everything other is spliced. 
Would it be SSL? context memory bug like in the 3.5.x?

Resource usage for squid:

Maximum Resident Size: 33619392 KB

Memory accounted for:
Total accounted: 1421104 KB
memPoolAlloc calls: 226605414
memPoolFree calls: 229519316

Frankly - I don't have too much xmas power to go back to 4.x and 
investigate. I went ahead to 6.x already... no change.

L

Dne 22.12.2021 v 1:48 Praveen Ponakanti napsal(a):
> Hi,
>
>
> We are running the squid proxy for servicing outbound HTTP quests from 
> our network and have observed a significant memory leak with 5.x 
> versions. While there are several discussions about memory leaks with 
> recent versions, just wanted to list out what we have observed in case 
> this is an unknown leak.
>
>
>   * The request-rate through our squid proxy currently ranges between
>     a daily low of 10 rps to a daily high 125 rps.
>   * About mid-way during the daily ramp in request rates, the memory
>     usage of the squid proxy starts to increase by about 1-2.5 G / day
>     before leveling off till the next day's ramp in reqs. 4.17 does
>     not exhibit this memory leak (or at least not at anything close to
>     this rate).
>   * We are running 30 squid workers and the cache is set to deny all.
>     Besides this, we have a single tcp_outgoing_address, some site
>     specific ACL?s (both IP & domain acl's), and a custom access log
>     format with a UDP target.
>   * Both versions of squid run on similar hosts (64 cores each) and
>     receive identical traffic patterns throughout the day. Version 5.3
>     & 5.1 have similar rates of memory leak.
>
>
> We are unable to use version 5.X in our production environment as we 
> will have a much higher rate of requests through the proxy later on.
>
>
> Due to the nature of the memory leak, it appears something with the 
> memory pool management has been broken with version 5.x.
>
>
> I have attempted to build squid with -with-valgrind-debug, and run it 
> in a test env. However valgrind appears to collect some data from the 
> parse config functions and then the squid proxy restarts. Valgrind no 
> longer reports memory leak stats afterwards.
>
>
> Snips from squid-internal-mgr/info. Note the data below does not 
> appear to account for all the memory used by the squid process(es), 
> which is also reported by the squid-exporter container. Our node level 
> stats show that the 5.x squid is currently using up more than 28G, 
> while the 4.17 version is under 7G. Both instances were setup to take 
> traffic about 10 days ago.
>
>
> Thanks
>
> Praveen
>
>
> Version 5.3
>
> ??????
>
>
> Memory accounted for:
>
> Total accounted: 1215892 KB
>
> memPoolAlloc calls: 7529400915
>
> memPoolFree calls:7624989161
>
> File descriptor usage for squid:
>
> Maximum number of file descriptors: 31457280
>
> Largest file desc currently in use: 24962
>
> Number of file desc currently in use: 4486
>
> Files queued for open: 0
>
> Available number of file descriptors: 31452794
>
> Reserved number of file descriptors:3000
>
> Store Disk files open: 0
>
>
> Version 4.17
>
> ??????
>
>
> Memory accounted for:
>
> Total accounted:76878 KB
>
> memPoolAlloc calls: 6217787434
>
> memPoolFree calls:6301483686
>
> File descriptor usage for squid:
>
> Maximum number of file descriptors: 31457280
>
> Largest file desc currently in use: 20184
>
> Number of file desc currently in use: 4419
>
> Files queued for open: 0
>
> Available number of file descriptors: 31452861
>
> Reserved number of file descriptors:3000
>
> Store Disk files open: 0
>
>
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users

-- 
Tato zpr?va byla zkontrolov?na na viry programem Avast Antivirus.
https://www.avast.com/antivirus
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20211222/e0a2cf3b/attachment.htm>

From loucansky.lukas at kjj.cz  Wed Dec 22 09:43:13 2021
From: loucansky.lukas at kjj.cz (=?UTF-8?B?THVrw6HFoSBMb3XEjWFuc2vDvQ==?=)
Date: Wed, 22 Dec 2021 10:43:13 +0100
Subject: [squid-users] Significant memory leak with version 5.x (not
 with 4.17)
In-Reply-To: <b6a228c7-2b57-31e3-e2b3-1a386cfb63f1@kjj.cz>
References: <CACabJxOfSqVkN63DN=N=_J=B7CtH-ahRkFaAtM93H67BpQx9eA@mail.gmail.com>
 <b6a228c7-2b57-31e3-e2b3-1a386cfb63f1@kjj.cz>
Message-ID: <c29549e6-37f8-0030-2f0a-5dc3c0dd306d@kjj.cz>

ups - i mean reqs per minute :-], and I'm doing icap to clamav daemon at 
localhost

L

Dne 22.12.2021 v 10:36 Luk?? Lou?ansk? napsal(a):
>
> ok - I'dont want to tell stories how I went from rockd and workers 
> back to non-SMP and aufs. But I want to mention I face these kind of 
> issues too. I do not have too much evidence nor expirience to call it 
> memory leak - but - whatever I set to cache_mem, all buffers, timeouts 
> etc., reducing sysctl buffer bloat for tcp/udp connections etc. my 
> squid eats all my RAM and starts to swap - and then crash by low 
> memory (could not start storeid helpers etc.)
>
> After one day the resources taken look like this
>
> 15487 proxy???? 20?? 0 8478512?? 7.9g? 17280 S?? 6.0? 50.5 64:15.84 squid
>
> and raising. I have about 370 clients, avg rps (now) 480 and about 
> 1000 peak. In this config 2GB (of 16GB) cache_mem (same behaviour with 
> 256MB) and about 80GB in two aufs cache dirs. I'm doing an ssl 
> "inspection" by looking at sni server names and cert fingerprints 
> during peek and splice steps (peek and terminate to be precise), 
> everything other is spliced. Would it be SSL? context memory bug like 
> in the 3.5.x?
>
> Resource usage for squid:
>
> Maximum Resident Size: 33619392 KB
>
> Memory accounted for:
> Total accounted: 1421104 KB
> memPoolAlloc calls: 226605414
> memPoolFree calls: 229519316
>
> Frankly - I don't have too much xmas power to go back to 4.x and 
> investigate. I went ahead to 6.x already... no change.
>
> L
>
> Dne 22.12.2021 v 1:48 Praveen Ponakanti napsal(a):
>> Hi,
>>
>>
>> We are running the squid proxy for servicing outbound HTTP quests 
>> from our network and have observed a significant memory leak with 5.x 
>> versions. While there are several discussions about memory leaks with 
>> recent versions, just wanted to list out what we have observed in 
>> case this is an unknown leak.
>>
>>
>>   * The request-rate through our squid proxy currently ranges between
>>     a daily low of 10 rps to a daily high 125 rps.
>>   * About mid-way during the daily ramp in request rates, the memory
>>     usage of the squid proxy starts to increase by about 1-2.5 G /
>>     day before leveling off till the next day's ramp in reqs. 4.17
>>     does not exhibit this memory leak (or at least not at anything
>>     close to this rate).
>>   * We are running 30 squid workers and the cache is set to deny all.
>>     Besides this, we have a single tcp_outgoing_address, some site
>>     specific ACL?s (both IP & domain acl's), and a custom access log
>>     format with a UDP target.
>>   * Both versions of squid run on similar hosts (64 cores each) and
>>     receive identical traffic patterns throughout the day. Version
>>     5.3 & 5.1 have similar rates of memory leak.
>>
>>
>> We are unable to use version 5.X in our production environment as we 
>> will have a much higher rate of requests through the proxy later on.
>>
>>
>> Due to the nature of the memory leak, it appears something with the 
>> memory pool management has been broken with version 5.x.
>>
>>
>> I have attempted to build squid with -with-valgrind-debug, and run it 
>> in a test env. However valgrind appears to collect some data from the 
>> parse config functions and then the squid proxy restarts. Valgrind no 
>> longer reports memory leak stats afterwards.
>>
>>
>> Snips from squid-internal-mgr/info. Note the data below does not 
>> appear to account for all the memory used by the squid process(es), 
>> which is also reported by the squid-exporter container. Our node 
>> level stats show that the 5.x squid is currently using up more than 
>> 28G, while the 4.17 version is under 7G. Both instances were setup to 
>> take traffic about 10 days ago.
>>
>>
>> Thanks
>>
>> Praveen
>>
>>
>> Version 5.3
>>
>> ??????
>>
>>
>> Memory accounted for:
>>
>> Total accounted: 1215892 KB
>>
>> memPoolAlloc calls: 7529400915
>>
>> memPoolFree calls:7624989161
>>
>> File descriptor usage for squid:
>>
>> Maximum number of file descriptors: 31457280
>>
>> Largest file desc currently in use: 24962
>>
>> Number of file desc currently in use: 4486
>>
>> Files queued for open: 0
>>
>> Available number of file descriptors: 31452794
>>
>> Reserved number of file descriptors:3000
>>
>> Store Disk files open: 0
>>
>>
>> Version 4.17
>>
>> ??????
>>
>>
>> Memory accounted for:
>>
>> Total accounted:76878 KB
>>
>> memPoolAlloc calls: 6217787434
>>
>> memPoolFree calls:6301483686
>>
>> File descriptor usage for squid:
>>
>> Maximum number of file descriptors: 31457280
>>
>> Largest file desc currently in use: 20184
>>
>> Number of file desc currently in use: 4419
>>
>> Files queued for open: 0
>>
>> Available number of file descriptors: 31452861
>>
>> Reserved number of file descriptors:3000
>>
>> Store Disk files open: 0
>>
>>
>> _______________________________________________
>> squid-users mailing list
>> squid-users at lists.squid-cache.org
>> http://lists.squid-cache.org/listinfo/squid-users
>
> <https://www.avast.com/sig-email?utm_medium=email&utm_source=link&utm_campaign=sig-email&utm_content=emailclient> 
> 	Bez vir?. www.avast.com 
> <https://www.avast.com/sig-email?utm_medium=email&utm_source=link&utm_campaign=sig-email&utm_content=emailclient> 
>
>
> <#DAB4FAD8-2DD7-40BB-A1B8-4E2AA1F9FDF2>
>
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users

-- 
Tato zpr?va byla zkontrolov?na na viry programem Avast Antivirus.
https://www.avast.com/antivirus
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20211222/c5520889/attachment.htm>

From rousskov at measurement-factory.com  Wed Dec 22 14:45:11 2021
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Wed, 22 Dec 2021 09:45:11 -0500
Subject: [squid-users] Significant memory leak with version 5.x (not
 with 4.17)
In-Reply-To: <CACabJxOfSqVkN63DN=N=_J=B7CtH-ahRkFaAtM93H67BpQx9eA@mail.gmail.com>
References: <CACabJxOfSqVkN63DN=N=_J=B7CtH-ahRkFaAtM93H67BpQx9eA@mail.gmail.com>
Message-ID: <f68674bd-1203-062d-9786-7513554fafb4@measurement-factory.com>

On 12/21/21 7:48 PM, Praveen Ponakanti wrote:

> We are running the squid proxy for servicing outbound HTTP quests from
> our network and have observed a significant memory leak with 5.x
> versions. While there are several discussions about memory leaks with
> recent versions, just wanted to list out what we have observed in case
> this is an unknown leak.

I recommend sharing a log with 48+ hourly mgr:mem snapshots. These
snapshots help compare your leak with others we know about and may help
isolate some of the memory leaks:
https://bugs.squid-cache.org/show_bug.cgi?id=5132#c8


> I have attempted to build squid with -with-valgrind-debug, and run it in
> a test env. However valgrind appears to collect some data from the parse
> config functions and then the squid proxy restarts. 

FWIW, valgrind works as expected in my environment. If your Squid proxy
is killed by an assertion or crashes, even in a test environment, please
consider reporting that bug (after checking that it has not been
reported already, of course). If your test proxy is misconfigured, then
please fix the configuration before proceeding with tests.


Thank you,

Alex.


From roeeklinger60 at gmail.com  Wed Dec 22 15:21:56 2021
From: roeeklinger60 at gmail.com (roee klinger)
Date: Wed, 22 Dec 2021 17:21:56 +0200
Subject: [squid-users] grouping multiple cache peers possible?
Message-ID: <CAGCa14rn-SdCWoKJVr2ZRZc+miJ6AUUc9kDK2TOCBfcS59=hhQ@mail.gmail.com>

Hey

I have a group of about 6 cache peers:

cache_peer 100.70.162.11 parent 16211 0 proxy-only default name=proxy16211
cache_peer 100.70.162.12 parent 16212 0 proxy-only default name=proxy16212
cache_peer 100.70.162.13 parent 16213 0 proxy-only default name=proxy16213

cache_peer 100.70.163.11 parent 16311 0 proxy-only default name=proxy16311
cache_peer 100.70.163.12 parent 16312 0 proxy-only default name=proxy16312
cache_peer 100.70.163.13 parent 16313 0 proxy-only default name=proxy16313


I would like to allow user162_acl access only to the peers that start with
100.70.162 or that have a name that starts with proxy162, or maybe form a
group for them.
For example:

cache_peer_access 100.70.162.* allow user162_acl

or

cache_peer_access proxy162* allow user162_acl

or

cache_peer_access group=proxy162 allow user162_acl


is that possible to do with Squid or do I have to manually put a line for
each peer, for example:

cache_peer_access proxy16211 allow user162_acl
cache_peer_access proxy16212 allow user162_acl
cache_peer_access proxy16213 allow user162_acl


Thanks.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20211222/13555b46/attachment.htm>

From rousskov at measurement-factory.com  Wed Dec 22 15:27:34 2021
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Wed, 22 Dec 2021 10:27:34 -0500
Subject: [squid-users] grouping multiple cache peers possible?
In-Reply-To: <CAGCa14rn-SdCWoKJVr2ZRZc+miJ6AUUc9kDK2TOCBfcS59=hhQ@mail.gmail.com>
References: <CAGCa14rn-SdCWoKJVr2ZRZc+miJ6AUUc9kDK2TOCBfcS59=hhQ@mail.gmail.com>
Message-ID: <3e621b58-f66e-5ab3-7851-1ef17684b62b@measurement-factory.com>

On 12/22/21 10:21 AM, roee klinger wrote:

> I have?a group of about 6 cache peers:
> 
>     cache_peer 100.70.162.11 parent 16211 0 proxy-only default name=proxy16211
>     cache_peer 100.70.162.12 parent 16212 0 proxy-only default name=proxy16212
>     cache_peer 100.70.162.13 parent 16213 0 proxy-only default name=proxy16213
> 
>     cache_peer 100.70.163.11 parent 16311 0 proxy-only default name=proxy16311
>     cache_peer 100.70.163.12 parent 16312 0 proxy-only default name=proxy16312
>     cache_peer 100.70.163.13 parent 16313 0 proxy-only default name=proxy16313
> 
> 
> I would like to allow user162_acl access only to the peers that ...
> have a name that starts with proxy162

According to documentation, a peername_regex ACL can do what you want.

Alex.


From roeeklinger60 at gmail.com  Wed Dec 22 16:29:32 2021
From: roeeklinger60 at gmail.com (roee klinger)
Date: Wed, 22 Dec 2021 18:29:32 +0200
Subject: [squid-users] grouping multiple cache peers possible?
In-Reply-To: <3e621b58-f66e-5ab3-7851-1ef17684b62b@measurement-factory.com>
References: <CAGCa14rn-SdCWoKJVr2ZRZc+miJ6AUUc9kDK2TOCBfcS59=hhQ@mail.gmail.com>
 <3e621b58-f66e-5ab3-7851-1ef17684b62b@measurement-factory.com>
Message-ID: <CAGCa14qPEH6G1CXmz4O+Pbuve6HkdhAYB9W7UwbrcuLmTYCpfg@mail.gmail.com>

Hey Alex,

Thank you for your help, I tried reading the documentation but I cannot get
it to work, and I am not sure how to debug this honestly.

I did:
cache_peer 100.70.162.11 parent 16211 0 proxy-only default name=proxy16211
cache_peer 100.70.162.12 parent 16212 0 proxy-only default name=proxy16212
cache_peer 100.70.162.13 parent 16213 0 proxy-only default name=proxy16213
acl peer_group_162 peername_regex -i proxy162.*\b

Followed by:
cache_peer_access peer_group_162 allow admin162

but I got an error:
ERROR: /etc/squid/conf.d/admin_allow_peer.conf, line 4: No cache_peer
'peer_group_162'

Should I use http_access instead? I am not sure how to use it, because
peer_group_162 is an ACL, not a cache_peer.

Also, is my regex entry correct? I am not sure if \b is supported, and if I
should add the -i flag or not.

Thanks alot.

On Wed, Dec 22, 2021 at 5:27 PM Alex Rousskov <
rousskov at measurement-factory.com> wrote:

> On 12/22/21 10:21 AM, roee klinger wrote:
>
> > I have a group of about 6 cache peers:
> >
> >     cache_peer 100.70.162.11 parent 16211 0 proxy-only default
> name=proxy16211
> >     cache_peer 100.70.162.12 parent 16212 0 proxy-only default
> name=proxy16212
> >     cache_peer 100.70.162.13 parent 16213 0 proxy-only default
> name=proxy16213
> >
> >     cache_peer 100.70.163.11 parent 16311 0 proxy-only default
> name=proxy16311
> >     cache_peer 100.70.163.12 parent 16312 0 proxy-only default
> name=proxy16312
> >     cache_peer 100.70.163.13 parent 16313 0 proxy-only default
> name=proxy16313
> >
> >
> > I would like to allow user162_acl access only to the peers that ...
> > have a name that starts with proxy162
>
> According to documentation, a peername_regex ACL can do what you want.
>
> Alex.
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20211222/3d6e0429/attachment.htm>

From rousskov at measurement-factory.com  Wed Dec 22 16:44:44 2021
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Wed, 22 Dec 2021 11:44:44 -0500
Subject: [squid-users] grouping multiple cache peers possible?
In-Reply-To: <CAGCa14qPEH6G1CXmz4O+Pbuve6HkdhAYB9W7UwbrcuLmTYCpfg@mail.gmail.com>
References: <CAGCa14rn-SdCWoKJVr2ZRZc+miJ6AUUc9kDK2TOCBfcS59=hhQ@mail.gmail.com>
 <3e621b58-f66e-5ab3-7851-1ef17684b62b@measurement-factory.com>
 <CAGCa14qPEH6G1CXmz4O+Pbuve6HkdhAYB9W7UwbrcuLmTYCpfg@mail.gmail.com>
Message-ID: <63ead3b9-bde3-07a4-353f-54fa7d7005b6@measurement-factory.com>

On 12/22/21 11:29 AM, roee klinger wrote:
> cache_peer 100.70.162.11 parent 16211 0 proxy-only default name=proxy16211
> cache_peer 100.70.162.12 parent 16212 0 proxy-only default name=proxy16212
> cache_peer 100.70.162.13 parent 16213 0 proxy-only default name=proxy16213
> acl peer_group_162 peername_regex -i proxy162.*\b
> 
> Followed by:
> cache_peer_access peer_group_162 allow admin162

According to documentation, the cache_peer_access directive requires a
peer name (or a peer host name) as the second parameter. Your
configuration is using a string "peer_group_162", which is not a name of
any cache_peer.

AFAICT, while you can use peername_regex to _match_ a group of
cache_peers, you still have to name a specific peer as the second
parameter of the cache_peer_access rule. That effectively defeats the
purpose of using peername_regex in this case! It was wrong for me to
point you in peername_regex direction.

Your configuiration has to have at least one cache_peer_access rule for
each cache_peer.


Sorry,

Alex.


> but I got an error:
> ERROR: /etc/squid/conf.d/admin_allow_peer.conf, line 4: No cache_peer
> 'peer_group_162'
> 
> Should I use http_access instead? I am not sure how to use it, because
> peer_group_162 is an ACL, not a cache_peer.
> 
> Also, is my regex entry?correct? I am not sure if \b is supported, and
> if I should add the -i flag or not.
> 
> Thanks alot.
> 
> On Wed, Dec 22, 2021 at 5:27 PM Alex Rousskov wrote:
> 
>     On 12/22/21 10:21 AM, roee klinger wrote:
> 
>     > I have?a group of about 6 cache peers:
>     >
>     >? ? ?cache_peer 100.70.162.11 parent 16211 0 proxy-only default
>     name=proxy16211
>     >? ? ?cache_peer 100.70.162.12 parent 16212 0 proxy-only default
>     name=proxy16212
>     >? ? ?cache_peer 100.70.162.13 parent 16213 0 proxy-only default
>     name=proxy16213
>     >
>     >? ? ?cache_peer 100.70.163.11 parent 16311 0 proxy-only default
>     name=proxy16311
>     >? ? ?cache_peer 100.70.163.12 parent 16312 0 proxy-only default
>     name=proxy16312
>     >? ? ?cache_peer 100.70.163.13 parent 16313 0 proxy-only default
>     name=proxy16313
>     >
>     >
>     > I would like to allow user162_acl access only to the peers that ...
>     > have a name that starts with proxy162
> 
>     According to documentation, a peername_regex ACL can do what you want.
> 
>     Alex.
>     _______________________________________________
>     squid-users mailing list
>     squid-users at lists.squid-cache.org
>     <mailto:squid-users at lists.squid-cache.org>
>     http://lists.squid-cache.org/listinfo/squid-users
>     <http://lists.squid-cache.org/listinfo/squid-users>
> 



From roeeklinger60 at gmail.com  Wed Dec 22 16:56:17 2021
From: roeeklinger60 at gmail.com (roee klinger)
Date: Wed, 22 Dec 2021 18:56:17 +0200
Subject: [squid-users] grouping multiple cache peers possible?
In-Reply-To: <63ead3b9-bde3-07a4-353f-54fa7d7005b6@measurement-factory.com>
References: <CAGCa14rn-SdCWoKJVr2ZRZc+miJ6AUUc9kDK2TOCBfcS59=hhQ@mail.gmail.com>
 <3e621b58-f66e-5ab3-7851-1ef17684b62b@measurement-factory.com>
 <CAGCa14qPEH6G1CXmz4O+Pbuve6HkdhAYB9W7UwbrcuLmTYCpfg@mail.gmail.com>
 <63ead3b9-bde3-07a4-353f-54fa7d7005b6@measurement-factory.com>
Message-ID: <CAGCa14pSR0gW_2SCs30BKtYmeH8-YxfL2KBMMf_0+z_EjNR=+A@mail.gmail.com>

Hey Alex,

Yes, it seems like I do have to put at least one cache_peer_access rule for
each cache_peer.

Currently, Squid is a bit problematic when dealing with many cach_peers,
it requires a lot of configurations for each cach_peer, which makes the
configuration file big
and takes a performance toll.

Hopefully, this post will save some time for people searching for this in
the future.

Thanks,
Roee

On Wed, Dec 22, 2021 at 6:44 PM Alex Rousskov <
rousskov at measurement-factory.com> wrote:

> On 12/22/21 11:29 AM, roee klinger wrote:
> > cache_peer 100.70.162.11 parent 16211 0 proxy-only default
> name=proxy16211
> > cache_peer 100.70.162.12 parent 16212 0 proxy-only default
> name=proxy16212
> > cache_peer 100.70.162.13 parent 16213 0 proxy-only default
> name=proxy16213
> > acl peer_group_162 peername_regex -i proxy162.*\b
> >
> > Followed by:
> > cache_peer_access peer_group_162 allow admin162
>
> According to documentation, the cache_peer_access directive requires a
> peer name (or a peer host name) as the second parameter. Your
> configuration is using a string "peer_group_162", which is not a name of
> any cache_peer.
>
> AFAICT, while you can use peername_regex to _match_ a group of
> cache_peers, you still have to name a specific peer as the second
> parameter of the cache_peer_access rule. That effectively defeats the
> purpose of using peername_regex in this case! It was wrong for me to
> point you in peername_regex direction.
>
> Your configuiration has to have at least one cache_peer_access rule for
> each cache_peer.
>
>
> Sorry,
>
> Alex.
>
>
> > but I got an error:
> > ERROR: /etc/squid/conf.d/admin_allow_peer.conf, line 4: No cache_peer
> > 'peer_group_162'
> >
> > Should I use http_access instead? I am not sure how to use it, because
> > peer_group_162 is an ACL, not a cache_peer.
> >
> > Also, is my regex entry correct? I am not sure if \b is supported, and
> > if I should add the -i flag or not.
> >
> > Thanks alot.
> >
> > On Wed, Dec 22, 2021 at 5:27 PM Alex Rousskov wrote:
> >
> >     On 12/22/21 10:21 AM, roee klinger wrote:
> >
> >     > I have a group of about 6 cache peers:
> >     >
> >     >     cache_peer 100.70.162.11 parent 16211 0 proxy-only default
> >     name=proxy16211
> >     >     cache_peer 100.70.162.12 parent 16212 0 proxy-only default
> >     name=proxy16212
> >     >     cache_peer 100.70.162.13 parent 16213 0 proxy-only default
> >     name=proxy16213
> >     >
> >     >     cache_peer 100.70.163.11 parent 16311 0 proxy-only default
> >     name=proxy16311
> >     >     cache_peer 100.70.163.12 parent 16312 0 proxy-only default
> >     name=proxy16312
> >     >     cache_peer 100.70.163.13 parent 16313 0 proxy-only default
> >     name=proxy16313
> >     >
> >     >
> >     > I would like to allow user162_acl access only to the peers that ...
> >     > have a name that starts with proxy162
> >
> >     According to documentation, a peername_regex ACL can do what you
> want.
> >
> >     Alex.
> >     _______________________________________________
> >     squid-users mailing list
> >     squid-users at lists.squid-cache.org
> >     <mailto:squid-users at lists.squid-cache.org>
> >     http://lists.squid-cache.org/listinfo/squid-users
> >     <http://lists.squid-cache.org/listinfo/squid-users>
> >
>
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20211222/d1a31c0e/attachment.htm>

From roeeklinger60 at gmail.com  Wed Dec 22 17:55:35 2021
From: roeeklinger60 at gmail.com (roee klinger)
Date: Wed, 22 Dec 2021 19:55:35 +0200
Subject: [squid-users] Setting custom cache peer revival times
Message-ID: <CAGCa14pbfp_st1Y0Q0_2ef2B5L-vWBgTdSQbPTzNWsOrbks8_A@mail.gmail.com>

Hello,

I have a set up with a few cache peers:

cache_peer 100.70.162.11 parent 16211 0 proxy-only name=proxy16211
cache_peer 100.70.162.12 parent 16212 0 proxy-only name=proxy16212
cache_peer 100.70.162.13 parent 16213 0 proxy-only name=proxy16213


My cache peers go down and up frequently, and I would like to set Squid to
choose a reliable peer, which has a long-lasting connection from these
peers, so I would like to set rules that would make the peer DOWN fast, but
UP  slow.

For setting the peer to go DOWN fast, there is an easy solution:

dead_peer_timeout 3 seconds


However, on the same page it reads:

However, it continues to send ICP queries, and will mark the peer as alive
upon receipt of the first subsequent ICP reply.


which means that any peers that receive even a single ICP reply will be
marked as back UP again, which is not ideal since it says very little about
the connection quality of this peer.

is there a way for me to change this behavior and have Squid wait for more
than a single ICP reply, for example, 200 replies?

Thanks,
Roee
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20211222/0ca7620b/attachment.htm>

From rousskov at measurement-factory.com  Wed Dec 22 18:53:47 2021
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Wed, 22 Dec 2021 13:53:47 -0500
Subject: [squid-users] grouping multiple cache peers possible?
In-Reply-To: <CAGCa14pSR0gW_2SCs30BKtYmeH8-YxfL2KBMMf_0+z_EjNR=+A@mail.gmail.com>
References: <CAGCa14rn-SdCWoKJVr2ZRZc+miJ6AUUc9kDK2TOCBfcS59=hhQ@mail.gmail.com>
 <3e621b58-f66e-5ab3-7851-1ef17684b62b@measurement-factory.com>
 <CAGCa14qPEH6G1CXmz4O+Pbuve6HkdhAYB9W7UwbrcuLmTYCpfg@mail.gmail.com>
 <63ead3b9-bde3-07a4-353f-54fa7d7005b6@measurement-factory.com>
 <CAGCa14pSR0gW_2SCs30BKtYmeH8-YxfL2KBMMf_0+z_EjNR=+A@mail.gmail.com>
Message-ID: <bddf633b-c8ec-8b65-cbf8-7738398c4a37@measurement-factory.com>

On 12/22/21 11:56 AM, roee klinger wrote:

> Currently, Squid is a bit problematic when dealing with many cach_peers,?
> it requires a lot of configurations for each cach_peer, which makes the
> configuration file big and takes a performance?toll.

Consider merging multiple cache_peer_access rules for the same
cache_peer into one rule (using all-of and any-of ACLs).

You can also outsource peer selection to an external ACL, leaving one
simple cache_peer_access rule (with a single note ACL) for each
cache_peer in squid.conf.

And with some Squid code modifications, one can even let an external ACL
select the cache_peer to use without extra cache_peer_access checks.
This feature would be similar to the existing X-Next-Services routing
functionality in Squid adaptation code.

Finally, one can invest into optimizing/fixing Squid code to eliminate
unnecessary repeated cache_peer_access checks, probably saving a lot of
CPU cycles for Squid instances with many (or complex) cache_peer_access
rules.


Cheers,

Alex.

> On Wed, Dec 22, 2021 at 6:44 PM Alex Rousskov wrote:
> 
>     On 12/22/21 11:29 AM, roee klinger wrote:
>     > cache_peer 100.70.162.11 parent 16211 0 proxy-only default
>     name=proxy16211
>     > cache_peer 100.70.162.12 parent 16212 0 proxy-only default
>     name=proxy16212
>     > cache_peer 100.70.162.13 parent 16213 0 proxy-only default
>     name=proxy16213
>     > acl peer_group_162 peername_regex -i proxy162.*\b
>     >
>     > Followed by:
>     > cache_peer_access peer_group_162 allow admin162
> 
>     According to documentation, the cache_peer_access directive requires a
>     peer name (or a peer host name) as the second parameter. Your
>     configuration is using a string "peer_group_162", which is not a name of
>     any cache_peer.
> 
>     AFAICT, while you can use peername_regex to _match_ a group of
>     cache_peers, you still have to name a specific peer as the second
>     parameter of the cache_peer_access rule. That effectively defeats the
>     purpose of using peername_regex in this case! It was wrong for me to
>     point you in peername_regex direction.
> 
>     Your configuiration has to have at least one cache_peer_access rule for
>     each cache_peer.
> 
> 
>     Sorry,
> 
>     Alex.
> 
> 
>     > but I got an error:
>     > ERROR: /etc/squid/conf.d/admin_allow_peer.conf, line 4: No cache_peer
>     > 'peer_group_162'
>     >
>     > Should I use http_access instead? I am not sure how to use it, because
>     > peer_group_162 is an ACL, not a cache_peer.
>     >
>     > Also, is my regex entry?correct? I am not sure if \b is supported, and
>     > if I should add the -i flag or not.
>     >
>     > Thanks alot.
>     >
>     > On Wed, Dec 22, 2021 at 5:27 PM Alex Rousskov wrote:
>     >
>     >? ? ?On 12/22/21 10:21 AM, roee klinger wrote:
>     >
>     >? ? ?> I have?a group of about 6 cache peers:
>     >? ? ?>
>     >? ? ?>? ? ?cache_peer 100.70.162.11 parent 16211 0 proxy-only default
>     >? ? ?name=proxy16211
>     >? ? ?>? ? ?cache_peer 100.70.162.12 parent 16212 0 proxy-only default
>     >? ? ?name=proxy16212
>     >? ? ?>? ? ?cache_peer 100.70.162.13 parent 16213 0 proxy-only default
>     >? ? ?name=proxy16213
>     >? ? ?>
>     >? ? ?>? ? ?cache_peer 100.70.163.11 parent 16311 0 proxy-only default
>     >? ? ?name=proxy16311
>     >? ? ?>? ? ?cache_peer 100.70.163.12 parent 16312 0 proxy-only default
>     >? ? ?name=proxy16312
>     >? ? ?>? ? ?cache_peer 100.70.163.13 parent 16313 0 proxy-only default
>     >? ? ?name=proxy16313
>     >? ? ?>
>     >? ? ?>
>     >? ? ?> I would like to allow user162_acl access only to the peers
>     that ...
>     >? ? ?> have a name that starts with proxy162
>     >
>     >? ? ?According to documentation, a peername_regex ACL can do what
>     you want.
>     >
>     >? ? ?Alex.
>     >? ? ?_______________________________________________
>     >? ? ?squid-users mailing list
>     >? ? ?squid-users at lists.squid-cache.org
>     <mailto:squid-users at lists.squid-cache.org>
>     >? ? ?<mailto:squid-users at lists.squid-cache.org
>     <mailto:squid-users at lists.squid-cache.org>>
>     >? ? ?http://lists.squid-cache.org/listinfo/squid-users
>     <http://lists.squid-cache.org/listinfo/squid-users>
>     >? ? ?<http://lists.squid-cache.org/listinfo/squid-users
>     <http://lists.squid-cache.org/listinfo/squid-users>>
>     >
> 



From roeeklinger60 at gmail.com  Wed Dec 22 19:29:05 2021
From: roeeklinger60 at gmail.com (roee klinger)
Date: Wed, 22 Dec 2021 21:29:05 +0200
Subject: [squid-users] grouping multiple cache peers possible?
In-Reply-To: <bddf633b-c8ec-8b65-cbf8-7738398c4a37@measurement-factory.com>
References: <CAGCa14rn-SdCWoKJVr2ZRZc+miJ6AUUc9kDK2TOCBfcS59=hhQ@mail.gmail.com>
 <3e621b58-f66e-5ab3-7851-1ef17684b62b@measurement-factory.com>
 <CAGCa14qPEH6G1CXmz4O+Pbuve6HkdhAYB9W7UwbrcuLmTYCpfg@mail.gmail.com>
 <63ead3b9-bde3-07a4-353f-54fa7d7005b6@measurement-factory.com>
 <CAGCa14pSR0gW_2SCs30BKtYmeH8-YxfL2KBMMf_0+z_EjNR=+A@mail.gmail.com>
 <bddf633b-c8ec-8b65-cbf8-7738398c4a37@measurement-factory.com>
Message-ID: <CAGCa14reD0AoZU74afutWNpMr2NEHoV9qQxUZdK9tcFfnLiL8w@mail.gmail.com>

>
> Consider merging multiple cache_peer_access rules for the same
> cache_peer into one rule (using all-of and any-of ACLs).


That is a great tip, thanks!

You can also outsource peer selection to an external ACL, leaving one
> simple cache_peer_access rule (with a single note ACL) for each
> cache_peer in squid.conf.


Actually, I am already doing this, however, there is still a long list of
cache_peer, cache_peer_access, cache_peer_deny rules, and note ACL rules,
to make sure every user goes to the right place, as you mentioned this is
not a CPU friendly approach either, so I will give serious thought
about modifying the Squid code.

Thank you,
Roee.

On Wed, Dec 22, 2021 at 8:53 PM Alex Rousskov <
rousskov at measurement-factory.com> wrote:

> On 12/22/21 11:56 AM, roee klinger wrote:
>
> > Currently, Squid is a bit problematic when dealing with many cach_peers,
> > it requires a lot of configurations for each cach_peer, which makes the
> > configuration file big and takes a performance toll.
>
> Consider merging multiple cache_peer_access rules for the same
> cache_peer into one rule (using all-of and any-of ACLs).
>
> You can also outsource peer selection to an external ACL, leaving one
> simple cache_peer_access rule (with a single note ACL) for each
> cache_peer in squid.conf.
>
> And with some Squid code modifications, one can even let an external ACL
> select the cache_peer to use without extra cache_peer_access checks.
> This feature would be similar to the existing X-Next-Services routing
> functionality in Squid adaptation code.
>
> Finally, one can invest into optimizing/fixing Squid code to eliminate
> unnecessary repeated cache_peer_access checks, probably saving a lot of
> CPU cycles for Squid instances with many (or complex) cache_peer_access
> rules.
>
>
> Cheers,
>
> Alex.
>
> > On Wed, Dec 22, 2021 at 6:44 PM Alex Rousskov wrote:
> >
> >     On 12/22/21 11:29 AM, roee klinger wrote:
> >     > cache_peer 100.70.162.11 parent 16211 0 proxy-only default
> >     name=proxy16211
> >     > cache_peer 100.70.162.12 parent 16212 0 proxy-only default
> >     name=proxy16212
> >     > cache_peer 100.70.162.13 parent 16213 0 proxy-only default
> >     name=proxy16213
> >     > acl peer_group_162 peername_regex -i proxy162.*\b
> >     >
> >     > Followed by:
> >     > cache_peer_access peer_group_162 allow admin162
> >
> >     According to documentation, the cache_peer_access directive requires
> a
> >     peer name (or a peer host name) as the second parameter. Your
> >     configuration is using a string "peer_group_162", which is not a
> name of
> >     any cache_peer.
> >
> >     AFAICT, while you can use peername_regex to _match_ a group of
> >     cache_peers, you still have to name a specific peer as the second
> >     parameter of the cache_peer_access rule. That effectively defeats the
> >     purpose of using peername_regex in this case! It was wrong for me to
> >     point you in peername_regex direction.
> >
> >     Your configuiration has to have at least one cache_peer_access rule
> for
> >     each cache_peer.
> >
> >
> >     Sorry,
> >
> >     Alex.
> >
> >
> >     > but I got an error:
> >     > ERROR: /etc/squid/conf.d/admin_allow_peer.conf, line 4: No
> cache_peer
> >     > 'peer_group_162'
> >     >
> >     > Should I use http_access instead? I am not sure how to use it,
> because
> >     > peer_group_162 is an ACL, not a cache_peer.
> >     >
> >     > Also, is my regex entry correct? I am not sure if \b is supported,
> and
> >     > if I should add the -i flag or not.
> >     >
> >     > Thanks alot.
> >     >
> >     > On Wed, Dec 22, 2021 at 5:27 PM Alex Rousskov wrote:
> >     >
> >     >     On 12/22/21 10:21 AM, roee klinger wrote:
> >     >
> >     >     > I have a group of about 6 cache peers:
> >     >     >
> >     >     >     cache_peer 100.70.162.11 parent 16211 0 proxy-only
> default
> >     >     name=proxy16211
> >     >     >     cache_peer 100.70.162.12 parent 16212 0 proxy-only
> default
> >     >     name=proxy16212
> >     >     >     cache_peer 100.70.162.13 parent 16213 0 proxy-only
> default
> >     >     name=proxy16213
> >     >     >
> >     >     >     cache_peer 100.70.163.11 parent 16311 0 proxy-only
> default
> >     >     name=proxy16311
> >     >     >     cache_peer 100.70.163.12 parent 16312 0 proxy-only
> default
> >     >     name=proxy16312
> >     >     >     cache_peer 100.70.163.13 parent 16313 0 proxy-only
> default
> >     >     name=proxy16313
> >     >     >
> >     >     >
> >     >     > I would like to allow user162_acl access only to the peers
> >     that ...
> >     >     > have a name that starts with proxy162
> >     >
> >     >     According to documentation, a peername_regex ACL can do what
> >     you want.
> >     >
> >     >     Alex.
> >     >     _______________________________________________
> >     >     squid-users mailing list
> >     >     squid-users at lists.squid-cache.org
> >     <mailto:squid-users at lists.squid-cache.org>
> >     >     <mailto:squid-users at lists.squid-cache.org
> >     <mailto:squid-users at lists.squid-cache.org>>
> >     >     http://lists.squid-cache.org/listinfo/squid-users
> >     <http://lists.squid-cache.org/listinfo/squid-users>
> >     >     <http://lists.squid-cache.org/listinfo/squid-users
> >     <http://lists.squid-cache.org/listinfo/squid-users>>
> >     >
> >
>
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20211222/e2c79bbf/attachment.htm>

From pponakanti at roblox.com  Thu Dec 23 07:15:37 2021
From: pponakanti at roblox.com (Praveen Ponakanti)
Date: Wed, 22 Dec 2021 23:15:37 -0800
Subject: [squid-users] Significant memory leak with version 5.x (not
 with 4.17)
In-Reply-To: <CACabJxOTJaKcavxx8AwNoETA6OjsLw0OsdLO=d2M05DpHBstGQ@mail.gmail.com>
References: <CACabJxOfSqVkN63DN=N=_J=B7CtH-ahRkFaAtM93H67BpQx9eA@mail.gmail.com>
 <f68674bd-1203-062d-9786-7513554fafb4@measurement-factory.com>
 <CACabJxOTJaKcavxx8AwNoETA6OjsLw0OsdLO=d2M05DpHBstGQ@mail.gmail.com>
Message-ID: <CACabJxPz9+0E3SAiyDE3hU8r+VFHOG3WpQr5r0WK3NgLkTiLOA@mail.gmail.com>

Hi Alex,

BTW, where do I send the files with the memory logs? I had sent a few
attachments in an email reply to this thread but got back a
message saying it is too large and will need to be reviewed by an admin.
Thanks
Praveen

On Wed, Dec 22, 2021 at 10:58 PM Praveen Ponakanti <pponakanti at roblox.com>
wrote:

> Hi Alex,
>
> Thanks, please see inline below.
>
> On Wed, Dec 22, 2021 at 6:45 AM Alex Rousskov <
> rousskov at measurement-factory.com> wrote:
>
>> On 12/21/21 7:48 PM, Praveen Ponakanti wrote:
>>
>> > We are running the squid proxy for servicing outbound HTTP quests from
>> > our network and have observed a significant memory leak with 5.x
>> > versions. While there are several discussions about memory leaks with
>> > recent versions, just wanted to list out what we have observed in case
>> > this is an unknown leak.
>>
>> I recommend sharing a log with 48+ hourly mgr:mem snapshots. These
>> snapshots help compare your leak with others we know about and may help
>> isolate some of the memory leaks:
>> https://bugs.squid-cache.org/show_bug.cgi?id=5132#c8
>>
>>
> Attached the current memory stats from the 2 nodes that have been taking a
> similar rate of requests, with the node running 5.3 already using up 20G
> more than the 4.17 version. The memory leak increases over a few hours in
> almost a step-like curve each day on the 5.x versions; I will continue
> collecting these stats hourly.
>
> Note, I am using a curl to http://localhost:3128/squid-internal-mgr/mem
> to collect the memory stats as we dont have the squidclient built into the
> docker container that runs the squid proxy. The output appears to be quite
> large with data for each kid process (we have 30 workers configured).
>
>
>> > I have attempted to build squid with -with-valgrind-debug, and run it in
>> > a test env. However valgrind appears to collect some data from the parse
>> > config functions and then the squid proxy restarts.
>>
>> FWIW, valgrind works as expected in my environment. If your Squid proxy
>> is killed by an assertion or crashes, even in a test environment, please
>> consider reporting that bug (after checking that it has not been
>> reported already, of course). If your test proxy is misconfigured, then
>> please fix the configuration before proceeding with tests.
>>
>> The Valgrind image isnt crashing, and it uses the same config that works
> in prod without valgrind. I might have to fix how it is launched from the
> docker entrypoint script in my test env.
>
> root     117051 117005  0 Dec11 ?        00:00:00 /usr/bin/valgrind.bin
> --leak-check=full --show-leak-kinds=all --verbose
> --log-file=/squid/var/logs/valgrind-out.txt /squid/sbin/squid -f
> /squid/etc/squid.conf
>
> gdb attach 1
> GNU gdb (Ubuntu 9.2-0ubuntu1~20.04) 9.2
>
> (gdb) monitor
> "monitor" command not supported by this target.
> (gdb)
>
>
>> Thank you,
>>
>> Alex.
>> _______________________________________________
>> squid-users mailing list
>> squid-users at lists.squid-cache.org
>> http://lists.squid-cache.org/listinfo/squid-users
>>
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20211222/3a007051/attachment.htm>

From rousskov at measurement-factory.com  Thu Dec 23 14:23:37 2021
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Thu, 23 Dec 2021 09:23:37 -0500
Subject: [squid-users] Significant memory leak with version 5.x (not
 with 4.17)
In-Reply-To: <CACabJxOTJaKcavxx8AwNoETA6OjsLw0OsdLO=d2M05DpHBstGQ@mail.gmail.com>
References: <CACabJxOfSqVkN63DN=N=_J=B7CtH-ahRkFaAtM93H67BpQx9eA@mail.gmail.com>
 <f68674bd-1203-062d-9786-7513554fafb4@measurement-factory.com>
 <CACabJxOTJaKcavxx8AwNoETA6OjsLw0OsdLO=d2M05DpHBstGQ@mail.gmail.com>
Message-ID: <88e5e3e2-5641-883b-fd8c-cf4c3796ea4a@measurement-factory.com>

On 12/23/21 1:58 AM, Praveen Ponakanti wrote:
> On Wed, Dec 22, 2021 at 6:45 AM Alex Rousskov wrote:
> 
>     On 12/21/21 7:48 PM, Praveen Ponakanti wrote:
> 
>     > We are running the squid proxy for servicing outbound HTTP quests from
>     > our network and have observed a significant memory leak with 5.x
>     > versions. While there are several discussions about memory leaks with
>     > recent versions, just wanted to list out what we have observed in case
>     > this is an unknown leak.
> 
>     I recommend sharing a log with 48+ hourly mgr:mem snapshots. These
>     snapshots help compare your leak with others we know about and may help
>     isolate some of the memory leaks:
>     https://bugs.squid-cache.org/show_bug.cgi?id=5132#c8

> I will continue collecting these stats hourly.

I will analyze those logs once you share them. Comparing two snapshots
from different Squid versions/instances may be useful, but it is much
more time consuming, and I cannot offer to do that right now.


> The output appears to be quite large

> ... where do I send the files with the memory logs?

The scripts that track memory usage changes across hourly snapshots do
not care about the log size. However, you may want to share a link to
the (compressed) log rather than sharing the log itself. The best place
to share that info, IMO, is the bug report I referenced above, but you
can post here, of course.


> I might have to fix how it is launched from
> the docker entrypoint script in my test env. 

FWIW, here is one of the valgrind commands I use (with paths stripped):

> valgrind -v --trace-children=no --child-silent-after-fork=yes --num-callers=50 --log-file=valgrind-%p.log --time-stamp=yes --leak-check=full --leak-resolution=high --show-reachable=no --track-origins=no --gen-suppressions=all --suppressions=valgrind.supp squid -f squid.conf ...

Valgrind reports useful leak info after Squid exits.

I do not have updated/polished Valgrind suppressions, but I can share
what I use:
https://gist.github.com/rousskov/a1f503981b4a3832ab44221b0b615b5a

I do not use gdb/valgrind monitor so I cannot help you there.


HTH,

Alex.


From pponakanti at roblox.com  Fri Dec 24 06:59:31 2021
From: pponakanti at roblox.com (Praveen Ponakanti)
Date: Thu, 23 Dec 2021 22:59:31 -0800
Subject: [squid-users] Significant memory leak with version 5.x (not
 with 4.17)
In-Reply-To: <88e5e3e2-5641-883b-fd8c-cf4c3796ea4a@measurement-factory.com>
References: <CACabJxOfSqVkN63DN=N=_J=B7CtH-ahRkFaAtM93H67BpQx9eA@mail.gmail.com>
 <f68674bd-1203-062d-9786-7513554fafb4@measurement-factory.com>
 <CACabJxOTJaKcavxx8AwNoETA6OjsLw0OsdLO=d2M05DpHBstGQ@mail.gmail.com>
 <88e5e3e2-5641-883b-fd8c-cf4c3796ea4a@measurement-factory.com>
Message-ID: <CACabJxN4Vn5HGnoh4b5wVJQm2wRGeBXSH0gcxPwY37cv1wJPmA@mail.gmail.com>

Hi Alex,

I have attached a log with about 24 hours of memory stats from our squid
proxy running version 5.3. The memory usage increased during the first
11-12 hours of the log and then flatted out. The same pattern repeats
itself each day with about an additional 2-3G being used up. Let me know if
you need any additional logs. I will take another shot at the test setup
with Valgrind later on. Happy holidays!

https://bugs.squid-cache.org/show_bug.cgi?id=5132

Thanks
Praveen

On Thu, Dec 23, 2021 at 6:23 AM Alex Rousskov <
rousskov at measurement-factory.com> wrote:

> On 12/23/21 1:58 AM, Praveen Ponakanti wrote:
> > On Wed, Dec 22, 2021 at 6:45 AM Alex Rousskov wrote:
> >
> >     On 12/21/21 7:48 PM, Praveen Ponakanti wrote:
> >
> >     > We are running the squid proxy for servicing outbound HTTP quests
> from
> >     > our network and have observed a significant memory leak with 5.x
> >     > versions. While there are several discussions about memory leaks
> with
> >     > recent versions, just wanted to list out what we have observed in
> case
> >     > this is an unknown leak.
> >
> >     I recommend sharing a log with 48+ hourly mgr:mem snapshots. These
> >     snapshots help compare your leak with others we know about and may
> help
> >     isolate some of the memory leaks:
> >     https://bugs.squid-cache.org/show_bug.cgi?id=5132#c8
>
> > I will continue collecting these stats hourly.
>
> I will analyze those logs once you share them. Comparing two snapshots
> from different Squid versions/instances may be useful, but it is much
> more time consuming, and I cannot offer to do that right now.
>
>
> > The output appears to be quite large
>
> > ... where do I send the files with the memory logs?
>
> The scripts that track memory usage changes across hourly snapshots do
> not care about the log size. However, you may want to share a link to
> the (compressed) log rather than sharing the log itself. The best place
> to share that info, IMO, is the bug report I referenced above, but you
> can post here, of course.
>
>
> > I might have to fix how it is launched from
> > the docker entrypoint script in my test env.
>
> FWIW, here is one of the valgrind commands I use (with paths stripped):
>
> > valgrind -v --trace-children=no --child-silent-after-fork=yes
> --num-callers=50 --log-file=valgrind-%p.log --time-stamp=yes
> --leak-check=full --leak-resolution=high --show-reachable=no
> --track-origins=no --gen-suppressions=all --suppressions=valgrind.supp
> squid -f squid.conf ...
>
> Valgrind reports useful leak info after Squid exits.
>
> I do not have updated/polished Valgrind suppressions, but I can share
> what I use:
> https://gist.github.com/rousskov/a1f503981b4a3832ab44221b0b615b5a
>
> I do not use gdb/valgrind monitor so I cannot help you there.
>
>
> HTH,
>
> Alex.
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20211223/a5f48b3a/attachment.htm>

From loucansky.lukas at kjj.cz  Fri Dec 24 12:24:30 2021
From: loucansky.lukas at kjj.cz (=?UTF-8?B?THVrw6HFoSBMb3XEjWFuc2vDvQ==?=)
Date: Fri, 24 Dec 2021 13:24:30 +0100
Subject: [squid-users] Significant memory leak with version 5.x (not
 with 4.17)
In-Reply-To: <CACabJxN4Vn5HGnoh4b5wVJQm2wRGeBXSH0gcxPwY37cv1wJPmA@mail.gmail.com>
References: <CACabJxOfSqVkN63DN=N=_J=B7CtH-ahRkFaAtM93H67BpQx9eA@mail.gmail.com>
 <f68674bd-1203-062d-9786-7513554fafb4@measurement-factory.com>
 <CACabJxOTJaKcavxx8AwNoETA6OjsLw0OsdLO=d2M05DpHBstGQ@mail.gmail.com>
 <88e5e3e2-5641-883b-fd8c-cf4c3796ea4a@measurement-factory.com>
 <CACabJxN4Vn5HGnoh4b5wVJQm2wRGeBXSH0gcxPwY37cv1wJPmA@mail.gmail.com>
Message-ID: <80242ed5-4e35-b2e3-80cb-82b78f4303e1@kjj.cz>

Sorry - maybe I'll post something irrelevant - but my Squid5.3 is 
running for 3 days now. As it seems the number of user's requests 
declined (xmas holliday) - the memory consuption stabilized and is not 
increasing (seemingly - I check only by mrtg figures - I'dont sample 
memory info because it seemed not prooffing)

Anyway general info shows:

Maximum Resident Size: 48399664 KB Page faults with physical i/o: 171 
Memory accounted for: Total accounted: 2013907 KB memPoolAlloc calls: 
390527804 memPoolFree calls: 395188267 Max resident size 46GB??? Memory 
allocated total: 2014463 kB. PID USER????? PR? NI??? VIRT??? RES??? SHR 
S? %CPU? %MEM???? TIME+ COMMAND 15487 proxy???? 20?? 0?? 11.6g? 11.5g? 
10344 S?? 0.0? 73.7 103:34.23 (squid-1) --kid squid-1 -YC -f 
/etc/squid5/squid.conf Is it something not included in the memory 
utilization chart? Something tied to connections? requests? ssl contexts? L

Dne 24.12.2021 v 7:59 Praveen Ponakanti napsal(a):
> Hi Alex,
>
> I have attached a log with about 24 hours of memory stats from our 
> squid proxy running version 5.3. The memory usage increased?during the 
> first 11-12 hours of the log and then flatted out. The same pattern 
> repeats itself each day with?about an additional 2-3G being used up. 
> Let me know if you need any additional logs. I will take another?shot 
> at the test setup with Valgrind later on. Happy holidays!
>
> https://bugs.squid-cache.org/show_bug.cgi?id=5132
>
> Thanks
> Praveen
>
> On Thu, Dec 23, 2021 at 6:23 AM Alex Rousskov 
> <rousskov at measurement-factory.com> wrote:
>
>     On 12/23/21 1:58 AM, Praveen Ponakanti wrote:
>     > On Wed, Dec 22, 2021 at 6:45 AM Alex Rousskov wrote:
>     >
>     >? ? ?On 12/21/21 7:48 PM, Praveen Ponakanti wrote:
>     >
>     >? ? ?> We are running the squid proxy for servicing outbound HTTP
>     quests from
>     >? ? ?> our network and have observed a significant memory leak
>     with 5.x
>     >? ? ?> versions. While there are several discussions about memory
>     leaks with
>     >? ? ?> recent versions, just wanted to list out what we have
>     observed in case
>     >? ? ?> this is an unknown leak.
>     >
>     >? ? ?I recommend sharing a log with 48+ hourly mgr:mem snapshots.
>     These
>     >? ? ?snapshots help compare your leak with others we know about
>     and may help
>     >? ? ?isolate some of the memory leaks:
>     > https://bugs.squid-cache.org/show_bug.cgi?id=5132#c8
>
>     > I will continue collecting these stats hourly.
>
>     I will analyze those logs once you share them. Comparing two snapshots
>     from different Squid versions/instances may be useful, but it is much
>     more time consuming, and I cannot offer to do that right now.
>
>
>     > The output appears to be quite large
>
>     > ... where do I send the files with the memory logs?
>
>     The scripts that track memory usage changes across hourly snapshots do
>     not care about the log size. However, you may want to share a link to
>     the (compressed) log rather than sharing the log itself. The best
>     place
>     to share that info, IMO, is the bug report I referenced above, but you
>     can post here, of course.
>
>
>     > I might have to fix how it is launched from
>     > the docker entrypoint script in my test env.
>
>     FWIW, here is one of the valgrind commands I use (with paths
>     stripped):
>
>     > valgrind -v --trace-children=no --child-silent-after-fork=yes
>     --num-callers=50 --log-file=valgrind-%p.log --time-stamp=yes
>     --leak-check=full --leak-resolution=high --show-reachable=no
>     --track-origins=no --gen-suppressions=all
>     --suppressions=valgrind.supp squid -f squid.conf ...
>
>     Valgrind reports useful leak info after Squid exits.
>
>     I do not have updated/polished Valgrind suppressions, but I can share
>     what I use:
>     https://gist.github.com/rousskov/a1f503981b4a3832ab44221b0b615b5a
>
>     I do not use gdb/valgrind monitor so I cannot help you there.
>
>
>     HTH,
>
>     Alex.
>
>
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users

-- 
Tato zpr?va byla zkontrolov?na na viry programem Avast Antivirus.
https://www.avast.com/antivirus
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20211224/c2369ddb/attachment.htm>

From pponakanti at roblox.com  Sat Dec 25 01:09:21 2021
From: pponakanti at roblox.com (Praveen Ponakanti)
Date: Fri, 24 Dec 2021 17:09:21 -0800
Subject: [squid-users] Significant memory leak with version 5.x (not
 with 4.17)
In-Reply-To: <80242ed5-4e35-b2e3-80cb-82b78f4303e1@kjj.cz>
References: <CACabJxOfSqVkN63DN=N=_J=B7CtH-ahRkFaAtM93H67BpQx9eA@mail.gmail.com>
 <f68674bd-1203-062d-9786-7513554fafb4@measurement-factory.com>
 <CACabJxOTJaKcavxx8AwNoETA6OjsLw0OsdLO=d2M05DpHBstGQ@mail.gmail.com>
 <88e5e3e2-5641-883b-fd8c-cf4c3796ea4a@measurement-factory.com>
 <CACabJxN4Vn5HGnoh4b5wVJQm2wRGeBXSH0gcxPwY37cv1wJPmA@mail.gmail.com>
 <80242ed5-4e35-b2e3-80cb-82b78f4303e1@kjj.cz>
Message-ID: <CACabJxMO-V86qzg9jk0wV=V=Q+j4Gq+4OehxkZkWV284+XaJkg@mail.gmail.com>

Hi Lukas,
Yeah, that is somewhat consistent with what we notice in our setup. The
leak appears to grow only when the traffic through the squid approaches the
previous day's mid-high request rates, but not during low request rates.

On Fri, Dec 24, 2021 at 4:25 AM Luk?? Lou?ansk? <loucansky.lukas at kjj.cz>
wrote:

> Sorry - maybe I'll post something irrelevant - but my Squid5.3 is running
> for 3 days now. As it seems the number of user's requests declined (xmas
> holliday) - the memory consuption stabilized and is not increasing
> (seemingly - I check only by mrtg figures - I'dont sample memory info
> because it seemed not prooffing)
>
> Anyway general info shows:
>
> Maximum Resident Size: 48399664 KB
> 	Page faults with physical i/o: 171
> Memory accounted for:
> 	Total accounted:       2013907 KB
> 	memPoolAlloc calls: 390527804
> 	memPoolFree calls:  395188267
>
> Max resident size 46GB???
>
> Memory allocated total: 2014463 kB.
>
>
> PID USER      PR  NI    VIRT    RES    SHR S  %CPU  %MEM     TIME+ COMMAND
> 15487 proxy     20   0   11.6g  11.5g  10344 S   0.0  73.7 103:34.23 (squid-1) --kid squid-1 -YC -f /etc/squid5/squid.conf
>
> Is it something not included in the memory utilization chart? Something tied to connections? requests? ssl contexts?
> L
>
> Dne 24.12.2021 v 7:59 Praveen Ponakanti napsal(a):
>
> Hi Alex,
>
> I have attached a log with about 24 hours of memory stats from our squid
> proxy running version 5.3. The memory usage increased during the first
> 11-12 hours of the log and then flatted out. The same pattern repeats
> itself each day with about an additional 2-3G being used up. Let me know if
> you need any additional logs. I will take another shot at the test setup
> with Valgrind later on. Happy holidays!
>
> https://bugs.squid-cache.org/show_bug.cgi?id=5132
>
> Thanks
> Praveen
>
> On Thu, Dec 23, 2021 at 6:23 AM Alex Rousskov <
> rousskov at measurement-factory.com> wrote:
>
>> On 12/23/21 1:58 AM, Praveen Ponakanti wrote:
>> > On Wed, Dec 22, 2021 at 6:45 AM Alex Rousskov wrote:
>> >
>> >     On 12/21/21 7:48 PM, Praveen Ponakanti wrote:
>> >
>> >     > We are running the squid proxy for servicing outbound HTTP quests
>> from
>> >     > our network and have observed a significant memory leak with 5.x
>> >     > versions. While there are several discussions about memory leaks
>> with
>> >     > recent versions, just wanted to list out what we have observed in
>> case
>> >     > this is an unknown leak.
>> >
>> >     I recommend sharing a log with 48+ hourly mgr:mem snapshots. These
>> >     snapshots help compare your leak with others we know about and may
>> help
>> >     isolate some of the memory leaks:
>> >     https://bugs.squid-cache.org/show_bug.cgi?id=5132#c8
>>
>> > I will continue collecting these stats hourly.
>>
>> I will analyze those logs once you share them. Comparing two snapshots
>> from different Squid versions/instances may be useful, but it is much
>> more time consuming, and I cannot offer to do that right now.
>>
>>
>> > The output appears to be quite large
>>
>> > ... where do I send the files with the memory logs?
>>
>> The scripts that track memory usage changes across hourly snapshots do
>> not care about the log size. However, you may want to share a link to
>> the (compressed) log rather than sharing the log itself. The best place
>> to share that info, IMO, is the bug report I referenced above, but you
>> can post here, of course.
>>
>>
>> > I might have to fix how it is launched from
>> > the docker entrypoint script in my test env.
>>
>> FWIW, here is one of the valgrind commands I use (with paths stripped):
>>
>> > valgrind -v --trace-children=no --child-silent-after-fork=yes
>> --num-callers=50 --log-file=valgrind-%p.log --time-stamp=yes
>> --leak-check=full --leak-resolution=high --show-reachable=no
>> --track-origins=no --gen-suppressions=all --suppressions=valgrind.supp
>> squid -f squid.conf ...
>>
>> Valgrind reports useful leak info after Squid exits.
>>
>> I do not have updated/polished Valgrind suppressions, but I can share
>> what I use:
>> https://gist.github.com/rousskov/a1f503981b4a3832ab44221b0b615b5a
>>
>> I do not use gdb/valgrind monitor so I cannot help you there.
>>
>>
>> HTH,
>>
>> Alex.
>>
>
> _______________________________________________
> squid-users mailing listsquid-users at lists.squid-cache.orghttp://lists.squid-cache.org/listinfo/squid-users
>
>
>
> <https://www.avast.com/sig-email?utm_medium=email&utm_source=link&utm_campaign=sig-email&utm_content=emailclient> Bez
> vir?. www.avast.com
> <https://www.avast.com/sig-email?utm_medium=email&utm_source=link&utm_campaign=sig-email&utm_content=emailclient>
> <#m_-8843196809291168515_DAB4FAD8-2DD7-40BB-A1B8-4E2AA1F9FDF2>
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20211224/450060bd/attachment.htm>

From squid3 at treenet.co.nz  Sun Dec 26 06:32:41 2021
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Sun, 26 Dec 2021 19:32:41 +1300
Subject: [squid-users] Significant memory leak with version 5.x (not
 with 4.17)
In-Reply-To: <80242ed5-4e35-b2e3-80cb-82b78f4303e1@kjj.cz>
References: <CACabJxOfSqVkN63DN=N=_J=B7CtH-ahRkFaAtM93H67BpQx9eA@mail.gmail.com>
 <f68674bd-1203-062d-9786-7513554fafb4@measurement-factory.com>
 <CACabJxOTJaKcavxx8AwNoETA6OjsLw0OsdLO=d2M05DpHBstGQ@mail.gmail.com>
 <88e5e3e2-5641-883b-fd8c-cf4c3796ea4a@measurement-factory.com>
 <CACabJxN4Vn5HGnoh4b5wVJQm2wRGeBXSH0gcxPwY37cv1wJPmA@mail.gmail.com>
 <80242ed5-4e35-b2e3-80cb-82b78f4303e1@kjj.cz>
Message-ID: <fed44ba8-b77a-6953-6053-735ce1fbe43e@treenet.co.nz>

On 25/12/21 01:24, Luk?? Lou?ansk? wrote:
> Sorry - maybe I'll post something irrelevant - but my Squid5.3 is 
> running for 3 days now. As it seems the number of user's requests 
> declined (xmas holliday) - the memory consuption stabilized and is not 
> increasing (seemingly - I check only by mrtg figures - I'dont sample 
> memory info because it seemed not prooffing)
> 
> Anyway general info shows:
> 
> Maximum Resident Size: 48399664 KB Page faults with physical i/o: 171 
> Memory accounted for: Total accounted: 2013907 KB memPoolAlloc calls: 
> 390527804 memPoolFree calls: 395188267 Max resident size 46GB???


Hi Luk?? ,

  This particular value is known to sometimes receive weird/garbage 
values from the libc API on 64-bit systems, and combines *all* active 
Squid processes. So be skeptical and prefer OS tools if this matters. 
Your top output shows a more trustworthy 11 GB resident size for (one 
of?) the Squid worker process.


> Memory 
> allocated total: 2014463 kB. PID USER????? PR? NI??? VIRT??? RES??? SHR 
> S? %CPU? %MEM???? TIME+ COMMAND

> 15487 proxy???? 20?? 0?? 11.6g? 11.5g  
> 10344 S?? 0.0? 73.7 103:34.23 (squid-1) --kid squid-1 -YC -f 
> /etc/squid5/squid.conf Is it something not included in the memory 
> utilization chart?

Hopefully not, but it could be something not using Squid Memory pools 
tracking.


> Something tied to connections? requests? ssl contexts? L
> 

"yes maybe" to all the above.


Amos


From squid3 at treenet.co.nz  Sun Dec 26 06:41:42 2021
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Sun, 26 Dec 2021 19:41:42 +1300
Subject: [squid-users] Significant memory leak with version 5.x (not
 with 4.17)
In-Reply-To: <CACabJxMO-V86qzg9jk0wV=V=Q+j4Gq+4OehxkZkWV284+XaJkg@mail.gmail.com>
References: <CACabJxOfSqVkN63DN=N=_J=B7CtH-ahRkFaAtM93H67BpQx9eA@mail.gmail.com>
 <f68674bd-1203-062d-9786-7513554fafb4@measurement-factory.com>
 <CACabJxOTJaKcavxx8AwNoETA6OjsLw0OsdLO=d2M05DpHBstGQ@mail.gmail.com>
 <88e5e3e2-5641-883b-fd8c-cf4c3796ea4a@measurement-factory.com>
 <CACabJxN4Vn5HGnoh4b5wVJQm2wRGeBXSH0gcxPwY37cv1wJPmA@mail.gmail.com>
 <80242ed5-4e35-b2e3-80cb-82b78f4303e1@kjj.cz>
 <CACabJxMO-V86qzg9jk0wV=V=Q+j4Gq+4OehxkZkWV284+XaJkg@mail.gmail.com>
Message-ID: <c06023d4-c97c-7ae5-037f-f20249f87ca3@treenet.co.nz>


If possible can one of you run a Squid to get this behaviour, then stop 
new clients connecting to it before lack of memory issues occur and see 
if the memory usage disappears or reduces after a 24-48hr wait.

A series of regular mempools report dumps from across the test may help 
Alex or whoever works on the bug eliminate further which cache and 
client related things are releasing properly.


Amos



From squid3 at treenet.co.nz  Sun Dec 26 06:59:58 2021
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Sun, 26 Dec 2021 19:59:58 +1300
Subject: [squid-users] Many new ERROR lines in cache.log after upgrade
In-Reply-To: <a3a6c6d046d24982bc6718583d30f4ed@zkb.ch>
References: <a3a6c6d046d24982bc6718583d30f4ed@zkb.ch>
Message-ID: <d5b65087-af47-ab3e-d98c-5003f5bfeebf@treenet.co.nz>

On 22/12/21 06:04, Truniger Othmar wrote:
> Hi Amos,
> thank you very much for your reply. It already helped me a lot.
> 
>>> I understand it's related to basic helpers. Since ever we use the original
>> basic_ldap_auth and ext_ldap_group_acl and never experienced any problems
>> with them. Also cachemgr now reports 100% successful requests/replies for the
>> helpers and I see not any indication for any problem.
>>> It just looks a little awkward to see ERROR in these lines but Success for
>> everything at the same time.
>>> I have set "debug_options ALL,1 rotate=2"
>>> The helpers don't use persistent connections.
>>>
>>
>> The lines shown do not indicate which type of helper is involved.
>>
>> Squid is receiving one of the following lines from the helper:
>>
>>     BH message="Success;"
>>     BH Success;
> 
> it turned out it's the basic_ldap_auth helper which produces this output.
> 
>> Maybe, a little bit anyway. It will be affecting some transactions at
>> least and should be fixed.
> 
> it turned out that I don't have to worry. I'm now able to reproduce it easily: the log lines occur every time when a user is sending an invalid password.
> Fortunately that does not happen too often and I don't have to care anyway. It's just an annoyance to have it all logged in cache.log.
> 

Thank you for the feedback. Definitely a helper bug there, and maybe a 
second with cache mgr not tracking the BH responses.

I have opened <https://bugs.squid-cache.org/show_bug.cgi?id=5181> to 
track the helper one. If you want to be kept informed or assist anyone 
who picks it up please add yourself to the bug.

Cheers
Amos


From loucansky.lukas at kjj.cz  Sun Dec 26 09:02:40 2021
From: loucansky.lukas at kjj.cz (=?UTF-8?B?THVrw6HFoSBMb3XEjWFuc2vDvQ==?=)
Date: Sun, 26 Dec 2021 10:02:40 +0100
Subject: [squid-users] Significant memory leak with version 5.x (not
 with 4.17)
In-Reply-To: <c06023d4-c97c-7ae5-037f-f20249f87ca3@treenet.co.nz>
References: <CACabJxOfSqVkN63DN=N=_J=B7CtH-ahRkFaAtM93H67BpQx9eA@mail.gmail.com>
 <f68674bd-1203-062d-9786-7513554fafb4@measurement-factory.com>
 <CACabJxOTJaKcavxx8AwNoETA6OjsLw0OsdLO=d2M05DpHBstGQ@mail.gmail.com>
 <88e5e3e2-5641-883b-fd8c-cf4c3796ea4a@measurement-factory.com>
 <CACabJxN4Vn5HGnoh4b5wVJQm2wRGeBXSH0gcxPwY37cv1wJPmA@mail.gmail.com>
 <80242ed5-4e35-b2e3-80cb-82b78f4303e1@kjj.cz>
 <CACabJxMO-V86qzg9jk0wV=V=Q+j4Gq+4OehxkZkWV284+XaJkg@mail.gmail.com>
 <c06023d4-c97c-7ae5-037f-f20249f87ca3@treenet.co.nz>
Message-ID: <cc63af40-3aa5-15ef-30ac-2f929b6def8f@kjj.cz>

ok - as it seems my squid quacked on low memory again today -

Dec 26 00:04:25 gw (squid-1): FATAL: Too many queued store_id requests; 
see on-persistent-overload.#012??? current master transaction: master4629331
Dec 26 00:04:28 gw squid[15485]: Squid Parent: squid-1 process 15487 
exited with status 1
Dec 26 00:04:28 gw squid[15485]: Squid Parent: (squid-1) process 28375 
started

2021/12/26 00:01:20 kid1| helperOpenServers: Starting 5/64 
'storeid_file_rewrite' processes
2021/12/26 00:01:20 kid1| ipcCreate: fork: (12) Cannot allocate memory
2021/12/26 00:01:20 kid1| WARNING: Cannot run 
'/lib/squid5/storeid_file_rewrite' process.
2021/12/26 00:01:20 kid1| ipcCreate: fork: (12) Cannot allocate memory

I'm going to reroute my clients (which are on their days off anyway) to 
direct connections and run it "dry" - on it's own. But I'm not able to 
to test it before "lack of memory issues occur" - because my clients are 
offline. So I'll watch squid for it's own memory consuption. It's all I 
can do right now - my squid already restarted and it's memory has been 
freed - so I think just now I have no power to fill it up again :-]

L

Dne 26.12.2021 v 7:41 Amos Jeffries napsal(a):
>
> If possible can one of you run a Squid to get this behaviour, then 
> stop new clients connecting to it before lack of memory issues occur 
> and see if the memory usage disappears or reduces after a 24-48hr wait.
>
> A series of regular mempools report dumps from across the test may 
> help Alex or whoever works on the bug eliminate further which cache 
> and client related things are releasing properly.
>
>
> Amos
>
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users

-- 
Tato zpr?va byla zkontrolov?na na viry programem Avast Antivirus.
https://www.avast.com/antivirus



From loucansky.lukas at kjj.cz  Mon Dec 27 10:26:18 2021
From: loucansky.lukas at kjj.cz (=?UTF-8?B?THVrw6HFoSBMb3XEjWFuc2vDvQ==?=)
Date: Mon, 27 Dec 2021 11:26:18 +0100
Subject: [squid-users] Significant memory leak with version 5.x (not
 with 4.17)
In-Reply-To: <cc63af40-3aa5-15ef-30ac-2f929b6def8f@kjj.cz>
References: <CACabJxOfSqVkN63DN=N=_J=B7CtH-ahRkFaAtM93H67BpQx9eA@mail.gmail.com>
 <f68674bd-1203-062d-9786-7513554fafb4@measurement-factory.com>
 <CACabJxOTJaKcavxx8AwNoETA6OjsLw0OsdLO=d2M05DpHBstGQ@mail.gmail.com>
 <88e5e3e2-5641-883b-fd8c-cf4c3796ea4a@measurement-factory.com>
 <CACabJxN4Vn5HGnoh4b5wVJQm2wRGeBXSH0gcxPwY37cv1wJPmA@mail.gmail.com>
 <80242ed5-4e35-b2e3-80cb-82b78f4303e1@kjj.cz>
 <CACabJxMO-V86qzg9jk0wV=V=Q+j4Gq+4OehxkZkWV284+XaJkg@mail.gmail.com>
 <c06023d4-c97c-7ae5-037f-f20249f87ca3@treenet.co.nz>
 <cc63af40-3aa5-15ef-30ac-2f929b6def8f@kjj.cz>
Message-ID: <4a1ae799-2d3b-37c8-8d24-d98f95a424fa@kjj.cz>

After one day of running without clients my squid memory is stable

29345 proxy???? 20?? 0? 171348 122360? 14732 S?? 0.0?? 0.7?? 0:25.96 
(squid-1) --kid squid-1 -YC -f /etc/squid5/squid.conf
29343 root????? 20?? 0? 133712? 79264?? 9284 S?? 0.0?? 0.5 0:00.00 
/usr/sbin/squid -YC -f /etc/squid5/squid.conf

Storage Mem size: 3944 KB Storage Mem capacity: 0.2% used, 99.8% free 
Maximum Resident Size: 489440 KB Page faults with physical i/o: 0 Memory 
accounted for: Total accounted: 15741 KB memPoolAlloc calls: 1061495 
memPoolFree calls: 1071691 Total allocated 15741 kB So this does not 
seem to be the problem... L

Dne 26.12.2021 v 10:02 Luk?? Lou?ansk? napsal(a):
> ok - as it seems my squid quacked on low memory again today -
>
> Dec 26 00:04:25 gw (squid-1): FATAL: Too many queued store_id 
> requests; see on-persistent-overload.#012??? current master 
> transaction: master4629331
> Dec 26 00:04:28 gw squid[15485]: Squid Parent: squid-1 process 15487 
> exited with status 1
> Dec 26 00:04:28 gw squid[15485]: Squid Parent: (squid-1) process 28375 
> started
>
> 2021/12/26 00:01:20 kid1| helperOpenServers: Starting 5/64 
> 'storeid_file_rewrite' processes
> 2021/12/26 00:01:20 kid1| ipcCreate: fork: (12) Cannot allocate memory
> 2021/12/26 00:01:20 kid1| WARNING: Cannot run 
> '/lib/squid5/storeid_file_rewrite' process.
> 2021/12/26 00:01:20 kid1| ipcCreate: fork: (12) Cannot allocate memory
>
> I'm going to reroute my clients (which are on their days off anyway) 
> to direct connections and run it "dry" - on it's own. But I'm not able 
> to to test it before "lack of memory issues occur" - because my 
> clients are offline. So I'll watch squid for it's own memory 
> consuption. It's all I can do right now - my squid already restarted 
> and it's memory has been freed - so I think just now I have no power 
> to fill it up again :-]
>
> L
>
> Dne 26.12.2021 v 7:41 Amos Jeffries napsal(a):
>>
>> If possible can one of you run a Squid to get this behaviour, then 
>> stop new clients connecting to it before lack of memory issues occur 
>> and see if the memory usage disappears or reduces after a 24-48hr wait.
>>
>> A series of regular mempools report dumps from across the test may 
>> help Alex or whoever works on the bug eliminate further which cache 
>> and client related things are releasing properly.
>>
>>
>> Amos
>>
>> _______________________________________________
>> squid-users mailing list
>> squid-users at lists.squid-cache.org
>> http://lists.squid-cache.org/listinfo/squid-users
>

-- 
Tato zpr?va byla zkontrolov?na na viry programem Avast Antivirus.
https://www.avast.com/antivirus
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20211227/47ac891c/attachment.htm>

From pponakanti at roblox.com  Tue Dec 28 00:58:44 2021
From: pponakanti at roblox.com (Praveen Ponakanti)
Date: Mon, 27 Dec 2021 16:58:44 -0800
Subject: [squid-users] Significant memory leak with version 5.x (not
 with 4.17)
In-Reply-To: <4a1ae799-2d3b-37c8-8d24-d98f95a424fa@kjj.cz>
References: <CACabJxOfSqVkN63DN=N=_J=B7CtH-ahRkFaAtM93H67BpQx9eA@mail.gmail.com>
 <f68674bd-1203-062d-9786-7513554fafb4@measurement-factory.com>
 <CACabJxOTJaKcavxx8AwNoETA6OjsLw0OsdLO=d2M05DpHBstGQ@mail.gmail.com>
 <88e5e3e2-5641-883b-fd8c-cf4c3796ea4a@measurement-factory.com>
 <CACabJxN4Vn5HGnoh4b5wVJQm2wRGeBXSH0gcxPwY37cv1wJPmA@mail.gmail.com>
 <80242ed5-4e35-b2e3-80cb-82b78f4303e1@kjj.cz>
 <CACabJxMO-V86qzg9jk0wV=V=Q+j4Gq+4OehxkZkWV284+XaJkg@mail.gmail.com>
 <c06023d4-c97c-7ae5-037f-f20249f87ca3@treenet.co.nz>
 <cc63af40-3aa5-15ef-30ac-2f929b6def8f@kjj.cz>
 <4a1ae799-2d3b-37c8-8d24-d98f95a424fa@kjj.cz>
Message-ID: <CACabJxNvqBr1=UswwszfDvBjjrFHTDi87bFDuzTtJ8Tc4OM2RQ@mail.gmail.com>

I cant make any changes to our prod squids this week. I have a squid
instance (5.3v) in a test env but could not reproduce the leak by starting
& stopping traffic with a bulk http req generator (wrk). Was able to send
175k rps @ 20k concurrent sessions (each doing a get on a 1KB object)
through the 30-worker squid. This initially caused a 3G increase in memory
usage and then flattened out after stopping the requests. If I restart the
bulk reqs, the memory usage only goes up ~0.5GB and then drops back down.
Live traffic is probably exercising a different code path within squid's
memory pools.

On Mon, Dec 27, 2021 at 2:26 AM Luk?? Lou?ansk? <loucansky.lukas at kjj.cz>
wrote:

> After one day of running without clients my squid memory is stable
>
> 29345 proxy     20   0  171348 122360  14732 S   0.0   0.7   0:25.96
> (squid-1) --kid squid-1 -YC -f /etc/squid5/squid.conf
> 29343 root      20   0  133712  79264   9284 S   0.0   0.5   0:00.00
> /usr/sbin/squid -YC -f /etc/squid5/squid.conf
>
> Storage Mem size:	3944 KB
> Storage Mem capacity:	 0.2% used, 99.8% free
> 	
> Maximum Resident Size: 489440 KB
> Page faults with physical i/o: 0
> Memory accounted for:
> Total accounted:        15741 KB
> memPoolAlloc calls:   1061495
> memPoolFree calls:    1071691
>
> Total allocated 15741	kB
>
> So this does not seem to be the problem...
> L
>
> Dne 26.12.2021 v 10:02 Luk?? Lou?ansk? napsal(a):
>
> ok - as it seems my squid quacked on low memory again today -
>
> Dec 26 00:04:25 gw (squid-1): FATAL: Too many queued store_id requests;
> see on-persistent-overload.#012    current master transaction:
> master4629331
> Dec 26 00:04:28 gw squid[15485]: Squid Parent: squid-1 process 15487
> exited with status 1
> Dec 26 00:04:28 gw squid[15485]: Squid Parent: (squid-1) process 28375
> started
>
> 2021/12/26 00:01:20 kid1| helperOpenServers: Starting 5/64
> 'storeid_file_rewrite' processes
> 2021/12/26 00:01:20 kid1| ipcCreate: fork: (12) Cannot allocate memory
> 2021/12/26 00:01:20 kid1| WARNING: Cannot run
> '/lib/squid5/storeid_file_rewrite' process.
> 2021/12/26 00:01:20 kid1| ipcCreate: fork: (12) Cannot allocate memory
>
> I'm going to reroute my clients (which are on their days off anyway) to
> direct connections and run it "dry" - on it's own. But I'm not able to to
> test it before "lack of memory issues occur" - because my clients are
> offline. So I'll watch squid for it's own memory consuption. It's all I can
> do right now - my squid already restarted and it's memory has been freed -
> so I think just now I have no power to fill it up again :-]
>
> L
>
> Dne 26.12.2021 v 7:41 Amos Jeffries napsal(a):
>
>
> If possible can one of you run a Squid to get this behaviour, then stop
> new clients connecting to it before lack of memory issues occur and see if
> the memory usage disappears or reduces after a 24-48hr wait.
>
> A series of regular mempools report dumps from across the test may help
> Alex or whoever works on the bug eliminate further which cache and client
> related things are releasing properly.
>
>
> Amos
>
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users
>
>
>
>
> <https://www.avast.com/sig-email?utm_medium=email&utm_source=link&utm_campaign=sig-email&utm_content=emailclient> Bez
> vir?. www.avast.com
> <https://www.avast.com/sig-email?utm_medium=email&utm_source=link&utm_campaign=sig-email&utm_content=emailclient>
> <#m_9217020348889694418_DAB4FAD8-2DD7-40BB-A1B8-4E2AA1F9FDF2>
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20211227/124e5f23/attachment.htm>

From roeeklinger60 at gmail.com  Tue Dec 28 05:32:16 2021
From: roeeklinger60 at gmail.com (roee klinger)
Date: Tue, 28 Dec 2021 07:32:16 +0200
Subject: [squid-users] Logging in Squid external helpers in Docker?
Message-ID: <CAGCa14pboGDuL0Tmcs12fDEq_JsEN53UjzP8JXQcO1Zng5voVQ@mail.gmail.com>

Hey,

I am running Squid inside a Docker container, and I am using an external
helper, I am trying to get the logs from the external helper to go to
Docker logs (stdout).

Currently, I am writing the logs to a file, which works, but I would like
to get them to stdout instead, however, Squid redirects all the stdout from
the external helper to itself, which makes me unable to send the logs I
want to stdout.

Is there a way for me to send the logs I want to the main stdout of the
container and not to Squid itself?

I am using Python if that matters, but I can also test in Bash.

Thank,
Roee
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20211228/87dcf304/attachment.htm>

From squid3 at treenet.co.nz  Tue Dec 28 05:45:25 2021
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Tue, 28 Dec 2021 18:45:25 +1300
Subject: [squid-users] Logging in Squid external helpers in Docker?
In-Reply-To: <CAGCa14pboGDuL0Tmcs12fDEq_JsEN53UjzP8JXQcO1Zng5voVQ@mail.gmail.com>
References: <CAGCa14pboGDuL0Tmcs12fDEq_JsEN53UjzP8JXQcO1Zng5voVQ@mail.gmail.com>
Message-ID: <a888047a-810a-960f-9652-a75bc344ae47@treenet.co.nz>

On 28/12/21 18:32, roee klinger wrote:
> Hey,
> 
> I am running Squid inside a Docker container, and I am using an external 
> helper, I am trying to get the logs from the external helper to go to 
> Docker logs (stdout).
> 
> Currently, I am writing the logs to a file, which works, but I would 
> like to get them to stdout instead, however, Squid redirects all the 
> stdout from the external helper to itself, which makes me unable?to send 
> the logs I want to stdout.
> 
> Is there a way for me to send the logs I want to the main stdout of the 
> container and not to Squid itself?

stdout of the helper is the channel to respond to Squid requests. Do not 
send other information there.

Helper debug info etc should go to the helper stderr which Squid will 
deliver to cache.log.

Amos


From roeeklinger60 at gmail.com  Tue Dec 28 06:01:39 2021
From: roeeklinger60 at gmail.com (roee klinger)
Date: Tue, 28 Dec 2021 08:01:39 +0200
Subject: [squid-users] Logging in Squid external helpers in Docker?
In-Reply-To: <a888047a-810a-960f-9652-a75bc344ae47@treenet.co.nz>
References: <CAGCa14pboGDuL0Tmcs12fDEq_JsEN53UjzP8JXQcO1Zng5voVQ@mail.gmail.com>
 <a888047a-810a-960f-9652-a75bc344ae47@treenet.co.nz>
Message-ID: <CAGCa14rNuxSn57Qf7f38ZH_GGHMX0Kqm+GCVqQpJF_JU9hLaPg@mail.gmail.com>

>
> stdout of the helper is the channel to respond to Squid requests. Do not
> send other information there.


Helper debug info etc should go to the helper stderr which Squid will
> deliver to cache.log.


Thank you, Amos.

I am glad there is a built-in way to handle this.

However, I tried putting this inside the script:

> sys.stderr.write("test ################################################")


However, I still can not see the info in the cache log, these are my
configurations:

> cache_log stdio:/dev/stdout
> cache_store_log stdio:/dev/stdout


I even tried adding this, but still no luck:

> debug_options 82,9


I can see the rest of the cache log just fine, and stdout makes it to
its destination just fine as well.

Any idea what is wrong?

Thanks,
Roee

On Tue, Dec 28, 2021 at 7:46 AM Amos Jeffries <squid3 at treenet.co.nz> wrote:

> On 28/12/21 18:32, roee klinger wrote:
> > Hey,
> >
> > I am running Squid inside a Docker container, and I am using an external
> > helper, I am trying to get the logs from the external helper to go to
> > Docker logs (stdout).
> >
> > Currently, I am writing the logs to a file, which works, but I would
> > like to get them to stdout instead, however, Squid redirects all the
> > stdout from the external helper to itself, which makes me unable to send
> > the logs I want to stdout.
> >
> > Is there a way for me to send the logs I want to the main stdout of the
> > container and not to Squid itself?
>
> stdout of the helper is the channel to respond to Squid requests. Do not
> send other information there.
>
> Helper debug info etc should go to the helper stderr which Squid will
> deliver to cache.log.
>
> Amos
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20211228/d99ece94/attachment.htm>

From dm at belkam.com  Tue Dec 28 06:18:25 2021
From: dm at belkam.com (Dmitry Melekhov)
Date: Tue, 28 Dec 2021 10:18:25 +0400
Subject: [squid-users] squid 5.3 crash
Message-ID: <26670208-f4e1-1b9b-36cb-38ad577544fa@belkam.com>

Hello!


Testing squid 5.3 on Ubuntu 20.04.

Looks good for several weeks , but just got this:


2021/12/28 09:58:01 kid1| assertion failed: Read.cc:61: 
"Comm::IsConnOpen(conn)"
 ??? current master transaction: master28713185


After this squid ate almost 100% of cpu, then crashed, unfortunately gdb 
says core dump is truncated:

/var/crash/squid-dump/CoreDump is truncated: expected core file size >= 
303022080, found: 177070080


Is this assertion fail known problem?


Thank you!




From squid3 at treenet.co.nz  Tue Dec 28 06:18:06 2021
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Tue, 28 Dec 2021 19:18:06 +1300
Subject: [squid-users] Logging in Squid external helpers in Docker?
In-Reply-To: <CAGCa14rNuxSn57Qf7f38ZH_GGHMX0Kqm+GCVqQpJF_JU9hLaPg@mail.gmail.com>
References: <CAGCa14pboGDuL0Tmcs12fDEq_JsEN53UjzP8JXQcO1Zng5voVQ@mail.gmail.com>
 <a888047a-810a-960f-9652-a75bc344ae47@treenet.co.nz>
 <CAGCa14rNuxSn57Qf7f38ZH_GGHMX0Kqm+GCVqQpJF_JU9hLaPg@mail.gmail.com>
Message-ID: <d4588da6-5220-e730-cf8f-8aef5d455481@treenet.co.nz>

On 28/12/21 19:01, roee klinger wrote:
>     stdout of the helper is the channel to respond to Squid requests. Do not
>     send other information there.
> 
> 
>     Helper debug info etc should go to the helper stderr which Squid will
>     deliver to cache.log.
> 
> 
> Thank you, Amos.
> 
> I am glad there is a built-in way to handle this.
> 
> However, I tried putting this inside the script:
> 
>     sys.stderr.write("test
>     ################################################")
> 
> 
> However, I still can not?see the info in the cache log, these are my 
> configurations:
> 
>     cache_log stdio:/dev/stdout
>     cache_store_log stdio:/dev/stdout
> 

NP: make sure you have log rotation set to 0 when doing this.


> 
> I even tried adding this, but still no luck:
> 
>     debug_options 82,9
> 
> 
> I can see the rest of the cache log just fine, and stdout makes it to 
> its?destination just fine as well.
> 
> Any idea what is wrong?
> 

Not for certain, works fine for me.

I/O behaviours like default buffering have caused issues with some 
helper implementation languages. So that is where I would be looking now 
to find out.

Amos


From rousskov at measurement-factory.com  Tue Dec 28 15:50:27 2021
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Tue, 28 Dec 2021 10:50:27 -0500
Subject: [squid-users] squid 5.3 crash
In-Reply-To: <26670208-f4e1-1b9b-36cb-38ad577544fa@belkam.com>
References: <26670208-f4e1-1b9b-36cb-38ad577544fa@belkam.com>
Message-ID: <47bb6da4-b165-762a-c3de-358d54217624@measurement-factory.com>

On 12/28/21 1:18 AM, Dmitry Melekhov wrote:

> Testing squid 5.3 on Ubuntu 20.04.

> 2021/12/28 09:58:01 kid1| assertion failed: Read.cc:61: "Comm::IsConnOpen(conn)"

> Is this assertion fail known problem?

Impossible to say for sure without a stack trace, unfortunately -- many
different code paths lead to that low level assertion -- but this could
be bug #5056 or a related problem, as triaged at:

https://bugs.squid-cache.org/show_bug.cgi?id=5056#c1


HTH,

Alex.


From rousskov at measurement-factory.com  Tue Dec 28 17:06:06 2021
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Tue, 28 Dec 2021 12:06:06 -0500
Subject: [squid-users] Logging in Squid external helpers in Docker?
In-Reply-To: <CAGCa14pboGDuL0Tmcs12fDEq_JsEN53UjzP8JXQcO1Zng5voVQ@mail.gmail.com>
References: <CAGCa14pboGDuL0Tmcs12fDEq_JsEN53UjzP8JXQcO1Zng5voVQ@mail.gmail.com>
Message-ID: <c01aec42-b42a-2d46-79bc-ed17f689600a@measurement-factory.com>

On 12/28/21 12:32 AM, roee klinger wrote:
> I am running Squid inside a Docker container, and I am using an external
> helper, I am trying to get the logs from the external helper to go to
> Docker logs (stdout).
> 
> Currently, I am writing the logs to a file, which works, but I would
> like to get them to stdout instead, however, Squid redirects all the
> stdout from the external helper to itself, which makes me unable?to send
> the logs I want to stdout.
> 
> Is there a way for me to send the logs I want to the main stdout of the
> container and not to Squid itself?

> sys.stderr.write("test ################################################")

According to [0], Python line-buffers stderr output. Try adding a new
line to the message.

[0]
https://adamj.eu/tech/2020/06/26/how-to-check-if-pythons-output-buffering-is-enabled/

----

The rest probably does not apply to your docker, but I will record it
here in case somebody else finds it useful...

> cache_log stdio:/dev/stdout

The above trick does not work in many environments. In basic
command-line tests, I get[1,2]:

> squid.strace.2072945:openat(AT_FDCWD, "/dev/stdout",
> O_RDWR|O_CREAT|O_APPEND, 0666) = -1 EACCES (Permission denied)

> WARNING: Cannot write log file: stdio:/dev/stdout
> stdio:/dev/stdout: Permission denied
>          messages will be sent to 'stderr'.

After that, the helper stderr output will not show up on Squid _stdout_:
Since Squid processes are using stderr instead of stdout for cache_log,
the helper stderr output is being sent to the (duped) Squid stderr file
descriptor rather than a (duped) Squid stdout descriptor.

There are other subtle problems with that /dev/stdout trick. It is
essentially unsupported.


HTH,

Alex.

[1] Same problem without the "stdio:" prefix. The presence of that
prefix in the WARNING message is misleading: Even with that prefix,
Squid actually tries to open "/dev/stdout", of course.

[2] Squid cannot open /dev/stdout in many environments because that pipe
often belongs to the user starting Squid rather than the user Squid runs
as:
https://unix.stackexchange.com/questions/38538/bash-dev-stderr-permission-denied/38580


