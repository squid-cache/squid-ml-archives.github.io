<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] deny squid to bump deny_info
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20deny%20squid%20to%20bump%20deny_info&In-Reply-To=%3C%21%26%21AAAAAAAAAAAuAAAAAAAAAJJD97gEMN5Ch2HBNn/5W3IBAMO2jhD3dRHOtM0AqgC7tuYAAAAAAA4AABAAAAC9RiWUcHCrQb7c2n%2BRZsgSAQAAAAA%3D%40articatech.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="024322.html">
   <LINK REL="Next"  HREF="024324.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] deny squid to bump deny_info</H1>
    <B>Andr&#233; Bolinhas</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20deny%20squid%20to%20bump%20deny_info&In-Reply-To=%3C%21%26%21AAAAAAAAAAAuAAAAAAAAAJJD97gEMN5Ch2HBNn/5W3IBAMO2jhD3dRHOtM0AqgC7tuYAAAAAAA4AABAAAAC9RiWUcHCrQb7c2n%2BRZsgSAQAAAAA%3D%40articatech.com%3E"
       TITLE="[squid-users] deny squid to bump deny_info">andre.bolinhas at articatech.com
       </A><BR>
    <I>Wed Dec  8 15:40:03 UTC 2021</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="024322.html">[squid-users] deny squid to bump deny_info
</A></li>
        <LI>Next message (by thread): <A HREF="024324.html">[squid-users] deny squid to bump deny_info
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24323">[ date ]</a>
              <a href="thread.html#24323">[ thread ]</a>
              <a href="subject.html#24323">[ subject ]</a>
              <a href="author.html#24323">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Thanks for the quick reply, where I need to add the ssl_bump terminate rule? Inside ssl.conf or http_access.conf?
I have tried in both both but continues to bump the error page.
Also tried ssl_bump terminate all in the top of both files and always bump ther error_page.

This is my current files:
http_access.conf
#### tcp_outgoing_tos ####
#### tcp_outgoing_tos 0 Rules ####
# webfilters_sqacls HaClusterClient=0 2 rules [202] [class.squid.acls.groups.inc]
# webfilters_sqacls #10 : aclport=0 (  ) [212] [class.squid.acls.groups.inc]
# [L.268]: rule id: 10 access_allow Port Direction=0 ()
# [L.303]: class.squid.acls.groups.inc buildacls_bytype_items(10,..)
http_access allow Group17
# webfilters_sqacls #5 : aclport=0 (  ) [212] [class.squid.acls.groups.inc]
# [L.268]: rule id: 5 access_deny Port Direction=0 ()
# [L.303]: class.squid.acls.groups.inc buildacls_bytype_items(5,..)
# Template Enabled for this ACL.
# Final acl is all, Template ID=1
deny_info TEMPLATE_5 all
http_access deny all
#
#
# ------------------ HTTP ACCESS --------------------
# 0 rule(s) from engine (Line 2170)


# SquidStandardLDAPAuth = 0
# EnableOpenLDAP = 0
# SquidRadiusAuth = 0
# LDAP_AUTH = 0 caused by EnableOpenLDAP
acl MyBlockedIPs src &quot;/etc/squid3/acls/DenyIPSrc&quot;
http_access allow WindowsUpdates

# LDAP Auth = 0
http_access deny HTTP !Safe_ports all
http_access deny CONNECT !SSL_ports all
http_access deny MyBlockedIPs
http_access deny blockedsites
http_access deny DomainsBlackLists
http_access deny NetworksBlackLists
include /etc/squid3/http_access_final.conf
# END http_access (defaults)

# Allow all networks to finally pass trough proxy.
http_access allow all

ssl.conf
# SSL used for port ID 1, :3128 on
# Patch 2020 - 08 - 03 SquidMikrotikEnabled = 0
# SSL Proxy options  Proxy version:5.2 [134]
sslcrtd_program /lib/squid3/security_file_certgen -s /var/lib/squid/session/ssl/ssl_db -M 32MB
sslcrtd_children 32 startup=5 idle=1 queue-size=64
#The AppStore application in IOS (iPhone, iPad, MacOS) uses SSL Certificate Pinning,
#it means the application knows what certificate to expect when accessing AppStore.
#When you enable SSL Bump of HTTPS connections Squid replaces the default certificate with a  ^`^xmimicked ^`^y one;
#the application detects that and refuses to function.
#
acl FakeCert ssl::server_name .apple.com
acl FakeCert ssl::server_name .icloud.com
acl FakeCert ssl::server_name .mzstatic.com
acl FakeCert ssl::server_name .dropbox.com
acl FakeCert ssl::server_name .bnpparisbas
acl ssl_step1 at_step SslBump1
acl ssl_step2 at_step SslBump2
acl ssl_step3 at_step SslBump3
ssl_bump peek ssl_step1
ssl_bump splice GlobalWhitelistDSTNet
ssl_bump splice GlobalWhitelistDomainsRx
ssl_bump splice GlobalWhitelistDomains
ssl_bump splice FakeCert

# SNI Group google_sni/ssl_sni
# id:16 Type: ssl_sni
acl SNIGroup16 ssl::server_name_regex -i accounts\.google\.com

# 0 Splice rules...
acl KeepSSL ssl::server_name &quot;/etc/squid3/acls_whitelist.dstdomain.conf&quot;
ssl_bump splice KeepSSL
ssl_bump splice GlobalWhitelistDSTNet

# Rules (spliced) added by admins....

# 1 BUMP rules...
#ssl_bump stare all
ssl_bump bump ssl_step2 SNIGroup16
ssl_bump splice all

tls_outgoing_options options=NO_SSLv3,NO_TICKET cipher=ALL:!SSLv2:!SSLv3:!ADH:!DSS:!MD5:!EXP:!DES:!PSK:!SRP:!RC4:!IDEA:!SEED:!aNULL:!eNULL flags=DONT_VERIFY_PEER
sslproxy_cert_error allow all
on_unsupported_protocol tunnel all


-----Mensagem original-----
De: Alex Rousskov &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt; 
Enviada: 8 de dezembro de 2021 15:13
Para: Andr&#233; Bolinhas &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">andre.bolinhas at articatech.com</A>&gt;; <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
Assunto: Re: [squid-users] deny squid to bump deny_info

On 12/7/21 8:39 PM, Andr&#233; Bolinhas wrote:

&gt;<i> We use Squid v5 with ssl_bump to decrypt only google domains. With a 
</I>&gt;<i> special configuration we also need to deny important websites. Squid 
</I>&gt;<i> tries to bump returned error pages
</I>
Yes, when SslBump encounters an error, it tries to bump the client connection to deliver the error response.

One way to prevent that error handling algorithm from kicking in is to close the offending client connection using an &quot;ssl_bump terminate&quot; rule (instead[1] of blocking client access using &quot;http_access&quot;).


&gt;<i> We have tried using a TCP_RESET deny_info but this does not fix the 
</I>&gt;<i> bump operation
</I>
I suspect the TCP_RESET feature is checked at error delivery time, after the client connection is bumped to prepare it for error delivery. This suspect behavior should be considered a Squid bug/deficiency IMO -- Squid should not be bumping the TLS connection to deliver a TCP RST or FIN packet.

HTH,

Alex.
[1] It may be a good idea to also/still block client access using http_access rules, as an additional safety layer, but it has to be done carefully so that &quot;ssl_bump terminate&quot; rule matches _before_ any of the corresponding &quot;http_access deny&quot; rules may match.



&gt;<i> In this peace of log, you can see that squid is forcing bump for 
</I>&gt;<i> Access Denied website under https:
</I>&gt;<i> 2021/12/08 05:05:53.774 kid2| 85,5| client_side_request.cc(769)
</I>&gt;<i> clientAccessCheckDone: Access Denied: beacons2.gvt2.com:443
</I>&gt;<i> 2021/12/08 05:05:53.774 kid2| 85,5| client_side_request.cc(770)
</I>&gt;<i> clientAccessCheckDone: AclMatchedName = all
</I>&gt;<i> 2021/12/08 05:05:53.774 kid2| 83,7| LogTags.cc(57) update: TAG_NONE to 
</I>&gt;<i> TCP_DENIED
</I>&gt;<i> 2021/12/08 05:05:53.774 kid2| 28,4| FilledChecklist.cc(67)
</I>&gt;<i> ~ACLFilledChecklist: ACLFilledChecklist destroyed 0x7ffc945c5b40
</I>&gt;<i> 2021/12/08 05:05:53.774 kid2| 28,4| Checklist.cc(197) ~ACLChecklist:
</I>&gt;<i> ACLChecklist::~ACLChecklist: destroyed 0x7ffc945c5b40
</I>&gt;<i> 2021/12/08 05:05:53.774 kid2| 85,5| client_side_request.cc(1461)
</I>&gt;<i> sslBumpAccessCheck: SslBump applies. Force bump action on error 
</I>&gt;<i> UNKNOWN
</I>&gt;<i> 2021/12/08 05:05:53.774 kid2| 83,3| client_side_request.cc(1562)
</I>&gt;<i> sslBumpNeed: sslBump required: bump
</I>&gt;<i> 2021/12/08 05:05:53.774 kid2| 73,3| HttpRequest.cc(683) storeId: sent 
</I>&gt;<i> back
</I>&gt;<i> effectiveRequestUrl: beacons2.gvt2.com:443
</I>&gt;<i> 2021/12/08 05:05:53.774 kid2| 24,7| SBuf.cc(160) rawSpace: reserving 1 
</I>&gt;<i> for
</I>&gt;<i> SBuf77493929
</I>&gt;<i> 2021/12/08 05:05:53.774 kid2| 24,7| SBuf.cc(866) reAlloc: SBuf77493929 
</I>&gt;<i> new store capacity: 40
</I>&gt;<i> 2021/12/08 05:05:53.774 kid2| 20,3| store.cc(769) storeCreatePureEntry:
</I>&gt;<i> storeCreateEntry: 'beacons2.gvt2.com:443'
</I>&gt;<i> 2021/12/08 05:05:53.774 kid2| 20,5| store.cc(349) StoreEntry: 
</I>&gt;<i> StoreEntry constructed, this=0x5561d9347e90
</I>&gt;<i> 2021/12/08 05:05:53.774 kid2| 20,3| MemObject.cc(100) MemObject: 
</I>&gt;<i> MemObject constructed, this=0x5561d5e66f50
</I>&gt;<i> 2021/12/08 05:05:53.774 kid2| 55,7| HttpHeader.cc(155) HttpHeader: 
</I>&gt;<i> init-ing
</I>&gt;<i> hdr: 0x5561d80af128 owner: 3
</I>&gt;<i> 2021/12/08 05:05:53.774 kid2| 88,3| MemObject.cc(83) setUris: 
</I>&gt;<i> 0x5561d5e66f50
</I>&gt;<i> storeId: beacons2.gvt2.com:443
</I>&gt;<i> 2021/12/08 05:05:53.774 kid2| 24,7| SBuf.cc(85) assign: assigning
</I>&gt;<i> SBuf77493930 from SBuf77493860
</I>&gt;<i> 2021/12/08 05:05:53.774 kid2| 20,3| store.cc(443) lock: 
</I>&gt;<i> storeCreateEntry locked key [null_store_key] e:=V/0x5561d9347e90*1
</I>&gt;<i> 2021/12/08 05:05:53.774 kid2| 20,3| store.cc(569) setPrivateKey: 01
</I>&gt;<i> e:=V/0x5561d9347e90*1
</I>&gt;<i> 2021/12/08 05:05:53.774 kid2| 20,3| store.cc(421) hashInsert:
</I>&gt;<i> StoreEntry::hashInsert: Inserting Entry e:=XIV/0x5561d9347e90*1 key 
</I>&gt;<i> '71570400000000002412000002000000'
</I>&gt;<i> 2021/12/08 05:05:53.774 kid2| 83,3| client_side_request.cc(1562)
</I>&gt;<i> sslBumpNeed: sslBump required: client-first
</I>&gt;<i> 2021/12/08 05:05:53.774 kid2| 33,4| ServerBump.cc(28) ServerBump: will 
</I>&gt;<i> peek at beacons2.gvt2.com:443
</I>&gt;<i> 2021/12/08 05:05:53.774 kid2| 20,3| store.cc(443) lock: 
</I>&gt;<i> Ssl::ServerBump locked key 71570400000000002412000002000000 
</I>&gt;<i> e:=XIV/0x5561d9347e90*2
</I>&gt;<i> 2021/12/08 05:05:53.774 kid2| 4,4| errorpage.cc(720) errorAppendEntry:
</I>&gt;<i> storing TEMPLATE_5 in e:=XIV/0x5561d9347e90*2
</I>&gt;<i> 2021/12/08 05:05:53.774 kid2| 55,7| HttpHeader.cc(155) HttpHeader: 
</I>&gt;<i> init-ing
</I>&gt;<i> hdr: 0x5561d66a8078 owner: 3
</I>&gt;<i> 2021/12/08 05:05:53.774 kid2| 4,2| errorpage.cc(1389) buildBody: No 
</I>&gt;<i> existing error page language negotiated for TEMPLATE_5. Using default error file.
</I>&gt;<i> 
</I>&gt;<i> Ssl.conf
</I>&gt;<i> # SSL used for port ID 1, :3128 on
</I>&gt;<i> # Patch 2020 - 08 - 03 SquidMikrotikEnabled = 0 # SSL Proxy options  
</I>&gt;<i> Proxy
</I>&gt;<i> version:5.2 [134] sslcrtd_program /lib/squid3/security_file_certgen 
</I>&gt;<i> sslcrtd_children 32 startup=5 idle=1 queue-size=64 #The AppStore 
</I>&gt;<i> application in IOS (iPhone, iPad, MacOS) uses SSL Certificate Pinning, 
</I>&gt;<i> #it means the application knows what certificate to expect when accessing AppStore.
</I>&gt;<i> #When you enable SSL Bump of HTTPS connections Squid replaces the 
</I>&gt;<i> default certificate with a  ^`^xmimicked ^`^y one;
</I>&gt;<i> 
</I>&gt;<i> #the application detects that and refuses to function.
</I>&gt;<i> #
</I>&gt;<i> acl FakeCert ssl::server_name .apple.com acl FakeCert ssl::server_name 
</I>&gt;<i> .icloud.com acl FakeCert ssl::server_name .mzstatic.com acl FakeCert 
</I>&gt;<i> ssl::server_name .dropbox.com acl FakeCert ssl::server_name 
</I>&gt;<i> .bnpparisbas acl notbump ssl::server_name .redtube.com acl ssl_step1 
</I>&gt;<i> at_step SslBump1 acl
</I>&gt;<i> ssl_step2 at_step SslBump2 acl ssl_step3 at_step SslBump3
</I>&gt;<i> 
</I>&gt;<i> acl Me dst 127.0.0.1 192.168.58.11
</I>&gt;<i> acl GlobalWhitelistDSTNet dst &quot;/etc/squid3/acls_whitelist.dst.conf&quot;
</I>&gt;<i> 
</I>&gt;<i> ssl_bump splice notbump all
</I>&gt;<i> ssl_bump splice GlobalWhitelistDSTNet
</I>&gt;<i> 
</I>&gt;<i> ssl_bump splice ssl_step1 Me
</I>&gt;<i> ssl_bump splice ByPassRBL
</I>&gt;<i> ssl_bump splice FakeCert
</I>&gt;<i> 
</I>&gt;<i> # SNI Group sni_domains/ssl_sni
</I>&gt;<i> # id:7 Type: ssl_sni
</I>&gt;<i> acl SNIGroup7 ssl::server_name_regex -i account\.google\.com acl 
</I>&gt;<i> SNIGroup7 ssl::server_name_regex -i accounts\.google\.com ssl_bump 
</I>&gt;<i> peek ssl_step1 all # 0 Splice rules...
</I>&gt;<i> ssl_bump splice ByPassRBL
</I>&gt;<i> ssl_bump splice GlobalWhitelistDSTNet
</I>&gt;<i> 
</I>&gt;<i> # Rules (spliced) added by admins....
</I>&gt;<i> 
</I>&gt;<i> # 1 BUMP rules...
</I>&gt;<i> ssl_bump bump ssl_step2 SNIGroup7
</I>&gt;<i> ssl_bump splice all
</I>&gt;<i> 
</I>&gt;<i> tls_outgoing_options options=NO_SSLv3,NO_TICKET 
</I>&gt;<i> cipher=ALL:!SSLv2:!SSLv3:!ADH:!DSS:!MD5:!EXP:!DES:!PSK:!SRP:!RC4:!IDEA
</I>&gt;<i> :!SEED :!aNULL:!eNULL flags=DONT_VERIFY_PEER sslproxy_cert_error allow 
</I>&gt;<i> all
</I>&gt;<i> 
</I>&gt;<i> http_access.conf
</I>&gt;<i> #### tcp_outgoing_tos ####
</I>&gt;<i> #### tcp_outgoing_tos 0 Rules ####
</I>&gt;<i> # SquidUrgency = 0 exec.squid.global.access.php[2233]
</I>&gt;<i> #       HaClusterClient=0 class.squid.acls.groups.inc/buildacls_order
</I>&gt;<i> #       mysql_for_port='' aclgpid=0 [L.174]
</I>&gt;<i> #       [3] rules [220]
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> # webfilters_sqacls #2 : aclport=0 (  ) [239] 
</I>&gt;<i> [class.squid.acls.groups.inc] # [L.292]: rule id: 2 access_allow Port Direction=0 () # [L.320]:
</I>&gt;<i> class.squid.acls.groups.inc buildacls_bytype_items(2,..) acl 
</I>&gt;<i> AnnotateRule2 annotate_transaction accessrule=Rule2 http_access allow 
</I>&gt;<i> Group2 AnnotateRule2 # webfilters_sqacls #4 : aclport=0 (  ) [239] 
</I>&gt;<i> [class.squid.acls.groups.inc] # [L.292]: rule id: 4 access_allow Port Direction=0 () # [L.320]:
</I>&gt;<i> class.squid.acls.groups.inc buildacls_bytype_items(4,..) acl 
</I>&gt;<i> AnnotateRule4 annotate_transaction accessrule=Rule4 http_access allow 
</I>&gt;<i> Group8 AnnotateRule4 # webfilters_sqacls #3 : aclport=0 (  ) [239] 
</I>&gt;<i> [class.squid.acls.groups.inc] # [L.292]: rule id: 3 access_deny Port Direction=0 () # [L.320]:
</I>&gt;<i> class.squid.acls.groups.inc buildacls_bytype_items(3,..) # Template 
</I>&gt;<i> Enabled for this ACL.
</I>&gt;<i> # Final acl is all, Template ID=1
</I>&gt;<i> acl AnnotateRule3 annotate_transaction accessrule=Rule3 http_access 
</I>&gt;<i> deny CONNECT  AnnotateRule3 deny_info TCP_RESET AnnotateRule3
</I>&gt;<i> 
</I>&gt;<i> acl MyAll dst 0.0.0.0/0
</I>&gt;<i> http_access deny Myall
</I>&gt;<i> deny_info 302:<A HREF="http://artica/me">http://artica/me</A> Myall
</I>&gt;<i> #
</I>&gt;<i> #
</I>&gt;<i> # ------------------ HTTP ACCESS -------------------- # 0 rule(s) from 
</I>&gt;<i> engine (Line 2240)
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> #
</I>&gt;<i> # SquidStandardLDAPAuth = 0
</I>&gt;<i> # EnableOpenLDAP = 0
</I>&gt;<i> # SquidRadiusAuth = 0
</I>&gt;<i> # LDAP_AUTH = 0 caused by EnableOpenLDAP acl MyBlockedIPs src 
</I>&gt;<i> &quot;/etc/squid3/acls/DenyIPSrc&quot;
</I>&gt;<i> acl AnnotateWindowsUpdates annotate_transaction 
</I>&gt;<i> accessrule=AllowWindowsUpdates http_access allow WindowsUpdates 
</I>&gt;<i> AnnotateWindowsUpdates # # -------------------- AUTH Schemes Squid
</I>&gt;<i> v5.2-----------------------
</I>&gt;<i> 
</I>&gt;<i> # ----------------------------------------------------------
</I>&gt;<i> 
</I>&gt;<i> # LDAP Auth = 0
</I>&gt;<i> acl AnnotateSafePorts annotate_transaction 
</I>&gt;<i> accessrule=deny_remote_ports http_access deny HTTP !Safe_ports all  
</I>&gt;<i> AnnotateSafePorts http_access deny CONNECT !SSL_ports all  
</I>&gt;<i> AnnotateSafePorts deny_info TCP_RESET all
</I>&gt;<i> 
</I>&gt;<i> acl AnnotateBLK annotate_transaction accessrule=global_blacklist 
</I>&gt;<i> http_access deny MyBlockedIPs AnnotateBLK http_access deny 
</I>&gt;<i> blockedsites AnnotateBLK http_access deny DomainsBlackLists 
</I>&gt;<i> AnnotateBLK http_access deny NetworksBlackLists AnnotateBLK include 
</I>&gt;<i> /etc/squid3/http_access_final.conf
</I>&gt;<i> # END http_access (defaults)
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i> 
</I>


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="024322.html">[squid-users] deny squid to bump deny_info
</A></li>
	<LI>Next message (by thread): <A HREF="024324.html">[squid-users] deny squid to bump deny_info
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24323">[ date ]</a>
              <a href="thread.html#24323">[ thread ]</a>
              <a href="subject.html#24323">[ subject ]</a>
              <a href="author.html#24323">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
