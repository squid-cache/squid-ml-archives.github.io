<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] missing response body with https requests
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20missing%20response%20body%20with%20https%20requests&In-Reply-To=%3C2804eae6-c35f-65a7-4577-07a958230380%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="024325.html">
   <LINK REL="Next"  HREF="024331.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] missing response body with https requests</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20missing%20response%20body%20with%20https%20requests&In-Reply-To=%3C2804eae6-c35f-65a7-4577-07a958230380%40measurement-factory.com%3E"
       TITLE="[squid-users] missing response body with https requests">rousskov at measurement-factory.com
       </A><BR>
    <I>Thu Dec  9 14:51:56 UTC 2021</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="024325.html">[squid-users] missing response body with https requests
</A></li>
        <LI>Next message (by thread): <A HREF="024331.html">[squid-users] IPcache and mixed case domain names
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24326">[ date ]</a>
              <a href="thread.html#24326">[ thread ]</a>
              <a href="subject.html#24326">[ subject ]</a>
              <a href="author.html#24326">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 12/9/21 8:18 AM, Mateusz &#321;o&#347; wrote:

&gt;<i> While connecting to https site through parent proxy we can see 407
</I>&gt;<i> response with Content-Length header but with empty body content which
</I>&gt;<i> causes applications to fail as they are trying to read that body
</I>
Squid does not yet have the code to support multi-step HTTP CONNECT
authentication with parent proxies. Your options for going forward may
include:

A1) Adjust the parent proxy configuration so that it does not respond
with HTTP 407 Proxy Authentication Required responses to the child
CONNECT requests.

A2) Adjust the child proxy configuration so that the parent proxy does
not respond with HTTP 407 Proxy Authentication Required responses to the
child.

B) Adjust the child proxy configuration so that it goes direct (rather
than through the parent proxy) when tunneling TLS connections.

C) Add proper support for multi-step HTTP CONNECT authentication to
Squid. It is a difficult/serious project that would require significant
code refactoring, but it can (and should) be done:
<A HREF="https://wiki.squid-cache.org/SquidFaq/AboutSquid#How_to_add_a_new_Squid_feature.2C_enhance.2C_of_fix_something.3F">https://wiki.squid-cache.org/SquidFaq/AboutSquid#How_to_add_a_new_Squid_feature.2C_enhance.2C_of_fix_something.3F</A>

Options A1 and A2 may need to be combined for the desired effect.

I do not know enough about your environment to say which of the above
options are viable/applicable, and cannot recommend specific
configuration adjustments (but others on this list may be able to help
with that).


HTH,

Alex.
P.S. Squid also does not have the code to read (large) CONNECT error
response bodies, but that is not the root cause of your problems. Even
if Squid could read the entire HTTP 407 response body in this case, it
would not help.


&gt;<i> lHttpAsyncClient [exchange: 71] connection aborted||The problematic lines are:|...|Consume content|-1 bytes read
</I>&gt;<i> 
</I>&gt;<i> with squid 5 I can see missing body in logs
</I>&gt;<i> 
</I>&gt;<i> 2021/10/26 07:17:32.684 kid1| 11,2| src/clients/HttpTunneler.cc(324) handleResponse: Tunnel Server RESPONSE:
</I>&gt;<i> ---------
</I>&gt;<i> &lt;HTML&gt;&lt;HEAD&gt;
</I>&gt;<i> 
</I>&gt;<i> &lt;TITLE&gt;Access Denied&lt;/TITLE&gt;
</I>&gt;<i> 
</I>&gt;<i> &lt;STYLE TYPE=&quot;text/css&quot;&gt;
</I>&gt;<i> 
</I>&gt;<i> 	TABLE.DETAILS TD{
</I>&gt;<i> 
</I>&gt;<i> 	  font-family: Helvetica;
</I>&gt;<i> 
</I>&gt;<i> 	  font-size: 9pt;
</I>&gt;<i> 
</I>&gt;<i> 	}
</I>&gt;<i> 
</I>&gt;<i> &lt;/STYLE&gt;
</I>&gt;<i> 
</I>&gt;<i> &lt;/HEAD&gt;
</I>&gt;<i> 
</I>&gt;<i> &lt;BODY&gt;
</I>&gt;<i> 
</I>&gt;<i> &lt;FONT face=&quot;Helvetica&quot;&gt;
</I>&gt;<i> 
</I>&gt;<i> &lt;big&gt;&lt;strong&gt;&lt;/strong&gt;&lt;/big&gt;&lt;BR&gt;
</I>&gt;<i> 
</I>&gt;<i> &lt;/FON----------
</I>&gt;<i> 2021/10/26 07:17:32.684 kid1| TCP connection to &lt;parent_proxy_ip&gt;/8080
</I>&gt;<i> failed
</I>&gt;<i> &#160; &#160; current master transaction: master95
</I>&gt;<i> 2021/10/26 07:17:32.684 kid1| Detected DEAD Parent: &lt;parent_proxy_ip&gt;
</I>&gt;<i> &#160; &#160; current master transaction: master95
</I>&gt;<i> 
</I>&gt;<i> Parent proxy configuration:
</I>&gt;<i> cache_peer myparentproxy_ipaddress parent 8080 0 no-query no-digest
</I>&gt;<i> no-netdb-exchange login=PASSTHRU
</I>&gt;<i> 
</I>&gt;<i> While connecting through parent proxy directly there is no issue and
</I>&gt;<i> response can be parsed properly.
</I>&gt;<i> 
</I>&gt;<i> I was unable to find configuration options to change this, while
</I>&gt;<i> connecting to http site there is no such issue and body is being send
</I>&gt;<i> properly with 407 answer.
</I>&gt;<i> 
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at testvm</A>:~# curl -x 192.168.3.19:3128 <A HREF="https://webhook.site">https://webhook.site</A>
</I>&gt;<i> &lt;<A HREF="https://webhook.site">https://webhook.site</A>&gt; -Lv
</I>&gt;<i> * &#160; Trying 192.168.3.19:3128...
</I>&gt;<i> * TCP_NODELAY set
</I>&gt;<i> * Connected to 192.168.3.19 (192.168.3.19) port 3128 (#0)
</I>&gt;<i> * allocate connect buffer!
</I>&gt;<i> * Establish HTTP proxy tunnel to webhook.site:443 &lt;<A HREF="http://webhook.site:443">http://webhook.site:443</A>&gt;
</I>&gt;&gt;<i> CONNECT webhook.site:443 &lt;<A HREF="http://webhook.site:443">http://webhook.site:443</A>&gt; HTTP/1.1
</I>&gt;&gt;<i> Host: webhook.site:443 &lt;<A HREF="http://webhook.site:443">http://webhook.site:443</A>&gt;
</I>&gt;&gt;<i> User-Agent: curl/7.68.0
</I>&gt;&gt;<i> Proxy-Connection: Keep-Alive
</I>&gt;&gt;<i>
</I>&gt;<i> &lt; HTTP/1.1 407 Proxy Authentication Required
</I>&gt;<i> &lt; Proxy-Authenticate: BASIC realm=&quot;LDAP&quot;
</I>&gt;<i> &lt; Cache-Control: no-cache
</I>&gt;<i> &lt; Pragma: no-cache
</I>&gt;<i> &lt; X-XSS-Protection: 1
</I>&gt;<i> &lt; Content-Type: text/html; charset=utf-8
</I>&gt;<i> &lt; Proxy-Connection: close
</I>&gt;<i> &lt; Connection: close
</I>&gt;<i> &lt; Content-Length: 1590
</I>&gt;<i> &lt;
</I>&gt;<i> * Ignore 1590 bytes of response-body
</I>&gt;<i> * Proxy CONNECT connection closed
</I>&gt;<i> * Closing connection 9
</I>&gt;<i> * Hostname 192.168.3.19 was found in DNS cache
</I>&gt;<i> * &#160; Trying 192.168.3.19:3128...
</I>&gt;<i> * TCP_NODELAY set
</I>&gt;<i> * Connected to 192.168.3.19 (192.168.3.19) port 3128 (#10)
</I>&gt;<i> * allocate connect buffer!
</I>&gt;<i> * Establish HTTP proxy tunnel to webhook.site:443 &lt;<A HREF="http://webhook.site:443">http://webhook.site:443</A>&gt;
</I>&gt;&gt;<i> CONNECT webhook.site:443 &lt;<A HREF="http://webhook.site:443">http://webhook.site:443</A>&gt; HTTP/1.1
</I>&gt;&gt;<i> Host: webhook.site:443 &lt;<A HREF="http://webhook.site:443">http://webhook.site:443</A>&gt;
</I>&gt;&gt;<i> User-Agent: curl/7.68.0
</I>&gt;&gt;<i> Proxy-Connection: Keep-Alive
</I>&gt;&gt;<i>
</I>&gt;<i> &lt; HTTP/1.1 500 Internal Server Error
</I>&gt;<i> &lt; Server: squid/5.2-VCS
</I>&gt;<i> &lt; Mime-Version: 1.0
</I>&gt;<i> &lt; Date: Tue, 26 Oct 2021 07:17:32 GMT
</I>&gt;<i> &lt; Content-Type: text/html;charset=utf-8
</I>&gt;<i> &lt; Content-Length: 3814
</I>&gt;<i> &lt; X-Squid-Error: ERR_CANNOT_FORWARD 0
</I>&gt;<i> &lt; Content-Language: en
</I>&gt;<i> &lt;
</I>&gt;<i> * Received HTTP code 500 from proxy after CONNECT
</I>&gt;<i> * CONNECT phase completed!
</I>&gt;<i> * Closing connection 10
</I>&gt;<i> curl: (56) Received HTTP code 500 from proxy after CONNECT
</I>&gt;<i> 
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at testvm</A>:~# curl -x 192.168.3.19:3128 <A HREF="http://webhook.site">http://webhook.site</A>
</I>&gt;<i> &lt;<A HREF="http://webhook.site">http://webhook.site</A>&gt; -Lv
</I>&gt;<i> * &#160; Trying 192.168.3.19:3128...
</I>&gt;<i> * TCP_NODELAY set
</I>&gt;<i> * Connected to 192.168.3.19 (192.168.3.19) port 3128 (#0)
</I>&gt;&gt;<i> GET <A HREF="http://webhook.site/">http://webhook.site/</A> &lt;<A HREF="http://webhook.site/">http://webhook.site/</A>&gt; HTTP/1.1
</I>&gt;&gt;<i> Host: webhook.site &lt;<A HREF="http://webhook.site">http://webhook.site</A>&gt;
</I>&gt;&gt;<i> User-Agent: curl/7.68.0
</I>&gt;&gt;<i> Accept: */*
</I>&gt;&gt;<i> Proxy-Connection: Keep-Alive
</I>&gt;&gt;<i>
</I>&gt;<i> * Mark bundle as not supporting multiuse
</I>&gt;<i> &lt; HTTP/1.1 407 Proxy Authentication Required
</I>&gt;<i> &lt; Proxy-Authenticate: BASIC realm=&quot;LDAP&quot;
</I>&gt;<i> &lt; Cache-Control: no-cache
</I>&gt;<i> &lt; Pragma: no-cache
</I>&gt;<i> &lt; X-XSS-Protection: 1
</I>&gt;<i> &lt; Content-Type: text/html; charset=utf-8
</I>&gt;<i> &lt; Set-Cookie: BCSI-CS-53409a6e5b6816df=2; Path=/
</I>&gt;<i> &lt; Content-Length: 1582
</I>&gt;<i> &lt; Date: Tue, 26 Oct 2021 07:17:01 GMT
</I>&gt;<i> &lt; X-Cache: MISS from testvm
</I>&gt;<i> &lt; Via: 1.1 testvm (squid/5.2-VCS)
</I>&gt;<i> &lt; Connection: keep-alive
</I>&gt;<i> &lt;
</I>&gt;<i> &lt;HTML&gt;&lt;HEAD&gt;
</I>&gt;<i> 
</I>&gt;<i> &lt;TITLE&gt;Access Denied&lt;/TITLE&gt;
</I>&gt;<i> 
</I>&gt;<i> &lt;STYLE TYPE=&quot;text/css&quot;&gt;
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Is there anything that can be done on configuration level to make it work?
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Regards,
</I>&gt;<i> Mateusz
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i> 
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="024325.html">[squid-users] missing response body with https requests
</A></li>
	<LI>Next message (by thread): <A HREF="024331.html">[squid-users] IPcache and mixed case domain names
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24326">[ date ]</a>
              <a href="thread.html#24326">[ thread ]</a>
              <a href="subject.html#24326">[ subject ]</a>
              <a href="author.html#24326">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
