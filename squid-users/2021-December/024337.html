<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Significant memory leak with version 5.x (not with 4.17)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Significant%20memory%20leak%20with%20version%205.x%20%28not%20with%0A%204.17%29&In-Reply-To=%3CCACabJxOfSqVkN63DN%3DN%3D_J%3DB7CtH-ahRkFaAtM93H67BpQx9eA%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="024356.html">
   <LINK REL="Next"  HREF="024338.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Significant memory leak with version 5.x (not with 4.17)</H1>
    <B>Praveen Ponakanti</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Significant%20memory%20leak%20with%20version%205.x%20%28not%20with%0A%204.17%29&In-Reply-To=%3CCACabJxOfSqVkN63DN%3DN%3D_J%3DB7CtH-ahRkFaAtM93H67BpQx9eA%40mail.gmail.com%3E"
       TITLE="[squid-users] Significant memory leak with version 5.x (not with 4.17)">pponakanti at roblox.com
       </A><BR>
    <I>Wed Dec 22 00:48:03 UTC 2021</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="024356.html">[squid-users] Many new ERROR lines in cache.log after upgrade
</A></li>
        <LI>Next message (by thread): <A HREF="024338.html">[squid-users] Significant memory leak with version 5.x (not with 4.17)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24337">[ date ]</a>
              <a href="thread.html#24337">[ thread ]</a>
              <a href="subject.html#24337">[ subject ]</a>
              <a href="author.html#24337">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,


We are running the squid proxy for servicing outbound HTTP quests from our
network and have observed a significant memory leak with 5.x versions.
While there are several discussions about memory leaks with recent
versions, just wanted to list out what we have observed in case this is an
unknown leak.



   - The request-rate through our squid proxy currently ranges between a
   daily low of 10 rps to a daily high 125 rps.
   - About mid-way during the daily ramp in request rates, the memory usage
   of the squid proxy starts to increase by about 1-2.5 G / day before
   leveling off till the next day's ramp in reqs. 4.17 does not exhibit this
   memory leak (or at least not at anything close to this rate).
   - We are running 30 squid workers and the cache is set to deny all.
   Besides this, we have a single tcp_outgoing_address, some site specific
   ACL&#8217;s (both IP &amp; domain acl's), and a custom access log format with a UDP
   target.
   - Both versions of squid run on similar hosts (64 cores each) and
   receive identical traffic patterns throughout the day. Version 5.3 &amp; 5.1
   have similar rates of memory leak.


We are unable to use version 5.X in our production environment as we will
have a much higher rate of requests through the proxy later on.


Due to the nature of the memory leak, it appears something with the memory
pool management has been broken with version 5.x.


I have attempted to build squid with -with-valgrind-debug, and run it in a
test env. However valgrind appears to collect some data from the parse
config functions and then the squid proxy restarts. Valgrind no longer
reports memory leak stats afterwards.


Snips from squid-internal-mgr/info. Note the data below does not appear to
account for all the memory used by the squid process(es), which is also
reported by the squid-exporter container. Our node level stats show that
the 5.x squid is currently using up more than 28G, while the 4.17 version
is under 7G. Both instances were setup to take traffic about 10 days ago.


Thanks

Praveen


Version 5.3

&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;


Memory accounted for:

Total accounted:       1215892 KB

memPoolAlloc calls: 7529400915

memPoolFree calls:  7624989161

File descriptor usage for squid:

Maximum number of file descriptors:   31457280

Largest file desc currently in use:   24962

Number of file desc currently in use: 4486

Files queued for open:                   0

Available number of file descriptors: 31452794

Reserved number of file descriptors:  3000

Store Disk files open:                   0


Version 4.17

&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;


Memory accounted for:

Total accounted:        76878 KB

memPoolAlloc calls: 6217787434

memPoolFree calls:  6301483686

File descriptor usage for squid:

Maximum number of file descriptors:   31457280

Largest file desc currently in use:   20184

Number of file desc currently in use: 4419

Files queued for open:                   0

Available number of file descriptors: 31452861

Reserved number of file descriptors:  3000

Store Disk files open:                   0
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20211221/429cffd2/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20211221/429cffd2/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="024356.html">[squid-users] Many new ERROR lines in cache.log after upgrade
</A></li>
	<LI>Next message (by thread): <A HREF="024338.html">[squid-users] Significant memory leak with version 5.x (not with 4.17)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24337">[ date ]</a>
              <a href="thread.html#24337">[ thread ]</a>
              <a href="subject.html#24337">[ subject ]</a>
              <a href="author.html#24337">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
