<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Significant memory leak with version 5.x (not with 4.17)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Significant%20memory%20leak%20with%20version%205.x%20%28not%0A%20with%204.17%29&In-Reply-To=%3CCACabJxPz9%2B0E3SAiyDE3hU8r%2BVFHOG3WpQr5r0WK3NgLkTiLOA%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="024340.html">
   <LINK REL="Next"  HREF="024350.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Significant memory leak with version 5.x (not with 4.17)</H1>
    <B>Praveen Ponakanti</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Significant%20memory%20leak%20with%20version%205.x%20%28not%0A%20with%204.17%29&In-Reply-To=%3CCACabJxPz9%2B0E3SAiyDE3hU8r%2BVFHOG3WpQr5r0WK3NgLkTiLOA%40mail.gmail.com%3E"
       TITLE="[squid-users] Significant memory leak with version 5.x (not with 4.17)">pponakanti at roblox.com
       </A><BR>
    <I>Thu Dec 23 07:15:37 UTC 2021</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="024340.html">[squid-users] Significant memory leak with version 5.x (not with 4.17)
</A></li>
        <LI>Next message (by thread): <A HREF="024350.html">[squid-users] Significant memory leak with version 5.x (not with 4.17)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24349">[ date ]</a>
              <a href="thread.html#24349">[ thread ]</a>
              <a href="subject.html#24349">[ subject ]</a>
              <a href="author.html#24349">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Alex,

BTW, where do I send the files with the memory logs? I had sent a few
attachments in an email reply to this thread but got back a
message saying it is too large and will need to be reviewed by an admin.
Thanks
Praveen

On Wed, Dec 22, 2021 at 10:58 PM Praveen Ponakanti &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">pponakanti at roblox.com</A>&gt;
wrote:

&gt;<i> Hi Alex,
</I>&gt;<i>
</I>&gt;<i> Thanks, please see inline below.
</I>&gt;<i>
</I>&gt;<i> On Wed, Dec 22, 2021 at 6:45 AM Alex Rousskov &lt;
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt; wrote:
</I>&gt;<i>
</I>&gt;&gt;<i> On 12/21/21 7:48 PM, Praveen Ponakanti wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &gt; We are running the squid proxy for servicing outbound HTTP quests from
</I>&gt;&gt;<i> &gt; our network and have observed a significant memory leak with 5.x
</I>&gt;&gt;<i> &gt; versions. While there are several discussions about memory leaks with
</I>&gt;&gt;<i> &gt; recent versions, just wanted to list out what we have observed in case
</I>&gt;&gt;<i> &gt; this is an unknown leak.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I recommend sharing a log with 48+ hourly mgr:mem snapshots. These
</I>&gt;&gt;<i> snapshots help compare your leak with others we know about and may help
</I>&gt;&gt;<i> isolate some of the memory leaks:
</I>&gt;&gt;<i> <A HREF="https://bugs.squid-cache.org/show_bug.cgi?id=5132#c8">https://bugs.squid-cache.org/show_bug.cgi?id=5132#c8</A>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;<i> Attached the current memory stats from the 2 nodes that have been taking a
</I>&gt;<i> similar rate of requests, with the node running 5.3 already using up 20G
</I>&gt;<i> more than the 4.17 version. The memory leak increases over a few hours in
</I>&gt;<i> almost a step-like curve each day on the 5.x versions; I will continue
</I>&gt;<i> collecting these stats hourly.
</I>&gt;<i>
</I>&gt;<i> Note, I am using a curl to <A HREF="http://localhost:3128/squid-internal-mgr/mem">http://localhost:3128/squid-internal-mgr/mem</A>
</I>&gt;<i> to collect the memory stats as we dont have the squidclient built into the
</I>&gt;<i> docker container that runs the squid proxy. The output appears to be quite
</I>&gt;<i> large with data for each kid process (we have 30 workers configured).
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> &gt; I have attempted to build squid with -with-valgrind-debug, and run it in
</I>&gt;&gt;<i> &gt; a test env. However valgrind appears to collect some data from the parse
</I>&gt;&gt;<i> &gt; config functions and then the squid proxy restarts.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> FWIW, valgrind works as expected in my environment. If your Squid proxy
</I>&gt;&gt;<i> is killed by an assertion or crashes, even in a test environment, please
</I>&gt;&gt;<i> consider reporting that bug (after checking that it has not been
</I>&gt;&gt;<i> reported already, of course). If your test proxy is misconfigured, then
</I>&gt;&gt;<i> please fix the configuration before proceeding with tests.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The Valgrind image isnt crashing, and it uses the same config that works
</I>&gt;<i> in prod without valgrind. I might have to fix how it is launched from the
</I>&gt;<i> docker entrypoint script in my test env.
</I>&gt;<i>
</I>&gt;<i> root     117051 117005  0 Dec11 ?        00:00:00 /usr/bin/valgrind.bin
</I>&gt;<i> --leak-check=full --show-leak-kinds=all --verbose
</I>&gt;<i> --log-file=/squid/var/logs/valgrind-out.txt /squid/sbin/squid -f
</I>&gt;<i> /squid/etc/squid.conf
</I>&gt;<i>
</I>&gt;<i> gdb attach 1
</I>&gt;<i> GNU gdb (Ubuntu 9.2-0ubuntu1~20.04) 9.2
</I>&gt;<i>
</I>&gt;<i> (gdb) monitor
</I>&gt;<i> &quot;monitor&quot; command not supported by this target.
</I>&gt;<i> (gdb)
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> Thank you,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Alex.
</I>&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;<i> squid-users mailing list
</I>&gt;&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20211222/3a007051/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20211222/3a007051/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="024340.html">[squid-users] Significant memory leak with version 5.x (not with 4.17)
</A></li>
	<LI>Next message (by thread): <A HREF="024350.html">[squid-users] Significant memory leak with version 5.x (not with 4.17)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24349">[ date ]</a>
              <a href="thread.html#24349">[ thread ]</a>
              <a href="subject.html#24349">[ subject ]</a>
              <a href="author.html#24349">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
