<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Fixing Squid configuration for caching proxy?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Fixing%20Squid%20configuration%20for%20caching%20proxy%3F&In-Reply-To=%3C006101d6f8da%240c58bf30%24250a3d90%24%40gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="023293.html">
   <LINK REL="Next"  HREF="023295.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Fixing Squid configuration for caching proxy?</H1>
    <B>Eliezer Croitoru</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Fixing%20Squid%20configuration%20for%20caching%20proxy%3F&In-Reply-To=%3C006101d6f8da%240c58bf30%24250a3d90%24%40gmail.com%3E"
       TITLE="[squid-users] Fixing Squid configuration for caching proxy?">ngtech1ltd at gmail.com
       </A><BR>
    <I>Mon Feb  1 20:37:23 UTC 2021</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="023293.html">[squid-users] Squid &quot;suspending ICAP service for too many failures&quot;
</A></li>
        <LI>Next message (by thread): <A HREF="023295.html">[squid-users] Wildcard for url domain
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23294">[ date ]</a>
              <a href="thread.html#23294">[ thread ]</a>
              <a href="subject.html#23294">[ subject ]</a>
              <a href="author.html#23294">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hey Milos,

I suggest to try and test this against:
<A HREF="http://s3.amazonaws.com/awsdocs/S3/latest/s3-gsg.pdf">http://s3.amazonaws.com/awsdocs/S3/latest/s3-gsg.pdf</A>
<A HREF="http://s3.amazonaws.com/awsdocs/gettingstarted/latest/awsgsg-freetier.pdf">http://s3.amazonaws.com/awsdocs/gettingstarted/latest/awsgsg-freetier.pdf</A>

<A HREF="https://s3.amazonaws.com/awsdocs/gettingstarted/latest/awsgsg-freetier.pdf">https://s3.amazonaws.com/awsdocs/gettingstarted/latest/awsgsg-freetier.pdf</A>
<A HREF="https://s3.amazonaws.com/awsdocs/S3/latest/s3-gsg.pdf">https://s3.amazonaws.com/awsdocs/S3/latest/s3-gsg.pdf</A>

What version of squid are you using?
squid -v
output should give something.

Eliezer

----
Eliezer Croitoru
Tech Support
Mobile: +972-5-28704261
Email: mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">ngtech1ltd at gmail.com</A>
Zoom: Coming soon


From: squid-users &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>&gt; On Behalf Of Milos Dodic
Sent: Friday, January 29, 2021 7:57 PM
To: Alex Rousskov &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt;
Cc: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
Subject: Re: [squid-users] Fixing Squid configuration for caching proxy?

Alex, thanks for the swift response. Your help is very much appreciated!

Here are the logs, but first to mention, from the server that is going through the Squid, I am using curl -k (-k to ignore SSL insecure warnings atm). From the Squid iself, I use squidclient, as using curl from Squid doesn't do much.

So when I curl the newly uploaded test file from the server that has Squid as default gateway, the access logs shows:
------------------------------------------------------------------------------------------------------------------
1611941462.501     13 10.10.1.249 NONE/200 0 CONNECT <A HREF="http://52.217.88.134:443">http://52.217.88.134:443</A> - ORIGINAL_DST/<A HREF="http://52.217.88.134">http://52.217.88.134</A> -
1611941462.537     22 10.10.1.249 TCP_MISS/200 488 GET <A HREF="https://s3.amazonaws.com/test.XXXXX.com/testFile">https://s3.amazonaws.com/test.XXXXX.com/testFile</A> - ORIGINAL_DST/<A HREF="http://52.217.88.134">http://52.217.88.134</A> binary/octet-stream
------------------------------------------------------------------------------------------------------------------

Cache log is quite long, but won't truncate in order to not omit something potentially important:
--------------------------------------------------------------------------------------------------------------------------------
2021/01/29 17:31:02.488 kid1| 5,2| TcpAcceptor.cc(224) doAccept: New connection on FD 30
2021/01/29 17:31:02.488 kid1| 5,2| TcpAcceptor.cc(312) acceptNext: connection on local=[::]:3130 remote=[::] FD 30 flags=41
2021/01/29 17:31:02.488 kid1| 33,2| client_side.cc(2748) httpsSslBumpAccessCheckDone: sslBump action stareneeded for local=<A HREF="http://52.217.88.134:443">http://52.217.88.134:443</A> remote=<A HREF="http://10.10.1.249:43538">http://10.10.1.249:43538</A> FD 13 flags=33
2021/01/29 17:31:02.488 kid1| 33,2| client_side.cc(3424) fakeAConnectRequest: fake a CONNECT request to force connState to tunnel for ssl-bump
2021/01/29 17:31:02.491 kid1| 85,2| client_side_request.cc(753) clientAccessCheckDone: The request CONNECT <A HREF="http://52.217.88.134:443">http://52.217.88.134:443</A> is ALLOWED; last ACL checked: allowed_http_sites
2021/01/29 17:31:02.492 kid1| 85,2| client_side_request.cc(729) clientAccessCheck2: No adapted_http_access configuration. default: ALLOW
2021/01/29 17:31:02.492 kid1| 85,2| client_side_request.cc(753) clientAccessCheckDone: The request CONNECT <A HREF="http://52.217.88.134:443">http://52.217.88.134:443</A> is ALLOWED; last ACL checked: allowed_http_sites
2021/01/29 17:31:02.494 kid1| 17,2| FwdState.cc(142) FwdState: Forwarding client request local=<A HREF="http://52.217.88.134:443">http://52.217.88.134:443</A> remote=<A HREF="http://10.10.1.249:43538">http://10.10.1.249:43538</A> FD 13 flags=33, url=<A HREF="http://52.217.88.134:443">http://52.217.88.134:443</A>
2021/01/29 17:31:02.494 kid1| 44,2| peer_select.cc(302) peerSelectDnsPaths: Found sources for '<A HREF="http://52.217.88.134:443">http://52.217.88.134:443</A>'
2021/01/29 17:31:02.494 kid1| 44,2| peer_select.cc(303) peerSelectDnsPaths:   always_direct = DENIED
2021/01/29 17:31:02.494 kid1| 44,2| peer_select.cc(304) peerSelectDnsPaths:    never_direct = DENIED
2021/01/29 17:31:02.494 kid1| 44,2| peer_select.cc(310) peerSelectDnsPaths:    ORIGINAL_DST = local=0.0.0.0 remote=<A HREF="http://52.217.88.134:443">http://52.217.88.134:443</A> flags=1
2021/01/29 17:31:02.494 kid1| 44,2| peer_select.cc(317) peerSelectDnsPaths:        timedout = 0
2021/01/29 17:31:02.496 kid1| 83,2| bio.cc(316) readAndParse: parsing error on FD 15: check failed: state &lt; atHelloReceived
    exception location: Handshake.cc(324) parseHandshakeMessage

2021/01/29 17:31:02.496 kid1| Error parsing SSL Server Hello Message on FD 15
2021/01/29 17:31:02.501 kid1| 37,2| IcmpSquid.cc(91) SendEcho: to 52.217.88.134, opcode 3, len 13
2021/01/29 17:31:02.501| 42,2| IcmpPinger.cc(205) Recv:  Pass 52.217.88.134 off to ICMPv4 module.
2021/01/29 17:31:02.501| 42,2| Icmp.cc(95) Log: pingerLog: 1611941462.501640 52.217.88.134                                 32
2021/01/29 17:31:02.501 kid1| 20,2| store.cc(986) checkCachable: StoreEntry::checkCachable: NO: not cachable
2021/01/29 17:31:02.501 kid1| 20,2| store.cc(986) checkCachable: StoreEntry::checkCachable: NO: not cachable
2021/01/29 17:31:02.502| 42,2| IcmpPinger.cc(218) SendResult: return result to squid. len=7994
2021/01/29 17:31:02.502| 42,2| Icmp.cc(95) Log: pingerLog: 1611941462.502816 52.217.88.134                                 0 Echo Reply      1ms 6 hops
2021/01/29 17:31:02.514 kid1| 83,2| client_side.cc(2683) clientNegotiateSSL: New session 0x19d4690 on FD 13 (<A HREF="http://10.10.1.249:43538">http://10.10.1.249:43538</A>)
2021/01/29 17:31:02.515 kid1| 11,2| client_side.cc(1306) parseHttpRequest: HTTP Client local=<A HREF="http://52.217.88.134:443">http://52.217.88.134:443</A> remote=<A HREF="http://10.10.1.249:43538">http://10.10.1.249:43538</A> FD 13 flags=33
2021/01/29 17:31:02.515 kid1| 11,2| client_side.cc(1310) parseHttpRequest: HTTP Client REQUEST:
---------
GET /<A HREF="http://test.XXXXX.com/testFile">http://test.XXXXX.com/testFile</A> HTTP/1.1
Host: <A HREF="http://s3.amazonaws.com">http://s3.amazonaws.com</A>
User-Agent: curl/7.61.1
Accept: */*


----------
2021/01/29 17:31:02.520 kid1| 85,2| client_side_request.cc(753) clientAccessCheckDone: The request GET <A HREF="https://s3.amazonaws.com/test.XXXXX.com/testFile">https://s3.amazonaws.com/test.XXXXX.com/testFile</A> is ALLOWED; last ACL checked: allowed_http_sites
2021/01/29 17:31:02.520 kid1| 85,2| client_side_request.cc(729) clientAccessCheck2: No adapted_http_access configuration. default: ALLOW
2021/01/29 17:31:02.520 kid1| 85,2| client_side_request.cc(753) clientAccessCheckDone: The request GET <A HREF="https://s3.amazonaws.com/test.XXXXX.com/testFile">https://s3.amazonaws.com/test.XXXXX.com/testFile</A> is ALLOWED; last ACL checked: allowed_http_sites
2021/01/29 17:31:02.520 kid1| 17,2| FwdState.cc(142) FwdState: Forwarding client request local=<A HREF="http://52.217.88.134:443">http://52.217.88.134:443</A> remote=<A HREF="http://10.10.1.249:43538">http://10.10.1.249:43538</A> FD 13 flags=33, url=<A HREF="https://s3.amazonaws.com/test.XXXXX.com/testFile">https://s3.amazonaws.com/test.XXXXX.com/testFile</A>
2021/01/29 17:31:02.520 kid1| 44,2| peer_select.cc(281) peerSelectDnsPaths: Find IP destination for: <A HREF="https://s3.amazonaws.com/test.XXXXX.com/testFile">https://s3.amazonaws.com/test.XXXXX.com/testFile</A>' via <A HREF="http://s3.amazonaws.com">http://s3.amazonaws.com</A>
2021/01/29 17:31:02.520 kid1| 44,2| peer_select.cc(302) peerSelectDnsPaths: Found sources for '<A HREF="https://s3.amazonaws.com/test.XXXXX.com/testFile">https://s3.amazonaws.com/test.XXXXX.com/testFile</A>'
2021/01/29 17:31:02.520 kid1| 44,2| peer_select.cc(303) peerSelectDnsPaths:   always_direct = DENIED
2021/01/29 17:31:02.520 kid1| 44,2| peer_select.cc(304) peerSelectDnsPaths:    never_direct = DENIED
2021/01/29 17:31:02.520 kid1| 44,2| peer_select.cc(312) peerSelectDnsPaths:          PINNED = local=0.0.0.0 remote=<A HREF="http://52.216.80.75:443">http://52.216.80.75:443</A> flags=1
2021/01/29 17:31:02.521 kid1| 44,2| peer_select.cc(310) peerSelectDnsPaths:    ORIGINAL_DST = local=0.0.0.0 remote=<A HREF="http://52.217.88.134:443">http://52.217.88.134:443</A> flags=1
2021/01/29 17:31:02.521 kid1| 44,2| peer_select.cc(317) peerSelectDnsPaths:        timedout = 0
2021/01/29 17:31:02.521 kid1| 37,2| IcmpSquid.cc(91) SendEcho: to 52.216.80.75, opcode 3, len 16
2021/01/29 17:31:02.521| 42,2| IcmpPinger.cc(205) Recv:  Pass 52.216.80.75 off to ICMPv4 module.
2021/01/29 17:31:02.521| 42,2| Icmp.cc(95) Log: pingerLog: 1611941462.521215 52.216.80.75                                  32
2021/01/29 17:31:02.521 kid1| 11,2| http.cc(2260) sendRequest: HTTP Server local=<A HREF="http://10.10.0.135:36120">http://10.10.0.135:36120</A> remote=<A HREF="http://52.217.88.134:443">http://52.217.88.134:443</A> FD 15 flags=1
2021/01/29 17:31:02.521 kid1| 11,2| http.cc(2261) sendRequest: HTTP Server REQUEST:
---------
GET /<A HREF="http://test.XXXXX.com/testFile">http://test.XXXXX.com/testFile</A> HTTP/1.1
User-Agent: curl/7.61.1
Accept: */*
Host: <A HREF="http://s3.amazonaws.com">http://s3.amazonaws.com</A>
Via: 1.1 squid (squid/4.9)
X-Forwarded-For: 10.10.1.249
Cache-Control: max-age=259200
Connection: keep-alive


----------
2021/01/29 17:31:02.521| 42,2| IcmpPinger.cc(218) SendResult: return result to squid. len=7997
2021/01/29 17:31:02.521| 42,2| Icmp.cc(95) Log: pingerLog: 1611941462.521561 52.216.80.75                                  0 Echo Reply      0ms 5 hops
2021/01/29 17:31:02.536 kid1| ctx: enter level  0: '<A HREF="https://s3.amazonaws.com/test.XXXXX.com/testFile">https://s3.amazonaws.com/test.XXXXX.com/testFile</A>'
2021/01/29 17:31:02.536 kid1| 11,2| http.cc(719) processReplyHeader: HTTP Server local=<A HREF="http://10.10.0.135:36120">http://10.10.0.135:36120</A> remote=<A HREF="http://52.217.88.134:443">http://52.217.88.134:443</A> FD 15 flags=1
2021/01/29 17:31:02.536 kid1| 11,2| http.cc(723) processReplyHeader: HTTP Server RESPONSE:
---------
HTTP/1.1 200 OK
x-amz-id-2: hZbtwwRSyeN8TkE+V7V9iUuEEMwyXLVblsFhmazae3kqofWK5EuQf+dH6rU3CF8hDUbj8YcMyw4=
x-amz-request-id: CD6D86AAA3FDA43F
Date: Fri, 29 Jan 2021 17:31:03 GMT
Last-Modified: Fri, 29 Jan 2021 17:27:47 GMT
ETag: &quot;eb1a3227cdc3fedbaec2fe38bf6c044a&quot;
Accept-Ranges: bytes
Content-Type: binary/octet-stream
Content-Length: 8
Server: AmazonS3

----------
2021/01/29 17:31:02.536 kid1| ctx: exit level  0
2021/01/29 17:31:02.537 kid1| 20,2| store.cc(986) checkCachable: StoreEntry::checkCachable: NO: not cachable
2021/01/29 17:31:02.537 kid1| 20,2| store.cc(986) checkCachable: StoreEntry::checkCachable: NO: not cachable
2021/01/29 17:31:02.537 kid1| 88,2| client_side_reply.cc(2061) processReplyAccessResult: The reply for GET <A HREF="https://s3.amazonaws.com/test.XXXXX.com/testFile">https://s3.amazonaws.com/test.XXXXX.com/testFile</A> is ALLOWED, because it matched allowed_http_sites
2021/01/29 17:31:02.537 kid1| 11,2| Stream.cc(266) sendStartOfMessage: HTTP Client local=<A HREF="http://52.217.88.134:443">http://52.217.88.134:443</A> remote=<A HREF="http://10.10.1.249:43538">http://10.10.1.249:43538</A> FD 13 flags=33
2021/01/29 17:31:02.537 kid1| 11,2| Stream.cc(267) sendStartOfMessage: HTTP Client REPLY:
---------
HTTP/1.1 200 OK
x-amz-id-2: hZbtwwRSyeN8TkE+V7V9iUuEEMwyXLVblsFhmazae3kqofWK5EuQf+dH6rU3CF8hDUbj8YcMyw4=
x-amz-request-id: CD6D86AAA3FDA43F
Date: Fri, 29 Jan 2021 17:31:03 GMT
Last-Modified: Fri, 29 Jan 2021 17:27:47 GMT
ETag: &quot;eb1a3227cdc3fedbaec2fe38bf6c044a&quot;
Accept-Ranges: bytes
Content-Type: binary/octet-stream
Content-Length: 8
Server: AmazonS3
X-Cache: MISS from squid
X-Cache-Lookup: MISS from squid:3128
Via: 1.1 squid (squid/4.9)
Connection: keep-alive


----------
2021/01/29 17:31:02.537 kid1| 20,2| store.cc(986) checkCachable: StoreEntry::checkCachable: NO: not cachable
2021/01/29 17:31:02.537 kid1| 20,2| store.cc(986) checkCachable: StoreEntry::checkCachable: NO: not cachable
2021/01/29 17:31:02.537 kid1| 20,2| store.cc(986) checkCachable: StoreEntry::checkCachable: NO: not cachable
2021/01/29 17:31:02.537 kid1| 20,2| store.cc(986) checkCachable: StoreEntry::checkCachable: NO: not cachable
2021/01/29 17:31:02.538 kid1| 33,2| client_side.cc(582) swanSong: local=<A HREF="http://52.217.88.134:443">http://52.217.88.134:443</A> remote=<A HREF="http://10.10.1.249:43538">http://10.10.1.249:43538</A> flags=33
2021/01/29 17:31:02.538 kid1| 20,2| store.cc(986) checkCachable: StoreEntry::checkCachable: NO: not cachable
--------------------------------------------------------------------------------------------------------------------------------




On the other hand, with squidclient from the Squid itself, access log (the first run, when nothing is cached for the new test file yet):

------------------------------------------------------------------------------------------------------------------
1611942152.986     29 127.0.0.1 TCP_MISS/200 483 GET <A HREF="https://s3.amazonaws.com/test.dvabearqloza.com/testFile">https://s3.amazonaws.com/test.dvabearqloza.com/testFile</A> - HIER_DIRECT/<A HREF="http://52.216.226.131">http://52.216.226.131</A> binary/octet-stream
------------------------------------------------------------------------------------------------------------------

And cache log:
------------------------------------------------------------------------------------------------------------------
2021/01/29 17:42:32.956 kid1| 5,2| TcpAcceptor.cc(312) acceptNext: connection on local=[::]:3128 remote=[::] FD 28 flags=9
2021/01/29 17:42:32.957 kid1| 11,2| client_side.cc(1306) parseHttpRequest: HTTP Client local=<A HREF="http://127.0.0.1:3128">http://127.0.0.1:3128</A> remote=<A HREF="http://127.0.0.1:50584">http://127.0.0.1:50584</A> FD 13 flags=1
2021/01/29 17:42:32.957 kid1| 11,2| client_side.cc(1310) parseHttpRequest: HTTP Client REQUEST:
---------
GET <A HREF="https://s3.amazonaws.com/test.XXXXX.com/testFile">https://s3.amazonaws.com/test.XXXXX.com/testFile</A> HTTP/1.0
Host: <A HREF="http://s3.amazonaws.com">http://s3.amazonaws.com</A>
User-Agent: squidclient/4.9
Accept: */*
Connection: close

----------
2021/01/29 17:42:32.957 kid1| 85,2| client_side_request.cc(753) clientAccessCheckDone: The request GET <A HREF="https://s3.amazonaws.com/test.XXXXX.com/testFile">https://s3.amazonaws.com/test.XXXXX.com/testFile</A> is ALLOWED; last ACL checked: allowed_http_sites
2021/01/29 17:42:32.957 kid1| 85,2| client_side_request.cc(729) clientAccessCheck2: No adapted_http_access configuration. default: ALLOW
2021/01/29 17:42:32.957 kid1| 85,2| client_side_request.cc(753) clientAccessCheckDone: The request GET <A HREF="https://s3.amazonaws.com/test.XXXXX.com/testFile">https://s3.amazonaws.com/test.XXXXX.com/testFile</A> is ALLOWED; last ACL checked: allowed_http_sites
2021/01/29 17:42:32.957 kid1| 17,2| FwdState.cc(142) FwdState: Forwarding client request local=<A HREF="http://127.0.0.1:3128">http://127.0.0.1:3128</A> remote=<A HREF="http://127.0.0.1:50584">http://127.0.0.1:50584</A> FD 13 flags=1, url=<A HREF="https://s3.amazonaws.com/test.XXXXX.com/testFile">https://s3.amazonaws.com/test.XXXXX.com/testFile</A>
2021/01/29 17:42:32.957 kid1| 44,2| peer_select.cc(281) peerSelectDnsPaths: Find IP destination for: <A HREF="https://s3.amazonaws.com/test.XXXXX.com/testFile">https://s3.amazonaws.com/test.XXXXX.com/testFile</A>' via <A HREF="http://s3.amazonaws.com">http://s3.amazonaws.com</A>
2021/01/29 17:42:32.959 kid1| 44,2| peer_select.cc(302) peerSelectDnsPaths: Found sources for '<A HREF="https://s3.amazonaws.com/test.XXXXX.com/testFile">https://s3.amazonaws.com/test.XXXXX.com/testFile</A>'
2021/01/29 17:42:32.959 kid1| 44,2| peer_select.cc(303) peerSelectDnsPaths:   always_direct = DENIED
2021/01/29 17:42:32.959 kid1| 44,2| peer_select.cc(304) peerSelectDnsPaths:    never_direct = DENIED
2021/01/29 17:42:32.959 kid1| 44,2| peer_select.cc(308) peerSelectDnsPaths:          DIRECT = local=0.0.0.0 remote=<A HREF="http://52.216.226.131:443">http://52.216.226.131:443</A> flags=1
2021/01/29 17:42:32.959 kid1| 44,2| peer_select.cc(317) peerSelectDnsPaths:        timedout = 0
2021/01/29 17:42:32.961 kid1| 83,2| bio.cc(316) readAndParse: parsing error on FD 15: check failed: state &lt; atHelloReceived
    exception location: Handshake.cc(324) parseHandshakeMessage

2021/01/29 17:42:32.961 kid1| Error parsing SSL Server Hello Message on FD 15
2021/01/29 17:42:32.965 kid1| 37,2| IcmpSquid.cc(91) SendEcho: to 52.216.226.131, opcode 3, len 16
2021/01/29 17:42:32.965| 42,2| IcmpPinger.cc(205) Recv:  Pass 52.216.226.131 off to ICMPv4 module.
2021/01/29 17:42:32.965| 42,2| Icmp.cc(95) Log: pingerLog: 1611942152.965403 52.216.226.131                                32
2021/01/29 17:42:32.965 kid1| 11,2| http.cc(2260) sendRequest: HTTP Server local=<A HREF="http://10.10.0.135:33004">http://10.10.0.135:33004</A> remote=<A HREF="http://52.216.226.131:443">http://52.216.226.131:443</A> FD 15 flags=1
2021/01/29 17:42:32.965 kid1| 11,2| http.cc(2261) sendRequest: HTTP Server REQUEST:
---------
GET /<A HREF="http://test.XXXXX.com/testFile">http://test.XXXXX.com/testFile</A> HTTP/1.1
User-Agent: squidclient/4.9
Accept: */*
Host: <A HREF="http://s3.amazonaws.com">http://s3.amazonaws.com</A>
Via: 1.0 squid (squid/4.9)
X-Forwarded-For: 127.0.0.1
Cache-Control: max-age=259200
Connection: keep-alive


----------
2021/01/29 17:42:32.966| 42,2| IcmpPinger.cc(218) SendResult: return result to squid. len=7997
2021/01/29 17:42:32.966| 42,2| Icmp.cc(95) Log: pingerLog: 1611942152.966514 52.216.226.131                                0 Echo Reply      1ms 6 hops
2021/01/29 17:42:32.985 kid1| ctx: enter level  0: '<A HREF="https://s3.amazonaws.com/test.XXXXX.com/testFile">https://s3.amazonaws.com/test.XXXXX.com/testFile</A>'
2021/01/29 17:42:32.985 kid1| 11,2| http.cc(719) processReplyHeader: HTTP Server local=<A HREF="http://10.10.0.135:33004">http://10.10.0.135:33004</A> remote=<A HREF="http://52.216.226.131:443">http://52.216.226.131:443</A> FD 15 flags=1
2021/01/29 17:42:32.985 kid1| 11,2| http.cc(723) processReplyHeader: HTTP Server RESPONSE:
---------
HTTP/1.1 200 OK
x-amz-id-2: z//C9o0g1wI5ep44MaSBbU7ptfDlvOjTZLIBYSpaI8+h8oxt607nyA9zumm8eEk+wTJb3jRD7wU=
x-amz-request-id: A6E14CC59FE63894
Date: Fri, 29 Jan 2021 17:42:33 GMT
Last-Modified: Fri, 29 Jan 2021 17:27:47 GMT
ETag: &quot;eb1a3227cdc3fedbaec2fe38bf6c044a&quot;
Accept-Ranges: bytes
Content-Type: binary/octet-stream
Content-Length: 8
Server: AmazonS3

----------
2021/01/29 17:42:32.986 kid1| ctx: exit level  0
2021/01/29 17:42:32.986 kid1| 88,2| client_side_reply.cc(2061) processReplyAccessResult: The reply for GET <A HREF="https://s3.amazonaws.com/test.XXXXX.com/testFile">https://s3.amazonaws.com/test.XXXXX.com/testFile</A> is ALLOWED, because it matched allowed_http_sites
2021/01/29 17:42:32.986 kid1| 11,2| Stream.cc(266) sendStartOfMessage: HTTP Client local=<A HREF="http://127.0.0.1:3128">http://127.0.0.1:3128</A> remote=<A HREF="http://127.0.0.1:50584">http://127.0.0.1:50584</A> FD 13 flags=1
2021/01/29 17:42:32.986 kid1| 11,2| Stream.cc(267) sendStartOfMessage: HTTP Client REPLY:
---------
HTTP/1.1 200 OK
x-amz-id-2: z//C9o0g1wI5ep44MaSBbU7ptfDlvOjTZLIBYSpaI8+h8oxt607nyA9zumm8eEk+wTJb3jRD7wU=
x-amz-request-id: A6E14CC59FE63894
Date: Fri, 29 Jan 2021 17:42:33 GMT
Last-Modified: Fri, 29 Jan 2021 17:27:47 GMT
ETag: &quot;eb1a3227cdc3fedbaec2fe38bf6c044a&quot;
Accept-Ranges: bytes
Content-Type: binary/octet-stream
Content-Length: 8
Server: AmazonS3
X-Cache: MISS from squid
X-Cache-Lookup: MISS from squid:3128
Via: 1.1 squid (squid/4.9)
Connection: close


----------
2021/01/29 17:42:32.986 kid1| 20,2| store_io.cc(43) storeCreate: storeCreate: Selected dir 0 for e:=sp2V/0x1f582b0*4
2021/01/29 17:42:32.986 kid1| 33,2| client_side.cc(891) kick: local=<A HREF="http://127.0.0.1:3128">http://127.0.0.1:3128</A> remote=<A HREF="http://127.0.0.1:50584">http://127.0.0.1:50584</A> flags=1 Connection was closed
2021/01/29 17:42:32.986 kid1| 33,2| client_side.cc(582) swanSong: local=<A HREF="http://127.0.0.1:3128">http://127.0.0.1:3128</A> remote=<A HREF="http://127.0.0.1:50584">http://127.0.0.1:50584</A> flags=1
------------------------------------------------------------------------------------------------------------------

The first thing that caught my attention was the line:
&quot;checkCachable: StoreEntry::checkCachable: NO: not cachable&quot;, that appears in the logs when server tries to go through proxy.

Any idea what might be the issue overall?

Thanks again!!!




On Fri, Jan 29, 2021 at 5:40 PM Alex Rousskov &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt; wrote:
On 1/28/21 1:34 PM, Milos Dodic wrote:

&gt;<i> I have noticed that the test server also doesn't cache anything
</I>&gt;<i> So if I try to go for a file in S3, it says MISS, and after that, MISS
</I>&gt;<i> again, and I see no new objects in cache being created.
</I>
&gt;<i> If I try the same thing from the proxy itself, I get the MISS, and the
</I>&gt;<i> object gets cached, as it should.
</I>&gt;<i> When I go back to the test server, and try again, it sees the object in
</I>&gt;<i> cache and returns TCP_MEM_HIT/200 instead.
</I>
Without more details, I can only speculate that the client running on
the test server sends different HTTP request headers than the client
running on the proxy itself. You can see the headers in cache.log if you
set debug_options to ALL,2. If you are not sure whether they are the
same, please share those logs. They will also contain response headers
and other potentially useful details.

If the request headers are the same in both tests, then I would
recommend sharing compressed ALL,7 or ALL,9 debugging logs of both
successful and unsuccessful tests (four transactions, two logs) for
analysis. Do not use sensitive data for these tests.

<A HREF="https://wiki.squid-cache.org/SquidFaq/BugReporting#Debugging_a_single_transaction">https://wiki.squid-cache.org/SquidFaq/BugReporting#Debugging_a_single_transaction</A>

Alex.



&gt;<i> This is the entire config file:
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> visible_hostname squid
</I>&gt;<i> cache_dir ufs /test/cache/squid 10000 16 256
</I>&gt;<i> 
</I>&gt;<i> http_access allow localhost
</I>&gt;<i> http_access alow all
</I>&gt;<i> 
</I>&gt;<i> http_port 3128
</I>&gt;<i> http_port 3129 intercept
</I>&gt;<i> acl allowed_http_sites dstdomain .<A HREF="http://amazonaws.com">http://amazonaws.com</A> &lt;<A HREF="http://amazonaws.com">http://amazonaws.com</A>&gt;
</I>&gt;<i> http_access allow allowed_http_sites
</I>&gt;<i> 
</I>&gt;<i> https_port 3130 cert=/etc/squid/ssl/squid.pem ssl-bump intercept
</I>&gt;<i> acl SSL_port port 443
</I>&gt;<i> http_access allow SSL_port
</I>&gt;<i> acl allowed_https_sites ssl::server_name .<A HREF="http://amazonaws.com">http://amazonaws.com</A>
</I>&gt;<i> &lt;<A HREF="http://amazonaws.com">http://amazonaws.com</A>&gt;
</I>&gt;<i> 
</I>&gt;<i> ssl_bump stare all
</I>&gt;<i> ssl_bump bump allowed_https_sites
</I>&gt;<i> ssl_bump terminate all
</I>

&gt;<i> On Tue, Jan 26, 2021 at 9:14 PM Alex Rousskov wrote:
</I>&gt;<i> 
</I>&gt;<i>     On 1/26/21 1:54 PM, Milos Dodic wrote:
</I>&gt;<i> 
</I>&gt;<i>     &gt; when the test server goes for a picture I have stored somewhere in
</I>&gt;<i>     &gt; the cloud, the squid access log shows &quot;TCP_TUNNEL/200&quot;. But when I
</I>&gt;<i>     &gt; try from the proxy itself with squidclient tool, I get
</I>&gt;<i>     &gt; &quot;TCP_MEM_HIT/200&quot;
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i>     Given the very limited information you have provided, I am guessing that
</I>&gt;<i> 
</I>&gt;<i>     * the primary tests opens a CONNECT tunnel through Squid
</I>&gt;<i>     * the squidclient test sends a plain text HTTP request to Squid
</I>&gt;<i> 
</I>&gt;<i>     The final origin server destination may be the same in both tests, but
</I>&gt;<i>     the two transactions are completely different from Squid point of view.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i>     &gt; ssl_bump peek step1 all
</I>&gt;<i>     &gt; ssl_bump peek step2 allowed_https_sites
</I>&gt;<i>     &gt; ssl_bump splice step3 allowed_https_sites
</I>&gt;<i>     &gt; ssl_bump terminate step3 all
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i>     AFAICT, this configuration is splicing or terminating all TLS traffic.
</I>&gt;<i>     No bumping at all. If you want your Squid to bump TLS tunnels, then you
</I>&gt;<i>     have to have at least one &quot;bump&quot; rule!
</I>&gt;<i> 
</I>&gt;<i>     I do not know what your overall SslBump needs are, but perhaps you meant
</I>&gt;<i>     something like the following?
</I>&gt;<i> 
</I>&gt;<i>         acl shouldBeBumped ssl::server_name .<A HREF="http://amazonaws.com">http://amazonaws.com</A>
</I>&gt;<i>     &lt;<A HREF="http://amazonaws.com">http://amazonaws.com</A>&gt;
</I>&gt;<i> 
</I>&gt;<i>         ssl_bump stare all
</I>&gt;<i>         ssl_bump bump shouldBeBumped
</I>&gt;<i>         ssl_bump terminate all
</I>&gt;<i> 
</I>&gt;<i>     Please do not use the configuration above until you understand what it
</I>&gt;<i>     does. Please see <A HREF="https://wiki.squid-cache.org/Features/SslPeekAndSplice">https://wiki.squid-cache.org/Features/SslPeekAndSplice</A>
</I>&gt;<i>     for details.
</I>&gt;<i> 
</I>&gt;<i>     Depending on your environment, the http_access rules may need to be
</I>&gt;<i>     adjusted to allow CONNECT requests (to TLS-safe ports) to IP addresses
</I>&gt;<i>     that do not result in .<A HREF="http://amazonaws.com">http://amazonaws.com</A> &lt;<A HREF="http://amazonaws.com">http://amazonaws.com</A>&gt; in
</I>&gt;<i>     reverse DNS lookups.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i>     HTH,
</I>&gt;<i> 
</I>&gt;<i>     Alex.
</I>&gt;<i> 
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="023293.html">[squid-users] Squid &quot;suspending ICAP service for too many failures&quot;
</A></li>
	<LI>Next message (by thread): <A HREF="023295.html">[squid-users] Wildcard for url domain
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23294">[ date ]</a>
              <a href="thread.html#23294">[ thread ]</a>
              <a href="subject.html#23294">[ subject ]</a>
              <a href="author.html#23294">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
