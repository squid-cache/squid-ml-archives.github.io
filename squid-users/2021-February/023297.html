<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid for Windows: negotiate_kerberos_auth helper seems to leak(?) handles
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20for%20Windows%3A%20negotiate_kerberos_auth%20helper%0A%20seems%20to%20leak%28%3F%29%20handles&In-Reply-To=%3Crvcb5e%24n9%241%40ciao.gmane.io%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="023303.html">
   <LINK REL="Next"  HREF="023301.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid for Windows: negotiate_kerberos_auth helper seems to leak(?) handles</H1>
    <B>Markus Moeller</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20for%20Windows%3A%20negotiate_kerberos_auth%20helper%0A%20seems%20to%20leak%28%3F%29%20handles&In-Reply-To=%3Crvcb5e%24n9%241%40ciao.gmane.io%3E"
       TITLE="[squid-users] Squid for Windows: negotiate_kerberos_auth helper seems to leak(?) handles">huaraz at moeller.plus.com
       </A><BR>
    <I>Tue Feb  2 20:02:50 UTC 2021</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="023303.html">[squid-users] Wildcard for url domain
</A></li>
        <LI>Next message (by thread): <A HREF="023301.html">[squid-users] SSL Squid 5 Cipher suite ordering issue
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23297">[ date ]</a>
              <a href="thread.html#23297">[ thread ]</a>
              <a href="subject.html#23297">[ subject ]</a>
              <a href="author.html#23297">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Klaus,

   The negotiate_kerberos_auth helper is not intended to run on Windows. 
How did you compile it ?

Markus



&quot;Klaus Westkamp&quot;  wrote in message 
news:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">8251c91f-1b08-82f2-f6ec-46ef92fe9573 at westkamp.net...</A>

Hi,

i digged a little further (but i'm no exert in WinDBG):

Attachimng to the process with the most handles (currently 323 shown by
Windows Process Manager, as newly started)

!handles gives me:

277 Handles (weired, shows less than process manager)
Type               Count
None               4
Event              199
Section            7
File               18
Directory          3
SymbolicLink       1
Mutant             9
Semaphore          5
Key                8
Token              2
Thread             5
IoCompletion       2
TpWorkerFactory    2
ALPC Port          5
WaitCompletionPacket    7

Asking for Handle Details:

0:003&gt; !handle 5e8 f
Handle 5e8
   Type             Event
   Attributes       0
   GrantedAccess    0x1f0003:
          Delete,ReadControl,WriteDac,WriteOwner,Synch
          QueryState,ModifyState
   HandleCount      2
   PointerCount     32769
   Name             &lt;none&gt;
   Object Specific Information
     Event Type Auto Reset
     Event is Waiting

0:003&gt; !handle 5e0 f
Handle 5e0
   Type             Event
   Attributes       0
   GrantedAccess    0x1f0003:
          Delete,ReadControl,WriteDac,WriteOwner,Synch
          QueryState,ModifyState
   HandleCount      2
   PointerCount     32769
   Name             &lt;none&gt;
   Object Specific Information
     Event Type Auto Reset
     Event is Waiting

0:003&gt; !handle 374 f
Handle 374
   Type             Event
   Attributes       0
   GrantedAccess    0x1f0003:
          Delete,ReadControl,WriteDac,WriteOwner,Synch
          QueryState,ModifyState
   HandleCount      2
   PointerCount     32769
   Name             &lt;none&gt;
   Object Specific Information
     Event Type Auto Reset
     Event is Waiting

These events seem to increase, but only one process gets to the limit of
3x00 handles and then the other processes seem to hang ...


On 15/12/2020 12:18, Klaus Westkamp wrote:
&gt;<i> Hi,
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> yes this is Dildale's last available package. Output of squid -v is as 
</I>&gt;<i> follows:
</I>&gt;<i>
</I>&gt;<i> squid -v
</I>&gt;<i>
</I>&gt;<i> Squid Cache: Version 3.5.28
</I>&gt;<i> Service Name: squid
</I>&gt;<i>
</I>&gt;<i> This binary uses OpenSSL 1.0.2j  26 Sep 2016. For legal restrictions on 
</I>&gt;<i> distribution see <A HREF="https://www.openssl.org/source/license.html">https://www.openssl.org/source/license.html</A>
</I>&gt;<i>
</I>&gt;<i> configure options:  '--bindir=/bin/squid' '--sbindir=/usr/sbin/squid' 
</I>&gt;<i> '--sysconfdir=/etc/squid' '--datadir=/usr/share/squid' 
</I>&gt;<i> '--libexecdir=/usr/lib/squid'
</I>&gt;<i> '--disable-strict-error-checking' '--with-logdir=/var/log/squid' 
</I>&gt;<i> '--with-swapdir=/var/cache/squid' '--with-pidfile=/var/run/squid.pid' 
</I>&gt;<i> '--enable-ssl'
</I>&gt;<i> '--enable-delay-pools' '--enable-ssl-crtd' '--enable-icap-client' 
</I>&gt;<i> '--disable-eui' '--localstatedir=/var/run/squid' 
</I>&gt;<i> '--sharedstatedir=/var/run/squid'
</I>&gt;<i> '--datarootdir=/usr/share/squid' 
</I>&gt;<i> '--enable-disk-io=AIO,Blocking,DiskThreads,IpcIo,Mmapped' 
</I>&gt;<i> '--enable-auth-basic=DB,LDAP,NCSA,POP3,RADIUS,SASL,SMB,fake,getpwnam'
</I>&gt;<i> '--enable-auth-ntlm=fake' '--enable-auth-negotiate=kerberos,wrapper' 
</I>&gt;<i> '--enable-external-acl-helpers=LDAP_group,SQL_session,eDirectory_userip,file_userip,kerberos_ldap_group,session,time_quota,unix_group,wbinfo_group'
</I>&gt;<i> '--with-openssl' '--with-filedescriptors=65536' 
</I>&gt;<i> '--enable-removal-policies=lru,heap'
</I>&gt;<i>
</I>&gt;<i> The helper negotiate_kerberos_auth.exe doesn't produce a Version output.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Best regards,
</I>&gt;<i>
</I>&gt;<i> Klaus Westkamp
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> On 15/12/2020 09:10, Amos Jeffries wrote:
</I>&gt;&gt;<i> On 15/12/20 4:03 am, Klaus Westkamp wrote:
</I>&gt;&gt;&gt;<i> Hi,
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> i'm uncertain, wether this mailing list is the correct one to ask, but i 
</I>&gt;&gt;&gt;<i> have the disputable honor to make a squid running on a Windows Server 
</I>&gt;&gt;&gt;<i> (if possible). Whilst squid.exe seems to run fine, i constantly run into 
</I>&gt;&gt;&gt;<i> an unresponsive system, when i enable Kerberos authentication via 
</I>&gt;&gt;&gt;<i> auth_param and the negotiate_kerberos_auth.exe helper.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> For a while authentication works fine, but all at the sudden the system 
</I>&gt;&gt;&gt;<i> hangs at 100% CPU usage. My Observation is that one of the 
</I>&gt;&gt;&gt;<i> negotiate_kerberos_auth.exe processes has a constantly increasing number 
</I>&gt;&gt;&gt;<i> of handles (Files and events). If i understand the Sysinternals handle 
</I>&gt;&gt;&gt;<i> tool correctly, most handles are event corrolated.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> The setting:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Windows 2012 R2 AD Controllers with Windows 2008R2 Domain Level. A 
</I>&gt;&gt;&gt;<i> Windows Server 2016 running Squid 3.5 for Windows.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Is Squid the package built by Diladele or a custom build?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Which exact version number is it? (output of &quot;squid -v&quot; please)
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Amos
</I>&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;<i> squid-users mailing list
</I>&gt;&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>_______________________________________________
squid-users mailing list
<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
<A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A> 



</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="023303.html">[squid-users] Wildcard for url domain
</A></li>
	<LI>Next message (by thread): <A HREF="023301.html">[squid-users] SSL Squid 5 Cipher suite ordering issue
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23297">[ date ]</a>
              <a href="thread.html#23297">[ thread ]</a>
              <a href="subject.html#23297">[ subject ]</a>
              <a href="author.html#23297">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
