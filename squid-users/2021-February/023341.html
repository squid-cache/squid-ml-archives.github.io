<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Why some traffic is TCP_DENIED
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Why%20some%20traffic%20is%20TCP_DENIED&In-Reply-To=%3Cad83ae77-d7b9-d494-abf3-482559803f9c%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="023337.html">
   <LINK REL="Next"  HREF="023344.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Why some traffic is TCP_DENIED</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Why%20some%20traffic%20is%20TCP_DENIED&In-Reply-To=%3Cad83ae77-d7b9-d494-abf3-482559803f9c%40treenet.co.nz%3E"
       TITLE="[squid-users] Why some traffic is TCP_DENIED">squid3 at treenet.co.nz
       </A><BR>
    <I>Tue Feb 16 18:09:37 UTC 2021</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="023337.html">[squid-users] Why some traffic is TCP_DENIED
</A></li>
        <LI>Next message (by thread): <A HREF="023344.html">[squid-users] Data tricking implementation is on ICAP side or Squid side?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23341">[ date ]</a>
              <a href="thread.html#23341">[ thread ]</a>
              <a href="subject.html#23341">[ subject ]</a>
              <a href="author.html#23341">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 16/02/21 11:09 pm, Vieri wrote:
&gt;<i> Hi,
</I>&gt;<i> 
</I>&gt;<i> I'm trying to understand why Squid denies access to some sites, eg:
</I>&gt;<i> 
</I>&gt;<i> [Tue Feb 16 10:15:36 2021].044&#160;&#160;&#160;&#160;&#160; 0 - TCP_DENIED/302 0 GET <A HREF="http://www.microsoft.com/pki/certs/MicRooCerAut2011_2011_03_22.crt">http://www.microsoft.com/pki/certs/MicRooCerAut2011_2011_03_22.crt</A> - HIER_NONE/- text/html
</I>&gt;<i> [Tue Feb 16 10:15:36 2021].050&#160;&#160;&#160;&#160; 46 10.215.248.160 TCP_DENIED/403 3352 - 52.109.12.25:443 - HIER_NONE/- text/html
</I>&gt;<i> [Tue Feb 16 10:15:36 2021].050&#160;&#160;&#160;&#160;&#160; 0 10.215.248.160 NONE_NONE/000 0 - error:transaction-end-before-headers - HIER_NONE/- -
</I>&gt;<i> [Tue Feb 16 10:15:36 2021].052&#160;&#160;&#160; 140 10.215.246.144 TCP_MISS/200 193311 GET <A HREF="https://outlook.office.com/mail/">https://outlook.office.com/mail/</A> - ORIGINAL_DST/52.97.168.210 text/html
</I>&gt;<i> [Tue Feb 16 10:15:36 2021].053&#160;&#160;&#160;&#160; 49 10.215.248.74 TCP_MISS/200 2037 GET <A HREF="https://puk1-collabhubrtc.officeapps.live.com/rtc2/signalr/negotiate?">https://puk1-collabhubrtc.officeapps.live.com/rtc2/signalr/negotiate?</A> - ORIGINAL_DST/52.108.88.1 application/json
</I>&gt;<i> [Tue Feb 16 10:15:36 2021].057&#160;&#160;&#160;&#160;&#160; 0 10.215.247.159 NONE_NONE/000 0 - error:invalid-request - HIER_NONE/- -
</I>&gt;<i> [Tue Feb 16 10:15:36 2021].057&#160;&#160;&#160;&#160;&#160; 0 10.215.247.159 TCP_DENIED/403 3353 - 40.67.251.132:443 - HIER_NONE/- text/html
</I>&gt;<i> [Tue Feb 16 10:15:36 2021].057&#160;&#160;&#160;&#160;&#160; 0 10.215.247.159 NONE_NONE/000 0 - error:transaction-end-before-headers - HIER_NONE/- -
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> If I take the first line in the log and I open the URL from a client I use then the site opens as expected, and the corresponding Squid log is:
</I>&gt;<i> 
</I>&gt;<i> [Tue Feb 16 10:45:50 2021].546&#160;&#160;&#160; 628 10.215.111.210 TCP_MISS/200 2134 GET <A HREF="https://www.microsoft.com/pki/certs/MicRooCerAut2011_2011_03_22.crt">https://www.microsoft.com/pki/certs/MicRooCerAut2011_2011_03_22.crt</A> - ORIGINAL_DST/23.210.36.30 application/octet-stream
</I>&gt;<i> [Tue Feb 16 10:45:52 2021].668&#160;&#160;&#160;&#160; 49 10.215.111.210 NONE_NONE/000 0 CONNECT 216.58.215.138:443 - ORIGINAL_DST/216.58.215.138 -
</I>&gt;<i> 
</I>&gt;<i> In this log I see my host's IP addr. 10.215.111.210.
</I>&gt;<i> However, in the first log I do not see a source IP address. Why?
</I>

Because this is Squid downloading the cert for its own use. For example 
SSL-Bump needing it to complete a TLS cert chain.


&gt;<i> 
</I>&gt;<i> Other clients seem to be denied access with errors in the log such as &quot;NONE_NONE/000&quot;&#160; followed by error:invalid-request or error:transaction-end-before-headers. How can I find out why I get &quot;invalid requests&quot;? Would a tcpdump on the server or client help? Or should I enable verbose debugging in Squid?
</I>
Looking at all these lines together I see;

  * a client TLS connection being intercepted, the server cert chain in 
incomplete.
  * Squid attempts to download the missing cert(s).
  * squid.conf rules force the cert download to get a 302 instead of a 
valid cert.
  * which leaves Squid unable to send the TLS connection client a valid 
cert chain.
  * the client rejects the TLS handshake and disconnects before any HTTP 
happens.


To avoid these, you need to prevent your squid.conf rules generating 
that 302 when Squid is initiating the request. The ACL type 
&quot;transaction_initiator&quot; can be used for that.


Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="023337.html">[squid-users] Why some traffic is TCP_DENIED
</A></li>
	<LI>Next message (by thread): <A HREF="023344.html">[squid-users] Data tricking implementation is on ICAP side or Squid side?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23341">[ date ]</a>
              <a href="thread.html#23341">[ thread ]</a>
              <a href="subject.html#23341">[ subject ]</a>
              <a href="author.html#23341">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
