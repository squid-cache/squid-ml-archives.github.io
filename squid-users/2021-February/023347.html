<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Data tricking implementation is on ICAP side or Squid side?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Data%20tricking%20implementation%20is%20on%20ICAP%20side%20or%0A%20Squid%20side%3F&In-Reply-To=%3C148f433c-ca13-7ed1-f202-01cce657d601%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="023346.html">
   <LINK REL="Next"  HREF="023349.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Data tricking implementation is on ICAP side or Squid side?</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Data%20tricking%20implementation%20is%20on%20ICAP%20side%20or%0A%20Squid%20side%3F&In-Reply-To=%3C148f433c-ca13-7ed1-f202-01cce657d601%40measurement-factory.com%3E"
       TITLE="[squid-users] Data tricking implementation is on ICAP side or Squid side?">rousskov at measurement-factory.com
       </A><BR>
    <I>Thu Feb 18 14:58:27 UTC 2021</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="023346.html">[squid-users] Data tricking implementation is on ICAP side or Squid side?
</A></li>
        <LI>Next message (by thread): <A HREF="023349.html">[squid-users] icap server name lookup
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23347">[ date ]</a>
              <a href="thread.html#23347">[ thread ]</a>
              <a href="subject.html#23347">[ subject ]</a>
              <a href="author.html#23347">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 2/18/21 1:52 AM, John Zhu wrote:

&gt;<i> &#65279;On 2/17/21, 10:28 PM, &quot;Alex Rousskov&quot; wrote:
</I>&gt;<i> 
</I>&gt;<i>     On 2/18/21 12:36 AM, John Zhu wrote:
</I>&gt;<i> 
</I>&gt;<i>     &gt; I have a wired issue. I setup the  Squid and ICAP.   When ICAP (in
</I>&gt;<i>     &gt; RespMod) sends response body (any file types, most of time are large
</I>&gt;<i>     &gt; size files) in a relative slow speed to squid,  if the time elapses
</I>&gt;<i>     &gt; longer than 1 minute, the browser will close the session and fail the
</I>&gt;<i>     &gt; downloading,
</I>&gt;<i> 
</I>&gt;<i>     During that minute, does the browser actually get any HTTP response
</I>&gt;<i>     bytes that the ICAP service sent to Squid? Just the response headers?
</I>&gt;<i>     Nothing at all?
</I>

&gt;<i>     --- Yes, I implemented the data trickling feature at ICAP server side. I can see in the Firefox browser.:
</I>&gt;<i> 1)  prompt to save or open file
</I>&gt;<i> 2)  the progress bar is receiving a few bytes every seconds  
</I>
Please note that my questions were not about the functionality in
general, but the problematic transaction specifically.

If the browser is constantly receiving data during that minute, then it
probably does not timeout. What changes after that minute? You may get
more information from the browser developer console or equivalent. The
browser should log the reason for transaction termination somewhere.


&gt;<i>     &gt; the squid log shows the error of TCP_MISS_ABORTED/206
</I>&gt;<i> 
</I>&gt;<i>     HTTP 206 is Partial Content response to a Range request. Did the origin
</I>&gt;<i>     server respond with an HTTP 206 response? Or did the ICAP server
</I>&gt;<i>     converted an HTTP 200 response into an HTTP 206 response? Or did Squid
</I>&gt;<i>     do that conversion?
</I>
&gt;<i>  -- Yes, sending back to squid from ICAP server 206 partial body data, not the original server.
</I>
Are you sure that the origin server did not send an HTTP 206 response to
Squid? An ICAP server cannot replace an HTTP 200 OK response with an
HTTP 206 response _unless_ the request had a Range header, and even that
theoretically-possible 200-&gt;206 rewrite may not be supported by Squid
today (I have not checked that it is supported).


&gt;<i>     If Squid does the conversion, then perhaps Squid just has no data to
</I>&gt;<i>     send to the client because the requested range has not come from the
</I>&gt;<i>     data trickling ICAP service yet?
</I>&gt;<i> 
</I>&gt;<i> --- What is request range?  Does it put in the header of icap response header?
</I>
To learn about Range requests (and 206 responses to them), please see
RFC 7233: <A HREF="https://tools.ietf.org/html/rfc7233">https://tools.ietf.org/html/rfc7233</A>


&gt;<i> This is the ICAP header back to squid
</I>&gt;<i> ICAP/1.0 200 OK
</I>
We are talking about HTTP headers, not ICAP headers. What HTTP headers
does your service receive and what HTTP headers does your service send back?


Cheers,

Alex.


&gt;<i> Date: Mon, 15 Feb 2021 04:35:37 +0000
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i>     HTH,
</I>&gt;<i> 
</I>&gt;<i>     Alex.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i>     &gt; Here are the configuration.  I am new to squid.  
</I>&gt;<i>     &gt; 
</I>&gt;<i>     &gt;  
</I>&gt;<i>     &gt; 
</I>&gt;<i>     &gt; ==&gt; /usr/local/squid/var/logs/access.log &lt;==
</I>&gt;<i>     &gt; 
</I>&gt;<i>     &gt; 1613593651.769  59962 172.90.1.1 TCP_MISS_ABORTED/206 3635 GET
</I>&gt;<i>     &gt; <A HREF="https://urldefense.com/v3/__https://pfpt-my.sharepoint.com/personal/jzhu_company__;!!ORgEfCBsr282Fw!-GAUSOBJG8F9UUMSLCJJWioLebLx-daFRj1qtCC8n3lXrg-1bD6s1AF2-2wMthz3$">https://urldefense.com/v3/__https://pfpt-my.sharepoint.com/personal/jzhu_company__;!!ORgEfCBsr282Fw!-GAUSOBJG8F9UUMSLCJJWioLebLx-daFRj1qtCC8n3lXrg-1bD6s1AF2-2wMthz3$</A> 
</I>&gt;<i>     &gt; _com/_layouts/15/download.aspx? - HIER_DIRECT/13.107.136.9 application/pdf
</I>&gt;<i>     &gt; 
</I>&gt;<i>     &gt;  
</I>&gt;<i>     &gt; 
</I>&gt;<i>     &gt;  
</I>&gt;<i>     &gt; 
</I>&gt;<i>     &gt; acl SSL_ports port 443
</I>&gt;<i>     &gt; acl Safe_ports port 80    # http
</I>&gt;<i>     &gt; acl Safe_ports port 21    # ftp
</I>&gt;<i>     &gt; acl Safe_ports port 443       # https
</I>&gt;<i>     &gt; acl Safe_ports port 70    # gopher
</I>&gt;<i>     &gt; acl Safe_ports port 210       # wais
</I>&gt;<i>     &gt; acl Safe_ports port 1025-65535 # unregistered ports
</I>&gt;<i>     &gt; acl Safe_ports port 280       # http-mgmt
</I>&gt;<i>     &gt; acl Safe_ports port 488       # gss-http
</I>&gt;<i>     &gt; acl Safe_ports port 591       # filemaker
</I>&gt;<i>     &gt; acl Safe_ports port 777       # multiling http
</I>&gt;<i>     &gt; acl CONNECT method CONNECT
</I>&gt;<i>     &gt; http_access deny !Safe_ports
</I>&gt;<i>     &gt; http_access deny CONNECT !SSL_ports
</I>&gt;<i>     &gt; http_access allow localhost manager
</I>&gt;<i>     &gt; http_access deny manager
</I>&gt;<i>     &gt; http_access allow all
</I>&gt;<i>     &gt; 
</I>&gt;<i>     &gt; # This is to help with the development process only
</I>&gt;<i>     &gt; #cache deny all
</I>&gt;<i>     &gt; 
</I>&gt;<i>     &gt; 
</I>&gt;<i>     &gt; cache_mem 1024 MB
</I>&gt;<i>     &gt; maximum_object_size 200 MB
</I>&gt;<i>     &gt; cache_swap_low 90
</I>&gt;<i>     &gt; cache_swap_high 95
</I>&gt;<i>     &gt; quick_abort_min -1
</I>&gt;<i>     &gt; 
</I>&gt;<i>     &gt; refresh_pattern ^ftp:     1440   20%    10080
</I>&gt;<i>     &gt; refresh_pattern ^gopher:   1440   0% 1440
</I>&gt;<i>     &gt; refresh_pattern -i (/cgi-bin/|\?) 0    0% 0
</I>&gt;<i>     &gt; refresh_pattern (Release|Packages(.gz)*)$      0       20%     2880
</I>&gt;<i>     &gt; refresh_pattern .     0  20%    4320
</I>&gt;<i>     &gt; 
</I>&gt;<i>     &gt; # Docker-compose setup
</I>&gt;<i>     &gt; icap_enable on
</I>&gt;<i>     &gt; icap_io_timeout 600 seconds
</I>&gt;<i>     &gt; icap_connect_timeout 600 seconds
</I>&gt;<i>     &gt; 
</I>&gt;<i>     &gt; icap_service service_req reqmod_precache bypass=1 <A HREF="icap://icapserver:1344/req">icap://icapserver:1344/req</A>
</I>&gt;<i>     &gt; icap_service service_resp respmod_precache bypass=1
</I>&gt;<i>     &gt; <A HREF="icap://icapserver:1344/resp">icap://icapserver:1344/resp</A>
</I>&gt;<i>     &gt; adaptation_access service_req allow all
</I>&gt;<i>     &gt; adaptation_access service_resp allow all
</I>&gt;<i>     &gt; 
</I>&gt;<i>     &gt;  
</I>&gt;<i>     &gt; 
</I>&gt;<i>     &gt;  
</I>&gt;<i>     &gt; 
</I>&gt;<i>     &gt; Thank you all,
</I>&gt;<i>     &gt; 
</I>&gt;<i>     &gt;  
</I>&gt;<i>     &gt; 
</I>&gt;<i>     &gt; John Zhu
</I>&gt;<i>     &gt; 
</I>&gt;<i>     &gt;  
</I>&gt;<i>     &gt; 
</I>&gt;<i>     &gt; 
</I>&gt;<i>     &gt; _______________________________________________
</I>&gt;<i>     &gt; squid-users mailing list
</I>&gt;<i>     &gt; <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i>     &gt; <A HREF="https://urldefense.com/v3/__http://lists.squid-cache.org/listinfo/squid-users__;!!ORgEfCBsr282Fw!-GAUSOBJG8F9UUMSLCJJWioLebLx-daFRj1qtCC8n3lXrg-1bD6s1AF2-5jdkNI7$">https://urldefense.com/v3/__http://lists.squid-cache.org/listinfo/squid-users__;!!ORgEfCBsr282Fw!-GAUSOBJG8F9UUMSLCJJWioLebLx-daFRj1qtCC8n3lXrg-1bD6s1AF2-5jdkNI7$</A> 
</I>&gt;<i>     &gt; 
</I>&gt;<i> 
</I>&gt;<i> 
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="023346.html">[squid-users] Data tricking implementation is on ICAP side or Squid side?
</A></li>
	<LI>Next message (by thread): <A HREF="023349.html">[squid-users] icap server name lookup
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23347">[ date ]</a>
              <a href="thread.html#23347">[ thread ]</a>
              <a href="subject.html#23347">[ subject ]</a>
              <a href="author.html#23347">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
