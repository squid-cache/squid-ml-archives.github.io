<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] My cache gived me a content-length of 0, and a 200 TCP_REFRESH_UNMODIFIED_ABORTED
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20My%20cache%20gived%20me%20a%20content-length%20of%200%2C%0A%20and%20a%20200%20TCP_REFRESH_UNMODIFIED_ABORTED&In-Reply-To=%3C75628d37-14c8-629a-2c87-13d0030824fb%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="023364.html">
   <LINK REL="Next"  HREF="023367.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] My cache gived me a content-length of 0, and a 200 TCP_REFRESH_UNMODIFIED_ABORTED</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20My%20cache%20gived%20me%20a%20content-length%20of%200%2C%0A%20and%20a%20200%20TCP_REFRESH_UNMODIFIED_ABORTED&In-Reply-To=%3C75628d37-14c8-629a-2c87-13d0030824fb%40treenet.co.nz%3E"
       TITLE="[squid-users] My cache gived me a content-length of 0, and a 200 TCP_REFRESH_UNMODIFIED_ABORTED">squid3 at treenet.co.nz
       </A><BR>
    <I>Wed Feb 24 14:43:43 UTC 2021</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="023364.html">[squid-users] My cache gived me a content-length of 0, and a 200 TCP_REFRESH_UNMODIFIED_ABORTED
</A></li>
        <LI>Next message (by thread): <A HREF="023367.html">[squid-users] My cache gived me a content-length of 0, and a 200 TCP_REFRESH_UNMODIFIED_ABORTED
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23366">[ date ]</a>
              <a href="thread.html#23366">[ thread ]</a>
              <a href="subject.html#23366">[ subject ]</a>
              <a href="author.html#23366">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 25/02/21 12:50 am, Se&#241;or J Onion wrote:
&gt;<i> I am new to Squid, I have been trying to get this to work for almost two weeks now, and have found nothing in the archives.
</I>&gt;<i> 
</I>&gt;<i> This is my curl command (you will get a 403 forbidden by the time you run this dear reader):
</I>&gt;<i> 
</I>&gt;<i> curl -s -D - -o /dev/null -G -d &quot;alt=media&quot; -x &quot;<A HREF="http://localhost:3128">http://localhost:3128</A>&quot; <A HREF="http://storage.googleapis.com/omgimg.appspot.com/test.jpeg">http://storage.googleapis.com/omgimg.appspot.com/test.jpeg</A> -H &quot;host:storage.googleapis.com&quot; -H &quot;x-amz-content-sha256:e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855&quot; -H &quot;x-amz-date:20210224T111631Z&quot; -H &quot;authorization:AWS4-HMAC-SHA256 Credential=GOOG1EGG4VCQ2EVRCJ2JCIO7ZDSZ3CY45Q72ATYZU2P32HITBFUOVQ6TEBWXI/20210224/auto/s3/aws4_request, SignedHeaders=host;x-amz-content-sha256;x-amz-date, Signature=77a60480e47dda2b65ef3ebcd72a032458685e74e2560bb9083dbb03c3f6c13d&#8221;
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> These are the HTTP response headers:
</I>&gt;<i> 
</I>
Actually these are *half* the response headers. There are also the 
response headers received y Squid from the server.

The key details to explain your problem are in those other 
request-response headers going between Squid and server.


&gt;<i> 
</I>&gt;<i> FIRST RUN:
</I>&gt;<i> 
</I>&gt;<i> HTTP/1.1 200 OK
</I>&gt;<i> X-GUploader-UploadID: ABg5-UwzmWjdWRPkonOxhLl3rUUik6wN3MB_ME1w1pxS5Rtmp_Cl1AAiP5G3tA9oXpFfAMnLCn5Pb8VW1mioc6GI-wJDun1S_g
</I>&gt;<i> Expires: Wed, 24 Feb 2021 11:20:08 GMT
</I>&gt;<i> Date: Wed, 24 Feb 2021 11:20:08 GMT
</I>&gt;<i> Cache-Control: private, max-age=0
</I>&gt;<i> Last-Modified: Tue, 04 Aug 2020 12:09:00 GMT
</I>
First clue:
   This object is not allowed to be cached. If a modern Squid is forced 
to cache anyway, the server will be checked for updates before it is 
delivered anywhere.


&gt;<i> ETag: &quot;d5b65c332fb6f80a0eade692b40b4afd&quot;
</I>&gt;<i> Content-Type: image/jpeg
</I>&gt;<i> x-goog-hash: crc32c=6ijxaQ==
</I>&gt;<i> x-goog-hash: md5=1bZcMy+2+AoOreaStAtK/Q==
</I>&gt;<i> x-goog-storage-class: STANDARD
</I>&gt;<i> Accept-Ranges: bytes
</I>&gt;<i> Content-Length: 2296040
</I>&gt;<i> Server: UploadServer
</I>&gt;<i> X-Cache: MISS from 80396e157a13
</I>&gt;<i> X-Cache-Lookup: MISS from 80396e157a13:3128
</I>&gt;<i> Via: 1.1 80396e157a13 (squid/3.5.27)
</I>&gt;<i> Connection: keep-alive
</I>&gt;<i> 
</I>&gt;<i> Squid log: 200 2296721 TCP_MISS:HIER_DIRECT
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> SECOND RUN:
</I>&gt;<i> 
</I>&gt;<i> HTTP/1.1 200 OK
</I>&gt;<i> Content-Type: image/jpeg
</I>&gt;<i> x-goog-hash: crc32c=6ijxaQ==
</I>&gt;<i> x-goog-hash: md5=1bZcMy+2+AoOreaStAtK/Q==
</I>&gt;<i> x-goog-storage-class: STANDARD
</I>&gt;<i> Accept-Ranges: bytes
</I>&gt;<i> X-GUploader-UploadID: ABg5-UzooDZGnVTXxGIWQ2i25EasnR3glFz41FfUFvclACmZb3iDccpSXsGbRH0cr-8lofOc6Wb3knUzYMTgj_wdrzo
</I>&gt;<i> Expires: Wed, 24 Feb 2021 11:20:17 GMT
</I>&gt;<i> Date: Wed, 24 Feb 2021 11:20:17 GMT
</I>&gt;<i> Cache-Control: private, max-age=0
</I>&gt;<i> Last-Modified: Tue, 04 Aug 2020 12:09:00 GMT
</I>&gt;<i> ETag: &quot;d5b65c332fb6f80a0eade692b40b4afd&quot;
</I>&gt;<i> Content-Length: 0
</I>&gt;<i> Server: UploadServer
</I>&gt;<i> Age: 0
</I>&gt;<i> X-Cache: HIT from 80396e157a13
</I>&gt;<i> X-Cache-Lookup: HIT from 80396e157a13:3128
</I>&gt;<i> Via: 1.1 80396e157a13 (squid/3.5.27)
</I>&gt;<i> Connection: keep-alive
</I>&gt;<i> 
</I>&gt;<i> Squid log: 200 651397 TCP_REFRESH_UNMODIFIED_ABORTED:HIER_DIRECT
</I>&gt;<i> 
</I>
Second clue is the REFRESH and UNMODIFIED tags. Squid revalidated with 
the server. The server said no changes happened beyond some headers.

Third clue(s) are the differences in headers between first and second 
responses to the client.

X-Cache, Via, Age, and Connection are generated by Squid. So ignore those.

The remainder of headers are from the server. The second reply is the 
HIT object with header changes provided in the servers 304 message.
  Expires, Date, X-GUploader-UploadID, and Content-Length changed.


&gt;<i> 
</I>&gt;<i> I don&#8217;t know why the second time round, I a) don&#8217;t get a HIT, and b) why my content-length is 0.
</I>&gt;<i> 
</I>

Because the server told Squid the objects length has become 0 bytes.

&lt;<A HREF="https://bugs.squid-cache.org/show_bug.cgi?id=4882#c11">https://bugs.squid-cache.org/show_bug.cgi?id=4882#c11</A>&gt; has some more 
details.

The very latest HTTP specification text has made it even clearer:

&quot;
    For messages that do not include content, the
    Content-Length indicates the size of the selected representation
&quot;

&quot;
   Any response ... 304 (Not Modified) status
   code is always terminated by the first empty line after the
   header fields, regardless of the header fields present in the
   message, and thus cannot contain a message body or trailer
   section(s).
&quot;


The 'selected representation' is being the object that was cached.

Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="023364.html">[squid-users] My cache gived me a content-length of 0, and a 200 TCP_REFRESH_UNMODIFIED_ABORTED
</A></li>
	<LI>Next message (by thread): <A HREF="023367.html">[squid-users] My cache gived me a content-length of 0, and a 200 TCP_REFRESH_UNMODIFIED_ABORTED
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23366">[ date ]</a>
              <a href="thread.html#23366">[ thread ]</a>
              <a href="subject.html#23366">[ subject ]</a>
              <a href="author.html#23366">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
