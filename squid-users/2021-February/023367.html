<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] My cache gived me a content-length of 0, and a 200 TCP_REFRESH_UNMODIFIED_ABORTED
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20My%20cache%20gived%20me%20a%20content-length%20of%200%2C%0A%20and%20a%20200%20TCP_REFRESH_UNMODIFIED_ABORTED&In-Reply-To=%3C18BA9F8E-8C4E-4F4B-9799-6394299DD40A%40gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="023366.html">
   <LINK REL="Next"  HREF="023369.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] My cache gived me a content-length of 0, and a 200 TCP_REFRESH_UNMODIFIED_ABORTED</H1>
    <B>Se&#241;or J Onion</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20My%20cache%20gived%20me%20a%20content-length%20of%200%2C%0A%20and%20a%20200%20TCP_REFRESH_UNMODIFIED_ABORTED&In-Reply-To=%3C18BA9F8E-8C4E-4F4B-9799-6394299DD40A%40gmail.com%3E"
       TITLE="[squid-users] My cache gived me a content-length of 0, and a 200 TCP_REFRESH_UNMODIFIED_ABORTED">senor.j.onion at gmail.com
       </A><BR>
    <I>Wed Feb 24 15:45:43 UTC 2021</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="023366.html">[squid-users] My cache gived me a content-length of 0, and a 200 TCP_REFRESH_UNMODIFIED_ABORTED
</A></li>
        <LI>Next message (by thread): <A HREF="023369.html">[squid-users] My cache gived me a content-length of 0, and a 200 TCP_REFRESH_UNMODIFIED_ABORTED
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23367">[ date ]</a>
              <a href="thread.html#23367">[ thread ]</a>
              <a href="subject.html#23367">[ subject ]</a>
              <a href="author.html#23367">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Thanks Amos - that&#8217;s a very kind and thorough explanation.

Ok - I understand why the content-length is 0 as the server responded with a 304. Gotcha. Squid in response responds with a 200.

And I also understand why it is a REFRESH because the server responded saying that it should not cache. (As a side note - I don&#8217;t understand what these directives do then: ignore-no-cache ignore-no-store ignore-must-revalidate ignore-private)

What isn&#8217;t clear to me then is whether Squid actually returns the cached image? (content-length being 0).

The reason being, is that I am using Squid between my server and AWS S3 (or Google Storage)

The first time I call my nodejs code to fetch the image from S3 (via the proxy) it works.
The second time I call my nodejs code to fetch the image from S3, it fails. (Same Squid logs - instead of curl I am using nodejs code)

My nodejs code fails with an HTTP Parse error (HPE_INVALID_CONSTANT). My guess is that the response from Squid  is malformed. My guess is that the response is empty. Or that the image is in the response, but the content-length 0 causes the nodejs HTTP response parser to fail.

I don&#8217;t understand why my code behaves differently when it is receiving the image for the first time, and when it is receiving the cached image.

&gt;<i> On 24 Feb 2021, at 13:50, Se&#241;or J Onion &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">senor.j.onion at gmail.com</A>&gt; wrote:
</I>&gt;<i> 
</I>&gt;<i> I am new to Squid, I have been trying to get this to work for almost two weeks now, and have found nothing in the archives.
</I>&gt;<i> 
</I>&gt;<i> This is my curl command (you will get a 403 forbidden by the time you run this dear reader):
</I>&gt;<i> 
</I>&gt;<i> curl -s -D - -o /dev/null -G -d &quot;alt=media&quot; -x &quot;<A HREF="http://localhost:3128">http://localhost:3128</A>&quot; <A HREF="http://storage.googleapis.com/omgimg.appspot.com/test.jpeg">http://storage.googleapis.com/omgimg.appspot.com/test.jpeg</A> -H &quot;host:storage.googleapis.com&quot; -H &quot;x-amz-content-sha256:e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855&quot; -H &quot;x-amz-date:20210224T111631Z&quot; -H &quot;authorization:AWS4-HMAC-SHA256 Credential=GOOG1EGG4VCQ2EVRCJ2JCIO7ZDSZ3CY45Q72ATYZU2P32HITBFUOVQ6TEBWXI/20210224/auto/s3/aws4_request, SignedHeaders=host;x-amz-content-sha256;x-amz-date, Signature=77a60480e47dda2b65ef3ebcd72a032458685e74e2560bb9083dbb03c3f6c13d&#8221;
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> These are the HTTP response headers:
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> FIRST RUN:
</I>&gt;<i> 
</I>&gt;<i> HTTP/1.1 200 OK
</I>&gt;<i> X-GUploader-UploadID: ABg5-UwzmWjdWRPkonOxhLl3rUUik6wN3MB_ME1w1pxS5Rtmp_Cl1AAiP5G3tA9oXpFfAMnLCn5Pb8VW1mioc6GI-wJDun1S_g
</I>&gt;<i> Expires: Wed, 24 Feb 2021 11:20:08 GMT
</I>&gt;<i> Date: Wed, 24 Feb 2021 11:20:08 GMT
</I>&gt;<i> Cache-Control: private, max-age=0
</I>&gt;<i> Last-Modified: Tue, 04 Aug 2020 12:09:00 GMT
</I>&gt;<i> ETag: &quot;d5b65c332fb6f80a0eade692b40b4afd&quot;
</I>&gt;<i> Content-Type: image/jpeg
</I>&gt;<i> x-goog-hash: crc32c=6ijxaQ==
</I>&gt;<i> x-goog-hash: md5=1bZcMy+2+AoOreaStAtK/Q==
</I>&gt;<i> x-goog-storage-class: STANDARD
</I>&gt;<i> Accept-Ranges: bytes
</I>&gt;<i> Content-Length: 2296040
</I>&gt;<i> Server: UploadServer
</I>&gt;<i> X-Cache: MISS from 80396e157a13
</I>&gt;<i> X-Cache-Lookup: MISS from 80396e157a13:3128
</I>&gt;<i> Via: 1.1 80396e157a13 (squid/3.5.27)
</I>&gt;<i> Connection: keep-alive
</I>&gt;<i> 
</I>&gt;<i> Squid log: 200 2296721 TCP_MISS:HIER_DIRECT
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> SECOND RUN:
</I>&gt;<i> 
</I>&gt;<i> HTTP/1.1 200 OK
</I>&gt;<i> Content-Type: image/jpeg
</I>&gt;<i> x-goog-hash: crc32c=6ijxaQ==
</I>&gt;<i> x-goog-hash: md5=1bZcMy+2+AoOreaStAtK/Q==
</I>&gt;<i> x-goog-storage-class: STANDARD
</I>&gt;<i> Accept-Ranges: bytes
</I>&gt;<i> X-GUploader-UploadID: ABg5-UzooDZGnVTXxGIWQ2i25EasnR3glFz41FfUFvclACmZb3iDccpSXsGbRH0cr-8lofOc6Wb3knUzYMTgj_wdrzo
</I>&gt;<i> Expires: Wed, 24 Feb 2021 11:20:17 GMT
</I>&gt;<i> Date: Wed, 24 Feb 2021 11:20:17 GMT
</I>&gt;<i> Cache-Control: private, max-age=0
</I>&gt;<i> Last-Modified: Tue, 04 Aug 2020 12:09:00 GMT
</I>&gt;<i> ETag: &quot;d5b65c332fb6f80a0eade692b40b4afd&quot;
</I>&gt;<i> Content-Length: 0
</I>&gt;<i> Server: UploadServer
</I>&gt;<i> Age: 0
</I>&gt;<i> X-Cache: HIT from 80396e157a13
</I>&gt;<i> X-Cache-Lookup: HIT from 80396e157a13:3128
</I>&gt;<i> Via: 1.1 80396e157a13 (squid/3.5.27)
</I>&gt;<i> Connection: keep-alive
</I>&gt;<i> 
</I>&gt;<i> Squid log: 200 651397 TCP_REFRESH_UNMODIFIED_ABORTED:HIER_DIRECT
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> I don&#8217;t know why the second time round, I a) don&#8217;t get a HIT, and b) why my content-length is 0.
</I>&gt;<i> 
</I>&gt;<i> I think - this is the reason why - when I make these same calls in nodejs I end up with an HTTP Parse error (HPE_INVALID_CONSTANT).
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> My squid.conf file looks like this:
</I>&gt;<i> 
</I>&gt;<i> acl localnet src 0.0.0.1-0.255.255.255
</I>&gt;<i> acl localnet src 10.0.0.0/8
</I>&gt;<i> acl localnet src 100.64.0.0/10
</I>&gt;<i> acl localnet src 169.254.0.0/16
</I>&gt;<i> acl localnet src 172.16.0.0/12
</I>&gt;<i> acl localnet src 192.168.0.0/16
</I>&gt;<i> acl localnet src fc00::/7
</I>&gt;<i> acl localnet src fe80::/10
</I>&gt;<i> 
</I>&gt;<i> acl SSL_ports port 443
</I>&gt;<i> acl Safe_ports port 80
</I>&gt;<i> acl Safe_ports port 443
</I>&gt;<i> 
</I>&gt;<i> acl Connect_ports port 80
</I>&gt;<i> acl Connect_ports port 443
</I>&gt;<i> 
</I>&gt;<i> acl CONNECT method CONNECT
</I>&gt;<i> 
</I>&gt;<i> http_access deny !Safe_ports
</I>&gt;<i> 
</I>&gt;<i> http_access deny CONNECT !Connect_ports
</I>&gt;<i> 
</I>&gt;<i> http_access allow localhost manager
</I>&gt;<i> http_access deny manager
</I>&gt;<i> 
</I>&gt;<i> http_access deny to_localhost
</I>&gt;<i> 
</I>&gt;<i> http_access allow localnet
</I>&gt;<i> http_access allow localhost
</I>&gt;<i> 
</I>&gt;<i> http_access deny all
</I>&gt;<i> 
</I>&gt;<i> strip_query_terms off
</I>&gt;<i> refresh_pattern . 525600 100% 525600 override-expire override-lastmod ignore-reload ignore-no-cache ignore-no-store reload-into-ims ignore-must-revalidate ignore-private ignore-auth store-stale
</I>&gt;<i> 
</I>&gt;<i> cache_mem 2500 MB
</I>&gt;<i> maximum_object_size_in_memory 100 MB
</I>&gt;<i> memory_cache_mode always
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Any direction would be greatly appreciated!
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="023366.html">[squid-users] My cache gived me a content-length of 0, and a 200 TCP_REFRESH_UNMODIFIED_ABORTED
</A></li>
	<LI>Next message (by thread): <A HREF="023369.html">[squid-users] My cache gived me a content-length of 0, and a 200 TCP_REFRESH_UNMODIFIED_ABORTED
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23367">[ date ]</a>
              <a href="thread.html#23367">[ thread ]</a>
              <a href="subject.html#23367">[ subject ]</a>
              <a href="author.html#23367">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
