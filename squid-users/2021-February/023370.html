<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] My cache gived me a content-length of 0, and a 200 TCP_REFRESH_UNMODIFIED_ABORTED
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20My%20cache%20gived%20me%20a%20content-length%20of%200%2C%0A%20and%20a%20200%20TCP_REFRESH_UNMODIFIED_ABORTED&In-Reply-To=%3Ca41d7491-3fe7-57f9-5465-de3bca7df24d%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="023369.html">
   <LINK REL="Next"  HREF="023368.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] My cache gived me a content-length of 0, and a 200 TCP_REFRESH_UNMODIFIED_ABORTED</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20My%20cache%20gived%20me%20a%20content-length%20of%200%2C%0A%20and%20a%20200%20TCP_REFRESH_UNMODIFIED_ABORTED&In-Reply-To=%3Ca41d7491-3fe7-57f9-5465-de3bca7df24d%40measurement-factory.com%3E"
       TITLE="[squid-users] My cache gived me a content-length of 0, and a 200 TCP_REFRESH_UNMODIFIED_ABORTED">rousskov at measurement-factory.com
       </A><BR>
    <I>Thu Feb 25 17:49:55 UTC 2021</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="023369.html">[squid-users] My cache gived me a content-length of 0, and a 200 TCP_REFRESH_UNMODIFIED_ABORTED
</A></li>
        <LI>Next message (by thread): <A HREF="023368.html">[squid-users] Problem with upload size limit in squid
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23370">[ date ]</a>
              <a href="thread.html#23370">[ thread ]</a>
              <a href="subject.html#23370">[ subject ]</a>
              <a href="author.html#23370">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 2/24/21 10:45 AM, Se&#241;or J Onion wrote:

&gt;<i> I don&#8217;t understand why my code behaves differently when it is
</I>&gt;<i> receiving the image for the first time, and when it is receiving the
</I>&gt;<i> cached image.
</I>
What you see is a result of two bugs.

* An origin server bug: During the second transaction, when Squid asks
the server whether there are any updates for the object cached during
the first transaction, the origin server lies to Squid about the changed
size of the object. The origin server gives Squid two contradictory
statements: &quot;the object you cached has not changed at all (its strong
ETag remains the same)&quot; and &quot;the size of the object you cached has
changed (to zero)&quot;.

* A Squid bug or deficiency: Squid should detect an inconsistent server
response and, instead of serving the cached object with lying headers,
Squid should remove the cached object and request a fresh one (a cache
miss due to revalidation failure). Optionally, as an admin-authorized
&quot;optimization&quot;, Squid can ignore the Content-Length field in the buggy
origin server response and serve a hit with other updated headers.

This is a known problem but nobody has volunteered to address it yet.

For workarounds, see <A HREF="https://bugs.squid-cache.org/show_bug.cgi?id=4882#c14">https://bugs.squid-cache.org/show_bug.cgi?id=4882#c14</A>


HTH,

Alex.


&gt;&gt;<i> On 24 Feb 2021, at 13:50, Se&#241;or J Onion &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">senor.j.onion at gmail.com</A>&gt; wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I am new to Squid, I have been trying to get this to work for almost two weeks now, and have found nothing in the archives.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> This is my curl command (you will get a 403 forbidden by the time you run this dear reader):
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> curl -s -D - -o /dev/null -G -d &quot;alt=media&quot; -x &quot;<A HREF="http://localhost:3128">http://localhost:3128</A>&quot; <A HREF="http://storage.googleapis.com/omgimg.appspot.com/test.jpeg">http://storage.googleapis.com/omgimg.appspot.com/test.jpeg</A> -H &quot;host:storage.googleapis.com&quot; -H &quot;x-amz-content-sha256:e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855&quot; -H &quot;x-amz-date:20210224T111631Z&quot; -H &quot;authorization:AWS4-HMAC-SHA256 Credential=GOOG1EGG4VCQ2EVRCJ2JCIO7ZDSZ3CY45Q72ATYZU2P32HITBFUOVQ6TEBWXI/20210224/auto/s3/aws4_request, SignedHeaders=host;x-amz-content-sha256;x-amz-date, Signature=77a60480e47dda2b65ef3ebcd72a032458685e74e2560bb9083dbb03c3f6c13d&#8221;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> These are the HTTP response headers:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> FIRST RUN:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> HTTP/1.1 200 OK
</I>&gt;&gt;<i> X-GUploader-UploadID: ABg5-UwzmWjdWRPkonOxhLl3rUUik6wN3MB_ME1w1pxS5Rtmp_Cl1AAiP5G3tA9oXpFfAMnLCn5Pb8VW1mioc6GI-wJDun1S_g
</I>&gt;&gt;<i> Expires: Wed, 24 Feb 2021 11:20:08 GMT
</I>&gt;&gt;<i> Date: Wed, 24 Feb 2021 11:20:08 GMT
</I>&gt;&gt;<i> Cache-Control: private, max-age=0
</I>&gt;&gt;<i> Last-Modified: Tue, 04 Aug 2020 12:09:00 GMT
</I>&gt;&gt;<i> ETag: &quot;d5b65c332fb6f80a0eade692b40b4afd&quot;
</I>&gt;&gt;<i> Content-Type: image/jpeg
</I>&gt;&gt;<i> x-goog-hash: crc32c=6ijxaQ==
</I>&gt;&gt;<i> x-goog-hash: md5=1bZcMy+2+AoOreaStAtK/Q==
</I>&gt;&gt;<i> x-goog-storage-class: STANDARD
</I>&gt;&gt;<i> Accept-Ranges: bytes
</I>&gt;&gt;<i> Content-Length: 2296040
</I>&gt;&gt;<i> Server: UploadServer
</I>&gt;&gt;<i> X-Cache: MISS from 80396e157a13
</I>&gt;&gt;<i> X-Cache-Lookup: MISS from 80396e157a13:3128
</I>&gt;&gt;<i> Via: 1.1 80396e157a13 (squid/3.5.27)
</I>&gt;&gt;<i> Connection: keep-alive
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Squid log: 200 2296721 TCP_MISS:HIER_DIRECT
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> SECOND RUN:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> HTTP/1.1 200 OK
</I>&gt;&gt;<i> Content-Type: image/jpeg
</I>&gt;&gt;<i> x-goog-hash: crc32c=6ijxaQ==
</I>&gt;&gt;<i> x-goog-hash: md5=1bZcMy+2+AoOreaStAtK/Q==
</I>&gt;&gt;<i> x-goog-storage-class: STANDARD
</I>&gt;&gt;<i> Accept-Ranges: bytes
</I>&gt;&gt;<i> X-GUploader-UploadID: ABg5-UzooDZGnVTXxGIWQ2i25EasnR3glFz41FfUFvclACmZb3iDccpSXsGbRH0cr-8lofOc6Wb3knUzYMTgj_wdrzo
</I>&gt;&gt;<i> Expires: Wed, 24 Feb 2021 11:20:17 GMT
</I>&gt;&gt;<i> Date: Wed, 24 Feb 2021 11:20:17 GMT
</I>&gt;&gt;<i> Cache-Control: private, max-age=0
</I>&gt;&gt;<i> Last-Modified: Tue, 04 Aug 2020 12:09:00 GMT
</I>&gt;&gt;<i> ETag: &quot;d5b65c332fb6f80a0eade692b40b4afd&quot;
</I>&gt;&gt;<i> Content-Length: 0
</I>&gt;&gt;<i> Server: UploadServer
</I>&gt;&gt;<i> Age: 0
</I>&gt;&gt;<i> X-Cache: HIT from 80396e157a13
</I>&gt;&gt;<i> X-Cache-Lookup: HIT from 80396e157a13:3128
</I>&gt;&gt;<i> Via: 1.1 80396e157a13 (squid/3.5.27)
</I>&gt;&gt;<i> Connection: keep-alive
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Squid log: 200 651397 TCP_REFRESH_UNMODIFIED_ABORTED:HIER_DIRECT
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I don&#8217;t know why the second time round, I a) don&#8217;t get a HIT, and b) why my content-length is 0.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I think - this is the reason why - when I make these same calls in nodejs I end up with an HTTP Parse error (HPE_INVALID_CONSTANT).
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> My squid.conf file looks like this:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> acl localnet src 0.0.0.1-0.255.255.255
</I>&gt;&gt;<i> acl localnet src 10.0.0.0/8
</I>&gt;&gt;<i> acl localnet src 100.64.0.0/10
</I>&gt;&gt;<i> acl localnet src 169.254.0.0/16
</I>&gt;&gt;<i> acl localnet src 172.16.0.0/12
</I>&gt;&gt;<i> acl localnet src 192.168.0.0/16
</I>&gt;&gt;<i> acl localnet src fc00::/7
</I>&gt;&gt;<i> acl localnet src fe80::/10
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> acl SSL_ports port 443
</I>&gt;&gt;<i> acl Safe_ports port 80
</I>&gt;&gt;<i> acl Safe_ports port 443
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> acl Connect_ports port 80
</I>&gt;&gt;<i> acl Connect_ports port 443
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> acl CONNECT method CONNECT
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> http_access deny !Safe_ports
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> http_access deny CONNECT !Connect_ports
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> http_access allow localhost manager
</I>&gt;&gt;<i> http_access deny manager
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> http_access deny to_localhost
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> http_access allow localnet
</I>&gt;&gt;<i> http_access allow localhost
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> http_access deny all
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> strip_query_terms off
</I>&gt;&gt;<i> refresh_pattern . 525600 100% 525600 override-expire override-lastmod ignore-reload ignore-no-cache ignore-no-store reload-into-ims ignore-must-revalidate ignore-private ignore-auth store-stale
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> cache_mem 2500 MB
</I>&gt;&gt;<i> maximum_object_size_in_memory 100 MB
</I>&gt;&gt;<i> memory_cache_mode always
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Any direction would be greatly appreciated!
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i> 
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="023369.html">[squid-users] My cache gived me a content-length of 0, and a 200 TCP_REFRESH_UNMODIFIED_ABORTED
</A></li>
	<LI>Next message (by thread): <A HREF="023368.html">[squid-users] Problem with upload size limit in squid
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23370">[ date ]</a>
              <a href="thread.html#23370">[ thread ]</a>
              <a href="subject.html#23370">[ subject ]</a>
              <a href="author.html#23370">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
