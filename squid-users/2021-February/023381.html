<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid ACL for bypassing ssl-bump
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20ACL%20for%20bypassing%20ssl-bump&In-Reply-To=%3CCAGEc96k5jF3y9_caFNVMDnZYmO3MRw7Og9rbDFH2xoK1_yRgDA%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="023379.html">
   <LINK REL="Next"  HREF="023383.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid ACL for bypassing ssl-bump</H1>
    <B>Justin Michael Schwartzbeck</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20ACL%20for%20bypassing%20ssl-bump&In-Reply-To=%3CCAGEc96k5jF3y9_caFNVMDnZYmO3MRw7Og9rbDFH2xoK1_yRgDA%40mail.gmail.com%3E"
       TITLE="[squid-users] Squid ACL for bypassing ssl-bump">justinmschw at gmail.com
       </A><BR>
    <I>Fri Feb 26 17:45:01 UTC 2021</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="023379.html">[squid-users] Squid ACL for bypassing ssl-bump
</A></li>
        <LI>Next message (by thread): <A HREF="023383.html">[squid-users] Squid ACL for bypassing ssl-bump
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23381">[ date ]</a>
              <a href="thread.html#23381">[ thread ]</a>
              <a href="subject.html#23381">[ subject ]</a>
              <a href="author.html#23381">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Thanks for your answers Alex.

For case 1, I understand that should not be a problem, since squid is the
one asking for DNS resolution.
For case 2 and 3, what you are saying is that the browser is requesting the
DNS lookup first, correct? Hence the need for a reverse DNS from squid,
since squid does not know at that point what domain the IP belongs to. But
they still had to query the DNS server, so that entry is in that DNS cache,
and it should have the same domain as the lookup that the user entered.

So if I have a local dns (maybe dnsmasq) that both squid and the user use,
from what I understand I should be able to use squid's dns_nameservers
directive to point to that DNS, and it should return fine since it is
stored right there in the cache.

If the user is trying to use a different DNS server other than the local
one, then fine, I will just decrypt their traffic as punishment. &#128513;

On Fri, Feb 26, 2021 at 9:44 AM Alex Rousskov &lt;
<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt; wrote:

&gt;<i> On 2/26/21 7:35 AM, Justin Michael Schwartzbeck wrote:
</I>&gt;<i> &gt;&gt; Yes, many HTTPS transactions do not expose destination domain until it
</I>&gt;<i> &gt;&gt; is too late to decide whether to bump them, and reverse DNS lookups are
</I>&gt;<i> &gt;&gt; often unreliable.
</I>&gt;<i>
</I>&gt;<i> &gt; I wonder why this would be.
</I>&gt;<i>
</I>&gt;<i> I suspect you assume that a forward DNS lookup (A or AAAA query) answer
</I>&gt;<i> is always the &quot;opposite&quot; of a reverse DSN lookup (PTR query) answer.
</I>&gt;<i> AFAIK, that is not how DNS is defined. From DNS point of view, each of
</I>&gt;<i> those answers is totally independent -- there is no 1:1 or even 1:N
</I>&gt;<i> mapping between them; the answers even come from different DNS zones!  A
</I>&gt;<i> caching DNS resolver would probably violate the DNS protocol if it uses
</I>&gt;<i> a cached A or AAAA record to answer a PTR query. Disclaimer: I am not a
</I>&gt;<i> DNS expert.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; From my understanding, when you open a
</I>&gt;<i> &gt; browser and browse to www.google.com, the very
</I>&gt;<i> &gt; first thing that happens is you do a DNS resolution so that you know
</I>&gt;<i> &gt; what IP to send the CONNECT request and subsequent HTTPS records in the
</I>&gt;<i> &gt; first place.
</I>&gt;<i>
</I>&gt;<i> What happens depends on the browser and the proxy port:
</I>&gt;<i>
</I>&gt;<i> 1. For forward proxies: Some browsers will not do DNS lookups. They will
</I>&gt;<i> send a CONNECT request to example.com, allowing Squid to do the DNS
</I>&gt;<i> lookup. In this case, Squid dstdomain configured with a host name will
</I>&gt;<i> work well.
</I>&gt;<i>
</I>&gt;<i> 2. For forward proxies: Some browsers do DNS lookups. They will send a
</I>&gt;<i> CONNECT request to one of the returned IP addresses.
</I>&gt;<i>
</I>&gt;<i> 3. For interception proxies: All browsers do DNS lookups. They open a
</I>&gt;<i> TCP connection to one of the returned IP addresses.
</I>&gt;<i>
</I>&gt;<i> In cases 2 and 3, Squid dstdomain will have to do a reverse DNS lookup
</I>&gt;<i> (PTR query). In many cases, that lookup either fails or returns a
</I>&gt;<i> different domain name than the domain the browser started with.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> HTH,
</I>&gt;<i>
</I>&gt;<i> Alex.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; So we would have the IP already, and the hostname that was
</I>&gt;<i> &gt; looked up already in the DNS cache, right? Why wouldn't squid just be
</I>&gt;<i> &gt; able to reach in there, match the IP that DNS returned, and then pull
</I>&gt;<i> &gt; that hostname out to compare against the ACLs?
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; On Thu, Feb 25, 2021 at 2:57 PM Alex Rousskov
</I>&gt;<i> &gt; &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>
</I>&gt;<i> &gt; &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt;&gt; wrote:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     On 2/25/21 2:07 PM, Justin Michael Schwartzbeck wrote:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     &gt; I have thus far used dstdomain acl for bypassing ssl bump on sites
</I>&gt;<i> &gt;     that
</I>&gt;<i> &gt;     &gt; we don't want to decrypt, like banking sites. It seems to work for
</I>&gt;<i> &gt;     some
</I>&gt;<i> &gt;     &gt; sites, but not for others.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     Yes, many HTTPS transactions do not expose destination domain until
</I>&gt;<i> it
</I>&gt;<i> &gt;     is too late to decide whether to bump them, and reverse DNS lookups
</I>&gt;<i> are
</I>&gt;<i> &gt;     often unreliable.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     &gt; I was thinking about this, and it seems to me that if we are using
</I>&gt;<i> the
</I>&gt;<i> &gt;     &gt; squid proxy with a dns server, we should be able to check the dns
</I>&gt;<i> &gt;     cache
</I>&gt;<i> &gt;     &gt; for that IP, and find the associated hostname, and then match
</I>&gt;<i> &gt;     against that.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     When you use dstdomain, Squid will do a (reverse) DNS query for you
</I>&gt;<i> as
</I>&gt;<i> &gt;     necessary (including DNS cache lookups) unless you specify a -n
</I>&gt;<i> option
</I>&gt;<i> &gt;     that is documented to disable all such operations.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     In many cases, you should be using ssl::server_name instead of
</I>&gt;<i> dstdomain
</I>&gt;<i> &gt;     or dst ACL, but you may have to use a combination of various ACLs to
</I>&gt;<i> &gt;     cover all the cases you care about.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     HTH,
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     Alex.
</I>&gt;<i> &gt;
</I>&gt;<i>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20210226/743eb2cf/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20210226/743eb2cf/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="023379.html">[squid-users] Squid ACL for bypassing ssl-bump
</A></li>
	<LI>Next message (by thread): <A HREF="023383.html">[squid-users] Squid ACL for bypassing ssl-bump
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23381">[ date ]</a>
              <a href="thread.html#23381">[ thread ]</a>
              <a href="subject.html#23381">[ subject ]</a>
              <a href="author.html#23381">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
