<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] TCP_DENIED/403 3954 CONNECT www.welt.de:443 - HIER_NONE/- text/html
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20TCP_DENIED/403%203954%20CONNECT%20www.welt.de%3A443%20-%0A%20HIER_NONE/-%20text/html&In-Reply-To=%3Cff5d4c94-0e62-1960-dfb3-88ae209b514e%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="023123.html">
   <LINK REL="Next"  HREF="023125.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] TCP_DENIED/403 3954 CONNECT www.welt.de:443 - HIER_NONE/- text/html</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20TCP_DENIED/403%203954%20CONNECT%20www.welt.de%3A443%20-%0A%20HIER_NONE/-%20text/html&In-Reply-To=%3Cff5d4c94-0e62-1960-dfb3-88ae209b514e%40treenet.co.nz%3E"
       TITLE="[squid-users] TCP_DENIED/403 3954 CONNECT www.welt.de:443 - HIER_NONE/- text/html">squid3 at treenet.co.nz
       </A><BR>
    <I>Wed Jan  6 05:57:23 UTC 2021</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="023123.html">[squid-users] TCP_DENIED/403 3954 CONNECT www.welt.de:443 - HIER_NONE/- text/html
</A></li>
        <LI>Next message (by thread): <A HREF="023125.html">[squid-users] Host header forgery detected on domain: mobile.pipe.aria.microsoft.com
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23124">[ date ]</a>
              <a href="thread.html#23124">[ thread ]</a>
              <a href="subject.html#23124">[ subject ]</a>
              <a href="author.html#23124">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 6/01/21 6:21 am, Wolfgang Paul Rauchholz wrote:
&gt;<i> I run a home server under Centos 7 and squid 3.5.20. The config is still 
</I>&gt;<i> work in progress as I started only today. Any tipps&amp;tricks are welcomed
</I>&gt;<i> The function is as expected when working from my LAN. But when I tested 
</I>&gt;<i> today from my cell phone from&#160;outside I received a few TCP_DENIED for 
</I>&gt;<i> web pages that are not part of the blacklists and I can access from my LAN.
</I>&gt;<i> I also tried a few apps (e.g. Twitter, Linkedin, etc..) and none worked. 
</I>&gt;<i> Underneath the config as-is.
</I>&gt;<i> 
</I>&gt;<i> Any idea why I cannot connect?
</I>

The provided squid.conf has two types of access permitted through this 
proxy:

1) non-LAN traffic is allowed to anything on the whitelist.

2) LAN traffic is allowed to anything on the whitelist AND anything not 
on the blacklist(s).


So the key question is whether the domains you tried are (or were) on 
the whitelist when you access them from outside the LAN.



&gt;<i> I have two more question&#160;I fiddled with and has no success:
</I>&gt;<i> 
</I>&gt;<i>   * Is there a possibility to re-direct certain MACs from the LAN
</I>&gt;<i>     through Squid and others can go direct?
</I>
Getting traffic to the proxy is entirely the OS duty. Most OS can route 
or NAT IPv4 packets based on MAC.

Note that if the client is not opening connections to the proxy by 
itself then you need to follow one of the interception configurations on 
the Squid machine. see 
&lt;<A HREF="https://wiki.squid-cache.org/ConfigExamples/Intercept/LinuxRedirect">https://wiki.squid-cache.org/ConfigExamples/Intercept/LinuxRedirect</A>&gt;
Squid needs separate http_port's for the intercepted traffic and the 
normal proxy traffic.


&gt;<i>   * Is there a good howto that describes in detail how autdetect&#160;proxy
</I>&gt;<i>     works with wpad.dat. I want that when users are on LAN they go
</I>&gt;<i>     through squid, but when they are travelling they can go direct.
</I>&gt;<i> 
</I>

I suggest you have a read of the FAQs 
(&lt;<A HREF="https://wiki.squid-cache.org/SquidFaq/ConfiguringBrowsers">https://wiki.squid-cache.org/SquidFaq/ConfiguringBrowsers</A>&gt;) about how 
proxies can be used by Browsers. In particular the section &quot;Recommended 
network configuration&quot; and links from there.



&gt;<i> Thanks for your help,
</I>&gt;<i> 
</I>&gt;<i> Wolfgang
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> #acl localnet src 172.16.0.0/12 &lt;<A HREF="http://172.16.0.0/12">http://172.16.0.0/12</A>&gt; &#160;# RFC1918 
</I>&gt;<i> possible internal network
</I>&gt;<i> #acl localnet src 192.168.0.0/16 &lt;<A HREF="http://192.168.0.0/16">http://192.168.0.0/16</A>&gt; # RFC1918 
</I>&gt;<i> possible internal network
</I>&gt;<i> #acl localnet src fc00::/7 &#160; &#160; &#160; # RFC 4193 local private network range
</I>&gt;<i> #acl localnet src fe80::/10 &#160; &#160; &#160;# RFC 4291 link-local (directly 
</I>&gt;<i> plugged) machines
</I>&gt;<i> 
</I>&gt;<i> acl SSL_ports port 443
</I>&gt;<i> acl Safe_ports port 80 &#160; &#160; &#160; &#160; &#160;# http
</I>&gt;<i> acl Safe_ports port 21 &#160; &#160; &#160; &#160; &#160;# ftp
</I>&gt;<i> acl Safe_ports port 443 &#160; &#160; &#160; &#160; # https
</I>&gt;<i> acl Safe_ports port 70 &#160; &#160; &#160; &#160; &#160;# gopher
</I>&gt;<i> acl Safe_ports port 210 &#160; &#160; &#160; &#160; # wais
</I>&gt;<i> acl Safe_ports port 1025-65535 &#160;# unregistered ports
</I>&gt;<i> acl Safe_ports port 280 &#160; &#160; &#160; &#160; # http-mgmt
</I>&gt;<i> acl Safe_ports port 488 &#160; &#160; &#160; &#160; # gss-http
</I>&gt;<i> acl Safe_ports port 591 &#160; &#160; &#160; &#160; # filemaker
</I>&gt;<i> acl Safe_ports port 777 &#160; &#160; &#160; &#160; # multiling http
</I>&gt;<i> acl CONNECT method CONNECT
</I>&gt;<i> # Add wo-lar LAN IP
</I>&gt;<i> acl lan src 10.5.2.0/24 &lt;<A HREF="http://10.5.2.0/24">http://10.5.2.0/24</A>&gt;
</I>&gt;<i> 
</I>
FYI: this is what &quot;localnet&quot; ACL is supposed to be set to.

As the squid.conf file itself says:
  # Adapt localnet in the ACL section to list your (internal) IP networks


&gt;<i> # Basic user auth
</I>&gt;<i> #auth_param basic program /usr/lib64/squid/basic_ncsa_auth 
</I>&gt;<i> /etc/squid/.htpasswd
</I>&gt;<i> #auth_param basic children 5
</I>&gt;<i> #auth_param basic realm Squid Basic Authentication
</I>&gt;<i> #auth_param basic credentialsttl 5 hours
</I>&gt;<i> #acl password proxy_auth REQUIRED
</I>&gt;<i> #http_access allow password
</I>&gt;<i> 
</I>
FYI: if you ever want to enable auth this should all be down below the 
blacklist http_access lines.


&gt;<i> #
</I>&gt;<i> # Recommended minimum Access Permission configuration:
</I>&gt;<i> #
</I>&gt;<i> # Deny requests to certain unsafe ports
</I>&gt;<i> #http_access deny !Safe_ports
</I>&gt;<i> 
</I>&gt;<i> # Deny CONNECT to other than secure SSL ports
</I>&gt;<i> #http_access deny CONNECT !SSL_ports
</I>&gt;<i> 
</I>
Please re-enable the above lines. They are protecting against whole 
groups of security attacks.


&gt;<i> # Only allow cachemgr access from localhost
</I>&gt;<i> http_access allow localhost manager
</I>&gt;<i> http_access deny manager
</I>&gt;<i> 
</I>&gt;<i> # We strongly recommend the following be uncommented to protect innocent
</I>&gt;<i> # web applications running on the proxy server who think the only
</I>&gt;<i> # one who can access services on &quot;localhost&quot; is a local user
</I>&gt;<i> #http_access deny to_localhost
</I>&gt;<i> # INSERT YOUR OWN RULE(S) HERE TO ALLOW ACCESS FROM YOUR CLIENTS
</I>&gt;<i> #
</I>&gt;<i> acl allowdomains dstdomain &quot;/etc/squid/whitelists/domains&quot;
</I>&gt;<i> acl porn &#160; &#160; &#160; &#160; dstdomain &quot;/etc/squid/blacklists/porn/domains&quot;
</I>&gt;<i> acl drugs &#160; &#160; &#160; &#160;dstdomain &quot;/etc/squid/blacklists/drugs/domains&quot;
</I>&gt;<i> http_access allow allowdomains
</I>&gt;<i> http_access deny porn
</I>&gt;<i> http_access deny drugs
</I>&gt;<i> 
</I>&gt;<i> # Example rule allowing access from your local networks.
</I>&gt;<i> # Adapt localnet in the ACL section to list your (internal) IP networks
</I>&gt;<i> # from where browsing should be allowed
</I>&gt;<i> http_access allow localhost
</I>&gt;<i> http_access allow lan
</I>&gt;<i> 
</I>&gt;<i> # And finally deny all other access to this proxy
</I>&gt;<i> http_access deny all
</I>

&gt;<i> request_header_access Referer deny all
</I>&gt;<i> request_header_access X-Forwarded-For deny all
</I>
You have configured &quot;forwarded_for off&quot; and are not using the clients 
X-Forwarded-For header. Which means the above setting does nothing useful.

&gt;<i> request_header_access Via deny all
</I>&gt;<i> request_header_access Cache-Control deny all
</I>&gt;<i> 
</I>
The above breaks HTTP in bad ways. Your clients will not be having a 
good experience without Cache-Control.


Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="023123.html">[squid-users] TCP_DENIED/403 3954 CONNECT www.welt.de:443 - HIER_NONE/- text/html
</A></li>
	<LI>Next message (by thread): <A HREF="023125.html">[squid-users] Host header forgery detected on domain: mobile.pipe.aria.microsoft.com
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23124">[ date ]</a>
              <a href="thread.html#23124">[ thread ]</a>
              <a href="subject.html#23124">[ subject ]</a>
              <a href="author.html#23124">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
