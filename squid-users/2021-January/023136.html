<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid 5.0.3 Cache_Peer Authentication Issue
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%205.0.3%20Cache_Peer%20Authentication%20Issue&In-Reply-To=%3C5FF893CF.26686.2CF14D2D%40Paul.pjb.org.uk%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="023135.html">
   <LINK REL="Next"  HREF="023137.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid 5.0.3 Cache_Peer Authentication Issue</H1>
    <B>Paul at pjb.org.uk</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%205.0.3%20Cache_Peer%20Authentication%20Issue&In-Reply-To=%3C5FF893CF.26686.2CF14D2D%40Paul.pjb.org.uk%3E"
       TITLE="[squid-users] Squid 5.0.3 Cache_Peer Authentication Issue">Paul at pjb.org.uk
       </A><BR>
    <I>Fri Jan  8 17:18:07 UTC 2021</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="023135.html">[squid-users] Squid 5.0.3 Cache_Peer Authentication Issue
</A></li>
        <LI>Next message (by thread): <A HREF="023137.html">[squid-users] Squid 5.0.3 Cache_Peer Authentication Issue
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23136">[ date ]</a>
              <a href="thread.html#23136">[ thread ]</a>
              <a href="subject.html#23136">[ subject ]</a>
              <a href="author.html#23136">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Thank you for responding.

&gt;<i> N.B. I assume you do not use SslBump -- the configuration snippet above
</I>&gt;<i> does not show SslBump being used. SslBump does not support what you want
</I>&gt;<i> per commit f5e1794 message.
</I>
I am using Ssl-bump, but on a different inbound port and it will never be for traffic heading 
out to this peer.  

There is an entry in my logs much earlier during the process (just before it does 
peer_select) which states:
kid1| 85,5| client_side_request.cc(1444) sslBumpAccessCheck: cannot SslBump this 
request 

Does this use of ssl-bump at any stage preclude the use of cache_peer authentication with 
CONNECT?  My http_port, various acls and ssl_bump statements are all after the config 
extract shown below.

&gt;<i> What kind of HTTP authentication does your client/peer use/expect?
</I>
&gt;<i>From the successful GET connections, I can see that the peer requests both a Negotiate 
</I>and NTLM, my clients respond with a Negotiate.

regards,
Paul


On 7 Jan 2021 at 15:18, Alex Rousskov wrote:

&gt;<i> On 1/7/21 2:43 PM, <A HREF="https://lists.squid-cache.org/listinfo/squid-users">Paul at pjb.org.uk</A> wrote:
</I>&gt;<i> 
</I>&gt;<i> &gt; I am currently using Squid 5.0.3 but have an issue when using a cache_peer (non-squid &amp;  
</I>&gt;<i> &gt; outside my control) that requires authentication.  My Squid server doesn't require 
</I>&gt;<i> &gt; authentication and reading the documentation indicated that I need to set 
</I>&gt;<i> &gt; 'login=PASSTHRU' on my cache_peer line, which I have done.  This has enabled GET 
</I>&gt;<i> &gt; methods to work as expected, but CONNECT methods are failing.  The response from the 
</I>&gt;<i> &gt; peer is a '407' with both methods. 
</I>&gt;<i> 
</I>&gt;<i> &gt; I am controlling access to the peer via an acl:
</I>&gt;<i> 
</I>&gt;<i> &gt; ---------------
</I>&gt;<i> &gt; acl localClients src 10.10.1.0/24
</I>&gt;<i> &gt; http_access allow localClients
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; acl aclREDIRECT dstdomain &quot;/etc/squid/redirect.txt&quot;
</I>&gt;<i> &gt; cache_peer 10.10.10.167 parent 8080 0 no-query name=peerREDIRECT login=PASSTHRU 
</I>&gt;<i> &gt; connection-auth=on
</I>&gt;<i> &gt; cache_peer_access peerREDIRECT allow aclREDIRECT
</I>&gt;<i> &gt; cache_peer_access peerREDIRECT deny !aclREDIRECT
</I>&gt;<i> &gt; never_direct allow aclREDIRECT
</I>&gt;<i> &gt; always_direct deny aclREDIRECT
</I>&gt;<i> &gt; always_direct allow all
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; http_port 80 connection-auth=on
</I>&gt;<i> &gt; ---------------
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> &gt; An extract from my logs showing the failure:
</I>&gt;<i> &gt; kid1| 11,2| HttpTunneler.cc(326) handleResponse: Tunnel Server RESPONSE:
</I>&gt;<i> &gt; &lt;!-- default &quot;Proxy Authorization Required&quot; response (407) --&gt;----------
</I>&gt;<i> &gt; kid1| 83,3| HttpTunneler.cc(345) bailOnResponseError: unsupported CONNECT response 
</I>&gt;<i> &gt; status code [state:w FD 17 job22]
</I>&gt;<i> 
</I>&gt;<i> &gt; Is this a mis-configuration? or have I mis-understood how cache_peer works?
</I>&gt;<i> 
</I>&gt;<i> N.B. I assume you do not use SslBump -- the configuration snippet above
</I>&gt;<i> does not show SslBump being used. SslBump does not support what you want
</I>&gt;<i> per commit f5e1794 message.
</I>&gt;<i> 
</I>&gt;<i> What kind of HTTP authentication does your client/peer use/expect?
</I>&gt;<i> 
</I>&gt;<i> The 407 response from the peer may be normal/expected (a part of HTTP
</I>&gt;<i> authentication) or indicate a problem. If you do not get better
</I>&gt;<i> suggestions, please show us the CONNECT request and response headers,
</I>&gt;<i> exchanged between the client and your Squid and between your Squid and
</I>&gt;<i> cache_peer (i.e. 4 headers total). You can use tools like
</I>&gt;<i> tcpdump/wireshark to collect/render those plain text headers.
</I>&gt;<i> 
</I>&gt;<i> Alex.
</I>


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="023135.html">[squid-users] Squid 5.0.3 Cache_Peer Authentication Issue
</A></li>
	<LI>Next message (by thread): <A HREF="023137.html">[squid-users] Squid 5.0.3 Cache_Peer Authentication Issue
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23136">[ date ]</a>
              <a href="thread.html#23136">[ thread ]</a>
              <a href="subject.html#23136">[ subject ]</a>
              <a href="author.html#23136">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
