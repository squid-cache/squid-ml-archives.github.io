<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] cache_peer selection based on username
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20cache_peer%20selection%20based%20on%20username&In-Reply-To=%3C003701d6e7f8%2493d90f70%24bb8b2e50%24%40gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="023142.html">
   <LINK REL="Next"  HREF="023143.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] cache_peer selection based on username</H1>
    <B>Eliezer Croitoru</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20cache_peer%20selection%20based%20on%20username&In-Reply-To=%3C003701d6e7f8%2493d90f70%24bb8b2e50%24%40gmail.com%3E"
       TITLE="[squid-users] cache_peer selection based on username">ngtech1ltd at gmail.com
       </A><BR>
    <I>Mon Jan 11 09:03:06 UTC 2021</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="023142.html">[squid-users] cache_peer selection based on username
</A></li>
        <LI>Next message (by thread): <A HREF="023143.html">[squid-users] cache_peer selection based on username
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23146">[ date ]</a>
              <a href="thread.html#23146">[ thread ]</a>
              <a href="subject.html#23146">[ subject ]</a>
              <a href="author.html#23146">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>In the next example I wrote a whole setup:

<A HREF="https://github.com/elico/vagrant-squid-outgoing-addresses">https://github.com/elico/vagrant-squid-outgoing-addresses</A>

 

Specifically it would look something like:

<A HREF="https://github.com/elico/vagrant-squid-outgoing-addresses/blob/master/shared/note.rb#L82">https://github.com/elico/vagrant-squid-outgoing-addresses/blob/master/shared/note.rb#L82</A>

 

it&#8217;s as a line like:

echo &#8220;OK x_note=100 ip=100&#8221;

 

The in squid use an acl like this:

<A HREF="https://github.com/elico/vagrant-squid-outgoing-addresses/blob/9221a73394ced582fec84bc42abfaae3c9a364b3/shared/collect-32-subnet-addresses.rb#L17">https://github.com/elico/vagrant-squid-outgoing-addresses/blob/9221a73394ced582fec84bc42abfaae3c9a364b3/shared/collect-32-subnet-addresses.rb#L17</A>

 

ie:

echo &quot;acl #{ip_map[key]} note ip #{acl_name.match(/([0-9]+)/)[1]}&quot; |tee -a /etc/squid/conf.d/acl-to-ip.conf

 

It&#8217;s better to run the lab and see the content of the conf files to understand it.

You will need VirtualBox and Vagrant to power up this lab.

 

Later I might be able to record a video of this but not sure yet about this.

 

Eliezer

 

----

Eliezer Croitoru

Tech Support

Mobile: +972-5-28704261

Email: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">ngtech1ltd at gmail.com</A> &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">ngtech1ltd at gmail.com</A>&gt; 

Zoom: Coming soon

 

 

From: roee klinger &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">roeeklinger60 at gmail.com</A>&gt; 
Sent: Sunday, January 10, 2021 5:51 PM
To: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
Cc: Eliezer Croitoru &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">ngtech1ltd at gmail.com</A>&gt;
Subject: Re: [squid-users] cache_peer selection based on username

 

So basically I return a note with the &#8220;OK&#8221; response, which can be any string, for example &#8220;100&#8221;.

 

Then, I can use &#8220;100&#8221; as a normal ACL in squid.conf?

 

Thanks

 

 





On Jan 10, 2021, at 17:36, Eliezer Croitoru &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">ngtech1ltd at gmail.com</A> &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">ngtech1ltd at gmail.com</A>&gt; &gt; wrote:

&#65279;

You should use a note acl for that.

When you return the whitelisted client you should add a note which can be 1-100 or any other static string.

 

It works just out of the box.

 

----

Eliezer Croitoru

Tech Support

Mobile: +972-5-28704261

Email: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">ngtech1ltd at gmail.com</A> &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">ngtech1ltd at gmail.com</A>&gt; 

Zoom: Coming soon

 

 

From: squid-users &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A> &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>&gt; &gt; On Behalf Of roee klinger
Sent: Sunday, January 10, 2021 5:33 PM
To: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A> &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>&gt; 
Subject: [squid-users] cache_peer selection based on username

 

Hey,

 

I am trying to figure out the best way to select cache peers based on the client username, I have read extensively but I cannot figure out the best way to do it.

 

so far I have:

external_acl_type user_whitelist_external children-max=20 ttl=300 %&gt;lp %&gt;a script.sh

acl whitelisted_users external user_whitelist_external

http_access allow whitelisted_users

 

and:

nonhierarchical_direct off

never_direct allow all

cache_peer 192.168.8.1 parent 101 0 proxy-only default name=proxy1

cache_peer_access proxy1 allow whitelisted_users

cache_peer_access proxy0.2 deny all

cache_peer 192.168.8.2 parent 102 0 proxy-only default name=proxy2

cache_peer_access proxy2 allow whitelisted_users

cache_peer_access proxy0.3 deny all

 

ideally, script.sh checks if the request is authinticated and if it is, it selects the cache peer to use, is there some kind of way to achieve this with &quot;Defined keywords&quot; to select which cache peer to use or am I looking at this the wrong way?

 

What would be the best way to accomplish this?

_______________________________________________
squid-users mailing list
<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A> &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>&gt; 
<A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>

-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20210111/5d67ad6e/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20210111/5d67ad6e/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="023142.html">[squid-users] cache_peer selection based on username
</A></li>
	<LI>Next message (by thread): <A HREF="023143.html">[squid-users] cache_peer selection based on username
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23146">[ date ]</a>
              <a href="thread.html#23146">[ thread ]</a>
              <a href="subject.html#23146">[ subject ]</a>
              <a href="author.html#23146">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
