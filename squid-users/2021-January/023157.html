<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] cache_peer selection based on username
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20cache_peer%20selection%20based%20on%20username&In-Reply-To=%3C000d01d6e8bb%246840bd90%2438c238b0%24%40gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="023154.html">
   <LINK REL="Next"  HREF="023164.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] cache_peer selection based on username</H1>
    <B>Eliezer Croitoru</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20cache_peer%20selection%20based%20on%20username&In-Reply-To=%3C000d01d6e8bb%246840bd90%2438c238b0%24%40gmail.com%3E"
       TITLE="[squid-users] cache_peer selection based on username">ngtech1ltd at gmail.com
       </A><BR>
    <I>Tue Jan 12 08:17:44 UTC 2021</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="023154.html">[squid-users] cache_peer selection based on username
</A></li>
        <LI>Next message (by thread): <A HREF="023164.html">[squid-users] cache_peer selection based on username
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23157">[ date ]</a>
              <a href="thread.html#23157">[ thread ]</a>
              <a href="subject.html#23157">[ subject ]</a>
              <a href="author.html#23157">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hey Amos,

One thing that the auth helper cannot do with this note is the ttl.
The auth ttl is different then the request IP binding/routing.
With separated auth and external_acl helper you can change/apply a note/rule/acl in a lower ttl
ie 3 seconds which can be critical to some applications.
If one ip goes down for any reason you can change the routing.
I would have expected for the note to stick if the ttl is either 0 or 1 for the relevant session.
This so we would rely on the helper to be &quot;live&quot; helper per request.

I know that 0-3 is almost the same like 0-5 but some prefer to use 0-1.

Eliezer 

----
Eliezer Croitoru
Tech Support
Mobile: +972-5-28704261
Email: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">ngtech1ltd at gmail.com</A>
Zoom: Coming soon


-----Original Message-----
From: squid-users &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>&gt; On Behalf Of Amos Jeffries
Sent: Tuesday, January 12, 2021 3:46 AM
To: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
Subject: Re: [squid-users] cache_peer selection based on username

On 11/01/21 8:06 am, roee klinger wrote:
&gt;<i> Thanks, Eliezer, I was able to get it working.
</I>&gt;<i> Here is an example in case anybody runs into this in the future:
</I>&gt;<i> 
</I>&gt;<i>     acl mynote1 note mykey note1
</I>&gt;<i>     acl mynote2 note mykey note2
</I>&gt;<i> 
</I>
FYI, key names ending with &quot;_&quot; character are reserved for custom keys 
like this.


&gt;<i>     external_acl_type user_whitelist_external children-max=20 ttl=300
</I>&gt;<i>     %&gt;lp %&gt;a script.sh
</I>
NP: this does not check for users or authenticated traffic at all. It is 
only using the client-IP and Squid receiving port number.

To meet the earlier stated requirement about authenticated traffic the 
helper format should contain %un. The lines below should follow the 
http_access rules doing authentication checks.


You could also have the helper doing authentication send the notes to 
Squid. eg as a group name.



&gt;<i>     acl whitelisted_users external user_whitelist_external
</I>&gt;<i>     http_access allow whitelisted_users
</I>&gt;<i> 
</I>&gt;<i>     nonhierarchical_direct off
</I>&gt;<i>     never_direct allow all
</I>&gt;<i>     cache_peer 192.168.8.1 parent 101 0 proxy-only default name=proxy1
</I>&gt;<i>     cache_peer_access proxy1 allow mynote1
</I>&gt;<i>     cache_peer_access proxy0.2 deny all
</I>&gt;<i>     cache_peer 192.168.8.2 parent 102 0 proxy-only default name=proxy2
</I>&gt;<i>     cache_peer_access proxy2 allow mynote2
</I>&gt;<i>     cache_peer_access proxy0.3 deny all
</I>&gt;<i> 
</I>
NP: there is no peer named &quot;proxy0.2&quot; or &quot;proxy0.3&quot; so those deny lines 
are not doing anything. The only reason this config does what it appears 
at first glance to do, is that the inverted default for the prox1 and 
proxy2 peer access rules default is deny.


&gt;<i> 
</I>&gt;<i> Then, on the external helper, I return one of these two:
</I>&gt;<i> 
</I>&gt;<i>     OK mykey=note1
</I>&gt;<i>     OK mykey=note2
</I>&gt;<i> 
</I>&gt;<i> 
</I>

Amos

_______________________________________________
squid-users mailing list
<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
<A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="023154.html">[squid-users] cache_peer selection based on username
</A></li>
	<LI>Next message (by thread): <A HREF="023164.html">[squid-users] cache_peer selection based on username
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23157">[ date ]</a>
              <a href="thread.html#23157">[ thread ]</a>
              <a href="subject.html#23157">[ subject ]</a>
              <a href="author.html#23157">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
