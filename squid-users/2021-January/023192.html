<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] generate-host-certificates=on fails to generate certificates for _some_ hosts
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20generate-host-certificates%3Don%20fails%20to%20generate%0A%20certificates%20for%20_some_%20hosts&In-Reply-To=%3C000201d6ea7b%24546069d0%24fd213d70%24%40gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="023188.html">
   <LINK REL="Next"  HREF="023193.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] generate-host-certificates=on fails to generate certificates for _some_ hosts</H1>
    <B>Eliezer Croitoru</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20generate-host-certificates%3Don%20fails%20to%20generate%0A%20certificates%20for%20_some_%20hosts&In-Reply-To=%3C000201d6ea7b%24546069d0%24fd213d70%24%40gmail.com%3E"
       TITLE="[squid-users] generate-host-certificates=on fails to generate certificates for _some_ hosts">ngtech1ltd at gmail.com
       </A><BR>
    <I>Thu Jan 14 13:44:06 UTC 2021</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="023188.html">[squid-users] generate-host-certificates=on fails to generate certificates for _some_ hosts
</A></li>
        <LI>Next message (by thread): <A HREF="023193.html">[squid-users] generate-host-certificates=on fails to generate certificates for _some_ hosts
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23192">[ date ]</a>
              <a href="thread.html#23192">[ thread ]</a>
              <a href="subject.html#23192">[ subject ]</a>
              <a href="author.html#23192">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hey Greg,

I am trying to test it with 5.0.4 and it seems that this site works for me with SSL BUMP.
The CN and the SAN are the same so it makes sense that it should work the same on your proxy.
However I do see that this domain has 2 IP addresses which might affect what you see.
I am trying to verify this issue locally.

I wrote the next ruby script to help others with some insights.
<A HREF="https://github.com/elico/tls-check-script">https://github.com/elico/tls-check-script</A>

Both ip addresses seem to give the same certificate.
I am using openssl to see the certificate:
openssl s_client -showcerts -servername arstechnica.com -connect arstechnica.com:443 &lt;/dev/null 2&gt;/dev/null | openssl x509 -noout -text

Let me know if something specific is seen in your environment.

It shouldn't matter too much but, what OS are you running squid ontop and what is &quot;squid -v&quot; output?

Thanks,
Eliezer

----
Eliezer Croitoru
Tech Support
Mobile: +972-5-28704261
Email: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">ngtech1ltd at gmail.com</A>
Zoom: Coming soon


-----Original Message-----
From: squid-users &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>&gt; On Behalf Of Greg Hulands
Sent: Thursday, January 14, 2021 8:22 AM
To: Alex Rousskov &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt;
Cc: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
Subject: Re: [squid-users] generate-host-certificates=on fails to generate certificates for _some_ hosts

Hey Alex,
Can you point me to the rough location in code where the certs are sent to the client.

I tried with TLS 1.2 with openssl s_client and it returned the certs the same.

Thanks,
Greg

&gt;<i> On Jan 13, 2021, at 8:44 PM, Alex Rousskov &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt; wrote:
</I>&gt;<i> 
</I>&gt;<i> On 1/13/21 9:47 PM, Greg Hulands wrote:
</I>&gt;&gt;<i> I have put the ALL,9 log
</I>&gt;&gt;<i> here <A HREF="https://gist.github.com/ghulands/4a689db93fc87f9e7f69174f292f1914">https://gist.github.com/ghulands/4a689db93fc87f9e7f69174f292f1914</A>
</I>&gt;<i> 
</I>&gt;&gt;<i> I can see it generates the certificate correctly,
</I>&gt;<i> 
</I>&gt;<i> Agreed. Squid receives (from the helper) a generated certificate with
</I>&gt;<i> the right wildcard CN, not a CA certificate.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> but couldn&#8217;t identify why it didn&#8217;t return the cert to the client.
</I>&gt;<i> 
</I>&gt;<i> Yeah... Squid is calling the code that should set the certificate for
</I>&gt;<i> the client connection. Unfortunately, I cannot easily tell whether that
</I>&gt;<i> code is using the right certificate -- the existing debugging may not
</I>&gt;<i> even reveal that detail.
</I>&gt;<i> 
</I>&gt;<i> If you see a different certificate received by the client -- something I
</I>&gt;<i> cannot verify from the logs -- then perhaps Squid incorrectly switched
</I>&gt;<i> the right certificate to a different one or Squid failed to set the
</I>&gt;<i> right certificate but forgot to report the problem (and the CA
</I>&gt;<i> certificate from the related context was used?). These are just wild
</I>&gt;<i> guesses.
</I>&gt;<i> 
</I>&gt;<i> If you do not get better suggestions for going forward, consider these
</I>&gt;<i> last-straw ideas:
</I>&gt;<i> 
</I>&gt;<i> * Testing with a client like openssl, try disabling TLS v1.3. It is
</I>&gt;<i> being used by the client in your logs. Perhaps there is something in TLS
</I>&gt;<i> v1.3 that requires special handing when talking to the client. I know
</I>&gt;<i> that Squid has problems with TLS v1.3 on the Squid-to-server
</I>&gt;<i> connections... (In your case, the Squid-to-server connection is TLS v1.2
</I>&gt;<i> AFAICT).
</I>&gt;<i> 
</I>&gt;<i> * Upgrade to the latest v5 or even v6. I see no relevant fixes in v5 but
</I>&gt;<i> I could miss them.
</I>&gt;<i> 
</I>&gt;<i> * If you are a developer, add more debugging or use gdb to find out what
</I>&gt;<i> happens with the Squid-to-client certificate. Otherwise, find a
</I>&gt;<i> developer who can do that for you.
</I>&gt;<i> 
</I>&gt;<i> Sorry I cannot think of any good options here.
</I>&gt;<i> 
</I>&gt;<i> Alex.
</I>
_______________________________________________
squid-users mailing list
<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
<A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="023188.html">[squid-users] generate-host-certificates=on fails to generate certificates for _some_ hosts
</A></li>
	<LI>Next message (by thread): <A HREF="023193.html">[squid-users] generate-host-certificates=on fails to generate certificates for _some_ hosts
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23192">[ date ]</a>
              <a href="thread.html#23192">[ thread ]</a>
              <a href="subject.html#23192">[ subject ]</a>
              <a href="author.html#23192">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
