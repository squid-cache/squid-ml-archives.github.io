<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] generate-host-certificates=on fails to generate certificates for _some_ hosts
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20generate-host-certificates%3Don%20fails%20to%20generate%0A%20certificates%20for%20_some_%20hosts&In-Reply-To=%3C9e539460-7d9b-221c-980e-2c725e62ceb0%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="023192.html">
   <LINK REL="Next"  HREF="023194.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] generate-host-certificates=on fails to generate certificates for _some_ hosts</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20generate-host-certificates%3Don%20fails%20to%20generate%0A%20certificates%20for%20_some_%20hosts&In-Reply-To=%3C9e539460-7d9b-221c-980e-2c725e62ceb0%40measurement-factory.com%3E"
       TITLE="[squid-users] generate-host-certificates=on fails to generate certificates for _some_ hosts">rousskov at measurement-factory.com
       </A><BR>
    <I>Thu Jan 14 14:53:10 UTC 2021</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="023192.html">[squid-users] generate-host-certificates=on fails to generate certificates for _some_ hosts
</A></li>
        <LI>Next message (by thread): <A HREF="023194.html">[squid-users] Mutual TLS for the upstream example
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23193">[ date ]</a>
              <a href="thread.html#23193">[ thread ]</a>
              <a href="subject.html#23193">[ subject ]</a>
              <a href="author.html#23193">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 1/14/21 1:22 AM, Greg Hulands wrote:

&gt;<i> Can you point me to the rough location in code where the certs are sent to the client.
</I>
I would start with the following log line:

&gt;<i> 2021/01/13 18:09:11.655 kid1| 33,5| client_side.cc(2700) sslCrtdHandleReply: Certificate for arstechnica.com was successfully recieved from ssl_crtd
</I>
You can see the exact code location of each low-level debug statement.
Unfortunately, Squid uses a somewhat unusual filename(linenumber)
notation for that, but the information is there -- client_side.cc line
2700. After the source code location, Squid prints the function name
where the message was generated -- sslCrtdHandleReply.

The above line points to a method that receives the (parsed) certificate
from the code that talks to the helper. IIRC, Squid then calls
Ssl::configureSSLUsingPkeyAndCertFromMemory() to apply the certificate
to the client-Squid TLS connection. It would be good to confirm that the
certificate Squid applies is the right one and that all the application
functions were successful (e.g., Squid may forget to check some OpenSSL
function result). This will require some development skills.


&gt;<i> I tried with TLS 1.2 with openssl s_client and it returned the certs the same.
</I>
Noted. You may prefer to test with TLS v1.2 (first) because it may
produce simpler debugging logs and create fewer uncertainties. The code
mentioned above is used for all TLS versions.


Good luck,

Alex.


&gt;&gt;<i> On Jan 13, 2021, at 8:44 PM, Alex Rousskov &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt; wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> On 1/13/21 9:47 PM, Greg Hulands wrote:
</I>&gt;&gt;&gt;<i> I have put the ALL,9 log
</I>&gt;&gt;&gt;<i> here <A HREF="https://gist.github.com/ghulands/4a689db93fc87f9e7f69174f292f1914">https://gist.github.com/ghulands/4a689db93fc87f9e7f69174f292f1914</A>
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> I can see it generates the certificate correctly,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Agreed. Squid receives (from the helper) a generated certificate with
</I>&gt;&gt;<i> the right wildcard CN, not a CA certificate.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> but couldn&#8217;t identify why it didn&#8217;t return the cert to the client.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Yeah... Squid is calling the code that should set the certificate for
</I>&gt;&gt;<i> the client connection. Unfortunately, I cannot easily tell whether that
</I>&gt;&gt;<i> code is using the right certificate -- the existing debugging may not
</I>&gt;&gt;<i> even reveal that detail.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> If you see a different certificate received by the client -- something I
</I>&gt;&gt;<i> cannot verify from the logs -- then perhaps Squid incorrectly switched
</I>&gt;&gt;<i> the right certificate to a different one or Squid failed to set the
</I>&gt;&gt;<i> right certificate but forgot to report the problem (and the CA
</I>&gt;&gt;<i> certificate from the related context was used?). These are just wild
</I>&gt;&gt;<i> guesses.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> If you do not get better suggestions for going forward, consider these
</I>&gt;&gt;<i> last-straw ideas:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> * Testing with a client like openssl, try disabling TLS v1.3. It is
</I>&gt;&gt;<i> being used by the client in your logs. Perhaps there is something in TLS
</I>&gt;&gt;<i> v1.3 that requires special handing when talking to the client. I know
</I>&gt;&gt;<i> that Squid has problems with TLS v1.3 on the Squid-to-server
</I>&gt;&gt;<i> connections... (In your case, the Squid-to-server connection is TLS v1.2
</I>&gt;&gt;<i> AFAICT).
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> * Upgrade to the latest v5 or even v6. I see no relevant fixes in v5 but
</I>&gt;&gt;<i> I could miss them.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> * If you are a developer, add more debugging or use gdb to find out what
</I>&gt;&gt;<i> happens with the Squid-to-client certificate. Otherwise, find a
</I>&gt;&gt;<i> developer who can do that for you.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Sorry I cannot think of any good options here.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Alex.
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="023192.html">[squid-users] generate-host-certificates=on fails to generate certificates for _some_ hosts
</A></li>
	<LI>Next message (by thread): <A HREF="023194.html">[squid-users] Mutual TLS for the upstream example
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23193">[ date ]</a>
              <a href="thread.html#23193">[ thread ]</a>
              <a href="subject.html#23193">[ subject ]</a>
              <a href="author.html#23193">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
