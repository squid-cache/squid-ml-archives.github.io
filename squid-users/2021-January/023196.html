<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Mutual TLS for the upstream example
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Mutual%20TLS%20for%20the%20upstream%20example&In-Reply-To=%3C948920b3-df53-6dbb-6f61-047bc413d7c4%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="023199.html">
   <LINK REL="Next"  HREF="023197.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Mutual TLS for the upstream example</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Mutual%20TLS%20for%20the%20upstream%20example&In-Reply-To=%3C948920b3-df53-6dbb-6f61-047bc413d7c4%40measurement-factory.com%3E"
       TITLE="[squid-users] Mutual TLS for the upstream example">rousskov at measurement-factory.com
       </A><BR>
    <I>Thu Jan 14 20:42:56 UTC 2021</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="023199.html">[squid-users] Mutual TLS for the upstream example
</A></li>
        <LI>Next message (by thread): <A HREF="023197.html">[squid-users] Mutual TLS for the upstream example
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23196">[ date ]</a>
              <a href="thread.html#23196">[ thread ]</a>
              <a href="subject.html#23196">[ subject ]</a>
              <a href="author.html#23196">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 1/14/21 2:41 PM, Sergey Maslyakov wrote:

&gt;<i> Is the CONNECT tunnel designed in a way that enables it to &quot;enrich&quot; the
</I>&gt;<i> outgoing connection with mTLS authentication?
</I>
If, by &quot;designed&quot;, you are asking about HTTP protocol design, then the
CONNECT tunnel is a blind TCP tunnel by that design. Hence, by design, a
proxy dealing with CONNECT tunnels does not assume they are related to TLS.

Squid SslBump feature allows the admin to disregard the general design
principles above and interpret the CONNECT tunnel bytes as TLS. Usually,
when folks ask about &quot;enriching&quot; TLS, they talk about SslBump. It is not
yet clear to me whether you need SslBump.

Neither Squid nor any other proxy can enrich a client TLS connection.
TLS is designed to protect from such fiddling by proxies. I suspect that
what you need is for Squid to use mTLS when forwarding a client request
to the origin server. This is supported in principle, but the devil is
in the details.


&gt;<i> My destination server requires mTLS authentication of the client. I have
</I>&gt;<i> a valid key-cert pair and I can successfully execute a &quot;curl&quot; command to
</I>&gt;<i> fetch a document from that server using the key-cert pair at hand.
</I>
Squid supports mTLS authentication with HTTPS cache_peers (including
origin servers) via the cache_peers sslcert option.


&gt;<i> I want to put Squid between my clients (Maven, Gradle, Docker Engine,
</I>&gt;<i> etc) and the server so that clients would be configured to use the
</I>&gt;<i> instance of Squid as an HTTPS proxy but would not have to be configured
</I>&gt;<i> with the mTLS key-cert pair.
</I>
1. &quot;HTTPS proxy&quot; is a proxy that accepts TLS connections opened by
clients that want to explicitly ask that proxy to forward their request
to some origin server. I suspect that is not what you meant by &quot;HTTPS
proxy&quot;. Whether there are CONNECT requests in this case depends on the
client, but all popular clients I know about do send CONNECT requests
inside that secure TLS connection to the proxy (unfortunately). For
those clients, SslBump is required.

2. It is possible that you are talking about an HTTPS surrogate or HTTPS
reverse proxy/accelerator. In this configuration, clients talk to Squid
thinking that Squid is an HTTPS origin server. There are no CONNECT
requests in this case. Clients receive Squid certificates. No SslBump.

3. If you meant that Squid should intercept/hijack client TCP
connections to HTTPS origin servers, then it is a third kind of
configuration. There are no CONNECT requests in this case. Clients
receive Squid certificates. SslBump is required.

4. If you meant that Squid, as a regular HTTP forward proxy, should
hijack client CONNECT tunnels to HTTPS origin servers, then it is a yet
another kind of configuration. There are CONNECT requests in this case.
Clients receive Squid certificates. SslBump is required.

Each scenario above would present its own Squid challenges. Please
clarify what you are dealing with.


&gt;<i> Here is how I see it:
</I>
&gt;<i> Maven --- (HTTPS/CONNECT) ---&gt; Squid (stores my mTLS key-cert pair) ---
</I>&gt;<i> (mTLS/SSL) ---&gt; Server
</I>
&gt;<i> Is this doable within&#160;Squid architecture?
</I> The &quot;HTTPS/CONNECT&quot; part can be misinterpreted as any of the four cases
above. Please clarify what it means to you. If this is all too
overwhelming, we can start with a simple question: Do your clients
establish TCP connections to a Squid port (cases 1, 2, 4)? Or do they
open TCP connections to origin servers instead (case 3)?


Cheers,

Alex.

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="023199.html">[squid-users] Mutual TLS for the upstream example
</A></li>
	<LI>Next message (by thread): <A HREF="023197.html">[squid-users] Mutual TLS for the upstream example
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23196">[ date ]</a>
              <a href="thread.html#23196">[ thread ]</a>
              <a href="subject.html#23196">[ subject ]</a>
              <a href="author.html#23196">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
