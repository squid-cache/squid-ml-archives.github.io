<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Mutual TLS for the upstream example
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Mutual%20TLS%20for%20the%20upstream%20example&In-Reply-To=%3C31d76444-b291-1bf7-03b9-bff389821325%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="023197.html">
   <LINK REL="Next"  HREF="023201.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Mutual TLS for the upstream example</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Mutual%20TLS%20for%20the%20upstream%20example&In-Reply-To=%3C31d76444-b291-1bf7-03b9-bff389821325%40measurement-factory.com%3E"
       TITLE="[squid-users] Mutual TLS for the upstream example">rousskov at measurement-factory.com
       </A><BR>
    <I>Fri Jan 15 17:37:03 UTC 2021</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="023197.html">[squid-users] Mutual TLS for the upstream example
</A></li>
        <LI>Next message (by thread): <A HREF="023201.html">[squid-users] Peer selection based on IP with multiple ports?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23200">[ date ]</a>
              <a href="thread.html#23200">[ thread ]</a>
              <a href="subject.html#23200">[ subject ]</a>
              <a href="author.html#23200">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 1/14/21 6:36 PM, Sergey Maslyakov wrote:

&gt;<i> I can either get plain-text HTTP to mTLS-secured forwarding, or I have
</I>&gt;<i> to have two independent legs of communication when the authenticity of
</I>&gt;<i> client-to-Squid connection is ensured using its (Squid's) own key-cert
</I>&gt;<i> pair, which is different from authentication credentials of the
</I>&gt;<i> handshake between Squid and my target server.
</I>
I doubt you can simply do plain-text HTTP to the proxy in this case
(without SslBump) even if you were OK with the risks because most
clients will not send &quot;GET <A HREF="https://">https://</A>&quot; requests to the proxy. They will
send CONNECT requests instead. The proxy would have to decrypt their
CONNECT tunnels with SslBump in order to add mTLS.

Thus, the second part of your summary essentially covers all practical
cases, including reverse proxy and SslBump-based ones.


&gt;<i> I don't have the server key-cert pair, which makes the
</I>&gt;<i> sslbump&#160;impractical too.
</I>
FYI: SslBump is meant for cases where you do _not_ have the origin
server key. Squid generates/fakes server certificates and signs them
with its own CA key. The clients have to be configured to trust that CA
key. It is not a &quot;nice&quot; solution by any means, but, sometimes, it is the
best one available.


&gt;<i> In NGINX, I implemented the reverse proxy model (option 2 on your list),
</I>&gt;<i> when the proxy terminated SSL with its own cert, received the request,
</I>&gt;<i> rewrote some headers, and forwarded it over an mTLS-secured connection.
</I>&gt;<i> The problem is that under some&#160;circumstances I also need to rewrite the
</I>&gt;<i> body of the HTTP request and this was taking the whole solution to a
</I>&gt;<i> whole new level of complexity...
</I>
FWIW, Squid should be able to do that as well. Body rewrites are
supported via eCAP/ICAP adaptations, but the result will be quite
complex indeed! Technically, this setup is pretty much as (in)secure as
a setup based on SslBump -- it is based on you securing the client-proxy
leg with your own certificate and forcing the clients to trust your
certificate.


Cheers,

Alex.


&gt;<i> On Thu, Jan 14, 2021 at 2:42 PM Alex Rousskov wrote:
</I>&gt;<i> 
</I>&gt;<i>     On 1/14/21 2:41 PM, Sergey Maslyakov wrote:
</I>&gt;<i> 
</I>&gt;<i>     &gt; Is the CONNECT tunnel designed in a way that enables it to
</I>&gt;<i>     &quot;enrich&quot; the
</I>&gt;<i>     &gt; outgoing connection with mTLS authentication?
</I>&gt;<i> 
</I>&gt;<i>     If, by &quot;designed&quot;, you are asking about HTTP protocol design, then the
</I>&gt;<i>     CONNECT tunnel is a blind TCP tunnel by that design. Hence, by design, a
</I>&gt;<i>     proxy dealing with CONNECT tunnels does not assume they are related
</I>&gt;<i>     to TLS.
</I>&gt;<i> 
</I>&gt;<i>     Squid SslBump feature allows the admin to disregard the general design
</I>&gt;<i>     principles above and interpret the CONNECT tunnel bytes as TLS. Usually,
</I>&gt;<i>     when folks ask about &quot;enriching&quot; TLS, they talk about SslBump. It is not
</I>&gt;<i>     yet clear to me whether you need SslBump.
</I>&gt;<i> 
</I>&gt;<i>     Neither Squid nor any other proxy can enrich a client TLS connection.
</I>&gt;<i>     TLS is designed to protect from such fiddling by proxies. I suspect that
</I>&gt;<i>     what you need is for Squid to use mTLS when forwarding a client request
</I>&gt;<i>     to the origin server. This is supported in principle, but the devil is
</I>&gt;<i>     in the details.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i>     &gt; My destination server requires mTLS authentication of the client.
</I>&gt;<i>     I have
</I>&gt;<i>     &gt; a valid key-cert pair and I can successfully execute a &quot;curl&quot;
</I>&gt;<i>     command to
</I>&gt;<i>     &gt; fetch a document from that server using the key-cert pair at hand.
</I>&gt;<i> 
</I>&gt;<i>     Squid supports mTLS authentication with HTTPS cache_peers (including
</I>&gt;<i>     origin servers) via the cache_peers sslcert option.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i>     &gt; I want to put Squid between my clients (Maven, Gradle, Docker Engine,
</I>&gt;<i>     &gt; etc) and the server so that clients would be configured to use the
</I>&gt;<i>     &gt; instance of Squid as an HTTPS proxy but would not have to be
</I>&gt;<i>     configured
</I>&gt;<i>     &gt; with the mTLS key-cert pair.
</I>&gt;<i> 
</I>&gt;<i>     1. &quot;HTTPS proxy&quot; is a proxy that accepts TLS connections opened by
</I>&gt;<i>     clients that want to explicitly ask that proxy to forward their request
</I>&gt;<i>     to some origin server. I suspect that is not what you meant by &quot;HTTPS
</I>&gt;<i>     proxy&quot;. Whether there are CONNECT requests in this case depends on the
</I>&gt;<i>     client, but all popular clients I know about do send CONNECT requests
</I>&gt;<i>     inside that secure TLS connection to the proxy (unfortunately). For
</I>&gt;<i>     those clients, SslBump is required.
</I>&gt;<i> 
</I>&gt;<i>     2. It is possible that you are talking about an HTTPS surrogate or HTTPS
</I>&gt;<i>     reverse proxy/accelerator. In this configuration, clients talk to Squid
</I>&gt;<i>     thinking that Squid is an HTTPS origin server. There are no CONNECT
</I>&gt;<i>     requests in this case. Clients receive Squid certificates. No SslBump.
</I>&gt;<i> 
</I>&gt;<i>     3. If you meant that Squid should intercept/hijack client TCP
</I>&gt;<i>     connections to HTTPS origin servers, then it is a third kind of
</I>&gt;<i>     configuration. There are no CONNECT requests in this case. Clients
</I>&gt;<i>     receive Squid certificates. SslBump is required.
</I>&gt;<i> 
</I>&gt;<i>     4. If you meant that Squid, as a regular HTTP forward proxy, should
</I>&gt;<i>     hijack client CONNECT tunnels to HTTPS origin servers, then it is a yet
</I>&gt;<i>     another kind of configuration. There are CONNECT requests in this case.
</I>&gt;<i>     Clients receive Squid certificates. SslBump is required.
</I>&gt;<i> 
</I>&gt;<i>     Each scenario above would present its own Squid challenges. Please
</I>&gt;<i>     clarify what you are dealing with.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i>     &gt; Here is how I see it:
</I>&gt;<i> 
</I>&gt;<i>     &gt; Maven --- (HTTPS/CONNECT) ---&gt; Squid (stores my mTLS key-cert
</I>&gt;<i>     pair) ---
</I>&gt;<i>     &gt; (mTLS/SSL) ---&gt; Server
</I>&gt;<i> 
</I>&gt;<i>     &gt; Is this doable within&#160;Squid architecture?
</I>&gt;<i>     &#160;The &quot;HTTPS/CONNECT&quot; part can be misinterpreted as any of the four cases
</I>&gt;<i>     above. Please clarify what it means to you. If this is all too
</I>&gt;<i>     overwhelming, we can start with a simple question: Do your clients
</I>&gt;<i>     establish TCP connections to a Squid port (cases 1, 2, 4)? Or do they
</I>&gt;<i>     open TCP connections to origin servers instead (case 3)?
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i>     Cheers,
</I>&gt;<i> 
</I>&gt;<i>     Alex.
</I>&gt;<i> 
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="023197.html">[squid-users] Mutual TLS for the upstream example
</A></li>
	<LI>Next message (by thread): <A HREF="023201.html">[squid-users] Peer selection based on IP with multiple ports?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23200">[ date ]</a>
              <a href="thread.html#23200">[ thread ]</a>
              <a href="subject.html#23200">[ subject ]</a>
              <a href="author.html#23200">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
