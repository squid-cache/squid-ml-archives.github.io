<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Adding headers in ICAP server with no preview
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Adding%20headers%20in%20ICAP%20server%20with%20no%20preview&In-Reply-To=%3C81302836-3c5f-fb18-8a09-0539540b2702%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="023203.html">
   <LINK REL="Next"  HREF="023209.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Adding headers in ICAP server with no preview</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Adding%20headers%20in%20ICAP%20server%20with%20no%20preview&In-Reply-To=%3C81302836-3c5f-fb18-8a09-0539540b2702%40measurement-factory.com%3E"
       TITLE="[squid-users] Adding headers in ICAP server with no preview">rousskov at measurement-factory.com
       </A><BR>
    <I>Sun Jan 17 21:33:59 UTC 2021</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="023203.html">[squid-users] Adding headers in ICAP server with no preview
</A></li>
        <LI>Next message (by thread): <A HREF="023209.html">[squid-users] Adding headers in ICAP server with no preview
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23204">[ date ]</a>
              <a href="thread.html#23204">[ thread ]</a>
              <a href="subject.html#23204">[ subject ]</a>
              <a href="author.html#23204">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 1/17/21 3:08 PM, Moti Berger wrote:
&gt;<i> What should the ICAP response look like?
</I>
The vast majority off ICAP responses containing an HTTP POST message
will look like ICAP header + HTTP header + HTTP body. Please see RFC
3507 and its errata for examples of and discussion about those three
components. It should help avoid guessing and developing by examples
(which usually leads to bugs, especially where ICAP is involved).


&gt;<i> What I do is to reply like this:
</I>&gt;<i> 
</I>&gt;<i>     (dI./M..ICAP/1.0 200 OK
</I>&gt;<i>     ISTag: &quot;SjIzlRA4te41axxcDOoiSl6rBRg4ZK&quot;
</I>&gt;<i>     Date: Sun, 17 Jan 2021 19:34:12 GMT
</I>&gt;<i>     Server: BaseICAP/1.0 Python/3.6.12
</I>&gt;<i>     Encapsulated: req-hdr=0, req-body=360
</I>&gt;<i> 
</I>&gt;<i>     POST <A HREF="http://www.dst-server.com:22222/v1/test">http://www.dst-server.com:22222/v1/test</A> HTTP/1.1
</I>&gt;<i>     x-new-header: {&quot;key&quot;: &quot;value&quot;}
</I>&gt;<i>     user-agent: python-requests/2.25.1
</I>&gt;<i>     accept-encoding: gzip, deflate
</I>&gt;<i>     accept: */*
</I>&gt;<i>     content-length: 16
</I>&gt;<i>     content-type: application/json
</I>&gt;<i>     host: www.dst-server.com:22222 &lt;<A HREF="http://www.dst-server.com:22222">http://www.dst-server.com:22222</A>&gt;
</I>

FYI: The above incomplete ICAP response promises an HTTP request body,
both on the ICAP level (req-body) and on the HTTP level (content-length:
16).


&gt;<i> As I said, I use 'Preview: 0' since I don't mind the body. The question
</I>&gt;<i> is whether declaring the body starts at X (req-body=X) is OK even though
</I>&gt;<i> I don't have a body to send?
</I>
It is not OK not to send the body. Encapsulated:req-body does more than
declaring where the encapsulated headers end. It also promises an
embedded HTTP body after those headers. You must encapsulate the body if
the HTTP message should have one. You cannot adapt the header of an HTTP
message with a body without also sending the HTTP body (virgin or adapted).

Preview is pretty much irrelevant in this context -- the ICAP protocol
does not care how the ICAP service gets the HTTP body to include in the
ICAP response.

There are unofficial ICAP extensions that make it possible to tell the
ICAP client to reuse the body it has buffered while adapting the header,
but you should get the baseline case working before bothering with those
extensions -- they are optimizations that are not applicable to some
transactions.


&gt;<i> I think having req-null=X is bad since it
</I>&gt;<i> probably tells squid that I decided the adapted request&#160;should have no
</I>&gt;<i> body, but that's only a guess.
</I>
If you meant to say &quot;null-body&quot;, then you guessed correctly -- null-body
means the adapted HTTP message has no body. That is not what you want to
say when adapting most HTTP POST messages.


HTH,

Alex.

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="023203.html">[squid-users] Adding headers in ICAP server with no preview
</A></li>
	<LI>Next message (by thread): <A HREF="023209.html">[squid-users] Adding headers in ICAP server with no preview
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23204">[ date ]</a>
              <a href="thread.html#23204">[ thread ]</a>
              <a href="subject.html#23204">[ subject ]</a>
              <a href="author.html#23204">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
