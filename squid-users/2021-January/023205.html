<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Making destination IP available in ICAP REQMOD request
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Making%20destination%20IP%20available%20in%20ICAP%20REQMOD%20request&In-Reply-To=%3CCAGSk-42s3gSjoHfuhVsh%2BMRY44kDejkXdRjhvw6DjDmGK8Vq-Q%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="023208.html">
   <LINK REL="Next"  HREF="023206.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Making destination IP available in ICAP REQMOD request</H1>
    <B>Moti Berger</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Making%20destination%20IP%20available%20in%20ICAP%20REQMOD%20request&In-Reply-To=%3CCAGSk-42s3gSjoHfuhVsh%2BMRY44kDejkXdRjhvw6DjDmGK8Vq-Q%40mail.gmail.com%3E"
       TITLE="[squid-users] Making destination IP available in ICAP REQMOD request">moberger at metanetworks.com
       </A><BR>
    <I>Sun Jan 17 22:28:38 UTC 2021</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="023208.html">[squid-users] Adding headers in ICAP server with no preview
</A></li>
        <LI>Next message (by thread): <A HREF="023206.html">[squid-users] Making destination IP available in ICAP REQMOD request
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23205">[ date ]</a>
              <a href="thread.html#23205">[ thread ]</a>
              <a href="subject.html#23205">[ subject ]</a>
              <a href="author.html#23205">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi

My goal is to obtain the destination IP when sending an HTTP request for my
ICAP server so it would be able to decide the kind of adaptation required
based on it.

Looking at squid (5.0.4) code I discovered the following:

It seems that &quot;everything&quot; starts at ClientRequestContext.
I've noticed that noteAdaptationAclCheckDone calls startAdaptation which
calls more methods, eventually getting
to Adaptation::Icap::ModXact::makeRequestHeaders where it iterates over
headers defined by the adaptation_meta configurations in squid.conf.
For each, it calls the 'match' method where it tries to format (and
assemble) it. There it seems that the value is taken from an AccessLogEntry:

&gt;<i>    case LFT_SERVER_IP_ADDRESS:
</I>&gt;<i>             if (al-&gt;hier.tcpServer)
</I>&gt;<i>                 out = al-&gt;hier.tcpServer-&gt;remote.toStr(tmp, sizeof(tmp));
</I>&gt;<i>             break;
</I>&gt;<i>
</I>
So the AccessLogEntry object seems to be the key.
At REQMOD time, I don't get the value of the destination IP.
Looking further I found that the DNS resolving happens when it's decided
that the request should be forwarded to the destination server.

So I tracked the flow and it seems to start from FwdState::Start method
which gets an AccessLogEntryPointer.
Then it calls methods that eventually do the DNS resolving
(Dns::nbgethostbyname) and ending in (FwdState::connectStart) which have
the IP to connect to.
So it seems that this flow will populate the AccessLogEntry.
This seems right since during RESPMOD, the same code above
(in Adaptation::Icap::ModXact::makeRequestHeaders) is running and this time
the `match` method eventually gets the destination IP.
I added logs that prints the AccessLogEntryPointer and in the FwdState.cc
the log says address 0x5592ab521e30*12 and in the Notes.cc the log says
address 0x5592ab521e30*25.

Two things that I haven't found yet:
1. The place where the AccessLogEntry is populated
2. Where after the adaptation, the forwarding to the destination server
occured (assuming it should be forwarded)

I couldn't figure out a way to start the DNS resolving just before
the startAdaptation starts as it requires all sorts of objects that seem to
be unavailable there.
I wonder if you can help me to find a way to do it.

Thanks,
Moti
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20210118/cd7a2889/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20210118/cd7a2889/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="023208.html">[squid-users] Adding headers in ICAP server with no preview
</A></li>
	<LI>Next message (by thread): <A HREF="023206.html">[squid-users] Making destination IP available in ICAP REQMOD request
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23205">[ date ]</a>
              <a href="thread.html#23205">[ thread ]</a>
              <a href="subject.html#23205">[ subject ]</a>
              <a href="author.html#23205">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
