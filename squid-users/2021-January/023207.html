<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Making destination IP available in ICAP REQMOD request
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Making%20destination%20IP%20available%20in%20ICAP%20REQMOD%0A%20request&In-Reply-To=%3CCABA8h%3DSOsA%3DLMUk0DLaeFQQNCW-4ds%3DgGwa_y_RO5eh4cfeEaA%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="023206.html">
   <LINK REL="Next"  HREF="023213.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Making destination IP available in ICAP REQMOD request</H1>
    <B>NgTech LTD</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Making%20destination%20IP%20available%20in%20ICAP%20REQMOD%0A%20request&In-Reply-To=%3CCABA8h%3DSOsA%3DLMUk0DLaeFQQNCW-4ds%3DgGwa_y_RO5eh4cfeEaA%40mail.gmail.com%3E"
       TITLE="[squid-users] Making destination IP available in ICAP REQMOD request">ngtech1ltd at gmail.com
       </A><BR>
    <I>Mon Jan 18 07:47:16 UTC 2021</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="023206.html">[squid-users] Making destination IP available in ICAP REQMOD request
</A></li>
        <LI>Next message (by thread): <A HREF="023213.html">[squid-users] Making destination IP available in ICAP REQMOD request
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23207">[ date ]</a>
              <a href="thread.html#23207">[ thread ]</a>
              <a href="subject.html#23207">[ subject ]</a>
              <a href="author.html#23207">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hey Moti,

It is a good assumption that the same caching dns server (not 8.8.8.8 or
1.1.1.1) that the client use will return the relevant destination ip for
the domain.
Its possible to do such a query in the icap service with low timeout(2-3)
seconds.
can this be good enough for your use case?

Eliezer

On Mon, Jan 18, 2021, 00:28 Moti Berger &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">moberger at metanetworks.com</A>&gt; wrote:

&gt;<i> Hi
</I>&gt;<i>
</I>&gt;<i> My goal is to obtain the destination IP when sending an HTTP request for
</I>&gt;<i> my ICAP server so it would be able to decide the kind of adaptation
</I>&gt;<i> required based on it.
</I>&gt;<i>
</I>&gt;<i> Looking at squid (5.0.4) code I discovered the following:
</I>&gt;<i>
</I>&gt;<i> It seems that &quot;everything&quot; starts at ClientRequestContext.
</I>&gt;<i> I've noticed that noteAdaptationAclCheckDone calls startAdaptation which
</I>&gt;<i> calls more methods, eventually getting
</I>&gt;<i> to Adaptation::Icap::ModXact::makeRequestHeaders where it iterates over
</I>&gt;<i> headers defined by the adaptation_meta configurations in squid.conf.
</I>&gt;<i> For each, it calls the 'match' method where it tries to format (and
</I>&gt;<i> assemble) it. There it seems that the value is taken from an AccessLogEntry:
</I>&gt;<i>
</I>&gt;&gt;<i>    case LFT_SERVER_IP_ADDRESS:
</I>&gt;&gt;<i>             if (al-&gt;hier.tcpServer)
</I>&gt;&gt;<i>                 out = al-&gt;hier.tcpServer-&gt;remote.toStr(tmp, sizeof(tmp));
</I>&gt;&gt;<i>             break;
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> So the AccessLogEntry object seems to be the key.
</I>&gt;<i> At REQMOD time, I don't get the value of the destination IP.
</I>&gt;<i> Looking further I found that the DNS resolving happens when it's decided
</I>&gt;<i> that the request should be forwarded to the destination server.
</I>&gt;<i>
</I>&gt;<i> So I tracked the flow and it seems to start from FwdState::Start method
</I>&gt;<i> which gets an AccessLogEntryPointer.
</I>&gt;<i> Then it calls methods that eventually do the DNS resolving
</I>&gt;<i> (Dns::nbgethostbyname) and ending in (FwdState::connectStart) which have
</I>&gt;<i> the IP to connect to.
</I>&gt;<i> So it seems that this flow will populate the AccessLogEntry.
</I>&gt;<i> This seems right since during RESPMOD, the same code above
</I>&gt;<i> (in Adaptation::Icap::ModXact::makeRequestHeaders) is running and this time
</I>&gt;<i> the `match` method eventually gets the destination IP.
</I>&gt;<i> I added logs that prints the AccessLogEntryPointer and in the FwdState.cc
</I>&gt;<i> the log says address 0x5592ab521e30*12 and in the Notes.cc the log says
</I>&gt;<i> address 0x5592ab521e30*25.
</I>&gt;<i>
</I>&gt;<i> Two things that I haven't found yet:
</I>&gt;<i> 1. The place where the AccessLogEntry is populated
</I>&gt;<i> 2. Where after the adaptation, the forwarding to the destination server
</I>&gt;<i> occured (assuming it should be forwarded)
</I>&gt;<i>
</I>&gt;<i> I couldn't figure out a way to start the DNS resolving just before
</I>&gt;<i> the startAdaptation starts as it requires all sorts of objects that seem to
</I>&gt;<i> be unavailable there.
</I>&gt;<i> I wonder if you can help me to find a way to do it.
</I>&gt;<i>
</I>&gt;<i> Thanks,
</I>&gt;<i> Moti
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20210118/30fa32c7/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20210118/30fa32c7/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="023206.html">[squid-users] Making destination IP available in ICAP REQMOD request
</A></li>
	<LI>Next message (by thread): <A HREF="023213.html">[squid-users] Making destination IP available in ICAP REQMOD request
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23207">[ date ]</a>
              <a href="thread.html#23207">[ thread ]</a>
              <a href="subject.html#23207">[ subject ]</a>
              <a href="author.html#23207">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
