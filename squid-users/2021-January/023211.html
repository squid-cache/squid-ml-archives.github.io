<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Adding headers in ICAP server with no preview
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Adding%20headers%20in%20ICAP%20server%20with%20no%20preview&In-Reply-To=%3C2dbee277-e239-0759-9b79-cf857db25088%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="023210.html">
   <LINK REL="Next"  HREF="023222.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Adding headers in ICAP server with no preview</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Adding%20headers%20in%20ICAP%20server%20with%20no%20preview&In-Reply-To=%3C2dbee277-e239-0759-9b79-cf857db25088%40measurement-factory.com%3E"
       TITLE="[squid-users] Adding headers in ICAP server with no preview">rousskov at measurement-factory.com
       </A><BR>
    <I>Mon Jan 18 16:48:40 UTC 2021</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="023210.html">[squid-users] Adding headers in ICAP server with no preview
</A></li>
        <LI>Next message (by thread): <A HREF="023222.html">[squid-users] Adding headers in ICAP server with no preview
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23211">[ date ]</a>
              <a href="thread.html#23211">[ thread ]</a>
              <a href="subject.html#23211">[ subject ]</a>
              <a href="author.html#23211">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 1/18/21 6:45 AM, Moti Berger wrote:

&gt;<i> If the ICAP server sets 'Preview: 0' in the OPTIONS it means that when
</I>&gt;<i> the ICAP client sends a request, it should not contain the body.
</I>
The above summary may mislead many readers. I would describe the
protocol operation differently:

* Preview in an OPTIONS response indicates that the server supports
Preview in general and specifies the maximum Preview size the client
should use (e.g., Preview:0 limits Preview to HTTP headers).

* The Preview mode for a specific REQMOD or RESPMOD transaction is
signaled in the corresponding REQMOD or RESPMOD request (not a previous
OPTIONS response) by adding a Preview:N ICAP request header (Preview:0
specifies a headers-only Preview for the current transaction).

* The REQMOD or RESPMOD transaction with a Preview:0 request header is
split into two phases. During the first phase, the client must not send
the virgin body. During the second phase, if any, the client must send
the virgin body. Both phases comprise a single ICAP transaction, with a
single ICAP request and a single ICAP response. Thus, one cannot say
that this transaction (as a whole) &quot;should not contain a body&quot;.


&gt;<i> This is the REQMOD request:
</I>&gt;<i> 
</I>&gt;<i>     F..n...DREQMOD <A HREF="icap://censor-req.proxy:14590/request">icap://censor-req.proxy:14590/request</A> ICAP/1.0
</I>&gt;<i>     Host: censor-req.proxy:14590
</I>&gt;<i>     Date: Mon, 18 Jan 2021 11:34:54 GMT
</I>&gt;<i>     Encapsulated: req-hdr=0, req-body=222
</I>&gt;<i>     Preview: 0
</I>&gt;<i>     Allow: 204, trailers
</I>&gt;<i>     X-custom-header: data
</I>&gt;<i> 
</I>&gt;<i>     POST <A HREF="http://www.dst-server.com:22222/v1/test">http://www.dst-server.com:22222/v1/test</A> HTTP/1.1
</I>&gt;<i>     User-Agent: python-requests/2.25.1
</I>&gt;<i>     Accept-Encoding: gzip, deflate
</I>&gt;<i>     Accept: */*
</I>&gt;<i>     Content-Length: 10
</I>&gt;<i>     Content-Type: application/json
</I>&gt;<i>     Host: www.dst-server.com:22222 &lt;<A HREF="http://www.dst-server.com:22222">http://www.dst-server.com:22222</A>&gt;
</I>
&gt;<i> The ICAP 'Encapsulated' header has a req-body even though no 'body'
</I>&gt;<i> should be in this request.
</I>
Not exactly. The request may not be over at this point. Please see my
third bullet above for details.


&gt;<i> The ICAP server has no way to encapsulate the HTTP request body if it
</I>&gt;<i> didn't get it.
</I>
To get the request body in Preview:0 mode, the ICAP server must respond
with ICAP 100 (Continue).


&gt;<i> I want to avoid sending the body because the adaptation is body agnostic.
</I>
Yes, I know, but you have to work within the ICAP protocol boundaries.
ICAP simply does not optimize your use case! After you have the basics
working well, you can invest in implementing a use-original-body ICAP
extension[1] that, in _some_ cases, can prevent the body exchange while
adapting HTTP headers.

Alternatively, you can use an existing (extendible) ICAP server to do
the legwork for you [2]. Many individuals and companies have learned the
hard way that implementing an ICAP service correctly from scratch is
very difficult and often prohibitively expensive.

[1]
<A HREF="http://www.icap-forum.org/documents/specification/draft-icap-ext-partial-content-07.txt">http://www.icap-forum.org/documents/specification/draft-icap-ext-partial-content-07.txt</A>

[2] <A HREF="https://wiki.squid-cache.org/Features/ICAP#ICAP_Servers">https://wiki.squid-cache.org/Features/ICAP#ICAP_Servers</A>


HTH,

Alex.



&gt;<i> On Sun, Jan 17, 2021 at 11:34 PM Alex Rousskov wrote:
</I>&gt;<i> 
</I>&gt;<i>     On 1/17/21 3:08 PM, Moti Berger wrote:
</I>&gt;<i>     &gt; What should the ICAP response look like?
</I>&gt;<i> 
</I>&gt;<i>     The vast majority off ICAP responses containing an HTTP POST message
</I>&gt;<i>     will look like ICAP header + HTTP header + HTTP body. Please see RFC
</I>&gt;<i>     3507 and its errata for examples of and discussion about those three
</I>&gt;<i>     components. It should help avoid guessing and developing by examples
</I>&gt;<i>     (which usually leads to bugs, especially where ICAP is involved).
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i>     &gt; What I do is to reply like this:
</I>&gt;<i>     &gt;
</I>&gt;<i>     &gt;&#160; &#160; &#160;(dI./M..ICAP/1.0 200 OK
</I>&gt;<i>     &gt;&#160; &#160; &#160;ISTag: &quot;SjIzlRA4te41axxcDOoiSl6rBRg4ZK&quot;
</I>&gt;<i>     &gt;&#160; &#160; &#160;Date: Sun, 17 Jan 2021 19:34:12 GMT
</I>&gt;<i>     &gt;&#160; &#160; &#160;Server: BaseICAP/1.0 Python/3.6.12
</I>&gt;<i>     &gt;&#160; &#160; &#160;Encapsulated: req-hdr=0, req-body=360
</I>&gt;<i>     &gt;
</I>&gt;<i>     &gt;&#160; &#160; &#160;POST <A HREF="http://www.dst-server.com:22222/v1/test">http://www.dst-server.com:22222/v1/test</A> HTTP/1.1
</I>&gt;<i>     &gt;&#160; &#160; &#160;x-new-header: {&quot;key&quot;: &quot;value&quot;}
</I>&gt;<i>     &gt;&#160; &#160; &#160;user-agent: python-requests/2.25.1
</I>&gt;<i>     &gt;&#160; &#160; &#160;accept-encoding: gzip, deflate
</I>&gt;<i>     &gt;&#160; &#160; &#160;accept: */*
</I>&gt;<i>     &gt;&#160; &#160; &#160;content-length: 16
</I>&gt;<i>     &gt;&#160; &#160; &#160;content-type: application/json
</I>&gt;<i>     &gt;&#160; &#160; &#160;host: www.dst-server.com:22222
</I>&gt;<i>     &lt;<A HREF="http://www.dst-server.com:22222">http://www.dst-server.com:22222</A>&gt; &lt;<A HREF="http://www.dst-server.com:22222">http://www.dst-server.com:22222</A>&gt;
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i>     FYI: The above incomplete ICAP response promises an HTTP request body,
</I>&gt;<i>     both on the ICAP level (req-body) and on the HTTP level (content-length:
</I>&gt;<i>     16).
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i>     &gt; As I said, I use 'Preview: 0' since I don't mind the body. The
</I>&gt;<i>     question
</I>&gt;<i>     &gt; is whether declaring the body starts at X (req-body=X) is OK even
</I>&gt;<i>     though
</I>&gt;<i>     &gt; I don't have a body to send?
</I>&gt;<i> 
</I>&gt;<i>     It is not OK not to send the body. Encapsulated:req-body does more than
</I>&gt;<i>     declaring where the encapsulated headers end. It also promises an
</I>&gt;<i>     embedded HTTP body after those headers. You must encapsulate the body if
</I>&gt;<i>     the HTTP message should have one. You cannot adapt the header of an HTTP
</I>&gt;<i>     message with a body without also sending the HTTP body (virgin or
</I>&gt;<i>     adapted).
</I>&gt;<i> 
</I>&gt;<i>     Preview is pretty much irrelevant in this context -- the ICAP protocol
</I>&gt;<i>     does not care how the ICAP service gets the HTTP body to include in the
</I>&gt;<i>     ICAP response.
</I>&gt;<i> 
</I>&gt;<i>     There are unofficial ICAP extensions that make it possible to tell the
</I>&gt;<i>     ICAP client to reuse the body it has buffered while adapting the header,
</I>&gt;<i>     but you should get the baseline case working before bothering with those
</I>&gt;<i>     extensions -- they are optimizations that are not applicable to some
</I>&gt;<i>     transactions.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i>     &gt; I think having req-null=X is bad since it
</I>&gt;<i>     &gt; probably tells squid that I decided the adapted request&#160;should have no
</I>&gt;<i>     &gt; body, but that's only a guess.
</I>&gt;<i> 
</I>&gt;<i>     If you meant to say &quot;null-body&quot;, then you guessed correctly -- null-body
</I>&gt;<i>     means the adapted HTTP message has no body. That is not what you want to
</I>&gt;<i>     say when adapting most HTTP POST messages.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i>     HTH,
</I>&gt;<i> 
</I>&gt;<i>     Alex.
</I>&gt;<i> 
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="023210.html">[squid-users] Adding headers in ICAP server with no preview
</A></li>
	<LI>Next message (by thread): <A HREF="023222.html">[squid-users] Adding headers in ICAP server with no preview
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23211">[ date ]</a>
              <a href="thread.html#23211">[ thread ]</a>
              <a href="subject.html#23211">[ subject ]</a>
              <a href="author.html#23211">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
