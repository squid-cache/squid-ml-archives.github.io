<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Fixing Squid configuration for caching proxy?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Fixing%20Squid%20configuration%20for%20caching%20proxy%3F&In-Reply-To=%3C0b1894b8-9e01-f93f-a88d-d955d2dc2653%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="023274.html">
   <LINK REL="Next"  HREF="023277.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Fixing Squid configuration for caching proxy?</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Fixing%20Squid%20configuration%20for%20caching%20proxy%3F&In-Reply-To=%3C0b1894b8-9e01-f93f-a88d-d955d2dc2653%40measurement-factory.com%3E"
       TITLE="[squid-users] Fixing Squid configuration for caching proxy?">rousskov at measurement-factory.com
       </A><BR>
    <I>Fri Jan 29 16:40:12 UTC 2021</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="023274.html">[squid-users] Fixing Squid configuration for caching proxy?
</A></li>
        <LI>Next message (by thread): <A HREF="023277.html">[squid-users] Fixing Squid configuration for caching proxy?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23275">[ date ]</a>
              <a href="thread.html#23275">[ thread ]</a>
              <a href="subject.html#23275">[ subject ]</a>
              <a href="author.html#23275">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 1/28/21 1:34 PM, Milos Dodic wrote:

&gt;<i> I have noticed that the test server also doesn't cache anything
</I>&gt;<i> So if I try to go for a file in S3, it says MISS, and after that, MISS
</I>&gt;<i> again, and I see no new objects in cache being created.
</I>
&gt;<i> If I try the same thing from the proxy itself, I get the MISS, and the
</I>&gt;<i> object gets cached, as it should.
</I>&gt;<i> When I go back to the test server, and try again, it sees the object in
</I>&gt;<i> cache and returns TCP_MEM_HIT/200 instead.
</I>
Without more details, I can only speculate that the client running on
the test server sends different HTTP request headers than the client
running on the proxy itself. You can see the headers in cache.log if you
set debug_options to ALL,2. If you are not sure whether they are the
same, please share those logs. They will also contain response headers
and other potentially useful details.

If the request headers are the same in both tests, then I would
recommend sharing compressed ALL,7 or ALL,9 debugging logs of both
successful and unsuccessful tests (four transactions, two logs) for
analysis. Do not use sensitive data for these tests.

<A HREF="https://wiki.squid-cache.org/SquidFaq/BugReporting#Debugging_a_single_transaction">https://wiki.squid-cache.org/SquidFaq/BugReporting#Debugging_a_single_transaction</A>

Alex.



&gt;<i> This is the entire config file:
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> visible_hostname squid
</I>&gt;<i> cache_dir ufs /test/cache/squid 10000 16 256
</I>&gt;<i> 
</I>&gt;<i> http_access allow localhost
</I>&gt;<i> http_access alow all
</I>&gt;<i> 
</I>&gt;<i> http_port 3128
</I>&gt;<i> http_port 3129 intercept
</I>&gt;<i> acl allowed_http_sites dstdomain .amazonaws.com &lt;<A HREF="http://amazonaws.com">http://amazonaws.com</A>&gt;
</I>&gt;<i> http_access allow allowed_http_sites
</I>&gt;<i> 
</I>&gt;<i> https_port 3130 cert=/etc/squid/ssl/squid.pem ssl-bump intercept
</I>&gt;<i> acl SSL_port port 443
</I>&gt;<i> http_access allow SSL_port
</I>&gt;<i> acl allowed_https_sites ssl::server_name .amazonaws.com
</I>&gt;<i> &lt;<A HREF="http://amazonaws.com">http://amazonaws.com</A>&gt;
</I>&gt;<i> 
</I>&gt;<i> ssl_bump stare all
</I>&gt;<i> ssl_bump bump allowed_https_sites
</I>&gt;<i> ssl_bump terminate all
</I>

&gt;<i> On Tue, Jan 26, 2021 at 9:14 PM Alex Rousskov wrote:
</I>&gt;<i> 
</I>&gt;<i>     On 1/26/21 1:54 PM, Milos Dodic wrote:
</I>&gt;<i> 
</I>&gt;<i>     &gt; when the test server goes for a picture I have stored somewhere in
</I>&gt;<i>     &gt; the cloud, the squid access log shows &quot;TCP_TUNNEL/200&quot;. But when I
</I>&gt;<i>     &gt; try from the proxy itself with squidclient tool, I get
</I>&gt;<i>     &gt; &quot;TCP_MEM_HIT/200&quot;
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i>     Given the very limited information you have provided, I am guessing that
</I>&gt;<i> 
</I>&gt;<i>     * the primary tests opens a CONNECT tunnel through Squid
</I>&gt;<i>     * the squidclient test sends a plain text HTTP request to Squid
</I>&gt;<i> 
</I>&gt;<i>     The final origin server destination may be the same in both tests, but
</I>&gt;<i>     the two transactions are completely different from Squid point of view.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i>     &gt; ssl_bump peek step1 all
</I>&gt;<i>     &gt; ssl_bump peek step2 allowed_https_sites
</I>&gt;<i>     &gt; ssl_bump splice step3 allowed_https_sites
</I>&gt;<i>     &gt; ssl_bump terminate step3 all
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i>     AFAICT, this configuration is splicing or terminating all TLS traffic.
</I>&gt;<i>     No bumping at all. If you want your Squid to bump TLS tunnels, then you
</I>&gt;<i>     have to have at least one &quot;bump&quot; rule!
</I>&gt;<i> 
</I>&gt;<i>     I do not know what your overall SslBump needs are, but perhaps you meant
</I>&gt;<i>     something like the following?
</I>&gt;<i> 
</I>&gt;<i>     &#160; &#160; acl shouldBeBumped ssl::server_name .amazonaws.com
</I>&gt;<i>     &lt;<A HREF="http://amazonaws.com">http://amazonaws.com</A>&gt;
</I>&gt;<i> 
</I>&gt;<i>     &#160; &#160; ssl_bump stare all
</I>&gt;<i>     &#160; &#160; ssl_bump bump shouldBeBumped
</I>&gt;<i>     &#160; &#160; ssl_bump terminate all
</I>&gt;<i> 
</I>&gt;<i>     Please do not use the configuration above until you understand what it
</I>&gt;<i>     does. Please see <A HREF="https://wiki.squid-cache.org/Features/SslPeekAndSplice">https://wiki.squid-cache.org/Features/SslPeekAndSplice</A>
</I>&gt;<i>     for details.
</I>&gt;<i> 
</I>&gt;<i>     Depending on your environment, the http_access rules may need to be
</I>&gt;<i>     adjusted to allow CONNECT requests (to TLS-safe ports) to IP addresses
</I>&gt;<i>     that do not result in .amazonaws.com &lt;<A HREF="http://amazonaws.com">http://amazonaws.com</A>&gt; in
</I>&gt;<i>     reverse DNS lookups.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i>     HTH,
</I>&gt;<i> 
</I>&gt;<i>     Alex.
</I>&gt;<i> 
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="023274.html">[squid-users] Fixing Squid configuration for caching proxy?
</A></li>
	<LI>Next message (by thread): <A HREF="023277.html">[squid-users] Fixing Squid configuration for caching proxy?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23275">[ date ]</a>
              <a href="thread.html#23275">[ thread ]</a>
              <a href="subject.html#23275">[ subject ]</a>
              <a href="author.html#23275">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
