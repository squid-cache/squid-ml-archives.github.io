<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid &quot;suspending ICAP service for too many failures&quot;
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20%22suspending%20ICAP%20service%20for%20too%20many%0A%20failures%22&In-Reply-To=%3Cff0b198a-672a-541b-95d5-c0283aa6ed45%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="023276.html">
   <LINK REL="Next"  HREF="023285.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid &quot;suspending ICAP service for too many failures&quot;</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20%22suspending%20ICAP%20service%20for%20too%20many%0A%20failures%22&In-Reply-To=%3Cff0b198a-672a-541b-95d5-c0283aa6ed45%40measurement-factory.com%3E"
       TITLE="[squid-users] Squid &quot;suspending ICAP service for too many failures&quot;">rousskov at measurement-factory.com
       </A><BR>
    <I>Fri Jan 29 19:38:25 UTC 2021</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="023276.html">[squid-users] Squid &quot;suspending ICAP service for too many failures&quot;
</A></li>
        <LI>Next message (by thread): <A HREF="023285.html">[squid-users] Squid &quot;suspending ICAP service for too many failures&quot;
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23278">[ date ]</a>
              <a href="thread.html#23278">[ thread ]</a>
              <a href="subject.html#23278">[ subject ]</a>
              <a href="author.html#23278">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 1/29/21 11:55 AM, Andrea Venturoli wrote:

&gt;<i> I see Squid connections to C-ICAP starting to time out:
</I>&gt;<i> when the number of errors reach 10, Squid marks squidclamav service as
</I>&gt;<i> &quot;suspended&quot;.
</I>
&gt;<i> No big surprise.
</I>
IIRC, you did not disclose timeout suspicions before. This explanation
is news to me, and it eliminates several suspects.


&gt;<i> Still I don't get any more insight (Is C-ICAP choking?
</I>&gt;<i> Why? What data triggers this?).
</I>
If you are talking about Squid timing out when attempting to establish a
TCP connection with the ICAP server, then this may by as much insight as
you can get from the Squid side. There is no ICAP &quot;data&quot; at that
connection establishment stage. It is a fairly low-level operation that
Squid and c-icap have little control over. The problem is probably
outside Squid.

I do not know much about c-icap, but I would check whether its
configuration or something like crontab results in hourly restarts and
associated loss of connectivity. The network interface or the routing
tables might also be reset hourly for some reason. The ICAP
server/service might be running out of descriptors or memory.

One potentially useful test is to try to connect to the ICAP server
_while the problem is happening_ using telnet or netcat. When Squid
cannot establish a connection, can you? If the ICAP service is not
running on the Squid box, then try this test both from the Squid box and
from the ICAP box.

Packet captures can tell you whether other Squid-ICAP server connections
were active at the time, whether from-Squid SYN packets were able to
reach the ICAP server, etc.

In other words, basic network troubleshooting steps...


&gt;<i> Is it a really bad idea to raise icap_connect_timeout?
</I>
Higher timeout will delay HTTP client transactions for longer periods of
time, of course. If you want to go down the road of finding workarounds,
then check whether raising that timeout actually helps. It is not yet
clear (to me) whether the connections just need more time to be
established or are simply doomed.


&gt;<i> Same for disabling icap_service_failure_limit?
</I>
This is an essential ICAP service (icap_service bypass=off). I assume
there is no backup service -- no adaptation_service_set in play here. If
so, disabling the limit means that fewer HTTP transactions will be
inconvenienced in the long run than if the service were to be suspended.
 Hence, fewer ICAP errors will be delivered to Squid clients.

You can also enable bypass.

Fixing the problem would be a much better solution, of course.


HTH,

Alex.

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="023276.html">[squid-users] Squid &quot;suspending ICAP service for too many failures&quot;
</A></li>
	<LI>Next message (by thread): <A HREF="023285.html">[squid-users] Squid &quot;suspending ICAP service for too many failures&quot;
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23278">[ date ]</a>
              <a href="thread.html#23278">[ thread ]</a>
              <a href="subject.html#23278">[ subject ]</a>
              <a href="author.html#23278">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
