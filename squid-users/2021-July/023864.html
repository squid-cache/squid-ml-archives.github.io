<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] TPROXY Error
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20TPROXY%20Error&In-Reply-To=%3C68332d40-ba49-f426-21b8-48602608690e%40gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="023863.html">
   <LINK REL="Next"  HREF="023865.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] TPROXY Error</H1>
    <B>Ben Goz</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20TPROXY%20Error&In-Reply-To=%3C68332d40-ba49-f426-21b8-48602608690e%40gmail.com%3E"
       TITLE="[squid-users] TPROXY Error">ben.goz87 at gmail.com
       </A><BR>
    <I>Wed Jul  7 12:35:58 UTC 2021</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="023863.html">[squid-users] TPROXY Error
</A></li>
        <LI>Next message (by thread): <A HREF="023865.html">[squid-users] TPROXY Error
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23864">[ date ]</a>
              <a href="thread.html#23864">[ thread ]</a>
              <a href="subject.html#23864">[ subject ]</a>
              <a href="author.html#23864">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>By the help of God.


Hi Eliezer,

Thanks for your help.

Please let me know if you need more information.


Regards,

Ben

On 07/07/2021 14:01, Eliezer Croitoru wrote:
&gt;<i> Hey Ben,
</I>&gt;<i>
</I>&gt;<i> I want to try and reset this issue because I am missing some technical
</I>&gt;<i> details.
</I>&gt;<i>
</I>&gt;<i> 1. What Linux Distro and what version are you using?'
</I>Ubuntu 20.04
&gt;<i> 2. the output of 'ip address'
</I>$ ip address
1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN 
group default qlen 1000
 &#160;&#160;&#160; link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
 &#160;&#160;&#160; inet 127.0.0.1/8 scope host lo
 &#160;&#160;&#160;&#160;&#160;&#160; valid_lft forever preferred_lft forever
 &#160;&#160;&#160; inet6 ::1/128 scope host
 &#160;&#160;&#160;&#160;&#160;&#160; valid_lft forever preferred_lft forever
2: ens1f0: &lt;BROADCAST,MULTICAST,SLAVE,UP,LOWER_UP&gt; mtu 1500 qdisc mq 
master bond0 state UP group default qlen 1000
 &#160;&#160;&#160; link/ether ba:59:58:58:23:2b brd ff:ff:ff:ff:ff:ff
3: ens1f1: &lt;BROADCAST,MULTICAST,SLAVE,UP,LOWER_UP&gt; mtu 1500 qdisc mq 
master bond0 state UP group default qlen 1000
 &#160;&#160;&#160; link/ether ba:59:58:58:23:2b brd ff:ff:ff:ff:ff:ff
4: usb0: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc noop state DOWN group 
default qlen 1000
 &#160;&#160;&#160; link/ether ca:13:59:65:c2:56 brd ff:ff:ff:ff:ff:ff
5: enx00e04c3600d3: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc 
fq_codel state UP group default qlen 1000
 &#160;&#160;&#160; link/ether 00:e0:4c:36:00:d3 brd ff:ff:ff:ff:ff:ff
 &#160;&#160;&#160; inet 8.11.39.250/30 brd 8.11.39.251 scope global enx00e04c3600d3
 &#160;&#160;&#160;&#160;&#160;&#160; valid_lft forever preferred_lft forever
 &#160;&#160;&#160; inet6 fe80::2e0:4cff:fe36:d3/64 scope link
 &#160;&#160;&#160;&#160;&#160;&#160; valid_lft forever preferred_lft forever
6: bond0: &lt;BROADCAST,MULTICAST,MASTER,UP,LOWER_UP&gt; mtu 1500 qdisc 
noqueue state UP group default qlen 1000
 &#160;&#160;&#160; link/ether ba:59:58:58:23:2b brd ff:ff:ff:ff:ff:ff
 &#160;&#160;&#160; inet6 fe80::b859:58ff:fe58:232b/64 scope link
 &#160;&#160;&#160;&#160;&#160;&#160; valid_lft forever preferred_lft forever
7: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">bond0.212 at bond0</A>: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc 
noqueue state UP group default qlen 1000
 &#160;&#160;&#160; link/ether ba:59:58:58:23:2b brd ff:ff:ff:ff:ff:ff
 &#160;&#160;&#160; inet 8.13.140.1/28 brd 8.13.140.15 scope global bond0.212
 &#160;&#160;&#160;&#160;&#160;&#160; valid_lft forever preferred_lft forever
 &#160;&#160;&#160; inet6 fe80::b859:58ff:fe58:232b/64 scope link
 &#160;&#160;&#160;&#160;&#160;&#160; valid_lft forever preferred_lft forever
8: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">bond0.213 at bond0</A>: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc 
noqueue state UP group default qlen 1000
 &#160;&#160;&#160; link/ether ba:59:58:58:23:2b brd ff:ff:ff:ff:ff:ff
 &#160;&#160;&#160; inet 1.21.213.1/24 brd 1.21.213.255 scope global bond0.213
 &#160;&#160;&#160;&#160;&#160;&#160; valid_lft forever preferred_lft forever
 &#160;&#160;&#160; inet6 fe80::b859:58ff:fe58:232b/64 scope link
 &#160;&#160;&#160;&#160;&#160;&#160; valid_lft forever preferred_lft forever
&gt;<i> 3. the output of 'ip rule'
</I>$ ip rule
0:&#160;&#160;&#160; from all lookup local
32762:&#160;&#160;&#160; from all fwmark 0x1 lookup 100
32763:&#160;&#160;&#160; from all fwmark 0x1 lookup 100
32764:&#160;&#160;&#160; from all fwmark 0x1 lookup 100
32765:&#160;&#160;&#160; from all fwmark 0x1 lookup 100
32766:&#160;&#160;&#160; from all lookup main
32767:&#160;&#160;&#160; from all lookup default

&gt;<i> 4.  the output of 'ip route show'
</I>
$ ip route show
default via 8.13.140.14 dev bond0.212 proto static
1.21.213.0/24 dev bond0.213 proto kernel scope link src 1.21.213.1
8.11.39.248/30 dev enx00e04c3600d3 proto kernel scope link src 8.11.39.250
8.13.140.0/28 dev bond0.212 proto kernel scope link src 8.13.140.1
8.13.144.0/20 via 1.21.213.254 dev bond0.213
8.13.148.1 via 1.21.213.254 dev bond0.213

&gt;<i> 5.  the output of 'ip route show table 100'
</I>$ ip route show
default via 8.13.140.14 dev bond0.212 proto static
1.21.213.0/24 dev bond0.213 proto kernel scope link src 1.21.213.1
8.11.39.248/30 dev enx00e04c3600d3 proto kernel scope link src 8.11.39.250
8.13.140.0/28 dev bond0.212 proto kernel scope link src 8.13.140.1
8.13.144.0/20 via 1.21.213.254 dev bond0.213
8.13.148.1 via 1.21.213.254 dev bond0.213
&gt;<i> 6. the output of 'iptables-save'
</I>

$ sudo iptables-save
# Generated by iptables-save v1.8.4 on Wed Jul&#160; 7 12:25:05 2021
*mangle
:<i>PREROUTING ACCEPT [72898710:6084386298]
</I>:<i>INPUT ACCEPT [0:0]
</I>:<i>FORWARD ACCEPT [0:0]
</I>:<i>OUTPUT ACCEPT [0:0]
</I>:<i>POSTROUTING ACCEPT [0:0]
</I>:<i>DIVERT - [0:0]
</I>-A PREROUTING -p tcp -m socket -j DIVERT
-A PREROUTING -i bond0.213 -p tcp -m tcp --dport 80 -j TPROXY --on-port 
15644 --on-ip 0.0.0.0 --tproxy-mark 0x1/0x1
-A PREROUTING -i bond0.213 -p tcp -m tcp --dport 443 -j TPROXY --on-port 
15645 --on-ip 0.0.0.0 --tproxy-mark 0x1/0x1
-A INPUT -j ACCEPT
-A FORWARD -j ACCEPT
-A OUTPUT -j ACCEPT
-A POSTROUTING -j ACCEPT
-A DIVERT -j MARK --set-xmark 0x1/0xffffffff
-A DIVERT -j ACCEPT
COMMIT
# Completed on Wed Jul&#160; 7 12:25:05 2021
# Generated by iptables-save v1.8.4 on Wed Jul&#160; 7 12:25:05 2021
*nat
:<i>PREROUTING ACCEPT [26338415:1392747531]
</I>:<i>INPUT ACCEPT [820462:44161193]
</I>:<i>OUTPUT ACCEPT [1053:92773]
</I>:<i>POSTROUTING ACCEPT [25514534:1348449899]
</I>-A PREROUTING -i eth1 -p udp -m udp --dport 53 -j REDIRECT --to-ports 53
-A PREROUTING -i eth1 -p tcp -m tcp --dport 53 -j REDIRECT --to-ports 53
COMMIT
# Completed on Wed Jul&#160; 7 12:25:05 2021
# Generated by iptables-save v1.8.4 on Wed Jul&#160; 7 12:25:05 2021
*filter
:<i>INPUT ACCEPT [5045387:2170630036]
</I>:<i>FORWARD ACCEPT [72544426:6194710400]
</I>:<i>OUTPUT ACCEPT [2471930:252759773]
</I>COMMIT
# Completed on Wed Jul&#160; 7 12:25:05 20

&gt;<i> 7. the output of 'nft -nn list ruleset' (if exists on the OS)
</I>Doesn't exists.
&gt;<i> 8. the output of your squid.conf
</I>$ cat squid.conf
#
# Recommended minimum configuration:
#

# Example rule allowing access from your local networks.
# Adapt to list your (internal) IP networks from where browsing
# should be allowed
acl localnet src 0.0.0.1-0.255.255.255&#160;&#160;&#160; # RFC 1122 &quot;this&quot; network (LAN)
acl localnet src 10.0.0.0/8&#160;&#160;&#160; &#160;&#160;&#160; # RFC 1918 local private network (LAN)
acl localnet src 100.64.0.0/10&#160;&#160;&#160; &#160;&#160;&#160; # RFC 6598 shared address space (CGN)
acl localnet src 169.254.0.0/16 &#160;&#160;&#160; # RFC 3927 link-local (directly 
plugged) machines
acl localnet src 172.16.0.0/12&#160;&#160;&#160; &#160;&#160;&#160; # RFC 1918 local private network (LAN)
acl localnet src 192.168.0.0/16&#160;&#160;&#160; &#160;&#160;&#160; # RFC 1918 local private network 
(LAN)
acl localnet src fc00::/7&#160;&#160;&#160;&#160;&#160;&#160; &#160;&#160;&#160; # RFC 4193 local private network range
acl localnet src fe80::/10&#160;&#160;&#160;&#160;&#160; &#160;&#160;&#160; # RFC 4291 link-local (directly 
plugged) machines

acl SSL_ports port 443
acl Safe_ports port 80&#160;&#160;&#160; &#160;&#160;&#160; # http
acl Safe_ports port 21&#160;&#160;&#160; &#160;&#160;&#160; # ftp
acl Safe_ports port 443&#160;&#160;&#160; &#160;&#160;&#160; # https
acl Safe_ports port 70&#160;&#160;&#160; &#160;&#160;&#160; # gopher
acl Safe_ports port 210&#160;&#160;&#160; &#160;&#160;&#160; # wais
acl Safe_ports port 1025-65535&#160;&#160;&#160; # unregistered ports
acl Safe_ports port 280&#160;&#160;&#160; &#160;&#160;&#160; # http-mgmt
acl Safe_ports port 488&#160;&#160;&#160; &#160;&#160;&#160; # gss-http
acl Safe_ports port 591&#160;&#160;&#160; &#160;&#160;&#160; # filemaker
acl Safe_ports port 777&#160;&#160;&#160; &#160;&#160;&#160; # multiling http
acl CONNECT method CONNECT

#
# Recommended minimum Access Permission configuration:
#
# Deny requests to certain unsafe ports
http_access deny !Safe_ports

# Deny CONNECT to other than secure SSL ports
http_access deny CONNECT !SSL_ports

# Only allow cachemgr access from localhost
http_access allow localhost manager
http_access deny manager

# We strongly recommend the following be uncommented to protect innocent
# web applications running on the proxy server who think the only
# one who can access services on &quot;localhost&quot; is a local user
#http_access deny to_localhost

#
# INSERT YOUR OWN RULE(S) HERE TO ALLOW ACCESS FROM YOUR CLIENTS
#

# Example rule allowing access from your local networks.
# Adapt localnet in the ACL section to list your (internal) IP networks
# from where browsing should be allowed
http_access allow localnet
http_access allow localhost

# And finally deny all other access to this proxy
#http_access deny all

http_access allow all

# Squid normally listens to port 3128
http_port 15643
http_port 15644 tproxy
https_port 15645 ssl-bump tproxy generate-host-certificates=on 
options=ALL dynamic_cert_mem_cache_size=4MB 
cert=/usr/local/squid/etc/ssl_cert/myCA.pem 
dhparams=/usr/local/squid/etc/dhparam.pem
always_direct allow all
acl DiscoverSNIHost at_step SslBump1
acl NoSSLInterceptRegexp_always ssl::server_name_regex -i xxx
acl NoSSLIntercept ssl::server_name&#160; &quot;xxx&quot;
acl NoSSLInterceptRegexp ssl::server_name_regex -i &quot;xxx&quot;
ssl_bump splice NoSSLInterceptRegexp_always
ssl_bump splice NoSSLIntercept
ssl_bump splice NoSSLInterceptRegexp
ssl_bump peek DiscoverSNIHost
ssl_bump bump all
sslcrtd_program /usr/local/squid/libexec/security_file_certgen -s 
/var/lib/ssl_db -M 4MB
sslcrtd_children 32 startup=15 idle=3
#sslproxy_capath /etc/ssl/certs

# Uncomment and adjust the following to add a disk cache directory.
#cache_dir ufs /usr/local/squid/var/cache/squid 100 16 256

# Leave coredumps in the first cache dir
coredump_dir /usr/local/squid/var/cache/squid

#
# Add any of your own refresh_pattern entries above these.
#
refresh_pattern ^ftp:&#160;&#160;&#160; &#160;&#160;&#160; 1440&#160;&#160;&#160; 20%&#160;&#160;&#160; 10080
refresh_pattern ^gopher:&#160;&#160;&#160; 1440&#160;&#160;&#160; 0%&#160;&#160;&#160; 1440
refresh_pattern -i (/cgi-bin/|\?) 0&#160;&#160;&#160; 0%&#160;&#160;&#160; 0
refresh_pattern .&#160;&#160;&#160; &#160;&#160;&#160; 0&#160;&#160;&#160; 20%&#160;&#160;&#160; 4320

range_offset_limit -1

dns_v4_first on
forwarded_for off
cache deny all
&gt;<i> 9. the output of 'squid -v'
</I>$ ./squid -v
Squid Cache: Version 4.15
Service Name: squid

This binary uses OpenSSL 1.1.1f&#160; 31 Mar 2020. For legal restrictions on 
distribution see <A HREF="https://www.openssl.org/source/license.html">https://www.openssl.org/source/license.html</A>

configure options:&#160; '--with-openssl' '--enable-ssl-crtd' '--enable-ecap' 
'--enable-linux-netfilter' --enable-ltdl-convenience

&gt;<i> 10. the output of 'uname -a'
</I>uname -a
Linux xxx 5.4.0-77-generic #86-Ubuntu SMP Thu Jun 17 02:35:03 UTC 2021 
x86_64 x86_64 x86_64 GNU/Linux
&gt;<i>
</I>&gt;<i> Once we will have all the above details (reducing/modifying any private
</I>&gt;<i> details) we can try to maybe help you.
</I>&gt;<i>
</I>&gt;<i> Eliezer
</I>&gt;<i>
</I>&gt;<i> -----Original Message-----
</I>&gt;<i> From: squid-users &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>&gt; On Behalf Of
</I>&gt;<i> Ben Goz
</I>&gt;<i> Sent: Wednesday, June 30, 2021 3:16 PM
</I>&gt;<i> To: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> Subject: [squid-users] TPROXY Error
</I>&gt;<i>
</I>&gt;<i>   By the help of God.
</I>&gt;<i>
</I>&gt;<i> Hi All,
</I>&gt;<i> I'm trying to configure squid as a transparent proxy using TPROXY.
</I>&gt;<i> The machine I'm using has 2 NICs, one for input and the other one for
</I>&gt;<i> output traffic.
</I>&gt;<i> The TPROXY iptables rules are configured on the input NIC.
</I>&gt;<i> It looks like iptables TPROXY redirect works but squid prints out the
</I>&gt;<i> following error:
</I>&gt;<i>
</I>&gt;<i> ERROR: NAT/TPROXY lookup failed to locate original IPs on
</I>&gt;<i> local=xxx:443 remote=xxx:49471 FD 14 flags=17
</I>&gt;<i>
</I>&gt;<i> I think I loaded all TPROXY required kernel modules.
</I>&gt;<i>
</I>&gt;<i> The ip forwarding works fine without the iptables rules. and I don't
</I>&gt;<i> see any squid ERROR on getsockopt
</I>&gt;<i>
</I>&gt;<i> Please let me know what I'm missing?
</I>&gt;<i>
</I>&gt;<i> Thanks,
</I>&gt;<i> Ben
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i>
</I>
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="023863.html">[squid-users] TPROXY Error
</A></li>
	<LI>Next message (by thread): <A HREF="023865.html">[squid-users] TPROXY Error
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23864">[ date ]</a>
              <a href="thread.html#23864">[ thread ]</a>
              <a href="subject.html#23864">[ subject ]</a>
              <a href="author.html#23864">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
