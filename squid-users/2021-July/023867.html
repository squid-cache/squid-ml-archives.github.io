<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Ubuntu 20.04 &quot;apt update&quot; issues behind a VPN and Squid proxy
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Ubuntu%2020.04%20%22apt%20update%22%20issues%20behind%20a%20VPN%20and%0A%20Squid%20proxy&In-Reply-To=%3C1f5626ce-dea3-bc16-77f8-c9c2fe82b333%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="023866.html">
   <LINK REL="Next"  HREF="023868.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Ubuntu 20.04 &quot;apt update&quot; issues behind a VPN and Squid proxy</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Ubuntu%2020.04%20%22apt%20update%22%20issues%20behind%20a%20VPN%20and%0A%20Squid%20proxy&In-Reply-To=%3C1f5626ce-dea3-bc16-77f8-c9c2fe82b333%40treenet.co.nz%3E"
       TITLE="[squid-users] Ubuntu 20.04 &quot;apt update&quot; issues behind a VPN and Squid proxy">squid3 at treenet.co.nz
       </A><BR>
    <I>Thu Jul  8 02:17:13 UTC 2021</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="023866.html">[squid-users] Ubuntu 20.04 &quot;apt update&quot; issues behind a VPN and Squid proxy
</A></li>
        <LI>Next message (by thread): <A HREF="023868.html">[squid-users] Ubuntu 20.04 &quot;apt update&quot; issues behind a VPN and Squid proxy
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23867">[ date ]</a>
              <a href="thread.html#23867">[ thread ]</a>
              <a href="subject.html#23867">[ subject ]</a>
              <a href="author.html#23867">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>

On 8/07/21 11:44 am, David Mills wrote:
&gt;<i> Hi Eliezer,
</I>&gt;<i> 
</I>&gt;<i> We have:
</I>&gt;<i> 
</I>&gt;<i> /etc/apt/apt.conf:
</I>&gt;<i> 
</I>&gt;<i>     Acquire::http::proxy
</I>&gt;<i>     &quot;<A HREF="http://vpn-proxy-d68aca8a8f7f81d6.elb.ap-southeast-2.amazonaws.com:3128/">http://vpn-proxy-d68aca8a8f7f81d6.elb.ap-southeast-2.amazonaws.com:3128/</A>
</I>&gt;<i>     &lt;<A HREF="http://vpn-proxy-d68aca8a8f7f81d6.elb.ap-southeast-2.amazonaws.com:3128/">http://vpn-proxy-d68aca8a8f7f81d6.elb.ap-southeast-2.amazonaws.com:3128/</A>&gt;&quot;;
</I>&gt;<i>     Acquire::https::proxy
</I>&gt;<i>     &quot;<A HREF="http://vpn-proxy-d68aca8a8f7f81d6.elb.ap-southeast-2.amazonaws.com:3128/">http://vpn-proxy-d68aca8a8f7f81d6.elb.ap-southeast-2.amazonaws.com:3128/</A>
</I>&gt;<i>     &lt;<A HREF="http://vpn-proxy-d68aca8a8f7f81d6.elb.ap-southeast-2.amazonaws.com:3128/">http://vpn-proxy-d68aca8a8f7f81d6.elb.ap-southeast-2.amazonaws.com:3128/</A>&gt;&quot;;
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> /etc/apt/sources.list (comment lines removed for brevity)
</I>&gt;<i> 
</I>&gt;<i>     deb <A HREF="https://mirror.aarnet.edu.au/ubuntu/">https://mirror.aarnet.edu.au/ubuntu/</A>
</I>&gt;<i>     &lt;<A HREF="https://mirror.aarnet.edu.au/ubuntu/">https://mirror.aarnet.edu.au/ubuntu/</A>&gt; focal main restricted
</I>&gt;<i>     deb <A HREF="https://mirror.aarnet.edu.au/ubuntu/">https://mirror.aarnet.edu.au/ubuntu/</A>
</I>&gt;<i>     &lt;<A HREF="https://mirror.aarnet.edu.au/ubuntu/">https://mirror.aarnet.edu.au/ubuntu/</A>&gt; focal-updates main restricted
</I>&gt;<i>     deb <A HREF="https://mirror.aarnet.edu.au/ubuntu/">https://mirror.aarnet.edu.au/ubuntu/</A>
</I>&gt;<i>     &lt;<A HREF="https://mirror.aarnet.edu.au/ubuntu/">https://mirror.aarnet.edu.au/ubuntu/</A>&gt; focal-updates universe
</I>&gt;<i>     deb <A HREF="https://mirror.aarnet.edu.au/ubuntu/">https://mirror.aarnet.edu.au/ubuntu/</A>
</I>&gt;<i>     &lt;<A HREF="https://mirror.aarnet.edu.au/ubuntu/">https://mirror.aarnet.edu.au/ubuntu/</A>&gt; focal multiverse
</I>&gt;<i>     deb <A HREF="https://mirror.aarnet.edu.au/ubuntu/">https://mirror.aarnet.edu.au/ubuntu/</A>
</I>&gt;<i>     &lt;<A HREF="https://mirror.aarnet.edu.au/ubuntu/">https://mirror.aarnet.edu.au/ubuntu/</A>&gt; focal-updates multiverse
</I>&gt;<i>     deb <A HREF="https://mirror.aarnet.edu.au/ubuntu/">https://mirror.aarnet.edu.au/ubuntu/</A>
</I>&gt;<i>     &lt;<A HREF="https://mirror.aarnet.edu.au/ubuntu/">https://mirror.aarnet.edu.au/ubuntu/</A>&gt; focal-backports main
</I>&gt;<i>     restricted universe multiverse
</I>&gt;<i>     deb <A HREF="https://mirror.aarnet.edu.au/ubuntu">https://mirror.aarnet.edu.au/ubuntu</A>
</I>&gt;<i>     &lt;<A HREF="https://mirror.aarnet.edu.au/ubuntu">https://mirror.aarnet.edu.au/ubuntu</A>&gt; focal-security main restricted
</I>&gt;<i>     deb <A HREF="https://mirror.aarnet.edu.au/ubuntu">https://mirror.aarnet.edu.au/ubuntu</A>
</I>&gt;<i>     &lt;<A HREF="https://mirror.aarnet.edu.au/ubuntu">https://mirror.aarnet.edu.au/ubuntu</A>&gt; focal-security universe
</I>&gt;<i>     deb <A HREF="https://mirror.aarnet.edu.au/ubuntu">https://mirror.aarnet.edu.au/ubuntu</A>
</I>&gt;<i>     &lt;<A HREF="https://mirror.aarnet.edu.au/ubuntu">https://mirror.aarnet.edu.au/ubuntu</A>&gt; focal-security multiverse
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> squid.conf
</I>&gt;<i> 
</I>...
&gt;<i>     #
</I>&gt;<i>     # INSERT YOUR OWN RULE(S) HERE TO ALLOW ACCESS FROM YOUR CLIENTS
</I>&gt;<i>     #
</I>&gt;<i> 
</I>&gt;<i>     # Redirect HTTP to HTTPS
</I>&gt;<i>     acl port_80 port 80
</I>&gt;<i>     acl gstatic dstdomain www.gstatic.com &lt;<A HREF="http://www.gstatic.com">http://www.gstatic.com</A>&gt;
</I>&gt;<i>     http_access deny port_80 gstatic
</I>&gt;<i>     deny_info 301:<A HREF="https://%H%R">https://%H%R</A> gstatic
</I>&gt;<i> 
</I>&gt;<i>     acl avpc dstdomain crop-assessment.acusensus-vpc
</I>&gt;<i>     http_access deny port_80 avpc
</I>&gt;<i>     deny_info 302:&lt;company url&gt; avpc
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i>     # Deny HTTP
</I>&gt;<i>     http_access deny port_80
</I>&gt;<i> 
</I>&gt;<i>     # Whitelist of allowed sites
</I>&gt;<i>     acl allowed_http_sites dstdomain &quot;/etc/squid/squid.allowed.sites.txt&quot;
</I>&gt;<i>     http_access allow allowed_http_sites vpc_cidr
</I>&gt;<i> 
</I>
Is the &quot;mirror.aarnet.edu.au&quot; or a wildcard matching it listed in file 
squid.allowed.sites.txt ?

(I assume so, but checking in case it is that simple).


&gt;<i>     # And finally deny all other access to this proxy
</I>&gt;<i>     http_access deny all
</I>&gt;<i> 
</I>&gt;<i>     # Squid normally listens to port 3128
</I>&gt;<i>     http_port 3128 ssl-bump cert=/etc/squid/cert.pem
</I>&gt;<i>     acl allowed_https_sites ssl::server_name
</I>&gt;<i>     &quot;/etc/squid/squid.allowed.sites.txt&quot;
</I>&gt;<i>     acl step1 at_step SslBump1
</I>&gt;<i>     acl step2 at_step SslBump2
</I>&gt;<i>     acl step3 at_step SslBump3
</I>&gt;<i>     ssl_bump peek step1 all
</I>&gt;<i>     ssl_bump peek step2 allowed_https_sites
</I>&gt;<i>     ssl_bump splice step3 allowed_https_sites
</I>&gt;<i>     ssl_bump terminate step2 all
</I>&gt;<i> 
</I>&gt;<i>     # Uncomment and adjust the following to add a disk cache directory.
</I>&gt;<i>     #cache_dir ufs /var/spool/squid 100 16 256
</I>&gt;<i> 
</I>&gt;<i>     # Leave coredumps in the first cache dir
</I>&gt;<i>     coredump_dir /var/spool/squid
</I>&gt;<i>     #
</I>&gt;<i>     # Add any of your own refresh_pattern entries above these.
</I>&gt;<i>     #
</I>&gt;<i>     refresh_pattern ^ftp: 1440 20% 10080
</I>&gt;<i>     refresh_pattern ^gopher: 1440 0% 1440
</I>&gt;<i>     refresh_pattern -i (/cgi-bin/|\?) 0 0% 0
</I>&gt;<i>     refresh_pattern . 0 20% 4320
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Squid 3.5 is running on an EC2 instance running Amazon Linux 2. I'll 
</I>&gt;<i> answer the questions you asked Ben for extra info.
</I>&gt;<i> ip address:
</I>&gt;<i> 
</I>&gt;<i>     1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN
</I>&gt;<i>     group default qlen 1000
</I>&gt;<i>      &#160; &#160; link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
</I>&gt;<i>      &#160; &#160; inet 127.0.0.1/8 &lt;<A HREF="http://127.0.0.1/8">http://127.0.0.1/8</A>&gt; scope host lo
</I>&gt;<i>      &#160; &#160; &#160; &#160;valid_lft forever preferred_lft forever
</I>&gt;<i>      &#160; &#160; inet6 ::1/128 scope host
</I>&gt;<i>      &#160; &#160; &#160; &#160;valid_lft forever preferred_lft forever
</I>&gt;<i>     2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 9001 qdisc mq state
</I>&gt;<i>     UP group default qlen 1000
</I>&gt;<i>      &#160; &#160; link/ether 02:1b:15:b8:9a:06 brd ff:ff:ff:ff:ff:ff
</I>&gt;<i>      &#160; &#160; inet 10.0.12.111/24 &lt;<A HREF="http://10.0.12.111/24">http://10.0.12.111/24</A>&gt; brd 10.0.12.255
</I>&gt;<i>     scope global dynamic eth0
</I>&gt;<i>      &#160; &#160; &#160; &#160;valid_lft 2393sec preferred_lft 2393sec
</I>&gt;<i>      &#160; &#160; inet6 fe80::1b:15ff:feb8:9a06/64 scope link
</I>&gt;<i>      &#160; &#160; &#160; &#160;valid_lft forever preferred_lft forever
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> ip rule
</I>&gt;<i> 
</I>&gt;<i>     0: from all lookup local
</I>&gt;<i>     32766: from all lookup main
</I>&gt;<i>     32767: from all lookup default 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> ip route show
</I>&gt;<i> 
</I>&gt;<i>     default via 10.0.12.1 dev eth0
</I>&gt;<i>     10.0.12.0/24 &lt;<A HREF="http://10.0.12.0/24">http://10.0.12.0/24</A>&gt; dev eth0 proto kernel scope link
</I>&gt;<i>     src 10.0.12.111
</I>&gt;<i>     169.254.169.254 dev eth0
</I>&gt;<i> 
</I>&gt;<i> 
</I>

The traffic from Squid to the AArnet server is apparently using IPv6. Is 
that routing setup properly too?


...

&gt;<i>     From: squid-users On Behalf Of David Mills
</I>&gt;<i>     Sent: Wednesday, July 7, 2021 2:26 AM
</I>...
&gt;<i>     We have tried upgrading one to 20.04. Same setup. From the command
</I>&gt;<i>     line curl or wget can happily download an Ubuntu package from the
</I>&gt;<i>     Ubuntu Mirror site we use. But &quot;apt update&quot; gets lots of &quot;IGN:&quot;
</I>&gt;<i>     timeouts and errors.
</I>&gt;<i> 
</I>&gt;<i>     The package we test curl with is
</I>&gt;<i>     <A HREF="https://mirror.aarnet.edu.au/ubuntu/pool/main/c/curl/curl_7.68.0-1ubuntu2.5_amd64.deb">https://mirror.aarnet.edu.au/ubuntu/pool/main/c/curl/curl_7.68.0-1ubuntu2.5_amd64.deb</A>
</I>&gt;<i>     &lt;<A HREF="https://mirror.aarnet.edu.au/ubuntu/pool/main/c/curl/curl_7.68.0-1ubuntu2.5_amd64.deb">https://mirror.aarnet.edu.au/ubuntu/pool/main/c/curl/curl_7.68.0-1ubuntu2.5_amd64.deb</A>&gt;
</I>&gt;<i> 
</I>&gt;<i>     The Squid log shows a line the doesn't occur for the successful
</I>&gt;<i>     18.04 &quot;apt updates&quot;:
</I>&gt;<i>     1625190959.233&#160; &#160; &#160;81 10.0.11.191 TAG_NONE/200 0 CONNECT
</I>&gt;<i>     <A HREF="http://mirror.aarnet.edu.au:443">http://mirror.aarnet.edu.au:443</A> &lt;<A HREF="http://mirror.aarnet.edu.au:443">http://mirror.aarnet.edu.au:443</A>&gt; -
</I>&gt;<i>     HIER_DIRECT/2001:388:30bc:cafe::beef -
</I>&gt;<i> 
</I>
With Ubuntu 20.04 you should have received Squid-4 (v4.10 or later). 
Which logs a few things differently from Squid-3.5, particularly for 
SSL-Bump activity and client connections that lack HTTP messages.

The above log line shows SSL-Bump activity. At least step2 was reached, 
possibly also step3. Looking at this a little closer to see if it 
completes fine or has unseen issues would be my next point of approach.

To debug what is happening with SSL-Bump use &quot;debug_options ALL1, 11,2 
83,5&quot; and check the resulting cache.log.



&gt;<i>     The full output of an attempt to update is:
</I>&gt;<i>     Ign:1 <A HREF="https://mirror.aarnet.edu.au/ubuntu">https://mirror.aarnet.edu.au/ubuntu</A>
</I>&gt;<i>     &lt;<A HREF="https://mirror.aarnet.edu.au/ubuntu">https://mirror.aarnet.edu.au/ubuntu</A>&gt; focal InRelease
</I>&gt;<i>     Ign:2 <A HREF="https://mirror.aarnet.edu.au/ubuntu">https://mirror.aarnet.edu.au/ubuntu</A>
</I>&gt;<i>     &lt;<A HREF="https://mirror.aarnet.edu.au/ubuntu">https://mirror.aarnet.edu.au/ubuntu</A>&gt; focal-updates InRelease
</I>&gt;<i>     Ign:3 <A HREF="https://mirror.aarnet.edu.au/ubuntu">https://mirror.aarnet.edu.au/ubuntu</A>
</I>&gt;<i>     &lt;<A HREF="https://mirror.aarnet.edu.au/ubuntu">https://mirror.aarnet.edu.au/ubuntu</A>&gt; focal-backports InRelease
</I>&gt;<i>     Ign:4 <A HREF="https://mirror.aarnet.edu.au/ubuntu">https://mirror.aarnet.edu.au/ubuntu</A>
</I>&gt;<i>     &lt;<A HREF="https://mirror.aarnet.edu.au/ubuntu">https://mirror.aarnet.edu.au/ubuntu</A>&gt; focal-security InRelease
</I>

These &quot;Ign&quot; are fine. They just mean that apt has determined those files 
it has cached are up-to-date and do not need to be re-fetched right now.

The below &quot;Err&quot; are the problem:

&gt;<i>     Err:5 <A HREF="https://mirror.aarnet.edu.au/ubuntu">https://mirror.aarnet.edu.au/ubuntu</A>
</I>&gt;<i>     &lt;<A HREF="https://mirror.aarnet.edu.au/ubuntu">https://mirror.aarnet.edu.au/ubuntu</A>&gt; focal Release
</I>&gt;<i>      &#160; Could not wait for server fd - select (11: Resource temporarily
</I>&gt;<i>     unavailable) [IP: 10.0.11.82 3128]...
</I>&gt;<i> 
</I>&gt;<i>     While running, the line
</I>&gt;<i>     0% [Connecting to HTTP proxy
</I>&gt;<i>     (<A HREF="http://vpn-proxy-d68aca8a8f7f81d6.elb.ap-southeast-2.amazonaws.com:3128">http://vpn-proxy-d68aca8a8f7f81d6.elb.ap-southeast-2.amazonaws.com:3128</A>
</I>&gt;<i>     &lt;<A HREF="http://vpn-proxy-d68aca8a8f7f81d6.elb.ap-southeast-2.amazonaws.com:3128">http://vpn-proxy-d68aca8a8f7f81d6.elb.ap-southeast-2.amazonaws.com:3128</A>&gt;)]
</I>&gt;<i>     appears often and hang for a while.
</I>&gt;<i> 
</I>&gt;<i>     I've tried upping the squid logging and allowing all, but they
</I>&gt;<i>     didn't offer any additional information about the issue.
</I>&gt;<i> 
</I>
Your squid.conf looks fine, assuming the same http_access rules were 
used in your working version.


I suspect the issue is related to one or more of:

  * IPv6 routing

  * ICMP config issues (maybe outside your network)

  * SSL-Bump issues processing the client or server handshake traffic
    typically seen with OpenSSL library version or config mismatches 
between Squid, client and server.

  * network timeouts affecting Squid


HTH
Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="023866.html">[squid-users] Ubuntu 20.04 &quot;apt update&quot; issues behind a VPN and Squid proxy
</A></li>
	<LI>Next message (by thread): <A HREF="023868.html">[squid-users] Ubuntu 20.04 &quot;apt update&quot; issues behind a VPN and Squid proxy
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23867">[ date ]</a>
              <a href="thread.html#23867">[ thread ]</a>
              <a href="subject.html#23867">[ subject ]</a>
              <a href="author.html#23867">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
