<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Parent Proxy and direct traffic
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Parent%20Proxy%20and%20direct%20traffic&In-Reply-To=%3C5823cf8e23bc496c0d076bca7e538f6b%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="023907.html">
   <LINK REL="Next"  HREF="023908.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Parent Proxy and direct traffic</H1>
    <B>squid3 at treenet.co.nz</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Parent%20Proxy%20and%20direct%20traffic&In-Reply-To=%3C5823cf8e23bc496c0d076bca7e538f6b%40treenet.co.nz%3E"
       TITLE="[squid-users] Parent Proxy and direct traffic">squid3 at treenet.co.nz
       </A><BR>
    <I>Tue Jul 27 11:38:23 UTC 2021</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="023907.html">[squid-users] Parent Proxy and direct traffic
</A></li>
        <LI>Next message (by thread): <A HREF="023908.html">[squid-users] ICAP latency information, Bench-marking
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23911">[ date ]</a>
              <a href="thread.html#23911">[ thread ]</a>
              <a href="subject.html#23911">[ subject ]</a>
              <a href="author.html#23911">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 2021-07-26 23:05, jens.altrock wrote:
&gt;<i> Hi!
</I>&gt;<i> 
</I>&gt;<i> I got a little Problem:
</I>&gt;<i> 
</I>&gt;<i> We have a proxy server that should route special requests to a parent
</I>&gt;<i> proxy and forward the rest tot he standard gateway. I haven't found
</I>&gt;<i> any suitable and working configurations, so I'm asking ehre for help.
</I>
You appear to not understand some of the directives correctly.

As a result your config currently forces Squid to ignore all cache_peer 
lines.



&gt;<i> My configuration so far:
</I>&gt;<i> 
</I>

&gt;<i> 
</I>&gt;<i> _acl alwayspeer dstdomain EXAMPLE.COM:777_
</I>&gt;<i> 
</I>
&quot;:777&quot; is not part of any domain name.

This ACL can never produce a match result.

To check two different properties (domain and port) you need two 
different ACLs.

For example;
  acl example dstdomain example.com
  acl port777 port 777

  cache_peer_access PARENT_PROXY_SRV allow example port777
  never_direct allow example port777


&gt;<i> 
</I>&gt;<i> _cache deny all_
</I>&gt;<i> 
</I>&gt;<i> _cache_peer PARENT_PROXY_SRV parent 8080 7 proxy-only no-query_
</I>&gt;<i> 
</I>&gt;<i> _cache_peer_access PARENT_PROXY_SRV allow alwayspeer_
</I>&gt;<i> 
</I>
Since &quot;alwayspeer&quot; is always false this line means the default for 
traffic going to this peer is &quot;deny all&quot;.

With the ACL adjustments from above this would be:

  cache_peer_access PARENT_PROXY_SRV allow example port777


&gt;<i> 
</I>&gt;<i> _#http_access deny !Safe_ports_
</I>&gt;<i> 
</I>&gt;<i> _#http_access deny CONNECT !SSL_ports_
</I>&gt;<i> 
</I>
Please restore those rules. They are protecting your proxy against being 
abused as a relay for DoS attacks against your network. They have 
nothing to do with routing of valid HTTP messages.


&gt;<i> 
</I>&gt;<i> _http_access allow localhost manager_
</I>&gt;<i> 
</I>
&gt;<i> _http_access allow all Safe_ports_
</I>&gt;<i> 
</I>&gt;<i> _http_access allow all SSL_ports_
</I>&gt;<i> 
</I>
Remove those two lines **urgently**.


&gt;<i> _never_direct deny alwayspeer_
</I>&gt;<i> 
</I>&gt;<i> _always_direct allow all_
</I>&gt;<i> 
</I>
 From the actions chosen I see you misunderstand these two directives.

&quot;DIRECT&quot; means using DNS (or equivalent) to locate and connect to origin 
server(s) from the URL domain name.

always_direct has precedence. So &quot;allow all&quot; means servers will *always* 
be found using URL domain and DNS instead of your config file and 
cache_peer lines.

   -&gt; you need to remove the always_direct line.

never_direct means the URL domain / DNS lookup mechanism is *never* 
used. Only cache_peer have any possibility, and only when 
cache_peer_access rules also say allow.

   -&gt; the 'action' field needs to be &quot;allow&quot; in order to force cache_peer 
to be used.

In both of these directives &quot;deny&quot; is simply a way to stop processing 
the directive lines before any more checks happen. eg, a way to put 
&quot;except&quot; or &quot;unless&quot; clauses into the logic.



&gt;<i> 
</I>&gt;<i> _http_access deny all_
</I>&gt;<i> 
</I>
No http_access rules placed below this will be checked. You should 
remove this line.

FYI; the whole point of include directive on the next line is so you can 
put your custom cache_peer and related rules into a file in there and 
not worry about the OS Squid package fiddling with it.

&gt;<i> 
</I>&gt;<i> _include /etc/squid/conf.d/*_
</I>&gt;<i> 
</I>&gt;<i> _http_access allow localhost_
</I>&gt;<i> 
</I>&gt;<i> _http_access deny all_
</I>&gt;<i> 
</I>

&gt;<i> 
</I>&gt;<i> Problem ist hat direct traffic is working, but he doesn't redirect
</I>&gt;<i> EXAMPLE.COM:777 to the correct Proxy server.
</I>&gt;<i> 
</I>&gt;<i> In the access.log I only see:
</I>&gt;<i> 
</I>&gt;<i> 1627297417.299  31535 CLIENT_IP NONE/503 0 CONNECT EXAMPLE.COM:777 -
</I>&gt;<i> HIER_NONE/- -
</I>&gt;<i> 
</I>

Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="023907.html">[squid-users] Parent Proxy and direct traffic
</A></li>
	<LI>Next message (by thread): <A HREF="023908.html">[squid-users] ICAP latency information, Bench-marking
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23911">[ date ]</a>
              <a href="thread.html#23911">[ thread ]</a>
              <a href="subject.html#23911">[ subject ]</a>
              <a href="author.html#23911">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
