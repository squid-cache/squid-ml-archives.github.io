<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Cache Peer Issue with URL
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Cache%20Peer%20Issue%20with%20URL&In-Reply-To=%3Cd11ab64a-f931-7a8d-fc7e-d4fb68f6c2fe%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="023728.html">
   <LINK REL="Next"  HREF="023730.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Cache Peer Issue with URL</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Cache%20Peer%20Issue%20with%20URL&In-Reply-To=%3Cd11ab64a-f931-7a8d-fc7e-d4fb68f6c2fe%40measurement-factory.com%3E"
       TITLE="[squid-users] Cache Peer Issue with URL">rousskov at measurement-factory.com
       </A><BR>
    <I>Sat Jun  5 15:08:24 UTC 2021</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="023728.html">[squid-users] Cache Peer Issue with URL
</A></li>
        <LI>Next message (by thread): <A HREF="023730.html">[squid-users] Testing eCap module
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23729">[ date ]</a>
              <a href="thread.html#23729">[ thread ]</a>
              <a href="subject.html#23729">[ subject ]</a>
              <a href="author.html#23729">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 6/5/21 11:03 AM, koshik moshik wrote:

&gt;<i> Due to encrypted traffic, is it even possible to get the path for https
</I>&gt;<i> sites?
</I>
No, Squid cannot see URL paths of encrypted requests. In an increasing
number of cases, even the exact domain name is not known. Use access.log
to see what URLs Squid sees.

Alex.


&gt;<i> My current squid.conf looks like this and it is not working:&#160;
</I>&gt;<i> 
</I>&gt;<i> http_port 2115
</I>&gt;<i> http_port 2116
</I>&gt;<i> dns_v4_first on
</I>&gt;<i> acl SSL_ports port 1-65535
</I>&gt;<i> acl Safe_ports port 1-65535
</I>&gt;<i> acl CONNECT method CONNECT
</I>&gt;<i> http_access deny !Safe_ports
</I>&gt;<i> http_access deny CONNECT !SSL_ports
</I>&gt;<i> acl ban_domains dstdomain &quot;/etc/squid/blacklist.txt&quot;
</I>&gt;<i> http_access deny ban_domains
</I>&gt;<i> auth_param basic program /usr/lib/squid/basic_ncsa_auth /etc/squid/.htpasswd
</I>&gt;<i> auth_param basic children 5
</I>&gt;<i> auth_param basic realm Squid Basic Authentication
</I>&gt;<i> auth_param basic credentialsttl 5 hours
</I>&gt;<i> external_acl_type file_userip ipv4 %MYADDR %LOGIN
</I>&gt;<i> /usr/lib/squid/ext_file_userip_acl -f /etc/squid/ip.txt
</I>&gt;<i> external_acl_type file_user %MYPORT %LOGIN
</I>&gt;<i> /usr/lib/squid/ext_file_userip_acl -f /etc/squid/users.txt
</I>&gt;<i> acl password proxy_auth REQUIRED
</I>&gt;<i> acl IP_USER external file_userip
</I>&gt;<i> acl USERS external file_user
</I>&gt;<i> http_access deny !IP_USER
</I>&gt;<i> http_access deny !USERS
</I>&gt;<i> http_access allow password
</I>&gt;<i> http_access deny all
</I>&gt;<i> cache deny all
</I>&gt;<i> never_direct allow all
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> acl ab1 urlpath_regex .
</I>&gt;<i> cache_peer my.proxy parent 3128 0 login=user:pw no-query name=user1
</I>&gt;<i> cache_peer_access user1 allow ab1
</I>&gt;<i> cache_peer_access user1 deny all
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> acl ab proxy_auth test
</I>&gt;<i> cache_peer my.proxy parent 3128 0 login=user:pw no-query name=user2
</I>&gt;<i> cache_peer_access user2 deny ab1
</I>&gt;<i> cache_peer_access user2 allow all
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> # Leave coredumps in the first cache dir
</I>&gt;<i> coredump_dir /var/spool/squid
</I>&gt;<i> 
</I>&gt;<i> #Rules to anonymize http headers
</I>&gt;<i> forwarded_for off
</I>&gt;<i> request_header_access Allow allow all
</I>&gt;<i> request_header_access Authorization allow all
</I>&gt;<i> request_header_access WWW-Authenticate allow all
</I>&gt;<i> request_header_access Proxy-Authorization allow all
</I>&gt;<i> request_header_access Proxy-Authenticate allow all
</I>&gt;<i> request_header_access Cache-Control allow all
</I>&gt;<i> request_header_access Content-Encoding allow all
</I>&gt;<i> request_header_access Content-Length allow all
</I>&gt;<i> request_header_access Content-Type allow all
</I>&gt;<i> request_header_access Date allow all
</I>&gt;<i> request_header_access Expires allow all
</I>&gt;<i> request_header_access Host allow all
</I>&gt;<i> request_header_access If-Modified-Since allow all
</I>&gt;<i> request_header_access Last-Modified allow all
</I>&gt;<i> request_header_access Location allow all
</I>&gt;<i> request_header_access Pragma allow all
</I>&gt;<i> request_header_access Accept allow all
</I>&gt;<i> request_header_access Accept-Charset allow all
</I>&gt;<i> request_header_access Accept-Encoding allow all
</I>&gt;<i> request_header_access Accept-Language allow all
</I>&gt;<i> request_header_access Content-Language allow all
</I>&gt;<i> request_header_access Mime-Version allow all
</I>&gt;<i> request_header_access Retry-After allow all
</I>&gt;<i> request_header_access Title allow all
</I>&gt;<i> request_header_access Connection allow all
</I>&gt;<i> request_header_access Proxy-Connection allow all
</I>&gt;<i> request_header_access User-Agent allow all
</I>&gt;<i> request_header_access Cookie allow all
</I>&gt;<i> request_header_access All deny all
</I>&gt;<i> 
</I>&gt;<i> #
</I>&gt;<i> # Add any of your own refresh_pattern entries above these.
</I>&gt;<i> #
</I>&gt;<i> refresh_pattern ^ftp: 1440 20% 10080
</I>&gt;<i> refresh_pattern ^gopher: 1440 0% 1440
</I>&gt;<i> refresh_pattern -i (/cgi-bin/|\?) 0 0% 0
</I>&gt;<i> refresh_pattern (Release|Packages(.gz)*)$ &#160; &#160; &#160;0 &#160; &#160; &#160; 20% &#160; &#160; 2880
</I>&gt;<i> refresh_pattern . 0 20% 4320
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> On Sat, Jun 5, 2021 at 1:10 AM Alex Rousskov
</I>&gt;<i> &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>
</I>&gt;<i> &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt;&gt; wrote:
</I>&gt;<i> 
</I>&gt;<i>     On 6/4/21 4:19 PM, koshik moshik wrote:
</I>&gt;<i>     &gt; Basically I have created two cashe peers:
</I>&gt;<i>     &gt;
</I>&gt;<i>     &gt; never_direct allow all
</I>&gt;<i>     &gt; acl ab1 dstdom_regex &quot;/etc/squid/Bad_Homepages.squid&quot; cache_peer
</I>&gt;<i>     &gt; my.proxy.com &lt;<A HREF="http://my.proxy.com">http://my.proxy.com</A>&gt; &lt;<A HREF="http://my.proxy.com">http://my.proxy.com</A>
</I>&gt;<i>     &lt;<A HREF="http://my.proxy.com">http://my.proxy.com</A>&gt;&gt; parent 31112 0 login=user:pw no-query
</I>&gt;<i>     &gt; name=user cache_peer_access user allow ab1 cache_peer_access user deny
</I>&gt;<i>     &gt; all acl ab2 proxy_auth userName1 cache_peer myProxyparent 31112 0
</I>&gt;<i>     &gt; login=user:pwno-query name=user2 cache_peer_access user2 allow ab2
</I>&gt;<i>     &gt; cache_peer_access user2 deny all
</I>&gt;<i>     &gt;
</I>&gt;<i>     &gt;
</I>&gt;<i>     &gt; As you can see, I have a Bad_homepages.squid file which contains
</I>&gt;<i>     regular
</I>&gt;<i>     &gt; expressions for a website, so this cache_peer will only be used,
</I>&gt;<i>     if the
</I>&gt;<i>     &gt; HOMEPAGE is requested. If a sub page is requested, the second
</I>&gt;<i>     &gt; cache_peer(acl ab2) should be used.&#160;
</I>&gt;<i>     &gt;
</I>&gt;<i>     &gt; Example: www.test.com &lt;<A HREF="http://www.test.com">http://www.test.com</A>&gt; &lt;<A HREF="http://www.test.com">http://www.test.com</A>
</I>&gt;<i>     &lt;<A HREF="http://www.test.com">http://www.test.com</A>&gt;&gt; -&gt; ab1 should be used&#160;
</I>&gt;<i>     &gt; www.test.com/hello &lt;<A HREF="http://www.test.com/hello">http://www.test.com/hello</A>&gt;
</I>&gt;<i>     &lt;<A HREF="http://www.test.com/hello">http://www.test.com/hello</A> &lt;<A HREF="http://www.test.com/hello">http://www.test.com/hello</A>&gt;&gt; -&gt; ab2
</I>&gt;<i>     should be used.&#160;
</I>&gt;<i> 
</I>&gt;<i>     Sorry about bad quoting -- Thunderbird is having trouble with your HTML
</I>&gt;<i>     email...
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i>     &gt; The regex in the Bad_Homepages.squid file is following:
</I>&gt;<i>     &gt; .whatismyip.com &lt;<A HREF="http://whatismyip.com">http://whatismyip.com</A>&gt;($|/$|/?)
</I>&gt;<i> 
</I>&gt;<i>     It looks like you are using a domain-based dstdom_regex but trying to
</I>&gt;<i>     match URL paths. If you are trying to detect URLs with non-empty paths,
</I>&gt;<i>     then you may want to use something like
</I>&gt;<i> 
</I>&gt;<i>     &#160; acl ab1 urlpath_regex .
</I>&gt;<i> 
</I>&gt;<i>     or
</I>&gt;<i> 
</I>&gt;<i>     &#160; acl ab1 urlpath_regex /.
</I>&gt;<i> 
</I>&gt;<i>     I do not know whether the leading slash is included and the built-in
</I>&gt;<i>     docs do not say. Others on the list may know the answer or you can find
</I>&gt;<i>     it using tests.
</I>&gt;<i> 
</I>&gt;<i>     You can make the regex tighter by excluding repeated &quot;/&quot; characters and
</I>&gt;<i>     &quot;#&quot;, but those are usually unimportant details if you keep in mind that
</I>&gt;<i>     nothing will work reliably in general because the URL path may contain a
</I>&gt;<i>     lot of stuff that the origin server may ignore or reinterpret.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i>     Finally, if you want Squid to use either peer A or peer B, then do not
</I>&gt;<i>     use two different ACLs to direct traffic to them. Use mutually exclusive
</I>&gt;<i>     tests of one ACL:
</I>&gt;<i> 
</I>&gt;<i>     &#160; cache_peer_access user allow ab1
</I>&gt;<i>     &#160; cache_peer_access user deny all
</I>&gt;<i> 
</I>&gt;<i>     &#160; cache_peer_access user2 deny ab1
</I>&gt;<i>     &#160; cache_peer_access user2 allow all
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i>     Please be mindful of nonhierarchical_direct and encrypted traffic.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i>     HTH,
</I>&gt;<i> 
</I>&gt;<i>     Alex.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i>     _______________________________________________
</I>&gt;<i>     squid-users mailing list
</I>&gt;<i>     <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i>     &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>&gt;
</I>&gt;<i>     <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i>     &lt;<A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>&gt;
</I>&gt;<i> 
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="023728.html">[squid-users] Cache Peer Issue with URL
</A></li>
	<LI>Next message (by thread): <A HREF="023730.html">[squid-users] Testing eCap module
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23729">[ date ]</a>
              <a href="thread.html#23729">[ thread ]</a>
              <a href="subject.html#23729">[ subject ]</a>
              <a href="author.html#23729">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
