<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Issues with SSLBumped high traffic forward caching
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Issues%20with%20SSLBumped%20high%20traffic%20forward%20caching&In-Reply-To=%3C20210609160409.2278fd90%40r2d2.marmotte.net%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="023760.html">
   <LINK REL="Next"  HREF="023753.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Issues with SSLBumped high traffic forward caching</H1>
    <B>Matthias Saou</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Issues%20with%20SSLBumped%20high%20traffic%20forward%20caching&In-Reply-To=%3C20210609160409.2278fd90%40r2d2.marmotte.net%3E"
       TITLE="[squid-users] Issues with SSLBumped high traffic forward caching">matthias at saou.eu
       </A><BR>
    <I>Wed Jun  9 14:04:09 UTC 2021</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="023760.html">[squid-users] custom DNS resolver scripts? (was: Re: Is it possible to force some dstdomain to ipv4) protocol without define an outgoing ip address ?
</A></li>
        <LI>Next message (by thread): <A HREF="023753.html">[squid-users] Issues with SSLBumped high traffic forward caching
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23752">[ date ]</a>
              <a href="thread.html#23752">[ thread ]</a>
              <a href="subject.html#23752">[ subject ]</a>
              <a href="author.html#23752">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

We have a fairly simple (in theory) use case where we have a bunch of
headless Chromium browsers connecting to websites on the Internet
through various geo-specific proxies. To speed things up, we'd like to
add a caching layer, since it's perfectly acceptable for us to honor all
max-age/expires/etc. headers for all of the accessed content.

Nearly all accesses use https, so we've had to implement SSLBump, and
we went with squid 5. That part seems to work well enough.

We initially went with multiple servers configured as cache peers, but
since we've been seeing a lot of different problems, we're now focusing
on a single squid 5.0.6 server.

It has 128GB RAM, a 16 core EPYC CPU, 3TB+ of NVMe storage and 1Gbps
Internet bandwidth, which we'd obviously like to use as much as
possible.

What we have configured is:
* Multiple http_port with a cache_peer each to access remote geo
  specific proxies. We've had to rebuild with -DMAXTCPLISTENPORTS=512
  to increase the 128 default. Example (sorry for the line breaks):

acl port_usa1 localport 21083
http_port 21083 ssl-bump cert=/etc/squid/ssl_cert/myCA.pem \
  generate-host-certificates=on dynamic_cert_mem_cache_size=32MB
cache_peer 198.51.100.66 parent 443 3130 no-query no-digest no-delay \
  name=usa1 cache_peer_access usa1 allow port_usa1

* Simple SSLBump setup, where we don't check origins for cached objects
  to avoid the added latency, use a local CA and have Chromium
  configured to ignore all SSL/TLS mismatches:

sslcrtd_program /usr/lib64/squid/security_file_certgen -s \
  /var/cache/squid/ssl_db -M 32MB
acl step1 at_step SslBump1
acl step2 at_step SslBump2
acl step3 at_step SslBump3
ssl_bump client-first

* Memory and disk cache to try and use resources as much as possible:

workers 4
cache_mem 81920 MB
memory_cache_shared on
shared_transient_entries_limit 65536
minimum_object_size 0 KB
maximum_object_size 20 MB
maximum_object_size_in_memory 2048 KB
#cache_dir rock /var/spool/squid 3453640 
max_filedescriptors 16384

We've tried a lot of other configuration options, read a lot of
documentation, but we're still getting a lot of errors in the logs.
Here are the most worrying:

assertion failed: Transients.cc:221: &quot;old == e&quot;

When that &quot;assertion failed&quot; happens, the kid dies and a new one gets
forked in its place. We can see that happen multiple times per minute.

ERROR: Collapsed forwarding queue overflow for kid1 at 1024 items

This one seems to be impossible for us to track down. It doesn't show
up immediately, but always ends up coming back, and can be multiple
times per second when we have a high usage peak. We've tried:
 * Enabling/disabling &quot;collapsed_forwarding&quot;, nothing changes. It should
   be off by default, but this message is there nevertheless.
 * Recompiling squid with the value raised to 4096. Same message with
   the new value.
 * Disabling the &quot;cache_dir rock&quot;. It seems to then take longer to
   appear, but does ultimately appear again.

Could anyone provide pointers on how to track down what could be
causing these two errors? We can provide configuration, logs, traces
and dumps as needed.

Cheers,
Matthias

-- 
            Matthias Saou                  &#9608;&#9608;          &#9608;&#9608;
                                             &#9608;&#9608;      &#9608;&#9608;
Web: <A HREF="http://matthias.saou.eu/">http://matthias.saou.eu/</A>              &#9608;&#9608;&#9608;&#9608;&#9608;&#9608;&#9608;&#9608;&#9608;&#9608;&#9608;&#9608;&#9608;&#9608;
Mail/XMPP:  <A HREF="https://lists.squid-cache.org/listinfo/squid-users">matthias at saou.eu</A>             &#9608;&#9608;&#9608;&#9608;  &#9608;&#9608;&#9608;&#9608;&#9608;&#9608;  &#9608;&#9608;&#9608;&#9608;
                                       &#9608;&#9608;&#9608;&#9608;&#9608;&#9608;&#9608;&#9608;&#9608;&#9608;&#9608;&#9608;&#9608;&#9608;&#9608;&#9608;&#9608;&#9608;&#9608;&#9608;&#9608;&#9608;
GPG: 4096R/E755CC63                    &#9608;&#9608;  &#9608;&#9608;&#9608;&#9608;&#9608;&#9608;&#9608;&#9608;&#9608;&#9608;&#9608;&#9608;&#9608;&#9608;  &#9608;&#9608;
     8D91 7E2E F048 9C9C 46AF          &#9608;&#9608;  &#9608;&#9608;          &#9608;&#9608;  &#9608;&#9608;
     21A9 7A51 7B82 E755 CC63                &#9608;&#9608;&#9608;&#9608;  &#9608;&#9608;&#9608;&#9608;

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="023760.html">[squid-users] custom DNS resolver scripts? (was: Re: Is it possible to force some dstdomain to ipv4) protocol without define an outgoing ip address ?
</A></li>
	<LI>Next message (by thread): <A HREF="023753.html">[squid-users] Issues with SSLBumped high traffic forward caching
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23752">[ date ]</a>
              <a href="thread.html#23752">[ thread ]</a>
              <a href="subject.html#23752">[ subject ]</a>
              <a href="author.html#23752">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
