<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid spliced TLS handshake failing with chrome/ium fallback for certain servers
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20spliced%20TLS%20handshake%20failing%20with%20chrome/ium%0A%20fallback%20for%20certain%20servers&In-Reply-To=%3C20210609192922.Horde.e5blxJcNidWpbfVZ3h05Ryd%40webmail.intern.securepoint.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="023762.html">
   <LINK REL="Next"  HREF="023758.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid spliced TLS handshake failing with chrome/ium fallback for certain servers</H1>
    <B>Andreas Weigel</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20spliced%20TLS%20handshake%20failing%20with%20chrome/ium%0A%20fallback%20for%20certain%20servers&In-Reply-To=%3C20210609192922.Horde.e5blxJcNidWpbfVZ3h05Ryd%40webmail.intern.securepoint.de%3E"
       TITLE="[squid-users] Squid spliced TLS handshake failing with chrome/ium fallback for certain servers">andreas.weigel at securepoint.de
       </A><BR>
    <I>Wed Jun  9 19:29:22 UTC 2021</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="023762.html">[squid-users] Issues with SSLBumped high traffic forward caching
</A></li>
        <LI>Next message (by thread): <A HREF="023758.html">[squid-users] Squid spliced TLS handshake failing with chrome/ium fallback for certain servers
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23755">[ date ]</a>
              <a href="thread.html#23755">[ thread ]</a>
              <a href="subject.html#23755">[ subject ]</a>
              <a href="author.html#23755">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi everyone,

I stumbled upon a case of someone complaining about a site not being  
reachable via squid. Squid was running as transparent proxy and  
splicing TLS connections.

Squid reported a TLS handshake error to the client  
(SQUID_ERR_SSL_HANDSHAKE; Handshake with SSL server failed:  
error:14094410:SSL routines:ssl3_read_bytes:sslv3 alert handshake  
failure).

After some wireshark-digging, I found that the site in question (for  
reference: www.klebl.net) aborted the handshake, if the Client Hello's  
&quot;Extension: signature_algorithms&quot; did not contain

   Signature Algorithm: rsa_pkcs1_sha1 (0x0201)
       Signature Hash Algorithm Hash: SHA1 (2)
       Signature Hash Algorithm Signature: RSA (1)

though it was perfectly capable of using SHA384 (which was negotiated  
with clients that did include sha1 to their signature algorithms). The  
point is, that chrome seems to have adopted a &quot;fallback&quot; approach  
since version 82 (see  
<A HREF="https://groups.google.com/u/1/a/chromium.org/g/blink-dev/c/yaJcs4p9LNI/m/haZWzX-UBwAJ?pli=1">https://groups.google.com/u/1/a/chromium.org/g/blink-dev/c/yaJcs4p9LNI/m/haZWzX-UBwAJ?pli=1</A>), that first tries to connect without said signature algorithm in its extension and only if that fails does a second handshake with SHA1 included. However, squid see and reports the error on the first attempt back to the client, so that the TLS-connection setup  
fails.

While this seems to be something that probably should be fixed at the  
server side, it does lead users to be believe Squid is at fault.

I tried bypassing TLS-handshake errors using

acl handshake_failure ssl_error SQUID_ERR_SSL_HANDSHAKE
sslproxy_cert_error allow handshake_failure

but this did not change anything (maybe sslproxy_cert_error only works  
for certificate verification, but not for the handshake?)

For the records, other clients, like firefox or openssl s_client  
(Version 1.1.1k) do not have any issues, because their Client Hello  
contains said signature algorithm. Please also note that sites like  
ssllabs do not hint that there is too much wrong with the site (apart  
from still allowing TLS 1.0, and TLS1.2 while disallowing TLS1.1).

The only other client that did not work (squid or no squid) for me was  
openssl s_client Version 1.1.1f (Ubuntu 20.04), I could not even force  
it to include SHA1 into the extensions via --sigalgs  
&quot;RSA+SHA1:RSA+SHA256&quot;.

Any suggestions on how to allow the first TLS-connection failure of  
chrome to be passed directly back to client instead of erroeing out,  
or any other ways to fix this problem?

Andreas

PS: Some further reading on why this may cause the server to abort the  
handshake at all:  
<A HREF="https://github.com/openssl/openssl/issues/11438#issuecomment-606927855">https://github.com/openssl/openssl/issues/11438#issuecomment-606927855</A>


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="023762.html">[squid-users] Issues with SSLBumped high traffic forward caching
</A></li>
	<LI>Next message (by thread): <A HREF="023758.html">[squid-users] Squid spliced TLS handshake failing with chrome/ium fallback for certain servers
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23755">[ date ]</a>
              <a href="thread.html#23755">[ thread ]</a>
              <a href="subject.html#23755">[ subject ]</a>
              <a href="author.html#23755">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
