<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid spliced TLS handshake failing with chrome/ium fallback for certain servers
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20spliced%20TLS%20handshake%20failing%20with%0A%20chrome/ium%20fallback%20for%20certain%20servers&In-Reply-To=%3Cc19c5ef3-aac7-e8e4-832c-e1ba2623fb2c%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="023755.html">
   <LINK REL="Next"  HREF="023761.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid spliced TLS handshake failing with chrome/ium fallback for certain servers</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20spliced%20TLS%20handshake%20failing%20with%0A%20chrome/ium%20fallback%20for%20certain%20servers&In-Reply-To=%3Cc19c5ef3-aac7-e8e4-832c-e1ba2623fb2c%40measurement-factory.com%3E"
       TITLE="[squid-users] Squid spliced TLS handshake failing with chrome/ium fallback for certain servers">rousskov at measurement-factory.com
       </A><BR>
    <I>Wed Jun  9 23:43:38 UTC 2021</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="023755.html">[squid-users] Squid spliced TLS handshake failing with chrome/ium fallback for certain servers
</A></li>
        <LI>Next message (by thread): <A HREF="023761.html">[squid-users] Squid spliced TLS handshake failing with chrome/ium fallback for certain servers
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23758">[ date ]</a>
              <a href="thread.html#23758">[ thread ]</a>
              <a href="subject.html#23758">[ subject ]</a>
              <a href="author.html#23758">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 6/9/21 3:29 PM, Andreas Weigel wrote:
&gt;<i> I stumbled upon a case of someone complaining about a site not being
</I>&gt;<i> reachable via squid. Squid was running as transparent proxy and splicing
</I>&gt;<i> TLS connections.
</I>

&gt;<i> Squid reported a TLS handshake error to the client
</I>&gt;<i> (SQUID_ERR_SSL_HANDSHAKE; Handshake with SSL server failed:
</I>&gt;<i> error:14094410:SSL routines:ssl3_read_bytes:sslv3 alert handshake failure).
</I>
If you are _splicing_ connections, then Squid should not be a part of
the TLS handshake at all. If Squid is a part of the TLS handshake in an
ssl_bump peek+splice configuration, then this is a Squid bug or limitation.


&gt;<i> After some wireshark-digging, I found that the site in question (for
</I>&gt;<i> reference: www.klebl.net) aborted the handshake, if the Client Hello's
</I>&gt;<i> &quot;Extension: signature_algorithms&quot; did not contain
</I>&gt;<i> 
</I>&gt;<i> &#160; Signature Algorithm: rsa_pkcs1_sha1 (0x0201)
</I>&gt;<i> &#160;&#160;&#160;&#160;&#160; Signature Hash Algorithm Hash: SHA1 (2)
</I>&gt;<i> &#160;&#160;&#160;&#160;&#160; Signature Hash Algorithm Signature: RSA (1)
</I>&gt;<i> 
</I>&gt;<i> though it was perfectly capable of using SHA384 (which was negotiated
</I>&gt;<i> with clients that did include sha1 to their signature algorithms). The
</I>&gt;<i> point is, that chrome seems to have adopted a &quot;fallback&quot; approach since
</I>&gt;<i> version 82 (see
</I>&gt;<i> <A HREF="https://groups.google.com/u/1/a/chromium.org/g/blink-dev/c/yaJcs4p9LNI/m/haZWzX-UBwAJ?pli=1">https://groups.google.com/u/1/a/chromium.org/g/blink-dev/c/yaJcs4p9LNI/m/haZWzX-UBwAJ?pli=1</A>),
</I>&gt;<i> that first tries to connect without said signature algorithm in its
</I>&gt;<i> extension and only if that fails does a second handshake with SHA1
</I>&gt;<i> included. However, squid see and reports the error on the first attempt
</I>&gt;<i> back to the client, so that the TLS-connection setup fails.
</I>&gt;<i> 
</I>&gt;<i> While this seems to be something that probably should be fixed at the
</I>&gt;<i> server side, it does lead users to be believe Squid is at fault.
</I>&gt;<i> 
</I>&gt;<i> I tried bypassing TLS-handshake errors using
</I>&gt;<i> 
</I>&gt;<i> acl handshake_failure ssl_error SQUID_ERR_SSL_HANDSHAKE
</I>&gt;<i> sslproxy_cert_error allow handshake_failure
</I>&gt;<i> 
</I>&gt;<i> but this did not change anything (maybe sslproxy_cert_error only works
</I>&gt;<i> for certificate verification, but not for the handshake?)
</I>
Yes, sslproxy_cert_error is about certificates, not TLS handshakes.


&gt;<i> Any suggestions on how to allow the first TLS-connection failure of
</I>&gt;<i> chrome to be passed directly back to client instead of erroeing out, or
</I>&gt;<i> any other ways to fix this problem?
</I>
I can only suggest to either fix the Squid bug/limitation or decide to
splice during step1 (based on client SNI, etc., before Squid talks to
the origin server).


HTH,

Alex.

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="023755.html">[squid-users] Squid spliced TLS handshake failing with chrome/ium fallback for certain servers
</A></li>
	<LI>Next message (by thread): <A HREF="023761.html">[squid-users] Squid spliced TLS handshake failing with chrome/ium fallback for certain servers
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23758">[ date ]</a>
              <a href="thread.html#23758">[ thread ]</a>
              <a href="subject.html#23758">[ subject ]</a>
              <a href="author.html#23758">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
