<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid spliced TLS handshake failing with chrome/ium fallback for certain servers
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20spliced%20TLS%20handshake%20failing%20with%0A%20chrome/ium%20fallback%20for%20certain%20servers&In-Reply-To=%3C20210610182421.Horde.ZWqYNYE-S-5UO93YX0389tx%40webmail.intern.securepoint.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="023764.html">
   <LINK REL="Next"  HREF="023765.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid spliced TLS handshake failing with chrome/ium fallback for certain servers</H1>
    <B>Andreas Weigel</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20spliced%20TLS%20handshake%20failing%20with%0A%20chrome/ium%20fallback%20for%20certain%20servers&In-Reply-To=%3C20210610182421.Horde.ZWqYNYE-S-5UO93YX0389tx%40webmail.intern.securepoint.de%3E"
       TITLE="[squid-users] Squid spliced TLS handshake failing with chrome/ium fallback for certain servers">andreas.weigel at securepoint.de
       </A><BR>
    <I>Thu Jun 10 18:24:21 UTC 2021</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="023764.html">[squid-users] Squid spliced TLS handshake failing with chrome/ium fallback for certain servers
</A></li>
        <LI>Next message (by thread): <A HREF="023765.html">[squid-users] Usage of --enable-gnuregex on FreeBSD?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23763">[ date ]</a>
              <a href="thread.html#23763">[ thread ]</a>
              <a href="subject.html#23763">[ subject ]</a>
              <a href="author.html#23763">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi again,

&gt;<i> I can only suggest to either fix the Squid bug/limitation
</I>
I found Ssl::PeekingPeerConnector::noteNegotiationError in  
src/PeekingPeerConnector.cc. There are some checks for the case that  
srvBio-&gt;bumpMode() == Ssl::bumpPeek. If I apply the attached patch,  
matching on the ssl_lib_error for failed handshakes (just for testing,  
not an actual suggestion!) and setting bypassValidator = true in that  
case, the connection from Chrome to the problematic site goes through  
after the initial failure (configured with peeking at step2, splicing  
at step 3).

&gt;<i> If you are _splicing_ connections, then Squid should not be a part of
</I>&gt;<i> the TLS handshake at all. If Squid is a part of the TLS handshake in an
</I>&gt;<i> ssl_bump peek+splice configuration, then this is a Squid bug or limitation.
</I>
I agree. Said function produces an error page, if none of the checks  
make it return early. Maybe the logic here should be inverted to  
rather enumerate error cases that actually justify an error page  
(maybe only local errors like failed syscalls, OOM?). I am far from  
understanding all possible paths of execution this may take and  
therefore I may easily miss an important point here, though.

Andreas

Zitat von Alex Rousskov &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt;:

&gt;<i> On 6/9/21 3:29 PM, Andreas Weigel wrote:
</I>&gt;&gt;<i> I stumbled upon a case of someone complaining about a site not being
</I>&gt;&gt;<i> reachable via squid. Squid was running as transparent proxy and splicing
</I>&gt;&gt;<i> TLS connections.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> Squid reported a TLS handshake error to the client
</I>&gt;&gt;<i> (SQUID_ERR_SSL_HANDSHAKE; Handshake with SSL server failed:
</I>&gt;&gt;<i> error:14094410:SSL routines:ssl3_read_bytes:sslv3 alert handshake failure).
</I>&gt;<i>
</I>&gt;<i> If you are _splicing_ connections, then Squid should not be a part of
</I>&gt;<i> the TLS handshake at all. If Squid is a part of the TLS handshake in an
</I>&gt;<i> ssl_bump peek+splice configuration, then this is a Squid bug or limitation.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> After some wireshark-digging, I found that the site in question (for
</I>&gt;&gt;<i> reference: www.klebl.net) aborted the handshake, if the Client Hello's
</I>&gt;&gt;<i> &quot;Extension: signature_algorithms&quot; did not contain
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &#160; Signature Algorithm: rsa_pkcs1_sha1 (0x0201)
</I>&gt;&gt;<i> &#160;&#160;&#160;&#160;&#160; Signature Hash Algorithm Hash: SHA1 (2)
</I>&gt;&gt;<i> &#160;&#160;&#160;&#160;&#160; Signature Hash Algorithm Signature: RSA (1)
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> though it was perfectly capable of using SHA384 (which was negotiated
</I>&gt;&gt;<i> with clients that did include sha1 to their signature algorithms). The
</I>&gt;&gt;<i> point is, that chrome seems to have adopted a &quot;fallback&quot; approach since
</I>&gt;&gt;<i> version 82 (see
</I>&gt;&gt;<i> <A HREF="https://groups.google.com/u/1/a/chromium.org/g/blink-dev/c/yaJcs4p9LNI/m/haZWzX-UBwAJ?pli=1">https://groups.google.com/u/1/a/chromium.org/g/blink-dev/c/yaJcs4p9LNI/m/haZWzX-UBwAJ?pli=1</A>),
</I>&gt;&gt;<i> that first tries to connect without said signature algorithm in its
</I>&gt;&gt;<i> extension and only if that fails does a second handshake with SHA1
</I>&gt;&gt;<i> included. However, squid see and reports the error on the first attempt
</I>&gt;&gt;<i> back to the client, so that the TLS-connection setup fails.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> While this seems to be something that probably should be fixed at the
</I>&gt;&gt;<i> server side, it does lead users to be believe Squid is at fault.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I tried bypassing TLS-handshake errors using
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> acl handshake_failure ssl_error SQUID_ERR_SSL_HANDSHAKE
</I>&gt;&gt;<i> sslproxy_cert_error allow handshake_failure
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> but this did not change anything (maybe sslproxy_cert_error only works
</I>&gt;&gt;<i> for certificate verification, but not for the handshake?)
</I>&gt;<i>
</I>&gt;<i> Yes, sslproxy_cert_error is about certificates, not TLS handshakes.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> Any suggestions on how to allow the first TLS-connection failure of
</I>&gt;&gt;<i> chrome to be passed directly back to client instead of erroeing out, or
</I>&gt;&gt;<i> any other ways to fix this problem?
</I>&gt;<i>
</I>&gt;<i> I can only suggest to either fix the Squid bug/limitation or decide to
</I>&gt;<i> splice during step1 (based on client SNI, etc., before Squid talks to
</I>&gt;<i> the origin server).
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> HTH,
</I>&gt;<i>
</I>&gt;<i> Alex.
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>

-------------- next part --------------
A non-text attachment was scrubbed...
Name: test_handshake_failure.patch
Type: text/x-diff
Size: 691 bytes
Desc: not available
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20210610/1a3fb091/attachment.patch">http://lists.squid-cache.org/pipermail/squid-users/attachments/20210610/1a3fb091/attachment.patch</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="023764.html">[squid-users] Squid spliced TLS handshake failing with chrome/ium fallback for certain servers
</A></li>
	<LI>Next message (by thread): <A HREF="023765.html">[squid-users] Usage of --enable-gnuregex on FreeBSD?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23763">[ date ]</a>
              <a href="thread.html#23763">[ thread ]</a>
              <a href="subject.html#23763">[ subject ]</a>
              <a href="author.html#23763">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
