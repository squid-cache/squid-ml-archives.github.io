<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Passing Proxy Protocol Headers to external ACL
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Passing%20Proxy%20Protocol%20Headers%20to%20external%20ACL&In-Reply-To=%3Cf48985cf-35ca-3de6-d314-f490c5222169%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="023775.html">
   <LINK REL="Next"  HREF="023780.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Passing Proxy Protocol Headers to external ACL</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Passing%20Proxy%20Protocol%20Headers%20to%20external%20ACL&In-Reply-To=%3Cf48985cf-35ca-3de6-d314-f490c5222169%40measurement-factory.com%3E"
       TITLE="[squid-users] Passing Proxy Protocol Headers to external ACL">rousskov at measurement-factory.com
       </A><BR>
    <I>Wed Jun 16 14:38:25 UTC 2021</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="023775.html">[squid-users] Passing Proxy Protocol Headers to external ACL
</A></li>
        <LI>Next message (by thread): <A HREF="023780.html">[squid-users] Passing Proxy Protocol Headers to external ACL
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23778">[ date ]</a>
              <a href="thread.html#23778">[ thread ]</a>
              <a href="subject.html#23778">[ subject ]</a>
              <a href="author.html#23778">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 6/16/21 4:15 AM, Frida Safran wrote:

&gt;<i> I see that the configured acl is not called for all requests.
</I>
classifyRequest should be evaluated for all CONNECT requests that get to
SslBump step2. That should be all CONNECT requests except for (rare)
cases where Squid cannot peek at the TLS ClientHello during step1 and,
hence, bumps the client connection without reaching step2.

Whether classifyRequest _matches_ when evaluated is a different story,
of course.

&gt;<i> I do see that the ecap is called, it sets the option&#160;X-PMeta-Splice
</I>&gt;<i> via&#160;visitEachOption&#160;correctly, but the classifyRequest note acl is not
</I>&gt;<i> evaluated, and the request is not spliced.
</I>&gt;<i> However, I do see that this acl is evaluated for some other requests,
</I>&gt;<i> but only when the&#160;X-PMeta-Bypass is set to: 'no'.
</I>&gt;<i> This config worked as expected when using an external acl type for the
</I>&gt;<i> same request, but i also saw the same issue when using note when i tried
</I>&gt;<i> to use it to classify the external acl.
</I>&gt;<i> Is there perhaps a bug/misconfiguration with the note acl?
</I>
Sorry, I do not have enough information to answer that question. Try
sharing an ALL,9 cache.log that reproduces the problem using a single
transaction:
<A HREF="https://wiki.squid-cache.org/SquidFaq/BugReporting#Debugging_a_single_transaction">https://wiki.squid-cache.org/SquidFaq/BugReporting#Debugging_a_single_transaction</A>


&gt;<i> The current config is:
</I>&gt;<i> 
</I>&gt;<i> acl classifyRequest note -m X-PMeta-Bypass yes
</I>&gt;<i> 
</I>&gt;<i> acl step1 at_step SslBump1
</I>&gt;<i> acl step2 at_step SslBump2
</I>&gt;<i> 
</I>&gt;<i> ssl_bump peek step1
</I>&gt;<i> ssl_bump splice step2 classifyRequest
</I>&gt;<i> ssl_bump stare all
</I>&gt;<i> ssl_bump bump all
</I>
&gt;<i> adaptation_meta X-PMeta-Bypass &quot;%adapt::&lt;last_h{X-PMeta-Splice}&quot;
</I>
This adaptation_meta configuration should pass X-PMeta-Bypass
meta-header field to the adaptation service, with the field value set to
the value of the value of X-PMeta-Splice meta-header field received by
Squid from the previously applied adaption service (within the same
master transaction). Is that what you want?


HTH,

Alex.



&gt;<i> ------------------------------------------------------------------------
</I>&gt;<i> *From:* Alex Rousskov &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt;
</I>&gt;<i> *Sent:* Tuesday, June 15, 2021 21:35
</I>&gt;<i> *To:* Frida Safran &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">fsafran at proofpoint.com</A>&gt;;
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A> &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>&gt;
</I>&gt;<i> *Subject:* Re: [squid-users] Passing Proxy Protocol Headers to external ACL
</I>&gt;<i> &#160;
</I>&gt;<i> On 6/15/21 4:18 AM, Frida Safran wrote:
</I>&gt;<i> 
</I>&gt;&gt;<i> In addition to using an external acl to annotate connections and decide
</I>&gt;&gt;<i> whether splice/bump, I would like to try using an ecap service to
</I>&gt;&gt;<i> achieve this.
</I>&gt;&gt;<i> I would like to create an acl using info from the ecap service, and
</I>&gt;&gt;<i> bump/splice using the following configuration:
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> acl classifyRequest note splice yes
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> acl step1 at_step SslBump1
</I>&gt;&gt;<i> acl step2 at_step SslBump2
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> ssl_bump peek step1
</I>&gt;&gt;<i> ssl_bump splice step2 classifyRequest
</I>&gt;&gt;<i> ssl_bump stare all
</I>&gt;&gt;<i> ssl_bump bump all
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> If I set a custom option from within the ecap service, can i use that
</I>&gt;&gt;<i> via the above note acl?
</I>&gt;<i> 
</I>&gt;<i> I believe that should work in principle, provided the eCAP service is
</I>&gt;<i> consulted before Squid starts evaluating &quot;ssl_bump splice step2
</I>&gt;<i> classifyRequest&quot;. If you do not restrict what requests your eCAP REQMOD
</I>&gt;<i> service gets, then it should be consulted during step1 (at least). The
</I>&gt;<i> logic is the same for eCAP and ICAP here -- Squid &quot;primary&quot; code does
</I>&gt;<i> not know the difference between those two adaptation interfaces.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> Can i set a custom option without setting it in
</I>&gt;&gt;<i> 'adaptation_masterx_shared_names'
</I>&gt;<i> 
</I>&gt;<i> Yes, you should be able to. The adaptation_masterx_shared_names
</I>&gt;<i> directive is unrelated to setting transaction annotations IIRC. It is
</I>&gt;<i> about sharing metadata across adaptation services.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> Or, should I instead use:
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> acl classifyRequest note %adapt::&lt;last_h{splice} yes
</I>&gt;<i> 
</I>&gt;<i> This option cannot work AFAICT because the &quot;note&quot; ACL requires a
</I>&gt;<i> constant (i.e. known at configuration time) annotation name. Squid will
</I>&gt;<i> not substitute %adapt::&lt;last_h{splice} with anything in this context.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> HTH,
</I>&gt;<i> 
</I>&gt;<i> Alex.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> ------------------------------------------------------------------------
</I>&gt;&gt;<i> *From:* Alex Rousskov &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt;
</I>&gt;&gt;<i> *Sent:* Monday, June 14, 2021 16:24
</I>&gt;&gt;<i> *To:* <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A> &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>&gt;
</I>&gt;&gt;<i> *Cc:* Frida Safran &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">fsafran at proofpoint.com</A>&gt;
</I>&gt;&gt;<i> *Subject:* Re: [squid-users] Passing Proxy Protocol Headers to external ACL
</I>&gt;&gt;<i> &#160;
</I>&gt;&gt;<i> On 6/14/21 2:29 AM, Frida Safran wrote:
</I>&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> Regarding proxy_protocol - is there a known patch for v4 I could use by
</I>&gt;&gt;&gt;<i> any chance?
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> I am not aware of any such patches. The changes were significant, fixing
</I>&gt;&gt;<i> many PROXY protocol handling bugs. Virtually anything can be backported,
</I>&gt;&gt;<i> but it would be a large effort with noticeable stability risks and
</I>&gt;&gt;<i> long-term maintenance overheads. Preparing for a v5 upgrade may be a
</I>&gt;&gt;<i> better strategy in this particular case.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> Regarding icap, I suppose the acl is getting evaluated before the icap
</I>&gt;&gt;&gt;<i> and that is why they aren't available:
</I>&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> acl classifyRequest external TransactionClassificator
</I>&gt;&gt;&gt;<i> ssl_bump peek step1
</I>&gt;&gt;&gt;<i> ssl_bump splice step2 classifyRequest
</I>&gt;&gt;&gt;<i> ssl_bump stare all
</I>&gt;&gt;&gt;<i> ssl_bump bump all
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> According to [1], the above configuration should result in two ICAP
</I>&gt;&gt;<i> REQMOD requests (if configured) before classifyRequest is consulted
</I>&gt;&gt;<i> during step2. I am aware of SslBump bugs in that area, but I would
</I>&gt;&gt;<i> expect at least one ICAP REQMOD request anyway. The requests
</I>&gt;&gt;<i> existence/timing should be easy to confirm using cache.log with
</I>&gt;&gt;<i> debug_options set to at least &quot;ALL,3 82,9 93,9&quot; and/or a logging or
</I>&gt;&gt;<i> pausing external ACL script in combination with an icap_log (to compare
</I>&gt;&gt;<i> logged timestamps).
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> [1]
</I>&gt;&gt;<i> <A HREF="https://urldefense.com/v3/__https://wiki.squid-cache.org/Features/SslPeekAndSplice__;!!ORgEfCBsr282Fw!6SDlCpq2n2kV1WuiNQ7focWt2YMDj-Xs9aEp29dC32pwZUHSLIkrD7dnojPghFBhQQ$">https://urldefense.com/v3/__https://wiki.squid-cache.org/Features/SslPeekAndSplice__;!!ORgEfCBsr282Fw!6SDlCpq2n2kV1WuiNQ7focWt2YMDj-Xs9aEp29dC32pwZUHSLIkrD7dnojPghFBhQQ$</A>
</I>&gt;<i> &lt;<A HREF="https://urldefense.com/v3/__https://wiki.squid-cache.org/Features/SslPeekAndSplice__;!!ORgEfCBsr282Fw!6SDlCpq2n2kV1WuiNQ7focWt2YMDj-Xs9aEp29dC32pwZUHSLIkrD7dnojPghFBhQQ$">https://urldefense.com/v3/__https://wiki.squid-cache.org/Features/SslPeekAndSplice__;!!ORgEfCBsr282Fw!6SDlCpq2n2kV1WuiNQ7focWt2YMDj-Xs9aEp29dC32pwZUHSLIkrD7dnojPghFBhQQ$</A>&gt;
</I>&gt;&gt;<i> &lt;<A HREF="https://urldefense.com/v3/__https://wiki.squid-cache.org/Features/SslPeekAndSplice__;!!ORgEfCBsr282Fw!6SDlCpq2n2kV1WuiNQ7focWt2YMDj-Xs9aEp29dC32pwZUHSLIkrD7dnojPghFBhQQ$">https://urldefense.com/v3/__https://wiki.squid-cache.org/Features/SslPeekAndSplice__;!!ORgEfCBsr282Fw!6SDlCpq2n2kV1WuiNQ7focWt2YMDj-Xs9aEp29dC32pwZUHSLIkrD7dnojPghFBhQQ$</A>
</I>&gt;<i> &lt;<A HREF="https://urldefense.com/v3/__https://wiki.squid-cache.org/Features/SslPeekAndSplice__;!!ORgEfCBsr282Fw!6SDlCpq2n2kV1WuiNQ7focWt2YMDj-Xs9aEp29dC32pwZUHSLIkrD7dnojPghFBhQQ$">https://urldefense.com/v3/__https://wiki.squid-cache.org/Features/SslPeekAndSplice__;!!ORgEfCBsr282Fw!6SDlCpq2n2kV1WuiNQ7focWt2YMDj-Xs9aEp29dC32pwZUHSLIkrD7dnojPghFBhQQ$</A>&gt;&gt;
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> HTH,
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> Alex.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> ------------------------------------------------------------------------
</I>&gt;&gt;&gt;<i> *From:* Alex Rousskov &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt;
</I>&gt;&gt;&gt;<i> *Sent:* Sunday, June 13, 2021 17:46
</I>&gt;&gt;&gt;<i> *To:* <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A> &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>&gt;
</I>&gt;&gt;&gt;<i> *Cc:* Frida Safran &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">fsafran at proofpoint.com</A>&gt;
</I>&gt;&gt;&gt;<i> *Subject:* Re: [squid-users] Passing Proxy Protocol Headers to external ACL
</I>&gt;&gt;&gt;<i> &#160;
</I>&gt;&gt;&gt;<i> On 6/13/21 7:31 AM, Frida Safran wrote:
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;&gt;<i>&#160; 1. Is it possible to pass proxy protocol headers to an external acl as
</I>&gt;&gt;&gt;&gt;<i>&#160;&#160;&#160;&#160; part of the format?
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> It should be possible. Use %proxy_protocol::&gt;h logformat %code in your
</I>&gt;&gt;&gt;<i> external_acl_type FORMAT configuration. We added that support to Squid
</I>&gt;&gt;&gt;<i> v5. Not available in the official v4.
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;&gt;<i>&#160; 2. Is it possible to pass all/specific icap headers to an external acl?
</I>&gt;&gt;&gt;&gt;<i>&#160;&#160;&#160;&#160; I have been trying to use %icap::&gt;h to pass all the icap headers to
</I>&gt;&gt;&gt;&gt;<i>&#160;&#160;&#160;&#160; an external acl, but it resolves to &quot;-&quot;
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> It should be possible if your external ACL is evaluated _after_ the
</I>&gt;&gt;&gt;<i> corresponding ICAP headers are received, but I would not be surprised if
</I>&gt;&gt;&gt;<i> there are bugs in this area -- the ICAP headers may be available but not
</I>&gt;&gt;&gt;<i> &#160;provided to the ACL evaluation code. Which squid.conf directive is
</I>&gt;&gt;&gt;<i> triggering your external ACL evaluation in this use case?
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> HTH,
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> Alex.
</I>&gt;&gt;<i> 
</I>&gt;<i> 
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="023775.html">[squid-users] Passing Proxy Protocol Headers to external ACL
</A></li>
	<LI>Next message (by thread): <A HREF="023780.html">[squid-users] Passing Proxy Protocol Headers to external ACL
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23778">[ date ]</a>
              <a href="thread.html#23778">[ thread ]</a>
              <a href="subject.html#23778">[ subject ]</a>
              <a href="author.html#23778">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
