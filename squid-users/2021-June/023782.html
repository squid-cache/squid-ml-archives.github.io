<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Passing Proxy Protocol Headers to external ACL
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Passing%20Proxy%20Protocol%20Headers%20to%20external%20ACL&In-Reply-To=%3CMN2PR12MB43418DEB16FFF9BF089F62F2D20B9%40MN2PR12MB4341.namprd12.prod.outlook.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="023781.html">
   <LINK REL="Next"  HREF="023787.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Passing Proxy Protocol Headers to external ACL</H1>
    <B>Frida Safran</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Passing%20Proxy%20Protocol%20Headers%20to%20external%20ACL&In-Reply-To=%3CMN2PR12MB43418DEB16FFF9BF089F62F2D20B9%40MN2PR12MB4341.namprd12.prod.outlook.com%3E"
       TITLE="[squid-users] Passing Proxy Protocol Headers to external ACL">fsafran at proofpoint.com
       </A><BR>
    <I>Sun Jun 20 06:55:52 UTC 2021</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="023781.html">[squid-users] Passing Proxy Protocol Headers to external ACL
</A></li>
        <LI>Next message (by thread): <A HREF="023787.html">[squid-users] Passing Proxy Protocol Headers to external ACL
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23782">[ date ]</a>
              <a href="thread.html#23782">[ thread ]</a>
              <a href="subject.html#23782">[ subject ]</a>
              <a href="author.html#23782">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>As far as I understand the ecap service should be called for each step:

  *   In step1 there is no SNI, and X-PMeta-Splice should be set in the ecap to 'no'.
  *   In step2 there should be an SNI, and X-PMeta-Splice should be set to 'yes', and the classifyRequest acl should return true, causing the request to be spliced.

In the debug log however, I see prints saying that it was decided to bump the request, suggesting that step2 is not working as expected.
Please advise how to proceed?
________________________________
From: Alex Rousskov &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt;
Sent: Thursday, June 17, 2021 18:41
To: Frida Safran &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">fsafran at proofpoint.com</A>&gt;; <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A> &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>&gt;
Subject: Re: [squid-users] Passing Proxy Protocol Headers to external ACL

On 6/17/21 1:55 AM, Frida Safran wrote:

&gt;<i> I see that the issue stems from that the %ssl::sni is not getting passed
</I>&gt;<i> correctly (evaluated as &quot;-&quot;) for CONNECT requests when passed via:
</I>&gt;<i>
</I>&gt;<i> adaptation_meta X-PMeta-SNI &quot;%ssl::sni&quot;
</I>&gt;<i>
</I>&gt;<i> Why could that be? I do see that in the access.log the %ssl::sni is
</I>&gt;<i> logged correctly on CONNECT entries.
</I>

Perhaps it is because SNI is never available during SslBump step1? It is
not clear (to me) whether you are talking about step1 or step2
adaptation_meta evaluation. Also, there could be Squid bugs that result
in missing adaptation_meta re-evaluations during step2 -- I have not
checked.


&gt;<i> I have worked around this by passing the &quot;%&gt;rd&quot; instead - are these 2
</I>&gt;<i> values equivalent in all cases?
</I>
No, they are not.

1. SNI should always be a domain name. CONNECT request URI may be an IP.

1.1 A true CONNECT request may use an IP address -- client choice.

1.2 A faked during step1 CONNECT request uses an IP address.
   This faking always happens when you use SslBump on https_port.

2. SNI may differ from the domain name in the CONNECT request.
  For example, the CONNECT request may be for example.com while
  SNI may say something more specific like service.example.com.
  Some SNI domains are obfuscated/encrypted.

3. SNI may be missing in TLS ClientHello.
   CONNECT requests always have a URI.

HTH,

Alex.

&gt;<i> ------------------------------------------------------------------------
</I>&gt;<i> *From:* Alex Rousskov &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt;
</I>&gt;<i> *Sent:* Wednesday, June 16, 2021 17:38
</I>&gt;<i> *To:* Frida Safran &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">fsafran at proofpoint.com</A>&gt;;
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A> &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>&gt;
</I>&gt;<i> *Subject:* Re: [squid-users] Passing Proxy Protocol Headers to external ACL
</I>&gt;<i>
</I>&gt;<i> On 6/16/21 4:15 AM, Frida Safran wrote:
</I>&gt;<i>
</I>&gt;&gt;<i> I see that the configured acl is not called for all requests.
</I>&gt;<i>
</I>&gt;<i> classifyRequest should be evaluated for all CONNECT requests that get to
</I>&gt;<i> SslBump step2. That should be all CONNECT requests except for (rare)
</I>&gt;<i> cases where Squid cannot peek at the TLS ClientHello during step1 and,
</I>&gt;<i> hence, bumps the client connection without reaching step2.
</I>&gt;<i>
</I>&gt;<i> Whether classifyRequest _matches_ when evaluated is a different story,
</I>&gt;<i> of course.
</I>&gt;<i>
</I>&gt;&gt;<i> I do see that the ecap is called, it sets the option X-PMeta-Splice
</I>&gt;&gt;<i> via visitEachOption correctly, but the classifyRequest note acl is not
</I>&gt;&gt;<i> evaluated, and the request is not spliced.
</I>&gt;&gt;<i> However, I do see that this acl is evaluated for some other requests,
</I>&gt;&gt;<i> but only when the X-PMeta-Bypass is set to: 'no'.
</I>&gt;&gt;<i> This config worked as expected when using an external acl type for the
</I>&gt;&gt;<i> same request, but i also saw the same issue when using note when i tried
</I>&gt;&gt;<i> to use it to classify the external acl.
</I>&gt;&gt;<i> Is there perhaps a bug/misconfiguration with the note acl?
</I>&gt;<i>
</I>&gt;<i> Sorry, I do not have enough information to answer that question. Try
</I>&gt;<i> sharing an ALL,9 cache.log that reproduces the problem using a single
</I>&gt;<i> transaction:
</I>&gt;<i> <A HREF="https://urldefense.com/v3/__https://wiki.squid-cache.org/SquidFaq/BugReporting*Debugging_a_single_transaction__;Iw!!ORgEfCBsr282Fw!9mAZmYL4yTa1_p9UoNH3-uc5baXXKzSf1Zi9SkjsnCkMq_JCg50KhEXmwGcowILvtw$">https://urldefense.com/v3/__https://wiki.squid-cache.org/SquidFaq/BugReporting*Debugging_a_single_transaction__;Iw!!ORgEfCBsr282Fw!9mAZmYL4yTa1_p9UoNH3-uc5baXXKzSf1Zi9SkjsnCkMq_JCg50KhEXmwGcowILvtw$</A>
</I>&gt;<i> &lt;<A HREF="https://urldefense.com/v3/__https://wiki.squid-cache.org/SquidFaq/BugReporting*Debugging_a_single_transaction__;Iw!!ORgEfCBsr282Fw!9mAZmYL4yTa1_p9UoNH3-uc5baXXKzSf1Zi9SkjsnCkMq_JCg50KhEXmwGcowILvtw$">https://urldefense.com/v3/__https://wiki.squid-cache.org/SquidFaq/BugReporting*Debugging_a_single_transaction__;Iw!!ORgEfCBsr282Fw!9mAZmYL4yTa1_p9UoNH3-uc5baXXKzSf1Zi9SkjsnCkMq_JCg50KhEXmwGcowILvtw$</A>&gt;
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> The current config is:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> acl classifyRequest note -m X-PMeta-Bypass yes
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> acl step1 at_step SslBump1
</I>&gt;&gt;<i> acl step2 at_step SslBump2
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> ssl_bump peek step1
</I>&gt;&gt;<i> ssl_bump splice step2 classifyRequest
</I>&gt;&gt;<i> ssl_bump stare all
</I>&gt;&gt;<i> ssl_bump bump all
</I>&gt;<i>
</I>&gt;&gt;<i> adaptation_meta X-PMeta-Bypass &quot;%adapt::&lt;last_h{X-PMeta-Splice}&quot;
</I>&gt;<i>
</I>&gt;<i> This adaptation_meta configuration should pass X-PMeta-Bypass
</I>&gt;<i> meta-header field to the adaptation service, with the field value set to
</I>&gt;<i> the value of the value of X-PMeta-Splice meta-header field received by
</I>&gt;<i> Squid from the previously applied adaption service (within the same
</I>&gt;<i> master transaction). Is that what you want?
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> HTH,
</I>&gt;<i>
</I>&gt;<i> Alex.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> ------------------------------------------------------------------------
</I>&gt;&gt;<i> *From:* Alex Rousskov &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt;
</I>&gt;&gt;<i> *Sent:* Tuesday, June 15, 2021 21:35
</I>&gt;&gt;<i> *To:* Frida Safran &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">fsafran at proofpoint.com</A>&gt;;
</I>&gt;&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A> &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>&gt;
</I>&gt;&gt;<i> *Subject:* Re: [squid-users] Passing Proxy Protocol Headers to external ACL
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> On 6/15/21 4:18 AM, Frida Safran wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> In addition to using an external acl to annotate connections and decide
</I>&gt;&gt;&gt;<i> whether splice/bump, I would like to try using an ecap service to
</I>&gt;&gt;&gt;<i> achieve this.
</I>&gt;&gt;&gt;<i> I would like to create an acl using info from the ecap service, and
</I>&gt;&gt;&gt;<i> bump/splice using the following configuration:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> acl classifyRequest note splice yes
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> acl step1 at_step SslBump1
</I>&gt;&gt;&gt;<i> acl step2 at_step SslBump2
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> ssl_bump peek step1
</I>&gt;&gt;&gt;<i> ssl_bump splice step2 classifyRequest
</I>&gt;&gt;&gt;<i> ssl_bump stare all
</I>&gt;&gt;&gt;<i> ssl_bump bump all
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> If I set a custom option from within the ecap service, can i use that
</I>&gt;&gt;&gt;<i> via the above note acl?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I believe that should work in principle, provided the eCAP service is
</I>&gt;&gt;<i> consulted before Squid starts evaluating &quot;ssl_bump splice step2
</I>&gt;&gt;<i> classifyRequest&quot;. If you do not restrict what requests your eCAP REQMOD
</I>&gt;&gt;<i> service gets, then it should be consulted during step1 (at least). The
</I>&gt;&gt;<i> logic is the same for eCAP and ICAP here -- Squid &quot;primary&quot; code does
</I>&gt;&gt;<i> not know the difference between those two adaptation interfaces.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Can i set a custom option without setting it in
</I>&gt;&gt;&gt;<i> 'adaptation_masterx_shared_names'
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Yes, you should be able to. The adaptation_masterx_shared_names
</I>&gt;&gt;<i> directive is unrelated to setting transaction annotations IIRC. It is
</I>&gt;&gt;<i> about sharing metadata across adaptation services.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Or, should I instead use:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> acl classifyRequest note %adapt::&lt;last_h{splice} yes
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> This option cannot work AFAICT because the &quot;note&quot; ACL requires a
</I>&gt;&gt;<i> constant (i.e. known at configuration time) annotation name. Squid will
</I>&gt;&gt;<i> not substitute %adapt::&lt;last_h{splice} with anything in this context.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> HTH,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Alex.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> ------------------------------------------------------------------------
</I>&gt;&gt;&gt;<i> *From:* Alex Rousskov &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt;
</I>&gt;&gt;&gt;<i> *Sent:* Monday, June 14, 2021 16:24
</I>&gt;&gt;&gt;<i> *To:* <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A> &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>&gt;
</I>&gt;&gt;&gt;<i> *Cc:* Frida Safran &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">fsafran at proofpoint.com</A>&gt;
</I>&gt;&gt;&gt;<i> *Subject:* Re: [squid-users] Passing Proxy Protocol Headers to external ACL
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> On 6/14/21 2:29 AM, Frida Safran wrote:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> Regarding proxy_protocol - is there a known patch for v4 I could use by
</I>&gt;&gt;&gt;&gt;<i> any chance?
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> I am not aware of any such patches. The changes were significant, fixing
</I>&gt;&gt;&gt;<i> many PROXY protocol handling bugs. Virtually anything can be backported,
</I>&gt;&gt;&gt;<i> but it would be a large effort with noticeable stability risks and
</I>&gt;&gt;&gt;<i> long-term maintenance overheads. Preparing for a v5 upgrade may be a
</I>&gt;&gt;&gt;<i> better strategy in this particular case.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> Regarding icap, I suppose the acl is getting evaluated before the icap
</I>&gt;&gt;&gt;&gt;<i> and that is why they aren't available:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> acl classifyRequest external TransactionClassificator
</I>&gt;&gt;&gt;&gt;<i> ssl_bump peek step1
</I>&gt;&gt;&gt;&gt;<i> ssl_bump splice step2 classifyRequest
</I>&gt;&gt;&gt;&gt;<i> ssl_bump stare all
</I>&gt;&gt;&gt;&gt;<i> ssl_bump bump all
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> According to [1], the above configuration should result in two ICAP
</I>&gt;&gt;&gt;<i> REQMOD requests (if configured) before classifyRequest is consulted
</I>&gt;&gt;&gt;<i> during step2. I am aware of SslBump bugs in that area, but I would
</I>&gt;&gt;&gt;<i> expect at least one ICAP REQMOD request anyway. The requests
</I>&gt;&gt;&gt;<i> existence/timing should be easy to confirm using cache.log with
</I>&gt;&gt;&gt;<i> debug_options set to at least &quot;ALL,3 82,9 93,9&quot; and/or a logging or
</I>&gt;&gt;&gt;<i> pausing external ACL script in combination with an icap_log (to compare
</I>&gt;&gt;&gt;<i> logged timestamps).
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> [1]
</I>&gt;&gt;&gt;<i> <A HREF="https://urldefense.com/v3/__https://wiki.squid-cache.org/Features/SslPeekAndSplice__;!!ORgEfCBsr282Fw!6SDlCpq2n2kV1WuiNQ7focWt2YMDj-Xs9aEp29dC32pwZUHSLIkrD7dnojPghFBhQQ$">https://urldefense.com/v3/__https://wiki.squid-cache.org/Features/SslPeekAndSplice__;!!ORgEfCBsr282Fw!6SDlCpq2n2kV1WuiNQ7focWt2YMDj-Xs9aEp29dC32pwZUHSLIkrD7dnojPghFBhQQ$</A>
</I>&gt;<i> &lt;<A HREF="https://urldefense.com/v3/__https://wiki.squid-cache.org/Features/SslPeekAndSplice__;!!ORgEfCBsr282Fw!6SDlCpq2n2kV1WuiNQ7focWt2YMDj-Xs9aEp29dC32pwZUHSLIkrD7dnojPghFBhQQ$">https://urldefense.com/v3/__https://wiki.squid-cache.org/Features/SslPeekAndSplice__;!!ORgEfCBsr282Fw!6SDlCpq2n2kV1WuiNQ7focWt2YMDj-Xs9aEp29dC32pwZUHSLIkrD7dnojPghFBhQQ$</A>&gt;
</I>&gt;&gt;<i> &lt;<A HREF="https://urldefense.com/v3/__https://wiki.squid-cache.org/Features/SslPeekAndSplice__;!!ORgEfCBsr282Fw!6SDlCpq2n2kV1WuiNQ7focWt2YMDj-Xs9aEp29dC32pwZUHSLIkrD7dnojPghFBhQQ$">https://urldefense.com/v3/__https://wiki.squid-cache.org/Features/SslPeekAndSplice__;!!ORgEfCBsr282Fw!6SDlCpq2n2kV1WuiNQ7focWt2YMDj-Xs9aEp29dC32pwZUHSLIkrD7dnojPghFBhQQ$</A>
</I>&gt;<i> &lt;<A HREF="https://urldefense.com/v3/__https://wiki.squid-cache.org/Features/SslPeekAndSplice__;!!ORgEfCBsr282Fw!6SDlCpq2n2kV1WuiNQ7focWt2YMDj-Xs9aEp29dC32pwZUHSLIkrD7dnojPghFBhQQ$">https://urldefense.com/v3/__https://wiki.squid-cache.org/Features/SslPeekAndSplice__;!!ORgEfCBsr282Fw!6SDlCpq2n2kV1WuiNQ7focWt2YMDj-Xs9aEp29dC32pwZUHSLIkrD7dnojPghFBhQQ$</A>&gt;&gt;
</I>&gt;&gt;&gt;<i> &lt;<A HREF="https://urldefense.com/v3/__https://wiki.squid-cache.org/Features/SslPeekAndSplice__;!!ORgEfCBsr282Fw!6SDlCpq2n2kV1WuiNQ7focWt2YMDj-Xs9aEp29dC32pwZUHSLIkrD7dnojPghFBhQQ$">https://urldefense.com/v3/__https://wiki.squid-cache.org/Features/SslPeekAndSplice__;!!ORgEfCBsr282Fw!6SDlCpq2n2kV1WuiNQ7focWt2YMDj-Xs9aEp29dC32pwZUHSLIkrD7dnojPghFBhQQ$</A>
</I>&gt;&gt;<i> &lt;<A HREF="https://urldefense.com/v3/__https://wiki.squid-cache.org/Features/SslPeekAndSplice__;!!ORgEfCBsr282Fw!6SDlCpq2n2kV1WuiNQ7focWt2YMDj-Xs9aEp29dC32pwZUHSLIkrD7dnojPghFBhQQ$">https://urldefense.com/v3/__https://wiki.squid-cache.org/Features/SslPeekAndSplice__;!!ORgEfCBsr282Fw!6SDlCpq2n2kV1WuiNQ7focWt2YMDj-Xs9aEp29dC32pwZUHSLIkrD7dnojPghFBhQQ$</A>
</I>&gt;<i> &lt;<A HREF="https://urldefense.com/v3/__https://wiki.squid-cache.org/Features/SslPeekAndSplice__;!!ORgEfCBsr282Fw!6SDlCpq2n2kV1WuiNQ7focWt2YMDj-Xs9aEp29dC32pwZUHSLIkrD7dnojPghFBhQQ$">https://urldefense.com/v3/__https://wiki.squid-cache.org/Features/SslPeekAndSplice__;!!ORgEfCBsr282Fw!6SDlCpq2n2kV1WuiNQ7focWt2YMDj-Xs9aEp29dC32pwZUHSLIkrD7dnojPghFBhQQ$</A>&gt;&gt;&gt;
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> HTH,
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Alex.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> ------------------------------------------------------------------------
</I>&gt;&gt;&gt;&gt;<i> *From:* Alex Rousskov &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt;
</I>&gt;&gt;&gt;&gt;<i> *Sent:* Sunday, June 13, 2021 17:46
</I>&gt;&gt;&gt;&gt;<i> *To:* <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A> &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>&gt;
</I>&gt;&gt;&gt;&gt;<i> *Cc:* Frida Safran &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">fsafran at proofpoint.com</A>&gt;
</I>&gt;&gt;&gt;&gt;<i> *Subject:* Re: [squid-users] Passing Proxy Protocol Headers to external ACL
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> On 6/13/21 7:31 AM, Frida Safran wrote:
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i>  1. Is it possible to pass proxy protocol headers to an external acl as
</I>&gt;&gt;&gt;&gt;&gt;<i>     part of the format?
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> It should be possible. Use %proxy_protocol::&gt;h logformat %code in your
</I>&gt;&gt;&gt;&gt;<i> external_acl_type FORMAT configuration. We added that support to Squid
</I>&gt;&gt;&gt;&gt;<i> v5. Not available in the official v4.
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i>  2. Is it possible to pass all/specific icap headers to an external acl?
</I>&gt;&gt;&gt;&gt;&gt;<i>     I have been trying to use %icap::&gt;h to pass all the icap headers to
</I>&gt;&gt;&gt;&gt;&gt;<i>     an external acl, but it resolves to &quot;-&quot;
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> It should be possible if your external ACL is evaluated _after_ the
</I>&gt;&gt;&gt;&gt;<i> corresponding ICAP headers are received, but I would not be surprised if
</I>&gt;&gt;&gt;&gt;<i> there are bugs in this area -- the ICAP headers may be available but not
</I>&gt;&gt;&gt;&gt;<i>  provided to the ACL evaluation code. Which squid.conf directive is
</I>&gt;&gt;&gt;&gt;<i> triggering your external ACL evaluation in this use case?
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> HTH,
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> Alex.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20210620/7359613b/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20210620/7359613b/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="023781.html">[squid-users] Passing Proxy Protocol Headers to external ACL
</A></li>
	<LI>Next message (by thread): <A HREF="023787.html">[squid-users] Passing Proxy Protocol Headers to external ACL
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23782">[ date ]</a>
              <a href="thread.html#23782">[ thread ]</a>
              <a href="subject.html#23782">[ subject ]</a>
              <a href="author.html#23782">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
