<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Data not being cached
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Data%20not%20being%20cached&In-Reply-To=%3C141c2c53-171a-f30d-6658-ab1044ca24c3%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="023783.html">
   <LINK REL="Next"  HREF="023817.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Data not being cached</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Data%20not%20being%20cached&In-Reply-To=%3C141c2c53-171a-f30d-6658-ab1044ca24c3%40treenet.co.nz%3E"
       TITLE="[squid-users] Data not being cached">squid3 at treenet.co.nz
       </A><BR>
    <I>Mon Jun 21 12:29:56 UTC 2021</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="023783.html">[squid-users] Data not being cached
</A></li>
        <LI>Next message (by thread): <A HREF="023817.html">[squid-users] Data not being cached
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23785">[ date ]</a>
              <a href="thread.html#23785">[ thread ]</a>
              <a href="subject.html#23785">[ subject ]</a>
              <a href="author.html#23785">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 21/06/21 6:41 am, Darwin O'Connor wrote:
&gt;<i> I run a transit prediction web app &lt;<A HREF="https://www.transsee.ca/">https://www.transsee.ca/</A>&gt;. It 
</I>&gt;<i> connects to a variety of web APIs to collect the real time transit data 
</I>&gt;<i> it needs. The app's activities are split among many processes. They 
</I>&gt;<i> currently uses libcurl to connect to squid for caching (often for as 
</I>&gt;<i> little as 10-30 seconds) and benefits of connection sharing.
</I>&gt;<i> 
</I>&gt;<i> There is still cases where data isn't being cached no matter what I do. 
</I>&gt;<i> It is https data, but I am able to cache other https pages like 
</I>&gt;<i> <A HREF="https://cdn.mbta.com/realtime/Alerts.pb">https://cdn.mbta.com/realtime/Alerts.pb</A>
</I>&gt;<i> 
</I>&gt;<i> The refresh_pattern:
</I>&gt;<i> 
</I>&gt;<i> refresh_pattern .&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; 60&#160;&#160;&#160;&#160;&#160; 99999%&#160; 7200 override-expire 
</I>&gt;<i> override-lastmod reload-into-ims ignore-reload ignore-no-cache 
</I>&gt;<i> ignore-no-store ignore-private ignore-auth store-stale
</I>&gt;<i> 
</I>
Please be aware that several of those options may be causing you more 
problems than they solve:

* ignore-no-cache - no longer exists.

* ignore-reload - contradicts reload-into-ims and that can cause 
inconsistent behaviour between initial MISS and followup HIT responses.

* override-lastmod - replaces all Last-Modification (L-M) headers with 
values indicating the object is almost brand new. That prevents caches 
detecting that objects have stuck around long enough not to need replacing.
  Luckily the example response has no L-M header, so that is not the 
problem here. But it may be affecting other traffic.



&gt;<i> The http headers from curl of an example where it is not being cached:
</I>&gt;<i> 
</I>&gt;<i> *&#160;&#160; Trying 127.0.0.1:3128...
</I>&gt;<i> * Connected to 127.0.0.1 (127.0.0.1) port 3128 (#0)
</I>&gt;<i>  &gt; GET <A HREF="https://api.transport.nsw.gov.au/v1/gtfs/alerts/buses">https://api.transport.nsw.gov.au/v1/gtfs/alerts/buses</A> HTTP/1.1
</I>&gt;<i> Host: 127.0.0.1:3128
</I>&gt;<i> User-Agent: curl/7.77.0 (+<A HREF="https://www.transsee.ca/">https://www.transsee.ca/</A>)
</I>&gt;<i> Accept: */*
</I>&gt;<i> Accept-Encoding: gzip
</I>
Note this header value is used for variant selection of the responses.

Is this test value the same as what the client apps send?


&gt;<i> Authorization: apikey 2eYEqXXxOPEDChnpeF7sZL2aR8moD2DtdNmn
</I>&gt;<i> Cache-Control: max-age=60
</I>&gt;<i> Content-Encoding: aes128gcm
</I>
Apparently the GET message contains some content. Yet there is no 
Content-Length or Transfer-Encoding to determine the length of that 
content.


&gt;<i> 
</I>&gt;<i> * Mark bundle as not supporting multiuse
</I>&gt;<i> &lt; HTTP/1.1 200 OK
</I>&gt;<i> &lt; Date: Sun, 20 Jun 2021 17:52:14 GMT
</I>&gt;<i> &lt; Content-Type: application/protobuf
</I>&gt;<i> &lt; Content-Length: 7455
</I>...
&gt;<i> &lt; Access-Control-Allow-Credentials: true
</I>&gt;<i> &lt; ETag: W/&quot;ab70-8SI2GdBV4SJG4edSc4E5W8LBJWk&quot;
</I>&gt;<i> &lt; Vary: Accept-Encoding
</I>&gt;<i> &lt; X-Cache: Hit from cloudfront
</I>&gt;<i> &lt; X-Amz-Cf-Pop: SYD1-C1
</I>&gt;<i> &lt; X-Amz-Cf-Id: hCoQckLsNONQMpgPr2kXJVdTDHu98jxl-rPXqV_PHB2vTCEomAd-Nw==
</I>&gt;<i> &lt; Age: 35
</I>&gt;<i> &lt; Access-Control-Allow-Origin: *
</I>&gt;<i> &lt; Content-Encoding: gzip
</I>&gt;<i> &lt; X-Cache: MISS from transsee
</I>&gt;<i> &lt; X-Cache-Lookup: MISS from transsee:3128
</I>&gt;<i> &lt; Via: 1.1 359a113ca166631b42f31a0f2e6a1aab.cloudfront.net (CloudFront), 
</I>&gt;<i> 1.1 transsee (squid/4.15)
</I>&gt;<i> &lt; Connection: keep-alive
</I>&gt;<i> 
</I>&gt;<i> Here is a sample from the Squid access log:
</I>&gt;<i> 
</I>&gt;<i> 1624212034.891&#160;&#160;&#160; 246 127.0.0.1 59216 TCP_MISS/200 8517 GET 
</I>&gt;<i> <A HREF="https://api.transport.nsw.gov.au/v1/gtfs/alerts/buses">https://api.transport.nsw.gov.au/v1/gtfs/alerts/buses</A> - 
</I>&gt;<i> HIER_DIRECT/52.65.222.24 application/protobuf
</I>&gt;<i> 
</I>
FYI, A single request is not sufficient to demonstrate caching issues. 
Caches always require one MISS to fetch the data which then is expected 
to show up as HIT on the second or later requests.


Couple of things going on here with timing make this a MISS:

* The log timestamp says your test happened at Mon, 21 Jun 2021 12:21:11 GMT

* The response Date says it was created Sun, 20 Jun 2021 17:52:14 GMT

* The request Cache-Control forbids receiving anything from cache older 
than 60 seconds.

So, the response being many hours old cannot be delivered from a cache 
to this test request.

NP: CloudFront are a reverse-proxy service, thus allowed to ignore 
Cache-Control from clients. Which is why they respond with a HIT.


Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="023783.html">[squid-users] Data not being cached
</A></li>
	<LI>Next message (by thread): <A HREF="023817.html">[squid-users] Data not being cached
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23785">[ date ]</a>
              <a href="thread.html#23785">[ thread ]</a>
              <a href="subject.html#23785">[ subject ]</a>
              <a href="author.html#23785">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
