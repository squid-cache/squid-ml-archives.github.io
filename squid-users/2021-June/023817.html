<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Data not being cached
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Data%20not%20being%20cached&In-Reply-To=%3Cba005970-af36-b46e-e8f6-345b58967f24%40transsee.ca%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="023785.html">
   <LINK REL="Next"  HREF="023784.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Data not being cached</H1>
    <B>Darwin O'Connor</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Data%20not%20being%20cached&In-Reply-To=%3Cba005970-af36-b46e-e8f6-345b58967f24%40transsee.ca%3E"
       TITLE="[squid-users] Data not being cached">doconnor at transsee.ca
       </A><BR>
    <I>Wed Jun 23 02:04:29 UTC 2021</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="023785.html">[squid-users] Data not being cached
</A></li>
        <LI>Next message (by thread): <A HREF="023784.html">[squid-users] cacheProtoClientHttpRequests OID
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23817">[ date ]</a>
              <a href="thread.html#23817">[ thread ]</a>
              <a href="subject.html#23817">[ subject ]</a>
              <a href="author.html#23817">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 2021-06-22 8:00 a.m., <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-request at lists.squid-cache.org</A> wrote:

&gt;<i> On 21/06/21 6:41 am, Darwin O'Connor wrote:
</I>&gt;&gt;<i> I run a transit prediction web app &lt;<A HREF="https://www.transsee.ca/">https://www.transsee.ca/</A>&gt;. It
</I>&gt;&gt;<i> connects to a variety of web APIs to collect the real time transit data
</I>&gt;&gt;<i> it needs. The app's activities are split among many processes. They
</I>&gt;&gt;<i> currently uses libcurl to connect to squid for caching (often for as
</I>&gt;&gt;<i> little as 10-30 seconds) and benefits of connection sharing.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> There is still cases where data isn't being cached no matter what I do.
</I>&gt;&gt;<i> It is https data, but I am able to cache other https pages like
</I>&gt;&gt;<i> <A HREF="https://cdn.mbta.com/realtime/Alerts.pb">https://cdn.mbta.com/realtime/Alerts.pb</A>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The refresh_pattern:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> refresh_pattern .?????????????? 60????? 99999%? 7200 override-expire
</I>&gt;&gt;<i> override-lastmod reload-into-ims ignore-reload ignore-no-cache
</I>&gt;&gt;<i> ignore-no-store ignore-private ignore-auth store-stale
</I>&gt;&gt;<i>
</I>&gt;<i> Please be aware that several of those options may be causing you more
</I>&gt;<i> problems than they solve:
</I>&gt;<i>
</I>&gt;<i> * ignore-no-cache - no longer exists.
</I>&gt;<i>
</I>&gt;<i> * ignore-reload - contradicts reload-into-ims and that can cause
</I>&gt;<i> inconsistent behaviour between initial MISS and followup HIT responses.
</I>&gt;<i>
</I>&gt;<i> * override-lastmod - replaces all Last-Modification (L-M) headers with
</I>&gt;<i> values indicating the object is almost brand new. That prevents caches
</I>&gt;<i> detecting that objects have stuck around long enough not to need 
</I>&gt;<i> replacing.
</I>&gt;<i> Luckily the example response has no L-M header, so that is not the
</I>&gt;<i> problem here. But it may be affecting other traffic.
</I>
I have removed these options. My refresh_pattern is now

refresh_pattern .&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; 60&#160;&#160;&#160;&#160;&#160; 99999%&#160; 7200 override-expire 
ignore-no-store ignore-private ignore-auth store-stale

Here are two requests, one after another. The headers match the actual 
client apps.

*&#160;&#160; Trying 127.0.0.1:3128...
* Connected to 127.0.0.1 (127.0.0.1) port 3128 (#0)
&gt;<i> GET <A HREF="https://api.transport.nsw.gov.au/v1/gtfs/alerts/buses">https://api.transport.nsw.gov.au/v1/gtfs/alerts/buses</A> HTTP/1.1
</I>Host: 127.0.0.1:3128
User-Agent: curl/7.77.0 (+<A HREF="https://www.transsee.ca/">https://www.transsee.ca/</A>)
Accept: */*
Accept-Encoding: gzip
Authorization: apikey 4sc5KapPRVzX6OeQm74FPCx9O0bFsIB7lei3
Cache-Control: max-age=60

* Mark bundle as not supporting multiuse
&lt; HTTP/1.1 200 OK
&lt; Date: Tue, 22 Jun 2021 23:23:06 GMT
&lt; Content-Type: application/protobuf
&lt; Content-Length: 7317
&lt; Set-Cookie: 
AWSALB=uydcNa4qcva/6YErLw+Ztl55Xvjtkf1N6HQiEfXOrPv46pjWn6uHEnqcRlPMWjcHXu6vAsbYjB/1WdxrVIYu0AAbrtIcz00zyAIiimoWQhWUlQFb6PO9120gf46N; 
Expires=Tue, 29 Jun 2021 23:23:06 GMT; Path=/
&lt; Set-Cookie: 
AWSALBCORS=uydcNa4qcva/6YErLw+Ztl55Xvjtkf1N6HQiEfXOrPv46pjWn6uHEnqcRlPMWjcHXu6vAsbYjB/1WdxrVIYu0AAbrtIcz00zyAIiimoWQhWUlQFb6PO9120gf46N; 
Expires=Tue, 29 Jun 2021 23:23:06 GMT; Path=/; SameSite=None; Secure
&lt; Server: Apache-Coyote/1.1
&lt; X-Powered-By: Express
&lt; Access-Control-Allow-Credentials: true
&lt; ETag: W/&quot;9b9e-32oicwXN7rJop21q+Y++RZhtnac&quot;
&lt; Vary: Accept-Encoding
&lt; X-Cache: Hit from cloudfront
&lt; X-Amz-Cf-Pop: SYD1-C
&lt; X-Amz-Cf-Id: fQeOCQLj5CiuSv2JV06y7O0r5rM0LvNchlXKFSBDKkES0-tUrmaorQ==
&lt; Age: 31
&lt; Access-Control-Allow-Origin: *
&lt; Content-Encoding: gzip
&lt; X-Cache: MISS from transsee
&lt; X-Cache-Lookup: MISS from transsee:3128
&lt; Via: 1.1 e57fe70b9ed429fb51b4b2432cadc67b.cloudfront.net (CloudFront), 
1.1 transsee (squid/4.15)
&lt; Connection: keep-alive

*&#160;&#160; Trying 127.0.0.1:3128...
* Connected to 127.0.0.1 (127.0.0.1) port 3128 (#0)
&gt;<i> GET <A HREF="https://api.transport.nsw.gov.au/v1/gtfs/alerts/buses">https://api.transport.nsw.gov.au/v1/gtfs/alerts/buses</A> HTTP/1.1
</I>Host: 127.0.0.1:3128
User-Agent: curl/7.77.0 (+<A HREF="https://www.transsee.ca/">https://www.transsee.ca/</A>)
Accept: */*
Accept-Encoding: gzip
Authorization: apikey 4sc5KapPRVzX6OeQm74FPCx9O0bFsIB7lei3
Cache-Control: max-age=60

* Mark bundle as not supporting multiuse
&lt; HTTP/1.1 200 OK
&lt; Date: Tue, 22 Jun 2021 23:23:13 GMT
&lt; Content-Type: application/protobuf
&lt; Content-Length: 7317
&lt; Set-Cookie: 
AWSALB=zjeR+TBhpLTKE+mr042891Cxkb7caSUqya7wvG82Ca7cK86Z7iQco0ahsj/9H9WtdgJuiX/D9++AOYiQf3+9yryXrZscG5eX+X0+vVjI+t2fI/86DjV27tXLyt3o; 
Expires=Tue, 29 Jun 2021 23:23:13 GMT; Path=/
&lt; Set-Cookie: 
AWSALBCORS=zjeR+TBhpLTKE+mr042891Cxkb7caSUqya7wvG82Ca7cK86Z7iQco0ahsj/9H9WtdgJuiX/D9++AOYiQf3+9yryXrZscG5eX+X0+vVjI+t2fI/86DjV27tXLyt3o; 
Expires=Tue, 29 Jun 2021 23:23:13 GMT; Path=/; SameSite=None; Secure
&lt; Server: Apache-Coyote/1.1
&lt; X-Powered-By: Express
&lt; Access-Control-Allow-Credentials: true
&lt; ETag: W/&quot;9b9e-32oicwXN7rJop21q+Y++RZhtnac&quot;
&lt; Vary: Accept-Encoding
&lt; X-Cache: Hit from cloudfront
&lt; X-Amz-Cf-Pop: SYD1-C1
&lt; X-Amz-Cf-Id: cL-w8TjYWTb6cjEOLsyfwyIvZvQYTI7Hn4R8Uz6cppHEJwVUWejO1w==
&lt; Age: 38
&lt; Access-Control-Allow-Origin: *
&lt; Content-Encoding: gzip
&lt; X-Cache: MISS from transsee
&lt; X-Cache-Lookup: MISS from transsee:3128
&lt; Via: 1.1 e57fe70b9ed429fb51b4b2432cadc67b.cloudfront.net (CloudFront), 
1.1 transsee (squid/4.15)
&lt; Connection: keep-alive

Here is the corresponding records from the access log. Before the 
records where from different fetches.

1624404186.746&#160;&#160;&#160; 298 127.0.0.1 59540 TCP_MISS/200 8380 GET 
<A HREF="https://api.transport.nsw.gov.au/v1/gtfs/alerts/buses">https://api.transport.nsw.gov.au/v1/gtfs/alerts/buses</A> - 
HIER_DIRECT/3.105.153.49 application/protobuf

1624404193.862&#160;&#160;&#160; 269 127.0.0.1 59886 TCP_MISS/200 8380 GET 
<A HREF="https://api.transport.nsw.gov.au/v1/gtfs/alerts/buses">https://api.transport.nsw.gov.au/v1/gtfs/alerts/buses</A> - 
HIER_DIRECT/3.105.153.49 application/protobuf



</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="023785.html">[squid-users] Data not being cached
</A></li>
	<LI>Next message (by thread): <A HREF="023784.html">[squid-users] cacheProtoClientHttpRequests OID
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23817">[ date ]</a>
              <a href="thread.html#23817">[ thread ]</a>
              <a href="subject.html#23817">[ subject ]</a>
              <a href="author.html#23817">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
