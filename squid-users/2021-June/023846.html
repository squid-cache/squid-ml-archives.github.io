<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] How to use request headers in external_acl_type
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20How%20to%20use%20request%20headers%20in%20external_acl_type&In-Reply-To=%3C7416EB54B03743A4B7B8AFDB52229FDC%40OhrSomayach%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="023829.html">
   <LINK REL="Next"  HREF="023834.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] How to use request headers in external_acl_type</H1>
    <B>Yosi Greenfield</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20How%20to%20use%20request%20headers%20in%20external_acl_type&In-Reply-To=%3C7416EB54B03743A4B7B8AFDB52229FDC%40OhrSomayach%3E"
       TITLE="[squid-users] How to use request headers in external_acl_type">ygreenfield at kewsystems.com
       </A><BR>
    <I>Wed Jun 30 17:17:19 UTC 2021</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="023829.html">[squid-users] How to use request headers in external_acl_type
</A></li>
        <LI>Next message (by thread): <A HREF="023834.html">[squid-users] More detail for access logs on error
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23846">[ date ]</a>
              <a href="thread.html#23846">[ thread ]</a>
              <a href="subject.html#23846">[ subject ]</a>
              <a href="author.html#23846">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Amos,

As always, thank you for your dedication answering all our questions.

Ok, turns out, as you noted, the browser is sending the correct request
headers. However, on https requests the external acl program is not getting
the custom header we're sending. SSL Bump is set, and works for our
redirector program, but not for the external acl program.

Here are the relevant lines from squid.conf:

   http_port 3128 name=non-bumped
   http_port 3130 ssl-bump generate-host-certificates=on
dynamic_cert_mem_cache_size=6MB cert=/etc/squid/ssl/newCA.pem name=bumped
options=ALL

   acl non-bumped myportname non-bumped
   acl bumped myportname bumped

   acl step1 at_step SslBump1
   acl broken_sites dstdomain &quot;/etc/squid/nobump/domains&quot;
   acl broken_sites_regex dstdom_regex -i &quot;/etc/squid/nobump/regexes&quot;
   ssl_bump splice broken_sites
   ssl_bump splice broken_sites_regex
   ssl_bump peek step1
   ssl_bump bump all

   external_acl_type portal_gatekeeper  %SRC %&gt;{Connection} %&gt;{Accept}
%&gt;{abc_session} %&gt;{Host} /etc/squid/portal.pl
   acl check-portal external portal_gatekeeper
   deny_info <A HREF="http://www.our_portal_site.com/">http://www.our_portal_site.com/</A> check-portal

   acl myIP1 src 10.200.10.2
   http_access deny myIP1 !check-portal

   sslcrtd_program /usr/local/squid/libexec/security_file_certgen -s
/var/lib/ssl_db -M 4MB
   sslcrtd_children 15 startup=5

   sslproxy_cert_error allow all
   request_header_access Surrogate-Capability deny all

   url_rewrite_access allow non-bumped
   url_rewrite_access deny bumped CONNECT
   url_rewrite_children 15  startup=7

   acl our_users src 10.10.0.0/24 10.10.1.0/24 10.200.0.0/16
   http_access allow our_users


Is it possible to get the custom abc_session header on https requests?

Thank you again.



&gt;<i> -----Original Message-----
</I>&gt;<i> From: squid-users 
</I>&gt;<i> [mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>] On Behalf 
</I>&gt;<i> Of <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>
</I>&gt;<i> Sent: Friday, June 25, 2021 7:20 PM
</I>&gt;<i> To: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> Subject: Re: [squid-users] How to use request headers in 
</I>&gt;<i> external_acl_type
</I>&gt;<i> 
</I>&gt;<i> On 2021-06-26 07:18, Yosi Greenfield wrote:
</I>&gt;<i> &gt; Hello all,
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; I'm trying to use request headers in an external acl, and 
</I>&gt;<i> I'm probably 
</I>&gt;<i> &gt; doing it incorrectly, and it's not working.
</I>&gt;<i> &gt; 
</I>&gt;<i> 
</I>&gt;<i> Looks like its working fine.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> &gt; Here's my acl definiton:
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; external_acl_type ext_acl_program  %SRC %&gt;{Connection} %&gt;{Accept} 
</I>&gt;<i> &gt; %&gt;{Custom_header} %&gt;{Host} /etc/squid/ext_acl_program.pl
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; The program ext_acl_program.pl simply prints out the input
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt;    chomp ($line);
</I>&gt;<i> &gt;    @fields          = split(' ', $line);
</I>&gt;<i> &gt;    my $ip           = $fields[0];
</I>&gt;<i> &gt;    my $connection   = $fields[1];
</I>&gt;<i> &gt;    my $accept       = $fields[2];
</I>&gt;<i> &gt;    my $custom       = $fields[3];
</I>&gt;<i> &gt;    my $host         = $fields[4];
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt;    print LOGFILE  &quot;IP: $ip\n Conn: $connection\n Accept: $accept\n
</I>&gt;<i> &gt; Custom: $custom\n Host: $host&quot;;
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; The output looks like this:
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; IP: 10.200.10.2
</I>&gt;<i> &gt; Conn: keep-alive
</I>&gt;<i> &gt; Accept: -
</I>&gt;<i> &gt; Custom: -
</I>&gt;<i> &gt; Host: www.wsws.com:443 [1]
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; As you see, it has values for %SRC, %&gt;{Connection} and 
</I>&gt;<i> %&gt;{Host}.  It 
</I>&gt;<i> &gt; does not have values for %&gt;{Accept} and %&gt;{Custom_header}
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; So the question is, are these %&gt;{} substitutions coming from 
</I>&gt;<i> &gt; request_headers (as I thought)?
</I>&gt;<i> 
</I>&gt;<i> The Host header only exists in request messages so I would 
</I>&gt;<i> say they are.
</I>&gt;<i> It may not be the request message you are thinking about 
</I>&gt;<i> though. Request headers can come from clients, but they could 
</I>&gt;<i> also be generated by Squid or ICAP/eCAP services.
</I>&gt;<i> 
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; If yes, why does it only have Connection and Host, and not 
</I>&gt;<i> Accept or 
</I>&gt;<i> &gt; my custom header?
</I>&gt;<i> &gt; 
</I>&gt;<i> 
</I>&gt;<i> Because those are the headers the message being printed contain.
</I>&gt;<i> You do not provide enough details about where the request 
</I>&gt;<i> came from. eg how it was created and/or changed between 
</I>&gt;<i> creation and the helper being called.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> &gt; If they are not coming from request headers, where are they coming 
</I>&gt;<i> &gt; from?
</I>&gt;<i> &gt; 
</I>&gt;<i> 
</I>&gt;<i> You can use &quot;debug_options 11,2&quot; to see the HTTP messages 
</I>&gt;<i> Squid is processing.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> &gt; And mostly, how can I pass my custom header into the program?
</I>&gt;<i> 
</I>&gt;<i> Exactly as you configured above. Assuming that the header is actually 
</I>&gt;<i> &quot;Custom_header: ...&quot; with that underscore included.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Amos
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i> 
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="023829.html">[squid-users] How to use request headers in external_acl_type
</A></li>
	<LI>Next message (by thread): <A HREF="023834.html">[squid-users] More detail for access logs on error
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23846">[ date ]</a>
              <a href="thread.html#23846">[ thread ]</a>
              <a href="subject.html#23846">[ subject ]</a>
              <a href="author.html#23846">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
