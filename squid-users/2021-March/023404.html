<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] squid ssl-bump with icap returns 503
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid%20ssl-bump%20with%20icap%20returns%20503&In-Reply-To=%3CEBE79ACA-BABA-4F24-A41C-D4D011856432%40ironpeak.be%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="023403.html">
   <LINK REL="Next"  HREF="023405.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] squid ssl-bump with icap returns 503</H1>
    <B>Niels Hofmans</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid%20ssl-bump%20with%20icap%20returns%20503&In-Reply-To=%3CEBE79ACA-BABA-4F24-A41C-D4D011856432%40ironpeak.be%3E"
       TITLE="[squid-users] squid ssl-bump with icap returns 503">hello at ironpeak.be
       </A><BR>
    <I>Thu Mar  4 12:13:07 UTC 2021</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="023403.html">[squid-users] squid ssl-bump with icap returns 503
</A></li>
        <LI>Next message (by thread): <A HREF="023405.html">[squid-users] squid ssl-bump with icap returns 503
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23404">[ date ]</a>
              <a href="thread.html#23404">[ thread ]</a>
              <a href="subject.html#23404">[ subject ]</a>
              <a href="author.html#23404">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

Interestingly this seems to work on a http_proxy listener:

http_port 0.0.0.0:3129 ssl-bump \
    generate-host-certificates=on dynamic_cert_mem_cache_size=10MB \
    cert=/etc/squid/ssl/squid.crt key=/etc/squid/ssl/squid.key
    #tls-cert=/etc/squid/ssl/squid.crt tls-key=/etc/squid/ssl/squid.key

always_direct allow all
ssl_bump bump all

But with https_port, I require tproxy/intercept which if I configure it returns:

http_port 0.0.0.0:3128 ssl-bump
https_port 0.0.0.0:3129 ssl-bump intercept \
    generate-host-certificates=on dynamic_cert_mem_cache_size=10MB \
    cert=/etc/squid/ssl/squid.crt key=/etc/squid/ssl/squid.key \
    tls-cert=/etc/squid/ssl/squid.crt tls-key=/etc/squid/ssl/squid.key
2021/03/04 12:11:27 kid1| ERROR: NF getsockopt(ORIGINAL_DST) failed on local=172.17.0.2:3129 remote=172.17.0.1:64488 FD 13 flags=33: (2) No such file or directory
2021/03/04 12:11:27 kid1| ERROR: NF getsockopt(ORIGINAL_DST) failed on local=172.17.0.2:3129 remote=172.17.0.1:64488 FD 13 flags=33: (2) No such file or directory
2021/03/04 12:11:27 kid1| ERROR: NAT/TPROXY lookup failed to locate original IPs on local=172.17.0.2:3129 remote=172.17.0.1:64488 FD 13 flags=33
2021/03/04 12:11:27 kid1| ERROR: NAT/TPROXY lookup failed to locate original IPs on local=172.17.0.2:3129 remote=172.17.0.1:64488 FD 13 flags=33
1614859887.972      0 172.17.0.1 NONE/000 0 NONE error:accept-client-connection - HIER_NONE/- -


And:

http_port 0.0.0.0:3128 ssl-bump
https_port 0.0.0.0:3129 ssl-bump tproxy \
    generate-host-certificates=on dynamic_cert_mem_cache_size=10MB \
    cert=/etc/squid/ssl/squid.crt key=/etc/squid/ssl/squid.key \
    tls-cert=/etc/squid/ssl/squid.crt tls-key=/etc/squid/ssl/squid.key

FATAL: https_port: TPROXY support in the system does not work.


Niels Hofmans

SITE   <A HREF="https://ironpeak.be">https://ironpeak.be</A>
BTW   BE0694785660
BANK BE76068909740795

On 4 Mar 2021, at 12:21, Niels Hofmans &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">hello at ironpeak.be</A>&gt; wrote:

Hi,

I think I may have found an issue: it only seems to ICAP the CONNECT request, whereas it will not pass any subsequent requests in that CONNECT tunnel to ICAP?

So my original implementation did not check for the HTTP method in ICAP, so it returned the wrong CONNECT hostname:

OPTIONS <A HREF="icap://10.10.0.119:1344/">icap://10.10.0.119:1344/</A> &lt;<A HREF="icap://10.10.0.119:1344/">icap://10.10.0.119:1344/</A>&gt; ICAP/1.0
Host: 10.10.0.119:1344
Allow: 206

ICAP/1.0 200 OK
Allow: 200,204
Connection: close
Date: Thu, 04 Mar 2021 11:11:45 GMT
Encapsulated: null-body=0
Methods: REQMOD,REQRESP
Preview: 0
Transfer-Preview: *

CONNECT ironpeak.be:443 &lt;<A HREF="http://ironpeak.be:443/">http://ironpeak.be:443/</A>&gt; HTTP/1.1
User-Agent: curl/7.64.1
Host: ironpeak.be:443 &lt;<A HREF="http://ironpeak.be:443/">http://ironpeak.be:443/</A>&gt;

REQMOD <A HREF="icap://10.10.0.119:1344/">icap://10.10.0.119:1344/</A> &lt;<A HREF="icap://10.10.0.119:1344/">icap://10.10.0.119:1344/</A>&gt; ICAP/1.0
Host: 10.10.0.119:1344
Date: Thu, 04 Mar 2021 11:11:23 GMT
Encapsulated: req-hdr=0, null-body=84
Preview: 0
Allow: 204

ICAP/1.0 200 OK
Connection: close
Date: Thu, 04 Mar 2021 11:11:23 GMT
Encapsulated: req-hdr=0, null-body=111

CONNECT //ironpeak.be:443 &lt;<A HREF="http://ironpeak.be:443/">http://ironpeak.be:443/</A>&gt;/blog/big-sur-t2rminator/ HTTP/1.1  &lt;&lt;&lt;&lt; here is my bug
Host: ironpeak.be:443 &lt;<A HREF="http://ironpeak.be:443/">http://ironpeak.be:443/</A>&gt;
User-Agent: curl/7.64.1

But now, it does not pass any HTTP request in the CONNECT tunnel to ICAP:

CONNECT ironpeak.be:443 &lt;<A HREF="http://ironpeak.be:443/">http://ironpeak.be:443/</A>&gt; HTTP/1.1
User-Agent: curl/7.64.1
Host: ironpeak.be:443 &lt;<A HREF="http://ironpeak.be:443/">http://ironpeak.be:443/</A>&gt;

REQMOD <A HREF="icap://10.10.0.119:1344/">icap://10.10.0.119:1344/</A> &lt;<A HREF="icap://10.10.0.119:1344/">icap://10.10.0.119:1344/</A>&gt; ICAP/1.0
Host: 10.10.0.119:1344
Date: Thu, 04 Mar 2021 11:19:00 GMT
Encapsulated: req-hdr=0, null-body=84
Preview: 0
Allow: 204

ICAP/1.0 204 No Modifications
Connection: close
Date: Thu, 04 Mar 2021 11:19:00 GMT
Encapsulated: null-body=0

..TLS ciphertext..    &lt;&lt;&lt;&lt;. No more ICAP requests


Any idea on how I pass -every- sslbumped request to ICAP?
Thank you.

Regards,
Niels Hofmans
SITE   <A HREF="https://ironpeak.be">https://ironpeak.be</A> &lt;<A HREF="https://ironpeak.be/">https://ironpeak.be/</A>&gt;

On 4 Mar 2021, at 12:01, NgTech LTD &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">ngtech1ltd at gmail.com</A> &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">ngtech1ltd at gmail.com</A>&gt;&gt; wrote:

Would it be possible to dump some icap traffic so we would be able to understand what might cause this issue if at all?

Eliezer

&#1489;&#1514;&#1488;&#1512;&#1497;&#1498; &#1497;&#1493;&#1501; &#1492;&#1523;, 4 &#1489;&#1502;&#1512;&#1509; 2021, 12:36, &#1502;&#1488;&#1514; Niels Hofmans &#8207;&lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">hello at ironpeak.be</A> &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">hello at ironpeak.be</A>&gt;&gt;:
Hi guys,

I&#8217;m asking here but since I&#8217;m not too comfortable with a mailing list, it&#8217;s also on serverfault.com &lt;<A HREF="http://serverfault.com/">http://serverfault.com/</A>&gt;: <A HREF="https://serverfault.com/questions/1055663/squid-icap-not-working-if-using-tls-interception-but-both-work-separately">https://serverfault.com/questions/1055663/squid-icap-not-working-if-using-tls-interception-but-both-work-separately</A> &lt;<A HREF="https://serverfault.com/questions/1055663/squid-icap-not-working-if-using-tls-interception-but-both-work-separately">https://serverfault.com/questions/1055663/squid-icap-not-working-if-using-tls-interception-but-both-work-separately</A>&gt;

I have an odd issue that squid will return a HTTP 503 when I try to do ICAP for an ssl-bumped HTTPS website. HTTP website works fine.
Any ideas?

Config:

visible_hostname proxy
forwarded_for delete
via off
httpd_suppress_version_string on
logfile_rotate 0
cache_log stdio:/dev/stdout
access_log stdio:/dev/stdout
cache_store_log stdio:/dev/stdout
dns_v4_first on
cache_dir ufs /cache 100 16 256
pid_filename /cache/squid.pid
mime_table /usr/share/squid/mime.conf
http_port 0.0.0.0:3128 &lt;<A HREF="http://0.0.0.0:3128/">http://0.0.0.0:3128/</A>&gt;
https_port 0.0.0.0:3129 &lt;<A HREF="http://0.0.0.0:3129/">http://0.0.0.0:3129/</A>&gt; \
    generate-host-certificates=on dynamic_cert_mem_cache_size=10MB \
    tls-cert=/etc/squid/ssl/squid.crt tls-key=/etc/squid/ssl/squid.key
ssl_bump peek all
ssl_bump bump all
quick_abort_min 0
quick_abort_max 0
quick_abort_pct 95
pinger_enable off
icap_enable on
icap_service_failure_limit -1
icap_service service_req reqmod_precache bypass=0 <A HREF="icap://10.10.0.119:1344/">icap://10.10.0.119:1344/</A> &lt;&gt;
icap_preview_enable on
adaptation_access service_req allow all
cache_mem 512 mb
dns_nameservers 1.1.1.1 1.0.0.1
cache_effective_user proxy
sslcrtd_program /usr/lib/squid/security_file_certgen -s /cache/ssl_db -M 4MB
sslcrtd_children 8 startup=1 idle=1
sslproxy_cert_error allow all
http_access allow all

Log line HTTPS when it doesn&#8217;t work:
1614853306.542     40 172.17.0.1 NONE/503 0 CONNECT //ironpeak.be:443 &lt;<A HREF="http://ironpeak.be:443/">http://ironpeak.be:443/</A>&gt; - HIER_NONE/- -

&lt; HTTP/1.1 503 Service Unavailable
&lt; Server: squid
&lt; Mime-Version: 1.0
&lt; Date: Thu, 04 Mar 2021 10:36:05 GMT
&lt; Content-Type: text/html;charset=utf-8
&lt; Content-Length: 1849
&lt; X-Squid-Error: ERR_DNS_FAIL 0


Log line HTTP when it does work:
  -1 1614851916 text/plain 60/60 GET <A HREF="http://ironpeak.be/blog/big-sur-t2rminator/">http://ironpeak.be/blog/big-sur-t2rminator/</A> &lt;<A HREF="http://ironpeak.be/blog/big-sur-t2rminator/">http://ironpeak.be/blog/big-sur-t2rminator/</A>&gt;
1614853320.743 SWAPOUT 00 00000002 F7A390D89822E9BA831C47E1B4CDD0A8  301 1614853320        -1 1614853320 text/plain 60/60 GET <A HREF="http://ironpeak.be/blog/big-sur-t2rminator/">http://ironpeak.be/blog/big-sur-t2rminator/</A> &lt;<A HREF="http://ironpeak.be/blog/big-sur-t2rminator/">http://ironpeak.be/blog/big-sur-t2rminator/</A>&gt;
1614853320.748    302 172.17.0.1 TCP_REFRESH_MODIFIED/301 1647 GET <A HREF="http://ironpeak.be/blog/big-sur-t2rminator/">http://ironpeak.be/blog/big-sur-t2rminator/</A> &lt;<A HREF="http://ironpeak.be/blog/big-sur-t2rminator/">http://ironpeak.be/blog/big-sur-t2rminator/</A>&gt; - HIER_DIRECT/104.21.60.47 &lt;<A HREF="http://104.21.60.47/">http://104.21.60.47/</A>&gt; text/plain

Example CLI command used:
ALL_PROXY=&quot;<A HREF="https://127.0.0.1:3129">https://127.0.0.1:3129</A> &lt;<A HREF="https://127.0.0.1:3129/">https://127.0.0.1:3129/</A>&gt;&quot; curl -vvv --proxy-insecure <A HREF="http://ironpeak.be/">http://ironpeak.be/</A> &lt;<A HREF="http://ironpeak.be/">http://ironpeak.be/</A>&gt;

Command used to start squid:
exec /usr/sbin/squid -f /etc/squid/squid.conf --foreground -YCd 1
Package info:
Package: squid-openssl
Version: 4.13-5

Many thanks!
Regards,
Niels Hofmans

SITE   <A HREF="https://ironpeak.be">https://ironpeak.be</A> &lt;<A HREF="https://ironpeak.be/">https://ironpeak.be/</A>&gt;
_______________________________________________
squid-users mailing list
<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A> &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>&gt;
<A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A> &lt;<A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>&gt;


-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20210304/8ba13e3d/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20210304/8ba13e3d/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="023403.html">[squid-users] squid ssl-bump with icap returns 503
</A></li>
	<LI>Next message (by thread): <A HREF="023405.html">[squid-users] squid ssl-bump with icap returns 503
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23404">[ date ]</a>
              <a href="thread.html#23404">[ thread ]</a>
              <a href="subject.html#23404">[ subject ]</a>
              <a href="author.html#23404">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
