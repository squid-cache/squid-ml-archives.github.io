<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Icap preview size
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Icap%20preview%20size&In-Reply-To=%3CB35B53AF-7FC7-471B-AB2D-4E8207887425%40ironpeak.be%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="023416.html">
   <LINK REL="Next"  HREF="023419.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Icap preview size</H1>
    <B>Niels Hofmans</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Icap%20preview%20size&In-Reply-To=%3CB35B53AF-7FC7-471B-AB2D-4E8207887425%40ironpeak.be%3E"
       TITLE="[squid-users] Icap preview size">hello at ironpeak.be
       </A><BR>
    <I>Sat Mar  6 10:09:00 UTC 2021</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="023416.html">[squid-users] Icap preview size
</A></li>
        <LI>Next message (by thread): <A HREF="023419.html">[squid-users] Icap preview size
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23417">[ date ]</a>
              <a href="thread.html#23417">[ thread ]</a>
              <a href="subject.html#23417">[ subject ]</a>
              <a href="author.html#23417">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Alex,

I&#8217;ve uploaded a tcpdump sample of where I&#8217;m requesting an image through squid + icap and where you can see the image response being posted fully to the ICAP service.
Headers passed on are Preview: 0 for RESPMOD and Transfer-Preview: *. (I only need the headers for the response)

PCAP: <A HREF="https://www.mediafire.com/file/k7zs51lg9s5ka3h/icap.pcap/file">https://www.mediafire.com/file/k7zs51lg9s5ka3h/icap.pcap/file</A> &lt;<A HREF="https://www.mediafire.com/file/k7zs51lg9s5ka3h/icap.pcap/file">https://www.mediafire.com/file/k7zs51lg9s5ka3h/icap.pcap/file</A>&gt;

Many thanks for co-debugging. :-)
Enjoy your weekend!

Regards,
Niels Hofmans

SITE   <A HREF="https://ironpeak.be">https://ironpeak.be</A>
BTW   BE0694785660
BANK BE76068909740795

On 5 Mar 2021, at 23:32, Alex Rousskov &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt; wrote:

On 3/5/21 5:21 PM, Niels Hofmans wrote:

&gt;<i> I receive that large payload right after an OPTIONS call to my ICAP endpoint. It is the preview.
</I>
The timing of an ICAP request does not determine whether that request
has a Preview stage and whether the &quot;unexpected&quot; body bytes were sent
during that Preview stage. I am asking these questions because I want to
determine whether Squid increases Preview size beyond what your server
has requested or does not send Preview at all.

Please share the ICAP headers of the problematic REQMOD request and the
last chunk metadata of that request body. You can get the latter from a
packet capture if your ICAP server does not report it in a convenient
form. In fact, sharing (a pointer to) the packet capture of the whole
problematic ICAP request is probably a good idea!

Alex.



&gt;<i> On 5 Mar 2021, at 17:21, Alex Rousskov wrote:
</I>&gt;<i> 
</I>&gt;<i> &#65279;On 3/5/21 2:55 AM, Niels Hofmans wrote:
</I>&gt;<i> 
</I>&gt;&gt;<i> One more: I believe ICAP is not respecting the Preview header for REQMOD
</I>&gt;&gt;<i> nor RESPMOD.
</I>&gt;<i> 
</I>&gt;&gt;<i> For the REQMOD OPTIONS requests, I respond with:
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> ICAP/1.0 200 OK
</I>&gt;&gt;<i> Allow: 200,204
</I>&gt;&gt;<i> Connection: close
</I>&gt;&gt;<i> Date: Fri, 05 Mar 2021 07:34:56 GMT
</I>&gt;&gt;<i> Encapsulated: null-body=0
</I>&gt;&gt;<i> Methods: REQMOD
</I>&gt;&gt;<i> Preview: 64000
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> However in my ICAP service, I often receive a request body over 64000
</I>&gt;&gt;<i> bytes, e.g. 1000000 request bytes.
</I>&gt;<i> 
</I>&gt;<i> Receive when? During preview, instead of Preview, and/or after Preview?
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> I also noticed that a &quot;Preview: 0&#8221; will not have any effect and the ICAP
</I>&gt;&gt;<i> service will still receive a complete HTTP REQMOD+REQRESP body.
</I>&gt;<i> 
</I>&gt;<i> Receive when? During preview, instead of Preview, and/or after Preview?
</I>&gt;<i> 
</I>&gt;<i> Alex.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> icap_enable on
</I>&gt;&gt;<i> icap_connect_timeout 1 second
</I>&gt;&gt;<i> icap_service_failure_limit -1
</I>&gt;&gt;<i> icap_send_client_ip    on
</I>&gt;&gt;<i> icap_preview_size 0
</I>&gt;&gt;<i> icap_persistent_connections on
</I>&gt;&gt;<i> icap_service service_req reqmod_precache bypass=0 <A HREF="icap://172.17.0.2:1344/request">icap://172.17.0.2:1344/request</A> &lt;<A HREF="icap://172.17.0.2:1344/request">icap://172.17.0.2:1344/request</A>&gt;
</I>&gt;&gt;<i> icap_service service_res respmod_precache bypass=0 <A HREF="icap://172.17.0.2:1344/response">icap://172.17.0.2:1344/response</A> &lt;<A HREF="icap://172.17.0.2:1344/response">icap://172.17.0.2:1344/response</A>&gt;
</I>&gt;&gt;<i> icap_preview_enable on
</I>&gt;&gt;<i> adaptation_access service_req allow all
</I>&gt;&gt;<i> adaptation_access service_res allow all
</I>&gt;<i> 
</I>

-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20210306/3c461bb1/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20210306/3c461bb1/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="023416.html">[squid-users] Icap preview size
</A></li>
	<LI>Next message (by thread): <A HREF="023419.html">[squid-users] Icap preview size
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23417">[ date ]</a>
              <a href="thread.html#23417">[ thread ]</a>
              <a href="subject.html#23417">[ subject ]</a>
              <a href="author.html#23417">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
