<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] squid ssl-bump with icap returns 503
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid%20ssl-bump%20with%20icap%20returns%20503&In-Reply-To=%3CCA6F9292-ED74-47A2-A2D2-7F0E9BEE37E9%40ironpeak.be%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="023407.html">
   <LINK REL="Next"  HREF="023408.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] squid ssl-bump with icap returns 503</H1>
    <B>Niels Hofmans</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid%20ssl-bump%20with%20icap%20returns%20503&In-Reply-To=%3CCA6F9292-ED74-47A2-A2D2-7F0E9BEE37E9%40ironpeak.be%3E"
       TITLE="[squid-users] squid ssl-bump with icap returns 503">hello at ironpeak.be
       </A><BR>
    <I>Sat Mar  6 10:10:13 UTC 2021</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="023407.html">[squid-users] squid ssl-bump with icap returns 503
</A></li>
        <LI>Next message (by thread): <A HREF="023408.html">[squid-users] Squid full request logging
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23418">[ date ]</a>
              <a href="thread.html#23418">[ thread ]</a>
              <a href="subject.html#23418">[ subject ]</a>
              <a href="author.html#23418">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Amos,

Just to get back to this, the conclusion is that https_port does not support ssl-bump of requests passing through CONNECT.
I&#8217;ll terminate the TLS connection in front of squid through a load balancer and use http_port, which works fine.
Thank you!

Niels Hofmans

SITE   <A HREF="https://ironpeak.be">https://ironpeak.be</A>
BTW   BE0694785660
BANK BE76068909740795

On 4 Mar 2021, at 14:21, Amos Jeffries &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt; wrote:

On 5/03/21 1:39 am, Niels Hofmans wrote:
&gt;<i> Hi Amos,
</I>&gt;<i> Thank you for getting back to me.
</I>&gt;<i> So if ssl-bump is required on the http(s)_port directive, I end up at:
</I>
https_port simply means TLS is the transport protocol. The transport is terminated at the proxy. There are many permutations of what is being done inside that TLS.

So no http_port does not require &quot;ssl-bump&quot;.

Squid does not support TLS-inside-TLS encryption layering. Which is why &quot;ssl-bump&quot; only works for &quot;intercept&quot; or &quot;tproxy&quot; modes on that port directive.




&gt;<i> http_port 0.0.0.0:3128
</I>&gt;<i> https_port 0.0.0.0:3129 ssl-bump intercept \
</I>&gt;<i>     generate-host-certificates=ondynamic_cert_mem_cache_size=10MB \
</I>&gt;<i>     cert=/etc/squid/ssl/squid.crtkey=/etc/squid/ssl/squid.key \
</I>&gt;<i>     tls-cert=/etc/squid/ssl/squid.crttls-key=/etc/squid/ssl/squid.key
</I>&gt;<i> always_direct allow all
</I>&gt;<i> ssl_bump bump all
</I>&gt;<i> This however ends up with following logs:
</I>&gt;<i> 2021/03/04 12:37:43 kid1| ERROR: NF getsockopt(ORIGINAL_DST) failed on local=172.17.0.2:3129 remote=172.17.0.1:55508 FD 13 flags=33: (2) No such file or directory
</I>
Which means your NAT systems have no records of port 443 being diverted to port 3129.


&gt;<i> Command to reproduce:
</I>&gt;<i>  % ALL_PROXY=&quot;<A HREF="http://127.0.0.1:3129">http://127.0.0.1:3129</A> &lt;<A HREF="http://127.0.0.1:3129/">http://127.0.0.1:3129/</A>&gt; &lt;<A HREF="http://127.0.0.1:3129">http://127.0.0.1:3129</A> &lt;<A HREF="http://127.0.0.1:3129/">http://127.0.0.1:3129/</A>&gt;&gt;&quot; curl -k -vvv --proxy-insecure -X POST --data 'foo' <A HREF="https://ironpeak.be/">https://ironpeak.be/</A> &lt;<A HREF="https://ironpeak.be/">https://ironpeak.be/</A>&gt; &lt;<A HREF="https://ironpeak.be/">https://ironpeak.be/</A> &lt;<A HREF="https://ironpeak.be/">https://ironpeak.be/</A>&gt;&gt;
</I>
Correct test command for &quot;https_port 3129 intercept ssl-bump&quot; is:

 curl --cacert /etc/squid/ssl/squid.crt -vvv \
      -X POST --data 'foo' <A HREF="https://ironpeak.be/">https://ironpeak.be/</A> &lt;<A HREF="https://ironpeak.be/">https://ironpeak.be/</A>&gt;

This verifies that the system is diverting traffic to the proxy, the proxy is the TLS agent for those connections, and that connectivity through the proxy is working.
TLS failure to verify the cert(s) indicate the proxy is not being reached.

Amos
_______________________________________________
squid-users mailing list
<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A> &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>&gt;
<A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A> &lt;<A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>&gt;
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20210306/55606f21/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20210306/55606f21/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="023407.html">[squid-users] squid ssl-bump with icap returns 503
</A></li>
	<LI>Next message (by thread): <A HREF="023408.html">[squid-users] Squid full request logging
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23418">[ date ]</a>
              <a href="thread.html#23418">[ thread ]</a>
              <a href="subject.html#23418">[ subject ]</a>
              <a href="author.html#23418">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
