<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Icap preview size
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Icap%20preview%20size&In-Reply-To=%3CE820AE00-C78F-4F9D-98C5-1AB7C3C5813A%40ironpeak.be%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="023419.html">
   <LINK REL="Next"  HREF="023421.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Icap preview size</H1>
    <B>Niels Hofmans</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Icap%20preview%20size&In-Reply-To=%3CE820AE00-C78F-4F9D-98C5-1AB7C3C5813A%40ironpeak.be%3E"
       TITLE="[squid-users] Icap preview size">hello at ironpeak.be
       </A><BR>
    <I>Sat Mar  6 20:35:21 UTC 2021</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="023419.html">[squid-users] Icap preview size
</A></li>
        <LI>Next message (by thread): <A HREF="023421.html">[squid-users] Icap preview size
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23420">[ date ]</a>
              <a href="thread.html#23420">[ thread ]</a>
              <a href="subject.html#23420">[ subject ]</a>
              <a href="author.html#23420">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>

On 6 Mar 2021, at 21:33, Niels Hofmans &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">hello at ironpeak.be</A>&gt; wrote:

Hi Alex,

I fixed a bug in the go-icap/icap library, seen here:
But this made me wonder about the following: <A HREF="https://i.imgur.com/bA3w8YT.png">https://i.imgur.com/bA3w8YT.png</A> &lt;<A HREF="https://i.imgur.com/bA3w8YT.png">https://i.imgur.com/bA3w8YT.png</A>&gt;

Here you can see squid issuing a RESPMOD to my ICAP server with a Preview of &#8220;0&#8221;, but it does contain a HTTP response.
And since my ICAP service will not return a HTTP response since the Preview size is 0, my http client receives nothing from squid.
I checked but I don&#8217;t think I see a 100 continuation from ICAP in the dump anymore.

Tcpdump: <A HREF="https://www.mediafire.com/file/sr7hvk9ezepoc8d/icap.pcap3/file">https://www.mediafire.com/file/sr7hvk9ezepoc8d/icap.pcap3/file</A> &lt;<A HREF="https://www.mediafire.com/file/sr7hvk9ezepoc8d/icap.pcap3/file">https://www.mediafire.com/file/sr7hvk9ezepoc8d/icap.pcap3/file</A>&gt;
(I&#8217;ve revoked my session cookies for this dump)

One step at a time closer to the truth! :-)

Regards,
Niels Hofmans

SITE   <A HREF="https://ironpeak.be">https://ironpeak.be</A> &lt;<A HREF="https://ironpeak.be/">https://ironpeak.be/</A>&gt;
BTW   BE0694785660
BANK BE76068909740795

On 6 Mar 2021, at 19:29, Alex Rousskov &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A> &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt;&gt; wrote:

On 3/6/21 5:09 AM, Niels Hofmans wrote:

&gt;<i> I&#8217;ve uploaded a tcpdump sample of where I&#8217;m requesting an image through
</I>&gt;<i> squid + icap and where you can see the image response being posted fully
</I>&gt;<i> to the ICAP service.
</I>
AFAICT, all ICAP REQMOD and RESPMOD requests in your packet capture send
zero-size Preview containing just the HTTP headers (e.g., see frame
#44). In one case, Squid also sends the HTTP response body but only
because your ICAP service explicitly requests that HTTP response body by
responding to Squid Preview with ICAP 100 Continue control message
(e.g., see frame #48)!

If your ICAP service does not want to see an HTTP body, then it should
not ask for it. It should respond (usually with ICAP 200 or ICAP 204)
based on the Preview alone, without sending ICAP 100 Continue control
message first.


HTH,

Alex.


&gt;<i> On 5 Mar 2021, at 23:32, Alex Rousskov wrote:
</I>&gt;<i> 
</I>&gt;<i> On 3/5/21 5:21 PM, Niels Hofmans wrote:
</I>&gt;<i> 
</I>&gt;&gt;<i> I receive that large payload right after an OPTIONS call to my ICAP
</I>&gt;&gt;<i> endpoint. It is the preview.
</I>&gt;<i> 
</I>&gt;<i> The timing of an ICAP request does not determine whether that request
</I>&gt;<i> has a Preview stage and whether the &quot;unexpected&quot; body bytes were sent
</I>&gt;<i> during that Preview stage. I am asking these questions because I want to
</I>&gt;<i> determine whether Squid increases Preview size beyond what your server
</I>&gt;<i> has requested or does not send Preview at all.
</I>&gt;<i> 
</I>&gt;<i> Please share the ICAP headers of the problematic REQMOD request and the
</I>&gt;<i> last chunk metadata of that request body. You can get the latter from a
</I>&gt;<i> packet capture if your ICAP server does not report it in a convenient
</I>&gt;<i> form. In fact, sharing (a pointer to) the packet capture of the whole
</I>&gt;<i> problematic ICAP request is probably a good idea!
</I>&gt;<i> 
</I>&gt;<i> Alex.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> On 5 Mar 2021, at 17:21, Alex Rousskov wrote:
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> &#65279;On 3/5/21 2:55 AM, Niels Hofmans wrote:
</I>&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> One more: I believe ICAP is not respecting the Preview header for REQMOD
</I>&gt;&gt;&gt;<i> nor RESPMOD.
</I>&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> For the REQMOD OPTIONS requests, I respond with:
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> ICAP/1.0 200 OK
</I>&gt;&gt;&gt;<i> Allow: 200,204
</I>&gt;&gt;&gt;<i> Connection: close
</I>&gt;&gt;&gt;<i> Date: Fri, 05 Mar 2021 07:34:56 GMT
</I>&gt;&gt;&gt;<i> Encapsulated: null-body=0
</I>&gt;&gt;&gt;<i> Methods: REQMOD
</I>&gt;&gt;&gt;<i> Preview: 64000
</I>&gt;&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> However in my ICAP service, I often receive a request body over 64000
</I>&gt;&gt;&gt;<i> bytes, e.g. 1000000 request bytes.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> Receive when? During preview, instead of Preview, and/or after Preview?
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> I also noticed that a &quot;Preview: 0&#8221; will not have any effect and the ICAP
</I>&gt;&gt;&gt;<i> service will still receive a complete HTTP REQMOD+REQRESP body.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> Receive when? During preview, instead of Preview, and/or after Preview?
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> Alex.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> 
</I>&gt;&gt;&gt;<i> icap_enable on
</I>&gt;&gt;&gt;<i> icap_connect_timeout 1 second
</I>&gt;&gt;&gt;<i> icap_service_failure_limit -1
</I>&gt;&gt;&gt;<i> icap_send_client_ip    on
</I>&gt;&gt;&gt;<i> icap_preview_size 0
</I>&gt;&gt;&gt;<i> icap_persistent_connections on
</I>&gt;&gt;&gt;<i> icap_service service_req reqmod_precache bypass=0
</I>&gt;&gt;&gt;<i> <A HREF="icap://172.17.0.2:1344/request">icap://172.17.0.2:1344/request</A> &lt;<A HREF="icap://172.17.0.2:1344/request">icap://172.17.0.2:1344/request</A>&gt; &lt;<A HREF="icap://172.17.0.2:1344/request">icap://172.17.0.2:1344/request</A> &lt;<A HREF="icap://172.17.0.2:1344/request">icap://172.17.0.2:1344/request</A>&gt;&gt;
</I>&gt;&gt;&gt;<i> &lt;<A HREF="icap://172.17.0.2:1344/request">icap://172.17.0.2:1344/request</A> &lt;<A HREF="icap://172.17.0.2:1344/request">icap://172.17.0.2:1344/request</A>&gt; &lt;<A HREF="icap://172.17.0.2:1344/request">icap://172.17.0.2:1344/request</A> &lt;<A HREF="icap://172.17.0.2:1344/request">icap://172.17.0.2:1344/request</A>&gt;&gt;&gt;
</I>&gt;&gt;&gt;<i> icap_service service_res respmod_precache bypass=0
</I>&gt;&gt;&gt;<i> <A HREF="icap://172.17.0.2:1344/response">icap://172.17.0.2:1344/response</A> &lt;<A HREF="icap://172.17.0.2:1344/response">icap://172.17.0.2:1344/response</A>&gt; &lt;<A HREF="icap://172.17.0.2:1344/response">icap://172.17.0.2:1344/response</A> &lt;<A HREF="icap://172.17.0.2:1344/response">icap://172.17.0.2:1344/response</A>&gt;&gt;
</I>&gt;&gt;&gt;<i> &lt;<A HREF="icap://172.17.0.2:1344/response">icap://172.17.0.2:1344/response</A> &lt;<A HREF="icap://172.17.0.2:1344/response">icap://172.17.0.2:1344/response</A>&gt; &lt;<A HREF="icap://172.17.0.2:1344/response">icap://172.17.0.2:1344/response</A> &lt;<A HREF="icap://172.17.0.2:1344/response">icap://172.17.0.2:1344/response</A>&gt;&gt;&gt;
</I>&gt;&gt;&gt;<i> icap_preview_enable on
</I>&gt;&gt;&gt;<i> adaptation_access service_req allow all
</I>&gt;&gt;&gt;<i> adaptation_access service_res allow all
</I>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20210306/474387b3/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20210306/474387b3/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="023419.html">[squid-users] Icap preview size
</A></li>
	<LI>Next message (by thread): <A HREF="023421.html">[squid-users] Icap preview size
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23420">[ date ]</a>
              <a href="thread.html#23420">[ thread ]</a>
              <a href="subject.html#23420">[ subject ]</a>
              <a href="author.html#23420">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
