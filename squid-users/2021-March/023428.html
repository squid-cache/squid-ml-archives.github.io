<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] How to completely blacklist a domain + subdomains, including HTTPS?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20How%20to%20completely%20blacklist%20a%20domain%20%2B%20subdomains%2C%0A%20including%20HTTPS%3F&In-Reply-To=%3C609e9e89-0ea4-8d59-c735-1b26a1739ae7%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="023427.html">
   <LINK REL="Next"  HREF="023432.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] How to completely blacklist a domain + subdomains, including HTTPS?</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20How%20to%20completely%20blacklist%20a%20domain%20%2B%20subdomains%2C%0A%20including%20HTTPS%3F&In-Reply-To=%3C609e9e89-0ea4-8d59-c735-1b26a1739ae7%40treenet.co.nz%3E"
       TITLE="[squid-users] How to completely blacklist a domain + subdomains, including HTTPS?">squid3 at treenet.co.nz
       </A><BR>
    <I>Tue Mar  9 12:43:25 UTC 2021</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="023427.html">[squid-users]  How to completely blacklist a domain + subdomains, including HTTPS?
</A></li>
        <LI>Next message (by thread): <A HREF="023432.html">[squid-users] How to completely blacklist a domain + subdomains, including HTTPS?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23428">[ date ]</a>
              <a href="thread.html#23428">[ thread ]</a>
              <a href="subject.html#23428">[ subject ]</a>
              <a href="author.html#23428">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 10/03/21 12:57 am, roee klinger wrote:
&gt;<i> Hey,
</I>&gt;<i> 
</I>&gt;<i> I have found a lot of outdated or conflicting&#160;information about this 
</I>&gt;<i> online, and since this is a really important matter, I wanted to make 
</I>&gt;<i> sure I am doing this correctly.
</I>&gt;<i> 
</I>&gt;<i> I am attempting to block some websites completely, including&#160;all HTTPS 
</I>&gt;<i> traffic and subdomains.
</I>&gt;<i> 
</I>
Basically there are two protocols that need to be considered for this. 
HTTP and TLS.

In HTTP the &quot;website&quot; is identified by a domain name in the 
request-target (aka URI, sometimes called URL).
  * The 'dstdomain' ACL type matches URI domain name.
  * The http_access directive is where that domain name becomes 
available for Squid to check.


In TLS the &quot;website&quot; is identified by the TLS SNI sent by the client, or 
a field in the server X.509 certificate.
  * The 'ssl::server_name' ACL type matches those details.
  * The ssl_bump directive


Next thing is to be aware that there are many ways to layer protocols. 
Do expect to see vastly different proxy behaviours for each permutation 
of those.
  * port 443 &quot;HTTPS&quot; is TLS then HTTP
  * port 80 &quot;HTTPS&quot; is HTTP then TLS (quite rare)
  * forward-proxy &quot;HTTPS&quot; is HTTP then TLS then HTTP



&gt;<i> Squid.conf:
</I>&gt;<i> 
</I>&gt;<i>     acl domain_blacklist dstdomain &quot;/etc/squid/domain_blacklist.txt&quot;
</I>&gt;<i>     http_access deny all domain_blacklist
</I>
The &quot;all&quot; here is pointless.


&gt;<i>     http_reply_access deny domain_blacklist
</I>
Use of reply access directive for blacklisting by request details is not 
useful.

The request already got blocked. So any response reaching here is just 
the error page saying forbidden. Blocking that error page would just 
change it to a slightly different error page saying the *response* was 
forbidden - which is a bit confusing for any user trying to understand 
why their request didn't work.


&gt;<i>     http_access deny CONNECT domain_blacklist
</I>&gt;<i> 
</I>
This line is useless here.

squid.conf lines are interpreted top-down. The &quot;deny all 
domain_blacklist&quot; already stopped all requests that could possibly match 
the second condition of this line.


&gt;<i> 
</I>&gt;<i> /etc/squid/domain_blacklist.txt:
</I>&gt;<i> 
</I>&gt;<i>     .ph
</I>&gt;<i>     .somepornwebsite.com
</I>&gt;<i>     .facebook.com
</I>&gt;<i> 
</I>...
&gt;<i> 
</I>&gt;<i> Am I doing this the&#160;right way?
</I>

Sort of. Your http_access denial will catch all the HTTP and decrypted 
HTTP(S) traffic. It will not be able to block any HTTP(S) requests that 
are not able to decrypt.

To catch and block these domains without needing the decrypt you should 
also use:

  acl server_blacklist ssl::server_name &quot;/etc/squid/domain_blacklist.txt&quot;
  ssl_bump terminate server_blacklist

Of course there is always the failure case where traffic cannot decrypt 
and the TLS details use different server names.


Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="023427.html">[squid-users]  How to completely blacklist a domain + subdomains, including HTTPS?
</A></li>
	<LI>Next message (by thread): <A HREF="023432.html">[squid-users] How to completely blacklist a domain + subdomains, including HTTPS?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23428">[ date ]</a>
              <a href="thread.html#23428">[ thread ]</a>
              <a href="subject.html#23428">[ subject ]</a>
              <a href="author.html#23428">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
