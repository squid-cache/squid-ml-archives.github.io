<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] How to completely blacklist a domain + subdomains, including HTTPS?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20How%20to%20completely%20blacklist%20a%20domain%20%2B%20subdomains%2C%0A%20including%20HTTPS%3F&In-Reply-To=%3CCAGCa14o4t4yAurM-gv0Mcwq3dYJ7oZX9VYiOw06tTgJ7n12E-A%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="023428.html">
   <LINK REL="Next"  HREF="023441.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] How to completely blacklist a domain + subdomains, including HTTPS?</H1>
    <B>roee klinger</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20How%20to%20completely%20blacklist%20a%20domain%20%2B%20subdomains%2C%0A%20including%20HTTPS%3F&In-Reply-To=%3CCAGCa14o4t4yAurM-gv0Mcwq3dYJ7oZX9VYiOw06tTgJ7n12E-A%40mail.gmail.com%3E"
       TITLE="[squid-users] How to completely blacklist a domain + subdomains, including HTTPS?">roeeklinger60 at gmail.com
       </A><BR>
    <I>Wed Mar 10 12:28:57 UTC 2021</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="023428.html">[squid-users] How to completely blacklist a domain + subdomains, including HTTPS?
</A></li>
        <LI>Next message (by thread): <A HREF="023441.html">[squid-users] How to completely blacklist a domain + subdomains, including HTTPS?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23432">[ date ]</a>
              <a href="thread.html#23432">[ thread ]</a>
              <a href="subject.html#23432">[ subject ]</a>
              <a href="author.html#23432">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Thanks, Amos.

I tried implementing the configuration you suggested but I am getting an
error message:

FATAL: Invalid ACL type 'ssl::server_name'
FATAL: Bungled /etc/squid/squid.conf line 36: acl server_blacklist
ssl::server_name &quot;/etc/squid/domain_blacklist.txt&quot;


I tried reading the documentation but can't find anything wrong in my
config file, I used the 2 lines exactly like they are in your suggestion,
and I am running Squid 4.10.

On Tue, Mar 9, 2021 at 2:48 PM Amos Jeffries &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt; wrote:

&gt;<i> On 10/03/21 12:57 am, roee klinger wrote:
</I>&gt;<i> &gt; Hey,
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I have found a lot of outdated or conflicting information about this
</I>&gt;<i> &gt; online, and since this is a really important matter, I wanted to make
</I>&gt;<i> &gt; sure I am doing this correctly.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I am attempting to block some websites completely, including all HTTPS
</I>&gt;<i> &gt; traffic and subdomains.
</I>&gt;<i> &gt;
</I>&gt;<i>
</I>&gt;<i> Basically there are two protocols that need to be considered for this.
</I>&gt;<i> HTTP and TLS.
</I>&gt;<i>
</I>&gt;<i> In HTTP the &quot;website&quot; is identified by a domain name in the
</I>&gt;<i> request-target (aka URI, sometimes called URL).
</I>&gt;<i>   * The 'dstdomain' ACL type matches URI domain name.
</I>&gt;<i>   * The http_access directive is where that domain name becomes
</I>&gt;<i> available for Squid to check.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> In TLS the &quot;website&quot; is identified by the TLS SNI sent by the client, or
</I>&gt;<i> a field in the server X.509 certificate.
</I>&gt;<i>   * The 'ssl::server_name' ACL type matches those details.
</I>&gt;<i>   * The ssl_bump directive
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Next thing is to be aware that there are many ways to layer protocols.
</I>&gt;<i> Do expect to see vastly different proxy behaviours for each permutation
</I>&gt;<i> of those.
</I>&gt;<i>   * port 443 &quot;HTTPS&quot; is TLS then HTTP
</I>&gt;<i>   * port 80 &quot;HTTPS&quot; is HTTP then TLS (quite rare)
</I>&gt;<i>   * forward-proxy &quot;HTTPS&quot; is HTTP then TLS then HTTP
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; Squid.conf:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     acl domain_blacklist dstdomain &quot;/etc/squid/domain_blacklist.txt&quot;
</I>&gt;<i> &gt;     http_access deny all domain_blacklist
</I>&gt;<i>
</I>&gt;<i> The &quot;all&quot; here is pointless.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt;     http_reply_access deny domain_blacklist
</I>&gt;<i>
</I>&gt;<i> Use of reply access directive for blacklisting by request details is not
</I>&gt;<i> useful.
</I>&gt;<i>
</I>&gt;<i> The request already got blocked. So any response reaching here is just
</I>&gt;<i> the error page saying forbidden. Blocking that error page would just
</I>&gt;<i> change it to a slightly different error page saying the *response* was
</I>&gt;<i> forbidden - which is a bit confusing for any user trying to understand
</I>&gt;<i> why their request didn't work.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt;     http_access deny CONNECT domain_blacklist
</I>&gt;<i> &gt;
</I>&gt;<i>
</I>&gt;<i> This line is useless here.
</I>&gt;<i>
</I>&gt;<i> squid.conf lines are interpreted top-down. The &quot;deny all
</I>&gt;<i> domain_blacklist&quot; already stopped all requests that could possibly match
</I>&gt;<i> the second condition of this line.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; /etc/squid/domain_blacklist.txt:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     .ph
</I>&gt;<i> &gt;     .somepornwebsite.com
</I>&gt;<i> &gt;     .facebook.com
</I>&gt;<i> &gt;
</I>&gt;<i> ...
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Am I doing this the right way?
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Sort of. Your http_access denial will catch all the HTTP and decrypted
</I>&gt;<i> HTTP(S) traffic. It will not be able to block any HTTP(S) requests that
</I>&gt;<i> are not able to decrypt.
</I>&gt;<i>
</I>&gt;<i> To catch and block these domains without needing the decrypt you should
</I>&gt;<i> also use:
</I>&gt;<i>
</I>&gt;<i>   acl server_blacklist ssl::server_name &quot;/etc/squid/domain_blacklist.txt&quot;
</I>&gt;<i>   ssl_bump terminate server_blacklist
</I>&gt;<i>
</I>&gt;<i> Of course there is always the failure case where traffic cannot decrypt
</I>&gt;<i> and the TLS details use different server names.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Amos
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20210310/3828e7f1/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20210310/3828e7f1/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="023428.html">[squid-users] How to completely blacklist a domain + subdomains, including HTTPS?
</A></li>
	<LI>Next message (by thread): <A HREF="023441.html">[squid-users] How to completely blacklist a domain + subdomains, including HTTPS?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23432">[ date ]</a>
              <a href="thread.html#23432">[ thread ]</a>
              <a href="subject.html#23432">[ subject ]</a>
              <a href="author.html#23432">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
