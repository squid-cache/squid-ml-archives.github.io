<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Protecting squid
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Protecting%20squid&In-Reply-To=%3Cda3b5157-587b-f284-dfd5-9e2b5c8b4b1a%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="023446.html">
   <LINK REL="Next"  HREF="023456.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Protecting squid</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Protecting%20squid&In-Reply-To=%3Cda3b5157-587b-f284-dfd5-9e2b5c8b4b1a%40treenet.co.nz%3E"
       TITLE="[squid-users] Protecting squid">squid3 at treenet.co.nz
       </A><BR>
    <I>Fri Mar 12 05:13:11 UTC 2021</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="023446.html">[squid-users] Protecting squid
</A></li>
        <LI>Next message (by thread): <A HREF="023456.html">[squid-users] Protecting squid
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23449">[ date ]</a>
              <a href="thread.html#23449">[ thread ]</a>
              <a href="subject.html#23449">[ subject ]</a>
              <a href="author.html#23449">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 12/03/21 3:56 am, Ben Goz wrote:
&gt;<i> 
</I>&gt;<i> On 11/03/2021 16:44, Amos Jeffries wrote:
</I>&gt;&gt;<i> On 12/03/21 3:37 am, Ben Goz wrote:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> On 11/03/2021 15:50, Antony Stone wrote:
</I>&gt;&gt;&gt;&gt;<i> On Thursday 11 March 2021 at 14:41:11, Ben Goz wrote:
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> Tell about your network setup and what you are trying to achieve - 
</I>&gt;&gt;&gt;&gt;<i> we might be
</I>&gt;&gt;&gt;&gt;<i> able to suggest solutions.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> End users machine using some client application while their system 
</I>&gt;&gt;&gt;<i> proxy points to the above squid proxy server.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Please also provide your squid.conf settings so we can check they 
</I>&gt;&gt;<i> achieve your described need(s) properly. At least any lines starting 
</I>&gt;&gt;<i> with the http_access, auth_param, acl, or external_acl_type directives 
</I>&gt;&gt;<i> would be most useful.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Do not forget to anonymize sensitive details before posting. PLEASE do 
</I>&gt;&gt;<i> so in a way that we can tell whether a hidden value was correct for 
</I>&gt;&gt;<i> its usage, and whether any two hidden values are the same or different.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> It's fork of default configuration with some changes.
</I>&gt;<i> 
</I>&gt;<i> # Recommended minimum Access Permission configuration:
</I>&gt;<i> #
</I>&gt;<i> # Deny requests to certain unsafe ports
</I>&gt;<i> #http_access deny !Safe_ports
</I>&gt;<i> 
</I>

Please restore this security protection. It prevents malware abusing 
HTTP's similarity to certain other protocols to perform attacks 
*through* your proxy.

The default Safe_ports list allows all ports not known to be dangerous, 
and all ports above 1024. So it should not have any noticeable effect on 
to any legitimate HTTP proxy clients - unless there is something really 
dodgy happening on your network. If you actually want something like 
that happening, then add the appropriate port for that activity to the 
Safe_ports list. Do not drop the protection completely.


&gt;<i> # Deny CONNECT to other than secure SSL ports
</I>&gt;<i> #http_access deny CONNECT !SSL_ports
</I>&gt;<i> 
</I>
The same can be said about this. Except this line is arguably even more 
important. CONNECT tunnels can literally contain anything. Let clients 
do things by adding ports to SSL_Ports list as-needed.

Please do some due-diligence checks before that to verify you are okay 
with all the uses of that port. Even ones you think the client 
themselves is unlikely to be doing. Once you open a port here *anyone* 
with access to the proxy can do whatever they like on that port.



&gt;<i> # Only allow cachemgr access from localhost
</I>&gt;<i> http_access allow localhost manager
</I>&gt;<i> http_access deny manager
</I>&gt;<i> 
</I>&gt;<i> http_access allow localnet
</I>&gt;<i> http_access allow localhost
</I>&gt;<i> 
</I>&gt;<i> auth_param basic program /usr/local/squid/libexec/basic_ncsa_auth 
</I>&gt;<i> /usr/local/squid/etc/passwd
</I>&gt;<i> auth_param basic realm proxy
</I>
I notice you are missing a line setting the login TTL value.

There is currently a potential problem in the default which means Squid 
encounters situations where the credentials are seen as still going to 
be valid for hours so do not get refreshed. But garbage collection 
decides to throw them away.

This may not be related to the complaints you reported getting. But 
should be fixed to ensure the side effect of having to re-authenticate 
users does not complicate your actual problem.

&quot;auth_param basic credentialsttl ...&quot; sets how often Squid will re-check 
your auth system to confirm the users is still allowed. Default: 2 hr.

&quot;authenticate_ttl ...&quot; sets how often Squid will try to throw away all 
info about old clients being logged in. Default: 1 hr.


&gt;<i> acl authenticated proxy_auth REQUIRED
</I>&gt;<i> http_access allow authenticated
</I>&gt;<i> 
</I>
I recommend a slightly different form of check for logins. It prevents 
the situation where a user trying the wrong credentials gets a loop of 
popups.

Like so:
  http_access deny !authenticated

That guarantees they are not asked to login again if their software 
agent (aka browser, or such) provided or can locate the proper credentials.

After that you can add other rules about what the logged in users can 
do. eg allow them to do whatever they want. Like so:
  http_access allow all


Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="023446.html">[squid-users] Protecting squid
</A></li>
	<LI>Next message (by thread): <A HREF="023456.html">[squid-users] Protecting squid
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23449">[ date ]</a>
              <a href="thread.html#23449">[ thread ]</a>
              <a href="subject.html#23449">[ subject ]</a>
              <a href="author.html#23449">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
