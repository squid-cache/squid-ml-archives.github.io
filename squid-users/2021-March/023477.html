<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] HTTPS caching is not working in squid with ssl-bump enabled
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20HTTPS%20caching%20is%20not%20working%20in%20squid%20with%0A%20ssl-bump%20enabled&In-Reply-To=%3C52eca759-0c91-c77a-3bf3-2ac6aa7347d2%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="023476.html">
   <LINK REL="Next"  HREF="023478.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] HTTPS caching is not working in squid with ssl-bump enabled</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20HTTPS%20caching%20is%20not%20working%20in%20squid%20with%0A%20ssl-bump%20enabled&In-Reply-To=%3C52eca759-0c91-c77a-3bf3-2ac6aa7347d2%40measurement-factory.com%3E"
       TITLE="[squid-users] HTTPS caching is not working in squid with ssl-bump enabled">rousskov at measurement-factory.com
       </A><BR>
    <I>Wed Mar 24 14:17:55 UTC 2021</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="023476.html">[squid-users] HTTPS caching is not working in squid with ssl-bump enabled
</A></li>
        <LI>Next message (by thread): <A HREF="023478.html">[squid-users] squid won't return cached even with refresh_pattern extra options override-lastmod override-expire ignore-reload ignore-no-store ignore-private store-stale
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23477">[ date ]</a>
              <a href="thread.html#23477">[ thread ]</a>
              <a href="subject.html#23477">[ subject ]</a>
              <a href="author.html#23477">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 3/24/21 6:11 AM, Vignesh Ramessh wrote:


&gt;<i> Previously we were seeing TCP_TUNNEL for <A HREF="https://www.google.com">https://www.google.com</A>
</I>&gt;<i> Now, we are able to see the TCP_MISS transactions for
</I>&gt;<i> <A HREF="https://www.google.com">https://www.google.com</A> &lt;<A HREF="https://www.google.com">https://www.google.com</A>&gt;.&#160;
</I>&gt;<i> As&#160;<A HREF="https://www.google.com">https://www.google.com</A> &lt;<A HREF="https://www.google.com">https://www.google.com</A>&gt; does not contain a
</I>&gt;<i> cache-control header in response, the response cannot be cached which we
</I>&gt;<i> are aware of.
</I>
Well, the Cache-Control header is not required for responses to be
cachable (and, depending on the value, may even prevent caching) -- a
lot of factors go into that decision.


&gt;<i> 1616580079.857 &#160; &#160; 73 ::1 NONE/200 0 CONNECT www.google.com:443
</I>&gt;<i> &lt;<A HREF="http://www.google.com:443">http://www.google.com:443</A>&gt; - HIER_DIRECT/172.217.163.68
</I>&gt;<i> &lt;<A HREF="http://172.217.163.68">http://172.217.163.68</A>&gt; -
</I>&gt;<i> 1616580079.945 &#160; &#160; 44 ::1 TCP_MISS/200 967 HEAD <A HREF="https://www.google.com/">https://www.google.com/</A>
</I>&gt;<i> &lt;<A HREF="https://www.google.com/">https://www.google.com/</A>&gt; - HIER_DIRECT/172.217.163.68
</I>&gt;<i> &lt;<A HREF="http://172.217.163.68">http://172.217.163.68</A>&gt; text/html
</I>
It looks like your Squid is bumping TLS connections.


&gt;<i> I generated key.pem and cert.pem files using openssl and when i tried to
</I>&gt;<i> connect a local python https web server which has cache-control headers
</I>&gt;<i> in https response, got the below error,
</I>&gt;<i> 
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at raspberrypi-rdk-hybrid</A>:~# curl -I <A HREF="https://192.168.1.41:443">https://192.168.1.41:443</A>
</I>&gt;<i> --proxy-cacert cert.pem --proxy <A HREF="http://localhost:3128">http://localhost:3128</A>
</I>
Your are telling curl to connect to a plain HTTP proxy (no encryption)
so --proxy-cacert does not apply to this transaction. The insides of the
CONNECT tunnel will be encrypted, of course, but those insides are meant
for the origin server, not the proxy.

For curl to trust a Squid-bumped connection, you want to specify
--cacert (or equivalent), and the file you specify must match the CA
certificate that Squid uses to generate fake certificates --
squid-ca-cert-key.pem in your squid.conf.


HTH,

Alex.


&gt;<i> HTTP/1.1 200 Connection established
</I>&gt;<i> 
</I>&gt;<i> curl: (60) SSL certificate problem: unable to get local issuer certificate
</I>&gt;<i> More details here: <A HREF="https://curl.haxx.se/docs/sslcerts.html">https://curl.haxx.se/docs/sslcerts.html</A>
</I>&gt;<i> &lt;<A HREF="https://curl.haxx.se/docs/sslcerts.html">https://curl.haxx.se/docs/sslcerts.html</A>&gt;
</I>&gt;<i> 
</I>&gt;<i> curl failed to verify the legitimacy of the server and therefore could not
</I>&gt;<i> establish a secure connection to it. To learn more about this situation and
</I>&gt;<i> how to fix it, please visit the web page mentioned above.
</I>&gt;<i> 
</I>&gt;<i> Have attached the squid.conf file for your reference. Can you please
</I>&gt;<i> check and let me know if I am missing something ?
</I>

&gt;<i> On Tue, Mar 23, 2021 at 7:44 PM Alex Rousskov wrote:
</I>&gt;<i> 
</I>&gt;<i>     On 3/23/21 2:10 AM, Vignesh Ramessh wrote:
</I>&gt;<i> 
</I>&gt;<i>     &gt; Currently am running squid version 4.14 on RPi3.
</I>&gt;<i>     &gt; Trying to cache https responses with cache-control:max-age headers
</I>&gt;<i>     &gt; available,
</I>&gt;<i>     &gt; using ssl bump - peek n splice feature with examples available in this
</I>&gt;<i>     &gt; link
</I>&gt;<i>     :-&#160;<A HREF="https://elatov.github.io/2019/01/using-squid-to-proxy-ssl-sites/">https://elatov.github.io/2019/01/using-squid-to-proxy-ssl-sites/</A>
</I>&gt;<i>     &lt;<A HREF="https://elatov.github.io/2019/01/using-squid-to-proxy-ssl-sites/">https://elatov.github.io/2019/01/using-squid-to-proxy-ssl-sites/</A>&gt;
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i>     &#160; &#160;ssl_bump peek step1
</I>&gt;<i>     &#160; &#160;ssl_bump bump all
</I>&gt;<i>     &#160; &#160;ssl_bump splice all
</I>&gt;<i> 
</I>&gt;<i>     AFAICT, the above &quot;bump all during step2&quot; configuration (the last line
</I>&gt;<i>     does not do anything and should be removed) should bump all traffic. Is
</I>&gt;<i>     that your configuration?
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i>     &gt; But the https caching doesnt seem to work, https connections are
</I>&gt;<i>     getting
</I>&gt;<i>     &gt; established as TCP_TUNNEL/200 in squid access logs.
</I>&gt;<i> 
</I>&gt;<i>     Do you see non-CONNECT HTTP traffic (e.g. GET, POST, etc.) in access
</I>&gt;<i>     log? If not, then Squid is not bumping traffic OR the client does not
</I>&gt;<i>     like what Squid is doing. Please post your http*_port and ssl_bump
</I>&gt;<i>     configuration with access.log lines corresponding to a single test
</I>&gt;<i>     transaction that you think should be bumped.
</I>&gt;<i> 
</I>&gt;<i>     Also, does the client (e.g. curl, wget, or browser) get an error from
</I>&gt;<i>     Squid? Does the client display any kind of warning or error at all? What
</I>&gt;<i>     certificate does the client show for the test connection?
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i>     &gt; I wasnt able to find any proper documentation on https caching
</I>&gt;<i>     using squid.
</I>&gt;<i> 
</I>&gt;<i>     What you call &quot;HTTPS caching&quot; consists of two virtually independent
</I>&gt;<i>     actions: Bumping HTTPS connections and caching. Documentation exists for
</I>&gt;<i>     each action. Currently, it sounds like the first action (bumping) is not
</I>&gt;<i>     working in your setup. Until that is addressed, you can ignore the
</I>&gt;<i>     caching part.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i>     HTH,
</I>&gt;<i> 
</I>&gt;<i>     Alex.
</I>&gt;<i> 
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="023476.html">[squid-users] HTTPS caching is not working in squid with ssl-bump enabled
</A></li>
	<LI>Next message (by thread): <A HREF="023478.html">[squid-users] squid won't return cached even with refresh_pattern extra options override-lastmod override-expire ignore-reload ignore-no-store ignore-private store-stale
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23477">[ date ]</a>
              <a href="thread.html#23477">[ thread ]</a>
              <a href="subject.html#23477">[ subject ]</a>
              <a href="author.html#23477">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
