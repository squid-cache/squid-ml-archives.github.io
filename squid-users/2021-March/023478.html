<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] squid won't return cached even with refresh_pattern extra options override-lastmod override-expire ignore-reload ignore-no-store ignore-private store-stale
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid%20won%27t%20return%20cached%20even%20with%20refresh_pattern%0A%20extra%20options%20override-lastmod%20override-expire%20ignore-reload%0A%20ignore-no-store%20ignore-private%20store-stale&In-Reply-To=%3CCAJtdwuuoy8ZGvqQzwh%3DZMEeBoo3%2Bh9-KFz3aDsYr7ip%3DvO3PBw%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="023477.html">
   <LINK REL="Next"  HREF="023479.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] squid won't return cached even with refresh_pattern extra options override-lastmod override-expire ignore-reload ignore-no-store ignore-private store-stale</H1>
    <B>Miroslaw Malinowski</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid%20won%27t%20return%20cached%20even%20with%20refresh_pattern%0A%20extra%20options%20override-lastmod%20override-expire%20ignore-reload%0A%20ignore-no-store%20ignore-private%20store-stale&In-Reply-To=%3CCAJtdwuuoy8ZGvqQzwh%3DZMEeBoo3%2Bh9-KFz3aDsYr7ip%3DvO3PBw%40mail.gmail.com%3E"
       TITLE="[squid-users] squid won't return cached even with refresh_pattern extra options override-lastmod override-expire ignore-reload ignore-no-store ignore-private store-stale">mr.miroslaw.malinowski at gmail.com
       </A><BR>
    <I>Wed Mar 24 16:48:26 UTC 2021</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="023477.html">[squid-users] HTTPS caching is not working in squid with ssl-bump enabled
</A></li>
        <LI>Next message (by thread): <A HREF="023479.html">[squid-users] squid won't return cached even with refresh_pattern extra options override-lastmod override-expire ignore-reload ignore-no-store ignore-private store-stale
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23478">[ date ]</a>
              <a href="thread.html#23478">[ thread ]</a>
              <a href="subject.html#23478">[ subject ]</a>
              <a href="author.html#23478">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

Probably, me missing on something silly or it can't be done but I don't
know why but squid won't return the cached version even when I turn all
override options ON in refresh_pattern. It's an API call where we call many
of the same requests and by knowing it we would like to stop those calls to
go out if it's already been sent once.
With debug, I can see the rule is matched and the cache is fresh but still
in access.log is TCP_REFRESH_MODIFIED

squid conf:
refresh_pattern -i &lt;URL&gt; 4320 80% 129600 override-lastmod override-expire
ignore-reload ignore-no-store ignore-private store-stale

curl headers:
curl --insecure --verbose --request GET --url 'URL' &gt;/dev/null
* TCP_NODELAY set
* ALPN, offering h2
* ALPN, offering http/1.1
* successfully set certificate verify locations:
*   CAfile: /etc/ssl/certs/ca-certificates.crt
 CApath: /etc/ssl/certs
} [5 bytes data]
* TLSv1.3 (OUT), TLS handshake, Client hello (1):
} [512 bytes data]
* TLSv1.3 (IN), TLS handshake, Server hello (2):
{ [122 bytes data]
* TLSv1.3 (IN), TLS handshake, Encrypted Extensions (8):
{ [6 bytes data]
* TLSv1.3 (IN), TLS handshake, Certificate (11):
{ [1956 bytes data]
* TLSv1.3 (IN), TLS handshake, CERT verify (15):
{ [78 bytes data]
* TLSv1.3 (IN), TLS handshake, Finished (20):
{ [52 bytes data]
* TLSv1.3 (OUT), TLS change cipher, Change cipher spec (1):
} [1 bytes data]
* TLSv1.3 (OUT), TLS handshake, Finished (20):
} [52 bytes data]
* SSL connection using TLSv1.3 / TLS_AES_256_GCM_SHA384

&gt;<i> GET URL HTTP/1.1
</I>&gt;<i> Host: URL
</I>&gt;<i> User-Agent: curl/7.68.0
</I>&gt;<i> Accept: */*
</I>&gt;<i>
</I>{ [5 bytes data]
* TLSv1.3 (IN), TLS handshake, Newsession Ticket (4):
{ [217 bytes data]
* TLSv1.3 (IN), TLS handshake, Newsession Ticket (4):
{ [217 bytes data]
* old SSL session ID is stale, removing
{ [5 bytes data]
* Mark bundle as not supporting multiuse
&lt; HTTP/1.1 200 OK
&lt; Cache-Control: no-cache
&lt; Content-Type: application/json
&lt; X-Cloud-Trace-Context: d3c27833b8b4312ce31a2dbae7e12fd0
&lt; Date: Wed, 24 Mar 2021 15:04:34 GMT
&lt; Server: Google Frontend
&lt; Content-Length: 7950
&lt; X-Cache: MISS from server
&lt; X-Cache-Lookup: HIT from server
&lt; Via: 1.1 server (squid/4.14)
&lt; Connection: keep-alive

access log:
243 172.16.230.249 TCP_REFRESH_MODIFIED/200 8328 GET URL - ORIGINAL_DST/IP
application/json

cache log:
2021-03-24T15:04:34 squid .710 kid1| 11,3| http.cc(982)
haveParsedReplyHeaders: decided: cache positively and share because refresh
check returned cacheable; HTTP status 200 e:=p2V/0x34868914670*3
2021-03-24T15:04:34 squid .710 kid1| 22,3| refresh.cc(470) refreshCheck:
returning FRESH_MIN_RULE
2021-03-24T15:04:34 squid .710 kid1| 22,3| refresh.cc(455) refreshCheck:
Object isn't stale..
2021-03-24T15:04:34 squid .710 kid1| 22,3| refresh.cc(327) refreshCheck:
Staleness = -1
2021-03-24T15:04:34 squid .710 kid1| 22,3| refresh.cc(199)
refreshStaleness: FRESH: age (60 sec) is less than configured minimum
(259200 sec)
2021-03-24T15:04:34 squid .710 kid1| 22,3| refresh.cc(166)
refreshStaleness: No explicit expiry given, using heuristics to determine
freshness
2021-03-24T15:04:34 squid .710 kid1| 22,3| refresh.cc(307) refreshCheck:
entry-&gt;timestamp: Wed, 24 Mar 2021 15:04:34 GMT
2021-03-24T15:04:34 squid .710 kid1| 22,3| refresh.cc(305) refreshCheck:
check_time: Wed, 24 Mar 2021 15:05:34 GMT
2021-03-24T15:04:34 squid .710 kid1| 22,3| refresh.cc(303) refreshCheck:
age: 60
2021-03-24T15:04:34 squid .710 kid1| 22,3| refresh.cc(301) refreshCheck:
Matched 'URL 259200 80%% 7776000'
2021-03-24T15:04:34 squid .710 kid1| 22,3| refresh.cc(279) refreshCheck:
checking freshness of URI: <A HREF="https://URL">https://URL</A>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20210324/bbc5f438/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20210324/bbc5f438/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="023477.html">[squid-users] HTTPS caching is not working in squid with ssl-bump enabled
</A></li>
	<LI>Next message (by thread): <A HREF="023479.html">[squid-users] squid won't return cached even with refresh_pattern extra options override-lastmod override-expire ignore-reload ignore-no-store ignore-private store-stale
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23478">[ date ]</a>
              <a href="thread.html#23478">[ thread ]</a>
              <a href="subject.html#23478">[ subject ]</a>
              <a href="author.html#23478">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
