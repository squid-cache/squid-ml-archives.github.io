<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] squid won't return cached even with refresh_pattern extra options override-lastmod override-expire ignore-reload ignore-no-store ignore-private store-stale
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid%20won%27t%20return%20cached%20even%20with%0A%20refresh_pattern%20extra%20options%20override-lastmod%20override-expire%0A%20ignore-reload%20ignore-no-store%20ignore-private%20store-stale&In-Reply-To=%3C064208f8-0a62-e49c-2640-857cdc9fa9b8%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="023478.html">
   <LINK REL="Next"  HREF="023480.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] squid won't return cached even with refresh_pattern extra options override-lastmod override-expire ignore-reload ignore-no-store ignore-private store-stale</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid%20won%27t%20return%20cached%20even%20with%0A%20refresh_pattern%20extra%20options%20override-lastmod%20override-expire%0A%20ignore-reload%20ignore-no-store%20ignore-private%20store-stale&In-Reply-To=%3C064208f8-0a62-e49c-2640-857cdc9fa9b8%40measurement-factory.com%3E"
       TITLE="[squid-users] squid won't return cached even with refresh_pattern extra options override-lastmod override-expire ignore-reload ignore-no-store ignore-private store-stale">rousskov at measurement-factory.com
       </A><BR>
    <I>Wed Mar 24 18:15:19 UTC 2021</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="023478.html">[squid-users] squid won't return cached even with refresh_pattern extra options override-lastmod override-expire ignore-reload ignore-no-store ignore-private store-stale
</A></li>
        <LI>Next message (by thread): <A HREF="023480.html">[squid-users] squid won't return cached even with refresh_pattern extra options override-lastmod override-expire ignore-reload ignore-no-store ignore-private store-stale
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23479">[ date ]</a>
              <a href="thread.html#23479">[ thread ]</a>
              <a href="subject.html#23479">[ subject ]</a>
              <a href="author.html#23479">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 3/24/21 12:48 PM, Miroslaw Malinowski wrote:

&gt;<i> Probably, me missing on something silly or it can't be done but I don't
</I>&gt;<i> know why but squid won't return the cached version even when I turn all
</I>&gt;<i> override options ON in refresh_pattern.
</I>
AFAICT, no configuration options that can disable revalidation of
Cache-Control:no-cache responses. refresh_pattern does not have an
(equivalent of) &quot;ignore-no-cache-in-responses&quot; option.

IIRC, older Squids were violating an HTTP MUST by forgetting to
revalidate Cache-Control:no-cache responses, but that was fixed in [1].
Your Squid version has that fix.

[1]
<A HREF="https://github.com/squid-cache/squid/commit/fa83b766a208b27abed8da4c9073cf8784cf10fa">https://github.com/squid-cache/squid/commit/fa83b766a208b27abed8da4c9073cf8784cf10fa</A>


&gt;<i> With debug, I can see the rule is matched and the cache is fresh but
</I>&gt;<i> still in access.log is TCP_REFRESH_MODIFIED
</I>
&gt;<i> 2021-03-24T15:04:34	squid	.710 kid1| 11,3| http.cc(982)
</I>&gt;<i> haveParsedReplyHeaders: decided: cache positively and share because
</I>
FYI: You are looking at cache.log lines logged _after_ Squid has already
decided to refresh the cached version. If you want to analyze why Squid
decided to refresh the cached version, you should look _before_ Squid
logged the request to the server (and before any FwdState.cc lines). I
have not checked the details, but I bet that your Squid revalidates
because of Cache-Control:no-cache in the response. Look for &quot;YES: Must
revalidate stale object&quot;.


HTH,

Alex.

&gt;<i> squid conf:
</I>&gt;<i> refresh_pattern -i &lt;URL&gt; 4320 80% 129600 override-lastmod
</I>&gt;<i> override-expire ignore-reload ignore-no-store ignore-private store-stale
</I>&gt;<i> 
</I>&gt;<i> curl headers:
</I>&gt;<i> curl --insecure --verbose --request GET --url 'URL' &gt;/dev/null
</I>&gt;<i> * TCP_NODELAY set
</I>&gt;<i> * ALPN, offering h2
</I>&gt;<i> * ALPN, offering http/1.1
</I>&gt;<i> * successfully set certificate verify locations:
</I>&gt;<i> * &#160;&#160;CAfile: /etc/ssl/certs/ca-certificates.crt
</I>&gt;<i> &#160;CApath: /etc/ssl/certs
</I>&gt;<i> } [5 bytes data]
</I>&gt;<i> * TLSv1.3 (OUT), TLS handshake, Client hello (1):
</I>&gt;<i> } [512 bytes data]
</I>&gt;<i> * TLSv1.3 (IN), TLS handshake, Server hello (2):
</I>&gt;<i> { [122 bytes data]
</I>&gt;<i> * TLSv1.3 (IN), TLS handshake, Encrypted Extensions (8):
</I>&gt;<i> { [6 bytes data]
</I>&gt;<i> * TLSv1.3 (IN), TLS handshake, Certificate (11):
</I>&gt;<i> { [1956 bytes data]
</I>&gt;<i> * TLSv1.3 (IN), TLS handshake, CERT verify (15):
</I>&gt;<i> { [78 bytes data]
</I>&gt;<i> * TLSv1.3 (IN), TLS handshake, Finished (20):
</I>&gt;<i> { [52 bytes data]
</I>&gt;<i> * TLSv1.3 (OUT), TLS change cipher, Change cipher spec (1):
</I>&gt;<i> } [1 bytes data]
</I>&gt;<i> * TLSv1.3 (OUT), TLS handshake, Finished (20):
</I>&gt;<i> } [52 bytes data]
</I>&gt;<i> * SSL connection using TLSv1.3 / TLS_AES_256_GCM_SHA384
</I>&gt;<i> 
</I>&gt;&gt;<i> GET URL HTTP/1.1
</I>&gt;&gt;<i> Host: URL
</I>&gt;&gt;<i> User-Agent: curl/7.68.0
</I>&gt;&gt;<i> Accept: */*
</I>&gt;&gt;<i>
</I>&gt;<i> { [5 bytes data]
</I>&gt;<i> * TLSv1.3 (IN), TLS handshake, Newsession Ticket (4):
</I>&gt;<i> { [217 bytes data]
</I>&gt;<i> * TLSv1.3 (IN), TLS handshake, Newsession Ticket (4):
</I>&gt;<i> { [217 bytes data]
</I>&gt;<i> * old SSL session ID is stale, removing
</I>&gt;<i> { [5 bytes data]
</I>&gt;<i> * Mark bundle as not supporting multiuse
</I>&gt;<i> &lt; HTTP/1.1 200 OK
</I>&gt;<i> &lt; Cache-Control: no-cache
</I>&gt;<i> &lt; Content-Type: application/json
</I>&gt;<i> &lt; X-Cloud-Trace-Context: d3c27833b8b4312ce31a2dbae7e12fd0
</I>&gt;<i> &lt; Date: Wed, 24 Mar 2021 15:04:34 GMT
</I>&gt;<i> &lt; Server: Google Frontend
</I>&gt;<i> &lt; Content-Length: 7950
</I>&gt;<i> &lt; X-Cache: MISS from server
</I>&gt;<i> &lt; X-Cache-Lookup: HIT from server
</I>&gt;<i> &lt; Via: 1.1 server (squid/4.14)
</I>&gt;<i> &lt; Connection: keep-alive
</I>&gt;<i> 
</I>&gt;<i> access log:
</I>&gt;<i> 243 172.16.230.249 TCP_REFRESH_MODIFIED/200 8328 GET URL -
</I>&gt;<i> ORIGINAL_DST/IP application/json
</I>&gt;<i> 
</I>&gt;<i> cache log:
</I>&gt;<i> 2021-03-24T15:04:34	squid	.710 kid1| 11,3| http.cc(982)
</I>&gt;<i> haveParsedReplyHeaders: decided: cache positively and share because
</I>&gt;<i> refresh check returned cacheable; HTTP status 200 e:=p2V/0x34868914670*3	&#160;
</I>&gt;<i> 2021-03-24T15:04:34	squid	.710 kid1| 22,3| refresh.cc(470) refreshCheck:
</I>&gt;<i> returning FRESH_MIN_RULE	&#160;
</I>&gt;<i> 2021-03-24T15:04:34	squid	.710 kid1| 22,3| refresh.cc(455) refreshCheck:
</I>&gt;<i> Object isn't stale..	&#160;
</I>&gt;<i> 2021-03-24T15:04:34	squid	.710 kid1| 22,3| refresh.cc(327) refreshCheck:
</I>&gt;<i> Staleness = -1	&#160;
</I>&gt;<i> 2021-03-24T15:04:34	squid	.710 kid1| 22,3| refresh.cc(199)
</I>&gt;<i> refreshStaleness: FRESH: age (60 sec) is less than configured minimum
</I>&gt;<i> (259200 sec)	&#160;
</I>&gt;<i> 2021-03-24T15:04:34	squid	.710 kid1| 22,3| refresh.cc(166)
</I>&gt;<i> refreshStaleness: No explicit expiry given, using heuristics to
</I>&gt;<i> determine freshness	&#160;
</I>&gt;<i> 2021-03-24T15:04:34	squid	.710 kid1| 22,3| refresh.cc(307) refreshCheck:
</I>&gt;<i> entry-&gt;timestamp: Wed, 24 Mar 2021 15:04:34 GMT	&#160;
</I>&gt;<i> 2021-03-24T15:04:34	squid	.710 kid1| 22,3| refresh.cc(305) refreshCheck:
</I>&gt;<i> check_time: Wed, 24 Mar 2021 15:05:34 GMT	&#160;
</I>&gt;<i> 2021-03-24T15:04:34	squid	.710 kid1| 22,3| refresh.cc(303) refreshCheck:
</I>&gt;<i> age: 60	&#160;
</I>&gt;<i> 2021-03-24T15:04:34	squid	.710 kid1| 22,3| refresh.cc(301) refreshCheck:
</I>&gt;<i> Matched 'URL 259200 80%% 7776000'	&#160;
</I>&gt;<i> 2021-03-24T15:04:34	squid	.710 kid1| 22,3| refresh.cc(279) refreshCheck:
</I>&gt;<i> checking freshness of URI: <A HREF="https://URL">https://URL</A> &lt;<A HREF="https://URL">https://URL</A>&gt;
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i> 
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="023478.html">[squid-users] squid won't return cached even with refresh_pattern extra options override-lastmod override-expire ignore-reload ignore-no-store ignore-private store-stale
</A></li>
	<LI>Next message (by thread): <A HREF="023480.html">[squid-users] squid won't return cached even with refresh_pattern extra options override-lastmod override-expire ignore-reload ignore-no-store ignore-private store-stale
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23479">[ date ]</a>
              <a href="thread.html#23479">[ thread ]</a>
              <a href="subject.html#23479">[ subject ]</a>
              <a href="author.html#23479">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
