<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] squid won't return cached even with refresh_pattern extra options override-lastmod override-expire ignore-reload ignore-no-store ignore-private store-stale
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid%20won%27t%20return%20cached%20even%20with%0A%20refresh_pattern%20extra%20options%20override-lastmod%20override-expire%0A%20ignore-reload%20ignore-no-store%20ignore-private%20store-stale&In-Reply-To=%3CCAJtdwuv5oqFd%2BZJiGkqt480O41X96_mU8jtc_%3DfeD%2BNf0X%2BfVA%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="023479.html">
   <LINK REL="Next"  HREF="023481.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] squid won't return cached even with refresh_pattern extra options override-lastmod override-expire ignore-reload ignore-no-store ignore-private store-stale</H1>
    <B>Miroslaw Malinowski</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid%20won%27t%20return%20cached%20even%20with%0A%20refresh_pattern%20extra%20options%20override-lastmod%20override-expire%0A%20ignore-reload%20ignore-no-store%20ignore-private%20store-stale&In-Reply-To=%3CCAJtdwuv5oqFd%2BZJiGkqt480O41X96_mU8jtc_%3DfeD%2BNf0X%2BfVA%40mail.gmail.com%3E"
       TITLE="[squid-users] squid won't return cached even with refresh_pattern extra options override-lastmod override-expire ignore-reload ignore-no-store ignore-private store-stale">mr.miroslaw.malinowski at gmail.com
       </A><BR>
    <I>Wed Mar 24 18:28:51 UTC 2021</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="023479.html">[squid-users] squid won't return cached even with refresh_pattern extra options override-lastmod override-expire ignore-reload ignore-no-store ignore-private store-stale
</A></li>
        <LI>Next message (by thread): <A HREF="023481.html">[squid-users] squid won't return cached even with refresh_pattern extra options override-lastmod override-expire ignore-reload ignore-no-store ignore-private store-stale
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23480">[ date ]</a>
              <a href="thread.html#23480">[ thread ]</a>
              <a href="subject.html#23480">[ subject ]</a>
              <a href="author.html#23480">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

You've right yes it's revalidating as API server I'm requesting data is
setting Cache-Control: no-cache. My question is how I can force squid to
cache and not validate as I know it's safe to do so. As I've explained
earlier we are making the same request and receiving the same response from
100+ server so as to reduce number of requests to the external server we
would like squid to cache the response and issue a cached version.

2021/03/24 18:00:54.867 kid1| 22,3| refresh.cc(351) refreshCheck: YES: Must
revalidate stale object (origin set no-cache or private)

Mirek

On Wed, Mar 24, 2021 at 6:15 PM Alex Rousskov &lt;
<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt; wrote:

&gt;<i> On 3/24/21 12:48 PM, Miroslaw Malinowski wrote:
</I>&gt;<i>
</I>&gt;<i> &gt; Probably, me missing on something silly or it can't be done but I don't
</I>&gt;<i> &gt; know why but squid won't return the cached version even when I turn all
</I>&gt;<i> &gt; override options ON in refresh_pattern.
</I>&gt;<i>
</I>&gt;<i> AFAICT, no configuration options that can disable revalidation of
</I>&gt;<i> Cache-Control:no-cache responses. refresh_pattern does not have an
</I>&gt;<i> (equivalent of) &quot;ignore-no-cache-in-responses&quot; option.
</I>&gt;<i>
</I>&gt;<i> IIRC, older Squids were violating an HTTP MUST by forgetting to
</I>&gt;<i> revalidate Cache-Control:no-cache responses, but that was fixed in [1].
</I>&gt;<i> Your Squid version has that fix.
</I>&gt;<i>
</I>&gt;<i> [1]
</I>&gt;<i>
</I>&gt;<i> <A HREF="https://github.com/squid-cache/squid/commit/fa83b766a208b27abed8da4c9073cf8784cf10fa">https://github.com/squid-cache/squid/commit/fa83b766a208b27abed8da4c9073cf8784cf10fa</A>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; With debug, I can see the rule is matched and the cache is fresh but
</I>&gt;<i> &gt; still in access.log is TCP_REFRESH_MODIFIED
</I>&gt;<i>
</I>&gt;<i> &gt; 2021-03-24T15:04:34   squid   .710 kid1| 11,3| http.cc(982)
</I>&gt;<i> &gt; haveParsedReplyHeaders: decided: cache positively and share because
</I>&gt;<i>
</I>&gt;<i> FYI: You are looking at cache.log lines logged _after_ Squid has already
</I>&gt;<i> decided to refresh the cached version. If you want to analyze why Squid
</I>&gt;<i> decided to refresh the cached version, you should look _before_ Squid
</I>&gt;<i> logged the request to the server (and before any FwdState.cc lines). I
</I>&gt;<i> have not checked the details, but I bet that your Squid revalidates
</I>&gt;<i> because of Cache-Control:no-cache in the response. Look for &quot;YES: Must
</I>&gt;<i> revalidate stale object&quot;.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> HTH,
</I>&gt;<i>
</I>&gt;<i> Alex.
</I>&gt;<i>
</I>&gt;<i> &gt; squid conf:
</I>&gt;<i> &gt; refresh_pattern -i &lt;URL&gt; 4320 80% 129600 override-lastmod
</I>&gt;<i> &gt; override-expire ignore-reload ignore-no-store ignore-private store-stale
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; curl headers:
</I>&gt;<i> &gt; curl --insecure --verbose --request GET --url 'URL' &gt;/dev/null
</I>&gt;<i> &gt; * TCP_NODELAY set
</I>&gt;<i> &gt; * ALPN, offering h2
</I>&gt;<i> &gt; * ALPN, offering http/1.1
</I>&gt;<i> &gt; * successfully set certificate verify locations:
</I>&gt;<i> &gt; *   CAfile: /etc/ssl/certs/ca-certificates.crt
</I>&gt;<i> &gt;  CApath: /etc/ssl/certs
</I>&gt;<i> &gt; } [5 bytes data]
</I>&gt;<i> &gt; * TLSv1.3 (OUT), TLS handshake, Client hello (1):
</I>&gt;<i> &gt; } [512 bytes data]
</I>&gt;<i> &gt; * TLSv1.3 (IN), TLS handshake, Server hello (2):
</I>&gt;<i> &gt; { [122 bytes data]
</I>&gt;<i> &gt; * TLSv1.3 (IN), TLS handshake, Encrypted Extensions (8):
</I>&gt;<i> &gt; { [6 bytes data]
</I>&gt;<i> &gt; * TLSv1.3 (IN), TLS handshake, Certificate (11):
</I>&gt;<i> &gt; { [1956 bytes data]
</I>&gt;<i> &gt; * TLSv1.3 (IN), TLS handshake, CERT verify (15):
</I>&gt;<i> &gt; { [78 bytes data]
</I>&gt;<i> &gt; * TLSv1.3 (IN), TLS handshake, Finished (20):
</I>&gt;<i> &gt; { [52 bytes data]
</I>&gt;<i> &gt; * TLSv1.3 (OUT), TLS change cipher, Change cipher spec (1):
</I>&gt;<i> &gt; } [1 bytes data]
</I>&gt;<i> &gt; * TLSv1.3 (OUT), TLS handshake, Finished (20):
</I>&gt;<i> &gt; } [52 bytes data]
</I>&gt;<i> &gt; * SSL connection using TLSv1.3 / TLS_AES_256_GCM_SHA384
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;&gt; GET URL HTTP/1.1
</I>&gt;<i> &gt;&gt; Host: URL
</I>&gt;<i> &gt;&gt; User-Agent: curl/7.68.0
</I>&gt;<i> &gt;&gt; Accept: */*
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt; { [5 bytes data]
</I>&gt;<i> &gt; * TLSv1.3 (IN), TLS handshake, Newsession Ticket (4):
</I>&gt;<i> &gt; { [217 bytes data]
</I>&gt;<i> &gt; * TLSv1.3 (IN), TLS handshake, Newsession Ticket (4):
</I>&gt;<i> &gt; { [217 bytes data]
</I>&gt;<i> &gt; * old SSL session ID is stale, removing
</I>&gt;<i> &gt; { [5 bytes data]
</I>&gt;<i> &gt; * Mark bundle as not supporting multiuse
</I>&gt;<i> &gt; &lt; HTTP/1.1 200 OK
</I>&gt;<i> &gt; &lt; Cache-Control: no-cache
</I>&gt;<i> &gt; &lt; Content-Type: application/json
</I>&gt;<i> &gt; &lt; X-Cloud-Trace-Context: d3c27833b8b4312ce31a2dbae7e12fd0
</I>&gt;<i> &gt; &lt; Date: Wed, 24 Mar 2021 15:04:34 GMT
</I>&gt;<i> &gt; &lt; Server: Google Frontend
</I>&gt;<i> &gt; &lt; Content-Length: 7950
</I>&gt;<i> &gt; &lt; X-Cache: MISS from server
</I>&gt;<i> &gt; &lt; X-Cache-Lookup: HIT from server
</I>&gt;<i> &gt; &lt; Via: 1.1 server (squid/4.14)
</I>&gt;<i> &gt; &lt; Connection: keep-alive
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; access log:
</I>&gt;<i> &gt; 243 172.16.230.249 TCP_REFRESH_MODIFIED/200 8328 GET URL -
</I>&gt;<i> &gt; ORIGINAL_DST/IP application/json
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; cache log:
</I>&gt;<i> &gt; 2021-03-24T15:04:34   squid   .710 kid1| 11,3| http.cc(982)
</I>&gt;<i> &gt; haveParsedReplyHeaders: decided: cache positively and share because
</I>&gt;<i> &gt; refresh check returned cacheable; HTTP status 200
</I>&gt;<i> e:=p2V/0x34868914670*3
</I>&gt;<i> &gt; 2021-03-24T15:04:34   squid   .710 kid1| 22,3| refresh.cc(470)
</I>&gt;<i> refreshCheck:
</I>&gt;<i> &gt; returning FRESH_MIN_RULE
</I>&gt;<i> &gt; 2021-03-24T15:04:34   squid   .710 kid1| 22,3| refresh.cc(455)
</I>&gt;<i> refreshCheck:
</I>&gt;<i> &gt; Object isn't stale..
</I>&gt;<i> &gt; 2021-03-24T15:04:34   squid   .710 kid1| 22,3| refresh.cc(327)
</I>&gt;<i> refreshCheck:
</I>&gt;<i> &gt; Staleness = -1
</I>&gt;<i> &gt; 2021-03-24T15:04:34   squid   .710 kid1| 22,3| refresh.cc(199)
</I>&gt;<i> &gt; refreshStaleness: FRESH: age (60 sec) is less than configured minimum
</I>&gt;<i> &gt; (259200 sec)
</I>&gt;<i> &gt; 2021-03-24T15:04:34   squid   .710 kid1| 22,3| refresh.cc(166)
</I>&gt;<i> &gt; refreshStaleness: No explicit expiry given, using heuristics to
</I>&gt;<i> &gt; determine freshness
</I>&gt;<i> &gt; 2021-03-24T15:04:34   squid   .710 kid1| 22,3| refresh.cc(307)
</I>&gt;<i> refreshCheck:
</I>&gt;<i> &gt; entry-&gt;timestamp: Wed, 24 Mar 2021 15:04:34 GMT
</I>&gt;<i> &gt; 2021-03-24T15:04:34   squid   .710 kid1| 22,3| refresh.cc(305)
</I>&gt;<i> refreshCheck:
</I>&gt;<i> &gt; check_time: Wed, 24 Mar 2021 15:05:34 GMT
</I>&gt;<i> &gt; 2021-03-24T15:04:34   squid   .710 kid1| 22,3| refresh.cc(303)
</I>&gt;<i> refreshCheck:
</I>&gt;<i> &gt; age: 60
</I>&gt;<i> &gt; 2021-03-24T15:04:34   squid   .710 kid1| 22,3| refresh.cc(301)
</I>&gt;<i> refreshCheck:
</I>&gt;<i> &gt; Matched 'URL 259200 80%% 7776000'
</I>&gt;<i> &gt; 2021-03-24T15:04:34   squid   .710 kid1| 22,3| refresh.cc(279)
</I>&gt;<i> refreshCheck:
</I>&gt;<i> &gt; checking freshness of URI: <A HREF="https://URL">https://URL</A> &lt;<A HREF="https://URL">https://URL</A>&gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; _______________________________________________
</I>&gt;<i> &gt; squid-users mailing list
</I>&gt;<i> &gt; <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> &gt; <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i> &gt;
</I>&gt;<i>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20210324/3367f87f/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20210324/3367f87f/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="023479.html">[squid-users] squid won't return cached even with refresh_pattern extra options override-lastmod override-expire ignore-reload ignore-no-store ignore-private store-stale
</A></li>
	<LI>Next message (by thread): <A HREF="023481.html">[squid-users] squid won't return cached even with refresh_pattern extra options override-lastmod override-expire ignore-reload ignore-no-store ignore-private store-stale
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23480">[ date ]</a>
              <a href="thread.html#23480">[ thread ]</a>
              <a href="subject.html#23480">[ subject ]</a>
              <a href="author.html#23480">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
