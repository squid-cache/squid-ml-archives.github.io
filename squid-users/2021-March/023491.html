<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] X-Next-Services
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20X-Next-Services&In-Reply-To=%3Cc3614051-4519-ee07-2888-88b99d3dc6ae%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="023487.html">
   <LINK REL="Next"  HREF="023493.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] X-Next-Services</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20X-Next-Services&In-Reply-To=%3Cc3614051-4519-ee07-2888-88b99d3dc6ae%40measurement-factory.com%3E"
       TITLE="[squid-users] X-Next-Services">rousskov at measurement-factory.com
       </A><BR>
    <I>Thu Mar 25 17:34:46 UTC 2021</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="023487.html">[squid-users] X-Next-Services
</A></li>
        <LI>Next message (by thread): <A HREF="023493.html">[squid-users] Squid stops serving requests after squid -k reconfigure
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23491">[ date ]</a>
              <a href="thread.html#23491">[ thread ]</a>
              <a href="subject.html#23491">[ subject ]</a>
              <a href="author.html#23491">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 3/25/21 9:06 AM, Moti Berger wrote:

&gt;<i> I want to be able to skip all subsequent ICAP servers defined in squid
</I>&gt;<i> based on some logic I have in one of my ICAP servers.
</I>&gt;<i> I used the X-Next-Services and it seems to control only the current ICAP
</I>&gt;<i> chain.
</I>&gt;<i> I also saw it while configuring two ICAP servers to handle requests and
</I>&gt;<i> one ICAP server to handle responses. When the header was sent from the
</I>&gt;<i> first ICAP on the request chain, the ICAP request didn't arrive at the
</I>&gt;<i> second ICAP server handling requests but did get to the ICAP server that
</I>&gt;<i> handles responses. I wish to also skip the ICAP which handles the
</I>&gt;<i> responses.&#160;
</I>&gt;<i> Is that possible?
</I>
Yes, it is.

IIRC, the current X-Next-Services implementation at REQMOD vectoring
point always proceeds to RESPMOD. Ideally, this algorithm should be
enhanced to allow a service to be explicit about its desire to end all
adaption (or continue with the default service at the explicitly
specified vectoring point). This enhancement should not be very
difficult to implement, but it does require non-trivial source code
changes.
<A HREF="https://wiki.squid-cache.org/SquidFaq/AboutSquid#How_to_add_a_new_Squid_feature.2C_enhance.2C_of_fix_something.3F">https://wiki.squid-cache.org/SquidFaq/AboutSquid#How_to_add_a_new_Squid_feature.2C_enhance.2C_of_fix_something.3F</A>

Meanwhile, you should be able to block RESPMOD adaptation for selected
requests using icap_service_access ACLs. As you know, this is possible
by adapting the HTTP request.

Ideally, it would also be possible by annotating the master transaction
using an ICAP response header, but only eCAP services can do that today
IIRC. Another missing enhancement for ICAP... However, you should try
this approach in combination with the adaptation_masterx_shared_names
mentioned below. I hope that when an ICAP response header field has the
shared header field name, the &quot;note&quot; ACL will have access to that field.


&gt;<i> If not, is it possible for an ICAP server to add an ICAP header during
</I>&gt;<i> request handling to be read by the other ICAP servers that come after it
</I>&gt;<i> when they handle the same request or the same request's response?
</I>
Yes, cross-service sharing should be possible by specifying your custom
ICAP header field name in adaptation_masterx_shared_names. As you can
tell, this will allow you to short-circuit unwanted RESPMOD adaptation
if the &quot;note&quot; ACL trick mentioned above does not work.


HTH,

Alex.

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="023487.html">[squid-users] X-Next-Services
</A></li>
	<LI>Next message (by thread): <A HREF="023493.html">[squid-users] Squid stops serving requests after squid -k reconfigure
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23491">[ date ]</a>
              <a href="thread.html#23491">[ thread ]</a>
              <a href="subject.html#23491">[ subject ]</a>
              <a href="author.html#23491">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
