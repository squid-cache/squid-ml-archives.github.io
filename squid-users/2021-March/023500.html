<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] [SPAM] Squid stops serving requests after squid -k reconfigure
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20%5BSPAM%5D%20Squid%20stops%20serving%20requests%20after%20squid%0A%20-k%20reconfigure&In-Reply-To=%3CCABA8h%3DTE1uV_Ojj5XGS0N4MM_8z2QPf5CL%2BN3Tbwob3OsE2bGQ%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="023499.html">
   <LINK REL="Next"  HREF="023503.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] [SPAM] Squid stops serving requests after squid -k reconfigure</H1>
    <B>NgTech LTD</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20%5BSPAM%5D%20Squid%20stops%20serving%20requests%20after%20squid%0A%20-k%20reconfigure&In-Reply-To=%3CCABA8h%3DTE1uV_Ojj5XGS0N4MM_8z2QPf5CL%2BN3Tbwob3OsE2bGQ%40mail.gmail.com%3E"
       TITLE="[squid-users] [SPAM] Squid stops serving requests after squid -k reconfigure">ngtech1ltd at gmail.com
       </A><BR>
    <I>Tue Mar 30 20:08:02 UTC 2021</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="023499.html">[squid-users] [SPAM] Squid stops serving requests after squid -k reconfigure
</A></li>
        <LI>Next message (by thread): <A HREF="023503.html">[squid-users] [SPAM] Squid stops serving requests after squid -k reconfigure
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23500">[ date ]</a>
              <a href="thread.html#23500">[ thread ]</a>
              <a href="subject.html#23500">[ subject ]</a>
              <a href="author.html#23500">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hey Acid,

First you should try 4.x latest.
a reload of 50 domains every 10 second doesn't make sense.
I don't understand the config and the setup.
for 50 sites you just need a basic script and even one in bash will work
dor you with grep.
I wrote an example in ruby a while ago, I will try to find it in the next
week.
Maybe the server is overloaded.

I will try to give you an example later on.

Eliezer


&#1489;&#1514;&#1488;&#1512;&#1497;&#1498; &#1497;&#1493;&#1501; &#1490;&#1523;, 30 &#1489;&#1502;&#1512;&#1509; 2021, 20:41, &#1502;&#1488;&#1514; acidflash acidflash &#8207;&lt;
<A HREF="https://lists.squid-cache.org/listinfo/squid-users">acidflash_ at linuxmail.org</A>&gt;:

&gt;<i>
</I>&gt;<i> Hi Eliezer,
</I>&gt;<i>
</I>&gt;<i> I hope your doing ok. Thanks for the reply. Yeah currently what I am doing
</I>&gt;<i> is:
</I>&gt;<i>
</I>&gt;<i> include /etc/squid/blockedsites.list
</I>&gt;<i> and adding the ACL's and the denies in the list file. What version do you
</I>&gt;<i> recommend I upgrade to, and is this a known issue? The list is actually
</I>&gt;<i> pretty small, probably no more than 50 sites or so, and thats split across
</I>&gt;<i> 4 or 5 groups (different ACL's). I'll look into ufdbguard and the other
</I>&gt;<i> projects as well, does this sound familiar though? If you think that the
</I>&gt;<i> best path forward is to alleviate the burden off of squid to some external
</I>&gt;<i> tool, I could probably think up a few hacks to for that, but would
</I>&gt;<i> obviously prefer to keep it all within squid. Is this occurance common with
</I>&gt;<i> squid -k reconfigure and dstdomain matching? Thanks for your time. Stay
</I>&gt;<i> safe.
</I>&gt;<i>
</I>&gt;<i> *Sent:* Sunday, March 28, 2021 at 4:42 AM
</I>&gt;<i> *From:* &quot;Eliezer Croitoru&quot; &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">ngtech1ltd at gmail.com</A>&gt;
</I>&gt;<i> *To:* <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> *Subject:* Re: [squid-users] [SPAM] Squid stops serving requests after
</I>&gt;<i> squid -k reconfigure
</I>&gt;<i>
</I>&gt;<i> Hey Acid,
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Haven&#8217;t seen you here for a very long time.
</I>&gt;<i>
</I>&gt;<i> The first thing is to upgrade squid if possible&#8230;
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> It&#8217;s better that you won&#8217;t use squid -kreconf for big blacklists.
</I>&gt;<i>
</I>&gt;<i> Instead you should use some external software to match the blacklists.
</I>&gt;<i>
</I>&gt;<i> The most recommended software these days is ufdbguard.
</I>&gt;<i>
</I>&gt;<i> Depends on the size of your blacklist your might need to find the right
</I>&gt;<i> solution.
</I>&gt;<i>
</I>&gt;<i> The best solution would be to store the list in ram somehow.
</I>&gt;<i>
</I>&gt;<i> Have you tried some kind of rbl server?
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> At the time I wrote some code to and some of it was merged into:
</I>&gt;<i>
</I>&gt;<i> <A HREF="https://github.com/looterz/grimd">https://github.com/looterz/grimd</A>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> It has a reload url so you can update the files on disk and send a reload.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Another service I am using is:
</I>&gt;<i>
</I>&gt;<i> <A HREF="https://github.com/andybalholm/redwood">https://github.com/andybalholm/redwood</A>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Which has a &#8220;Classification Service&#8221; function.
</I>&gt;<i>
</I>&gt;<i> It&#8217;s pretty easy to write a json http client that can run queries against
</I>&gt;<i> this classification service.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Also you&#8217;d better use a file In the dstdomain ac ie:
</I>&gt;<i>
</I>&gt;<i> acl Blacklist dstdomain &#8220;/var/blacklists/xyx.list&#8221;
</I>&gt;<i>
</I>&gt;<i> http_access deny Blacklist
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> and inside the xyx.list file just add lines of domains like
</I>&gt;<i>
</I>&gt;<i> .blacklisted-domain.com
</I>&gt;<i>
</I>&gt;<i> .example.com
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Etc..
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> All The Bests,
</I>&gt;<i>
</I>&gt;<i> Eliezer
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> ----
</I>&gt;<i>
</I>&gt;<i> Eliezer Croitoru
</I>&gt;<i>
</I>&gt;<i> Tech Support
</I>&gt;<i>
</I>&gt;<i> Mobile: +972-5-28704261
</I>&gt;<i>
</I>&gt;<i> Email: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">ngtech1ltd at gmail.com</A>
</I>&gt;<i>
</I>&gt;<i> Zoom: Coming soon
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> *From:* squid-users &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>&gt; *On
</I>&gt;<i> Behalf Of *acidflash acidflash
</I>&gt;<i> *Sent:* Saturday, March 27, 2021 10:55 AM
</I>&gt;<i> *To:* <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> *Subject:* [SPAM] [squid-users] Squid stops serving requests after squid
</I>&gt;<i> -k reconfigure
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> I have gone through the forums, and I haven't found an answer to the
</I>&gt;<i> question, although it has been asked more than once.
</I>&gt;<i>
</I>&gt;<i> I am running squid 3.5.X on Centos 7, the compile options are:
</I>&gt;<i> &quot;configure options:  '--build=x86_64-redhat-linux-gnu'
</I>&gt;<i> '--host=x86_64-redhat-linux-gnu' '--program-prefix=' '--prefix=/usr'
</I>&gt;<i> '--exec-prefix=/usr' '--bindir=/usr/bin' '--sbindir=/usr/sbin'
</I>&gt;<i> '--sysconfdir=/etc' '--datadir=/usr/share' '--includedir=/usr/include'
</I>&gt;<i> '--libdir=/usr/lib64' '--libexecdir=/usr/libexec'
</I>&gt;<i> '--sharedstatedir=/var/lib' '--mandir=/usr/share/man'
</I>&gt;<i> '--infodir=/usr/share/info' '--disable-strict-error-checking'
</I>&gt;<i> '--exec_prefix=/usr' '--libexecdir=/usr/lib64/squid' '--localstatedir=/var'
</I>&gt;<i> '--datadir=/usr/share/squid' '--sysconfdir=/etc/squid'
</I>&gt;<i> '--with-logdir=$(localstatedir)/log/squid'
</I>&gt;<i> '--with-pidfile=$(localstatedir)/run/squid.pid'
</I>&gt;<i> '--disable-dependency-tracking' '--enable-eui'
</I>&gt;<i> '--enable-follow-x-forwarded-for' '--enable-auth'
</I>&gt;<i> '--enable-auth-basic=DB,LDAP,MSNT-multi-domain,NCSA,NIS,PAM,POP3,RADIUS,SASL,SMB,SMB_LM,getpwnam'
</I>&gt;<i> '--enable-auth-ntlm=smb_lm,fake'
</I>&gt;<i> '--enable-auth-digest=file,LDAP,eDirectory'
</I>&gt;<i> '--enable-auth-negotiate=kerberos'
</I>&gt;<i> '--enable-external-acl-helpers=file_userip,LDAP_group,time_quota,session,unix_group,wbinfo_group,kerberos_ldap_group'
</I>&gt;<i> '--enable-cache-digests' '--enable-cachemgr-hostname=localhost'
</I>&gt;<i> '--enable-delay-pools' '--enable-epoll' '--enable-ident-lookups'
</I>&gt;<i> '--enable-linux-netfilter' '--enable-removal-policies=heap,lru'
</I>&gt;<i> '--enable-snmp' '--enable-ssl-crtd' '--enable-storeio=aufs,diskd,rock,ufs'
</I>&gt;<i> '--enable-wccpv2' '--enable-esi' '--enable-ecap' '--with-aio'
</I>&gt;<i> '--with-default-user=squid' '--with-dl' '--with-openssl' '--with-pthreads'
</I>&gt;<i> '--disable-arch-native' 'build_alias=x86_64-redhat-linux-gnu'
</I>&gt;<i> 'host_alias=x86_64-redhat-linux-gnu' 'CFLAGS=-O2 -g -pipe -Wall
</I>&gt;<i> -Wp,-D_FORTIFY_SOURCE=2 -fexceptions -fstack-protector-strong
</I>&gt;<i> --param=ssp-buffer-size=4 -grecord-gcc-switches   -m64 -mtune=generic
</I>&gt;<i> -fpie' 'LDFLAGS=-Wl,-z,relro  -pie -Wl,-z,relro -Wl,-z,now' 'CXXFLAGS=-O2
</I>&gt;<i> -g -pipe -Wall -Wp,-D_FORTIFY_SOURCE=2 -fexceptions
</I>&gt;<i> -fstack-protector-strong --param=ssp-buffer-size=4 -grecord-gcc-switches
</I>&gt;<i> -m64 -mtune=generic -fpie'
</I>&gt;<i> 'PKG_CONFIG_PATH=:/usr/lib64/pkgconfig:/usr/share/pkgconfig'&quot;
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> I have a service which adds domains to a blacklist file, and then calls
</I>&gt;<i> squid -k reconfigure.
</I>&gt;<i> Instead of writing to the file, this service updates the file completely
</I>&gt;<i> with new rules,
</I>&gt;<i> by deleting the old file, and creating a new one in its place, and then
</I>&gt;<i> calling squid -k reconfigure.
</I>&gt;<i> After doing this, on odd occasions, squid will stop serving traffic
</I>&gt;<i> completely,
</I>&gt;<i> until you do a squid stop, and squid start. After shutting down squid,
</I>&gt;<i> and starting squid up with the same rules, squid will continue to work
</I>&gt;<i> normally.
</I>&gt;<i> Its probably worth mentioning that during the time that these events are
</I>&gt;<i> taking place,
</I>&gt;<i> the server is under quite a bit of load, and clients don't stop sending
</I>&gt;<i> requests via the server.
</I>&gt;<i> What these directives look like:
</I>&gt;<i>
</I>&gt;<i> acl Porn dstdomain .xnxx.com .sex.com
</I>&gt;<i> acl Drugs dstdomain .drugs.com .silkroad.eu
</I>&gt;<i> http_access deny Porn
</I>&gt;<i> http_access deny Drugs
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> This also seems to be amplified when there are several squid workers
</I>&gt;<i> (child processes) running.
</I>&gt;<i> In regards to order, these ACL's are above any other ACL's in the list. We
</I>&gt;<i> have a very basic squid conf file that looks like this:
</I>&gt;<i> ## START OF FILE
</I>&gt;<i> http_port 3128
</I>&gt;<i> cache deny all
</I>&gt;<i> #
</I>&gt;<i> access_log /var/log/squid/access.log
</I>&gt;<i> cache_store_log none
</I>&gt;<i> cache_log /dev/null
</I>&gt;<i> logfile_rotate 4
</I>&gt;<i> #
</I>&gt;<i> auth_param basic program /usr/lib64/squid/basic_db_auth --dsn
</I>&gt;<i> &quot;DBI:mysql:host=XX.XX.XX.XX;port=XXXX;database=XXXXX&quot; --user XXXXXX
</I>&gt;<i> --password XXXXXXXX --plaintext --persist
</I>&gt;<i> #
</I>&gt;<i> acl db-auth proxy_auth REQUIRED
</I>&gt;<i> auth_param basic credentialsttl 2 hours
</I>&gt;<i> auth_param basic casesensitive on
</I>&gt;<i> #
</I>&gt;<i> connect_timeout 55 minutes
</I>&gt;<i> #
</I>&gt;<i> request_header_access Allow allow all
</I>&gt;<i> request_header_access Authorization allow all
</I>&gt;<i> request_header_access WWW-Authenticate allow all
</I>&gt;<i> request_header_access Proxy-Authorization allow all
</I>&gt;<i> request_header_access Proxy-Authenticate allow all
</I>&gt;<i> request_header_access Cache-Control allow all
</I>&gt;<i> request_header_access Content-Encoding allow all
</I>&gt;<i> request_header_access Content-Length allow all
</I>&gt;<i> request_header_access Content-Type allow all
</I>&gt;<i> request_header_access Date allow all
</I>&gt;<i> request_header_access Expires allow all
</I>&gt;<i> request_header_access Host allow all
</I>&gt;<i> request_header_access If-Modified-Since allow all
</I>&gt;<i> request_header_access Last-Modified allow all
</I>&gt;<i> request_header_access Location allow all
</I>&gt;<i> request_header_access Pragma allow all
</I>&gt;<i> request_header_access Accept allow all
</I>&gt;<i> request_header_access Accept-Charset allow all
</I>&gt;<i> request_header_access Accept-Encoding allow all
</I>&gt;<i> request_header_access Accept-Language allow all
</I>&gt;<i> request_header_access Content-Language allow all
</I>&gt;<i> request_header_access Mime-Version allow all
</I>&gt;<i> request_header_access Retry-After allow all
</I>&gt;<i> request_header_access Title allow all
</I>&gt;<i> request_header_access Connection allow all
</I>&gt;<i> request_header_access Proxy-Connection allow all
</I>&gt;<i> request_header_access User-Agent allow all
</I>&gt;<i> request_header_access Cookie allow all
</I>&gt;<i> request_header_access All deny all
</I>&gt;<i> dns_v4_first on
</I>&gt;<i> via off
</I>&gt;<i> forwarded_for off
</I>&gt;<i> follow_x_forwarded_for deny all
</I>&gt;<i> dns_nameservers 8.8.8.8 8.8.4.4
</I>&gt;<i> ## END OF FILE
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Your help is greatly appreciated, maybe there has been some insight into
</I>&gt;<i> this issue after 10+ years since the last time it was asked.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________ squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20210330/f185a701/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20210330/f185a701/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="023499.html">[squid-users] [SPAM] Squid stops serving requests after squid -k reconfigure
</A></li>
	<LI>Next message (by thread): <A HREF="023503.html">[squid-users] [SPAM] Squid stops serving requests after squid -k reconfigure
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23500">[ date ]</a>
              <a href="thread.html#23500">[ thread ]</a>
              <a href="subject.html#23500">[ subject ]</a>
              <a href="author.html#23500">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
