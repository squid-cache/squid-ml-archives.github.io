<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] [SPAM] Squid stops serving requests after squid -k reconfigure
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20%5BSPAM%5D%20Squid%20stops%20serving%20requests%20after%20squid%0A%20-k%20reconfigure&In-Reply-To=%3C008301d72654%245a0eb2a0%240e2c17e0%24%40gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="023500.html">
   <LINK REL="Next"  HREF="023497.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] [SPAM] Squid stops serving requests after squid -k reconfigure</H1>
    <B>Eliezer Croitoru</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20%5BSPAM%5D%20Squid%20stops%20serving%20requests%20after%20squid%0A%20-k%20reconfigure&In-Reply-To=%3C008301d72654%245a0eb2a0%240e2c17e0%24%40gmail.com%3E"
       TITLE="[squid-users] [SPAM] Squid stops serving requests after squid -k reconfigure">ngtech1ltd at gmail.com
       </A><BR>
    <I>Wed Mar 31 17:36:14 UTC 2021</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="023500.html">[squid-users] [SPAM] Squid stops serving requests after squid -k reconfigure
</A></li>
        <LI>Next message (by thread): <A HREF="023497.html">[squid-users] kswapd0 and memory usage
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23503">[ date ]</a>
              <a href="thread.html#23503">[ thread ]</a>
              <a href="subject.html#23503">[ subject ]</a>
              <a href="author.html#23503">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hey Acid,

 

I created as an example scripts the next:

<A HREF="https://github.com/elico/squid-external-matchers">https://github.com/elico/squid-external-matchers</A>

 

The bash script is the pseudo and the ruby are production grade services.

I have use these services in production for a very long time and it works great.

Auto reloads the files as you append the content/domains/urls/sni.

 

All The Bests,

Eliezer

 

----

Eliezer Croitoru

Tech Support

Mobile: +972-5-28704261

Email: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">ngtech1ltd at gmail.com</A> &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">ngtech1ltd at gmail.com</A>&gt; 

Zoom: Coming soon

 

 

From: NgTech LTD &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">ngtech1ltd at gmail.com</A>&gt; 
Sent: Tuesday, March 30, 2021 11:08 PM
To: acidflash acidflash &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">acidflash_ at linuxmail.org</A>&gt;
Cc: Squid Users &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>&gt;
Subject: Re: [squid-users] [SPAM] Squid stops serving requests after squid -k reconfigure

 

Hey Acid,

 

First you should try 4.x latest.

a reload of 50 domains every 10 second doesn't make sense.

I don't understand the config and the setup.

for 50 sites you just need a basic script and even one in bash will work dor you with grep.

I wrote an example in ruby a while ago, I will try to find it in the next week.

Maybe the server is overloaded.

 

I will try to give you an example later on.

 

Eliezer

 

 

&#1489;&#1514;&#1488;&#1512;&#1497;&#1498; &#1497;&#1493;&#1501; &#1490;&#1523;, 30 &#1489;&#1502;&#1512;&#1509; 2021, 20:41, &#1502;&#1488;&#1514; acidflash acidflash &#8207;&lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">acidflash_ at linuxmail.org</A> &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">acidflash_ at linuxmail.org</A>&gt; &gt;:

 

Hi Eliezer,

I hope your doing ok. Thanks for the reply. Yeah currently what I am doing is:

include /etc/squid/blockedsites.list
and adding the ACL's and the denies in the list file. What version do you recommend I upgrade to, and is this a known issue? The list is actually pretty small, probably no more than 50 sites or so, and thats split across 4 or 5 groups (different ACL's). I'll look into ufdbguard and the other projects as well, does this sound familiar though? If you think that the best path forward is to alleviate the burden off of squid to some external tool, I could probably think up a few hacks to for that, but would obviously prefer to keep it all within squid. Is this occurance common with squid -k reconfigure and dstdomain matching? Thanks for your time. Stay safe. 

  

Sent: Sunday, March 28, 2021 at 4:42 AM
From: &quot;Eliezer Croitoru&quot; &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">ngtech1ltd at gmail.com</A> &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">ngtech1ltd at gmail.com</A>&gt; &gt;
To: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A> &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>&gt; 
Subject: Re: [squid-users] [SPAM] Squid stops serving requests after squid -k reconfigure

Hey Acid,

 

Haven&#8217;t seen you here for a very long time.

The first thing is to upgrade squid if possible&#8230;

 

It&#8217;s better that you won&#8217;t use squid -kreconf for big blacklists.

Instead you should use some external software to match the blacklists.

The most recommended software these days is ufdbguard.

Depends on the size of your blacklist your might need to find the right solution.

The best solution would be to store the list in ram somehow.

Have you tried some kind of rbl server?

 

At the time I wrote some code to and some of it was merged into:

<A HREF="https://github.com/looterz/grimd">https://github.com/looterz/grimd</A>

 

It has a reload url so you can update the files on disk and send a reload.

 

Another service I am using is:

<A HREF="https://github.com/andybalholm/redwood">https://github.com/andybalholm/redwood</A>

 

Which has a &#8220;Classification Service&#8221; function.

It&#8217;s pretty easy to write a json http client that can run queries against this classification service.

 

Also you&#8217;d better use a file In the dstdomain ac ie:

acl Blacklist dstdomain &#8220;/var/blacklists/xyx.list&#8221;

http_access deny Blacklist

 

and inside the xyx.list file just add lines of domains like

.blacklisted-domain.com &lt;<A HREF="http://blacklisted-domain.com">http://blacklisted-domain.com</A>&gt; 

.example.com &lt;<A HREF="http://example.com">http://example.com</A>&gt; 

 

Etc..

 

 

All The Bests,

Eliezer

 

----

Eliezer Croitoru

Tech Support

Mobile: +972-5-28704261

Email: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">ngtech1ltd at gmail.com</A> &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">ngtech1ltd at gmail.com</A>&gt; 

Zoom: Coming soon

 

 

From: squid-users &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A> &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>&gt; &gt; On Behalf Of acidflash acidflash
Sent: Saturday, March 27, 2021 10:55 AM
To: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A> &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>&gt; 
Subject: [SPAM] [squid-users] Squid stops serving requests after squid -k reconfigure

 

I have gone through the forums, and I haven't found an answer to the question, although it has been asked more than once.

I am running squid 3.5.X on Centos 7, the compile options are:
&quot;configure options:  '--build=x86_64-redhat-linux-gnu' '--host=x86_64-redhat-linux-gnu' '--program-prefix=' '--prefix=/usr' '--exec-prefix=/usr' '--bindir=/usr/bin' '--sbindir=/usr/sbin' '--sysconfdir=/etc' '--datadir=/usr/share' '--includedir=/usr/include' '--libdir=/usr/lib64' '--libexecdir=/usr/libexec' '--sharedstatedir=/var/lib' '--mandir=/usr/share/man' '--infodir=/usr/share/info' '--disable-strict-error-checking' '--exec_prefix=/usr' '--libexecdir=/usr/lib64/squid' '--localstatedir=/var' '--datadir=/usr/share/squid' '--sysconfdir=/etc/squid' '--with-logdir=$(localstatedir)/log/squid' '--with-pidfile=$(localstatedir)/run/squid.pid' '--disable-dependency-tracking' '--enable-eui' '--enable-follow-x-forwarded-for' '--enable-auth' '--enable-auth-basic=DB,LDAP,MSNT-multi-domain,NCSA,NIS,PAM,POP3,RADIUS,SASL,SMB,SMB_LM,getpwnam' '--enable-auth-ntlm=smb_lm,fake' '--enable-auth-digest=file,LDAP,eDirectory' '--enable-auth-negotiate=kerberos' '--enable-external-acl-helpers=file_userip,LDAP_group,time_quota,session,unix_group,wbinfo_group,kerberos_ldap_group' '--enable-cache-digests' '--enable-cachemgr-hostname=localhost' '--enable-delay-pools' '--enable-epoll' '--enable-ident-lookups' '--enable-linux-netfilter' '--enable-removal-policies=heap,lru' '--enable-snmp' '--enable-ssl-crtd' '--enable-storeio=aufs,diskd,rock,ufs' '--enable-wccpv2' '--enable-esi' '--enable-ecap' '--with-aio' '--with-default-user=squid' '--with-dl' '--with-openssl' '--with-pthreads' '--disable-arch-native' 'build_alias=x86_64-redhat-linux-gnu' 'host_alias=x86_64-redhat-linux-gnu' 'CFLAGS=-O2 -g -pipe -Wall -Wp,-D_FORTIFY_SOURCE=2 -fexceptions -fstack-protector-strong --param=ssp-buffer-size=4 -grecord-gcc-switches   -m64 -mtune=generic -fpie' 'LDFLAGS=-Wl,-z,relro  -pie -Wl,-z,relro -Wl,-z,now' 'CXXFLAGS=-O2 -g -pipe -Wall -Wp,-D_FORTIFY_SOURCE=2 -fexceptions -fstack-protector-strong --param=ssp-buffer-size=4 -grecord-gcc-switches   -m64 -mtune=generic -fpie' 'PKG_CONFIG_PATH=:/usr/lib64/pkgconfig:/usr/share/pkgconfig'&quot;

 

I have a service which adds domains to a blacklist file, and then calls squid -k reconfigure.
Instead of writing to the file, this service updates the file completely with new rules,
by deleting the old file, and creating a new one in its place, and then calling squid -k reconfigure.
After doing this, on odd occasions, squid will stop serving traffic completely,
until you do a squid stop, and squid start. After shutting down squid,
and starting squid up with the same rules, squid will continue to work normally.
Its probably worth mentioning that during the time that these events are taking place,
the server is under quite a bit of load, and clients don't stop sending requests via the server.
What these directives look like:

acl Porn dstdomain .xnxx.com &lt;<A HREF="http://xnxx.com">http://xnxx.com</A>&gt;  .sex.com &lt;<A HREF="http://sex.com">http://sex.com</A>&gt;  
acl Drugs dstdomain .drugs.com &lt;<A HREF="http://drugs.com">http://drugs.com</A>&gt;  .silkroad.eu &lt;<A HREF="http://silkroad.eu">http://silkroad.eu</A>&gt;  
http_access deny Porn
http_access deny Drugs

 

This also seems to be amplified when there are several squid workers (child processes) running.
In regards to order, these ACL's are above any other ACL's in the list. We have a very basic squid conf file that looks like this:
## START OF FILE
http_port 3128
cache deny all
#
access_log /var/log/squid/access.log 
cache_store_log none
cache_log /dev/null
logfile_rotate 4
#
auth_param basic program /usr/lib64/squid/basic_db_auth --dsn &quot;DBI:mysql:host=XX.XX.XX.XX;port=XXXX;database=XXXXX&quot; --user XXXXXX --password XXXXXXXX --plaintext --persist
# 
acl db-auth proxy_auth REQUIRED
auth_param basic credentialsttl 2 hours
auth_param basic casesensitive on
#
connect_timeout 55 minutes
#
request_header_access Allow allow all
request_header_access Authorization allow all
request_header_access WWW-Authenticate allow all
request_header_access Proxy-Authorization allow all
request_header_access Proxy-Authenticate allow all
request_header_access Cache-Control allow all
request_header_access Content-Encoding allow all
request_header_access Content-Length allow all
request_header_access Content-Type allow all
request_header_access Date allow all
request_header_access Expires allow all
request_header_access Host allow all
request_header_access If-Modified-Since allow all
request_header_access Last-Modified allow all
request_header_access Location allow all
request_header_access Pragma allow all
request_header_access Accept allow all
request_header_access Accept-Charset allow all
request_header_access Accept-Encoding allow all
request_header_access Accept-Language allow all
request_header_access Content-Language allow all
request_header_access Mime-Version allow all
request_header_access Retry-After allow all
request_header_access Title allow all
request_header_access Connection allow all
request_header_access Proxy-Connection allow all
request_header_access User-Agent allow all
request_header_access Cookie allow all
request_header_access All deny all
dns_v4_first on
via off
forwarded_for off
follow_x_forwarded_for deny all
dns_nameservers 8.8.8.8 8.8.4.4
## END OF FILE

 

Your help is greatly appreciated, maybe there has been some insight into this issue after 10+ years since the last time it was asked.

 

_______________________________________________ squid-users mailing list <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A> &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>&gt;  <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>

_______________________________________________
squid-users mailing list
<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A> &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>&gt; 
<A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>

-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20210331/c872f363/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20210331/c872f363/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="023500.html">[squid-users] [SPAM] Squid stops serving requests after squid -k reconfigure
</A></li>
	<LI>Next message (by thread): <A HREF="023497.html">[squid-users] kswapd0 and memory usage
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23503">[ date ]</a>
              <a href="thread.html#23503">[ thread ]</a>
              <a href="subject.html#23503">[ subject ]</a>
              <a href="author.html#23503">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
