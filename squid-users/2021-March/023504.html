<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Linking Squid Logs
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Linking%20Squid%20Logs&In-Reply-To=%3CMN2PR06MB5951FD073FE9AE408423FFAD987C9%40MN2PR06MB5951.namprd06.prod.outlook.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="023501.html">
   <LINK REL="Next"  HREF="023505.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Linking Squid Logs</H1>
    <B>Garbacik, Joe</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Linking%20Squid%20Logs&In-Reply-To=%3CMN2PR06MB5951FD073FE9AE408423FFAD987C9%40MN2PR06MB5951.namprd06.prod.outlook.com%3E"
       TITLE="[squid-users] Linking Squid Logs">Joseph.Garbacik at netapp.com
       </A><BR>
    <I>Wed Mar 31 17:59:47 UTC 2021</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="023501.html">[squid-users] icap adaptation chains with adaptation sets
</A></li>
        <LI>Next message (by thread): <A HREF="023505.html">[squid-users] client_delay_pools doesn't work as expected
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23504">[ date ]</a>
              <a href="thread.html#23504">[ thread ]</a>
              <a href="subject.html#23504">[ subject ]</a>
              <a href="author.html#23504">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>In my squid.conf, I have the following logformat which passes all the data from the client via the load balancer to the squid server as headers:
logformat MyLogFormat  ---&gt; local_time=&quot;[%tl]&quot; squid_service=%{service}note squid_status=%Ss squid_hierarchy_status=%Sh ** haproxy_id=%{X-Request-Id}&gt;h orig_src_ip=%{X-Client-Egress-Ip}&gt;h orig_src_port=%{X-Client-Egress-Port}&gt;h  haproxy_ingress_ip=%{X-Haproxy-Ingress-Ip}&gt;h haproxy_ingress_port=%{X-Haproxy-Ingress-Port}&gt;h haproxy_egress_ip=%&gt;a haproxy_egress_port=%&gt;p squid_ingress_ip=%&gt;la squid_ingress_port=%&gt;lp squid_egress_ip=%&lt;la squid_egress_port=%&lt;lp dst_ip=%&lt;a dst_host=%&lt;A dst_port=%&lt;p ident_username=%[ui username=%[un request_method=%rm request=&quot;%rm %ru HTTP/%rv&quot; status_code_from_server=%&gt;Hs status_code_to_client=%&lt;Hs referer=&quot;%{Referer}&gt;h&quot; user_agent=&quot;%{User-Agent}&gt;h&quot; protocol_version=%rv ** dns_response_time=%dt response_time=%tr mime_type=%mt *XFER*  total_request_size=%&gt;st total_reply_size=%&lt;st ** %{src_zone}note %{dst_zone}note %{method_category}note %{dst_category}note %{file_upload}note ** REQUEST HEADERS %&gt;h *** RESPONSE HEADERS %&lt;h *** tag_returned=%et tag_string=&quot;%ea&quot; previous_hop_mac=%&gt;eui peer_response_time=%&lt;pt total_response_time=%&lt;tt *SSL* src_ssl_negotiated_version=%ssl::&gt;negotiated_version dst_ssl_negotiated_version=%ssl::&lt;negotiated_version src_tls_hello_version=%ssl::&gt;received_hello_version  dst_tls_hello_version=%ssl::&lt;received_hello_version src_tls_max_version=%ssl::&gt;received_supported_version dst_tls_max_version=%ssl::&lt;received_supported_version src_tls_cipher=%ssl::&gt;negotiated_cipher dst_tls_cipher=%ssl::&lt;negotiated_cipher ssl_bump=%&lt;bs ssl_bump_mode=%ssl::bump_mode ssl_sni=%ssl::&gt;sni src_cert_subject=&quot;%ssl::&gt;cert_subject&quot; src_cert_issuer=&quot;%ssl::&gt;cert_issuer&quot; dst_cert_subject=&quot;%ssl::&lt;cert_subject&quot; dst_cert_issuer=&quot;%ssl::&lt;cert_issuer&quot; cert_errors=&quot;%ssl::&lt;cert_errors&quot; *** error_page_presented=%err_code err_detail=&quot;%err_detail&quot;  rule_id=%{ruleid}note rule_type=%{ruletype}note  XFF=%{X-Forwarded-For}&gt;h dst_app=%{dst_app}note

This creates the two logs at the end of this message, What I am wondering is:

  1.  Why aren't all the request headers (look between  ** REQUEST HEADERS and *** RESPONSE HEADERS in each log) seen in the first log present in the second log
  2.  I'm assuming since squid is then making the request in the second log, it leaves the items in Flow0 (client &#8226; load balancer) empty but does retain the data for flow1 (load-balancer-&gt; squid)and flow2 (squid -&gt; destination). Even the XFF is not passed. It there anyway to included retain this data?
  3.  Is there a way to generate an unique Id for each flow so, besides the data in flow0, once can easily link these logs together?

Thanks


Which generates these two logs when doing SSL intercept
Log 1-----
2021-03-31T12:22:08.402609+00:00 squid1 ---&gt; local_time=&quot;[31/Mar/2021:08:22:08 -0400]&quot; squid_service=explicit squid_status=NONE squid_hierarchy_status=HIER_DIRECT ** haproxy_id=73834348 | **Flow0** src_ip=10.11.63.205 src_port=55624 haproxy_ingress_ip=192.16.8.1.33 haproxy_ingress_port=3128 | ** Flow1** haproxy_egress_ip=192.16.8.1.39 haproxy_egress_port=6079 squid_ingress_ip=192.16.8.1.36 squid_ingress_port=3128 | ** Flow2* squid_egress_ip=192.16.8.1.40 squid_egress_port=55984 dst_ip=10.51.129.182 dst_host=myhost.foo.com dst_port=443 ident_username=- username=- request_method=CONNECT request=&quot;CONNECT myhost.foo.com:443 HTTP/1.1&quot; status_code_from_server=200 status_code_to_client=- referer=&quot;-&quot; user_agent=&quot;git/2.7.4&quot; protocol_version=1.1 ** dns_response_time=- response_time=174 mime_type=- *XFER* total_request_size=763 total_reply_size=0 ** src_zone=CoreLab - method_category=Safe - - ** REQUEST HEADERS User-Agent=git/2.7.4 HDR_Proxy-Connection=Keep-Alive HDR_X-Client-Environment=SecLab HDR_X-Client-Environment=Corporate HDR_X-Client-IP=10.11.63.205 HDR_X-Proxy-Channel=3128 HDR_X-Haproxy-Role=Squid HDR_X-Correlation-ID=73834348  HDR_X-Client-Egress-Ip=10.11.63.205 HDR_X-Client-Egress-Port=55624 HDR_X-Haproxy-Ingress-Ip=192.16.8.1.33 HDR_X-Haproxy-Ingress-Port=3128 HDR_X-Haproxy-Egress-Ip=&quot;&quot; HDR_X-Haproxy-Egress-Port=&quot;&quot; HDR_X-Server-Ingress-Ip=&quot;&quot; HDR_X-Server-Ingress-Port=&quot;&quot; HDR_X-Server-Queue=0 HDR_X-App-Node=%3CNOSRV%3E HDR_X-SSL-Cipher=&quot;&quot; HDR_X-SSL-Version=&quot;&quot; HDR_X-Request-Id=73834348 HDR_X-Forwarded-For=10.11.63.205 HDR_Connection=close HDR_Host=myhost.foo.com:443 HDR_ *** RESPONSE HEADERS - *** tag_returned=- tag_string=&quot;-&quot; previous_hop_mac=00:50:56:b8:03:73 peer_response_time=- total_response_time=98 *SSL* src_ssl_negotiated_version=- dst_ssl_negotiated_version=TLS/1.2 src_tls_hello_version=TLS/1.0 dst_tls_hello_version=TLS/1.2 src_tls_max_version=TLS/1.2 dst_tls_max_version=TLS/1.2 src_tls_cipher=- dst_tls_cipher=ECDHE-RSA-AES256-GCM-SHA384 ssl_bump=- ssl_bump_mode=bump ssl_sni=myhost.foo.com src_cert_subject=&quot;-&quot; src_cert_issuer=&quot;-&quot; dst_cert_subject=&quot;/C=US/postalCode=12345/ST=California/L=Sunnyvale/street=123 Any Street/O=Demo, Inc./OU=None/CN=foo.com&quot; dst_cert_issuer=&quot;/C=GB/ST=Greater Manchester/L=Salford/O=Sectigo Limited/CN=Sectigo RSA Organization Validation Secure Server CA&quot; cert_errors=&quot;-&quot; *** error_page_presented=- err_detail=&quot;-&quot; rule_id=Explicit-45-Rule1.conf_2 rule_type=ALLOW XFF=&quot;10.11.63.205&quot; squid_dst_app=MyApp

Log 2----
2021-03-31T12:22:08.495914+00:00 squid1 ---&gt; local_time=&quot;[31/Mar/2021:08:22:08 -0400]&quot; squid_service=explicit squid_status=TCP_MISS squid_hierarchy_status=HIER_DIRECT ** haproxy_id=- | **Flow0** src_ip=- src_port=- haproxy_ingress_ip=- haproxy_ingress_port=- | ** Flow1** haproxy_egress_ip=192.16.8.1.39 haproxy_egress_port=6079 squid_ingress_ip=192.16.8.1.36 squid_ingress_port=3128 | ** Flow2** squid_egress_ip=192.16.8.1.40 squid_egress_port=55984 dst_ip=10.51.129.182 dst_host=myhost.foo.com dst_port=443 ident_username=- username=- request_method=GET request=&quot;GET <A HREF="https://myhost.foo.com/test.js">https://myhost.foo.com/test.js</A> HTTP/1.1&quot; status_code_from_server=401 status_code_to_client=401 referer=&quot;-&quot; user_agent=&quot;git/2.7.4&quot; protocol_version=1.1 ** dns_response_time=- response_time=33 mime_type=- *XFER* total_request_size=231 total_reply_size=434 ** src_zone=CoreLab - method_category=Safe - - ** REQUEST HEADERS User-Agent=git/2.7.4 HDR_Accept=*/* HDR_Accept-Encoding=gzip HDR_Accept-Language=en-US, *;q=0.9 HDR_Pragma=no-cache HDR_Host=myhost.foo.com HDR_ *** RESPONSE HEADERS HTTP/1.1 401 Unauthorized HDR_Date=Wed, 31 Mar 2021 12:22:07 GMT HDR_%0D *** tag_returned=- tag_string=&quot;-&quot; previous_hop_mac=00:50:56:b8:03:73 peer_response_time=32 total_response_time=33 *SSL* src_ssl_negotiated_version=TLS/1.2 dst_ssl_negotiated_version=TLS/1.2 src_tls_hello_version=TLS/1.0 dst_tls_hello_version=TLS/1.2 src_tls_max_version=TLS/1.2 dst_tls_max_version=TLS/1.2 src_tls_cipher=ECDHE-RSA-AES256-GCM-SHA384 dst_tls_cipher=ECDHE-RSA-AES256-GCM-SHA384 ssl_bump=0 ssl_bump_mode=bump ssl_sni=myhost.foo.com src_cert_subject=&quot;-&quot; src_cert_issuer=&quot;-&quot; dst_cert_subject=&quot;/C=US/postalCode=12345/ST=California/L=Sunnyvale/street=123 Any Street/O=Demo, Inc./OU=None/CN=foo.com&quot; dst_cert_issuer=&quot;/C=GB/ST=Greater Manchester/L=Salford/O=Sectigo Limited/CN=Sectigo RSA Organization Validation Secure Server CA&quot; cert_errors=&quot;-&quot; *** error_page_presented=- err_detail=&quot;-&quot; rule_id=Explicit-45-Rule1.conf_2 rule_type=ALLOW XFF=&quot;-&quot; squid_dst_app=MyApp

-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20210331/073a1a75/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20210331/073a1a75/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="023501.html">[squid-users] icap adaptation chains with adaptation sets
</A></li>
	<LI>Next message (by thread): <A HREF="023505.html">[squid-users] client_delay_pools doesn't work as expected
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23504">[ date ]</a>
              <a href="thread.html#23504">[ thread ]</a>
              <a href="subject.html#23504">[ subject ]</a>
              <a href="author.html#23504">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
