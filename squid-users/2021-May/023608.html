<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] &quot;helperHandleRead: unexpected read&quot; for helper function
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20%22helperHandleRead%3A%20unexpected%20read%22%20for%20helper%0A%20function&In-Reply-To=%3C78173529-0995-0e78-5e94-8e7f17c850aa%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="023607.html">
   <LINK REL="Next"  HREF="023611.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] &quot;helperHandleRead: unexpected read&quot; for helper function</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20%22helperHandleRead%3A%20unexpected%20read%22%20for%20helper%0A%20function&In-Reply-To=%3C78173529-0995-0e78-5e94-8e7f17c850aa%40measurement-factory.com%3E"
       TITLE="[squid-users] &quot;helperHandleRead: unexpected read&quot; for helper function">rousskov at measurement-factory.com
       </A><BR>
    <I>Sat May  8 15:18:43 UTC 2021</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="023607.html">[squid-users] &quot;helperHandleRead: unexpected read&quot; for helper function
</A></li>
        <LI>Next message (by thread): <A HREF="023611.html">[squid-users] SSL BUMP
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23608">[ date ]</a>
              <a href="thread.html#23608">[ thread ]</a>
              <a href="subject.html#23608">[ subject ]</a>
              <a href="author.html#23608">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 5/7/21 10:22 PM, Justin Michael Schwartzbeck wrote:

&gt;<i> So I have written an external acl helper
</I>
&gt;<i> while(1) {
</I>&gt;<i>     string category, hostname;
</I>&gt;<i>     cin &gt;&gt; category &gt;&gt; hostname;
</I>&gt;<i>     
</I>&gt;<i>     // Perform REST API
</I>

&gt;<i> I have it all configured in my squid.conf:
</I>&gt;<i> external_acl_type host_category_helper %ACL %DST
</I>&gt;<i> /usr/local/bin/squidhelpers/host_category_helper
</I>&gt;<i> acl searchengines external host_category_helper
</I>
&gt;<i> I am seeing a million of the following lines:
</I>&gt;<i> 2021/05/08 02:04:57| helperHandleRead: unexpected read from
</I>&gt;<i> host_category_helper #Hlpr6, 4 bytes 'ERR
</I>
AFAICT, your helper does not validate its input in any way. Until you
fix that critical design flaw, you may face surprises like this even if
things appear to work in your tests. Check that each line contains the
number of fields you expect (which is 2 AFAICT) _and_ nothing else.

I suspect I know where the immediate bug is, but I think it is best if I
keep those details to myself as a motivation for you to add input
validation :-).


BTW, you should also handle input EOF, which is how Squid gracefully
terminates helpers IIRC.


&gt;<i> I saw also some snippet about concurrency being an issue, ...
</I>&gt;<i> But this doesn't make sense to me since only one helper appears to be
</I>&gt;<i> running:
</I>
In this context, concurrency is about concurrent transactions (a.k.a
requests or queries) sent to a single helper instance, not about
concurrent helper instances.

Documentation is rather vague on this point, but, AFAICT, external
helpers are assumed to lack concurrency support by default, so this
should not be an issue for your specific helper configuration. Once you
add validation, you will know for sure.

Said that, your helper does not support and silently breaks concurrent
requests.


&gt;<i> I would have assumed that each helper (there are 5
</I>&gt;<i> of them) would have their own stdin/stdout and be writing to/from it
</I>&gt;<i> rather than everyone at once. 
</I>
Your assumption is correct.


&gt;<i> you are supposed to print ERR when there is not a match, correct?
</I>
Correct.

On invalid input, respond with BH if you think your helper can recover
from that bad input. Respond with BH _and_ quit the helper otherwise.


HTH,

Alex.

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="023607.html">[squid-users] &quot;helperHandleRead: unexpected read&quot; for helper function
</A></li>
	<LI>Next message (by thread): <A HREF="023611.html">[squid-users] SSL BUMP
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23608">[ date ]</a>
              <a href="thread.html#23608">[ thread ]</a>
              <a href="subject.html#23608">[ subject ]</a>
              <a href="author.html#23608">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
