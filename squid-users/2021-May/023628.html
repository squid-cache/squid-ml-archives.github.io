<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] https_port not correctly sending ssl cert information?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20https_port%20not%20correctly%20sending%20ssl%20cert%20information%3F&In-Reply-To=%3C5942a26b-2328-4479-a807-1f3954e400b1%40www.fastmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="023613.html">
   <LINK REL="Next"  HREF="023629.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] https_port not correctly sending ssl cert information?</H1>
    <B>Dan Steen</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20https_port%20not%20correctly%20sending%20ssl%20cert%20information%3F&In-Reply-To=%3C5942a26b-2328-4479-a807-1f3954e400b1%40www.fastmail.com%3E"
       TITLE="[squid-users] https_port not correctly sending ssl cert information?">dan at mirageid.com
       </A><BR>
    <I>Tue May 11 22:06:10 UTC 2021</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="023613.html">[squid-users] [squid-announce] [ADVISORY] SQUID-2020:11 HTTP Request Smuggling
</A></li>
        <LI>Next message (by thread): <A HREF="023629.html">[squid-users] https_port not correctly sending ssl cert information?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23628">[ date ]</a>
              <a href="thread.html#23628">[ thread ]</a>
              <a href="subject.html#23628">[ subject ]</a>
              <a href="author.html#23628">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi!,

I've recently been trying to update my version of squid from 4.0.20 to something more modern (4.13), but I'm having issues with my TLS enabled proxy not returning certificates correctly (it seems).   Specifically, when I try and run the following curl (url replaced to protect the innocent):
 
curl -vvI  --proxy <A HREF="https://test.example.com:5000">https://test.example.com:5000</A> &lt;<A HREF="https://vvnncqvnjkclsuu3ctvdp5k4ck72-uupfpbnf.mirageid.com:5000/">https://vvnncqvnjkclsuu3ctvdp5k4ck72-uupfpbnf.mirageid.com:5000/</A>&gt; <A HREF="https://google.com">https://google.com</A>

I get the following result:

*   Trying 167.99.53.100:5000...
* Connected to test.example.com port 5000
* ALPN, offering http/1.1
* successfully set certificate verify locations:
*  CAfile: /etc/ssl/certs/ca-certificates.crt
*  CApath: none
* TLSv1.3 (OUT), TLS handshake, Client hello (1):
* TLSv1.3 (IN), TLS handshake, Server hello (2):
* TLSv1.3 (IN), TLS handshake, Encrypted Extensions (8):
* TLSv1.3 (IN), TLS handshake, Certificate (11):
* TLSv1.3 (OUT), TLS alert, unknown CA (560):
* SSL certificate problem: unable to get local issuer certificate
* Closing connection 0
curl: (60) SSL certificate problem: unable to get local issuer certificate

This is different then what I get for my old 4.0.20 server:

* Connected to test.example.com port 3128 (#0)
* successfully set certificate verify locations:
*  CAfile: /etc/ssl/certs/ca-certificates.crt
*  CApath: none
* TLSv1.3 (OUT), TLS handshake, Client hello (1):
* TLSv1.3 (IN), TLS handshake, Server hello (2):
* TLSv1.2 (IN), TLS handshake, Certificate (11):
* TLSv1.2 (IN), TLS handshake, Server key exchange (12):
* TLSv1.2 (IN), TLS handshake, Server finished (14):
* TLSv1.2 (OUT), TLS handshake, Client key exchange (16):
* TLSv1.2 (OUT), TLS change cipher, Change cipher spec (1):
* TLSv1.2 (OUT), TLS handshake, Finished (20):
* TLSv1.2 (IN), TLS handshake, Finished (20):
* SSL connection using TLSv1.2 / ECDHE-RSA-AES256-GCM-SHA384
* Proxy certificate:
*  subject: CN=*.example.com
*  start date: Apr  5 21:02:06 2021 GMT
*  expire date: May  7 21:02:06 2022 GMT
*  issuer: C=BE; O=GlobalSign nv-sa; CN=AlphaSSL CA - SHA256 - G2
*  SSL certificate verify ok.

But the config and certs are exactly the same!  I've pasted the config, output of squid -v, and cert information here:  <A HREF="https://gist.github.com/dansteen/c28343fd025c713bcfba8368ce2b728b">https://gist.github.com/dansteen/c28343fd025c713bcfba8368ce2b728b</A>

One difference between the two that I noticed is that the old version is compiled with --with-openssl and --enable-ssl and -enable-ssl-crtd, and the new version only has --with-gnutls.  Would that be the issue?  I appreciate the help!

Thanks!
Dan Steen

-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20210511/c0b83906/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20210511/c0b83906/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="023613.html">[squid-users] [squid-announce] [ADVISORY] SQUID-2020:11 HTTP Request Smuggling
</A></li>
	<LI>Next message (by thread): <A HREF="023629.html">[squid-users] https_port not correctly sending ssl cert information?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23628">[ date ]</a>
              <a href="thread.html#23628">[ thread ]</a>
              <a href="subject.html#23628">[ subject ]</a>
              <a href="author.html#23628">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
