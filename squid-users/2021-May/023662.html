<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] All Adaptation ICAPs go down at the same time
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20All%20Adaptation%20ICAPs%20go%20down%20at%20the%20same%20time&In-Reply-To=%3Cda23b8c7-c680-fe01-ec8b-76882e881a7d%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="023661.html">
   <LINK REL="Next"  HREF="023672.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] All Adaptation ICAPs go down at the same time</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20All%20Adaptation%20ICAPs%20go%20down%20at%20the%20same%20time&In-Reply-To=%3Cda23b8c7-c680-fe01-ec8b-76882e881a7d%40measurement-factory.com%3E"
       TITLE="[squid-users] All Adaptation ICAPs go down at the same time">rousskov at measurement-factory.com
       </A><BR>
    <I>Wed May 19 21:53:28 UTC 2021</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="023661.html">[squid-users] All Adaptation ICAPs go down at the same time
</A></li>
        <LI>Next message (by thread): <A HREF="023672.html">[squid-users] All Adaptation ICAPs go down at the same time
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23662">[ date ]</a>
              <a href="thread.html#23662">[ thread ]</a>
              <a href="subject.html#23662">[ subject ]</a>
              <a href="author.html#23662">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 5/19/21 5:31 PM, roie rachamim wrote:

&gt;<i> 2021/05/12 12:27:24.209| 93,5| AsyncJob.cc(139) callEnd:
</I>&gt;<i> AsyncJob::start() ends job [/ job31640]
</I>
To me, this looks like bug 4528:
<A HREF="https://bugs.squid-cache.org/show_bug.cgi?id=4528">https://bugs.squid-cache.org/show_bug.cgi?id=4528</A>

That bug is being fixed in PR 795:
<A HREF="https://github.com/squid-cache/squid/pull/795">https://github.com/squid-cache/squid/pull/795</A>

You might be able to patch your Squid using the corresponding patch:
<A HREF="https://github.com/squid-cache/squid/pull/795.diff">https://github.com/squid-cache/squid/pull/795.diff</A>

Testing feedback is very weclomed.


HTH,

Alex.


&gt;<i> On Mon, Apr 19, 2021 at 12:07 PM Eliezer Croitoru wrote:
</I>&gt;<i> 
</I>&gt;<i>     Hey Roie,____
</I>&gt;<i> 
</I>&gt;<i>     __&#160;__
</I>&gt;<i> 
</I>&gt;<i>     From the output I assume it&#8217;s a dns resolution issue.____
</I>&gt;<i> 
</I>&gt;<i>     In the past I remember that Docker was updating the hosts file with
</I>&gt;<i>     the relevant names but &#160;it&#8217;s not working the same way now.____
</I>&gt;<i> 
</I>&gt;<i>     Currently Docker is using a local network dns service which is being
</I>&gt;<i>     accessed via 127.0.0.53.____
</I>&gt;<i> 
</I>&gt;<i>     From I remember Squid is resolving the icap service name only at
</I>&gt;<i>     startup or reload.____
</I>&gt;<i> 
</I>&gt;<i>     Lately Alex published a testable patch that might fix specific
</I>&gt;<i>     issues with icap services which are resolved by dns. ( sorry I don&#8217;t
</I>&gt;<i>     remember the bug report)____
</I>&gt;<i> 
</I>&gt;<i>     I assume you can try to test this patch first.____
</I>&gt;<i> 
</I>&gt;<i>     If these services are static to some degree you might be able to
</I>&gt;<i>     create a script that updates the hosts file and reload squid on each
</I>&gt;<i>     change.____
</I>&gt;<i> 
</I>&gt;<i>     When using the hosts file it&#8217;s possible that some issues will
</I>&gt;<i>     disappear.____
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i>     There is also another possibility which is a malformed ICAP response
</I>&gt;<i>     or wrong sessions handling which cause this issue.____
</I>&gt;<i> 
</I>&gt;<i>     You might be able to use tcpdump from either the host or the
</I>&gt;<i>     container side to capture traffic when these goes down.____
</I>&gt;<i> 
</I>&gt;<i>     Depends on your preference of debug level you might even be able to
</I>&gt;<i>     debug specific debug_options like for ICAP services
</I>&gt;<i>     and/or requests to the degree you might be able to see what happens
</I>&gt;<i>     on the basic level of the ICAP encapsulation.____
</I>&gt;<i> 
</I>&gt;<i>     If you really need help with a diagnosis and a solution you might be
</I>&gt;<i>     able to use Alex and the measurement factory.
</I>&gt;<i> 
</I>&gt;<i>     ____
</I>&gt;<i> 
</I>&gt;<i>     All The Bests,____
</I>&gt;<i> 
</I>&gt;<i>     Eliezer____
</I>&gt;<i> 
</I>&gt;<i>     __&#160;__
</I>&gt;<i> 
</I>&gt;<i>     *From:* squid-users &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>
</I>&gt;<i>     &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>&gt;&gt; *On Behalf Of
</I>&gt;<i>     *roie rachamim
</I>&gt;<i>     *Sent:* Monday, April 12, 2021 12:54 PM
</I>&gt;<i>     *To:* <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i>     &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>&gt;
</I>&gt;<i>     *Subject:* [squid-users] All Adaptation ICAPs go down at the same
</I>&gt;<i>     time____
</I>&gt;<i> 
</I>&gt;<i>     __&#160;__
</I>&gt;<i> 
</I>&gt;<i>     Hi,____
</I>&gt;<i> 
</I>&gt;<i>     __&#160;__
</I>&gt;<i> 
</I>&gt;<i>     Our setup includes squid that runs in docker container with several
</I>&gt;<i>     ICAP servers in additional containers.____
</I>&gt;<i> 
</I>&gt;<i>     From time to time we see in cache.log the following messages:
</I>&gt;<i>     2021/04/12 00:22:39| optional ICAP service is down after an options
</I>&gt;<i>     fetch failure: <A HREF="icap://icap1.proxy:14590/censor">icap://icap1.proxy:14590/censor</A> [down,!opt]
</I>&gt;<i>     2021/04/12 00:22:39| optional ICAP service is down after an options
</I>&gt;<i>     fetch failure: <A HREF="icap://icap2.proxy:1344/request">icap://icap2.proxy:1344/request</A> [down,!opt]
</I>&gt;<i>     2021/04/12 00:22:39| optional ICAP service is down after an options
</I>&gt;<i>     fetch failure: <A HREF="icap://icap3.proxy:14590/response">icap://icap3.proxy:14590/response</A> [down,!opt]
</I>&gt;<i> 
</I>&gt;<i>     2021/04/12 06:10:45| optional ICAP service is down after an options
</I>&gt;<i>     fetch failure: <A HREF="icap://icap1.proxy:14590/censor">icap://icap1.proxy:14590/censor</A> [down,!opt]
</I>&gt;<i>     2021/04/12 06:10:45| optional ICAP service is down after an options
</I>&gt;<i>     fetch failure: <A HREF="icap://icap2.proxy:1344/request">icap://icap2.proxy:1344/request</A> [down,!opt]
</I>&gt;<i>     2021/04/12 06:10:45| optional ICAP service is down after an options
</I>&gt;<i>     fetch failure: <A HREF="icap://icap3.proxy:14590/response">icap://icap3.proxy:14590/response</A> [down,!opt]____
</I>&gt;<i> 
</I>&gt;<i>     __&#160;__
</I>&gt;<i> 
</I>&gt;<i>     We're trying to understand why it happens to all ICAPs at once. This
</I>&gt;<i>     happens in 4.14 and in 5.0.4____
</I>&gt;<i> 
</I>&gt;<i>     Any thoughts about what might cause this ?____
</I>&gt;<i> 
</I>&gt;<i>     Many Thanks,____
</I>&gt;<i> 
</I>&gt;<i>     Roie____
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i> 
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="023661.html">[squid-users] All Adaptation ICAPs go down at the same time
</A></li>
	<LI>Next message (by thread): <A HREF="023672.html">[squid-users] All Adaptation ICAPs go down at the same time
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23662">[ date ]</a>
              <a href="thread.html#23662">[ thread ]</a>
              <a href="subject.html#23662">[ subject ]</a>
              <a href="author.html#23662">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
