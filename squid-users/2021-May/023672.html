<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] All Adaptation ICAPs go down at the same time
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20All%20Adaptation%20ICAPs%20go%20down%20at%20the%20same%20time&In-Reply-To=%3CCAD%3DNrcBh%3D%2B8_qzEkUy%2BX7r_%2BpmH2CDcbEhx1_oZWer39et0Tqw%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="023662.html">
   <LINK REL="Next"  HREF="023673.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] All Adaptation ICAPs go down at the same time</H1>
    <B>roie rachamim</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20All%20Adaptation%20ICAPs%20go%20down%20at%20the%20same%20time&In-Reply-To=%3CCAD%3DNrcBh%3D%2B8_qzEkUy%2BX7r_%2BpmH2CDcbEhx1_oZWer39et0Tqw%40mail.gmail.com%3E"
       TITLE="[squid-users] All Adaptation ICAPs go down at the same time">roierachamim at gmail.com
       </A><BR>
    <I>Sun May 23 06:05:43 UTC 2021</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="023662.html">[squid-users] All Adaptation ICAPs go down at the same time
</A></li>
        <LI>Next message (by thread): <A HREF="023673.html">[squid-users] All Adaptation ICAPs go down at the same time
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23672">[ date ]</a>
              <a href="thread.html#23672">[ thread ]</a>
              <a href="subject.html#23672">[ subject ]</a>
              <a href="author.html#23672">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Alex,

Patch seems to do the trick,
When is it expected to be merged ?

Thanks,
Roie

On Thu, May 20, 2021 at 12:53 AM Alex Rousskov &lt;
<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt; wrote:

&gt;<i> On 5/19/21 5:31 PM, roie rachamim wrote:
</I>&gt;<i>
</I>&gt;<i> &gt; 2021/05/12 12:27:24.209| 93,5| AsyncJob.cc(139) callEnd:
</I>&gt;<i> &gt; AsyncJob::start() ends job [/ job31640]
</I>&gt;<i>
</I>&gt;<i> To me, this looks like bug 4528:
</I>&gt;<i> <A HREF="https://bugs.squid-cache.org/show_bug.cgi?id=4528">https://bugs.squid-cache.org/show_bug.cgi?id=4528</A>
</I>&gt;<i>
</I>&gt;<i> That bug is being fixed in PR 795:
</I>&gt;<i> <A HREF="https://github.com/squid-cache/squid/pull/795">https://github.com/squid-cache/squid/pull/795</A>
</I>&gt;<i>
</I>&gt;<i> You might be able to patch your Squid using the corresponding patch:
</I>&gt;<i> <A HREF="https://github.com/squid-cache/squid/pull/795.diff">https://github.com/squid-cache/squid/pull/795.diff</A>
</I>&gt;<i>
</I>&gt;<i> Testing feedback is very weclomed.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> HTH,
</I>&gt;<i>
</I>&gt;<i> Alex.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; On Mon, Apr 19, 2021 at 12:07 PM Eliezer Croitoru wrote:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     Hey Roie,____
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     __ __
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     From the output I assume it&#8217;s a dns resolution issue.____
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     In the past I remember that Docker was updating the hosts file with
</I>&gt;<i> &gt;     the relevant names but  it&#8217;s not working the same way now.____
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     Currently Docker is using a local network dns service which is being
</I>&gt;<i> &gt;     accessed via 127.0.0.53.____
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     From I remember Squid is resolving the icap service name only at
</I>&gt;<i> &gt;     startup or reload.____
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     Lately Alex published a testable patch that might fix specific
</I>&gt;<i> &gt;     issues with icap services which are resolved by dns. ( sorry I don&#8217;t
</I>&gt;<i> &gt;     remember the bug report)____
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     I assume you can try to test this patch first.____
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     If these services are static to some degree you might be able to
</I>&gt;<i> &gt;     create a script that updates the hosts file and reload squid on each
</I>&gt;<i> &gt;     change.____
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     When using the hosts file it&#8217;s possible that some issues will
</I>&gt;<i> &gt;     disappear.____
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     There is also another possibility which is a malformed ICAP response
</I>&gt;<i> &gt;     or wrong sessions handling which cause this issue.____
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     You might be able to use tcpdump from either the host or the
</I>&gt;<i> &gt;     container side to capture traffic when these goes down.____
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     Depends on your preference of debug level you might even be able to
</I>&gt;<i> &gt;     debug specific debug_options like for ICAP services
</I>&gt;<i> &gt;     and/or requests to the degree you might be able to see what happens
</I>&gt;<i> &gt;     on the basic level of the ICAP encapsulation.____
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     If you really need help with a diagnosis and a solution you might be
</I>&gt;<i> &gt;     able to use Alex and the measurement factory.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     ____
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     All The Bests,____
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     Eliezer____
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     __ __
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     *From:* squid-users &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>
</I>&gt;<i> &gt;     &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>&gt;&gt; *On Behalf Of
</I>&gt;<i> &gt;     *roie rachamim
</I>&gt;<i> &gt;     *Sent:* Monday, April 12, 2021 12:54 PM
</I>&gt;<i> &gt;     *To:* <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> &gt;     &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>&gt;
</I>&gt;<i> &gt;     *Subject:* [squid-users] All Adaptation ICAPs go down at the same
</I>&gt;<i> &gt;     time____
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     __ __
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     Hi,____
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     __ __
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     Our setup includes squid that runs in docker container with several
</I>&gt;<i> &gt;     ICAP servers in additional containers.____
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     From time to time we see in cache.log the following messages:
</I>&gt;<i> &gt;     2021/04/12 00:22:39| optional ICAP service is down after an options
</I>&gt;<i> &gt;     fetch failure: <A HREF="icap://icap1.proxy:14590/censor">icap://icap1.proxy:14590/censor</A> [down,!opt]
</I>&gt;<i> &gt;     2021/04/12 00:22:39| optional ICAP service is down after an options
</I>&gt;<i> &gt;     fetch failure: <A HREF="icap://icap2.proxy:1344/request">icap://icap2.proxy:1344/request</A> [down,!opt]
</I>&gt;<i> &gt;     2021/04/12 00:22:39| optional ICAP service is down after an options
</I>&gt;<i> &gt;     fetch failure: <A HREF="icap://icap3.proxy:14590/response">icap://icap3.proxy:14590/response</A> [down,!opt]
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     2021/04/12 06:10:45| optional ICAP service is down after an options
</I>&gt;<i> &gt;     fetch failure: <A HREF="icap://icap1.proxy:14590/censor">icap://icap1.proxy:14590/censor</A> [down,!opt]
</I>&gt;<i> &gt;     2021/04/12 06:10:45| optional ICAP service is down after an options
</I>&gt;<i> &gt;     fetch failure: <A HREF="icap://icap2.proxy:1344/request">icap://icap2.proxy:1344/request</A> [down,!opt]
</I>&gt;<i> &gt;     2021/04/12 06:10:45| optional ICAP service is down after an options
</I>&gt;<i> &gt;     fetch failure: <A HREF="icap://icap3.proxy:14590/response">icap://icap3.proxy:14590/response</A> [down,!opt]____
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     __ __
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     We're trying to understand why it happens to all ICAPs at once. This
</I>&gt;<i> &gt;     happens in 4.14 and in 5.0.4____
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     Any thoughts about what might cause this ?____
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     Many Thanks,____
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     Roie____
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; _______________________________________________
</I>&gt;<i> &gt; squid-users mailing list
</I>&gt;<i> &gt; <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> &gt; <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i> &gt;
</I>&gt;<i>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20210523/907b8549/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20210523/907b8549/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="023662.html">[squid-users] All Adaptation ICAPs go down at the same time
</A></li>
	<LI>Next message (by thread): <A HREF="023673.html">[squid-users] All Adaptation ICAPs go down at the same time
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23672">[ date ]</a>
              <a href="thread.html#23672">[ thread ]</a>
              <a href="subject.html#23672">[ subject ]</a>
              <a href="author.html#23672">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
