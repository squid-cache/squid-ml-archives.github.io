<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] allow request to cloudfront after 302 redirection.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20allow%20request%20to%20cloudfront%20after%20302%20redirection.&In-Reply-To=%3C000001d75082%24741961b0%245c4c2510%24%40gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="023700.html">
   <LINK REL="Next"  HREF="023675.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] allow request to cloudfront after 302 redirection.</H1>
    <B>Eliezer Croitoru</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20allow%20request%20to%20cloudfront%20after%20302%20redirection.&In-Reply-To=%3C000001d75082%24741961b0%245c4c2510%24%40gmail.com%3E"
       TITLE="[squid-users] allow request to cloudfront after 302 redirection.">ngtech1ltd at gmail.com
       </A><BR>
    <I>Mon May 24 09:52:04 UTC 2021</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="023700.html">[squid-users] Caching configuration for Squid on Windows
</A></li>
        <LI>Next message (by thread): <A HREF="023675.html">[squid-users] allow request to cloudfront after 302 redirection.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23674">[ date ]</a>
              <a href="thread.html#23674">[ thread ]</a>
              <a href="subject.html#23674">[ subject ]</a>
              <a href="author.html#23674">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hey Alex,

Following up this thread I was wondering about an example how to do that with an external_acl helper.
With ICAP I can do that easily to some degree.
With an external_acl helper I am not sure what values to send.
I would guess that the response code and response Location header might be the ones which should be passed to the helper?

What do you think about the next acls, should do the trick?(code to be followed)

acl redirect http_status 301-308
acl gitlab_package dstdomain package.gitlab.com

external_acl_type openlocation children=15 %DST %SRC %&lt;{Location} /usr/local/bin/location-openner.rb
acl location_openner external openlocation
http_access deny gitlab_package redirect location_openner
http_access allow location_openner


Thanks,
----
Eliezer Croitoru
Tech Support
Mobile: +972-5-28704261
Email: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">ngtech1ltd at gmail.com</A>


-----Original Message-----
From: squid-users &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>&gt; On Behalf Of Alex Rousskov
Sent: Wednesday, April 21, 2021 8:49 PM
To: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
Subject: Re: [squid-users] allow request to cloudfront after 302 redirection.

On 4/21/21 12:48 PM, Miroslaw Malinowski wrote:
&gt;<i> Is it possible to create a whitelist that allows cloudfront 302
</I>&gt;<i> redirections, e.g. gitlab is using cloudfront as CDN and when we
</I>&gt;<i> whitelist package.gitlab.com the URL is redirected (302) to
</I>&gt;<i> <A HREF="https://d20rj4el6vkp4c.cloudfront.net/7/11/ubuntu/package_files/35938.deb?t=1619023239_a63698472b6bebeaee980e7c030632d97a29c15d">https://d20rj4el6vkp4c.cloudfront.net/7/11/ubuntu/package_files/35938.deb?t=1619023239_a63698472b6bebeaee980e7c030632d97a29c15d</A>
</I>

Yes, it is possible to allow future requests to Location-listed URLs,
but since we are talking about two (or more) independent HTTP
transactions, on two (or more) TCP connections, you will need to store
the allowed Location values (at least) somewhere, maintain that storage
(e.g., remove stale entries), and (optionally) determine whether the
request for an allowed cloudfront URL came from the same user agent as
the gitlab request that was redirected to that URL.

Storing, maintenance, and checking of allowed Locations/etc. can be done
using external ACLs and/or eCAP/ICAP adaptation services. It cannot be
reliably done using built-in ACLs alone AFAICT.


HTH,

Alex.


&gt;<i> I could whitelist a whole .cloudfront.net &lt;<A HREF="http://cloudfront.net">http://cloudfront.net</A>&gt; domain
</I>&gt;<i> or url_regex, but what I would like to achieve, I don't know if
</I>&gt;<i> possible, is a chain of events like:
</I>&gt;<i> If packages.gitlab.com &lt;<A HREF="http://packages.gitlab.com">http://packages.gitlab.com</A>&gt; return 302 Location
</I>&gt;<i> .cloudfront, then allow
</I>&gt;<i> <A HREF="https://d20rj4el6vkp4c.cloudfront.net/7/11/ubuntu/package_files/35938.deb?t=1619023239_a63698472b6bebeaee980e7c030632d97a29c">https://d20rj4el6vkp4c.cloudfront.net/7/11/ubuntu/package_files/35938.deb?t=1619023239_a63698472b6bebeaee980e7c030632d97a29c</A>
</I>&gt;<i> &lt;<A HREF="https://d20rj4el6vkp4c.cloudfront.net/7/11/ubuntu/package_files/35938.deb?t=1619023239_a63698472b6bebeaee980e7c030632d97a29c">https://d20rj4el6vkp4c.cloudfront.net/7/11/ubuntu/package_files/35938.deb?t=1619023239_a63698472b6bebeaee980e7c030632d97a29c</A>&gt;
</I>&gt;<i> request.
</I>&gt;<i> I've been playing around with http_reply_access and rep_headers, but I
</I>&gt;<i> can only go as far as allow replay of the first request to
</I>&gt;<i> package.gitlab.com &lt;<A HREF="http://package.gitlab.com">http://package.gitlab.com</A>&gt;, but then a GET to
</I>&gt;<i> cloudfront is blocked anyway as it's not on our whitelist.
</I>&gt;<i> e.g.
</I>&gt;<i> 1619022938.916   423 172.16.230.237 NONE/200 0 CONNECT 54.153.54.194:443
</I>&gt;<i> &lt;<A HREF="http://54.153.54.194:443">http://54.153.54.194:443</A>&gt; - ORIGINAL_DST/54.153.54.194
</I>&gt;<i> &lt;<A HREF="http://54.153.54.194">http://54.153.54.194</A>&gt; -
</I>&gt;<i> 1619022939.074   153 172.16.230.237 TCP_MISS/302 758 GET
</I>&gt;<i> <A HREF="https://packages.gitlab.com/gitlab/gitlab-ee/packages/ubuntu/bionic/gitlab-ee_11.0.1-ee.0_amd64.deb/download.deb">https://packages.gitlab.com/gitlab/gitlab-ee/packages/ubuntu/bionic/gitlab-ee_11.0.1-ee.0_amd64.deb/download.deb</A>
</I>&gt;<i> &lt;<A HREF="https://packages.gitlab.com/gitlab/gitlab-ee/packages/ubuntu/bionic/gitlab-ee_11.0.1-ee.0_amd64.deb/download.deb">https://packages.gitlab.com/gitlab/gitlab-ee/packages/ubuntu/bionic/gitlab-ee_11.0.1-ee.0_amd64.deb/download.deb</A>&gt;
</I>&gt;<i> - ORIGINAL_DST/54.153.54.194 &lt;<A HREF="http://54.153.54.194">http://54.153.54.194</A>&gt; text/html
</I>&gt;<i> 1619022939.108    20 172.16.230.237 NONE/200 0 CONNECT 52.84.90.34:443
</I>&gt;<i> &lt;<A HREF="http://52.84.90.34:443">http://52.84.90.34:443</A>&gt; - ORIGINAL_DST/52.84.90.34 &lt;<A HREF="http://52.84.90.34">http://52.84.90.34</A>&gt; -
</I>&gt;<i> 1619022939.114     2 172.16.230.237 TCP_DENIED/403 19053 GET
</I>&gt;<i> <A HREF="https://d20rj4el6vkp4c.cloudfront.net/7/11/ubuntu/package_files/35938.deb">https://d20rj4el6vkp4c.cloudfront.net/7/11/ubuntu/package_files/35938.deb</A> &lt;<A HREF="https://d20rj4el6vkp4c.cloudfront.net/7/11/ubuntu/package_files/35938.deb">https://d20rj4el6vkp4c.cloudfront.net/7/11/ubuntu/package_files/35938.deb</A>&gt;?
</I>&gt;<i> - HIER_NONE/- text/html
</I>
_______________________________________________
squid-users mailing list
<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
<A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="023700.html">[squid-users] Caching configuration for Squid on Windows
</A></li>
	<LI>Next message (by thread): <A HREF="023675.html">[squid-users] allow request to cloudfront after 302 redirection.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23674">[ date ]</a>
              <a href="thread.html#23674">[ thread ]</a>
              <a href="subject.html#23674">[ subject ]</a>
              <a href="author.html#23674">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
