<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] allow request to cloudfront after 302 redirection.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20allow%20request%20to%20cloudfront%20after%20302%20redirection.&In-Reply-To=%3C002201d752f2%242367afc0%246a370f40%24%40gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="023675.html">
   <LINK REL="Next"  HREF="023676.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] allow request to cloudfront after 302 redirection.</H1>
    <B>Eliezer Croitoru</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20allow%20request%20to%20cloudfront%20after%20302%20redirection.&In-Reply-To=%3C002201d752f2%242367afc0%246a370f40%24%40gmail.com%3E"
       TITLE="[squid-users] allow request to cloudfront after 302 redirection.">ngtech1ltd at gmail.com
       </A><BR>
    <I>Thu May 27 12:16:34 UTC 2021</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="023675.html">[squid-users] allow request to cloudfront after 302 redirection.
</A></li>
        <LI>Next message (by thread): <A HREF="023676.html">[squid-users] manual proxy configuration ...
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23710">[ date ]</a>
              <a href="thread.html#23710">[ thread ]</a>
              <a href="subject.html#23710">[ subject ]</a>
              <a href="author.html#23710">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Thanks Alex,

I assume you do remember that 301 is not the same as 302.
Depends on the status code ie 301/302 307/307 etc the ttl of the cached location would be decides.
The basic idea is to use either redis or memcached  on another key-value DB to persist the Location response.
(This key-value DB would only be a &quot;cache&quot; with a ttl)

For a 301 the basic assumption is that the Location header contains the static/permanent redirection.
For a 302 it's not a static, I think it's important to have the status code sent to the helper.

About the http_reply_access, I actually forgot it exists and indeed it makes more sense...

I am working on an example.
Eliezer

-----Original Message-----
From: squid-users &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>&gt; On Behalf Of Alex Rousskov
Sent: Monday, May 24, 2021 9:26 PM
To: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
Subject: Re: [squid-users] allow request to cloudfront after 302 redirection.

On 5/24/21 5:52 AM, Eliezer Croitoru wrote:

&gt;<i> Following up this thread I was wondering about an example how to do
</I>&gt;<i> that with an external_acl helper. With ICAP I can do that easily to
</I>&gt;<i> some degree. With an external_acl helper I am not sure what values to
</I>&gt;<i> send.
</I>
AFAICT, the external ACL helper(s) should be sent the Location URI
values the helper(s) should cache (at response time) and the request URI
values the helper(s) should examine (at request time). More information
may be sent/cached, of course, depending on the exact decision logic.


&gt;<i> I would guess that the response code and response Location header
</I>&gt;<i> might be the ones which should be passed to the helper?
</I>
I do not see the value in sending the response status code (because
Squid can check that itself), but the correct answer depends on the
exact decision logic.


&gt;<i> What do you think about the next acls, should do the trick?
</I>
&gt;<i> acl redirect http_status 301-308
</I>&gt;<i> acl gitlab_package dstdomain package.gitlab.com
</I>
&gt;<i> external_acl_type openlocation children=15 %DST %SRC %&lt;{Location} /usr/local/bin/location-openner.rb
</I>&gt;<i> acl location_openner external openlocation
</I>&gt;<i> http_access deny gitlab_package redirect location_openner
</I>&gt;<i> http_access allow location_openner
</I>
The above sketch does not make sense to me because it uses response
information (e.g., %&lt;h{Location}) in a request-time directive (i.e.
http_access). FWIW, I would expect something along these lines:

  http_access allow toPreviouslySeenLocation

  http_reply_access allow isRedirect storeSeenLocation
  http_reply_access allow all

... where toPreviouslySeenLocation and storeSeenLocation are external
ACLs (using one shared or two dedicated external ACL helpers).
storeSeenLocation always matches and is used for its side effect.


HTH,

Alex.


&gt;<i> -----Original Message-----
</I>&gt;<i> From: squid-users &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>&gt; On Behalf Of Alex Rousskov
</I>&gt;<i> Sent: Wednesday, April 21, 2021 8:49 PM
</I>&gt;<i> To: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> Subject: Re: [squid-users] allow request to cloudfront after 302 redirection.
</I>&gt;<i> 
</I>&gt;<i> On 4/21/21 12:48 PM, Miroslaw Malinowski wrote:
</I>&gt;&gt;<i> Is it possible to create a whitelist that allows cloudfront 302
</I>&gt;&gt;<i> redirections, e.g. gitlab is using cloudfront as CDN and when we
</I>&gt;&gt;<i> whitelist package.gitlab.com the URL is redirected (302) to
</I>&gt;&gt;<i> <A HREF="https://d20rj4el6vkp4c.cloudfront.net/7/11/ubuntu/package_files/35938.deb?t=1619023239_a63698472b6bebeaee980e7c030632d97a29c15d">https://d20rj4el6vkp4c.cloudfront.net/7/11/ubuntu/package_files/35938.deb?t=1619023239_a63698472b6bebeaee980e7c030632d97a29c15d</A>
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Yes, it is possible to allow future requests to Location-listed URLs,
</I>&gt;<i> but since we are talking about two (or more) independent HTTP
</I>&gt;<i> transactions, on two (or more) TCP connections, you will need to store
</I>&gt;<i> the allowed Location values (at least) somewhere, maintain that storage
</I>&gt;<i> (e.g., remove stale entries), and (optionally) determine whether the
</I>&gt;<i> request for an allowed cloudfront URL came from the same user agent as
</I>&gt;<i> the gitlab request that was redirected to that URL.
</I>&gt;<i> 
</I>&gt;<i> Storing, maintenance, and checking of allowed Locations/etc. can be done
</I>&gt;<i> using external ACLs and/or eCAP/ICAP adaptation services. It cannot be
</I>&gt;<i> reliably done using built-in ACLs alone AFAICT.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> HTH,
</I>&gt;<i> 
</I>&gt;<i> Alex.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> I could whitelist a whole .cloudfront.net &lt;<A HREF="http://cloudfront.net">http://cloudfront.net</A>&gt; domain
</I>&gt;&gt;<i> or url_regex, but what I would like to achieve, I don't know if
</I>&gt;&gt;<i> possible, is a chain of events like:
</I>&gt;&gt;<i> If packages.gitlab.com &lt;<A HREF="http://packages.gitlab.com">http://packages.gitlab.com</A>&gt; return 302 Location
</I>&gt;&gt;<i> .cloudfront, then allow
</I>&gt;&gt;<i> <A HREF="https://d20rj4el6vkp4c.cloudfront.net/7/11/ubuntu/package_files/35938.deb?t=1619023239_a63698472b6bebeaee980e7c030632d97a29c">https://d20rj4el6vkp4c.cloudfront.net/7/11/ubuntu/package_files/35938.deb?t=1619023239_a63698472b6bebeaee980e7c030632d97a29c</A>
</I>&gt;&gt;<i> &lt;<A HREF="https://d20rj4el6vkp4c.cloudfront.net/7/11/ubuntu/package_files/35938.deb?t=1619023239_a63698472b6bebeaee980e7c030632d97a29c">https://d20rj4el6vkp4c.cloudfront.net/7/11/ubuntu/package_files/35938.deb?t=1619023239_a63698472b6bebeaee980e7c030632d97a29c</A>&gt;
</I>&gt;&gt;<i> request.
</I>&gt;&gt;<i> I've been playing around with http_reply_access and rep_headers, but I
</I>&gt;&gt;<i> can only go as far as allow replay of the first request to
</I>&gt;&gt;<i> package.gitlab.com &lt;<A HREF="http://package.gitlab.com">http://package.gitlab.com</A>&gt;, but then a GET to
</I>&gt;&gt;<i> cloudfront is blocked anyway as it's not on our whitelist.
</I>&gt;&gt;<i> e.g.
</I>&gt;&gt;<i> 1619022938.916   423 172.16.230.237 NONE/200 0 CONNECT 54.153.54.194:443
</I>&gt;&gt;<i> &lt;<A HREF="http://54.153.54.194:443">http://54.153.54.194:443</A>&gt; - ORIGINAL_DST/54.153.54.194
</I>&gt;&gt;<i> &lt;<A HREF="http://54.153.54.194">http://54.153.54.194</A>&gt; -
</I>&gt;&gt;<i> 1619022939.074   153 172.16.230.237 TCP_MISS/302 758 GET
</I>&gt;&gt;<i> <A HREF="https://packages.gitlab.com/gitlab/gitlab-ee/packages/ubuntu/bionic/gitlab-ee_11.0.1-ee.0_amd64.deb/download.deb">https://packages.gitlab.com/gitlab/gitlab-ee/packages/ubuntu/bionic/gitlab-ee_11.0.1-ee.0_amd64.deb/download.deb</A>
</I>&gt;&gt;<i> &lt;<A HREF="https://packages.gitlab.com/gitlab/gitlab-ee/packages/ubuntu/bionic/gitlab-ee_11.0.1-ee.0_amd64.deb/download.deb">https://packages.gitlab.com/gitlab/gitlab-ee/packages/ubuntu/bionic/gitlab-ee_11.0.1-ee.0_amd64.deb/download.deb</A>&gt;
</I>&gt;&gt;<i> - ORIGINAL_DST/54.153.54.194 &lt;<A HREF="http://54.153.54.194">http://54.153.54.194</A>&gt; text/html
</I>&gt;&gt;<i> 1619022939.108    20 172.16.230.237 NONE/200 0 CONNECT 52.84.90.34:443
</I>&gt;&gt;<i> &lt;<A HREF="http://52.84.90.34:443">http://52.84.90.34:443</A>&gt; - ORIGINAL_DST/52.84.90.34 &lt;<A HREF="http://52.84.90.34">http://52.84.90.34</A>&gt; -
</I>&gt;&gt;<i> 1619022939.114     2 172.16.230.237 TCP_DENIED/403 19053 GET
</I>&gt;&gt;<i> <A HREF="https://d20rj4el6vkp4c.cloudfront.net/7/11/ubuntu/package_files/35938.deb">https://d20rj4el6vkp4c.cloudfront.net/7/11/ubuntu/package_files/35938.deb</A> &lt;<A HREF="https://d20rj4el6vkp4c.cloudfront.net/7/11/ubuntu/package_files/35938.deb">https://d20rj4el6vkp4c.cloudfront.net/7/11/ubuntu/package_files/35938.deb</A>&gt;?
</I>&gt;&gt;<i> - HIER_NONE/- text/html
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i> 
</I>
_______________________________________________
squid-users mailing list
<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
<A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="023675.html">[squid-users] allow request to cloudfront after 302 redirection.
</A></li>
	<LI>Next message (by thread): <A HREF="023676.html">[squid-users] manual proxy configuration ...
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#23710">[ date ]</a>
              <a href="thread.html#23710">[ thread ]</a>
              <a href="subject.html#23710">[ subject ]</a>
              <a href="author.html#23710">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
