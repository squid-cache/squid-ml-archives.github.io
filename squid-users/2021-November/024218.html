<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid 5.2 Peer parent TCP connection to x.x.x.x/x failed
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%205.2%20Peer%20parent%20TCP%20connection%20to%20x.x.x.x/x%0A%20failed&In-Reply-To=%3C5ae7df68-711b-3733-77df-a0bb8f76dfee%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="024217.html">
   <LINK REL="Next"  HREF="024215.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid 5.2 Peer parent TCP connection to x.x.x.x/x failed</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%205.2%20Peer%20parent%20TCP%20connection%20to%20x.x.x.x/x%0A%20failed&In-Reply-To=%3C5ae7df68-711b-3733-77df-a0bb8f76dfee%40measurement-factory.com%3E"
       TITLE="[squid-users] Squid 5.2 Peer parent TCP connection to x.x.x.x/x failed">rousskov at measurement-factory.com
       </A><BR>
    <I>Tue Nov  2 18:24:26 UTC 2021</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="024217.html">[squid-users] Squid 5.2 Peer parent TCP connection to x.x.x.x/x failed
</A></li>
        <LI>Next message (by thread): <A HREF="024215.html">[squid-users] ftp_port and squidclamav
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24218">[ date ]</a>
              <a href="thread.html#24218">[ thread ]</a>
              <a href="subject.html#24218">[ subject ]</a>
              <a href="author.html#24218">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 11/2/21 12:28 PM, David Touzeau wrote:
&gt;<i> Ok, we will investigate on the Parent Proxy but it seems that when squid
</I>&gt;<i> child claim about TCP failed, it understand that the peer is dead
</I>
Yes, that is the side effect of the deficiency I was talking about --
Squid inability to recognize that specific error response from the
(indirect) parent Squid as something completely unrelated to the TCP
connection to the next hop (and to the responding parent Squid ability
to serve traffic in general). There are quite a few things that could be
improved here for your and similar use cases.

Alex.


&gt;<i> Le 02/11/2021 &#224; 16:17, Alex Rousskov a &#233;crit&#160;:
</I>&gt;&gt;<i> On 11/2/21 10:40 AM, David Touzeau wrote:
</I>&gt;&gt;&gt;<i> 2021/11/01 16:50:48.787 kid1| 93,3| Http::Tunneler::handleReadyRead(conn9812727 local=127.0.0.1:23408 remote=127.0.0.1:2320 FIRSTUP_PARENT)
</I>&gt;&gt;&gt;<i> 2021/11/01 16:50:48.787 kid1| 74,5| parse: status-line: proto HTTP/1.1
</I>&gt;&gt;&gt;<i> 2021/11/01 16:50:48.787 kid1| 74,5| parse: status-line: status-code 503
</I>&gt;&gt;&gt;<i> 2021/11/01 16:50:48.787 kid1| 74,5| parse: status-line: reason-phrase Service Unavailable
</I>&gt;&gt;&gt;<i> Server: squid
</I>&gt;&gt;&gt;<i> Date: Mon, 01 Nov 2021 15:50:48 GMT
</I>&gt;&gt;&gt;<i> X-Squid-Error: ERR_CONNECT_FAIL 110
</I>&gt;&gt;&gt;<i> 2021/11/01 16:50:48.787 kid1| 83,3| bailOnResponseError: unsupported CONNECT response status code
</I>&gt;&gt;&gt;<i> 2021/11/01 16:50:48.787 kid1| TCP connection to 127.0.0.1/2320 failed
</I>&gt;&gt;<i> A parent[^1] proxy is a Squid proxy that cannot connect to the server in
</I>&gt;&gt;<i> question. That Squid proxy responds with an HTTP 503 Error to your Squid
</I>&gt;&gt;<i> CONNECT request. Your Squid logs the &quot;TCP connection to ... failed&quot;
</I>&gt;&gt;<i> error that you were wondering about.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> This sequence highlights a deficiency in Squid CONNECT error handling
</I>&gt;&gt;<i> code (and possibly cache_peer configuration abilities). Ideally, Squid
</I>&gt;&gt;<i> should recognize Squid error responses coming from a parent HTTP proxy
</I>&gt;&gt;<i> and avoid complaining about remote Squid-origin errors as if they are
</I>&gt;&gt;<i> local Squid-parent errors. IIRC, some folks still insist on Squid
</I>&gt;&gt;<i> complaining about the latter &quot;within hierarchy&quot; errors, but the former
</I>&gt;&gt;<i> &quot;external Squid-origin&quot; errors are definitely not supposed to be
</I>&gt;&gt;<i> reported to admins via level-0/1 messages in cache.log.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> HTH,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Alex.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> [^1]: Direct or indirect parent -- I could not tell quickly but you
</I>&gt;&gt;<i> should be able to tell by looking at addresses, configurations, and/or
</I>&gt;&gt;<i> access logs. My bet is that it is an indirect parent if you are still
</I>&gt;&gt;<i> using a load balancer between Squids.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Le 01/11/2021 &#224; 15:53, Alex Rousskov a &#233;crit&#160;:
</I>&gt;&gt;&gt;&gt;<i> On 11/1/21 7:55 AM, David Touzeau wrote:
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> The Squid uses the loopback as a parent.
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> The same problem occurs:
</I>&gt;&gt;&gt;&gt;&gt;<i> 06:19:47 kid1| TCP connection to 127.0.0.1/2320 failed
</I>&gt;&gt;&gt;&gt;&gt;<i> 06:15:13 kid1| TCP connection to 127.0.0.1/2320 failed
</I>&gt;&gt;&gt;&gt;&gt;<i> 06:14:41 kid1| TCP connection to 127.0.0.1/2320 failed
</I>&gt;&gt;&gt;&gt;&gt;<i> 06:14:38 kid1| TCP connection to 127.0.0.1/2320 failed
</I>&gt;&gt;&gt;&gt;&gt;<i> 06:13:15 kid1| TCP connection to 127.0.0.1/2320 failed
</I>&gt;&gt;&gt;&gt;&gt;<i> 06:11:23 kid1| TCP connection to 127.0.0.1/2320 failed
</I>&gt;&gt;&gt;&gt;&gt;<i> cache_peer 127.0.0.1 parent 2320 0 name=Peer11 no-query default
</I>&gt;&gt;&gt;&gt;&gt;<i> connect-timeout=3 connect-fail-limit=5 no-tproxy
</I>&gt;&gt;&gt;&gt;<i> It is impossible to tell for sure what is going on because Squid does
</I>&gt;&gt;&gt;&gt;<i> not (unfortunately; yet) report the exact reason behind these connection
</I>&gt;&gt;&gt;&gt;<i> establishment failures or even the context in which a failure has
</I>&gt;&gt;&gt;&gt;<i> occurred. You may be able to tell more by collecting/analyzing packet
</I>&gt;&gt;&gt;&gt;<i> captures. Developers may be able to tell more if you share, say, ALL,5
</I>&gt;&gt;&gt;&gt;<i> debugging logs that show what led to the failure report.
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> Alex.
</I>&gt;<i> 
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="024217.html">[squid-users] Squid 5.2 Peer parent TCP connection to x.x.x.x/x failed
</A></li>
	<LI>Next message (by thread): <A HREF="024215.html">[squid-users] ftp_port and squidclamav
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24218">[ date ]</a>
              <a href="thread.html#24218">[ thread ]</a>
              <a href="subject.html#24218">[ subject ]</a>
              <a href="author.html#24218">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
