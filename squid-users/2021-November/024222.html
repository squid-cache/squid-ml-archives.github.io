<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] acl / format code evaluation
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20acl%20/%20format%20code%20evaluation&In-Reply-To=%3Cf2321709-eb45-9a58-50c6-55d0bcb7f6e8%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="024221.html">
   <LINK REL="Next"  HREF="024223.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] acl / format code evaluation</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20acl%20/%20format%20code%20evaluation&In-Reply-To=%3Cf2321709-eb45-9a58-50c6-55d0bcb7f6e8%40treenet.co.nz%3E"
       TITLE="[squid-users] acl / format code evaluation">squid3 at treenet.co.nz
       </A><BR>
    <I>Fri Nov  5 08:53:54 UTC 2021</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="024221.html">[squid-users] acl / format code evaluation
</A></li>
        <LI>Next message (by thread): <A HREF="024223.html">[squid-users] acl / format code evaluation
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24222">[ date ]</a>
              <a href="thread.html#24222">[ thread ]</a>
              <a href="subject.html#24222">[ subject ]</a>
              <a href="author.html#24222">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 5/11/21 04:14, Jason Spashett wrote:
&gt;<i> Hello,
</I>&gt;<i> 
</I>&gt;<i> I am using squid 5, and after reading the following I have attempted
</I>&gt;<i> to link the connect requests to the other requests within a TLS
</I>&gt;<i> tunnel.
</I>&gt;<i> 
</I>&gt;<i> Can anyone tell me why this isn't working, and or when the log format
</I>&gt;<i> codes get evaluated.
</I>
The logformat %macros get expanded any time Squid needs to use the 
format string containing them.


For your config snippet below



That means usually;
  - helper queries at several points processing each request/transaction,
  - each time those ACLs of yours are *checked*,
  - log outputs when each request finishes, and
  - deny_info URL generation for redirection.


&gt;<i> 
</I>&gt;<i> Squid configuration
</I>&gt;<i> -------------------
</I>&gt;<i> #
</I>&gt;<i> acl connection_id_acl annotate_client conn_id+=&quot;%master_xaction/%random&quot;
</I>&gt;<i> acl has_conn_id_acl note conn_id
</I>&gt;<i> acl set_conn_id_once_acl any-of has_conn_id_acl connection_id_acl
</I>&gt;<i> note &quot;&quot; &quot;&quot; set_conn_id_once_acl
</I>&gt;<i> #
</I>&gt;<i> logformat log time=&quot;%tl&quot; conn_id=%{conn_id}note request_type=%&gt;rm url=%&gt;ru
</I>&gt;<i> 
</I>&gt;<i> log output
</I>&gt;<i> ----------
</I>&gt;<i> time=&quot;04/Nov/2021:14:54:19 +0000&quot; conn_id=2550/Fh0Lje1
</I>&gt;<i> request_type=CONNECT url=blog.jason.spashett.com:443
</I>&gt;<i> time=&quot;04/Nov/2021:14:54:19 +0000&quot; conn_id=2550/e5sVhqi
</I>&gt;<i> request_type=GET
</I>&gt;<i> url=<A HREF="https://blog.jason.spashett.com/minecraft-4k-ported-to-the-d-programming-language/">https://blog.jason.spashett.com/minecraft-4k-ported-to-the-d-programming-language/</A>
</I>&gt;<i> time=&quot;04/Nov/2021:14:54:20 +0000&quot; conn_id=2550/e5sVhqi
</I>&gt;<i> request_type=GET url=<A HREF="https://blog.jason.spashett.com/css/main.css">https://blog.jason.spashett.com/css/main.css</A>
</I>
This looks like its working to me.

  &quot;2550/&quot; is the TCP connection being handled.

  &quot;2550/Fh0Lje1&quot; is the CONNECT received via TCP.

  &quot;2550/e5sVhqi&quot; are the requests decoded from inside the CONNECT tunnel.


The problem you have is that the CONNECT request ceases to exist at the 
point it is accepted to be decrypted. The TLS handshake takes time - so 
the conn_id %random value you assigned to that CONNECT is long gone by 
the time the decrypted requests are received. We have several bugs open 
about this situation, but my fix has got stuck with QA rejections from 
other team memmbers.

Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="024221.html">[squid-users] acl / format code evaluation
</A></li>
	<LI>Next message (by thread): <A HREF="024223.html">[squid-users] acl / format code evaluation
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24222">[ date ]</a>
              <a href="thread.html#24222">[ thread ]</a>
              <a href="subject.html#24222">[ subject ]</a>
              <a href="author.html#24222">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
