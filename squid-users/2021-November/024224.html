<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] acl / format code evaluation
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20acl%20/%20format%20code%20evaluation&In-Reply-To=%3Cd84a6f32-f740-57c9-0180-8bc26251ede1%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="024223.html">
   <LINK REL="Next"  HREF="024225.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] acl / format code evaluation</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20acl%20/%20format%20code%20evaluation&In-Reply-To=%3Cd84a6f32-f740-57c9-0180-8bc26251ede1%40measurement-factory.com%3E"
       TITLE="[squid-users] acl / format code evaluation">rousskov at measurement-factory.com
       </A><BR>
    <I>Fri Nov  5 14:35:21 UTC 2021</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="024223.html">[squid-users] acl / format code evaluation
</A></li>
        <LI>Next message (by thread): <A HREF="024225.html">[squid-users] acl / format code evaluation
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24224">[ date ]</a>
              <a href="thread.html#24224">[ thread ]</a>
              <a href="subject.html#24224">[ subject ]</a>
              <a href="author.html#24224">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 11/4/21 11:14 AM, Jason Spashett wrote:

&gt;<i> I am using squid 5, and after reading the following I have attempted
</I>&gt;<i> to link the connect requests to the other requests within a TLS
</I>&gt;<i> tunnel.
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/pipermail/squid-users/2021-April/023526.html">http://lists.squid-cache.org/pipermail/squid-users/2021-April/023526.html</A>
</I>
&gt;<i> I added an extra log format code to squid 5, called %random, which
</I>&gt;<i> always returns a random string, in the hopes of using this to stamp
</I>&gt;<i> against log entries to tie them together.
</I>
It is difficult for me to imagine the right use case for identifying
clients with random strings, especially if you are adding new %codes:

* If you want uniqueness within a Squid kid, then you should use a
simple ever-increasing counter, not a random string.

* If you want uniqueness across kids, processes, and instances, then you
probably need a UUID, not just a random string.


&gt;<i> The squid configuration follows, this seems to partially work in that
</I>&gt;<i> the requests in the tunnel have the same conn_id, but the connect
</I>&gt;<i> request itself has a different one, which leads me to to believe that
</I>&gt;<i> the format code is being evaluated twice in that case perhaps.
</I>
Bugs notwithstanding, Squid applies the note directive once for every
client transaction. That includes one or more CONNECT transactions and
each GET/POST/etc. transaction inside the bumped CONNECT tunnel. Squid
applies the note directive at the end of the client transaction
lifetime. The resulting annotations may be logged (via %note) when/if
the transaction is logged.


&gt;<i> Note that I added %master_xaction to the log too, to see if that
</I>&gt;<i> worked, and it does, but it's not particularly practical on it's own
</I>&gt;<i> due to the problem of it not being unique enough.
</I>
Whether it is unique enough depends on the desired uniqueness scope. I
bet that, strictly speaking, it is no less unique than your current
%random algorithm!

The first CONNECT request on a TCP connection should have a unique
master transaction ID compared to all other CONNECT requests on other
TCP connections accepted by the same kid process. That is exactly what
you need if you need per-process uniqueness. If you need a larger
uniqueness scope, then you probably need to use UUIDs.


&gt;<i> Can anyone tell me why this isn't working,
</I>
I am not sure at all, but it could be a Squid bug related to how client
annotations are propagated across CONNECT and in-tunnel requests. I am
also worried about the note directive application time, but I cannot
offer a specific explanation on how it can break things in your use case.


I suggest that you revise your configuration to:

1. Avoid the note directive. It might be applied too late, and it is not
meant to do what you are trying to accomplish.

2. Use ssl_bump directive to annotate the client during SslBump step1.
This directive is evaluated early, even before http_access. For plain
requests, you can use http_access.

3. Continue to annotate each client exactly once. Replace &quot;+=&quot; with &quot;=&quot;
to avoid creating the impression that you are updating annotations.


&gt;<i> and or when the log format codes get evaluated.
</I>
They are evaluated when used. In your specific case, you have not told
us how your configuration uses logformat &quot;log&quot;, but if you are using
&quot;log&quot; just for the access_log directive, then &quot;log&quot; %codes are evaluated
when Squid creates the access.log record for each transaction.


HTH,

Alex.



&gt;<i> 
</I>&gt;<i> Squid configuration
</I>&gt;<i> -------------------
</I>&gt;<i> #
</I>&gt;<i> acl connection_id_acl annotate_client conn_id+=&quot;%master_xaction/%random&quot;
</I>&gt;<i> acl has_conn_id_acl note conn_id
</I>&gt;<i> acl set_conn_id_once_acl any-of has_conn_id_acl connection_id_acl
</I>&gt;<i> note &quot;&quot; &quot;&quot; set_conn_id_once_acl
</I>&gt;<i> #
</I>&gt;<i> logformat log time=&quot;%tl&quot; conn_id=%{conn_id}note request_type=%&gt;rm url=%&gt;ru
</I>&gt;<i> 
</I>&gt;<i> log output
</I>&gt;<i> ----------
</I>&gt;<i> time=&quot;04/Nov/2021:14:54:19 +0000&quot; conn_id=2550/Fh0Lje1 request_type=CONNECT url=blog.jason.spashett.com:443
</I>&gt;<i> time=&quot;04/Nov/2021:14:54:19 +0000&quot; conn_id=2550/e5sVhqi request_type=GET url=<A HREF="https://blog.jason.spashett.com/minecraft-4k-ported-to-the-d-programming-language/">https://blog.jason.spashett.com/minecraft-4k-ported-to-the-d-programming-language/</A>
</I>&gt;<i> time=&quot;04/Nov/2021:14:54:20 +0000&quot; conn_id=2550/e5sVhqi request_type=GET url=<A HREF="https://blog.jason.spashett.com/css/main.css">https://blog.jason.spashett.com/css/main.css</A>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i> 
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="024223.html">[squid-users] acl / format code evaluation
</A></li>
	<LI>Next message (by thread): <A HREF="024225.html">[squid-users] acl / format code evaluation
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24224">[ date ]</a>
              <a href="thread.html#24224">[ thread ]</a>
              <a href="subject.html#24224">[ subject ]</a>
              <a href="author.html#24224">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
