<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid very slow with kerberos auth and LDAP Group Search(AD)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20very%20slow%20with%20kerberos%20auth%20and%20LDAP%20Group%0A%20Search%28AD%29&In-Reply-To=%3C136f4720-061c-09a4-7a60-5817b5375f3d%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="024229.html">
   <LINK REL="Next"  HREF="024234.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid very slow with kerberos auth and LDAP Group Search(AD)</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20very%20slow%20with%20kerberos%20auth%20and%20LDAP%20Group%0A%20Search%28AD%29&In-Reply-To=%3C136f4720-061c-09a4-7a60-5817b5375f3d%40treenet.co.nz%3E"
       TITLE="[squid-users] Squid very slow with kerberos auth and LDAP Group Search(AD)">squid3 at treenet.co.nz
       </A><BR>
    <I>Tue Nov  9 02:04:48 UTC 2021</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="024229.html">[squid-users] Squid very slow with kerberos auth and LDAP Group Search(AD)
</A></li>
        <LI>Next message (by thread): <A HREF="024234.html">[squid-users] Squid very slow with kerberos auth and LDAP Group Search(AD)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24232">[ date ]</a>
              <a href="thread.html#24232">[ thread ]</a>
              <a href="subject.html#24232">[ subject ]</a>
              <a href="author.html#24232">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 9/11/21 01:19, <A HREF="https://lists.squid-cache.org/listinfo/squid-users">heimarbeit123.99 at web.de</A> wrote:
&gt;<i> Hello all,
</I>&gt;<i> I finaly got a squid proxy with kerberos authentification and LDAP group 
</I>&gt;<i> check to work! With a small amount of clients(1-10) everything works as 
</I>&gt;<i> it should and the squid is fast(no noticeable waiting time for websites 
</I>&gt;<i> to open). Users get authenticated, different AD groups can access the 
</I>&gt;<i> internet with blacklists/whitelists/full access and so on..
</I>
&gt;<i> But as soon as I make the whole company(round about 80 clients) use the 
</I>&gt;<i> new proxy, it begins to be very slow. And by very slow I mean like 1-2 
</I>&gt;<i> minutes waiting time(response time in access.log is like 60000-270000 
</I>&gt;<i> milliseconds for TCP_TUNNEL) until a website is fully loaded.
</I>
That could just mean the entire website was loaded through that one 
tunnel. Which is often the case if the clients are using HTTP/2 or HTTPS 
at version 1.1 through it.


&gt;<i> We got a 
</I>&gt;<i> old squid proxy too, but without any authentication (just some dstdomain 
</I>&gt;<i> in general) and it's working great. But the new one is very slow..
</I>&gt;<i> Btw. some of our clients have ipv6, others ipv4(~90%)..There were no 
</I>&gt;<i> errors in cache.log(activated it for some minutes with debug ALL for 
</I>&gt;<i> error checking).
</I>
ALL at what level? &quot;ALL,0&quot; log barely anything on a working proxy, but 
will definitely complain about critical problems.



&gt;<i> Can anyone help?
</I>&gt;<i> What I tried so far:
</I>&gt;<i> dns_v4_first on at the very end/very beginning from squid.conf
</I>&gt;<i> enable/disable (memory) caching
</I>&gt;<i> use Google DNS instead of our own
</I>
That can be a recipe for slowness. Since the Google DNS service produces 
different responses to every request - even identical repeated ones.


&gt;<i> connect_timeout 3 seconds
</I>&gt;<i> Nothing realy helped..
</I>&gt;<i> Here is my squid.conf:
</I>&gt;<i> ######### allowed port part ########################
</I>&gt;<i> acl Allowed_port port 80&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; # http
</I>&gt;<i> acl Allowed_port port 21&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; # ftp
</I>&gt;<i> acl Allowed_port port 443&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; # https
</I>&gt;<i> acl Allowed_port port 70&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; # gopher
</I>&gt;<i> acl Allowed_port port 210&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; # wais
</I>&gt;<i> acl Allowed_port port 1025-65535&#160; # unregistered ports
</I>&gt;<i> acl Allowed_port port 280&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; # http-mgmt
</I>&gt;<i> acl Allowed_port port 488&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; # gss-http
</I>&gt;<i> acl Allowed_port port 591&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; # filemaker
</I>&gt;<i> acl Allowed_port port 777&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; # multiling http
</I>&gt;<i> acl Allowed_port port 10000&#160;&#160;&#160;&#160;&#160;&#160; # Proofpoint
</I>&gt;<i> acl CONNECT method CONNECT
</I>&gt;<i> http_access deny CONNECT !Allowed_port
</I>
Please no. The default security protections were created to cover a 
range of security risks commonly seen in Internet traffic.


# forbids touching protocols that can be confused with HTTP
http_access deny !Safe_ports

# prevent arbitrary exfiltration from malware in the network.
http_access deny CONNECT !SSL_ports


&gt;<i> ##################### cache/logs ########################
</I>&gt;<i> cache_log /dev/null
</I>
Do set that to an actual file. You may find the thing causing your 
problems is detectable by Squid.



&gt;<i> logformat myformat %{%d.%m %H:%M:%S}tl %&gt;a %Ss %ru %tr
</I>&gt;<i> access_log /var/log/squid/access.log myformat
</I>

&gt;<i> cache deny all
</I>&gt;<i> coredump_dir /dev/null
</I>
Core dumps are something you should probably disable at the system level 
instead if you don't want them. Writing all that can be quite time 
consuming, even to /dev/null.


&gt;<i> cache_dir null /dev/null
</I>
&quot;null&quot; cache type does not exist anymore. That is one thing your 
cache.log should be warning you about if you could see it.


&gt;<i> cache_store_log none
</I>
This is a default in all current Squid.


&gt;<i> ########## Debug ########################
</I>&gt;<i> #debug_options ALL,1 33,2 28,9
</I>&gt;<i> ######################### squid-port #######
</I>&gt;<i> http_port 3128&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; #proxy port
</I>&gt;<i> authenticate_ttl 2 hours&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; #auth timeout 
</I>&gt;<i> squid-&gt;passwd_server
</I>
&gt;<i> acl black_regex url_regex &quot;/etc/squid/regex_black.acl&quot;
</I>
&gt;<i> acl white_regex url_regex &quot;/etc/squid/regex_white.acl&quot;
</I>&gt;<i> acl license_regex url_regex &quot;/etc/squid/regex_license_servers_no_auth.acl&quot;
</I>&gt;<i> ############################# allow License Managers ##########
</I>&gt;<i> http_access allow license_regex all
</I>
The &quot; all&quot; at the end of this line is pointless. Authentication is not 
being performed by the regex ACL listed.


&gt;<i> ################### Kerberos ##################################
</I>&gt;<i> auth_param negotiate program /lib/squid/negotiate_wrapper_auth -d --ntlm 
</I>&gt;<i> /bin/ntlm_auth --diagnostics --helper-protocol=squid-2.5-ntlmssp 
</I>&gt;<i> --domain=DOMAIN.TLD --kerberos /lib/squid/negotiate_kerberos_auth -d -s 
</I>&gt;<i> HTTP/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">proxy.domain.tld at DOMAIN.TLD</A>
</I>&gt;<i> auth_param negotiate children 200
</I>
You should not need 200 helpers for 80 users with Kerberos operational.


&gt;<i> auth_param negotiate keep_alive on
</I>&gt;<i> ########################## Allow based on group membership ######
</I>&gt;<i> # Authentication required, otherwise Pop-Up
</I>&gt;<i> acl Authenticated_Users proxy_auth REQUIRED
</I>&gt;<i> http_access deny !Authenticated_Users all
</I>
FYI: the &quot; all&quot; ACL check at the end of this line forbids Squid sending 
the 40x challenge which triggers popups. Users will be getting full 
rejection 403 instead if they match this line.


&gt;<i> # Define external acl for group check
</I>&gt;<i> external_acl_type ldap_group ipv4 ttl=300 negative_ttl=120 
</I>&gt;<i> children-max=200 %LOGIN /lib/squid/ext_ldap_group_acl -K -S -R \
</I>&gt;<i> -b &quot;ou=Users,DC=domain,DC=tld&quot; \
</I>&gt;<i> -D &quot;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">ProxyUser at DOMAIN.TLD</A>&quot; \
</I>&gt;<i> -W /etc/squid/authfile \
</I>&gt;<i> -f 
</I>&gt;<i> &quot;(&amp;(objectclass=person)(sAMAccountName=%v)(memberof=CN=%a,OU=Groups,DC=domain,DC=tl))&quot; 
</I>&gt;<i> \
</I>&gt;<i> -h 192.0.1.1
</I>
&gt;<i> acl Users_Internet_Users external ldap_group Users
</I>&gt;<i> http_access allow Users_Internet_Users !black_regex
</I>
The above performs the slowest ACL test first. It can be optimized as:
   http_access allow !black_regex Users_Internet_Users all


&gt;<i> http_access deny all
</I>&gt;<i> dns_v4_first on
</I>&gt;<i> connect_timeout 3 seconds
</I>

Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="024229.html">[squid-users] Squid very slow with kerberos auth and LDAP Group Search(AD)
</A></li>
	<LI>Next message (by thread): <A HREF="024234.html">[squid-users] Squid very slow with kerberos auth and LDAP Group Search(AD)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24232">[ date ]</a>
              <a href="thread.html#24232">[ thread ]</a>
              <a href="subject.html#24232">[ subject ]</a>
              <a href="author.html#24232">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
