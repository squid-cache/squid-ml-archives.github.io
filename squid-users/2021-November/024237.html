<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] squid 5.2: ntlm_fake_auth refuse to valid credentials
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid%205.2%3A%20ntlm_fake_auth%20refuse%20to%20valid%20credentials&In-Reply-To=%3Cb7b9ccc8-c394-552c-f99c-833463c52ff9%40articatech.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="024234.html">
   <LINK REL="Next"  HREF="024238.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] squid 5.2: ntlm_fake_auth refuse to valid credentials</H1>
    <B>David Touzeau</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid%205.2%3A%20ntlm_fake_auth%20refuse%20to%20valid%20credentials&In-Reply-To=%3Cb7b9ccc8-c394-552c-f99c-833463c52ff9%40articatech.com%3E"
       TITLE="[squid-users] squid 5.2: ntlm_fake_auth refuse to valid credentials">david at articatech.com
       </A><BR>
    <I>Thu Nov 11 01:12:04 UTC 2021</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="024234.html">[squid-users] Squid very slow with kerberos auth and LDAP Group Search(AD)
</A></li>
        <LI>Next message (by thread): <A HREF="024238.html">[squid-users] squid 5.2: ntlm_fake_auth refuse to valid credentials
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24237">[ date ]</a>
              <a href="thread.html#24237">[ thread ]</a>
              <a href="subject.html#24237">[ subject ]</a>
              <a href="author.html#24237">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,
i would like to use ntlm_fake_auth but it seems Squid refuse to switch 
to authenticated user and return a 407 to the browser and squid never 
accept&#160; credentials.

What i missing ?

Configuration seems simple:
auth_param ntlm program /lib/squid3/ntlm_fake_auth -v
auth_param ntlm children 20 startup=5 idle=1 concurrency=0 queue-size=80 
on-persistent-overload=ERR
acl AUTHENTICATED proxy_auth REQUIRED
http_access deny&#160; !AUTHENTICATED

Here the debug mode;

2021/11/11 01:36:16.862 kid1| 14,3| ipcache.cc(614) 
ipcache_gethostbyname: ipcache_gethostbyname: 'www.squid-cache.org', flags=1
2021/11/11 01:36:16.862 kid1| 28,3| Ip.cc(538) match: aclIpMatchIp: 
'212.199.163.170' NOT found
2021/11/11 01:36:16.862 kid1| 28,3| Ip.cc(538) match: aclIpMatchIp: 
'196.200.160.70' NOT found
2021/11/11 01:36:16.862 kid1| 28,3| Acl.cc(151) matches: checked: 
NetworksBlackLists = 0
2021/11/11 01:36:16.862 kid1| 28,3| Acl.cc(151) matches: checked: 
http_access#29 = 0
2021/11/11 01:36:16.862 kid1| 28,5| Checklist.cc(397) bannedAction: 
Action 'DENIED/0' is not banned
2021/11/11 01:36:16.862 kid1| 28,5| Acl.cc(124) matches: checking 
http_access#30
2021/11/11 01:36:16.862 kid1| 28,5| Acl.cc(124) matches: checking 
NormalPorts
2021/11/11 01:36:16.862 kid1| 24,7| SBuf.cc(212) append: from c-string 
to id SBuf1021843
2021/11/11 01:36:16.862 kid1| 24,7| SBuf.cc(160) rawSpace: reserving 13 
for SBuf1021843
2021/11/11 01:36:16.862 kid1| 24,7| SBuf.cc(865) reAlloc: SBuf1021843 
new store capacity: 40
2021/11/11 01:36:16.862 kid1| 28,3| StringData.cc(33) match: 
aclMatchStringList: checking 'MyPortNameID1'
2021/11/11 01:36:16.862 kid1| 28,3| StringData.cc(36) match: 
aclMatchStringList: 'MyPortNameID1' found
2021/11/11 01:36:16.862 kid1| 28,3| Acl.cc(151) matches: checked: 
NormalPorts = 1
2021/11/11 01:36:16.862 kid1| 28,5| Acl.cc(124) matches: checking 
!AUTHENTICATED
2021/11/11 01:36:16.862 kid1| 28,5| Acl.cc(124) matches: checking 
AUTHENTICATED
2021/11/11 01:36:16.862 kid1| 29,4| UserRequest.cc(354) authenticate: No 
connection authentication type
2021/11/11 01:36:16.862 kid1| 29,5| User.cc(36) User: Initialised 
auth_user '0x5570e8c4d240'.
2021/11/11 01:36:16.862 kid1| 29,5| UserRequest.cc(99) UserRequest: 
initialised request 0x5570e8cdacf0
2021/11/11 01:36:16.862 kid1| 24,7| SBuf.cc(212) append: from c-string 
to id SBuf1021846
2021/11/11 01:36:16.862 kid1| 24,7| SBuf.cc(160) rawSpace: reserving 61 
for SBuf1021846
2021/11/11 01:36:16.862 kid1| 24,7| SBuf.cc(865) reAlloc: SBuf1021846 
new store capacity: 128
2021/11/11 01:36:16.862 kid1| 29,5| UserRequest.cc(77) valid: Validated. 
Auth::UserRequest '0x5570e8cdacf0'.
2021/11/11 01:36:16.862 kid1| 29,5| UserRequest.cc(77) valid: Validated. 
Auth::UserRequest '0x5570e8cdacf0'.
2021/11/11 01:36:16.862 kid1| 33,2| client_side.cc(507) setAuth: Adding 
connection-auth to local=192.168.90.170:3128 remote=192.168.90.10:50746 
FD 12 flags=1 from new NTLM handshake request
2021/11/11 01:36:16.862 kid1| 29,5| UserRequest.cc(77) valid: Validated. 
Auth::UserRequest '0x5570e8cdacf0'.
2021/11/11 01:36:16.862 kid1| 28,3| AclProxyAuth.cc(131) checkForAsync: 
checking password via authenticator
2021/11/11 01:36:16.862 kid1| 29,5| UserRequest.cc(77) valid: Validated. 
Auth::UserRequest '0x5570e8cdacf0'.
2021/11/11 01:36:16.862 kid1| 84,5| helper.cc(1292) 
StatefulGetFirstAvailable: StatefulGetFirstAvailable: Running servers 5
2021/11/11 01:36:16.862 kid1| 84,5| helper.cc(1309) 
StatefulGetFirstAvailable: StatefulGetFirstAvailable: returning srv-Hlpr66
2021/11/11 01:36:16.862 kid1| 5,5| AsyncCall.cc(26) AsyncCall: The 
AsyncCall helperStatefulDispatchWriteDone constructed, 
this=0x5570e8c8f8e0 [call581993]
2021/11/11 01:36:16.862 kid1| 5,5| Write.cc(35) Write: local=[::] 
remote=[::] FD 10 flags=1: sz 60: asynCall 0x5570e8c8f8e0*1
2021/11/11 01:36:16.862 kid1| 5,5| ModEpoll.cc(117) SetSelect: FD 10, 
type=2, handler=1, client_data=0x7f9e5d8a75a8, timeout=0
2021/11/11 01:36:16.862 kid1| 84,5| helper.cc(1430) 
helperStatefulDispatch: helperStatefulDispatch: Request sent to 
ntlmauthenticator #Hlpr66, 60 bytes
2021/11/11 01:36:16.862 kid1| 28,4| Acl.cc(72) AuthenticateAcl: 
returning 2 sending credentials to helper.
2021/11/11 01:36:16.862 kid1| 28,3| Acl.cc(151) matches: checked: 
AUTHENTICATED = -1 async
2021/11/11 01:36:16.862 kid1| 28,3| Acl.cc(151) matches: checked: 
!AUTHENTICATED = -1 async
2021/11/11 01:36:16.862 kid1| 28,3| Acl.cc(151) matches: checked: 
http_access#30 = -1 async
2021/11/11 01:36:16.862 kid1| 28,3| Acl.cc(151) matches: checked: 
http_access = -1 async
2021/11/11 01:36:16.862 kid1| 33,4| Server.cc(90) readSomeData: 
local=192.168.90.170:3128 remote=192.168.90.10:50746 FD 12 flags=1: 
reading request...
2021/11/11 01:36:16.862 kid1| 33,5| AsyncCall.cc(26) AsyncCall: The 
AsyncCall Server::doClientRead constructed, this=0x5570e87cfd50 [call581994]
2021/11/11 01:36:16.862 kid1| 5,5| Read.cc(57) comm_read_base: 
comm_read, queueing read for local=192.168.90.170:3128 
remote=192.168.90.10:50746 FD 12 flags=1; asynCall 0x5570e87cfd50*1
2021/11/11 01:36:16.862 kid1| 5,5| ModEpoll.cc(117) SetSelect: FD 12, 
type=1, handler=1, client_data=0x7f9e5d8a7678, timeout=0
2021/11/11 01:36:16.862 kid1| 33,5| AsyncJob.cc(154) callEnd: 
Http1::Server status out: [ job17296]
2021/11/11 01:36:16.862 kid1| 33,5| AsyncCallQueue.cc(57) fireNext: 
leaving Server::doClientRead(local=192.168.90.170:3128 
remote=192.168.90.10:50746 FD 12 flags=1, data=0x5570e8c63468)
2021/11/11 01:36:16.862 kid1| 5,5| Write.cc(66) HandleWrite: local=[::] 
remote=[::] FD 10 flags=1: off 0, sz 60.
2021/11/11 01:36:16.862 kid1| 5,5| Write.cc(108) HandleWrite: write() 
returns 60
2021/11/11 01:36:16.862 kid1| 5,3| IoCallback.cc(116) finish: called for 
local=[::] remote=[::] FD 10 flags=1 (0, 0)
2021/11/11 01:36:16.862 kid1| 5,5| AsyncCall.cc(93) ScheduleCall: 
IoCallback.cc(135) will call helperStatefulDispatchWriteDone(local=[::] 
remote=[::] FD 10 flags=1, data=0x5570e8731e08, size=60, 
buf=0x5570e8d2c1a0) [call581993]
ntlm_fake_auth.cc(170): pid=4454 :2021/11/11 01:36:16.862 kid1| 5,5| 
AsyncCallQueue.cc(55) fireNext: entering 
helperStatefulDispatchWriteDone(local=[::] remote=[::] FD 10 flags=1, 
data=0x5570e8731e08, size=60, buf=0x5570e8d2c1a0)
Got 'YR' from Squid with data:
2021/11/11 01:36:16.862 kid1| 5,5| AsyncCall.cc(38) make: make call 
helperStatefulDispatchWriteDone [call581993]
[0000]&#160; 4E 54 4C 4D 53 53 50 00&#160; 01 00 00 00 07 82 08 A2 NTLMSSP. ........
2021/11/11 01:36:16.862 kid1| 5,5| AsyncCallQueue.cc(57) fireNext: 
leaving helperStatefulDispatchWriteDone(local=[::] remote=[::] FD 10 
flags=1, data=0x5570e8731e08, size=60, buf=0x5570e8d2c1a0)
[0010]&#160; 00 00 00 00 00 00 00 00&#160; 00 00 00 00 00 00 00 00 ........ ........
2021/11/11 01:36:16.862 kid1| 5,5| ModEpoll.cc(117) SetSelect: FD 10, 
type=2, handler=0, client_data=0, timeout=0
[0020]&#160; 0A 00 63 45 00 00 00 0F ..cE....
*ntlm_fake_auth.cc(197): pid=4454 :sending 'TT' to squid with data:*
*[0000]&#160; 4E 54 4C 4D 53 53 50 00&#160; 02 00 00 00 09 00 09 00 NTLMSSP. ........*
*2021/11/11 01:36:16.862 kid1| 5,3| Read.cc(145) HandleRead: FD 10, size 
32767, retval 72, errno 0*
*[0010]&#160; AE AA AA AA 07 82 08 A2&#160; E8 DB F0 45 D4 04 00 32 ........ ...E...2*
*2021/11/11 01:36:16.862 kid1| 5,3| IoCallback.cc(116) finish: called 
for local=[::] remote=[::] FD 10 flags=1 (0, 0)*
*[0020]&#160; 00 00 00 00 00 00 3A 00&#160; 57 4F 52 4B 47 52 4F 55 ........ WORKGROU*
*[0030]&#160; 50 * &#160; &#160; &#160; P
2021/11/11 01:36:16.862 kid1| 5,4| AsyncCall.cc(93) ScheduleCall: 
IoCallback.cc(135) will call helperStatefulHandleRead(local=[::] 
remote=[::] FD 10 flags=1, data=0x5570e8752b18, size=72, 
buf=0x5570e87635b0) [call581969]
2021/11/11 01:36:16.862 kid1| 5,4| AsyncCallQueue.cc(55) fireNext: 
entering helperStatefulHandleRead(local=[::] remote=[::] FD 10 flags=1, 
data=0x5570e8752b18, size=72, buf=0x5570e87635b0)
2021/11/11 01:36:16.862 kid1| 5,4| AsyncCall.cc(38) make: make call 
helperStatefulHandleRead [call581969]
2021/11/11 01:36:16.862 kid1| 84,5| helper.cc(1081) 
helperStatefulHandleRead: helperStatefulHandleRead: 72 bytes from 
ntlmauthenticator #Hlpr66
2021/11/11 01:36:16.862 kid1| 84,3| helper.cc(1103) 
helperStatefulHandleRead: helperStatefulHandleRead: end of reply found
2021/11/11 01:36:16.862 kid1| 84,3| Reply.cc(41) finalize: Parsing 
helper buffer
2021/11/11 01:36:16.862 kid1| 84,3| Reply.cc(59) finalize: Buff length 
is larger than 2
*2021/11/11 01:36:16.862 kid1| 29,4| UserRequest.cc(306) HandleReply: 
Need to challenge the client with a server token: 
'TlRMTVNTUAACAAAACQAJAK6qqqoHggii6NvwRdQEADIAAAAAAAA6AFdPUktHUk9VUA=='*
2021/11/11 01:36:16.862 kid1| 29,5| UserRequest.cc(77) valid: Validated. 
Auth::UserRequest '0x5570e8cdacf0'.
2021/11/11 01:36:16.862 kid1| 28,5| InnerNode.cc(94) resumeMatchingAt: 
checking http_access at 29
2021/11/11 01:36:16.862 kid1| 28,5| Checklist.cc(397) bannedAction: 
Action 'DENIED/0' is not banned
2021/11/11 01:36:16.862 kid1| 28,5| InnerNode.cc(94) resumeMatchingAt: 
checking http_access#30 at 1
2021/11/11 01:36:16.862 kid1| 28,5| InnerNode.cc(94) resumeMatchingAt: 
checking !AUTHENTICATED at 0
2021/11/11 01:36:16.862 kid1| 28,5| Acl.cc(124) matches: checking 
AUTHENTICATED
2021/11/11 01:36:16.862 kid1| 29,5| UserRequest.cc(77) valid: Validated. 
Auth::UserRequest '0x5570e8cdacf0'.
2021/11/11 01:36:16.862 kid1| 29,5| UserRequest.cc(77) valid: Validated. 
Auth::UserRequest '0x5570e8cdacf0'.
*2021/11/11 01:36:16.862 kid1| 29,2| UserRequest.cc(197) authenticate: 
need to challenge client 
'TlRMTVNTUAACAAAACQAJAK6qqqoHggii6NvwRdQEADIAAAAAAAA6AFdPUktHUk9VUA=='!*
2021/11/11 01:36:16.862 kid1| 29,5| UserRequest.cc(77) valid: Validated. 
Auth::UserRequest '0x5570e8cdacf0'.
2021/11/11 01:36:16.862 kid1| 28,4| Acl.cc(78) AuthenticateAcl: 
returning 3 sending authentication challenge.
2021/11/11 01:36:16.862 kid1| 28,3| Checklist.cc(63) markFinished: 
0x5570e876da88 answer AUTH_REQUIRED for AuthenticateAcl exception
*2021/11/11 01:36:16.862 kid1| 28,3| Acl.cc(151) matches: checked: 
AUTHENTICATED = -1*
2021/11/11 01:36:16.863 kid1| 28,3| InnerNode.cc(97) resumeMatchingAt: 
checked: !AUTHENTICATED = -1
2021/11/11 01:36:16.863 kid1| 28,3| InnerNode.cc(97) resumeMatchingAt: 
checked: http_access#30 = -1
2021/11/11 01:36:16.863 kid1| 28,3| InnerNode.cc(97) resumeMatchingAt: 
checked: http_access = -1
2021/11/11 01:36:16.863 kid1| 28,3| Checklist.cc(163) checkCallback: 
ACLChecklist::checkCallback: 0x5570e876da88 answer=AUTH_REQUIRED
2021/11/11 01:36:16.863 kid1| 85,2| client_side_request.cc(759) 
clientAccessCheckDone: The request GET <A HREF="http://www.squid-cache.org/">http://www.squid-cache.org/</A> is 
AUTH_REQUIRED; last ACL checked: AUTHENTICATED
2021/11/11 01:36:16.863 kid1| 85,5| client_side_request.cc(775) 
clientAccessCheckDone: *Access Denied*: <A HREF="http://www.squid-cache.org/">http://www.squid-cache.org/</A>
2021/11/11 01:36:16.863 kid1| 85,5| client_side_request.cc(776) 
clientAccessCheckDone: AclMatchedName = AUTHENTICATED
2021/11/11 01:36:16.863 kid1| 33,5| client_side_request.cc(779) 
clientAccessCheckDone: Proxy Auth Message = Authentication in progress
2021/11/11 01:36:16.863 kid1| 28,4| FilledChecklist.cc(67) 
~ACLFilledChecklist: ACLFilledChecklist destroyed 0x7fff22f7a0b0
2021/11/11 01:36:16.863 kid1| 28,4| Checklist.cc(197) ~ACLChecklist: 
ACLChecklist::~ACLChecklist: destroyed 0x7fff22f7a0b0
2021/11/11 01:36:16.863 kid1| 28,4| FilledChecklist.cc(67) 
~ACLFilledChecklist: ACLFilledChecklist destroyed 0x7fff22f7a0b0
2021/11/11 01:36:16.863 kid1| 28,4| Checklist.cc(197) ~ACLChecklist: 
ACLChecklist::~ACLChecklist: destroyed 0x7fff22f7a0b0
2021/11/11 01:36:16.863 kid1| 85,5| client_side_request.cc(1445) 
sslBumpAccessCheck: cannot SslBump this request
2021/11/11 01:36:16.863 kid1| 73,3| HttpRequest.cc(662) storeId: sent 
back effectiveRequestUrl: <A HREF="http://www.squid-cache.org/">http://www.squid-cache.org/</A>
2021/11/11 01:36:16.863 kid1| 24,7| SBuf.cc(160) rawSpace: reserving 1 
for SBuf1021849
2021/11/11 01:36:16.863 kid1| 24,7| SBuf.cc(167) rawSpace: SBuf1021849 
not growing
2021/11/11 01:36:16.863 kid1| 20,3| store.cc(785) storeCreatePureEntry: 
storeCreateEntry: '<A HREF="http://www.squid-cache.org/">http://www.squid-cache.org/</A>'
2021/11/11 01:36:16.863 kid1| 20,5| store.cc(347) StoreEntry: StoreEntry 
constructed, this=0x5570e87b5620
2021/11/11 01:36:16.863 kid1| 20,3| MemObject.cc(101) MemObject: 
MemObject constructed, this=0x5570e8ad2990
2021/11/11 01:36:16.863 kid1| 55,7| HttpHeader.cc(152) HttpHeader: 
init-ing hdr: 0x5570e8c55128 owner: 3
2021/11/11 01:36:16.863 kid1| 88,3| MemObject.cc(84) setUris: 
0x5570e8ad2990 storeId: <A HREF="http://www.squid-cache.org/">http://www.squid-cache.org/</A>
2021/11/11 01:36:16.863 kid1| 24,7| SBuf.cc(85) assign: assigning 
SBuf1021850 from SBuf1021792
2021/11/11 01:36:16.863 kid1| 20,3| store.cc(444) lock: storeCreateEntry 
locked key [null_store_key] e:=V/0x5570e87b5620*1
2021/11/11 01:36:16.863 kid1| 20,3| store.cc(586) setPrivateKey: 01 
e:=V/0x5570e87b5620*1
2021/11/11 01:36:16.863 kid1| 20,3| store.cc(422) hashInsert: 
StoreEntry::hashInsert: Inserting Entry e:=XIV/0x5570e87b5620*1 key 
'771C000000000000A607000001000000'
2021/11/11 01:36:16.863 kid1| 20,3| store.cc(444) lock: 
clientReplyContext::setReplyToStoreEntry locked key 
771C000000000000A607000001000000 e:=XIV/0x5570e87b5620*2
2021/11/11 01:36:16.863 kid1| 4,4| errorpage.cc(604) errorAppendEntry: 
Creating an error page for entry 0x5570e87b5620 with errorstate 
0x5570e8c527b8 page id 2
2021/11/11 01:36:16.863 kid1| 55,7| HttpHeader.cc(152) HttpHeader: 
init-ing hdr: 0x5570e8ddec88 owner: 3
2021/11/11 01:36:16.863 kid1| 4,2| errorpage.cc(1259) BuildContent: No 
existing error page language negotiated for ERR_CACHE_ACCESS_DENIED. 
Using default error file.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20211111/e2e5d121/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20211111/e2e5d121/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="024234.html">[squid-users] Squid very slow with kerberos auth and LDAP Group Search(AD)
</A></li>
	<LI>Next message (by thread): <A HREF="024238.html">[squid-users] squid 5.2: ntlm_fake_auth refuse to valid credentials
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24237">[ date ]</a>
              <a href="thread.html#24237">[ thread ]</a>
              <a href="subject.html#24237">[ subject ]</a>
              <a href="author.html#24237">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
