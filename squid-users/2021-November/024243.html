<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid 5.2 unstable in production mode
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%205.2%20unstable%20in%20production%20mode&In-Reply-To=%3C1a583ffa-c89d-028b-5712-d934687fb919%40articatech.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="024288.html">
   <LINK REL="Next"  HREF="024244.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid 5.2 unstable in production mode</H1>
    <B>David Touzeau</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%205.2%20unstable%20in%20production%20mode&In-Reply-To=%3C1a583ffa-c89d-028b-5712-d934687fb919%40articatech.com%3E"
       TITLE="[squid-users] Squid 5.2 unstable in production mode">david at articatech.com
       </A><BR>
    <I>Thu Nov 11 19:08:13 UTC 2021</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="024288.html">[squid-users] Too many ERROR: Collapsed forwarding queue overflow for kid2 at 1024 items
</A></li>
        <LI>Next message (by thread): <A HREF="024244.html">[squid-users] Squid 5.2 unstable in production mode
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24243">[ date ]</a>
              <a href="thread.html#24243">[ thread ]</a>
              <a href="subject.html#24243">[ subject ]</a>
              <a href="author.html#24243">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi

Just for information and i hope it will help.

We have installed Squid 5.1 and Squid 5.2 in production mode.
It seems that after several days, the Squid become very unstable.
We mention that when switching to 4.x we did not encounter these errors 
with the same configuration, same users, same network ( replace binaries 
and keep same configuration )

All production servers are installed in a virtual environment ( ESXI or 
Nutanix ) on Debian 10.x with about 4 to 8 vCPUs and 8GB of memory.
and from 20 to 5000 users.

After severals tests we see that the number of users did not have impact 
with the stability.
We encounter same errors on a 20 users proxy and the same way of a 5000 
users proxy.


1) Memory leak
---------------------------------
This was encounter on computer that handle more than 10Gb of memory, 
squid eat more than 8Gb of memory.
After eating all memory, squid is unable to load helpers and freeze 
listen ports.
A restart service free the memory and fix the issue.

2) Max filedescriptors issues:
--------------------------------
This is a strange behavior that Squid did not accept defined parameter:
Example we set 65535 filedescriptors but squidclient mgr:info report 
4096 and sometimes return back to 1024.

Several times squid report

 &#160;&#160;&#160; current master transaction: master15881
2021/11/11 17:10:09 kid1| WARNING! Your cache is running out of 
filedescriptors
 &#160;&#160;&#160; listening port: MyPortNameID1
2021/11/11 17:10:29 kid1| WARNING! Your cache is running out of 
filedescriptors
 &#160;&#160;&#160; listening port: MyPortNameID1
2021/11/11 17:10:51 kid1| WARNING! Your cache is running out of 
filedescriptors
 &#160;&#160;&#160; listening port: MyPortNameID1
2021/11/11 17:11:56 kid1| TCP connection to 127.0.0.1/2320 failed
 &#160;&#160;&#160; current master transaction: master15881
2021/11/11 17:13:02 kid1| WARNING! Your cache is running out of 
filedescriptors
 &#160;&#160;&#160; listening port: MyPortNameID1
2021/11/11 17:13:19 kid1| WARNING! Your cache is running out of 
filedescriptors

But a mgr:info report:

 &#160;&#160;&#160;&#160;&#160;&#160;&#160; memPoolFree calls:&#160;&#160;&#160; 4295601
File descriptor usage for squid:
 &#160;&#160;&#160;&#160;&#160;&#160;&#160; Maximum number of file descriptors:&#160;&#160; 10048
 &#160;&#160;&#160;&#160;&#160;&#160;&#160; Largest file desc currently in use:&#160;&#160;&#160; 262
 &#160;&#160;&#160;&#160;&#160;&#160;&#160; Number of file desc currently in use:&#160; 135
 &#160;&#160;&#160;&#160;&#160;&#160;&#160; Files queued for open:&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; 0
 &#160;&#160;&#160;&#160;&#160;&#160;&#160; Available number of file descriptors: 9913
 &#160;&#160;&#160;&#160;&#160;&#160;&#160; Reserved number of file descriptors:&#160; 9789

After these errors the listen port is freeze and nobody is able to surf.
a just &quot;squid -k reconfigure&quot; fix the issue and the proxy return to 
normal mode for several minutes and back again to filedescriptors issues.

There is no relationship between filedescriptors issues and the number 
of clients.
Sometimes the issue is discovered during the night when there is no user 
that using the proxy ( just some robots like windows update )




Is there something other we can investigate to help more stability of 
the 5.x branch ?
Regards
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20211111/da810875/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20211111/da810875/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="024288.html">[squid-users] Too many ERROR: Collapsed forwarding queue overflow for kid2 at 1024 items
</A></li>
	<LI>Next message (by thread): <A HREF="024244.html">[squid-users] Squid 5.2 unstable in production mode
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24243">[ date ]</a>
              <a href="thread.html#24243">[ thread ]</a>
              <a href="subject.html#24243">[ subject ]</a>
              <a href="author.html#24243">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
