<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Too many ERROR: Collapsed forwarding queue overflow for kid2 at 1024 items
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Too%20many%20ERROR%3A%20Collapsed%20forwarding%20queue%0A%20overflow%20for%20kid2%20at%201024%20items&In-Reply-To=%3C369d5766-b6ab-f4cd-8cef-64b298d84638%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="024254.html">
   <LINK REL="Next"  HREF="024270.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Too many ERROR: Collapsed forwarding queue overflow for kid2 at 1024 items</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Too%20many%20ERROR%3A%20Collapsed%20forwarding%20queue%0A%20overflow%20for%20kid2%20at%201024%20items&In-Reply-To=%3C369d5766-b6ab-f4cd-8cef-64b298d84638%40measurement-factory.com%3E"
       TITLE="[squid-users] Too many ERROR: Collapsed forwarding queue overflow for kid2 at 1024 items">rousskov at measurement-factory.com
       </A><BR>
    <I>Tue Nov 16 18:09:12 UTC 2021</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="024254.html">[squid-users] Too many ERROR: Collapsed forwarding queue overflow for kid2 at 1024 items
</A></li>
        <LI>Next message (by thread): <A HREF="024270.html">[squid-users] Too many ERROR: Collapsed forwarding queue overflow for kid2 at 1024 items
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24256">[ date ]</a>
              <a href="thread.html#24256">[ thread ]</a>
              <a href="subject.html#24256">[ subject ]</a>
              <a href="author.html#24256">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 11/16/21 12:00 PM, Lou&#269;ansk&#253; Luk&#225;&#353; wrote:

&gt;<i> I will try to backport it from that patch into the v5 tree I've
</I>&gt;<i> downloaded today. As we were using the mentioned build I came across
</I>&gt;<i> these new assertions:
</I>
&gt;<i> 2021/11/16 10:29:46 kid1| assertion failed: StoreMap.cc:241: &quot;anchorAt(anchorId).reading()&quot;
</I>&gt;<i> 2021/11/16 11:32:51 kid2| assertion failed: Transients.cc:221: &quot;old == e&quot;
</I>&gt;<i> 2021/11/16 14:29:41 kid2| assertion failed: store.cc:1108: &quot;store_status == STORE_PENDING&quot;
</I>
I hope that at least some of the above assertions are fixed by master/v6
commit 5210df4.


&gt;<i> 2021/11/16 17:40:21 kid1| assertion failed: cbdata.cc:372: &quot;c-&gt;locks &gt; 0&quot;
</I>&gt;<i> 2021/11/16 17:40:44 kid1| assertion failed: cbdata.cc:115: &quot;cookie == ((long)this ^ Cookie)&quot; 
</I>
This is probably an unrelated bug. I recommend filing a bug report in
Squid bugzilla and posting the corresponding &quot;bt full&quot; backtrace there.


Alex.


&gt;<i> -----Original Message-----
</I>&gt;<i> From: Alex Rousskov [mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>] 
</I>&gt;<i> Sent: Tuesday, November 16, 2021 3:42 PM
</I>&gt;<i> To: Lou&#269;ansk&#253; Luk&#225;&#353;; Squid Users
</I>&gt;<i> Subject: Re: [squid-users] Too many ERROR: Collapsed forwarding queue overflow for kid2 at 1024 items
</I>&gt;<i> 
</I>&gt;<i> On 11/16/21 4:38 AM, Lou&#269;ansk&#253; Luk&#225;&#353; wrote:
</I>&gt;&gt;<i> is it going to be patched only in the v6 version? 
</I>&gt;<i> 
</I>&gt;<i> I hope the existing fix applies to v5 cleanly, and I am ready to help with backporting if it does not. Beyond that, it is in the maintainer hands. I cannot predict whether or when the fix will be officially merged into v5 because I do not understand how those decisions are made.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> Anyway - in the morning I run debug with 20,9 to see:
</I>&gt;&gt;<i> ...
</I>&gt;&gt;<i> 2021/11/16 09:02:06.496 kid2| assertion failed: Transients.cc:221: &quot;old == e&quot;
</I>&gt;<i> 
</I>&gt;<i> Unfortunately, I cannot see the cause of the assertion in this short/partial trace -- the problematic actions happened before the trace or were not logged during the trace.
</I>&gt;<i> 
</I>&gt;<i> Patching your Squid with commit 5210df4 is the best next step IMO. If that patch does not help, then there are probably other bugs that we need to fix in v5 (at least).
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> HTH,
</I>&gt;<i> 
</I>&gt;<i> Alex.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> -----Original Message-----
</I>&gt;&gt;<i> From: Alex Rousskov [mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>]
</I>&gt;&gt;<i> Sent: Monday, November 15, 2021 5:17 PM
</I>&gt;&gt;<i> To: Squid Users
</I>&gt;&gt;<i> Cc: Lou&#269;ansk&#253; Luk&#225;&#353;
</I>&gt;&gt;<i> Subject: Re: [squid-users] Too many ERROR: Collapsed forwarding queue 
</I>&gt;&gt;<i> overflow for kid2 at 1024 items
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> On 11/15/21 7:43 AM, Lou&#269;ansk&#253; Luk&#225;&#353; wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> 2021/11/14 10:13:30 kid2| assertion failed: Transients.cc:221: &quot;old == e&quot;
</I>&gt;&gt;&gt;<i> 2021/11/15 08:37:36 kid2| assertion failed: Transients.cc:221: &quot;old == e&quot;
</I>&gt;&gt;&gt;<i> 2021/11/15 11:54:14 kid1| assertion failed: Transients.cc:221: &quot;old == e&quot;
</I>&gt;&gt;&gt;<i> 2021/11/15 12:16:27 kid1| assertion failed: Transients.cc:221: &quot;old == e&quot;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I recommend ignoring queue overflows until the above assertions are fixed because worker deaths cause queue overflows. Your Squid is buggy, and those bugs essentially cause queue overflows.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The assertion itself is known as Bug 5134:
</I>&gt;&gt;<i> <A HREF="https://bugs.squid-cache.org/show_bug.cgi?id=5134">https://bugs.squid-cache.org/show_bug.cgi?id=5134</A>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> That bug has a speculative fix (master/v6 commit 5210df4). Please try it if you can.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> HTH,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Alex.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> -----Original Message-----
</I>&gt;&gt;&gt;<i> From: Alex Rousskov [mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>]
</I>&gt;&gt;&gt;<i> Sent: Friday, November 12, 2021 5:24 PM
</I>&gt;&gt;&gt;<i> To: Lou&#269;ansk&#253; Luk&#225;&#353;; <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;&gt;&gt;<i> Subject: Re: [squid-users] Too many ERROR: Collapsed forwarding queue 
</I>&gt;&gt;&gt;<i> overflow for kid2 at 1024 items
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> On 11/11/21 10:19 AM, Lou&#269;ansk&#253; Luk&#225;&#353; wrote:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> recently I'm facing too many ERROR: Collapsed forwarding queue 
</I>&gt;&gt;&gt;&gt;<i> overflow for kid2 at 1024 items lines in my Squid 5.2 log files.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> We see those overflows when kids die. Do you see any FATAL messages, assertions, or similar deadly errors in cache.log?
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> Could someone elaborate how the queue is filled - what is clogging it?
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> The sender/writer sends messages faster than the recipient/reader is 
</I>&gt;&gt;&gt;<i> reading them, eventually exceeding the queue capacity (i.e. 1024 
</I>&gt;&gt;&gt;<i> messages). These messages are about Store entries that may need 
</I>&gt;&gt;&gt;<i> synchronization across workers. Each message is very sm
</I>&gt;&gt;<i> all.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> I don't mind too much if I have to turn collapsed forwarding off
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Most likely, the problem is not tied to collapsed forwarding. These 
</I>&gt;&gt;&gt;<i> queues were used for collapsed forwarding when they were added, but 
</I>&gt;&gt;&gt;<i> they are used for regular traffic as well in modern SMP Squids. We 
</I>&gt;&gt;&gt;<i> need to change the queue names (and related code/m
</I>&gt;&gt;<i> essage text) to reflect the expanded nature of these queues.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> HTH,
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Alex.
</I>&gt;&gt;&gt;<i>
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="024254.html">[squid-users] Too many ERROR: Collapsed forwarding queue overflow for kid2 at 1024 items
</A></li>
	<LI>Next message (by thread): <A HREF="024270.html">[squid-users] Too many ERROR: Collapsed forwarding queue overflow for kid2 at 1024 items
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24256">[ date ]</a>
              <a href="thread.html#24256">[ thread ]</a>
              <a href="subject.html#24256">[ subject ]</a>
              <a href="author.html#24256">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
