<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Multi-clients VPS - Authentication been shared.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Multi-clients%20VPS%20-%20Authentication%20been%20shared.&In-Reply-To=%3C00aa01d7dcbe%247a9a2ba0%246fce82e0%24%40graminsta.com.br%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="024257.html">
   <LINK REL="Next"  HREF="024265.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Multi-clients VPS - Authentication been shared.</H1>
    <B>Graminsta</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Multi-clients%20VPS%20-%20Authentication%20been%20shared.&In-Reply-To=%3C00aa01d7dcbe%247a9a2ba0%246fce82e0%24%40graminsta.com.br%3E"
       TITLE="[squid-users] Multi-clients VPS - Authentication been shared.">marcelorodrigo at graminsta.com.br
       </A><BR>
    <I>Thu Nov 18 20:54:26 UTC 2021</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="024257.html">[squid-users] Multi-clients VPS - Authentication been shared.
</A></li>
        <LI>Next message (by thread): <A HREF="024265.html">[squid-users] Multi-clients VPS - Authentication been shared.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24264">[ date ]</a>
              <a href="thread.html#24264">[ thread ]</a>
              <a href="subject.html#24264">[ subject ]</a>
              <a href="author.html#24264">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Tks for the answers.

Considerations:

1- &quot;Please note that you are allowing authenticated clients to send traffic
to unsafe ports. For example, they can CONNECT to non-SSL ports. You may
want to reorder the above rules if that is not what you want.&quot;

ANSWER:
Tks for the advice, I already had it changed.


2- &quot;However, you should also ask yourself another question: &quot;Why am I using
multiple http_ports if all I care about is who uses which
tcp_outgoing_address?&quot;. The listening ports have virtually nothing to do
with tcp_outgoing_address...&quot;

ANSWER:
Because I have to route each http_port to specific tcp_outgoing_address.
I have several customers per VPS.
Each one uses like 10 different ports to direct connections through
different IPv6s.

3- &quot;Use http_access to deny authenticated users connected to wrong ports.&quot;

ANSWER:
So, in this scenario, how can I prevent users in the same users list to
access ports that not belong to them.
How to deny it in http_access rules?

Marcelo

-----Mensagem original-----
De: squid-users [mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>] Em nome
de <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-request at lists.squid-cache.org</A>
Enviada em: ter&#231;a-feira, 16 de novembro de 2021 15:23
Para: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
Assunto: squid-users Digest, Vol 87, Issue 19

Send squid-users mailing list submissions to
	<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>

To subscribe or unsubscribe via the World Wide Web, visit
	<A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
or, via email, send a message with subject or body 'help' to
	<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-request at lists.squid-cache.org</A>

You can reach the person managing the list at
	<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-owner at lists.squid-cache.org</A>

When replying, please edit your Subject line so it is more specific than
&quot;Re: Contents of squid-users digest...&quot;


Today's Topics:

   1. Multi-clients VPS - Authentication been shared. (Graminsta)
   2. Re: Too many ERROR: Collapsed forwarding queue overflow for
      kid2 at 1024 items (Lou?ansk? Luk??)
   3. Re: Stable Squid Version for production on Linux (David Touzeau)
   4. Re: Too many ERROR: Collapsed forwarding queue overflow for
      kid2 at 1024 items (Alex Rousskov)
   5. Re: Multi-clients VPS - Authentication been shared.
      (Alex Rousskov)


----------------------------------------------------------------------

Message: 1
Date: Tue, 16 Nov 2021 13:53:52 -0300
From: &quot;Graminsta&quot; &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">marcelorodrigo at graminsta.com.br</A>&gt;
To: &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>&gt;
Subject: [squid-users] Multi-clients VPS - Authentication been shared.
Message-ID: &lt;005e01d7db0a$8ab2ab80$a0180280$@graminsta.com.br&gt;
Content-Type: text/plain; charset=&quot;us-ascii&quot;

Hello friends,

 

I'm using these user authentication lines in squid.conf based on user's
authentication list:

 

auth_param basic program /usr/lib/squid/basic_ncsa_auth /etc/squid/users

auth_param basic children 5

auth_param basic realm Squid proxy-caching web server

auth_param basic credentialsttl 2 hours

auth_param basic casesensitive off

 

http_access allow localhost

acl clientes proxy_auth REQUIRED

http_access allow clientes

http_access deny !Safe_ports

http_access deny CONNECT !SSL_ports

http_access allow localhost manager

http_access deny manager

http_access deny all

 

#List of outgoings (all IPs are fake)

http_port 181.111.11.111:4000 name=3

acl ip3 myportname 3

tcp_outgoing_address 2804:1934:2E1::3D6 ip3

 

http_port 181.111.11.112:4001 name=4

acl ip4 myportname 4

tcp_outgoing_address 2804:1934:3a8::3D7 ip4

 

The problem is that everyone whom is in the users file are allow to use all
tcp_outgoing_address.

If a smarter client scans for open IPs and ports will be able to find these
outgoings.

 

How can I restrict each user to their own tcp_outgoing_address output?

 

Tks.

Marcelo

-------------- next part --------------
An HTML attachment was scrubbed...
URL:
&lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20211116/69f">http://lists.squid-cache.org/pipermail/squid-users/attachments/20211116/69f</A>
b0a22/attachment-0001.htm&gt;

------------------------------

Message: 2
Date: Tue, 16 Nov 2021 18:00:56 +0100
From: Lou?ansk? Luk?? &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">Loucansky.Lukas at kjj.cz</A>&gt;
To: &quot;Alex Rousskov&quot; &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt;, &quot;Squid Users&quot;
	&lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>&gt;
Subject: Re: [squid-users] Too many ERROR: Collapsed forwarding queue
	overflow for kid2 at 1024 items
Message-ID:
	&lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">72DD5D5CF661B5459DC08A060BF26B53010897A8 at kjj-server.KJJ.local</A>&gt;
Content-Type: text/plain;	charset=&quot;windows-1250&quot;

Ok - I will try to backport it from that patch into the v5 tree I've
downloaded today. As we were using the mentioned build I came across these
new assertions:

2021/11/16 10:29:46 kid1| assertion failed: StoreMap.cc:241:
&quot;anchorAt(anchorId).reading()&quot;
2021/11/16 11:32:51 kid2| assertion failed: Transients.cc:221: &quot;old == e&quot;
2021/11/16 13:02:09 kid2| assertion failed: Transients.cc:221: &quot;old == e&quot;
2021/11/16 13:52:05 kid2| assertion failed: Transients.cc:221: &quot;old == e&quot;
2021/11/16 14:29:41 kid2| assertion failed: store.cc:1108: &quot;store_status ==
STORE_PENDING&quot;
2021/11/16 15:26:15 kid1| assertion failed: Transients.cc:221: &quot;old == e&quot;
2021/11/16 17:40:21 kid1| assertion failed: cbdata.cc:372: &quot;c-&gt;locks &gt; 0&quot;
2021/11/16 17:40:44 kid1| assertion failed: cbdata.cc:115: &quot;cookie ==
((long)this ^ Cookie)&quot; 


(no config changes)

My 1w cache.log is about 300MB - without elevated debug options (debug
options ALL,1) - so it?s not easy to find something relevant with &quot;9&quot;
options enabled...

LL

-----Original Message-----
From: Alex Rousskov [mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>]
Sent: Tuesday, November 16, 2021 3:42 PM
To: Lou?ansk? Luk??; Squid Users
Subject: Re: [squid-users] Too many ERROR: Collapsed forwarding queue
overflow for kid2 at 1024 items

On 11/16/21 4:38 AM, Lou?ansk? Luk?? wrote:
&gt;<i> is it going to be patched only in the v6 version? 
</I>
I hope the existing fix applies to v5 cleanly, and I am ready to help with
backporting if it does not. Beyond that, it is in the maintainer hands. I
cannot predict whether or when the fix will be officially merged into v5
because I do not understand how those decisions are made.


&gt;<i> Anyway - in the morning I run debug with 20,9 to see:
</I>&gt;<i> ...
</I>&gt;<i> 2021/11/16 09:02:06.496 kid2| assertion failed: Transients.cc:221: &quot;old ==
</I>e&quot;

Unfortunately, I cannot see the cause of the assertion in this short/partial
trace -- the problematic actions happened before the trace or were not
logged during the trace.

Patching your Squid with commit 5210df4 is the best next step IMO. If that
patch does not help, then there are probably other bugs that we need to fix
in v5 (at least).


HTH,

Alex.


&gt;<i> -----Original Message-----
</I>&gt;<i> From: Alex Rousskov [mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>]
</I>&gt;<i> Sent: Monday, November 15, 2021 5:17 PM
</I>&gt;<i> To: Squid Users
</I>&gt;<i> Cc: Lou?ansk? Luk??
</I>&gt;<i> Subject: Re: [squid-users] Too many ERROR: Collapsed forwarding queue 
</I>&gt;<i> overflow for kid2 at 1024 items
</I>&gt;<i> 
</I>&gt;<i> On 11/15/21 7:43 AM, Lou?ansk? Luk?? wrote:
</I>&gt;<i> 
</I>&gt;&gt;<i> 2021/11/14 10:13:30 kid2| assertion failed: Transients.cc:221: &quot;old == e&quot;
</I>&gt;&gt;<i> 2021/11/15 08:37:36 kid2| assertion failed: Transients.cc:221: &quot;old == e&quot;
</I>&gt;&gt;<i> 2021/11/15 11:54:14 kid1| assertion failed: Transients.cc:221: &quot;old == e&quot;
</I>&gt;&gt;<i> 2021/11/15 12:16:27 kid1| assertion failed: Transients.cc:221: &quot;old == e&quot;
</I>&gt;<i> 
</I>&gt;<i> I recommend ignoring queue overflows until the above assertions are fixed
</I>because worker deaths cause queue overflows. Your Squid is buggy, and those
bugs essentially cause queue overflows.
&gt;<i> 
</I>&gt;<i> The assertion itself is known as Bug 5134:
</I>&gt;<i> <A HREF="https://bugs.squid-cache.org/show_bug.cgi?id=5134">https://bugs.squid-cache.org/show_bug.cgi?id=5134</A>
</I>&gt;<i> 
</I>&gt;<i> That bug has a speculative fix (master/v6 commit 5210df4). Please try it
</I>if you can.
&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> HTH,
</I>&gt;<i> 
</I>&gt;<i> Alex.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> -----Original Message-----
</I>&gt;&gt;<i> From: Alex Rousskov [mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>]
</I>&gt;&gt;<i> Sent: Friday, November 12, 2021 5:24 PM
</I>&gt;&gt;<i> To: Lou?ansk? Luk??; <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;&gt;<i> Subject: Re: [squid-users] Too many ERROR: Collapsed forwarding queue 
</I>&gt;&gt;<i> overflow for kid2 at 1024 items
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> On 11/11/21 10:19 AM, Lou?ansk? Luk?? wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> recently I'm facing too many ERROR: Collapsed forwarding queue 
</I>&gt;&gt;&gt;<i> overflow for kid2 at 1024 items lines in my Squid 5.2 log files.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> We see those overflows when kids die. Do you see any FATAL messages,
</I>assertions, or similar deadly errors in cache.log?
&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Could someone elaborate how the queue is filled - what is clogging it?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The sender/writer sends messages faster than the recipient/reader is 
</I>&gt;&gt;<i> reading them, eventually exceeding the queue capacity (i.e. 1024 
</I>&gt;&gt;<i> messages). These messages are about Store entries that may need 
</I>&gt;&gt;<i> synchronization across workers. Each message is very sm
</I>&gt;<i> all.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> I don't mind too much if I have to turn collapsed forwarding off
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Most likely, the problem is not tied to collapsed forwarding. These 
</I>&gt;&gt;<i> queues were used for collapsed forwarding when they were added, but 
</I>&gt;&gt;<i> they are used for regular traffic as well in modern SMP Squids. We 
</I>&gt;&gt;<i> need to change the queue names (and related code/m
</I>&gt;<i> essage text) to reflect the expanded nature of these queues.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> HTH,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Alex.
</I>&gt;&gt;<i>
</I>


------------------------------

Message: 3
Date: Tue, 16 Nov 2021 18:33:30 +0100
From: David Touzeau &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">david at articatech.com</A>&gt;
To: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
Subject: Re: [squid-users] Stable Squid Version for production on
	Linux
Message-ID: &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">60b9c5c9-202c-ad3c-c90d-a78f45f6c89c at articatech.com</A>&gt;
Content-Type: text/plain; charset=&quot;utf-8&quot;; Format=&quot;flowed&quot;

Hi,

For us it is Squid v4.17

Le 16/11/2021 ? 17:40, Graminsta a ?crit?:
&gt;<i>
</I>&gt;<i> Hey folks ?;)
</I>&gt;<i>
</I>&gt;<i> What is the most stable squid version for production on Ubuntu 18 or 20?
</I>&gt;<i>
</I>&gt;<i> Marcelo
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL:
&lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20211116/5b3">http://lists.squid-cache.org/pipermail/squid-users/attachments/20211116/5b3</A>
1cc34/attachment-0001.htm&gt;

------------------------------

Message: 4
Date: Tue, 16 Nov 2021 13:09:12 -0500
From: Alex Rousskov &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt;
To: Lou?ansk? Luk?? &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">Loucansky.Lukas at kjj.cz</A>&gt;, Squid Users
	&lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>&gt;
Subject: Re: [squid-users] Too many ERROR: Collapsed forwarding queue
	overflow for kid2 at 1024 items
Message-ID:
	&lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">369d5766-b6ab-f4cd-8cef-64b298d84638 at measurement-factory.com</A>&gt;
Content-Type: text/plain; charset=windows-1250

On 11/16/21 12:00 PM, Lou?ansk? Luk?? wrote:

&gt;<i> I will try to backport it from that patch into the v5 tree I've 
</I>&gt;<i> downloaded today. As we were using the mentioned build I came across 
</I>&gt;<i> these new assertions:
</I>
&gt;<i> 2021/11/16 10:29:46 kid1| assertion failed: StoreMap.cc:241:
</I>&quot;anchorAt(anchorId).reading()&quot;
&gt;<i> 2021/11/16 11:32:51 kid2| assertion failed: Transients.cc:221: &quot;old == e&quot;
</I>&gt;<i> 2021/11/16 14:29:41 kid2| assertion failed: store.cc:1108: &quot;store_status
</I>== STORE_PENDING&quot;

I hope that at least some of the above assertions are fixed by master/v6
commit 5210df4.


&gt;<i> 2021/11/16 17:40:21 kid1| assertion failed: cbdata.cc:372: &quot;c-&gt;locks &gt; 0&quot;
</I>&gt;<i> 2021/11/16 17:40:44 kid1| assertion failed: cbdata.cc:115: &quot;cookie ==
</I>((long)this ^ Cookie)&quot; 

This is probably an unrelated bug. I recommend filing a bug report in Squid
bugzilla and posting the corresponding &quot;bt full&quot; backtrace there.


Alex.


&gt;<i> -----Original Message-----
</I>&gt;<i> From: Alex Rousskov [mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>]
</I>&gt;<i> Sent: Tuesday, November 16, 2021 3:42 PM
</I>&gt;<i> To: Lou?ansk? Luk??; Squid Users
</I>&gt;<i> Subject: Re: [squid-users] Too many ERROR: Collapsed forwarding queue 
</I>&gt;<i> overflow for kid2 at 1024 items
</I>&gt;<i> 
</I>&gt;<i> On 11/16/21 4:38 AM, Lou?ansk? Luk?? wrote:
</I>&gt;&gt;<i> is it going to be patched only in the v6 version? 
</I>&gt;<i> 
</I>&gt;<i> I hope the existing fix applies to v5 cleanly, and I am ready to help with
</I>backporting if it does not. Beyond that, it is in the maintainer hands. I
cannot predict whether or when the fix will be officially merged into v5
because I do not understand how those decisions are made.
&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> Anyway - in the morning I run debug with 20,9 to see:
</I>&gt;&gt;<i> ...
</I>&gt;&gt;<i> 2021/11/16 09:02:06.496 kid2| assertion failed: Transients.cc:221: &quot;old
</I>== e&quot;
&gt;<i> 
</I>&gt;<i> Unfortunately, I cannot see the cause of the assertion in this
</I>short/partial trace -- the problematic actions happened before the trace or
were not logged during the trace.
&gt;<i> 
</I>&gt;<i> Patching your Squid with commit 5210df4 is the best next step IMO. If that
</I>patch does not help, then there are probably other bugs that we need to fix
in v5 (at least).
&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> HTH,
</I>&gt;<i> 
</I>&gt;<i> Alex.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> -----Original Message-----
</I>&gt;&gt;<i> From: Alex Rousskov [mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>]
</I>&gt;&gt;<i> Sent: Monday, November 15, 2021 5:17 PM
</I>&gt;&gt;<i> To: Squid Users
</I>&gt;&gt;<i> Cc: Lou?ansk? Luk??
</I>&gt;&gt;<i> Subject: Re: [squid-users] Too many ERROR: Collapsed forwarding queue 
</I>&gt;&gt;<i> overflow for kid2 at 1024 items
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> On 11/15/21 7:43 AM, Lou?ansk? Luk?? wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> 2021/11/14 10:13:30 kid2| assertion failed: Transients.cc:221: &quot;old ==
</I>e&quot;
&gt;&gt;&gt;<i> 2021/11/15 08:37:36 kid2| assertion failed: Transients.cc:221: &quot;old ==
</I>e&quot;
&gt;&gt;&gt;<i> 2021/11/15 11:54:14 kid1| assertion failed: Transients.cc:221: &quot;old ==
</I>e&quot;
&gt;&gt;&gt;<i> 2021/11/15 12:16:27 kid1| assertion failed: Transients.cc:221: &quot;old ==
</I>e&quot;
&gt;&gt;<i>
</I>&gt;&gt;<i> I recommend ignoring queue overflows until the above assertions are fixed
</I>because worker deaths cause queue overflows. Your Squid is buggy, and those
bugs essentially cause queue overflows.
&gt;&gt;<i>
</I>&gt;&gt;<i> The assertion itself is known as Bug 5134:
</I>&gt;&gt;<i> <A HREF="https://bugs.squid-cache.org/show_bug.cgi?id=5134">https://bugs.squid-cache.org/show_bug.cgi?id=5134</A>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> That bug has a speculative fix (master/v6 commit 5210df4). Please try it
</I>if you can.
&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> HTH,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Alex.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> -----Original Message-----
</I>&gt;&gt;&gt;<i> From: Alex Rousskov [mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>]
</I>&gt;&gt;&gt;<i> Sent: Friday, November 12, 2021 5:24 PM
</I>&gt;&gt;&gt;<i> To: Lou?ansk? Luk??; <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;&gt;&gt;<i> Subject: Re: [squid-users] Too many ERROR: Collapsed forwarding 
</I>&gt;&gt;&gt;<i> queue overflow for kid2 at 1024 items
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> On 11/11/21 10:19 AM, Lou?ansk? Luk?? wrote:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> recently I'm facing too many ERROR: Collapsed forwarding queue 
</I>&gt;&gt;&gt;&gt;<i> overflow for kid2 at 1024 items lines in my Squid 5.2 log files.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> We see those overflows when kids die. Do you see any FATAL messages,
</I>assertions, or similar deadly errors in cache.log?
&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> Could someone elaborate how the queue is filled - what is clogging it?
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> The sender/writer sends messages faster than the recipient/reader is 
</I>&gt;&gt;&gt;<i> reading them, eventually exceeding the queue capacity (i.e. 1024 
</I>&gt;&gt;&gt;<i> messages). These messages are about Store entries that may need 
</I>&gt;&gt;&gt;<i> synchronization across workers. Each message is very sm
</I>&gt;&gt;<i> all.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> I don't mind too much if I have to turn collapsed forwarding off
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Most likely, the problem is not tied to collapsed forwarding. These 
</I>&gt;&gt;&gt;<i> queues were used for collapsed forwarding when they were added, but 
</I>&gt;&gt;&gt;<i> they are used for regular traffic as well in modern SMP Squids. We 
</I>&gt;&gt;&gt;<i> need to change the queue names (and related code/m
</I>&gt;&gt;<i> essage text) to reflect the expanded nature of these queues.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> HTH,
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Alex.
</I>&gt;&gt;&gt;<i>
</I>


------------------------------

Message: 5
Date: Tue, 16 Nov 2021 13:23:00 -0500
From: Alex Rousskov &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt;
To: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
Subject: Re: [squid-users] Multi-clients VPS - Authentication been
	shared.
Message-ID:
	&lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">7d3ac49b-d2f7-fffa-cb2d-e2377b8ada5e at measurement-factory.com</A>&gt;
Content-Type: text/plain; charset=windows-1252

On 11/16/21 11:53 AM, Graminsta wrote:
&gt;<i> Hello friends,
</I>&gt;<i> 
</I>&gt;<i> ?
</I>&gt;<i> 
</I>&gt;<i> I'm using these user authentication lines in squid.conf based on 
</I>&gt;<i> user?s authentication list:
</I>&gt;<i> 
</I>&gt;<i> ?
</I>&gt;<i> 
</I>&gt;<i> auth_param basic program /usr/lib/squid/basic_ncsa_auth 
</I>&gt;<i> /etc/squid/users
</I>&gt;<i> 
</I>&gt;<i> auth_param basic children 5
</I>&gt;<i> 
</I>&gt;<i> auth_param basic realm Squid proxy-caching web server
</I>&gt;<i> 
</I>&gt;<i> auth_param basic credentialsttl 2 hours
</I>&gt;<i> 
</I>&gt;<i> auth_param basic casesensitive off
</I>&gt;<i> 
</I>&gt;<i> ?
</I>&gt;<i> 
</I>&gt;<i> http_access allow localhost
</I>&gt;<i> 
</I>&gt;<i> acl clientes proxy_auth REQUIRED
</I>&gt;<i> 
</I>&gt;<i> http_access allow clientes
</I>&gt;<i> http_access deny !Safe_ports
</I>&gt;<i> http_access deny CONNECT !SSL_ports
</I>&gt;<i> http_access allow localhost manager
</I>&gt;<i> http_access deny manager
</I>&gt;<i> http_access deny all
</I>
Please note that you are allowing authenticated clients to send traffic to
unsafe ports. For example, they can CONNECT to non-SSL ports. You may want
to reorder the above rules if that is not what you want.


&gt;<i> #List of outgoings (all IPs are fake)
</I>&gt;<i> 
</I>&gt;<i> http_port 181.111.11.111:4000 name=3
</I>&gt;<i> acl ip3 myportname 3
</I>&gt;<i> tcp_outgoing_address 2804:1934:2E1::3D6 ip3
</I>&gt;<i> 
</I>&gt;<i> ?
</I>&gt;<i> 
</I>&gt;<i> http_port 181.111.11.112:4001 name=4
</I>&gt;<i> acl ip4 myportname 4
</I>&gt;<i> tcp_outgoing_address 2804:1934:3a8::3D7 ip4
</I>&gt;<i> 
</I>&gt;<i> ?
</I>&gt;<i> 
</I>&gt;<i> The problem is that everyone whom is in the users file are allow to 
</I>&gt;<i> use all tcp_outgoing_address.
</I>&gt;<i> 
</I>&gt;<i> If a smarter client scans for open IPs and ports will be able to find 
</I>&gt;<i> these outgoings.
</I>&gt;<i> 
</I>&gt;<i> ?
</I>&gt;<i> 
</I>&gt;<i> How can I restrict each user to their own tcp_outgoing_address output?
</I>
I suspect you are asking the wrong question. A better question is &quot;How do I
restrict each user to their own http_port?&quot;. The answer is &quot;Use http_access
to deny authenticated users connected to wrong ports.&quot;

However, you should also ask yourself another question: &quot;Why am I using
multiple http_ports if all I care about is who uses which
tcp_outgoing_address?&quot;. The listening ports have virtually nothing to do
with tcp_outgoing_address...

I suspect you want something like this instead:

    http_port ...
    tcp_outgoing_address ...:3D01 user1
    tcp_outgoing_address ...:3D02 user2
    tcp_outgoing_address ...:3D03 user3
    ...

...where userN is an ACL that matches an authenticated user N.


HTH,

Alex.


------------------------------

Subject: Digest Footer

_______________________________________________
squid-users mailing list
<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
<A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>


------------------------------

End of squid-users Digest, Vol 87, Issue 19
*******************************************


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="024257.html">[squid-users] Multi-clients VPS - Authentication been shared.
</A></li>
	<LI>Next message (by thread): <A HREF="024265.html">[squid-users] Multi-clients VPS - Authentication been shared.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24264">[ date ]</a>
              <a href="thread.html#24264">[ thread ]</a>
              <a href="subject.html#24264">[ subject ]</a>
              <a href="author.html#24264">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
