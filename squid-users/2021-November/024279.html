<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Too many ERROR: Collapsed forwarding queue overflow for kid2 at 1024 items
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Too%20many%20ERROR%3A%20Collapsed%20forwarding%20queue%0A%20overflow%20for%20kid2%20at%201024%20items&In-Reply-To=%3C72DD5D5CF661B5459DC08A060BF26B53010897AC%40kjj-server.KJJ.local%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="024273.html">
   <LINK REL="Next"  HREF="024288.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Too many ERROR: Collapsed forwarding queue overflow for kid2 at 1024 items</H1>
    <B>Lou&#269;ansk&#253; Luk&#225;&#353;</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Too%20many%20ERROR%3A%20Collapsed%20forwarding%20queue%0A%20overflow%20for%20kid2%20at%201024%20items&In-Reply-To=%3C72DD5D5CF661B5459DC08A060BF26B53010897AC%40kjj-server.KJJ.local%3E"
       TITLE="[squid-users] Too many ERROR: Collapsed forwarding queue overflow for kid2 at 1024 items">Loucansky.Lukas at kjj.cz
       </A><BR>
    <I>Tue Nov 23 08:32:35 UTC 2021</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="024273.html">[squid-users] Too many ERROR: Collapsed forwarding queue overflow for kid2 at 1024 items
</A></li>
        <LI>Next message (by thread): <A HREF="024288.html">[squid-users] Too many ERROR: Collapsed forwarding queue overflow for kid2 at 1024 items
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24279">[ date ]</a>
              <a href="thread.html#24279">[ thread ]</a>
              <a href="subject.html#24279">[ subject ]</a>
              <a href="author.html#24279">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I agree - it seems I'm catching red herrings here. Restarted squid yesterday at about 11:30. Everything seemed ok until 8am today - when this assert was again raised: (note - it's another from these in version 5)

2021/11/23 08:00:15 kid2| assertion failed: store.cc:1094: &quot;store_status == STORE_PENDING&quot;

then kid2 restarted itself and after another 9mins the &quot;collapsed forwarding queue overflow&quot; message began filling my log file.

Besides this there was one &quot;unable to allocate 64kB mem&quot; error

Nov 23 06:27:01 proxy-gw (squid-1): FATAL: xmalloc: Unable to allocate 65535 bytes!#012#012    current master transaction: master54
Nov 23 06:27:01 proxy-gw squid[20213]: Squid Parent: squid-1 process 20221 exited due to signal 6 with status 0
Nov 23 06:27:01 proxy-gw squid[20213]: Squid Parent: (squid-1) process 24763 started

But it does not trigger the 1024 items overflow error.

Nov 23 08:00:16 proxy-gw squid[20213]: Squid Parent: squid-2 process 20220 exited due to signal 6 with status 0
Nov 23 08:00:16 proxy-gw squid[20213]: Squid Parent: (squid-2) process 25372 started

Is it possible that after kid worker restarts it stops synchronizing or sending messages via this queues? ie. like the new one is unable to process or read the messages intended for the old one? In on of the old mails I've posted  list from the cachemgr showing transient queues being filled - which I don't see if the queue overflow messageis not logged. But it showed more items even for kid1 receiving from kid1 and kid1 sending to kid1 - so why would it stop sending it to itself? As I'm a laymen in this field (can not see the whole picture or how it works) I'm not currently able to tell how to induce such behaviour or speculate why it's filling. So far I've recompiled squid with disabled optimizations and enabled backtraces - let's see what it does while it crashes again....

LL 

-----Original Message-----
From: Alex Rousskov [mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>] 
Sent: Monday, November 22, 2021 5:35 PM
To: Lou&#269;ansk&#253; Luk&#225;&#353;; <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
Subject: Re: [squid-users] Too many ERROR: Collapsed forwarding queue overflow for kid2 at 1024 items

On 11/22/21 3:59 AM, Lou&#269;ansk&#253; Luk&#225;&#353; wrote:

&gt;<i> I'm running Squid Object Cache: Version 6.0.0-20211116-r90086c5a8 for 
</I>&gt;<i> about 14hrs now. I've noticed many new  &quot;ERROR: Collapsed forwarding 
</I>&gt;<i> queue overflow for kid2 at 1024 items&quot; after about 11hrs runtime.
</I>
Ignore queue overflows (for now) because they are a known side effect of assertions.


&gt;<i> 2021/11/22 07:54:24 kid2| assertion failed: store.cc:1094: &quot;store_status == STORE_PENDING&quot;
</I>&gt;<i> 2021/11/22 08:51:48 kid1| assertion failed: store.cc:1094: &quot;store_status == STORE_PENDING&quot;
</I>
I recommend filing a bug report with Squid Bugzilla and providing a stack trace (&quot;bt full&quot;) from this assertion. If possible, please keep the core dump for further analysis.


Thank you,

Alex.



&gt;<i> -----Original Message-----
</I>&gt;<i> From: Alex Rousskov [mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>]
</I>&gt;<i> Sent: Sunday, November 21, 2021 8:28 PM
</I>&gt;<i> To: Lou&#269;ansk&#253; Luk&#225;&#353;; <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> Subject: Re: [squid-users] Too many ERROR: Collapsed forwarding queue 
</I>&gt;<i> overflow for kid2 at 1024 items
</I>&gt;<i> 
</I>&gt;<i> On 11/21/21 2:08 PM, Lou&#269;ansk&#253; Luk&#225;&#353; wrote:
</I>&gt;&gt;<i> Hello, I've replaced src/ipc/ReadWritelock.cc and ReadWriteLock.h 
</I>&gt;&gt;<i> with modified versions (with finalizeExclusive calls), but afeter 
</I>&gt;&gt;<i> some time I have got queue overflows agains.
</I>&gt;<i> 
</I>&gt;<i> After each bug fix, we have to restart the triage sequence from scratch:
</I>&gt;<i> Any assertions, crashes, FATAL messages or similar things leading to kid deaths? If they are present, then they explain queue overflows.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> So I've downloaded squid-6.0.0-20211116-r90086c5a8 - run it with my 
</I>&gt;&gt;<i> v5 configure and now I'm testing it. So far I get these:
</I>&gt;&gt;<i> 2021/11/21 19:05:06 kid1| BUG: missing ENTRY_REQUIRES_COLLAPSING for
</I>&gt;<i> 
</I>&gt;<i> Noted. If you cannot reproduce this bug at will, then I recommend focusing on other, easier-to-address problems first.
</I>&gt;<i> 
</I>&gt;<i> Alex.
</I>&gt;<i> 
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="024273.html">[squid-users] Too many ERROR: Collapsed forwarding queue overflow for kid2 at 1024 items
</A></li>
	<LI>Next message (by thread): <A HREF="024288.html">[squid-users] Too many ERROR: Collapsed forwarding queue overflow for kid2 at 1024 items
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24279">[ date ]</a>
              <a href="thread.html#24279">[ thread ]</a>
              <a href="subject.html#24279">[ subject ]</a>
              <a href="author.html#24279">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
