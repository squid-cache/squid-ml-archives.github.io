<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] squid 5 and parent peers
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid%205%20and%20parent%20peers&In-Reply-To=%3Csjrrhc%24lat%241%40ciao.gmane.io%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="024156.html">
   <LINK REL="Next"  HREF="024158.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] squid 5 and parent peers</H1>
    <B>Markus Moeller</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid%205%20and%20parent%20peers&In-Reply-To=%3Csjrrhc%24lat%241%40ciao.gmane.io%3E"
       TITLE="[squid-users] squid 5 and parent peers">huaraz at moeller.plus.com
       </A><BR>
    <I>Sat Oct  9 10:39:36 UTC 2021</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="024156.html">[squid-users] squid 5 and parent peers
</A></li>
        <LI>Next message (by thread): <A HREF="024158.html">[squid-users] squid 5 and parent peers
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24157">[ date ]</a>
              <a href="thread.html#24157">[ thread ]</a>
              <a href="subject.html#24157">[ subject ]</a>
              <a href="author.html#24157">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I understand now better the concept.

Thank you
Markus


&quot;Alex Rousskov&quot;  wrote in message 
news:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">3dec529a-b62e-1e95-6cb7-0b68f6bf3c8d at measurement-factory.com...</A>

On 10/8/21 8:02 PM, Markus Moeller wrote:

&gt;<i> I try to setup a proxy chain, but don't get the setup right. I have one
</I>&gt;<i> squid with 2 parents. One with auth for domainA.com and one w/o auth for
</I>&gt;<i> the non local IPs (i.e. Internet).
</I>
&gt;<i> With the below config I see domainA.com still going to the
</I>&gt;<i> unauthenticated parent proxy. Any hint why ?
</I>
Several factors can explain that, but I would start by rephrasing your
request routing requirements (and the corresponding configuration rules)
as mutually exclusive (if they are). Currently, you have formulated and
configured the equivalent of

* send green traffic to auth-proxy
* send blue traffic to parent-proxy

This approach leaves important questions like &quot;What about yellow
traffic?&quot; and &quot;What about traffic with green and blue dots?&quot; unanswered.

If you want every request to go to either auth-proxy or parent-proxy,
then say so explicitly:

# green (and only green!) traffic to auth-proxy
cache_peer_access auth-proxy allow green
cache_peer_access auth-proxy deny all

# not green (and only not green!) traffic to parent-proxy
cache_peer_access auth-proxy deny green
cache_peer_access auth-proxy allow all

What &quot;green&quot; means exactly in your case, I do not know (due to the
questions like those listed above).


If you want every request to go to either auth-proxy, parent-proxy, or
direct, then your rules will become a bit more complex, but all three
routes should still be mutually exclusive:

# green (and only green) traffic to auth-proxy
# but exclude traffic that should go direct
cache_peer_access auth-proxy deny meantToGoDirect
cache_peer_access auth-proxy allow green
cache_peer_access auth-proxy deny all

# not green (and only not green) traffic to parent-proxy
# but exclude traffic that should go direct
cache_peer_access auth-proxy deny meantToGoDirect
cache_peer_access auth-proxy deny green
cache_peer_access auth-proxy allow all

# traffic that should go direct (and only that traffic)
# should always go direct
always_direct allow meantToGoDirect
always_direct deny all

# traffic that should not go direct (and only that traffic)
# should never go direct
never_direct deny meantToGoDirect
never_direct allow all

Disclaimer: The above configuration snippets are not complete, are not
tested, and can probably be reduced (some might say &quot;simplified&quot;) if you
prefer to rely on certain defaults. See also: nonhierarchical_direct.

Once you get the above working for plain HTTP requests that have
resolvable domain names as targets, please note that your listA ACL will
not work for requests that have IP addresses, including some CONNECT
requests that ask your Squid to tunnel HTTPS traffic. Your Squid may not
get any such requests, but if it does, then your &quot;green&quot; and
&quot;meantToGoDirect&quot; ACLs may need to be more complex than &quot;dstdomain -n&quot;
and &quot;dst&quot;.


HTH,

Alex.
P.S. I would not call the second proxy &quot;parent-proxy&quot; because both of
your proxies are configured as parent proxies.



&gt;<i> # Recommended minimum configuration:
</I>&gt;<i> #
</I>&gt;<i>
</I>&gt;<i> # Example rule allowing access from your local networks.
</I>&gt;<i> # Adapt to list your (internal) IP networks from where browsing
</I>&gt;<i> # should be allowed
</I>&gt;<i> acl localnet src 0.0.0.1-0.255.255.255  # RFC 1122 &quot;this&quot; network (LAN)
</I>&gt;<i> acl localnet src 10.0.0.0/8             # RFC 1918 local private network
</I>&gt;<i> (LAN)
</I>&gt;<i> acl localnet src 100.64.0.0/10          # RFC 6598 shared address space
</I>&gt;<i> (CGN)
</I>&gt;<i> acl localnet src 169.254.0.0/16         # RFC 3927 link-local (directly
</I>&gt;<i> plugged) machines
</I>&gt;<i> acl localnet src 172.16.0.0/12          # RFC 1918 local private network
</I>&gt;<i> (LAN)
</I>&gt;<i> acl localnet src 192.168.0.0/16         # RFC 1918 local private network
</I>&gt;<i> (LAN)
</I>&gt;<i> acl localnet src fc00::/7               # RFC 4193 local private network
</I>&gt;<i> range
</I>&gt;<i> acl localnet src fe80::/10              # RFC 4291 link-local (directly
</I>&gt;<i> plugged) machines
</I>&gt;<i>
</I>&gt;<i> acl localdst dst 10.0.0.0/8             # RFC 1918 local private network
</I>&gt;<i> (LAN)
</I>&gt;<i> acl localdst dst 100.64.0.0/10          # RFC 6598 shared address space
</I>&gt;<i> (CGN)
</I>&gt;<i> acl localdst dst 169.254.0.0/16         # RFC 3927 link-local (directly
</I>&gt;<i> plugged) machines
</I>&gt;<i> acl localdst dst 172.16.0.0/12          # RFC 1918 local private network
</I>&gt;<i> (LAN)
</I>&gt;<i> acl localdst dst 192.168.0.0/16         # RFC 1918 local private network
</I>&gt;<i> (LAN)
</I>&gt;<i> acl localdst dst fc00::/7               # RFC 4193 local private network
</I>&gt;<i> range
</I>&gt;<i> acl localdst dst fe80::/10              # RFC 4291 link-local (directly
</I>&gt;<i> plugged) machines
</I>&gt;<i>
</I>&gt;<i> acl listA dstdomain -n  domainA.com
</I>&gt;<i>
</I>&gt;<i> acl SSL_ports port 443
</I>&gt;<i> acl Safe_ports port 80          # http
</I>&gt;<i> acl Safe_ports port 21          # ftp
</I>&gt;<i> acl Safe_ports port 443         # https
</I>&gt;<i> acl Safe_ports port 70          # gopher
</I>&gt;<i> acl Safe_ports port 210         # wais
</I>&gt;<i> acl Safe_ports port 1025-65535  # unregistered ports
</I>&gt;<i> acl Safe_ports port 280         # http-mgmt
</I>&gt;<i> acl Safe_ports port 488         # gss-http
</I>&gt;<i> acl Safe_ports port 591         # filemaker
</I>&gt;<i> acl Safe_ports port 777         # multiling http
</I>&gt;<i>
</I>&gt;<i> cache_peer auth-proxy parent   3128 0  no-query default login=NEGOTIATE
</I>&gt;<i> cache_peer parent-proxy parent   3128 0  no-query default
</I>&gt;<i> cache_peer_access auth-proxy allow listA
</I>&gt;<i> cache_peer_access parent-proxy allow !localdst
</I>&gt;<i> never_direct deny localdst
</I>&gt;<i> never_direct allow all
</I>&gt;<i>
</I>&gt;<i> debug_options 44,10 11,20
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>
_______________________________________________
squid-users mailing list
<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
<A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A> 



</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="024156.html">[squid-users] squid 5 and parent peers
</A></li>
	<LI>Next message (by thread): <A HREF="024158.html">[squid-users] squid 5 and parent peers
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24157">[ date ]</a>
              <a href="thread.html#24157">[ thread ]</a>
              <a href="subject.html#24157">[ subject ]</a>
              <a href="author.html#24157">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
