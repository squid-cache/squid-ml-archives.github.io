<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] squid 5 and parent peers
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid%205%20and%20parent%20peers&In-Reply-To=%3Csjs44m%24une%241%40ciao.gmane.io%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="024157.html">
   <LINK REL="Next"  HREF="024159.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] squid 5 and parent peers</H1>
    <B>Markus Moeller</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid%205%20and%20parent%20peers&In-Reply-To=%3Csjs44m%24une%241%40ciao.gmane.io%3E"
       TITLE="[squid-users] squid 5 and parent peers">huaraz at moeller.plus.com
       </A><BR>
    <I>Sat Oct  9 13:06:24 UTC 2021</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="024157.html">[squid-users] squid 5 and parent peers
</A></li>
        <LI>Next message (by thread): <A HREF="024159.html">[squid-users] squid 5 and parent peers
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24158">[ date ]</a>
              <a href="thread.html#24158">[ thread ]</a>
              <a href="subject.html#24158">[ subject ]</a>
              <a href="author.html#24158">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

I have now tested with the below config and I see my first request works, 
but the second fails. So I am not sure if it is still a configuration issue 
or something else.


....
# Example rule allowing access from your local networks.
# Adapt to list your (internal) IP networks from where browsing
# should be allowed
#acl localnet src 0.0.0.1-0.255.255.255  # RFC 1122 &quot;this&quot; network (LAN)
acl localnet src 10.0.0.0/8             # RFC 1918 local private network 
(LAN)
acl localnet src 100.64.0.0/10          # RFC 6598 shared address space 
(CGN)
acl localnet src 169.254.0.0/16         # RFC 3927 link-local (directly 
plugged) machines
acl localnet src 172.16.0.0/12          # RFC 1918 local private network 
(LAN)
acl localnet src 192.168.0.0/16         # RFC 1918 local private network 
(LAN)
acl localnet src fc00::/7               # RFC 4193 local private network 
range
acl localnet src fe80::/10              # RFC 4291 link-local (directly 
plugged) machines

#acl localdst dst 0.0.0.1-0.255.255.255  # RFC 1122 &quot;this&quot; network (LAN)
acl localdst dst 10.0.0.0/8             # RFC 1918 local private network 
(LAN)
acl localdst dst 100.64.0.0/10          # RFC 6598 shared address space 
(CGN)
acl localdst dst 169.254.0.0/16         # RFC 3927 link-local (directly 
plugged) machines
acl localdst dst 172.16.0.0/12          # RFC 1918 local private network 
(LAN)
acl localdst dst 192.168.0.0/16         # RFC 1918 local private network 
(LAN)
acl localdst dst fc00::/7               # RFC 4193 local private network 
range
acl localdst dst fe80::/10              # RFC 4291 link-local (directly 
plugged) machines

acl google dstdomain -n .google.com

cache_peer internetproxy.example.com parent 8080 0 no-query no-digest 
no-netdb-exchange default
cache_peer authproxy.example.com parent 8080 0 no-query no-digest 
no-netdb-exchange default login=NEGOTIATE auth-no-keytab
# Only google to auth proxy
cache_peer_access authproxy.example.com deny localdst
cache_peer_access authproxy.example.com allow google
cache_peer_access authproxy.example.com deny all
# All other external domains
cache_peer_access internetproxy.example.com deny localdst
cache_peer_access internetproxy.example.com deny google
cache_peer_access internetproxy.example.com allow all
# Local goes direct
always_direct allow localdst
always_direct deny all
never_direct deny !localdst
never_direct allow all

debug_options 44,10 11,20

....

The first test looked fine:

#curl -vvv -x <A HREF="http://localhost:3128">http://localhost:3128</A> <A HREF="http://www.google.com">http://www.google.com</A>
* Uses proxy env variable no_proxy == 'localhost, 127.0.0.1'
*   Trying 127.0.0.1:3128...
* Connected to localhost (127.0.0.1) port 3128 (#0)
&gt;<i> GET <A HREF="http://www.google.com/">http://www.google.com/</A> HTTP/1.1
</I>&gt;<i> Host: www.google.com
</I>&gt;<i> User-Agent: curl/7.75.0
</I>&gt;<i> Accept: */*
</I>&gt;<i> Proxy-Connection: Keep-Alive
</I>&gt;<i>
</I>* Mark bundle as not supporting multiuse
&lt; HTTP/1.1 301 Moved Permanently
&lt; Location: <A HREF="https://www.google.com/">https://www.google.com/</A>
&lt; Content-Length: 0
&lt; Date: Sat, 09 Oct 2021 12:29:23 GMT
&lt; X-Cache: MISS from clientproxy
&lt; X-Cache-Lookup: MISS from clientproxy:3128
&lt; Connection: keep-alive
&lt;
* Connection #0 to host localhost left intact


Second request failed with a cache error:


#curl -vvv -x <A HREF="http://localhost:3128">http://localhost:3128</A> <A HREF="http://www.google.com">http://www.google.com</A>
* Uses proxy env variable no_proxy == 'localhost, 127.0.0.1'
*   Trying 127.0.0.1:3128...
* Connected to localhost (127.0.0.1) port 3128 (#0)
&gt;<i> GET <A HREF="http://www.google.com/">http://www.google.com/</A> HTTP/1.1
</I>&gt;<i> Host: www.google.com
</I>&gt;<i> User-Agent: curl/7.75.0
</I>&gt;<i> Accept: */*
</I>&gt;<i> Proxy-Connection: Keep-Alive
</I>&gt;<i>
</I>* Mark bundle as not supporting multiuse
&lt; HTTP/1.1 503 Service Unavailable
&lt; Server: squid/5.1-VCS
&lt; Mime-Version: 1.0
&lt; Date: Sat, 09 Oct 2021 12:30:27 GMT
&lt; Content-Type: text/html;charset=utf-8
&lt; Content-Length: 3573
&lt; X-Squid-Error: ERR_CONNECT_FAIL 110
&lt; Vary: Accept-Language
&lt; Content-Language: en
&lt; X-Cache: MISS from clientproxy
&lt; X-Cache-Lookup: MISS from clientproxy:3128
&lt; Connection: keep-alive
&lt;
&lt;!DOCTYPE html PUBLIC &quot;-//W3C//DTD HTML 4.01//EN&quot; 
<A HREF="http://www.w3.org/TR/html4/strict.dtd">http://www.w3.org/TR/html4/strict.dtd</A>&gt;
&lt;html&gt;&lt;head&gt;
&lt;meta type=&quot;copyright&quot; content=&quot;Copyright (C) 1996-2021 The Squid Software 
Foundation and contributors&quot;&gt;
&lt;meta http-equiv=&quot;Content-Type&quot; CONTENT=&quot;text/html; charset=utf-8&quot;&gt;
&lt;title&gt;ERROR: The requested URL could not be retrieved&lt;/title&gt;
.....


The cache log says:

2021/10/09 13:29:23.520 kid1| 11,2| client_side.cc(1353) parseHttpRequest: 
HTTP Client conn10 local=127.0.0.1:3128 remote=127.0.0.1:45192 FD 12 flags=1
2021/10/09 13:29:23.520 kid1| 11,2| client_side.cc(1354) parseHttpRequest: 
HTTP Client REQUEST:
---------
GET <A HREF="http://www.google.com/">http://www.google.com/</A> HTTP/1.1
Host: www.google.com
User-Agent: curl/7.75.0
Accept: */*
Proxy-Connection: Keep-Alive


----------
2021/10/09 13:29:23.520 kid1| 44,3| peer_select.cc(309) peerSelect: 
e:=IV/0x12e63f0*2 <A HREF="http://www.google.com/">http://www.google.com/</A>
2021/10/09 13:29:23.520 kid1| 44,7| peer_select.cc(1149) 
interestedInitiator: PeerSelector1
2021/10/09 13:29:23.520 kid1| 44,3| peer_select.cc(612) selectMore: GET 
www.google.com
2021/10/09 13:29:23.520 kid1| 44,3| peer_select.cc(617) selectMore: direct = 
DIRECT_UNKNOWN (always_direct to be checked)
2021/10/09 13:29:23.523 kid1| 44,3| peer_select.cc(373) 
checkAlwaysDirectDone: DENIED
2021/10/09 13:29:23.523 kid1| 44,7| peer_select.cc(1149) 
interestedInitiator: PeerSelector1
2021/10/09 13:29:23.523 kid1| 44,3| peer_select.cc(612) selectMore: GET 
www.google.com
2021/10/09 13:29:23.523 kid1| 44,3| peer_select.cc(626) selectMore: direct = 
DIRECT_UNKNOWN (never_direct to be checked)
2021/10/09 13:29:23.523 kid1| 44,3| peer_select.cc(345) 
checkNeverDirectDone: DENIED
2021/10/09 13:29:23.523 kid1| 44,7| peer_select.cc(1149) 
interestedInitiator: PeerSelector1
2021/10/09 13:29:23.523 kid1| 44,3| peer_select.cc(612) selectMore: GET 
www.google.com
2021/10/09 13:29:23.523 kid1| 44,3| peer_select.cc(577) checkNetdbDirect: MY 
RTT = 0 msec
2021/10/09 13:29:23.523 kid1| 44,3| peer_select.cc(578) checkNetdbDirect: 
minimum_direct_rtt = 400 msec
2021/10/09 13:29:23.523 kid1| 44,3| peer_select.cc(585) checkNetdbDirect: MY 
hops = 0
2021/10/09 13:29:23.523 kid1| 44,3| peer_select.cc(586) checkNetdbDirect: 
minimum_direct_hops = 4
2021/10/09 13:29:23.523 kid1| 44,3| peer_select.cc(647) selectMore: direct = 
DIRECT_MAYBE (default)
2021/10/09 13:29:23.523 kid1| 44,3| peer_select.cc(650) selectMore: direct = 
DIRECT_MAYBE
2021/10/09 13:29:23.523 kid1| 44,3| peer_select.cc(286) peerSelectIcpPing: 
<A HREF="http://www.google.com/">http://www.google.com/</A>
2021/10/09 13:29:23.523 kid1| 44,3| peer_select.cc(297) peerSelectIcpPing: 
counted 0 neighbors
2021/10/09 13:29:23.523 kid1| 44,3| peer_select.cc(833) selectSomeParent: 
GET www.google.com
2021/10/09 13:29:23.523 kid1| 44,3| peer_select.cc(1098) addSelection: 
adding FIRSTUP_PARENT/authproxy.example.com
2021/10/09 13:29:23.523 kid1| 44,3| peer_select.cc(1091) addSelection: 
skipping ANY_OLD_PARENT/authproxy.example.com; have 
FIRSTUP_PARENT/authproxy.example.com
2021/10/09 13:29:23.523 kid1| 44,3| peer_select.cc(1091) addSelection: 
skipping DEFAULT_PARENT/authproxy.example.com; have 
FIRSTUP_PARENT/authproxy.example.com
2021/10/09 13:29:23.523 kid1| 44,3| peer_select.cc(1098) addSelection: 
adding HIER_DIRECT#www.google.com
2021/10/09 13:29:23.523 kid1| 44,7| peer_select.cc(1149) 
interestedInitiator: PeerSelector1
2021/10/09 13:29:23.523 kid1| 44,2| peer_select.cc(460) resolveSelected: 
Find IP destination for: <A HREF="http://www.google.com/">http://www.google.com/</A>' via authproxy.example.com
2021/10/09 13:29:23.523 kid1| 44,7| peer_select.cc(1149) 
interestedInitiator: PeerSelector1
2021/10/09 13:29:23.523 kid1| 44,2| peer_select.cc(1171) handlePath: 
PeerSelector1 found conn11 local=0.0.0.0 remote=10.20.1.1:8080 
FIRSTUP_PARENT flags=1, destination #1 for <A HREF="http://www.google.com/">http://www.google.com/</A>
2021/10/09 13:29:23.523 kid1| 44,2| peer_select.cc(1177) handlePath: 
always_direct = DENIED
2021/10/09 13:29:23.523 kid1| 44,2| peer_select.cc(1178) handlePath: 
never_direct = DENIED
2021/10/09 13:29:23.523 kid1| 44,2| peer_select.cc(1179) handlePath: 
timedout = 0
2021/10/09 13:29:23.523 kid1| 44,7| peer_select.cc(1149) 
interestedInitiator: PeerSelector1
2021/10/09 13:29:23.523 kid1| 11,7| HttpRequest.cc(468) clearError: old: 
ERR_NONE
2021/10/09 13:29:23.524 kid1| 44,7| peer_select.cc(1149) 
interestedInitiator: PeerSelector1
2021/10/09 13:29:23.524 kid1| 44,7| peer_select.cc(1149) 
interestedInitiator: PeerSelector1
2021/10/09 13:29:23.524 kid1| 44,2| peer_select.cc(460) resolveSelected: 
Find IP destination for: <A HREF="http://www.google.com/">http://www.google.com/</A>' via www.google.com
2021/10/09 13:29:23.524 kid1| 44,7| peer_select.cc(1149) 
interestedInitiator: PeerSelector1
2021/10/09 13:29:23.524 kid1| 44,2| peer_select.cc(1171) handlePath: 
PeerSelector1 found conn12 local=0.0.0.0 remote=172.217.23.100:80 
HIER_DIRECT flags=1, destination #2 for <A HREF="http://www.google.com/">http://www.google.com/</A>
2021/10/09 13:29:23.524 kid1| 44,2| peer_select.cc(1177) handlePath: 
always_direct = DENIED
2021/10/09 13:29:23.524 kid1| 44,2| peer_select.cc(1178) handlePath: 
never_direct = DENIED
2021/10/09 13:29:23.524 kid1| 44,2| peer_select.cc(1179) handlePath: 
timedout = 0
2021/10/09 13:29:23.524 kid1| 44,7| peer_select.cc(1149) 
interestedInitiator: PeerSelector1
2021/10/09 13:29:23.524 kid1| 44,7| peer_select.cc(1149) 
interestedInitiator: PeerSelector1
2021/10/09 13:29:23.524 kid1| 44,7| peer_select.cc(1149) 
interestedInitiator: PeerSelector1
2021/10/09 13:29:23.524 kid1| 44,2| peer_select.cc(479) resolveSelected: 
PeerSelector1 found all 2 destinations for <A HREF="http://www.google.com/">http://www.google.com/</A>
2021/10/09 13:29:23.524 kid1| 44,2| peer_select.cc(480) resolveSelected: 
always_direct = DENIED
2021/10/09 13:29:23.524 kid1| 44,2| peer_select.cc(481) resolveSelected: 
never_direct = DENIED
2021/10/09 13:29:23.524 kid1| 44,2| peer_select.cc(482) resolveSelected: 
timedout = 0
2021/10/09 13:29:23.524 kid1| 44,7| peer_select.cc(1149) 
interestedInitiator: PeerSelector1
2021/10/09 13:29:23.524 kid1| 44,3| peer_select.cc(241) ~PeerSelector: 
<A HREF="http://www.google.com/">http://www.google.com/</A>
2021/10/09 13:29:23.526 kid1| 11,4| HttpRequest.cc(453) prepForPeering: 
0x1154cf0 to authproxy.example.com proxy
2021/10/09 13:29:23.526 kid1| 11,3| http.cc(2486) httpStart: GET 
<A HREF="http://www.google.com/">http://www.google.com/</A>
2021/10/09 13:29:23.527 kid1| 11,5| http.cc(87) HttpStateData: HttpStateData 
0x12e9988 created
2021/10/09 13:29:23.527 kid1| 11,5| http.cc(2367) sendRequest: conn13 
local=10.10.1.1:36928 remote=10.20.1.1:8080 FIRSTUP_PARENT FD 13 flags=1, 
request 0x1154cf0*6, this 0x12e9988.
2021/10/09 13:29:23.527 kid1| 11,5| AsyncCall.cc(29) AsyncCall: The 
AsyncCall HttpStateData::httpTimeout constructed, this=0x12e8920 [call65]
2021/10/09 13:29:23.527 kid1| 11,8| http.cc(1656) maybeMakeSpaceAvailable: 
may read up to 65536 bytes info buf(0/65536) from conn13 
local=10.10.1.1:36928 remote=10.20.1.1:8080 FIRSTUP_PARENT FD 13 flags=1
2021/10/09 13:29:23.527 kid1| 11,5| AsyncCall.cc(29) AsyncCall: The 
AsyncCall HttpStateData::readReply constructed, this=0x12f9c10 [call66]
2021/10/09 13:29:23.527 kid1| 11,5| AsyncCall.cc(29) AsyncCall: The 
AsyncCall HttpStateData::wroteLast constructed, this=0x12f9cc0 [call67]
2021/10/09 13:29:23.527 kid1| 11,8| http.cc(2309) decideIfWeDoRanges: 
decideIfWeDoRanges: range specs: 0, cachable: 1; we_do_ranges: 0
2021/10/09 13:29:23.527 kid1| 11,5| http.cc(2113) 
copyOneHeaderFromClientsideRequestToUpstreamRequest: httpBuildRequestHeader: 
User-Agent: curl/7.75.0
2021/10/09 13:29:23.527 kid1| 11,5| http.cc(2113) 
copyOneHeaderFromClientsideRequestToUpstreamRequest: httpBuildRequestHeader: 
Accept: */*
2021/10/09 13:29:23.527 kid1| 11,5| http.cc(2113) 
copyOneHeaderFromClientsideRequestToUpstreamRequest: httpBuildRequestHeader: 
Proxy-Connection: Keep-Alive
2021/10/09 13:29:23.527 kid1| 11,5| http.cc(2113) 
copyOneHeaderFromClientsideRequestToUpstreamRequest: httpBuildRequestHeader: 
Host: www.google.com
2021/10/09 13:29:23.527 kid1| 11,5| peer_proxy_negotiate_auth.cc(539) 
peer_proxy_negotiate_auth: Import gss name
2021/10/09 13:29:23.527 kid1| 11,5| peer_proxy_negotiate_auth.cc(546) 
peer_proxy_negotiate_auth: Initialize gss security context
2021/10/09 13:29:23.531 kid1| 11,5| peer_proxy_negotiate_auth.cc(560) 
peer_proxy_negotiate_auth: Got token with length 2568
2021/10/09 13:29:23.531 kid1| 11,2| http.cc(2442) sendRequest: HTTP Server 
conn13 local=10.10.1.1:36928 remote=10.20.1.1:8080 FIRSTUP_PARENT FD 13 
flags=1
2021/10/09 13:29:23.531 kid1| 11,2| http.cc(2443) sendRequest: HTTP Server 
REQUEST:
---------
GET <A HREF="http://www.google.com/">http://www.google.com/</A> HTTP/1.1
User-Agent: curl/7.75.0
Accept: */*
Host: www.google.com
Proxy-Authorization: Negotiate YIIK....
Cache-Control: max-age=259200
Connection: keep-alive


----------
2021/10/09 13:29:23.531 kid1| 11,5| AsyncCall.cc(96) ScheduleCall: 
IoCallback.cc(131) will call HttpStateData::wroteLast(conn13 
local=10.10.1.1:36928 remote=10.20.1.1:8080 FIRSTUP_PARENT FD 13 flags=1, 
data=0x12e9988) [call67]
2021/10/09 13:29:23.531 kid1| 11,5| AsyncCallQueue.cc(59) fireNext: entering 
HttpStateData::wroteLast(conn13 local=10.10.1.1:36928 remote=10.20.1.1:8080 
FIRSTUP_PARENT FD 13 flags=1, data=0x12e9988)
2021/10/09 13:29:23.531 kid1| 11,5| AsyncCall.cc(41) make: make call 
HttpStateData::wroteLast [call67]
2021/10/09 13:29:23.531 kid1| 11,5| AsyncJob.cc(122) callStart: 
HttpStateData status in: [ job8]
2021/10/09 13:29:23.531 kid1| 11,5| http.cc(1667) wroteLast: conn13 
local=10.10.1.1:36928 remote=10.20.1.1:8080 FIRSTUP_PARENT FD 13 flags=1: 
size 3611: errflag 0.
2021/10/09 13:29:23.531 kid1| 11,5| AsyncCall.cc(29) AsyncCall: The 
AsyncCall HttpStateData::httpTimeout constructed, this=0xe34fa0 [call69]
2021/10/09 13:29:23.531 kid1| 11,5| AsyncJob.cc(153) callEnd: HttpStateData 
status out: [ job8]
2021/10/09 13:29:23.531 kid1| 11,5| AsyncCallQueue.cc(61) fireNext: leaving 
HttpStateData::wroteLast(conn13 local=10.10.1.1:36928 remote=10.20.1.1:8080 
FIRSTUP_PARENT FD 13 flags=1, data=0x12e9988)
2021/10/09 13:29:23.615 kid1| 11,5| AsyncCall.cc(96) ScheduleCall: 
IoCallback.cc(131) will call HttpStateData::readReply(conn13 
local=10.10.1.1:36928 remote=10.20.1.1:8080 FIRSTUP_PARENT FD 13 flags=1, 
data=0x12e9988) [call66]
2021/10/09 13:29:23.615 kid1| 11,5| AsyncCallQueue.cc(59) fireNext: entering 
HttpStateData::readReply(conn13 local=10.10.1.1:36928 remote=10.20.1.1:8080 
FIRSTUP_PARENT FD 13 flags=1, data=0x12e9988)
2021/10/09 13:29:23.615 kid1| 11,5| AsyncCall.cc(41) make: make call 
HttpStateData::readReply [call66]
2021/10/09 13:29:23.615 kid1| 11,5| AsyncJob.cc(122) callStart: 
HttpStateData status in: [ job8]
2021/10/09 13:29:23.615 kid1| 11,5| http.cc(1215) readReply: conn13 
local=10.10.1.1:36928 remote=10.20.1.1:8080 FIRSTUP_PARENT FD 13 flags=1
2021/10/09 13:29:23.615 kid1| ctx: enter level  0: '<A HREF="http://www.google.com/">http://www.google.com/</A>'
2021/10/09 13:29:23.615 kid1| 11,3| http.cc(666) processReplyHeader: 
processReplyHeader: key '0200000000000000843D000001000000'
2021/10/09 13:29:23.615 kid1| 11,2| http.cc(720) processReplyHeader: HTTP 
Server conn13 local=10.10.1.1:36928 remote=10.20.1.1:8080 FIRSTUP_PARENT FD 
13 flags=1
2021/10/09 13:29:23.615 kid1| 11,2| http.cc(721) processReplyHeader: HTTP 
Server RESPONSE:
---------
HTTP/1.1 301 Moved Permanently
Location: <A HREF="https://www.google.com/">https://www.google.com/</A>
Content-Length: 0
Proxy-Connection: Keep-Alive

----------
2021/10/09 13:29:23.616 kid1| 11,5| Client.cc(119) setVirginReply: 0x12e9988 
setting virgin reply to 0x12fa850
2021/10/09 13:29:23.616 kid1| ctx: exit level  0
2021/10/09 13:29:23.616 kid1| 11,5| Client.cc(973) adaptOrFinalizeReply: 
adaptationAccessCheckPending=0
2021/10/09 13:29:23.616 kid1| 11,5| Client.cc(139) setFinalReply: 0x12e9988 
setting final reply to 0x12fa850
2021/10/09 13:29:23.616 kid1| ctx: enter level  0: '<A HREF="http://www.google.com/">http://www.google.com/</A>'
2021/10/09 13:29:23.616 kid1| 11,3| http.cc(979) haveParsedReplyHeaders: 
HTTP CODE: 301
2021/10/09 13:29:23.616 kid1| 11,3| http.cc(1054) haveParsedReplyHeaders: 
decided: do not cache but share because refresh check returned 
non-cacheable; HTTP status 301 e:=p2XIV/0x12e63f0*3
2021/10/09 13:29:23.616 kid1| ctx: exit level  0
2021/10/09 13:29:23.616 kid1| 11,2| Stream.cc(279) sendStartOfMessage: HTTP 
Client conn10 local=127.0.0.1:3128 remote=127.0.0.1:45192 FD 12 flags=1
2021/10/09 13:29:23.616 kid1| 11,2| Stream.cc(280) sendStartOfMessage: HTTP 
Client REPLY:
---------
HTTP/1.1 301 Moved Permanently
Location: <A HREF="https://www.google.com/">https://www.google.com/</A>
Content-Length: 0
Date: Sat, 09 Oct 2021 12:29:23 GMT
X-Cache: MISS from clientproxy
X-Cache-Lookup: MISS from clientproxy:3128
Connection: keep-alive


----------
2021/10/09 13:29:23.616 kid1| 11,5| http.cc(1491) processReplyBody: 
adaptationAccessCheckPending=0
2021/10/09 13:29:23.616 kid1| 11,3| http.cc(1154) persistentConnStatus: 
conn13 local=10.10.1.1:36928 remote=10.20.1.1:8080 FIRSTUP_PARENT FD 13 
flags=1 eof=0
2021/10/09 13:29:23.616 kid1| 11,5| http.cc(1174) persistentConnStatus: 
persistentConnStatus: content_length=0
2021/10/09 13:29:23.616 kid1| 11,5| http.cc(1178) persistentConnStatus: 
persistentConnStatus: clen=0
2021/10/09 13:29:23.616 kid1| 11,5| http.cc(1537) processReplyBody: 
processReplyBody: COMPLETE_PERSISTENT_MSG from conn13 local=10.10.1.1:36928 
remote=10.20.1.1:8080 FIRSTUP_PARENT FD 13 flags=1
2021/10/09 13:29:23.616 kid1| 11,5| Client.cc(162) serverComplete: 
serverComplete 0x12e9988
2021/10/09 13:29:23.616 kid1| 11,5| Client.cc(184) serverComplete2: 
serverComplete2 0x12e9988
2021/10/09 13:29:23.616 kid1| 11,5| Client.cc(212) completeForwarding: 
completing forwarding for 0x12e6e28*2
2021/10/09 13:29:23.616 kid1| 11,5| Client.cc(586) cleanAdaptation: cleaning 
ICAP; ACL: 0
2021/10/09 13:29:23.616 kid1| 11,5| http.cc(134) ~HttpStateData: 
HttpStateData 0x12e9988 destroyed;
2021/10/09 13:29:23.616 kid1| 11,5| AsyncCallQueue.cc(61) fireNext: leaving 
HttpStateData::readReply(conn13 local=10.10.1.1:36928 remote=10.20.1.1:8080 
FIRSTUP_PARENT FD 13 flags=1, data=0x12e9988)
2021/10/09 13:29:27.287 kid1| 11,2| client_side.cc(1353) parseHttpRequest: 
HTTP Client conn15 local=127.0.0.1:3128 remote=127.0.0.1:45219 FD 12 flags=1
2021/10/09 13:29:27.287 kid1| 11,2| client_side.cc(1354) parseHttpRequest: 
HTTP Client REQUEST:
---------
GET <A HREF="http://www.google.com/">http://www.google.com/</A> HTTP/1.1
Host: www.google.com
User-Agent: curl/7.75.0
Accept: */*
Proxy-Connection: Keep-Alive


----------
2021/10/09 13:29:27.287 kid1| 44,3| peer_select.cc(309) peerSelect: 
e:=IV/0x12e63f0*2 <A HREF="http://www.google.com/">http://www.google.com/</A>
2021/10/09 13:29:27.287 kid1| 44,7| peer_select.cc(1149) 
interestedInitiator: PeerSelector2
2021/10/09 13:29:27.287 kid1| 44,3| peer_select.cc(612) selectMore: GET 
www.google.com
2021/10/09 13:29:27.287 kid1| 44,3| peer_select.cc(617) selectMore: direct = 
DIRECT_UNKNOWN (always_direct to be checked)
2021/10/09 13:29:27.287 kid1| 44,3| peer_select.cc(373) 
checkAlwaysDirectDone: DENIED
2021/10/09 13:29:27.287 kid1| 44,7| peer_select.cc(1149) 
interestedInitiator: PeerSelector2
2021/10/09 13:29:27.287 kid1| 44,3| peer_select.cc(612) selectMore: GET 
www.google.com
2021/10/09 13:29:27.287 kid1| 44,3| peer_select.cc(626) selectMore: direct = 
DIRECT_UNKNOWN (never_direct to be checked)
2021/10/09 13:29:27.287 kid1| 44,3| peer_select.cc(345) 
checkNeverDirectDone: DENIED
2021/10/09 13:29:27.287 kid1| 44,7| peer_select.cc(1149) 
interestedInitiator: PeerSelector2
2021/10/09 13:29:27.287 kid1| 44,3| peer_select.cc(612) selectMore: GET 
www.google.com
2021/10/09 13:29:27.287 kid1| 44,3| peer_select.cc(577) checkNetdbDirect: MY 
RTT = 1 msec
2021/10/09 13:29:27.287 kid1| 44,3| peer_select.cc(578) checkNetdbDirect: 
minimum_direct_rtt = 400 msec
2021/10/09 13:29:27.287 kid1| 44,3| peer_select.cc(644) selectMore: direct = 
DIRECT_YES (checkNetdbDirect)
2021/10/09 13:29:27.287 kid1| 44,3| peer_select.cc(650) selectMore: direct = 
DIRECT_YES
2021/10/09 13:29:27.287 kid1| 44,3| peer_select.cc(1098) addSelection: 
adding HIER_DIRECT#www.google.com
2021/10/09 13:29:27.287 kid1| 44,7| peer_select.cc(1149) 
interestedInitiator: PeerSelector2
2021/10/09 13:29:27.287 kid1| 44,2| peer_select.cc(460) resolveSelected: 
Find IP destination for: <A HREF="http://www.google.com/">http://www.google.com/</A>' via www.google.com
2021/10/09 13:29:27.287 kid1| 44,7| peer_select.cc(1149) 
interestedInitiator: PeerSelector2
2021/10/09 13:29:27.287 kid1| 44,2| peer_select.cc(1171) handlePath: 
PeerSelector2 found conn16 local=0.0.0.0 remote=172.217.23.100:80 
HIER_DIRECT flags=1, destination #1 for <A HREF="http://www.google.com/">http://www.google.com/</A>
2021/10/09 13:29:27.287 kid1| 44,2| peer_select.cc(1177) handlePath: 
always_direct = DENIED
2021/10/09 13:29:27.287 kid1| 44,2| peer_select.cc(1178) handlePath: 
never_direct = DENIED
2021/10/09 13:29:27.287 kid1| 44,2| peer_select.cc(1179) handlePath: 
timedout = 0
2021/10/09 13:29:27.287 kid1| 44,7| peer_select.cc(1149) 
interestedInitiator: PeerSelector2
2021/10/09 13:29:27.287 kid1| 11,7| HttpRequest.cc(468) clearError: old: 
ERR_NONE
2021/10/09 13:29:27.287 kid1| 44,7| peer_select.cc(1149) 
interestedInitiator: PeerSelector2
2021/10/09 13:29:27.287 kid1| 44,7| peer_select.cc(1149) 
interestedInitiator: PeerSelector2
2021/10/09 13:29:27.287 kid1| 44,2| peer_select.cc(479) resolveSelected: 
PeerSelector2 found all 1 destinations for <A HREF="http://www.google.com/">http://www.google.com/</A>
2021/10/09 13:29:27.287 kid1| 44,2| peer_select.cc(480) resolveSelected: 
always_direct = DENIED
2021/10/09 13:29:27.287 kid1| 44,2| peer_select.cc(481) resolveSelected: 
never_direct = DENIED
2021/10/09 13:29:27.287 kid1| 44,2| peer_select.cc(482) resolveSelected: 
timedout = 0
2021/10/09 13:29:27.287 kid1| 44,7| peer_select.cc(1149) 
interestedInitiator: PeerSelector2
2021/10/09 13:29:27.287 kid1| 44,3| peer_select.cc(241) ~PeerSelector: 
<A HREF="http://www.google.com/">http://www.google.com/</A>
2021/10/09 13:30:27.421 kid1| 11,2| Stream.cc(279) sendStartOfMessage: HTTP 
Client conn15 local=127.0.0.1:3128 remote=127.0.0.1:45219 FD 12 flags=1
2021/10/09 13:30:27.421 kid1| 11,2| Stream.cc(280) sendStartOfMessage: HTTP 
Client REPLY:
---------
HTTP/1.1 503 Service Unavailable
Server: squid/5.1-VCS
Mime-Version: 1.0
Date: Sat, 09 Oct 2021 12:30:27 GMT
Content-Type: text/html;charset=utf-8
Content-Length: 3573
X-Squid-Error: ERR_CONNECT_FAIL 110
Vary: Accept-Language
Content-Language: en
X-Cache: MISS from clientproxy
X-Cache-Lookup: MISS from clientproxy:3128
Connection: keep-alive


----------






Thank you
Markus





&quot;Markus Moeller&quot;  wrote in message news:sjrrhc$lat$<A HREF="https://lists.squid-cache.org/listinfo/squid-users">1 at ciao.gmane.io...</A>

I understand now better the concept.

Thank you
Markus


&quot;Alex Rousskov&quot;  wrote in message
news:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">3dec529a-b62e-1e95-6cb7-0b68f6bf3c8d at measurement-factory.com...</A>

On 10/8/21 8:02 PM, Markus Moeller wrote:

&gt;<i> I try to setup a proxy chain, but don't get the setup right. I have one
</I>&gt;<i> squid with 2 parents. One with auth for domainA.com and one w/o auth for
</I>&gt;<i> the non local IPs (i.e. Internet).
</I>
&gt;<i> With the below config I see domainA.com still going to the
</I>&gt;<i> unauthenticated parent proxy. Any hint why ?
</I>
Several factors can explain that, but I would start by rephrasing your
request routing requirements (and the corresponding configuration rules)
as mutually exclusive (if they are). Currently, you have formulated and
configured the equivalent of

* send green traffic to auth-proxy
* send blue traffic to parent-proxy

This approach leaves important questions like &quot;What about yellow
traffic?&quot; and &quot;What about traffic with green and blue dots?&quot; unanswered.

If you want every request to go to either auth-proxy or parent-proxy,
then say so explicitly:

# green (and only green!) traffic to auth-proxy
cache_peer_access auth-proxy allow green
cache_peer_access auth-proxy deny all

# not green (and only not green!) traffic to parent-proxy
cache_peer_access auth-proxy deny green
cache_peer_access auth-proxy allow all

What &quot;green&quot; means exactly in your case, I do not know (due to the
questions like those listed above).


If you want every request to go to either auth-proxy, parent-proxy, or
direct, then your rules will become a bit more complex, but all three
routes should still be mutually exclusive:

# green (and only green) traffic to auth-proxy
# but exclude traffic that should go direct
cache_peer_access auth-proxy deny meantToGoDirect
cache_peer_access auth-proxy allow green
cache_peer_access auth-proxy deny all

# not green (and only not green) traffic to parent-proxy
# but exclude traffic that should go direct
cache_peer_access auth-proxy deny meantToGoDirect
cache_peer_access auth-proxy deny green
cache_peer_access auth-proxy allow all

# traffic that should go direct (and only that traffic)
# should always go direct
always_direct allow meantToGoDirect
always_direct deny all

# traffic that should not go direct (and only that traffic)
# should never go direct
never_direct deny meantToGoDirect
never_direct allow all

Disclaimer: The above configuration snippets are not complete, are not
tested, and can probably be reduced (some might say &quot;simplified&quot;) if you
prefer to rely on certain defaults. See also: nonhierarchical_direct.

Once you get the above working for plain HTTP requests that have
resolvable domain names as targets, please note that your listA ACL will
not work for requests that have IP addresses, including some CONNECT
requests that ask your Squid to tunnel HTTPS traffic. Your Squid may not
get any such requests, but if it does, then your &quot;green&quot; and
&quot;meantToGoDirect&quot; ACLs may need to be more complex than &quot;dstdomain -n&quot;
and &quot;dst&quot;.


HTH,

Alex.
P.S. I would not call the second proxy &quot;parent-proxy&quot; because both of
your proxies are configured as parent proxies.



&gt;<i> # Recommended minimum configuration:
</I>&gt;<i> #
</I>&gt;<i>
</I>&gt;<i> # Example rule allowing access from your local networks.
</I>&gt;<i> # Adapt to list your (internal) IP networks from where browsing
</I>&gt;<i> # should be allowed
</I>&gt;<i> acl localnet src 0.0.0.1-0.255.255.255  # RFC 1122 &quot;this&quot; network (LAN)
</I>&gt;<i> acl localnet src 10.0.0.0/8             # RFC 1918 local private network
</I>&gt;<i> (LAN)
</I>&gt;<i> acl localnet src 100.64.0.0/10          # RFC 6598 shared address space
</I>&gt;<i> (CGN)
</I>&gt;<i> acl localnet src 169.254.0.0/16         # RFC 3927 link-local (directly
</I>&gt;<i> plugged) machines
</I>&gt;<i> acl localnet src 172.16.0.0/12          # RFC 1918 local private network
</I>&gt;<i> (LAN)
</I>&gt;<i> acl localnet src 192.168.0.0/16         # RFC 1918 local private network
</I>&gt;<i> (LAN)
</I>&gt;<i> acl localnet src fc00::/7               # RFC 4193 local private network
</I>&gt;<i> range
</I>&gt;<i> acl localnet src fe80::/10              # RFC 4291 link-local (directly
</I>&gt;<i> plugged) machines
</I>&gt;<i>
</I>&gt;<i> acl localdst dst 10.0.0.0/8             # RFC 1918 local private network
</I>&gt;<i> (LAN)
</I>&gt;<i> acl localdst dst 100.64.0.0/10          # RFC 6598 shared address space
</I>&gt;<i> (CGN)
</I>&gt;<i> acl localdst dst 169.254.0.0/16         # RFC 3927 link-local (directly
</I>&gt;<i> plugged) machines
</I>&gt;<i> acl localdst dst 172.16.0.0/12          # RFC 1918 local private network
</I>&gt;<i> (LAN)
</I>&gt;<i> acl localdst dst 192.168.0.0/16         # RFC 1918 local private network
</I>&gt;<i> (LAN)
</I>&gt;<i> acl localdst dst fc00::/7               # RFC 4193 local private network
</I>&gt;<i> range
</I>&gt;<i> acl localdst dst fe80::/10              # RFC 4291 link-local (directly
</I>&gt;<i> plugged) machines
</I>&gt;<i>
</I>&gt;<i> acl listA dstdomain -n  domainA.com
</I>&gt;<i>
</I>&gt;<i> acl SSL_ports port 443
</I>&gt;<i> acl Safe_ports port 80          # http
</I>&gt;<i> acl Safe_ports port 21          # ftp
</I>&gt;<i> acl Safe_ports port 443         # https
</I>&gt;<i> acl Safe_ports port 70          # gopher
</I>&gt;<i> acl Safe_ports port 210         # wais
</I>&gt;<i> acl Safe_ports port 1025-65535  # unregistered ports
</I>&gt;<i> acl Safe_ports port 280         # http-mgmt
</I>&gt;<i> acl Safe_ports port 488         # gss-http
</I>&gt;<i> acl Safe_ports port 591         # filemaker
</I>&gt;<i> acl Safe_ports port 777         # multiling http
</I>&gt;<i>
</I>&gt;<i> cache_peer auth-proxy parent   3128 0  no-query default login=NEGOTIATE
</I>&gt;<i> cache_peer parent-proxy parent   3128 0  no-query default
</I>&gt;<i> cache_peer_access auth-proxy allow listA
</I>&gt;<i> cache_peer_access parent-proxy allow !localdst
</I>&gt;<i> never_direct deny localdst
</I>&gt;<i> never_direct allow all
</I>&gt;<i>
</I>&gt;<i> debug_options 44,10 11,20
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>
_______________________________________________
squid-users mailing list
<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
<A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A> 



</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="024157.html">[squid-users] squid 5 and parent peers
</A></li>
	<LI>Next message (by thread): <A HREF="024159.html">[squid-users] squid 5 and parent peers
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24158">[ date ]</a>
              <a href="thread.html#24158">[ thread ]</a>
              <a href="subject.html#24158">[ subject ]</a>
              <a href="author.html#24158">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
