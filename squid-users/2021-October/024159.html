<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] squid 5 and parent peers
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid%205%20and%20parent%20peers&In-Reply-To=%3Ccbe23671-7b3c-e270-f3f4-593d4f030f36%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="024158.html">
   <LINK REL="Next"  HREF="024160.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] squid 5 and parent peers</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid%205%20and%20parent%20peers&In-Reply-To=%3Ccbe23671-7b3c-e270-f3f4-593d4f030f36%40measurement-factory.com%3E"
       TITLE="[squid-users] squid 5 and parent peers">rousskov at measurement-factory.com
       </A><BR>
    <I>Sat Oct  9 15:41:04 UTC 2021</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="024158.html">[squid-users] squid 5 and parent peers
</A></li>
        <LI>Next message (by thread): <A HREF="024160.html">[squid-users] squid 5 and parent peers
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24159">[ date ]</a>
              <a href="thread.html#24159">[ thread ]</a>
              <a href="subject.html#24159">[ subject ]</a>
              <a href="author.html#24159">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 10/9/21 9:06 AM, Markus Moeller wrote:
&gt;<i> Hi,
</I>&gt;<i> 
</I>&gt;<i> I have now tested with the below config and I see my first request
</I>&gt;<i> works, but the second fails. So I am not sure if it is still a
</I>&gt;<i> configuration issue or something else.
</I>

&gt;<i> always_direct allow localdst
</I>&gt;<i> never_direct deny !localdst
</I>
I (still) do not know what you want to achive exactly (see my previous
response for more specific questions), but the above combination looks
suspicious to me. I would expect traffic that should always go direct to
be denied in the never_direct rule instead. Did you mean for that &quot;!&quot; to
be there?

I did not check the debugging trace carefully, but it may be the reason
why Squid cannot forward some requests -- it is getting an
impossible-to-satisfy or self-contradictory directions.


BTW, thank you for posting the debugging trace! Please keep doing that
if you need further help.

Alex.


&gt;<i> ....
</I>&gt;<i> # Example rule allowing access from your local networks.
</I>&gt;<i> # Adapt to list your (internal) IP networks from where browsing
</I>&gt;<i> # should be allowed
</I>&gt;<i> #acl localnet src 0.0.0.1-0.255.255.255&#160; # RFC 1122 &quot;this&quot; network (LAN)
</I>&gt;<i> acl localnet src 10.0.0.0/8&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; # RFC 1918 local private network
</I>&gt;<i> (LAN)
</I>&gt;<i> acl localnet src 100.64.0.0/10&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; # RFC 6598 shared address space
</I>&gt;<i> (CGN)
</I>&gt;<i> acl localnet src 169.254.0.0/16&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; # RFC 3927 link-local (directly
</I>&gt;<i> plugged) machines
</I>&gt;<i> acl localnet src 172.16.0.0/12&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; # RFC 1918 local private network
</I>&gt;<i> (LAN)
</I>&gt;<i> acl localnet src 192.168.0.0/16&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; # RFC 1918 local private network
</I>&gt;<i> (LAN)
</I>&gt;<i> acl localnet src fc00::/7&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; # RFC 4193 local private network
</I>&gt;<i> range
</I>&gt;<i> acl localnet src fe80::/10&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; # RFC 4291 link-local (directly
</I>&gt;<i> plugged) machines
</I>&gt;<i> 
</I>&gt;<i> #acl localdst dst 0.0.0.1-0.255.255.255&#160; # RFC 1122 &quot;this&quot; network (LAN)
</I>&gt;<i> acl localdst dst 10.0.0.0/8&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; # RFC 1918 local private network
</I>&gt;<i> (LAN)
</I>&gt;<i> acl localdst dst 100.64.0.0/10&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; # RFC 6598 shared address space
</I>&gt;<i> (CGN)
</I>&gt;<i> acl localdst dst 169.254.0.0/16&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; # RFC 3927 link-local (directly
</I>&gt;<i> plugged) machines
</I>&gt;<i> acl localdst dst 172.16.0.0/12&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; # RFC 1918 local private network
</I>&gt;<i> (LAN)
</I>&gt;<i> acl localdst dst 192.168.0.0/16&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; # RFC 1918 local private network
</I>&gt;<i> (LAN)
</I>&gt;<i> acl localdst dst fc00::/7&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; # RFC 4193 local private network
</I>&gt;<i> range
</I>&gt;<i> acl localdst dst fe80::/10&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; # RFC 4291 link-local (directly
</I>&gt;<i> plugged) machines
</I>&gt;<i> 
</I>&gt;<i> acl google dstdomain -n .google.com
</I>&gt;<i> 
</I>&gt;<i> cache_peer internetproxy.example.com parent 8080 0 no-query no-digest
</I>&gt;<i> no-netdb-exchange default
</I>&gt;<i> cache_peer authproxy.example.com parent 8080 0 no-query no-digest
</I>&gt;<i> no-netdb-exchange default login=NEGOTIATE auth-no-keytab
</I>&gt;<i> # Only google to auth proxy
</I>&gt;<i> cache_peer_access authproxy.example.com deny localdst
</I>&gt;<i> cache_peer_access authproxy.example.com allow google
</I>&gt;<i> cache_peer_access authproxy.example.com deny all
</I>&gt;<i> # All other external domains
</I>&gt;<i> cache_peer_access internetproxy.example.com deny localdst
</I>&gt;<i> cache_peer_access internetproxy.example.com deny google
</I>&gt;<i> cache_peer_access internetproxy.example.com allow all
</I>&gt;<i> # Local goes direct
</I>&gt;<i> always_direct allow localdst
</I>&gt;<i> always_direct deny all
</I>&gt;<i> never_direct deny !localdst
</I>&gt;<i> never_direct allow all
</I>&gt;<i> 
</I>&gt;<i> debug_options 44,10 11,20
</I>&gt;<i> 
</I>&gt;<i> ....
</I>&gt;<i> 
</I>&gt;<i> The first test looked fine:
</I>&gt;<i> 
</I>&gt;<i> #curl -vvv -x <A HREF="http://localhost:3128">http://localhost:3128</A> <A HREF="http://www.google.com">http://www.google.com</A>
</I>&gt;<i> * Uses proxy env variable no_proxy == 'localhost, 127.0.0.1'
</I>&gt;<i> *&#160;&#160; Trying 127.0.0.1:3128...
</I>&gt;<i> * Connected to localhost (127.0.0.1) port 3128 (#0)
</I>&gt;&gt;<i> GET <A HREF="http://www.google.com/">http://www.google.com/</A> HTTP/1.1
</I>&gt;&gt;<i> Host: www.google.com
</I>&gt;&gt;<i> User-Agent: curl/7.75.0
</I>&gt;&gt;<i> Accept: */*
</I>&gt;&gt;<i> Proxy-Connection: Keep-Alive
</I>&gt;&gt;<i>
</I>&gt;<i> * Mark bundle as not supporting multiuse
</I>&gt;<i> &lt; HTTP/1.1 301 Moved Permanently
</I>&gt;<i> &lt; Location: <A HREF="https://www.google.com/">https://www.google.com/</A>
</I>&gt;<i> &lt; Content-Length: 0
</I>&gt;<i> &lt; Date: Sat, 09 Oct 2021 12:29:23 GMT
</I>&gt;<i> &lt; X-Cache: MISS from clientproxy
</I>&gt;<i> &lt; X-Cache-Lookup: MISS from clientproxy:3128
</I>&gt;<i> &lt; Connection: keep-alive
</I>&gt;<i> &lt;
</I>&gt;<i> * Connection #0 to host localhost left intact
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Second request failed with a cache error:
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> #curl -vvv -x <A HREF="http://localhost:3128">http://localhost:3128</A> <A HREF="http://www.google.com">http://www.google.com</A>
</I>&gt;<i> * Uses proxy env variable no_proxy == 'localhost, 127.0.0.1'
</I>&gt;<i> *&#160;&#160; Trying 127.0.0.1:3128...
</I>&gt;<i> * Connected to localhost (127.0.0.1) port 3128 (#0)
</I>&gt;&gt;<i> GET <A HREF="http://www.google.com/">http://www.google.com/</A> HTTP/1.1
</I>&gt;&gt;<i> Host: www.google.com
</I>&gt;&gt;<i> User-Agent: curl/7.75.0
</I>&gt;&gt;<i> Accept: */*
</I>&gt;&gt;<i> Proxy-Connection: Keep-Alive
</I>&gt;&gt;<i>
</I>&gt;<i> * Mark bundle as not supporting multiuse
</I>&gt;<i> &lt; HTTP/1.1 503 Service Unavailable
</I>&gt;<i> &lt; Server: squid/5.1-VCS
</I>&gt;<i> &lt; Mime-Version: 1.0
</I>&gt;<i> &lt; Date: Sat, 09 Oct 2021 12:30:27 GMT
</I>&gt;<i> &lt; Content-Type: text/html;charset=utf-8
</I>&gt;<i> &lt; Content-Length: 3573
</I>&gt;<i> &lt; X-Squid-Error: ERR_CONNECT_FAIL 110
</I>&gt;<i> &lt; Vary: Accept-Language
</I>&gt;<i> &lt; Content-Language: en
</I>&gt;<i> &lt; X-Cache: MISS from clientproxy
</I>&gt;<i> &lt; X-Cache-Lookup: MISS from clientproxy:3128
</I>&gt;<i> &lt; Connection: keep-alive
</I>&gt;<i> &lt;
</I>&gt;<i> &lt;!DOCTYPE html PUBLIC &quot;-//W3C//DTD HTML 4.01//EN&quot;
</I>&gt;<i> <A HREF="http://www.w3.org/TR/html4/strict.dtd">http://www.w3.org/TR/html4/strict.dtd</A>&gt;
</I>&gt;<i> &lt;html&gt;&lt;head&gt;
</I>&gt;<i> &lt;meta type=&quot;copyright&quot; content=&quot;Copyright (C) 1996-2021 The Squid
</I>&gt;<i> Software Foundation and contributors&quot;&gt;
</I>&gt;<i> &lt;meta http-equiv=&quot;Content-Type&quot; CONTENT=&quot;text/html; charset=utf-8&quot;&gt;
</I>&gt;<i> &lt;title&gt;ERROR: The requested URL could not be retrieved&lt;/title&gt;
</I>&gt;<i> .....
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> The cache log says:
</I>&gt;<i> 
</I>&gt;<i> 2021/10/09 13:29:23.520 kid1| 11,2| client_side.cc(1353)
</I>&gt;<i> parseHttpRequest: HTTP Client conn10 local=127.0.0.1:3128
</I>&gt;<i> remote=127.0.0.1:45192 FD 12 flags=1
</I>&gt;<i> 2021/10/09 13:29:23.520 kid1| 11,2| client_side.cc(1354)
</I>&gt;<i> parseHttpRequest: HTTP Client REQUEST:
</I>&gt;<i> ---------
</I>&gt;<i> GET <A HREF="http://www.google.com/">http://www.google.com/</A> HTTP/1.1
</I>&gt;<i> Host: www.google.com
</I>&gt;<i> User-Agent: curl/7.75.0
</I>&gt;<i> Accept: */*
</I>&gt;<i> Proxy-Connection: Keep-Alive
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> ----------
</I>&gt;<i> 2021/10/09 13:29:23.520 kid1| 44,3| peer_select.cc(309) peerSelect:
</I>&gt;<i> e:=IV/0x12e63f0*2 <A HREF="http://www.google.com/">http://www.google.com/</A>
</I>&gt;<i> 2021/10/09 13:29:23.520 kid1| 44,7| peer_select.cc(1149)
</I>&gt;<i> interestedInitiator: PeerSelector1
</I>&gt;<i> 2021/10/09 13:29:23.520 kid1| 44,3| peer_select.cc(612) selectMore: GET
</I>&gt;<i> www.google.com
</I>&gt;<i> 2021/10/09 13:29:23.520 kid1| 44,3| peer_select.cc(617) selectMore:
</I>&gt;<i> direct = DIRECT_UNKNOWN (always_direct to be checked)
</I>&gt;<i> 2021/10/09 13:29:23.523 kid1| 44,3| peer_select.cc(373)
</I>&gt;<i> checkAlwaysDirectDone: DENIED
</I>&gt;<i> 2021/10/09 13:29:23.523 kid1| 44,7| peer_select.cc(1149)
</I>&gt;<i> interestedInitiator: PeerSelector1
</I>&gt;<i> 2021/10/09 13:29:23.523 kid1| 44,3| peer_select.cc(612) selectMore: GET
</I>&gt;<i> www.google.com
</I>&gt;<i> 2021/10/09 13:29:23.523 kid1| 44,3| peer_select.cc(626) selectMore:
</I>&gt;<i> direct = DIRECT_UNKNOWN (never_direct to be checked)
</I>&gt;<i> 2021/10/09 13:29:23.523 kid1| 44,3| peer_select.cc(345)
</I>&gt;<i> checkNeverDirectDone: DENIED
</I>&gt;<i> 2021/10/09 13:29:23.523 kid1| 44,7| peer_select.cc(1149)
</I>&gt;<i> interestedInitiator: PeerSelector1
</I>&gt;<i> 2021/10/09 13:29:23.523 kid1| 44,3| peer_select.cc(612) selectMore: GET
</I>&gt;<i> www.google.com
</I>&gt;<i> 2021/10/09 13:29:23.523 kid1| 44,3| peer_select.cc(577)
</I>&gt;<i> checkNetdbDirect: MY RTT = 0 msec
</I>&gt;<i> 2021/10/09 13:29:23.523 kid1| 44,3| peer_select.cc(578)
</I>&gt;<i> checkNetdbDirect: minimum_direct_rtt = 400 msec
</I>&gt;<i> 2021/10/09 13:29:23.523 kid1| 44,3| peer_select.cc(585)
</I>&gt;<i> checkNetdbDirect: MY hops = 0
</I>&gt;<i> 2021/10/09 13:29:23.523 kid1| 44,3| peer_select.cc(586)
</I>&gt;<i> checkNetdbDirect: minimum_direct_hops = 4
</I>&gt;<i> 2021/10/09 13:29:23.523 kid1| 44,3| peer_select.cc(647) selectMore:
</I>&gt;<i> direct = DIRECT_MAYBE (default)
</I>&gt;<i> 2021/10/09 13:29:23.523 kid1| 44,3| peer_select.cc(650) selectMore:
</I>&gt;<i> direct = DIRECT_MAYBE
</I>&gt;<i> 2021/10/09 13:29:23.523 kid1| 44,3| peer_select.cc(286)
</I>&gt;<i> peerSelectIcpPing: <A HREF="http://www.google.com/">http://www.google.com/</A>
</I>&gt;<i> 2021/10/09 13:29:23.523 kid1| 44,3| peer_select.cc(297)
</I>&gt;<i> peerSelectIcpPing: counted 0 neighbors
</I>&gt;<i> 2021/10/09 13:29:23.523 kid1| 44,3| peer_select.cc(833)
</I>&gt;<i> selectSomeParent: GET www.google.com
</I>&gt;<i> 2021/10/09 13:29:23.523 kid1| 44,3| peer_select.cc(1098) addSelection:
</I>&gt;<i> adding FIRSTUP_PARENT/authproxy.example.com
</I>&gt;<i> 2021/10/09 13:29:23.523 kid1| 44,3| peer_select.cc(1091) addSelection:
</I>&gt;<i> skipping ANY_OLD_PARENT/authproxy.example.com; have
</I>&gt;<i> FIRSTUP_PARENT/authproxy.example.com
</I>&gt;<i> 2021/10/09 13:29:23.523 kid1| 44,3| peer_select.cc(1091) addSelection:
</I>&gt;<i> skipping DEFAULT_PARENT/authproxy.example.com; have
</I>&gt;<i> FIRSTUP_PARENT/authproxy.example.com
</I>&gt;<i> 2021/10/09 13:29:23.523 kid1| 44,3| peer_select.cc(1098) addSelection:
</I>&gt;<i> adding HIER_DIRECT#www.google.com
</I>&gt;<i> 2021/10/09 13:29:23.523 kid1| 44,7| peer_select.cc(1149)
</I>&gt;<i> interestedInitiator: PeerSelector1
</I>&gt;<i> 2021/10/09 13:29:23.523 kid1| 44,2| peer_select.cc(460) resolveSelected:
</I>&gt;<i> Find IP destination for: <A HREF="http://www.google.com/">http://www.google.com/</A>' via authproxy.example.com
</I>&gt;<i> 2021/10/09 13:29:23.523 kid1| 44,7| peer_select.cc(1149)
</I>&gt;<i> interestedInitiator: PeerSelector1
</I>&gt;<i> 2021/10/09 13:29:23.523 kid1| 44,2| peer_select.cc(1171) handlePath:
</I>&gt;<i> PeerSelector1 found conn11 local=0.0.0.0 remote=10.20.1.1:8080
</I>&gt;<i> FIRSTUP_PARENT flags=1, destination #1 for <A HREF="http://www.google.com/">http://www.google.com/</A>
</I>&gt;<i> 2021/10/09 13:29:23.523 kid1| 44,2| peer_select.cc(1177) handlePath:
</I>&gt;<i> always_direct = DENIED
</I>&gt;<i> 2021/10/09 13:29:23.523 kid1| 44,2| peer_select.cc(1178) handlePath:
</I>&gt;<i> never_direct = DENIED
</I>&gt;<i> 2021/10/09 13:29:23.523 kid1| 44,2| peer_select.cc(1179) handlePath:
</I>&gt;<i> timedout = 0
</I>&gt;<i> 2021/10/09 13:29:23.523 kid1| 44,7| peer_select.cc(1149)
</I>&gt;<i> interestedInitiator: PeerSelector1
</I>&gt;<i> 2021/10/09 13:29:23.523 kid1| 11,7| HttpRequest.cc(468) clearError: old:
</I>&gt;<i> ERR_NONE
</I>&gt;<i> 2021/10/09 13:29:23.524 kid1| 44,7| peer_select.cc(1149)
</I>&gt;<i> interestedInitiator: PeerSelector1
</I>&gt;<i> 2021/10/09 13:29:23.524 kid1| 44,7| peer_select.cc(1149)
</I>&gt;<i> interestedInitiator: PeerSelector1
</I>&gt;<i> 2021/10/09 13:29:23.524 kid1| 44,2| peer_select.cc(460) resolveSelected:
</I>&gt;<i> Find IP destination for: <A HREF="http://www.google.com/">http://www.google.com/</A>' via www.google.com
</I>&gt;<i> 2021/10/09 13:29:23.524 kid1| 44,7| peer_select.cc(1149)
</I>&gt;<i> interestedInitiator: PeerSelector1
</I>&gt;<i> 2021/10/09 13:29:23.524 kid1| 44,2| peer_select.cc(1171) handlePath:
</I>&gt;<i> PeerSelector1 found conn12 local=0.0.0.0 remote=172.217.23.100:80
</I>&gt;<i> HIER_DIRECT flags=1, destination #2 for <A HREF="http://www.google.com/">http://www.google.com/</A>
</I>&gt;<i> 2021/10/09 13:29:23.524 kid1| 44,2| peer_select.cc(1177) handlePath:
</I>&gt;<i> always_direct = DENIED
</I>&gt;<i> 2021/10/09 13:29:23.524 kid1| 44,2| peer_select.cc(1178) handlePath:
</I>&gt;<i> never_direct = DENIED
</I>&gt;<i> 2021/10/09 13:29:23.524 kid1| 44,2| peer_select.cc(1179) handlePath:
</I>&gt;<i> timedout = 0
</I>&gt;<i> 2021/10/09 13:29:23.524 kid1| 44,7| peer_select.cc(1149)
</I>&gt;<i> interestedInitiator: PeerSelector1
</I>&gt;<i> 2021/10/09 13:29:23.524 kid1| 44,7| peer_select.cc(1149)
</I>&gt;<i> interestedInitiator: PeerSelector1
</I>&gt;<i> 2021/10/09 13:29:23.524 kid1| 44,7| peer_select.cc(1149)
</I>&gt;<i> interestedInitiator: PeerSelector1
</I>&gt;<i> 2021/10/09 13:29:23.524 kid1| 44,2| peer_select.cc(479) resolveSelected:
</I>&gt;<i> PeerSelector1 found all 2 destinations for <A HREF="http://www.google.com/">http://www.google.com/</A>
</I>&gt;<i> 2021/10/09 13:29:23.524 kid1| 44,2| peer_select.cc(480) resolveSelected:
</I>&gt;<i> always_direct = DENIED
</I>&gt;<i> 2021/10/09 13:29:23.524 kid1| 44,2| peer_select.cc(481) resolveSelected:
</I>&gt;<i> never_direct = DENIED
</I>&gt;<i> 2021/10/09 13:29:23.524 kid1| 44,2| peer_select.cc(482) resolveSelected:
</I>&gt;<i> timedout = 0
</I>&gt;<i> 2021/10/09 13:29:23.524 kid1| 44,7| peer_select.cc(1149)
</I>&gt;<i> interestedInitiator: PeerSelector1
</I>&gt;<i> 2021/10/09 13:29:23.524 kid1| 44,3| peer_select.cc(241) ~PeerSelector:
</I>&gt;<i> <A HREF="http://www.google.com/">http://www.google.com/</A>
</I>&gt;<i> 2021/10/09 13:29:23.526 kid1| 11,4| HttpRequest.cc(453) prepForPeering:
</I>&gt;<i> 0x1154cf0 to authproxy.example.com proxy
</I>&gt;<i> 2021/10/09 13:29:23.526 kid1| 11,3| http.cc(2486) httpStart: GET
</I>&gt;<i> <A HREF="http://www.google.com/">http://www.google.com/</A>
</I>&gt;<i> 2021/10/09 13:29:23.527 kid1| 11,5| http.cc(87) HttpStateData:
</I>&gt;<i> HttpStateData 0x12e9988 created
</I>&gt;<i> 2021/10/09 13:29:23.527 kid1| 11,5| http.cc(2367) sendRequest: conn13
</I>&gt;<i> local=10.10.1.1:36928 remote=10.20.1.1:8080 FIRSTUP_PARENT FD 13
</I>&gt;<i> flags=1, request 0x1154cf0*6, this 0x12e9988.
</I>&gt;<i> 2021/10/09 13:29:23.527 kid1| 11,5| AsyncCall.cc(29) AsyncCall: The
</I>&gt;<i> AsyncCall HttpStateData::httpTimeout constructed, this=0x12e8920 [call65]
</I>&gt;<i> 2021/10/09 13:29:23.527 kid1| 11,8| http.cc(1656)
</I>&gt;<i> maybeMakeSpaceAvailable: may read up to 65536 bytes info buf(0/65536)
</I>&gt;<i> from conn13 local=10.10.1.1:36928 remote=10.20.1.1:8080 FIRSTUP_PARENT
</I>&gt;<i> FD 13 flags=1
</I>&gt;<i> 2021/10/09 13:29:23.527 kid1| 11,5| AsyncCall.cc(29) AsyncCall: The
</I>&gt;<i> AsyncCall HttpStateData::readReply constructed, this=0x12f9c10 [call66]
</I>&gt;<i> 2021/10/09 13:29:23.527 kid1| 11,5| AsyncCall.cc(29) AsyncCall: The
</I>&gt;<i> AsyncCall HttpStateData::wroteLast constructed, this=0x12f9cc0 [call67]
</I>&gt;<i> 2021/10/09 13:29:23.527 kid1| 11,8| http.cc(2309) decideIfWeDoRanges:
</I>&gt;<i> decideIfWeDoRanges: range specs: 0, cachable: 1; we_do_ranges: 0
</I>&gt;<i> 2021/10/09 13:29:23.527 kid1| 11,5| http.cc(2113)
</I>&gt;<i> copyOneHeaderFromClientsideRequestToUpstreamRequest:
</I>&gt;<i> httpBuildRequestHeader: User-Agent: curl/7.75.0
</I>&gt;<i> 2021/10/09 13:29:23.527 kid1| 11,5| http.cc(2113)
</I>&gt;<i> copyOneHeaderFromClientsideRequestToUpstreamRequest:
</I>&gt;<i> httpBuildRequestHeader: Accept: */*
</I>&gt;<i> 2021/10/09 13:29:23.527 kid1| 11,5| http.cc(2113)
</I>&gt;<i> copyOneHeaderFromClientsideRequestToUpstreamRequest:
</I>&gt;<i> httpBuildRequestHeader: Proxy-Connection: Keep-Alive
</I>&gt;<i> 2021/10/09 13:29:23.527 kid1| 11,5| http.cc(2113)
</I>&gt;<i> copyOneHeaderFromClientsideRequestToUpstreamRequest:
</I>&gt;<i> httpBuildRequestHeader: Host: www.google.com
</I>&gt;<i> 2021/10/09 13:29:23.527 kid1| 11,5| peer_proxy_negotiate_auth.cc(539)
</I>&gt;<i> peer_proxy_negotiate_auth: Import gss name
</I>&gt;<i> 2021/10/09 13:29:23.527 kid1| 11,5| peer_proxy_negotiate_auth.cc(546)
</I>&gt;<i> peer_proxy_negotiate_auth: Initialize gss security context
</I>&gt;<i> 2021/10/09 13:29:23.531 kid1| 11,5| peer_proxy_negotiate_auth.cc(560)
</I>&gt;<i> peer_proxy_negotiate_auth: Got token with length 2568
</I>&gt;<i> 2021/10/09 13:29:23.531 kid1| 11,2| http.cc(2442) sendRequest: HTTP
</I>&gt;<i> Server conn13 local=10.10.1.1:36928 remote=10.20.1.1:8080 FIRSTUP_PARENT
</I>&gt;<i> FD 13 flags=1
</I>&gt;<i> 2021/10/09 13:29:23.531 kid1| 11,2| http.cc(2443) sendRequest: HTTP
</I>&gt;<i> Server REQUEST:
</I>&gt;<i> ---------
</I>&gt;<i> GET <A HREF="http://www.google.com/">http://www.google.com/</A> HTTP/1.1
</I>&gt;<i> User-Agent: curl/7.75.0
</I>&gt;<i> Accept: */*
</I>&gt;<i> Host: www.google.com
</I>&gt;<i> Proxy-Authorization: Negotiate YIIK....
</I>&gt;<i> Cache-Control: max-age=259200
</I>&gt;<i> Connection: keep-alive
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> ----------
</I>&gt;<i> 2021/10/09 13:29:23.531 kid1| 11,5| AsyncCall.cc(96) ScheduleCall:
</I>&gt;<i> IoCallback.cc(131) will call HttpStateData::wroteLast(conn13
</I>&gt;<i> local=10.10.1.1:36928 remote=10.20.1.1:8080 FIRSTUP_PARENT FD 13
</I>&gt;<i> flags=1, data=0x12e9988) [call67]
</I>&gt;<i> 2021/10/09 13:29:23.531 kid1| 11,5| AsyncCallQueue.cc(59) fireNext:
</I>&gt;<i> entering HttpStateData::wroteLast(conn13 local=10.10.1.1:36928
</I>&gt;<i> remote=10.20.1.1:8080 FIRSTUP_PARENT FD 13 flags=1, data=0x12e9988)
</I>&gt;<i> 2021/10/09 13:29:23.531 kid1| 11,5| AsyncCall.cc(41) make: make call
</I>&gt;<i> HttpStateData::wroteLast [call67]
</I>&gt;<i> 2021/10/09 13:29:23.531 kid1| 11,5| AsyncJob.cc(122) callStart:
</I>&gt;<i> HttpStateData status in: [ job8]
</I>&gt;<i> 2021/10/09 13:29:23.531 kid1| 11,5| http.cc(1667) wroteLast: conn13
</I>&gt;<i> local=10.10.1.1:36928 remote=10.20.1.1:8080 FIRSTUP_PARENT FD 13
</I>&gt;<i> flags=1: size 3611: errflag 0.
</I>&gt;<i> 2021/10/09 13:29:23.531 kid1| 11,5| AsyncCall.cc(29) AsyncCall: The
</I>&gt;<i> AsyncCall HttpStateData::httpTimeout constructed, this=0xe34fa0 [call69]
</I>&gt;<i> 2021/10/09 13:29:23.531 kid1| 11,5| AsyncJob.cc(153) callEnd:
</I>&gt;<i> HttpStateData status out: [ job8]
</I>&gt;<i> 2021/10/09 13:29:23.531 kid1| 11,5| AsyncCallQueue.cc(61) fireNext:
</I>&gt;<i> leaving HttpStateData::wroteLast(conn13 local=10.10.1.1:36928
</I>&gt;<i> remote=10.20.1.1:8080 FIRSTUP_PARENT FD 13 flags=1, data=0x12e9988)
</I>&gt;<i> 2021/10/09 13:29:23.615 kid1| 11,5| AsyncCall.cc(96) ScheduleCall:
</I>&gt;<i> IoCallback.cc(131) will call HttpStateData::readReply(conn13
</I>&gt;<i> local=10.10.1.1:36928 remote=10.20.1.1:8080 FIRSTUP_PARENT FD 13
</I>&gt;<i> flags=1, data=0x12e9988) [call66]
</I>&gt;<i> 2021/10/09 13:29:23.615 kid1| 11,5| AsyncCallQueue.cc(59) fireNext:
</I>&gt;<i> entering HttpStateData::readReply(conn13 local=10.10.1.1:36928
</I>&gt;<i> remote=10.20.1.1:8080 FIRSTUP_PARENT FD 13 flags=1, data=0x12e9988)
</I>&gt;<i> 2021/10/09 13:29:23.615 kid1| 11,5| AsyncCall.cc(41) make: make call
</I>&gt;<i> HttpStateData::readReply [call66]
</I>&gt;<i> 2021/10/09 13:29:23.615 kid1| 11,5| AsyncJob.cc(122) callStart:
</I>&gt;<i> HttpStateData status in: [ job8]
</I>&gt;<i> 2021/10/09 13:29:23.615 kid1| 11,5| http.cc(1215) readReply: conn13
</I>&gt;<i> local=10.10.1.1:36928 remote=10.20.1.1:8080 FIRSTUP_PARENT FD 13 flags=1
</I>&gt;<i> 2021/10/09 13:29:23.615 kid1| ctx: enter level&#160; 0: '<A HREF="http://www.google.com/">http://www.google.com/</A>'
</I>&gt;<i> 2021/10/09 13:29:23.615 kid1| 11,3| http.cc(666) processReplyHeader:
</I>&gt;<i> processReplyHeader: key '0200000000000000843D000001000000'
</I>&gt;<i> 2021/10/09 13:29:23.615 kid1| 11,2| http.cc(720) processReplyHeader:
</I>&gt;<i> HTTP Server conn13 local=10.10.1.1:36928 remote=10.20.1.1:8080
</I>&gt;<i> FIRSTUP_PARENT FD 13 flags=1
</I>&gt;<i> 2021/10/09 13:29:23.615 kid1| 11,2| http.cc(721) processReplyHeader:
</I>&gt;<i> HTTP Server RESPONSE:
</I>&gt;<i> ---------
</I>&gt;<i> HTTP/1.1 301 Moved Permanently
</I>&gt;<i> Location: <A HREF="https://www.google.com/">https://www.google.com/</A>
</I>&gt;<i> Content-Length: 0
</I>&gt;<i> Proxy-Connection: Keep-Alive
</I>&gt;<i> 
</I>&gt;<i> ----------
</I>&gt;<i> 2021/10/09 13:29:23.616 kid1| 11,5| Client.cc(119) setVirginReply:
</I>&gt;<i> 0x12e9988 setting virgin reply to 0x12fa850
</I>&gt;<i> 2021/10/09 13:29:23.616 kid1| ctx: exit level&#160; 0
</I>&gt;<i> 2021/10/09 13:29:23.616 kid1| 11,5| Client.cc(973) adaptOrFinalizeReply:
</I>&gt;<i> adaptationAccessCheckPending=0
</I>&gt;<i> 2021/10/09 13:29:23.616 kid1| 11,5| Client.cc(139) setFinalReply:
</I>&gt;<i> 0x12e9988 setting final reply to 0x12fa850
</I>&gt;<i> 2021/10/09 13:29:23.616 kid1| ctx: enter level&#160; 0: '<A HREF="http://www.google.com/">http://www.google.com/</A>'
</I>&gt;<i> 2021/10/09 13:29:23.616 kid1| 11,3| http.cc(979) haveParsedReplyHeaders:
</I>&gt;<i> HTTP CODE: 301
</I>&gt;<i> 2021/10/09 13:29:23.616 kid1| 11,3| http.cc(1054)
</I>&gt;<i> haveParsedReplyHeaders: decided: do not cache but share because refresh
</I>&gt;<i> check returned non-cacheable; HTTP status 301 e:=p2XIV/0x12e63f0*3
</I>&gt;<i> 2021/10/09 13:29:23.616 kid1| ctx: exit level&#160; 0
</I>&gt;<i> 2021/10/09 13:29:23.616 kid1| 11,2| Stream.cc(279) sendStartOfMessage:
</I>&gt;<i> HTTP Client conn10 local=127.0.0.1:3128 remote=127.0.0.1:45192 FD 12
</I>&gt;<i> flags=1
</I>&gt;<i> 2021/10/09 13:29:23.616 kid1| 11,2| Stream.cc(280) sendStartOfMessage:
</I>&gt;<i> HTTP Client REPLY:
</I>&gt;<i> ---------
</I>&gt;<i> HTTP/1.1 301 Moved Permanently
</I>&gt;<i> Location: <A HREF="https://www.google.com/">https://www.google.com/</A>
</I>&gt;<i> Content-Length: 0
</I>&gt;<i> Date: Sat, 09 Oct 2021 12:29:23 GMT
</I>&gt;<i> X-Cache: MISS from clientproxy
</I>&gt;<i> X-Cache-Lookup: MISS from clientproxy:3128
</I>&gt;<i> Connection: keep-alive
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> ----------
</I>&gt;<i> 2021/10/09 13:29:23.616 kid1| 11,5| http.cc(1491) processReplyBody:
</I>&gt;<i> adaptationAccessCheckPending=0
</I>&gt;<i> 2021/10/09 13:29:23.616 kid1| 11,3| http.cc(1154) persistentConnStatus:
</I>&gt;<i> conn13 local=10.10.1.1:36928 remote=10.20.1.1:8080 FIRSTUP_PARENT FD 13
</I>&gt;<i> flags=1 eof=0
</I>&gt;<i> 2021/10/09 13:29:23.616 kid1| 11,5| http.cc(1174) persistentConnStatus:
</I>&gt;<i> persistentConnStatus: content_length=0
</I>&gt;<i> 2021/10/09 13:29:23.616 kid1| 11,5| http.cc(1178) persistentConnStatus:
</I>&gt;<i> persistentConnStatus: clen=0
</I>&gt;<i> 2021/10/09 13:29:23.616 kid1| 11,5| http.cc(1537) processReplyBody:
</I>&gt;<i> processReplyBody: COMPLETE_PERSISTENT_MSG from conn13
</I>&gt;<i> local=10.10.1.1:36928 remote=10.20.1.1:8080 FIRSTUP_PARENT FD 13 flags=1
</I>&gt;<i> 2021/10/09 13:29:23.616 kid1| 11,5| Client.cc(162) serverComplete:
</I>&gt;<i> serverComplete 0x12e9988
</I>&gt;<i> 2021/10/09 13:29:23.616 kid1| 11,5| Client.cc(184) serverComplete2:
</I>&gt;<i> serverComplete2 0x12e9988
</I>&gt;<i> 2021/10/09 13:29:23.616 kid1| 11,5| Client.cc(212) completeForwarding:
</I>&gt;<i> completing forwarding for 0x12e6e28*2
</I>&gt;<i> 2021/10/09 13:29:23.616 kid1| 11,5| Client.cc(586) cleanAdaptation:
</I>&gt;<i> cleaning ICAP; ACL: 0
</I>&gt;<i> 2021/10/09 13:29:23.616 kid1| 11,5| http.cc(134) ~HttpStateData:
</I>&gt;<i> HttpStateData 0x12e9988 destroyed;
</I>&gt;<i> 2021/10/09 13:29:23.616 kid1| 11,5| AsyncCallQueue.cc(61) fireNext:
</I>&gt;<i> leaving HttpStateData::readReply(conn13 local=10.10.1.1:36928
</I>&gt;<i> remote=10.20.1.1:8080 FIRSTUP_PARENT FD 13 flags=1, data=0x12e9988)
</I>&gt;<i> 2021/10/09 13:29:27.287 kid1| 11,2| client_side.cc(1353)
</I>&gt;<i> parseHttpRequest: HTTP Client conn15 local=127.0.0.1:3128
</I>&gt;<i> remote=127.0.0.1:45219 FD 12 flags=1
</I>&gt;<i> 2021/10/09 13:29:27.287 kid1| 11,2| client_side.cc(1354)
</I>&gt;<i> parseHttpRequest: HTTP Client REQUEST:
</I>&gt;<i> ---------
</I>&gt;<i> GET <A HREF="http://www.google.com/">http://www.google.com/</A> HTTP/1.1
</I>&gt;<i> Host: www.google.com
</I>&gt;<i> User-Agent: curl/7.75.0
</I>&gt;<i> Accept: */*
</I>&gt;<i> Proxy-Connection: Keep-Alive
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> ----------
</I>&gt;<i> 2021/10/09 13:29:27.287 kid1| 44,3| peer_select.cc(309) peerSelect:
</I>&gt;<i> e:=IV/0x12e63f0*2 <A HREF="http://www.google.com/">http://www.google.com/</A>
</I>&gt;<i> 2021/10/09 13:29:27.287 kid1| 44,7| peer_select.cc(1149)
</I>&gt;<i> interestedInitiator: PeerSelector2
</I>&gt;<i> 2021/10/09 13:29:27.287 kid1| 44,3| peer_select.cc(612) selectMore: GET
</I>&gt;<i> www.google.com
</I>&gt;<i> 2021/10/09 13:29:27.287 kid1| 44,3| peer_select.cc(617) selectMore:
</I>&gt;<i> direct = DIRECT_UNKNOWN (always_direct to be checked)
</I>&gt;<i> 2021/10/09 13:29:27.287 kid1| 44,3| peer_select.cc(373)
</I>&gt;<i> checkAlwaysDirectDone: DENIED
</I>&gt;<i> 2021/10/09 13:29:27.287 kid1| 44,7| peer_select.cc(1149)
</I>&gt;<i> interestedInitiator: PeerSelector2
</I>&gt;<i> 2021/10/09 13:29:27.287 kid1| 44,3| peer_select.cc(612) selectMore: GET
</I>&gt;<i> www.google.com
</I>&gt;<i> 2021/10/09 13:29:27.287 kid1| 44,3| peer_select.cc(626) selectMore:
</I>&gt;<i> direct = DIRECT_UNKNOWN (never_direct to be checked)
</I>&gt;<i> 2021/10/09 13:29:27.287 kid1| 44,3| peer_select.cc(345)
</I>&gt;<i> checkNeverDirectDone: DENIED
</I>&gt;<i> 2021/10/09 13:29:27.287 kid1| 44,7| peer_select.cc(1149)
</I>&gt;<i> interestedInitiator: PeerSelector2
</I>&gt;<i> 2021/10/09 13:29:27.287 kid1| 44,3| peer_select.cc(612) selectMore: GET
</I>&gt;<i> www.google.com
</I>&gt;<i> 2021/10/09 13:29:27.287 kid1| 44,3| peer_select.cc(577)
</I>&gt;<i> checkNetdbDirect: MY RTT = 1 msec
</I>&gt;<i> 2021/10/09 13:29:27.287 kid1| 44,3| peer_select.cc(578)
</I>&gt;<i> checkNetdbDirect: minimum_direct_rtt = 400 msec
</I>&gt;<i> 2021/10/09 13:29:27.287 kid1| 44,3| peer_select.cc(644) selectMore:
</I>&gt;<i> direct = DIRECT_YES (checkNetdbDirect)
</I>&gt;<i> 2021/10/09 13:29:27.287 kid1| 44,3| peer_select.cc(650) selectMore:
</I>&gt;<i> direct = DIRECT_YES
</I>&gt;<i> 2021/10/09 13:29:27.287 kid1| 44,3| peer_select.cc(1098) addSelection:
</I>&gt;<i> adding HIER_DIRECT#www.google.com
</I>&gt;<i> 2021/10/09 13:29:27.287 kid1| 44,7| peer_select.cc(1149)
</I>&gt;<i> interestedInitiator: PeerSelector2
</I>&gt;<i> 2021/10/09 13:29:27.287 kid1| 44,2| peer_select.cc(460) resolveSelected:
</I>&gt;<i> Find IP destination for: <A HREF="http://www.google.com/">http://www.google.com/</A>' via www.google.com
</I>&gt;<i> 2021/10/09 13:29:27.287 kid1| 44,7| peer_select.cc(1149)
</I>&gt;<i> interestedInitiator: PeerSelector2
</I>&gt;<i> 2021/10/09 13:29:27.287 kid1| 44,2| peer_select.cc(1171) handlePath:
</I>&gt;<i> PeerSelector2 found conn16 local=0.0.0.0 remote=172.217.23.100:80
</I>&gt;<i> HIER_DIRECT flags=1, destination #1 for <A HREF="http://www.google.com/">http://www.google.com/</A>
</I>&gt;<i> 2021/10/09 13:29:27.287 kid1| 44,2| peer_select.cc(1177) handlePath:
</I>&gt;<i> always_direct = DENIED
</I>&gt;<i> 2021/10/09 13:29:27.287 kid1| 44,2| peer_select.cc(1178) handlePath:
</I>&gt;<i> never_direct = DENIED
</I>&gt;<i> 2021/10/09 13:29:27.287 kid1| 44,2| peer_select.cc(1179) handlePath:
</I>&gt;<i> timedout = 0
</I>&gt;<i> 2021/10/09 13:29:27.287 kid1| 44,7| peer_select.cc(1149)
</I>&gt;<i> interestedInitiator: PeerSelector2
</I>&gt;<i> 2021/10/09 13:29:27.287 kid1| 11,7| HttpRequest.cc(468) clearError: old:
</I>&gt;<i> ERR_NONE
</I>&gt;<i> 2021/10/09 13:29:27.287 kid1| 44,7| peer_select.cc(1149)
</I>&gt;<i> interestedInitiator: PeerSelector2
</I>&gt;<i> 2021/10/09 13:29:27.287 kid1| 44,7| peer_select.cc(1149)
</I>&gt;<i> interestedInitiator: PeerSelector2
</I>&gt;<i> 2021/10/09 13:29:27.287 kid1| 44,2| peer_select.cc(479) resolveSelected:
</I>&gt;<i> PeerSelector2 found all 1 destinations for <A HREF="http://www.google.com/">http://www.google.com/</A>
</I>&gt;<i> 2021/10/09 13:29:27.287 kid1| 44,2| peer_select.cc(480) resolveSelected:
</I>&gt;<i> always_direct = DENIED
</I>&gt;<i> 2021/10/09 13:29:27.287 kid1| 44,2| peer_select.cc(481) resolveSelected:
</I>&gt;<i> never_direct = DENIED
</I>&gt;<i> 2021/10/09 13:29:27.287 kid1| 44,2| peer_select.cc(482) resolveSelected:
</I>&gt;<i> timedout = 0
</I>&gt;<i> 2021/10/09 13:29:27.287 kid1| 44,7| peer_select.cc(1149)
</I>&gt;<i> interestedInitiator: PeerSelector2
</I>&gt;<i> 2021/10/09 13:29:27.287 kid1| 44,3| peer_select.cc(241) ~PeerSelector:
</I>&gt;<i> <A HREF="http://www.google.com/">http://www.google.com/</A>
</I>&gt;<i> 2021/10/09 13:30:27.421 kid1| 11,2| Stream.cc(279) sendStartOfMessage:
</I>&gt;<i> HTTP Client conn15 local=127.0.0.1:3128 remote=127.0.0.1:45219 FD 12
</I>&gt;<i> flags=1
</I>&gt;<i> 2021/10/09 13:30:27.421 kid1| 11,2| Stream.cc(280) sendStartOfMessage:
</I>&gt;<i> HTTP Client REPLY:
</I>&gt;<i> ---------
</I>&gt;<i> HTTP/1.1 503 Service Unavailable
</I>&gt;<i> Server: squid/5.1-VCS
</I>&gt;<i> Mime-Version: 1.0
</I>&gt;<i> Date: Sat, 09 Oct 2021 12:30:27 GMT
</I>&gt;<i> Content-Type: text/html;charset=utf-8
</I>&gt;<i> Content-Length: 3573
</I>&gt;<i> X-Squid-Error: ERR_CONNECT_FAIL 110
</I>&gt;<i> Vary: Accept-Language
</I>&gt;<i> Content-Language: en
</I>&gt;<i> X-Cache: MISS from clientproxy
</I>&gt;<i> X-Cache-Lookup: MISS from clientproxy:3128
</I>&gt;<i> Connection: keep-alive
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> ----------
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Thank you
</I>&gt;<i> Markus
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> &quot;Markus Moeller&quot;&#160; wrote in message news:sjrrhc$lat$<A HREF="https://lists.squid-cache.org/listinfo/squid-users">1 at ciao.gmane.io...</A>
</I>&gt;<i> 
</I>&gt;<i> I understand now better the concept.
</I>&gt;<i> 
</I>&gt;<i> Thank you
</I>&gt;<i> Markus
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> &quot;Alex Rousskov&quot;&#160; wrote in message
</I>&gt;<i> news:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">3dec529a-b62e-1e95-6cb7-0b68f6bf3c8d at measurement-factory.com...</A>
</I>&gt;<i> 
</I>&gt;<i> On 10/8/21 8:02 PM, Markus Moeller wrote:
</I>&gt;<i> 
</I>&gt;&gt;<i> I try to setup a proxy chain, but don't get the setup right. I have one
</I>&gt;&gt;<i> squid with 2 parents. One with auth for domainA.com and one w/o auth for
</I>&gt;&gt;<i> the non local IPs (i.e. Internet).
</I>&gt;<i> 
</I>&gt;&gt;<i> With the below config I see domainA.com still going to the
</I>&gt;&gt;<i> unauthenticated parent proxy. Any hint why ?
</I>&gt;<i> 
</I>&gt;<i> Several factors can explain that, but I would start by rephrasing your
</I>&gt;<i> request routing requirements (and the corresponding configuration rules)
</I>&gt;<i> as mutually exclusive (if they are). Currently, you have formulated and
</I>&gt;<i> configured the equivalent of
</I>&gt;<i> 
</I>&gt;<i> * send green traffic to auth-proxy
</I>&gt;<i> * send blue traffic to parent-proxy
</I>&gt;<i> 
</I>&gt;<i> This approach leaves important questions like &quot;What about yellow
</I>&gt;<i> traffic?&quot; and &quot;What about traffic with green and blue dots?&quot; unanswered.
</I>&gt;<i> 
</I>&gt;<i> If you want every request to go to either auth-proxy or parent-proxy,
</I>&gt;<i> then say so explicitly:
</I>&gt;<i> 
</I>&gt;<i> # green (and only green!) traffic to auth-proxy
</I>&gt;<i> cache_peer_access auth-proxy allow green
</I>&gt;<i> cache_peer_access auth-proxy deny all
</I>&gt;<i> 
</I>&gt;<i> # not green (and only not green!) traffic to parent-proxy
</I>&gt;<i> cache_peer_access auth-proxy deny green
</I>&gt;<i> cache_peer_access auth-proxy allow all
</I>&gt;<i> 
</I>&gt;<i> What &quot;green&quot; means exactly in your case, I do not know (due to the
</I>&gt;<i> questions like those listed above).
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> If you want every request to go to either auth-proxy, parent-proxy, or
</I>&gt;<i> direct, then your rules will become a bit more complex, but all three
</I>&gt;<i> routes should still be mutually exclusive:
</I>&gt;<i> 
</I>&gt;<i> # green (and only green) traffic to auth-proxy
</I>&gt;<i> # but exclude traffic that should go direct
</I>&gt;<i> cache_peer_access auth-proxy deny meantToGoDirect
</I>&gt;<i> cache_peer_access auth-proxy allow green
</I>&gt;<i> cache_peer_access auth-proxy deny all
</I>&gt;<i> 
</I>&gt;<i> # not green (and only not green) traffic to parent-proxy
</I>&gt;<i> # but exclude traffic that should go direct
</I>&gt;<i> cache_peer_access auth-proxy deny meantToGoDirect
</I>&gt;<i> cache_peer_access auth-proxy deny green
</I>&gt;<i> cache_peer_access auth-proxy allow all
</I>&gt;<i> 
</I>&gt;<i> # traffic that should go direct (and only that traffic)
</I>&gt;<i> # should always go direct
</I>&gt;<i> always_direct allow meantToGoDirect
</I>&gt;<i> always_direct deny all
</I>&gt;<i> 
</I>&gt;<i> # traffic that should not go direct (and only that traffic)
</I>&gt;<i> # should never go direct
</I>&gt;<i> never_direct deny meantToGoDirect
</I>&gt;<i> never_direct allow all
</I>&gt;<i> 
</I>&gt;<i> Disclaimer: The above configuration snippets are not complete, are not
</I>&gt;<i> tested, and can probably be reduced (some might say &quot;simplified&quot;) if you
</I>&gt;<i> prefer to rely on certain defaults. See also: nonhierarchical_direct.
</I>&gt;<i> 
</I>&gt;<i> Once you get the above working for plain HTTP requests that have
</I>&gt;<i> resolvable domain names as targets, please note that your listA ACL will
</I>&gt;<i> not work for requests that have IP addresses, including some CONNECT
</I>&gt;<i> requests that ask your Squid to tunnel HTTPS traffic. Your Squid may not
</I>&gt;<i> get any such requests, but if it does, then your &quot;green&quot; and
</I>&gt;<i> &quot;meantToGoDirect&quot; ACLs may need to be more complex than &quot;dstdomain -n&quot;
</I>&gt;<i> and &quot;dst&quot;.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> HTH,
</I>&gt;<i> 
</I>&gt;<i> Alex.
</I>&gt;<i> P.S. I would not call the second proxy &quot;parent-proxy&quot; because both of
</I>&gt;<i> your proxies are configured as parent proxies.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> # Recommended minimum configuration:
</I>&gt;&gt;<i> #
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> # Example rule allowing access from your local networks.
</I>&gt;&gt;<i> # Adapt to list your (internal) IP networks from where browsing
</I>&gt;&gt;<i> # should be allowed
</I>&gt;&gt;<i> acl localnet src 0.0.0.1-0.255.255.255&#160; # RFC 1122 &quot;this&quot; network (LAN)
</I>&gt;&gt;<i> acl localnet src 10.0.0.0/8&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; # RFC 1918 local private network
</I>&gt;&gt;<i> (LAN)
</I>&gt;&gt;<i> acl localnet src 100.64.0.0/10&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; # RFC 6598 shared address space
</I>&gt;&gt;<i> (CGN)
</I>&gt;&gt;<i> acl localnet src 169.254.0.0/16&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; # RFC 3927 link-local (directly
</I>&gt;&gt;<i> plugged) machines
</I>&gt;&gt;<i> acl localnet src 172.16.0.0/12&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; # RFC 1918 local private network
</I>&gt;&gt;<i> (LAN)
</I>&gt;&gt;<i> acl localnet src 192.168.0.0/16&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; # RFC 1918 local private network
</I>&gt;&gt;<i> (LAN)
</I>&gt;&gt;<i> acl localnet src fc00::/7&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; # RFC 4193 local private network
</I>&gt;&gt;<i> range
</I>&gt;&gt;<i> acl localnet src fe80::/10&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; # RFC 4291 link-local (directly
</I>&gt;&gt;<i> plugged) machines
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> acl localdst dst 10.0.0.0/8&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; # RFC 1918 local private network
</I>&gt;&gt;<i> (LAN)
</I>&gt;&gt;<i> acl localdst dst 100.64.0.0/10&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; # RFC 6598 shared address space
</I>&gt;&gt;<i> (CGN)
</I>&gt;&gt;<i> acl localdst dst 169.254.0.0/16&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; # RFC 3927 link-local (directly
</I>&gt;&gt;<i> plugged) machines
</I>&gt;&gt;<i> acl localdst dst 172.16.0.0/12&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; # RFC 1918 local private network
</I>&gt;&gt;<i> (LAN)
</I>&gt;&gt;<i> acl localdst dst 192.168.0.0/16&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; # RFC 1918 local private network
</I>&gt;&gt;<i> (LAN)
</I>&gt;&gt;<i> acl localdst dst fc00::/7&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; # RFC 4193 local private network
</I>&gt;&gt;<i> range
</I>&gt;&gt;<i> acl localdst dst fe80::/10&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; # RFC 4291 link-local (directly
</I>&gt;&gt;<i> plugged) machines
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> acl listA dstdomain -n&#160; domainA.com
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> acl SSL_ports port 443
</I>&gt;&gt;<i> acl Safe_ports port 80&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; # http
</I>&gt;&gt;<i> acl Safe_ports port 21&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; # ftp
</I>&gt;&gt;<i> acl Safe_ports port 443&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; # https
</I>&gt;&gt;<i> acl Safe_ports port 70&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; # gopher
</I>&gt;&gt;<i> acl Safe_ports port 210&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; # wais
</I>&gt;&gt;<i> acl Safe_ports port 1025-65535&#160; # unregistered ports
</I>&gt;&gt;<i> acl Safe_ports port 280&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; # http-mgmt
</I>&gt;&gt;<i> acl Safe_ports port 488&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; # gss-http
</I>&gt;&gt;<i> acl Safe_ports port 591&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; # filemaker
</I>&gt;&gt;<i> acl Safe_ports port 777&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; # multiling http
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> cache_peer auth-proxy parent&#160;&#160; 3128 0&#160; no-query default login=NEGOTIATE
</I>&gt;&gt;<i> cache_peer parent-proxy parent&#160;&#160; 3128 0&#160; no-query default
</I>&gt;&gt;<i> cache_peer_access auth-proxy allow listA
</I>&gt;&gt;<i> cache_peer_access parent-proxy allow !localdst
</I>&gt;&gt;<i> never_direct deny localdst
</I>&gt;&gt;<i> never_direct allow all
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> debug_options 44,10 11,20
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;<i> squid-users mailing list
</I>&gt;&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="024158.html">[squid-users] squid 5 and parent peers
</A></li>
	<LI>Next message (by thread): <A HREF="024160.html">[squid-users] squid 5 and parent peers
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24159">[ date ]</a>
              <a href="thread.html#24159">[ thread ]</a>
              <a href="subject.html#24159">[ subject ]</a>
              <a href="author.html#24159">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
