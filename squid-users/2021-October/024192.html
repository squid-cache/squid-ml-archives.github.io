<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] AWS NLB Proxy Protocol V2
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20AWS%20NLB%20Proxy%20Protocol%20V2&In-Reply-To=%3C9ef6c3d4-c8aa-fe32-adae-3ca7aad8a464%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="024190.html">
   <LINK REL="Next"  HREF="024193.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] AWS NLB Proxy Protocol V2</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20AWS%20NLB%20Proxy%20Protocol%20V2&In-Reply-To=%3C9ef6c3d4-c8aa-fe32-adae-3ca7aad8a464%40measurement-factory.com%3E"
       TITLE="[squid-users] AWS NLB Proxy Protocol V2">rousskov at measurement-factory.com
       </A><BR>
    <I>Mon Oct 18 17:48:57 UTC 2021</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="024190.html">[squid-users] AWS NLB Proxy Protocol V2
</A></li>
        <LI>Next message (by thread): <A HREF="024193.html">[squid-users] AWS NLB Proxy Protocol V2
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24192">[ date ]</a>
              <a href="thread.html#24192">[ thread ]</a>
              <a href="subject.html#24192">[ subject ]</a>
              <a href="author.html#24192">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 10/18/21 12:11 PM, Ty Martin wrote:

&gt;<i> I am looking to run Squid as a forward proxy with basic auth in Docker
</I>&gt;<i> on AWS ECS behind a network load balancer. I seem to have things up and
</I>&gt;<i> running for the most part; however, I am having difficulty in getting
</I>&gt;<i> proxy protocol to work so that I get access to client IP addresses
</I>&gt;<i> beyond that of the private IPs of my NLB. As soon as I enable proxy
</I>&gt;<i> protocol v2 on the AWS NLB, requests to Squid start failing with errors
</I>&gt;<i> similar to the following:
</I>&gt;<i> 
</I>&gt;<i> Squid log: `1634330668.200 &#160; &#160; &#160;5 &lt;nlb-private-ip&gt; NONE_NONE/400 2032 -
</I>&gt;<i> error:invalid-request - HIER_NONE/- text/html`
</I>&gt;<i> Client log: `X-Squid-Error: ERR_PROTOCOL_UNKNOWN 0`
</I>
&gt;<i> http_port 3128
</I>
You must use require-proxy-header http_port option to tell Squid to
always expect/require PROXY protocol messages on connections to that
listening  port. Otherwise, Squid will expect naked HTTP traffic and
fail to parse incoming (PROXY protocol) connection bytes.

According to proxy_protocol_access documentation, after adding
require-proxy-header to http_port, you must also use
proxy_protocol_access to tell Squid which TCP connections to allow on
that port (and, hence, which PROXY protocol messages to trust). Denied
connections will be closed.


HTH,

Alex.

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="024190.html">[squid-users] AWS NLB Proxy Protocol V2
</A></li>
	<LI>Next message (by thread): <A HREF="024193.html">[squid-users] AWS NLB Proxy Protocol V2
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24192">[ date ]</a>
              <a href="thread.html#24192">[ thread ]</a>
              <a href="subject.html#24192">[ subject ]</a>
              <a href="author.html#24192">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
