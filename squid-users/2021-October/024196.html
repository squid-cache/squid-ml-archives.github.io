<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] AWS NLB Proxy Protocol V2
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20AWS%20NLB%20Proxy%20Protocol%20V2&In-Reply-To=%3C60a3a839-d99f-f470-e570-714dc064f95e%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="024195.html">
   <LINK REL="Next"  HREF="024197.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] AWS NLB Proxy Protocol V2</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20AWS%20NLB%20Proxy%20Protocol%20V2&In-Reply-To=%3C60a3a839-d99f-f470-e570-714dc064f95e%40measurement-factory.com%3E"
       TITLE="[squid-users] AWS NLB Proxy Protocol V2">rousskov at measurement-factory.com
       </A><BR>
    <I>Wed Oct 20 02:27:12 UTC 2021</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="024195.html">[squid-users] AWS NLB Proxy Protocol V2
</A></li>
        <LI>Next message (by thread): <A HREF="024197.html">[squid-users] AWS NLB Proxy Protocol V2
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24196">[ date ]</a>
              <a href="thread.html#24196">[ thread ]</a>
              <a href="subject.html#24196">[ subject ]</a>
              <a href="author.html#24196">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 10/19/21 4:56 PM, Ty Martin wrote:

&gt;<i> That `--haproxy-protocol` option seems like it should have done the
</I>&gt;<i> trick. Am I just shooting myself in the foot with bad curl commands?
</I>
It look like curl --haproxy-protocol does not work the way you want for
HTTPS requests sent through HTTP proxies:

&gt;<i> curl --haproxy-protocol -x <A HREF="http://127.0.0.1:3128/">http://127.0.0.1:3128/</A> <A HREF="https://...">https://...</A>
</I>&gt;&gt;<i> CONNECT localhost:443 HTTP/1.1
</I>...
&gt;<i> &lt; HTTP/1.1 200 Connection established
</I>&gt;<i>
</I>&gt;<i> * Proxy replied 200 to CONNECT request
</I>&gt;<i> * CONNECT phase completed!
</I>
&gt;&gt;<i> PROXY TCP4 127.0.0.1 127.0.0.1 35628 3128
</I>
The above PROXY protocol message is sent to the HTTP origin server
inside the CONNECT tunnel instead of being sent to Squid _before_ the
tunnel.


A similar curl command &quot;works&quot; for plain HTTP requests (because, without
CONNECT, it is impossible to distinguish the target of the PROXY
protocol message):

&gt;<i> curl --haproxy-protocol -x <A HREF="http://127.0.0.1:3128/">http://127.0.0.1:3128/</A> <A HREF="http://...">http://...</A>
</I>&gt;<i> * Connected to 127.0.0.1 (127.0.0.1) port 3128 (#0)
</I>&gt;&gt;<i> PROXY TCP4 127.0.0.1 127.0.0.1 35634 3128
</I>&gt;&gt;<i> GET <A HREF="http://...">http://...</A> HTTP/1.1
</I>
FWIW, my v5.2-based Squid groks the above correctly, forwarding the
request (if proxy_protocol_access allows it). This indicates that the
basic PROXY protocol support in my Squid works.


Unfortunately, there is no curl --proxy-haproxy-protocol (yet?) so you
will need to find another way to test. Alternatively, you can share
Squid debugging logs and/or packet captures when using your network load
balancer.


Alex.


&gt;<i> On Mon, Oct 18, 2021 at 5:32 PM Alex Rousskov wrote:
</I>&gt;<i> 
</I>&gt;<i>     On 10/18/21 5:16 PM, Ty Martin wrote:
</I>&gt;<i>     &gt; Ah, yep. Adding the following to my config got things working in AWS:
</I>&gt;<i> 
</I>&gt;<i>     &gt; acl private src 172.0.0.0/8 &lt;<A HREF="http://172.0.0.0/8">http://172.0.0.0/8</A>&gt;
</I>&gt;<i>     &gt; proxy_protocol_access allow private
</I>&gt;<i>     &gt; http_port 3128 require-proxy-header
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i>     &gt; I was trying to test it locally without success by running the Docker
</I>&gt;<i>     &gt; container and hitting it with a curl along the lines of:
</I>&gt;<i>     &gt; `curl --proxy <A HREF="http://&lt;un">http://&lt;un</A>&gt;:&lt;pw&gt;@localhost:3128 -v --header
</I>&gt;<i>     &gt; &quot;X-Forwarded-For: 192.168.0.2&quot; <A HREF="https://www.google.com">https://www.google.com</A>
</I>&gt;<i>     &lt;<A HREF="https://www.google.com">https://www.google.com</A>&gt;
</I>&gt;<i> 
</I>&gt;<i>     To test using curl, try curl --haproxy-protocol ...
</I>&gt;<i> 
</I>&gt;<i>     PROXY protocol (all versions) is not HTTP.
</I>&gt;<i> 
</I>&gt;<i>     Alex.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i>     &gt; --- Resulting Squid logs ---
</I>&gt;<i>     &gt; ```
</I>&gt;<i>     &gt; squid-proxy_1 &#160;| 2021/10/18 19:55:33| PROXY protocol error:
</I>&gt;<i>     invalid magic
</I>&gt;<i>     &gt; squid-proxy_1 &#160;| &#160; &#160; exception location: Parser.cc(260) Parse from
</I>&gt;<i>     conn6
</I>&gt;<i>     &gt; local=172.24.0.2:3128 &lt;<A HREF="http://172.24.0.2:3128">http://172.24.0.2:3128</A>&gt;
</I>&gt;<i>     &lt;<A HREF="http://172.24.0.2:3128">http://172.24.0.2:3128</A> &lt;<A HREF="http://172.24.0.2:3128">http://172.24.0.2:3128</A>&gt;&gt;
</I>&gt;<i>     remote=172.24.0.1:65426 &lt;<A HREF="http://172.24.0.1:65426">http://172.24.0.1:65426</A>&gt;
</I>&gt;<i>     &gt; &lt;<A HREF="http://172.24.0.1:65426">http://172.24.0.1:65426</A> &lt;<A HREF="http://172.24.0.1:65426">http://172.24.0.1:65426</A>&gt;&gt; FD 12 flags=1
</I>&gt;<i>     &gt; squid-proxy_1 &#160;| &#160; &#160; connection: conn6 local=172.24.0.2:3128
</I>&gt;<i>     &lt;<A HREF="http://172.24.0.2:3128">http://172.24.0.2:3128</A>&gt;
</I>&gt;<i>     &gt; &lt;<A HREF="http://172.24.0.2:3128">http://172.24.0.2:3128</A> &lt;<A HREF="http://172.24.0.2:3128">http://172.24.0.2:3128</A>&gt;&gt;
</I>&gt;<i>     remote=172.24.0.1:65426 &lt;<A HREF="http://172.24.0.1:65426">http://172.24.0.1:65426</A>&gt;
</I>&gt;<i>     &gt; &lt;<A HREF="http://172.24.0.1:65426">http://172.24.0.1:65426</A> &lt;<A HREF="http://172.24.0.1:65426">http://172.24.0.1:65426</A>&gt;&gt; FD 12 flags=1
</I>&gt;<i>     &gt; ```
</I>&gt;<i>     &gt;
</I>&gt;<i>     &gt; --- Resulting client logs ---
</I>&gt;<i>     &gt; ```
</I>&gt;<i>     &gt; * Proxy CONNECT aborted
</I>&gt;<i>     &gt; * CONNECT phase completed!
</I>&gt;<i>     &gt; * Closing connection 0
</I>&gt;<i>     &gt; curl: (56) Proxy CONNECT aborted
</I>&gt;<i>     &gt; ```
</I>&gt;<i>     &gt;
</I>&gt;<i>     &gt; Any idea offhand what I'm missing from the local testing scenario? I
</I>&gt;<i>     &gt; thought adding a &quot;X-Forwarded-For&quot; header via curl would be treated as
</I>&gt;<i>     &gt; proxy protocol v1 by Squid, but the &quot;invalid magic&quot; protocol error
</I>&gt;<i>     gives
</I>&gt;<i>     &gt; me the impression I'm not going about it the right way.
</I>&gt;<i>     &gt;
</I>&gt;<i>     &gt; On Mon, Oct 18, 2021 at 12:48 PM Alex Rousskov
</I>&gt;<i>     &gt; &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>
</I>&gt;<i>     &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt;
</I>&gt;<i>     &gt; &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>
</I>&gt;<i>     &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt;&gt;&gt; wrote:
</I>&gt;<i>     &gt;
</I>&gt;<i>     &gt;&#160; &#160; &#160;On 10/18/21 12:11 PM, Ty Martin wrote:
</I>&gt;<i>     &gt;
</I>&gt;<i>     &gt;&#160; &#160; &#160;&gt; I am looking to run Squid as a forward proxy with basic auth
</I>&gt;<i>     in Docker
</I>&gt;<i>     &gt;&#160; &#160; &#160;&gt; on AWS ECS behind a network load balancer. I seem to have things
</I>&gt;<i>     &gt;&#160; &#160; &#160;up and
</I>&gt;<i>     &gt;&#160; &#160; &#160;&gt; running for the most part; however, I am having difficulty
</I>&gt;<i>     in getting
</I>&gt;<i>     &gt;&#160; &#160; &#160;&gt; proxy protocol to work so that I get access to client IP
</I>&gt;<i>     addresses
</I>&gt;<i>     &gt;&#160; &#160; &#160;&gt; beyond that of the private IPs of my NLB. As soon as I
</I>&gt;<i>     enable proxy
</I>&gt;<i>     &gt;&#160; &#160; &#160;&gt; protocol v2 on the AWS NLB, requests to Squid start failing with
</I>&gt;<i>     &gt;&#160; &#160; &#160;errors
</I>&gt;<i>     &gt;&#160; &#160; &#160;&gt; similar to the following:
</I>&gt;<i>     &gt;&#160; &#160; &#160;&gt;
</I>&gt;<i>     &gt;&#160; &#160; &#160;&gt; Squid log: `1634330668.200 &#160; &#160; &#160;5 &lt;nlb-private-ip&gt; NONE_NONE/400
</I>&gt;<i>     &gt;&#160; &#160; &#160;2032 -
</I>&gt;<i>     &gt;&#160; &#160; &#160;&gt; error:invalid-request - HIER_NONE/- text/html`
</I>&gt;<i>     &gt;&#160; &#160; &#160;&gt; Client log: `X-Squid-Error: ERR_PROTOCOL_UNKNOWN 0`
</I>&gt;<i>     &gt;
</I>&gt;<i>     &gt;&#160; &#160; &#160;&gt; http_port 3128
</I>&gt;<i>     &gt;
</I>&gt;<i>     &gt;&#160; &#160; &#160;You must use require-proxy-header http_port option to tell
</I>&gt;<i>     Squid to
</I>&gt;<i>     &gt;&#160; &#160; &#160;always expect/require PROXY protocol messages on connections
</I>&gt;<i>     to that
</I>&gt;<i>     &gt;&#160; &#160; &#160;listening&#160; port. Otherwise, Squid will expect naked HTTP
</I>&gt;<i>     traffic and
</I>&gt;<i>     &gt;&#160; &#160; &#160;fail to parse incoming (PROXY protocol) connection bytes.
</I>&gt;<i>     &gt;
</I>&gt;<i>     &gt;&#160; &#160; &#160;According to proxy_protocol_access documentation, after adding
</I>&gt;<i>     &gt;&#160; &#160; &#160;require-proxy-header to http_port, you must also use
</I>&gt;<i>     &gt;&#160; &#160; &#160;proxy_protocol_access to tell Squid which TCP connections to
</I>&gt;<i>     allow on
</I>&gt;<i>     &gt;&#160; &#160; &#160;that port (and, hence, which PROXY protocol messages to
</I>&gt;<i>     trust). Denied
</I>&gt;<i>     &gt;&#160; &#160; &#160;connections will be closed.
</I>&gt;<i>     &gt;
</I>&gt;<i>     &gt;
</I>&gt;<i>     &gt;&#160; &#160; &#160;HTH,
</I>&gt;<i>     &gt;
</I>&gt;<i>     &gt;&#160; &#160; &#160;Alex.
</I>&gt;<i>     &gt;
</I>&gt;<i> 
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="024195.html">[squid-users] AWS NLB Proxy Protocol V2
</A></li>
	<LI>Next message (by thread): <A HREF="024197.html">[squid-users] AWS NLB Proxy Protocol V2
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24196">[ date ]</a>
              <a href="thread.html#24196">[ thread ]</a>
              <a href="subject.html#24196">[ subject ]</a>
              <a href="author.html#24196">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
