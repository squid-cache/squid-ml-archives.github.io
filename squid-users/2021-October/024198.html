<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] logformat odd values
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20logformat%20odd%20values&In-Reply-To=%3C2b61143a-1196-8b0d-778d-e17bf1708250%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="024197.html">
   <LINK REL="Next"  HREF="024199.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] logformat odd values</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20logformat%20odd%20values&In-Reply-To=%3C2b61143a-1196-8b0d-778d-e17bf1708250%40measurement-factory.com%3E"
       TITLE="[squid-users] logformat odd values">rousskov at measurement-factory.com
       </A><BR>
    <I>Wed Oct 20 18:49:03 UTC 2021</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="024197.html">[squid-users] AWS NLB Proxy Protocol V2
</A></li>
        <LI>Next message (by thread): <A HREF="024199.html">[squid-users] How to pass TeamViewer traffic
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24198">[ date ]</a>
              <a href="thread.html#24198">[ thread ]</a>
              <a href="subject.html#24198">[ subject ]</a>
              <a href="author.html#24198">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>FTR: Factory investigation triggered by this email thread found an
explanation for the observed odd measurements. Armed with that
knowledge, we concluded that %icap::tt documentation is wrong and
proposed a fix at <A HREF="https://github.com/squid-cache/squid/pull/914/">https://github.com/squid-cache/squid/pull/914/</A>


HTH,

Alex.

On 9/17/21 10:56 AM, Alex Rousskov wrote:
&gt;<i> On 9/17/21 10:35 AM, Moti Berger wrote:
</I>&gt;<i> 
</I>&gt;&gt;<i> It's possible that in some cases they will run concurrently, however not
</I>&gt;&gt;<i> in my setup. The ICAPs are chained. If the chain doesn't guarantee it
</I>&gt;&gt;<i> please let me know since I rely on it.
</I>&gt;<i> 
</I>&gt;<i> Chaining adaptation services guarantees that they will _start_
</I>&gt;<i> sequentially, but does not guarantee that they will _run_ sequentially.
</I>&gt;<i> That guarantee can only come from the services themselves.
</I>&gt;<i> 
</I>&gt;<i> For example, imagine two chained REQMOD services handling a 1GB HTTP PUT
</I>&gt;<i> request. If the first service emits the adapted request headers (at
</I>&gt;<i> least), then Squid will start the second service and will send those
</I>&gt;<i> adapted request headers (and any adapted request body trickled after the
</I>&gt;<i> headers) to that second service. The two services, in that case, will
</I>&gt;<i> run concurrently.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> Regarding what you said about things that can happen in parallel, I'm OK
</I>&gt;&gt;<i> with it since what I care the most is the extra time my ICAPs add to the
</I>&gt;&gt;<i> user latency and this is what I would like to measure.
</I>&gt;<i> 
</I>&gt;<i> The desire to measure ICAP overheads is common and natural.
</I>&gt;<i> Unfortunately, bugs notwithstanding, %icap::tt measures the latency
</I>&gt;<i> added exclusively by adaptation if and only if the corresponding
</I>&gt;<i> adaptation transaction is tiny (e.g., one I/O to receive the entire
</I>&gt;<i> adapted HTTP message from the adaptation service). In most real world
</I>&gt;<i> scenarios involving larger HTTP messages, adaptation services will run
</I>&gt;<i> in parallel with Squid reading/writing from the HTTP client and/or
</I>&gt;<i> server because Squid uses adapted bytes as soon as it can.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> HTH,
</I>&gt;<i> 
</I>&gt;<i> Alex.
</I>&gt;<i> 
</I>&gt;&gt;<i> On Wed, Sep 15, 2021, 20:47 Alex Rousskov wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>     On 9/14/21 3:04 PM, Moti Berger wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>     &gt; I have the followings in squid.conf:
</I>&gt;&gt;<i>     &gt;
</I>&gt;&gt;<i>     &gt;&#160; &#160; &#160;logformat metrics %icap::tt %adapt::all_trs %adapt::sum_trs
</I>&gt;&gt;<i>     &gt;&#160; &#160; &#160;%{service_req_a}adapt::sum_trs %{service_resp_a}adapt::sum_trs
</I>&gt;&gt;<i>     &gt;&#160; &#160; &#160;%{service_req_b}adapt::sum_trs %{service_resp_b}adapt::sum_trs
</I>&gt;&gt;<i>     &gt;&#160; &#160; &#160;access_log daemon:/var/log/squid/metrics.log metrics
</I>&gt;&gt;<i>     &gt;
</I>&gt;&gt;<i>     &gt; &#160;
</I>&gt;&gt;<i>     &gt;
</I>&gt;&gt;<i>     &gt;&#160; &#160; &#160;icap_service service_req_a reqmod_precache bypass=1
</I>&gt;&gt;<i>     on-overload=wait
</I>&gt;&gt;<i>     &gt;&#160; &#160; &#160;routing=1 <A HREF="icap://a.y:12345/request">icap://a.y:12345/request</A>
</I>&gt;&gt;<i>     &gt;&#160; &#160; &#160;icap_service service_req_b reqmod_precache bypass=1
</I>&gt;&gt;<i>     on-overload=wait
</I>&gt;&gt;<i>     &gt;&#160; &#160; &#160;<A HREF="icap://b.y:10101/request">icap://b.y:10101/request</A>
</I>&gt;&gt;<i>     &gt;&#160; &#160; &#160;adaptation_service_chain svcRequest service_req_a&#160;service_req_b
</I>&gt;&gt;<i>     &gt;&#160; &#160; &#160;adaptation_access svcRequest deny manager
</I>&gt;&gt;<i>     &gt;&#160; &#160; &#160;adaptation_access svcRequest allow all
</I>&gt;&gt;<i>     &gt;&#160; &#160; &#160;icap_service service_resp_a respmod_precache bypass=1
</I>&gt;&gt;<i>     &gt;&#160; &#160; &#160;on-overload=wait routing=1 <A HREF="icap://a.y:12345/response">icap://a.y:12345/response</A>
</I>&gt;&gt;<i>     &gt;&#160; &#160; &#160;icap_service service_resp_b respmod_precache bypass=1
</I>&gt;&gt;<i>     &gt;&#160; &#160; &#160;on-overload=wait <A HREF="icap://b.y:10101/response">icap://b.y:10101/response</A>
</I>&gt;&gt;<i>     &gt;&#160; &#160; &#160;adaptation_service_chain svcResponse service_resp_a&#160;service_resp_b
</I>&gt;&gt;<i>     &gt;&#160; &#160; &#160;adaptation_access svcResponse deny manager
</I>&gt;&gt;<i>     &gt;&#160; &#160; &#160;adaptation_access svcResponse allow all
</I>&gt;&gt;<i>     &gt;
</I>&gt;&gt;<i>     &gt;
</I>&gt;&gt;<i>     &gt; &#160;I see in metrics.log lines like this:
</I>&gt;&gt;<i>     &gt;
</I>&gt;&gt;<i>     &gt;&#160; &#160; &#160;4 4,180 4,180 4 180 - -
</I>&gt;&gt;<i>     &gt;
</I>&gt;&gt;<i>     &gt;
</I>&gt;&gt;<i>     &gt; Now I wonder how come the value of %icap:tt isn't at least as the
</I>&gt;&gt;<i>     sum of
</I>&gt;&gt;<i>     &gt; all the numbers appear on %adapt::all_trs or %adapt::sum_trs (assuming
</I>&gt;&gt;<i>     &gt; no failed transactions)?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>     There is probably a bug somewhere, but please note that %icap:tt may not
</I>&gt;&gt;<i>     be the sum of individual transaction response times (in _some_ cases)
</I>&gt;&gt;<i>     even after that bug is fixed because those individual transactions may
</I>&gt;&gt;<i>     run _concurrently_ (i.e. partially overlap in time).
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>     &gt; If %icap:tt isn't at least the sum of all ICAPs processing time,
</I>&gt;&gt;<i>     what is?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>     Bugs notwithstanding, it is approximate time a master transaction spent
</I>&gt;&gt;<i>     doing adaptation (including checking whether adaptation is necessary).
</I>&gt;&gt;<i>     This stopwatch ticks when adaptation_access ACLs are checked and also
</I>&gt;&gt;<i>     when at least one adaptation transaction associated with that master
</I>&gt;&gt;<i>     transaction is in progress.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>     Please note that a master transaction can do a lot of different things
</I>&gt;&gt;<i>     at once or in parallel. For example, it can communicate with an HTTP
</I>&gt;&gt;<i>     client while communicating with an FTP server while communicating with
</I>&gt;&gt;<i>     an eCAP REQMOD adaptation service while communicating with a DNS server
</I>&gt;&gt;<i>     to decide whether to start communicating with an ICAP RESPMOD service.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>     HTH,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>     Alex.
</I>&gt;&gt;<i>     _______________________________________________
</I>&gt;&gt;<i>     squid-users mailing list
</I>&gt;&gt;<i>     <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;&gt;<i>     &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>&gt;
</I>&gt;&gt;<i>     <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;&gt;<i>     &lt;<A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>&gt;
</I>&gt;&gt;<i>
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i> 
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="024197.html">[squid-users] AWS NLB Proxy Protocol V2
</A></li>
	<LI>Next message (by thread): <A HREF="024199.html">[squid-users] How to pass TeamViewer traffic
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24198">[ date ]</a>
              <a href="thread.html#24198">[ thread ]</a>
              <a href="subject.html#24198">[ subject ]</a>
              <a href="author.html#24198">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
