<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Configuring SSL Bump on CONNECT, but no SSL Bump on Transparent
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Configuring%20SSL%20Bump%20on%20CONNECT%2C%0A%20but%20no%20SSL%20Bump%20on%20Transparent&In-Reply-To=%3CLO2P123MB600857B60EE5321B3DC97BD9A9D09%40LO2P123MB6008.GBRP123.PROD.OUTLOOK.COM%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="024015.html">
   <LINK REL="Next"  HREF="024012.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Configuring SSL Bump on CONNECT, but no SSL Bump on Transparent</H1>
    <B>Graham Wharton</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Configuring%20SSL%20Bump%20on%20CONNECT%2C%0A%20but%20no%20SSL%20Bump%20on%20Transparent&In-Reply-To=%3CLO2P123MB600857B60EE5321B3DC97BD9A9D09%40LO2P123MB6008.GBRP123.PROD.OUTLOOK.COM%3E"
       TITLE="[squid-users] Configuring SSL Bump on CONNECT, but no SSL Bump on Transparent">graham at gwharton.me.uk
       </A><BR>
    <I>Sat Sep  4 10:44:18 UTC 2021</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="024015.html">[squid-users] Fwd: Getting a squid clients list
</A></li>
        <LI>Next message (by thread): <A HREF="024012.html">[squid-users] Configuring SSL Bump on CONNECT, but no SSL Bump on Transparent
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24011">[ date ]</a>
              <a href="thread.html#24011">[ thread ]</a>
              <a href="subject.html#24011">[ subject ]</a>
              <a href="author.html#24011">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi all,

Squid 3.5.20

I am attempting to configure the following

Port 3128 = Accepts CONNECT requests with SSL Bump for all sites
Port 3129 = HTTP port for transparent proxy
Port 3130 = HTTPS port for transparent proxy - NO SSL Bump, all sites should always TUNNEL

Is the above config possible?

The relevant sections of my config are

#TANSPARENT
http_port 10.0.0.36:3129
https_port 10.0.0.36:3130

#CONNECT
http_port 10.0.0.36:3128 ssl-bump \
        cert=/etc/squid/ssl_cert/squid-ca-cert.pem \
        generate-host-certificates=on dynamic_cert_mem_cache_size=4MB
sslcrtd_program /usr/lib64/squid/ssl_crtd -s /var/lib/ssl_db -M 4MB

#Permissions
http_access allow localnet
http_access allow localhost
http_access deny all

##Steps
acl step1 at_step SslBump1
acl step2 at_step SslBump2
acl step3 at_step SslBump3

#Bump Rules
ssl_bump peek step1
ssl_bump bump all
ssl_bump splice all

All appears to work correctly, apart from transparent connections for HTTPS. These are getting bumped.

According to the logs

2021/09/04 10:38:54.129 kid1| 5,2| TcpAcceptor.cc(218) doAccept: New connection on FD 30
2021/09/04 10:38:54.129 kid1| 5,2| TcpAcceptor.cc(293) acceptNext: connection on local=10.0.0.36:3130 remote=[::] FD 30 flags=41
2021/09/04 10:38:54.129 kid1| 33,2| client_side.cc(3920) httpsSslBumpAccessCheckDone: sslBump needed for local=142.250.187.196:443 remote=10.0.1.254:51928 FD 12 flags=33 method 3

Looking at the code, it would appear that because the destination is ALLOWED for the ssl_bump acl, the connection is automatically upgraded to ssl_bump by the httpsSslBumpAccessCheckDone function. But this isn't what I want. I want ssl_bump to be completely disabled on my transparent proxy, I only wan to bump connections for connections that have explicitly set their proxy.

Any suggestions on how to overcome this, apart from running two copies of squid.

Thanks in advance

Graham Wharton


-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20210904/143045b6/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20210904/143045b6/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="024015.html">[squid-users] Fwd: Getting a squid clients list
</A></li>
	<LI>Next message (by thread): <A HREF="024012.html">[squid-users] Configuring SSL Bump on CONNECT, but no SSL Bump on Transparent
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24011">[ date ]</a>
              <a href="thread.html#24011">[ thread ]</a>
              <a href="subject.html#24011">[ subject ]</a>
              <a href="author.html#24011">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
