<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Configuring SSL Bump on CONNECT, but no SSL Bump on Transparent
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Configuring%20SSL%20Bump%20on%20CONNECT%2C%0A%20but%20no%20SSL%20Bump%20on%20Transparent&In-Reply-To=%3Cf4f894b6-290b-3043-dcc5-82dc668ab483%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="024012.html">
   <LINK REL="Next"  HREF="024014.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Configuring SSL Bump on CONNECT, but no SSL Bump on Transparent</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Configuring%20SSL%20Bump%20on%20CONNECT%2C%0A%20but%20no%20SSL%20Bump%20on%20Transparent&In-Reply-To=%3Cf4f894b6-290b-3043-dcc5-82dc668ab483%40measurement-factory.com%3E"
       TITLE="[squid-users] Configuring SSL Bump on CONNECT, but no SSL Bump on Transparent">rousskov at measurement-factory.com
       </A><BR>
    <I>Sat Sep  4 19:58:31 UTC 2021</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="024012.html">[squid-users] Configuring SSL Bump on CONNECT, but no SSL Bump on Transparent
</A></li>
        <LI>Next message (by thread): <A HREF="024014.html">[squid-users] OT - myportname ACL
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24013">[ date ]</a>
              <a href="thread.html#24013">[ thread ]</a>
              <a href="subject.html#24013">[ subject ]</a>
              <a href="author.html#24013">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 9/4/21 7:47 AM, Graham Wharton wrote:

&gt;<i> Besides I&#8217;ve managed to configure it using localport acl&#8217;s to detect
</I>&gt;<i> which port the request came in on and bump accordingly. Not sure if this
</I>&gt;<i> is the best way.
</I>
I do not remember what works in Squid v3, but, in general, the best way
is to name your ports and use the myportname ACL instead of trying to
match one of the many port numbers associated with transparent
connections, especially when Squid has a tendency to &quot;swap&quot; source and
destination addresses in that context.

Besides not running v3, I also would not try to bump at step1 -- there
is so little information for Squid to use during step1 that the client
is very unlikely to be happy about the Squid-generated certificate.

To bump at step2:

  ssl_bump peek step1
  ssl_bump bump shouldBeBumped
  ssl_bump splice all

or even step3:

  ssl_bump peek step1
  ssl_bump stare shouldBeBumped
  ssl_bump bump shouldBeBumped
  ssl_bump splice all

... where shouldBeBumped is your ACL that matches transactions that
should be bumped.


HTH,

Alex.


&gt;<i> &#160;
</I>&gt;<i> 
</I>&gt;<i> Thanks for listening.
</I>&gt;<i> 
</I>&gt;<i> &#160;
</I>&gt;<i> 
</I>&gt;<i> For info for anyone else interested
</I>&gt;<i> 
</I>&gt;<i> &#160;
</I>&gt;<i> 
</I>&gt;<i> acl localnet src 10.0.0.0/8&#160;&#160;&#160;&#160; # RFC1918 possible internal network
</I>&gt;<i> 
</I>&gt;<i> acl localnet src 172.16.0.0/12&#160; # RFC1918 possible internal network
</I>&gt;<i> 
</I>&gt;<i> acl localnet src 192.168.0.0/16 # RFC1918 possible internal network
</I>&gt;<i> 
</I>&gt;<i> acl localnet src fc00::/7&#160;&#160;&#160;&#160;&#160;&#160; # RFC 4193 local private network range
</I>&gt;<i> 
</I>&gt;<i> acl localnet src fe80::/10&#160;&#160;&#160;&#160;&#160; # RFC 4291 link-local (directly plugged)
</I>&gt;<i> machines
</I>&gt;<i> 
</I>&gt;<i> acl connectport localport 3128
</I>&gt;<i> 
</I>&gt;<i> http_port 10.0.0.36:3129 intercept
</I>&gt;<i> 
</I>&gt;<i> https_port 10.0.0.36:3130 intercept ssl-bump \
</I>&gt;<i> 
</I>&gt;<i> &#160;&#160;&#160;&#160;&#160;&#160;&#160; cert=/etc/squid/ssl_cert/squid-ca-cert.pem \
</I>&gt;<i> 
</I>&gt;<i> &#160;&#160;&#160;&#160;&#160;&#160;&#160; generate-host-certificates=on dynamic_cert_mem_cache_size=4MB
</I>&gt;<i> 
</I>&gt;<i> http_port 10.0.0.36:3128 ssl-bump \
</I>&gt;<i> 
</I>&gt;<i> &#160;&#160;&#160;&#160;&#160;&#160;&#160; cert=/etc/squid/ssl_cert/squid-ca-cert.pem \
</I>&gt;<i> 
</I>&gt;<i> &#160;&#160;&#160;&#160;&#160;&#160;&#160; generate-host-certificates=on dynamic_cert_mem_cache_size=4MB
</I>&gt;<i> 
</I>&gt;<i> sslcrtd_program /usr/lib64/squid/ssl_crtd -s /var/lib/ssl_db -M 4MB
</I>&gt;<i> 
</I>&gt;<i> http_access allow localnet
</I>&gt;<i> 
</I>&gt;<i> http_access allow localhost
</I>&gt;<i> 
</I>&gt;<i> http_access deny all
</I>&gt;<i> 
</I>&gt;<i> acl step1 at_step SslBump1
</I>&gt;<i> 
</I>&gt;<i> acl step2 at_step SslBump2
</I>&gt;<i> 
</I>&gt;<i> acl step3 at_step SslBump3
</I>&gt;<i> 
</I>&gt;<i> ssl_bump bump connectport
</I>&gt;<i> 
</I>&gt;<i> ssl_bump peek all
</I>&gt;<i> 
</I>&gt;<i> ssl_bump splice all
</I>&gt;<i> 
</I>&gt;<i> &#160;
</I>&gt;<i> 
</I>&gt;<i> Cheers
</I>&gt;<i> 
</I>&gt;<i> &#160;
</I>&gt;<i> 
</I>&gt;<i> Graham
</I>&gt;<i> 
</I>&gt;<i> &#160;
</I>&gt;<i> 
</I>&gt;<i> &#160;
</I>&gt;<i> 
</I>&gt;<i> *From:*squid-users &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>&gt; *On
</I>&gt;<i> Behalf Of *Graham Wharton
</I>&gt;<i> *Sent:* 04 September 2021 11:44
</I>&gt;<i> *To:* <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> *Subject:* [squid-users] Configuring SSL Bump on CONNECT, but no SSL
</I>&gt;<i> Bump on Transparent
</I>&gt;<i> 
</I>&gt;<i> &#160;
</I>&gt;<i> 
</I>&gt;<i> Hi all,
</I>&gt;<i> 
</I>&gt;<i> &#160;
</I>&gt;<i> 
</I>&gt;<i> Squid 3.5.20
</I>&gt;<i> 
</I>&gt;<i> &#160;
</I>&gt;<i> 
</I>&gt;<i> I am attempting to configure the following
</I>&gt;<i> 
</I>&gt;<i> &#160;
</I>&gt;<i> 
</I>&gt;<i> Port 3128 = Accepts CONNECT requests with SSL Bump for all sites
</I>&gt;<i> 
</I>&gt;<i> Port 3129 = HTTP port for transparent proxy
</I>&gt;<i> 
</I>&gt;<i> Port 3130 = HTTPS port for transparent proxy &#8211; NO SSL Bump, all sites
</I>&gt;<i> should always TUNNEL
</I>&gt;<i> 
</I>&gt;<i> &#160;
</I>&gt;<i> 
</I>&gt;<i> Is the above config possible?
</I>&gt;<i> 
</I>&gt;<i> &#160;
</I>&gt;<i> 
</I>&gt;<i> The relevant sections of my config are
</I>&gt;<i> 
</I>&gt;<i> &#160;
</I>&gt;<i> 
</I>&gt;<i> #TANSPARENT
</I>&gt;<i> 
</I>&gt;<i> http_port 10.0.0.36:3129
</I>&gt;<i> 
</I>&gt;<i> https_port 10.0.0.36:3130
</I>&gt;<i> 
</I>&gt;<i> &#160;
</I>&gt;<i> 
</I>&gt;<i> #CONNECT
</I>&gt;<i> 
</I>&gt;<i> http_port 10.0.0.36:3128 ssl-bump \
</I>&gt;<i> 
</I>&gt;<i> &#160;&#160;&#160;&#160;&#160;&#160;&#160; cert=/etc/squid/ssl_cert/squid-ca-cert.pem \
</I>&gt;<i> 
</I>&gt;<i> &#160;&#160;&#160;&#160;&#160;&#160;&#160; generate-host-certificates=on dynamic_cert_mem_cache_size=4MB
</I>&gt;<i> 
</I>&gt;<i> sslcrtd_program /usr/lib64/squid/ssl_crtd -s /var/lib/ssl_db -M 4MB
</I>&gt;<i> 
</I>&gt;<i> &#160;
</I>&gt;<i> 
</I>&gt;<i> #Permissions
</I>&gt;<i> 
</I>&gt;<i> http_access allow localnet
</I>&gt;<i> 
</I>&gt;<i> http_access allow localhost
</I>&gt;<i> 
</I>&gt;<i> http_access deny all
</I>&gt;<i> 
</I>&gt;<i> &#160;
</I>&gt;<i> 
</I>&gt;<i> ##Steps
</I>&gt;<i> 
</I>&gt;<i> acl step1 at_step SslBump1
</I>&gt;<i> 
</I>&gt;<i> acl step2 at_step SslBump2
</I>&gt;<i> 
</I>&gt;<i> acl step3 at_step SslBump3
</I>&gt;<i> 
</I>&gt;<i> &#160;
</I>&gt;<i> 
</I>&gt;<i> #Bump Rules
</I>&gt;<i> 
</I>&gt;<i> ssl_bump peek step1
</I>&gt;<i> 
</I>&gt;<i> ssl_bump bump all
</I>&gt;<i> 
</I>&gt;<i> ssl_bump splice all
</I>&gt;<i> 
</I>&gt;<i> &#160;
</I>&gt;<i> 
</I>&gt;<i> All appears to work correctly, apart from transparent connections for
</I>&gt;<i> HTTPS. These are getting bumped.
</I>&gt;<i> 
</I>&gt;<i> &#160;
</I>&gt;<i> 
</I>&gt;<i> According to the logs
</I>&gt;<i> 
</I>&gt;<i> &#160;
</I>&gt;<i> 
</I>&gt;<i> 2021/09/04 10:38:54.129 kid1| 5,2| TcpAcceptor.cc(218) doAccept: New
</I>&gt;<i> connection on FD 30
</I>&gt;<i> 
</I>&gt;<i> 2021/09/04 10:38:54.129 kid1| 5,2| TcpAcceptor.cc(293) acceptNext:
</I>&gt;<i> connection on local=10.0.0.36:3130 remote=[::] FD 30 flags=41
</I>&gt;<i> 
</I>&gt;<i> 2021/09/04 10:38:54.129 kid1| 33,2| client_side.cc(3920)
</I>&gt;<i> httpsSslBumpAccessCheckDone: sslBump needed for
</I>&gt;<i> local=142.250.187.196:443 remote=10.0.1.254:51928 FD 12 flags=33 method 3
</I>&gt;<i> 
</I>&gt;<i> &#160;
</I>&gt;<i> 
</I>&gt;<i> Looking at the code, it would appear that because the destination is
</I>&gt;<i> ALLOWED for the ssl_bump acl, the connection is automatically upgraded
</I>&gt;<i> to ssl_bump by the httpsSslBumpAccessCheckDone function. But this isn&#8217;t
</I>&gt;<i> what I want. I want ssl_bump to be completely disabled on my transparent
</I>&gt;<i> proxy, I only wan to bump connections for connections that have
</I>&gt;<i> explicitly set their proxy.
</I>&gt;<i> 
</I>&gt;<i> &#160;
</I>&gt;<i> 
</I>&gt;<i> Any suggestions on how to overcome this, apart from running two copies
</I>&gt;<i> of squid.
</I>&gt;<i> 
</I>&gt;<i> &#160;
</I>&gt;<i> 
</I>&gt;<i> Thanks in advance
</I>&gt;<i> 
</I>&gt;<i> &#160;
</I>&gt;<i> 
</I>&gt;<i> Graham Wharton
</I>&gt;<i> 
</I>&gt;<i> &#160;
</I>&gt;<i> 
</I>&gt;<i> &#160;
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i> 
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="024012.html">[squid-users] Configuring SSL Bump on CONNECT, but no SSL Bump on Transparent
</A></li>
	<LI>Next message (by thread): <A HREF="024014.html">[squid-users] OT - myportname ACL
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24013">[ date ]</a>
              <a href="thread.html#24013">[ thread ]</a>
              <a href="subject.html#24013">[ subject ]</a>
              <a href="author.html#24013">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
