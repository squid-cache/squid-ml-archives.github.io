<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] logformat odd values
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20logformat%20odd%20values&In-Reply-To=%3Cd85a66e2-6b00-43e2-0f61-d1f75853df29%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="024067.html">
   <LINK REL="Next"  HREF="024045.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] logformat odd values</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20logformat%20odd%20values&In-Reply-To=%3Cd85a66e2-6b00-43e2-0f61-d1f75853df29%40measurement-factory.com%3E"
       TITLE="[squid-users] logformat odd values">rousskov at measurement-factory.com
       </A><BR>
    <I>Fri Sep 17 14:56:21 UTC 2021</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="024067.html">[squid-users] logformat odd values
</A></li>
        <LI>Next message (by thread): <A HREF="024045.html">[squid-users] squid 5.1/Debian WARNING: no_suid: setuid(0): (1) Operation not permitted
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24068">[ date ]</a>
              <a href="thread.html#24068">[ thread ]</a>
              <a href="subject.html#24068">[ subject ]</a>
              <a href="author.html#24068">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 9/17/21 10:35 AM, Moti Berger wrote:

&gt;<i> It's possible that in some cases they will run concurrently, however not
</I>&gt;<i> in my setup. The ICAPs are chained. If the chain doesn't guarantee it
</I>&gt;<i> please let me know since I rely on it.
</I>
Chaining adaptation services guarantees that they will _start_
sequentially, but does not guarantee that they will _run_ sequentially.
That guarantee can only come from the services themselves.

For example, imagine two chained REQMOD services handling a 1GB HTTP PUT
request. If the first service emits the adapted request headers (at
least), then Squid will start the second service and will send those
adapted request headers (and any adapted request body trickled after the
headers) to that second service. The two services, in that case, will
run concurrently.


&gt;<i> Regarding what you said about things that can happen in parallel, I'm OK
</I>&gt;<i> with it since what I care the most is the extra time my ICAPs add to the
</I>&gt;<i> user latency and this is what I would like to measure.
</I>
The desire to measure ICAP overheads is common and natural.
Unfortunately, bugs notwithstanding, %icap::tt measures the latency
added exclusively by adaptation if and only if the corresponding
adaptation transaction is tiny (e.g., one I/O to receive the entire
adapted HTTP message from the adaptation service). In most real world
scenarios involving larger HTTP messages, adaptation services will run
in parallel with Squid reading/writing from the HTTP client and/or
server because Squid uses adapted bytes as soon as it can.


HTH,

Alex.

&gt;<i> On Wed, Sep 15, 2021, 20:47 Alex Rousskov wrote:
</I>&gt;<i> 
</I>&gt;<i>     On 9/14/21 3:04 PM, Moti Berger wrote:
</I>&gt;<i> 
</I>&gt;<i>     &gt; I have the followings in squid.conf:
</I>&gt;<i>     &gt;
</I>&gt;<i>     &gt;&#160; &#160; &#160;logformat metrics %icap::tt %adapt::all_trs %adapt::sum_trs
</I>&gt;<i>     &gt;&#160; &#160; &#160;%{service_req_a}adapt::sum_trs %{service_resp_a}adapt::sum_trs
</I>&gt;<i>     &gt;&#160; &#160; &#160;%{service_req_b}adapt::sum_trs %{service_resp_b}adapt::sum_trs
</I>&gt;<i>     &gt;&#160; &#160; &#160;access_log daemon:/var/log/squid/metrics.log metrics
</I>&gt;<i>     &gt;
</I>&gt;<i>     &gt; &#160;
</I>&gt;<i>     &gt;
</I>&gt;<i>     &gt;&#160; &#160; &#160;icap_service service_req_a reqmod_precache bypass=1
</I>&gt;<i>     on-overload=wait
</I>&gt;<i>     &gt;&#160; &#160; &#160;routing=1 <A HREF="icap://a.y:12345/request">icap://a.y:12345/request</A>
</I>&gt;<i>     &gt;&#160; &#160; &#160;icap_service service_req_b reqmod_precache bypass=1
</I>&gt;<i>     on-overload=wait
</I>&gt;<i>     &gt;&#160; &#160; &#160;<A HREF="icap://b.y:10101/request">icap://b.y:10101/request</A>
</I>&gt;<i>     &gt;&#160; &#160; &#160;adaptation_service_chain svcRequest service_req_a&#160;service_req_b
</I>&gt;<i>     &gt;&#160; &#160; &#160;adaptation_access svcRequest deny manager
</I>&gt;<i>     &gt;&#160; &#160; &#160;adaptation_access svcRequest allow all
</I>&gt;<i>     &gt;&#160; &#160; &#160;icap_service service_resp_a respmod_precache bypass=1
</I>&gt;<i>     &gt;&#160; &#160; &#160;on-overload=wait routing=1 <A HREF="icap://a.y:12345/response">icap://a.y:12345/response</A>
</I>&gt;<i>     &gt;&#160; &#160; &#160;icap_service service_resp_b respmod_precache bypass=1
</I>&gt;<i>     &gt;&#160; &#160; &#160;on-overload=wait <A HREF="icap://b.y:10101/response">icap://b.y:10101/response</A>
</I>&gt;<i>     &gt;&#160; &#160; &#160;adaptation_service_chain svcResponse service_resp_a&#160;service_resp_b
</I>&gt;<i>     &gt;&#160; &#160; &#160;adaptation_access svcResponse deny manager
</I>&gt;<i>     &gt;&#160; &#160; &#160;adaptation_access svcResponse allow all
</I>&gt;<i>     &gt;
</I>&gt;<i>     &gt;
</I>&gt;<i>     &gt; &#160;I see in metrics.log lines like this:
</I>&gt;<i>     &gt;
</I>&gt;<i>     &gt;&#160; &#160; &#160;4 4,180 4,180 4 180 - -
</I>&gt;<i>     &gt;
</I>&gt;<i>     &gt;
</I>&gt;<i>     &gt; Now I wonder how come the value of %icap:tt isn't at least as the
</I>&gt;<i>     sum of
</I>&gt;<i>     &gt; all the numbers appear on %adapt::all_trs or %adapt::sum_trs (assuming
</I>&gt;<i>     &gt; no failed transactions)?
</I>&gt;<i> 
</I>&gt;<i>     There is probably a bug somewhere, but please note that %icap:tt may not
</I>&gt;<i>     be the sum of individual transaction response times (in _some_ cases)
</I>&gt;<i>     even after that bug is fixed because those individual transactions may
</I>&gt;<i>     run _concurrently_ (i.e. partially overlap in time).
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i>     &gt; If %icap:tt isn't at least the sum of all ICAPs processing time,
</I>&gt;<i>     what is?
</I>&gt;<i> 
</I>&gt;<i>     Bugs notwithstanding, it is approximate time a master transaction spent
</I>&gt;<i>     doing adaptation (including checking whether adaptation is necessary).
</I>&gt;<i>     This stopwatch ticks when adaptation_access ACLs are checked and also
</I>&gt;<i>     when at least one adaptation transaction associated with that master
</I>&gt;<i>     transaction is in progress.
</I>&gt;<i> 
</I>&gt;<i>     Please note that a master transaction can do a lot of different things
</I>&gt;<i>     at once or in parallel. For example, it can communicate with an HTTP
</I>&gt;<i>     client while communicating with an FTP server while communicating with
</I>&gt;<i>     an eCAP REQMOD adaptation service while communicating with a DNS server
</I>&gt;<i>     to decide whether to start communicating with an ICAP RESPMOD service.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i>     HTH,
</I>&gt;<i> 
</I>&gt;<i>     Alex.
</I>&gt;<i>     _______________________________________________
</I>&gt;<i>     squid-users mailing list
</I>&gt;<i>     <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i>     &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>&gt;
</I>&gt;<i>     <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i>     &lt;<A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>&gt;
</I>&gt;<i> 
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="024067.html">[squid-users] logformat odd values
</A></li>
	<LI>Next message (by thread): <A HREF="024045.html">[squid-users] squid 5.1/Debian WARNING: no_suid: setuid(0): (1) Operation not permitted
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24068">[ date ]</a>
              <a href="thread.html#24068">[ thread ]</a>
              <a href="subject.html#24068">[ subject ]</a>
              <a href="author.html#24068">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
