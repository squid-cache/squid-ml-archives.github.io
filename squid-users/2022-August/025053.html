<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] filedescriptors on debian/systemd
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20filedescriptors%20on%20debian/systemd&In-Reply-To=%3CYulPiicK1TqlA1p7%40fantomas.sk%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="025046.html">
   <LINK REL="Next"  HREF="025058.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] filedescriptors on debian/systemd</H1>
    <B>Matus UHLAR - fantomas</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20filedescriptors%20on%20debian/systemd&In-Reply-To=%3CYulPiicK1TqlA1p7%40fantomas.sk%3E"
       TITLE="[squid-users] filedescriptors on debian/systemd">uhlar at fantomas.sk
       </A><BR>
    <I>Tue Aug  2 16:23:38 UTC 2022</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="025046.html">[squid-users] filedescriptors on debian/systemd
</A></li>
        <LI>Next message (by thread): <A HREF="025058.html">[squid-users] filedescriptors on debian/systemd
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25053">[ date ]</a>
              <a href="thread.html#25053">[ thread ]</a>
              <a href="subject.html#25053">[ subject ]</a>
              <a href="author.html#25053">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 02.08.22 17:21, <A HREF="https://lists.squid-cache.org/listinfo/squid-users">ngtech1ltd at gmail.com</A> wrote:
&gt;<i>What's the bug exactly?
</I>
only 1k of fildescriptors by default. Even if hard limit is 1M (at least for 
login)

debian sysvinit script has hack that sets 64k fd limit, systemd unit file 
doesn't have this hack.

&gt;<i>The design of systemd is to enforce the FD limit.
</I>&gt;<i>This is coming from the init 0 level of the design and due to this,
</I>&gt;<i>squid cannot &quot;patch&quot; the kernel at runtime like any other process.
</I>&gt;<i>The OS and systemd do not give any API to allow a request for&quot;more FD&quot;.
</I>&gt;<i>I assume that these days it makes sense for a request from the kernel or
</I>&gt;<i>systemd to implement such a feature but I don't know if anyone have worked on this.
</I>
afaik that process can raise its soft limit up to hard limit level.

squid seems not to do this and debian 11 systemd unit files has no setting 
of limit at all.


&gt;<i>-----Original Message-----
</I>&gt;<i>From: squid-users &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>&gt; On Behalf Of Matus UHLAR - fantomas
</I>&gt;<i>Sent: Tuesday, 2 August 2022 16:54
</I>&gt;<i>To: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i>Subject: [squid-users] filedescriptors on debian/systemd
</I>&gt;<i>
</I>&gt;<i>Hello,
</I>&gt;<i>
</I>&gt;<i>I have encountered Debian bug 934208:
</I>&gt;<i>
</I>&gt;<i>2022/07/28 16:40:53 kid1| With 1024 file descriptors available
</I>&gt;<i>2022/07/29 06:50:18 kid1| WARNING! Your cache is running out of filedescriptors
</I>&gt;<i>
</I>&gt;<i>according to the bug report:
</I>&gt;<i>
</I>&gt;<i>&quot;Under systemd the default is not to have any limitation at all.&quot;
</I>&gt;<i>
</I>&gt;<i>which seems not to be true, but:
</I>&gt;<i>
</I>&gt;<i>Unfortunately there are still some bugs that needs to be straightened
</I>&gt;<i>out upstream for Squid to use the --with-filedescriptors value when
</I>&gt;<i>there is *no* specific upper limit provided by the OS.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>limits when I log in (ssh or console) are 1024(soft) and 1048576 (hard) and
</I>&gt;<i>yet squid starts with 1024 FDs.
</I>&gt;<i>
</I>&gt;<i>I have configured:
</I>&gt;<i>
</I>&gt;<i># cat /etc/systemd/system/squid.service.d/override.conf
</I>&gt;<i>[Service]
</I>&gt;<i>LimitNOFILE=65536
</I>&gt;<i>
</I>&gt;<i>and after reloading systemd:
</I>&gt;<i>
</I>&gt;<i># systemctl daemon-reload
</I>&gt;<i>
</I>&gt;<i>and restart squid it seems to work properly:
</I>&gt;<i>
</I>&gt;<i>2022/08/02 15:52:28 kid1| With 65536 file descriptors available
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>does anyone encounter this bug?
</I>&gt;<i>How do you fix it?
</I>
-- 
Matus UHLAR - fantomas, <A HREF="https://lists.squid-cache.org/listinfo/squid-users">uhlar at fantomas.sk</A> ; <A HREF="http://www.fantomas.sk/">http://www.fantomas.sk/</A>
Warning: I wish NOT to receive e-mail advertising to this address.
Varovanie: na tuto adresu chcem NEDOSTAVAT akukolvek reklamnu postu.
The 3 biggets disasters: Hiroshima 45, Tschernobyl 86, Windows 95

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="025046.html">[squid-users] filedescriptors on debian/systemd
</A></li>
	<LI>Next message (by thread): <A HREF="025058.html">[squid-users] filedescriptors on debian/systemd
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25053">[ date ]</a>
              <a href="thread.html#25053">[ thread ]</a>
              <a href="subject.html#25053">[ subject ]</a>
              <a href="author.html#25053">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
