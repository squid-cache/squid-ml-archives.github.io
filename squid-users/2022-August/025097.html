<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Problem caching range requests with range_offset_limit
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Problem%20caching%20range%20requests%20with%0A%20range_offset_limit&In-Reply-To=%3Cc9ceb26b-cf6c-ea30-ea73-ab774e573351%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="025096.html">
   <LINK REL="Next"  HREF="025111.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Problem caching range requests with range_offset_limit</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Problem%20caching%20range%20requests%20with%0A%20range_offset_limit&In-Reply-To=%3Cc9ceb26b-cf6c-ea30-ea73-ab774e573351%40measurement-factory.com%3E"
       TITLE="[squid-users] Problem caching range requests with range_offset_limit">rousskov at measurement-factory.com
       </A><BR>
    <I>Thu Aug 11 03:06:33 UTC 2022</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="025096.html">[squid-users] Problem caching range requests with range_offset_limit
</A></li>
        <LI>Next message (by thread): <A HREF="025111.html">[squid-users] Problem caching range requests with range_offset_limit
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25097">[ date ]</a>
              <a href="thread.html#25097">[ thread ]</a>
              <a href="subject.html#25097">[ subject ]</a>
              <a href="author.html#25097">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 8/10/22 22:43, osy wrote:
&gt;<i> I am trying to cache Azure objects. I have SSL bump and the following config:
</I>&gt;<i> 
</I>&gt;<i> maximum_object_size 1000 MB
</I>&gt;<i> acl azure_storage dstdomain .blob.core.windows.net
</I>&gt;<i> range_offset_limit -1 azure_storage
</I>&gt;<i> 
</I>&gt;<i> My expectation is that when a request is made with the Range header,
</I>&gt;<i> that Squid will request the object starting from the beginning, return
</I>&gt;<i> the data when it reaches the range, then keep the connection open and
</I>&gt;<i> keep requesting data until the end.
</I>
N.B. In the above &quot;keep the connection&quot; should refer to the 
Squid-to-origin connection, not the user_agent-to-Squid connection.


&gt;<i> However, I observe the last part
</I>&gt;<i> isn't true: the connection to the server is closed after the proxy
</I>&gt;<i> client closes the connection.
</I>&gt;<i> 
</I>&gt;<i> 2022/08/10 18:55:23.152| 5,3| Read.cc(92) ReadNow:
</I>&gt;<i> local=127.0.0.1:3128 remote=127.0.0.1:57075 FD 21 flags=1, size 3644,
</I>&gt;<i> retval 0, errno 0
</I>&gt;<i> 2022/08/10 18:55:23.152| 33,5| Server.cc(147) doClientRead:
</I>&gt;<i> local=127.0.0.1:3128 remote=127.0.0.1:57075 FD 21 flags=1 closed?
</I>&gt;<i> 2022/08/10 18:55:23.152| 33,3| client_side.cc(1418)
</I>&gt;<i> connFinishedWithConn: local=127.0.0.1:3128 remote=127.0.0.1:57075 FD
</I>&gt;<i> 21 flags=1 aborted (half_closed_clients disabled)
</I>&gt;<i> 2022/08/10 18:55:23.152| 33,3| Pipeline.cc(56) terminateAll: Pipeline
</I>&gt;<i> 0x149704e80 notify(0) 0x13a817600*3
</I>&gt;<i> 2022/08/10 18:55:23.152| 90,3| store_client.cc(651) storeUnregister:
</I>&gt;<i> storeUnregister: called for 'F43F6204305C4808C2A393C7CC905C16'
</I>&gt;<i> 2022/08/10 18:55:23.153| 90,3| store_client.cc(764)
</I>&gt;<i> CheckQuickAbortIsReasonable: entry=e:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">d5 at 0</A>=w1p2V/0x6000038f6d80*6
</I>&gt;<i> 2022/08/10 18:55:23.153| 90,3| store_client.cc(755)
</I>&gt;<i> storePendingNClients: storePendingNClients: returning 0
</I>&gt;<i> 2022/08/10 18:55:23.153| 90,3| store_client.cc(788)
</I>&gt;<i> CheckQuickAbortIsReasonable: mem=0x14a14bcb0
</I>&gt;<i> 2022/08/10 18:55:23.153| 90,3| store_client.cc(817)
</I>&gt;<i> CheckQuickAbortIsReasonable: quick-abort? NO admin configured range
</I>&gt;<i> replies to full-download
</I>&gt;<i> 2022/08/10 18:55:23.153| 33,3| Pipeline.cc(69) popMe: Pipeline
</I>&gt;<i> 0x149704e80 drop 0x13a817600*3
</I>&gt;<i> 2022/08/10 18:55:23.153| 33,3| client_side_request.cc(270)
</I>&gt;<i> ~ClientHttpRequest: httpRequestFree: [url here]
</I>
Just to avoid any misunderstanding, the above debugging quote does _not_ 
show the connection to the origin server being closed. There are many 
things called &quot;servers&quot; and &quot;clients&quot; in this context. The &quot;Server.cc&quot; 
above is a Squid task parsing requests from user agents and responding 
with a replies. It is nearly unrelated to the origin server.

The above trace does not necessarily contradict your configuration and 
expectations AFAICT. It shows that the user agent closed the connection 
to Squid, but Squid may have decided to keep going with downloading the 
response from the origin server (&quot;quick-abort? NO&quot;). Something else 
could have gone wrong with that download later (or even earlier), of 
course, but the trace does not show that AFAICT.


HTH,

Alex.



&gt;<i> I also tried setting &quot;half_closed_clients on&quot; but that just defers the
</I>&gt;<i> error to a write later on. Any advice would be appreciated, thanks!
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="025096.html">[squid-users] Problem caching range requests with range_offset_limit
</A></li>
	<LI>Next message (by thread): <A HREF="025111.html">[squid-users] Problem caching range requests with range_offset_limit
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25097">[ date ]</a>
              <a href="thread.html#25097">[ thread ]</a>
              <a href="subject.html#25097">[ subject ]</a>
              <a href="author.html#25097">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
