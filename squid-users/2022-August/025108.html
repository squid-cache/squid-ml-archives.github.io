<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid as Reverse Proxy with Parent Proxy, http inbound and https outbound
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20as%20Reverse%20Proxy%20with%20Parent%20Proxy%2C%0A%20http%20inbound%20and%20https%20outbound&In-Reply-To=%3C000501d8ae23%2480d0b700%2482722500%24%40gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="025107.html">
   <LINK REL="Next"  HREF="025109.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid as Reverse Proxy with Parent Proxy, http inbound and https outbound</H1>
    <B>ngtech1ltd at gmail.com</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20as%20Reverse%20Proxy%20with%20Parent%20Proxy%2C%0A%20http%20inbound%20and%20https%20outbound&In-Reply-To=%3C000501d8ae23%2480d0b700%2482722500%24%40gmail.com%3E"
       TITLE="[squid-users] Squid as Reverse Proxy with Parent Proxy, http inbound and https outbound">ngtech1ltd at gmail.com
       </A><BR>
    <I>Fri Aug 12 08:14:10 UTC 2022</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="025107.html">[squid-users] Squid as Reverse Proxy with Parent Proxy, http inbound and https outbound
</A></li>
        <LI>Next message (by thread): <A HREF="025109.html">[squid-users] Squid as Reverse Proxy with Parent Proxy, http inbound and https outbound
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25108">[ date ]</a>
              <a href="thread.html#25108">[ thread ]</a>
              <a href="subject.html#25108">[ subject ]</a>
              <a href="author.html#25108">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hey Joel,
 
I don&#8217;t know if squid would be able to do what you want/need but I know that nginx can do some part of what you want.
 
Eliezer
 
----
Eliezer Croitoru
NgTech, Tech Support
Mobile: +972-5-28704261
Email: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">ngtech1ltd at gmail.com</A> &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">ngtech1ltd at gmail.com</A>&gt; 
Web: <A HREF="https://ngtech.co.il/">https://ngtech.co.il/</A>
My-Tube: <A HREF="https://tube.ngtech.co.il/">https://tube.ngtech.co.il/</A>
 
From: squid-users &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>&gt; On Behalf Of Joel Howard
Sent: Friday, 12 August 2022 7:28
To: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
Subject: Re: [squid-users] Squid as Reverse Proxy with Parent Proxy, http inbound and https outbound
 
Hey Alex,
 
Thanks for the quick and detailed response! I inherited this service recently - would you recommend upgrading to 5? My configs are fairly simple, so upgrade should be easy.
 
Here's my desired flow - let &quot;reverse&quot; and &quot;parent&quot; represent the IPs of those proxies, and &quot;target&quot; represent the target API hostname.

Application sends GET (POST, PUT, etc) <A HREF="http://reverse/some/path">http://reverse/some/path</A>
(Note: Application doesn't know target, and couldn't reach it if it did.)

Reverse adds headers to the request
Reverse sends the request to <A HREF="https://target/some/path,">https://target/some/path,</A> using parent as a forward proxy.
 
The parent proxy in my test case accepts TCP, although if possible I would like to support parent TLS proxies as well - this reverse proxy is deployed in different environments where the parent proxy may differ.

I set this up outside of a docker and without trying to force ssl. The config below was my first attempt - it works if the reverse proxy has direct internet access, but just hangs otherwise; my understanding is that requests that use the first cache_peer do not use the second to proxy.
 
# Reverse proxy to google.com &lt;<A HREF="http://google.com">http://google.com</A>&gt; 
http_port 80 accel vhost defaultsite=www.google.com &lt;<A HREF="http://www.google.com">http://www.google.com</A>&gt; 
cache_peer google.com &lt;<A HREF="http://google.com">http://google.com</A>&gt;  parent 80 0 no-query originserver forceddomain=www.google.com &lt;<A HREF="http://www.google.com">http://www.google.com</A>&gt;  name=target
request_header_add Joel Joel

# Simplified acl
http_access allow all
cache_peer_access target allow all

# Parent proxy
cache_peer 10.60.4.178 parent 3128 0 no-query default
acl all src 0.0.0.0/0.0.0.0 &lt;<A HREF="http://0.0.0.0/0.0.0.0">http://0.0.0.0/0.0.0.0</A>&gt; 
never_direct allow all

This was my second attempt, using forceddomain to replace the host header but sending the request directly to the parent proxy. This results in the parent receiving GET /, which it does not understand (it expects GET target/somepath).
 
# Reverse proxy directly to forward proxy google.com &lt;<A HREF="http://google.com">http://google.com</A>&gt; 
http_port 80 accel vhost defaultsite=www.google.com &lt;<A HREF="http://www.google.com">http://www.google.com</A>&gt; 
cache_peer 10.60.4.178 parent 3128 0 no-query originserver forceddomain=www.google.com &lt;<A HREF="http://www.google.com">http://www.google.com</A>&gt;  name=parent
request_header_add Joel Joel

# Misc
cache deny all
shutdown_lifetime 1 seconds
 
I suspect this would need a url rewriter to force the url to target - I'm failing to get any of the example rewriters working (maybe due to the old squid version?) so I haven't been able to test that yet. But I suspect it will fail for HTTPS, because the rewritten URL will be sent as GET target/something to the parent proxy, instead of CONNECT target/something - I still think I'm missing something to get my squid to use the forward as a proxy while itself functioning in reverse.
 
I'll rewrite these for squid 5 and try to get URL rewriting working. In the meantime, could you let me know if either of these two general approaches is remotely correct and if so, what I can do to get further with them?

Thanks so much! If you happen to be on StackOverflow, I've asked the question with a bounty there &lt;<A HREF="https://stackoverflow.com/questions/73286678/reverse-proxy-with-http-inbound-https-outbound-and-parent-proxy/73293978?noredirect=1#comment129465312_73293978">https://stackoverflow.com/questions/73286678/reverse-proxy-with-http-inbound-https-outbound-and-parent-proxy/73293978?noredirect=1#comment129465312_73293978</A>&gt;  as well (although less squid-specific).
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20220812/086e038a/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20220812/086e038a/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="025107.html">[squid-users] Squid as Reverse Proxy with Parent Proxy, http inbound and https outbound
</A></li>
	<LI>Next message (by thread): <A HREF="025109.html">[squid-users] Squid as Reverse Proxy with Parent Proxy, http inbound and https outbound
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25108">[ date ]</a>
              <a href="thread.html#25108">[ thread ]</a>
              <a href="subject.html#25108">[ subject ]</a>
              <a href="author.html#25108">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
