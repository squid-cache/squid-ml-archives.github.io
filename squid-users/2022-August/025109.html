<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid as Reverse Proxy with Parent Proxy, http inbound and https outbound
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20as%20Reverse%20Proxy%20with%20Parent%20Proxy%2C%0A%20http%20inbound%20and%20https%20outbound&In-Reply-To=%3C663b73e9-0bef-b58b-3d0e-fdc4beeeb8dd%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="025108.html">
   <LINK REL="Next"  HREF="025110.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid as Reverse Proxy with Parent Proxy, http inbound and https outbound</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20as%20Reverse%20Proxy%20with%20Parent%20Proxy%2C%0A%20http%20inbound%20and%20https%20outbound&In-Reply-To=%3C663b73e9-0bef-b58b-3d0e-fdc4beeeb8dd%40measurement-factory.com%3E"
       TITLE="[squid-users] Squid as Reverse Proxy with Parent Proxy, http inbound and https outbound">rousskov at measurement-factory.com
       </A><BR>
    <I>Fri Aug 12 15:18:32 UTC 2022</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="025108.html">[squid-users] Squid as Reverse Proxy with Parent Proxy, http inbound and https outbound
</A></li>
        <LI>Next message (by thread): <A HREF="025110.html">[squid-users] Squid as Reverse Proxy with Parent Proxy, http inbound and https outbound
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25109">[ date ]</a>
              <a href="thread.html#25109">[ thread ]</a>
              <a href="subject.html#25109">[ subject ]</a>
              <a href="author.html#25109">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 8/12/22 00:28, Joel Howard wrote:

&gt;<i> Thanks for the quick and detailed response! I inherited this service 
</I>&gt;<i> recently - would you recommend upgrading to 5? My configs are fairly 
</I>&gt;<i> simple, so upgrade&#160;should be easy.
</I>
I recommend not using v3. I do not have enough information about your 
environment to _recommend_ a specific version to upgrade to. By default, 
you should be upgrading to v5.


&gt;<i> Here's my desired flow - let &quot;reverse&quot; and &quot;parent&quot; represent the IPs of 
</I>&gt;<i> those proxies, and &quot;target&quot; represent the target API hostname.
</I>&gt;<i> 
</I>&gt;<i> Application sends GET (POST, PUT, etc) <A HREF="http://reverse/some/path">http://reverse/some/path</A> 
</I>
Nitpick: That is not exactly what the application sends if reverse is a 
reverse proxy. The application will send &quot;GET /some/path&quot; (with 
&quot;reverse&quot; in the Host header).


&gt;<i> Reverse adds headers to the request
</I>&gt;<i> Reverse sends the request to <A HREF="https://target/some/path">https://target/some/path</A> 
</I>&gt;<i> using&#160;parent as a forward proxy.
</I>
I am not sure, but I suspect you will need a URL rewriter to change the 
URL scheme from &quot;http&quot; to &quot;https&quot;.

&gt;<i> I set this up outside of a docker and without trying to force ssl. The 
</I>&gt;<i> config below was my first attempt
</I>
Why are there suddenly two cache_peers in your configuration? Can you 
simplify, at least for now, and have just one?

And why are there no [parent] proxies in your configuration? If you want 
Squid to use a parent proxy, then you need a cache_peer option _without_ 
the originserver flag. That flag coverts Squid treatment of an HTTP 
agent at the specified cache_peer address from a [forward] proxy [that 
you want] to an origin server.

I would start with the following sketch:

     http_port 80 accel
     cache_peer 10.60.4.178 parent 3128 0 no-query no-digest
     http_access ...

And then, after the above is adjusted and working as expected, add 
request URL rewriting to try to change the URL scheme to https.

HTH,

Alex.


&gt;<i> # Reverse proxy to google.com &lt;<A HREF="http://google.com">http://google.com</A>&gt;
</I>&gt;<i> http_port 80 accel vhost defaultsite=www.google.com &lt;<A HREF="http://www.google.com">http://www.google.com</A>&gt;
</I>&gt;<i> cache_peer google.com &lt;<A HREF="http://google.com">http://google.com</A>&gt; parent 80 0 no-query 
</I>&gt;<i> originserver forceddomain=www.google.com &lt;<A HREF="http://www.google.com">http://www.google.com</A>&gt; name=target
</I>&gt;<i> request_header_add Joel Joel
</I>&gt;<i> 
</I>&gt;<i> # Simplified acl
</I>&gt;<i> http_access allow all
</I>&gt;<i> cache_peer_access target allow all
</I>&gt;<i> 
</I>&gt;<i> # Parent proxy
</I>&gt;<i> cache_peer 10.60.4.178 parent 3128 0 no-query default
</I>&gt;<i> acl all src 0.0.0.0/0.0.0.0 &lt;<A HREF="http://0.0.0.0/0.0.0.0">http://0.0.0.0/0.0.0.0</A>&gt;
</I>&gt;<i> never_direct allow all
</I>&gt;<i> 
</I>&gt;<i> This was my second attempt, using forceddomain to replace the host 
</I>&gt;<i> header but sending the request directly to the parent proxy. This 
</I>&gt;<i> results in the parent receiving GET /, which it does not understand (it 
</I>&gt;<i> expects GET target/somepath).
</I>&gt;<i> 
</I>&gt;<i> # Reverse proxy directly to forward proxy google.com &lt;<A HREF="http://google.com">http://google.com</A>&gt;
</I>&gt;<i> http_port 80 accel vhost defaultsite=www.google.com &lt;<A HREF="http://www.google.com">http://www.google.com</A>&gt;
</I>&gt;<i> cache_peer 10.60.4.178 parent 3128 0 no-query originserver 
</I>&gt;<i> forceddomain=www.google.com &lt;<A HREF="http://www.google.com">http://www.google.com</A>&gt; name=parent
</I>&gt;<i> request_header_add Joel Joel
</I>&gt;<i> 
</I>&gt;<i> # Misc
</I>&gt;<i> cache deny all
</I>&gt;<i> shutdown_lifetime 1 seconds
</I>&gt;<i> 
</I>&gt;<i> I suspect this would need a url rewriter to force the url to target - 
</I>&gt;<i> I'm failing to get any of the example rewriters working (maybe due to 
</I>&gt;<i> the old squid version?) so I haven't been able to test that yet. But I 
</I>&gt;<i> suspect it will fail for HTTPS, because the rewritten URL will be sent 
</I>&gt;<i> as GET target/something to the parent proxy, instead of CONNECT 
</I>&gt;<i> target/something - I still think I'm missing something to get my squid 
</I>&gt;<i> to use the forward /as a proxy/&#160;while itself functioning in reverse.
</I>&gt;<i> 
</I>&gt;<i> I'll rewrite these for squid 5 and try to get URL rewriting working. In 
</I>&gt;<i> the meantime, could you let me know if either of these two general 
</I>&gt;<i> approaches is remotely correct and if so, what I can do to get further 
</I>&gt;<i> with them?
</I>&gt;<i> 
</I>&gt;<i> Thanks so much! If you happen to be on StackOverflow, I've asked the 
</I>&gt;<i> question with a bounty there 
</I>&gt;<i> &lt;<A HREF="https://stackoverflow.com/questions/73286678/reverse-proxy-with-http-inbound-https-outbound-and-parent-proxy/73293978?noredirect=1#comment129465312_73293978">https://stackoverflow.com/questions/73286678/reverse-proxy-with-http-inbound-https-outbound-and-parent-proxy/73293978?noredirect=1#comment129465312_73293978</A>&gt; 
</I>&gt;<i> as well (although less squid-specific).
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="025108.html">[squid-users] Squid as Reverse Proxy with Parent Proxy, http inbound and https outbound
</A></li>
	<LI>Next message (by thread): <A HREF="025110.html">[squid-users] Squid as Reverse Proxy with Parent Proxy, http inbound and https outbound
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25109">[ date ]</a>
              <a href="thread.html#25109">[ thread ]</a>
              <a href="subject.html#25109">[ subject ]</a>
              <a href="author.html#25109">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
