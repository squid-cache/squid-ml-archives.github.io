<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] forwarding TPROXY squid and multi-ISP
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20forwarding%20TPROXY%20squid%20and%20multi-ISP&In-Reply-To=%3C1748202460.2345291.1660636327635%40mail.yahoo.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="025130.html">
   <LINK REL="Next"  HREF="025126.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] forwarding TPROXY squid and multi-ISP</H1>
    <B>Vieri</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20forwarding%20TPROXY%20squid%20and%20multi-ISP&In-Reply-To=%3C1748202460.2345291.1660636327635%40mail.yahoo.com%3E"
       TITLE="[squid-users] forwarding TPROXY squid and multi-ISP">rentorbuy at yahoo.com
       </A><BR>
    <I>Tue Aug 16 07:52:07 UTC 2022</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="025130.html">[squid-users] Anyone able to sell me some squid consulting? (advanced routing+cache peering)
</A></li>
        <LI>Next message (by thread): <A HREF="025126.html">[squid-users] forwarding TPROXY squid and multi-ISP
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25117">[ date ]</a>
              <a href="thread.html#25117">[ thread ]</a>
              <a href="subject.html#25117">[ subject ]</a>
              <a href="author.html#25117">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

I'm using squid as a forward transparent proxy with something like this:

https_port 3130 tproxy ssl-bump [etc.]

The Squid service is running on a Linux FW which is the LAN's default gateway.
The host uses TPROXY such as:

25873 5262K TPROXY&#160;&#160;&#160;&#160; tcp&#160; --&#160; *&#160;&#160;&#160;&#160;&#160; *&#160;&#160;&#160;&#160;&#160;&#160; 0.0.0.0/0&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; 0.0.0.0/0&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; TPROXY redirect 0.0.0.0:3130 mark 0x200/0x200

This router has multiple physical and logical interfaces with a default route via 172.16.0.2. The latter IP address is assigned to another Linux host acting as gateway to Internet.

Now, the Squid firewalling router also has a network interface connected to a different Internet provider (say, ISP2). Some LAN hosts are required to use that provider instead of the Internet gateway I mentioned before (via 172.16.0.2).
If I do NOT apply TPROXY to these hosts (ie. if they by-pass squid) then they can access the alternate WAN provider after I apply some simple routing rules (eg. &quot;from HOST_IP_ADDR lookup ISP2&quot;).
The rest of the hosts with TPROXIED traffic through Squid can also correctly access Internet via 172.16.0.2.

The only scenario that's failing is if I want to force LAN traffic through Squid for those hosts that need to access Internet via ISP2.
I'm guessing that it may be because the Squid process is fetching data via 172.16.0.2 *always*.

How can I fix this? What are my options?
Is it possible to properly configure the same Squid system for this, or is it necessary to set up another Squid system via ISP2?

Regards

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="025130.html">[squid-users] Anyone able to sell me some squid consulting? (advanced routing+cache peering)
</A></li>
	<LI>Next message (by thread): <A HREF="025126.html">[squid-users] forwarding TPROXY squid and multi-ISP
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25117">[ date ]</a>
              <a href="thread.html#25117">[ thread ]</a>
              <a href="subject.html#25117">[ subject ]</a>
              <a href="author.html#25117">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
