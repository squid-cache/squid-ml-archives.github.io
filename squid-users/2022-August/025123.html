<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid 4.8+ intercept
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%204.8%2B%20intercept&In-Reply-To=%3CCAFMSmTua4_eQ4iyY-zwCSkqYk%2BE1Rjd0CtzvxYi7vP_ty%3DpQAg%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="025113.html">
   <LINK REL="Next"  HREF="025124.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid 4.8+ intercept</H1>
    <B>M K</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%204.8%2B%20intercept&In-Reply-To=%3CCAFMSmTua4_eQ4iyY-zwCSkqYk%2BE1Rjd0CtzvxYi7vP_ty%3DpQAg%40mail.gmail.com%3E"
       TITLE="[squid-users] Squid 4.8+ intercept">mohammed.khallaf at gmail.com
       </A><BR>
    <I>Thu Aug 18 03:20:09 UTC 2022</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="025113.html">[squid-users] Squid 4.8+ intercept
</A></li>
        <LI>Next message (by thread): <A HREF="025124.html">[squid-users] Squid 4.8+ intercept
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25123">[ date ]</a>
              <a href="thread.html#25123">[ thread ]</a>
              <a href="subject.html#25123">[ subject ]</a>
              <a href="author.html#25123">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello Eliezer,

I finally got my setup to work; turned out to be intercepted clients
running into default nat, while my test squid server did not allow
them access, not even through iptables!

Now, I have one last bit to handle, which you did not cover in your
video. I'm using 3 ports for squid like Rafael's guide: one for normal
CONNECT, one for intercepted plain HTTP on 80, and one for intercepted
HTTPs on 443.

The setup works awesome for TLS addresses (i.e <A HREF="https://">https://</A>), but browser
redirection from Plain to TLS, say from <A HREF="http://cnn.com">http://cnn.com</A> to
<A HREF="https://cnn.com,">https://cnn.com,</A> fails to happen. It just waits then time out.
What could be done to make it happen?

All best,
K


On Sat, Aug 13, 2022 at 7:57 PM &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">ngtech1ltd at gmail.com</A>&gt; wrote:
&gt;<i>
</I>&gt;<i> Hey K,
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> What RouterOS version are you using?
</I>&gt;<i>
</I>&gt;<i> Also, what rules have you applied?
</I>&gt;<i>
</I>&gt;<i> If there is a very long delay and then a failure you should verify that the rules you wrote are proper to your environment.
</I>&gt;<i>
</I>&gt;<i> You should route packets based on connection marks and mark only new connections from LAN IP addresses and only on the LAN interface.
</I>&gt;<i>
</I>&gt;<i> As I showed in the demo video it&#8217;s very simple to implement.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Let me know if you are still having issues.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Eliezer
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> ----
</I>&gt;<i>
</I>&gt;<i> Eliezer Croitoru
</I>&gt;<i>
</I>&gt;<i> NgTech, Tech Support
</I>&gt;<i>
</I>&gt;<i> Mobile: +972-5-28704261
</I>&gt;<i>
</I>&gt;<i> Email: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">ngtech1ltd at gmail.com</A>
</I>&gt;<i>
</I>&gt;<i> Web: <A HREF="https://ngtech.co.il/">https://ngtech.co.il/</A>
</I>&gt;<i>
</I>&gt;<i> My-Tube: <A HREF="https://tube.ngtech.co.il/">https://tube.ngtech.co.il/</A>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> From: M K &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">mohammed.khallaf at gmail.com</A>&gt;
</I>&gt;<i> Sent: Saturday, 13 August 2022 10:59
</I>&gt;<i> To: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">ngtech1ltd at gmail.com</A>
</I>&gt;<i> Cc: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> Subject: Re: [squid-users] Squid 4.8+ intercept
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Thank  you for your quick reply. The text-drawing actually changed with different font; the squid server is effectively connected to MikroTik router, not the same physical link as the client.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> The MikroTik router sits between the client and squid server.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> That said, I can confirm that the MikroTik router is effectively able to route/DNat client packets going to ports 80 and 443 to squid server. Depending on router rules be it route or dnat, the client browser effectively displays the error page of squid, or goes into a very long delay then failure.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> I will retry and let you know.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> K
</I>&gt;<i>
</I>&gt;<i> On Wed, Aug 10, 2022, 10:08 &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">ngtech1ltd at gmail.com</A>&gt; wrote:
</I>&gt;<i>
</I>&gt;<i> Hey K,
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> I am not sure about the network topology.
</I>&gt;<i>
</I>&gt;<i> Preferably the Squid should reside on another network then the clients if it&#8217;s intercepting the traffic.
</I>&gt;<i>
</I>&gt;<i> Also, I assume it&#8217;s not a TPROXY setup so it should be pretty simple and straight forward.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> I understand why are you asking this question.
</I>&gt;<i>
</I>&gt;<i> Also take into account that Mikrotik is now on 7.4 firmware and it&#8217;s recommended to use this one.
</I>&gt;<i>
</I>&gt;<i> If you are using any other version let me know so I can try to make sense on the differences.
</I>&gt;<i>
</I>&gt;<i> I will try to give a DEMO for such a setup and how to make it work.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Eliezer
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> ----
</I>&gt;<i>
</I>&gt;<i> Eliezer Croitoru
</I>&gt;<i>
</I>&gt;<i> NgTech, Tech Support
</I>&gt;<i>
</I>&gt;<i> Mobile: +972-5-28704261
</I>&gt;<i>
</I>&gt;<i> Email: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">ngtech1ltd at gmail.com</A>
</I>&gt;<i>
</I>&gt;<i> Web: <A HREF="https://ngtech.co.il/">https://ngtech.co.il/</A>
</I>&gt;<i>
</I>&gt;<i> My-Tube: <A HREF="https://tube.ngtech.co.il/">https://tube.ngtech.co.il/</A>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> From: squid-users &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>&gt; On Behalf Of M K
</I>&gt;<i> Sent: Tuesday, 9 August 2022 22:29
</I>&gt;<i> To: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> Subject: [squid-users] Squid 4.8+ intercept
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Hello,
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> I have a setup like this one:
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> | Client | =====&gt; | Router | =====&gt; Internet
</I>&gt;<i>                      ||
</I>&gt;<i>                      \/
</I>&gt;<i>                   | Squid |
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> ...the router is a Mikrotik router capable of all things NAT/Redirect and whatnot. Squid server has only one network interface.
</I>&gt;<i>
</I>&gt;<i> Using the router:
</I>&gt;<i>
</I>&gt;<i> - I tried routing traffic to squid server IP.
</I>&gt;<i>
</I>&gt;<i> - I tried destination-NATing from client to server IP, with origin server IP-and-port natted to squid IP-and-port, and with origin server IP-only natted to squid-IP.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> I have been struggling for 2 days to setup a working Squid 4.8 or higher interception.
</I>&gt;<i>
</I>&gt;<i> Test server is running Ubuntu 18.4.3 and Squid 4.8.
</I>&gt;<i>
</I>&gt;<i> Documentation is either too much trim or extremely outdated.
</I>&gt;<i>
</I>&gt;<i> Any help would be very much appreciated.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> All best,
</I>&gt;<i>
</I>&gt;<i> K
</I>
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="025113.html">[squid-users] Squid 4.8+ intercept
</A></li>
	<LI>Next message (by thread): <A HREF="025124.html">[squid-users] Squid 4.8+ intercept
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25123">[ date ]</a>
              <a href="thread.html#25123">[ thread ]</a>
              <a href="subject.html#25123">[ subject ]</a>
              <a href="author.html#25123">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
