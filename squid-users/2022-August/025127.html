<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Capture incoming information from one squid
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Capture%20incoming%20information%20from%20one%20squid&In-Reply-To=%3C003001d8b422%245da0d9e0%2418e28da0%24%40graminsta.com.br%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="025120.html">
   <LINK REL="Next"  HREF="025128.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Capture incoming information from one squid</H1>
    <B>Marcelo</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Capture%20incoming%20information%20from%20one%20squid&In-Reply-To=%3C003001d8b422%245da0d9e0%2418e28da0%24%40graminsta.com.br%3E"
       TITLE="[squid-users] Capture incoming information from one squid">marcelorodrigo at graminsta.com.br
       </A><BR>
    <I>Fri Aug 19 23:20:56 UTC 2022</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="025120.html">[squid-users] Forward proxy with certificates
</A></li>
        <LI>Next message (by thread): <A HREF="025128.html">[squid-users] Capture incoming information from one squid
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25127">[ date ]</a>
              <a href="thread.html#25127">[ thread ]</a>
              <a href="subject.html#25127">[ subject ]</a>
              <a href="author.html#25127">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Thanks Alex,

1- Is it possible to provide me with an example of squid.conf of both parent
and child squids?

I am having very basic doubts about cache_peer and its very hard to find
complete squid.confs over the internet.

2- cache-peer really routes the connection to the second squid server or
just look for a hit in a second server's cache?
I need the second server to not just authenticate the user, but to know from
which port the user got in the first squid server in order to forward this
user through different routes based on this incoming port number.

I want to use the first squid, just as a dst.domain filter for it to decide
based on the dst.domain list, if the user will be forward to a local route,
or if this user are going to be sent to the second squid server, which,
based on the original incoming port, can decide through which
tcp_outgoing_address he will going out.

Thanks for all the helping.

Marcelo.




On 8/15/22 21:49, Marcelo wrote:

&gt;<i> How can I transfer connection information from one squid server to
</I>another?

Use cache_peer login=PASSTHRU or login=PASS. Other login=... options may
also be of interest. See cache_peer documentation in your
squid.conf.documented for details and caveats.


HTH,


Alex.


&gt;<i> Example:
</I>&gt;<i> 
</I>&gt;<i> An user connects to Squid One (Squid One IP 192.1.1.1) through port 
</I>&gt;<i> 4000 using usr/pw credentials.
</I>&gt;<i> 
</I>&gt;<i> Squid One authenticates it via SQL DB. This part is already working fine.
</I>&gt;<i> 
</I>&gt;<i> Squid One verifies if destination website is in dst domain list.
</I>&gt;<i> 
</I>&gt;<i> If yes Squid One routes it to Route A. End of story.
</I>&gt;<i> 
</I>&gt;<i> If no Squid One routes it to Squid Two.
</I>&gt;<i> 
</I>&gt;<i> But Squid One must inform Squid Two who is the user and witch port he 
</I>&gt;<i> asked to connect.
</I>&gt;<i> 
</I>&gt;<i> Why? Because Squid Two must use this info as if the user itself is 
</I>&gt;<i> connecting to Squid Two.
</I>&gt;<i> Why, again? Because Squid Two will use this info to route this user to 
</I>&gt;<i> the correct route. This part is also done.
</I>&gt;<i> 
</I>&gt;<i> My doubt is, is there a way to make Squid Two ?thinks? that user is 
</I>&gt;<i> connecting direct to Squid Two, so that, Squid Two can use user/port 
</I>&gt;<i> information to route this poor little guy.
</I>&gt;<i> 
</I>&gt;<i> It?s a bit hard to explain it through email.
</I>&gt;<i> 
</I>&gt;<i> Best Regards.
</I>&gt;<i> 
</I>&gt;<i> Marcelo.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>


------------------------------

Message: 5
Date: Thu, 18 Aug 2022 05:08:35 +0200
From: M K &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">mohammed.khallaf at gmail.com</A>&gt;
To: Rafael Akchurin &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rafael.akchurin at diladele.com</A>&gt;
Cc: &quot;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>&quot;
	&lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>&gt;
Subject: Re: [squid-users] Squid 4.8+ intercept
Message-ID:
	&lt;CAFMSmTvypP-Z+iiZiO=<A HREF="https://lists.squid-cache.org/listinfo/squid-users">0CEB68d0sMn6f9FkmKNtsHxPg-EdfVw at mail.gmail.com</A>&gt;
Content-Type: text/plain; charset=&quot;UTF-8&quot;

Hello Rafael,

Thank you for your reply. The key problem in my case is that I'm using a
complex NAT/Mangle setup, with too many decisions to be made. When I finally
succeeded, I was able to pin-point the glitch in my setup:
&quot;Ensure NAT Rule is Applied to WAN Interface Only&quot; in your excellent guide.

Since I'm unable to do that in my setup, I used a better and more safe
approach: just create a nat rule that will ACCEPT traffic from intercepted
clients with no further action, and place it well enough higher in the nat
rule-chain so it basically skips regular nat.

Thank you for the excellent guide.

All best,
K


On Tue, Aug 9, 2022 at 10:54 PM Rafael Akchurin
&lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rafael.akchurin at diladele.com</A>&gt; wrote:
&gt;<i>
</I>&gt;<i> Hello K,
</I>&gt;<i>
</I>&gt;<i> We use 
</I>&gt;<i> <A HREF="https://docs.diladele.com/tutorials/mikrotik_transparent_squid/index.h">https://docs.diladele.com/tutorials/mikrotik_transparent_squid/index.h</A>
</I>&gt;<i> tml
</I>&gt;<i>
</I>&gt;<i> Best regards,
</I>&gt;<i> Rafael
</I>&gt;<i>
</I>&gt;<i> Op 9 aug. 2022 om 21:29 heeft M K &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">mohammed.khallaf at gmail.com</A>&gt; het
</I>volgende geschreven:
&gt;<i>
</I>&gt;<i> ?
</I>&gt;<i> Hello,
</I>&gt;<i>
</I>&gt;<i> I have a setup like this one:
</I>&gt;<i>
</I>&gt;<i> | Client | =====&gt; | Router | =====&gt; Internet
</I>&gt;<i>                      ||
</I>&gt;<i>                      \/
</I>&gt;<i>                   | Squid |
</I>&gt;<i>
</I>&gt;<i> ...the router is a Mikrotik router capable of all things NAT/Redirect and
</I>whatnot. Squid server has only one network interface.
&gt;<i> Using the router:
</I>&gt;<i> - I tried routing traffic to squid server IP.
</I>&gt;<i> - I tried destination-NATing from client to server IP, with origin server
</I>IP-and-port natted to squid IP-and-port, and with origin server IP-only
natted to squid-IP.
&gt;<i>
</I>&gt;<i> I have been struggling for 2 days to setup a working Squid 4.8 or higher
</I>interception.
&gt;<i> Test server is running Ubuntu 18.4.3 and Squid 4.8.
</I>&gt;<i> Documentation is either too much trim or extremely outdated.
</I>&gt;<i> Any help would be very much appreciated.
</I>&gt;<i>
</I>&gt;<i> All best,
</I>&gt;<i> K
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>

------------------------------

Message: 6
Date: Thu, 18 Aug 2022 05:20:09 +0200
From: M K &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">mohammed.khallaf at gmail.com</A>&gt;
To: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">ngtech1ltd at gmail.com</A>
Cc: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>,  Rafael Akchurin
	&lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rafael.akchurin at diladele.com</A>&gt;
Subject: Re: [squid-users] Squid 4.8+ intercept
Message-ID:
	&lt;CAFMSmTua4_eQ4iyY-zwCSkqYk+E1Rjd0CtzvxYi7vP_ty=<A HREF="https://lists.squid-cache.org/listinfo/squid-users">pQAg at mail.gmail.com</A>&gt;
Content-Type: text/plain; charset=&quot;UTF-8&quot;

Hello Eliezer,

I finally got my setup to work; turned out to be intercepted clients running
into default nat, while my test squid server did not allow them access, not
even through iptables!

Now, I have one last bit to handle, which you did not cover in your video.
I'm using 3 ports for squid like Rafael's guide: one for normal CONNECT, one
for intercepted plain HTTP on 80, and one for intercepted HTTPs on 443.

The setup works awesome for TLS addresses (i.e <A HREF="https://">https://</A>), but browser
redirection from Plain to TLS, say from <A HREF="http://cnn.com">http://cnn.com</A> to <A HREF="https://cnn.com,">https://cnn.com,</A>
fails to happen. It just waits then time out.
What could be done to make it happen?

All best,
K


On Sat, Aug 13, 2022 at 7:57 PM &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">ngtech1ltd at gmail.com</A>&gt; wrote:
&gt;<i>
</I>&gt;<i> Hey K,
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> What RouterOS version are you using?
</I>&gt;<i>
</I>&gt;<i> Also, what rules have you applied?
</I>&gt;<i>
</I>&gt;<i> If there is a very long delay and then a failure you should verify that
</I>the rules you wrote are proper to your environment.
&gt;<i>
</I>&gt;<i> You should route packets based on connection marks and mark only new
</I>connections from LAN IP addresses and only on the LAN interface.
&gt;<i>
</I>&gt;<i> As I showed in the demo video it?s very simple to implement.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Let me know if you are still having issues.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Eliezer
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> ----
</I>&gt;<i>
</I>&gt;<i> Eliezer Croitoru
</I>&gt;<i>
</I>&gt;<i> NgTech, Tech Support
</I>&gt;<i>
</I>&gt;<i> Mobile: +972-5-28704261
</I>&gt;<i>
</I>&gt;<i> Email: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">ngtech1ltd at gmail.com</A>
</I>&gt;<i>
</I>&gt;<i> Web: <A HREF="https://ngtech.co.il/">https://ngtech.co.il/</A>
</I>&gt;<i>
</I>&gt;<i> My-Tube: <A HREF="https://tube.ngtech.co.il/">https://tube.ngtech.co.il/</A>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> From: M K &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">mohammed.khallaf at gmail.com</A>&gt;
</I>&gt;<i> Sent: Saturday, 13 August 2022 10:59
</I>&gt;<i> To: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">ngtech1ltd at gmail.com</A>
</I>&gt;<i> Cc: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> Subject: Re: [squid-users] Squid 4.8+ intercept
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Thank  you for your quick reply. The text-drawing actually changed with
</I>different font; the squid server is effectively connected to MikroTik
router, not the same physical link as the client.
&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> The MikroTik router sits between the client and squid server.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> That said, I can confirm that the MikroTik router is effectively able to
</I>route/DNat client packets going to ports 80 and 443 to squid server.
Depending on router rules be it route or dnat, the client browser
effectively displays the error page of squid, or goes into a very long delay
then failure.
&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> I will retry and let you know.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> K
</I>&gt;<i>
</I>&gt;<i> On Wed, Aug 10, 2022, 10:08 &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">ngtech1ltd at gmail.com</A>&gt; wrote:
</I>&gt;<i>
</I>&gt;<i> Hey K,
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> I am not sure about the network topology.
</I>&gt;<i>
</I>&gt;<i> Preferably the Squid should reside on another network then the clients if
</I>it?s intercepting the traffic.
&gt;<i>
</I>&gt;<i> Also, I assume it?s not a TPROXY setup so it should be pretty simple and
</I>straight forward.
&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> I understand why are you asking this question.
</I>&gt;<i>
</I>&gt;<i> Also take into account that Mikrotik is now on 7.4 firmware and it?s
</I>recommended to use this one.
&gt;<i>
</I>&gt;<i> If you are using any other version let me know so I can try to make sense
</I>on the differences.
&gt;<i>
</I>&gt;<i> I will try to give a DEMO for such a setup and how to make it work.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Eliezer
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> ----
</I>&gt;<i>
</I>&gt;<i> Eliezer Croitoru
</I>&gt;<i>
</I>&gt;<i> NgTech, Tech Support
</I>&gt;<i>
</I>&gt;<i> Mobile: +972-5-28704261
</I>&gt;<i>
</I>&gt;<i> Email: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">ngtech1ltd at gmail.com</A>
</I>&gt;<i>
</I>&gt;<i> Web: <A HREF="https://ngtech.co.il/">https://ngtech.co.il/</A>
</I>&gt;<i>
</I>&gt;<i> My-Tube: <A HREF="https://tube.ngtech.co.il/">https://tube.ngtech.co.il/</A>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> From: squid-users &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>&gt; On 
</I>&gt;<i> Behalf Of M K
</I>&gt;<i> Sent: Tuesday, 9 August 2022 22:29
</I>&gt;<i> To: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> Subject: [squid-users] Squid 4.8+ intercept
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Hello,
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> I have a setup like this one:
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> | Client | =====&gt; | Router | =====&gt; Internet
</I>&gt;<i>                      ||
</I>&gt;<i>                      \/
</I>&gt;<i>                   | Squid |
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> ...the router is a Mikrotik router capable of all things NAT/Redirect and
</I>whatnot. Squid server has only one network interface.
&gt;<i>
</I>&gt;<i> Using the router:
</I>&gt;<i>
</I>&gt;<i> - I tried routing traffic to squid server IP.
</I>&gt;<i>
</I>&gt;<i> - I tried destination-NATing from client to server IP, with origin server
</I>IP-and-port natted to squid IP-and-port, and with origin server IP-only
natted to squid-IP.
&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> I have been struggling for 2 days to setup a working Squid 4.8 or higher
</I>interception.
&gt;<i>
</I>&gt;<i> Test server is running Ubuntu 18.4.3 and Squid 4.8.
</I>&gt;<i>
</I>&gt;<i> Documentation is either too much trim or extremely outdated.
</I>&gt;<i>
</I>&gt;<i> Any help would be very much appreciated.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> All best,
</I>&gt;<i>
</I>&gt;<i> K
</I>

------------------------------

Subject: Digest Footer

_______________________________________________
squid-users mailing list
<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
<A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>


------------------------------

End of squid-users Digest, Vol 96, Issue 35
*******************************************


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="025120.html">[squid-users] Forward proxy with certificates
</A></li>
	<LI>Next message (by thread): <A HREF="025128.html">[squid-users] Capture incoming information from one squid
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25127">[ date ]</a>
              <a href="thread.html#25127">[ thread ]</a>
              <a href="subject.html#25127">[ subject ]</a>
              <a href="author.html#25127">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
