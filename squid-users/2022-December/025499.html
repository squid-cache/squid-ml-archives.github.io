<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Setting header with external auth helper error message
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Setting%20header%20with%20external%20auth%20helper%20error%0A%20message&In-Reply-To=%3C21f9e58a-e7dc-7e72-bfc1-bed5c5f59a00%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="025498.html">
   <LINK REL="Next"  HREF="025500.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Setting header with external auth helper error message</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Setting%20header%20with%20external%20auth%20helper%20error%0A%20message&In-Reply-To=%3C21f9e58a-e7dc-7e72-bfc1-bed5c5f59a00%40measurement-factory.com%3E"
       TITLE="[squid-users] Setting header with external auth helper error message">rousskov at measurement-factory.com
       </A><BR>
    <I>Tue Dec  6 14:33:44 UTC 2022</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="025498.html">[squid-users] Setting header with external auth helper error message
</A></li>
        <LI>Next message (by thread): <A HREF="025500.html">[squid-users] No buffer space available
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25499">[ date ]</a>
              <a href="thread.html#25499">[ thread ]</a>
              <a href="subject.html#25499">[ subject ]</a>
              <a href="author.html#25499">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 12/6/22 08:54, Irem Kuyucu wrote:

&gt;<i> I'm trying to get Squid (4.9) to reply to the client with a custom
</I>&gt;<i> header which contains the error message returned from the external
</I>&gt;<i> auth helper binary.
</I>&gt;<i> 
</I>&gt;<i> For example, I'd like Squid to reply with a header like this:
</I>&gt;<i> X-Custom-Err: ERR NO_BACKEND
</I>&gt;<i> or
</I>&gt;<i> X-Custom-Err: NO_BACKEND
</I>&gt;<i> Where &quot;ERR NO_BACKEND&quot; is a response gathered from the auth helper.
</I>&gt;<i> 
</I>&gt;<i> I've tried setting this in squid.conf, this way I can see the header
</I>&gt;<i> however its value is always '-':
</I>&gt;<i> 
</I>&gt;<i> reply_header_add X-Custom-Err &quot;%err_detail&quot;
</I>&gt;<i> 
</I>&gt;<i> I also tried to define a custom error by modifying squid.conf and
</I>&gt;<i> error-details.txt. That also didn't work, the value is always set to
</I>&gt;<i> '-'.
</I>&gt;<i> /etc/squid.conf:
</I>&gt;<i> 
</I>&gt;<i> error_directory /etc/squid/error_directory/
</I>&gt;<i> deny_info CUSTOM_ERR_ACCESS_DENIED custom-auth
</I>&gt;<i> reply_header_add X-Custom-Err &quot;%err_detail&quot;
</I>&gt;<i> 
</I>&gt;<i> /etc/squid/error_directory/error-details.txt:
</I>&gt;<i> 
</I>&gt;<i> name: CUSTOM_ERR_ACCESS_DENIED
</I>&gt;<i> detail: &quot;%m&quot;
</I>&gt;<i> descr: &quot;Access denied&quot;
</I>&gt;<i> 
</I>&gt;<i> &quot;%m&quot; is the error message returned by external auth helper according
</I>&gt;<i> to <A HREF="https://wiki.squid-cache.org/Features/CustomErrors#ERR_.2A_template_codes_for_embedding">https://wiki.squid-cache.org/Features/CustomErrors#ERR_.2A_template_codes_for_embedding</A>
</I>&gt;<i> I also tried to log &quot;%err_code %err_detail %et %ea&quot; but all of these
</I>&gt;<i> values except err_code are logged as '-'.
</I>
&gt;<i> Does anyone know how to do this or if this is possible to do in the first place?
</I>

1. Upgrade to the latest Squid v4 (at least). There are Squid v4.9 bugs 
that may prevent the advice below from working correctly. One of them 
was fixed in v4.11, but there may be others. Consider upgrading to Squid 
v5.7 or later. I hope my response covers the latest Squid v4, but I do 
not remember any v4-specific caveats.


2. Make sure your helper is sending the right annotation to Squid as a 
custom name=value pair in each helper response. Always end your custom 
helper annotation names with an underscore to avoid conflicts with Squid 
internal annotations, current and future. See [1] for format details. 
[1] <A HREF="https://wiki.squid-cache.org/Features/AddonHelpers#Authenticator">https://wiki.squid-cache.org/Features/AddonHelpers#Authenticator</A>


3. Use reply_header_add with the corresponding %note logformat code
(let's assume that you called your custom annotation &quot;myerror_&quot;):

     reply_header_add X-Custom-Err &quot;%note{myerror_}&quot;


4. Please note that helper results may be cached. If your helper is not 
contacted for a given transaction (due to a helper cache hit or some 
other reason), then you may get no annotation or a stale annotation. If 
your annotation is not specific to authentication, you may want to use 
an external ACL helper to set it (and disable caching of that helper 
results with &quot;external_acl_type ... cache=0&quot; or similar, as needed).

N.B. %err_code and %err_detail logformat code are for reporting 
Squid-discovered errors, not custom annotations.


HTH,

Alex.


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="025498.html">[squid-users] Setting header with external auth helper error message
</A></li>
	<LI>Next message (by thread): <A HREF="025500.html">[squid-users] No buffer space available
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25499">[ date ]</a>
              <a href="thread.html#25499">[ thread ]</a>
              <a href="subject.html#25499">[ subject ]</a>
              <a href="author.html#25499">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
