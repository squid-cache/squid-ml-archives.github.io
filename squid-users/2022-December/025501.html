<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] No buffer space available
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20No%20buffer%20space%20available&In-Reply-To=%3C2ad03f14-20d9-a9de-8743-7ab1dc30b820%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="025500.html">
   <LINK REL="Next"  HREF="025502.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] No buffer space available</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20No%20buffer%20space%20available&In-Reply-To=%3C2ad03f14-20d9-a9de-8743-7ab1dc30b820%40treenet.co.nz%3E"
       TITLE="[squid-users] No buffer space available">squid3 at treenet.co.nz
       </A><BR>
    <I>Wed Dec  7 16:37:20 UTC 2022</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="025500.html">[squid-users] No buffer space available
</A></li>
        <LI>Next message (by thread): <A HREF="025502.html">[squid-users] req_header acl with ssl_bump
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25501">[ date ]</a>
              <a href="thread.html#25501">[ thread ]</a>
              <a href="subject.html#25501">[ subject ]</a>
              <a href="author.html#25501">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 7/12/2022 9:24 pm, Craig Harrington wrote:
&gt;<i>
</I>&gt;<i> My squid proxy has been running fine for over a year and over the last 
</I>&gt;<i> few weeks it has been failing randomly.
</I>&gt;<i>
</I>&gt;<i> I have been getting the following messages in the cache.log:
</I>&gt;<i>
</I>&gt;<i> comm_openex socket failure: (105) No buffer space available
</I>&gt;<i>
</I>&gt;<i> oldAccept&#160; FD 18, [::] [ job2]: (105) No buffer space available
</I>&gt;<i>
</I>
That error &quot;(105) No buffer space available&quot; occurs when the __operating 
system__ has run out of TCP sockets (too many connections) or network 
stack memory (too much traffic volume).

FWIW; Windows is known to have quite low limit of 2000 concurrent TCP 
sockets per process, making it quite sub-optimal to use for networking 
services like Squid.

Since you have had it running previously, I suggest checking to see how 
many connections Squid is actually using when the problem occurs.

If the number of sockets looks unexpectedly high check for a routing 
loop forwarding traffic leaving Squid back into Squid again?
that type of self-DoS (and of course other types of DoS) are usually 
what cause this error message to come up for Squid.


&gt;<i> Sometimes a restart of the service fixes and sometimes I need to reboot.
</I>&gt;<i>
</I>
Hmm. That need for a full reboot hints that some other service on the 
machine is consuming TCP resources.
If Squid were the cause of this the service restart would *always* fix 
the problem.

It may just be the OS cannot handle two services putting &quot;heavy&quot; use on 
TCP at the same time.


&gt;<i> Server is Windows 2019 running in AWS
</I>&gt;<i>
</I>&gt;<i> Squid is v4.14 from Diladele installer
</I>&gt;<i>
</I>&gt;<i> I have tried reducing TcpFinWait2Delay and TcpTimedWaitDelay.
</I>&gt;<i>
</I>
For effective use of those settings check squid.conf to ensure you do 
*not* have these:
 &#160; client_persistent_connections off
 &#160; serve_persistent_connections off

If they exist removing both (or at least the server one) may help reduce 
the pressure on the OS resources.

One thing to be wary of since you reduced it - is that TcpTimedWaitDelay 
should ideally be the same or larger than Squid 
client_idle_pconn_timeout (default 2 minutes).


HTH
Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="025500.html">[squid-users] No buffer space available
</A></li>
	<LI>Next message (by thread): <A HREF="025502.html">[squid-users] req_header acl with ssl_bump
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25501">[ date ]</a>
              <a href="thread.html#25501">[ thread ]</a>
              <a href="subject.html#25501">[ subject ]</a>
              <a href="author.html#25501">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
