<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Update from Squid 4 to Squid 5 :
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Update%20from%20Squid%204%20to%20Squid%205%20%3A&In-Reply-To=%3C2bc6f3a0-9c10-8292-3cdc-26a0f6aee9e0%40stemarie-aizenay.fr%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="025503.html">
   <LINK REL="Next"  HREF="025514.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Update from Squid 4 to Squid 5 :</H1>
    <B>Bertrand Friconneau</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Update%20from%20Squid%204%20to%20Squid%205%20%3A&In-Reply-To=%3C2bc6f3a0-9c10-8292-3cdc-26a0f6aee9e0%40stemarie-aizenay.fr%3E"
       TITLE="[squid-users] Update from Squid 4 to Squid 5 :">bfriconneau at stemarie-aizenay.fr
       </A><BR>
    <I>Thu Dec  8 08:54:27 UTC 2022</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="025503.html">[squid-users] req_header acl with ssl_bump
</A></li>
        <LI>Next message (by thread): <A HREF="025514.html">[squid-users] Update from Squid 4 to Squid 5 :
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25504">[ date ]</a>
              <a href="thread.html#25504">[ thread ]</a>
              <a href="subject.html#25504">[ subject ]</a>
              <a href="author.html#25504">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi every one,

I can almost continue this tread

First, thanks for the help.

Amos, I made the changes you suggested, but same result.

I tested the folowings commands :
command : wbinfo -u

Can retrieve the users


command : klist
result : klist: No credentials cache found (filename: /tmp/krb5cc_0)

command : kinit <A HREF="https://lists.squid-cache.org/listinfo/squid-users">administrateur at STEMARIE-AIZENAY.LOCAL</A>
result : kinit: Ressource unavailable while getting initial credentials

So I tried to test the DNS :
nslookup 8.8.8.8
nslookup www.google.fr

And it fails

My Squid server can ping my local DNS, but that's all. No DNS resolution

In Sylog :
dans syslog :
Dec&#160; 7 15:53:01 squid winbindd[797]:&#160;&#160; get_kdc_ip_string: get_kdc_list 
fail NT_STATUS_NO_LOGON_SERVERS
Dec&#160; 7 15:53:01 squid winbindd[797]: [2022/12/07 15:53:01.693756, 0] 
../../source3/libads/sasl.c:589(ads_sasl_spnego_bind)
Dec&#160; 7 15:53:01 squid winbindd[797]:&#160;&#160; ads_sasl_spnego_bind: kinit 
succeeded but SPNEGO bind with Kerberos failed for 
ldap/srv-ad2.stemarie-aizenay.local - user[SQUID$], 
realm[STEMARIE-AIZENAY.LOCAL]: No logon servers are currently available 
to service the logon request.

The DNS server is configure in /etc/network/interfaces

The files /etc/hosts and /etc/hostname seem to be well configured

Iptable is not configured, everything is accepted

Any id&#233;e ?

Regards

Bertrand Friconneau




Le 10/11/2022 &#224; 14:10, Amos Jeffries a &#233;crit&#160;:
&gt;<i> On 10/11/2022 4:50 am, Bertrand Friconneau wrote:
</I>&gt;&gt;<i> Hi Everyone,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I've got Squid 4.10 on Ubuntu 20.10 LTS
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I try to upgrade my server to Ubuntu 22.04 LTS
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> But the users couldn't get internet no more.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Here is the log in /var/log/squid/access.log :
</I>&gt;&gt;<i> 1668004454.050&#160;&#160;&#160;&#160;&#160; 0 172.22.200.1 TCP_DENIED/407 3951 CONNECT 
</I>&gt;&gt;<i> drive.google.com:443 - HIER_NONE/- text/html
</I>&gt;&gt;<i> 1668004454.052&#160;&#160;&#160;&#160;&#160; 0 172.22.200.1 TCP_DENIED/407 3951 CONNECT 
</I>&gt;&gt;<i> drive.google.com:443 - HIER_NONE/- text/html
</I>&gt;&gt;<i> 1668004454.057&#160;&#160;&#160;&#160;&#160; 0 172.22.200.1 TCP_DENIED/407 3951 CONNECT 
</I>&gt;&gt;<i> drive.google.com:443 - HIER_NONE/- text/html
</I>&gt;&gt;<i> 1668004454.063&#160;&#160;&#160;&#160;&#160; 1 172.22.200.1 TCP_DENIED/407 4454 CONNECT 
</I>&gt;&gt;<i> drive.google.com:443 - HIER_NONE/- text/html
</I>&gt;&gt;<i> 1668004454.076&#160;&#160;&#160;&#160; 10 172.22.200.1 NONE_NONE/500 0 CONNECT 
</I>&gt;&gt;<i> drive.google.com:443 infoe HIER_NONE/- -
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> And on the client :
</I>&gt;&gt;<i> ERR_TUNNEL_CONNECTION_FAILED
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> According to this page : 
</I>&gt;&gt;<i> <A HREF="https://wiki.squid-cache.org/ConfigExamples/Authenticate/Ntlm">https://wiki.squid-cache.org/ConfigExamples/Authenticate/Ntlm</A>
</I>&gt;&gt;<i> The cause is due to challenge-response process of NTLM
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> How can I solve it ?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Regards
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Bertrand Friconneau
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> ------------------------------------------------------------------------------------------------------------------------------------------------------- 
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Here is my config file of squid :
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> dns_v4_first on
</I>&gt;&gt;<i> visible_hostname squid
</I>&gt;<i>
</I>&gt;<i> Please use an actual FQDN hostname. This is the proxies &quot;visible&quot; 
</I>&gt;<i> hostname - eg sent as the domain name for URLs in error pages etc.
</I>&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> error_directory /usr/share/squid/errors/French
</I>&gt;<i>
</I>&gt;<i> These days it would be better to use:
</I>&gt;<i>
</I>&gt;<i> &#160; error_default_language fr
</I>&gt;<i>
</I>&gt;<i> or at least
</I>&gt;<i> &#160; error_directory /usr/share/squid-langpack/fr
</I>&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> auth_param ntlm program /usr/bin/ntlm_auth 
</I>&gt;&gt;<i> --helper-protocol=squid-2.5-ntlmssp
</I>&gt;&gt;<i> auth_param ntlm children 250
</I>&gt;&gt;<i> auth_param ntlm keep_alive off
</I>&gt;&gt;<i>
</I>&gt;<i> ...
</I>&gt;<i>
</I>&gt;&gt;<i> http_access deny !Safe_ports
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> http_access deny CONNECT !SSL_ports
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> http_access allow localhost manager
</I>&gt;<i>
</I>&gt;<i> or maybe limit manager access to administrationzone
</I>&gt;<i>
</I>&gt;&gt;<i> http_access deny manager
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> custom access policy rules should be down here:
</I>&gt;<i>
</I>&gt;&gt;<i> http_access allow sitebypass
</I>&gt;&gt;<i> http_access deny tor
</I>&gt;&gt;<i> http_access deny url_exe
</I>&gt;<i>
</I>&gt;&gt;<i> http_access allow administrationzone
</I>&gt;&gt;<i> #http_access allow pedagozone
</I>&gt;&gt;<i> #http_access allow xibozone
</I>&gt;<i>
</I>&gt;<i> All these below are of the same ACL type and all &quot;allow&quot; actions.
</I>&gt;<i> Therefore you can combine them into one ACL definition.
</I>&gt;<i>
</I>&gt;&gt;<i> http_access allow informatiquezone
</I>&gt;&gt;<i> http_access allow secuzone
</I>&gt;&gt;<i> http_access allow srvzone
</I>&gt;<i>
</I>&gt;&gt;<i> http_access allow ntlm
</I>&gt;<i>
</I>&gt;<i> What about invalid logins, missing logins etc?
</I>&gt;<i> We highly recommend that the line triggering auth is a &quot;deny&quot; policy 
</I>&gt;<i> to reject all those.
</I>&gt;<i>
</I>&gt;<i> &#160;&#160; http_access deny !ntlm
</I>&gt;<i>
</I>&gt;<i> ... then you allow what can be done by logged in accounts.
</I>&gt;<i>
</I>&gt;<i> &#160; http_access allow localnet
</I>&gt;<i> or
</I>&gt;<i> &#160;http_access allow all
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> You may see a behaviour difference with this change to how Squid 
</I>&gt;<i> handles the login.
</I>&gt;<i> After doing it, of the problem continues try to get some debug 
</I>&gt;<i> information from the auth helper to see what it is getting from the 
</I>&gt;<i> client and why that is not being accepted.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> PS. Since you have Kerberos available, please consider moving away 
</I>&gt;<i> from NTLM to using Negotiate/Kerberos auth. It has both better 
</I>&gt;<i> security and far better performance for the proxy.
</I>&gt;<i>
</I>&gt;<i> Amos
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="025503.html">[squid-users] req_header acl with ssl_bump
</A></li>
	<LI>Next message (by thread): <A HREF="025514.html">[squid-users] Update from Squid 4 to Squid 5 :
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25504">[ date ]</a>
              <a href="thread.html#25504">[ thread ]</a>
              <a href="subject.html#25504">[ subject ]</a>
              <a href="author.html#25504">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
