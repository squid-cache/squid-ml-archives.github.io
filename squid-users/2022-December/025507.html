<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] TLS client hello tls1.0 even with options &quot;tls_outgoing_options min-version=1.2 options=NO_TLSv1:NO_TLSv1_1&quot;
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20TLS%20client%20hello%20tls1.0%20even%20with%20options%0A%20%22tls_outgoing_options%20min-version%3D1.2%20options%3DNO_TLSv1%3ANO_TLSv1_1%22&In-Reply-To=%3C0e529788-581e-b503-f575-a850751bc0fe%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="025506.html">
   <LINK REL="Next"  HREF="025508.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] TLS client hello tls1.0 even with options &quot;tls_outgoing_options min-version=1.2 options=NO_TLSv1:NO_TLSv1_1&quot;</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20TLS%20client%20hello%20tls1.0%20even%20with%20options%0A%20%22tls_outgoing_options%20min-version%3D1.2%20options%3DNO_TLSv1%3ANO_TLSv1_1%22&In-Reply-To=%3C0e529788-581e-b503-f575-a850751bc0fe%40measurement-factory.com%3E"
       TITLE="[squid-users] TLS client hello tls1.0 even with options &quot;tls_outgoing_options min-version=1.2 options=NO_TLSv1:NO_TLSv1_1&quot;">rousskov at measurement-factory.com
       </A><BR>
    <I>Mon Dec 12 14:24:13 UTC 2022</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="025506.html">[squid-users] TLS client hello tls1.0 even with options &quot;tls_outgoing_options min-version=1.2 options=NO_TLSv1:NO_TLSv1_1&quot;
</A></li>
        <LI>Next message (by thread): <A HREF="025508.html">[squid-users] TLS client hello tls1.0 even with options &quot;tls_outgoing_options min-version=1.2 options=NO_TLSv1:NO_TLSv1_1&quot;
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25507">[ date ]</a>
              <a href="thread.html#25507">[ thread ]</a>
              <a href="subject.html#25507">[ subject ]</a>
              <a href="author.html#25507">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 12/12/22 06:34, Dieter Bloms wrote:

&gt;<i> I've enabled sslbump and configured the following outgoing tls options:
</I>&gt;<i> 
</I>&gt;<i> tls_outgoing_options min-version=1.2 options=NO_TLSv1:NO_TLSv1_1 cipher=TLSv1.2:+aRSA:+SHA384:+SHA256:+DH:-kRSA:!PSK:!eNULL:!aNULL:!DSS:!AESCCM:!CAMELLIA:!ARIA
</I>

This probably does not apply to your specific use case, but I will state 
it here in case others readers find this exchange: If SslBump 
configuration peeks at the server, then Squid cannot honor 
tls_outgoing_options. For example, tls_outgoing_options will be ignored 
in the following configuration:

     ssl_bump peek all
     ssl_bump splice all

 &gt; min-version=1.2 options=NO_TLSv1:NO_TLSv1_1

FYI: The min-version=1.2 directive will automatically append 
NO_TLSv1:NO_TLSv1_1 options (or their GnuTLS equivalents).


&gt;<i> so for me it looks like squid must not use TLS1.1 or TLS1.0.
</I>&gt;<i> But for some web sites like
</I>&gt;<i> <A HREF="https://www.europarl.europa.eu/doceo/document/LIBE-OJ-2022-12-12-1_EN.html">https://www.europarl.europa.eu/doceo/document/LIBE-OJ-2022-12-12-1_EN.html</A>
</I>&gt;<i> the first request is made with an tls1.0 client hello packet.
</I>
You are probably being misled by Wireshark (or equivalent). Packet in 
frame 4 and packet in frame 9 in your trace use the same set of 
versions. The two packets only differ in Random, Session ID, and Key 
Exchange fields (as expected). You can confirm that by expanding TLS 
sub-trees in each packet, copying each packet dissection, and comparing 
the two saved text files.

TLS has many layers. Layers have their own versions (and their own 
version-specific ways to specify versions). The two packets in question 
use v1.0 TLS record to transmit ClientHello message (legacy version 
v1.2) to announce support for TLS v1.2 and TLS v1.3:

&gt;<i> TLS... Record Layer: Handshake Protocol: Client Hello
</I>&gt;<i>     Content Type: Handshake (22)
</I>&gt;<i>     Version: TLS 1.0 (0x0301)
</I>&gt;<i>     Handshake Protocol: Client Hello
</I>&gt;<i>         Version: TLS 1.2 (0x0303)
</I>...
&gt;<i>         Extension: supported_versions (len=5)
</I>&gt;<i>             Type: supported_versions (43)
</I>&gt;<i>             Length: 5
</I>&gt;<i>             Supported Versions length: 4
</I>&gt;<i>             Supported Version: TLS 1.3 (0x0304)
</I>&gt;<i>             Supported Version: TLS 1.2 (0x0303)
</I>

Why does Whireshark (and similar smart tools) say &quot;TLSv1.3 Record Layer&quot; 
only for packet 9 even though all the relevant ClientHello fields are 
identical in both packets? That happens because Wireshark is smart 
enough to look further into the TLS handshake and discover that, when it 
comes to the connection containing packet 9, the two agents have 
negotiated TLS v1.3 (starting with frame 10):

&gt;<i> TLSv1.3 Record Layer: Handshake Protocol: Hello Retry Request
</I>&gt;<i>         Extension: supported_versions (len=2)
</I>&gt;<i>             Type: supported_versions (43)
</I>&gt;<i>             Length: 2
</I>&gt;<i>             Supported Version: TLS 1.3 (0x0304)
</I>

You can easily confirm that Wireshark is just being (too) helpful by 
exporting frames 1-9 from the packet capture (as a pcap packet capture) 
and looking at the exported packets with Wireshark. You will then see 
&quot;TLSv1 Record Layer&quot; instead of &quot;TLSv1.3 Record Layer&quot; for packet 9, 
even though you have modified no packets, only truncated the exchange.


I do not know why the server resets the first TCP connection.


HTH,

Alex.



&gt;<i> When I reload the page the proxyserver sends a tls1.2 client hello and the website is shown as expected.
</I>&gt;<i> 
</I>&gt;<i> So what option can be used to force a minimum tls1.2 client hello package every time?
</I>&gt;<i> 
</I>&gt;<i> Here is a link to the pcap file with both variants: <A HREF="https://bloms.de/download/www.europarl.europa.eu.pcap">https://bloms.de/download/www.europarl.europa.eu.pcap</A>
</I>&gt;<i> 
</I>&gt;<i> 
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="025506.html">[squid-users] TLS client hello tls1.0 even with options &quot;tls_outgoing_options min-version=1.2 options=NO_TLSv1:NO_TLSv1_1&quot;
</A></li>
	<LI>Next message (by thread): <A HREF="025508.html">[squid-users] TLS client hello tls1.0 even with options &quot;tls_outgoing_options min-version=1.2 options=NO_TLSv1:NO_TLSv1_1&quot;
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25507">[ date ]</a>
              <a href="thread.html#25507">[ thread ]</a>
              <a href="subject.html#25507">[ subject ]</a>
              <a href="author.html#25507">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
