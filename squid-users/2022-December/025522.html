<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] LEGACY_SERVER_CONNECT, ALLOW_UNSAFE_LEGACY_RENEGOTIATION does not work - SSL bump, OpenSSL 3
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20LEGACY_SERVER_CONNECT%2C%0A%20ALLOW_UNSAFE_LEGACY_RENEGOTIATION%20does%20not%20work%20-%20SSL%20bump%2C%20OpenSSL%203&In-Reply-To=%3C2584423d-9def-9832-b41b-f4a525d8209a%40gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="025521.html">
   <LINK REL="Next"  HREF="025523.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] LEGACY_SERVER_CONNECT, ALLOW_UNSAFE_LEGACY_RENEGOTIATION does not work - SSL bump, OpenSSL 3</H1>
    <B>Amish</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20LEGACY_SERVER_CONNECT%2C%0A%20ALLOW_UNSAFE_LEGACY_RENEGOTIATION%20does%20not%20work%20-%20SSL%20bump%2C%20OpenSSL%203&In-Reply-To=%3C2584423d-9def-9832-b41b-f4a525d8209a%40gmail.com%3E"
       TITLE="[squid-users] LEGACY_SERVER_CONNECT, ALLOW_UNSAFE_LEGACY_RENEGOTIATION does not work - SSL bump, OpenSSL 3">anon.amish at gmail.com
       </A><BR>
    <I>Mon Dec 26 06:26:45 UTC 2022</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="025521.html">[squid-users] LEGACY_SERVER_CONNECT, ALLOW_UNSAFE_LEGACY_RENEGOTIATION does not work - SSL bump, OpenSSL 3
</A></li>
        <LI>Next message (by thread): <A HREF="025523.html">[squid-users] LEGACY_SERVER_CONNECT, ALLOW_UNSAFE_LEGACY_RENEGOTIATION does not work - SSL bump, OpenSSL 3
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25522">[ date ]</a>
              <a href="thread.html#25522">[ thread ]</a>
              <a href="subject.html#25522">[ subject ]</a>
              <a href="author.html#25522">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello,

After sending the previous (quoted below) email, I came across another 
recent thread [1] where it is mentioned by Alex that:

 &gt; If SslBump configuration peeks at the server, then Squid cannot honor 
tls_outgoing_options.

So here is ssl_bump options too, in case that information is required:

ssl_bump peek ssl_step1 # step1 - so not peeking at the server yet
ssl_bump splice nosslbump_domains # step2 or 3, tunnel some domains we 
do not want to bump
ssl_bump stare all # step2 stare (not peek) at the server
ssl_bump bump all # step3, bump all connections that reached here

So I think in my case (previous email), squid should honor 
tls_outgoing_options.

Regards,

[1] 
<A HREF="http://lists.squid-cache.org/pipermail/squid-users/2022-December/025507.html">http://lists.squid-cache.org/pipermail/squid-users/2022-December/025507.html</A>

Amish

On 26/12/22 11:16, Amish wrote:
&gt;<i> Hello
</I>&gt;<i>
</I>&gt;<i> I am using squid v5.7 with OpenSSL 3.0.7. (Arch Linux)
</I>&gt;<i>
</I>&gt;<i> I have setup SSL bump which was working fine till OpenSSL 1.1.1 series.
</I>&gt;<i>
</I>&gt;<i> With OpenSSL 3.0.7, SSL bump still works fine but except some 
</I>&gt;<i> (unpatched) sites.
</I>&gt;<i>
</I>&gt;<i> For example:
</I>&gt;<i> <A HREF="https://www.jio.com/">https://www.jio.com/</A> (A leading mobile network provider in India)
</I>&gt;<i>
</I>&gt;<i> For above site, squid throws error page with this message:
</I>&gt;<i>
</I>&gt;<i> &#160;&#160;&#160; [No Error] (TLS code: 
</I>&gt;<i> SQUID_TLS_ERR_CONNECT+TLS_LIB_ERR=A000152+TLS_IO_ERR=1)
</I>&gt;<i> &#160;&#160;&#160; Failed to establish a secure connection: error:0A000152:SSL 
</I>&gt;<i> routines::unsafe legacy renegotiation disabled
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Testing the same site with OpenSSL (via s_client) also fails unless 
</I>&gt;<i> legacy renegotiation is enabled:
</I>&gt;<i>
</I>&gt;<i> $ openssl s_client -connect www.jio.com:443
</I>&gt;<i> 40C7F204E37F0000:error:0A000152:SSL routines:final_renegotiate:unsafe 
</I>&gt;<i> legacy renegotiation disabled:ssl/statem/extensions.c:893:
</I>&gt;<i>
</I>&gt;<i> $ openssl s_client&#160; -legacy_renegotiation -connect www.jio.com:443
</I>&gt;<i> depth=2 C = US, ST = Arizona, L = Scottsdale, O = &quot;GoDaddy.com, Inc.&quot;, 
</I>&gt;<i> CN = Go Daddy Root Certificate Authority - G2
</I>&gt;<i> ...
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Since website is one of the important website, I am trying to inform 
</I>&gt;<i> squid to allow legacy server connect (I also tried with unsafe 
</I>&gt;<i> renegotiation)
</I>&gt;<i>
</I>&gt;<i> Source: <A HREF="https://www.openssl.org/docs/man3.0/man3/SSL_CTX_set_options.html">https://www.openssl.org/docs/man3.0/man3/SSL_CTX_set_options.html</A>
</I>&gt;<i>
</I>&gt;<i> squid.conf:
</I>&gt;<i>
</I>&gt;<i> # workaround for legacy / unpatched servers
</I>&gt;<i> tls_outgoing_options 
</I>&gt;<i> options=LEGACY_SERVER_CONNECT,ALLOW_UNSAFE_LEGACY_RENEGOTIATION
</I>&gt;<i>
</I>&gt;<i> # other related TLS related settings
</I>&gt;<i> tls_outgoing_options cafile=/etc/ssl/cert.pem
</I>&gt;<i>
</I>&gt;<i> tls_outgoing_options 
</I>&gt;<i> cipher=ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA:ECDHE-RSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA:DHE-RSA-AES256-SHA256:DHE-RSA-AES256-SHA:ECDHE-ECDSA-DES-CBC3-SHA:ECDHE-RSA-DES-CBC3-SHA:EDH-RSA-DES-CBC3-SHA:AES128-GCM-SHA256:AES256-GCM-SHA384:AES128-SHA256:AES256-SHA256:AES128-SHA:AES256-SHA:DES-CBC3-SHA:!DSS
</I>&gt;<i>
</I>&gt;<i> # systemctl reload squid
</I>&gt;<i>
</I>&gt;<i> But I am still getting the same error when trying to connect to the 
</I>&gt;<i> above site via squid proxy. (Works fine without proxy)
</I>&gt;<i>
</I>&gt;<i> What am I doing wrong?
</I>&gt;<i>
</I>&gt;<i> Tips / help appreciated,
</I>&gt;<i>
</I>&gt;<i> Thank you,
</I>&gt;<i>
</I>&gt;<i> Amish.
</I>&gt;<i>
</I>
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="025521.html">[squid-users] LEGACY_SERVER_CONNECT, ALLOW_UNSAFE_LEGACY_RENEGOTIATION does not work - SSL bump, OpenSSL 3
</A></li>
	<LI>Next message (by thread): <A HREF="025523.html">[squid-users] LEGACY_SERVER_CONNECT, ALLOW_UNSAFE_LEGACY_RENEGOTIATION does not work - SSL bump, OpenSSL 3
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25522">[ date ]</a>
              <a href="thread.html#25522">[ thread ]</a>
              <a href="subject.html#25522">[ subject ]</a>
              <a href="author.html#25522">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
