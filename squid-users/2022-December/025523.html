<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] LEGACY_SERVER_CONNECT, ALLOW_UNSAFE_LEGACY_RENEGOTIATION does not work - SSL bump, OpenSSL 3
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20LEGACY_SERVER_CONNECT%2C%0A%20ALLOW_UNSAFE_LEGACY_RENEGOTIATION%20does%20not%20work%20-%20SSL%20bump%2C%20OpenSSL%203&In-Reply-To=%3Cecc504d5-29f8-c63d-5662-7303b4c4a5f3%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="025522.html">
   <LINK REL="Next"  HREF="025524.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] LEGACY_SERVER_CONNECT, ALLOW_UNSAFE_LEGACY_RENEGOTIATION does not work - SSL bump, OpenSSL 3</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20LEGACY_SERVER_CONNECT%2C%0A%20ALLOW_UNSAFE_LEGACY_RENEGOTIATION%20does%20not%20work%20-%20SSL%20bump%2C%20OpenSSL%203&In-Reply-To=%3Cecc504d5-29f8-c63d-5662-7303b4c4a5f3%40measurement-factory.com%3E"
       TITLE="[squid-users] LEGACY_SERVER_CONNECT, ALLOW_UNSAFE_LEGACY_RENEGOTIATION does not work - SSL bump, OpenSSL 3">rousskov at measurement-factory.com
       </A><BR>
    <I>Mon Dec 26 16:01:49 UTC 2022</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="025522.html">[squid-users] LEGACY_SERVER_CONNECT, ALLOW_UNSAFE_LEGACY_RENEGOTIATION does not work - SSL bump, OpenSSL 3
</A></li>
        <LI>Next message (by thread): <A HREF="025524.html">[squid-users] LEGACY_SERVER_CONNECT, ALLOW_UNSAFE_LEGACY_RENEGOTIATION does not work - SSL bump, OpenSSL 3
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25523">[ date ]</a>
              <a href="thread.html#25523">[ thread ]</a>
              <a href="subject.html#25523">[ subject ]</a>
              <a href="author.html#25523">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 12/26/22 00:46, Amish wrote:

&gt;<i> I am using squid v5.7 with OpenSSL 3.0.7. (Arch Linux)
</I>
&gt;<i> squid.conf:
</I>&gt;<i> 
</I>&gt;<i> # workaround for legacy / unpatched servers
</I>&gt;<i> tls_outgoing_options 
</I>&gt;<i> options=LEGACY_SERVER_CONNECT,ALLOW_UNSAFE_LEGACY_RENEGOTIATION
</I>
There are two problems here:

1. Squid v5.7 hides important configuration errors. That problem was 
fixed in master/v6 commit 61be1d8, but that fix has not been backported 
to v5. If it were, you would have seen errors like this:

     ERROR: Unknown TLS option LEGACY_SERVER_CONNECT
     ERROR: Unknown TLS option ALLOW_UNSAFE_LEGACY_RENEGOTIATION

You can still see those level-1 errors on stderr if you start Squid v5.7 
with &quot;-X&quot;, but they will be drowned in a sea of debugging records. Save 
stderr output into a file and search it for ERROR.

I recommend lobbying for making the above configuration errors fatal in 
Squid v6. I would be happy to post the corresponding code changes if 
others agree that they should be fatal.


2. As the above errors imply, you are using options that Squid does not 
understand. Squid cannot pass named options that it does not understand 
to OpenSSL because Squid does not know their numerical values (OpenSSL 
API requires a numeric value to enable an option). However, you can use 
a dangerous workaround: You can specify their raw numeric values (in 
hex). You may use the table at [1] to get those values[2]:

     tls_outgoing_options options=0x4,0x40000

Disclaimer: I have not tested whether the above configuration matches 
your intent. I only know that Squid v5 does not generate an ERROR for it.


[1] <A HREF="https://wiki.openssl.org/index.php/List_of_SSL_OP_Flags">https://wiki.openssl.org/index.php/List_of_SSL_OP_Flags</A>

[2] The table provides numerical values for OpenSSL v1 options. For 
OpenSSL v3, the table provides a SSL_OP_BIT(n) formula: 2 to the power 
of n. For example, SSL_OP_BIT(2) is, in hex notation, 0x4.
     #define SSL_OP_BIT(n)  ((uint64_t)1 &lt;&lt; (uint64_t)n)


HTH,

Alex.


&gt;<i> # other related TLS related settings
</I>&gt;<i> tls_outgoing_options cafile=/etc/ssl/cert.pem
</I>&gt;<i> 
</I>&gt;<i> tls_outgoing_options 
</I>&gt;<i> cipher=ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA:ECDHE-RSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA:DHE-RSA-AES256-SHA256:DHE-RSA-AES256-SHA:ECDHE-ECDSA-DES-CBC3-SHA:ECDHE-RSA-DES-CBC3-SHA:EDH-RSA-DES-CBC3-SHA:AES128-GCM-SHA256:AES256-GCM-SHA384:AES128-SHA256:AES256-SHA256:AES128-SHA:AES256-SHA:DES-CBC3-SHA:!DSS
</I>&gt;<i> 
</I>&gt;<i> # systemctl reload squid
</I>&gt;<i> 
</I>&gt;<i> But I am still getting the same error when trying to connect to the 
</I>&gt;<i> above site via squid proxy. (Works fine without proxy)
</I>&gt;<i> 
</I>&gt;<i> What am I doing wrong?
</I>&gt;<i> 
</I>&gt;<i> Tips / help appreciated,
</I>&gt;<i> 
</I>&gt;<i> Thank you,
</I>&gt;<i> 
</I>&gt;<i> Amish.
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="025522.html">[squid-users] LEGACY_SERVER_CONNECT, ALLOW_UNSAFE_LEGACY_RENEGOTIATION does not work - SSL bump, OpenSSL 3
</A></li>
	<LI>Next message (by thread): <A HREF="025524.html">[squid-users] LEGACY_SERVER_CONNECT, ALLOW_UNSAFE_LEGACY_RENEGOTIATION does not work - SSL bump, OpenSSL 3
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25523">[ date ]</a>
              <a href="thread.html#25523">[ thread ]</a>
              <a href="subject.html#25523">[ subject ]</a>
              <a href="author.html#25523">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
