<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] LEGACY_SERVER_CONNECT, ALLOW_UNSAFE_LEGACY_RENEGOTIATION does not work - SSL bump, OpenSSL 3
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20LEGACY_SERVER_CONNECT%2C%0A%20ALLOW_UNSAFE_LEGACY_RENEGOTIATION%20does%20not%20work%20-%20SSL%20bump%2C%20OpenSSL%203&In-Reply-To=%3C63f940db-77b3-c57c-ec00-f174fed51516%40gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="025523.html">
   <LINK REL="Next"  HREF="025525.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] LEGACY_SERVER_CONNECT, ALLOW_UNSAFE_LEGACY_RENEGOTIATION does not work - SSL bump, OpenSSL 3</H1>
    <B>Amish</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20LEGACY_SERVER_CONNECT%2C%0A%20ALLOW_UNSAFE_LEGACY_RENEGOTIATION%20does%20not%20work%20-%20SSL%20bump%2C%20OpenSSL%203&In-Reply-To=%3C63f940db-77b3-c57c-ec00-f174fed51516%40gmail.com%3E"
       TITLE="[squid-users] LEGACY_SERVER_CONNECT, ALLOW_UNSAFE_LEGACY_RENEGOTIATION does not work - SSL bump, OpenSSL 3">anon.amish at gmail.com
       </A><BR>
    <I>Tue Dec 27 15:42:38 UTC 2022</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="025523.html">[squid-users] LEGACY_SERVER_CONNECT, ALLOW_UNSAFE_LEGACY_RENEGOTIATION does not work - SSL bump, OpenSSL 3
</A></li>
        <LI>Next message (by thread): <A HREF="025525.html">[squid-users] LEGACY_SERVER_CONNECT, ALLOW_UNSAFE_LEGACY_RENEGOTIATION does not work - SSL bump, OpenSSL 3
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25524">[ date ]</a>
              <a href="thread.html#25524">[ thread ]</a>
              <a href="subject.html#25524">[ subject ]</a>
              <a href="author.html#25524">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Alex,

Thank you for putting so much efforts in reply.

Unfortunately, something is still wrong somewhere, as below.

On 26/12/22 21:31, Alex Rousskov wrote:
&gt;<i> On 12/26/22 00:46, Amish wrote:
</I>&gt;<i>
</I>&gt;&gt;<i> I am using squid v5.7 with OpenSSL 3.0.7. (Arch Linux)
</I>&gt;<i>
</I>&gt;&gt;<i> squid.conf:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> # workaround for legacy / unpatched servers
</I>&gt;&gt;<i> tls_outgoing_options 
</I>&gt;&gt;<i> options=LEGACY_SERVER_CONNECT,ALLOW_UNSAFE_LEGACY_RENEGOTIATION
</I>&gt;<i>
</I>&gt;<i> There are two problems here:
</I>&gt;<i>
</I>&gt;<i> 1. Squid v5.7 hides important configuration errors. That problem was 
</I>&gt;<i> fixed in master/v6 commit 61be1d8, but that fix has not been 
</I>&gt;<i> backported to v5. If it were, you would have seen errors like this:
</I>&gt;<i>
</I>&gt;<i> &#160;&#160;&#160; ERROR: Unknown TLS option LEGACY_SERVER_CONNECT
</I>&gt;<i> &#160;&#160;&#160; ERROR: Unknown TLS option ALLOW_UNSAFE_LEGACY_RENEGOTIATION
</I>&gt;<i>
</I>&gt;<i> You can still see those level-1 errors on stderr if you start Squid 
</I>&gt;<i> v5.7 with &quot;-X&quot;, but they will be drowned in a sea of debugging 
</I>&gt;<i> records. Save stderr output into a file and search it for ERROR.
</I>&gt;<i>
</I>&gt;<i> I recommend lobbying for making the above configuration errors fatal 
</I>&gt;<i> in Squid v6. I would be happy to post the corresponding code changes 
</I>&gt;<i> if others agree that they should be fatal.
</I>

Yes indeed, the ERROR does appear on stderr with -X.

It should definitely be fatal as otherwise someone may lose proper 
security, with wrong OR incomplete OR unimplemented settings thinking 
that, squid did not give error so its working fine.

&gt;<i> 2. As the above errors imply, you are using options that Squid does 
</I>&gt;<i> not understand. Squid cannot pass named options that it does not 
</I>&gt;<i> understand to OpenSSL because Squid does not know their numerical 
</I>&gt;<i> values (OpenSSL API requires a numeric value to enable an option). 
</I>&gt;<i> However, you can use a dangerous workaround: You can specify their raw 
</I>&gt;<i> numeric values (in hex). You may use the table at [1] to get those 
</I>&gt;<i> values[2]:
</I>&gt;<i>
</I>&gt;<i> &#160;&#160;&#160; tls_outgoing_options options=0x4,0x40000
</I>&gt;<i>
</I>&gt;<i> Disclaimer: I have not tested whether the above configuration matches 
</I>&gt;<i> your intent. I only know that Squid v5 does not generate an ERROR for it.
</I>

With numeric hex values, I do not see the ERROR on stderr.

But it still does not seem to be working as expected. Squid still does 
not open the page and gives same legacy negotiation error.

How do I know that SSL_CTX_set_options() is working with above options?

There appears to be nothing in cache.log.

$ grep debug_options squid.conf
debug_options 83,6

$ tail -f /var/log/squid/cache.log |grep -i 'ssl\|tls'
2022/12/27 20:39:04.939 kid1| 83,3| client_side_request.cc(1557) 
sslBumpNeed: sslBump required: peek
2022/12/27 20:39:05.920 kid1| 83,5| 
../../src/security/PeerOptions.h(111) convertContextFromRawPtr: SSL_CTX 
construct, this=0x557039611e60
2022/12/27 20:39:05.920 kid1| 83,5| Session.cc(103) NewSessionObject: 
SSL_new session=0x55703adcfd70
2022/12/27 20:39:05.920 kid1| 83,5| Session.cc(161) CreateSession: link 
FD 12 to TLS session=0x55703adcfd70
2022/12/27 20:39:05.920 kid1| 83,5| Io.cc(91) Handshake: -1/0 for TLS 
connection 0x55703adcfd70 over conn23909 local=127.0.0.1:8080 
remote=127.0.0.1:48458 FD 12 flags=1
2022/12/27 20:39:05.927 kid1| 83,5| Session.cc(103) NewSessionObject: 
SSL_new session=0x557039a59050
2022/12/27 20:39:05.927 kid1| 83,5| Session.cc(161) CreateSession: link 
FD 16 to TLS session=0x557039a59050
2022/12/27 20:39:05.928 kid1| 83,5| Io.cc(91) Handshake: -1/11 for TLS 
connection 0x557039a59050 over conn23913 local=[2001:db8::2]:60020 
remote=[2405:200:1601:c0e1:49:40:8:183]:443 HIER_DIRECT FD 16 flags=1
2022/12/27 20:39:06.062 kid1| 83,5| Io.cc(91) Handshake: -1/0 for TLS 
connection 0x557039a59050 over conn23913 local=[2001:db8::2]:60020 
remote=[2405:200:1601:c0e1:49:40:8:183]:443 HIER_DIRECT FD 16 flags=1
2022/12/27 20:39:06.062 kid1| 83,5| Io.cc(91) Handshake: -1/0 for TLS 
connection 0x557039a59050 over conn23913 local=[2001:db8::2]:60020 
remote=[2405:200:1601:c0e1:49:40:8:183]:443 HIER_DIRECT FD 16 flags=1
2022/12/27 20:39:06.063 kid1| 83,5| Io.cc(91) Handshake: -1/0 for TLS 
connection 0x557039a59050 over conn23913 local=[2001:db8::2]:60020 
remote=[2405:200:1601:c0e1:49:40:8:183]:443 HIER_DIRECT FD 16 flags=1
2022/12/27 20:39:06.063 kid1| 83,2| PeerConnector.cc(256) 
handleNegotiationResult: ERROR: failure while establishing TLS 
connection on FD: 160x55703a2d9e40*1
2022/12/27 20:39:06.063 kid1| 83,5| NegotiationHistory.cc(85) 
retrieveNegotiatedInfo: SSL connection info on FD 16 SSL version 
NONE/0.0 negotiated cipher
2022/12/27 20:39:06.063 kid1| 83,5| PeerConnector.cc(540) callBack: TLS 
setup ended for
2022/12/27 20:39:06.069 kid1| 83,5| Session.cc(103) NewSessionObject: 
SSL_new session=0x557039779b10
2022/12/27 20:39:06.069 kid1| 83,5| Session.cc(161) CreateSession: link 
FD 16 to TLS session=0x557039779b10
2022/12/27 20:39:06.070 kid1| 83,5| Io.cc(91) Handshake: -1/11 for TLS 
connection 0x557039779b10 over conn23916 local=192.168.0.2:54084 
remote=49.40.8.180:443 HIER_DIRECT FD 16 flags=1
2022/12/27 20:39:06.191 kid1| 83,5| Io.cc(91) Handshake: -1/0 for TLS 
connection 0x557039779b10 over conn23916 local=192.168.0.2:54084 
remote=49.40.8.180:443 HIER_DIRECT FD 16 flags=1
2022/12/27 20:39:06.192 kid1| 83,5| Io.cc(91) Handshake: -1/0 for TLS 
connection 0x557039779b10 over conn23916 local=192.168.0.2:54084 
remote=49.40.8.180:443 HIER_DIRECT FD 16 flags=1
2022/12/27 20:39:06.193 kid1| 83,5| Io.cc(91) Handshake: -1/0 for TLS 
connection 0x557039779b10 over conn23916 local=192.168.0.2:54084 
remote=49.40.8.180:443 HIER_DIRECT FD 16 flags=1
2022/12/27 20:39:06.193 kid1| 83,2| PeerConnector.cc(256) 
handleNegotiationResult: ERROR: failure while establishing TLS 
connection on FD: 160x55703a2d9e40*1
2022/12/27 20:39:06.193 kid1| 83,5| NegotiationHistory.cc(85) 
retrieveNegotiatedInfo: SSL connection info on FD 16 SSL version 
NONE/0.0 negotiated cipher
2022/12/27 20:39:06.193 kid1| 83,5| PeerConnector.cc(540) callBack: TLS 
setup ended for
2022/12/27 20:39:06.193 kid1| 83,5| Session.cc(100) operator(): SSL_free 
session=0x557039779b10
2022/12/27 20:39:06.236 kid1| 83,5| Io.cc(91) Handshake: -1/11 for TLS 
connection 0x55703adcfd70 over conn23909 local=127.0.0.1:8080 
remote=127.0.0.1:48458 FD 12 flags=1
2022/12/27 20:39:06.247 kid1| 83,5| Io.cc(91) Handshake: -1/11 for TLS 
connection 0x55703adcfd70 over conn23909 local=127.0.0.1:8080 
remote=127.0.0.1:48458 FD 12 flags=1
2022/12/27 20:39:06.254 kid1| 83,5| Session.cc(292) store_session_cb: 
Request to store SSL_SESSION
2022/12/27 20:39:06.254 kid1| 83,5| Session.cc(314) store_session_cb: 
wrote an SSL_SESSION entry of size 129 at pos 129
2022/12/27 20:39:06.254 kid1| 83,5| Session.cc(292) store_session_cb: 
Request to store SSL_SESSION
2022/12/27 20:39:06.254 kid1| 83,5| Session.cc(314) store_session_cb: 
wrote an SSL_SESSION entry of size 128 at pos 80
2022/12/27 20:39:06.255 kid1| 83,5| Io.cc(91) Handshake: 1/0 for TLS 
connection 0x55703adcfd70 over conn23909 local=127.0.0.1:8080 
remote=127.0.0.1:48458 FD 12 flags=1
-----BEGIN SSL SESSION PARAMETERS-----
-----END SSL SESSION PARAMETERS-----
2022/12/27 20:39:06.255 kid1| 83,2| client_side.cc(2460) 
clientNegotiateSSL: New session 0x55703abd32f0 on FD 12 (127.0.0.1:48458)
2022/12/27 20:39:06.255 kid1| 83,5| NegotiationHistory.cc(85) 
retrieveNegotiatedInfo: SSL connection info on FD 12 SSL version TLS/1.3 
negotiated cipher TLS_AES_256_GCM_SHA384
2022/12/27 20:39:06.255 kid1| 83,5| client_side.cc(2483) 
clientNegotiateSSL: FD 12 has no client certificate.
2022/12/27 20:39:06.255 kid1| 83,3| Session.cc(36) tls_read_method: 
started for session=0x55703adcfd70
2022/12/27 20:39:06.256 kid1| 83,3| Session.cc(73) tls_write_method: 
started for session=0x55703adcfd70
2022/12/27 20:39:06.256 kid1| 83,3| Session.cc(73) tls_write_method: 
started for session=0x55703adcfd70
2022/12/27 20:39:06.257 kid1| 83,5| Session.cc(100) operator(): SSL_free 
session=0x557039a59050
2022/12/27 20:39:06.257 kid1| 83,5| Session.cc(100) operator(): SSL_free 
session=0x55703adcfd70
2022/12/27 20:39:06.257 kid1| 83,5| 
../../src/security/PeerOptions.h(113) operator(): SSL_CTX destruct, 
this=0x557039611e60


Any idea on how do I know if SSL_CTX_set_options() is working with 
legacy negotiations enabled?


&gt;<i> [1] <A HREF="https://wiki.openssl.org/index.php/List_of_SSL_OP_Flags">https://wiki.openssl.org/index.php/List_of_SSL_OP_Flags</A>
</I>

Above link should be placed in tls_outgoing_options documentation at 
<A HREF="http://www.squid-cache.org/Doc/config/tls_outgoing_options/">http://www.squid-cache.org/Doc/config/tls_outgoing_options/</A>

Additionally a NOTE should be placed stating that it supports HEX values.

Current documentation gives an impression that I can use all the named 
options supported by OpenSSL. But in reality only selected named options 
are supported.


&gt;<i> [2] The table provides numerical values for OpenSSL v1 options. For 
</I>&gt;<i> OpenSSL v3, the table provides a SSL_OP_BIT(n) formula: 2 to the power 
</I>&gt;<i> of n. For example, SSL_OP_BIT(2) is, in hex notation, 0x4.
</I>&gt;<i> &#160;&#160;&#160; #define SSL_OP_BIT(n)&#160; ((uint64_t)1 &lt;&lt; (uint64_t)n)
</I>&gt;<i>
</I>&gt;<i> HTH,
</I>&gt;<i>
</I>&gt;<i> Alex.
</I>&gt;<i>
</I>&gt;&gt;<i> # other related TLS related settings
</I>&gt;&gt;<i> tls_outgoing_options cafile=/etc/ssl/cert.pem
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> tls_outgoing_options 
</I>&gt;&gt;<i> cipher=ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA:ECDHE-RSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA:DHE-RSA-AES256-SHA256:DHE-RSA-AES256-SHA:ECDHE-ECDSA-DES-CBC3-SHA:ECDHE-RSA-DES-CBC3-SHA:EDH-RSA-DES-CBC3-SHA:AES128-GCM-SHA256:AES256-GCM-SHA384:AES128-SHA256:AES256-SHA256:AES128-SHA:AES256-SHA:DES-CBC3-SHA:!DSS
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> # systemctl reload squid
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> But I am still getting the same error when trying to connect to the 
</I>&gt;&gt;<i> above site via squid proxy. (Works fine without proxy)
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> What am I doing wrong?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Tips / help appreciated,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Thank you,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Amish.
</I>
Thank you

Amish.


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="025523.html">[squid-users] LEGACY_SERVER_CONNECT, ALLOW_UNSAFE_LEGACY_RENEGOTIATION does not work - SSL bump, OpenSSL 3
</A></li>
	<LI>Next message (by thread): <A HREF="025525.html">[squid-users] LEGACY_SERVER_CONNECT, ALLOW_UNSAFE_LEGACY_RENEGOTIATION does not work - SSL bump, OpenSSL 3
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25524">[ date ]</a>
              <a href="thread.html#25524">[ thread ]</a>
              <a href="subject.html#25524">[ subject ]</a>
              <a href="author.html#25524">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
