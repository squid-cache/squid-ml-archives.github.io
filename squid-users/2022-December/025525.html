<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] LEGACY_SERVER_CONNECT, ALLOW_UNSAFE_LEGACY_RENEGOTIATION does not work - SSL bump, OpenSSL 3
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20LEGACY_SERVER_CONNECT%2C%0A%20ALLOW_UNSAFE_LEGACY_RENEGOTIATION%20does%20not%20work%20-%20SSL%20bump%2C%20OpenSSL%203&In-Reply-To=%3C17c35a0f-2577-712e-ff3a-5cdd251cb179%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="025524.html">
   <LINK REL="Next"  HREF="025526.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] LEGACY_SERVER_CONNECT, ALLOW_UNSAFE_LEGACY_RENEGOTIATION does not work - SSL bump, OpenSSL 3</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20LEGACY_SERVER_CONNECT%2C%0A%20ALLOW_UNSAFE_LEGACY_RENEGOTIATION%20does%20not%20work%20-%20SSL%20bump%2C%20OpenSSL%203&In-Reply-To=%3C17c35a0f-2577-712e-ff3a-5cdd251cb179%40measurement-factory.com%3E"
       TITLE="[squid-users] LEGACY_SERVER_CONNECT, ALLOW_UNSAFE_LEGACY_RENEGOTIATION does not work - SSL bump, OpenSSL 3">rousskov at measurement-factory.com
       </A><BR>
    <I>Tue Dec 27 16:22:34 UTC 2022</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="025524.html">[squid-users] LEGACY_SERVER_CONNECT, ALLOW_UNSAFE_LEGACY_RENEGOTIATION does not work - SSL bump, OpenSSL 3
</A></li>
        <LI>Next message (by thread): <A HREF="025526.html">[squid-users] LEGACY_SERVER_CONNECT, ALLOW_UNSAFE_LEGACY_RENEGOTIATION does not work - SSL bump, OpenSSL 3
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25525">[ date ]</a>
              <a href="thread.html#25525">[ thread ]</a>
              <a href="subject.html#25525">[ subject ]</a>
              <a href="author.html#25525">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 12/27/22 10:42, Amish wrote:
&gt;<i> On 26/12/22 21:31, Alex Rousskov wrote:
</I>&gt;&gt;<i> tls_outgoing_options options=0x4,0x40000
</I>
&gt;<i> With numeric hex values, I do not see the ERROR on stderr.
</I>
&gt;<i> But it still does not seem to be working as expected. Squid still does 
</I>&gt;<i> not open the page and gives same legacy negotiation error.
</I>
There are still many unknowns (from my point of view), including:

1. Does OpenSSL accept the above options? You ask that question below.
2. Does Squid indeed stare at the server, as expected?
3. Does Squid apply the accepted options when staring at the server?
4. Why does TLS negotiation fail despite those options applied,
    especially since it succeeds with using openssl s_client

Investigating the above (rough) questions may uncover more leads.


&gt;<i> How do I know that SSL_CTX_set_options() is working with above options?
</I>&gt;<i> There appears to be nothing in cache.log.
</I>
Squid does not check the outcome of the SSL_CTX_set_options() call. To 
be sure, one would need to either use a debugger or add debugging to 
Squid (quality patches welcome). The call is in 
Security::PeerOptions::updateContextOptions().


&gt;<i> $ tail -f /var/log/squid/cache.log |grep -i 'ssl\|tls'
</I>
FWIW, using this log snippet, I cannot quickly answer the other three 
questions . To make progress, I would either need to see a complete 
ALL,9 log (with a single problematic transaction[1]) or to reproduce the 
issue myself. Unfortunately, I currently do not have enough free time 
for that.

[1] 
<A HREF="https://wiki.squid-cache.org/SquidFaq/BugReporting#debugging-a-single-transaction">https://wiki.squid-cache.org/SquidFaq/BugReporting#debugging-a-single-transaction</A>


Sorry,

Alex.


&gt;<i> 2022/12/27 20:39:04.939 kid1| 83,3| client_side_request.cc(1557) 
</I>&gt;<i> sslBumpNeed: sslBump required: peek
</I>&gt;<i> 2022/12/27 20:39:05.920 kid1| 83,5| 
</I>&gt;<i> ../../src/security/PeerOptions.h(111) convertContextFromRawPtr: SSL_CTX 
</I>&gt;<i> construct, this=0x557039611e60
</I>&gt;<i> 2022/12/27 20:39:05.920 kid1| 83,5| Session.cc(103) NewSessionObject: 
</I>&gt;<i> SSL_new session=0x55703adcfd70
</I>&gt;<i> 2022/12/27 20:39:05.920 kid1| 83,5| Session.cc(161) CreateSession: link 
</I>&gt;<i> FD 12 to TLS session=0x55703adcfd70
</I>&gt;<i> 2022/12/27 20:39:05.920 kid1| 83,5| Io.cc(91) Handshake: -1/0 for TLS 
</I>&gt;<i> connection 0x55703adcfd70 over conn23909 local=127.0.0.1:8080 
</I>&gt;<i> remote=127.0.0.1:48458 FD 12 flags=1
</I>&gt;<i> 2022/12/27 20:39:05.927 kid1| 83,5| Session.cc(103) NewSessionObject: 
</I>&gt;<i> SSL_new session=0x557039a59050
</I>&gt;<i> 2022/12/27 20:39:05.927 kid1| 83,5| Session.cc(161) CreateSession: link 
</I>&gt;<i> FD 16 to TLS session=0x557039a59050
</I>&gt;<i> 2022/12/27 20:39:05.928 kid1| 83,5| Io.cc(91) Handshake: -1/11 for TLS 
</I>&gt;<i> connection 0x557039a59050 over conn23913 local=[2001:db8::2]:60020 
</I>&gt;<i> remote=[2405:200:1601:c0e1:49:40:8:183]:443 HIER_DIRECT FD 16 flags=1
</I>&gt;<i> 2022/12/27 20:39:06.062 kid1| 83,5| Io.cc(91) Handshake: -1/0 for TLS 
</I>&gt;<i> connection 0x557039a59050 over conn23913 local=[2001:db8::2]:60020 
</I>&gt;<i> remote=[2405:200:1601:c0e1:49:40:8:183]:443 HIER_DIRECT FD 16 flags=1
</I>&gt;<i> 2022/12/27 20:39:06.062 kid1| 83,5| Io.cc(91) Handshake: -1/0 for TLS 
</I>&gt;<i> connection 0x557039a59050 over conn23913 local=[2001:db8::2]:60020 
</I>&gt;<i> remote=[2405:200:1601:c0e1:49:40:8:183]:443 HIER_DIRECT FD 16 flags=1
</I>&gt;<i> 2022/12/27 20:39:06.063 kid1| 83,5| Io.cc(91) Handshake: -1/0 for TLS 
</I>&gt;<i> connection 0x557039a59050 over conn23913 local=[2001:db8::2]:60020 
</I>&gt;<i> remote=[2405:200:1601:c0e1:49:40:8:183]:443 HIER_DIRECT FD 16 flags=1
</I>&gt;<i> 2022/12/27 20:39:06.063 kid1| 83,2| PeerConnector.cc(256) 
</I>&gt;<i> handleNegotiationResult: ERROR: failure while establishing TLS 
</I>&gt;<i> connection on FD: 160x55703a2d9e40*1
</I>&gt;<i> 2022/12/27 20:39:06.063 kid1| 83,5| NegotiationHistory.cc(85) 
</I>&gt;<i> retrieveNegotiatedInfo: SSL connection info on FD 16 SSL version 
</I>&gt;<i> NONE/0.0 negotiated cipher
</I>&gt;<i> 2022/12/27 20:39:06.063 kid1| 83,5| PeerConnector.cc(540) callBack: TLS 
</I>&gt;<i> setup ended for
</I>&gt;<i> 2022/12/27 20:39:06.069 kid1| 83,5| Session.cc(103) NewSessionObject: 
</I>&gt;<i> SSL_new session=0x557039779b10
</I>&gt;<i> 2022/12/27 20:39:06.069 kid1| 83,5| Session.cc(161) CreateSession: link 
</I>&gt;<i> FD 16 to TLS session=0x557039779b10
</I>&gt;<i> 2022/12/27 20:39:06.070 kid1| 83,5| Io.cc(91) Handshake: -1/11 for TLS 
</I>&gt;<i> connection 0x557039779b10 over conn23916 local=192.168.0.2:54084 
</I>&gt;<i> remote=49.40.8.180:443 HIER_DIRECT FD 16 flags=1
</I>&gt;<i> 2022/12/27 20:39:06.191 kid1| 83,5| Io.cc(91) Handshake: -1/0 for TLS 
</I>&gt;<i> connection 0x557039779b10 over conn23916 local=192.168.0.2:54084 
</I>&gt;<i> remote=49.40.8.180:443 HIER_DIRECT FD 16 flags=1
</I>&gt;<i> 2022/12/27 20:39:06.192 kid1| 83,5| Io.cc(91) Handshake: -1/0 for TLS 
</I>&gt;<i> connection 0x557039779b10 over conn23916 local=192.168.0.2:54084 
</I>&gt;<i> remote=49.40.8.180:443 HIER_DIRECT FD 16 flags=1
</I>&gt;<i> 2022/12/27 20:39:06.193 kid1| 83,5| Io.cc(91) Handshake: -1/0 for TLS 
</I>&gt;<i> connection 0x557039779b10 over conn23916 local=192.168.0.2:54084 
</I>&gt;<i> remote=49.40.8.180:443 HIER_DIRECT FD 16 flags=1
</I>&gt;<i> 2022/12/27 20:39:06.193 kid1| 83,2| PeerConnector.cc(256) 
</I>&gt;<i> handleNegotiationResult: ERROR: failure while establishing TLS 
</I>&gt;<i> connection on FD: 160x55703a2d9e40*1
</I>&gt;<i> 2022/12/27 20:39:06.193 kid1| 83,5| NegotiationHistory.cc(85) 
</I>&gt;<i> retrieveNegotiatedInfo: SSL connection info on FD 16 SSL version 
</I>&gt;<i> NONE/0.0 negotiated cipher
</I>&gt;<i> 2022/12/27 20:39:06.193 kid1| 83,5| PeerConnector.cc(540) callBack: TLS 
</I>&gt;<i> setup ended for
</I>&gt;<i> 2022/12/27 20:39:06.193 kid1| 83,5| Session.cc(100) operator(): SSL_free 
</I>&gt;<i> session=0x557039779b10
</I>&gt;<i> 2022/12/27 20:39:06.236 kid1| 83,5| Io.cc(91) Handshake: -1/11 for TLS 
</I>&gt;<i> connection 0x55703adcfd70 over conn23909 local=127.0.0.1:8080 
</I>&gt;<i> remote=127.0.0.1:48458 FD 12 flags=1
</I>&gt;<i> 2022/12/27 20:39:06.247 kid1| 83,5| Io.cc(91) Handshake: -1/11 for TLS 
</I>&gt;<i> connection 0x55703adcfd70 over conn23909 local=127.0.0.1:8080 
</I>&gt;<i> remote=127.0.0.1:48458 FD 12 flags=1
</I>&gt;<i> 2022/12/27 20:39:06.254 kid1| 83,5| Session.cc(292) store_session_cb: 
</I>&gt;<i> Request to store SSL_SESSION
</I>&gt;<i> 2022/12/27 20:39:06.254 kid1| 83,5| Session.cc(314) store_session_cb: 
</I>&gt;<i> wrote an SSL_SESSION entry of size 129 at pos 129
</I>&gt;<i> 2022/12/27 20:39:06.254 kid1| 83,5| Session.cc(292) store_session_cb: 
</I>&gt;<i> Request to store SSL_SESSION
</I>&gt;<i> 2022/12/27 20:39:06.254 kid1| 83,5| Session.cc(314) store_session_cb: 
</I>&gt;<i> wrote an SSL_SESSION entry of size 128 at pos 80
</I>&gt;<i> 2022/12/27 20:39:06.255 kid1| 83,5| Io.cc(91) Handshake: 1/0 for TLS 
</I>&gt;<i> connection 0x55703adcfd70 over conn23909 local=127.0.0.1:8080 
</I>&gt;<i> remote=127.0.0.1:48458 FD 12 flags=1
</I>&gt;<i> -----BEGIN SSL SESSION PARAMETERS-----
</I>&gt;<i> -----END SSL SESSION PARAMETERS-----
</I>&gt;<i> 2022/12/27 20:39:06.255 kid1| 83,2| client_side.cc(2460) 
</I>&gt;<i> clientNegotiateSSL: New session 0x55703abd32f0 on FD 12 (127.0.0.1:48458)
</I>&gt;<i> 2022/12/27 20:39:06.255 kid1| 83,5| NegotiationHistory.cc(85) 
</I>&gt;<i> retrieveNegotiatedInfo: SSL connection info on FD 12 SSL version TLS/1.3 
</I>&gt;<i> negotiated cipher TLS_AES_256_GCM_SHA384
</I>&gt;<i> 2022/12/27 20:39:06.255 kid1| 83,5| client_side.cc(2483) 
</I>&gt;<i> clientNegotiateSSL: FD 12 has no client certificate.
</I>&gt;<i> 2022/12/27 20:39:06.255 kid1| 83,3| Session.cc(36) tls_read_method: 
</I>&gt;<i> started for session=0x55703adcfd70
</I>&gt;<i> 2022/12/27 20:39:06.256 kid1| 83,3| Session.cc(73) tls_write_method: 
</I>&gt;<i> started for session=0x55703adcfd70
</I>&gt;<i> 2022/12/27 20:39:06.256 kid1| 83,3| Session.cc(73) tls_write_method: 
</I>&gt;<i> started for session=0x55703adcfd70
</I>&gt;<i> 2022/12/27 20:39:06.257 kid1| 83,5| Session.cc(100) operator(): SSL_free 
</I>&gt;<i> session=0x557039a59050
</I>&gt;<i> 2022/12/27 20:39:06.257 kid1| 83,5| Session.cc(100) operator(): SSL_free 
</I>&gt;<i> session=0x55703adcfd70
</I>&gt;<i> 2022/12/27 20:39:06.257 kid1| 83,5| 
</I>&gt;<i> ../../src/security/PeerOptions.h(113) operator(): SSL_CTX destruct, 
</I>&gt;<i> this=0x557039611e60
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Any idea on how do I know if SSL_CTX_set_options() is working with 
</I>&gt;<i> legacy negotiations enabled?
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> [1] <A HREF="https://wiki.openssl.org/index.php/List_of_SSL_OP_Flags">https://wiki.openssl.org/index.php/List_of_SSL_OP_Flags</A>
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Above link should be placed in tls_outgoing_options documentation at 
</I>&gt;<i> <A HREF="http://www.squid-cache.org/Doc/config/tls_outgoing_options/">http://www.squid-cache.org/Doc/config/tls_outgoing_options/</A>
</I>&gt;<i> 
</I>&gt;<i> Additionally a NOTE should be placed stating that it supports HEX values.
</I>&gt;<i> 
</I>&gt;<i> Current documentation gives an impression that I can use all the named 
</I>&gt;<i> options supported by OpenSSL. But in reality only selected named options 
</I>&gt;<i> are supported.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> [2] The table provides numerical values for OpenSSL v1 options. For 
</I>&gt;&gt;<i> OpenSSL v3, the table provides a SSL_OP_BIT(n) formula: 2 to the power 
</I>&gt;&gt;<i> of n. For example, SSL_OP_BIT(2) is, in hex notation, 0x4.
</I>&gt;&gt;<i> &#160;&#160;&#160; #define SSL_OP_BIT(n)&#160; ((uint64_t)1 &lt;&lt; (uint64_t)n)
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> HTH,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Alex.
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> # other related TLS related settings
</I>&gt;&gt;&gt;<i> tls_outgoing_options cafile=/etc/ssl/cert.pem
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> tls_outgoing_options 
</I>&gt;&gt;&gt;<i> cipher=ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA:ECDHE-RSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA:DHE-RSA-AES256-SHA256:DHE-RSA-AES256-SHA:ECDHE-ECDSA-DES-CBC3-SHA:ECDHE-RSA-DES-CBC3-SHA:EDH-RSA-DES-CBC3-SHA:AES128-GCM-SHA256:AES256-GCM-SHA384:AES128-SHA256:AES256-SHA256:AES128-SHA:AES256-SHA:DES-CBC3-SHA:!DSS
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> # systemctl reload squid
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> But I am still getting the same error when trying to connect to the 
</I>&gt;&gt;&gt;<i> above site via squid proxy. (Works fine without proxy)
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> What am I doing wrong?
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Tips / help appreciated,
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Thank you,
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Amish.
</I>&gt;<i> 
</I>&gt;<i> Thank you
</I>&gt;<i> 
</I>&gt;<i> Amish.
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="025524.html">[squid-users] LEGACY_SERVER_CONNECT, ALLOW_UNSAFE_LEGACY_RENEGOTIATION does not work - SSL bump, OpenSSL 3
</A></li>
	<LI>Next message (by thread): <A HREF="025526.html">[squid-users] LEGACY_SERVER_CONNECT, ALLOW_UNSAFE_LEGACY_RENEGOTIATION does not work - SSL bump, OpenSSL 3
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25525">[ date ]</a>
              <a href="thread.html#25525">[ thread ]</a>
              <a href="subject.html#25525">[ subject ]</a>
              <a href="author.html#25525">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
