<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] LEGACY_SERVER_CONNECT, ALLOW_UNSAFE_LEGACY_RENEGOTIATION does not work - SSL bump, OpenSSL 3
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20LEGACY_SERVER_CONNECT%2C%0A%20ALLOW_UNSAFE_LEGACY_RENEGOTIATION%20does%20not%20work%20-%20SSL%20bump%2C%20OpenSSL%203&In-Reply-To=%3Cd447614e-7a22-0969-0257-46095df48c51%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="025526.html">
   <LINK REL="Next"  HREF="025528.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] LEGACY_SERVER_CONNECT, ALLOW_UNSAFE_LEGACY_RENEGOTIATION does not work - SSL bump, OpenSSL 3</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20LEGACY_SERVER_CONNECT%2C%0A%20ALLOW_UNSAFE_LEGACY_RENEGOTIATION%20does%20not%20work%20-%20SSL%20bump%2C%20OpenSSL%203&In-Reply-To=%3Cd447614e-7a22-0969-0257-46095df48c51%40measurement-factory.com%3E"
       TITLE="[squid-users] LEGACY_SERVER_CONNECT, ALLOW_UNSAFE_LEGACY_RENEGOTIATION does not work - SSL bump, OpenSSL 3">rousskov at measurement-factory.com
       </A><BR>
    <I>Wed Dec 28 16:01:00 UTC 2022</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="025526.html">[squid-users] LEGACY_SERVER_CONNECT, ALLOW_UNSAFE_LEGACY_RENEGOTIATION does not work - SSL bump, OpenSSL 3
</A></li>
        <LI>Next message (by thread): <A HREF="025528.html">[squid-users] LEGACY_SERVER_CONNECT, ALLOW_UNSAFE_LEGACY_RENEGOTIATION does not work - SSL bump, OpenSSL 3
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25527">[ date ]</a>
              <a href="thread.html#25527">[ thread ]</a>
              <a href="subject.html#25527">[ subject ]</a>
              <a href="author.html#25527">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Amish,

     Squid parsing code is tricky. tls_outgoing_options parsing code is 
triply so. Even its authors misinterpret it!

I assume you have removed multiple tls_outgoing_options directives from 
your configuration before testing. If you have not, please merge those 
directives into one and retest. You should still see multiple parsing 
paths, in part, due to (unfortunate) Security::PeerOptions 
implementation and, in part, due to Squid parsing default options before 
Squid parses your actual configuration files.


If merging directives does not deliver custom options to 
SSL_CTX_set_options(), then let's attack this from the other end: Supply 
the right options to each SSL_CTX_set_options() call:

     const Security::ParsedOptions forcedParsedOptions = 0x4 | 0x40000;
     SSL_CTX_set_options(ctx.get(), forcedParsedOptions);

Does the above temporary hack fix the problem in your test?


Thank you,

Alex.



On 12/28/22 02:32, Amish wrote:
&gt;<i> Hi Alex,
</I>&gt;<i> 
</I>&gt;<i> Thanks again for your reply.
</I>&gt;<i> 
</I>&gt;<i> To find answers to your questions, I added few debugs() lines to 
</I>&gt;<i> PeerOptions.cc.
</I>&gt;<i> 
</I>&gt;<i> The diff file (patch) is attached.
</I>&gt;<i> 
</I>&gt;<i> It prints parsedOptions and options retrieved from SSL context and 
</I>&gt;<i> session objects at several stages.
</I>&gt;<i> 
</I>&gt;<i> Here is tls_outgoing_options setting:
</I>&gt;<i> 
</I>&gt;<i> $ grep tls_outgoing_options /etc/squid/squid.conf
</I>&gt;<i> tls_outgoing_options \
</I>&gt;<i>  &#160;&#160;&#160; cafile=/etc/ssl/cert.pem \
</I>&gt;<i> cipher=ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA:ECDHE-RSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA:DHE-RSA-AES256-SHA256:DHE-RSA-AES256-SHA:ECDHE-ECDSA-DES-CBC3-SHA:ECDHE-RSA-DES-CBC3-SHA:EDH-RSA-DES-CBC3-SHA:AES128-GCM-SHA256:AES256-GCM-SHA384:AES128-SHA256:AES256-SHA256:AES128-SHA:AES256-SHA:DES-CBC3-SHA:!DSS \
</I>&gt;<i>  &#160;&#160;&#160; options=0x4
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Here is what squid logs on reload i.e. on parsing the squid.conf
</I>&gt;<i> 
</I>&gt;<i> $ systemctl reload squid
</I>&gt;<i> $ tail -f /var/log/squid/cache.log&#160; |grep -i 'openssl\|parsed'
</I>&gt;<i> 2022/12/28 12:19:30.596 kid1| 83,5| PeerOptions.cc(547) parseOptions: INFO: TLS parsedOptions(3)=0
</I>&gt;<i> 2022/12/28 12:19:30.598 kid1| 83,5| PeerOptions.cc(547) parseOptions: INFO: TLS parsedOptions(3)=0
</I>&gt;<i> 2022/12/28 12:19:30.723 kid1| 83,5| PeerOptions.cc(547) parseOptions: INFO: TLS parsedOptions(3)=4
</I>&gt;<i> 2022/12/28 12:19:30.729 kid1| 83,5| PeerOptions.cc(547) parseOptions: INFO: TLS parsedOptions(3)=0
</I>&gt;<i> 2022/12/28 12:19:30.729 kid1| 83,5| PeerOptions.cc(547) parseOptions: INFO: TLS parsedOptions(3)=0
</I>&gt;<i> 2022/12/28 12:19:32.147 kid1| 83,5| PeerOptions.cc(447) parseOptions: INFO: TLS parsedOptions(1)=0
</I>&gt;<i> 2022/12/28 12:19:32.147 kid1| 83,5| PeerOptions.cc(547) parseOptions: INFO: TLS parsedOptions(3)=0
</I>&gt;<i> 2022/12/28 12:19:33.524 kid1| 83,5| PeerOptions.cc(447) parseOptions: INFO: TLS parsedOptions(1)=0
</I>&gt;<i> 2022/12/28 12:19:33.532 kid1| 83,5| PeerOptions.cc(547) parseOptions: INFO: TLS parsedOptions(3)=0
</I>&gt;<i> 2022/12/28 12:19:33.695 kid1| 83,5| PeerOptions.cc(447) parseOptions: INFO: TLS parsedOptions(1)=0
</I>&gt;<i> 2022/12/28 12:19:33.695 kid1| 83,5| PeerOptions.cc(643) updateContextOptions: set OpenSSL options for context=0x562a5387fe30, parsedOptions=0
</I>&gt;<i> 2022/12/28 12:19:33.695 kid1| 83,5| PeerOptions.cc(645) updateContextOptions: get OpenSSL options for context=0x562a5387fe30, getOptions=1179648
</I>
&gt;<i> 2022/12/28 12:19:33.708 kid1| 83,5| PeerOptions.cc(447) parseOptions: INFO: TLS parsedOptions(1)=0
</I>&gt;<i> 2022/12/28 12:19:33.708 kid1| 83,5| PeerOptions.cc(643) updateContextOptions: set OpenSSL options for context=0x562a53e6e740, parsedOptions=0
</I>&gt;<i> 2022/12/28 12:19:33.708 kid1| 83,5| PeerOptions.cc(645) 
</I>&gt;<i> updateContextOptions: get OpenSSL options for context=0x562a53e6e740, 
</I>&gt;<i> getOptions=1179648
</I>&gt;<i> 
</I>&gt;<i> It seems that squid parses the options multiple times and only once it 
</I>&gt;<i> gets the value as 4. Rest are parsed as 0.
</I>&gt;<i> 
</I>&gt;<i> The value of 1179648 (0x120000) corresponds to SSL_OP_NO_COMPRESSION 
</I>&gt;<i> (0x20000) and SSL_OP_ENABLE_MIDDLEBOX_COMPAT. (0x100000)
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Now lets reproduce the issue:
</I>&gt;<i> 
</I>&gt;<i> $ curl --no-progress-meter -kx 127.0.0.1:8080 <A HREF="https://www.jio.com">https://www.jio.com</A> |grep 
</I>&gt;<i> 'TLS\|SSL'
</I>&gt;<i> &lt;pre&gt;[No Error] (TLS code: 
</I>&gt;<i> SQUID_TLS_ERR_CONNECT+TLS_LIB_ERR=A000152+TLS_IO_ERR=1)&lt;/pre&gt;
</I>&gt;<i> &lt;p&gt;Failed to establish a secure connection: error:0A000152:SSL 
</I>&gt;<i> routines::unsafe legacy renegotiation disabled&lt;/p&gt;
</I>&gt;<i> 
</I>&gt;<i> So, as we can see, we are still not able to access the site.
</I>&gt;<i> 
</I>&gt;<i> Lets see what cache.log has to say.
</I>&gt;<i> 
</I>&gt;<i> $ tail -f /var/log/squid/cache.log&#160; |grep -i 'openssl\|parsed'
</I>&gt;<i> 2022/12/28 12:31:09.971 kid1| 83,5| PeerOptions.cc(447) parseOptions: 
</I>&gt;<i> INFO: TLS parsedOptions(1)=0
</I>&gt;<i> 2022/12/28 12:31:09.971 kid1| 83,5| PeerOptions.cc(643) 
</I>&gt;<i> updateContextOptions: set OpenSSL options for context=0x562a53eb14e0, 
</I>&gt;<i> parsedOptions=0
</I>&gt;<i> 2022/12/28 12:31:09.971 kid1| 83,5| PeerOptions.cc(645) 
</I>&gt;<i> updateContextOptions: get OpenSSL options for context=0x562a53eb14e0, 
</I>&gt;<i> getOptions=1179648
</I>&gt;<i> 
</I>&gt;<i> Strangely parsedOptions was zero and not 4!
</I>&gt;<i> 
</I>&gt;<i> Now we can answer your questions as below.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> On 27/12/22 21:52, Alex Rousskov wrote:
</I>&gt;&gt;<i> On 12/27/22 10:42, Amish wrote:
</I>&gt;&gt;&gt;<i> On 26/12/22 21:31, Alex Rousskov wrote:
</I>&gt;&gt;&gt;&gt;<i> tls_outgoing_options options=0x4,0x40000
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> With numeric hex values, I do not see the ERROR on stderr.
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> But it still does not seem to be working as expected. Squid still 
</I>&gt;&gt;&gt;<i> does not open the page and gives same legacy negotiation error.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> There are still many unknowns (from my point of view), including:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> 1. Does OpenSSL accept the above options? You ask that question below.
</I>&gt;<i> 
</I>&gt;<i> Google search shows some projects using OpenSSL v3 where there is 
</I>&gt;<i> mention to use above option when a similar error occurred to them.
</I>&gt;<i> 
</I>&gt;<i> But in our case, its clear that squid does not pass value 4 to SSL 
</I>&gt;<i> context, hence we do not know yet if OpenSSL accepts above options.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> 2. Does Squid indeed stare at the server, as expected?
</I>&gt;&gt;<i> 3. Does Squid apply the accepted options when staring at the server?
</I>&gt;<i> 
</I>&gt;<i> A comment for parseOptions() in PeerOptions.cc states this:
</I>&gt;<i> 
</I>&gt;<i> /**
</I>&gt;<i>  &#160;* Pre-parse TLS options= parameter to be applied when the TLS objects 
</I>&gt;<i> created.
</I>&gt;<i>  &#160;* Options must not used in the case of peek or stare bump mode.
</I>&gt;<i>  &#160;*/
</I>&gt;<i> void Security::PeerOptions::parseOptions()
</I>&gt;<i> 
</I>&gt;<i> So it appears that TLS options is NOT used for peek as well as stare. 
</I>&gt;<i> But why? I am not sure.
</I>&gt;<i> 
</I>&gt;<i> How do I make squid use it for 'stare' atleast?
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> 4. Why does TLS negotiation fail despite those options applied,
</I>&gt;&gt;<i> &#160;&#160; especially since it succeeds with using openssl s_client
</I>&gt;<i> 
</I>&gt;<i> It possibly fails because options are not applied by squid.
</I>&gt;<i> 
</I>&gt;<i> So, where do I check next on why parsedOptions is still set to 0 and why 
</I>&gt;<i> its not used for 'stare'?
</I>&gt;<i> 
</I>&gt;<i> Thanks and regards,
</I>&gt;<i> 
</I>&gt;<i> Amish.
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="025526.html">[squid-users] LEGACY_SERVER_CONNECT, ALLOW_UNSAFE_LEGACY_RENEGOTIATION does not work - SSL bump, OpenSSL 3
</A></li>
	<LI>Next message (by thread): <A HREF="025528.html">[squid-users] LEGACY_SERVER_CONNECT, ALLOW_UNSAFE_LEGACY_RENEGOTIATION does not work - SSL bump, OpenSSL 3
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25527">[ date ]</a>
              <a href="thread.html#25527">[ thread ]</a>
              <a href="subject.html#25527">[ subject ]</a>
              <a href="author.html#25527">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
