<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] LEGACY_SERVER_CONNECT, ALLOW_UNSAFE_LEGACY_RENEGOTIATION does not work - SSL bump, OpenSSL 3
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20LEGACY_SERVER_CONNECT%2C%0A%20ALLOW_UNSAFE_LEGACY_RENEGOTIATION%20does%20not%20work%20-%20SSL%20bump%2C%20OpenSSL%203&In-Reply-To=%3Cd0fc0698-f750-4f34-fdc1-3af163b47cae%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="025530.html">
   <LINK REL="Next"  HREF="025532.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] LEGACY_SERVER_CONNECT, ALLOW_UNSAFE_LEGACY_RENEGOTIATION does not work - SSL bump, OpenSSL 3</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20LEGACY_SERVER_CONNECT%2C%0A%20ALLOW_UNSAFE_LEGACY_RENEGOTIATION%20does%20not%20work%20-%20SSL%20bump%2C%20OpenSSL%203&In-Reply-To=%3Cd0fc0698-f750-4f34-fdc1-3af163b47cae%40measurement-factory.com%3E"
       TITLE="[squid-users] LEGACY_SERVER_CONNECT, ALLOW_UNSAFE_LEGACY_RENEGOTIATION does not work - SSL bump, OpenSSL 3">rousskov at measurement-factory.com
       </A><BR>
    <I>Thu Dec 29 02:44:33 UTC 2022</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="025530.html">[squid-users] LEGACY_SERVER_CONNECT, ALLOW_UNSAFE_LEGACY_RENEGOTIATION does not work - SSL bump, OpenSSL 3
</A></li>
        <LI>Next message (by thread): <A HREF="025532.html">[squid-users] LEGACY_SERVER_CONNECT, ALLOW_UNSAFE_LEGACY_RENEGOTIATION does not work - SSL bump, OpenSSL 3
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25531">[ date ]</a>
              <a href="thread.html#25531">[ thread ]</a>
              <a href="subject.html#25531">[ subject ]</a>
              <a href="author.html#25531">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Amish,

     Thank you for updating test results. I have a working theory: 
Staring SslBump disregards parsed tcp_outgoing_options since commit 
f233022. That commit message explains why tcp_outgoing_options should be 
ignored when peeking at the server. The message does not explain why 
_staring_ mode got penalized as well, but I suspect that Squid had only 
one context to use for both modes, so staring mode had to follow the 
peeking code lead...

You can test that theory by replacing &quot;false&quot; with &quot;true&quot; in 
Security::ProxyOutgoingConfig.createClientContext(false) call inside 
configDoConfigure(). Needless to say, doing so may break SslBump 
peeking, but at least we will know that the theory is correct.


HTH,

Alex.


On 12/28/22 20:22, Amish wrote:
&gt;<i> Hi Alex,
</I>&gt;<i> 
</I>&gt;<i> Thank you once again!
</I>&gt;<i> 
</I>&gt;<i> See replies inline below.
</I>&gt;<i> 
</I>&gt;<i> On 28/12/22 22:57, Alex Rousskov wrote:
</I>&gt;&gt;<i> Hi Amish,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &#160;&#160;&#160; TLS options are used on _both_ sides, in various cases, but there 
</I>&gt;&gt;<i> are still too many unknowns, and I cannot quickly answer all of your 
</I>&gt;&gt;<i> questions at once. Sorry. I can only guide you one step at a time.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> * If you are sure that SSL_CTX_set_options() is not called when 
</I>&gt;&gt;<i> talking to the origin server in your setup, then there is no need to 
</I>&gt;&gt;<i> hard-code those options. Instead, we need to figure out why Squid does 
</I>&gt;&gt;<i> not call SSL_CTX_set_options(). The best next step is to configure 
</I>&gt;&gt;<i> your Squid with the following ssl_bump rules and check whether 
</I>&gt;&gt;<i> SSL_CTX_set_options() is called for the Squid-server connection in 
</I>&gt;&gt;<i> that case. Sharing access.log records to double check that the origin 
</I>&gt;&gt;<i> server was contacted may be a good idea.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &#160;&#160;&#160; ssl_bump stare all
</I>&gt;&gt;<i> &#160;&#160;&#160; ssl_bump bump all
</I>&gt;<i> 
</I>&gt;<i> I have concluded that updateContextOptions() is not being called for 
</I>&gt;<i> squid to origin server as cache.log does not show any calls.
</I>&gt;<i> 
</I>&gt;<i> Here is how I concluded it.
</I>&gt;<i> 
</I>&gt;<i> $ cat /etc/squid/squid.conf
</I>&gt;<i> debug_options 83,6
</I>&gt;<i> ssl_bump stare all
</I>&gt;<i> ssl_bump bump all
</I>&gt;<i> 
</I>&gt;<i> tls_outgoing_options \
</I>&gt;<i>  &#160;&#160;&#160; cafile=/etc/ssl/cert.pem \
</I>&gt;<i> cipher=ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA:ECDHE-RSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA:DHE-RSA-AES256-SHA256:DHE-RSA-AES256-SHA:ECDHE-ECDSA-DES-CBC3-SHA:ECDHE-RSA-DES-CBC3-SHA:EDH-RSA-DES-CBC3-SHA:AES128-GCM-SHA256:AES256-GCM-SHA384:AES128-SHA256:AES256-SHA256:AES128-SHA:AES256-SHA:DES-CBC3-SHA:!DSS \
</I>&gt;<i>  &#160;&#160;&#160; options=0x40000
</I>&gt;<i> 
</I>&gt;<i> http_port 3128 intercept
</I>&gt;<i> http_port 8080 ssl-bump generate-host-certificates=on 
</I>&gt;<i> tls-cert=/etc/squid/ssl_cert/squid.pem 
</I>&gt;<i> tls-dh=/etc/squid/ssl_cert/dhparam.pem options=0x4
</I>&gt;<i> https_port 8081 intercept ssl-bump generate-host-certificates=on 
</I>&gt;<i> tls-cert=/etc/squid/ssl_cert/squid.pem 
</I>&gt;<i> tls-dh=/etc/squid/ssl_cert/dhparam.pem options=0x4
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Note that I have kept different options. 0x40000 for 
</I>&gt;<i> tcp_outgoing_options and 0x4 for http(s)_port.
</I>&gt;<i> 
</I>&gt;<i> $ systemctl reload squid
</I>&gt;<i> $ curl --no-progress-meter -kx 127.0.0.1:8080 
</I>&gt;<i> '<A HREF="https://www.jio.com/?foo=bar">https://www.jio.com/?foo=bar</A>'
</I>&gt;<i> $ tail -f /var/log/squid/cache.log&#160; |grep -i 'openssl\|parsed'
</I>&gt;<i> 2022/12/29 06:13:04.182 kid1| 83,5| PeerOptions.cc(447) parseOptions: 
</I>&gt;<i> INFO: TLS parsedOptions(1)=4
</I>&gt;<i> 2022/12/29 06:13:04.182 kid1| 83,5| PeerOptions.cc(643) 
</I>&gt;<i> updateContextOptions: set OpenSSL options for context=0x559210db6b20, 
</I>&gt;<i> parsedOptions=4
</I>&gt;<i> 2022/12/29 06:13:04.182 kid1| 83,5| PeerOptions.cc(645) 
</I>&gt;<i> updateContextOptions: get OpenSSL options for context=0x559210db6b20, 
</I>&gt;<i> getOptions=1179652
</I>&gt;<i> 
</I>&gt;<i> parsedOptions is 4 which squid picked up from http_port line.
</I>&gt;<i> 
</I>&gt;<i> $ tail -f /var/log/squid/access.log
</I>&gt;<i> 1672274753.787&#160;&#160; 1290 127.0.0.1 NONE_NONE/200 0 CONNECT www.jio.com:443 
</I>&gt;<i> local HIER_NONE/- -
</I>&gt;<i> 1672274753.789&#160;&#160;&#160;&#160;&#160; 0 127.0.0.1 NONE_NONE/503 4343 GET 
</I>&gt;<i> <A HREF="https://www.jio.com/?foo=bar">https://www.jio.com/?foo=bar</A> - HIER_NONE/- text/html
</I>&gt;<i> 
</I>&gt;<i> SSL Bumping is working fine as squid is able to find full HTTPS URL 
</I>&gt;<i> including CGI parameters.
</I>&gt;<i> 
</I>&gt;<i> But just to double check that SSL bumping is working fine, we try 
</I>&gt;<i> accessing Google:
</I>&gt;<i> 
</I>&gt;<i> $ curl --no-progress-meter -kx 127.0.0.1:8080 '<A HREF="https://google.com/?foo=bar">https://google.com/?foo=bar</A>'
</I>&gt;<i> $ tail -f /var/log/squid/access.log
</I>&gt;<i> 1672274850.924&#160;&#160; 1120 127.0.0.1 NONE_NONE/200 0 CONNECT google.com:443 
</I>&gt;<i> local HIER_DIRECT/2404:6800:4009:81d::200e -
</I>&gt;<i> 1672274851.000&#160;&#160;&#160;&#160; 75 127.0.0.1 TCP_MISS/301 1041 GET 
</I>&gt;<i> <A HREF="https://google.com/?foo=bar">https://google.com/?foo=bar</A> local HIER_DIRECT/2404:6800:4009:81d::200e 
</I>&gt;<i> text/html
</I>&gt;<i> 
</I>&gt;<i> Google.com is accessed successfully and access.log also shows the same 
</I>&gt;<i> with full HTTPS URL.
</I>&gt;<i> 
</I>&gt;<i> Now I reversed the options. Setting the options as 0x4 for 
</I>&gt;<i> tcp_outgoing_options and 0x40000 for http(s)_port.
</I>&gt;<i> 
</I>&gt;<i> $ cat /etc/squid/squid.conf
</I>&gt;<i> tls_outgoing_options \
</I>&gt;<i> ...
</I>&gt;<i>  &#160;&#160;&#160; options=0x4
</I>&gt;<i> ...
</I>&gt;<i> http_port 8080 ssl-bump generate-host-certificates=on 
</I>&gt;<i> tls-cert=/etc/squid/ssl_cert/squid.pem 
</I>&gt;<i> tls-dh=/etc/squid/ssl_cert/dhparam.pem options=0x40000
</I>&gt;<i> https_port 8081 intercept ssl-bump generate-host-certificates=on 
</I>&gt;<i> tls-cert=/etc/squid/ssl_cert/squid.pem 
</I>&gt;<i> tls-dh=/etc/squid/ssl_cert/dhparam.pem options=0x40000
</I>&gt;<i> 
</I>&gt;<i> $ systemctl reload squid
</I>&gt;<i> $ curl --no-progress-meter -kx 127.0.0.1:8080 <A HREF="https://www.jio.com/?foo=bar">https://www.jio.com/?foo=bar</A>'
</I>&gt;<i> $ tail -f /var/log/squid/cache.log&#160; |grep -i 'openssl\|parsed'
</I>&gt;<i> 2022/12/29 06:29:30.106 kid1| 83,5| PeerOptions.cc(447) parseOptions: 
</I>&gt;<i> INFO: TLS parsedOptions(1)=262144
</I>&gt;<i> 2022/12/29 06:29:30.106 kid1| 83,5| PeerOptions.cc(643) 
</I>&gt;<i> updateContextOptions: set OpenSSL options for context=0x559211c674e0, 
</I>&gt;<i> parsedOptions=262144
</I>&gt;<i> 2022/12/29 06:29:30.106 kid1| 83,5| PeerOptions.cc(645) 
</I>&gt;<i> updateContextOptions: get OpenSSL options for context=0x559211c674e0, 
</I>&gt;<i> getOptions=1441792
</I>&gt;<i> 
</I>&gt;<i> Note: 262144 is 0x40000 = SSL_OP_ALLOW_UNSAFE_LEGACY_RENEGOTIATION.
</I>&gt;<i> And 1441792 is 0x160000 (i.e. 0x100000 = SSL_OP_ENABLE_MIDDLEBOX_COMPAT 
</I>&gt;<i> | 0x40000 | 0x20000 = SSL_OP_NO_COMPRESSION)
</I>&gt;<i> 
</I>&gt;<i> $ tail -f /var/log/squid/access.log
</I>&gt;<i> 1672275570.422&#160;&#160;&#160; 325 127.0.0.1 NONE_NONE/200 0 CONNECT www.jio.com:443 
</I>&gt;<i> local HIER_NONE/- -
</I>&gt;<i> 1672275570.423&#160;&#160;&#160;&#160;&#160; 0 127.0.0.1 NONE_NONE/503 4343 GET 
</I>&gt;<i> <A HREF="https://www.jio.com/?foo=bar">https://www.jio.com/?foo=bar</A> - HIER_NONE/- text/html
</I>&gt;<i> 
</I>&gt;<i> So from above two squid.conf settings we can conclude that 
</I>&gt;<i> updateContextOptions() and hence SSL_CTX_set_options() is getting called 
</I>&gt;<i> only for client to squid side of the connection and not squid to origin 
</I>&gt;<i> side of the connection.
</I>&gt;<i> 
</I>&gt;<i> Now we need to find, where the server side connection happens OR why 
</I>&gt;<i> updateContextOptions() is not called for squid to origin server 
</I>&gt;<i> connections.
</I>&gt;<i> 
</I>&gt;<i> Any idea?
</I>&gt;<i> 
</I>&gt;<i> Thanks and regards
</I>&gt;<i> 
</I>&gt;<i> Amish
</I>&gt;<i> 
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> * If you are not sure whether SSL_CTX_set_options() is called when 
</I>&gt;&gt;<i> talking to the origin server in your setup, then hard-coding those 
</I>&gt;&gt;<i> options may still be the best next step. If it fixes the problem, then 
</I>&gt;&gt;<i> we will be able to resolve a few variables without the test in the 
</I>&gt;&gt;<i> first bullet.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> HTH,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Alex.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> On 12/28/22 11:49, Amish wrote:
</I>&gt;&gt;&gt;<i> Hi Alex,
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> On 28/12/22 21:31, Alex Rousskov wrote:
</I>&gt;&gt;&gt;&gt;<i> Hi Amish,
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> &#160;&#160;&#160; Squid parsing code is tricky. tls_outgoing_options parsing code 
</I>&gt;&gt;&gt;&gt;<i> is triply so. Even its authors misinterpret it!
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> I assume you have removed multiple tls_outgoing_options directives 
</I>&gt;&gt;&gt;&gt;<i> from your configuration before testing. If you have not, please 
</I>&gt;&gt;&gt;&gt;<i> merge those directives into one and retest. You should still see 
</I>&gt;&gt;&gt;&gt;<i> multiple parsing paths, in part, due to (unfortunate) 
</I>&gt;&gt;&gt;&gt;<i> Security::PeerOptions implementation and, in part, due to Squid 
</I>&gt;&gt;&gt;&gt;<i> parsing default options before Squid parses your actual 
</I>&gt;&gt;&gt;&gt;<i> configuration files.
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Yes I had combined all tls_outgoing_options in to a single directive 
</I>&gt;&gt;&gt;<i> (but in multiple lines ending with a backslash \). It can be seen in 
</I>&gt;&gt;&gt;<i> the grep command in my previous email.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> But wait, I have found something.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> And I have a doubt that parsedOptions work only for client to squid 
</I>&gt;&gt;&gt;<i> side of the connection and does not work for squid to server side of 
</I>&gt;&gt;&gt;<i> the connection.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> What I did is changed my &quot;http(s)_port&quot; directives to include 
</I>&gt;&gt;&gt;<i> options=0x4. These directives control options for the client to squid 
</I>&gt;&gt;&gt;<i> side of TLS connection.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> $ grep 'ssl-bump' /etc/squid/squid.conf
</I>&gt;&gt;&gt;<i> http_port 8080 ssl-bump generate-host-certificates=on 
</I>&gt;&gt;&gt;<i> tls-cert=/etc/squid/ssl_cert/squid.pem 
</I>&gt;&gt;&gt;<i> tls-dh=/etc/squid/ssl_cert/dhparam.pem options=0x4
</I>&gt;&gt;&gt;<i> https_port 8081 intercept ssl-bump generate-host-certificates=on 
</I>&gt;&gt;&gt;<i> tls-cert=/etc/squid/ssl_cert/squid.pem 
</I>&gt;&gt;&gt;<i> tls-dh=/etc/squid/ssl_cert/dhparam.pem options=0x4
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Now lets reproduce the issue:
</I>&gt;&gt;&gt;<i> $ curl --no-progress-meter -kx 127.0.0.1:8080 <A HREF="https://www.jio.com">https://www.jio.com</A> 
</I>&gt;&gt;&gt;<i> |grep 'TLS\|SSL'
</I>&gt;&gt;&gt;<i> &lt;pre&gt;[No Error] (TLS code: 
</I>&gt;&gt;&gt;<i> SQUID_TLS_ERR_CONNECT+TLS_LIB_ERR=A000152+TLS_IO_ERR=1)&lt;/pre&gt;
</I>&gt;&gt;&gt;<i> &lt;p&gt;Failed to establish a secure connection: error:0A000152:SSL 
</I>&gt;&gt;&gt;<i> routines::unsafe legacy renegotiation disabled&lt;/p&gt;
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Lets see what cache.log has to say:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> $ tail -f /var/log/squid/cache.log&#160; |grep -i 'openssl\|parsed'
</I>&gt;&gt;&gt;<i> 2022/12/28 21:52:56.532 kid1| 83,5| PeerOptions.cc(447) parseOptions: 
</I>&gt;&gt;&gt;<i> INFO: TLS parsedOptions(1)=4
</I>&gt;&gt;&gt;<i> 2022/12/28 21:52:56.532 kid1| 83,5| PeerOptions.cc(643) 
</I>&gt;&gt;&gt;<i> updateContextOptions: set OpenSSL options for context=0x559075043e30, 
</I>&gt;&gt;&gt;<i> parsedOptions=4
</I>&gt;&gt;&gt;<i> 2022/12/28 21:52:56.532 kid1| 83,5| PeerOptions.cc(645) 
</I>&gt;&gt;&gt;<i> updateContextOptions: get OpenSSL options for context=0x559075043e30, 
</I>&gt;&gt;&gt;<i> getOptions=1179652
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Bingo!! As we can see, parsedOptions is now set to 4!
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> And it is also confirmed by ssl_get_options() - 1179652&#160; = 0x120004 
</I>&gt;&gt;&gt;<i> (4 means the option is accepted by OpenSSL too)
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> But this also means that updateContextOptions() is called ONLY FOR 
</I>&gt;&gt;&gt;<i> client to squid side (curl to squid) and it is not called for squid 
</I>&gt;&gt;&gt;<i> to server (jio.com in this case) side.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> The reason being that we do not see updateContextOptions() being 
</I>&gt;&gt;&gt;<i> called twice for a request. But only once. And that is why request 
</I>&gt;&gt;&gt;<i> still fails with the negotiation error.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> So where exactly is the call for squid to server side being made?
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> If merging directives does not deliver custom options to 
</I>&gt;&gt;&gt;&gt;<i> SSL_CTX_set_options(), then let's attack this from the other end: 
</I>&gt;&gt;&gt;&gt;<i> Supply the right options to each SSL_CTX_set_options() call:
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> &#160;&#160;&#160; const Security::ParsedOptions forcedParsedOptions = 0x4 | 0x40000;
</I>&gt;&gt;&gt;&gt;<i> &#160;&#160;&#160; SSL_CTX_set_options(ctx.get(), forcedParsedOptions);
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> Does the above temporary hack fix the problem in your test?
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> I will try this tomorrow (its late night here).
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> But I think I will have to set this somewhere else and NOT in 
</I>&gt;&gt;&gt;<i> PeerOptions.cc. Because above code appears to be for client to squid 
</I>&gt;&gt;&gt;<i> side.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> And I need to add forcedParsedOptions to the code which connects 
</I>&gt;&gt;&gt;<i> squid to server. But where?
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Thank you,
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Amish.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> Thank you,
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> Alex.
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> On 12/28/22 02:32, Amish wrote:
</I>&gt;&gt;&gt;&gt;&gt;<i> Hi Alex,
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> Thanks again for your reply.
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> To find answers to your questions, I added few debugs() lines to 
</I>&gt;&gt;&gt;&gt;&gt;<i> PeerOptions.cc.
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> The diff file (patch) is attached.
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> It prints parsedOptions and options retrieved from SSL context and 
</I>&gt;&gt;&gt;&gt;&gt;<i> session objects at several stages.
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> Here is tls_outgoing_options setting:
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> $ grep tls_outgoing_options /etc/squid/squid.conf
</I>&gt;&gt;&gt;&gt;&gt;<i> tls_outgoing_options \
</I>&gt;&gt;&gt;&gt;&gt;<i> &#160;&#160;&#160;&#160; cafile=/etc/ssl/cert.pem \
</I>&gt;&gt;&gt;&gt;&gt;<i> cipher=ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA:ECDHE-RSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA:DHE-RSA-AES256-SHA256:DHE-RSA-AES256-SHA:ECDHE-ECDSA-DES-CBC3-SHA:ECDHE-RSA-DES-CBC3-SHA:EDH-RSA-DES-CBC3-SHA:AES128-GCM-SHA256:AES256-GCM-SHA384:AES128-SHA256:AES256-SHA256:AES128-SHA:AES256-SHA:DES-CBC3-SHA:!DSS \
</I>&gt;&gt;&gt;&gt;&gt;<i> &#160;&#160;&#160;&#160; options=0x4
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> Here is what squid logs on reload i.e. on parsing the squid.conf
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> $ systemctl reload squid
</I>&gt;&gt;&gt;&gt;&gt;<i> $ tail -f /var/log/squid/cache.log&#160; |grep -i 'openssl\|parsed'
</I>&gt;&gt;&gt;&gt;&gt;<i> 2022/12/28 12:19:30.596 kid1| 83,5| PeerOptions.cc(547) 
</I>&gt;&gt;&gt;&gt;&gt;<i> parseOptions: INFO: TLS parsedOptions(3)=0
</I>&gt;&gt;&gt;&gt;&gt;<i> 2022/12/28 12:19:30.598 kid1| 83,5| PeerOptions.cc(547) 
</I>&gt;&gt;&gt;&gt;&gt;<i> parseOptions: INFO: TLS parsedOptions(3)=0
</I>&gt;&gt;&gt;&gt;&gt;<i> 2022/12/28 12:19:30.723 kid1| 83,5| PeerOptions.cc(547) 
</I>&gt;&gt;&gt;&gt;&gt;<i> parseOptions: INFO: TLS parsedOptions(3)=4
</I>&gt;&gt;&gt;&gt;&gt;<i> 2022/12/28 12:19:30.729 kid1| 83,5| PeerOptions.cc(547) 
</I>&gt;&gt;&gt;&gt;&gt;<i> parseOptions: INFO: TLS parsedOptions(3)=0
</I>&gt;&gt;&gt;&gt;&gt;<i> 2022/12/28 12:19:30.729 kid1| 83,5| PeerOptions.cc(547) 
</I>&gt;&gt;&gt;&gt;&gt;<i> parseOptions: INFO: TLS parsedOptions(3)=0
</I>&gt;&gt;&gt;&gt;&gt;<i> 2022/12/28 12:19:32.147 kid1| 83,5| PeerOptions.cc(447) 
</I>&gt;&gt;&gt;&gt;&gt;<i> parseOptions: INFO: TLS parsedOptions(1)=0
</I>&gt;&gt;&gt;&gt;&gt;<i> 2022/12/28 12:19:32.147 kid1| 83,5| PeerOptions.cc(547) 
</I>&gt;&gt;&gt;&gt;&gt;<i> parseOptions: INFO: TLS parsedOptions(3)=0
</I>&gt;&gt;&gt;&gt;&gt;<i> 2022/12/28 12:19:33.524 kid1| 83,5| PeerOptions.cc(447) 
</I>&gt;&gt;&gt;&gt;&gt;<i> parseOptions: INFO: TLS parsedOptions(1)=0
</I>&gt;&gt;&gt;&gt;&gt;<i> 2022/12/28 12:19:33.532 kid1| 83,5| PeerOptions.cc(547) 
</I>&gt;&gt;&gt;&gt;&gt;<i> parseOptions: INFO: TLS parsedOptions(3)=0
</I>&gt;&gt;&gt;&gt;&gt;<i> 2022/12/28 12:19:33.695 kid1| 83,5| PeerOptions.cc(447) 
</I>&gt;&gt;&gt;&gt;&gt;<i> parseOptions: INFO: TLS parsedOptions(1)=0
</I>&gt;&gt;&gt;&gt;&gt;<i> 2022/12/28 12:19:33.695 kid1| 83,5| PeerOptions.cc(643) 
</I>&gt;&gt;&gt;&gt;&gt;<i> updateContextOptions: set OpenSSL options for 
</I>&gt;&gt;&gt;&gt;&gt;<i> context=0x562a5387fe30, parsedOptions=0
</I>&gt;&gt;&gt;&gt;&gt;<i> 2022/12/28 12:19:33.695 kid1| 83,5| PeerOptions.cc(645) 
</I>&gt;&gt;&gt;&gt;&gt;<i> updateContextOptions: get OpenSSL options for 
</I>&gt;&gt;&gt;&gt;&gt;<i> context=0x562a5387fe30, getOptions=1179648
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> 2022/12/28 12:19:33.708 kid1| 83,5| PeerOptions.cc(447) 
</I>&gt;&gt;&gt;&gt;&gt;<i> parseOptions: INFO: TLS parsedOptions(1)=0
</I>&gt;&gt;&gt;&gt;&gt;<i> 2022/12/28 12:19:33.708 kid1| 83,5| PeerOptions.cc(643) 
</I>&gt;&gt;&gt;&gt;&gt;<i> updateContextOptions: set OpenSSL options for 
</I>&gt;&gt;&gt;&gt;&gt;<i> context=0x562a53e6e740, parsedOptions=0
</I>&gt;&gt;&gt;&gt;&gt;<i> 2022/12/28 12:19:33.708 kid1| 83,5| PeerOptions.cc(645) 
</I>&gt;&gt;&gt;&gt;&gt;<i> updateContextOptions: get OpenSSL options for 
</I>&gt;&gt;&gt;&gt;&gt;<i> context=0x562a53e6e740, getOptions=1179648
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> It seems that squid parses the options multiple times and only once 
</I>&gt;&gt;&gt;&gt;&gt;<i> it gets the value as 4. Rest are parsed as 0.
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> The value of 1179648 (0x120000) corresponds to 
</I>&gt;&gt;&gt;&gt;&gt;<i> SSL_OP_NO_COMPRESSION (0x20000) and SSL_OP_ENABLE_MIDDLEBOX_COMPAT. 
</I>&gt;&gt;&gt;&gt;&gt;<i> (0x100000)
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> Now lets reproduce the issue:
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> $ curl --no-progress-meter -kx 127.0.0.1:8080 <A HREF="https://www.jio.com">https://www.jio.com</A> 
</I>&gt;&gt;&gt;&gt;&gt;<i> |grep 'TLS\|SSL'
</I>&gt;&gt;&gt;&gt;&gt;<i> &lt;pre&gt;[No Error] (TLS code: 
</I>&gt;&gt;&gt;&gt;&gt;<i> SQUID_TLS_ERR_CONNECT+TLS_LIB_ERR=A000152+TLS_IO_ERR=1)&lt;/pre&gt;
</I>&gt;&gt;&gt;&gt;&gt;<i> &lt;p&gt;Failed to establish a secure connection: error:0A000152:SSL 
</I>&gt;&gt;&gt;&gt;&gt;<i> routines::unsafe legacy renegotiation disabled&lt;/p&gt;
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> So, as we can see, we are still not able to access the site.
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> Lets see what cache.log has to say.
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> $ tail -f /var/log/squid/cache.log&#160; |grep -i 'openssl\|parsed'
</I>&gt;&gt;&gt;&gt;&gt;<i> 2022/12/28 12:31:09.971 kid1| 83,5| PeerOptions.cc(447) 
</I>&gt;&gt;&gt;&gt;&gt;<i> parseOptions: INFO: TLS parsedOptions(1)=0
</I>&gt;&gt;&gt;&gt;&gt;<i> 2022/12/28 12:31:09.971 kid1| 83,5| PeerOptions.cc(643) 
</I>&gt;&gt;&gt;&gt;&gt;<i> updateContextOptions: set OpenSSL options for 
</I>&gt;&gt;&gt;&gt;&gt;<i> context=0x562a53eb14e0, parsedOptions=0
</I>&gt;&gt;&gt;&gt;&gt;<i> 2022/12/28 12:31:09.971 kid1| 83,5| PeerOptions.cc(645) 
</I>&gt;&gt;&gt;&gt;&gt;<i> updateContextOptions: get OpenSSL options for 
</I>&gt;&gt;&gt;&gt;&gt;<i> context=0x562a53eb14e0, getOptions=1179648
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> Strangely parsedOptions was zero and not 4!
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> Now we can answer your questions as below.
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> On 27/12/22 21:52, Alex Rousskov wrote:
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> On 12/27/22 10:42, Amish wrote:
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> On 26/12/22 21:31, Alex Rousskov wrote:
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> tls_outgoing_options options=0x4,0x40000
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> With numeric hex values, I do not see the ERROR on stderr.
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> But it still does not seem to be working as expected. Squid still 
</I>&gt;&gt;&gt;&gt;&gt;&gt;&gt;<i> does not open the page and gives same legacy negotiation error.
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> There are still many unknowns (from my point of view), including:
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> 1. Does OpenSSL accept the above options? You ask that question 
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> below.
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> Google search shows some projects using OpenSSL v3 where there is 
</I>&gt;&gt;&gt;&gt;&gt;<i> mention to use above option when a similar error occurred to them.
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> But in our case, its clear that squid does not pass value 4 to SSL 
</I>&gt;&gt;&gt;&gt;&gt;<i> context, hence we do not know yet if OpenSSL accepts above options.
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> 2. Does Squid indeed stare at the server, as expected?
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> 3. Does Squid apply the accepted options when staring at the server?
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> A comment for parseOptions() in PeerOptions.cc states this:
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> /**
</I>&gt;&gt;&gt;&gt;&gt;<i> &#160;&#160;* Pre-parse TLS options= parameter to be applied when the TLS 
</I>&gt;&gt;&gt;&gt;&gt;<i> objects created.
</I>&gt;&gt;&gt;&gt;&gt;<i> &#160;&#160;* Options must not used in the case of peek or stare bump mode.
</I>&gt;&gt;&gt;&gt;&gt;<i> &#160;&#160;*/
</I>&gt;&gt;&gt;&gt;&gt;<i> void Security::PeerOptions::parseOptions()
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> So it appears that TLS options is NOT used for peek as well as 
</I>&gt;&gt;&gt;&gt;&gt;<i> stare. But why? I am not sure.
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> How do I make squid use it for 'stare' atleast?
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> 4. Why does TLS negotiation fail despite those options applied,
</I>&gt;&gt;&gt;&gt;&gt;&gt;<i> &#160;&#160; especially since it succeeds with using openssl s_client
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> It possibly fails because options are not applied by squid.
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> So, where do I check next on why parsedOptions is still set to 0 
</I>&gt;&gt;&gt;&gt;&gt;<i> and why its not used for 'stare'?
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> Thanks and regards,
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> Amish.
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;&gt;<i> squid-users mailing list
</I>&gt;&gt;&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;&gt;&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;<i> squid-users mailing list
</I>&gt;&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="025530.html">[squid-users] LEGACY_SERVER_CONNECT, ALLOW_UNSAFE_LEGACY_RENEGOTIATION does not work - SSL bump, OpenSSL 3
</A></li>
	<LI>Next message (by thread): <A HREF="025532.html">[squid-users] LEGACY_SERVER_CONNECT, ALLOW_UNSAFE_LEGACY_RENEGOTIATION does not work - SSL bump, OpenSSL 3
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25531">[ date ]</a>
              <a href="thread.html#25531">[ thread ]</a>
              <a href="subject.html#25531">[ subject ]</a>
              <a href="author.html#25531">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
