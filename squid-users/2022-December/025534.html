<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] LEGACY_SERVER_CONNECT, ALLOW_UNSAFE_LEGACY_RENEGOTIATION does not work - SSL bump, OpenSSL 3
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20LEGACY_SERVER_CONNECT%2C%0A%20ALLOW_UNSAFE_LEGACY_RENEGOTIATION%20does%20not%20work%20-%20SSL%20bump%2C%20OpenSSL%203&In-Reply-To=%3C4f493502-55e0-b652-569a-0424eacad048%40gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="025533.html">
   <LINK REL="Next"  HREF="025535.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] LEGACY_SERVER_CONNECT, ALLOW_UNSAFE_LEGACY_RENEGOTIATION does not work - SSL bump, OpenSSL 3</H1>
    <B>Amish</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20LEGACY_SERVER_CONNECT%2C%0A%20ALLOW_UNSAFE_LEGACY_RENEGOTIATION%20does%20not%20work%20-%20SSL%20bump%2C%20OpenSSL%203&In-Reply-To=%3C4f493502-55e0-b652-569a-0424eacad048%40gmail.com%3E"
       TITLE="[squid-users] LEGACY_SERVER_CONNECT, ALLOW_UNSAFE_LEGACY_RENEGOTIATION does not work - SSL bump, OpenSSL 3">anon.amish at gmail.com
       </A><BR>
    <I>Thu Dec 29 15:41:49 UTC 2022</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="025533.html">[squid-users] LEGACY_SERVER_CONNECT, ALLOW_UNSAFE_LEGACY_RENEGOTIATION does not work - SSL bump, OpenSSL 3
</A></li>
        <LI>Next message (by thread): <A HREF="025535.html">[squid-users] LEGACY_SERVER_CONNECT, ALLOW_UNSAFE_LEGACY_RENEGOTIATION does not work - SSL bump, OpenSSL 3
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25534">[ date ]</a>
              <a href="thread.html#25534">[ thread ]</a>
              <a href="subject.html#25534">[ subject ]</a>
              <a href="author.html#25534">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 29/12/22 20:23, Alex Rousskov wrote:
&gt;<i> On 12/28/22 23:17, Amish wrote:
</I>&gt;<i>
</I>&gt;&gt;<i> But now what?
</I>&gt;<i>
</I>&gt;<i> If your Squid never peeks at origin servers (i.e. it always stares) 
</I>&gt;<i> and your proxy never serves/secures plain-text &quot;GET https&quot; requests, 
</I>&gt;<i> then you can run with the createClientContext(true) hack until 
</I>&gt;<i> somebody volunteers a long-term solution (as discussed below).
</I>
Yes it always stares. So current hack will work for mr. Just that I can 
not use squid shipped by Arch Linux and will have to compile is manually.

What is plain text &quot;GET https&quot; request?

I do use squid as intercept proxy for http (port 80) and https (port 443 
and stare bump). I hope above hack will not break that.

&gt;<i> There are several ways to fix this bug long-term, including these two:
</I>&gt;<i>
</I>&gt;<i> Minimal: Create a TLS context object dedicated to peeking at origin 
</I>&gt;<i> servers. It will probably have to be admin-configurable to accomodate 
</I>&gt;<i> various TLS v1.2 (and earlier) corner cases, but we can try to start 
</I>&gt;<i> without adding support for such configuration. Continue to use the 
</I>&gt;<i> existing configurable context for staring and other needs but call 
</I>&gt;<i> createClientContext(true) for that existing context.
</I>
I wish I could code it. But I have no idea about TLS and OpenSSL APIs 
and also squid code.

I believe as more people switch to OpenSSL 3.0, we will see more people 
(using sslbump) complain about squid not connecting to unpatched origin 
servers.

I think easiest option to tackle this issue could be to have 
tls_outgoing_sslopflags directive which gets applied (ORed) to all SSL 
(peek, stare, splice) connections. And then those who wants squid to be 
able to connect to unpatched origin server can set it to 0x4. And then 
we do not need above hack. Peek and stare both will continue to work as 
it is currently.

If it is acceptable solution then I may try my hands on creating PR if 
it is not too complicated.

&gt;<i> Flexible: Replace tls_outgoing_options with tls_outgoing or a similar 
</I>&gt;<i> directive that supports ACLs. The new directive must be used once for 
</I>&gt;<i> each set of context configuration parameters (unlike&#160; the existing 
</I>&gt;<i> tls_outgoing_options that could be (mis)used multiple times, 
</I>&gt;<i> accumulating some parameters and overwriting others). At configuration 
</I>&gt;<i> time, Squid will create as many TLS context objects as there are 
</I>&gt;<i> tls_outgoing directives. At runtime, Squid will evaluate ACLs and pick 
</I>&gt;<i> the right context object for the current outgoing TLS connection 
</I>&gt;<i> attempt. For example, you would be able to configure Squid to use one 
</I>&gt;<i> context for peeking at servers and another for staring at them.
</I>
I thought squid (intentionally) supported multiple tls_outgoing_options. 
I had asked that question long back.

<A HREF="http://lists.squid-cache.org/pipermail/squid-users/2018-July/018582.html">http://lists.squid-cache.org/pipermail/squid-users/2018-July/018582.html</A>

Hope there is no plan to remove that feature(!) in future else my 
scripts will break.

&gt;<i> Unfortunately, even the minimal solution requires non-trivial 
</I>&gt;<i> development work. I do not have enough free time to give you a 
</I>&gt;<i> ready-to-use blueprint for its implementation.
</I>&gt;<i>
</I>&gt;<i> <A HREF="https://wiki.squid-cache.org/SquidFaq/AboutSquid#how-to-add-a-new-squid-feature-enhance-of-fix-something">https://wiki.squid-cache.org/SquidFaq/AboutSquid#how-to-add-a-new-squid-feature-enhance-of-fix-something</A> 
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> HTH,
</I>&gt;<i>
</I>&gt;<i> Alex.
</I>
Thank you very much again

You have been of great help.

Regards,

Amish.


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="025533.html">[squid-users] LEGACY_SERVER_CONNECT, ALLOW_UNSAFE_LEGACY_RENEGOTIATION does not work - SSL bump, OpenSSL 3
</A></li>
	<LI>Next message (by thread): <A HREF="025535.html">[squid-users] LEGACY_SERVER_CONNECT, ALLOW_UNSAFE_LEGACY_RENEGOTIATION does not work - SSL bump, OpenSSL 3
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25534">[ date ]</a>
              <a href="thread.html#25534">[ thread ]</a>
              <a href="subject.html#25534">[ subject ]</a>
              <a href="author.html#25534">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
