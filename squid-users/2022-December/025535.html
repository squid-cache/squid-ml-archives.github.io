<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] LEGACY_SERVER_CONNECT, ALLOW_UNSAFE_LEGACY_RENEGOTIATION does not work - SSL bump, OpenSSL 3
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20LEGACY_SERVER_CONNECT%2C%0A%20ALLOW_UNSAFE_LEGACY_RENEGOTIATION%20does%20not%20work%20-%20SSL%20bump%2C%20OpenSSL%203&In-Reply-To=%3C711d97c2-f618-c458-2fcf-47da87ed3806%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="025534.html">
   <LINK REL="Next"  HREF="025538.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] LEGACY_SERVER_CONNECT, ALLOW_UNSAFE_LEGACY_RENEGOTIATION does not work - SSL bump, OpenSSL 3</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20LEGACY_SERVER_CONNECT%2C%0A%20ALLOW_UNSAFE_LEGACY_RENEGOTIATION%20does%20not%20work%20-%20SSL%20bump%2C%20OpenSSL%203&In-Reply-To=%3C711d97c2-f618-c458-2fcf-47da87ed3806%40measurement-factory.com%3E"
       TITLE="[squid-users] LEGACY_SERVER_CONNECT, ALLOW_UNSAFE_LEGACY_RENEGOTIATION does not work - SSL bump, OpenSSL 3">rousskov at measurement-factory.com
       </A><BR>
    <I>Thu Dec 29 17:02:34 UTC 2022</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="025534.html">[squid-users] LEGACY_SERVER_CONNECT, ALLOW_UNSAFE_LEGACY_RENEGOTIATION does not work - SSL bump, OpenSSL 3
</A></li>
        <LI>Next message (by thread): <A HREF="025538.html">[squid-users] LEGACY_SERVER_CONNECT, ALLOW_UNSAFE_LEGACY_RENEGOTIATION does not work - SSL bump, OpenSSL 3
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25535">[ date ]</a>
              <a href="thread.html#25535">[ thread ]</a>
              <a href="subject.html#25535">[ subject ]</a>
              <a href="author.html#25535">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 12/29/22 10:41, Amish wrote:
&gt;<i> On 29/12/22 20:23, Alex Rousskov wrote:
</I>&gt;&gt;<i> On 12/28/22 23:17, Amish wrote:
</I>&gt;&gt;&gt;<i> But now what?
</I>
&gt;&gt;<i> If your Squid never peeks at origin servers (i.e. it always stares) 
</I>&gt;&gt;<i> and your proxy never serves/secures plain-text &quot;GET https&quot; requests, 
</I>&gt;&gt;<i> then you can run with the createClientContext(true) hack until 
</I>&gt;&gt;<i> somebody volunteers a long-term solution (as discussed below).
</I>
&gt;<i> What is plain text &quot;GET https&quot; request?
</I>
It is an unencrypted HTTP GET request arriving at http_port and using an 
https URI scheme in its target URI. These requests are relatively rare, 
mostly seen in environments where specialized HTTP clients outsource TLS 
work to their forward proxies.


&gt;<i> I do use squid as intercept proxy for http (port 80) and https (port 443 
</I>&gt;<i> and stare bump). I hope above hack will not break that.
</I>
I share that hope, but cannot guarantee success.


&gt;&gt;<i> There are several ways to fix this bug long-term, including these two:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Minimal: Create a TLS context object dedicated to peeking at origin 
</I>&gt;&gt;<i> servers. It will probably have to be admin-configurable to accomodate 
</I>&gt;&gt;<i> various TLS v1.2 (and earlier) corner cases, but we can try to start 
</I>&gt;&gt;<i> without adding support for such configuration. Continue to use the 
</I>&gt;&gt;<i> existing configurable context for staring and other needs but call 
</I>&gt;&gt;<i> createClientContext(true) for that existing context.
</I>
&gt;<i> I wish I could code it. But I have no idea about TLS and OpenSSL APIs 
</I>&gt;<i> and also squid code.
</I>
&gt;<i> I believe as more people switch to OpenSSL 3.0, we will see more people 
</I>&gt;<i> (using sslbump) complain about squid not connecting to unpatched origin 
</I>&gt;<i> servers.
</I>
&gt;<i> I think easiest option to tackle this issue could be to have 
</I>&gt;<i> tls_outgoing_sslopflags directive which gets applied (ORed) to all SSL 
</I>&gt;<i> (peek, stare, splice) connections. And then those who wants squid to be 
</I>&gt;<i> able to connect to unpatched origin server can set it to 0x4. And then 
</I>&gt;<i> we do not need above hack. Peek and stare both will continue to work as 
</I>&gt;<i> it is currently.
</I>
&gt;<i> If it is acceptable solution then I may try my hands on creating PR if 
</I>&gt;<i> it is not too complicated.
</I>
Why would adding such a new directive be better than committing the 
createClientContext(true) change that you have tested? AFAICT, such a 
commit would enable the old directive to do what the new directive is 
meant to do. Just like a new directive, this commit will break either 
peek or stare cases (depending on the problematic origin server).

The only advantage I see is that the new directive you propose would 
allow to preserve the old configuration behavior, but since that 
behavior is wrong/exceptional/surprising, I doubt it is worth preserving 
long-term (which is what adding such a new directive would do).


&gt;<i> I thought squid (intentionally) supported multiple
</I>&gt;<i> tls_outgoing_options. I had asked that question long back.
</I>&gt;<i> 
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/pipermail/squid-users/2018-July/018582.html">http://lists.squid-cache.org/pipermail/squid-users/2018-July/018582.html</A>
</I>
IMO, Squid support for multiple tls_outgoing_options directives is

* poor (and probably buggy)
* unnecessary (one can always get the same result without it)
* a configuration design mistake (we should have prohibited it)
* significantly complicates fixing/enhancing the underlying code


 &gt; Hope there is no plan to remove that feature(!) in future else my
 &gt; scripts will break.

If it were my call, it would have been removed (while fixing the problem 
you have reported on this thread): It is better to adjust your scripts 
(a one-time pain) than suffer from this mistake long-term. It is _not_ 
my call, and Squid is full of other features that cause ongoing pains 
and complicate progress because it is very difficult to reach consensus 
that something should be _removed_.


Cheers,

Alex.



&gt;&gt;<i> Flexible: Replace tls_outgoing_options with tls_outgoing or a similar 
</I>&gt;&gt;<i> directive that supports ACLs. The new directive must be used once for 
</I>&gt;&gt;<i> each set of context configuration parameters (unlike&#160; the existing 
</I>&gt;&gt;<i> tls_outgoing_options that could be (mis)used multiple times, 
</I>&gt;&gt;<i> accumulating some parameters and overwriting others). At configuration 
</I>&gt;&gt;<i> time, Squid will create as many TLS context objects as there are 
</I>&gt;&gt;<i> tls_outgoing directives. At runtime, Squid will evaluate ACLs and pick 
</I>&gt;&gt;<i> the right context object for the current outgoing TLS connection 
</I>&gt;&gt;<i> attempt. For example, you would be able to configure Squid to use one 
</I>&gt;&gt;<i> context for peeking at servers and another for staring at them.
</I>

&gt;&gt;<i> Unfortunately, even the minimal solution requires non-trivial 
</I>&gt;&gt;<i> development work. I do not have enough free time to give you a 
</I>&gt;&gt;<i> ready-to-use blueprint for its implementation.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> <A HREF="https://wiki.squid-cache.org/SquidFaq/AboutSquid#how-to-add-a-new-squid-feature-enhance-of-fix-something">https://wiki.squid-cache.org/SquidFaq/AboutSquid#how-to-add-a-new-squid-feature-enhance-of-fix-something</A>
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="025534.html">[squid-users] LEGACY_SERVER_CONNECT, ALLOW_UNSAFE_LEGACY_RENEGOTIATION does not work - SSL bump, OpenSSL 3
</A></li>
	<LI>Next message (by thread): <A HREF="025538.html">[squid-users] LEGACY_SERVER_CONNECT, ALLOW_UNSAFE_LEGACY_RENEGOTIATION does not work - SSL bump, OpenSSL 3
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25535">[ date ]</a>
              <a href="thread.html#25535">[ thread ]</a>
              <a href="subject.html#25535">[ subject ]</a>
              <a href="author.html#25535">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
