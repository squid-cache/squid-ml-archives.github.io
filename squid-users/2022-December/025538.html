<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] LEGACY_SERVER_CONNECT, ALLOW_UNSAFE_LEGACY_RENEGOTIATION does not work - SSL bump, OpenSSL 3
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20LEGACY_SERVER_CONNECT%2C%0A%20ALLOW_UNSAFE_LEGACY_RENEGOTIATION%20does%20not%20work%20-%20SSL%20bump%2C%20OpenSSL%203&In-Reply-To=%3Cf6b82d0a-349f-3579-c3cb-9551a574bcd9%40gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="025535.html">
   <LINK REL="Next"  HREF="025539.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] LEGACY_SERVER_CONNECT, ALLOW_UNSAFE_LEGACY_RENEGOTIATION does not work - SSL bump, OpenSSL 3</H1>
    <B>Amish</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20LEGACY_SERVER_CONNECT%2C%0A%20ALLOW_UNSAFE_LEGACY_RENEGOTIATION%20does%20not%20work%20-%20SSL%20bump%2C%20OpenSSL%203&In-Reply-To=%3Cf6b82d0a-349f-3579-c3cb-9551a574bcd9%40gmail.com%3E"
       TITLE="[squid-users] LEGACY_SERVER_CONNECT, ALLOW_UNSAFE_LEGACY_RENEGOTIATION does not work - SSL bump, OpenSSL 3">anon.amish at gmail.com
       </A><BR>
    <I>Fri Dec 30 01:05:49 UTC 2022</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="025535.html">[squid-users] LEGACY_SERVER_CONNECT, ALLOW_UNSAFE_LEGACY_RENEGOTIATION does not work - SSL bump, OpenSSL 3
</A></li>
        <LI>Next message (by thread): <A HREF="025539.html">[squid-users] LEGACY_SERVER_CONNECT, ALLOW_UNSAFE_LEGACY_RENEGOTIATION does not work - SSL bump, OpenSSL 3
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25538">[ date ]</a>
              <a href="thread.html#25538">[ thread ]</a>
              <a href="subject.html#25538">[ subject ]</a>
              <a href="author.html#25538">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
On 29/12/22 22:32, Alex Rousskov wrote:
&gt;<i> On 12/29/22 10:41, Amish wrote:
</I>&gt;&gt;<i> On 29/12/22 20:23, Alex Rousskov wrote:
</I>&gt;&gt;&gt;<i> On 12/28/22 23:17, Amish wrote:
</I>&gt;&gt;&gt;&gt;<i> But now what?
</I>&gt;<i>
</I>&gt;&gt;&gt;<i> If your Squid never peeks at origin servers (i.e. it always stares) 
</I>&gt;&gt;&gt;<i> and your proxy never serves/secures plain-text &quot;GET https&quot; requests, 
</I>&gt;&gt;&gt;<i> then you can run with the createClientContext(true) hack until 
</I>&gt;&gt;&gt;<i> somebody volunteers a long-term solution (as discussed below).
</I>&gt;<i>
</I>&gt;&gt;<i> What is plain text &quot;GET https&quot; request?
</I>&gt;<i>
</I>&gt;<i> It is an unencrypted HTTP GET request arriving at http_port and using 
</I>&gt;<i> an https URI scheme in its target URI. These requests are relatively 
</I>&gt;<i> rare, mostly seen in environments where specialized HTTP clients 
</I>&gt;<i> outsource TLS work to their forward proxies.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> I do use squid as intercept proxy for http (port 80) and https (port 
</I>&gt;&gt;<i> 443 and stare bump). I hope above hack will not break that.
</I>&gt;<i>
</I>&gt;<i> I share that hope, but cannot guarantee success.
</I>
Thanks for the info.

&gt;<i>
</I>&gt;&gt;&gt;<i> There are several ways to fix this bug long-term, including these two:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Minimal: Create a TLS context object dedicated to peeking at origin 
</I>&gt;&gt;&gt;<i> servers. It will probably have to be admin-configurable to 
</I>&gt;&gt;&gt;<i> accomodate various TLS v1.2 (and earlier) corner cases, but we can 
</I>&gt;&gt;&gt;<i> try to start without adding support for such configuration. Continue 
</I>&gt;&gt;&gt;<i> to use the existing configurable context for staring and other needs 
</I>&gt;&gt;&gt;<i> but call createClientContext(true) for that existing context.
</I>&gt;<i>
</I>&gt;&gt;<i> I wish I could code it. But I have no idea about TLS and OpenSSL APIs 
</I>&gt;&gt;<i> and also squid code.
</I>&gt;<i>
</I>&gt;&gt;<i> I believe as more people switch to OpenSSL 3.0, we will see more 
</I>&gt;&gt;<i> people (using sslbump) complain about squid not connecting to 
</I>&gt;&gt;<i> unpatched origin servers.
</I>&gt;<i>
</I>&gt;&gt;<i> I think easiest option to tackle this issue could be to have 
</I>&gt;&gt;<i> tls_outgoing_sslopflags directive which gets applied (ORed) to all 
</I>&gt;&gt;<i> SSL (peek, stare, splice) connections. And then those who wants squid 
</I>&gt;&gt;<i> to be able to connect to unpatched origin server can set it to 0x4. 
</I>&gt;&gt;<i> And then we do not need above hack. Peek and stare both will continue 
</I>&gt;&gt;<i> to work as it is currently.
</I>&gt;<i>
</I>&gt;&gt;<i> If it is acceptable solution then I may try my hands on creating PR 
</I>&gt;&gt;<i> if it is not too complicated.
</I>&gt;<i>
</I>&gt;<i> Why would adding such a new directive be better than committing the 
</I>&gt;<i> createClientContext(true) change that you have tested? AFAICT, such a 
</I>&gt;<i> commit would enable the old directive to do what the new directive is 
</I>&gt;<i> meant to do. Just like a new directive, this commit will break either 
</I>&gt;<i> peek or stare cases (depending on the problematic origin server).
</I>&gt;<i>
</I>&gt;<i> The only advantage I see is that the new directive you propose would 
</I>&gt;<i> allow to preserve the old configuration behavior, but since that 
</I>&gt;<i> behavior is wrong/exceptional/surprising, I doubt it is worth 
</I>&gt;<i> preserving long-term (which is what adding such a new directive would 
</I>&gt;<i> do).
</I>
I do not know what createClientContext() actually does. I thought it was 
just a way to test your theory.

If you tell me the starting point then I may try to look at the code and 
try to implement your minimal way to fix it.

In the mean time, do you think this bug needs to be reported as an issue 
on Github? I can do that.

Thanks and regards,

Amish.

&gt;&gt;<i> I thought squid (intentionally) supported multiple
</I>&gt;&gt;<i> tls_outgoing_options. I had asked that question long back.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> <A HREF="http://lists.squid-cache.org/pipermail/squid-users/2018-July/018582.html">http://lists.squid-cache.org/pipermail/squid-users/2018-July/018582.html</A>
</I>&gt;<i>
</I>&gt;<i> IMO, Squid support for multiple tls_outgoing_options directives is
</I>&gt;<i>
</I>&gt;<i> * poor (and probably buggy)
</I>&gt;<i> * unnecessary (one can always get the same result without it)
</I>&gt;<i> * a configuration design mistake (we should have prohibited it)
</I>&gt;<i> * significantly complicates fixing/enhancing the underlying code
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; Hope there is no plan to remove that feature(!) in future else my
</I>&gt;<i> &gt; scripts will break.
</I>&gt;<i>
</I>&gt;<i> If it were my call, it would have been removed (while fixing the 
</I>&gt;<i> problem you have reported on this thread): It is better to adjust your 
</I>&gt;<i> scripts (a one-time pain) than suffer from this mistake long-term. It 
</I>&gt;<i> is _not_ my call, and Squid is full of other features that cause 
</I>&gt;<i> ongoing pains and complicate progress because it is very difficult to 
</I>&gt;<i> reach consensus that something should be _removed_.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Cheers,
</I>&gt;<i>
</I>&gt;<i> Alex.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;&gt;<i> Flexible: Replace tls_outgoing_options with tls_outgoing or a 
</I>&gt;&gt;&gt;<i> similar directive that supports ACLs. The new directive must be used 
</I>&gt;&gt;&gt;<i> once for each set of context configuration parameters (unlike&#160; the 
</I>&gt;&gt;&gt;<i> existing tls_outgoing_options that could be (mis)used multiple 
</I>&gt;&gt;&gt;<i> times, accumulating some parameters and overwriting others). At 
</I>&gt;&gt;&gt;<i> configuration time, Squid will create as many TLS context objects as 
</I>&gt;&gt;&gt;<i> there are tls_outgoing directives. At runtime, Squid will evaluate 
</I>&gt;&gt;&gt;<i> ACLs and pick the right context object for the current outgoing TLS 
</I>&gt;&gt;&gt;<i> connection attempt. For example, you would be able to configure 
</I>&gt;&gt;&gt;<i> Squid to use one context for peeking at servers and another for 
</I>&gt;&gt;&gt;<i> staring at them.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;&gt;<i> Unfortunately, even the minimal solution requires non-trivial 
</I>&gt;&gt;&gt;<i> development work. I do not have enough free time to give you a 
</I>&gt;&gt;&gt;<i> ready-to-use blueprint for its implementation.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> <A HREF="https://wiki.squid-cache.org/SquidFaq/AboutSquid#how-to-add-a-new-squid-feature-enhance-of-fix-something">https://wiki.squid-cache.org/SquidFaq/AboutSquid#how-to-add-a-new-squid-feature-enhance-of-fix-something</A> 
</I>&gt;&gt;&gt;<i>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="025535.html">[squid-users] LEGACY_SERVER_CONNECT, ALLOW_UNSAFE_LEGACY_RENEGOTIATION does not work - SSL bump, OpenSSL 3
</A></li>
	<LI>Next message (by thread): <A HREF="025539.html">[squid-users] LEGACY_SERVER_CONNECT, ALLOW_UNSAFE_LEGACY_RENEGOTIATION does not work - SSL bump, OpenSSL 3
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25538">[ date ]</a>
              <a href="thread.html#25538">[ thread ]</a>
              <a href="subject.html#25538">[ subject ]</a>
              <a href="author.html#25538">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
