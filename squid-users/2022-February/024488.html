<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] External helper consumes too many DB connections
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20External%20helper%20consumes%20too%20many%20DB%20connections&In-Reply-To=%3CCAGCa14oKUT2V4f9OiVuJyYHZuxdau1TL%2BkU3frnvr%2BXd3REB2w%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="024480.html">
   <LINK REL="Next"  HREF="024489.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] External helper consumes too many DB connections</H1>
    <B>roee klinger</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20External%20helper%20consumes%20too%20many%20DB%20connections&In-Reply-To=%3CCAGCa14oKUT2V4f9OiVuJyYHZuxdau1TL%2BkU3frnvr%2BXd3REB2w%40mail.gmail.com%3E"
       TITLE="[squid-users] External helper consumes too many DB connections">roeeklinger60 at gmail.com
       </A><BR>
    <I>Tue Feb  8 14:13:46 UTC 2022</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="024480.html">[squid-users] The status of AIA ie: TLS code: X509_V_ERR_UNABLE_TO_GET_ISSUER_CERT_LOCALLY ?
</A></li>
        <LI>Next message (by thread): <A HREF="024489.html">[squid-users] External helper consumes too many DB connections
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24488">[ date ]</a>
              <a href="thread.html#24488">[ thread ]</a>
              <a href="subject.html#24488">[ subject ]</a>
              <a href="author.html#24488">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello,

I am running multiple instances of Squid in a K8S environment, each Squid
instance has a helper that authenticates users based on their username and
password, the scripts are written in Python.

I have been facing an issue, that when under load, the helpers (even with
3600 sec TTL) swamp the MariaDB instance, causing it to reach 100% CPU,
basically I believe because each helper opens up its own connection to
MariaDB, which ends up as a lot of connections.

My initial idea was to create a Redis DB next to each Squid instance and
connect each Squid to its own dedicated Redis. I will sync Redis with
MariaDB every minute, thus decreasing the connections count from a few 100s
to just 1 every minute. This will also improve speeds since Redis is much
faster than MariaDB.

The problem is, however, that there will still be many connections from
Squid to Redis, and I probably that will consume a lot of DB resources as
well, which I don't actually know how to optimize, since it seems that
Squid opens many processes, and there is no way to get them to talk to each
other (expect TTL values, which seems not to help in my case, which I also
don't understand why that is).

What is the best practice to handle this? considering I have the following
requirements:

1. Fast
2. Refresh data every minute
3. Consume as least amount of DB resources as possible

Thanks,
Roee
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20220208/ab7b4b57/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20220208/ab7b4b57/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="024480.html">[squid-users] The status of AIA ie: TLS code: X509_V_ERR_UNABLE_TO_GET_ISSUER_CERT_LOCALLY ?
</A></li>
	<LI>Next message (by thread): <A HREF="024489.html">[squid-users] External helper consumes too many DB connections
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24488">[ date ]</a>
              <a href="thread.html#24488">[ thread ]</a>
              <a href="subject.html#24488">[ subject ]</a>
              <a href="author.html#24488">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
