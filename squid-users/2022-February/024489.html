<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] External helper consumes too many DB connections
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20External%20helper%20consumes%20too%20many%20DB%20connections&In-Reply-To=%3C586d74b2-6a84-85ca-7ac9-482ed6722d00%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="024488.html">
   <LINK REL="Next"  HREF="024490.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] External helper consumes too many DB connections</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20External%20helper%20consumes%20too%20many%20DB%20connections&In-Reply-To=%3C586d74b2-6a84-85ca-7ac9-482ed6722d00%40measurement-factory.com%3E"
       TITLE="[squid-users] External helper consumes too many DB connections">rousskov at measurement-factory.com
       </A><BR>
    <I>Tue Feb  8 14:41:57 UTC 2022</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="024488.html">[squid-users] External helper consumes too many DB connections
</A></li>
        <LI>Next message (by thread): <A HREF="024490.html">[squid-users] External helper consumes too many DB connections
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24489">[ date ]</a>
              <a href="thread.html#24489">[ thread ]</a>
              <a href="subject.html#24489">[ subject ]</a>
              <a href="author.html#24489">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 2/8/22 09:13, roee klinger wrote:

&gt;<i> I am running multiple instances of Squid in a K8S environment, each 
</I>&gt;<i> Squid instance has a helper&#160;that authenticates users based on their 
</I>&gt;<i> username and password, the scripts are written in Python.
</I>&gt;<i> 
</I>&gt;<i> I have been facing an issue, that when under load, the helpers (even 
</I>&gt;<i> with 3600 sec TTL) swamp the MariaDB instance, causing&#160;it to reach 100% 
</I>&gt;<i> CPU, basically&#160;I believe because each helper opens up its own connection 
</I>&gt;<i> to MariaDB, which ends up as a lot of connections.
</I>&gt;<i> 
</I>&gt;<i> My initial idea was to create a Redis DB next to each Squid instance and 
</I>&gt;<i> connect each Squid to its own dedicated Redis. I will sync Redis with 
</I>&gt;<i> MariaDB every minute, thus decreasing the connections count from a few 
</I>&gt;<i> 100s to just 1 every minute. This will also improve speeds since Redis 
</I>&gt;<i> is much faster than MariaDB.
</I>&gt;<i> 
</I>&gt;<i> The problem is, however, that there will still be many connections from 
</I>&gt;<i> Squid to Redis, and I probably that will consume a lot of DB resources 
</I>&gt;<i> as well, which I don't actually know how to optimize, since it seems 
</I>&gt;<i> that Squid opens many processes, and there is no way to get them to talk 
</I>&gt;<i> to each other (expect TTL values, which seems not to help in my case, 
</I>&gt;<i> which I also don't understand why that is).
</I>&gt;<i> 
</I>&gt;<i> What is the best practice to handle this? considering I have the 
</I>&gt;<i> following requirements:
</I>&gt;<i> 
</I>&gt;<i>     1. Fast
</I>&gt;<i>     2. Refresh data every minute
</I>&gt;<i>     3. Consume as least amount of DB resources as possible
</I>
I would start from the beginning: Does the aggregate number of database 
requests match your expectations? In other words, do you see lots of 
database requests that should not be there given your user access 
patterns and authentication TTLs? In yet other words, are there many 
repeated authentication accesses that should have been authentication 
cache hits?

If there are a lot more requests than your users/TTLs should generate, 
then you may be able to decrease db load by figuring out where the extra 
requests are coming from. For example, it is possible that your 
authentication cache key includes some noise that renders caching 
ineffective (e.g., see comments about key_extras in 
squid.conf.documented). Or maybe you need a bigger authentication cache.

If the total stream of authentication requests during peak hours is 
reasonable, with few unwarranted cache misses, then you can start 
working on aggregating helper-db connections (helpers can be written to 
talk through a central connection aggregator) and/or adding database 
power (e.g., by introducing additional databases running on previously 
unused hardware -- just like your MariaDB idea).


Cheers,

Alex.

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="024488.html">[squid-users] External helper consumes too many DB connections
</A></li>
	<LI>Next message (by thread): <A HREF="024490.html">[squid-users] External helper consumes too many DB connections
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24489">[ date ]</a>
              <a href="thread.html#24489">[ thread ]</a>
              <a href="subject.html#24489">[ subject ]</a>
              <a href="author.html#24489">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
