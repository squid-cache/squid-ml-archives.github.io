<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] squid-5.4 blocking on ipv6 outage
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid-5.4%20blocking%20on%20ipv6%20outage&In-Reply-To=%3CCAFChrgJBRFt3TcTx0OK3QjoMV%3Dcq1nBiCQEe9L5oeGbvOrmzhA%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="024537.html">
   <LINK REL="Next"  HREF="024538.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] squid-5.4 blocking on ipv6 outage</H1>
    <B>Jason Haar</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid-5.4%20blocking%20on%20ipv6%20outage&In-Reply-To=%3CCAFChrgJBRFt3TcTx0OK3QjoMV%3Dcq1nBiCQEe9L5oeGbvOrmzhA%40mail.gmail.com%3E"
       TITLE="[squid-users] squid-5.4 blocking on ipv6 outage">jason_haar at trimble.com
       </A><BR>
    <I>Mon Feb 21 19:21:42 UTC 2022</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="024537.html">[squid-users] squid-5.4 blocking on ipv6 outage
</A></li>
        <LI>Next message (by thread): <A HREF="024538.html">[squid-users] squid proxy really slow for web requests
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24539">[ date ]</a>
              <a href="thread.html#24539">[ thread ]</a>
              <a href="subject.html#24539">[ subject ]</a>
              <a href="author.html#24539">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Well this was a wild ride, I actually tracked the problem back to....
dns64/nat64!!!!!!!!!

What I discovered is that the affected webserver didn't actually have ipv6
- it only had 2 ipv4 addresses. But something in my DNS-tree (I'm
suspecting the local systemd-resolve, but can't actually find any direct
evidence) had whacked fake  DNS64/NAT64 records for each of them. I've
never seen them before so didn't realise &quot;64:ff9b:XXXXXXXX&quot; was a &quot;special&quot;
IPv6 range. I directly queried our upstream DNS recursive name server and
it didn't have those IPv6 records - but the local systemd-resolve would not
give them up. So I down/up-ed the interface (resetting systemd-resolve) and
the problem disappeared.

This new information really doesn't change the nature of the question, but
I'm afraid the problem is now resolved (for the moment) so debugging won't
catch it. If it happens again (I have never seen this before) I'll be sure
to do the debugging thang.

On Tue, Feb 22, 2022 at 3:16 AM Alex Rousskov &lt;
<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt; wrote:

&gt;<i> On 2/20/22 20:43, Jason Haar wrote:
</I>&gt;<i>
</I>&gt;<i> &gt; I've noticed that the Internet ipv6 is not quite as reliable as ipv4, in
</I>&gt;<i> &gt; that squid reports it cannot connect to web servers with an ipv6 error
</I>&gt;<i> &gt; when the web server is still available over ipv4.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; eg right now one of our Internet-based web apps (which has 2 ipv6 and 2
</I>&gt;<i> &gt; ipv4 IP addresses mapped to it's DNS name) is not responding over ipv6
</I>&gt;<i> &gt; for some reason (I dunno - not involved myself) - but is working fine
</I>&gt;<i> &gt; over ipv4. Squid-5.4 is erroring out - saying that it cannot connect to
</I>&gt;<i> &gt; the first ipv6 address with a &quot;no route to host&quot; error. But if I use
</I>&gt;<i> &gt; good-ol' telnet to the DNS name, telnet shows it trying-and-failing
</I>&gt;<i> &gt; against both ipv6 addresses and then succeeds against the ipv4. ie it
</I>&gt;<i> &gt; works and squid doesn't. BTW the same squid server is currently fine
</I>&gt;<i> &gt; with ipv6 clients talking to it and it talking over ipv6 to Internet
</I>&gt;<i> &gt; hosts like google.com &lt;<A HREF="http://google.com">http://google.com</A>&gt; - ie this is an ipv6 outage
</I>&gt;<i> on
</I>&gt;<i> &gt; one Internet host where it's ipv4 is still working.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; This doesn't seem like a negative_dns_ttl setting issue, it seems like
</I>&gt;<i> &gt; squid just tries one address on a multiple-IP DNS record and stops
</I>&gt;<i> &gt; trying? I even got tcpdump up and can see that when I do a
</I>&gt;<i> &gt; &quot;shift-reload&quot; on the webpage, squid only sends a few SYN packets to the
</I>&gt;<i> &gt; same non-working IPv6 address - it doesn't even try the other 3 IPs?
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I also checked squidcachemgr.cgi and the DNS record isn't even cached in
</I>&gt;<i> &gt; &quot;FQDN Cache Stats and Contents&quot;, which I guess is consistent with it's
</I>&gt;<i> &gt; opinion that it's not working.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Any ideas what's going on there? thanks!
</I>&gt;<i>
</I>&gt;<i> Squid is supposed to send both A and AAAA DNS queries for the uncached
</I>&gt;<i> domain and then try the first IP it can DNS-resolve and TCP-connect to.
</I>&gt;<i> If that winning destination does not work at HTTP level, then Squid may,
</I>&gt;<i> in some cases, try other destinations. There are lots of variables and
</I>&gt;<i> nuances related to the associated Happy Eyeballs and reforwarding
</I>&gt;<i> algorithms. It is impossible to say for sure what is going on in your
</I>&gt;<i> specific case without more information.
</I>&gt;<i>
</I>&gt;<i> Your best bet may be to share an ALL,9 cache.log that reproduces the
</I>&gt;<i> problem using a single isolated test transaction:
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> <A HREF="https://wiki.squid-cache.org/SquidFaq/BugReporting#Debugging_a_single_transaction">https://wiki.squid-cache.org/SquidFaq/BugReporting#Debugging_a_single_transaction</A>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> HTH,
</I>&gt;<i>
</I>&gt;<i> Alex.
</I>&gt;<i>
</I>

-- 
Cheers

Jason Haar
Information Security Manager, Trimble Navigation Ltd.
Phone: +1 408 481 8171
PGP Fingerprint: 7A2E 0407 C9A6 CAF6 2B9F 8422 C063 5EBB FE1D 66D1
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20220222/7d9964f1/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20220222/7d9964f1/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="024537.html">[squid-users] squid-5.4 blocking on ipv6 outage
</A></li>
	<LI>Next message (by thread): <A HREF="024538.html">[squid-users] squid proxy really slow for web requests
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24539">[ date ]</a>
              <a href="thread.html#24539">[ thread ]</a>
              <a href="subject.html#24539">[ subject ]</a>
              <a href="author.html#24539">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
