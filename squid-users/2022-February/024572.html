<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] getsockopt failures, although direct access to intercept ports is blocked
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20getsockopt%20failures%2C%0A%20although%20direct%20access%20to%20intercept%20ports%20is%20blocked&In-Reply-To=%3Cb75703c5-3be1-a645-7e05-3b557b5b1336%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="024551.html">
   <LINK REL="Next"  HREF="024581.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] getsockopt failures, although direct access to intercept ports is blocked</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20getsockopt%20failures%2C%0A%20although%20direct%20access%20to%20intercept%20ports%20is%20blocked&In-Reply-To=%3Cb75703c5-3be1-a645-7e05-3b557b5b1336%40treenet.co.nz%3E"
       TITLE="[squid-users] getsockopt failures, although direct access to intercept ports is blocked">squid3 at treenet.co.nz
       </A><BR>
    <I>Fri Feb 25 10:30:47 UTC 2022</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="024551.html">[squid-users] getsockopt failures, although direct access to intercept ports is blocked
</A></li>
        <LI>Next message (by thread): <A HREF="024581.html">[squid-users] [EXTERN] Re:  getsockopt failures, although direct access to intercept ports is blocked
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24572">[ date ]</a>
              <a href="thread.html#24572">[ thread ]</a>
              <a href="subject.html#24572">[ subject ]</a>
              <a href="author.html#24572">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 24/02/22 12:05, Andreas Weigel wrote:
&gt;<i> Hi everyone,
</I>&gt;<i> 
</I>&gt;<i> I had the following issue with Squid in Transparent Mode (and SSL 
</I>&gt;<i> Interception in mode splice). It is working as expected, however after 
</I>&gt;<i> multiple long-running (talking about several seconds) anti-virus 
</I>&gt;<i> ecap-Processes have finished, I *sometimes* get the following in the log:
</I>&gt;<i> 
</I>&gt;<i> 2022/02/23 14:56:40.668 kid1| 5,2| src/comm/TcpAcceptor.cc(224) 
</I>&gt;<i> doAccept: New connection on FD 21
</I>&gt;<i> 2022/02/23 14:56:40.668 kid1| 5,2| src/comm/TcpAcceptor.cc(312) 
</I>&gt;<i> acceptNext: connection on local=[::]:2412 remote=[::] FD 21 flags=41
</I>&gt;<i> 2022/02/23 14:56:40.668 kid1| 89,5| src/ip/Intercept.cc(405) Lookup: 
</I>&gt;<i> address BEGIN: me/client= 192.168.180.1:2412, destination/me= 
</I>&gt;<i> 192.168.180.10:48582
</I>&gt;<i> 2022/02/23 14:56:40.668 kid1| ERROR: NF getsockopt(ORIGINAL_DST) failed 
</I>&gt;<i> on local=192.168.180.1:2412 remote=192.168.180.10:48582 FD 37 flags=33: 
</I>&gt;<i> (2) No such file or directory
</I>&gt;<i> 2022/02/23 14:56:40.669 kid1| 89,9| src/ip/Intercept.cc(151) 
</I>&gt;<i> NetfilterInterception: address: local=192.168.180.1:2412 
</I>&gt;<i> remote=192.168.180.10:48582 FD 37 flags=33
</I>&gt;<i> 2022/02/23 14:56:40.669 kid1| ERROR: NAT/TPROXY lookup failed to locate 
</I>&gt;<i> original IPs on local=192.168.180.1:2412 remote=192.168.180.10:48582 FD 
</I>&gt;<i> 37 flags=33
</I>

These can happen if the NAT table entries expire or otherwise get 
dropped by conntrack between the client initiating TCP SYN and Squid 
accept(2) receiving the connection.

Your config looks good to me and the lack of regularity indicates the 
issue is likely this type of transient state situation.
  Is this happening at times of unusually high client connections 
through the NAT?
  Is eCAP processing blocking the Squid worker for all those seconds?


&gt;<i> 2022/02/23 14:56:40.669 kid1| 5,5| src/comm/TcpAcceptor.cc(287) 
</I>&gt;<i> acceptOne: non-recoverable error: FD 21, [::] [ job2] handler 
</I>&gt;<i> Subscription: 0x55edac3d08d0*1
</I>&gt;<i> 
</I>&gt;<i> Sometimes, this only appears on on of the two interception ports, 
</I>&gt;<i> sometimes on both. After that, the squid worker does not poll the 
</I>&gt;<i> intercept listen port any longer, i.e. stops working.
</I>
That part is likely to be the issue recently worked around by 
&lt;<A HREF="http://www.squid-cache.org/Versions/v6/changesets/squid-6-9fd3e68c3d0dfd6035db98ce142cf425be6c5fc1.patch">http://www.squid-cache.org/Versions/v6/changesets/squid-6-9fd3e68c3d0dfd6035db98ce142cf425be6c5fc1.patch</A>&gt;


Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="024551.html">[squid-users] getsockopt failures, although direct access to intercept ports is blocked
</A></li>
	<LI>Next message (by thread): <A HREF="024581.html">[squid-users] [EXTERN] Re:  getsockopt failures, although direct access to intercept ports is blocked
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24572">[ date ]</a>
              <a href="thread.html#24572">[ thread ]</a>
              <a href="subject.html#24572">[ subject ]</a>
              <a href="author.html#24572">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
