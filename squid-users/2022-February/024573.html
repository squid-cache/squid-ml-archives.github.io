<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Trying to set up SSL cache
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Trying%20to%20set%20up%20SSL%20cache&In-Reply-To=%3C776152f1-8bf2-286b-6308-0eeead344674%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="024552.html">
   <LINK REL="Next"  HREF="024583.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Trying to set up SSL cache</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Trying%20to%20set%20up%20SSL%20cache&In-Reply-To=%3C776152f1-8bf2-286b-6308-0eeead344674%40treenet.co.nz%3E"
       TITLE="[squid-users] Trying to set up SSL cache">squid3 at treenet.co.nz
       </A><BR>
    <I>Fri Feb 25 11:16:30 UTC 2022</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="024552.html">[squid-users] Trying to set up SSL cache
</A></li>
        <LI>Next message (by thread): <A HREF="024583.html">[squid-users] Trying to set up SSL cache
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24573">[ date ]</a>
              <a href="thread.html#24573">[ thread ]</a>
              <a href="subject.html#24573">[ subject ]</a>
              <a href="author.html#24573">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 24/02/22 15:26, Dave Blanchard wrote:
&gt;<i> Hello, I'm trying to configure Squid as a HTTPS cache on my local computer, using ssl-bump. I've got it working as a basic proxy, but the traffic seems to just be tunneling through and not being cached.
</I>
Do you actually get at least *2* (maybe 3) Squid access.log entries per 
client connection demonstrating that?


&gt;<i> My web browser shows the site's actual certificate, rather than the locally generated self-signed certificate, which I want it to see. I have followed every tutorial I can find and none of them are helpful in figuring out what the hell is going on here. Here is what my config file looks like:
</I>&gt;<i> 
</I>&gt;<i> [...]
</I>&gt;<i> 
</I>&gt;<i> http_port 3128 ssl-bump \
</I>&gt;<i>                 generate-host-certificates=on \
</I>&gt;<i>                 dynamic_cert_mem_cache_size=32MB \
</I>&gt;<i>                 cert=/path/to/self-signed.pem \
</I>&gt;<i>                 key=/path/to/self-signed.pem
</I>&gt;<i> 
</I>&gt;<i> sslcrtd_program /usr/libexec/security_file_certgen -s /path/to/ssl-database -M 32MB
</I>&gt;<i> 
</I>&gt;<i> ssl_bump peek all
</I>
Okay TLS handshake clientHello gets observed by Squid.

At this point you should see 2 CONNECT requests in access.log, first 
(step1) with raw-IP and second (step2) with the TLS SNI from this 
clientHello (if any, otherwise raw-IP again).


&gt;<i> ssl_bump bump all
</I>
... now (step3) everything gets decrypted.

At this point you should start seeing access.log entries with <A HREF="https://">https://</A> 
URLs and the actual server name per the serverHello certificate.


&gt;<i> ssl_bump splice localhost
</I>&gt;<i> 
</I>
The connection is already bump'ed. This rule can never be reached.


&gt;<i> [...]
</I>&gt;<i> 
</I>&gt;<i> Otherwise, it's pretty much just the default config. The only thing that seems to halfway work is removing the line:
</I>&gt;<i> 
</I>&gt;<i> http_access deny CONNECT !SSL_ports
</I>&gt;<i> 
</I>&gt;<i> and changing to:
</I>&gt;<i> 
</I>&gt;<i> http_access deny CONNECT
</I>&gt;<i> 
</I>
This actively rejects *all* CONNECT messages. Including the one Squid 
uses internally for SSL-Bump step1.


&gt;<i> With that change, an older Chromium just hangs trying to load the page, saying &quot;Processing request.&quot; On a WebKit-based browser, I get a Squid 'Access Denied' error page.
</I>
As expected with a &quot;deny CONNECT&quot; rule on a CONNECT request.

This is actually the best outcome right now. It means the SSL-Bump 
crypto part is working fine for at least this second client.

What you need to do next is figure out which of your other rules is 
causing things to go wrong when the HTTP message inside the TLS is received.

For example; whether it is actually *HTTP/1* messages arriving. Other 
things will revert back to tunneling (see 
&lt;<A HREF="http://www.squid-cache.org/Doc/config/on_unsupported_protocol/">http://www.squid-cache.org/Doc/config/on_unsupported_protocol/</A>&gt;)


&gt;<i> Another WebKit browser complains about the certificate, but when I tell it to continue anyway, it gives the same 'Access Denied' page.
</I>&gt;<i> A newer Chromium stops right away with an untrusted SSL certificate error, and the details look like it's getting the self-signed certificate, as expected.
</I>&gt;<i> 
</I>
These clients do not trust the CA Squid is using as signing cert. That 
will need to be fixed to avoid the cert complaint, but does not 
otherwise make any difference to the main issue.


You could use these browsers to test if you don't mind the popup. But I 
recommend the one which already trusts Squids signing CA until you have 
the rest of the basics working.



There are a few things to be aware of while troubleshooting:

* not all TLS connections can be bump'ed. TLS is designed to prevent 
exactly the type of decrypt that bump does. If the client and server are 
using TLS properly bump *will* fail.


* Google are known to be rather pedantic about security. So having their 
software at either end of the TLS when testing is more likely to hit 
such non-decryptable TLS connections.


* Checking the test web service for TLS certificate pinning or DANE. 
Both of these lock the/some client into using the original server 
certificate and they will unavoidably reject the Squid signing CA.

* Check traffic from the web server for HTTPS-Transport-Security or 
Alt-Svc HTTP headers. Both of these can break SSL-Bump if they reach a 
client. What is worse they can force arbitrarily long cache times for 
the info they contain, causing breakage to extend across the whole 
period. Only a full client purge of state and never receiving the info 
again can via any protocol fix these.


Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="024552.html">[squid-users] Trying to set up SSL cache
</A></li>
	<LI>Next message (by thread): <A HREF="024583.html">[squid-users] Trying to set up SSL cache
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24573">[ date ]</a>
              <a href="thread.html#24573">[ thread ]</a>
              <a href="subject.html#24573">[ subject ]</a>
              <a href="author.html#24573">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
