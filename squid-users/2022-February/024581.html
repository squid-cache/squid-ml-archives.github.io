<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] [EXTERN] Re:  getsockopt failures, although direct access to intercept ports is blocked
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20%5BEXTERN%5D%20Re%3A%20%20getsockopt%20failures%2C%0A%20although%20direct%20access%20to%20intercept%20ports%20is%20blocked&In-Reply-To=%3C20220225161619.Horde.7gf_rdQ4chkiUNDGk0wWqQK%40webmail.intern.securepoint.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="024572.html">
   <LINK REL="Next"  HREF="024552.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] [EXTERN] Re:  getsockopt failures, although direct access to intercept ports is blocked</H1>
    <B>Andreas Weigel</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20%5BEXTERN%5D%20Re%3A%20%20getsockopt%20failures%2C%0A%20although%20direct%20access%20to%20intercept%20ports%20is%20blocked&In-Reply-To=%3C20220225161619.Horde.7gf_rdQ4chkiUNDGk0wWqQK%40webmail.intern.securepoint.de%3E"
       TITLE="[squid-users] [EXTERN] Re:  getsockopt failures, although direct access to intercept ports is blocked">andreas.weigel at securepoint.de
       </A><BR>
    <I>Fri Feb 25 16:16:19 UTC 2022</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="024572.html">[squid-users] getsockopt failures, although direct access to intercept ports is blocked
</A></li>
        <LI>Next message (by thread): <A HREF="024552.html">[squid-users] Trying to set up SSL cache
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24581">[ date ]</a>
              <a href="thread.html#24581">[ thread ]</a>
              <a href="subject.html#24581">[ subject ]</a>
              <a href="author.html#24581">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Amos,

thank you so much for your reply. I was starting to suspect that the  
cause was located somewhere outside Squid or its config.

&gt;<i>  Is this happening at times of unusually high client connections  
</I>&gt;<i> through the NAT?
</I>&gt;<i>  Is eCAP processing blocking the Squid worker for all those seconds?
</I>
I was only able to reproduce the issue by provoking multiple  
long-running ecap transactions by curl-ing a certain .deb file. In my  
little test setup, there was not much of other client traffic (only  
one client with an open browser). The eCAP Adapter uses poll to wait  
for the response of a virus scanner on a unix domain socket, so yes, I  
assume this blocks the worker. I will probably have to look into Async  
operation with regard to this issue.

&gt;<i> That part is likely to be the issue recently worked around by
</I>
Thanks for the patch, I will definitely try it, this will already go a  
long way to help mitigate the problem.

Kind regards,
Andreas

Zitat von Amos Jeffries &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt;:

&gt;<i> On 24/02/22 12:05, Andreas Weigel wrote:
</I>&gt;&gt;<i> Hi everyone,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I had the following issue with Squid in Transparent Mode (and SSL  
</I>&gt;&gt;<i> Interception in mode splice). It is working as expected, however  
</I>&gt;&gt;<i> after multiple long-running (talking about several seconds)  
</I>&gt;&gt;<i> anti-virus ecap-Processes have finished, I *sometimes* get the  
</I>&gt;&gt;<i> following in the log:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> 2022/02/23 14:56:40.668 kid1| 5,2| src/comm/TcpAcceptor.cc(224)  
</I>&gt;&gt;<i> doAccept: New connection on FD 21
</I>&gt;&gt;<i> 2022/02/23 14:56:40.668 kid1| 5,2| src/comm/TcpAcceptor.cc(312)  
</I>&gt;&gt;<i> acceptNext: connection on local=[::]:2412 remote=[::] FD 21 flags=41
</I>&gt;&gt;<i> 2022/02/23 14:56:40.668 kid1| 89,5| src/ip/Intercept.cc(405)  
</I>&gt;&gt;<i> Lookup: address BEGIN: me/client= 192.168.180.1:2412,  
</I>&gt;&gt;<i> destination/me= 192.168.180.10:48582
</I>&gt;&gt;<i> 2022/02/23 14:56:40.668 kid1| ERROR: NF getsockopt(ORIGINAL_DST)  
</I>&gt;&gt;<i> failed on local=192.168.180.1:2412 remote=192.168.180.10:48582 FD  
</I>&gt;&gt;<i> 37 flags=33: (2) No such file or directory
</I>&gt;&gt;<i> 2022/02/23 14:56:40.669 kid1| 89,9| src/ip/Intercept.cc(151)  
</I>&gt;&gt;<i> NetfilterInterception: address: local=192.168.180.1:2412  
</I>&gt;&gt;<i> remote=192.168.180.10:48582 FD 37 flags=33
</I>&gt;&gt;<i> 2022/02/23 14:56:40.669 kid1| ERROR: NAT/TPROXY lookup failed to  
</I>&gt;&gt;<i> locate original IPs on local=192.168.180.1:2412  
</I>&gt;&gt;<i> remote=192.168.180.10:48582 FD 37 flags=33
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> These can happen if the NAT table entries expire or otherwise get  
</I>&gt;<i> dropped by conntrack between the client initiating TCP SYN and Squid  
</I>&gt;<i> accept(2) receiving the connection.
</I>&gt;<i>
</I>&gt;<i> Your config looks good to me and the lack of regularity indicates  
</I>&gt;<i> the issue is likely this type of transient state situation.
</I>&gt;<i>  Is this happening at times of unusually high client connections  
</I>&gt;<i> through the NAT?
</I>&gt;<i>  Is eCAP processing blocking the Squid worker for all those seconds?
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> 2022/02/23 14:56:40.669 kid1| 5,5| src/comm/TcpAcceptor.cc(287)  
</I>&gt;&gt;<i> acceptOne: non-recoverable error: FD 21, [::] [ job2] handler  
</I>&gt;&gt;<i> Subscription: 0x55edac3d08d0*1
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Sometimes, this only appears on on of the two interception ports,  
</I>&gt;&gt;<i> sometimes on both. After that, the squid worker does not poll the  
</I>&gt;&gt;<i> intercept listen port any longer, i.e. stops working.
</I>&gt;<i>
</I>&gt;<i> That part is likely to be the issue recently worked around by  
</I>&gt;<i> &lt;<A HREF="http://www.squid-cache.org/Versions/v6/changesets/squid-6-9fd3e68c3d0dfd6035db98ce142cf425be6c5fc1.patch">http://www.squid-cache.org/Versions/v6/changesets/squid-6-9fd3e68c3d0dfd6035db98ce142cf425be6c5fc1.patch</A>&gt;
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Amos
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>



</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="024572.html">[squid-users] getsockopt failures, although direct access to intercept ports is blocked
</A></li>
	<LI>Next message (by thread): <A HREF="024552.html">[squid-users] Trying to set up SSL cache
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24581">[ date ]</a>
              <a href="thread.html#24581">[ thread ]</a>
              <a href="subject.html#24581">[ subject ]</a>
              <a href="author.html#24581">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
