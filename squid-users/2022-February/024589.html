<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] peek &amp; splice only to log ssl info
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20peek%20%26%20splice%20only%20to%20log%20ssl%20info&In-Reply-To=%3C6aa96517-cdf8-e6ef-ea71-3279897f327b%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="024585.html">
   <LINK REL="Next"  HREF="024592.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] peek &amp; splice only to log ssl info</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20peek%20%26%20splice%20only%20to%20log%20ssl%20info&In-Reply-To=%3C6aa96517-cdf8-e6ef-ea71-3279897f327b%40measurement-factory.com%3E"
       TITLE="[squid-users] peek &amp; splice only to log ssl info">rousskov at measurement-factory.com
       </A><BR>
    <I>Fri Feb 25 23:07:11 UTC 2022</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="024585.html">[squid-users] peek &amp; splice only to log ssl info
</A></li>
        <LI>Next message (by thread): <A HREF="024592.html">[squid-users] Squid 5 OOM
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24589">[ date ]</a>
              <a href="thread.html#24589">[ thread ]</a>
              <a href="subject.html#24589">[ subject ]</a>
              <a href="author.html#24589">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 2/25/22 14:36, Matus UHLAR - fantomas wrote:

&gt;<i> I only intend to splice connections but after repeated reading 
</I>&gt;<i> <A HREF="https://wiki.squid-cache.org/Features/SslPeekAndSplice">https://wiki.squid-cache.org/Features/SslPeekAndSplice</A> I still don't 
</I>&gt;<i> understand parts of the logic.
</I>&gt;<i> 
</I>&gt;<i> - is the combination described at:
</I>&gt;<i> <A HREF="https://wiki.squid-cache.org/Features/SslPeekAndSplice#Basic_Splicing_and_Bumping">https://wiki.squid-cache.org/Features/SslPeekAndSplice#Basic_Splicing_and_Bumping</A> 
</I>&gt;<i> 
</I>&gt;<i> enough for logging SNI and cert info?
</I>
There are three combinations described in that section. The first peeks 
at SNI and certificate info (so the answer is &quot;yes&quot;). The other two are 
more complex and may not have access to some of that info in some cases.


&gt;<i> - are peek and they completely equal at step 1?
</I>
Bugs notwithstanding, Squid does the same thing right after discovering 
that a peek or stare rule matched during step1 -- Squid tries to look at 
the TLS client Hello message (where SNI is stored).

The difference, if any, only comes after Squid looks at that 
ClientHello. Bugs notwithstanding(*), if no ssl_bump rule matches during 
step2, then the next Squid action will be either splice or bump, 
depending on which rule (peek or stare) matched at the first step.

By using &quot;peek&quot;, you tell Squid that you intend to splice if everything 
goes alright; and by using stare, you tell Squid that you intend to 
bump. After step1, you can still change your mind (because the immediate 
Squid operations are the same -- look at ClientHello). After step2, you 
cannot (because Squid operations differ and, in modern environments, 
peeking precludes future bumping and staring precludes future splicing 
as detailed further below).

(*) There are recently discovered bugs in this area (that we are 
fixing), so you should not rely on this, but that is what Squid will be 
doing when those bugs are fixed. I do not recommend relying on such 
&quot;defaults&quot; anyway -- make sure the step after a peek or stare rule match 
has a matching rule.


&gt;<i> - what's the difference between peek and splice that makes it impossible 
</I>&gt;<i>  &#160; (most of the time) to splice (stare) or bump (peek) the connection?
</I>
* When Squid peeks, it forwards the user agent TLS client Hello message 
to the TLS server intact. After forwarding that virgin Hello, Squid 
cannot become a part of the TLS conversation. Squid has to splice or 
terminate the connections, which are both TCP- not TLS-level operations.

* When Squid stares, Squid modifies the TLS client Hello received from 
the user agent to use Squid-specific TLS secrets and then sends the 
adapted ClientHello to the TLS server. After that, it is impossible for 
Squid to get out of the loop -- the conversation is now based on 
Squid-provided secrets. Squid has to bump or terminate the connections.


HTH,

Alex.

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="024585.html">[squid-users] peek &amp; splice only to log ssl info
</A></li>
	<LI>Next message (by thread): <A HREF="024592.html">[squid-users] Squid 5 OOM
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24589">[ date ]</a>
              <a href="thread.html#24589">[ thread ]</a>
              <a href="subject.html#24589">[ subject ]</a>
              <a href="author.html#24589">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
