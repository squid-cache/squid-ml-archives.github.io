<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Significant memory leak with version 5.x (not with 4.17)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Significant%20memory%20leak%20with%20version%205.x%20%28not%0A%20with%204.17%29&In-Reply-To=%3C72DD5D5CF661B5459DC08A060BF26B53010897EE%40kjj-server.KJJ.local%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="024393.html">
   <LINK REL="Next"  HREF="024407.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Significant memory leak with version 5.x (not with 4.17)</H1>
    <B>Lou&#269;ansk&#253; Luk&#225;&#353;</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Significant%20memory%20leak%20with%20version%205.x%20%28not%0A%20with%204.17%29&In-Reply-To=%3C72DD5D5CF661B5459DC08A060BF26B53010897EE%40kjj-server.KJJ.local%3E"
       TITLE="[squid-users] Significant memory leak with version 5.x (not with 4.17)">Loucansky.Lukas at kjj.cz
       </A><BR>
    <I>Thu Jan 13 15:37:39 UTC 2022</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="024393.html">[squid-users] Significant memory leak with version 5.x (not with 4.17)
</A></li>
        <LI>Next message (by thread): <A HREF="024407.html">[squid-users] Significant memory leak with version 5.x (not with 4.17)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24404">[ date ]</a>
              <a href="thread.html#24404">[ thread ]</a>
              <a href="subject.html#24404">[ subject ]</a>
              <a href="author.html#24404">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello,
my squid 5.3 with 957 patch runs for 6 days now - so everything seems ok. 

	Maximum Resident Size: 3798688 KB
Memory accounted for:
	Total accounted:       326687 KB

But - I'd like to ask if I'm doing anything wrong. Am I correct when I think, that patch #957 is not backported/merged to tunnel.cc for v5.3 at the git repo v5 branch? Neither in the squid-5.3-20220112-r8ac83ed55 build avaible at the squid cache web page? But tunnel.cc file in the master (v6) branch is patched? As there is a &quot;small&quot; warning not to use v6 in production - I'd like to ask if is it wise to modify tunnel.cc file like I did it in my current 5.3-20211214-r832aa256c. Or it would be better to switch to git master branch. 

But FYI I had a compilation error due -wshadow option:

XactionRep.cc  -fPIC -DPIC -o .libs/libecapsquid_la-XactionRep.o
XactionRep.cc: In member function &#8216;const libecap::Area Adaptation::Ecap::XactionRep::masterxSharedValue(const libecap::Name&amp;) const&#8217;:
XactionRep.cc:174:20: error: declaration of &#8216;String name&#8217; shadows a parameter [-Werror=shadow]
             String name, value;
                    ^~~~
XactionRep.cc:166:71: note: shadowed declaration is here
 Adaptation::Ecap::XactionRep::masterxSharedValue(const libecap::Name &amp;name) const
                                                  ~~~~~~~~~~~~~~~~~~~~~^~~~
XactionRep.cc: In member function &#8216;void Adaptation::Ecap::XactionRep::updateHistory(Http::Message*)&#8217;:
XactionRep.cc:486:33: error: declaration of &#8216;services&#8217; shadows a previous local [-Werror=shadow]
         if (const libecap::Area services = theMaster-&gt;option(libecap::metaNextServices)) {
                                 ^~~~~~~~
XactionRep.cc:485:16: note: shadowed declaration is here
         String services;
                ^~~~~~~~
At global scope:
cc1plus: error: unrecognized command line option &#8216;-Wno-unused-private-field&#8217; [-Werror]


gcc -v
Using built-in specs.
COLLECT_GCC=gcc
COLLECT_LTO_WRAPPER=/usr/lib/gcc/x86_64-linux-gnu/8/lto-wrapper
OFFLOAD_TARGET_NAMES=nvptx-none
OFFLOAD_TARGET_DEFAULT=1
Target: x86_64-linux-gnu
Configured with: ../src/configure -v --with-pkgversion='Debian 8.3.0-6' --with-bugurl=<A HREF="file:///usr/share/doc/gcc-8/README.Bugs">file:///usr/share/doc/gcc-8/README.Bugs</A> --enable-languages=c,ada,c++,go,brig,d,fortran,objc,obj-c++ --prefix=/usr --with-gcc-major-version-only --program-suffix=-8 --program-prefix=x86_64-linux-gnu- --enable-shared --enable-linker-build-id --libexecdir=/usr/lib --without-included-gettext --enable-threads=posix --libdir=/usr/lib --enable-nls --enable-bootstrap --enable-clocale=gnu --enable-libstdcxx-debug --enable-libstdcxx-time=yes --with-default-libstdcxx-abi=new --enable-gnu-unique-object --disable-vtable-verify --enable-libmpx --enable-plugin --enable-default-pie --with-system-zlib --with-target-system-zlib --enable-objc-gc=auto --enable-multiarch --disable-werror --with-arch-32=i686 --with-abi=m64 --with-multilib-list=m32,m64,mx32 --enable-multilib --with-tune=generic --enable-offload-targets=nvptx-none --without-cuda-driver --enable-checking=release --build=x86_64-linux-gnu --host=x86_64-linux-gnu --target=x86_64-linux-gnu
Thread model: posix
gcc version 8.3.0 (Debian 8.3.0-6)

Description:    Debian GNU/Linux 10 (buster)

I have noticed differences in the configure.ac file between v5 and v6 branches.But the file src/adaptation/ecap/XactionRep.cc is the same. My configure command line is the same for both versions. So I commented out #SQUID_CC_ADD_CXXFLAG_IF_SUPPORTED([-Wshadow]) in the configure.ac and run bootstrap, config, make again.

After that - squid is compiled without any problems:
./squid -v
Squid Cache: Version 6.0.0-VCS
Service Name: squid
v6 master

This binary uses OpenSSL 1.1.1d  10 Sep 2019. For legal restrictions on distribution see <A HREF="https://www.openssl.org/source/license.html">https://www.openssl.org/source/license.html</A>

configure options:  '--build=x86_64-linux-gnu' '--prefix=/usr' '--includedir=/include' '--mandir=/share/man' '--infodir=/share/info' '--sysconfdir=/etc' '--localstatedir=/var' '--libexecdir=/lib/squid5' '--disable-maintainer-mode' '--disable-silent-rules' '--datadir=/usr/share/squid5' '--sysconfdir=/etc/squid5' '--mandir=/usr/share/man' '--enable-build-info=v6 master' '--enable-inline' '--enable-arp-acl' '--disable-wccp' '--disable-wccp2' '--disable-htcp--disable-arch-native' '--enable-storeio=ufs,aufs,diskd,rock' '--enable-removal-policies=lru,heap' '--enable-delay-pools' '--enable-cache-digests' '--enable-icap-client' '--enable-follow-x-forwarded-for' '--enable-auth-basic=DB,fake,getpwnam,LDAP,NCSA,NIS,PAM,POP3,RADIUS,SASL,SMB' '--enable-auth-digest=file,LDAP' '--enable-auth-negotiate=kerberos,wrapper' '--enable-auth-ntlm=fake,SMB_LM' '--enable-external-acl-helpers=file_userip,kerberos_ldap_group,LDAP_group,session,SQL_session,time_quota,unix_group,wbinfo_group' '--enable-url-rewrite-helpers=fake' '--enable-security-cert-validators=fake' '--enable-storeid-rewrite-helpers=file' '--enable-eui' '--enable-esi' '--enable-icmp' '--enable-zph-qos' '--enable-ecap' '--enable-snmp' '--disable-ident-lookups' '--disable-translation' '--with-swapdir=/var/spool/squid5' '--with-logdir=/var/log/squid5' '--with-pidfile=/var/run/squid5.pid' '--with-large-files' '--with-default-user=proxy' '--with-openssl' '--with-filedescriptors=8192' '--enable-ssl-crtd' '--enable-security-cert-generators' '--enable-security-cert-validators' '--enable-linux-netfilter' '--enable-stacktraces' 'PKG_CONFIG_PATH=:/usr/local/lib/pkgconfig:/usr/lib64/pkgconfig:/usr/share/pkgconfig' 'CFLAGS=-g -O2 -m64 -fPIE -fstack-protector-strong -Wformat -Werror=format-security -Wall' 'LDFLAGS=-fPIE -pie -Wl,-z,relro -Wl,-z,now' 'CPPFLAGS=-D_FORTIFY_SOURCE=2' 'CXXFLAGS=-g -O2 -m64 -fPIE -fstack-protector-strong -Wformat -Werror=format-security' 'build_alias=x86_64-linux-gnu'

Sorry for a little thread hijack, but I'd like to confirm that the patch 957 seems to work and ask for advice about v5 brach on the github vs v6/master.

THX
LL

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="024393.html">[squid-users] Significant memory leak with version 5.x (not with 4.17)
</A></li>
	<LI>Next message (by thread): <A HREF="024407.html">[squid-users] Significant memory leak with version 5.x (not with 4.17)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24404">[ date ]</a>
              <a href="thread.html#24404">[ thread ]</a>
              <a href="subject.html#24404">[ subject ]</a>
              <a href="author.html#24404">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
