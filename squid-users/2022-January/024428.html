<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] 4.17 and 5.3 SSL BUMP issue: SSL_ERROR_RX_RECORD_TOO_LONG
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%204.17%20and%205.3%20SSL%20BUMP%20issue%3A%0A%20SSL_ERROR_RX_RECORD_TOO_LONG&In-Reply-To=%3Ceca4aa31-238e-0d7f-b36c-021cd7629696%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="024427.html">
   <LINK REL="Next"  HREF="024429.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] 4.17 and 5.3 SSL BUMP issue: SSL_ERROR_RX_RECORD_TOO_LONG</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%204.17%20and%205.3%20SSL%20BUMP%20issue%3A%0A%20SSL_ERROR_RX_RECORD_TOO_LONG&In-Reply-To=%3Ceca4aa31-238e-0d7f-b36c-021cd7629696%40measurement-factory.com%3E"
       TITLE="[squid-users] 4.17 and 5.3 SSL BUMP issue: SSL_ERROR_RX_RECORD_TOO_LONG">rousskov at measurement-factory.com
       </A><BR>
    <I>Mon Jan 24 19:53:57 UTC 2022</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="024427.html">[squid-users] 4.17 and 5.3 SSL BUMP issue: SSL_ERROR_RX_RECORD_TOO_LONG
</A></li>
        <LI>Next message (by thread): <A HREF="024429.html">[squid-users] Reverse DNS lookups from squid logging port
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24428">[ date ]</a>
              <a href="thread.html#24428">[ thread ]</a>
              <a href="subject.html#24428">[ subject ]</a>
              <a href="author.html#24428">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 1/24/22 1:06 PM, Eliezer Croitoru wrote:
&gt;<i> I sat for a while thinking what is the best approach to the subject and the
</I>&gt;<i> next patch seems to be reasonable enough to me:
</I>&gt;<i> <A HREF="https://gist.github.com/elico/630fa57d161b0c0b59ef68786d801589">https://gist.github.com/elico/630fa57d161b0c0b59ef68786d801589</A>
</I>
&gt;<i> Let me know if this patch violates anything that I might not took into
</I>&gt;<i> account.
</I>
The squid-users mailing list is not a good place for code reviews. If
you think your changes should be made official, please submit a pull
request on GitHub: <A HREF="https://wiki.squid-cache.org/MergeProcedure">https://wiki.squid-cache.org/MergeProcedure</A>

FWIW, I wonder whether we should reuse and/or extend host_verify_strict
instead of adding a new squid.conf directive to control this behavior.
All other factors being equal, it would be good to have one directive to
control Host validation and its direct effects.


&gt;<i> * Tested to work in my specific scenario which I really don't care about
</I>&gt;<i> caching when I'm in a DOS situation.
</I>
When one disables checks, Squid will continue to &quot;work&quot;, of course. Did
you verify that the patched Squid:

1. Goes to the intended destination IP address rather than to Host?
2. Does not evict the matching cached responses from the cache?
3. Does not satisfy the forged request from the cache?
4. Does not share responses to requests with the &quot;forged&quot; Host?

There may be other prerequisites, and the above four may need polishing,
but these are the first conditions that come to my mind when dealing
with forgery attacks. Please disclose this information when/if posting
your changes for the Project review on GitHub.


Thank you,

Alex.

&gt;<i> ----
</I>&gt;<i> Eliezer Croitoru
</I>&gt;<i> Tech Support
</I>&gt;<i> Mobile: +972-5-28704261
</I>&gt;<i> Email: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">ngtech1ltd at gmail.com</A>
</I>&gt;<i> 
</I>&gt;<i> -----Original Message-----
</I>&gt;<i> From: squid-users &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>&gt; On Behalf Of
</I>&gt;<i> Alex Rousskov
</I>&gt;<i> Sent: Monday, January 24, 2022 16:54
</I>&gt;<i> To: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> Subject: Re: [squid-users] 4.17 and 5.3 SSL BUMP issue:
</I>&gt;<i> SSL_ERROR_RX_RECORD_TOO_LONG
</I>&gt;<i> 
</I>&gt;<i> On 1/24/22 2:42 AM, Eliezer Croitoru wrote:
</I>&gt;&gt;<i> 2022/01/24 09:11:20 kid1| SECURITY ALERT: Host header forgery detected on
</I>&gt;&gt;<i> local=142.250.179.228:443 remote=10.200.191.171:51831 FD 16 flags=33
</I>&gt;<i> (local
</I>&gt;&gt;<i> IP does not match any domain IP)
</I>&gt;<i> 
</I>&gt;<i> As you know, Squid improvements related to these messages have been
</I>&gt;<i> discussed many times. I bet the ideas summarized in the following old
</I>&gt;<i> email remain valid today:
</I>&gt;<i> 
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/pipermail/squid-users/2019-July/020764.html">http://lists.squid-cache.org/pipermail/squid-users/2019-July/020764.html</A>
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> If you would like to address browser's SSL_ERROR_RX_RECORD_TOO_LONG
</I>&gt;<i> specifically (the error in your email Subject line), then that is a
</I>&gt;<i> somewhat different matter: According to your packet capture, Squid sends
</I>&gt;<i> a plain text HTTP 409 response to a TLS client. That is not going to
</I>&gt;<i> work with popular browsers (for various technical and policy reasons).
</I>&gt;<i> 
</I>&gt;<i> Depending on the SslBump stage where the Host header forgery was
</I>&gt;<i> detected, Squid could bump the client connection to deliver that error
</I>&gt;<i> response; in that case, the browser may still refuse to show the
</I>&gt;<i> response to the user because the browser will not trust the certificate
</I>&gt;<i> that Squid would have to fake without sufficient origin server info.
</I>&gt;<i> However, the browser error will be different and arguably less confusing
</I>&gt;<i> to admins and even users.
</I>&gt;<i> 
</I>&gt;<i> <A HREF="https://wiki.squid-cache.org/SquidFaq/AboutSquid#How_to_add_a_new_Squid_feat">https://wiki.squid-cache.org/SquidFaq/AboutSquid#How_to_add_a_new_Squid_feat</A>
</I>&gt;<i> ure.2C_enhance.2C_of_fix_something.3F
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> HTH,
</I>&gt;<i> 
</I>&gt;<i> Alex.
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i> 
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="024427.html">[squid-users] 4.17 and 5.3 SSL BUMP issue: SSL_ERROR_RX_RECORD_TOO_LONG
</A></li>
	<LI>Next message (by thread): <A HREF="024429.html">[squid-users] Reverse DNS lookups from squid logging port
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24428">[ date ]</a>
              <a href="thread.html#24428">[ thread ]</a>
              <a href="subject.html#24428">[ subject ]</a>
              <a href="author.html#24428">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
