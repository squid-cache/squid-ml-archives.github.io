<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Tune Squid proxy to handle 90k connection
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Tune%20Squid%20proxy%20to%20handle%2090k%20connection&In-Reply-To=%3C%21%26%21AAAAAAAAAAAuAAAAAAAAAJJD97gEMN5Ch2HBNn/5W3IBAMO2jhD3dRHOtM0AqgC7tuYAAAAAAA4AABAAAACQee6iB%2B9UQbA7yyJVYK9FAQAAAAA%3D%40articatech.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="024454.html">
   <LINK REL="Next"  HREF="024457.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Tune Squid proxy to handle 90k connection</H1>
    <B>Andr&#233; Bolinhas</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Tune%20Squid%20proxy%20to%20handle%2090k%20connection&In-Reply-To=%3C%21%26%21AAAAAAAAAAAuAAAAAAAAAJJD97gEMN5Ch2HBNn/5W3IBAMO2jhD3dRHOtM0AqgC7tuYAAAAAAA4AABAAAACQee6iB%2B9UQbA7yyJVYK9FAQAAAAA%3D%40articatech.com%3E"
       TITLE="[squid-users] Tune Squid proxy to handle 90k connection">andre.bolinhas at articatech.com
       </A><BR>
    <I>Mon Jan 31 13:46:51 UTC 2022</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="024454.html">[squid-users] Tune Squid proxy to handle 90k connection
</A></li>
        <LI>Next message (by thread): <A HREF="024457.html">[squid-users] Tune Squid proxy to handle 90k connection
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24456">[ date ]</a>
              <a href="thread.html#24456">[ thread ]</a>
              <a href="subject.html#24456">[ subject ]</a>
              <a href="author.html#24456">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi

I will not use cache in this project.

Yes, I will need

*	ACL (based on Domain, AD user, Headers, User Agent&#8230;)
*	Authentication
*	SSL bump just for one domain.
*	DNS resolution (I will use Unbound DNS service for this)

 

Also, I will divide the traffic between two Squid box instead just one.

 

So each box will handle around 50k request.

 

Each box have:

*	CPU(s) 16
*	Threads per code 2
*	Cores per socket 8
*	Sockets 1
*	Inter Xeron Silver 4208  @ 2.10GHz
*	96GB Ram
*	1TB raid-0 SSD

 

At this time I have 5 workers on each Squid box and the Squid version is 4.17, do you recommend more workers or upgrade the squid version to 5?

 

Best regards

 

De: NgTech LTD &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">ngtech1ltd at gmail.com</A>&gt; 
Enviada: 31 de janeiro de 2022 04:59
Para: Andr&#233; Bolinhas &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">andre.bolinhas at articatech.com</A>&gt;
Cc: Squid Users &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>&gt;
Assunto: Re: [squid-users] Tune Squid proxy to handle 90k connection

 

I would recommend you to start with 0 caching.

However, for choosing the right solution you must give more details.

For example there is an IBM reasearch that prooved that for about 90k connections you can use vm's ontop of such hardware with apache web server.

If you do have the set of the other requirements from the proxy else then the 90k requests it would be wise to mention them.

 

Do you need any specific acls?

Do you need authentication?

etc..

 

For a simple forward proxy I would suggest to use a simpler solution and if possible to not log anything as a starter point.

Any local disk i/o will slow down the machine.

 

About the url categorization, I do not have experience with ufdbguard on such scale but it would be pretty heavy for any software to handle 90k rps...

 It's doable to implement such setup but will require testing.

Will you use ssl bump in this setup?

 

If I will have all the technical and specs/requirements details I might be able to suggest better then now.

Take into account that each squid worker can handle about 3k rps tops(with my experience) and it's a juggling between two sides so... 3k is really 3k+3k+external_acls+dns...

 

I believe that in this case an example of configuration from the squid developers might be usefull.

 

Eliezer

 

 

&#1489;&#1514;&#1488;&#1512;&#1497;&#1498; &#1497;&#1493;&#1501; &#1490;&#1523;, 25 &#1489;&#1497;&#1504;&#1493;&#1523; 2022, 18:42, &#1502;&#1488;&#1514; Andr&#233; Bolinhas &#8207;&lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">andre.bolinhas at articatech.com</A> &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">andre.bolinhas at articatech.com</A>&gt; &gt;:

Any tip about my last comment?

-----Mensagem original-----
De: Andr&#233; Bolinhas &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">andre.bolinhas at articatech.com</A> &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">andre.bolinhas at articatech.com</A>&gt; &gt; 
Enviada: 21 de janeiro de 2022 16:36
Para: 'Amos Jeffries' &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A> &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt; &gt;; <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A> &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>&gt; 
Assunto: RE: [squid-users] Tune Squid proxy to handle 90k connection

Thanks Amos
Yes, you are right, I will put a second box with HaProxy in front to balance the traffic.
About the sockets I can't double it because is a physical machine, do you think disable hyperthreading from bios will help, because we have other services inside the box that works in multi-threading, like unbound DNS?

Just more a few questions:
1&#186; The server have 92Gb of Ram, do you think that is needed that adding swap will help squid performance?
2&#186; Right now we are using squid 4.17 did you recommend upgrade or downgrade to any specific version?
3&#186; We need categorization, for this we are using an external helper to achieve it, do you recommend use this approach with ACL or move to some kind of ufdbguard service?

Best regards
-----Mensagem original-----
De: squid-users &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A> &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>&gt; &gt; Em Nome De Amos Jeffries
Enviada: 21 de janeiro de 2022 16:05
Para: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A> &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>&gt; 
Assunto: Re: [squid-users] Tune Squid proxy to handle 90k connection

Sorry for the slow reply. Responses inline.


On 14/01/22 05:44, Andr&#233; Bolinhas wrote:
&gt;<i> Hi
</I>&gt;<i> ~80k request per second  10k users
</I>

Test this, but you may need a second machine to achieve the full 80k RPS.

Latest Squid do not have any details analysis, but older Squid-3.5 were only achieving &gt;15k RPS under lab conditions, more likely expect under 10k RPS/worker on real traffic.
  That means (IME) this machine is quite likely to hit its capacity somewhere under 70k RPS.


&gt;<i> CPU info:
</I>&gt;<i> CPU(s) 16
</I>&gt;<i> Threads per code 2
</I>&gt;<i> Cores per socket 8
</I>
With this CPU you will be able to run 7 workers. Setup affinity of one core per worker (the &quot;kidN&quot; processes of Squid). Leaving one core to the OS and additional processing needs - this matters at peak loading.

CPU &quot;threads&quot; tend not to be useful for Squid. Under high loads Squid workers will consume all available cycles on their core, not leaving any for the fancy &quot;thread&quot; core sharing features to pretend there is another core available. YMMV. One of the tests to try when tuning is to turn off the CPU hyperthreading and see what effect it has (if any).


&gt;<i> Sockets 1
</I>&gt;<i> Inter Xeron Silver 4208  @ 2.10GHz
</I>&gt;<i>
</I>
Okay. Doable, but for best performance you want as high GHz rating on the cores as your budget can afford. The amount of &quot;lag&quot; Squid adds to traffic and RPS performance/parallelism directly correlates with how fast the CPU core can run cycles.



HTH
Amos
_______________________________________________
squid-users mailing list
<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A> &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>&gt; 
<A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>

_______________________________________________
squid-users mailing list
<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A> &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>&gt; 
<A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>

-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20220131/8886feb3/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20220131/8886feb3/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="024454.html">[squid-users] Tune Squid proxy to handle 90k connection
</A></li>
	<LI>Next message (by thread): <A HREF="024457.html">[squid-users] Tune Squid proxy to handle 90k connection
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24456">[ date ]</a>
              <a href="thread.html#24456">[ thread ]</a>
              <a href="subject.html#24456">[ subject ]</a>
              <a href="author.html#24456">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
