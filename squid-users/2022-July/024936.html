<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] How to &quot;active&quot; update NetDB informations ?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20How%20to%20%22active%22%20update%20NetDB%20informations%20%3F&In-Reply-To=%3C8e029e1d-45c8-a683-36b6-f5a1bcfc1ffb%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="024935.html">
   <LINK REL="Next"  HREF="024937.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] How to &quot;active&quot; update NetDB informations ?</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20How%20to%20%22active%22%20update%20NetDB%20informations%20%3F&In-Reply-To=%3C8e029e1d-45c8-a683-36b6-f5a1bcfc1ffb%40measurement-factory.com%3E"
       TITLE="[squid-users] How to &quot;active&quot; update NetDB informations ?">rousskov at measurement-factory.com
       </A><BR>
    <I>Fri Jul  1 17:00:30 UTC 2022</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="024935.html">[squid-users] How to &quot;active&quot; update NetDB informations ?
</A></li>
        <LI>Next message (by thread): <A HREF="024937.html">[squid-users] How to &quot;active&quot; update NetDB informations ?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24936">[ date ]</a>
              <a href="thread.html#24936">[ thread ]</a>
              <a href="subject.html#24936">[ subject ]</a>
              <a href="author.html#24936">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 7/1/22 10:22, Th&#233;o BARRAGUE wrote:

&gt;<i> I'm facing to issue with squid : i want to use squid to route http 
</I>&gt;<i> traffic though the fastest path ( based on RTT ).
</I>&gt;<i> 
</I>&gt;<i> Before to explain my problem, this is my configuration where :
</I>&gt;<i> 
</I>&gt;<i>   * *client* is a http client : curl, wget, firefox, ...
</I>&gt;<i>   * *squid* is a squid instance with /never_direct allow all/ option to
</I>&gt;<i>     prevent direct access but with *squid a* and *squid b* as parents
</I>&gt;<i>     peers and /query_icmp/ /on/&#160;option
</I>&gt;<i>   * *squid a* and *squid b* are squid instances that can make direct
</I>&gt;<i>     connections
</I>&gt;<i>   * all *squid *instances&#160;are cacheless and built with /--enable-icmp/
</I>&gt;<i> 
</I>&gt;<i> Now, come issues. When *squid* send a request to *squid a* or *squid b*, 
</I>&gt;<i> two ICP packets are sent ( to *squid a*&#160;and *squid b*&#160;) and the squid 
</I>&gt;<i> which do the direct connection send an icmp to origin server and squid 
</I>&gt;<i> instances update their netdb informations ( *squid a* or *squid b* 
</I>&gt;<i> &quot;locally&quot; from icmp answer and *squid* though ICP ).
</I>
Correct.


&gt;<i> If *link a*&#160;slows down, the RTT will increase and *squid*&#160;will send all 
</I>&gt;<i> requests to *squid b*&#160;because his RTT is low.
</I>
Yes (by default).


&gt;<i> But, if *link a*&#160;come back and with a lower RTT than *squid b*, *squid 
</I>&gt;<i> a*&#160;will never know because no requests are made to him until RTT on 
</I>&gt;<i> *squid b*&#160;goes up ( upper than the &quot;uppest&quot; / &quot;oldest&quot; RTT of *squid a*&#160;).
</I>
Yes, if Squid A has no reason to go to a site, it will not update its 
ICMP RTT information for that site. Squid does not probe origin sites 
unless it needs to send a request to that site.


&gt;<i> How to deal with this scenario ?
</I>
Interesting question! AFAICT, you have several options to keep RTT 
information fresh, including:

* Force some client traffic through the slower path. See 
weighted-round-robin in squid.conf.documented. This will make your 
clients suffer for the sake of keeping NetDB fresh.

* Modify Squid sources so that a parent that receives an ICP query sends 
an ICMP request to the corresponding origin server (if the available 
NetDB information became stale). This requires development and will 
double ICMP traffic from your Squid farm (because each parent will send 
an ICMP request for every HTTP transaction for a site that needs a NetDB 
record update).

* Enable active background &quot;probing&quot; of (popular?) sites through each 
parent. This will increase both ICMP and HTTP traffic from your Squid farm.

Pick your poison...

I know that you called the last solution a &quot;workaround rather than a 
good solution&quot; but I do not know what you are trying to optimize, so I 
cannot agree or disagree with that judgement.


&gt;<i> I can also restart squid a and squid b every 5 minutes for example to
</I>&gt;<i> flush netdb informations
</I>
I agree -- erasing fresh RTT information (in an actively used peer that 
has fresh NetDB) is not a good solution. If you go this route, then you 
may also need to disable the disk copy of NetDB (&quot;netdb_filename none&quot;).


HTH,

Alex.

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="024935.html">[squid-users] How to &quot;active&quot; update NetDB informations ?
</A></li>
	<LI>Next message (by thread): <A HREF="024937.html">[squid-users] How to &quot;active&quot; update NetDB informations ?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24936">[ date ]</a>
              <a href="thread.html#24936">[ thread ]</a>
              <a href="subject.html#24936">[ subject ]</a>
              <a href="author.html#24936">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
