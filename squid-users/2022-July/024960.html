<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] How to allow users authenticated to access only their own ports.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20How%20to%20allow%20users%20authenticated%20to%20access%20only%0A%20their%20own%20ports.&In-Reply-To=%3C19c59ee6-ec89-e814-569c-93486bca323a%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="024941.html">
   <LINK REL="Next"  HREF="024942.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] How to allow users authenticated to access only their own ports.</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20How%20to%20allow%20users%20authenticated%20to%20access%20only%0A%20their%20own%20ports.&In-Reply-To=%3C19c59ee6-ec89-e814-569c-93486bca323a%40treenet.co.nz%3E"
       TITLE="[squid-users] How to allow users authenticated to access only their own ports.">squid3 at treenet.co.nz
       </A><BR>
    <I>Thu Jul 14 10:15:56 UTC 2022</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="024941.html">[squid-users] How to allow users authenticated to access only their own ports.
</A></li>
        <LI>Next message (by thread): <A HREF="024942.html">[squid-users] Squid.conf in a DB Mysql
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24960">[ date ]</a>
              <a href="thread.html#24960">[ thread ]</a>
              <a href="subject.html#24960">[ subject ]</a>
              <a href="author.html#24960">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 8/07/22 11:13, Marcelo wrote:
&gt;<i> Hi everyone ;)
</I>&gt;<i> 
</I>&gt;<i> I have a little bit complex task at hand.
</I>&gt;<i> 
</I>
This is not particularly complex and comes up relatively often.


&gt;<i> What I must do:
</I>&gt;<i> 
</I>&gt;<i> 1-Allow an user to access squid only through specific port. This same 
</I>&gt;<i> user can access 1 port or several ports, depending on how many routes he 
</I>&gt;<i> have.
</I>
Why do Squid listening ports need to be linked to routes? There is 
nothing special about listening ports.

If you have a business/contractual level thing indicating that certain 
clients IP ranges can access certain port(s) that is better dealt with 
at a firewall prohibiting other IP ranges reaching those ports. Letting 
the traffic reach Squid in that case is &quot;too late&quot;.


&gt;<i> 
</I>&gt;<i> 2- Authenticated users can access only their own ports.
</I>&gt;<i> 
</I>
These are not separate items. They are achieved by the same config setup:

  http_port 3218
  acl port3128 myportname 3128

  # repeat above for each listening port

  # below lines only need to exist once

  auth_param ...
  acl login proxy_auth REQUIRED
  http_access deny !login

  external_acl_type checkUserPort \
     ttl=0 negative_ttl=0 cache=0 \
     %ul %rp \
     /path/to/ext_sql_session_acl ...

  acl userHasPort external checkUserPort
  http_access deny !userHasPort


In the DB the session helper checks you simply add entries for each 
&quot;username portname&quot; as the session ID column. Removing DB entries 
immediately stops all *new* traffic from that user account being 
accepted. You can adjust the TTL / cache options, but that will affect 
the speed of user traffic halting.


&gt;<i> 3- Every access is via IP:Port that brings the user to a different 
</I>&gt;<i> tcp_outgoing_address
</I>&gt;<i> 
</I>

Please be aware that the concept of an end-to-end route decided by one 
agent along the line is not compatible with modern networking protocols.

Firstly, you will need to disable HTTP persistence features entirely on 
outbound traffic. This erases all possibility of TCP-fast-open, HTTP 
connection sharing and multiplexing performance boosters for traffic 
going through your proxy. It will also make use of cache_peer extremely 
difficult.

   server_persistent_connections off


Next you have Squid tell the OS routing system what IP(s) each listening 
port is linked to:

   tcp_outgoing_address 192.168.0.1 port3128
   tcp_outgoing_address ::1 port3128

I would place them right after the port3128 line so it is easy to manage 
many entries and see what port+routes are linked.
   You could even place the repeated groups of 
http_access+acl+tcp_outgoing_address lines in a separate config file 
per-port to allow automated management with the include directive.


Please be aware that tcp_outgoing_address is at best a *hint* to the OS 
routing system about what IP address is preferred as outgoing. The 
routing system can itself re-assign IP related details (eg outgoing NAT 
or gateway traffic balancing).


So, if you can clarify what actual business need is leading to it being 
considered a requirement? very likely there are alternatives that will 
not break your traffic as much.




If you are interested here are some pointers on where the experiments 
went wrong ...

&gt;<i> Example
</I>&gt;<i> 
</I>&gt;<i> An user must have 2 routes:
</I>&gt;<i> 
</I>&gt;<i> 192.168.0.2:3001 this route brings this user to tcp_outgoing_address 
</I>&gt;<i> 200.2.2.11
</I>&gt;<i> 
</I>&gt;<i> 192.168.0.2:3002 this route brings this user to tcp_outgoing_address 
</I>&gt;<i> 200.2.2.12
</I>&gt;<i> 
</I>&gt;<i> Yes, every port have to route to a different tcp outgoing address.
</I>&gt;<i> 
</I>&gt;<i> The closest I could get to a solution was using this:
</I>&gt;<i> 
</I>&gt;<i> http_port 192.168.0.2:3001 name=5
</I>&gt;<i> 
</I>&gt;<i> acl ip5 myportname 5
</I>&gt;<i> 
</I>&gt;<i> tcp_outgoing_address 200.2.2.11 ip5
</I>&gt;<i> 
</I>&gt;<i> This way, an user that enters via 192.168.0.2:3001 goes out via 200.2.2.11.
</I>&gt;<i> 
</I>
It *looks* like working. But only does if the user is accessing an IPv4 
service.

You need a second tcp_outgoing_address entry to provide routing to IPv6 
services. Otherwise IPv6 traffic will completely disobey your route 
assignment policy.


&gt;<i> And its fine, but this way, every authenticated user can access all routes.
</I>&gt;<i> 
</I>&gt;<i> I have tried several ways to bind an username in this solution, but it 
</I>&gt;<i> is not working.
</I>&gt;<i> Authentication was via basic_db_auth, but I &#8220;downgraded it&#8221; to 
</I>&gt;<i> basic_ncsa_auth to simplify tests. Authentication is working fine.
</I>&gt;<i> 
</I>&gt;<i> My last try was using the setup below, but It made squid a little dizzy:
</I>&gt;<i> 
</I>&gt;<i> acl ip3 proxy_auth test myportname 3
</I>&gt;<i> 
</I>
The above will accept logins for these usernames:
   &quot;test&quot;, &quot;myportname&quot;, and &quot;3&quot;

Each &quot;acl&quot; line has a single type parameter (above &quot;proxy_auth&quot;) and 
performs a boolean 'OR' condition matching values listed after the type.



&gt;<i> http_access allow ip3
</I>&gt;<i> 
</I>
This allows the above mentioned usernames unlimited access. No criteria 
other than they had to login.


&gt;<i> http_port 192.168.0.2:2000 name=3
</I>&gt;<i> 
</I>&gt;<i> tcp_outgoing_address 200.2.2.11 ip3
</I>&gt;<i> 
</I>
This assigns the *username* to that route. No connection to the port 
they arrived at.


&gt;<i> http_access deny ip3
</I>&gt;<i> 
</I>
Never happens, &quot;ip3&quot; has already been allowed above.


Same issues for these ip4 rules

&gt;<i> acl ip4 proxy_auth test1 myportname 4
</I>&gt;<i> http_access allow ip4
</I>&gt;<i> http_port 192.168.0.2:2000 name=4
</I>&gt;<i> tcp_outgoing_address 200.2.2.12 ip4
</I>&gt;<i> http_access deny ip4
</I>&gt;<i> 
</I>
Then finally, all attempts to login that are *not* matching &quot;ip3&quot; nor 
&quot;ip4&quot; are *ALLOWED* (oops).


HTH
Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="024941.html">[squid-users] How to allow users authenticated to access only their own ports.
</A></li>
	<LI>Next message (by thread): <A HREF="024942.html">[squid-users] Squid.conf in a DB Mysql
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24960">[ date ]</a>
              <a href="thread.html#24960">[ thread ]</a>
              <a href="subject.html#24960">[ subject ]</a>
              <a href="author.html#24960">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
