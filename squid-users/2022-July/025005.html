<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] slow TCP_TUNNEL
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20slow%20TCP_TUNNEL&In-Reply-To=%3C3e14062c-b288-e78f-8470-44dfc7d6f29d%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="025004.html">
   <LINK REL="Next"  HREF="025012.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] slow TCP_TUNNEL</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20slow%20TCP_TUNNEL&In-Reply-To=%3C3e14062c-b288-e78f-8470-44dfc7d6f29d%40measurement-factory.com%3E"
       TITLE="[squid-users] slow TCP_TUNNEL">rousskov at measurement-factory.com
       </A><BR>
    <I>Mon Jul 25 19:43:52 UTC 2022</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="025004.html">[squid-users] slow TCP_TUNNEL
</A></li>
        <LI>Next message (by thread): <A HREF="025012.html">[squid-users] slow TCP_TUNNEL
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25005">[ date ]</a>
              <a href="thread.html#25005">[ thread ]</a>
              <a href="subject.html#25005">[ subject ]</a>
              <a href="author.html#25005">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 7/25/22 04:40, Katerina Bubenickova wrote:
&gt;<i> Hi,
</I>&gt;<i> We have 2 squid proxies running on Centos 6 which is very old (let's 
</I>&gt;<i> call them C1, C2) in DMZ.
</I>&gt;<i> 
</I>&gt;<i> I have installed Debian 11 bullseye and squid +squidguard, trying to use 
</I>&gt;<i> the same configuration (let's call it D1).
</I>&gt;<i> If I use this proxy for 1 pc station, all is ok.
</I>&gt;<i> If Iadded the proxy to dns as third proxy (C1+C2 + D1) or use one old 
</I>&gt;<i> proxy and the new one (C1+D1) the response of internet was very slow, 
</I>&gt;<i> unusable.
</I>&gt;<i> 
</I>&gt;<i> I tryed to fix it without success:
</I>&gt;<i> I added directive url_rewrite_children 200
</I>&gt;<i> I changed DNS from 8.8.8.8 to localhost
</I>&gt;<i> I turned off squid cache
</I>&gt;<i> I commented out squidguard
</I>&gt;<i> I migrated from one vmware server to another, better,
</I>&gt;<i> I added memory (16 GB) and CPU (6) ,
</I>&gt;<i> I added directive dns_v4_first on
</I>&gt;<i> There are no rules in D1 firewall
</I>&gt;<i> 
</I>&gt;<i> We have about 700 pc and the problem starts after 15-20 minutes after I 
</I>&gt;<i> add D1 into dns as proxy.
</I>&gt;<i> I can see it on our monitor Flowmon, where I can see value NPM response 
</I>&gt;<i> time. In normal state it is about 0.1s, when the problem arises it is up 
</I>&gt;<i> to 3s.
</I>&gt;<i> If I remove D1 from dns, all is ok after a while.
</I>&gt;<i> 
</I>&gt;<i> I&#160; tried to set IP of D1 the same as IP of C2 (of course C2 was power 
</I>&gt;<i> off) to test, whether the problem could be caused by some firewall 
</I>&gt;<i> between user pc and proxy, it doesn.t help
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> access.log of D1
</I>&gt;<i> 
</I>&gt;<i> 1658483765.546 1622444 172.19.11.101 TCP_TUNNEL/200 3635 CONNECT 
</I>&gt;<i> epns.eset.com:443 - HIER_DIRECT/91.228.167.192 -
</I>
Are all D1 transactions that slow (the second field is response time in 
milliseconds)? Or are some of them fast even when others are slow?

Is D1 Squid itself very busy (90% single CPU core utilization or 
higher)? If Squid looks idle, it is probably waiting for something like 
a DNS response or a problematic helper.

Any errors or warnings in D1 cache.log?

Can you reproduce the problem with a single curl/wget transaction that 
targets D1?


HTH,

Alex.



&gt;<i> 
</I>&gt;<i> in access.log of C1 are the time numbers a lot lower:
</I>&gt;<i> 
</I>&gt;<i> 1658491430.020&#160;&#160;&#160;&#160;&#160; 7 172.19.14.191 TCP_MISS/200 473 GET 
</I>&gt;<i> <A HREF="http://i5.c.eset.com/v1/auth/60064ADBC289880E8D77/updlist/31/eid/108/lid/108">http://i5.c.eset.com/v1/auth/60064ADBC289880E8D77/updlist/31/eid/108/lid/108</A> 
</I>&gt;<i> - DIRECT/91.228.166.45 application/octet-stream
</I>&gt;<i> 1658491430.025&#160;&#160;&#160;&#160;&#160; 6 172.19.15.72 TCP_MISS/200 473 GET 
</I>&gt;<i> <A HREF="http://i5.c.eset.com/v1/auth/60064ADBC289880E8D77/updlist/31/eid/108/lid/108">http://i5.c.eset.com/v1/auth/60064ADBC289880E8D77/updlist/31/eid/108/lid/108</A> 
</I>&gt;<i> - DIRECT/91.228.166.45 application/octet-stream
</I>&gt;<i> 1658491430.031&#160;&#160;&#160;&#160;&#160; 6 172.19.14.191 TCP_MISS/200 473 GET 
</I>&gt;<i> <A HREF="http://i5.c.eset.com/v1/auth/60064ADBC289880E8D77/updlist/32/eid/117876/lid/117876">http://i5.c.eset.com/v1/auth/60064ADBC289880E8D77/updlist/32/eid/117876/lid/117876</A> 
</I>&gt;<i> - DIRECT/91.228.166.45 application/octet-stream
</I>&gt;<i> 1658491430.038&#160;&#160;&#160; 430 172.19.14.71 TCP_MISS/200 4906 CONNECT 
</I>&gt;<i> v10.events.data.microsoft.com:443 - DIRECT/20.42.65.90 -
</I>&gt;<i> 1658491430.076&#160;&#160;&#160;&#160; 40 172.19.14.191 TCP_MISS/200 473 GET 
</I>&gt;<i> <A HREF="http://i5.c.eset.com/v1/auth/60064ADBC289880E8D77/updlist/33/eid/10185/lid/10185">http://i5.c.eset.com/v1/auth/60064ADBC289880E8D77/updlist/33/eid/10185/lid/10185</A> 
</I>&gt;<i> - DIRECT/91.228.166.45 application/octet-stream
</I>&gt;<i> 1658491430.112&#160;&#160;&#160;&#160; 55 172.19.15.72 TCP_MISS/200 473 GET 
</I>&gt;<i> <A HREF="http://i5.c.eset.com/v1/auth/60064ADBC289880E8D77/updlist/32/eid/117876/lid/117876">http://i5.c.eset.com/v1/auth/60064ADBC289880E8D77/updlist/32/eid/117876/lid/117876</A> 
</I>&gt;<i> - DIRECT/91.228.166.45 application/octet-stream
</I>&gt;<i> 1658491430.155&#160; 30017 172.19.14.186 TCP_MISS/200 62553 CONNECT 
</I>&gt;<i> armmf.adobe.com:443 - DIRECT/2.23.8.158 -
</I>&gt;<i> 1658491430.180&#160;&#160;&#160;&#160; 43 172.19.14.191 TCP_MISS/200 473 GET 
</I>&gt;<i> <A HREF="http://i5.c.eset.com/v1/auth/60064ADBC289880E8D77/updlist/34/eid/8576/lid/8576">http://i5.c.eset.com/v1/auth/60064ADBC289880E8D77/updlist/34/eid/8576/lid/8576</A> 
</I>&gt;<i> - DIRECT/91.228.166.45 application/octet-stream
</I>&gt;<i> 1658491430.227&#160;&#160;&#160; 235 172.19.15.144 TCP_MISS/200 3793 CONNECT 
</I>&gt;<i> ts.eset.com:443 - DIRECT/91.228.166.148 -
</I>&gt;<i> 1658491430.276&#160;&#160;&#160;&#160; 73 172.19.15.72 TCP_MISS/200 473 GET 
</I>&gt;<i> <A HREF="http://i5.c.eset.com/v1/auth/60064ADBC289880E8D77/updlist/33/eid/10185/lid/10185">http://i5.c.eset.com/v1/auth/60064ADBC289880E8D77/updlist/33/eid/10185/lid/10185</A> 
</I>&gt;<i> - DIRECT/91.228.166.45 application/octet-stream
</I>&gt;<i> 1658491430.404&#160;&#160;&#160;&#160; 90 172.19.14.191 TCP_MISS/200 473 GET 
</I>&gt;<i> <A HREF="http://i5.c.eset.com/v1/auth/60064ADBC289880E8D77/updlist/35/eid/7351/lid/7351">http://i5.c.eset.com/v1/auth/60064ADBC289880E8D77/updlist/35/eid/7351/lid/7351</A> 
</I>&gt;<i> - DIRECT/91.228.166.45 application/octet-stream
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Now I am out of ideas what to test.
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="025004.html">[squid-users] slow TCP_TUNNEL
</A></li>
	<LI>Next message (by thread): <A HREF="025012.html">[squid-users] slow TCP_TUNNEL
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25005">[ date ]</a>
              <a href="thread.html#25005">[ thread ]</a>
              <a href="subject.html#25005">[ subject ]</a>
              <a href="author.html#25005">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
