<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Fwd: Sqid uses all RAM / killed by OOM
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Fwd%3A%20Sqid%20uses%20all%20RAM%20/%20killed%20by%20OOM&In-Reply-To=%3Cdc32d5cd-99af-a8c4-7262-a7e4a8ee1bf1%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="025009.html">
   <LINK REL="Next"  HREF="025011.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Fwd: Sqid uses all RAM / killed by OOM</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Fwd%3A%20Sqid%20uses%20all%20RAM%20/%20killed%20by%20OOM&In-Reply-To=%3Cdc32d5cd-99af-a8c4-7262-a7e4a8ee1bf1%40measurement-factory.com%3E"
       TITLE="[squid-users] Fwd: Sqid uses all RAM / killed by OOM">rousskov at measurement-factory.com
       </A><BR>
    <I>Mon Jul 25 21:18:17 UTC 2022</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="025009.html">[squid-users] Fwd: Sqid uses all RAM / killed by OOM
</A></li>
        <LI>Next message (by thread): <A HREF="025011.html">[squid-users] Fwd: Sqid uses all RAM / killed by OOM
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25010">[ date ]</a>
              <a href="thread.html#25010">[ thread ]</a>
              <a href="subject.html#25010">[ subject ]</a>
              <a href="author.html#25010">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 7/25/22 16:33, <A HREF="https://lists.squid-cache.org/listinfo/squid-users">ngtech1ltd at gmail.com</A> wrote:

&gt;<i> Ronny was trying to use 5.2 on Ubuntu 22.04 as an upgrade from 20.04.
</I>&gt;<i> The issue was that probably for the same traffic on 20.04 with another version of squid
</I>&gt;<i> it consumed a lot of RAM.
</I>
&gt;<i> My first suggestion was to upgrade into latest 5.6 but since 22.04 uses OpenSSL 3.x Squid 5.6
</I>&gt;<i> would not compile on it.
</I>
I suspect Squid will compile just fine, just not with the default build 
options and/or default OpenSSL install:

* If the default install of OpenSSL on 22.04 still provides deprecated 
OpenSSL v1 APIs, then it may be possible to build Squid with that by 
telling the compiler not to treat warnings as errors (i.e. remove 
-Werror from CXXFLAGS).

* Otherwise, it is not very difficult to install any modern OpenSSL 
version from OpenSSL sources and build Squid with that.


&gt;<i> The referenced patch is for OpenSSL 3.x compatibility and not a memory leak.
</I>
Thank you for clarifying that. If there is a high quality patch that 
adds OpenSSL v3 support to Squid v5, then it is fine to use that patch 
as a short-term workaround, of course. I do not have such a patch.


&gt;<i> What I didn't understood is first: how can 4.17 can be compiled on 22.04
</I>
I do not know the answer, but perhaps Squid v4.17 does not enable some 
of the warnings that v5 does?


&gt;<i> and if it compiles is there still some memory leak?
</I>
I doubt OpenSSL upgrade can stop a serious memory leak, but it is not 
impossible. Some leak-sensitive code was modified/improved when adding 
support to OpenSSL v3.

Alex.



&gt;<i> I believe it's too soon to upgrade into 22.04 and I would suggest to use another OS for now.
</I>&gt;<i> From what I have seen Ubuntu doesn't have more support than other OS for now so..
</I>&gt;<i> 
</I>&gt;<i> The only thing I can offer is to use some RPM based OS which can use my packages.
</I>&gt;<i> 
</I>&gt;<i> Eliezer
</I>&gt;<i> 
</I>&gt;<i> ----
</I>&gt;<i> Eliezer Croitoru
</I>&gt;<i> NgTech, Tech Support
</I>&gt;<i> Mobile: +972-5-28704261
</I>&gt;<i> Email: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">ngtech1ltd at gmail.com</A>
</I>&gt;<i> Web: <A HREF="https://ngtech.co.il/">https://ngtech.co.il/</A>
</I>&gt;<i> My-Tube: <A HREF="https://tube.ngtech.co.il/">https://tube.ngtech.co.il/</A>
</I>&gt;<i> 
</I>&gt;<i> -----Original Message-----
</I>&gt;<i> From: squid-users &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>&gt; On Behalf Of Alex Rousskov
</I>&gt;<i> Sent: Monday, 25 July 2022 23:05
</I>&gt;<i> To: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> Subject: Re: [squid-users] Fwd: Sqid uses all RAM / killed by OOM
</I>&gt;<i> 
</I>&gt;<i> On 7/25/22 01:59, Ronny Preiss wrote:
</I>&gt;<i> 
</I>&gt;&gt;<i> Can someone support me regarding my question about compiling squid 5.6
</I>&gt;&gt;<i> on ubuntu 22.04?
</I>&gt;<i> 
</I>&gt;<i> There is probably some misunderstanding: You are expecting some kind of
</I>&gt;<i> a patch for Squid v5.6, but I do not know what patch you are talking
</I>&gt;<i> about. I am aware of one important bug fix that was added to Squid v5
</I>&gt;<i> after v5.6 release[1], but that fix is not targeting any memory leaks
</I>&gt;<i> (it may still fix some as a side effect though).
</I>&gt;<i> 
</I>&gt;<i> I also do not recall any known memory leaks in v5.6, but perhaps I have
</I>&gt;<i> forgotten something we fixed in master/v6 long time ago -- until [1], it
</I>&gt;<i> was not possible to run v5 in production deployments I dealt with, so I
</I>&gt;<i> can easily forget or miss some old v5 details.
</I>&gt;<i> 
</I>&gt;<i> If you believe that your Squid v5.6 is leaking memory, try [1]. If that
</I>&gt;<i> does not help, you may need to create a bug report on Bugzilla and start
</I>&gt;<i> collecting the necessary details to confirm the leak and identify what
</I>&gt;<i> is leaking.
</I>&gt;<i> 
</I>&gt;<i> [1] <A HREF="https://github.com/squid-cache/squid/commit/c999621.diff">https://github.com/squid-cache/squid/commit/c999621.diff</A>
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> HTH,
</I>&gt;<i> 
</I>&gt;<i> Alex.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> Since my previous attempts also have the &quot;memory leak&quot; on ubuntu 22.04
</I>&gt;&gt;<i> and squid 5.6 problem again.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Kind regards Ronny
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> ---------- Forwarded message ---------
</I>&gt;&gt;<i> Von: *Ronny Preiss* &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">ronny.preiss at gmail.com</A> &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">ronny.preiss at gmail.com</A>&gt;&gt;
</I>&gt;&gt;<i> Date: Mo., 11. Juli 2022 um 08:54 Uhr
</I>&gt;&gt;<i> Subject: Sqid uses all RAM / killed by OOM
</I>&gt;&gt;<i> To: &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;&gt;<i> &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>&gt;&gt;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Hello all,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I have the following problem with squid 5.2 on ubuntu 22.04.
</I>&gt;&gt;<i> Squid consumes all ram and the entire SWAP. When swap and ram are
</I>&gt;&gt;<i> completely full, the OOM killer strikes and terminates the process.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> We use three internal child proxy servers with keepalived and haproxy as
</I>&gt;&gt;<i> load balancers. From our ISP we use a parent upstream proxy for external
</I>&gt;&gt;<i> internet traffic.
</I>&gt;&gt;<i> As an operating system we have so far Ubuntu 20.04.4 with squid 4.1 in
</I>&gt;&gt;<i> use. This constellation works flawlessly.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Now I want to update the Server to Ubuntu 22.04 and squid 5.2. But with
</I>&gt;&gt;<i> Ubuntu 22.04 and squid 5.2 the above mentioned problem with the OOM
</I>&gt;&gt;<i> Killer occurs.
</I>&gt;&gt;<i> The new machine has only the OS and squid installed.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Who can help me with a solution?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> With kind regards
</I>&gt;&gt;<i> Ronny
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Attached the squid configuration and the VMWare specs.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> ### VM Specs ###
</I>&gt;&gt;<i> OS: Ubuntu 22.04 Server
</I>&gt;&gt;<i> CPU: 4x (Intel(R) Xeon(R) CPU E5-2690 v3 @ 2.60GHz)
</I>&gt;&gt;<i> RAM: 4 GB
</I>&gt;&gt;<i> VMWare: ESXi 7.0 U2
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> ### CONFIG ###
</I>&gt;&gt;<i> acl 10.172.xxx.xxx/18 &lt;<A HREF="http://10.172.128.0/18">http://10.172.128.0/18</A>&gt; src 10.172.xxx.xxx/18
</I>&gt;&gt;<i> &lt;<A HREF="http://10.172.128.0/18">http://10.172.128.0/18</A>&gt;
</I>&gt;&gt;<i> acl 172.16.xxx.xxx/12 &lt;<A HREF="http://172.16.0.0/12">http://172.16.0.0/12</A>&gt; src 172.16.xxx.xxx/12
</I>&gt;&gt;<i> &lt;<A HREF="http://172.16.0.0/12">http://172.16.0.0/12</A>&gt;
</I>&gt;&gt;<i> acl 192.168.xxx.xxx/16 &lt;<A HREF="http://192.168.0.0/16">http://192.168.0.0/16</A>&gt; src 192.168.xxx.xxx/16
</I>&gt;&gt;<i> &lt;<A HREF="http://192.168.0.0/16">http://192.168.0.0/16</A>&gt;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> acl Safe_ports port 80
</I>&gt;&gt;<i> acl Safe_ports port 21
</I>&gt;&gt;<i> acl Safe_ports port 443
</I>&gt;&gt;<i> acl Safe_ports port 70
</I>&gt;&gt;<i> acl Safe_ports port 210
</I>&gt;&gt;<i> acl Safe_ports port 1025-65535
</I>&gt;&gt;<i> acl Safe_ports port 280
</I>&gt;&gt;<i> acl Safe_ports port 488
</I>&gt;&gt;<i> acl Safe_ports port 591
</I>&gt;&gt;<i> acl Safe_ports port 777
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> http_access allow 10.172.xxx.xxx/18 &lt;<A HREF="http://10.172.128.0/18">http://10.172.128.0/18</A>&gt; Safe_ports
</I>&gt;&gt;<i> http_access allow 172.16.xxx.xxx/12 &lt;<A HREF="http://172.16.0.0/12">http://172.16.0.0/12</A>&gt; Safe_ports
</I>&gt;&gt;<i> http_access allow 192.168.xxx.xxx/16 &lt;<A HREF="http://192.168.0.0/16">http://192.168.0.0/16</A>&gt; Safe_ports
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> http_access allow localhost manager
</I>&gt;&gt;<i> http_access allow localhost
</I>&gt;&gt;<i> http_access deny manager
</I>&gt;&gt;<i> http_access deny all
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> include /etc/squid/conf.d/*
</I>&gt;&gt;<i> http_port 10.172.xxx.xxx:3128 &lt;<A HREF="http://10.172.128.34:3128">http://10.172.128.34:3128</A>&gt;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> cache_peer 10.210.xxx.xxx parent 8080 0
</I>&gt;&gt;<i> cache_dir ufs /var/spool/squid 3000 16 256
</I>&gt;&gt;<i> cache_effective_user proxy
</I>&gt;&gt;<i> cache_effective_group proxy
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> coredump_dir /var/spool/squid
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> refresh_pattern ^ftp:           1440    20%     10080
</I>&gt;&gt;<i> refresh_pattern ^gopher:        1440    0%      1440
</I>&gt;&gt;<i> refresh_pattern -i (/cgi-bin/|\?) 0     0%      0
</I>&gt;&gt;<i> refresh_pattern \/(Packages|Sources)(|\.bz2|\.gz|\.xz)$ 0 0% 0 refresh-ims
</I>&gt;&gt;<i> refresh_pattern \/Release(|\.gpg)$ 0 0% 0 refresh-ims
</I>&gt;&gt;<i> refresh_pattern \/InRelease$ 0 0% 0 refresh-ims
</I>&gt;&gt;<i> refresh_pattern \/(Translation-.*)(|\.bz2|\.gz|\.xz)$ 0 0% 0 refresh-ims
</I>&gt;&gt;<i> refresh_pattern .               0       20%     4320
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> never_direct allow all
</I>&gt;&gt;<i> max_filedescriptors 40960
</I>&gt;&gt;<i> dns_nameservers 10.244.xxx.xxx
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> ### DMESG ###
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> [256929.150801]
</I>&gt;&gt;<i> oom-kill:constraint=CONSTRAINT_NONE,nodemask=(null),cpuset=/,mems_allowed=0,global_oom,task_memcg=/system.slice/squid.service,task=squid,pid=26390,uid=13
</I>&gt;&gt;<i> [256929.150822] Out of memory: Killed process 26390 (squid)
</I>&gt;&gt;<i> total-vm:9691764kB, anon-rss:3657748kB, file-rss:2320kB, shmem-rss:0kB,
</I>&gt;&gt;<i> UID:13 pgtables:18932kB oom_score_adj:0
</I>&gt;&gt;<i> [256929.510641] oom_reaper: reaped process 26390 (squid), now
</I>&gt;&gt;<i> anon-rss:0kB, file-rss:0kB, shmem-rss:0kB
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;<i> squid-users mailing list
</I>&gt;&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="025009.html">[squid-users] Fwd: Sqid uses all RAM / killed by OOM
</A></li>
	<LI>Next message (by thread): <A HREF="025011.html">[squid-users] Fwd: Sqid uses all RAM / killed by OOM
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25010">[ date ]</a>
              <a href="thread.html#25010">[ thread ]</a>
              <a href="subject.html#25010">[ subject ]</a>
              <a href="author.html#25010">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
