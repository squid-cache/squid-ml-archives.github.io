<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] slow TCP_TUNNEL [SOLVED]
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20slow%20TCP_TUNNEL%20%5BSOLVED%5D&In-Reply-To=%3C62E0E7AB0200005F0004E94A%40gwia.plbohnice.cz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="025012.html">
   <LINK REL="Next"  HREF="025026.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] slow TCP_TUNNEL [SOLVED]</H1>
    <B>Katerina Bubenickova</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20slow%20TCP_TUNNEL%20%5BSOLVED%5D&In-Reply-To=%3C62E0E7AB0200005F0004E94A%40gwia.plbohnice.cz%3E"
       TITLE="[squid-users] slow TCP_TUNNEL [SOLVED]">Katerina.Bubenickova at bohnice.cz
       </A><BR>
    <I>Wed Jul 27 07:22:19 UTC 2022</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="025012.html">[squid-users] slow TCP_TUNNEL
</A></li>
        <LI>Next message (by thread): <A HREF="025026.html">[squid-users] slow TCP_TUNNEL [SOLVED]
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25015">[ date ]</a>
              <a href="thread.html#25015">[ thread ]</a>
              <a href="subject.html#25015">[ subject ]</a>
              <a href="author.html#25015">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hey Eliezer,


Thank you. Now I am ashamed for I have sent unintentionally [solved]
answer only to Alex yesterday.


I tried wireshark, disabled client persistent connections.
but the problem was system run out of filedescriptors.
4096 was not enough . I didn't notice it in the cache.log before


So I put into 

/etc/security/limits.conf


line 

* - nofile 65535




and into squid.conf:

max_filedescriptors 65535


systemctl restart squid

Now it is working all right.

Thank you for your effort,
now see I have a lot to learn.

I have to figure out the difference between  forward and intercept
proxy,
what the pinger daemon is and what workers are.


Two proxies makes faster performance for us, 

On Debian 11 there is version Version 4.13
load balance is done by bind - two IPs have the name in A record

I will remove the  `dns_v4_first` 


Thank you all again for your support,


Katerina













&gt;&gt;&gt;<i> &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">ngtech1ltd at gmail.com</A>&gt; 07/26/22 9:40 PM &gt;&gt;&gt;
</I>Hey Katerina,

Let&#8217;s try to understand the issue first.
The CentOS 6 squid version is what exactly? (squid -v )
What do you require from this proxy to do else then squidguard?
&gt;<i>From what I understand it&#8217;s a simple forward proxy and not an intercept
</I>proxy.
It means that all DNS resolution is done on the proxy.
What localhost DNS daemon are you using? (Bind? unbound? other?)
What version of Squid are you running on the Debian 11 machine (squid
-v)

The `dns_v4_first` configuration is obsolete.
The first thing to check is that if the pinger is up and running.
&gt;<i>From what I remember Debian didn&#8217;t liked the pinger daemon.
</I>Are you using workers in your configuration?
If you can share your current squid version and squid.conf we might be
able to help you try to understand what&#8217;s going on.
The latest version of squid I have published for CentOS 6 was:
squid-3.5.28-1.el6.x86_64.rpm

For a simple forward proxy you won&#8217;t need too much hardware but if you
won&#8217;t be using workers this would be the expected behavior.
I believe that if you do not require special configurations we can
compare another simple forward proxy just to make sure that
the core of the issue is something with squid.
(it&#8217;s possible to find the issue without using a comparison if enough
details would be published)

How exactly is the proxy configured on the clients side?
Also is there any form of authentication happening or plain connections?
How do you load balance between the proxies?

&gt;<i>From my experience 700 clients are OK on a single proxy however&#8230;
</I>only if the load is not too high in the network level.
It can be that the maximum limit of open file descriptors is reached or
couple other reasons.
Can you share couple pages of your cache manager output?
The next script:
<A HREF="https://gist.githubusercontent.com/elico/8790bdc835d8e9ecbc57e72fc31effc0/raw/60d140b0e772fa4f418779bfc27e4804a345ce23/dump-cache-mgr-to-file.sh">https://gist.githubusercontent.com/elico/8790bdc835d8e9ecbc57e72fc31effc0/raw/60d140b0e772fa4f418779bfc27e4804a345ce23/dump-cache-mgr-to-file.sh</A>

should dump all pages to stdout but don&#8217;t send the output on the public
list please.
I will try to analyze the pages and see if there is something specific I
can understand from them.
If the above output would not be sufficient I have another more in-depth
script that should help us
to understand what is the core issue with this VM.

I am waiting for more details so I would be able to try and help you.

Eliezer

----
Eliezer Croitoru
NgTech, Tech Support
Mobile: +972-5-28704261
Email: mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">ngtech1ltd at gmail.com</A>
Web: <A HREF="https://ngtech.co.il/">https://ngtech.co.il/</A>
My-Tube: <A HREF="https://tube.ngtech.co.il/">https://tube.ngtech.co.il/</A>

From: squid-users &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>&gt; On Behalf
Of Katerina Bubenickova
Sent: Monday, 25 July 2022 11:40
To: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
Subject: [squid-users] slow TCP_TUNNEL

Hi,
We have 2 squid proxies running on Centos 6 which is very old (let's
call them C1, C2) in DMZ.

I have installed Debian 11 bullseye and squid +squidguard, trying to use
the same configuration (let's call it D1).
If I use this proxy for 1 pc station, all is ok.
If Iadded the proxy toI tryed to fix it without success:
I added directive url_rewrite_children 200
I changed DNS from 8.8.8.8 to localhost
I turned off squid cache
I commented out squidguard
I migrated from one vmware server to another, better,
I added memory (16 GB) and CPU (6) ,
I added directive dns_v4_first on
There are no rules in D1 firewall

We have about 700 pc and the problem starts after 15-20 minutes after I
add D1 into dns as proxy.
I can see it on our monitor Flowmon, where I can see value NPM response
time. In normal state it is about 0.1s, when the problem arises it is up
to 3s.
If I remove D1 from dns, all is ok after a while.

I  tried to set IP of D1 the same as IP of C2 (of course C2 was power
off) to test, whether the problem could be caused by some firewall
between user pc and proxy, it doesn.t help


access.log of D1
1658483765.546 1622444 172.19.11.101 TCP_TUNNEL/200 3635 CONNECT
epns.eset.com:443 - HIER_DIRECT/91.228.167.192 -
1658483765.546 900188 172.19.14.73 TCP_TUNNEL/200 4738 CONNECT
prg.smartadserver.com:443 - HIER_DIRECT/185.86.138.16 -
1658483765.546 900246 172.19.14.73 TCP_TUNNEL/200 4102 CONNECT
bidder.criteo.com:443 - HIER_DIRECT/178.250.0.165 -
1658483765.546 1008081 172.19.13.171 TCP_TUNNEL/200 12749428 CONNECT
rr1---sn-jxnoxu-2gbl.googlevideo.com:443 - HIER_DIRECT/195.113.214.204 -
1658483765.546 901791 172.19.14.95 TCP_TUNNEL/200 2176 CONNECT
pcb.kb.cz:443 - HIER_DIRECT/194.50.226.158 -
1658483765.546 900569 172.19.14.73 TCP_TUNNEL/200 7260 CONNECT
adx.adform.net:443 - HIER_DIRECT/37.157.2.237 -
1658483766.547 935767 172.19.13.190 TCP_TUNNEL/200 110961 CONNECT
<A HREF="http://www.seznam.cz:443">http://www.seznam.cz:443</A> - HIER_DIRECT/77.75.77.222 -
1658483766.547 1620846 172.19.15.40 TCP_TUNNEL/200 3520 CONNECT
epns.eset.com:443 - HIER_DIRECT/91.228.167.192 -
1658483766.547 900183 172.19.14.73 TCP_TUNNEL/200 4296 CONNECT
etarget-emea.adnxs.com:443 - HIER_DIRECT/37.252.173.214 -
1658483767.548 1028965 172.19.15.2 TCP_TUNNEL/200 20796 CONNECT
<A HREF="http://www.seznam.cz:443">http://www.seznam.cz:443</A> - HIER_DIRECT/77.75.79.222 -
1658483767.548 959986 172.19.15.199 TCP_TUNNEL/200 7269 CONNECT
fonts.googleapis.com:443 - HIER_DIRECT/142.251.36.106 -
1658483767.548 900027 172.19.14.73 TCP_TUNNEL/200 10544 CONNECT
fastlane.rubiconproject.com:443 - HIER_DIRECT/69.173.144.141 -
1658483768.549 1625800 172.19.14.204 TCP_TUNNEL/200 3635 CONNECT
epns.eset.com:443 - HIER_DIRECT/91.228.167.192 -
1658483768.549 903754 172.19.14.73 TCP_TUNNEL/200 5891 CONNECT
region1.google-analytics.com:443 - HIER_DIRECT/216.239.34.36 -
1658483769.551 1017091 172.19.14.19 TCP_TUNNEL/200 4702 CONNECT
secure-it.imrworldwide.com:443 - HIER_DIRECT/54.246.16.130 -
1658483769.551 976878 172.19.14.69 TCP_TUNNEL/200 1120200 CONNECT
rr2---sn-jxnoxu-2gbl.googlevideo.com:443 - HIER_DIRECT/195.113.214.205 -
1658483769.551 1626332 172.19.15.189 TCP_TUNNEL/200 3635 CONNECT
epns.eset.com:443 - HIER_DIRECT/91.228.167.192 -
1658483769.551 986881 172.19.14.69 TCP_TUNNEL/200 11983552 CONNECT
rr5---sn-2gb7sn7r.googlevideo.com:443 - HIER_DIRECT/172.217.130.74 -

in access.log of C1 are the time numbers a lot lower:

1658491430.020      7 172.19.14.191 TCP_MISS/200 473 GET
<A HREF="http://i5.c.eset.com/v1/auth/60064ADBC289880E8D77/updlist/31/eid/108/lid/108">http://i5.c.eset.com/v1/auth/60064ADBC289880E8D77/updlist/31/eid/108/lid/108</A>
- DIRECT/91.228.166.45 application/octet-stream
1658491430.025      6 172.19.15.72 TCP_MISS/200 473 GET
<A HREF="http://i5.c.eset.com/v1/auth/60064ADBC289880E8D77/updlist/31/eid/108/lid/108">http://i5.c.eset.com/v1/auth/60064ADBC289880E8D77/updlist/31/eid/108/lid/108</A>
- DIRECT/91.228.166.45 application/octet-stream
1658491430.031      6 172.19.14.191 TCP_MISS/200 473 GET
<A HREF="http://i5.c.eset.com/v1/auth/60064ADBC289880E8D77/updlist/32/eid/117876/lid/117876">http://i5.c.eset.com/v1/auth/60064ADBC289880E8D77/updlist/32/eid/117876/lid/117876</A>
- DIRECT/91.228.166.45 application/octet-stream
1658491430.038    430 172.19.14.71 TCP_MISS/200 4906 CONNECT
v10.events.data.microsoft.com:443 - DIRECT/20.42.65.90 -
1658491430.076     40 172.19.14.191 TCP_MISS/200 473 GET
<A HREF="http://i5.c.eset.com/v1/auth/60064ADBC289880E8D77/updlist/33/eid/10185/lid/10185">http://i5.c.eset.com/v1/auth/60064ADBC289880E8D77/updlist/33/eid/10185/lid/10185</A>
- DIRECT/91.228.166.45 application/octet-stream
1658491430.112     55 172.19.15.72 TCP_MISS/200 473 GET
<A HREF="http://i5.c.eset.com/v1/auth/60064ADB-">http://i5.c.eset.com/v1/auth/60064ADB-</A> DIRECT/91.228.166.45 application/octet-stream
1658491430.155  30017 172.19.14.186 TCP_MISS/200 62553 CONNECT
armmf.adobe.com:443 - DIRECT/2.23.8.158 -
1658491430.180     43 172.19.14.191 TCP_MISS/200 473 GET
<A HREF="http://i5.c.eset.com/v1/auth/60064ADBC289880E8D77/updlist/34/eid/8576/lid/8576">http://i5.c.eset.com/v1/auth/60064ADBC289880E8D77/updlist/34/eid/8576/lid/8576</A>
- DIRECT/91.228.166.45 application/octet-stream
Tato e-mailov&#225; zpr&#225;va m&#225; pouze informativn&#237; charakter a vych&#225;z&#237; z 
podklad&#367;, kter&#233; byly odes&#237;lateli p&#345;ed&#225;ny nebo zasl&#225;ny v minulosti. Obsah
 t&#233;to e-mailov&#233; zpr&#225;vy, resp. jak&#233;koliv p&#345;&#237;padn&#233; pr&#225;vn&#237; jedn&#225;n&#237; 
vypl&#253;vaj&#237;c&#237; z t&#233;to e-mailov&#233; zpr&#225;vy, se nepova&#382;uje za n&#225;vrh na uzav&#345;en&#237; 
smlouvy ve smyslu ustanoven&#237; &#167; 1731 z&#225;kona &#269;. 89/2012 Sb., ob&#269;ansk&#233;ho 
z&#225;kon&#237;ku, v platn&#233;m zn&#283;n&#237; (d&#225;le jen &#8222;ob&#269;ansk&#253; z&#225;kon&#237;k&#8220;) nebo akceptaci 
n&#225;vrhu na uzav&#345;en&#237; smlouvy ve smyslu &#167; 1740 ob&#269;ansk&#233;ho z&#225;kon&#237;ku, pop&#345;. 
potvrzen&#237; uzav&#345;en&#237; smluvn&#237;ho vztahu, nen&#237;-li odes&#237;latelem uvedeno 
v&#253;slovn&#283; jinak. Tato e-mailov&#225; zpr&#225;va je ur&#269;ena pouze pro osobn&#237; a 
d&#367;v&#283;rn&#233; u&#382;it&#237; ur&#269;en&#253;mi adres&#225;ty, tedy osobou (osobami), kter&#233; (kter&#253;m) 
je obsahov&#283; ur&#269;ena. Nejste-li osobou, kter&#233; je tato zpr&#225;va ur&#269;ena, 
upozor&#328;ujeme V&#225;s, &#382;e jak&#233;koliv &#353;&#237;&#345;en&#237; &#269;i kop&#237;rov&#225;n&#237; t&#233;to e-mailov&#233; 
zpr&#225;vy, &#269;i informace z n&#237;, je zak&#225;z&#225;no. Jestli&#382;e tuto e-mailovou zpr&#225;vu 
obdr&#382;&#237;te nedopat&#345;en&#237;m, pros&#237;me, oznamte tuto skute&#269;nost odes&#237;lateli a 
odstra&#328;te zpr&#225;vu samotnou i v&#353;echny jej&#237; p&#345;&#237;lohy ze sv&#233;ho syst&#233;mu. 

1658491430.227    235 172.19.15.144 TCP_MISS/200 3793 CONNECT
ts.eset.com:443 - DIRECT/91.228.166.148 -
1658491430.276     73 172.19.15.72 TCP_MISS/200 473 GET
<A HREF="http://i5.c.eset.com/v1/auth/60064ADBC289880E8D77/updlist/33/eid/10185/lid/10185">http://i5.c.eset.com/v1/auth/60064ADBC289880E8D77/updlist/33/eid/10185/lid/10185</A>
- DIRECT/91.228.166.45 application/octet-stream
1658491430.404     90 172.19.14.191 TCP_MISS/200 473 GET
<A HREF="http://i5.c.eset.com/v1/auth/60064ADBC289880E8D77/updlist/35/eid/7351/lid/7351">http://i5.c.eset.com/v1/auth/60064ADBC289880E8D77/updlist/35/eid/7351/lid/7351</A>
- DIRECT/91.228.166.45 application/octet-stream


Now I am out of ideas what to test.

Thank you very much for your help,
Katerina





}



Tato e-mailov&#225; zpr&#225;va m&#225; pouze informativn&#237; charakter a vych&#225;z&#237; z
podklad&#367;, kter&#233; byly odes&#237;lateli p&#345;ed&#225;ny nebo zasl&#225;ny v minulosti. Obsah
t&#233;to e-mailov&#233; zpr&#225;vy, resp. jak&#233;koliv p&#345;&#237;padn&#233; pr&#225;vn&#237; jedn&#225;n&#237;
vypl&#253;vaj&#237;c&#237; z t&#233;to e-mailov&#233; zpr&#225;vy, se nepova&#382;uje za n&#225;vrh na
uzav&#345;en&#237; smlouvy ve smyslu ustanoven&#237; &#167; 1731 z&#225;kona &#269;. 89/2012 Sb.,
ob&#269;ansk&#233;ho z&#225;kon&#237;ku, v platn&#233;m zn&#283;n&#237; (d&#225;le jen &#8222;ob&#269;ansk&#253; z&#225;kon&#237;k&#8220;)
nebo akceptaci n&#225;vrhu na uzav&#345;en&#237; smlouvy ve smyslu &#167; 1740 ob&#269;ansk&#233;ho
z&#225;kon&#237;ku, pop&#345;. potvrzen&#237; uzav&#345;en&#237; smluvn&#237;ho vztahu, nen&#237;-li
odes&#237;latelem uvedeno v&#253;slovn&#283; jinak. Tato e-mailov&#225; zpr&#225;va je ur&#269;ena
pouze pro osobn&#237; a d&#367;v&#283;rn&#233; u&#382;it&#237; ur&#269;en&#253;mi adres&#225;ty, tedy osobou
(osobami), kter&#233; (kter&#253;m) je obsahov&#283; ur&#269;ena. Nejste-li osobou, kter&#233; je
tato zpr&#225;va ur&#269;ena, upozor&#328;ujeme V&#225;s, &#382;e jak&#233;koliv &#353;&#237;&#345;en&#237; &#269;i kop&#237;rov&#225;n&#237;
t&#233;to e-mailov&#233; zpr&#225;vy, &#269;i informace z n&#237;, je zak&#225;z&#225;no. Jestli&#382;e tuto
e-mailovou zpr&#225;vu obdr&#382;&#237;te nedopat&#345;en&#237;m, pros&#237;me, oznamte tuto
skute&#269;nost odes&#237;lateli a odstra&#328;te zpr&#225;vu samotnou i v&#353;echny jej&#237;
p&#345;&#237;lohy ze sv&#233;ho syst&#233;mu.


-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20220727/b10ebe84/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20220727/b10ebe84/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="025012.html">[squid-users] slow TCP_TUNNEL
</A></li>
	<LI>Next message (by thread): <A HREF="025026.html">[squid-users] slow TCP_TUNNEL [SOLVED]
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25015">[ date ]</a>
              <a href="thread.html#25015">[ thread ]</a>
              <a href="subject.html#25015">[ subject ]</a>
              <a href="author.html#25015">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
