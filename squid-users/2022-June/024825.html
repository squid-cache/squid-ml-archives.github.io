<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Scaling concurrent TCP sessions beyond ephemeral port range
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Scaling%20concurrent%20TCP%20sessions%20beyond%20ephemeral%0A%20port%20range&In-Reply-To=%3CCACabJxPPwF1ZpGbhU2zXnzcEKkvt1Jej7aygzSxYXTEOfTEX%3Dw%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="024824.html">
   <LINK REL="Next"  HREF="024901.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Scaling concurrent TCP sessions beyond ephemeral port range</H1>
    <B>Praveen Ponakanti</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Scaling%20concurrent%20TCP%20sessions%20beyond%20ephemeral%0A%20port%20range&In-Reply-To=%3CCACabJxPPwF1ZpGbhU2zXnzcEKkvt1Jej7aygzSxYXTEOfTEX%3Dw%40mail.gmail.com%3E"
       TITLE="[squid-users] Scaling concurrent TCP sessions beyond ephemeral port range">pponakanti at roblox.com
       </A><BR>
    <I>Wed Jun  1 21:31:46 UTC 2022</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="024824.html">[squid-users] squid only partially working WHY ?
</A></li>
        <LI>Next message (by thread): <A HREF="024901.html">[squid-users] Scaling concurrent TCP sessions beyond ephemeral port range
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24825">[ date ]</a>
              <a href="thread.html#24825">[ thread ]</a>
              <a href="subject.html#24825">[ subject ]</a>
              <a href="author.html#24825">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

We have patched in a small code diff to add the IP_BIND_ADDRESS_NO_PORT
sockopt flag and it has been working fine as we can see outbound TCP ports
being reused with different destination IP addresses.

Have some followup questions.
A lot of the client requests in our setup go to a small set of destination
webservers ( &lt; 10), so we still run the risk of running out of ports for
concurrent connections to a single destination webserver. We have not
enabled the squid for caching and run multiple instances each with 30
workers.
- Is there some config knob available to have squid efficiently reuse
outbound connections across multiple client requests? It appears that each
client's request creates a separate TCP connection to the dest webserver
even if they are the same. This happens for both HTTP and HTTPS. How do we
enable connection pooling if that is available with squid?
- If this is something that isn't supported with v5.5, do you
recommend investigating code modifications to allow the reuse of outbound
connections? Any suggestions or gotchas before we go about this approach?

We have looked into the multiple tcp_oubound_adress option but would prefer
not to go that route.

Thanks
Praveen


On Fri, May 20, 2022 at 9:31 PM Amos Jeffries &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt; wrote:

&gt;<i> On 20/05/22 19:44, Praveen Ponakanti wrote:
</I>&gt;<i> &gt; Hi Alex,
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Thanks for going through several steps to help mitigate src port
</I>&gt;<i> &gt; exhaustion. We are looking to achieve 400-500% more
</I>&gt;<i> &gt; concurrent connections if we could :) as there is a significant buffer
</I>&gt;<i> &gt; on the available CPU.
</I>&gt;<i>
</I>&gt;<i> Then you require at least 4, maybe 5, IP addresses to handle that many
</I>&gt;<i> concurrent connections with Squid.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; The option to use multiple tcp_outoing_addresses appears to be promising
</I>&gt;<i> &gt; along with some tweaks to the TCP timeouts. I guess we could use ACLs to
</I>&gt;<i> &gt; pick a different outbound IP based on the requesting client's prefix. We
</I>&gt;<i> &gt; had not considered that option as the ephemeral ports were no longer
</I>&gt;<i> &gt; available to other applications when squid uses most of them with a
</I>&gt;<i> &gt; single outbound IP configured. We are also looking to modify the code to
</I>&gt;<i> &gt; use the IP_BIND_ADDRESS_NO_PORT sockopt as that could help delay port
</I>&gt;<i> &gt; assignment with the bind() call on the outbound TCP sessions (to
</I>&gt;<i> &gt; hopefully allow access to the 4-tuple on the socket).
</I>&gt;<i>
</I>&gt;<i> Patches welcome.
</I>&gt;<i>
</I>&gt;<i> However, please be aware that use of the 4-tuple is often no different
</I>&gt;<i> from the 3-tuple since the dst-port is typically identical for all
</I>&gt;<i> outgoing traffic to a given dst-IP.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Cheers
</I>&gt;<i> Amos
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20220601/af8988c8/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20220601/af8988c8/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="024824.html">[squid-users] squid only partially working WHY ?
</A></li>
	<LI>Next message (by thread): <A HREF="024901.html">[squid-users] Scaling concurrent TCP sessions beyond ephemeral port range
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24825">[ date ]</a>
              <a href="thread.html#24825">[ thread ]</a>
              <a href="subject.html#24825">[ subject ]</a>
              <a href="author.html#24825">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
