<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Reloading squid service results in connection resets
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Reloading%20squid%20service%20results%20in%20connection%20resets&In-Reply-To=%3CDS7PR06MB6789C5AD65B4455DD7E9B228E9AB9%40DS7PR06MB6789.namprd06.prod.outlook.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="024833.html">
   <LINK REL="Next"  HREF="024832.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Reloading squid service results in connection resets</H1>
    <B>Toler, Matt</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Reloading%20squid%20service%20results%20in%20connection%20resets&In-Reply-To=%3CDS7PR06MB6789C5AD65B4455DD7E9B228E9AB9%40DS7PR06MB6789.namprd06.prod.outlook.com%3E"
       TITLE="[squid-users] Reloading squid service results in connection resets">Matt.Toler at netapp.com
       </A><BR>
    <I>Mon Jun 13 22:35:51 UTC 2022</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="024833.html">[squid-users] sftp through Squid: sftp error with proxy: command-line line 0 bad protocol 2 host key algorithms +ssh-dss
</A></li>
        <LI>Next message (by thread): <A HREF="024832.html">[squid-users] Reloading squid service results in connection resets
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24831">[ date ]</a>
              <a href="thread.html#24831">[ thread ]</a>
              <a href="subject.html#24831">[ subject ]</a>
              <a href="author.html#24831">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello!

I hope you all are well. We've run into a troublesome issue and hope to get some guidance.

We have an automated workflow that will reload the squid configuration if any changes are made. In our use case the changes are dynamic and happen often. We were able to determine that frequency isn't the problem as the issue can be manually reproduced in the absents of any automation or significant load.

Environment:
OS: RHEL 7.9
Kernel: 3.10.0-1160.62.1.el7.x86_64
Squid: 4.14

In our test case we're using the AWS CLI to get information from EC2 instances. While looping &quot;ec2 describe-instances&quot; through the squid via a load balancer everything works great until we reload the service. Most times the command will pause and return the requested output after a few more seconds. However, more times than is tolerable when the service is reloading the command will return error &quot;Failed to connect to proxy URL&quot; to the client. With the AWS CLI debug enabled before the &quot;Failed to connect to proxy URL&quot; is thrown we see &quot;ConnectionResetError: [Errno 104] Connection reset by peer&quot;. We then ran packet captures and were able to determine that the reset was coming from the server running squid at the time the service was reloading. This connection is not logged by squid at all which was confusing to us that we had any client connection issues as the squid logs are clean. We are reloading the service with systemd but were able to reproduce the issue with &quot;squid -k reconfigure&quot; as well.

Our current plan is to upgrade our servers to RHEL8 and compile squid 5.6 in hopes that this issue will go away but we may need to go so far as programmatically removing a given squid node from the Load balancer before any service reload.

That said, it was our understanding that reloading the service would not disturb any old connections and new connections would receive the new configuration. We were wondering if anyone else has encountered any issues with connection resets of client traffic during squid service reload? Or may otherwise have any thoughts on this issue. Please let me know if I can provide any further detail.

Thanks in advance.

Regards,
Matt







-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20220613/0c472565/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20220613/0c472565/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="024833.html">[squid-users] sftp through Squid: sftp error with proxy: command-line line 0 bad protocol 2 host key algorithms +ssh-dss
</A></li>
	<LI>Next message (by thread): <A HREF="024832.html">[squid-users] Reloading squid service results in connection resets
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24831">[ date ]</a>
              <a href="thread.html#24831">[ thread ]</a>
              <a href="subject.html#24831">[ subject ]</a>
              <a href="author.html#24831">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
