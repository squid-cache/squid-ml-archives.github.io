<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid checking for both dstdomain and IP
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20checking%20for%20both%20dstdomain%20and%20IP&In-Reply-To=%3C419c10f1-b987-68de-c968-a1507eacfc22%40riosoft.com.br%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="024922.html">
   <LINK REL="Next"  HREF="024924.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid checking for both dstdomain and IP</H1>
    <B>Bruno de Paula Larini</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20checking%20for%20both%20dstdomain%20and%20IP&In-Reply-To=%3C419c10f1-b987-68de-c968-a1507eacfc22%40riosoft.com.br%3E"
       TITLE="[squid-users] Squid checking for both dstdomain and IP">bruno.larini at riosoft.com.br
       </A><BR>
    <I>Tue Jun 28 12:08:00 UTC 2022</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="024922.html">[squid-users] is there any squid 4.x version has delay_pools working?
</A></li>
        <LI>Next message (by thread): <A HREF="024924.html">[squid-users] Squid checking for both dstdomain and IP
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24920">[ date ]</a>
              <a href="thread.html#24920">[ thread ]</a>
              <a href="subject.html#24920">[ subject ]</a>
              <a href="author.html#24920">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi list.

I have a pretty simple configuration for website filtering (intercepted) 
and ssl_bump, which follows below.
However, for some reason, it seems Squid resolves the website domain 
address, then uses the IP to compare with the ACLs.
As the IP is not included in the ACL, the access to the website is denied.
Before that, it already checked for the domain name. I can tell based on 
the error from the browser.
I'm using Squid version 5.5.

For example, while trying to open <A HREF="https://repo.maven.apache.org/">https://repo.maven.apache.org/</A> 
(included in the allowed sites), the browser shows the error:

 &#160;&#160;&#160; The following error was encountered while trying to retrieve the 
URL: <A HREF="https://199.232.192.215/*">https://199.232.192.215/*</A>

 &#160;&#160;&#160; Access Denied.

If I replace 'deny all' with 'allow all', the website will open as expected.
Is there something wrong with my config? I have something similar 
running and working on version 4.4 (unless I'm missing something).
I'm still only splicing for now.

Thanks for the help!


### SQUID.CONF
...
#
# INSERT YOUR OWN RULE(S) HERE TO ALLOW ACCESS FROM YOUR CLIENTS
#

acl allowed_sites dstdomain &quot;/etc/squid/allowed-sites.txt&quot;
http_access allow allowed_sites

acl step1 at_step SslBump1
ssl_bump peek step1
ssl_bump splice all

tls_outgoing_options capath=/etc/pki/tls/certs options=ALL

sslcrtd_program /usr/lib64/squid/security_file_certgen -s 
/var/lib/squid/ssl_db -M 8MB
sslcrtd_children 3

http_access allow localhost

# And finally deny all other access to this proxy
http_access deny all

# Squid normally listens to port 3128
http_port 192.168.10.10:8080
http_port 192.168.10.10:3128 intercept
https_port 192.168.10.10:3129 tls-cert=/etc/squid/ssl/squidCA.pem 
tls-key=/etc/squid/ssl/squidCA.key ssl-bump intercept 
generate-host-certificates=on dynamic_cert_mem_cache_size=8MB
...

### IPTABLES
...
iptables -t nat -A PREROUTING -i eth0 -s 192.168.10.0/24 -p tcp --dport 
80 -j REDIRECT --to-port 3128
iptables -t nat -A PREROUTING -i eth0 -s 192.168.10.0/24 -p tcp --dport 
443 -j REDIRECT --to-port 3129
...


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="024922.html">[squid-users] is there any squid 4.x version has delay_pools working?
</A></li>
	<LI>Next message (by thread): <A HREF="024924.html">[squid-users] Squid checking for both dstdomain and IP
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24920">[ date ]</a>
              <a href="thread.html#24920">[ thread ]</a>
              <a href="subject.html#24920">[ subject ]</a>
              <a href="author.html#24920">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
