<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid checking for both dstdomain and IP
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20checking%20for%20both%20dstdomain%20and%20IP&In-Reply-To=%3C32a5bc9e-2900-9b33-061b-e3880694b30b%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="024920.html">
   <LINK REL="Next"  HREF="024925.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid checking for both dstdomain and IP</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20checking%20for%20both%20dstdomain%20and%20IP&In-Reply-To=%3C32a5bc9e-2900-9b33-061b-e3880694b30b%40measurement-factory.com%3E"
       TITLE="[squid-users] Squid checking for both dstdomain and IP">rousskov at measurement-factory.com
       </A><BR>
    <I>Tue Jun 28 13:52:10 UTC 2022</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="024920.html">[squid-users] Squid checking for both dstdomain and IP
</A></li>
        <LI>Next message (by thread): <A HREF="024925.html">[squid-users] Squid checking for both dstdomain and IP
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24924">[ date ]</a>
              <a href="thread.html#24924">[ thread ]</a>
              <a href="subject.html#24924">[ subject ]</a>
              <a href="author.html#24924">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 6/28/22 08:08, Bruno de Paula Larini wrote:

&gt;<i> I have a pretty simple configuration for website filtering (intercepted) 
</I>&gt;<i> and ssl_bump, which follows below.
</I>&gt;<i> However, for some reason, it seems Squid resolves the website domain 
</I>&gt;<i> address, then uses the IP to compare with the ACLs.
</I>
Most likely, what is actually happening is that Squid does not have 
domain information during SslBump step1, and then gets that information 
during step2. Squid http_access rules apply to each SslBump step, so you 
have to write them accordingly.

Available to Squid information and expected Squid behavior is documented 
for each step at the following wiki page. There are bugs in that 
algorithm _implementation_, but they are being fixed, and I am not aware 
of better docs: 
<A HREF="https://wiki.squid-cache.org/Features/SslPeekAndSplice#Processing_steps">https://wiki.squid-cache.org/Features/SslPeekAndSplice#Processing_steps</A>


HTH,

Alex.


&gt;<i> As the IP is not included in the ACL, the access to the website is denied.
</I>&gt;<i> Before that, it already checked for the domain name. I can tell based on 
</I>&gt;<i> the error from the browser.
</I>&gt;<i> I'm using Squid version 5.5.
</I>&gt;<i> 
</I>&gt;<i> For example, while trying to open <A HREF="https://repo.maven.apache.org/">https://repo.maven.apache.org/</A> 
</I>&gt;<i> (included in the allowed sites), the browser shows the error:
</I>&gt;<i> 
</I>&gt;<i>  &#160;&#160;&#160; The following error was encountered while trying to retrieve the 
</I>&gt;<i> URL: <A HREF="https://199.232.192.215/*">https://199.232.192.215/*</A>
</I>&gt;<i> 
</I>&gt;<i>  &#160;&#160;&#160; Access Denied.
</I>&gt;<i> 
</I>&gt;<i> If I replace 'deny all' with 'allow all', the website will open as 
</I>&gt;<i> expected.
</I>&gt;<i> Is there something wrong with my config? I have something similar 
</I>&gt;<i> running and working on version 4.4 (unless I'm missing something).
</I>&gt;<i> I'm still only splicing for now.
</I>&gt;<i> 
</I>&gt;<i> Thanks for the help!
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> ### SQUID.CONF
</I>&gt;<i> ...
</I>&gt;<i> #
</I>&gt;<i> # INSERT YOUR OWN RULE(S) HERE TO ALLOW ACCESS FROM YOUR CLIENTS
</I>&gt;<i> #
</I>&gt;<i> 
</I>&gt;<i> acl allowed_sites dstdomain &quot;/etc/squid/allowed-sites.txt&quot;
</I>&gt;<i> http_access allow allowed_sites
</I>&gt;<i> 
</I>&gt;<i> acl step1 at_step SslBump1
</I>&gt;<i> ssl_bump peek step1
</I>&gt;<i> ssl_bump splice all
</I>&gt;<i> 
</I>&gt;<i> tls_outgoing_options capath=/etc/pki/tls/certs options=ALL
</I>&gt;<i> 
</I>&gt;<i> sslcrtd_program /usr/lib64/squid/security_file_certgen -s 
</I>&gt;<i> /var/lib/squid/ssl_db -M 8MB
</I>&gt;<i> sslcrtd_children 3
</I>&gt;<i> 
</I>&gt;<i> http_access allow localhost
</I>&gt;<i> 
</I>&gt;<i> # And finally deny all other access to this proxy
</I>&gt;<i> http_access deny all
</I>&gt;<i> 
</I>&gt;<i> # Squid normally listens to port 3128
</I>&gt;<i> http_port 192.168.10.10:8080
</I>&gt;<i> http_port 192.168.10.10:3128 intercept
</I>&gt;<i> https_port 192.168.10.10:3129 tls-cert=/etc/squid/ssl/squidCA.pem 
</I>&gt;<i> tls-key=/etc/squid/ssl/squidCA.key ssl-bump intercept 
</I>&gt;<i> generate-host-certificates=on dynamic_cert_mem_cache_size=8MB
</I>&gt;<i> ...
</I>&gt;<i> 
</I>&gt;<i> ### IPTABLES
</I>&gt;<i> ...
</I>&gt;<i> iptables -t nat -A PREROUTING -i eth0 -s 192.168.10.0/24 -p tcp --dport 
</I>&gt;<i> 80 -j REDIRECT --to-port 3128
</I>&gt;<i> iptables -t nat -A PREROUTING -i eth0 -s 192.168.10.0/24 -p tcp --dport 
</I>&gt;<i> 443 -j REDIRECT --to-port 3129
</I>&gt;<i> ...
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="024920.html">[squid-users] Squid checking for both dstdomain and IP
</A></li>
	<LI>Next message (by thread): <A HREF="024925.html">[squid-users] Squid checking for both dstdomain and IP
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24924">[ date ]</a>
              <a href="thread.html#24924">[ thread ]</a>
              <a href="subject.html#24924">[ subject ]</a>
              <a href="author.html#24924">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
