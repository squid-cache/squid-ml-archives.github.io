<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] ssl_bump with parent cache
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20ssl_bump%20with%20parent%20cache&In-Reply-To=%3C1ba61eae-5f36-62ad-054a-e8194484c0ed%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="024629.html">
   <LINK REL="Next"  HREF="024631.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] ssl_bump with parent cache</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20ssl_bump%20with%20parent%20cache&In-Reply-To=%3C1ba61eae-5f36-62ad-054a-e8194484c0ed%40measurement-factory.com%3E"
       TITLE="[squid-users] ssl_bump with parent cache">rousskov at measurement-factory.com
       </A><BR>
    <I>Tue Mar  8 20:43:46 UTC 2022</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="024629.html">[squid-users] ssl_bump with parent cache
</A></li>
        <LI>Next message (by thread): <A HREF="024631.html">[squid-users] ssl_bump with parent cache
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24630">[ date ]</a>
              <a href="thread.html#24630">[ thread ]</a>
              <a href="subject.html#24630">[ subject ]</a>
              <a href="author.html#24630">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 3/8/22 14:16, Aaron Dewell wrote:

&gt;<i> I'm trying to use these two features at the same time.&#160; The use case is 
</I>&gt;<i> pretty simple.&#160; I want to capture all traffic from a single source (a 
</I>&gt;<i> device of mine) to another squid proxy server and decrypt/log it.&#160;&#160;&#160; I'm 
</I>&gt;<i> using the Ubuntu 20 package of squid-ssl version 4.13.
</I>&gt;<i> 
</I>&gt;<i> Device -&gt; ssl_bump proxy -&gt; upstream proxy -&gt; website
</I>&gt;<i> 
</I>&gt;<i> It was all successfully working without ssl_bump, so the cache_peer 
</I>&gt;<i> configuration works.&#160; One side note: the parent proxy is running on 443 
</I>&gt;<i> without SSL (I believe - I don't run it but I've asked those that do for 
</I>&gt;<i> confirmation, but I do know it's a pretty standard destination proxy 
</I>&gt;<i> configuration).
</I>&gt;<i> 
</I>&gt;<i> The website itself is not directly accessible thus the upstream proxy is 
</I>&gt;<i> required.
</I>&gt;<i> 
</I>&gt;<i> Adding the ssl_bump configuration caused it to not work, with errors 
</I>&gt;<i> about SSL versions and &quot;Error negotiating SSL connection on FD xx&quot;.&#160; My 
</I>&gt;<i> best guess is that it is attempting to establish an SSL connection to 
</I>&gt;<i> the upstream and failing.
</I>&gt;<i> 
</I>&gt;<i> acl step1 at_step SslBump1
</I>&gt;<i> ssl_bump peek step1
</I>&gt;<i> ssl_bump bump all
</I>&gt;<i> http_port&#160;3128 ssl-bump cert=/var/lib/squid/ssl_cert/myCA.pem 
</I>&gt;<i> generate-host-certificates=on dynamic_cert_mem_cache_size=4MB
</I>&gt;<i> tls_outgoing_options options=NO_SSLv3 
</I>&gt;<i> flags=DON'T_VERIFY_PEER,DONT_VERIFY_DOMAIN 
</I>&gt;<i> cert=/var/lib/squid/ssl_cert/device.pem 
</I>&gt;<i> key=/var/lib/squid/ssl_cert/client.key
</I>&gt;<i> 
</I>&gt;<i> (client.key and client.pem are from the device and are needed due to the 
</I>&gt;<i> authentication of the session at the destination server.&#160; Also, I 
</I>&gt;<i> haven't looked at the packet logging yet. I assume that will be an easy 
</I>&gt;<i> addition once the setup works generally.)
</I>&gt;<i> 
</I>&gt;<i> However, my understanding is that the cache_peer configuration should 
</I>&gt;<i> NOT do TLS by default unless that was specified in the options, and I 
</I>&gt;<i> see no way to explicitly disable it.
</I>&gt;<i> 
</I>&gt;<i> So first question: is that assumption accurate?&#160; No TLS to the parent 
</I>&gt;<i> unless explicitly configured?
</I>
Yes, that is correct: cache_peers are plain HTTP forward proxies unless 
explicitly configured otherwise. Their listening port value does carry 
any special meaning as far as Squid code is concerned.

However, it is very unusual to run a plain HTTP forward proxy on port 
443. That port may imply that your parent proxy is an HTTPS reverse 
proxy. If it is, you need to use originserver flag when configuring the 
corresponding cache_peer line. You can check by sending plain CONNECT 
requests to that upstream proxy using wget, curl, or some such. A 
reverse HTTPS proxy would reject such requests.


&gt;<i> if the ssl_bump configuration is causing it to attempt an upstream 
</I>&gt;<i> TLS connection ...
</I>
Bugs notwithstanding, it should not.


&gt;<i> Anything here that I'm doing obviously wrong?
</I>
I see no red flags relevant to your specific question.

Does replacing &quot;bump all&quot; with &quot;splice all&quot; fix the problem? I realize 
that you do want to bump/see the device traffic, but I wonder whether 
the errors are not between Squid and the upstream proxy but Squid and 
the web site. Splicing would remove those errors while still keeping 
some SslBump code active.

Sharing a (pointer to compressed) libpcap packet capture and/or a 
(pointer to compressed) ALL,9 cache.log while reproducing the problem 
with a single transaction may help: 
<A HREF="https://wiki.squid-cache.org/SquidFaq/BugReporting#Debugging_a_single_transaction">https://wiki.squid-cache.org/SquidFaq/BugReporting#Debugging_a_single_transaction</A>

Alex.

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="024629.html">[squid-users] ssl_bump with parent cache
</A></li>
	<LI>Next message (by thread): <A HREF="024631.html">[squid-users] ssl_bump with parent cache
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24630">[ date ]</a>
              <a href="thread.html#24630">[ thread ]</a>
              <a href="subject.html#24630">[ subject ]</a>
              <a href="author.html#24630">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
