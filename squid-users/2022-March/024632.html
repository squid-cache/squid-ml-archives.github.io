<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] ssl_bump with parent cache
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20ssl_bump%20with%20parent%20cache&In-Reply-To=%3Cf716fa4b-6dfe-925d-e5eb-550d3762eedc%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="024631.html">
   <LINK REL="Next"  HREF="024633.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] ssl_bump with parent cache</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20ssl_bump%20with%20parent%20cache&In-Reply-To=%3Cf716fa4b-6dfe-925d-e5eb-550d3762eedc%40measurement-factory.com%3E"
       TITLE="[squid-users] ssl_bump with parent cache">rousskov at measurement-factory.com
       </A><BR>
    <I>Tue Mar  8 21:57:36 UTC 2022</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="024631.html">[squid-users] ssl_bump with parent cache
</A></li>
        <LI>Next message (by thread): <A HREF="024633.html">[squid-users] ssl_bump with parent cache
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24632">[ date ]</a>
              <a href="thread.html#24632">[ thread ]</a>
              <a href="subject.html#24632">[ subject ]</a>
              <a href="author.html#24632">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 3/8/22 16:38, Aaron Dewell wrote:

&gt;<i> Hi Alex, thanks for your reply!&#160; I did get access to the parent proxy 
</I>&gt;<i> and my assumption was wrong, it's doing minimal bumping.
</I>
TLS inspection at the parent proxy does not affect what I was trying to 
double check. What matters is whether it is a forward HTTP proxy (e.g., 
a Squid instance listening on an http_port configured without intercept, 
tproxy, or accel flags). It sounds like that is what it is. That's OK!

I do not remember whether your Squid version (v4.13) supports SslBump 
with parent forward proxies, but I believe modern Squids do, and we can 
assume that your Squid version does as well. The debugging should show 
whether that is indeed the case.


&gt;<i> The parent is doing peek and splice to an exact list of internal 
</I>&gt;<i> destinations.&#160; Specifically, peek step1 all, peek step2 allowed_sites, 
</I>&gt;<i> splice allowed_sites, terminate all.&#160; That shouldn't (to my imperfect 
</I>&gt;<i> knowledge) interfere with what I'm doing though.
</I>
Yes, assuming the parent does not terminate your Squid connections, of 
course (i.e. assuming connections from your Squid always match 
allowed_sites after step1 at the parent proxy).


&gt;<i> That's a good idea to do splice only and see if that's successful.  
</I>&gt;<i> Trying to do too much at once!&#160; I'll see what that does, then try debug 
</I>&gt;<i> again.&#160; The debug output wasn't very helpful before, but stepwise may be 
</I>&gt;<i> more useful.
</I>
Just to clarify: The debugging output was not meant for you to 
interpret. A Squid developer should do that. It may contain sensitive 
details; it is best to not use anything but test traffic and test 
certificate keys when sharing ALL,9 output.

Alex.


&gt;<i> On Mar 8 2022, at 1:43 pm, Alex Rousskov  wrote:
</I>&gt;<i> 
</I>&gt;<i>     On 3/8/22 14:16, Aaron Dewell wrote:
</I>&gt;<i> 
</I>&gt;<i>      &gt; I'm trying to use these two features at the same time.&#160; The use
</I>&gt;<i>     case is
</I>&gt;<i>      &gt; pretty simple.&#160; I want to capture all traffic from a single source (a
</I>&gt;<i>      &gt; device of mine) to another squid proxy server and decrypt/log
</I>&gt;<i>     it.&#160;&#160;&#160; I'm
</I>&gt;<i>      &gt; using the Ubuntu 20 package of squid-ssl version 4.13.
</I>&gt;<i>      &gt;
</I>&gt;<i>      &gt; Device -&gt; ssl_bump proxy -&gt; upstream proxy -&gt; website
</I>&gt;<i>      &gt;
</I>&gt;<i>      &gt; It was all successfully working without ssl_bump, so the cache_peer
</I>&gt;<i>      &gt; configuration works.&#160; One side note: the parent proxy is running
</I>&gt;<i>     on 443
</I>&gt;<i>      &gt; without SSL (I believe - I don't run it but I've asked those that
</I>&gt;<i>     do for
</I>&gt;<i>      &gt; confirmation, but I do know it's a pretty standard destination proxy
</I>&gt;<i>      &gt; configuration).
</I>&gt;<i>      &gt;
</I>&gt;<i>      &gt; The website itself is not directly accessible thus the upstream
</I>&gt;<i>     proxy is
</I>&gt;<i>      &gt; required.
</I>&gt;<i>      &gt;
</I>&gt;<i>      &gt; Adding the ssl_bump configuration caused it to not work, with errors
</I>&gt;<i>      &gt; about SSL versions and &quot;Error negotiating SSL connection on FD
</I>&gt;<i>     xx&quot;.&#160; My
</I>&gt;<i>      &gt; best guess is that it is attempting to establish an SSL connection to
</I>&gt;<i>      &gt; the upstream and failing.
</I>&gt;<i>      &gt;
</I>&gt;<i>      &gt; acl step1 at_step SslBump1
</I>&gt;<i>      &gt; ssl_bump peek step1
</I>&gt;<i>      &gt; ssl_bump bump all
</I>&gt;<i>      &gt; http_port&#160;3128 ssl-bump cert=/var/lib/squid/ssl_cert/myCA.pem
</I>&gt;<i>      &gt; generate-host-certificates=on dynamic_cert_mem_cache_size=4MB
</I>&gt;<i>      &gt; tls_outgoing_options options=NO_SSLv3
</I>&gt;<i>      &gt; flags=DON'T_VERIFY_PEER,DONT_VERIFY_DOMAIN
</I>&gt;<i>      &gt; cert=/var/lib/squid/ssl_cert/device.pem
</I>&gt;<i>      &gt; key=/var/lib/squid/ssl_cert/client.key
</I>&gt;<i>      &gt;
</I>&gt;<i>      &gt; (client.key and client.pem are from the device and are needed due
</I>&gt;<i>     to the
</I>&gt;<i>      &gt; authentication of the session at the destination server.&#160; Also, I
</I>&gt;<i>      &gt; haven't looked at the packet logging yet. I assume that will be
</I>&gt;<i>     an easy
</I>&gt;<i>      &gt; addition once the setup works generally.)
</I>&gt;<i>      &gt;
</I>&gt;<i>      &gt; However, my understanding is that the cache_peer configuration should
</I>&gt;<i>      &gt; NOT do TLS by default unless that was specified in the options, and I
</I>&gt;<i>      &gt; see no way to explicitly disable it.
</I>&gt;<i>      &gt;
</I>&gt;<i>      &gt; So first question: is that assumption accurate?&#160; No TLS to the parent
</I>&gt;<i>      &gt; unless explicitly configured?
</I>&gt;<i> 
</I>&gt;<i>     Yes, that is correct: cache_peers are plain HTTP forward proxies unless
</I>&gt;<i>     explicitly configured otherwise. Their listening port value does carry
</I>&gt;<i>     any special meaning as far as Squid code is concerned.
</I>&gt;<i> 
</I>&gt;<i>     However, it is very unusual to run a plain HTTP forward proxy on port
</I>&gt;<i>     443. That port may imply that your parent proxy is an HTTPS reverse
</I>&gt;<i>     proxy. If it is, you need to use originserver flag when configuring the
</I>&gt;<i>     corresponding cache_peer line. You can check by sending plain CONNECT
</I>&gt;<i>     requests to that upstream proxy using wget, curl, or some such. A
</I>&gt;<i>     reverse HTTPS proxy would reject such requests.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i>      &gt; if the ssl_bump configuration is causing it to attempt an upstream
</I>&gt;<i>      &gt; TLS connection ...
</I>&gt;<i> 
</I>&gt;<i>     Bugs notwithstanding, it should not.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i>      &gt; Anything here that I'm doing obviously wrong?
</I>&gt;<i> 
</I>&gt;<i>     I see no red flags relevant to your specific question.
</I>&gt;<i> 
</I>&gt;<i>     Does replacing &quot;bump all&quot; with &quot;splice all&quot; fix the problem? I realize
</I>&gt;<i>     that you do want to bump/see the device traffic, but I wonder whether
</I>&gt;<i>     the errors are not between Squid and the upstream proxy but Squid and
</I>&gt;<i>     the web site. Splicing would remove those errors while still keeping
</I>&gt;<i>     some SslBump code active.
</I>&gt;<i> 
</I>&gt;<i>     Sharing a (pointer to compressed) libpcap packet capture and/or a
</I>&gt;<i>     (pointer to compressed) ALL,9 cache.log while reproducing the problem
</I>&gt;<i>     with a single transaction may help:
</I>&gt;<i>     <A HREF="https://wiki.squid-cache.org/SquidFaq/BugReporting#Debugging_a_single_transaction">https://wiki.squid-cache.org/SquidFaq/BugReporting#Debugging_a_single_transaction</A>
</I>&gt;<i> 
</I>&gt;<i>     Alex.
</I>&gt;<i>     _______________________________________________
</I>&gt;<i>     squid-users mailing list
</I>&gt;<i>     <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i>     <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i> 
</I>&gt;<i> Sent from Mailspring
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="024631.html">[squid-users] ssl_bump with parent cache
</A></li>
	<LI>Next message (by thread): <A HREF="024633.html">[squid-users] ssl_bump with parent cache
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24632">[ date ]</a>
              <a href="thread.html#24632">[ thread ]</a>
              <a href="subject.html#24632">[ subject ]</a>
              <a href="author.html#24632">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
