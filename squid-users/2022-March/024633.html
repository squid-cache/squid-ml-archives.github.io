<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] ssl_bump with parent cache
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20ssl_bump%20with%20parent%20cache&In-Reply-To=%3CE24BC440-52BA-431A-A9AC-A6C5A1958101%40getmailspring.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="024632.html">
   <LINK REL="Next"  HREF="024634.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] ssl_bump with parent cache</H1>
    <B>Aaron Dewell</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20ssl_bump%20with%20parent%20cache&In-Reply-To=%3CE24BC440-52BA-431A-A9AC-A6C5A1958101%40getmailspring.com%3E"
       TITLE="[squid-users] ssl_bump with parent cache">acd at woods.net
       </A><BR>
    <I>Tue Mar  8 22:56:22 UTC 2022</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="024632.html">[squid-users] ssl_bump with parent cache
</A></li>
        <LI>Next message (by thread): <A HREF="024634.html">[squid-users] ssl_bump with parent cache
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24633">[ date ]</a>
              <a href="thread.html#24633">[ thread ]</a>
              <a href="subject.html#24633">[ subject ]</a>
              <a href="author.html#24633">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
Ok, with a bit more messing with it... Changing bump to splice does work:
ssl_bump splice all
Adding:
acl step2 at_step SslBump2
ssl_bump peek step1
ssl_bump peek step2
ssl_bump splice step2

Fails (back to the connection errors as with bump). My guess is that this means it can splice at step1 but not step 2, which I know is more intrusive.
This appears to be the relevant data from the log:
2022/03/08 14:35:47.644 kid1| 83,7| bio.cc(163) stateChanged: FD 10 now: 0x4004 TED (TLSv1.3 early data)
2022/03/08 14:35:47.644 kid1| 83,7| bio.cc(163) stateChanged: FD 10 now: 0x2002 SSLERR (error)
2022/03/08 14:35:47.644 kid1| Error negotiating SSL connection on FD 10: error:00000001:lib(0):func(0):reason(1) (1/-1)

at which point it starts freeing memory, etc.
On Mar 8 2022, at 2:57 pm, Alex Rousskov &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt; wrote:
&gt;<i> On 3/8/22 16:38, Aaron Dewell wrote:
</I>&gt;<i>
</I>&gt;<i> &gt; Hi Alex, thanks for your reply! I did get access to the parent proxy
</I>&gt;<i> &gt; and my assumption was wrong, it's doing minimal bumping.
</I>&gt;<i>
</I>&gt;<i> TLS inspection at the parent proxy does not affect what I was trying to
</I>&gt;<i> double check. What matters is whether it is a forward HTTP proxy (e.g.,
</I>&gt;<i> a Squid instance listening on an http_port configured without intercept,
</I>&gt;<i> tproxy, or accel flags). It sounds like that is what it is. That's OK!
</I>&gt;<i>
</I>&gt;<i> I do not remember whether your Squid version (v4.13) supports SslBump
</I>&gt;<i> with parent forward proxies, but I believe modern Squids do, and we can
</I>&gt;<i> assume that your Squid version does as well. The debugging should show
</I>&gt;<i> whether that is indeed the case.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; The parent is doing peek and splice to an exact list of internal
</I>&gt;<i> &gt; destinations. Specifically, peek step1 all, peek step2 allowed_sites,
</I>&gt;<i> &gt; splice allowed_sites, terminate all. That shouldn't (to my imperfect
</I>&gt;<i> &gt; knowledge) interfere with what I'm doing though.
</I>&gt;<i>
</I>&gt;<i> Yes, assuming the parent does not terminate your Squid connections, of
</I>&gt;<i> course (i.e. assuming connections from your Squid always match
</I>&gt;<i> allowed_sites after step1 at the parent proxy).
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; That's a good idea to do splice only and see if that's successful.
</I>&gt;<i> &gt; Trying to do too much at once! I'll see what that does, then try debug
</I>&gt;<i> &gt; again. The debug output wasn't very helpful before, but stepwise may be
</I>&gt;<i> &gt; more useful.
</I>&gt;<i>
</I>&gt;<i> Just to clarify: The debugging output was not meant for you to
</I>&gt;<i> interpret. A Squid developer should do that. It may contain sensitive
</I>&gt;<i> details; it is best to not use anything but test traffic and test
</I>&gt;<i> certificate keys when sharing ALL,9 output.
</I>&gt;<i>
</I>&gt;<i> Alex.
</I>&gt;<i>
</I>&gt;<i> &gt; On Mar 8 2022, at 1:43 pm, Alex Rousskov wrote:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; On 3/8/22 14:16, Aaron Dewell wrote:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; &gt; I'm trying to use these two features at the same time. The use
</I>&gt;<i> &gt; case is
</I>&gt;<i> &gt; &gt; pretty simple. I want to capture all traffic from a single source (a
</I>&gt;<i> &gt; &gt; device of mine) to another squid proxy server and decrypt/log
</I>&gt;<i> &gt; it. I'm
</I>&gt;<i> &gt; &gt; using the Ubuntu 20 package of squid-ssl version 4.13.
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; Device -&gt; ssl_bump proxy -&gt; upstream proxy -&gt; website
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; It was all successfully working without ssl_bump, so the cache_peer
</I>&gt;<i> &gt; &gt; configuration works. One side note: the parent proxy is running
</I>&gt;<i> &gt; on 443
</I>&gt;<i> &gt; &gt; without SSL (I believe - I don't run it but I've asked those that
</I>&gt;<i> &gt; do for
</I>&gt;<i> &gt; &gt; confirmation, but I do know it's a pretty standard destination proxy
</I>&gt;<i> &gt; &gt; configuration).
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; The website itself is not directly accessible thus the upstream
</I>&gt;<i> &gt; proxy is
</I>&gt;<i> &gt; &gt; required.
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; Adding the ssl_bump configuration caused it to not work, with errors
</I>&gt;<i> &gt; &gt; about SSL versions and &quot;Error negotiating SSL connection on FD
</I>&gt;<i> &gt; xx&quot;. My
</I>&gt;<i> &gt; &gt; best guess is that it is attempting to establish an SSL connection to
</I>&gt;<i> &gt; &gt; the upstream and failing.
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; acl step1 at_step SslBump1
</I>&gt;<i> &gt; &gt; ssl_bump peek step1
</I>&gt;<i> &gt; &gt; ssl_bump bump all
</I>&gt;<i> &gt; &gt; http_port 3128 ssl-bump cert=/var/lib/squid/ssl_cert/myCA.pem
</I>&gt;<i> &gt; &gt; generate-host-certificates=on dynamic_cert_mem_cache_size=4MB
</I>&gt;<i> &gt; &gt; tls_outgoing_options options=NO_SSLv3
</I>&gt;<i> &gt; &gt; flags=DON'T_VERIFY_PEER,DONT_VERIFY_DOMAIN
</I>&gt;<i> &gt; &gt; cert=/var/lib/squid/ssl_cert/device.pem
</I>&gt;<i> &gt; &gt; key=/var/lib/squid/ssl_cert/client.key
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; (client.key and client.pem are from the device and are needed due
</I>&gt;<i> &gt; to the
</I>&gt;<i> &gt; &gt; authentication of the session at the destination server. Also, I
</I>&gt;<i> &gt; &gt; haven't looked at the packet logging yet. I assume that will be
</I>&gt;<i> &gt; an easy
</I>&gt;<i> &gt; &gt; addition once the setup works generally.)
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; However, my understanding is that the cache_peer configuration should
</I>&gt;<i> &gt; &gt; NOT do TLS by default unless that was specified in the options, and I
</I>&gt;<i> &gt; &gt; see no way to explicitly disable it.
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; So first question: is that assumption accurate? No TLS to the parent
</I>&gt;<i> &gt; &gt; unless explicitly configured?
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Yes, that is correct: cache_peers are plain HTTP forward proxies unless
</I>&gt;<i> &gt; explicitly configured otherwise. Their listening port value does carry
</I>&gt;<i> &gt; any special meaning as far as Squid code is concerned.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; However, it is very unusual to run a plain HTTP forward proxy on port
</I>&gt;<i> &gt; 443. That port may imply that your parent proxy is an HTTPS reverse
</I>&gt;<i> &gt; proxy. If it is, you need to use originserver flag when configuring the
</I>&gt;<i> &gt; corresponding cache_peer line. You can check by sending plain CONNECT
</I>&gt;<i> &gt; requests to that upstream proxy using wget, curl, or some such. A
</I>&gt;<i> &gt; reverse HTTPS proxy would reject such requests.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; &gt; if the ssl_bump configuration is causing it to attempt an upstream
</I>&gt;<i> &gt; &gt; TLS connection ...
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Bugs notwithstanding, it should not.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; &gt; Anything here that I'm doing obviously wrong?
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I see no red flags relevant to your specific question.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Does replacing &quot;bump all&quot; with &quot;splice all&quot; fix the problem? I realize
</I>&gt;<i> &gt; that you do want to bump/see the device traffic, but I wonder whether
</I>&gt;<i> &gt; the errors are not between Squid and the upstream proxy but Squid and
</I>&gt;<i> &gt; the web site. Splicing would remove those errors while still keeping
</I>&gt;<i> &gt; some SslBump code active.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Sharing a (pointer to compressed) libpcap packet capture and/or a
</I>&gt;<i> &gt; (pointer to compressed) ALL,9 cache.log while reproducing the problem
</I>&gt;<i> &gt; with a single transaction may help:
</I>&gt;<i> &gt; <A HREF="https://wiki.squid-cache.org/SquidFaq/BugReporting#Debugging_a_single_transaction">https://wiki.squid-cache.org/SquidFaq/BugReporting#Debugging_a_single_transaction</A>
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Alex.
</I>&gt;<i> &gt; _______________________________________________
</I>&gt;<i> &gt; squid-users mailing list
</I>&gt;<i> &gt; <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> &gt; <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Sent from Mailspring
</I>&gt;<i>
</I>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20220308/ebdf3508/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20220308/ebdf3508/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="024632.html">[squid-users] ssl_bump with parent cache
</A></li>
	<LI>Next message (by thread): <A HREF="024634.html">[squid-users] ssl_bump with parent cache
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24633">[ date ]</a>
              <a href="thread.html#24633">[ thread ]</a>
              <a href="subject.html#24633">[ subject ]</a>
              <a href="author.html#24633">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
