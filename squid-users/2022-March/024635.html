<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] ssl_bump with parent cache
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20ssl_bump%20with%20parent%20cache&In-Reply-To=%3CD38C42C1-291B-4932-9405-E8BA358DB29D%40getmailspring.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="024634.html">
   <LINK REL="Next"  HREF="024636.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] ssl_bump with parent cache</H1>
    <B>Aaron Dewell</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20ssl_bump%20with%20parent%20cache&In-Reply-To=%3CD38C42C1-291B-4932-9405-E8BA358DB29D%40getmailspring.com%3E"
       TITLE="[squid-users] ssl_bump with parent cache">acd at woods.net
       </A><BR>
    <I>Wed Mar  9 21:16:14 UTC 2022</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="024634.html">[squid-users] ssl_bump with parent cache
</A></li>
        <LI>Next message (by thread): <A HREF="024636.html">[squid-users] ssl_bump with parent cache
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24635">[ date ]</a>
              <a href="thread.html#24635">[ thread ]</a>
              <a href="subject.html#24635">[ subject ]</a>
              <a href="author.html#24635">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
So after a bit more experimentation. the difference in what works and what doesn't is:
ssl_bump peek step1
ssl_bump splice all

(working) and this not working:
ssl_bump peek all
ssl_bump splice all

I'm not clear on why peeking at &quot;all&quot; vs. &quot;step1&quot; would cause it to fail. However, I also note that not peeking at anything makes it work also (commenting out the &quot;peek&quot; line), so I'm suspicious that &quot;peek step1&quot; is effectively having it do nothing.
&quot;stare step1&quot; also works, but &quot;stare all&quot; does not (i.e. same result as &quot;peek&quot;).
&quot;stare step1&quot; followed by &quot;bump all&quot; fails as well (i.e. changing &quot;splice&quot; to &quot;bump&quot;), as does &quot;stare all/bump all&quot;.
I'm probably not going to be able to share any packet dumps so that does make things difficult. This device is under development and the details of &quot;what it's doing&quot; is likely to be sensitive. I appreciate that makes troubleshooting things difficult. What I could do is put a VM behind it and do manual wgets or something from it but that will take some changes to the environment, or perhaps just creating a new one to test this where this device isn't present. If that's where it needs to go, I'll have to start discussions on exactly how sensitive it is and/or start creating the new/modified setup.
Anyway, I do appreciate the suggestions, and the lightbulb is starting to go on, albeit dimly. :)
On Mar 8 2022, at 4:16 pm, Alex Rousskov &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt; wrote:
&gt;<i> On 3/8/22 17:56, Aaron Dewell wrote:
</I>&gt;<i> &gt; Ok, with a bit more messing with it... Changing bump to splice does work:
</I>&gt;<i>
</I>&gt;<i> &gt; ssl_bump splice all
</I>&gt;<i> Noted.
</I>&gt;<i>
</I>&gt;<i> &gt; Adding:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; acl step2 at_step SslBump2
</I>&gt;<i> &gt; ssl_bump peek step1
</I>&gt;<i> &gt; ssl_bump peek step2
</I>&gt;<i> &gt; ssl_bump splice step2
</I>&gt;<i>
</I>&gt;<i> The above is a bad configuration because no rule matches during step3.
</I>&gt;<i> Please try this configuration instead, to make sure you are not seeing a
</I>&gt;<i> side effect of various Squid bugs related to such configurations (we are
</I>&gt;<i> working on fixing them):
</I>&gt;<i>
</I>&gt;<i> ssl_bump peek all
</I>&gt;<i> ssl_bump splice all
</I>&gt;<i>
</I>&gt;<i> If the above fails, please see my earlier suggestions about sharing test
</I>&gt;<i> artifacts. Otherwise, please try this:
</I>&gt;<i>
</I>&gt;<i> ssl_bump stare all
</I>&gt;<i> ssl_bump bump all
</I>&gt;<i>
</I>&gt;<i> If the above fails, please see my earlier suggestions about sharing test
</I>&gt;<i> artifacts. Otherwise, please try this:
</I>&gt;<i>
</I>&gt;<i> ssl_bump peek step1
</I>&gt;<i> ssl_bump bump all
</I>&gt;<i>
</I>&gt;<i> If the above fails, please see my earlier suggestions about sharing test
</I>&gt;<i> artifacts. Otherwise, you got a working config (which is the same config
</I>&gt;<i> you have started with, so I doubt you will get to this stage!).
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; This appears to be the relevant data from the log:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; 2022/03/08 14:35:47.644 kid1| 83,7| bio.cc(163) stateChanged: FD 10 now: 0x4004 TED (TLSv1.3 early data)
</I>&gt;<i> &gt; 2022/03/08 14:35:47.644 kid1| 83,7| bio.cc(163) stateChanged: FD 10 now: 0x2002 SSLERR (error)
</I>&gt;<i> &gt; 2022/03/08 14:35:47.644 kid1| Error negotiating SSL connection on FD 10: error:00000001:lib(0):func(0):reason(1) (1/-1)
</I>&gt;<i>
</I>&gt;<i> YMMV, but I will need to see a lot more lines surrounding this snippet
</I>&gt;<i> to understand what exactly went wrong. That is why I am asking for the
</I>&gt;<i> entire transaction log rather than selected &quot;error&quot; lines.
</I>&gt;<i>
</I>&gt;<i> Sharing a packet capture might be sufficient if this is a basic
</I>&gt;<i> misconfiguration error -- we will see wrong protocol traffic on one of
</I>&gt;<i> both Squid sides. You can start with that (often, but not always, safer
</I>&gt;<i> as far as sensitive info disclosure) step if you prefer.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> HTH,
</I>&gt;<i> Alex.
</I>&gt;<i>
</I>&gt;<i> &gt; On Mar 8 2022, at 2:57 pm, Alex Rousskov wrote:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; On 3/8/22 16:38, Aaron Dewell wrote:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; &gt; Hi Alex, thanks for your reply! I did get access to the parent proxy
</I>&gt;<i> &gt; &gt; and my assumption was wrong, it's doing minimal bumping.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; TLS inspection at the parent proxy does not affect what I was trying to
</I>&gt;<i> &gt; double check. What matters is whether it is a forward HTTP proxy (e.g.,
</I>&gt;<i> &gt; a Squid instance listening on an http_port configured without intercept,
</I>&gt;<i> &gt; tproxy, or accel flags). It sounds like that is what it is. That's OK!
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I do not remember whether your Squid version (v4.13) supports SslBump
</I>&gt;<i> &gt; with parent forward proxies, but I believe modern Squids do, and we can
</I>&gt;<i> &gt; assume that your Squid version does as well. The debugging should show
</I>&gt;<i> &gt; whether that is indeed the case.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; &gt; The parent is doing peek and splice to an exact list of internal
</I>&gt;<i> &gt; &gt; destinations. Specifically, peek step1 all, peek step2
</I>&gt;<i> &gt; allowed_sites,
</I>&gt;<i> &gt; &gt; splice allowed_sites, terminate all. That shouldn't (to my imperfect
</I>&gt;<i> &gt; &gt; knowledge) interfere with what I'm doing though.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Yes, assuming the parent does not terminate your Squid connections, of
</I>&gt;<i> &gt; course (i.e. assuming connections from your Squid always match
</I>&gt;<i> &gt; allowed_sites after step1 at the parent proxy).
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; &gt; That's a good idea to do splice only and see if that's successful.
</I>&gt;<i> &gt; &gt; Trying to do too much at once! I'll see what that does, then try
</I>&gt;<i> &gt; debug
</I>&gt;<i> &gt; &gt; again. The debug output wasn't very helpful before, but stepwise
</I>&gt;<i> &gt; may be
</I>&gt;<i> &gt; &gt; more useful.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Just to clarify: The debugging output was not meant for you to
</I>&gt;<i> &gt; interpret. A Squid developer should do that. It may contain sensitive
</I>&gt;<i> &gt; details; it is best to not use anything but test traffic and test
</I>&gt;<i> &gt; certificate keys when sharing ALL,9 output.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Alex.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; &gt; On Mar 8 2022, at 1:43 pm, Alex Rousskov wrote:
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; On 3/8/22 14:16, Aaron Dewell wrote:
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt; I'm trying to use these two features at the same time. The use
</I>&gt;<i> &gt; &gt; case is
</I>&gt;<i> &gt; &gt; &gt; pretty simple. I want to capture all traffic from a single
</I>&gt;<i> &gt; source (a
</I>&gt;<i> &gt; &gt; &gt; device of mine) to another squid proxy server and decrypt/log
</I>&gt;<i> &gt; &gt; it. I'm
</I>&gt;<i> &gt; &gt; &gt; using the Ubuntu 20 package of squid-ssl version 4.13.
</I>&gt;<i> &gt; &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt; Device -&gt; ssl_bump proxy -&gt; upstream proxy -&gt; website
</I>&gt;<i> &gt; &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt; It was all successfully working without ssl_bump, so the cache_peer
</I>&gt;<i> &gt; &gt; &gt; configuration works. One side note: the parent proxy is running
</I>&gt;<i> &gt; &gt; on 443
</I>&gt;<i> &gt; &gt; &gt; without SSL (I believe - I don't run it but I've asked those that
</I>&gt;<i> &gt; &gt; do for
</I>&gt;<i> &gt; &gt; &gt; confirmation, but I do know it's a pretty standard destination
</I>&gt;<i> &gt; proxy
</I>&gt;<i> &gt; &gt; &gt; configuration).
</I>&gt;<i> &gt; &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt; The website itself is not directly accessible thus the upstream
</I>&gt;<i> &gt; &gt; proxy is
</I>&gt;<i> &gt; &gt; &gt; required.
</I>&gt;<i> &gt; &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt; Adding the ssl_bump configuration caused it to not work, with
</I>&gt;<i> &gt; errors
</I>&gt;<i> &gt; &gt; &gt; about SSL versions and &quot;Error negotiating SSL connection on FD
</I>&gt;<i> &gt; &gt; xx&quot;. My
</I>&gt;<i> &gt; &gt; &gt; best guess is that it is attempting to establish an SSL
</I>&gt;<i> &gt; connection to
</I>&gt;<i> &gt; &gt; &gt; the upstream and failing.
</I>&gt;<i> &gt; &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt; acl step1 at_step SslBump1
</I>&gt;<i> &gt; &gt; &gt; ssl_bump peek step1
</I>&gt;<i> &gt; &gt; &gt; ssl_bump bump all
</I>&gt;<i> &gt; &gt; &gt; http_port 3128 ssl-bump cert=/var/lib/squid/ssl_cert/myCA.pem
</I>&gt;<i> &gt; &gt; &gt; generate-host-certificates=on dynamic_cert_mem_cache_size=4MB
</I>&gt;<i> &gt; &gt; &gt; tls_outgoing_options options=NO_SSLv3
</I>&gt;<i> &gt; &gt; &gt; flags=DON'T_VERIFY_PEER,DONT_VERIFY_DOMAIN
</I>&gt;<i> &gt; &gt; &gt; cert=/var/lib/squid/ssl_cert/device.pem
</I>&gt;<i> &gt; &gt; &gt; key=/var/lib/squid/ssl_cert/client.key
</I>&gt;<i> &gt; &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt; (client.key and client.pem are from the device and are needed due
</I>&gt;<i> &gt; &gt; to the
</I>&gt;<i> &gt; &gt; &gt; authentication of the session at the destination server. Also, I
</I>&gt;<i> &gt; &gt; &gt; haven't looked at the packet logging yet. I assume that will be
</I>&gt;<i> &gt; &gt; an easy
</I>&gt;<i> &gt; &gt; &gt; addition once the setup works generally.)
</I>&gt;<i> &gt; &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt; However, my understanding is that the cache_peer configuration
</I>&gt;<i> &gt; should
</I>&gt;<i> &gt; &gt; &gt; NOT do TLS by default unless that was specified in the options,
</I>&gt;<i> &gt; and I
</I>&gt;<i> &gt; &gt; &gt; see no way to explicitly disable it.
</I>&gt;<i> &gt; &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt; So first question: is that assumption accurate? No TLS to the
</I>&gt;<i> &gt; parent
</I>&gt;<i> &gt; &gt; &gt; unless explicitly configured?
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; Yes, that is correct: cache_peers are plain HTTP forward proxies
</I>&gt;<i> &gt; unless
</I>&gt;<i> &gt; &gt; explicitly configured otherwise. Their listening port value does
</I>&gt;<i> &gt; carry
</I>&gt;<i> &gt; &gt; any special meaning as far as Squid code is concerned.
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; However, it is very unusual to run a plain HTTP forward proxy on port
</I>&gt;<i> &gt; &gt; 443. That port may imply that your parent proxy is an HTTPS reverse
</I>&gt;<i> &gt; &gt; proxy. If it is, you need to use originserver flag when
</I>&gt;<i> &gt; configuring the
</I>&gt;<i> &gt; &gt; corresponding cache_peer line. You can check by sending plain CONNECT
</I>&gt;<i> &gt; &gt; requests to that upstream proxy using wget, curl, or some such. A
</I>&gt;<i> &gt; &gt; reverse HTTPS proxy would reject such requests.
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt; if the ssl_bump configuration is causing it to attempt an upstream
</I>&gt;<i> &gt; &gt; &gt; TLS connection ...
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; Bugs notwithstanding, it should not.
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt; Anything here that I'm doing obviously wrong?
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; I see no red flags relevant to your specific question.
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; Does replacing &quot;bump all&quot; with &quot;splice all&quot; fix the problem? I
</I>&gt;<i> &gt; realize
</I>&gt;<i> &gt; &gt; that you do want to bump/see the device traffic, but I wonder whether
</I>&gt;<i> &gt; &gt; the errors are not between Squid and the upstream proxy but Squid and
</I>&gt;<i> &gt; &gt; the web site. Splicing would remove those errors while still keeping
</I>&gt;<i> &gt; &gt; some SslBump code active.
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; Sharing a (pointer to compressed) libpcap packet capture and/or a
</I>&gt;<i> &gt; &gt; (pointer to compressed) ALL,9 cache.log while reproducing the problem
</I>&gt;<i> &gt; &gt; with a single transaction may help:
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; <A HREF="https://wiki.squid-cache.org/SquidFaq/BugReporting#Debugging_a_single_transaction">https://wiki.squid-cache.org/SquidFaq/BugReporting#Debugging_a_single_transaction</A>
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; Alex.
</I>&gt;<i> &gt; &gt; _______________________________________________
</I>&gt;<i> &gt; &gt; squid-users mailing list
</I>&gt;<i> &gt; &gt; <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> &gt; &gt; <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; Sent from Mailspring
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Sent from Mailspring
</I>&gt;<i>
</I>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20220309/ea6f561b/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20220309/ea6f561b/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="024634.html">[squid-users] ssl_bump with parent cache
</A></li>
	<LI>Next message (by thread): <A HREF="024636.html">[squid-users] ssl_bump with parent cache
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24635">[ date ]</a>
              <a href="thread.html#24635">[ thread ]</a>
              <a href="subject.html#24635">[ subject ]</a>
              <a href="author.html#24635">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
