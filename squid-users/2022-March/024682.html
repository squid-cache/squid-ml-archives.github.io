<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] version 5.4.1 aborts squid process (SIGABRT)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20version%205.4.1%20aborts%20squid%20process%20%28SIGABRT%29&In-Reply-To=%3C60e572fb-f308-83ad-f9f8-b07ba7a2406b%40grosbein.net%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="024681.html">
   <LINK REL="Next"  HREF="024683.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] version 5.4.1 aborts squid process (SIGABRT)</H1>
    <B>Eugene Grosbein</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20version%205.4.1%20aborts%20squid%20process%20%28SIGABRT%29&In-Reply-To=%3C60e572fb-f308-83ad-f9f8-b07ba7a2406b%40grosbein.net%3E"
       TITLE="[squid-users] version 5.4.1 aborts squid process (SIGABRT)">eugen at grosbein.net
       </A><BR>
    <I>Tue Mar 22 09:27:42 UTC 2022</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="024681.html">[squid-users] Reconfiguring Squid every few seconds
</A></li>
        <LI>Next message (by thread): <A HREF="024683.html">[squid-users] version 5.4.1 aborts squid process (SIGABRT)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24682">[ date ]</a>
              <a href="thread.html#24682">[ thread ]</a>
              <a href="subject.html#24682">[ subject ]</a>
              <a href="author.html#24682">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi!

Recently I upgraded one old squid-3.5 instance to the version 5.4.1 under FreeBSD-12.3/amd64 (64 bit)
using its Ports Collection.

Old version worked rock-stable for years but after upgrade new one crashed with a message from the kernel:

kernel: pid 43512 (squid), jid 0, uid 100: exited on signal 6 (core dumped)

Then, I rebuilt squid with debugging symbols enabled and next time it crashed
I've got nice coredump and backtrace:

(gdb) bt
#0  0x000000080175bf1a in thr_kill () from /lib/libc.so.7
#1  0x000000080175a2d4 in raise () from /lib/libc.so.7
#2  0x00000008016d2d29 in abort () from /lib/libc.so.7
#3  0x000000080174a2c1 in __assert () from /lib/libc.so.7
#4  0x00000000009c2d07 in Ip::Address::getAddrInfo (this=0x81393b7e8,
    dst=@0x7fffffffdfa0: 0x813af39d0, force=0) at Address.cc:663
#5  0x00000000009b2300 in comm_openex (sock_type=1, proto=6, addr=..., flags=1,
    note=0x84cd1b040 &quot;[fe80::30be:e84c:67b2:d2c2]&quot;) at comm.cc:347
#6  0x0000000000a060cb in Comm::ConnOpener::createFd (this=0x80d8c72d8) at ConnOpener.cc:288
#7  0x0000000000a05ca1 in Comm::ConnOpener::start (this=0x80d8c72d8) at ConnOpener.cc:261
#8  0x00000000009a2983 in NullaryMemFunT&lt;AsyncJob&gt;::doDial (this=0x80ca26ed8)
    at ../../src/base/AsyncJobCalls.h:103
#9  0x00000000009a2e6b in JobDialer&lt;AsyncJob&gt;::dial (this=0x80ca26ed8, call=...)
    at ../../src/base/AsyncJobCalls.h:175
#10 0x00000000009a2cfc in AsyncCallT&lt;NullaryMemFunT&lt;AsyncJob&gt; &gt;::fire (this=0x80ca26ea0)
    at ../../src/base/AsyncCall.h:145
#11 0x000000000099e62d in AsyncCall::make (this=0x80ca26ea0) at AsyncCall.cc:44
#12 0x000000000099f5df in AsyncCallQueue::fireNext (this=0x802280cd0) at AsyncCallQueue.cc:60
#13 0x000000000099f1cc in AsyncCallQueue::fire (this=0x802280cd0) at AsyncCallQueue.cc:43
#14 0x00000000006a0839 in EventLoop::dispatchCalls (this=0x7fffffffea90) at EventLoop.cc:144
#15 0x00000000006a0711 in EventLoop::runOnce (this=0x7fffffffea90) at EventLoop.cc:121
#16 0x00000000006a0580 in EventLoop::run (this=0x7fffffffea90) at EventLoop.cc:83
#17 0x0000000000826ed3 in SquidMain (argc=5, argv=0x7fffffffeba8) at main.cc:1716
#18 0x0000000000826155 in SquidMainSafe (argc=5, argv=0x7fffffffeba8) at main.cc:1403
#19 0x0000000000826122 in main (argc=5, argv=0x7fffffffeba8) at main.cc:1391

(gdb) frame 4
#4  0x00000000009c2d07 in Ip::Address::getAddrInfo (this=0x81393b7e8,
    dst=@0x7fffffffdfa0: 0x813af39d0, force=0) at Address.cc:663
663             IASSERT(&quot;false&quot;,false);
(gdb) l
658
659             dst-&gt;ai_addrlen = sizeof(struct sockaddr_in);
660
661             dst-&gt;ai_family = ((struct sockaddr_in*)dst-&gt;ai_addr)-&gt;sin_family;
662         } else {
663             IASSERT(&quot;false&quot;,false);
664         }
665     }
666
667     void
(gdb) p Ip::EnableIpv6
$27 = 0

It was built from source without --enable-ipv6,
also src/cf.data.pre was modified before build (by Ports building system):

&quot;::1&quot; removed from the line &quot;DEFAULT: localhost src 127.0.0.1/32 ::1&quot;
&quot;::1/128 ::/128&quot; removed from the line &quot;DEFAULT: to_localhost dst 127.0.0.0/8 0.0.0.0/32 ::1/128 ::/128&quot;
&quot;2001:DB8::2&quot; removed from the line &quot;acl htcp_clr_peer src 192.0.2.2 2001:DB8::2&quot;
&quot;2001:DB8::a:0/64&quot; removed from the line &quot;acl localclients src 192.0.2.0/24 2001:DB8::a:0/64&quot;

Also, the following lines removed completely:

acl localnet src fc00::/7              # RFC 4193 local private network range
acl localnet src fe80::/10             # RFC 4291 link-local (directly plugged) machines
tcp_outgoing_address 2001:db8::c001 good_service_net
tcp_outgoing_address 2001:db8::beef normal_service_net
tcp_outgoing_address 2001:db8::1

The system is not configured for IPv6 ether, as it runs inside private IPv4-only network behind NAT box
that has no IPv6 connectivity, too. The system has no IPv6 addresses configured on its network interfaces
except of loopback &quot;inet6 fe80::1%lo0 prefixlen 64 scopeid 0x3&quot; on the interface lo0.

So, the function comm_openex() calls addr.getAddrInfo(AI) with default value of force argument:
<A HREF="https://github.com/squid-cache/squid/blame/master/src/comm.cc#L345">https://github.com/squid-cache/squid/blame/master/src/comm.cc#L345</A>

EnableIpv6 is zero, therefore Ip::Address::getAddrInfo() crashes squid:
<A HREF="https://github.com/squid-cache/squid/blame/master/src/ip/Address.cc#L663">https://github.com/squid-cache/squid/blame/master/src/ip/Address.cc#L663</A>

Looks like a bug in the Ip::Address::getAddrInfo(), does it?

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="024681.html">[squid-users] Reconfiguring Squid every few seconds
</A></li>
	<LI>Next message (by thread): <A HREF="024683.html">[squid-users] version 5.4.1 aborts squid process (SIGABRT)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24682">[ date ]</a>
              <a href="thread.html#24682">[ thread ]</a>
              <a href="subject.html#24682">[ subject ]</a>
              <a href="author.html#24682">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
