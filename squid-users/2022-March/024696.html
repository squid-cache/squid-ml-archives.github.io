<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] acl aclname server_cert_fingerprint
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20acl%20aclname%20server_cert_fingerprint&In-Reply-To=%3C21166f34-666b-3a69-f069-2b10732b7087%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="024692.html">
   <LINK REL="Next"  HREF="024693.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] acl aclname server_cert_fingerprint</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20acl%20aclname%20server_cert_fingerprint&In-Reply-To=%3C21166f34-666b-3a69-f069-2b10732b7087%40measurement-factory.com%3E"
       TITLE="[squid-users] acl aclname server_cert_fingerprint">rousskov at measurement-factory.com
       </A><BR>
    <I>Wed Mar 30 14:26:56 UTC 2022</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="024692.html">[squid-users] acl aclname server_cert_fingerprint
</A></li>
        <LI>Next message (by thread): <A HREF="024693.html">[squid-users] Are there centos 7 rpm's on ARM of squid 4 or 5?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24696">[ date ]</a>
              <a href="thread.html#24696">[ thread ]</a>
              <a href="subject.html#24696">[ subject ]</a>
              <a href="author.html#24696">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 3/30/22 03:27, Eliezer Croitoru wrote:
&gt;<i> So just to illustrate the usage of :
</I>&gt;<i> server_cert_fingerprint
</I>&gt;<i> 
</I>&gt;<i> What this acl purpose is? Can it be documented?
</I>
Please see squid.conf.documented for the best available answers to those 
two questions. If something is not clear in that documentation, please 
ask more specific questions. If my answers clarified something for you, 
consider submitting a pull request that improves existing documentation.


&gt;<i> Is it possible today to decide whether to bump or not a connection
</I>&gt;<i> based on some part of the certificate, else then the sni or domain?
</I>
Yes, to a certain extent: After Squid saw the server certificate, it is 
too late to make a bump-vs-splice decision, but it is still possible to 
make a decision to either continue with the previously implicitly 
decided action (bump or splice, depending on whether step2 action was 
stare or peek) or close the TCP connections (i.e. apply the &quot;terminate&quot; 
action).

In other words, after seeing the server certificate, Squid can make a 
continue-vs-terminate decision but not a splice-vs-bump decision.

This is how TLS works. The only known alternative is to use a second, 
&quot;probing&quot; TLS connection to the origin server. Squid does not support 
that alternative natively yet, but there is a constant trickle of 
requests for that feature, especially given TLS v1.3 encryption of 
certificates that effectively places them outside the peek/stare actions 
reach.


&gt;<i> Also, can a tag be sent back from a sslcrtd_program??
</I>
IIRC, not yet, but we are working on adding that functionality to the 
sslcrtvalidator_program. If extending that addition to both programs is 
easy, we will do that.


HTH,

Alex.



&gt;<i> -----Original Message-----
</I>&gt;<i> From: Alex Rousskov &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt;
</I>&gt;<i> Sent: Wednesday, January 27, 2021 22:07
</I>&gt;<i> To: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> Cc: Eliezer Croitoru &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">ngtech1ltd at gmail.com</A>&gt;
</I>&gt;<i> Subject: Re: [squid-users] acl aclname server_cert_fingerprint
</I>&gt;<i> 
</I>&gt;<i> On 1/27/21 1:50 PM, Eliezer Croitoru wrote:
</I>&gt;<i> 
</I>&gt;&gt;<i> I am still missing a way to make this work with the fingerprint.
</I>&gt;<i> 
</I>&gt;<i> I do not know what you are trying to accomplish (i.e. what &quot;this&quot; is).
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> We first need to know the fingerprint but when squid &quot;knows&quot; about
</I>&gt;&gt;<i> it, it's already too late. In what config scenario can it work?
</I>&gt;<i> 
</I>&gt;<i> Knowing the fingerprint (or any other server-sent detail!) is indeed not
</I>&gt;<i> useful for making bump-vs-splice decisions. Fingerprint knowledge can be
</I>&gt;<i> useful for many other decisions, including whether to allow an HTTP
</I>&gt;<i> request, whether to cache an HTTP response, and whether to terminate a
</I>&gt;<i> TLS connection.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> HTH,
</I>&gt;<i> 
</I>&gt;<i> Alex.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> -----Original Message-----
</I>&gt;&gt;<i> From: Alex Rousskov &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt;
</I>&gt;&gt;<i> Sent: Wednesday, January 27, 2021 8:43 PM
</I>&gt;&gt;<i> To: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;&gt;<i> Cc: Eliezer Croitoru &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">ngtech1ltd at gmail.com</A>&gt;
</I>&gt;&gt;<i> Subject: Re: [squid-users] acl aclname server_cert_fingerprint
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> On 1/27/21 11:45 AM, Eliezer Croitoru wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> I'm not sure I understood hat these errorcde and error detai.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> FWIW, access log fields are configured using logformat %codes. Search
</I>&gt;&gt;<i> squid.conf.documented for the words &quot;err_code&quot; and &quot;err_detail&quot; (no quotes).
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> acl tls_to_splice any-of ... NoBump_certificate_fingerprint
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> acl tls_s1_connect at_step SslBump1
</I>&gt;&gt;&gt;<i> acl tls_s2_client_hello at_step SslBump2
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> ssl_bump peek tls_s1_connect
</I>&gt;&gt;&gt;<i> ssl_bump splice tls_to_splice
</I>&gt;&gt;&gt;<i> ssl_bump stare tls_s2_client_hello
</I>&gt;&gt;&gt;<i> ssl_bump bump tls_to_bump
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Bugs notwithstanding, the NoBump_certificate_fingerprint ACL will never
</I>&gt;&gt;<i> match in the above configuration AFAICT:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> * step1 is excluded by the earlier &quot;peek if tls_s1_connect&quot; rule. The
</I>&gt;&gt;<i> server certificate is not yet available during that step anyway.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> * step2 is reachable for a &quot;splice&quot; action, but the server certificate
</I>&gt;&gt;<i> is still not yet available during that step.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> * step3 is unreachable for a &quot;splice&quot; action because the only non-final
</I>&gt;&gt;<i> action during step2 is &quot;stare&quot;. Starting precludes splicing.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> HTH,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Alex.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> -----Original Message-----
</I>&gt;&gt;&gt;<i> From: Alex Rousskov &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt;
</I>&gt;&gt;&gt;<i> Sent: Wednesday, January 27, 2021 5:12 PM
</I>&gt;&gt;&gt;<i> To: Eliezer Croitoru &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">ngtech1ltd at gmail.com</A>&gt;; <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;&gt;&gt;<i> Subject: Re: [squid-users] acl aclname server_cert_fingerprint
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> On 1/26/21 2:09 AM, Eliezer Croitoru wrote:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> I'm trying to understand what I'm doing wrong in the config that stil
</I>&gt;&gt;&gt;&gt;<i> lets edition.cnn.com be decrypted instead of spliced?
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> If you still need help, please share the relevant parts of your
</I>&gt;&gt;&gt;<i> configuration and logs. I would start with ssl_bump rules and access log
</I>&gt;&gt;&gt;<i> records containing additional %error_code/%err_detail fields.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Alex.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> -----Original Message-----
</I>&gt;&gt;&gt;&gt;<i> From: Alex Rousskov &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt;
</I>&gt;&gt;&gt;&gt;<i> Sent: Tuesday, January 26, 2021 6:22 AM
</I>&gt;&gt;&gt;&gt;<i> To: Eliezer Croitoru &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">ngtech1ltd at gmail.com</A>&gt;; <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;&gt;&gt;&gt;<i> Subject: Re: [squid-users] acl aclname server_cert_fingerprint
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> On 1/25/21 6:03 AM, Eliezer Croitoru wrote:
</I>&gt;&gt;&gt;&gt;&gt;<i> I'm trying to use:
</I>&gt;&gt;&gt;&gt;&gt;<i> acl aclname server_cert_fingerprint [-sha1] fingerprint
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> I have cerated the next file:
</I>&gt;&gt;&gt;&gt;&gt;<i> /etc/squid/no-ssl-bump-server-fingerprint.list
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> And trying to use the next line:
</I>&gt;&gt;&gt;&gt;&gt;<i> acl NoBump_certificate_fingerprint server_cert_fingerprint -sha1
</I>&gt;&gt;&gt;&gt;&gt;<i> &quot;/etc/squid/no-ssl-bump-server-fingerprint.list&quot;
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> To be explicit despite that only sha1 is a valid checksum.
</I>&gt;&gt;&gt;&gt;&gt;<i> Squid doesn't accept the above line
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> Does not accept how? What is the error message?
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> but this one yes:
</I>&gt;&gt;&gt;&gt;&gt;<i> acl NoBump_certificate_fingerprint server_cert_fingerprint
</I>&gt;&gt;&gt;&gt;&gt;<i> &quot;/etc/squid/no-ssl-bump-server-fingerprint.list&quot;
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> Is there a reason for that?
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> The use of ACL options and ACL parameter options is poorly documented.
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> Squid Bug 4847 is marked as fixed, but the corresponding commit d4c6aca
</I>&gt;&gt;&gt;&gt;<i> says that server_cert_fingerprint is still broken. Not sure whether that
</I>&gt;&gt;&gt;&gt;<i> was true, whether some other commit has fixed that ACL, and whether the
</I>&gt;&gt;&gt;&gt;<i> problem mentioned in the commit message is related to your troubles.
</I>&gt;&gt;&gt;&gt;<i> <A HREF="https://bugs.squid-cache.org/show_bug.cgi?id=4847">https://bugs.squid-cache.org/show_bug.cgi?id=4847</A>
</I>&gt;&gt;&gt;&gt;<i> <A HREF="https://github.com/squid-cache/squid/pull/191">https://github.com/squid-cache/squid/pull/191</A>
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> Also, according to my 2015 notes, server_cert_fingerprint happens to be
</I>&gt;&gt;&gt;&gt;<i> case sensitive. I consider that a bug. I am not sure, but I think Squid
</I>&gt;&gt;&gt;&gt;<i> expects uppercase hex letters (if any). I do not know whether that has
</I>&gt;&gt;&gt;&gt;<i> been fixed.
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> Finally, it is dangerous to list ACL parameter options like -sha1 in
</I>&gt;&gt;&gt;&gt;<i> front of parameter filename when that parameter file may contain its own
</I>&gt;&gt;&gt;&gt;<i> parameter options. A reader may think that -sha1 in squid.conf
</I>&gt;&gt;&gt;&gt;<i> overwrites, say, -sha256 in the parameter file, but that is not what
</I>&gt;&gt;&gt;&gt;<i> probably will happen when Squid starts supporting both options.
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> That consideration may actually be the reason why Squid rejects your
</I>&gt;&gt;&gt;&gt;<i> first configuration sample (or perhaps it should be the reason even if
</I>&gt;&gt;&gt;&gt;<i> it does not).
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> I am sure there are use cases where the admin wants to apply one
</I>&gt;&gt;&gt;&gt;<i> parameter option to the whole file, but the ambiguity is too dangerous
</I>&gt;&gt;&gt;&gt;<i> to allow IMO. We should make the choice explicit.
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> HTH,
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> Alex.
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;&gt;&gt;<i> squid-users mailing list
</I>&gt;&gt;&gt;&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;&gt;&gt;&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;&gt;&gt;&gt;<i>
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="024692.html">[squid-users] acl aclname server_cert_fingerprint
</A></li>
	<LI>Next message (by thread): <A HREF="024693.html">[squid-users] Are there centos 7 rpm's on ARM of squid 4 or 5?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24696">[ date ]</a>
              <a href="thread.html#24696">[ thread ]</a>
              <a href="subject.html#24696">[ subject ]</a>
              <a href="author.html#24696">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
