<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid CONNECT tunnel
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20CONNECT%20tunnel&In-Reply-To=%3C10874a92-369f-df49-c080-1cb0afd53c7f%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="024769.html">
   <LINK REL="Next"  HREF="024771.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid CONNECT tunnel</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20CONNECT%20tunnel&In-Reply-To=%3C10874a92-369f-df49-c080-1cb0afd53c7f%40measurement-factory.com%3E"
       TITLE="[squid-users] Squid CONNECT tunnel">rousskov at measurement-factory.com
       </A><BR>
    <I>Wed May  4 16:47:03 UTC 2022</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="024769.html">[squid-users] Squid CONNECT tunnel
</A></li>
        <LI>Next message (by thread): <A HREF="024771.html">[squid-users] acl question
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24770">[ date ]</a>
              <a href="thread.html#24770">[ thread ]</a>
              <a href="subject.html#24770">[ subject ]</a>
              <a href="author.html#24770">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 5/4/22 12:30, roee klinger wrote:

&gt;<i> Basically, I need to set up a cache_peer, and have all traffic to it be 
</I>&gt;<i> sent using CONNECT, and add an&#160;HTTP CONNECT header such as:
</I>&gt;<i> CONNECT test1 HTTP/1.1\r\n\r\n .
</I>
&gt;<i> Is that possible with Squid?
</I>
Squid can be configured to forward all http_port and https_port traffic 
to a cache_peer. The same may be true for ftp_port, but I am not sure.

However, Squid cannot be configured to forward &quot;all traffic&quot; (i.e. all 
protocols and all protocol commands) using the CONNECT request method 
specifically. For example, plain HTTP GET requests received on an 
http_port will be forwarded using the GET method, not CONNECT.

Furthermore, it would be difficult (and probably wrong) to rewrite the 
destination of all requests to &quot;test1&quot;. In most cases, a request going 
to origin server A should look different than a request going to origin 
server B. However, I am not sure whether &quot;test1&quot; in your template was a 
constant that should not be changed across requests.

Finally, I doubt that you actually need to forward _all_ traffic using 
CONNECT tunnels. You probably need to forward some specific requests. 
For that (unknown to me) subset of requests, Squid may (or may not) use 
CONNECT when talking to a configured cache_peer.

Alex.


&gt;<i> On 3 May 2022, 16:30 +0300, Alex Rousskov wrote:
</I>&gt;&gt;<i> On 5/3/22 06:12, roee klinger wrote:
</I>&gt;&gt;&gt;<i> Hey,
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> I am trying to use Squid with FTP server TCP Port Multiplexing, on the
</I>&gt;&gt;&gt;<i> FRP documentation (<A HREF="https://github.com/fatedier/frp#tcp-port-multiplexing">https://github.com/fatedier/frp#tcp-port-multiplexing</A>
</I>&gt;&gt;&gt;<i> &lt;<A HREF="https://github.com/fatedier/frp#tcp-port-multiplexing">https://github.com/fatedier/frp#tcp-port-multiplexing</A>&gt;), it says:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> frp supports receiving TCP sockets directed to different proxies on
</I>&gt;&gt;&gt;<i> a single port on frps, similar to vhost_http_port and vhost_https_port.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> The only supported TCP port multiplexing method available at the
</I>&gt;&gt;&gt;<i> moment is httpconnect - HTTP CONNECT tunnel.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> When setting tcpmux_httpconnect_port to anything other than 0 in
</I>&gt;&gt;&gt;<i> frps under [common], frps will listen on this port for HTTP CONNECT
</I>&gt;&gt;&gt;<i> requests.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> The host of the HTTP CONNECT request will be used to match the proxy
</I>&gt;&gt;&gt;<i> in frps. Proxy hosts can be configured in frpc by configuring
</I>&gt;&gt;&gt;<i> custom_domain and / or subdomain under type = tcpmux proxies, when
</I>&gt;&gt;&gt;<i> multiplexer = httpconnect.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> In the above configuration - frps can be contacted on port 1337 with
</I>&gt;&gt;&gt;<i> a HTTP CONNECT header such as:
</I>&gt;&gt;&gt;<i> CONNECT test1 HTTP/1.1\r\n\r\n
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> and the connection will be routed to proxy1.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> I have been struggling to find info about the use of CONNECT tunnels in
</I>&gt;&gt;&gt;<i> Squid, the only page that seems to be talking about it is this:
</I>&gt;&gt;&gt;<i> <A HREF="https://wiki.squid-cache.org/Features/HTTPS">https://wiki.squid-cache.org/Features/HTTPS</A>
</I>&gt;&gt;&gt;<i> &lt;<A HREF="https://wiki.squid-cache.org/Features/HTTPS">https://wiki.squid-cache.org/Features/HTTPS</A>&gt;, and the link it points to
</I>&gt;&gt;&gt;<i> is broken.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> My question is, how can I use this with Squid? Can I configure Squid to
</I>&gt;&gt;&gt;<i> receive traffic and then send it out to FRP with a custom CONNECT header?
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> I am not sure if this is only good for web servers, or if upstream proxy
</I>&gt;&gt;&gt;<i> servers can use this method too.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> CONNECT is usually used for opening TCP tunnels through HTTP proxies.
</I>&gt;&gt;<i> Squid uses CONNECT (only) when the HTTP protocol requires such use:
</I>&gt;&gt;<i> Squid will send a CONNECT request if you configure Squid to talk to a
</I>&gt;&gt;<i> configured cache_peer (without an originserver flag), provided Squid
</I>&gt;&gt;<i> needs to open a TCP tunnel through that cache_peer.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Squid uses TCP tunnels in several cases. The most common use case is
</I>&gt;&gt;<i> when Squid is forwarding a received CONNECT request (or an intercepted
</I>&gt;&gt;<i> TLS connection) through a cache_peer.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I have not studied FRP documentation and do not know how it all maps to
</I>&gt;&gt;<i> your specific use case, but if you can summarize your use case in basic
</I>&gt;&gt;<i> FTP/HTTP/TLS terms (e.g. Squid receives FTP request X and should send
</I>&gt;&gt;<i> HTTP request Y), we may be able to help you with Squid configuration.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Alex.
</I>&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;<i> squid-users mailing list
</I>&gt;&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="024769.html">[squid-users] Squid CONNECT tunnel
</A></li>
	<LI>Next message (by thread): <A HREF="024771.html">[squid-users] acl question
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24770">[ date ]</a>
              <a href="thread.html#24770">[ thread ]</a>
              <a href="subject.html#24770">[ subject ]</a>
              <a href="author.html#24770">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
