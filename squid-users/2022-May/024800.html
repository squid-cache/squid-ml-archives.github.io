<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Scaling concurrent TCP sessions beyond ephemeral port range
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Scaling%20concurrent%20TCP%20sessions%20beyond%20ephemeral%20port%0A%20range&In-Reply-To=%3CCACabJxP86UGm_dm%2BPbyckMWoxiis2fc87jwyQq%2BuXHXAKm%3DAfA%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="024812.html">
   <LINK REL="Next"  HREF="024801.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Scaling concurrent TCP sessions beyond ephemeral port range</H1>
    <B>Praveen Ponakanti</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Scaling%20concurrent%20TCP%20sessions%20beyond%20ephemeral%20port%0A%20range&In-Reply-To=%3CCACabJxP86UGm_dm%2BPbyckMWoxiis2fc87jwyQq%2BuXHXAKm%3DAfA%40mail.gmail.com%3E"
       TITLE="[squid-users] Scaling concurrent TCP sessions beyond ephemeral port range">pponakanti at roblox.com
       </A><BR>
    <I>Fri May 20 00:22:06 UTC 2022</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="024812.html">[squid-users] Put URLs and URL regex in one text file
</A></li>
        <LI>Next message (by thread): <A HREF="024801.html">[squid-users] Scaling concurrent TCP sessions beyond ephemeral port range
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24800">[ date ]</a>
              <a href="thread.html#24800">[ thread ]</a>
              <a href="subject.html#24800">[ subject ]</a>
              <a href="author.html#24800">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,


Does anyone have recommendations on scaling concurrent connections through
the squid proxy to above the ephemeral port range?


I have squid v5.5 on Ubuntu with about 48K ephemeral ports available with
the ip_local_port_range. The squid is bound to listen on port 3128 and has
a single tcp_outgoing_address configured. We notice that after about 40-45k
concurrent connections through the proxy it is unable to reuse ports and it
severely limits local ports available to other applications running on the
system. The squid is setup to run 30 workers; total CPU is still under 10%
during peak connection rates.


Is any build config flag required to enable SO_REUSEPORT or SO_REUSEADDR on
the outbound TCP sessions opened by squid?

It does not appear that there is an option to use the
IP_BIND_ADDRESS_NO_PORT sockopt flag which can help with ephemeral port
reuse.



We have tried enabling tcp_tw_reuse, ip_autobind_reuse and ip_nonlocal_bind
flags, but unable to get the system reuse the ephemeral ports. The
fs.file-max is set to 4M. Pasted some errors below. Any suggestions are
appreciated!


Thanks

Praveen



2022/05/19 23:35:00 kid12| commBind Cannot bind socket FD 3075 to &lt;*IP*&gt;:
(99) Cannot assign requested address

    current master transaction: master48536607

2022/05/19 23:35:00 kid23| commBind Cannot bind socket FD 1320 to &lt;*IP*&gt;:
(99) Cannot assign requested address

    current master transaction: master26662366


2022/05/19 23:37:30 kid13| commBind Cannot bind socket FD 3346 to &lt;*IP*&gt;:
(98) Address already in use

    current master transaction: master11976056

2022/05/19 23:37:30 kid12| commBind Cannot bind socket FD 6459 to &lt;*IP*&gt;:
(98) Address already in use

    current master transaction: master48561031


While the system is in this state, local curl&#8217;s to another endpoint on the
same node are not able to obtain a TCP socket.


curl: (7) Couldn't connect to server
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20220519/e79b5df5/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20220519/e79b5df5/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="024812.html">[squid-users] Put URLs and URL regex in one text file
</A></li>
	<LI>Next message (by thread): <A HREF="024801.html">[squid-users] Scaling concurrent TCP sessions beyond ephemeral port range
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24800">[ date ]</a>
              <a href="thread.html#24800">[ thread ]</a>
              <a href="subject.html#24800">[ subject ]</a>
              <a href="author.html#24800">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
