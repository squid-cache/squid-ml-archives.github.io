<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Scaling concurrent TCP sessions beyond ephemeral port range
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Scaling%20concurrent%20TCP%20sessions%20beyond%20ephemeral%0A%20port%20range&In-Reply-To=%3Cf7f62043-e384-0395-6d0f-ff4d510b0baf%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="024800.html">
   <LINK REL="Next"  HREF="024802.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Scaling concurrent TCP sessions beyond ephemeral port range</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Scaling%20concurrent%20TCP%20sessions%20beyond%20ephemeral%0A%20port%20range&In-Reply-To=%3Cf7f62043-e384-0395-6d0f-ff4d510b0baf%40measurement-factory.com%3E"
       TITLE="[squid-users] Scaling concurrent TCP sessions beyond ephemeral port range">rousskov at measurement-factory.com
       </A><BR>
    <I>Fri May 20 02:18:38 UTC 2022</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="024800.html">[squid-users] Scaling concurrent TCP sessions beyond ephemeral port range
</A></li>
        <LI>Next message (by thread): <A HREF="024802.html">[squid-users] Scaling concurrent TCP sessions beyond ephemeral port range
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24801">[ date ]</a>
              <a href="thread.html#24801">[ thread ]</a>
              <a href="subject.html#24801">[ subject ]</a>
              <a href="author.html#24801">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 5/19/22 20:22, Praveen Ponakanti wrote:

&gt;<i> Does anyone have recommendations on scaling concurrent connections 
</I>&gt;<i> through the squid proxy to above the ephemeral port range?
</I>
I know of several solutions, but not all of them are probably applicable 
to your specific situation:

1. Decrease the amount of time closed TCP connections occupy the port. 
For example, if you have many connections in TIME_WAIT state, and can 
afford to lower that state duration, it may help free ports faster.

2. If outgoing connections are closed faster (i.e. after fewer requests) 
than they should be, then fix that problem to increase connection reuse 
(and, hence, decrease port pressure). This solution is usually 
applicable to environments where you control both ends of the connection 
and see some premature closures.

3. Use more outgoing IP addresses. Without modifications, Squid would 
not automatically pick the next outgoing IP address after using up most 
of the ports on the previous one, but perhaps the OS would do the right 
thing _for_ Squid? Not sure. You can use tcp_outgoing_address with 
random ACLs to force-spread the load across multiple IPs (and, hence, 
multiple port banks). This does not work if you must use a single 
outgoing IP for some reason.

4. Modify Squid to retry port binding errors. This is easy to do but 
(without #5 below) it will not help much once ephemeral ports become 
scarce (in my experience; I have not checked what the latest kernels are 
capable of in this area).

5. If you need, say, 20-30% more concurrency (rather than 100+%) and 
cannot use multiple outbound IP addresses, then would be possible to 
modify Squid to implement a manual port allocation algorithm that 
usually works a lot more reliable under load than ephemeral ports 
administered by the OS (last time I checked, which was a few years ago). 
You will still be bound by the TCP limit of 64K ports (minus whatever 
you want to leave for other applications that open outgoing connections) 
and various TCP-level timeouts, of course, but the number of cases where 
Squid cannot open a port because of OS port mismanagement will go down.

FWIW, we successfully use solutions 3, 4, and 5 in Web Polygraph 
benchmark (that can be configured to create lots of outgoing connections).


&gt;<i> I have squid v5.5 on Ubuntu with about 48K ephemeral ports available 
</I>&gt;<i> with the ip_local_port_range. The squid is bound to listen on port 3128 
</I>&gt;<i> and has a single tcp_outgoing_address configured. We notice that after 
</I>&gt;<i> about 40-45k concurrent connections through the proxy it&#160;is unable to 
</I>&gt;<i> reuse ports and it severely limits local ports available to other 
</I>&gt;<i> applications running on the system. The squid is setup to run 30 
</I>&gt;<i> workers; total CPU is still under 10% during peak connection rates.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Is any build config flag required to enable SO_REUSEPORT or SO_REUSEADDR 
</I>&gt;<i> on the outbound TCP sessions opened by squid?
</I>
Squid can be configured to use SO_REUSEPORT on _incoming_ connections 
(see *_port worker-queues), but that is not what you are asking about. 
Outside of that worker-queues feature, Squid will not set SO_REUSEPORT 
AFAICT.

Squid does set SO_REUSEADDR unless you use the -R command line option 
AFAICT.


&gt;<i> It does not appear that there is an option to use the 
</I>&gt;<i> IP_BIND_ADDRESS_NO_PORT sockopt flag which can help with ephemeral port 
</I>&gt;<i> reuse.
</I>
No.


&gt;<i> We have tried enabling tcp_tw_reuse, ip_autobind_reuse and 
</I>&gt;<i> ip_nonlocal_bind flags, but unable to get the system reuse the ephemeral 
</I>&gt;<i> ports. The fs.file-max is set to 4M. Pasted some errors below. Any 
</I>&gt;<i> suggestions are appreciated!
</I>

HTH,

Alex.



&gt;<i> 2022/05/19 23:35:00 kid12| commBind Cannot bind socket FD 3075 to 
</I>&gt;<i> &lt;/IP/&gt;: (99) Cannot assign requested address
</I>&gt;<i> 
</I>&gt;<i> current master transaction: master48536607
</I>&gt;<i> 
</I>&gt;<i> 2022/05/19 23:35:00 kid23| commBind Cannot bind socket FD 1320 to 
</I>&gt;<i> &lt;/IP/&gt;: (99) Cannot assign requested address
</I>&gt;<i> 
</I>&gt;<i> current master transaction: master26662366
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 2022/05/19 23:37:30 kid13| commBind Cannot bind socket FD 3346 to 
</I>&gt;<i> &lt;/IP/&gt;: (98) Address already in use
</I>&gt;<i> 
</I>&gt;<i> current master transaction: master11976056
</I>&gt;<i> 
</I>&gt;<i> 2022/05/19 23:37:30 kid12| commBind Cannot bind socket FD 6459 to 
</I>&gt;<i> &lt;/IP/&gt;: (98) Address already in use
</I>&gt;<i> 
</I>&gt;<i> current master transaction: master48561031
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> While the system is in this state, local curl&#8217;s to another endpoint on 
</I>&gt;<i> the same node are not able to obtain a TCP socket.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> curl: (7) Couldn't connect to server
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="024800.html">[squid-users] Scaling concurrent TCP sessions beyond ephemeral port range
</A></li>
	<LI>Next message (by thread): <A HREF="024802.html">[squid-users] Scaling concurrent TCP sessions beyond ephemeral port range
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24801">[ date ]</a>
              <a href="thread.html#24801">[ thread ]</a>
              <a href="subject.html#24801">[ subject ]</a>
              <a href="author.html#24801">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
