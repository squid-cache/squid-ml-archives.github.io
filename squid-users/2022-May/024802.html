<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Scaling concurrent TCP sessions beyond ephemeral port range
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Scaling%20concurrent%20TCP%20sessions%20beyond%20ephemeral%0A%20port%20range&In-Reply-To=%3CCACabJxNv5%2Bo7AiY-tfuJ%3D_V4ZBNEks%3DdX4ki2YQBHcPPpUrABg%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="024801.html">
   <LINK REL="Next"  HREF="024809.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Scaling concurrent TCP sessions beyond ephemeral port range</H1>
    <B>Praveen Ponakanti</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Scaling%20concurrent%20TCP%20sessions%20beyond%20ephemeral%0A%20port%20range&In-Reply-To=%3CCACabJxNv5%2Bo7AiY-tfuJ%3D_V4ZBNEks%3DdX4ki2YQBHcPPpUrABg%40mail.gmail.com%3E"
       TITLE="[squid-users] Scaling concurrent TCP sessions beyond ephemeral port range">pponakanti at roblox.com
       </A><BR>
    <I>Fri May 20 07:44:28 UTC 2022</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="024801.html">[squid-users] Scaling concurrent TCP sessions beyond ephemeral port range
</A></li>
        <LI>Next message (by thread): <A HREF="024809.html">[squid-users] Scaling concurrent TCP sessions beyond ephemeral port range
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24802">[ date ]</a>
              <a href="thread.html#24802">[ thread ]</a>
              <a href="subject.html#24802">[ subject ]</a>
              <a href="author.html#24802">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Alex,

Thanks for going through several steps to help mitigate src port
exhaustion. We are looking to achieve 400-500% more concurrent connections
if we could :) as there is a significant buffer on the available CPU.
The option to use multiple tcp_outoing_addresses appears to be promising
along with some tweaks to the TCP timeouts. I guess we could use ACLs to
pick a different outbound IP based on the requesting client's prefix. We
had not considered that option as the ephemeral ports were no longer
available to other applications when squid uses most of them with a single
outbound IP configured. We are also looking to modify the code to use the
IP_BIND_ADDRESS_NO_PORT sockopt as that could help delay port assignment
with the bind() call on the outbound TCP sessions (to hopefully allow
access to the 4-tuple on the socket).
Thanks
Praveen


On Thu, May 19, 2022 at 7:18 PM Alex Rousskov &lt;
<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt; wrote:

&gt;<i> On 5/19/22 20:22, Praveen Ponakanti wrote:
</I>&gt;<i>
</I>&gt;<i> &gt; Does anyone have recommendations on scaling concurrent connections
</I>&gt;<i> &gt; through the squid proxy to above the ephemeral port range?
</I>&gt;<i>
</I>&gt;<i> I know of several solutions, but not all of them are probably applicable
</I>&gt;<i> to your specific situation:
</I>&gt;<i>
</I>&gt;<i> 1. Decrease the amount of time closed TCP connections occupy the port.
</I>&gt;<i> For example, if you have many connections in TIME_WAIT state, and can
</I>&gt;<i> afford to lower that state duration, it may help free ports faster.
</I>&gt;<i>
</I>&gt;<i> 2. If outgoing connections are closed faster (i.e. after fewer requests)
</I>&gt;<i> than they should be, then fix that problem to increase connection reuse
</I>&gt;<i> (and, hence, decrease port pressure). This solution is usually
</I>&gt;<i> applicable to environments where you control both ends of the connection
</I>&gt;<i> and see some premature closures.
</I>&gt;<i>
</I>&gt;<i> 3. Use more outgoing IP addresses. Without modifications, Squid would
</I>&gt;<i> not automatically pick the next outgoing IP address after using up most
</I>&gt;<i> of the ports on the previous one, but perhaps the OS would do the right
</I>&gt;<i> thing _for_ Squid? Not sure. You can use tcp_outgoing_address with
</I>&gt;<i> random ACLs to force-spread the load across multiple IPs (and, hence,
</I>&gt;<i> multiple port banks). This does not work if you must use a single
</I>&gt;<i> outgoing IP for some reason.
</I>&gt;<i>
</I>&gt;<i> 4. Modify Squid to retry port binding errors. This is easy to do but
</I>&gt;<i> (without #5 below) it will not help much once ephemeral ports become
</I>&gt;<i> scarce (in my experience; I have not checked what the latest kernels are
</I>&gt;<i> capable of in this area).
</I>&gt;<i>
</I>&gt;<i> 5. If you need, say, 20-30% more concurrency (rather than 100+%) and
</I>&gt;<i> cannot use multiple outbound IP addresses, then would be possible to
</I>&gt;<i> modify Squid to implement a manual port allocation algorithm that
</I>&gt;<i> usually works a lot more reliable under load than ephemeral ports
</I>&gt;<i> administered by the OS (last time I checked, which was a few years ago).
</I>&gt;<i> You will still be bound by the TCP limit of 64K ports (minus whatever
</I>&gt;<i> you want to leave for other applications that open outgoing connections)
</I>&gt;<i> and various TCP-level timeouts, of course, but the number of cases where
</I>&gt;<i> Squid cannot open a port because of OS port mismanagement will go down.
</I>&gt;<i>
</I>&gt;<i> FWIW, we successfully use solutions 3, 4, and 5 in Web Polygraph
</I>&gt;<i> benchmark (that can be configured to create lots of outgoing connections).
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; I have squid v5.5 on Ubuntu with about 48K ephemeral ports available
</I>&gt;<i> &gt; with the ip_local_port_range. The squid is bound to listen on port 3128
</I>&gt;<i> &gt; and has a single tcp_outgoing_address configured. We notice that after
</I>&gt;<i> &gt; about 40-45k concurrent connections through the proxy it is unable to
</I>&gt;<i> &gt; reuse ports and it severely limits local ports available to other
</I>&gt;<i> &gt; applications running on the system. The squid is setup to run 30
</I>&gt;<i> &gt; workers; total CPU is still under 10% during peak connection rates.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Is any build config flag required to enable SO_REUSEPORT or SO_REUSEADDR
</I>&gt;<i> &gt; on the outbound TCP sessions opened by squid?
</I>&gt;<i>
</I>&gt;<i> Squid can be configured to use SO_REUSEPORT on _incoming_ connections
</I>&gt;<i> (see *_port worker-queues), but that is not what you are asking about.
</I>&gt;<i> Outside of that worker-queues feature, Squid will not set SO_REUSEPORT
</I>&gt;<i> AFAICT.
</I>&gt;<i>
</I>&gt;<i> Squid does set SO_REUSEADDR unless you use the -R command line option
</I>&gt;<i> AFAICT.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; It does not appear that there is an option to use the
</I>&gt;<i> &gt; IP_BIND_ADDRESS_NO_PORT sockopt flag which can help with ephemeral port
</I>&gt;<i> &gt; reuse.
</I>&gt;<i>
</I>&gt;<i> No.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; We have tried enabling tcp_tw_reuse, ip_autobind_reuse and
</I>&gt;<i> &gt; ip_nonlocal_bind flags, but unable to get the system reuse the ephemeral
</I>&gt;<i> &gt; ports. The fs.file-max is set to 4M. Pasted some errors below. Any
</I>&gt;<i> &gt; suggestions are appreciated!
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> HTH,
</I>&gt;<i>
</I>&gt;<i> Alex.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; 2022/05/19 23:35:00 kid12| commBind Cannot bind socket FD 3075 to
</I>&gt;<i> &gt; &lt;/IP/&gt;: (99) Cannot assign requested address
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; current master transaction: master48536607
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; 2022/05/19 23:35:00 kid23| commBind Cannot bind socket FD 1320 to
</I>&gt;<i> &gt; &lt;/IP/&gt;: (99) Cannot assign requested address
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; current master transaction: master26662366
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; 2022/05/19 23:37:30 kid13| commBind Cannot bind socket FD 3346 to
</I>&gt;<i> &gt; &lt;/IP/&gt;: (98) Address already in use
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; current master transaction: master11976056
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; 2022/05/19 23:37:30 kid12| commBind Cannot bind socket FD 6459 to
</I>&gt;<i> &gt; &lt;/IP/&gt;: (98) Address already in use
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; current master transaction: master48561031
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; While the system is in this state, local curl&#8217;s to another endpoint on
</I>&gt;<i> &gt; the same node are not able to obtain a TCP socket.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; curl: (7) Couldn't connect to server
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; _______________________________________________
</I>&gt;<i> &gt; squid-users mailing list
</I>&gt;<i> &gt; <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> &gt; <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20220520/804da239/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20220520/804da239/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="024801.html">[squid-users] Scaling concurrent TCP sessions beyond ephemeral port range
</A></li>
	<LI>Next message (by thread): <A HREF="024809.html">[squid-users] Scaling concurrent TCP sessions beyond ephemeral port range
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24802">[ date ]</a>
              <a href="thread.html#24802">[ thread ]</a>
              <a href="subject.html#24802">[ subject ]</a>
              <a href="author.html#24802">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
