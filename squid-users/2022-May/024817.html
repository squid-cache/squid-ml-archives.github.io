<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] ssl-bump connect issues
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20ssl-bump%20connect%20issues&In-Reply-To=%3Cab080f2b-b143-bf49-0969-3bafd743274e%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="024816.html">
   <LINK REL="Next"  HREF="024820.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] ssl-bump connect issues</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20ssl-bump%20connect%20issues&In-Reply-To=%3Cab080f2b-b143-bf49-0969-3bafd743274e%40treenet.co.nz%3E"
       TITLE="[squid-users] ssl-bump connect issues">squid3 at treenet.co.nz
       </A><BR>
    <I>Mon May 23 13:57:23 UTC 2022</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="024816.html">[squid-users] ssl-bump connect issues
</A></li>
        <LI>Next message (by thread): <A HREF="024820.html">[squid-users] ssl-bump connect issues
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24817">[ date ]</a>
              <a href="thread.html#24817">[ thread ]</a>
              <a href="subject.html#24817">[ subject ]</a>
              <a href="author.html#24817">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 23/05/22 17:41, Jernej Porenta wrote:
&gt;<i> 
</I>&gt;<i> The logs show that clients did issue a CONNECT, however the connections 
</I>&gt;<i> are stuck (and eventually timeout) and netstat is showing exactly 10 
</I>&gt;<i> connections in SYN_SENT state towards npm registry. I am kinda puzzled, 
</I>&gt;<i> where this number comes from.
</I>&gt;<i> 
</I>
This sounds a bit like other situations where the sslcrtd_program helper 
has hung and stopped generating certificates.



&gt;<i> Big thank you in advance, br, Jernej
</I>&gt;<i> 
</I>&gt;<i> The &quot;relevant&quot; parts of my configurations are:
</I>&gt;<i> 
</I>&gt;<i> acl intermediate_fetching transaction_initiator certificate-fetching
</I>&gt;<i> http_access allow intermediate_fetching
</I>
This is not all of the required http_access rules. Please list them all.


&gt;<i> http_port 80 ssl-bump generate-host-certificates=on 
</I>&gt;<i> dynamic_cert_mem_cache_size=20MB 
</I>&gt;<i> tls-cert=/etc/squid/certs/squid-self-signed.crt 
</I>&gt;<i> tls-key=/etc/squid/certs/squid-self-signed.key 
</I>&gt;<i> cipher=HIGH:MEDIUM:!LOW:!RC4:!SEED:!IDEA:!3DES:!MD5:!EXP:!PSK:!DSS 
</I>&gt;<i> options=NO_TLSv1,NO_SSLv3,SINGLE_DH_USE,SINGLE_ECDH_USE 
</I>&gt;<i> tls-dh=prime256v1:/etc/squid/certs/squid-self-signed_dhparam.pem 
</I>&gt;<i> disable-pmtu-discovery=transparent
</I>&gt;<i> 
</I>&gt;<i> sslcrtd_program /usr/lib/squid/security_file_certgen -s 
</I>&gt;<i> /var/spool/squid/ssl_db -M 20MB
</I>&gt;<i> sslcrtd_children 8
</I>&gt;<i> ssl_bump server-first all
</I>

This &quot;server-first&quot; action is outdated. Please upgrade. The modern 
equivalent would be:

   acl step1 at_step SslBump1
   ssl_bump peek step1
   ssl_bump bump cachedSites
   ssl_bump splice all


&gt;<i> sslproxy_cert_error deny all
</I>&gt;<i> 
</I>
This may be hiding symptoms you need to figure the problem out. It is 
best to start with everything allowed and only deny the specific errors 
that are not relevant to the client(s).


&gt;<i> 
</I>&gt;<i> # dns
</I>&gt;<i> positive_dns_ttl 31 seconds
</I>&gt;<i> negative_dns_ttl 30 seconds
</I>
These also may be the source of problems. They prevent Squid from 
obeying short-TTL on DNS responses typically used by repositories to 
load balance large amounts of traffic and/or server failure recovery.



HTH
Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="024816.html">[squid-users] ssl-bump connect issues
</A></li>
	<LI>Next message (by thread): <A HREF="024820.html">[squid-users] ssl-bump connect issues
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24817">[ date ]</a>
              <a href="thread.html#24817">[ thread ]</a>
              <a href="subject.html#24817">[ subject ]</a>
              <a href="author.html#24817">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
