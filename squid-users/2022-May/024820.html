<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] ssl-bump connect issues
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20ssl-bump%20connect%20issues&In-Reply-To=%3C58F4366A-B798-47BE-B221-39C3BEF8E2EB%403fs.si%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="024817.html">
   <LINK REL="Next"  HREF="024818.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] ssl-bump connect issues</H1>
    <B>Jernej Porenta</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20ssl-bump%20connect%20issues&In-Reply-To=%3C58F4366A-B798-47BE-B221-39C3BEF8E2EB%403fs.si%3E"
       TITLE="[squid-users] ssl-bump connect issues">jernej.porenta at 3fs.si
       </A><BR>
    <I>Tue May 24 15:05:41 UTC 2022</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="024817.html">[squid-users] ssl-bump connect issues
</A></li>
        <LI>Next message (by thread): <A HREF="024818.html">[squid-users] The usage of extended SNMPD commands to monitor squid.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24820">[ date ]</a>
              <a href="thread.html#24820">[ thread ]</a>
              <a href="subject.html#24820">[ subject ]</a>
              <a href="author.html#24820">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hey,

thank you for your response.

&gt;&gt;<i> The logs show that clients did issue a CONNECT, however the connections are stuck (and eventually timeout) and netstat is showing exactly 10 connections in SYN_SENT state towards npm registry. I am kinda puzzled, where this number comes from.
</I>&gt;<i> 
</I>&gt;<i> This sounds a bit like other situations where the sslcrtd_program helper has hung and stopped generating certificates.
</I>
I've checked that and it seems this part is working just fine.

&gt;<i> 
</I>&gt;&gt;<i> Big thank you in advance, br, Jernej
</I>&gt;&gt;<i> The &quot;relevant&quot; parts of my configurations are:
</I>&gt;&gt;<i> acl intermediate_fetching transaction_initiator certificate-fetching
</I>&gt;&gt;<i> http_access allow intermediate_fetching
</I>&gt;<i> 
</I>&gt;<i> This is not all of the required http_access rules. Please list them all.
</I>
You can check the whole configuration file here: <A HREF="https://pastebin.com/h7ryfArx">https://pastebin.com/h7ryfArx</A>

&gt;<i> 
</I>&gt;&gt;<i> http_port 80 ssl-bump generate-host-certificates=on dynamic_cert_mem_cache_size=20MB tls-cert=/etc/squid/certs/squid-self-signed.crt tls-key=/etc/squid/certs/squid-self-signed.key cipher=HIGH:MEDIUM:!LOW:!RC4:!SEED:!IDEA:!3DES:!MD5:!EXP:!PSK:!DSS options=NO_TLSv1,NO_SSLv3,SINGLE_DH_USE,SINGLE_ECDH_USE tls-dh=prime256v1:/etc/squid/certs/squid-self-signed_dhparam.pem disable-pmtu-discovery=transparent
</I>&gt;&gt;<i> sslcrtd_program /usr/lib/squid/security_file_certgen -s /var/spool/squid/ssl_db -M 20MB
</I>&gt;&gt;<i> sslcrtd_children 8
</I>&gt;&gt;<i> ssl_bump server-first all
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> This &quot;server-first&quot; action is outdated. Please upgrade. The modern equivalent would be:
</I>&gt;<i> 
</I>&gt;<i>  acl step1 at_step SslBump1
</I>&gt;<i>  ssl_bump peek step1
</I>&gt;<i>  ssl_bump bump cachedSites
</I>&gt;<i>  ssl_bump splice all
</I>
Updated it to your recommendation.

&gt;<i> 
</I>&gt;&gt;<i> sslproxy_cert_error deny all
</I>&gt;<i> 
</I>&gt;<i> This may be hiding symptoms you need to figure the problem out. It is best to start with everything allowed and only deny the specific errors that are not relevant to the client(s).
</I>
I've tried to comment it out but there was no difference.

&gt;&gt;<i> # dns
</I>&gt;&gt;<i> positive_dns_ttl 31 seconds
</I>&gt;&gt;<i> negative_dns_ttl 30 seconds
</I>&gt;<i> 
</I>&gt;<i> These also may be the source of problems. They prevent Squid from obeying short-TTL on DNS responses typically used by repositories to load balance large amounts of traffic and/or server failure recovery.
</I>
Removed.

I've ran some additional test and found out that one of the servers (which is resolved from yarnpkg.com) is not accessible and it seeems that that one is causing all the others to halt. Once the connect_timeout period is over, new batch of requests is processed without a problem.

Is there a way to disable this behaviour? (or maybe it is actually yarn's behaviour that stops requesting if registry is not available?)

Thank you in advance, br, Jernej
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="024817.html">[squid-users] ssl-bump connect issues
</A></li>
	<LI>Next message (by thread): <A HREF="024818.html">[squid-users] The usage of extended SNMPD commands to monitor squid.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#24820">[ date ]</a>
              <a href="thread.html#24820">[ thread ]</a>
              <a href="subject.html#24820">[ subject ]</a>
              <a href="author.html#24820">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
