<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Does Squid support client ssl termination?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Does%20Squid%20support%20client%20ssl%20termination%3F&In-Reply-To=%3C4857700226b1763495385cfa23f2bc78%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="025368.html">
   <LINK REL="Next"  HREF="025374.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Does Squid support client ssl termination?</H1>
    <B>squid3 at treenet.co.nz</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Does%20Squid%20support%20client%20ssl%20termination%3F&In-Reply-To=%3C4857700226b1763495385cfa23f2bc78%40treenet.co.nz%3E"
       TITLE="[squid-users] Does Squid support client ssl termination?">squid3 at treenet.co.nz
       </A><BR>
    <I>Tue Nov  1 22:17:35 UTC 2022</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="025368.html">[squid-users] Does Squid support client ssl termination?
</A></li>
        <LI>Next message (by thread): <A HREF="025374.html">[squid-users] Does Squid support client ssl termination?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25372">[ date ]</a>
              <a href="thread.html#25372">[ thread ]</a>
              <a href="subject.html#25372">[ subject ]</a>
              <a href="author.html#25372">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 2022-11-02 07:49, Grant Taylor wrote:
&gt;<i> On 11/1/22 11:33 AM, squid3 wrote:
</I>&gt;&gt;<i> That is not true as a blanket statement.
</I>&gt;<i> 
</I>&gt;<i> Please clarify which statement / who you are addressing.
</I>&gt;<i> 
</I>&gt;<i> It seems as if you're addressing mingheng (copied below for 
</I>&gt;<i> convenience):
</I>&gt;<i> 
</I>
Yes I was addressing mingheng's statement.


&gt;<i> On 10/31/22 7:32 PM, mingheng wang wrote:
</I>&gt;&gt;<i> I delved into the configuration the last few days, and found that 
</I>&gt;&gt;<i> Squid doesn't officially support cache_peer when ssl_bump is in use.
</I>&gt;<i> 
</I>&gt;<i> But you may be addressing my statement (...):
</I>&gt;<i> 
</I>&gt;<i> On 11/1/22 10:44 AM, Grant Taylor wrote:
</I>&gt;&gt;<i> That surprises me.  I wonder if it's a technical limitation or an 
</I>&gt;&gt;<i> oversight.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> On 11/1/22 11:33 AM, <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A> wrote:
</I>&gt;&gt;<i> What Squid officially *does not* support is decrypting traffic then 
</I>&gt;&gt;<i> sending the un-encrypted form to a HTTP-only cache_peer.
</I>&gt;<i> 
</I>&gt;<i> Please elaborate.  I'm trying to develop a mental model of what is and 
</I>&gt;<i> is not supported with regard to client / proxy / server communications. 
</I>&gt;<i> I'm unclear on how this applies to the two potential HTTPS streams; 
</I>&gt;<i> client-to-proxy and proxy-to-server.
</I>
Okay, some info that may help with that mental model...

The first thing you need to do is avoid that &quot;HTTPS&quot; term. It has 
multiple meanings and they cause confusion. Instead decompose it into 
its TLS and HTTP layers.

* A client can use TCP or TLS to connect to a proxy.
  - this is configured with http_port vs https_port

* Independently of the connection type the client can request <A HREF="http://">http://</A> or 
<A HREF="https://">https://</A> URLs or CONNECT tunnels.

* Independent of what the client is doing/requesting, a cache_peer may 
be connected to using TCP or TLS.
  - this is configured with cache_peer tls options (or their absence)

* Independent of anything else, a cache_peer MAY be asked to open a 
CONNECT tunnel for opaque uses.
  - this is automatically decided by Squid based on various criteria.


TCP is the foundation layer. On top of that can be HTTP transfer or TLS 
transfer. Transfer layers can be nested infinitely deep in any order.

So &quot;HTTPS&quot; can mean any one of things like:
  1) HTTP-over-TLS (how Browsers handle <A HREF="https://">https://</A> URLs)
  2) HTTP-over-TLS (sending <A HREF="http://">http://</A> URLs over a secure connection)
  3) HTTP-over-TLS-over-TLS (relay (1) through a secure cache_peer)
  4) HTTP-over-TLS-over-HTTP (relay (1), (2) or (3) through an insecure 
cache_peer via CONNECT tunnel)

Each agent along the chain can add or remove any number of transfer 
layers to the protocol X-over-Y stack. Although for efficiency most 
prefer to minimize the layering depth.

A typical web request may flow across the Internet through a chain of 
proxies like this:

  client -(1)-&gt; S1 =(4)=&gt; S2 =(1)=&gt; S3 -(2)-&gt; O

  C = origin client
  S1 = forward-proxy
  S2 = insecure relay proxy
  S3 = TLS terminating reverse-proxy
  O = origin server


&gt;<i>  Or if this is more applicable to TLS-Bump on implicit / network 
</I>&gt;<i> transparent / intercepting proxies where the client thinks that it's 
</I>&gt;<i> talking HTTPS to the origin server and the proxy would really be 
</I>&gt;<i> downgrading security by stripping TLS.
</I>&gt;<i> 
</I>
It's *more* important with SSL-Bump 'bump' due to the interception 
nature of that operation. But also applies to other cases.

SSL-Bump implies interception of TLS
  * intercept may happen at network level (port 443 redirect or NAT)
  * intercept may be entirely within Squid (CONNECT tunnel unwrapped)

Decryption is independent of interception.
  a) SSL-Bump 'bump' action performs decrypt (the others do not)
  b) a TLS forward/explicit-proxy performs decrypt
  c) a TLS reverse-proxy performs decrypt

Traffic from (a) case requires re-encrypt before sending, even if its 
URL indicates insecure protocols.
Traffic from (b) MUST be re-encrypted when it is for a secure protocol 
eg <A HREF="https://,">https://,</A> otherwise optional.
Traffic from (c) SHOULD be encrypted on sending, but always optional.

The &quot;re-encrypt&quot; may take the form of TLS to the secure peer, or a 
CONNECT tunnel through any peer with TLS to whatever is at the other end 
of the tunnel.


&gt;<i> Here is my mental model based on my current understanding.  Is the 
</I>&gt;<i> following diagram accurate?
</I>&gt;<i> 
</I>&gt;<i>             +-------------+-----------+
</I>&gt;<i>             |  P2S-HTTP   | P2S-HTTPS |
</I>&gt;<i> +-----------+-------------+-----------+
</I>&gt;<i> | C2P-HTTP  |  supported  | supported |
</I>&gt;<i> +-----------+-------------+-----------+
</I>&gt;<i> | C2P-HTTPS | unsupported | supported |
</I>&gt;<i> +-----------+-------------+-----------+
</I>&gt;<i>   C2P = Client to Proxy communication
</I>&gt;<i>   P2S = Proxy to server communication
</I>&gt;<i> 
</I>
Vaguely yes. There are three dimensions to the matrix, you only have two 
shown here.
The box showing &quot;unsupported&quot; has &quot;supported&quot; in its other dimension.


&gt;&gt;<i> All other permutations of inbound TCP/TLS, <A HREF="http://">http://</A> or <A HREF="https://">https://</A> URL, 
</I>&gt;&gt;<i> and outbound TCP/TLS should currently work to some degree. The more 
</I>&gt;&gt;<i> recent your Squid version the better it is.
</I>&gt;<i> 
</I>&gt;<i> ACK
</I>&gt;<i> 
</I>&gt;<i> 
</I>
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="025368.html">[squid-users] Does Squid support client ssl termination?
</A></li>
	<LI>Next message (by thread): <A HREF="025374.html">[squid-users] Does Squid support client ssl termination?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25372">[ date ]</a>
              <a href="thread.html#25372">[ thread ]</a>
              <a href="subject.html#25372">[ subject ]</a>
              <a href="author.html#25372">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
