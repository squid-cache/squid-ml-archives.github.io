<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Does Squid support client ssl termination?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Does%20Squid%20support%20client%20ssl%20termination%3F&In-Reply-To=%3CCAB-cPAo2329EEm0cSsZp75M1qh1n4q7YC7BtoQGGuQXdCuSXqA%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="025372.html">
   <LINK REL="Next"  HREF="025375.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Does Squid support client ssl termination?</H1>
    <B>mingheng wang</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Does%20Squid%20support%20client%20ssl%20termination%3F&In-Reply-To=%3CCAB-cPAo2329EEm0cSsZp75M1qh1n4q7YC7BtoQGGuQXdCuSXqA%40mail.gmail.com%3E"
       TITLE="[squid-users] Does Squid support client ssl termination?">ifoolb at gmail.com
       </A><BR>
    <I>Wed Nov  2 00:58:25 UTC 2022</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="025372.html">[squid-users] Does Squid support client ssl termination?
</A></li>
        <LI>Next message (by thread): <A HREF="025375.html">[squid-users] Does Squid support client ssl termination?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25374">[ date ]</a>
              <a href="thread.html#25374">[ thread ]</a>
              <a href="subject.html#25374">[ subject ]</a>
              <a href="author.html#25374">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Wed, Nov 2, 2022 at 6:17 AM &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt; wrote:

&gt;<i> On 2022-11-02 07:49, Grant Taylor wrote:
</I>&gt;<i> &gt; On 11/1/22 11:33 AM, squid3 wrote:
</I>&gt;<i> &gt;&gt; That is not true as a blanket statement.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Please clarify which statement / who you are addressing.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; It seems as if you're addressing mingheng (copied below for
</I>&gt;<i> &gt; convenience):
</I>&gt;<i> &gt;
</I>&gt;<i>
</I>&gt;<i> Yes I was addressing mingheng's statement.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; On 10/31/22 7:32 PM, mingheng wang wrote:
</I>&gt;<i> &gt;&gt; I delved into the configuration the last few days, and found that
</I>&gt;<i> &gt;&gt; Squid doesn't officially support cache_peer when ssl_bump is in use.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; But you may be addressing my statement (...):
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; On 11/1/22 10:44 AM, Grant Taylor wrote:
</I>&gt;<i> &gt;&gt; That surprises me.  I wonder if it's a technical limitation or an
</I>&gt;<i> &gt;&gt; oversight.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; On 11/1/22 11:33 AM, <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A> wrote:
</I>&gt;<i> &gt;&gt; What Squid officially *does not* support is decrypting traffic then
</I>&gt;<i> &gt;&gt; sending the un-encrypted form to a HTTP-only cache_peer.
</I>&gt;<i>
</I>Oh sorry, I was meant to say that. I tested setting a sslstrip proxy as
cache_peer
when ssl_bump was in use, and it didn't work. I was too focused on my setup
and
forgot the case of regular proxies.


&gt;<i> &gt;
</I>&gt;<i> &gt; Please elaborate.  I'm trying to develop a mental model of what is and
</I>&gt;<i> &gt; is not supported with regard to client / proxy / server communications.
</I>&gt;<i> &gt; I'm unclear on how this applies to the two potential HTTPS streams;
</I>&gt;<i> &gt; client-to-proxy and proxy-to-server.
</I>&gt;<i>
</I>&gt;<i> Okay, some info that may help with that mental model...
</I>&gt;<i>
</I>&gt;<i> The first thing you need to do is avoid that &quot;HTTPS&quot; term. It has
</I>&gt;<i> multiple meanings and they cause confusion. Instead decompose it into
</I>&gt;<i> its TLS and HTTP layers.
</I>&gt;<i>
</I>&gt;<i> * A client can use TCP or TLS to connect to a proxy.
</I>&gt;<i>   - this is configured with http_port vs https_port
</I>&gt;<i>
</I>&gt;<i> * Independently of the connection type the client can request <A HREF="http://">http://</A> or
</I>&gt;<i> <A HREF="https://">https://</A> URLs or CONNECT tunnels.
</I>&gt;<i>
</I>&gt;<i> * Independent of what the client is doing/requesting, a cache_peer may
</I>&gt;<i> be connected to using TCP or TLS.
</I>&gt;<i>   - this is configured with cache_peer tls options (or their absence)
</I>&gt;<i>
</I>&gt;<i> * Independent of anything else, a cache_peer MAY be asked to open a
</I>&gt;<i> CONNECT tunnel for opaque uses.
</I>&gt;<i>   - this is automatically decided by Squid based on various criteria.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> TCP is the foundation layer. On top of that can be HTTP transfer or TLS
</I>&gt;<i> transfer. Transfer layers can be nested infinitely deep in any order.
</I>&gt;<i>
</I>&gt;<i> So &quot;HTTPS&quot; can mean any one of things like:
</I>&gt;<i>   1) HTTP-over-TLS (how Browsers handle <A HREF="https://">https://</A> URLs)
</I>&gt;<i>   2) HTTP-over-TLS (sending <A HREF="http://">http://</A> URLs over a secure connection)
</I>&gt;<i>   3) HTTP-over-TLS-over-TLS (relay (1) through a secure cache_peer)
</I>&gt;<i>   4) HTTP-over-TLS-over-HTTP (relay (1), (2) or (3) through an insecure
</I>&gt;<i> cache_peer via CONNECT tunnel)
</I>&gt;<i>
</I>&gt;<i> Each agent along the chain can add or remove any number of transfer
</I>&gt;<i> layers to the protocol X-over-Y stack. Although for efficiency most
</I>&gt;<i> prefer to minimize the layering depth.
</I>&gt;<i>
</I>&gt;<i> A typical web request may flow across the Internet through a chain of
</I>&gt;<i> proxies like this:
</I>&gt;<i>
</I>&gt;<i>   client -(1)-&gt; S1 =(4)=&gt; S2 =(1)=&gt; S3 -(2)-&gt; O
</I>&gt;<i>
</I>&gt;<i>   C = origin client
</I>&gt;<i>   S1 = forward-proxy
</I>&gt;<i>   S2 = insecure relay proxy
</I>&gt;<i>   S3 = TLS terminating reverse-proxy
</I>&gt;<i>   O = origin server
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt;  Or if this is more applicable to TLS-Bump on implicit / network
</I>&gt;<i> &gt; transparent / intercepting proxies where the client thinks that it's
</I>&gt;<i> &gt; talking HTTPS to the origin server and the proxy would really be
</I>&gt;<i> &gt; downgrading security by stripping TLS.
</I>&gt;<i> &gt;
</I>&gt;<i>
</I>&gt;<i> It's *more* important with SSL-Bump 'bump' due to the interception
</I>&gt;<i> nature of that operation. But also applies to other cases.
</I>&gt;<i>
</I>&gt;<i> SSL-Bump implies interception of TLS
</I>&gt;<i>   * intercept may happen at network level (port 443 redirect or NAT)
</I>&gt;<i>   * intercept may be entirely within Squid (CONNECT tunnel unwrapped)
</I>&gt;<i>
</I>&gt;<i> Decryption is independent of interception.
</I>&gt;<i>   a) SSL-Bump 'bump' action performs decrypt (the others do not)
</I>&gt;<i>   b) a TLS forward/explicit-proxy performs decrypt
</I>&gt;<i>   c) a TLS reverse-proxy performs decrypt
</I>&gt;<i>
</I>&gt;<i> Traffic from (a) case requires re-encrypt before sending, even if its
</I>&gt;<i> URL indicates insecure protocols.
</I>&gt;<i>
</I>  I don't understand. According to the wiki on Squid that I read, there are
several
steps involving &quot;peek&quot;, &quot;bump&quot; or &quot;slice&quot; etc, we can already choose to
bump or
slice through SNI at step2. So why does HTTP have to be encrypted too?

  Anyway, essentially what I need is like splitting Squid into two parts:
the client
side part communicate with a client over a connection with dynamically
generated
certificates in order to fool the client when dealing with HSTS; while
forwarding traffic
unencrypted to the &quot;other part&quot; of Squid somewhere, which in turn
establishes a
new connection with the original server to do the bump thing and so on.

  Since Squid doesn't support this, I'll stop fiddling with it. I think
HTTP isn't a very
complicated protocol, and most HTTP libraries can handle TLS as well.
Perhaps it
won't be hard to write a simple proxy for personal use and Squid even has a
tool
called security_file_certgen, maybe I can make use of it.


&gt;<i> Traffic from (b) MUST be re-encrypted when it is for a secure protocol
</I>&gt;<i> eg <A HREF="https://,">https://,</A> otherwise optional.
</I>&gt;<i> Traffic from (c) SHOULD be encrypted on sending, but always optional.
</I>&gt;<i>
</I>&gt;<i> The &quot;re-encrypt&quot; may take the form of TLS to the secure peer, or a
</I>&gt;<i> CONNECT tunnel through any peer with TLS to whatever is at the other end
</I>&gt;<i> of the tunnel.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; Here is my mental model based on my current understanding.  Is the
</I>&gt;<i> &gt; following diagram accurate?
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;             +-------------+-----------+
</I>&gt;<i> &gt;             |  P2S-HTTP   | P2S-HTTPS |
</I>&gt;<i> &gt; +-----------+-------------+-----------+
</I>&gt;<i> &gt; | C2P-HTTP  |  supported  | supported |
</I>&gt;<i> &gt; +-----------+-------------+-----------+
</I>&gt;<i> &gt; | C2P-HTTPS | unsupported | supported |
</I>&gt;<i> &gt; +-----------+-------------+-----------+
</I>&gt;<i> &gt;   C2P = Client to Proxy communication
</I>&gt;<i> &gt;   P2S = Proxy to server communication
</I>&gt;<i> &gt;
</I>&gt;<i>
</I>&gt;<i> Vaguely yes. There are three dimensions to the matrix, you only have two
</I>&gt;<i> shown here.
</I>&gt;<i> The box showing &quot;unsupported&quot; has &quot;supported&quot; in its other dimension.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt;&gt; All other permutations of inbound TCP/TLS, <A HREF="http://">http://</A> or <A HREF="https://">https://</A> URL,
</I>&gt;<i> &gt;&gt; and outbound TCP/TLS should currently work to some degree. The more
</I>&gt;<i> &gt;&gt; recent your Squid version the better it is.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; ACK
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i>
</I>

-- 
Like a Fool,I'm very foolish.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20221102/d2c4e2d9/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20221102/d2c4e2d9/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="025372.html">[squid-users] Does Squid support client ssl termination?
</A></li>
	<LI>Next message (by thread): <A HREF="025375.html">[squid-users] Does Squid support client ssl termination?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25374">[ date ]</a>
              <a href="thread.html#25374">[ thread ]</a>
              <a href="subject.html#25374">[ subject ]</a>
              <a href="author.html#25374">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
