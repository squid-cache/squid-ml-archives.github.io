<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] site opens only without ssl bump
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20site%20opens%20only%20without%20ssl%20bump&In-Reply-To=%3C0aa508d5-033c-6f41-d751-ec9eee090dc3%40ckta.by%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="025382.html">
   <LINK REL="Next"  HREF="025384.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] site opens only without ssl bump</H1>
    <B>Majed Zouhairy</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20site%20opens%20only%20without%20ssl%20bump&In-Reply-To=%3C0aa508d5-033c-6f41-d751-ec9eee090dc3%40ckta.by%3E"
       TITLE="[squid-users] site opens only without ssl bump">m_zouhairy at ckta.by
       </A><BR>
    <I>Thu Nov  3 09:43:22 UTC 2022</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="025382.html">[squid-users] ACL based DNS server list
</A></li>
        <LI>Next message (by thread): <A HREF="025384.html">[squid-users] site opens only without ssl bump
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25383">[ date ]</a>
              <a href="thread.html#25383">[ thread ]</a>
              <a href="subject.html#25383">[ subject ]</a>
              <a href="author.html#25383">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Peace,
i have 2 proxies, one with ssl bump and one without, there is a internal 
site that opens only on the no ssl bump proxy.

on the ssl bump proxy it displays:


&#1053;&#1077; &#1091;&#1076;&#1072;&#1077;&#1090;&#1089;&#1103; &#1087;&#1086;&#1083;&#1091;&#1095;&#1080;&#1090;&#1100; &#1076;&#1086;&#1089;&#1090;&#1091;&#1087; &#1082; &#1089;&#1072;&#1081;&#1090;&#1091;&#1042;&#1077;&#1073;-&#1089;&#1090;&#1088;&#1072;&#1085;&#1080;&#1094;&#1072; &#1087;&#1086; &#1072;&#1076;&#1088;&#1077;&#1089;&#1091; (i was unable 
to gain access to website:) 
<A HREF="https://test-auth.ias.ckko.nl/oauth/authorize?response_type=code&amp;client_id=agoh1xHNNwaLZ65uspARyhYj7V8GTWla&amp;state=guest&amp;authentication=usbtoken&amp;redirect_uri=https%3A%2F%2Fais.skko.by%2Foauth2%2Fcallback,">https://test-auth.ias.ckko.nl/oauth/authorize?response_type=code&amp;client_id=agoh1xHNNwaLZ65uspARyhYj7V8GTWla&amp;state=guest&amp;authentication=usbtoken&amp;redirect_uri=https%3A%2F%2Fais.skko.by%2Foauth2%2Fcallback,</A> 
&#1074;&#1086;&#1079;&#1084;&#1086;&#1078;&#1085;&#1086;, &#1074;&#1088;&#1077;&#1084;&#1077;&#1085;&#1085;&#1086; &#1085;&#1077;&#1076;&#1086;&#1089;&#1090;&#1091;&#1087;&#1085;&#1072; &#1080;&#1083;&#1080; &#1087;&#1086;&#1089;&#1090;&#1086;&#1103;&#1085;&#1085;&#1086; &#1087;&#1077;&#1088;&#1077;&#1084;&#1077;&#1097;&#1077;&#1085;&#1072; &#1087;&#1086; &#1085;&#1086;&#1074;&#1086;&#1084;&#1091; &#1072;&#1076;&#1088;&#1077;&#1089;&#1091;. 
(it is possible that it can not bbe reached or it has been permanently 
relocated to a new address)
ERR_TUNNEL_CONNECTION_FAILED

the site needs special configurations to run:
it needs a local proxy to run, avtunproxy.nl
in the internet explorer settings:
the second box in the proxy settings needs to be checked called the &quot;use 
the scenario for automatic configuration&quot;
in it, the proxy address is plugged
<A HREF="http://127.0.0.1:10224/proxy.pac">http://127.0.0.1:10224/proxy.pac</A>

my bump settings are as follows:


acl 	tls_s1_connect		at_step SslBump1
acl 	tls_s2_client_hello 	at_step SslBump2
acl 	tls_s3_server_hello 	at_step SslBump3

# define acls for sites that must not be actively bumped

acl 	tls_allowed_hsts		ssl::server_name 			.akamaihd.net
acl 	tls_allowed_hsts		ssl::server_name 			.proxy.ckko.nl
acl 	tls_server_is_bank 		ssl::server_name		 
&quot;/usr/local/ufdbguard/blacklists/finance/domains.squidsplice&quot;
acl 	tls_to_splice 	any-of 	tls_allowed_hsts tls_server_is_bank

# TLS/SSL bumping steps

ssl_bump 		peek				tls_s1_connect 		# peek at TLS/SSL connect data
ssl_bump 		splice 				tls_to_splice		# splice some: no active bump
ssl_bump 		stare 				all					# stare(peek) at server
														# properties of the webserver
ssl_bump 		bump

contents of the 
/usr/local/ufdbguard/blacklists/finance/domains.squidsplice file:

.ckko.nl
.ias.ckko.nl
.test-auth.ias.ckko.nl
.config.avtunproxy.nl
.rand.avtunproxy.nl
.avast.nl
.dev.avast.nl
.ncis.nl
.cdn.nlpost.nl

those are all the sites that are logged in on the non ssl bump proxy 
when ias.ckko.nl is accessed

despite all this configuration, the site does not open. in ufdbguard 
every site from the user is a pass.

in avtunproxy log :

2022/11/03 12:22:17.087001 |INF| [UPDATER] [TrustFirmware] fetching 
<A HREF="https://ckko.nl/upload/certificates/8.crl">https://ckko.nl/upload/certificates/8.crl</A>
2022/11/03 12:28:34.634001 |ERR| [rid=ab7a9b1c9f39fb3e] 
[addr=127.0.0.1:10523] [PROXY parent=proxy.ckko.nl:8080] HTTP 500 - EOF
2022/11/03 12:28:34.635001 |INF| [rid=ab7a9b1c9f39fb3e] 
[addr=127.0.0.1:10523] [PROXY parent=proxy.ckko.nl:8080] CONNECT 
test-oauth.ais.ckko.nl:443 -- 500 -- 14.000000 ms
2022/11/03 12:28:34.663001 |ERR| [rid=47fba344ff078bcf] 
[addr=127.0.0.1:10526] [PROXY parent=proxy.ckko.nl:8080] HTTP 500 - read 
tcp 192.168.2.5:10527-&gt;10.0.0.18:8080: wsarecv: An existing connection 
was forcibly closed by the remote host.
2022/11/03 12:28:34.664001 |INF| [rid=47fba344ff078bcf] 
[addr=127.0.0.1:10526] [PROXY parent=proxy.ckko.nl:8080] CONNECT 
test-oauth.ais.ckko.nl:443 -- 500 -- 17.000000 ms
2022/11/03 12:28:35.723001 |ERR| [rid=3f5ccf39ef0ae021] 
[addr=127.0.0.1:10529] [PROXY parent=proxy.ckko.nl:8080] HTTP 500 - EOF
2022/11/03 12:28:35.723001 |INF| [rid=3f5ccf39ef0ae021] 
[addr=127.0.0.1:10529] [PROXY parent=proxy.ckko.nl:8080] CONNECT 
test-oauth.ais.ckko.nl:443 -- 500 -- 19.000000 ms
2022/11/03 12:28:35.748001 |ERR| [rid=c48d84308d001f59] 
[addr=127.0.0.1:10531] [PROXY parent=proxy.ckko.nl:8080] HTTP 500 - EOF
2022/11/03 12:28:35.748001 |INF| [rid=c48d84308d001f59] 
[addr=127.0.0.1:10531] [PROXY parent=proxy.ckko.nl:8080] CONNECT 
test-oauth.ais.ckko.nl:443 -- 500 -- 12.000000 ms
2022/11/03 12:28:35.752001 |ERR| [rid=d181037283b2a34a] 
[addr=127.0.0.1:10532] [PROXY parent=proxy.ckko.nl:8080] HTTP 500 - EOF
2022/11/03 12:28:35.752001 |INF| [rid=d181037283b2a34a] 
[addr=127.0.0.1:10532] [PROXY parent=proxy.ckko.nl:8080] CONNECT 
test-oauth.ais.ckko.nl:443 -- 500 -- 15.000000 ms
2022/11/03 12:28:40.775001 |ERR| [rid=27f00eecdbe53178] 
[addr=127.0.0.1:10537] [PROXY parent=proxy.ckko.nl:8080] HTTP 500 - read 
tcp 192.168.2.5:10538-&gt;10.0.0.18:8080: wsarecv: An existing connection 
was forcibly closed by the remote host.
2022/11/03 12:28:40.775001 |INF| [rid=27f00eecdbe53178] 
[addr=127.0.0.1:10537] [PROXY parent=proxy.ckko.nl:8080] CONNECT 
test-oauth.ais.ckko.nl:443 -- 500 -- 19.000000 ms
2022/11/03 12:28:40.815001 |ERR| [rid=79611bea389d7c9c] 
[addr=127.0.0.1:10539] [PROXY parent=proxy.ckko.nl:8080] HTTP 500 - EOF
2022/11/03 12:28:40.816001 |INF| [rid=79611bea389d7c9c] 
[addr=127.0.0.1:10539] [PROXY parent=proxy.ckko.nl:8080] CONNECT 
test-oauth.ais.ckko.nl:443 -- 500 -- 14.000000 ms
2022/11/03 12:28:42.188001 |INF| [rid=7a104242baf9a559] 
[addr=127.0.0.1:10541] GET /static/jquery.js - HTTP 200 - OK
2022/11/03 12:28:42.190001 |INF| [rid=27a7baff0fe5d70e] 
[addr=127.0.0.1:10542] GET /static/bootstrap.js - HTTP 200 - OK
2022/11/03 12:28:42.192001 |INF| [rid=dbddaaa3f7759903] 
[addr=127.0.0.1:10459] GET /static/bootstrap.css - HTTP 200 - OK
2022/11/03 12:28:42.287001 |INF| [rid=7e81e98ea9c70d3f] 
[addr=127.0.0.1:10544] GET /api/v2/log


what is the solution?

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="025382.html">[squid-users] ACL based DNS server list
</A></li>
	<LI>Next message (by thread): <A HREF="025384.html">[squid-users] site opens only without ssl bump
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25383">[ date ]</a>
              <a href="thread.html#25383">[ thread ]</a>
              <a href="subject.html#25383">[ subject ]</a>
              <a href="author.html#25383">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
