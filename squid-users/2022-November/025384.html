<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] site opens only without ssl bump
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20site%20opens%20only%20without%20ssl%20bump&In-Reply-To=%3C70311335-8ece-ca90-caea-b78ffeecc69e%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="025383.html">
   <LINK REL="Next"  HREF="025385.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] site opens only without ssl bump</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20site%20opens%20only%20without%20ssl%20bump&In-Reply-To=%3C70311335-8ece-ca90-caea-b78ffeecc69e%40measurement-factory.com%3E"
       TITLE="[squid-users] site opens only without ssl bump">rousskov at measurement-factory.com
       </A><BR>
    <I>Thu Nov  3 13:05:24 UTC 2022</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="025383.html">[squid-users] site opens only without ssl bump
</A></li>
        <LI>Next message (by thread): <A HREF="025385.html">[squid-users] site opens only without ssl bump
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25384">[ date ]</a>
              <a href="thread.html#25384">[ thread ]</a>
              <a href="subject.html#25384">[ subject ]</a>
              <a href="author.html#25384">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 11/3/22 05:43, Majed Zouhairy wrote:

&gt;<i> i have 2 proxies, one with ssl bump and one without, there is a internal 
</I>&gt;<i> site that opens only on the no ssl bump proxy.
</I>&gt;<i> 
</I>&gt;<i> on the ssl bump proxy it displays:
</I>

What does Squid say in access.log for this problematic request? Please 
configure Squid to log %err_code/%err_detail before answering this 
question. For example:

logformat xsquid ...your regular %codes... %err_code/%err_detail
access_log ... xsquid



Does the site works if you temporary replace your ssl_bump rules with:

ssl_bump peek all
ssl_bump splice all


Does the site works if you temporary replace your ssl_bump rules with:

ssl_bump peek tls_s1_connect
ssl_bump splice all


Alex.




&gt;<i> &#1053;&#1077; &#1091;&#1076;&#1072;&#1077;&#1090;&#1089;&#1103; &#1087;&#1086;&#1083;&#1091;&#1095;&#1080;&#1090;&#1100; &#1076;&#1086;&#1089;&#1090;&#1091;&#1087; &#1082; &#1089;&#1072;&#1081;&#1090;&#1091;&#1042;&#1077;&#1073;-&#1089;&#1090;&#1088;&#1072;&#1085;&#1080;&#1094;&#1072; &#1087;&#1086; &#1072;&#1076;&#1088;&#1077;&#1089;&#1091; (i was unable 
</I>&gt;<i> to gain access to website:) 
</I>&gt;<i> <A HREF="https://test-auth.ias.ckko.nl/oauth/authorize?response_type=code&amp;client_id=agoh1xHNNwaLZ65uspARyhYj7V8GTWla&amp;state=guest&amp;authentication=usbtoken&amp;redirect_uri=https%3A%2F%2Fais.skko.by%2Foauth2%2Fcallback,">https://test-auth.ias.ckko.nl/oauth/authorize?response_type=code&amp;client_id=agoh1xHNNwaLZ65uspARyhYj7V8GTWla&amp;state=guest&amp;authentication=usbtoken&amp;redirect_uri=https%3A%2F%2Fais.skko.by%2Foauth2%2Fcallback,</A> 
</I>&gt;<i> &#1074;&#1086;&#1079;&#1084;&#1086;&#1078;&#1085;&#1086;, &#1074;&#1088;&#1077;&#1084;&#1077;&#1085;&#1085;&#1086; &#1085;&#1077;&#1076;&#1086;&#1089;&#1090;&#1091;&#1087;&#1085;&#1072; &#1080;&#1083;&#1080; &#1087;&#1086;&#1089;&#1090;&#1086;&#1103;&#1085;&#1085;&#1086; &#1087;&#1077;&#1088;&#1077;&#1084;&#1077;&#1097;&#1077;&#1085;&#1072; &#1087;&#1086; &#1085;&#1086;&#1074;&#1086;&#1084;&#1091; &#1072;&#1076;&#1088;&#1077;&#1089;&#1091;. 
</I>&gt;<i> (it is possible that it can not bbe reached or it has been permanently 
</I>&gt;<i> relocated to a new address)
</I>&gt;<i> ERR_TUNNEL_CONNECTION_FAILED
</I>&gt;<i> 
</I>&gt;<i> the site needs special configurations to run:
</I>&gt;<i> it needs a local proxy to run, avtunproxy.nl
</I>&gt;<i> in the internet explorer settings:
</I>&gt;<i> the second box in the proxy settings needs to be checked called the &quot;use 
</I>&gt;<i> the scenario for automatic configuration&quot;
</I>&gt;<i> in it, the proxy address is plugged
</I>&gt;<i> <A HREF="http://127.0.0.1:10224/proxy.pac">http://127.0.0.1:10224/proxy.pac</A>
</I>&gt;<i> 
</I>&gt;<i> my bump settings are as follows:
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> acl&#160;&#160;&#160;&#160; tls_s1_connect&#160;&#160;&#160;&#160;&#160;&#160;&#160; at_step SslBump1
</I>&gt;<i> acl&#160;&#160;&#160;&#160; tls_s2_client_hello&#160;&#160;&#160;&#160; at_step SslBump2
</I>&gt;<i> acl&#160;&#160;&#160;&#160; tls_s3_server_hello&#160;&#160;&#160;&#160; at_step SslBump3
</I>&gt;<i> 
</I>&gt;<i> # define acls for sites that must not be actively bumped
</I>&gt;<i> 
</I>&gt;<i> acl&#160;&#160;&#160;&#160; tls_allowed_hsts&#160;&#160;&#160;&#160;&#160;&#160;&#160; ssl::server_name&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; .akamaihd.net
</I>&gt;<i> acl&#160;&#160;&#160;&#160; tls_allowed_hsts&#160;&#160;&#160;&#160;&#160;&#160;&#160; ssl::server_name&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; .proxy.ckko.nl
</I>&gt;<i> acl&#160;&#160;&#160;&#160; tls_server_is_bank&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; ssl::server_name 
</I>&gt;<i> &quot;/usr/local/ufdbguard/blacklists/finance/domains.squidsplice&quot;
</I>&gt;<i> acl&#160;&#160;&#160;&#160; tls_to_splice&#160;&#160;&#160;&#160; any-of&#160;&#160;&#160;&#160; tls_allowed_hsts tls_server_is_bank
</I>&gt;<i> 
</I>&gt;<i> # TLS/SSL bumping steps
</I>&gt;<i> 
</I>&gt;<i> ssl_bump&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; peek&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; tls_s1_connect&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; # peek at 
</I>&gt;<i> TLS/SSL connect data
</I>&gt;<i> ssl_bump&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; splice&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; tls_to_splice&#160;&#160;&#160;&#160;&#160;&#160;&#160; # splice 
</I>&gt;<i> some: no active bump
</I>&gt;<i> ssl_bump&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; stare&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; all&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; # 
</I>&gt;<i> stare(peek) at server
</I>&gt;<i>  &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; # properties of 
</I>&gt;<i> the webserver
</I>&gt;<i> ssl_bump&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; bump
</I>&gt;<i> 
</I>&gt;<i> contents of the 
</I>&gt;<i> /usr/local/ufdbguard/blacklists/finance/domains.squidsplice file:
</I>&gt;<i> 
</I>&gt;<i> .ckko.nl
</I>&gt;<i> .ias.ckko.nl
</I>&gt;<i> .test-auth.ias.ckko.nl
</I>&gt;<i> .config.avtunproxy.nl
</I>&gt;<i> .rand.avtunproxy.nl
</I>&gt;<i> .avast.nl
</I>&gt;<i> .dev.avast.nl
</I>&gt;<i> .ncis.nl
</I>&gt;<i> .cdn.nlpost.nl
</I>&gt;<i> 
</I>&gt;<i> those are all the sites that are logged in on the non ssl bump proxy 
</I>&gt;<i> when ias.ckko.nl is accessed
</I>&gt;<i> 
</I>&gt;<i> despite all this configuration, the site does not open. in ufdbguard 
</I>&gt;<i> every site from the user is a pass.
</I>&gt;<i> 
</I>&gt;<i> in avtunproxy log :
</I>&gt;<i> 
</I>&gt;<i> 2022/11/03 12:22:17.087001 |INF| [UPDATER] [TrustFirmware] fetching 
</I>&gt;<i> <A HREF="https://ckko.nl/upload/certificates/8.crl">https://ckko.nl/upload/certificates/8.crl</A>
</I>&gt;<i> 2022/11/03 12:28:34.634001 |ERR| [rid=ab7a9b1c9f39fb3e] 
</I>&gt;<i> [addr=127.0.0.1:10523] [PROXY parent=proxy.ckko.nl:8080] HTTP 500 - EOF
</I>&gt;<i> 2022/11/03 12:28:34.635001 |INF| [rid=ab7a9b1c9f39fb3e] 
</I>&gt;<i> [addr=127.0.0.1:10523] [PROXY parent=proxy.ckko.nl:8080] CONNECT 
</I>&gt;<i> test-oauth.ais.ckko.nl:443 -- 500 -- 14.000000 ms
</I>&gt;<i> 2022/11/03 12:28:34.663001 |ERR| [rid=47fba344ff078bcf] 
</I>&gt;<i> [addr=127.0.0.1:10526] [PROXY parent=proxy.ckko.nl:8080] HTTP 500 - read 
</I>&gt;<i> tcp 192.168.2.5:10527-&gt;10.0.0.18:8080: wsarecv: An existing connection 
</I>&gt;<i> was forcibly closed by the remote host.
</I>&gt;<i> 2022/11/03 12:28:34.664001 |INF| [rid=47fba344ff078bcf] 
</I>&gt;<i> [addr=127.0.0.1:10526] [PROXY parent=proxy.ckko.nl:8080] CONNECT 
</I>&gt;<i> test-oauth.ais.ckko.nl:443 -- 500 -- 17.000000 ms
</I>&gt;<i> 2022/11/03 12:28:35.723001 |ERR| [rid=3f5ccf39ef0ae021] 
</I>&gt;<i> [addr=127.0.0.1:10529] [PROXY parent=proxy.ckko.nl:8080] HTTP 500 - EOF
</I>&gt;<i> 2022/11/03 12:28:35.723001 |INF| [rid=3f5ccf39ef0ae021] 
</I>&gt;<i> [addr=127.0.0.1:10529] [PROXY parent=proxy.ckko.nl:8080] CONNECT 
</I>&gt;<i> test-oauth.ais.ckko.nl:443 -- 500 -- 19.000000 ms
</I>&gt;<i> 2022/11/03 12:28:35.748001 |ERR| [rid=c48d84308d001f59] 
</I>&gt;<i> [addr=127.0.0.1:10531] [PROXY parent=proxy.ckko.nl:8080] HTTP 500 - EOF
</I>&gt;<i> 2022/11/03 12:28:35.748001 |INF| [rid=c48d84308d001f59] 
</I>&gt;<i> [addr=127.0.0.1:10531] [PROXY parent=proxy.ckko.nl:8080] CONNECT 
</I>&gt;<i> test-oauth.ais.ckko.nl:443 -- 500 -- 12.000000 ms
</I>&gt;<i> 2022/11/03 12:28:35.752001 |ERR| [rid=d181037283b2a34a] 
</I>&gt;<i> [addr=127.0.0.1:10532] [PROXY parent=proxy.ckko.nl:8080] HTTP 500 - EOF
</I>&gt;<i> 2022/11/03 12:28:35.752001 |INF| [rid=d181037283b2a34a] 
</I>&gt;<i> [addr=127.0.0.1:10532] [PROXY parent=proxy.ckko.nl:8080] CONNECT 
</I>&gt;<i> test-oauth.ais.ckko.nl:443 -- 500 -- 15.000000 ms
</I>&gt;<i> 2022/11/03 12:28:40.775001 |ERR| [rid=27f00eecdbe53178] 
</I>&gt;<i> [addr=127.0.0.1:10537] [PROXY parent=proxy.ckko.nl:8080] HTTP 500 - read 
</I>&gt;<i> tcp 192.168.2.5:10538-&gt;10.0.0.18:8080: wsarecv: An existing connection 
</I>&gt;<i> was forcibly closed by the remote host.
</I>&gt;<i> 2022/11/03 12:28:40.775001 |INF| [rid=27f00eecdbe53178] 
</I>&gt;<i> [addr=127.0.0.1:10537] [PROXY parent=proxy.ckko.nl:8080] CONNECT 
</I>&gt;<i> test-oauth.ais.ckko.nl:443 -- 500 -- 19.000000 ms
</I>&gt;<i> 2022/11/03 12:28:40.815001 |ERR| [rid=79611bea389d7c9c] 
</I>&gt;<i> [addr=127.0.0.1:10539] [PROXY parent=proxy.ckko.nl:8080] HTTP 500 - EOF
</I>&gt;<i> 2022/11/03 12:28:40.816001 |INF| [rid=79611bea389d7c9c] 
</I>&gt;<i> [addr=127.0.0.1:10539] [PROXY parent=proxy.ckko.nl:8080] CONNECT 
</I>&gt;<i> test-oauth.ais.ckko.nl:443 -- 500 -- 14.000000 ms
</I>&gt;<i> 2022/11/03 12:28:42.188001 |INF| [rid=7a104242baf9a559] 
</I>&gt;<i> [addr=127.0.0.1:10541] GET /static/jquery.js - HTTP 200 - OK
</I>&gt;<i> 2022/11/03 12:28:42.190001 |INF| [rid=27a7baff0fe5d70e] 
</I>&gt;<i> [addr=127.0.0.1:10542] GET /static/bootstrap.js - HTTP 200 - OK
</I>&gt;<i> 2022/11/03 12:28:42.192001 |INF| [rid=dbddaaa3f7759903] 
</I>&gt;<i> [addr=127.0.0.1:10459] GET /static/bootstrap.css - HTTP 200 - OK
</I>&gt;<i> 2022/11/03 12:28:42.287001 |INF| [rid=7e81e98ea9c70d3f] 
</I>&gt;<i> [addr=127.0.0.1:10544] GET /api/v2/log
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> what is the solution?
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="025383.html">[squid-users] site opens only without ssl bump
</A></li>
	<LI>Next message (by thread): <A HREF="025385.html">[squid-users] site opens only without ssl bump
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25384">[ date ]</a>
              <a href="thread.html#25384">[ thread ]</a>
              <a href="subject.html#25384">[ subject ]</a>
              <a href="author.html#25384">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
