<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Update from Squid 4 to Squid 5 :
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Update%20from%20Squid%204%20to%20Squid%205%20%3A&In-Reply-To=%3Cff318d21-5e79-aabb-2dc8-7024b94c64b2%40stemarie-aizenay.fr%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="025400.html">
   <LINK REL="Next"  HREF="025403.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Update from Squid 4 to Squid 5 :</H1>
    <B>Bertrand Friconneau</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Update%20from%20Squid%204%20to%20Squid%205%20%3A&In-Reply-To=%3Cff318d21-5e79-aabb-2dc8-7024b94c64b2%40stemarie-aizenay.fr%3E"
       TITLE="[squid-users] Update from Squid 4 to Squid 5 :">bfriconneau at stemarie-aizenay.fr
       </A><BR>
    <I>Wed Nov  9 15:50:05 UTC 2022</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="025400.html">[squid-users] Squid Dual HTTP &amp; SOCKS Set-Up
</A></li>
        <LI>Next message (by thread): <A HREF="025403.html">[squid-users] Update from Squid 4 to Squid 5 :
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25402">[ date ]</a>
              <a href="thread.html#25402">[ thread ]</a>
              <a href="subject.html#25402">[ subject ]</a>
              <a href="author.html#25402">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Everyone,

I've got Squid 4.10 on Ubuntu 20.10 LTS

I try to upgrade my server to Ubuntu 22.04 LTS

But the users couldn't get internet no more.

Here is the log in /var/log/squid/access.log :
1668004454.050&#160;&#160;&#160;&#160;&#160; 0 172.22.200.1 TCP_DENIED/407 3951 CONNECT 
drive.google.com:443 - HIER_NONE/- text/html
1668004454.052&#160;&#160;&#160;&#160;&#160; 0 172.22.200.1 TCP_DENIED/407 3951 CONNECT 
drive.google.com:443 - HIER_NONE/- text/html
1668004454.057&#160;&#160;&#160;&#160;&#160; 0 172.22.200.1 TCP_DENIED/407 3951 CONNECT 
drive.google.com:443 - HIER_NONE/- text/html
1668004454.063&#160;&#160;&#160;&#160;&#160; 1 172.22.200.1 TCP_DENIED/407 4454 CONNECT 
drive.google.com:443 - HIER_NONE/- text/html
1668004454.076&#160;&#160;&#160;&#160; 10 172.22.200.1 NONE_NONE/500 0 CONNECT 
drive.google.com:443 infoe HIER_NONE/- -

And on the client :
ERR_TUNNEL_CONNECTION_FAILED

According to this page : 
<A HREF="https://wiki.squid-cache.org/ConfigExamples/Authenticate/Ntlm">https://wiki.squid-cache.org/ConfigExamples/Authenticate/Ntlm</A>
The cause is due to challenge-response process of NTLM

How can I solve it ?

Regards

Bertrand Friconneau


-------------------------------------------------------------------------------------------------------------------------------------------------------
Here is my config file of squid :

dns_v4_first on
visible_hostname squid

error_directory /usr/share/squid/errors/French

cache_dir ufs /data/squid/spool 5000 16 256
#cache_mem 256 MB
cache_mem 512 MB
coredump_dir /data/squid/spool
cache_store_log none

auth_param ntlm program /usr/bin/ntlm_auth 
--helper-protocol=squid-2.5-ntlmssp

auth_param ntlm children 250

auth_param ntlm keep_alive off

acl sitebypass dstdomain 
&quot;/var/lib/squidguard/db/exception/bypassite/bypassite.url&quot;
acl tor dst &quot;/etc/squid/tor&quot;

acl administrationzone src 172.21.0.0/16
acl informatiquezone src 172.28.0.0/16
acl secuzone src 172.18.0.0/16
acl srvzone src 172.20.0.0/16
acl url_exe url_regex -i \.[Mm][Ss][Ii]$ \.[Dd][Ll][Ll]$
acl ntlm proxy_auth REQUIRED


acl SSL_ports port 443
acl Safe_ports port 80&#160;&#160;&#160; &#160;&#160;&#160; # http
acl Safe_ports port 21&#160;&#160;&#160; &#160;&#160;&#160; # ftp
acl Safe_ports port 443&#160;&#160;&#160; &#160;&#160;&#160; # https
acl Safe_ports port 70&#160;&#160;&#160; &#160;&#160;&#160; # gopher
acl Safe_ports port 210&#160;&#160;&#160; &#160;&#160;&#160; # wais
acl Safe_ports port 1025-65535&#160;&#160;&#160; # unregistered ports
acl Safe_ports port 280&#160;&#160;&#160; &#160;&#160;&#160; # http-mgmt
acl Safe_ports port 488&#160;&#160;&#160; &#160;&#160;&#160; # gss-http
acl Safe_ports port 591&#160;&#160;&#160; &#160;&#160;&#160; # filemaker
acl Safe_ports port 777&#160;&#160;&#160; &#160;&#160;&#160; # multiling http
acl CONNECT method CONNECT

http_access allow sitebypass
http_access deny tor
http_access deny url_exe
http_access allow administrationzone
#http_access allow pedagozone
#http_access allow xibozone
http_access allow informatiquezone
http_access allow secuzone
http_access allow srvzone
http_access allow ntlm

http_access deny !Safe_ports

http_access deny CONNECT !SSL_ports

http_access allow localhost manager
http_access deny manager

http_access allow localhost

http_access deny all
http_port 8080

url_rewrite_program /usr/bin/squidGuard -P -c 
/etc/squidguard/squidGuard.conf

url_rewrite_children 75

coredump_dir /var/spool/squid
refresh_pattern ^gopher:&#160;&#160;&#160; 1440&#160;&#160;&#160; 0%&#160;&#160;&#160; 1440
refresh_pattern -i (/cgi-bin/|\?) 0&#160;&#160;&#160; 0%&#160;&#160;&#160; 0
refresh_pattern (Release|Packages(.gz)*)$&#160;&#160;&#160;&#160;&#160; 0&#160;&#160;&#160;&#160;&#160;&#160; 20%&#160;&#160;&#160;&#160; 2880
refresh_pattern .&#160;&#160;&#160; &#160;&#160;&#160; 0&#160;&#160;&#160; 20%&#160;&#160;&#160; 4320

max_filedescriptors 65536

-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Here is my config file of samba :

[global]
 &#160;&#160; workgroup = STEMARIEAIZENAY
 &#160;&#160; security = ADS
 &#160;&#160; realm = STEMARIE-AIZENAY.LOCAL
 &#160;&#160; encrypt passwords = yes
 &#160;&#160; winbind separator = +
 &#160;&#160; idmap config *:backend = tdb
 &#160;&#160; idmap config *:range = 70001-80000
 &#160;&#160; idmap config STEMARIEAIZENAY:backend&#160; = rid
 &#160;&#160; idmap config STEMARIEAIZENAY:range&#160; = 10000-70000
 &#160;&#160; winbind enum users = yes
 &#160;&#160; winbind enum groups = yes
 &#160;&#160; vfs objects = acl_xattr
 &#160;&#160; map acl inherit = Yes
 &#160;&#160; store dos attributes = Yes
 &#160;&#160; winbind use default domain = yes
 &#160;&#160; template homedir = /home/homes/%U

-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Here is the krb5.conf file :

[libdefaults]
 &#160;&#160;&#160; default_realm = STEMARIE-AIZENAY.LOCAL
 &#160;&#160;&#160; dns_lookup_kdc = no
 &#160;&#160;&#160; dns_lookup_realm = no
 &#160;&#160;&#160; #ticket_lifetime = 24h
 &#160;&#160;&#160; default_keytab_name = /etc/squid/PROXY.keytab

; for Windows 2003
 &#160;&#160;&#160; default_tgs_enctypes = rc4-hmac des-cbc-crc des-cbc-md5
 &#160;&#160;&#160; default_tkt_enctypes = rc4-hmac des-cbc-crc des-cbc-md5
 &#160;&#160;&#160; permitted_enctypes = rc4-hmac des-cbc-crc des-cbc-md5

; for Windows 2008 with AES
;&#160;&#160;&#160; default_tgs_enctypes = aes256-cts-hmac-sha1-96 rc4-hmac des-cbc-crc 
des-cbc-md5
;&#160;&#160;&#160; default_tkt_enctypes = aes256-cts-hmac-sha1-96 rc4-hmac des-cbc-crc 
des-cbc-md5
;&#160;&#160;&#160; permitted_enctypes = aes256-cts-hmac-sha1-96 rc4-hmac des-cbc-crc 
des-cbc-md5

[realms]
 &#160;&#160;&#160; STEMARIE-AIZENAY.LOCAL = {
 &#160;&#160;&#160;&#160;&#160;&#160;&#160; kdc = srv-ad.stemarie-aizenay.local
 &#160;&#160;&#160;&#160;&#160;&#160;&#160; admin_server = srv-ad.stemarie-aizenay.local
 &#160;&#160;&#160;&#160;&#160;&#160;&#160; default_domain = stemarie-aizenay.local
 &#160;&#160;&#160; }

[domain_realm]
 &#160;&#160;&#160; .stemarie-aizenay.local = STEMARIE-AIZENAY.LOCAL
 &#160;&#160;&#160; stemarie-aizenay.local = STEMARIE-AIZENAY.LOCAL

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="025400.html">[squid-users] Squid Dual HTTP &amp; SOCKS Set-Up
</A></li>
	<LI>Next message (by thread): <A HREF="025403.html">[squid-users] Update from Squid 4 to Squid 5 :
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25402">[ date ]</a>
              <a href="thread.html#25402">[ thread ]</a>
              <a href="subject.html#25402">[ subject ]</a>
              <a href="author.html#25402">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
