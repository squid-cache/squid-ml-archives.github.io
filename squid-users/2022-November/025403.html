<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Update from Squid 4 to Squid 5 :
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Update%20from%20Squid%204%20to%20Squid%205%20%3A&In-Reply-To=%3C56ec5a8c-a171-26bd-6c55-36e75561d971%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="025402.html">
   <LINK REL="Next"  HREF="025404.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Update from Squid 4 to Squid 5 :</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Update%20from%20Squid%204%20to%20Squid%205%20%3A&In-Reply-To=%3C56ec5a8c-a171-26bd-6c55-36e75561d971%40treenet.co.nz%3E"
       TITLE="[squid-users] Update from Squid 4 to Squid 5 :">squid3 at treenet.co.nz
       </A><BR>
    <I>Thu Nov 10 13:10:16 UTC 2022</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="025402.html">[squid-users] Update from Squid 4 to Squid 5 :
</A></li>
        <LI>Next message (by thread): <A HREF="025404.html">[squid-users] Squid ssl_bump configuration optimized for highest CPS?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25403">[ date ]</a>
              <a href="thread.html#25403">[ thread ]</a>
              <a href="subject.html#25403">[ subject ]</a>
              <a href="author.html#25403">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 10/11/2022 4:50 am, Bertrand Friconneau wrote:
&gt;<i> Hi Everyone,
</I>&gt;<i>
</I>&gt;<i> I've got Squid 4.10 on Ubuntu 20.10 LTS
</I>&gt;<i>
</I>&gt;<i> I try to upgrade my server to Ubuntu 22.04 LTS
</I>&gt;<i>
</I>&gt;<i> But the users couldn't get internet no more.
</I>&gt;<i>
</I>&gt;<i> Here is the log in /var/log/squid/access.log :
</I>&gt;<i> 1668004454.050&#160;&#160;&#160;&#160;&#160; 0 172.22.200.1 TCP_DENIED/407 3951 CONNECT 
</I>&gt;<i> drive.google.com:443 - HIER_NONE/- text/html
</I>&gt;<i> 1668004454.052&#160;&#160;&#160;&#160;&#160; 0 172.22.200.1 TCP_DENIED/407 3951 CONNECT 
</I>&gt;<i> drive.google.com:443 - HIER_NONE/- text/html
</I>&gt;<i> 1668004454.057&#160;&#160;&#160;&#160;&#160; 0 172.22.200.1 TCP_DENIED/407 3951 CONNECT 
</I>&gt;<i> drive.google.com:443 - HIER_NONE/- text/html
</I>&gt;<i> 1668004454.063&#160;&#160;&#160;&#160;&#160; 1 172.22.200.1 TCP_DENIED/407 4454 CONNECT 
</I>&gt;<i> drive.google.com:443 - HIER_NONE/- text/html
</I>&gt;<i> 1668004454.076&#160;&#160;&#160;&#160; 10 172.22.200.1 NONE_NONE/500 0 CONNECT 
</I>&gt;<i> drive.google.com:443 infoe HIER_NONE/- -
</I>&gt;<i>
</I>&gt;<i> And on the client :
</I>&gt;<i> ERR_TUNNEL_CONNECTION_FAILED
</I>&gt;<i>
</I>&gt;<i> According to this page : 
</I>&gt;<i> <A HREF="https://wiki.squid-cache.org/ConfigExamples/Authenticate/Ntlm">https://wiki.squid-cache.org/ConfigExamples/Authenticate/Ntlm</A>
</I>&gt;<i> The cause is due to challenge-response process of NTLM
</I>&gt;<i>
</I>&gt;<i> How can I solve it ?
</I>&gt;<i>
</I>&gt;<i> Regards
</I>&gt;<i>
</I>&gt;<i> Bertrand Friconneau
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> ------------------------------------------------------------------------------------------------------------------------------------------------------- 
</I>&gt;<i>
</I>&gt;<i> Here is my config file of squid :
</I>&gt;<i>
</I>&gt;<i> dns_v4_first on
</I>&gt;<i> visible_hostname squid
</I>
Please use an actual FQDN hostname. This is the proxies &quot;visible&quot; 
hostname - eg sent as the domain name for URLs in error pages etc.

&gt;<i>
</I>&gt;<i> error_directory /usr/share/squid/errors/French
</I>
These days it would be better to use:

 &#160; error_default_language fr

or at least
 &#160; error_directory /usr/share/squid-langpack/fr

&gt;<i>
</I>&gt;<i> auth_param ntlm program /usr/bin/ntlm_auth 
</I>&gt;<i> --helper-protocol=squid-2.5-ntlmssp
</I>&gt;<i> auth_param ntlm children 250
</I>&gt;<i> auth_param ntlm keep_alive off
</I>&gt;<i>
</I>...

&gt;<i> http_access deny !Safe_ports
</I>&gt;<i>
</I>&gt;<i> http_access deny CONNECT !SSL_ports
</I>&gt;<i>
</I>&gt;<i> http_access allow localhost manager
</I>
or maybe limit manager access to administrationzone

&gt;<i> http_access deny manager
</I>&gt;<i>
</I>
custom access policy rules should be down here:

&gt;<i> http_access allow sitebypass
</I>&gt;<i> http_access deny tor
</I>&gt;<i> http_access deny url_exe
</I>
&gt;<i> http_access allow administrationzone
</I>&gt;<i> #http_access allow pedagozone
</I>&gt;<i> #http_access allow xibozone
</I>
All these below are of the same ACL type and all &quot;allow&quot; actions.
Therefore you can combine them into one ACL definition.

&gt;<i> http_access allow informatiquezone
</I>&gt;<i> http_access allow secuzone
</I>&gt;<i> http_access allow srvzone
</I>
&gt;<i> http_access allow ntlm
</I>
What about invalid logins, missing logins etc?
We highly recommend that the line triggering auth is a &quot;deny&quot; policy to 
reject all those.

 &#160;&#160; http_access deny !ntlm

... then you allow what can be done by logged in accounts.

 &#160; http_access allow localnet
or
 &#160;http_access allow all


You may see a behaviour difference with this change to how Squid handles 
the login.
After doing it, of the problem continues try to get some debug 
information from the auth helper to see what it is getting from the 
client and why that is not being accepted.


PS. Since you have Kerberos available, please consider moving away from 
NTLM to using Negotiate/Kerberos auth. It has both better security and 
far better performance for the proxy.

Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="025402.html">[squid-users] Update from Squid 4 to Squid 5 :
</A></li>
	<LI>Next message (by thread): <A HREF="025404.html">[squid-users] Squid ssl_bump configuration optimized for highest CPS?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25403">[ date ]</a>
              <a href="thread.html#25403">[ thread ]</a>
              <a href="subject.html#25403">[ subject ]</a>
              <a href="author.html#25403">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
