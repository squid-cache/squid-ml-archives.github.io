<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid ssl_bump configuration optimized for highest CPS?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20ssl_bump%20configuration%20optimized%20for%0A%20highest%20CPS%3F&In-Reply-To=%3C76535017-e90e-5baf-3ab7-e2afcb4ff9a7%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="025404.html">
   <LINK REL="Next"  HREF="025405.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid ssl_bump configuration optimized for highest CPS?</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20ssl_bump%20configuration%20optimized%20for%0A%20highest%20CPS%3F&In-Reply-To=%3C76535017-e90e-5baf-3ab7-e2afcb4ff9a7%40treenet.co.nz%3E"
       TITLE="[squid-users] Squid ssl_bump configuration optimized for highest CPS?">squid3 at treenet.co.nz
       </A><BR>
    <I>Fri Nov 11 15:52:32 UTC 2022</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="025404.html">[squid-users] Squid ssl_bump configuration optimized for highest CPS?
</A></li>
        <LI>Next message (by thread): <A HREF="025405.html">[squid-users] squid 5.7: can't access https://www.ilo.org/global/lang--en/index.htm with enabled sslbump, without sslbump it works
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25406">[ date ]</a>
              <a href="thread.html#25406">[ thread ]</a>
              <a href="subject.html#25406">[ subject ]</a>
              <a href="author.html#25406">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 11/11/2022 5:38 am, Andralojc, Wojciech wrote:
&gt;<i>
</I>&gt;<i> Hi,
</I>&gt;<i>
</I>&gt;<i> I&#8217;m running squid v4.13 in TLS bump mode.
</I>&gt;<i>
</I>&gt;<i> Trying to configure it to get highest (single core) CPS (new TLS 
</I>&gt;<i> sessions/connections per second) numbers.
</I>&gt;<i>
</I>&gt;<i> I run multiple s_time tests on client side and &#8220;plain&#8221; nginx on server 
</I>&gt;<i> side.
</I>&gt;<i>
</I>&gt;<i> Example s_time command line:
</I>&gt;<i>
</I>&gt;<i> openssl s_time -connect server:443 -new -cipher AES128-GCM-SHA256 
</I>&gt;<i> -time 30 -CAfile /opt/proxy_rootCA.pem -tls1_2
</I>&gt;<i>
</I>&gt;<i> Could you please review config below and suggest changes to improve 
</I>&gt;<i> performance?
</I>&gt;<i>
</I>
FYI; If this config you have shown is intended to go into production, 
then I would suggest not using Squid at all.
Without logging, decryption, nor policy rules there is no benefit to 
using Squid.

You would have better efficiency using NAT to redirect the traffic.


&gt;<i> Assumptions:
</I>&gt;<i>
</I>&gt;<i>   * SSL bump/transparent SSL proxy;
</I>&gt;<i>
</I>
Which definition of &quot;transparent&quot; do you mean exactly?
 &#160;* The HTTP definition where it means a proxy does not alter the traffic?
 &#160;* or the colloquial use where it means intercepting and filtering traffic?

Your provided config looks like it is trying to do both.

&gt;<i>  *
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>   * single core performance;
</I>&gt;<i>   * caching disabled;
</I>&gt;<i>   * persistent connections disabled;
</I>&gt;<i>   * no logs;
</I>&gt;<i>
</I>
The last three of those assumptions are debatable.

* the use of a proxy naturally adds some amount of latency to traffic. 
Caching is one of the major mechanisms used in HTTP to counter this cost 
and when possible exceed it for extra performance. Whether it is useful 
depends on how much (if any) of your traffic is cacheable.

* persistence connections are how HTTP (and HTTPS) avoid TCP connection 
setup latency costs. Disabling is generally a loss of performance, but 
some specific situations can benefit from it.
One of the things you should absolutely do is test is what impact 
persistence has on your proxy performance, on each of the client/server 
connection types independently.

* logging is a very minor impact. Processing the HTTP messages is by far 
the largest part of Squid performance costs.
That said;
 &#160; - store.log is almost always useless so that is OFF by default nowdays.
 &#160; - access.log is minor work, it can be disabled for a trivial 
reduction in CPU cycles at cost of not being able to see what clients 
are doing with the proxy.


&gt;<i> http_access deny !Safe_ports
</I>&gt;<i>
</I>&gt;<i> http_access deny CONNECT !SSL_ports
</I>&gt;<i>
</I>&gt;<i> http_access allow localhost manager
</I>&gt;<i>
</I>&gt;<i> http_access deny manager
</I>&gt;<i>
</I>&gt;<i> http_access allow localnet
</I>&gt;<i>
</I>&gt;<i> http_access allow localhost
</I>&gt;<i>
</I>&gt;<i> http_access allow all
</I>&gt;<i>
</I>
You now have an open-proxy.


&gt;<i> # Squid normally listens to port 3128
</I>&gt;<i>
</I>&gt;<i> http_port 3128
</I>&gt;<i>
</I>&gt;<i> http_port 3129 intercept
</I>&gt;<i>
</I>&gt;<i> ssl_bump server-first all
</I>&gt;<i>
</I>
&quot;server-first&quot; is deprecated.
Instead please use the new syntax:

 &#160; acl step1 at_step SslBump1
 &#160; ssl_bump peek step1
 &#160; ssl_bump splice all

&gt;<i> https_port 3130 intercept ssl-bump cert=/etc/ssl/certs//rootCA.pem 
</I>&gt;<i> generate-host-certificates=on
</I>&gt;<i>
</I>

&gt;<i> visible_hostname &quot;proxy&quot;
</I>&gt;<i>
</I>
This should be an externally resolvable FQDN and not quoted.

&gt;<i> tls_outgoing_options cafile=/etc/ssl/certs//nginx.pem
</I>&gt;<i>
</I>&gt;<i> access_log none
</I>&gt;<i>
</I>&gt;<i> cache_store_log none
</I>&gt;<i>
</I>
Not needed, cache_store_log default is disabled anyway.

&gt;<i> cache_log /dev/null
</I>&gt;<i>
</I>
cache_log is not optional. If Squid has problems serving traffic that is 
your only source of information about what happened.
To minimize what gets logged use this instead:

 &#160; debug_options ALL,0

&gt;<i> workers 1
</I>&gt;<i>
</I>
If you have a multi-core machine this is not enough. You may also need 
CPU affinity to lock the Squid processes to one core.
see &lt;<A HREF="http://www.squid-cache.org/Doc/config/cpu_affinity_map/">http://www.squid-cache.org/Doc/config/cpu_affinity_map/</A>&gt;


&gt;<i> cache deny all
</I>&gt;<i>
</I>&gt;<i> cache_mem 0
</I>&gt;<i>
</I>
Okay, but if you have any plain-text or decrypted messages handled by 
Squid at least some memory cache can have performance benefits.
This is something you should definitely test, measure, tune to see what 
works best on your specific traffic.

&gt;<i> server_persistent_connections off
</I>&gt;<i>
</I>&gt;<i> client_persistent_connections off
</I>&gt;<i>
</I>
See above.


HTH
Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="025404.html">[squid-users] Squid ssl_bump configuration optimized for highest CPS?
</A></li>
	<LI>Next message (by thread): <A HREF="025405.html">[squid-users] squid 5.7: can't access https://www.ilo.org/global/lang--en/index.htm with enabled sslbump, without sslbump it works
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25406">[ date ]</a>
              <a href="thread.html#25406">[ thread ]</a>
              <a href="subject.html#25406">[ subject ]</a>
              <a href="author.html#25406">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
