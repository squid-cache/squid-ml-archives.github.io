<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] moving squid from centos 7 to ubuntu 22.04
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20moving%20squid%20from%20centos%207%20to%20ubuntu%2022.04&In-Reply-To=%3C51294f1b-3c4b-73d0-d345-1773bc75cd58%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="025419.html">
   <LINK REL="Next"  HREF="025425.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] moving squid from centos 7 to ubuntu 22.04</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20moving%20squid%20from%20centos%207%20to%20ubuntu%2022.04&In-Reply-To=%3C51294f1b-3c4b-73d0-d345-1773bc75cd58%40treenet.co.nz%3E"
       TITLE="[squid-users] moving squid from centos 7 to ubuntu 22.04">squid3 at treenet.co.nz
       </A><BR>
    <I>Thu Nov 17 06:06:58 UTC 2022</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="025419.html">[squid-users] moving squid from centos 7 to ubuntu 22.04
</A></li>
        <LI>Next message (by thread): <A HREF="025425.html">[squid-users] moving squid from centos 7 to ubuntu 22.04
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25424">[ date ]</a>
              <a href="thread.html#25424">[ thread ]</a>
              <a href="subject.html#25424">[ subject ]</a>
              <a href="author.html#25424">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 16/11/2022 6:31 am, robert k Wild wrote:
&gt;<i> hi all,
</I>&gt;<i>
</I>&gt;<i> atm i have written a script, once you have built a centos 7 VM, you 
</I>&gt;<i> just run the script and after the reboot its a complete running 
</I>&gt;<i> squidclamAV server
</I>&gt;<i>
</I>&gt;<i> i'm going to be moving the script to a ubuntu server as centos 7 is 
</I>&gt;<i> dead now (as i run clamAV on it, clamAV will stop getting virus 
</I>&gt;<i> definitions 2024 as i use this for virus scanning of internet packets)
</I>&gt;<i>
</I>&gt;<i> just want to know what lines i need to adjust to work with ubuntu 
</I>&gt;<i> instead of centos, obviously i know instead of yum install.... its apt 
</I>&gt;<i> install
</I>&gt;<i>
</I>
My comments below assume that you want to keep the exact versions as-is 
and custom build.

Otherwise, if you are okay following Ubuntu's official packages and 
security fixes things could be a lot different (and simpler).


&gt;<i> heres my long script
</I>&gt;<i>
</I>&gt;<i> #!/bin/bash
</I>&gt;<i> #
</I>&gt;<i> #this script will download/install and configure the following packages
</I>&gt;<i> #
</I>&gt;<i> #squid - proxy server
</I>&gt;<i> #squid ssl bump - intercept HTTPS traffic
</I>&gt;<i> #clamAV - antivirus engine inc trojans,viruses,malware
</I>&gt;<i> #c-icap - icap server
</I>&gt;<i> #squidclamav - that integrates all the above in squid
</I>
You may not be aware squidclamav has been replaced with eCAP ClamAV module:
&lt;<A HREF="https://www.e-cap.org/downloads/">https://www.e-cap.org/downloads/</A>&gt;

Ubuntu provides libecap package and Squid has support auto-enabled for it.
So all you should need to do is build the ecap-clamav adaptor and 
configure it for use.


&gt;<i> #whitelist URL's
</I>&gt;<i> #deny MIME types
</I>&gt;<i> #
</I>&gt;<i> #on the PROD host you only need squid
</I>&gt;<i> #
</I>&gt;<i> #first things first lets disable firewalld and SElinux
</I>&gt;<i> #
</I>&gt;<i> systemctl stop firewalld
</I>&gt;<i> systemctl disable firewalld
</I>&gt;<i> sed -i -e 's/SELINUX=enforcing/SELINUX=disabled/g' /etc/selinux/config
</I>&gt;<i> #
</I>&gt;<i> #squid packages
</I>&gt;<i> #
</I>&gt;<i> yum install -y epel-release screen rsync net-tools ethtool swaks sed 
</I>&gt;<i> tar zip unzip curl telnet openssl openssl-devel bzip2-devel libarchive 
</I>&gt;<i> libarchive-devel perl perl-Data-Dumper gcc gcc-c++ binutils autoconf 
</I>&gt;<i> automake make sudo wget libxml2-devel libcap-devel libtool-ltdl-devel
</I>&gt;<i> #
</I>
Drop &quot;epel-release&quot; as irrelevant on Ubuntu.

Ubuntu developer packages have &quot;-dev&quot; suffix instead of &quot;-devel&quot;. So all 
those should change.

To get access to simpler source building I recommend altering the apt 
configuration like so:

 &#160;&#160;&#160; sudo sed --in-place -E 's/# (deb-src.*updates main)/&#160; \1/g' 
/etc/apt/sources.list
 &#160;&#160;&#160; sudo apt-get --quiet=2 update


There are some trivial package naming differences. When apt complains 
about not finding a package you can use
&lt;<A HREF="https://packages.ubuntu.com/search">https://packages.ubuntu.com/search</A>&gt; to search for the Ubuntu naming 
and/or any alternatives.


Many of those are not related to Squid in any way. Perhapse separate 
them into a different install command?

After the above deb-src change the packages needed to build Squid for 
Ubuntu can be installed like so:

 &#160;&#160;&#160; sudo apt-get --quiet=2 build-dep squid

Similar commands also for clamav, c-icap any others which Ubuntu 
provides packages for.

After that build-dep command you only need to install dependencies if 
the Ubuntu package lacks support.
For example, Ubuntu older than 21.10 lack openssl natively, so &quot;apt 
install libssl-dev&quot; may be needed specially.


&gt;<i> #clamAV packages
</I>&gt;<i> #
</I>&gt;<i> yum install -y clamav-server clamav-data clamav-update 
</I>&gt;<i> clamav-filesystem clamav clamav-scanner-systemd clamav-devel 
</I>&gt;<i> clamav-lib clamav-server-systemd
</I>&gt;<i> #
</I>

&gt;<i> #download and compile from source
</I>&gt;<i> #
</I>&gt;<i> cd /tmp
</I>&gt;<i> wget <A HREF="http://www.squid-cache.org/Versions/v4/squid-4.17.tar.gz">http://www.squid-cache.org/Versions/v4/squid-4.17.tar.gz</A>
</I>&gt;<i> wget 
</I>&gt;<i> <A HREF="http://sourceforge.net/projects/c-icap/files/c-icap/0.5.x/c_icap-0.5.10.tar.gz">http://sourceforge.net/projects/c-icap/files/c-icap/0.5.x/c_icap-0.5.10.tar.gz</A> 
</I>&gt;<i> --no-check-certificate
</I>&gt;<i> wget 
</I>&gt;<i> <A HREF="http://sourceforge.net/projects/c-icap/files/c-icap-modules/0.5.x/c_icap_modules-0.5.5.tar.gz">http://sourceforge.net/projects/c-icap/files/c-icap-modules/0.5.x/c_icap_modules-0.5.5.tar.gz</A> 
</I>&gt;<i> --no-check-certificate
</I>&gt;<i> wget 
</I>&gt;<i> <A HREF="https://sourceforge.net/projects/squidclamav/files/squidclamav/7.1/squidclamav-7.1.tar.gz">https://sourceforge.net/projects/squidclamav/files/squidclamav/7.1/squidclamav-7.1.tar.gz</A> 
</I>&gt;<i> --no-check-certificate
</I>&gt;<i> #
</I>&gt;<i> for f in *.tar.gz; do tar xf &quot;$f&quot;; done
</I>&gt;<i> #
</I>&gt;<i> cd /tmp/squid-4.17
</I>&gt;<i> ./configure --with-openssl --enable-ssl-crtd --enable-icap-client 
</I>&gt;<i> --enable-http-violations &amp;&amp; make &amp;&amp; make install
</I>
The prefix can be a bit different on Debian/Ubuntu. To ensure it is 
right add --prefix=/usr/local to the above options.


&gt;<i> #
</I>&gt;<i> cd /tmp/c_icap-0.5.10
</I>&gt;<i> ./configure 'CXXFLAGS=-O2 -m64 -pipe' 'CFLAGS=-O2 -m64 -pipe' 
</I>&gt;<i> --without-bdb --prefix=/usr/local &amp;&amp; make &amp;&amp; make install
</I>&gt;<i> #
</I>&gt;<i> cd /tmp/squidclamav-7.1
</I>&gt;<i> ./configure 'CXXFLAGS=-O2 -m64 -pipe' 'CFLAGS=-O2 -m64 -pipe' 
</I>&gt;<i> --with-c-icap=/usr/local --with-libarchive &amp;&amp; make &amp;&amp; make install
</I>&gt;<i> #
</I>&gt;<i> cd /tmp/c_icap_modules-0.5.5
</I>&gt;<i> ./configure 'CFLAGS=-O3 -m64 -pipe' 
</I>&gt;<i> 'CPPFLAGS=-I/usr/local/clamav/include' 'LDFLAGS=-L/usr/local/lib 
</I>&gt;<i> -L/usr/local/clamav/lib/' &amp;&amp; make &amp;&amp; make install
</I>&gt;<i> #
</I>&gt;<i> #creating shortcuts and copying files
</I>&gt;<i> #
</I>&gt;<i> cp -f /usr/local/squid/etc/squid.conf /usr/local/squid/etc/squid.conf.orig
</I>&gt;<i> cp -f /usr/local/etc/c-icap.conf /usr/local/etc/c-icap.conf.orig
</I>&gt;<i> cp -f /usr/local/etc/squidclamav.conf /usr/local/etc/squidclamav.conf.orig
</I>&gt;<i> cp -f /usr/local/etc/clamav_mod.conf /usr/local/etc/clamav_mod.conf.orig
</I>&gt;<i> cp -f /usr/local/etc/virus_scan.conf /usr/local/etc/virus_scan.conf.orig
</I>&gt;<i> #
</I>&gt;<i> ln -s /usr/local/squid/etc/squid.conf /etc
</I>&gt;<i> ln -s /usr/local/etc/c-icap.conf /etc
</I>&gt;<i> ln -s /usr/local/etc/squidclamav.conf /etc
</I>&gt;<i> ln -s /usr/local/etc/clamav_mod.conf /etc
</I>&gt;<i> ln -s /usr/local/etc/virus_scan.conf /etc
</I>&gt;<i> #
</I>&gt;<i> mkdir -p /usr/local/clamav/share/clamav
</I>&gt;<i> ln -s /var/lib/clamav /usr/local/clamav/share/clamav
</I>&gt;<i> #
</I>&gt;<i> #tmpfiles for run files
</I>&gt;<i> #
</I>&gt;<i> echo &quot;d /var/run/c-icap 0755 root root -&quot; &gt;&gt; /etc/tmpfiles.d/c-icap.conf
</I>&gt;<i> echo &quot;d /var/run/clamav 0755 root root -&quot; &gt;&gt; /etc/tmpfiles.d/clamav.conf
</I>&gt;<i> #
</I>&gt;<i> #original squid config
</I>&gt;<i> #
</I>&gt;<i> sed -i '/http_port 3128/d' /usr/local/squid/etc/squid.conf
</I>&gt;<i> sed -i -e 's%http_access deny !Safe_ports%#http_access deny 
</I>&gt;<i> !Safe_ports%g' /usr/local/squid/etc/squid.conf
</I>&gt;<i> sed -i -e 's%http_access deny CONNECT !SSL_ports%#http_access deny 
</I>&gt;<i> CONNECT !SSL_ports%g' /usr/local/squid/etc/squid.conf
</I>
Reason? this opens a large number of security vulnerabilities.


Modern Squid have an &quot;include&quot; directive to import extra squid.conf 
rules from other files and/or directories.
I recommend adding this one line to squid.conf under where it says 
&quot;|INSERT YOUR OWN RULE(S) HERE TO ALLOW ACCESS FROM YOUR CLIENTS&quot;|:

|<i>include /etc/squid/conf.d/*.conf|
</I>
then placing all your custom Squid files in that conf.d directory.


&gt;<i> #
</I>&gt;<i> #create URL, MIME and public key list
</I>&gt;<i> #
</I>&gt;<i> echo &quot;#eicar&quot; &gt;&gt; /usr/local/squid/etc/urlwhite.txt
</I>&gt;<i> echo &quot;.eicar.org &lt;<A HREF="http://eicar.org">http://eicar.org</A>&gt;&quot; &gt;&gt; /usr/local/squid/etc/urlwhite.txt
</I>&gt;<i> #
</I>&gt;<i> echo &quot;<A HREF="http://updater.maxon.net/server_test">http://updater.maxon.net/server_test</A>&quot; &gt;&gt; 
</I>&gt;<i> /usr/local/squid/etc/urlspecial.txt
</I>&gt;<i> #
</I>&gt;<i> echo &quot;application/octet-stream&quot; &gt;&gt; /usr/local/squid/etc/mimedeny.txt
</I>&gt;<i> echo &quot;application/x-msi&quot; &gt;&gt; /usr/local/squid/etc/mimedeny.txt
</I>&gt;<i> echo &quot;application/zip&quot; &gt;&gt; /usr/local/squid/etc/mimedeny.txt
</I>&gt;<i> echo &quot;application/x-7z-compressed&quot; &gt;&gt; /usr/local/squid/etc/mimedeny.txt
</I>&gt;<i> echo &quot;application/vnd.ms-cab-compressed&quot; &gt;&gt; 
</I>&gt;<i> /usr/local/squid/etc/mimedeny.txt
</I>&gt;<i> echo &quot;application/x-msdownload&quot; &gt;&gt; /usr/local/squid/etc/mimedeny.txt
</I>&gt;<i> echo &quot;application/x-iso9660-image&quot; &gt;&gt; /usr/local/squid/etc/mimedeny.txt
</I>
FWIW: squid config files are all agnostic to whitespace indentation. So 
you should be able to improve script readability like this:

 &#160;echo &quot;
 &#160;&#160; blah
 &#160;&#160; blah
 &#160;&#160; blah
 &#160;&#160; blah
&quot; &gt;&gt; path/to/file


Also, I see that you are adding systemd integration for the other software.
There is a file in squid tarball at tools/systemd/squid.service that can 
be installed to add that.
You will need to adjust the binary paths inside it to your custom 
/usr/local ones.

Also, consider using logrotate package to manage the log files instead 
of cron.


HTH
Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="025419.html">[squid-users] moving squid from centos 7 to ubuntu 22.04
</A></li>
	<LI>Next message (by thread): <A HREF="025425.html">[squid-users] moving squid from centos 7 to ubuntu 22.04
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25424">[ date ]</a>
              <a href="thread.html#25424">[ thread ]</a>
              <a href="subject.html#25424">[ subject ]</a>
              <a href="author.html#25424">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
