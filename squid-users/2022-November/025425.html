<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] moving squid from centos 7 to ubuntu 22.04
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20moving%20squid%20from%20centos%207%20to%20ubuntu%2022.04&In-Reply-To=%3CCAGU_CiJ%3DgQU%2B84c4MnWxaN68iE5vri%2BQ9NmqSyL5ODWA25U3qw%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="025424.html">
   <LINK REL="Next"  HREF="025426.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] moving squid from centos 7 to ubuntu 22.04</H1>
    <B>robert k Wild</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20moving%20squid%20from%20centos%207%20to%20ubuntu%2022.04&In-Reply-To=%3CCAGU_CiJ%3DgQU%2B84c4MnWxaN68iE5vri%2BQ9NmqSyL5ODWA25U3qw%40mail.gmail.com%3E"
       TITLE="[squid-users] moving squid from centos 7 to ubuntu 22.04">robertkwild at gmail.com
       </A><BR>
    <I>Thu Nov 17 08:21:07 UTC 2022</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="025424.html">[squid-users] moving squid from centos 7 to ubuntu 22.04
</A></li>
        <LI>Next message (by thread): <A HREF="025426.html">[squid-users] moving squid from centos 7 to ubuntu 22.04
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25425">[ date ]</a>
              <a href="thread.html#25425">[ thread ]</a>
              <a href="subject.html#25425">[ subject ]</a>
              <a href="author.html#25425">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Wow thanks Amos so much for this,

You think if I build it on rocky Linux, it would be easier?

On Thu, 17 Nov 2022, 06:07 Amos Jeffries, &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt; wrote:

&gt;<i> On 16/11/2022 6:31 am, robert k Wild wrote:
</I>&gt;<i> &gt; hi all,
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; atm i have written a script, once you have built a centos 7 VM, you
</I>&gt;<i> &gt; just run the script and after the reboot its a complete running
</I>&gt;<i> &gt; squidclamAV server
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; i'm going to be moving the script to a ubuntu server as centos 7 is
</I>&gt;<i> &gt; dead now (as i run clamAV on it, clamAV will stop getting virus
</I>&gt;<i> &gt; definitions 2024 as i use this for virus scanning of internet packets)
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; just want to know what lines i need to adjust to work with ubuntu
</I>&gt;<i> &gt; instead of centos, obviously i know instead of yum install.... its apt
</I>&gt;<i> &gt; install
</I>&gt;<i> &gt;
</I>&gt;<i>
</I>&gt;<i> My comments below assume that you want to keep the exact versions as-is
</I>&gt;<i> and custom build.
</I>&gt;<i>
</I>&gt;<i> Otherwise, if you are okay following Ubuntu's official packages and
</I>&gt;<i> security fixes things could be a lot different (and simpler).
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; heres my long script
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; #!/bin/bash
</I>&gt;<i> &gt; #
</I>&gt;<i> &gt; #this script will download/install and configure the following packages
</I>&gt;<i> &gt; #
</I>&gt;<i> &gt; #squid - proxy server
</I>&gt;<i> &gt; #squid ssl bump - intercept HTTPS traffic
</I>&gt;<i> &gt; #clamAV - antivirus engine inc trojans,viruses,malware
</I>&gt;<i> &gt; #c-icap - icap server
</I>&gt;<i> &gt; #squidclamav - that integrates all the above in squid
</I>&gt;<i>
</I>&gt;<i> You may not be aware squidclamav has been replaced with eCAP ClamAV module:
</I>&gt;<i> &lt;<A HREF="https://www.e-cap.org/downloads/">https://www.e-cap.org/downloads/</A>&gt;
</I>&gt;<i>
</I>&gt;<i> Ubuntu provides libecap package and Squid has support auto-enabled for it.
</I>&gt;<i> So all you should need to do is build the ecap-clamav adaptor and
</I>&gt;<i> configure it for use.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; #whitelist URL's
</I>&gt;<i> &gt; #deny MIME types
</I>&gt;<i> &gt; #
</I>&gt;<i> &gt; #on the PROD host you only need squid
</I>&gt;<i> &gt; #
</I>&gt;<i> &gt; #first things first lets disable firewalld and SElinux
</I>&gt;<i> &gt; #
</I>&gt;<i> &gt; systemctl stop firewalld
</I>&gt;<i> &gt; systemctl disable firewalld
</I>&gt;<i> &gt; sed -i -e 's/SELINUX=enforcing/SELINUX=disabled/g' /etc/selinux/config
</I>&gt;<i> &gt; #
</I>&gt;<i> &gt; #squid packages
</I>&gt;<i> &gt; #
</I>&gt;<i> &gt; yum install -y epel-release screen rsync net-tools ethtool swaks sed
</I>&gt;<i> &gt; tar zip unzip curl telnet openssl openssl-devel bzip2-devel libarchive
</I>&gt;<i> &gt; libarchive-devel perl perl-Data-Dumper gcc gcc-c++ binutils autoconf
</I>&gt;<i> &gt; automake make sudo wget libxml2-devel libcap-devel libtool-ltdl-devel
</I>&gt;<i> &gt; #
</I>&gt;<i>
</I>&gt;<i> Drop &quot;epel-release&quot; as irrelevant on Ubuntu.
</I>&gt;<i>
</I>&gt;<i> Ubuntu developer packages have &quot;-dev&quot; suffix instead of &quot;-devel&quot;. So all
</I>&gt;<i> those should change.
</I>&gt;<i>
</I>&gt;<i> To get access to simpler source building I recommend altering the apt
</I>&gt;<i> configuration like so:
</I>&gt;<i>
</I>&gt;<i>      sudo sed --in-place -E 's/# (deb-src.*updates main)/  \1/g'
</I>&gt;<i> /etc/apt/sources.list
</I>&gt;<i>      sudo apt-get --quiet=2 update
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> There are some trivial package naming differences. When apt complains
</I>&gt;<i> about not finding a package you can use
</I>&gt;<i> &lt;<A HREF="https://packages.ubuntu.com/search">https://packages.ubuntu.com/search</A>&gt; to search for the Ubuntu naming
</I>&gt;<i> and/or any alternatives.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Many of those are not related to Squid in any way. Perhapse separate
</I>&gt;<i> them into a different install command?
</I>&gt;<i>
</I>&gt;<i> After the above deb-src change the packages needed to build Squid for
</I>&gt;<i> Ubuntu can be installed like so:
</I>&gt;<i>
</I>&gt;<i>      sudo apt-get --quiet=2 build-dep squid
</I>&gt;<i>
</I>&gt;<i> Similar commands also for clamav, c-icap any others which Ubuntu
</I>&gt;<i> provides packages for.
</I>&gt;<i>
</I>&gt;<i> After that build-dep command you only need to install dependencies if
</I>&gt;<i> the Ubuntu package lacks support.
</I>&gt;<i> For example, Ubuntu older than 21.10 lack openssl natively, so &quot;apt
</I>&gt;<i> install libssl-dev&quot; may be needed specially.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; #clamAV packages
</I>&gt;<i> &gt; #
</I>&gt;<i> &gt; yum install -y clamav-server clamav-data clamav-update
</I>&gt;<i> &gt; clamav-filesystem clamav clamav-scanner-systemd clamav-devel
</I>&gt;<i> &gt; clamav-lib clamav-server-systemd
</I>&gt;<i> &gt; #
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; #download and compile from source
</I>&gt;<i> &gt; #
</I>&gt;<i> &gt; cd /tmp
</I>&gt;<i> &gt; wget <A HREF="http://www.squid-cache.org/Versions/v4/squid-4.17.tar.gz">http://www.squid-cache.org/Versions/v4/squid-4.17.tar.gz</A>
</I>&gt;<i> &gt; wget
</I>&gt;<i> &gt;
</I>&gt;<i> <A HREF="http://sourceforge.net/projects/c-icap/files/c-icap/0.5.x/c_icap-0.5.10.tar.gz">http://sourceforge.net/projects/c-icap/files/c-icap/0.5.x/c_icap-0.5.10.tar.gz</A>
</I>&gt;<i> &gt; --no-check-certificate
</I>&gt;<i> &gt; wget
</I>&gt;<i> &gt;
</I>&gt;<i> <A HREF="http://sourceforge.net/projects/c-icap/files/c-icap-modules/0.5.x/c_icap_modules-0.5.5.tar.gz">http://sourceforge.net/projects/c-icap/files/c-icap-modules/0.5.x/c_icap_modules-0.5.5.tar.gz</A>
</I>&gt;<i> &gt; --no-check-certificate
</I>&gt;<i> &gt; wget
</I>&gt;<i> &gt;
</I>&gt;<i> <A HREF="https://sourceforge.net/projects/squidclamav/files/squidclamav/7.1/squidclamav-7.1.tar.gz">https://sourceforge.net/projects/squidclamav/files/squidclamav/7.1/squidclamav-7.1.tar.gz</A>
</I>&gt;<i> &gt; --no-check-certificate
</I>&gt;<i> &gt; #
</I>&gt;<i> &gt; for f in *.tar.gz; do tar xf &quot;$f&quot;; done
</I>&gt;<i> &gt; #
</I>&gt;<i> &gt; cd /tmp/squid-4.17
</I>&gt;<i> &gt; ./configure --with-openssl --enable-ssl-crtd --enable-icap-client
</I>&gt;<i> &gt; --enable-http-violations &amp;&amp; make &amp;&amp; make install
</I>&gt;<i>
</I>&gt;<i> The prefix can be a bit different on Debian/Ubuntu. To ensure it is
</I>&gt;<i> right add --prefix=/usr/local to the above options.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; #
</I>&gt;<i> &gt; cd /tmp/c_icap-0.5.10
</I>&gt;<i> &gt; ./configure 'CXXFLAGS=-O2 -m64 -pipe' 'CFLAGS=-O2 -m64 -pipe'
</I>&gt;<i> &gt; --without-bdb --prefix=/usr/local &amp;&amp; make &amp;&amp; make install
</I>&gt;<i> &gt; #
</I>&gt;<i> &gt; cd /tmp/squidclamav-7.1
</I>&gt;<i> &gt; ./configure 'CXXFLAGS=-O2 -m64 -pipe' 'CFLAGS=-O2 -m64 -pipe'
</I>&gt;<i> &gt; --with-c-icap=/usr/local --with-libarchive &amp;&amp; make &amp;&amp; make install
</I>&gt;<i> &gt; #
</I>&gt;<i> &gt; cd /tmp/c_icap_modules-0.5.5
</I>&gt;<i> &gt; ./configure 'CFLAGS=-O3 -m64 -pipe'
</I>&gt;<i> &gt; 'CPPFLAGS=-I/usr/local/clamav/include' 'LDFLAGS=-L/usr/local/lib
</I>&gt;<i> &gt; -L/usr/local/clamav/lib/' &amp;&amp; make &amp;&amp; make install
</I>&gt;<i> &gt; #
</I>&gt;<i> &gt; #creating shortcuts and copying files
</I>&gt;<i> &gt; #
</I>&gt;<i> &gt; cp -f /usr/local/squid/etc/squid.conf
</I>&gt;<i> /usr/local/squid/etc/squid.conf.orig
</I>&gt;<i> &gt; cp -f /usr/local/etc/c-icap.conf /usr/local/etc/c-icap.conf.orig
</I>&gt;<i> &gt; cp -f /usr/local/etc/squidclamav.conf
</I>&gt;<i> /usr/local/etc/squidclamav.conf.orig
</I>&gt;<i> &gt; cp -f /usr/local/etc/clamav_mod.conf /usr/local/etc/clamav_mod.conf.orig
</I>&gt;<i> &gt; cp -f /usr/local/etc/virus_scan.conf /usr/local/etc/virus_scan.conf.orig
</I>&gt;<i> &gt; #
</I>&gt;<i> &gt; ln -s /usr/local/squid/etc/squid.conf /etc
</I>&gt;<i> &gt; ln -s /usr/local/etc/c-icap.conf /etc
</I>&gt;<i> &gt; ln -s /usr/local/etc/squidclamav.conf /etc
</I>&gt;<i> &gt; ln -s /usr/local/etc/clamav_mod.conf /etc
</I>&gt;<i> &gt; ln -s /usr/local/etc/virus_scan.conf /etc
</I>&gt;<i> &gt; #
</I>&gt;<i> &gt; mkdir -p /usr/local/clamav/share/clamav
</I>&gt;<i> &gt; ln -s /var/lib/clamav /usr/local/clamav/share/clamav
</I>&gt;<i> &gt; #
</I>&gt;<i> &gt; #tmpfiles for run files
</I>&gt;<i> &gt; #
</I>&gt;<i> &gt; echo &quot;d /var/run/c-icap 0755 root root -&quot; &gt;&gt; /etc/tmpfiles.d/c-icap.conf
</I>&gt;<i> &gt; echo &quot;d /var/run/clamav 0755 root root -&quot; &gt;&gt; /etc/tmpfiles.d/clamav.conf
</I>&gt;<i> &gt; #
</I>&gt;<i> &gt; #original squid config
</I>&gt;<i> &gt; #
</I>&gt;<i> &gt; sed -i '/http_port 3128/d' /usr/local/squid/etc/squid.conf
</I>&gt;<i> &gt; sed -i -e 's%http_access deny !Safe_ports%#http_access deny
</I>&gt;<i> &gt; !Safe_ports%g' /usr/local/squid/etc/squid.conf
</I>&gt;<i> &gt; sed -i -e 's%http_access deny CONNECT !SSL_ports%#http_access deny
</I>&gt;<i> &gt; CONNECT !SSL_ports%g' /usr/local/squid/etc/squid.conf
</I>&gt;<i>
</I>&gt;<i> Reason? this opens a large number of security vulnerabilities.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Modern Squid have an &quot;include&quot; directive to import extra squid.conf
</I>&gt;<i> rules from other files and/or directories.
</I>&gt;<i> I recommend adding this one line to squid.conf under where it says
</I>&gt;<i> &quot;|INSERT YOUR OWN RULE(S) HERE TO ALLOW ACCESS FROM YOUR CLIENTS&quot;|:
</I>&gt;<i>
</I>&gt;<i> |include /etc/squid/conf.d/*.conf|
</I>&gt;<i>
</I>&gt;<i> then placing all your custom Squid files in that conf.d directory.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; #
</I>&gt;<i> &gt; #create URL, MIME and public key list
</I>&gt;<i> &gt; #
</I>&gt;<i> &gt; echo &quot;#eicar&quot; &gt;&gt; /usr/local/squid/etc/urlwhite.txt
</I>&gt;<i> &gt; echo &quot;.eicar.org &lt;<A HREF="http://eicar.org">http://eicar.org</A>&gt;&quot; &gt;&gt;
</I>&gt;<i> /usr/local/squid/etc/urlwhite.txt
</I>&gt;<i> &gt; #
</I>&gt;<i> &gt; echo &quot;<A HREF="http://updater.maxon.net/server_test">http://updater.maxon.net/server_test</A>&quot; &gt;&gt;
</I>&gt;<i> &gt; /usr/local/squid/etc/urlspecial.txt
</I>&gt;<i> &gt; #
</I>&gt;<i> &gt; echo &quot;application/octet-stream&quot; &gt;&gt; /usr/local/squid/etc/mimedeny.txt
</I>&gt;<i> &gt; echo &quot;application/x-msi&quot; &gt;&gt; /usr/local/squid/etc/mimedeny.txt
</I>&gt;<i> &gt; echo &quot;application/zip&quot; &gt;&gt; /usr/local/squid/etc/mimedeny.txt
</I>&gt;<i> &gt; echo &quot;application/x-7z-compressed&quot; &gt;&gt; /usr/local/squid/etc/mimedeny.txt
</I>&gt;<i> &gt; echo &quot;application/vnd.ms-cab-compressed&quot; &gt;&gt;
</I>&gt;<i> &gt; /usr/local/squid/etc/mimedeny.txt
</I>&gt;<i> &gt; echo &quot;application/x-msdownload&quot; &gt;&gt; /usr/local/squid/etc/mimedeny.txt
</I>&gt;<i> &gt; echo &quot;application/x-iso9660-image&quot; &gt;&gt; /usr/local/squid/etc/mimedeny.txt
</I>&gt;<i>
</I>&gt;<i> FWIW: squid config files are all agnostic to whitespace indentation. So
</I>&gt;<i> you should be able to improve script readability like this:
</I>&gt;<i>
</I>&gt;<i>   echo &quot;
</I>&gt;<i>     blah
</I>&gt;<i>     blah
</I>&gt;<i>     blah
</I>&gt;<i>     blah
</I>&gt;<i> &quot; &gt;&gt; path/to/file
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Also, I see that you are adding systemd integration for the other software.
</I>&gt;<i> There is a file in squid tarball at tools/systemd/squid.service that can
</I>&gt;<i> be installed to add that.
</I>&gt;<i> You will need to adjust the binary paths inside it to your custom
</I>&gt;<i> /usr/local ones.
</I>&gt;<i>
</I>&gt;<i> Also, consider using logrotate package to manage the log files instead
</I>&gt;<i> of cron.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> HTH
</I>&gt;<i> Amos
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20221117/150716c6/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20221117/150716c6/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="025424.html">[squid-users] moving squid from centos 7 to ubuntu 22.04
</A></li>
	<LI>Next message (by thread): <A HREF="025426.html">[squid-users] moving squid from centos 7 to ubuntu 22.04
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25425">[ date ]</a>
              <a href="thread.html#25425">[ thread ]</a>
              <a href="subject.html#25425">[ subject ]</a>
              <a href="author.html#25425">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
