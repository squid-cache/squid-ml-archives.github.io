<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Scaling concurrent TCP sessions beyond ephemeral port range
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Scaling%20concurrent%20TCP%20sessions%20beyond%20ephemeral%0A%20port%20range&In-Reply-To=%3CCACabJxP4bXq5X-U360NL2v65RQ7o%3D--_h-NxT%3DP6DCygvC87Hg%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="025439.html">
   <LINK REL="Next"  HREF="025451.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Scaling concurrent TCP sessions beyond ephemeral port range</H1>
    <B>Praveen Ponakanti</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Scaling%20concurrent%20TCP%20sessions%20beyond%20ephemeral%0A%20port%20range&In-Reply-To=%3CCACabJxP4bXq5X-U360NL2v65RQ7o%3D--_h-NxT%3DP6DCygvC87Hg%40mail.gmail.com%3E"
       TITLE="[squid-users] Scaling concurrent TCP sessions beyond ephemeral port range">pponakanti at roblox.com
       </A><BR>
    <I>Wed Nov 23 02:06:19 UTC 2022</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="025439.html">[squid-users] does squid 5.7 support HTTP/2 protocol
</A></li>
        <LI>Next message (by thread): <A HREF="025451.html">[squid-users] Scaling concurrent TCP sessions beyond ephemeral port range
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25450">[ date ]</a>
              <a href="thread.html#25450">[ thread ]</a>
              <a href="subject.html#25450">[ subject ]</a>
              <a href="author.html#25450">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Alex,

Do we have a recent squid ver 6 snapshot build available for testing?
Looking for something that includes the patch from the PR to introduce the
ip_bind_address_noport socket option on outbound TCP connections, I dont
see any new builds after Sep 6th.

<A HREF="http://www.squid-cache.org/Versions/v6/">http://www.squid-cache.org/Versions/v6/</A>


We have been using the last commit (prior to merge) from my branch on a few
canary instances and have observed a memory leak with squid 6.0.0.  The
memory usage by squid with that code has grown by almost 20G over the last
2+ months, while other v5.5 squids (with a local patch for adding that
socket option) have not had that significant of an increase.


Thanks for your insights below, apologies for not being able to try your
suggestions until recently. I hadn't looked at the coordinator in depth and
forgotten that squid workers are not threads.
The following config knobs were tried and did not make much of a difference
with respect to concurrent outbound TLS sessions across the workers. The
docs say the default sslproxy_session_cache_size is 2 MB, how high can we
go? Are there any other knobs we can try to improve session reuse for HTTPS
reqs ? (without enabling squid cache)

sslproxy_session_cache_size 10 MB
tls_outgoing_options options=NO_TICKET


&gt;<i> Agree, it might not make sense to increase the complexity with sharing
</I>&gt;<i> &gt; socket among the workers. Was thinking more on the lines of a hashmap
</I>&gt;<i> &gt; that the coordinator could use to pick workers that already have a TCP
</I>&gt;<i> &gt; connection to the destination being requested, instead of having the
</I>&gt;<i> &gt; workers themselves share connection details.
</I>

&gt;<i> Coordinator does not receive/see regular HTTP traffic. If we start
</I>&gt;<i> routing HTTP transactions through that process, it may become the
</I>&gt;<i> bottleneck itself _and_ will introduce additional overheads for passing
</I>&gt;<i> descriptors to workers. From performance point of view, the model with
</I>&gt;<i> one &quot;routing&quot; task doling work to workers works best (and is commonly
</I>&gt;<i> used) in threaded applications, but Squid is not threaded at that level.
</I>&gt;<i>
</I>&gt;<i>
</I>
&gt;<i> &gt; Most of the TCP connections are for HTTPS reqs, w/o TLS termination at
</I>&gt;<i> &gt; the squid. Does squid currently support a TLS session cache ?
</I>&gt;<i>
</I>&gt;<i> Yes, there is some support for worker-specific TLS session caching, with
</I>&gt;<i> directives like sslproxy_session_cache_size, tls_outgoing_options
</I>&gt;<i> options=NO_TICKET (for outgoing sessions IIRC) and https_port
</I>&gt;<i> sslflags=NO_SESSION_REUSE and https_port sslcontext (for incoming
</I>&gt;<i> sessions).
</I>&gt;<i>
</I>
&gt;<i> HTH,
</I>&gt;<i>
</I>&gt;<i> Alex.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt;     If you are dealing with TLS sessions as well, then we should add a
</I>&gt;<i> &gt;     shared memory TLS session cache that all workers can tap into.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     Cheers,
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     Alex.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;      &gt; On Tue, Jun 21, 2022 at 2:11 PM Alex Rousskov wrote:
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt;     On 6/19/22 12:48, Praveen Ponakanti wrote:
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt; What is the process to have this code patch upstreamed for
</I>&gt;<i> &gt;     future
</I>&gt;<i> &gt;      &gt;     squid
</I>&gt;<i> &gt;      &gt;      &gt; versions?
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt;     In short, just post a quality pull request on GitHub (or find
</I>&gt;<i> &gt;     somebody
</I>&gt;<i> &gt;      &gt;     who can guide your code towards official acceptance for you).
</I>&gt;<i> For
</I>&gt;<i> &gt;      &gt;     details, please see
</I>&gt;<i> &gt;     <A HREF="https://wiki.squid-cache.org/MergeProcedure">https://wiki.squid-cache.org/MergeProcedure</A>
</I>&gt;<i> &gt;     &lt;<A HREF="https://wiki.squid-cache.org/MergeProcedure">https://wiki.squid-cache.org/MergeProcedure</A>&gt;
</I>&gt;<i> &gt;      &gt;     &lt;<A HREF="https://wiki.squid-cache.org/MergeProcedure">https://wiki.squid-cache.org/MergeProcedure</A>
</I>&gt;<i> &gt;     &lt;<A HREF="https://wiki.squid-cache.org/MergeProcedure">https://wiki.squid-cache.org/MergeProcedure</A>&gt;&gt;
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt;     Thank you,
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt;     Alex.
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt; On Fri, May 20, 2022 at 9:31 PM Amos Jeffries
</I>&gt;<i> &gt;      &gt;     &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A> &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt;
</I>&gt;<i> &gt;     &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A> &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt;&gt;
</I>&gt;<i> &gt;      &gt;      &gt; wrote:
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;     On 20/05/22 19:44, Praveen Ponakanti wrote:
</I>&gt;<i> &gt;      &gt;      &gt;      &gt; Hi Alex,
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;      &gt; Thanks for going through several steps to help
</I>&gt;<i> mitigate
</I>&gt;<i> &gt;      &gt;     src port
</I>&gt;<i> &gt;      &gt;      &gt;      &gt; exhaustion. We are looking to achieve 400-500% more
</I>&gt;<i> &gt;      &gt;      &gt;      &gt; concurrent connections if we could :) as there is a
</I>&gt;<i> &gt;      &gt;      &gt;     significant buffer
</I>&gt;<i> &gt;      &gt;      &gt;      &gt; on the available CPU.
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;     Then you require at least 4, maybe 5, IP addresses to
</I>&gt;<i> &gt;     handle
</I>&gt;<i> &gt;      &gt;     that many
</I>&gt;<i> &gt;      &gt;      &gt;     concurrent connections with Squid.
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt; We would like to investigate going beyond the ephemeral
</I>&gt;<i> port
</I>&gt;<i> &gt;      &gt;     range for
</I>&gt;<i> &gt;      &gt;      &gt; some specific destination IP:PORT addresses. For that it
</I>&gt;<i> &gt;     appears
</I>&gt;<i> &gt;      &gt;     squid
</I>&gt;<i> &gt;      &gt;      &gt; does not round-robin requests if we use multiple
</I>&gt;<i> &gt;      &gt;     tcp_outgoing_addresses.
</I>&gt;<i> &gt;      &gt;      &gt; We could use ACL&#8217;s to pick a different outbound IP based
</I>&gt;<i> &gt;     on the
</I>&gt;<i> &gt;      &gt;     clients
</I>&gt;<i> &gt;      &gt;      &gt; source IP, however that is not very ideal in our
</I>&gt;<i> &gt;     environment as our
</I>&gt;<i> &gt;      &gt;      &gt; clients aren&#8217;t always equally split by subnet. However, if
</I>&gt;<i> &gt;     we could
</I>&gt;<i> &gt;      &gt;      &gt; split by the client&#8217;s source port that might help achieve
</I>&gt;<i> &gt;     this. For
</I>&gt;<i> &gt;      &gt;      &gt; example something like:
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt; acl pool1 clientport 0-32768
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt; acl pool2 clientport 32769-65536
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt; tcp_outgoing_address 10.1.0.1 pool1
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt; tcp_outgoing_address 10.1.0.2 pool2
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt; Squid's ACLs currently do not allow filtering by the
</I>&gt;<i> &gt;     client's source
</I>&gt;<i> &gt;      &gt;      &gt; port. We could look into a separate patch to add this
</I>&gt;<i> &gt;      &gt;     functionality to
</I>&gt;<i> &gt;      &gt;      &gt; squid&#8217;s ACL code if that makes sense. Or is there a better
</I>&gt;<i> &gt;     way to
</I>&gt;<i> &gt;      &gt;      &gt; achieve this?
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt; Thanks
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt; Praveen
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;      &gt; The option to use multiple tcp_outoing_addresses
</I>&gt;<i> &gt;     appears to be
</I>&gt;<i> &gt;      &gt;      &gt;     promising
</I>&gt;<i> &gt;      &gt;      &gt;      &gt; along with some tweaks to the TCP timeouts. I guess
</I>&gt;<i> we
</I>&gt;<i> &gt;      &gt;     could use
</I>&gt;<i> &gt;      &gt;      &gt;     ACLs to
</I>&gt;<i> &gt;      &gt;      &gt;      &gt; pick a different outbound IP based on the
</I>&gt;<i> &gt;     requesting client's
</I>&gt;<i> &gt;      &gt;      &gt;     prefix. We
</I>&gt;<i> &gt;      &gt;      &gt;      &gt; had not considered that option as the ephemeral
</I>&gt;<i> &gt;     ports were
</I>&gt;<i> &gt;      &gt;     no longer
</I>&gt;<i> &gt;      &gt;      &gt;      &gt; available to other applications when squid uses
</I>&gt;<i> most of
</I>&gt;<i> &gt;      &gt;     them with a
</I>&gt;<i> &gt;      &gt;      &gt;      &gt; single outbound IP configured. We are also looking
</I>&gt;<i> to
</I>&gt;<i> &gt;      &gt;     modify the
</I>&gt;<i> &gt;      &gt;      &gt;     code to
</I>&gt;<i> &gt;      &gt;      &gt;      &gt; use the IP_BIND_ADDRESS_NO_PORT sockopt as that
</I>&gt;<i> &gt;     could help
</I>&gt;<i> &gt;      &gt;     delay
</I>&gt;<i> &gt;      &gt;      &gt;     port
</I>&gt;<i> &gt;      &gt;      &gt;      &gt; assignment with the bind() call on the outbound TCP
</I>&gt;<i> &gt;      &gt;     sessions (to
</I>&gt;<i> &gt;      &gt;      &gt;      &gt; hopefully allow access to the 4-tuple on the
</I>&gt;<i> socket).
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;     Patches welcome.
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;     However, please be aware that use of the 4-tuple is
</I>&gt;<i> &gt;     often no
</I>&gt;<i> &gt;      &gt;     different
</I>&gt;<i> &gt;      &gt;      &gt;     from the 3-tuple since the dst-port is typically
</I>&gt;<i> identical
</I>&gt;<i> &gt;      &gt;     for all
</I>&gt;<i> &gt;      &gt;      &gt;     outgoing traffic to a given dst-IP.
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;     Cheers
</I>&gt;<i> &gt;      &gt;      &gt;     Amos
</I>&gt;<i>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20221122/4a00f4a8/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20221122/4a00f4a8/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="025439.html">[squid-users] does squid 5.7 support HTTP/2 protocol
</A></li>
	<LI>Next message (by thread): <A HREF="025451.html">[squid-users] Scaling concurrent TCP sessions beyond ephemeral port range
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25450">[ date ]</a>
              <a href="thread.html#25450">[ thread ]</a>
              <a href="subject.html#25450">[ subject ]</a>
              <a href="author.html#25450">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
