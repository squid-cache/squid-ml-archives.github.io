<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Scaling concurrent TCP sessions beyond ephemeral port range
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Scaling%20concurrent%20TCP%20sessions%20beyond%20ephemeral%0A%20port%20range&In-Reply-To=%3CCACabJxP_wdxvBqpZPQ1ccqJQKKA9NctOWxZZwzCx2ZXKBh5tYQ%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="025451.html">
   <LINK REL="Next"  HREF="025455.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Scaling concurrent TCP sessions beyond ephemeral port range</H1>
    <B>Praveen Ponakanti</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Scaling%20concurrent%20TCP%20sessions%20beyond%20ephemeral%0A%20port%20range&In-Reply-To=%3CCACabJxP_wdxvBqpZPQ1ccqJQKKA9NctOWxZZwzCx2ZXKBh5tYQ%40mail.gmail.com%3E"
       TITLE="[squid-users] Scaling concurrent TCP sessions beyond ephemeral port range">pponakanti at roblox.com
       </A><BR>
    <I>Wed Nov 23 23:07:01 UTC 2022</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="025451.html">[squid-users] Scaling concurrent TCP sessions beyond ephemeral port range
</A></li>
        <LI>Next message (by thread): <A HREF="025455.html">[squid-users] ubuntu squid - proxy refusing
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25454">[ date ]</a>
              <a href="thread.html#25454">[ thread ]</a>
              <a href="subject.html#25454">[ subject ]</a>
              <a href="author.html#25454">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Alex,

Thanks for all the details. I will build a new squid image off master/v6 to
check for the memory leak with test traffic.
Regarding the TLS session cache, I will try setting it to 100MB. Are there
any stats exposed from the tls session cache that can be monitored to study
the session cache usage with our traffic patterns? Would those be
accessible via the squid-internal-mgr endpoint?
Thanks
Praveen

On Tue, Nov 22, 2022 at 7:58 PM Alex Rousskov &lt;
<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt; wrote:

&gt;<i> On 11/22/22 21:06, Praveen Ponakanti wrote:
</I>&gt;<i>
</I>&gt;<i> &gt; Do we have a recent squid ver 6 snapshot build available for testing?
</I>&gt;<i>
</I>&gt;<i> Sorry, I do not know the exact answer to your question. One can
</I>&gt;<i> certainly build master/v6 from git sources, of course.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; The following config knobs were tried and did not make much of a
</I>&gt;<i> &gt; difference with respect to concurrent outbound TLS sessions across the
</I>&gt;<i> &gt; workers.
</I>&gt;<i>
</I>&gt;<i> I can only speculate that there is a Squid bug that prevents workers
</I>&gt;<i> from using (or sharing) the TLS session cache OR your traffic patterns
</I>&gt;<i> do not allow (much) sharing OR your TLS session cache is too small for
</I>&gt;<i> those traffic patterns. Lot's of possibilities here!
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; The docs say the default sslproxy_session_cache_size is 2 MB,
</I>&gt;<i> &gt; how high can we go?
</I>&gt;<i>
</I>&gt;<i> I have not tested this, but, bugs notwithstanding, I would expect you to
</I>&gt;<i> be able to go as high as the maximum shared memory segment size in your
</I>&gt;<i> environment (e.g., see sysctl kernel.shmax). The entire cache must fit
</I>&gt;<i> into a single shared memory segment IIRC. It certainly does not hurt to
</I>&gt;<i> try 100 MB if you already tried 10 MB. Squid should complain if it
</I>&gt;<i> cannot allocate a segment of the specified size.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; Are there any other knobs we can try to improve
</I>&gt;<i> &gt; session reuse for HTTPS reqs ? (without enabling squid cache)
</I>&gt;<i>
</I>&gt;<i> FWIW, I would try to understand _why_ sessions are not shared (enough)
</I>&gt;<i> in the first place, especially if increasing sslproxy_session_cache_size
</I>&gt;<i> value does not result in session cache hit ratio increase while there
</I>&gt;<i> are still many false cache misses. I do not know whether anybody is
</I>&gt;<i> paying a lot of attention to that cache in production, but the
</I>&gt;<i> corresponding Squid code is not tested by the Squid Project CI (yet?).
</I>&gt;<i>
</I>&gt;<i> Also, there are different kinds of TLS session reuse. It is possible
</I>&gt;<i> that the sessions you want to reuse are not supported by the Squid
</I>&gt;<i> session cache. Unfortunately, I do not remember enough details to tell
</I>&gt;<i> you more, but one can set up a controlled test and see what is actually
</I>&gt;<i> going on.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> HTH,
</I>&gt;<i>
</I>&gt;<i> Alex.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; sslproxy_session_cache_size 10 MB
</I>&gt;<i> &gt; tls_outgoing_options options=NO_TICKET
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     &gt; Agree, it might not make sense to increase the complexity with
</I>&gt;<i> sharing
</I>&gt;<i> &gt;     &gt; socket among the workers. Was thinking more on the lines of a
</I>&gt;<i> hashmap
</I>&gt;<i> &gt;     &gt; that the coordinator could use to pick workers that already have a
</I>&gt;<i> TCP
</I>&gt;<i> &gt;     &gt; connection to the destination being requested, instead of having
</I>&gt;<i> the
</I>&gt;<i> &gt;     &gt; workers themselves share connection details.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     Coordinator does not receive/see regular HTTP traffic. If we start
</I>&gt;<i> &gt;     routing HTTP transactions through that process, it may become the
</I>&gt;<i> &gt;     bottleneck itself _and_ will introduce additional overheads for
</I>&gt;<i> passing
</I>&gt;<i> &gt;     descriptors to workers. From performance point of view, the model
</I>&gt;<i> with
</I>&gt;<i> &gt;     one &quot;routing&quot; task doling work to workers works best (and is commonly
</I>&gt;<i> &gt;     used) in threaded applications, but Squid is not threaded at that
</I>&gt;<i> level.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;      &gt; Most of the TCP connections are for HTTPS reqs, w/o TLS
</I>&gt;<i> &gt;     termination at
</I>&gt;<i> &gt;      &gt; the squid. Does squid currently support a TLS session cache ?
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     Yes, there is some support for worker-specific TLS session caching,
</I>&gt;<i> &gt;     with
</I>&gt;<i> &gt;     directives like sslproxy_session_cache_size, tls_outgoing_options
</I>&gt;<i> &gt;     options=NO_TICKET (for outgoing sessions IIRC) and https_port
</I>&gt;<i> &gt;     sslflags=NO_SESSION_REUSE and https_port sslcontext (for incoming
</I>&gt;<i> &gt;     sessions).
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     HTH,
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     Alex.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;      &gt;     If you are dealing with TLS sessions as well, then we should
</I>&gt;<i> &gt;     add a
</I>&gt;<i> &gt;      &gt;     shared memory TLS session cache that all workers can tap into.
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt;     Cheers,
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt;     Alex.
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt; On Tue, Jun 21, 2022 at 2:11 PM Alex Rousskov wrote:
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;     On 6/19/22 12:48, Praveen Ponakanti wrote:
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;      &gt; What is the process to have this code patch
</I>&gt;<i> &gt;     upstreamed for
</I>&gt;<i> &gt;      &gt;     future
</I>&gt;<i> &gt;      &gt;      &gt;     squid
</I>&gt;<i> &gt;      &gt;      &gt;      &gt; versions?
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;     In short, just post a quality pull request on GitHub
</I>&gt;<i> &gt;     (or find
</I>&gt;<i> &gt;      &gt;     somebody
</I>&gt;<i> &gt;      &gt;      &gt;     who can guide your code towards official acceptance
</I>&gt;<i> &gt;     for you). For
</I>&gt;<i> &gt;      &gt;      &gt;     details, please see
</I>&gt;<i> &gt;      &gt; <A HREF="https://wiki.squid-cache.org/MergeProcedure">https://wiki.squid-cache.org/MergeProcedure</A>
</I>&gt;<i> &gt;     &lt;<A HREF="https://wiki.squid-cache.org/MergeProcedure">https://wiki.squid-cache.org/MergeProcedure</A>&gt;
</I>&gt;<i> &gt;      &gt;     &lt;<A HREF="https://wiki.squid-cache.org/MergeProcedure">https://wiki.squid-cache.org/MergeProcedure</A>
</I>&gt;<i> &gt;     &lt;<A HREF="https://wiki.squid-cache.org/MergeProcedure">https://wiki.squid-cache.org/MergeProcedure</A>&gt;&gt;
</I>&gt;<i> &gt;      &gt;      &gt;     &lt;<A HREF="https://wiki.squid-cache.org/MergeProcedure">https://wiki.squid-cache.org/MergeProcedure</A>
</I>&gt;<i> &gt;     &lt;<A HREF="https://wiki.squid-cache.org/MergeProcedure">https://wiki.squid-cache.org/MergeProcedure</A>&gt;
</I>&gt;<i> &gt;      &gt;     &lt;<A HREF="https://wiki.squid-cache.org/MergeProcedure">https://wiki.squid-cache.org/MergeProcedure</A>
</I>&gt;<i> &gt;     &lt;<A HREF="https://wiki.squid-cache.org/MergeProcedure">https://wiki.squid-cache.org/MergeProcedure</A>&gt;&gt;&gt;
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;     Thank you,
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;     Alex.
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;      &gt; On Fri, May 20, 2022 at 9:31 PM Amos Jeffries
</I>&gt;<i> &gt;      &gt;      &gt;     &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A> &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt;
</I>&gt;<i> &gt;     &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A> &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt;&gt;
</I>&gt;<i> &gt;      &gt;     &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A> &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt;
</I>&gt;<i> &gt;     &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A> &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt;&gt;&gt;
</I>&gt;<i> &gt;      &gt;      &gt;      &gt; wrote:
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;     On 20/05/22 19:44, Praveen Ponakanti wrote:
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt; Hi Alex,
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt; Thanks for going through several steps to
</I>&gt;<i> &gt;     help mitigate
</I>&gt;<i> &gt;      &gt;      &gt;     src port
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt; exhaustion. We are looking to achieve
</I>&gt;<i> &gt;     400-500% more
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt; concurrent connections if we could :) as
</I>&gt;<i> &gt;     there is a
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;     significant buffer
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt; on the available CPU.
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;     Then you require at least 4, maybe 5, IP
</I>&gt;<i> &gt;     addresses to
</I>&gt;<i> &gt;      &gt;     handle
</I>&gt;<i> &gt;      &gt;      &gt;     that many
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;     concurrent connections with Squid.
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;      &gt; We would like to investigate going beyond the
</I>&gt;<i> &gt;     ephemeral port
</I>&gt;<i> &gt;      &gt;      &gt;     range for
</I>&gt;<i> &gt;      &gt;      &gt;      &gt; some specific destination IP:PORT addresses. For
</I>&gt;<i> &gt;     that it
</I>&gt;<i> &gt;      &gt;     appears
</I>&gt;<i> &gt;      &gt;      &gt;     squid
</I>&gt;<i> &gt;      &gt;      &gt;      &gt; does not round-robin requests if we use multiple
</I>&gt;<i> &gt;      &gt;      &gt;     tcp_outgoing_addresses.
</I>&gt;<i> &gt;      &gt;      &gt;      &gt; We could use ACL&#8217;s to pick a different outbound IP
</I>&gt;<i> &gt;     based
</I>&gt;<i> &gt;      &gt;     on the
</I>&gt;<i> &gt;      &gt;      &gt;     clients
</I>&gt;<i> &gt;      &gt;      &gt;      &gt; source IP, however that is not very ideal in our
</I>&gt;<i> &gt;      &gt;     environment as our
</I>&gt;<i> &gt;      &gt;      &gt;      &gt; clients aren&#8217;t always equally split by subnet.
</I>&gt;<i> &gt;     However, if
</I>&gt;<i> &gt;      &gt;     we could
</I>&gt;<i> &gt;      &gt;      &gt;      &gt; split by the client&#8217;s source port that might help
</I>&gt;<i> &gt;     achieve
</I>&gt;<i> &gt;      &gt;     this. For
</I>&gt;<i> &gt;      &gt;      &gt;      &gt; example something like:
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;      &gt; acl pool1 clientport 0-32768
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;      &gt; acl pool2 clientport 32769-65536
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;      &gt; tcp_outgoing_address 10.1.0.1 pool1
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;      &gt; tcp_outgoing_address 10.1.0.2 pool2
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;      &gt; Squid's ACLs currently do not allow filtering by the
</I>&gt;<i> &gt;      &gt;     client's source
</I>&gt;<i> &gt;      &gt;      &gt;      &gt; port. We could look into a separate patch to add
</I>&gt;<i> this
</I>&gt;<i> &gt;      &gt;      &gt;     functionality to
</I>&gt;<i> &gt;      &gt;      &gt;      &gt; squid&#8217;s ACL code if that makes sense. Or is there a
</I>&gt;<i> &gt;     better
</I>&gt;<i> &gt;      &gt;     way to
</I>&gt;<i> &gt;      &gt;      &gt;      &gt; achieve this?
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;      &gt; Thanks
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;      &gt; Praveen
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt; The option to use multiple
</I>&gt;<i> tcp_outoing_addresses
</I>&gt;<i> &gt;      &gt;     appears to be
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;     promising
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt; along with some tweaks to the TCP timeouts.
</I>&gt;<i> &gt;     I guess we
</I>&gt;<i> &gt;      &gt;      &gt;     could use
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;     ACLs to
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt; pick a different outbound IP based on the
</I>&gt;<i> &gt;      &gt;     requesting client's
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;     prefix. We
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt; had not considered that option as the
</I>&gt;<i> ephemeral
</I>&gt;<i> &gt;      &gt;     ports were
</I>&gt;<i> &gt;      &gt;      &gt;     no longer
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt; available to other applications when squid
</I>&gt;<i> &gt;     uses most of
</I>&gt;<i> &gt;      &gt;      &gt;     them with a
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt; single outbound IP configured. We are also
</I>&gt;<i> &gt;     looking to
</I>&gt;<i> &gt;      &gt;      &gt;     modify the
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;     code to
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt; use the IP_BIND_ADDRESS_NO_PORT sockopt as
</I>&gt;<i> that
</I>&gt;<i> &gt;      &gt;     could help
</I>&gt;<i> &gt;      &gt;      &gt;     delay
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;     port
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt; assignment with the bind() call on the
</I>&gt;<i> &gt;     outbound TCP
</I>&gt;<i> &gt;      &gt;      &gt;     sessions (to
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt; hopefully allow access to the 4-tuple on the
</I>&gt;<i> &gt;     socket).
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;     Patches welcome.
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;     However, please be aware that use of the
</I>&gt;<i> 4-tuple is
</I>&gt;<i> &gt;      &gt;     often no
</I>&gt;<i> &gt;      &gt;      &gt;     different
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;     from the 3-tuple since the dst-port is
</I>&gt;<i> &gt;     typically identical
</I>&gt;<i> &gt;      &gt;      &gt;     for all
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;     outgoing traffic to a given dst-IP.
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;     Cheers
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;     Amos
</I>&gt;<i> &gt;
</I>&gt;<i>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20221123/7d1bc55e/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20221123/7d1bc55e/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="025451.html">[squid-users] Scaling concurrent TCP sessions beyond ephemeral port range
</A></li>
	<LI>Next message (by thread): <A HREF="025455.html">[squid-users] ubuntu squid - proxy refusing
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25454">[ date ]</a>
              <a href="thread.html#25454">[ thread ]</a>
              <a href="subject.html#25454">[ subject ]</a>
              <a href="author.html#25454">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
