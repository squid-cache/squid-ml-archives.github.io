<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] tcp_outgoing_address directive ignored, data goes out on default gateway
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20tcp_outgoing_address%20directive%20ignored%2C%0A%20data%20goes%20out%20on%20default%20gateway&In-Reply-To=%3C499c9974-1089-37b0-fcc0-b1376b1ffb8a%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="025460.html">
   <LINK REL="Next"  HREF="025473.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] tcp_outgoing_address directive ignored, data goes out on default gateway</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20tcp_outgoing_address%20directive%20ignored%2C%0A%20data%20goes%20out%20on%20default%20gateway&In-Reply-To=%3C499c9974-1089-37b0-fcc0-b1376b1ffb8a%40treenet.co.nz%3E"
       TITLE="[squid-users] tcp_outgoing_address directive ignored, data goes out on default gateway">squid3 at treenet.co.nz
       </A><BR>
    <I>Sun Nov 27 13:55:45 UTC 2022</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="025460.html">[squid-users] tcp_outgoing_address directive ignored, data goes out on default gateway
</A></li>
        <LI>Next message (by thread): <A HREF="025473.html">[squid-users] tcp_outgoing_address directive ignored, data goes out on default gateway
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25462">[ date ]</a>
              <a href="thread.html#25462">[ thread ]</a>
              <a href="subject.html#25462">[ subject ]</a>
              <a href="author.html#25462">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 26/11/2022 11:49 pm, N wrote:
&gt;<i> Hi,
</I>&gt;<i> I'm trying to use tcp_outgoing_address to forward traffic from 
</I>&gt;<i> specific users to a specific interface.
</I>&gt;<i>
</I>&gt;<i> running squid 5.7 (on openwrt).
</I>&gt;<i> have a few interfaces on my machine, two of which are VPN interfaces 
</I>&gt;<i> with IPs (internal) 10.200.0.70 &#160;and10.102.237.50.
</I>&gt;<i> trying to forward user &quot;uk&quot; to the interface with IP 10.200.0.70 is 
</I>&gt;<i> &quot;ignored&quot; - I can see that the default WAN interface is used. I see it 
</I>&gt;<i> by using a simple &quot;what is my ip&quot; test when using the proxy, and 
</I>&gt;<i> checking the traffic of the interfaces when sending requests.
</I>&gt;<i>
</I>&gt;<i> the relevant excerpt from the squid conf:
</I>&gt;<i> acl auth_users proxy_auth REQUIRED
</I>
First possibility:

 &#160;Authentication is a VERY slow process. It is definitely not reliable 
to trigger during a 'fast' type ACL check like tcp_outgoing_* directives.

To fix this you need to ensure authentication is performed in 
http_access or similar early 'slow' access control directive. eg.

 &#160;&#160; http_access deny !auth_users


Squid can then access the username with a 'note' type ACL check like so:

 &#160; acl wg_uk note user uk


&gt;<i> acl wg_uk proxy_auth uk
</I>&gt;<i> tcp_outgoing_address 10.200.0.70 wg_uk
</I>&gt;<i>
</I>&gt;<i> I can see that the IP and config are not wrong because the requests 
</I>&gt;<i> don't get 503 errors (if I change the IP to a non existing one, e.g. 
</I>&gt;<i> 10.200.0.71 I do get 503 errors).
</I>&gt;<i>
</I>
The log snippet looks like Squid is correctly obeying your configuration:

&gt;<i> small excerpt from the squid_cache.log (proxy server is 192.168.1.1, 
</I>&gt;<i> proxy client is&#160;192.168.1.149)
</I>&gt;<i> 2022/11/26 11:28:48.286| 17,3| FwdState.cc(394) Start: 
</I>&gt;<i> '<A HREF="http://detectportal.firefox.com/canonical.html">http://detectportal.firefox.com/canonical.html</A>'
</I>&gt;<i> 2022/11/26 11:28:48.286| 17,2| FwdState.cc(157) FwdState: Forwarding 
</I>&gt;<i> client request conn157 local=192.168.1.1:3128 
</I>&gt;<i> &lt;<A HREF="http://192.168.1.1:3128">http://192.168.1.1:3128</A>&gt; remote=192.168.1.149:64723 
</I>&gt;<i> &lt;<A HREF="http://192.168.1.149:64723">http://192.168.1.149:64723</A>&gt; FD 13 flags=1, 
</I>&gt;<i> url=<A HREF="http://detectportal.firefox.com/canonical.html">http://detectportal.firefox.com/canonical.html</A>
</I>
To be clear, the above are about the client&lt;-&gt;Squid connection which 
triggered this outbound request.

...
&gt;<i> 2022/11/26 11:28:48.287| 14,4| ipcache.cc(647) 
</I>&gt;<i> ipcache_nbgethostbyname_: ipcache_nbgethostbyname: HIT for 
</I>&gt;<i> 'detectportal.firefox.com &lt;<A HREF="http://detectportal.firefox.com">http://detectportal.firefox.com</A>&gt;'
</I>&gt;<i> 2022/11/26 11:28:48.287| 14,7| ipcache.cc(250) forwardIp: 34.107.221.82
</I>&gt;<i> 2022/11/26 11:28:48.287| 28,5| Acl.cc(124) matches: checking wg_uk
</I>&gt;<i> 2022/11/26 11:28:48.287| 28,3| Acl.cc(151) matches: checked: 
</I>&gt;<i> tcp_outgoing_address 10.200.0.70 = 1
</I>&gt;<i> 2022/11/26 11:28:48.287| 28,3| Checklist.cc(63) markFinished: 
</I>&gt;<i> 0x7ffd71e3d440 answer ALLOWED for match
</I>&gt;<i> 2022/11/26 11:28:48.287| 44,2| peer_select.cc(1171) handlePath: 
</I>&gt;<i> PeerSelector27 found conn167 local=10.200.0.70 remote=34.107.221.82:80 
</I>&gt;<i> &lt;<A HREF="http://34.107.221.82:80">http://34.107.221.82:80</A>&gt; HIER_DIRECT flags=1, destination #1 for 
</I>&gt;<i> <A HREF="http://detectportal.firefox.com/canonical.html">http://detectportal.firefox.com/canonical.html</A>
</I>
As you can see Squid MAY select to use a connection where the local= IP 
is your configured tcp_outgoing_address ...

...
&gt;<i> 2022/11/26 11:28:48.288| 14,7| ipcache.cc(250) forwardIp: 
</I>&gt;<i> [2600:1901:0:38d7::]
</I>&gt;<i> 2022/11/26 11:28:48.288| 44,7| peer_select.cc(1149) 
</I>&gt;<i> interestedInitiator: PeerSelector27
</I>&gt;<i> 2022/11/26 11:28:48.288| 44,2| peer_select.cc(1171) handlePath: 
</I>&gt;<i> PeerSelector27 found conn168 local=[::] remote=[2600:1901:0:38d7::]:80 
</I>&gt;<i> HIER_DIRECT flags=1, destination #2 for 
</I>&gt;<i> <A HREF="http://detectportal.firefox.com/canonical.html">http://detectportal.firefox.com/canonical.html</A>
</I>
... or it also MAY select IPv6 which you did not configure any 
particular address for.
In accordance with with BCP 177 specifications Squid prefers IPv6 when 
possible setting up new connections.
This can also be impacted by &quot;happy eyeballs&quot; timing and whether there 
is an existing open connection on either of those two routes to the server.

So it is most likely that the IPv6 was chosen when you see the &quot;not 
working&quot; behaviour with 10.200.0.70 address, and the IPv4 is chosen when 
you saw the 503 errors in the 10.200.0.71 tests.


Try adding tcp_outgoing_address for IPv6 first and see if the problems 
disappear completely.

The log shown stops before showing which of the two connections were 
actually used, so there may be additional problems later. If they remain 
we will need more log info to tell what is going on. Including the debug 
11,2 trace of a non-working transaction would help.


Cheers
Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="025460.html">[squid-users] tcp_outgoing_address directive ignored, data goes out on default gateway
</A></li>
	<LI>Next message (by thread): <A HREF="025473.html">[squid-users] tcp_outgoing_address directive ignored, data goes out on default gateway
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25462">[ date ]</a>
              <a href="thread.html#25462">[ thread ]</a>
              <a href="subject.html#25462">[ subject ]</a>
              <a href="author.html#25462">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
