<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Logs not showing ssl::servername
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Logs%20not%20showing%20ssl%3A%3Aservername&In-Reply-To=%3CCAGSQug%3DRi2iZV%2BDVD45xCcVh2viP8d0ocs1u%2ByetZB3QPoXqKA%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="025466.html">
   <LINK REL="Next"  HREF="025469.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Logs not showing ssl::servername</H1>
    <B>Gabriel Vilari&#241;o</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Logs%20not%20showing%20ssl%3A%3Aservername&In-Reply-To=%3CCAGSQug%3DRi2iZV%2BDVD45xCcVh2viP8d0ocs1u%2ByetZB3QPoXqKA%40mail.gmail.com%3E"
       TITLE="[squid-users] Logs not showing ssl::servername">gvilarino6 at gmail.com
       </A><BR>
    <I>Tue Nov 29 12:16:38 UTC 2022</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="025466.html">[squid-users] daily usage email reports for hostnames/users/top URLs/blocked URLs
</A></li>
        <LI>Next message (by thread): <A HREF="025469.html">[squid-users] Logs not showing ssl::servername
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25468">[ date ]</a>
              <a href="thread.html#25468">[ thread ]</a>
              <a href="subject.html#25468">[ subject ]</a>
              <a href="author.html#25468">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi there,

I am setting up an HTTP/HTTPS transparent proxy, meaning the clients not
need any certificates for using the proxy. This works fine on version 3.5
of Squid, however after upgrading to 5.7 the behavior of the logs change:

1669723133.174   8037 10.184.19.220 TCP_TUNNEL/500 6207 CONNECT
54.240.253.128:443 - ORIGINAL_DST/54.240.253.128 -

Directive: logformat squid %ts.%03tu %&gt;a %Ss/%03&gt;Hs %ssl::&gt;sni
%ssl::bump_mode ssl::&gt;cert_subject %&lt;ru

On version 3.5 we were obtaining the domain name (an aws service) in the
place of ORIGINAL_DST. Also now we are not seeing any information about the
bump_mode in no one of the connections while before we were seeing it. One
could trough that it could be because of the /500 message, however on a 200
one to docs.ansble.com it also don&#180;t show any data on the sni field:

1669723513.363    332 10.184.19.220 TCP_TUNNEL/200 38192 CONNECT
104.26.0.234:443 - ORIGINAL_DST/104.26.0.234 -

Also the 500 looks to come from the squid not understanding something on
the SSL negotiation:

2022/11/29 10:32:38.943 kid1| 83,4| support.cc(248) check_domain: Verifying
server domain arsenal.us-west-2.amazonaws.com to certificate
name/subjectAltName arsenal.us-west-2.amazonaws.com 2022/11/29 10:32:38.943
kid1| 83,5| bio.cc(136) read: FD 28 read 347 &lt;= 65535 2022/11/29
10:32:38.943 kid1| 83,5| Io.cc(91) Handshake: -1/0 for TLS connection
0x558453168970 over conn99 local=SQUID-INTERNAL-IP:44264 remote=
54.240.251.223:443 ORIGINAL_DST FD 28 flags=1 2022/11/29 10:32:38.943 kid1|
83,2| PeerConnector.cc(256) handleNegotiationResult: ERROR: failure while
establishing TLS connection on FD: 280x558452b68980*1 2022/11/29
10:32:38.943 kid1| 83,5| NegotiationHistory.cc(85) retrieveNegotiatedInfo:
SSL connection info on FD 28 SSL version NONE/0.0 negotiated cipher 2022/11/29
10:32:38.943 kid1| 83,5| PeekingPeerConnector.cc(84)
checkForPeekAndSpliceMatched: Will check for peek and splice on FD 28
2022/11/29
10:32:38.943 kid1| 83,5| PeekingPeerConnector.cc(395)
serverCertificateVerified: HTTPS server CN: arsenal.us-west-2.amazonaws.com
bumped: conn99 local=SQUID-INTERNAL-IP:44264 remote=54.240.251.223:443
ORIGINAL_DST FD 28 flags=1
2022/11/29 10:32:38.943 kid1| 83,5| PeekingPeerConnector.cc(273)
startTunneling: will tunnel instead of negotiating TLS

It is clear that in creates the tunnel so the 500 probably is that error?
Why the bump/sni messages never log anything (according to
<A HREF="https://wiki.squid-cache.org/Features/SslPeekAndSplice">https://wiki.squid-cache.org/Features/SslPeekAndSplice</A> they should log
splice not -). This is the config for bumping:



acl step1 at_step SslBump1
acl step2 at_step SslBump2
acl step3 at_step SslBump3
ssl_bump peek step1 all

.... http rules ...

acl allowed_https_sites ssl::server_name_regex &quot;/etc/squid/whitelist.txt&quot;
ssl_bump peek step2 allowed_https_sites
ssl_bump splice step3 allowed_https_sites
ssl_bump terminate step2 all




Ip tables simply redirect:

iptables -t nat -A PREROUTING -p tcp --dport 80 -j REDIRECT --to-port 3129
iptables -t nat -A PREROUTING -p tcp --dport 443 -j REDIRECT --to-port 3130
# https port on squid: https_port 3130 intercept ssl-bump
cert=/etc/squid/ssl/dummy.pem

Thanks in advance, i have been trying this for a week now reading a lot of
posts but not luck...
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20221129/9a5d4372/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20221129/9a5d4372/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="025466.html">[squid-users] daily usage email reports for hostnames/users/top URLs/blocked URLs
</A></li>
	<LI>Next message (by thread): <A HREF="025469.html">[squid-users] Logs not showing ssl::servername
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25468">[ date ]</a>
              <a href="thread.html#25468">[ thread ]</a>
              <a href="subject.html#25468">[ subject ]</a>
              <a href="author.html#25468">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
