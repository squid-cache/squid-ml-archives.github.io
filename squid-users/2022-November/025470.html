<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Logs not showing ssl::servername
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Logs%20not%20showing%20ssl%3A%3Aservername&In-Reply-To=%3C5afe9c32-c979-4b64-5193-b96d975fd05f%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="025469.html">
   <LINK REL="Next"  HREF="025471.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Logs not showing ssl::servername</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Logs%20not%20showing%20ssl%3A%3Aservername&In-Reply-To=%3C5afe9c32-c979-4b64-5193-b96d975fd05f%40measurement-factory.com%3E"
       TITLE="[squid-users] Logs not showing ssl::servername">rousskov at measurement-factory.com
       </A><BR>
    <I>Tue Nov 29 14:18:15 UTC 2022</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="025469.html">[squid-users] Logs not showing ssl::servername
</A></li>
        <LI>Next message (by thread): <A HREF="025471.html">[squid-users] Logs not showing ssl::servername
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25470">[ date ]</a>
              <a href="thread.html#25470">[ thread ]</a>
              <a href="subject.html#25470">[ subject ]</a>
              <a href="author.html#25470">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 11/29/22 08:06, Gabriel Vilari&#241;o wrote:

&gt;<i> However, in this context, what means TCP_TUNNEL/500? is it because the 
</I>&gt;<i> TLS handshake? I would like to know if it is tunneling correctly or is 
</I>&gt;<i> having some trouble (not easy to test right now).
</I>
Squid bugs notwithstanding, TCP_TUNNEL/500 means that Squid refused to 
tunnel the corresponding TCP connection and responded with an HTTP 500 
error to the corresponding HTTP CONNECT request. That client request is 
faked in your TLS interception case, so the response is also a fake -- 
Squid does not really send it to the client.

In most SslBump cases, if Squid cannot successfully peek-and-splice, 
then it will try to bump the client connection and, if the client then 
sends a GET request on the bumped client-Squid connection, Squid will 
respond with a real HTTP 500 error.

AFAICT, the logs you have shared do not detail the TLS error that 
triggers that TCP_TUNNEL/500 outcome.


HTH,

Alex.


&gt;<i> 
</I>&gt;<i> Thanks!
</I>&gt;<i> 
</I>&gt;<i> El mar, 29 nov 2022 a las 13:16, Gabriel Vilari&#241;o (&lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">gvilarino6 at gmail.com</A> 
</I>&gt;<i> &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">gvilarino6 at gmail.com</A>&gt;&gt;) escribi&#243;:
</I>&gt;<i> 
</I>&gt;<i>     Hi there,
</I>&gt;<i> 
</I>&gt;<i>     I am setting up an HTTP/HTTPS transparent proxy, meaning the clients
</I>&gt;<i>     not need any certificates for using the proxy. This works fine on
</I>&gt;<i>     version 3.5 of Squid, however after upgrading to 5.7 the behavior of
</I>&gt;<i>     the logs change:
</I>&gt;<i> 
</I>&gt;<i>     1669723133.174 &#160; 8037 10.184.19.220 TCP_TUNNEL/500 6207 CONNECT
</I>&gt;<i>     54.240.253.128:443 &lt;<A HREF="http://54.240.253.128:443">http://54.240.253.128:443</A>&gt; -
</I>&gt;<i>     ORIGINAL_DST/54.240.253.128 &lt;<A HREF="http://54.240.253.128">http://54.240.253.128</A>&gt; -
</I>&gt;<i> 
</I>&gt;<i>     Directive: logformat squid %ts.%03tu %&gt;a %Ss/%03&gt;Hs %ssl::&gt;sni
</I>&gt;<i>     %ssl::bump_mode ssl::&gt;cert_subject %&lt;ru
</I>&gt;<i> 
</I>&gt;<i>     On version 3.5 we were obtaining the domain name (an aws service) in
</I>&gt;<i>     the place of ORIGINAL_DST. Also now we are not seeing any
</I>&gt;<i>     information about the bump_mode in no one of the connections while
</I>&gt;<i>     before we were seeing it. One could trough that it could be because
</I>&gt;<i>     of the /500 message, however on a 200 one to docs.ansble.com
</I>&gt;<i>     &lt;<A HREF="http://docs.ansble.com">http://docs.ansble.com</A>&gt; it also don&#180;t show any data on the sni field:
</I>&gt;<i> 
</I>&gt;<i>     1669723513.363 &#160; &#160;332 10.184.19.220 TCP_TUNNEL/200 38192 CONNECT
</I>&gt;<i>     104.26.0.234:443 &lt;<A HREF="http://104.26.0.234:443">http://104.26.0.234:443</A>&gt; -
</I>&gt;<i>     ORIGINAL_DST/104.26.0.234 &lt;<A HREF="http://104.26.0.234">http://104.26.0.234</A>&gt; -
</I>&gt;<i> 
</I>&gt;<i>     Also the 500 looks to come from the squid not understanding
</I>&gt;<i>     something on the SSL negotiation:
</I>&gt;<i> 
</I>&gt;<i>     |2022/11/29 10:32:38.943 kid1| 83,4| support.cc(248) check_domain:
</I>&gt;<i>     Verifying server domain arsenal.us-west-2.amazonaws.com
</I>&gt;<i>     &lt;<A HREF="http://arsenal.us-west-2.amazonaws.com">http://arsenal.us-west-2.amazonaws.com</A>&gt; to certificate
</I>&gt;<i>     name/subjectAltName arsenal.us-west-2.amazonaws.com
</I>&gt;<i>     &lt;<A HREF="http://arsenal.us-west-2.amazonaws.com">http://arsenal.us-west-2.amazonaws.com</A>&gt; ||2022/11/29 10:32:38.943
</I>&gt;<i>     kid1| 83,5| bio.cc(136) read: FD 28 read 347 &lt;= 65535 ||2022/11/29
</I>&gt;<i>     10:32:38.943 kid1| 83,5| Io.cc(91) Handshake: -1/0 for TLS
</I>&gt;<i>     connection 0x558453168970 over conn99 local=SQUID-INTERNAL-IP:44264
</I>&gt;<i>     remote=54.240.251.223:443 &lt;<A HREF="http://54.240.251.223:443">http://54.240.251.223:443</A>&gt; ORIGINAL_DST
</I>&gt;<i>     FD 28 flags=1 ||2022/11/29 10:32:38.943 kid1| 83,2|
</I>&gt;<i>     PeerConnector.cc(256) handleNegotiationResult: ERROR: failure while
</I>&gt;<i>     establishing TLS connection on FD: 280x558452b68980*1 ||2022/11/29
</I>&gt;<i>     10:32:38.943 kid1| 83,5| NegotiationHistory.cc(85)
</I>&gt;<i>     retrieveNegotiatedInfo: SSL connection info on FD 28 SSL version
</I>&gt;<i>     NONE/0.0 negotiated cipher ||2022/11/29 10:32:38.943 kid1| 83,5|
</I>&gt;<i>     PeekingPeerConnector.cc(84) checkForPeekAndSpliceMatched: Will check
</I>&gt;<i>     for peek and splice on FD 28 ||2022/11/29 10:32:38.943 kid1| 83,5|
</I>&gt;<i>     PeekingPeerConnector.cc(395) serverCertificateVerified: HTTPS server
</I>&gt;<i>     CN: arsenal.us-west-2.amazonaws.com
</I>&gt;<i>     &lt;<A HREF="http://arsenal.us-west-2.amazonaws.com">http://arsenal.us-west-2.amazonaws.com</A>&gt; bumped: conn99
</I>&gt;<i>     local=SQUID-INTERNAL-IP:44264 remote=54.240.251.223:443
</I>&gt;<i>     &lt;<A HREF="http://54.240.251.223:443">http://54.240.251.223:443</A>&gt; ORIGINAL_DST FD 28 flags=1 |
</I>&gt;<i>     |2022/11/29 10:32:38.943 kid1| 83,5| PeekingPeerConnector.cc(273)
</I>&gt;<i>     startTunneling: will tunnel instead of negotiating TLS|
</I>&gt;<i> 
</I>&gt;<i>     It is clear that in creates the tunnel so the 500 probably is that
</I>&gt;<i>     error? Why the bump/sni messages never log anything (according to
</I>&gt;<i>     <A HREF="https://wiki.squid-cache.org/Features/SslPeekAndSplice">https://wiki.squid-cache.org/Features/SslPeekAndSplice</A>
</I>&gt;<i>     &lt;<A HREF="https://wiki.squid-cache.org/Features/SslPeekAndSplice">https://wiki.squid-cache.org/Features/SslPeekAndSplice</A>&gt; they should
</I>&gt;<i>     log splice not -). This is the config for bumping:
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i>     acl step1 at_step SslBump1
</I>&gt;<i>     acl step2 at_step SslBump2
</I>&gt;<i>     acl step3 at_step SslBump3
</I>&gt;<i>     ssl_bump peek step1 all
</I>&gt;<i> 
</I>&gt;<i>     .... http rules ...
</I>&gt;<i> 
</I>&gt;<i>     acl allowed_https_sites ssl::server_name_regex
</I>&gt;<i>     &quot;/etc/squid/whitelist.txt&quot;
</I>&gt;<i>     ssl_bump peek step2 allowed_https_sites
</I>&gt;<i>     ssl_bump splice step3 allowed_https_sites
</I>&gt;<i>     ssl_bump terminate step2 all
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i>     Ip tables simply redirect:
</I>&gt;<i> 
</I>&gt;<i>     iptables -t nat -A PREROUTING -p tcp --dport 80 -j REDIRECT
</I>&gt;<i>     --to-port 3129
</I>&gt;<i>     iptables -t nat -A PREROUTING -p tcp --dport 443 -j REDIRECT
</I>&gt;<i>     --to-port 3130 # https port on squid: https_port 3130 intercept
</I>&gt;<i>     ssl-bump cert=/etc/squid/ssl/dummy.pem
</I>&gt;<i> 
</I>&gt;<i>     Thanks in advance, i have been trying this for a week now reading a
</I>&gt;<i>     lot of posts but not luck...
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="025469.html">[squid-users] Logs not showing ssl::servername
</A></li>
	<LI>Next message (by thread): <A HREF="025471.html">[squid-users] Logs not showing ssl::servername
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25470">[ date ]</a>
              <a href="thread.html#25470">[ thread ]</a>
              <a href="subject.html#25470">[ subject ]</a>
              <a href="author.html#25470">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
