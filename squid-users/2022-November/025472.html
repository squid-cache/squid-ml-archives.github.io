<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Logs not showing ssl::servername
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Logs%20not%20showing%20ssl%3A%3Aservername&In-Reply-To=%3C1dccba7c-f6bc-57c8-a672-9981d228092e%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="025471.html">
   <LINK REL="Next"  HREF="025474.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Logs not showing ssl::servername</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Logs%20not%20showing%20ssl%3A%3Aservername&In-Reply-To=%3C1dccba7c-f6bc-57c8-a672-9981d228092e%40measurement-factory.com%3E"
       TITLE="[squid-users] Logs not showing ssl::servername">rousskov at measurement-factory.com
       </A><BR>
    <I>Tue Nov 29 21:15:36 UTC 2022</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="025471.html">[squid-users] Logs not showing ssl::servername
</A></li>
        <LI>Next message (by thread): <A HREF="025474.html">[squid-users] Logs not showing ssl::servername
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25472">[ date ]</a>
              <a href="thread.html#25472">[ thread ]</a>
              <a href="subject.html#25472">[ subject ]</a>
              <a href="author.html#25472">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 11/29/22 15:52, Gabriel Vilari&#241;o wrote:
&gt;<i> Here are the fixed logs:
</I>&gt;<i> |1669726977.734 INTERNAL_CLIENT_IP TCP_TUNNEL/500 
</I>&gt;<i> arsenal.us-west-2.amazonaws.com splice /CN=arsenal.us-west-2.amazonaws.com 54.240.251.223|
</I>

&gt;<i> |As you can see, the destination is an aws service, more interesting, it 
</I>&gt;<i> effectively *logs the splice* action! That&#180;s why I though it was letting 
</I>&gt;<i> the traffic go trough.
</I>
Yeah. Without more information, I cannot tell whether Squid logs the 
wrong &quot;500&quot; status code or the wrong &quot;splice&quot; action in this case.


&gt;<i> Also the debug logs from SSL show this:|
</I>&gt;<i> ||2022/11/29 10:32:38.943 kid1| 83,5| PeekingPeerConnector.cc(273) 
</I>&gt;<i> *startTunneling: will tunnel instead of negotiating TLS* # Last line 
</I>&gt;<i> from previously attached logs||
</I>&gt;<i> ||
</I>&gt;<i> ||
</I>&gt;<i> ||As far as I know this means *is getting to the TCP_TUNNEL, at that 
</I>&gt;<i> point it can not know anything about the internal status on the 
</I>&gt;<i> connection between client and host*. 
</I>
Correct.


&gt;<i> If not, *where I should be looking for this error?
</I>
My current bet is that either

* there is no error at all (but Squid logs the wrong 500 status code) OR
* there is an error (but you are looking at the wrong cache.log lines 
that are not about the transaction that ended with an error).


FWIW, IMHO, you should not be looking for information in debugging 
cache.log (ALL,3 or higher) because the latter is not designed for admin 
use. Instead, you should:

* log %err_code/%err_detail to access.log and share that info (along 
with any associated level-0/1 messages in cache.log).

* If that information is not sufficient, then you should share debugging 
cache.log, so that folks who know &quot;where to look for this error&quot; can 
look for it. 
<A HREF="https://wiki.squid-cache.org/SquidFaq/BugReporting#Debugging_a_single_transaction">https://wiki.squid-cache.org/SquidFaq/BugReporting#Debugging_a_single_transaction</A>


Said that, the answer to your question is: The misleading &quot;will tunnel 
instead of negotiating&quot; line in an ALL,5+ debugging cache.log is 
associated with a no-error successful-splicing-at-step3 transaction 
outcome. If the same transaction ends with an error from client or 
origin point of view, then that error usually happens _after_ Squid 
splices the connections. In that case, Squid will not &quot;see&quot; that error.


HTH,

Alex.



&gt;<i> El mar, 29 nov 2022 a las 14:06, Gabriel Vilari&#241;o (&lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">gvilarino6 at gmail.com</A>&gt;) escribi&#243;:
</I>&gt;<i> 
</I>&gt;<i>     Just got it solved. Was caused because of checking default
</I>&gt;<i>     access.log. Using a new file solves all the problems.
</I>&gt;<i> 
</I>&gt;<i>     However, in this context, what means TCP_TUNNEL/500? is it because
</I>&gt;<i>     the TLS handshake? I would like to know if it is tunneling correctly
</I>&gt;<i>     or is having some trouble (not easy to test right now).
</I>&gt;<i> 
</I>&gt;<i>     Thanks!
</I>&gt;<i> 
</I>&gt;<i>     El mar, 29 nov 2022 a las 13:16, Gabriel Vilari&#241;o
</I>&gt;<i>     (&lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">gvilarino6 at gmail.com</A> &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">gvilarino6 at gmail.com</A>&gt;&gt;) escribi&#243;:
</I>&gt;<i> 
</I>&gt;<i>         Hi there,
</I>&gt;<i> 
</I>&gt;<i>         I am setting up an HTTP/HTTPS transparent proxy, meaning the
</I>&gt;<i>         clients not need any certificates for using the proxy. This
</I>&gt;<i>         works fine on version 3.5 of Squid, however after upgrading to
</I>&gt;<i>         5.7 the behavior of the logs change:
</I>&gt;<i> 
</I>&gt;<i>         1669723133.174 &#160; 8037 10.184.19.220 TCP_TUNNEL/500 6207 CONNECT
</I>&gt;<i>         54.240.253.128:443 &lt;<A HREF="http://54.240.253.128:443">http://54.240.253.128:443</A>&gt; -
</I>&gt;<i>         ORIGINAL_DST/54.240.253.128 &lt;<A HREF="http://54.240.253.128">http://54.240.253.128</A>&gt; -
</I>&gt;<i> 
</I>&gt;<i>         Directive: logformat squid %ts.%03tu %&gt;a %Ss/%03&gt;Hs %ssl::&gt;sni
</I>&gt;<i>         %ssl::bump_mode ssl::&gt;cert_subject %&lt;ru
</I>&gt;<i> 
</I>&gt;<i>         On version 3.5 we were obtaining the domain name (an aws
</I>&gt;<i>         service) in the place of ORIGINAL_DST. Also now we are not
</I>&gt;<i>         seeing any information about the bump_mode in no one of the
</I>&gt;<i>         connections while before we were seeing it. One could trough
</I>&gt;<i>         that it could be because of the /500 message, however on a 200
</I>&gt;<i>         one to docs.ansble.com &lt;<A HREF="http://docs.ansble.com">http://docs.ansble.com</A>&gt; it also don&#180;t
</I>&gt;<i>         show any data on the sni field:
</I>&gt;<i> 
</I>&gt;<i>         1669723513.363 &#160; &#160;332 10.184.19.220 TCP_TUNNEL/200 38192 CONNECT
</I>&gt;<i>         104.26.0.234:443 &lt;<A HREF="http://104.26.0.234:443">http://104.26.0.234:443</A>&gt; -
</I>&gt;<i>         ORIGINAL_DST/104.26.0.234 &lt;<A HREF="http://104.26.0.234">http://104.26.0.234</A>&gt; -
</I>&gt;<i> 
</I>&gt;<i>         Also the 500 looks to come from the squid not understanding
</I>&gt;<i>         something on the SSL negotiation:
</I>&gt;<i> 
</I>&gt;<i>         |2022/11/29 10:32:38.943 kid1| 83,4| support.cc(248)
</I>&gt;<i>         check_domain: Verifying server domain
</I>&gt;<i>         arsenal.us-west-2.amazonaws.com
</I>&gt;<i>         &lt;<A HREF="http://arsenal.us-west-2.amazonaws.com">http://arsenal.us-west-2.amazonaws.com</A>&gt; to certificate
</I>&gt;<i>         name/subjectAltName arsenal.us-west-2.amazonaws.com
</I>&gt;<i>         &lt;<A HREF="http://arsenal.us-west-2.amazonaws.com">http://arsenal.us-west-2.amazonaws.com</A>&gt; ||2022/11/29
</I>&gt;<i>         10:32:38.943 kid1| 83,5| bio.cc(136) read: FD 28 read 347 &lt;=
</I>&gt;<i>         65535 ||2022/11/29 10:32:38.943 kid1| 83,5| Io.cc(91) Handshake:
</I>&gt;<i>         -1/0 for TLS connection 0x558453168970 over conn99
</I>&gt;<i>         local=SQUID-INTERNAL-IP:44264 remote=54.240.251.223:443
</I>&gt;<i>         &lt;<A HREF="http://54.240.251.223:443">http://54.240.251.223:443</A>&gt; ORIGINAL_DST FD 28 flags=1
</I>&gt;<i>         ||2022/11/29 10:32:38.943 kid1| 83,2| PeerConnector.cc(256)
</I>&gt;<i>         handleNegotiationResult: ERROR: failure while establishing TLS
</I>&gt;<i>         connection on FD: 280x558452b68980*1 ||2022/11/29 10:32:38.943
</I>&gt;<i>         kid1| 83,5| NegotiationHistory.cc(85) retrieveNegotiatedInfo:
</I>&gt;<i>         SSL connection info on FD 28 SSL version NONE/0.0 negotiated
</I>&gt;<i>         cipher ||2022/11/29 10:32:38.943 kid1| 83,5|
</I>&gt;<i>         PeekingPeerConnector.cc(84) checkForPeekAndSpliceMatched: Will
</I>&gt;<i>         check for peek and splice on FD 28 ||2022/11/29 10:32:38.943
</I>&gt;<i>         kid1| 83,5| PeekingPeerConnector.cc(395)
</I>&gt;<i>         serverCertificateVerified: HTTPS server CN:
</I>&gt;<i>         arsenal.us-west-2.amazonaws.com
</I>&gt;<i>         &lt;<A HREF="http://arsenal.us-west-2.amazonaws.com">http://arsenal.us-west-2.amazonaws.com</A>&gt; bumped: conn99
</I>&gt;<i>         local=SQUID-INTERNAL-IP:44264 remote=54.240.251.223:443
</I>&gt;<i>         &lt;<A HREF="http://54.240.251.223:443">http://54.240.251.223:443</A>&gt; ORIGINAL_DST FD 28 flags=1 |
</I>&gt;<i>         |2022/11/29 10:32:38.943 kid1| 83,5|
</I>&gt;<i>         PeekingPeerConnector.cc(273) startTunneling: will tunnel instead
</I>&gt;<i>         of negotiating TLS|
</I>&gt;<i> 
</I>&gt;<i>         It is clear that in creates the tunnel so the 500 probably is
</I>&gt;<i>         that error? Why the bump/sni messages never log anything
</I>&gt;<i>         (according to
</I>&gt;<i>         <A HREF="https://wiki.squid-cache.org/Features/SslPeekAndSplice">https://wiki.squid-cache.org/Features/SslPeekAndSplice</A>
</I>&gt;<i>         &lt;<A HREF="https://wiki.squid-cache.org/Features/SslPeekAndSplice">https://wiki.squid-cache.org/Features/SslPeekAndSplice</A>&gt; they
</I>&gt;<i>         should log splice not -). This is the config for bumping:
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i>         acl step1 at_step SslBump1
</I>&gt;<i>         acl step2 at_step SslBump2
</I>&gt;<i>         acl step3 at_step SslBump3
</I>&gt;<i>         ssl_bump peek step1 all
</I>&gt;<i> 
</I>&gt;<i>         .... http rules ...
</I>&gt;<i> 
</I>&gt;<i>         acl allowed_https_sites ssl::server_name_regex
</I>&gt;<i>         &quot;/etc/squid/whitelist.txt&quot;
</I>&gt;<i>         ssl_bump peek step2 allowed_https_sites
</I>&gt;<i>         ssl_bump splice step3 allowed_https_sites
</I>&gt;<i>         ssl_bump terminate step2 all
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i>         Ip tables simply redirect:
</I>&gt;<i> 
</I>&gt;<i>         iptables -t nat -A PREROUTING -p tcp --dport 80 -j REDIRECT
</I>&gt;<i>         --to-port 3129
</I>&gt;<i>         iptables -t nat -A PREROUTING -p tcp --dport 443 -j REDIRECT
</I>&gt;<i>         --to-port 3130 # https port on squid: https_port 3130 intercept
</I>&gt;<i>         ssl-bump cert=/etc/squid/ssl/dummy.pem
</I>&gt;<i> 
</I>&gt;<i>         Thanks in advance, i have been trying this for a week now
</I>&gt;<i>         reading a lot of posts but not luck...
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="025471.html">[squid-users] Logs not showing ssl::servername
</A></li>
	<LI>Next message (by thread): <A HREF="025474.html">[squid-users] Logs not showing ssl::servername
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25472">[ date ]</a>
              <a href="thread.html#25472">[ thread ]</a>
              <a href="subject.html#25472">[ subject ]</a>
              <a href="author.html#25472">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
