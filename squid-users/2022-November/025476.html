<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] transparent mode squid on centos 9 with iptables (part 2)
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20transparent%20mode%20squid%20on%20centos%209%20with%20iptables%0A%20%28part%202%29&In-Reply-To=%3C001101d904aa%2473a03190%245ae094b0%24%40gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="025464.html">
   <LINK REL="Next"  HREF="025479.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] transparent mode squid on centos 9 with iptables (part 2)</H1>
    <B>ngtech1ltd at gmail.com</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20transparent%20mode%20squid%20on%20centos%209%20with%20iptables%0A%20%28part%202%29&In-Reply-To=%3C001101d904aa%2473a03190%245ae094b0%24%40gmail.com%3E"
       TITLE="[squid-users] transparent mode squid on centos 9 with iptables (part 2)">ngtech1ltd at gmail.com
       </A><BR>
    <I>Wed Nov 30 10:56:50 UTC 2022</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="025464.html">[squid-users] transparent mode squid on centos 9 with iptables (part 2)
</A></li>
        <LI>Next message (by thread): <A HREF="025479.html">[squid-users] transparent mode squid on centos 9 with iptables (part 2)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25476">[ date ]</a>
              <a href="thread.html#25476">[ thread ]</a>
              <a href="subject.html#25476">[ subject ]</a>
              <a href="author.html#25476">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hey,
 
There are no technical details about the relevant subject which is the iptables, iproute and squid.conf
I will try to give a demo for such a setup later on.
 
Eliezer
 
----
Eliezer Croitoru
NgTech, Tech Support
Mobile: +972-5-28704261
Email: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">ngtech1ltd at gmail.com</A> &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">ngtech1ltd at gmail.com</A>&gt; 
Web: <A HREF="https://ngtech.co.il/">https://ngtech.co.il/</A>
My-Tube: <A HREF="https://tube.ngtech.co.il/">https://tube.ngtech.co.il/</A>
 
From: squid-users &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>&gt; On Behalf Of Lola Lo
Sent: Monday, 28 November 2022 6:33
To: Amos Jeffries &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt;; <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
Subject: Re: [squid-users] transparent mode squid on centos 9 with iptables (part 2)
 
Hi Amos.
 
Thank you for your advice. I applied the instructionts that you have sent it to me in this link: <A HREF="https://wiki.squid-cache.org/ConfigExamples/Intercept/LinuxRedirect">https://wiki.squid-cache.org/ConfigExamples/Intercept/LinuxRedirect</A> and the <A HREF="https://wiki.squid-cache.org/ConfigExamples/Intercept/IptablesPolicyRoute,">https://wiki.squid-cache.org/ConfigExamples/Intercept/IptablesPolicyRoute,</A> the case of: &quot;When Squid is Internal amongst clients&quot; and the section:  Routing Setup. Now I can see the squid is intercepting the traffic however, it is not applying my policies:
 
http_access deny cliente_linux sitios2
http_access deny cliente_windows sitios1
http_access allow mi_red
 
&quot;sitios2&quot;=facebook
&quot;sitios1&quot;=youtube
 these policies work when I set up manually the proxy. Do you have any idea of how to troubleshoot this?
Thank you for your help
 
 
 
On Wed, Nov 16, 2022 at 11:35 PM Amos Jeffries &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A> &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt; &gt; wrote:
On 17/11/2022 9:14 am, Lola Lo wrote:
&gt;<i> Hi guys.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Could you please send a tutorial or any good guidance to implement  
</I>&gt;<i> squid on transparent mode on centos 9 with iptables.
</I>&gt;<i>
</I>
The configuration details for what you appear to be trying to configure 
are here:
  &lt;<A HREF="https://wiki.squid-cache.org/ConfigExamples/Intercept/LinuxRedirect">https://wiki.squid-cache.org/ConfigExamples/Intercept/LinuxRedirect</A>&gt;

My comments below relate to how your attempt differs and how to fix.

&gt;<i> I have configured squid.conf with this parameters:
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> ens192: 172.31.168.28, internet interface
</I>&gt;<i>
</I>&gt;<i> ens224: 192.168.1.10, LAN interface (private network)
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> # Mis ACLs #
</I>&gt;<i>
</I>&gt;<i> acl mi_red src 192.168.1.0/24 &lt;<A HREF="http://192.168.1.0/24">http://192.168.1.0/24</A>&gt;  &lt;<A HREF="http://192.168.1.0/24">http://192.168.1.0/24</A>&gt;
</I>&gt;<i>
</I>&gt;<i> acl cliente_linux src 192.168.1.20
</I>&gt;<i>
</I>&gt;<i> acl cliente_windows src 192.168.1.30
</I>&gt;<i>
</I>&gt;<i> acl sitios1 url_regex &quot;/etc/squid/listas/sitios1&quot;
</I>&gt;<i>
</I>&gt;<i> acl sitios2 url_regex &quot;/etc/squid/listas/sitios2&quot;
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> # Squid normally listens to port 3128
</I>&gt;<i>
</I>&gt;<i> http_port 3128
</I>&gt;<i>
</I>&gt;<i> http_port 8080 transparent
</I>&gt;<i>
</I>&gt;<i>
</I>
Firstly, use &quot;intercept&quot; instead of &quot;transparent&quot; with modern Squid.

Secondly, remember that only port 8080 is setup to receive intercepted 
traffic. Port 3128 still receives normal forward-proxy traffic.

&gt;<i> I want the &#8220;deny all&#8221; rule get applied to test the client using the proxy
</I>&gt;<i>
</I>&gt;<i>
</I>
You have not shown any http_access lines from your config. There is a 
clear bug in your NAT which explains the behaviour so I will assume that 
the squid.conf policy does what you want.


&gt;<i> My iptables is configured as follows:
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> #!/bin/bash
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> ## NAT server configuration ##
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> sysctl -w net.ipv4.ip_forward=1
</I>&gt;<i>
</I>&gt;<i> sysctl -p
</I>&gt;<i>
</I>&gt;<i> iptables -X
</I>&gt;<i>
</I>&gt;<i> iptables -F
</I>&gt;<i>
</I>&gt;<i> iptables -t nat -X
</I>&gt;<i>
</I>&gt;<i> iptables -t nat -F
</I>&gt;<i>
</I>&gt;<i> iptables -I INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT
</I>&gt;<i>
</I>&gt;<i> iptables -I FORWARD-m state --state RELATED,ESTABLISHED -j ACCEPT
</I>&gt;<i>
</I>&gt;<i> iptables -t nat -I POSTROUTING -o ens192 -j MASQUERADE
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>
Why is this a different script?
Ideally the firewall rules should be as atomic as possible to avoid 
connections being setup with only part of the rules applied.


&gt;<i>
</I>&gt;<i> #!/bin/bash
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> ## proxy server configuration ##
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> ### Accepting traffic for the ports: 3128 and 8080##
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> iptables -A INPUT -s 192.168.1.0/24 &lt;<A HREF="http://192.168.1.0/24">http://192.168.1.0/24</A>&gt;  &lt;<A HREF="http://192.168.1.0/24">http://192.168.1.0/24</A>&gt; -p tcp 
</I>&gt;<i> --dport 3128 -j ACCEPT
</I>&gt;<i>
</I>&gt;<i> iptables -A INPUT -p tcp --dport 3128 -j DROP
</I>&gt;<i>
</I>
Do not accept traffic directly to the port 8080. Also Squid does not 
make outbound connections from its listening ports.
So these ...

&gt;<i> iptables -A OUTPUT -d 192.168.1.0/24 &lt;<A HREF="http://192.168.1.0/24">http://192.168.1.0/24</A>&gt;  &lt;<A HREF="http://192.168.1.0/24">http://192.168.1.0/24</A>&gt; -p tcp 
</I>&gt;<i> --sport 3128 -j ACCEPT
</I>&gt;<i>
</I>&gt;<i> iptables -A OUTPUT -p tcp --sport 3128 -j DROP
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> iptables -A INPUT -s 192.168.1.0/24 &lt;<A HREF="http://192.168.1.0/24">http://192.168.1.0/24</A>&gt;  &lt;<A HREF="http://192.168.1.0/24">http://192.168.1.0/24</A>&gt; -p tcp 
</I>&gt;<i> --dport 8080 -j ACCEPT
</I>&gt;<i>
</I>&gt;<i> iptables -A INPUT -p tcp --dport 8080 -j DROP
</I>&gt;<i>
</I>&gt;<i> iptables -A OUTPUT -d 192.168.1.0/24 &lt;<A HREF="http://192.168.1.0/24">http://192.168.1.0/24</A>&gt;  &lt;<A HREF="http://192.168.1.0/24">http://192.168.1.0/24</A>&gt; -p tcp 
</I>&gt;<i> --sport 8080 -j ACCEPT
</I>&gt;<i>
</I>&gt;<i> iptables -A OUTPUT -p tcp --sport 8080 -j DROP
</I>&gt;<i>
</I>&gt;<i>
</I>
... should be replaced with:

   iptables -t mangle -A PREROUTING -p tcp --dport 8080 -j DROP


&gt;<i>
</I>&gt;<i> `### Accepting traffic for the ports: 3128 and 8080##
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> iptables -t nat -A POSTROUTING -o ens192 -j MASQUERADE
</I>&gt;<i>
</I>
You are missing a rule to allow Squid outbound traffic to avoid the NAT.

   iptables -t nat -A PREROUTING -s 192.168.1.10 -p tcp --dport 80 -j ACCEPT

&gt;<i> iptables -t nat -A PREROUTING -s 192.168.1.0/24 &lt;<A HREF="http://192.168.1.0/24">http://192.168.1.0/24</A>&gt;  
</I>&gt;<i> &lt;<A HREF="http://192.168.1.0/24">http://192.168.1.0/24</A>&gt; -p tcp --dport 80 -j REDIRECT --to-port 8080
</I>&gt;<i>
</I>&gt;<i> iptables -t nat -A PREROUTING -s 192.168.1.0/24 &lt;<A HREF="http://192.168.1.0/24">http://192.168.1.0/24</A>&gt;  
</I>&gt;<i> &lt;<A HREF="http://192.168.1.0/24">http://192.168.1.0/24</A>&gt; -p tcp --dport 443 -j REDIRECT --to-port 8080
</I>&gt;<i>
</I>&gt;<i>
</I>
Port 8080 in your squid.conf can only handle port 80 traffic syntax.

Port 443 is a more tricky situation. I recommend removing that until you 
have the port 80 working.


&gt;<i>
</I>&gt;<i> But I got this error:
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> 1668381894.7460 192.168.1.20 NONE_NONE/000 0 - 
</I>&gt;<i> error:transaction-end-before-headers - HIER_NONE/- -
</I>&gt;<i>
</I>&gt;<i> 1668381967.8000 192.168.1.20 NONE_NONE/400 3690 - 
</I>&gt;<i> error:invalid-request - HIER_NONE/- text/html
</I>&gt;<i>
</I>
This is likely from the missing NAT rule allowing Squid outbound.

If the above changes do not fix everything make sure that you test 
exactly what the real clients will be doing. Specifically that they are 
making contact to servers on port 80 or directly to Squid port 3128. 
They know *nothing* about port 8080 existence so have no reason to send 
anything that way directly.


HTH
Amos

_______________________________________________
squid-users mailing list
<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A> &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>&gt; 
<A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20221130/d5f4e551/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20221130/d5f4e551/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="025464.html">[squid-users] transparent mode squid on centos 9 with iptables (part 2)
</A></li>
	<LI>Next message (by thread): <A HREF="025479.html">[squid-users] transparent mode squid on centos 9 with iptables (part 2)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25476">[ date ]</a>
              <a href="thread.html#25476">[ thread ]</a>
              <a href="subject.html#25476">[ subject ]</a>
              <a href="author.html#25476">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
