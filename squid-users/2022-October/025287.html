<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] LDAP search filter for FreeIPA
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20LDAP%20search%20filter%20for%20FreeIPA&In-Reply-To=%3C7981c308-16e9-6b46-32f1-6a4d78f2537e%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="025284.html">
   <LINK REL="Next"  HREF="025288.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] LDAP search filter for FreeIPA</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20LDAP%20search%20filter%20for%20FreeIPA&In-Reply-To=%3C7981c308-16e9-6b46-32f1-6a4d78f2537e%40treenet.co.nz%3E"
       TITLE="[squid-users] LDAP search filter for FreeIPA">squid3 at treenet.co.nz
       </A><BR>
    <I>Thu Oct  6 02:40:59 UTC 2022</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="025284.html">[squid-users] LDAP search filter for FreeIPA
</A></li>
        <LI>Next message (by thread): <A HREF="025288.html">[squid-users] LDAP search filter for FreeIPA
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25287">[ date ]</a>
              <a href="thread.html#25287">[ thread ]</a>
              <a href="subject.html#25287">[ subject ]</a>
              <a href="author.html#25287">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 6/10/22 02:29, Djerk Geurts wrote:
&gt;<i> Hi,
</I>&gt;<i> 
</I>&gt;<i> I&#8217;ve got DLAP auth working against FreeIPA, but now I&#8217;m trying to get 
</I>&gt;<i> LDAP group all controls working. Initially I used the local unix group 
</I>&gt;<i> filter, which works great as the machine running Squid is&#160;able to query 
</I>&gt;<i> group membership through pam. But then I found that nested group 
</I>&gt;<i> membership didn&#8217;t work. So now I&#8217;m trying to query group membership via 
</I>&gt;<i> LDAP and failing miserably.
</I>&gt;<i> 
</I>&gt;<i> My config:
</I>&gt;<i> 
</I>&gt;<i> auth_param basic program /usr/lib/squid/basic_ldap_auth -v 3 -b 
</I>&gt;<i> &quot;cn=users,cn=accounts,dc=DOMAIN,dc=COM&quot; -D 
</I>&gt;<i> &quot;uid=squid-ldap,cn=sysaccounts,cn=etc,dc=DOMAIN,dc=COM&quot; 
</I>&gt;<i> -W&#160;&quot;/etc/squid/squid-ldap.cred&quot; -u uid -H <A HREF="LDAPS://ipa.domain.com:636">LDAPS://ipa.domain.com:636</A> 
</I>&gt;<i> &lt;<A HREF="ldaps://ipa.domain.com:636">ldaps://ipa.domain.com:636</A>&gt;
</I>&gt;<i> [&#8230;]
</I>&gt;<i> 
</I>
To clarify, does the above description mean login with this helper works 
fine?


 &gt; external_acl_type ldap_group %LOGIN .../ext_ldap_group_acl \
 &gt;   -v 3 \

FYI: LDAP v3 is the default. You should not need to set this.


 &gt;   -b &quot;cn=groups,cn=accounts,dc=DOMAIN,dc=COM&quot; \
 &gt;   -f &quot;(&amp;(cn=%g)(member=uid=%u))&quot; \
 &gt; ...


You can add '-d' (lower case) to get a debug trace in cache.log about 
what is happening inside the helper.

You can use that to confirm the user/group details are arriving properly 
and the filter string is correct before it goes sent to LDAP.

Also, see whether LDAP is having connectivity issues, or search issues, 
or something else is going on.


FWIW, the above reads to me like you are looking up the existence of the 
group rather than the existence of a specific user within a group. My 
LDAP knowledge is weak, so I may be wrong about that.


&gt;<i> 
</I>&gt;<i> This ldap search works fine:
</I>&gt;<i> 
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">user at ipa</A>:~$ ldapsearch -x -D 'cn=Directory Manager' -W -b 
</I>&gt;<i> &quot;cn=groups,cn=accounts,dc=DOMAIN,dc=COM&quot; '(&amp;(cn=proxy)(member=uid=user,*))'
</I>
I notice that there is an extra ',*' after the username in this filter 
string which is missing on the helper one.



&gt;<i> Enter LDAP Password:
</I>&gt;<i> # extended LDIF
</I>&gt;<i> #
</I>&gt;<i> # LDAPv3
</I>&gt;<i> # base &lt;cn=groups,cn=accounts,dc=DOMAIN,dc=COM&gt; with scope subtree
</I>&gt;<i> # filter: (&amp;(cn=proxy)(member=uid=user,*))
</I>&gt;<i> # requesting: ALL
</I>&gt;<i> #
</I>
...

&gt;<i> 
</I>&gt;<i> So how am I meant to set the filter of ext_ldap_group_acl?
</I>

FYI, what the Squid helpers do is replace the %g and %u values and pass 
the resulting string as the 'filter' to LDAP.

Meaning that the filter used by Squid should be the same as the 
ldapsearch filter would be if you were searching for username &quot;%u&quot; in 
group &quot;%g&quot;.


Also, be aware that the filter string/pattern should be constructed in a 
way that correctly handles non-ASCII characters or whitespace if those 
are possible in your credentials and/or group names.


HTH
Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="025284.html">[squid-users] LDAP search filter for FreeIPA
</A></li>
	<LI>Next message (by thread): <A HREF="025288.html">[squid-users] LDAP search filter for FreeIPA
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25287">[ date ]</a>
              <a href="thread.html#25287">[ thread ]</a>
              <a href="subject.html#25287">[ subject ]</a>
              <a href="author.html#25287">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
