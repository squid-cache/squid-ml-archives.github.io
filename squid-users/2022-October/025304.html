<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] FW: Encrypted browser-Squid connection errors
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20FW%3A%20Encrypted%20browser-Squid%20connection%20errors&In-Reply-To=%3C6774a0af-b9bd-1aed-7474-1f439c05cd7c%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="025303.html">
   <LINK REL="Next"  HREF="025306.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] FW: Encrypted browser-Squid connection errors</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20FW%3A%20Encrypted%20browser-Squid%20connection%20errors&In-Reply-To=%3C6774a0af-b9bd-1aed-7474-1f439c05cd7c%40measurement-factory.com%3E"
       TITLE="[squid-users] FW: Encrypted browser-Squid connection errors">rousskov at measurement-factory.com
       </A><BR>
    <I>Fri Oct 14 17:34:06 UTC 2022</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="025303.html">[squid-users] FW: Encrypted browser-Squid connection errors
</A></li>
        <LI>Next message (by thread): <A HREF="025306.html">[squid-users] FW: Encrypted browser-Squid connection errors
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25304">[ date ]</a>
              <a href="thread.html#25304">[ thread ]</a>
              <a href="subject.html#25304">[ subject ]</a>
              <a href="author.html#25304">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 10/14/22 10:32, LEMRAZZEQ, Wadie wrote:
&gt;<i> I tried to implement this on a dockerized Alpine, and a squid 5.5 with openssl module
</I>
FWIW, Squid v5.5 is unusable in many environments -- too many bugs. Use 
v5.7 or later. I do not know whether one of those bugs are responsible 
for the specific problem you are discussing though.


&gt;<i> in squid.conf, I have:
</I>&gt;<i> 
</I>&gt;<i> ...
</I>&gt;<i> 
</I>&gt;<i> http_port 3128
</I>&gt;<i> 
</I>&gt;<i> https_port 3129 cert=/etc/squid/crt.pem key=/etc/squid/key.pem
</I>
OK.


&gt;<i> but when I request squid https port, I got this error every time, in 
</I>&gt;<i> cache.log:
</I>
_How_ do you &quot;request squid https port&quot;?


&gt;<i> ERROR: failure while accepting a TLS connection on conn77 
</I>&gt;<i> local=172.17.0.2:3129 remote=172.17.0.1:56608 FD 12 flags=1: 
</I>&gt;<i> 
</I>&gt;<i> connection: conn77 local=172.17.0.2:3129 remote=172.17.0.1:56608 FD 12 flags=1
</I>&gt;<i> 
</I>&gt;<i> Error.cc(22) update: recent: 
</I>&gt;<i> ERR_SECURE_ACCEPT_FAIL/SQUID_TLS_ERR_ACCEPT+TLS_LIB_ERR=1408F09B+TLS_IO_ERR=1
</I>
According to &quot;openssl errstr&quot;, that OpenSSL error is:

     error:1408F09B:SSL routines:ssl3_get_record:https proxy request


Most likely, the client is sending a plain text CONNECT request before 
encrypting the TLS connection to the HTTPS proxy. In other words, the 
client thinks it is talking to an HTTP proxy while you want it to think 
that it is talking to an HTTPS proxy. For example,

* HTTP proxy:  curl -x <A HREF="http://172.17.0.2:3128/">http://172.17.0.2:3128/</A> ... <A HREF="https://example.com">https://example.com</A>
* HTTPS proxy: curl -x <A HREF="https://172.17.0.2:3129/">https://172.17.0.2:3129/</A> ... <A HREF="https://example.com">https://example.com</A>


HTH,

Alex.




&gt;<i> ...
</I>&gt;<i> 
</I>&gt;<i> I also tried this with squid 4.10 with gnutls module, in an Ubuntu 20.40 
</I>&gt;<i> environment, with the same squid.conf, and I got again a TLS error
</I>&gt;<i> 
</I>&gt;<i> ...
</I>&gt;<i> 
</I>&gt;<i> client_side.cc(2597) tlsAttemptHandshake: Error negotiating TLS on 
</I>&gt;<i> local=x.x.x.x:3129 remote=x.x.x.x:50874 FD 11 flags=1: Aborted by 
</I>&gt;<i> client: An unexpected TLS packet was received.
</I>&gt;<i> 
</I>&gt;<i> ...
</I>&gt;<i> 
</I>&gt;<i> I used for certificates, a self signed one, and a generated certificate 
</I>&gt;<i> signed by our CA, for both scenarios
</I>&gt;<i> 
</I>&gt;<i> Also, I tried multiple https_port options (disable some SSL 
</I>&gt;<i> implementation, manipulation of client certificates...) but without success
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="025303.html">[squid-users] FW: Encrypted browser-Squid connection errors
</A></li>
	<LI>Next message (by thread): <A HREF="025306.html">[squid-users] FW: Encrypted browser-Squid connection errors
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25304">[ date ]</a>
              <a href="thread.html#25304">[ thread ]</a>
              <a href="subject.html#25304">[ subject ]</a>
              <a href="author.html#25304">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
