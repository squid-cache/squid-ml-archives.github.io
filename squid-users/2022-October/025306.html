<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] FW: Encrypted browser-Squid connection errors
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20FW%3A%20Encrypted%20browser-Squid%20connection%20errors&In-Reply-To=%3CDBAPR02MB6149F46E4378E1069758569EF5289%40DBAPR02MB6149.eurprd02.prod.outlook.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="025304.html">
   <LINK REL="Next"  HREF="025307.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] FW: Encrypted browser-Squid connection errors</H1>
    <B>LEMRAZZEQ, Wadie</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20FW%3A%20Encrypted%20browser-Squid%20connection%20errors&In-Reply-To=%3CDBAPR02MB6149F46E4378E1069758569EF5289%40DBAPR02MB6149.eurprd02.prod.outlook.com%3E"
       TITLE="[squid-users] FW: Encrypted browser-Squid connection errors">wadie.lemrazzeq at capgemini.com
       </A><BR>
    <I>Tue Oct 18 08:55:23 UTC 2022</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="025304.html">[squid-users] FW: Encrypted browser-Squid connection errors
</A></li>
        <LI>Next message (by thread): <A HREF="025307.html">[squid-users] FW: Encrypted browser-Squid connection errors
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25306">[ date ]</a>
              <a href="thread.html#25306">[ thread ]</a>
              <a href="subject.html#25306">[ subject ]</a>
              <a href="author.html#25306">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>&gt;<i> On 10/14/22 10:32, LEMRAZZEQ, Wadie wrote:
</I>&gt;&gt;<i> I tried to implement this on a dockerized Alpine, and a squid 5.5 with 
</I>&gt;&gt;<i> openssl module
</I>
&gt;<i> FWIW, Squid v5.5 is unusable in many environments -- too many bugs. Use
</I>&gt;<i> v5.7 or later. I do not know whether one of those bugs are responsible for the specific problem you are discussing though.
</I>
I tried with squid 5.7, but still have the same issue

&gt;&gt;<i> but when I request squid https port, I got this error every time, in
</I>&gt;&gt;<i> cache.log:
</I>
&gt;<i> _How_ do you &quot;request squid https port&quot;?
</I>
Ah sorry didn't mentioned that I have problem only web browsers (Firefox, chromium), and I do specify to use https proxy in the browser proxy config
But if I use curl, it works

&gt;&gt;<i> ERROR: failure while accepting a TLS connection on conn77
</I>&gt;&gt;<i> local=172.17.0.2:3129 remote=172.17.0.1:56608 FD 12 flags=1: 
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> connection: conn77 local=172.17.0.2:3129 remote=172.17.0.1:56608 FD 12 
</I>&gt;&gt;<i> flags=1
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> Error.cc(22) update: recent: 
</I>&gt;&gt;<i> ERR_SECURE_ACCEPT_FAIL/SQUID_TLS_ERR_ACCEPT+TLS_LIB_ERR=1408F09B+TLS_I
</I>&gt;&gt;<i> O_ERR=1
</I>
&gt;<i> According to &quot;openssl errstr&quot;, that OpenSSL error is:
</I>
&gt;<i>      error:1408F09B:SSL routines:ssl3_get_record:https proxy request
</I>

&gt;<i> Most likely, the client is sending a plain text CONNECT request before encrypting the TLS connection to the HTTPS proxy. In other words, the client thinks it is talking to an HTTP proxy while &gt; you want it to think that it is talking to an HTTPS proxy. For example,
</I>
&gt;<i> * HTTP proxy:  curl -x <A HREF="http://172.17.0.2:3128/">http://172.17.0.2:3128/</A> ... <A HREF="https://example.com">https://example.com</A>
</I>&gt;<i> * HTTPS proxy: curl -x <A HREF="https://172.17.0.2:3129/">https://172.17.0.2:3129/</A> ... <A HREF="https://example.com">https://example.com</A>
</I>
Yes indeed, requesting with curl works unless the web browsers




&gt;<i> ...
</I>&gt;<i> 
</I>&gt;<i> I also tried this with squid 4.10 with gnutls module, in an Ubuntu 
</I>&gt;<i> 20.40 environment, with the same squid.conf, and I got again a TLS 
</I>&gt;<i> error
</I>&gt;<i> 
</I>&gt;<i> ...
</I>&gt;<i> 
</I>&gt;<i> client_side.cc(2597) tlsAttemptHandshake: Error negotiating TLS on
</I>&gt;<i> local=x.x.x.x:3129 remote=x.x.x.x:50874 FD 11 flags=1: Aborted by
</I>&gt;<i> client: An unexpected TLS packet was received.
</I>&gt;<i> 
</I>&gt;<i> ...
</I>&gt;<i> 
</I>&gt;<i> I used for certificates, a self signed one, and a generated 
</I>&gt;<i> certificate signed by our CA, for both scenarios
</I>&gt;<i> 
</I>&gt;<i> Also, I tried multiple https_port options (disable some SSL 
</I>&gt;<i> implementation, manipulation of client certificates...) but without 
</I>&gt;<i> success
</I>
_______________________________________________
squid-users mailing list
<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
<A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>

This message contains information that may be privileged or confidential and is the property of the Capgemini Group. It is intended only for the person to whom it is addressed. If you are not the intended recipient, you are not authorized to read, print, retain, copy, disseminate, distribute, or use this message or any part thereof. If you receive this message in error, please notify the sender immediately and delete all copies of this message.


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="025304.html">[squid-users] FW: Encrypted browser-Squid connection errors
</A></li>
	<LI>Next message (by thread): <A HREF="025307.html">[squid-users] FW: Encrypted browser-Squid connection errors
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25306">[ date ]</a>
              <a href="thread.html#25306">[ thread ]</a>
              <a href="subject.html#25306">[ subject ]</a>
              <a href="author.html#25306">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
