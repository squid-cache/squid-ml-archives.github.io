<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Empty transfer-encoding header causes 502 response
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Empty%20transfer-encoding%20header%20causes%20502%20response&In-Reply-To=%3C42f81feb-2563-9ca7-38cc-e0114a0ca417%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="025337.html">
   <LINK REL="Next"  HREF="025350.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Empty transfer-encoding header causes 502 response</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Empty%20transfer-encoding%20header%20causes%20502%20response&In-Reply-To=%3C42f81feb-2563-9ca7-38cc-e0114a0ca417%40measurement-factory.com%3E"
       TITLE="[squid-users] Empty transfer-encoding header causes 502 response">rousskov at measurement-factory.com
       </A><BR>
    <I>Tue Oct 25 13:07:56 UTC 2022</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="025337.html">[squid-users] Empty transfer-encoding header causes 502 response
</A></li>
        <LI>Next message (by thread): <A HREF="025350.html">[squid-users] Empty transfer-encoding header causes 502 response
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25338">[ date ]</a>
              <a href="thread.html#25338">[ thread ]</a>
              <a href="subject.html#25338">[ subject ]</a>
              <a href="author.html#25338">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 10/23/22 20:36, Matthew H wrote:
&gt;<i> Hi,
</I>&gt;<i> 
</I>&gt;<i> I'm using Squid to proxy HTTP requests to another proxy. I can see squid 
</I>&gt;<i> sending the request to the parent and getting a response, but it sends 
</I>&gt;<i> the client that initiated the request a 502 Bad Gateway response.
</I>&gt;<i> 
</I>&gt;<i> On closer inspection it appears the parent proxy is sending an 
</I>&gt;<i> empty&#160;transfer-encoding header, and this is causing Squid to send a 502. 
</I>
Do you know whether the response body was using chunked (or any other 
non-identity) encoding? I have already added your case to the list of 
known rejected responses[1], but it would be good to update that with 
the information on the actual response encoding.

[1] <A HREF="https://github.com/squid-cache/squid/pull/702#issuecomment-762459132">https://github.com/squid-cache/squid/pull/702#issuecomment-762459132</A>

If the very first bytes of the response are &quot;&lt;html&quot; or similar, then no 
encoding was probably applied. If you see what can be interpreted as a 
small hex number followed by a new line, then chunked encoding was 
probably applied (at least). If you cannot tell, or are not sure, feel 
free to share the response packet in libpcap format, captured with 
wireshark or &quot;tcpdump -s0&quot;.


Thank you,

Alex.



&gt;<i> 2022/10/24 00:23:59.106| ctx: enter level &#160;0: '<A HREF="http://nintendo.com/">http://nintendo.com/</A> 
</I>&gt;<i> &lt;<A HREF="http://nintendo.com/">http://nintendo.com/</A>&gt;'
</I>&gt;<i> 2022/10/24 00:23:59.106| 11,3| http.cc(666) processReplyHeader: 
</I>&gt;<i> processReplyHeader: key '19010000000000000C00000000000000'
</I>&gt;<i> 2022/10/24 00:23:59.106| 11,2| http.cc(720) processReplyHeader: HTTP 
</I>&gt;<i> Server conn294 local=172.25.0.3:57802 
</I>&gt;<i> &lt;<A HREF="http://172.25.0.3:57802/">http://172.25.0.3:57802/</A>&gt;&#160;remote=159.203.14.9:1996 
</I>&gt;<i> &lt;<A HREF="http://159.203.14.9:1996/">http://159.203.14.9:1996/</A>&gt;&#160;FIRSTUP_PARENT FD 26 flags=1
</I>&gt;<i> 2022/10/24 00:23:59.106| 11,2| http.cc(721) processReplyHeader: HTTP 
</I>&gt;<i> Server RESPONSE:
</I>&gt;<i> ---------
</I>&gt;<i> HTTP/1.1 200 OK
</I>&gt;<i> x-powered-by: Express
</I>&gt;<i> content-type: text/html; charset=iso-8859-1
</I>&gt;<i> transfer-encoding:
</I>&gt;<i> date: Mon, 24 Oct 2022 00:23:57 GMT
</I>&gt;<i> connection: close
</I>&gt;<i> 
</I>&gt;<i> ----------
</I>&gt;<i> 2022/10/24 00:23:59.106| 55,3| HttpHeader.cc(882) getList: empty list 
</I>&gt;<i> header: Transfer-Encoding(Transfer-Encoding[63])
</I>&gt;<i> 2022/10/24 00:23:59.106| 55,2| HttpHeader.cc(559) parse: WARNING: 
</I>&gt;<i> unsupported Transfer-Encoding used by client:
</I>&gt;<i> 2022/10/24 00:23:59.106| ctx: exit level &#160;0
</I>&gt;<i> 2022/10/24 00:23:59.106| 20,3| store.cc(1673) reset: 
</I>&gt;<i> <A HREF="http://nintendo.com/">http://nintendo.com/</A> &lt;<A HREF="http://nintendo.com/">http://nintendo.com/</A>&gt;
</I>&gt;<i> 2022/10/24 00:23:59.107| 17,3| FwdState.cc(492) fail: ERR_INVALID_RESP 
</I>&gt;<i> &quot;Bad Gateway&quot;
</I>&gt;<i> <A HREF="http://nintendo.com/">http://nintendo.com/</A> &lt;<A HREF="http://nintendo.com/">http://nintendo.com/</A>&gt;
</I>&gt;<i> 2022/10/24 00:23:59.107| 17,3| FwdState.cc(533) unregister: 
</I>&gt;<i> <A HREF="http://nintendo.com/">http://nintendo.com/</A> &lt;<A HREF="http://nintendo.com/">http://nintendo.com/</A>&gt;
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="025337.html">[squid-users] Empty transfer-encoding header causes 502 response
</A></li>
	<LI>Next message (by thread): <A HREF="025350.html">[squid-users] Empty transfer-encoding header causes 502 response
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25338">[ date ]</a>
              <a href="thread.html#25338">[ thread ]</a>
              <a href="subject.html#25338">[ subject ]</a>
              <a href="author.html#25338">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
