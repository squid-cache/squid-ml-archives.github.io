<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Empty transfer-encoding header causes 502 response
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Empty%20transfer-encoding%20header%20causes%20502%20response&In-Reply-To=%3Cc448aa28-617e-1ec5-a24e-39a757421cc9%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="025350.html">
   <LINK REL="Next"  HREF="025341.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Empty transfer-encoding header causes 502 response</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Empty%20transfer-encoding%20header%20causes%20502%20response&In-Reply-To=%3Cc448aa28-617e-1ec5-a24e-39a757421cc9%40measurement-factory.com%3E"
       TITLE="[squid-users] Empty transfer-encoding header causes 502 response">rousskov at measurement-factory.com
       </A><BR>
    <I>Wed Oct 26 13:20:14 UTC 2022</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="025350.html">[squid-users] Empty transfer-encoding header causes 502 response
</A></li>
        <LI>Next message (by thread): <A HREF="025341.html">[squid-users] Squid 5: server_cert_fingerprint not working fine...
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25355">[ date ]</a>
              <a href="thread.html#25355">[ thread ]</a>
              <a href="subject.html#25355">[ subject ]</a>
              <a href="author.html#25355">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 10/25/22 20:55, Matthew H wrote:

&gt;<i> I have included the requested output from tcpdump below:
</I>
Thank you! This raw output is sufficient to determine that no transfer 
encoding was used by this buggy origin server. I have updated the GitHub 
comment/summary accordingly.

N.B. In the future, please consider sharing libpcap packet captures 
instead of raw tcpdump console output. It is not necessary to re-share 
anything now.

FWIW, I am not aware of any official Squid workarounds for this origin 
server bug. Some of the features Factory is currently working on will be 
useful here, but they are not yet ready for the official submission. One 
can remove the corresponding check from Squid source code, of course, 
but doing so will open modified Squid (and other HTTP agents) to serious 
security vulnerabilities, so I cannot recommend such a blunt workaround.

Alex.


&gt;<i>  &#160;tcpdump -A -s 0 -ni enp4s0 &quot;host 159.203.14.9 and (((ip[2:2] - 
</I>&gt;<i> ((ip[0]&amp;0xf)&lt;&lt;2)) - ((tcp[12]&amp;
</I>&gt;<i> 0xf0)&gt;&gt;2)) != 0)&quot;
</I>&gt;<i> tcpdump: verbose output suppressed, use -v[v]... for full protocol decode
</I>&gt;<i> listening on enp4s0, link-type EN10MB (Ethernet), snapshot length 262144 
</I>&gt;<i> bytes
</I>&gt;<i> 
</I>&gt;<i> 01:40:17.310479 IP 10.0.160.10.43426 &gt; 159.203.14.9.1996: Flags [P.], 
</I>&gt;<i> seq 2955630477:2955630939, ack 2382737005, win 502, options [nop,nop,TS 
</I>&gt;<i> val 3000375654 ecr 1932743995], length 462
</I>&gt;<i> E....:@.?.7.
</I>&gt;<i> ..
</I>&gt;<i> ... &#160; &#160; .....+W....m....Y......
</I>&gt;<i> ...fs3U;GET <A HREF="http://nintendo.com/">http://nintendo.com/</A> &lt;<A HREF="http://nintendo.com/">http://nintendo.com/</A>&gt; HTTP/1.1
</I>&gt;<i> User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:106.0) 
</I>&gt;<i> Gecko/20100101 Firefox/106.0
</I>&gt;<i> Accept: 
</I>&gt;<i> text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8
</I>&gt;<i> Accept-Language: en-GB,en;q=0.5
</I>&gt;<i> Accept-Encoding: gzip, deflate
</I>&gt;<i> Upgrade-Insecure-Requests: 1
</I>&gt;<i> Host: nintendo.com &lt;<A HREF="http://nintendo.com">http://nintendo.com</A>&gt;
</I>&gt;<i> Via: 1.1 dce3749b9671 (squid/5.6)
</I>&gt;<i> X-Forwarded-For: 10.0.130.210
</I>&gt;<i> Cache-Control: max-age=259200
</I>&gt;<i> Connection: keep-alive
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 01:40:18.957475 IP 159.203.14.9.1996 &gt; 10.0.160.10.43426: Flags [P.], 
</I>&gt;<i> seq 1:1466, ack 462, win 114, options [nop,nop,TS val 1932744407 ecr 
</I>&gt;<i> 3000375654], length 1465
</I>&gt;<i> E....@@.3......
</I>&gt;<i> ..
</I>&gt;<i> .......m.+Y[...r]......
</I>&gt;<i> s3V....fHTTP/1.1 200 OK
</I>&gt;<i> x-powered-by: Express
</I>&gt;<i> content-type: text/html; charset=iso-8859-1
</I>&gt;<i> transfer-encoding:
</I>&gt;<i> date: Wed, 26 Oct 2022 00:40:20 GMT
</I>&gt;<i> connection: close
</I>&gt;<i> 
</I>&gt;<i> &lt;!DOCTYPE html PUBLIC &quot;-//IETF//DTD HTML 2.0//EN&quot;&gt;&lt;html&gt;&lt;head&gt;
</I>&gt;<i> &lt;!-- this automatically loads the hallway after 20 seconds --&gt;
</I>&gt;<i> &lt;meta http-equiv=&quot;refresh&quot; content=&quot;20; 
</I>&gt;<i> url=<A HREF="http://nintendo.com//./hallway/index.html">http://nintendo.com//./hallway/index.html</A> 
</I>&gt;<i> &lt;<A HREF="http://nintendo.com//./hallway/index.html">http://nintendo.com//./hallway/index.html</A>&gt;&quot;&gt;
</I>&gt;<i> &lt;title&gt;Nintendo Power Source&lt;/title&gt;
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> On Tue, Oct 25, 2022 at 2:08 PM Alex Rousskov 
</I>&gt;<i> &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A> 
</I>&gt;<i> &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt;&gt; wrote:
</I>&gt;<i> 
</I>&gt;<i>     On 10/23/22 20:36, Matthew H wrote:
</I>&gt;<i>      &gt; Hi,
</I>&gt;<i>      &gt;
</I>&gt;<i>      &gt; I'm using Squid to proxy HTTP requests to another proxy. I can
</I>&gt;<i>     see squid
</I>&gt;<i>      &gt; sending the request to the parent and getting a response, but it
</I>&gt;<i>     sends
</I>&gt;<i>      &gt; the client that initiated the request a 502 Bad Gateway response.
</I>&gt;<i>      &gt;
</I>&gt;<i>      &gt; On closer inspection it appears the parent proxy is sending an
</I>&gt;<i>      &gt; empty&#160;transfer-encoding header, and this is causing Squid to send
</I>&gt;<i>     a 502.
</I>&gt;<i> 
</I>&gt;<i>     Do you know whether the response body was using chunked (or any other
</I>&gt;<i>     non-identity) encoding? I have already added your case to the list of
</I>&gt;<i>     known rejected responses[1], but it would be good to update that with
</I>&gt;<i>     the information on the actual response encoding.
</I>&gt;<i> 
</I>&gt;<i>     [1]
</I>&gt;<i>     <A HREF="https://github.com/squid-cache/squid/pull/702#issuecomment-762459132">https://github.com/squid-cache/squid/pull/702#issuecomment-762459132</A>
</I>&gt;<i>     &lt;<A HREF="https://github.com/squid-cache/squid/pull/702#issuecomment-762459132">https://github.com/squid-cache/squid/pull/702#issuecomment-762459132</A>&gt;
</I>&gt;<i> 
</I>&gt;<i>     If the very first bytes of the response are &quot;&lt;html&quot; or similar, then no
</I>&gt;<i>     encoding was probably applied. If you see what can be interpreted as a
</I>&gt;<i>     small hex number followed by a new line, then chunked encoding was
</I>&gt;<i>     probably applied (at least). If you cannot tell, or are not sure, feel
</I>&gt;<i>     free to share the response packet in libpcap format, captured with
</I>&gt;<i>     wireshark or &quot;tcpdump -s0&quot;.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i>     Thank you,
</I>&gt;<i> 
</I>&gt;<i>     Alex.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i>      &gt; 2022/10/24 00:23:59.106| ctx: enter level &#160;0:
</I>&gt;<i>     '<A HREF="http://nintendo.com/">http://nintendo.com/</A> &lt;<A HREF="http://nintendo.com/">http://nintendo.com/</A>&gt;
</I>&gt;<i>      &gt; &lt;<A HREF="http://nintendo.com/">http://nintendo.com/</A> &lt;<A HREF="http://nintendo.com/">http://nintendo.com/</A>&gt;&gt;'
</I>&gt;<i>      &gt; 2022/10/24 00:23:59.106| 11,3| http.cc(666) processReplyHeader:
</I>&gt;<i>      &gt; processReplyHeader: key '19010000000000000C00000000000000'
</I>&gt;<i>      &gt; 2022/10/24 00:23:59.106| 11,2| http.cc(720) processReplyHeader: HTTP
</I>&gt;<i>      &gt; Server conn294 local=172.25.0.3:57802 &lt;<A HREF="http://172.25.0.3:57802">http://172.25.0.3:57802</A>&gt;
</I>&gt;<i>      &gt; &lt;<A HREF="http://172.25.0.3:57802/">http://172.25.0.3:57802/</A>
</I>&gt;<i>     &lt;<A HREF="http://172.25.0.3:57802/">http://172.25.0.3:57802/</A>&gt;&gt;&#160;remote=159.203.14.9:1996
</I>&gt;<i>     &lt;<A HREF="http://159.203.14.9:1996">http://159.203.14.9:1996</A>&gt;
</I>&gt;<i>      &gt; &lt;<A HREF="http://159.203.14.9:1996/">http://159.203.14.9:1996/</A>
</I>&gt;<i>     &lt;<A HREF="http://159.203.14.9:1996/">http://159.203.14.9:1996/</A>&gt;&gt;&#160;FIRSTUP_PARENT FD 26 flags=1
</I>&gt;<i>      &gt; 2022/10/24 00:23:59.106| 11,2| http.cc(721) processReplyHeader: HTTP
</I>&gt;<i>      &gt; Server RESPONSE:
</I>&gt;<i>      &gt; ---------
</I>&gt;<i>      &gt; HTTP/1.1 200 OK
</I>&gt;<i>      &gt; x-powered-by: Express
</I>&gt;<i>      &gt; content-type: text/html; charset=iso-8859-1
</I>&gt;<i>      &gt; transfer-encoding:
</I>&gt;<i>      &gt; date: Mon, 24 Oct 2022 00:23:57 GMT
</I>&gt;<i>      &gt; connection: close
</I>&gt;<i>      &gt;
</I>&gt;<i>      &gt; ----------
</I>&gt;<i>      &gt; 2022/10/24 00:23:59.106| 55,3| HttpHeader.cc(882) getList: empty
</I>&gt;<i>     list
</I>&gt;<i>      &gt; header: Transfer-Encoding(Transfer-Encoding[63])
</I>&gt;<i>      &gt; 2022/10/24 00:23:59.106| 55,2| HttpHeader.cc(559) parse: WARNING:
</I>&gt;<i>      &gt; unsupported Transfer-Encoding used by client:
</I>&gt;<i>      &gt; 2022/10/24 00:23:59.106| ctx: exit level &#160;0
</I>&gt;<i>      &gt; 2022/10/24 00:23:59.106| 20,3| store.cc(1673) reset:
</I>&gt;<i>      &gt; <A HREF="http://nintendo.com/">http://nintendo.com/</A> &lt;<A HREF="http://nintendo.com/">http://nintendo.com/</A>&gt; &lt;<A HREF="http://nintendo.com/">http://nintendo.com/</A>
</I>&gt;<i>     &lt;<A HREF="http://nintendo.com/">http://nintendo.com/</A>&gt;&gt;
</I>&gt;<i>      &gt; 2022/10/24 00:23:59.107| 17,3| FwdState.cc(492) fail:
</I>&gt;<i>     ERR_INVALID_RESP
</I>&gt;<i>      &gt; &quot;Bad Gateway&quot;
</I>&gt;<i>      &gt; <A HREF="http://nintendo.com/">http://nintendo.com/</A> &lt;<A HREF="http://nintendo.com/">http://nintendo.com/</A>&gt; &lt;<A HREF="http://nintendo.com/">http://nintendo.com/</A>
</I>&gt;<i>     &lt;<A HREF="http://nintendo.com/">http://nintendo.com/</A>&gt;&gt;
</I>&gt;<i>      &gt; 2022/10/24 00:23:59.107| 17,3| FwdState.cc(533) unregister:
</I>&gt;<i>      &gt; <A HREF="http://nintendo.com/">http://nintendo.com/</A> &lt;<A HREF="http://nintendo.com/">http://nintendo.com/</A>&gt; &lt;<A HREF="http://nintendo.com/">http://nintendo.com/</A>
</I>&gt;<i>     &lt;<A HREF="http://nintendo.com/">http://nintendo.com/</A>&gt;&gt;
</I>&gt;<i>      &gt;
</I>&gt;<i>      &gt; _______________________________________________
</I>&gt;<i>      &gt; squid-users mailing list
</I>&gt;<i>      &gt; <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i>     &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>&gt;
</I>&gt;<i>      &gt; <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i>     &lt;<A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>&gt;
</I>&gt;<i> 
</I>&gt;<i>     _______________________________________________
</I>&gt;<i>     squid-users mailing list
</I>&gt;<i>     <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i>     &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>&gt;
</I>&gt;<i>     <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i>     &lt;<A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>&gt;
</I>&gt;<i> 
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="025350.html">[squid-users] Empty transfer-encoding header causes 502 response
</A></li>
	<LI>Next message (by thread): <A HREF="025341.html">[squid-users] Squid 5: server_cert_fingerprint not working fine...
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25355">[ date ]</a>
              <a href="thread.html#25355">[ thread ]</a>
              <a href="subject.html#25355">[ subject ]</a>
              <a href="author.html#25355">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
