<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Scaling concurrent TCP sessions beyond ephemeral port range
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Scaling%20concurrent%20TCP%20sessions%20beyond%20ephemeral%0A%20port%20range&In-Reply-To=%3CCACabJxP1f8YhngBG6WzkRZ4W%2BRzcM4cc0HoXo2%3D5bGsQCFUsBQ%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="025207.html">
   <LINK REL="Next"  HREF="025192.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Scaling concurrent TCP sessions beyond ephemeral port range</H1>
    <B>Praveen Ponakanti</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Scaling%20concurrent%20TCP%20sessions%20beyond%20ephemeral%0A%20port%20range&In-Reply-To=%3CCACabJxP1f8YhngBG6WzkRZ4W%2BRzcM4cc0HoXo2%3D5bGsQCFUsBQ%40mail.gmail.com%3E"
       TITLE="[squid-users] Scaling concurrent TCP sessions beyond ephemeral port range">pponakanti at roblox.com
       </A><BR>
    <I>Thu Sep  8 23:41:25 UTC 2022</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="025207.html">[squid-users] [Troubleshoot] Squid 3.3 - Lots of 403 erros when reducing the workers number
</A></li>
        <LI>Next message (by thread): <A HREF="025192.html">[squid-users] Scaling concurrent TCP sessions beyond ephemeral port range
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25191">[ date ]</a>
              <a href="thread.html#25191">[ thread ]</a>
              <a href="subject.html#25191">[ subject ]</a>
              <a href="author.html#25191">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Alex,


Thanks for all the help from the squid dev group with upstreaming the
enhancement to scale up outbound TCP sessions on Linux with the
IP_BIND_ADDRESS_NO_PORT sockopt flag. Our canary instances have been doing
great the last few weeks with the code patch prior to merge.


A few followup questions (not urgent) :

   - Do we know which 5.x version will include the patch? I do not see it
   listed in the change log for squid-5.7.
   - We have a large number of workers (30) to help with handling a
   high RPS. However, TCP session reuse does not seem to be optimal even with
   server_persistent_connections enabled as a new outbound session would have
   to be opened up if the request is proxied by a kid worker that doesn&#8217;t
   already have a connection to that destination. Is there something that can
   be done to improve this with later versions of squid? Would be glad to help
   out if anyone has some suggestions.

Thanks
Praveen

On Tue, Jun 21, 2022 at 2:11 PM Alex Rousskov &lt;
<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt; wrote:

&gt;<i> On 6/19/22 12:48, Praveen Ponakanti wrote:
</I>&gt;<i>
</I>&gt;<i> &gt; What is the process to have this code patch upstreamed for future squid
</I>&gt;<i> &gt; versions?
</I>&gt;<i>
</I>&gt;<i> In short, just post a quality pull request on GitHub (or find somebody
</I>&gt;<i> who can guide your code towards official acceptance for you). For
</I>&gt;<i> details, please see <A HREF="https://wiki.squid-cache.org/MergeProcedure">https://wiki.squid-cache.org/MergeProcedure</A>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Thank you,
</I>&gt;<i>
</I>&gt;<i> Alex.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; On Fri, May 20, 2022 at 9:31 PM Amos Jeffries &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>
</I>&gt;<i> &gt; wrote:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     On 20/05/22 19:44, Praveen Ponakanti wrote:
</I>&gt;<i> &gt;      &gt; Hi Alex,
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt; Thanks for going through several steps to help mitigate src port
</I>&gt;<i> &gt;      &gt; exhaustion. We are looking to achieve 400-500% more
</I>&gt;<i> &gt;      &gt; concurrent connections if we could :) as there is a
</I>&gt;<i> &gt;     significant buffer
</I>&gt;<i> &gt;      &gt; on the available CPU.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     Then you require at least 4, maybe 5, IP addresses to handle that
</I>&gt;<i> many
</I>&gt;<i> &gt;     concurrent connections with Squid.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; We would like to investigate going beyond the ephemeral port range for
</I>&gt;<i> &gt; some specific destination IP:PORT addresses. For that it appears squid
</I>&gt;<i> &gt; does not round-robin requests if we use multiple tcp_outgoing_addresses.
</I>&gt;<i> &gt; We could use ACL&#8217;s to pick a different outbound IP based on the clients
</I>&gt;<i> &gt; source IP, however that is not very ideal in our environment as our
</I>&gt;<i> &gt; clients aren&#8217;t always equally split by subnet. However, if we could
</I>&gt;<i> &gt; split by the client&#8217;s source port that might help achieve this. For
</I>&gt;<i> &gt; example something like:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; acl pool1 clientport 0-32768
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; acl pool2 clientport 32769-65536
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; tcp_outgoing_address 10.1.0.1 pool1
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; tcp_outgoing_address 10.1.0.2 pool2
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Squid's ACLs currently do not allow filtering by the client's source
</I>&gt;<i> &gt; port. We could look into a separate patch to add this functionality to
</I>&gt;<i> &gt; squid&#8217;s ACL code if that makes sense. Or is there a better way to
</I>&gt;<i> &gt; achieve this?
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Thanks
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Praveen
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;      &gt; The option to use multiple tcp_outoing_addresses appears to be
</I>&gt;<i> &gt;     promising
</I>&gt;<i> &gt;      &gt; along with some tweaks to the TCP timeouts. I guess we could use
</I>&gt;<i> &gt;     ACLs to
</I>&gt;<i> &gt;      &gt; pick a different outbound IP based on the requesting client's
</I>&gt;<i> &gt;     prefix. We
</I>&gt;<i> &gt;      &gt; had not considered that option as the ephemeral ports were no
</I>&gt;<i> longer
</I>&gt;<i> &gt;      &gt; available to other applications when squid uses most of them with
</I>&gt;<i> a
</I>&gt;<i> &gt;      &gt; single outbound IP configured. We are also looking to modify the
</I>&gt;<i> &gt;     code to
</I>&gt;<i> &gt;      &gt; use the IP_BIND_ADDRESS_NO_PORT sockopt as that could help delay
</I>&gt;<i> &gt;     port
</I>&gt;<i> &gt;      &gt; assignment with the bind() call on the outbound TCP sessions (to
</I>&gt;<i> &gt;      &gt; hopefully allow access to the 4-tuple on the socket).
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     Patches welcome.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     However, please be aware that use of the 4-tuple is often no
</I>&gt;<i> different
</I>&gt;<i> &gt;     from the 3-tuple since the dst-port is typically identical for all
</I>&gt;<i> &gt;     outgoing traffic to a given dst-IP.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     Cheers
</I>&gt;<i> &gt;     Amos
</I>&gt;<i> &gt;     _______________________________________________
</I>&gt;<i> &gt;     squid-users mailing list
</I>&gt;<i> &gt;     <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> &gt;     &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>&gt;
</I>&gt;<i> &gt;     <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i> &gt;     &lt;<A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>&gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; _______________________________________________
</I>&gt;<i> &gt; squid-users mailing list
</I>&gt;<i> &gt; <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> &gt; <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20220908/75a4db90/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20220908/75a4db90/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="025207.html">[squid-users] [Troubleshoot] Squid 3.3 - Lots of 403 erros when reducing the workers number
</A></li>
	<LI>Next message (by thread): <A HREF="025192.html">[squid-users] Scaling concurrent TCP sessions beyond ephemeral port range
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25191">[ date ]</a>
              <a href="thread.html#25191">[ thread ]</a>
              <a href="subject.html#25191">[ subject ]</a>
              <a href="author.html#25191">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
