<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Scaling concurrent TCP sessions beyond ephemeral port range
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Scaling%20concurrent%20TCP%20sessions%20beyond%20ephemeral%0A%20port%20range&In-Reply-To=%3CCACabJxMXendT2FFn5u9dFqYhWNrBab%3DE1k-JbWUAWV%3DqrCPW2w%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="025194.html">
   <LINK REL="Next"  HREF="025204.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Scaling concurrent TCP sessions beyond ephemeral port range</H1>
    <B>Praveen Ponakanti</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Scaling%20concurrent%20TCP%20sessions%20beyond%20ephemeral%0A%20port%20range&In-Reply-To=%3CCACabJxMXendT2FFn5u9dFqYhWNrBab%3DE1k-JbWUAWV%3DqrCPW2w%40mail.gmail.com%3E"
       TITLE="[squid-users] Scaling concurrent TCP sessions beyond ephemeral port range">pponakanti at roblox.com
       </A><BR>
    <I>Fri Sep  9 22:29:07 UTC 2022</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="025194.html">[squid-users] Scaling concurrent TCP sessions beyond ephemeral port range
</A></li>
        <LI>Next message (by thread): <A HREF="025204.html">[squid-users] Scaling concurrent TCP sessions beyond ephemeral port range
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25203">[ date ]</a>
              <a href="thread.html#25203">[ thread ]</a>
              <a href="subject.html#25203">[ subject ]</a>
              <a href="author.html#25203">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On Thu, Sep 8, 2022 at 8:31 PM Alex Rousskov &lt;
<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt; wrote:

&gt;<i> On 9/8/22 19:41, Praveen Ponakanti wrote:
</I>&gt;<i> &gt;   * We have a large number of workers (30) to help with handling a
</I>&gt;<i> &gt;     high RPS. However, TCP session reuse does not seem to be optimal
</I>&gt;<i> &gt;     even with server_persistent_connections enabled as a new outbound
</I>&gt;<i> &gt;     session would have to be opened up if the request is proxied by a
</I>&gt;<i> &gt;     kid worker that doesn&#8217;t already have a connection to that
</I>&gt;<i> &gt;     destination. Is there something that can be done to improve this
</I>&gt;<i> &gt;     with later versions of squid? Would be glad to help out if anyone
</I>&gt;<i> &gt;     has some suggestions.
</I>&gt;<i>
</I>&gt;<i> If your only concern is TCP, and the number of servers is large, then it
</I>&gt;<i> would be possible to share open Squid-server connections among workers
</I>&gt;<i> by adding code that would exchange open TCP socket descriptors using UDS
</I>&gt;<i> messages, but I doubt it is worth doing (a lot of complexity but not
</I>&gt;<i> enough gain). There may also be some advanced/modern kernel tricks that
</I>&gt;<i> we can teach Squid to use for sharing connections, but, again, I doubt
</I>&gt;<i> the complexity would be worth the benefits from such reuse.
</I>&gt;<i>
</I>
Agree, it might not make sense to increase the complexity with sharing
socket among the workers. Was thinking more on the lines of a hashmap that
the coordinator could use to pick workers that already have a TCP
connection to the destination being requested, instead of having the
workers themselves share connection details. This might introduce
significant complexity as well, so please ignore if there are better
solutions when large counts of workers are in use.


&gt;<i>
</I>&gt;<i> If most TCP servers are known a priori, and there are few of them, then
</I>&gt;<i> cache_peer standby=N feature for them might be useful.
</I>&gt;<i>
</I>&gt;<i>
</I>The TCP destinations are not always known beforehand and can run into the
thousands. However only the top 4-5 destinations have a large number of
concurrent sessions. Which are each limited to the ip_local_port_range size
in concurrent sessions now after the enhancement to add the
IP_BIND_ADDRESS_NO_PORT flag. BTW, we do not run caching on squid or have
peer caches in our deployment.

Most of the TCP connections are for HTTPS reqs, w/o TLS termination at the
squid. Does squid currently support a TLS session cache ?

Thanks
Praveen


&gt;<i> If you are dealing with TLS sessions as well, then we should add a
</I>&gt;<i> shared memory TLS session cache that all workers can tap into.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Cheers,
</I>&gt;<i>
</I>&gt;<i> Alex.
</I>&gt;<i>
</I>&gt;<i> &gt; On Tue, Jun 21, 2022 at 2:11 PM Alex Rousskov wrote:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     On 6/19/22 12:48, Praveen Ponakanti wrote:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;      &gt; What is the process to have this code patch upstreamed for future
</I>&gt;<i> &gt;     squid
</I>&gt;<i> &gt;      &gt; versions?
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     In short, just post a quality pull request on GitHub (or find
</I>&gt;<i> somebody
</I>&gt;<i> &gt;     who can guide your code towards official acceptance for you). For
</I>&gt;<i> &gt;     details, please see <A HREF="https://wiki.squid-cache.org/MergeProcedure">https://wiki.squid-cache.org/MergeProcedure</A>
</I>&gt;<i> &gt;     &lt;<A HREF="https://wiki.squid-cache.org/MergeProcedure">https://wiki.squid-cache.org/MergeProcedure</A>&gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     Thank you,
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     Alex.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;      &gt; On Fri, May 20, 2022 at 9:31 PM Amos Jeffries
</I>&gt;<i> &gt;     &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A> &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt;
</I>&gt;<i> &gt;      &gt; wrote:
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt;     On 20/05/22 19:44, Praveen Ponakanti wrote:
</I>&gt;<i> &gt;      &gt;      &gt; Hi Alex,
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt; Thanks for going through several steps to help mitigate
</I>&gt;<i> &gt;     src port
</I>&gt;<i> &gt;      &gt;      &gt; exhaustion. We are looking to achieve 400-500% more
</I>&gt;<i> &gt;      &gt;      &gt; concurrent connections if we could :) as there is a
</I>&gt;<i> &gt;      &gt;     significant buffer
</I>&gt;<i> &gt;      &gt;      &gt; on the available CPU.
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt;     Then you require at least 4, maybe 5, IP addresses to handle
</I>&gt;<i> &gt;     that many
</I>&gt;<i> &gt;      &gt;     concurrent connections with Squid.
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt; We would like to investigate going beyond the ephemeral port
</I>&gt;<i> &gt;     range for
</I>&gt;<i> &gt;      &gt; some specific destination IP:PORT addresses. For that it appears
</I>&gt;<i> &gt;     squid
</I>&gt;<i> &gt;      &gt; does not round-robin requests if we use multiple
</I>&gt;<i> &gt;     tcp_outgoing_addresses.
</I>&gt;<i> &gt;      &gt; We could use ACL&#8217;s to pick a different outbound IP based on the
</I>&gt;<i> &gt;     clients
</I>&gt;<i> &gt;      &gt; source IP, however that is not very ideal in our environment as
</I>&gt;<i> our
</I>&gt;<i> &gt;      &gt; clients aren&#8217;t always equally split by subnet. However, if we
</I>&gt;<i> could
</I>&gt;<i> &gt;      &gt; split by the client&#8217;s source port that might help achieve this.
</I>&gt;<i> For
</I>&gt;<i> &gt;      &gt; example something like:
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt; acl pool1 clientport 0-32768
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt; acl pool2 clientport 32769-65536
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt; tcp_outgoing_address 10.1.0.1 pool1
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt; tcp_outgoing_address 10.1.0.2 pool2
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt; Squid's ACLs currently do not allow filtering by the client's
</I>&gt;<i> source
</I>&gt;<i> &gt;      &gt; port. We could look into a separate patch to add this
</I>&gt;<i> &gt;     functionality to
</I>&gt;<i> &gt;      &gt; squid&#8217;s ACL code if that makes sense. Or is there a better way to
</I>&gt;<i> &gt;      &gt; achieve this?
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt; Thanks
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt; Praveen
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt; The option to use multiple tcp_outoing_addresses appears
</I>&gt;<i> to be
</I>&gt;<i> &gt;      &gt;     promising
</I>&gt;<i> &gt;      &gt;      &gt; along with some tweaks to the TCP timeouts. I guess we
</I>&gt;<i> &gt;     could use
</I>&gt;<i> &gt;      &gt;     ACLs to
</I>&gt;<i> &gt;      &gt;      &gt; pick a different outbound IP based on the requesting
</I>&gt;<i> client's
</I>&gt;<i> &gt;      &gt;     prefix. We
</I>&gt;<i> &gt;      &gt;      &gt; had not considered that option as the ephemeral ports were
</I>&gt;<i> &gt;     no longer
</I>&gt;<i> &gt;      &gt;      &gt; available to other applications when squid uses most of
</I>&gt;<i> &gt;     them with a
</I>&gt;<i> &gt;      &gt;      &gt; single outbound IP configured. We are also looking to
</I>&gt;<i> &gt;     modify the
</I>&gt;<i> &gt;      &gt;     code to
</I>&gt;<i> &gt;      &gt;      &gt; use the IP_BIND_ADDRESS_NO_PORT sockopt as that could help
</I>&gt;<i> &gt;     delay
</I>&gt;<i> &gt;      &gt;     port
</I>&gt;<i> &gt;      &gt;      &gt; assignment with the bind() call on the outbound TCP
</I>&gt;<i> &gt;     sessions (to
</I>&gt;<i> &gt;      &gt;      &gt; hopefully allow access to the 4-tuple on the socket).
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt;     Patches welcome.
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt;     However, please be aware that use of the 4-tuple is often no
</I>&gt;<i> &gt;     different
</I>&gt;<i> &gt;      &gt;     from the 3-tuple since the dst-port is typically identical
</I>&gt;<i> &gt;     for all
</I>&gt;<i> &gt;      &gt;     outgoing traffic to a given dst-IP.
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt;     Cheers
</I>&gt;<i> &gt;      &gt;     Amos
</I>&gt;<i> &gt;      &gt;     _______________________________________________
</I>&gt;<i> &gt;      &gt;     squid-users mailing list
</I>&gt;<i> &gt;      &gt; <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> &gt;     &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>&gt;
</I>&gt;<i> &gt;      &gt;     &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> &gt;     &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>&gt;&gt;
</I>&gt;<i> &gt;      &gt; <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i> &gt;     &lt;<A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>&gt;
</I>&gt;<i> &gt;      &gt;     &lt;<A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i> &gt;     &lt;<A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>&gt;&gt;
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt; _______________________________________________
</I>&gt;<i> &gt;      &gt; squid-users mailing list
</I>&gt;<i> &gt;      &gt; <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> &gt;     &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>&gt;
</I>&gt;<i> &gt;      &gt; <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i> &gt;     &lt;<A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>&gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     _______________________________________________
</I>&gt;<i> &gt;     squid-users mailing list
</I>&gt;<i> &gt;     <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> &gt;     &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>&gt;
</I>&gt;<i> &gt;     <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i> &gt;     &lt;<A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>&gt;
</I>&gt;<i> &gt;
</I>&gt;<i>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20220909/cb812047/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20220909/cb812047/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="025194.html">[squid-users] Scaling concurrent TCP sessions beyond ephemeral port range
</A></li>
	<LI>Next message (by thread): <A HREF="025204.html">[squid-users] Scaling concurrent TCP sessions beyond ephemeral port range
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25203">[ date ]</a>
              <a href="thread.html#25203">[ thread ]</a>
              <a href="subject.html#25203">[ subject ]</a>
              <a href="author.html#25203">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
