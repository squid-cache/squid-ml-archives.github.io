<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] [Troubleshoot] Squid 3.3 - Lots of 403 erros when reducing the workers number
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20%5BTroubleshoot%5D%20Squid%203.3%20-%20Lots%20of%20403%20erros%20when%0A%20reducing%20the%20workers%20number&In-Reply-To=%3C000c01d8c69a%24e896a680%24b9c3f380%24%40gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="025200.html">
   <LINK REL="Next"  HREF="025191.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] [Troubleshoot] Squid 3.3 - Lots of 403 erros when reducing the workers number</H1>
    <B>ngtech1ltd at gmail.com</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20%5BTroubleshoot%5D%20Squid%203.3%20-%20Lots%20of%20403%20erros%20when%0A%20reducing%20the%20workers%20number&In-Reply-To=%3C000c01d8c69a%24e896a680%24b9c3f380%24%40gmail.com%3E"
       TITLE="[squid-users] [Troubleshoot] Squid 3.3 - Lots of 403 erros when reducing the workers number">ngtech1ltd at gmail.com
       </A><BR>
    <I>Mon Sep 12 11:29:22 UTC 2022</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="025200.html">[squid-users] [Troubleshoot] Squid 3.3 - Lots of 403 erros when reducing the workers number
</A></li>
        <LI>Next message (by thread): <A HREF="025191.html">[squid-users] Scaling concurrent TCP sessions beyond ephemeral port range
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25207">[ date ]</a>
              <a href="thread.html#25207">[ thread ]</a>
              <a href="subject.html#25207">[ subject ]</a>
              <a href="author.html#25207">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>He Xavier,

I believe that there are couple logformat options that you should add to understand better this issue.
The first thing in this scenario is to have the squid.conf and access.log output.

If you have a load of about 100 rps you shouldn't be required to have more then 1-2 workers tops.
To know the actual load you can dump the cache manager details.
With the next script:
<A HREF="https://gist.github.com/elico/8790bdc835d8e9ecbc57e72fc31effc0">https://gist.github.com/elico/8790bdc835d8e9ecbc57e72fc31effc0</A>

it would be possible to probably dump all the relevant sections and much more.
Just be advised to review them and the squid.conf and the access.log before send a link to a compressed archive
on the public list.

If you prefer you can send the link to there in a private email so I can try to review them.
Depends on the proxy network access it would be pretty simple to understand where this 403 is coming from.
It's also possible that it's from the origin server and not from the proxy.

I assume this 403 is not based on the authentication level but it might be possible to use a special deny_info to
&quot;mark&quot; the culprit deny acl in your squid.conf.
Ie we can set a special response code in the ranges of 40x or 50x to make sure if it's from the proxy side.

If I remember you are using basic authentication so it's pretty simple to write a threaded helper that will 
be responsible on all requests but I still need to see the squid.conf and access.log

Eliezer

----
Eliezer Croitoru
NgTech, Tech Support
Mobile: +972-5-28704261
Email: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">ngtech1ltd at gmail.com</A>
Web: <A HREF="https://ngtech.co.il/">https://ngtech.co.il/</A>
My-Tube: <A HREF="https://tube.ngtech.co.il/">https://tube.ngtech.co.il/</A>

-----Original Message-----
From: squid-users &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>&gt; On Behalf Of Xavier Lecluse
Sent: Friday, 9 September 2022 11:21
To: Alex Rousskov &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt;
Cc: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
Subject: Re: [squid-users] [Troubleshoot] Squid 3.3 - Lots of 403 erros when reducing the workers number

Hello Alex,

Thanks for your answer.

&gt;&gt;<i> We are using two squid proxies (Squid 3.3)
</I>
&gt;<i>Squid v3 is not officially supported. My answers below may apply to 
</I>&gt;<i>Squid v3, but they are based on Squid v5+.
</I>

&gt;&gt;<i> In order to address some issues with Java clients, we tried to lower
</I>&gt;&gt;<i> the worker directive from 8 to 1, because of the relative low number
</I>&gt;&gt;<i> of simultaneous connections on our SSquid servers (about 100rq/s) 
</I>&gt;&gt;<i> After reducing the worker value to 1, and restarting the proxies, we
</I>&gt;&gt;<i> observed a great number of 403 errors, so we decided to rollback to 8
</I>&gt;&gt;<i> workers.
</I>
&gt;&gt;<i> - How the number of workers and these 403 errors can be correlated ?
</I>
&gt;<i>I do not know the exact correlation vector in your environment, but 
</I>&gt;<i>fewer workers means, among other things, smaller _aggregate_ 
</I>&gt;<i>authentication cache size and higher load on individual authentication 
</I>&gt;<i>helpers. To pinpoint the correlation, we would need to know _why_ Squid 
</I>&gt;<i>is generating 403 (Forbidden) errors.
</I>
Is there a specific way to find the reason ? Do I need to activate a certain logging level to see these traces ?
I will check in the actual logs and I'll come back if I don't find anything


&gt;&gt;<i> - Is there any &quot;recommandations&quot; about the number of workers to use,
</I>&gt;&gt;<i> for a given number of request/s ?
</I>
&gt;<i>Workers are primarily a performance optimization. For related tuning 
</I>&gt;<i>suggestions, please see 
</I>&gt;<i><A HREF="https://wiki.squid-cache.org/Features/SmpScale#How_to_configure_SMP_Squid_for_top_performance.3F">https://wiki.squid-cache.org/Features/SmpScale#How_to_configure_SMP_Squid_for_top_performance.3F</A>
</I>
Yes, I saw and read this thread on the Wiki.
We were already using some of these recommandations.
I think we are quite far from a &quot;top performance&quot; but we didn't observed any performance issue when we used 8 workers.
I understand that an individual worker should be able to handle our actual load, but we have to find what is provoking the 403 errors first.

&gt;&gt;<i> The inital problem is from some java clients, which are using two TCP
</I>&gt;&gt;<i> sessions, one for the authentication, and another one for the HTTP(s)
</I>&gt;&gt;<i> requests. The fact is that the &quot;second&quot; session is not always opened
</I>&gt;&gt;<i> on the same worker, so ot considers that the authentication step has
</I>&gt;&gt;<i> not already been done.
</I>
&gt;&gt;<i> Is there a way to address this issue ?
</I>
&gt;<i>If (a request on) the second connection has enough information to link 
</I>&gt;<i>it to the first/authenticated request/connection, then it may be 
</I>&gt;<i>possible to configure Squid and write authentication helpers in such a 
</I>&gt;<i>way that the &quot;other&quot; worker knows that the client of the second 
</I>&gt;<i>connection has already authenticated. The details would depend on the 
</I>&gt;<i>authentication scheme and that &quot;linking&quot; mechanism.
</I>
Do you have any example of an authentication helper I can start with ? or an example on how to &quot;link&quot; events between workers ?
I was thinking that workers were quite &quot;individuals&quot; and did not exchange anything (or verry little) with each other.
Any start point would be welcome.

Regards,
Xavier

&gt;<i>HTH,
</I>
&gt;<i>Alex.
</I>



----- Mail original -----
De: &quot;Alex Rousskov&quot; &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt;
&#192;: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
Envoy&#233;: Jeudi 8 Septembre 2022 17:19:19
Objet: Re: [squid-users] [Troubleshoot] Squid 3.3 - Lots of 403 erros when reducing the workers number

On 9/8/22 10:15, Xavier Lecluse wrote:

&gt;<i> We are using two squid proxies (Squid 3.3)
</I>
Squid v3 is not officially supported. My answers below may apply to 
Squid v3, but they are based on Squid v5+.


&gt;<i> In order to address some issues with Java clients, we tried to lower
</I>&gt;<i> the worker directive from 8 to 1, because of the relative low number
</I>&gt;<i> of simultaneous connections on our SSquid servers (about 100rq/s) 
</I>&gt;<i> After reducing the worker value to 1, and restarting the proxies, we
</I>&gt;<i> observed a great number of 403 errors, so we decided to rollback to 8
</I>&gt;<i> workers.
</I>
&gt;<i> - How the number of workers and these 403 errors can be correlated ?
</I>
I do not know the exact correlation vector in your environment, but 
fewer workers means, among other things, smaller _aggregate_ 
authentication cache size and higher load on individual authentication 
helpers. To pinpoint the correlation, we would need to know _why_ Squid 
is generating 403 (Forbidden) errors.


&gt;<i> - Is there any &quot;recommandations&quot; about the number of workers to use,
</I>&gt;<i> for a given number of request/s ?
</I>
Workers are primarily a performance optimization. For related tuning 
suggestions, please see 
<A HREF="https://wiki.squid-cache.org/Features/SmpScale#How_to_configure_SMP_Squid_for_top_performance.3F">https://wiki.squid-cache.org/Features/SmpScale#How_to_configure_SMP_Squid_for_top_performance.3F</A>


&gt;<i> The inital problem is from some java clients, which are using two TCP
</I>&gt;<i> sessions, one for the authentication, and another one for the HTTP(s)
</I>&gt;<i> requests. The fact is that the &quot;second&quot; session is not always opened
</I>&gt;<i> on the same worker, so ot considers that the authentication step has
</I>&gt;<i> not already been done.
</I>
&gt;<i> Is there a way to address this issue ?
</I>
If (a request on) the second connection has enough information to link 
it to the first/authenticated request/connection, then it may be 
possible to configure Squid and write authentication helpers in such a 
way that the &quot;other&quot; worker knows that the client of the second 
connection has already authenticated. The details would depend on the 
authentication scheme and that &quot;linking&quot; mechanism.


HTH,

Alex.

_______________________________________________
squid-users mailing list
<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
<A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
_______________________________________________
squid-users mailing list
<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
<A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="025200.html">[squid-users] [Troubleshoot] Squid 3.3 - Lots of 403 erros when reducing the workers number
</A></li>
	<LI>Next message (by thread): <A HREF="025191.html">[squid-users] Scaling concurrent TCP sessions beyond ephemeral port range
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25207">[ date ]</a>
              <a href="thread.html#25207">[ thread ]</a>
              <a href="subject.html#25207">[ subject ]</a>
              <a href="author.html#25207">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
