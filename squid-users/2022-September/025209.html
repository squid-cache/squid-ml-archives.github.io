<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] [EXTERNAL] Re: Exchange server authentication via squid reverse proxy not working after upgrade from squid 4.15 to 5.6
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20%5BEXTERNAL%5D%20Re%3A%20Exchange%20server%20authentication%20via%0A%20squid%20reverse%20proxy%20not%20working%20after%20upgrade%20from%20squid%204.15%20to%205.6&In-Reply-To=%3CDM6PR10MB3740208B6C31955ACA904C53B3449%40DM6PR10MB3740.namprd10.prod.outlook.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="025195.html">
   <LINK REL="Next"  HREF="025187.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] [EXTERNAL] Re: Exchange server authentication via squid reverse proxy not working after upgrade from squid 4.15 to 5.6</H1>
    <B>Hannes Fasching</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20%5BEXTERNAL%5D%20Re%3A%20Exchange%20server%20authentication%20via%0A%20squid%20reverse%20proxy%20not%20working%20after%20upgrade%20from%20squid%204.15%20to%205.6&In-Reply-To=%3CDM6PR10MB3740208B6C31955ACA904C53B3449%40DM6PR10MB3740.namprd10.prod.outlook.com%3E"
       TITLE="[squid-users] [EXTERNAL] Re: Exchange server authentication via squid reverse proxy not working after upgrade from squid 4.15 to 5.6">hfasching at barracuda.com
       </A><BR>
    <I>Mon Sep 12 13:06:04 UTC 2022</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="025195.html">[squid-users] Exchange server authentication via squid reverse proxy not working after upgrade from squid 4.15 to 5.6
</A></li>
        <LI>Next message (by thread): <A HREF="025187.html">[squid-users] [Troubleshoot] Squid 3.3 - Lots of 403 erros when reducing the workers number
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25209">[ date ]</a>
              <a href="thread.html#25209">[ thread ]</a>
              <a href="subject.html#25209">[ subject ]</a>
              <a href="author.html#25209">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Amos,
thanks for your answer. It's a new point to look at and brings me one step further.

Kind regards,
Hannes





Von: squid-users &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>&gt; im Auftrag von Amos Jeffries &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt;
Gesendet: Freitag, 9. September 2022 06:45
An: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A> &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>&gt;
Betreff: [EXTERNAL] Re: [squid-users] Exchange server authentication via squid reverse proxy not working after upgrade from squid 4.15 to 5.6

On 8/09/22 19:40, Hannes Fasching wrote:
&gt;<i> Hello,
</I>&gt;<i> A customer have an issue that after upgrading from squid 4.15 to actual 5.6 with reverse proxy mode for an exchange server.
</I>&gt;<i> The authentication is not working anymore when the integrated Windows authentication is enabled (needed for SSO). When disabled, the authentication via squid is then working.
</I>

The squid.conf you link to below does not perform any authentication.
Squid is configured just to relay any auth headers as-is to the Exchange
server / peer.

To clarify some details here:

* &quot;SSO&quot; means simply that all services on a network are supposed to
accept the same credentials.
  - Microsoft making a big noise about this terminology is purely
marketing hype. SSO can be performed with any auth scheme and any
credentials - it is entirely a matter of what the service doing the
authentication accepts as valid credentials. So this can be ignored for
troubleshooting purposes.


* &quot;integrated Windows authentication&quot; means simply that the Browser is
supposed to have access to the users Windows account to send their
machine login credentials when auth is needed.
  - So the thing to be looking at is whether the Browser (or other
client software) is able to access and send the user login when
authenticating.
  - If it is sending some other credentials that is a problem. Look at
where they are coming from and why.


* authentication _scheme_ is simply a way to deliver the credentials
from some client to some server.
  - these are dictated by the server doing the authentication. As long
as the client software is using a scheme the service indicated as
available things should work correctly.
  - this is where Squid comes in.
   ** If Squid is participating in the authentication the scheme is
limited to one where three agents can share it (eg Basic).
   ** If Squid is blindly relaying then only the client and server need
to agree on the scheme. But Squid needs to avoid breaking the scheme
requirements (eg NTLM/Negotiate restrict TCP connection multiplexing,
Digest restricts server load balancing).


&gt;<i> The difference is that Windows with integrated authentication is trying several authentication schemes otherwise only Basic authentication is used.
</I>&gt;<i> Please follow the link to see the squid.conf and the cache log file starting with the attempt when it fails and afterwards, with the time stamp 19:15, the attempt when it is working.
</I>&gt;<i>
</I>&gt;<i> <A HREF="https://barracudacorp-my.sharepoint.com/:u:/g/personal/hfasching_barracuda_com/EZBjHnJqCaFLlArPb8a_-FwB-7FIzvK0e21ow1Qec-MVhw?e=5149sA">https://barracudacorp-my.sharepoint.com/:u:/g/personal/hfasching_barracuda_com/EZBjHnJqCaFLlArPb8a_-FwB-7FIzvK0e21ow1Qec-MVhw?e=5149sA</A> (squid.conf)
</I>&gt;<i> <A HREF="https://barracudacorp-my.sharepoint.com/:u:/g/personal/hfasching_barracuda_com/EcPpd3DeeoFLs4_9Dn6JWAYBbHrwenOEJ3SZ0IW8_ED1-A?e=Ff9BZc">https://barracudacorp-my.sharepoint.com/:u:/g/personal/hfasching_barracuda_com/EcPpd3DeeoFLs4_9Dn6JWAYBbHrwenOEJ3SZ0IW8_ED1-A?e=Ff9BZc</A> (squid_cache.log)
</I>&gt;<i>
</I>&gt;<i> It would be great if you could help me finding out what is wrong with Windows integrated authentication as our customer needs the SSO feature.
</I>

What I would be looking at here is the HTTP(S) message flows and headers
to see what type of credentials the user/client is trying to send
through Squid to Exchange. What auth scheme they are being sent with.
And what TCP connections (&quot;FD&quot;) they are being sent on when leaving Squid.


What I see in the log you posted is two client connections doing the
following:

Client connection #1:
  * sends POST with Basic auth
  * server accepts
  * sends OPTIONS with Basic auth
  * server accepts

That looks good. Check that the credentials sent were the users Windows
login and were sent automatically. If so then &quot;SSO&quot; is working.


Client connection #2:
  * sends POST with Bearer auth
  * server rejects (401)
  * sends POST with no credentials
  * server rejects (401)
  * sends POST with no credentials
  * server rejects (401)

   - I think this client software is broken. It should absolutely *not*
be sending any requests without authentication after having received
that first 401 status. It should be trying alternative schemes, or
alternative credentials with each scheme, or going away.


Client connection #2 (after a short delay):

  * sends POST with Negotiate/NTLMv2 client capabilities token
  * server responds per NTLMv2 (401 status)
    - I assume it also produces the nonce token though I don't see the
header logged
  * sends POST with Negotiate/NTLMv2 proof of identity token
  * server rejects (401)

That looks like Squid is correctly relaying the NTLMv2 handshake
messages. But the Exchange server does not like the login for some reason.
  I would at this point be checking whether the credentials used here
were actually the users Windows login, and whether Exchange server is
validating properly.
  I am not familiar with Exchange but this may be something to do with
NTLMv2 credentials using Negotiate scheme instead of NTLM scheme.
Negotiate scheme typically means Kerberos handshake expected since NTLM
was formally deprecated by Microsoft in April 2006.


HTH
Amos
_______________________________________________
squid-users mailing list
<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
<A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>

Get the 13 Email Threat Types eBook

<A HREF="https://www.barracuda.com/">https://www.barracuda.com/</A>

This e-mail and any attachments to it contain confidential and proprietary material of Barracuda, its affiliates or agents, and is solely for the use of the intended recipient. Any review, use, disclosure, distribution or copying of this transmittal is prohibited except by or on behalf of the intended recipient. If you have received this transmittal in error, please notify the sender and destroy this e-mail and any attachments and all copies, whether electronic or printed.

________________________________

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="025195.html">[squid-users] Exchange server authentication via squid reverse proxy not working after upgrade from squid 4.15 to 5.6
</A></li>
	<LI>Next message (by thread): <A HREF="025187.html">[squid-users] [Troubleshoot] Squid 3.3 - Lots of 403 erros when reducing the workers number
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25209">[ date ]</a>
              <a href="thread.html#25209">[ thread ]</a>
              <a href="subject.html#25209">[ subject ]</a>
              <a href="author.html#25209">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
