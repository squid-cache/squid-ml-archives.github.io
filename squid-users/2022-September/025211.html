<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Do squid logs performence affect general request performece?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Do%20squid%20logs%20performence%20affect%20general%20request%0A%20performece%3F&In-Reply-To=%3Cb7f407f8-5902-75f5-532c-8afa5401e7be%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="025210.html">
   <LINK REL="Next"  HREF="025231.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Do squid logs performence affect general request performece?</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Do%20squid%20logs%20performence%20affect%20general%20request%0A%20performece%3F&In-Reply-To=%3Cb7f407f8-5902-75f5-532c-8afa5401e7be%40measurement-factory.com%3E"
       TITLE="[squid-users] Do squid logs performence affect general request performece?">rousskov at measurement-factory.com
       </A><BR>
    <I>Tue Sep 13 03:30:39 UTC 2022</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="025210.html">[squid-users] Do squid logs performence affect general request performece?
</A></li>
        <LI>Next message (by thread): <A HREF="025231.html">[squid-users] Do squid logs performence affect general request performece?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25211">[ date ]</a>
              <a href="thread.html#25211">[ thread ]</a>
              <a href="subject.html#25211">[ subject ]</a>
              <a href="author.html#25211">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 9/12/22 18:20, roee klinger wrote:

&gt;<i> Thank you for your advice, as suggested I tested a both TCP and UDP, and 
</I>&gt;<i> found TCP to be so slow
</I>&gt;<i> that is it practically unusable, UDP however works fine, but has the 
</I>&gt;<i> normal disadvantages of UDP.
</I>
Glad that test yielded useful results in your environment!


&gt;<i> It seems that TCP sends each message by itself, and UDP sends them in 
</I>&gt;<i> bulk (10-20 at a time),
</I>&gt;<i> which seems to be a big part of the performance difference, in fact TCP 
</I>&gt;<i> is so slow that it causes Squid to crash after a while.
</I>&gt;<i> 
</I>&gt;<i> After carefully reading the logs, I tried to get TCP to send in bulk as 
</I>&gt;<i> well by configuring:
</I>&gt;<i> 
</I>&gt;<i>     logformat logstash %ts.%03tu %6tr %&gt;a %&lt;la %&gt;lp %Ss/%03&gt;Hs %&lt;st %rm
</I>&gt;<i>     %ru %[un %Sh/%&lt;a %mt %{Client-Tags}&gt;h
</I>&gt;<i>     access_log <A HREF="tcp://127.0.0.1:5400">tcp://127.0.0.1:5400</A> logformat=logstash buffer-size=64KB
</I>&gt;<i>     buffered_logs on
</I>&gt;<i> 
</I>&gt;<i> But it seems to still be sending the logs line by line, am I missing 
</I>&gt;<i> something?
</I>

I have not tested this, but if my interpretation of the underlying code 
is correct, then the TCP logging module code does not flush the buffer 
when it accumulates (close to) buffer-size bytes. Instead, the module 
starts writing its buffer after accumulating more than 16KB (2*MAX_URL). 
How long are your typical access.log records?

Each write(2) call of a buffering TCP logging module during normal Squid 
operation should be 16KB, regardless of the buffer-size setting.

FWIW, the official access_log buffer-size documentation hints at 
module-specific flushing algorithms. I cannot describe the exact 
algorithm used by the TCP logging module in a few words, but it is not 
as simple as &quot;accumulate buffer-size bytes and then write the 
accumulated bytes&quot;.


HTH,

Alex.


&gt;<i> On 9 Sep 2022, 19:57 +0300, Alex Rousskov wrote:
</I>&gt;&gt;<i> On 9/9/22 08:49, roee klinger wrote:
</I>&gt;&gt;&gt;<i> Hello,
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> I have just recently started exploring ingesting logs from Squid via
</I>&gt;&gt;&gt;<i> Logstash (TCP log ingestion)
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> I now have to make the decision of how to deploy Logstash, it seems to
</I>&gt;&gt;&gt;<i> me that I have two options:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> 1. Deploy a Logstash instance for every region where I have a Squid
</I>&gt;&gt;&gt;<i> instance running, resulting in the lowest latency possible between
</I>&gt;&gt;&gt;<i> Squid and Logstash.
</I>&gt;&gt;&gt;<i> 2. Deploy a central Logstash instance for all Squid instance worldwide,
</I>&gt;&gt;&gt;<i> which is the cheapest and easiest option, but will have high latency
</I>&gt;&gt;&gt;<i> for some of the Squid instance which are located far away
</I>&gt;&gt;&gt;<i> geographically from the Logstash instance.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> I already know that if the log server crashes in Squid, then Squid will
</I>&gt;&gt;&gt;<i> crash with a fatal error,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> FYI: Logging error handling is configurable via &quot;access_log on-error&quot;.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> so Squid takes logging very seriously, so my
</I>&gt;&gt;&gt;<i> question is: does TCP logging performance in Squid effect the total
</I>&gt;&gt;&gt;<i> request performance, or are they independent from each other?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> TCP logger uses asynchronous non-blocking I/O. Individual HTTP
</I>&gt;&gt;<i> transactions do not wait for individual log records to be sent. Needless
</I>&gt;&gt;<i> to say, logging does consume resources and, hence, may affect overall
</I>&gt;&gt;<i> HTTP transaction performance. And if the log record recipient is too
</I>&gt;&gt;<i> slow, then Squid will die and/or log records will be dropped.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> What would be you recommendations, if request performance is crucial
</I>&gt;&gt;&gt;<i> (and log performance is not)?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I would not be surprised if you would not be able to measure meaningful
</I>&gt;&gt;<i> performance difference among these modules. From general performance
</I>&gt;&gt;<i> point of view, and module-specific bugs and limitations notwithstanding,
</I>&gt;&gt;<i> I would expect &quot;daemon&quot; and &quot;udp&quot; modules to have smaller performance
</I>&gt;&gt;<i> overhead/cost for Squid workers than the &quot;tcp&quot; module because I expect
</I>&gt;&gt;<i> that TCP has to &quot;do more&quot; than stdout I/O and UDP. However, I would not
</I>&gt;&gt;<i> base this decision on such high-level speculations and test various
</I>&gt;&gt;<i> options instead.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> HTH,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Alex.
</I>&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;<i> squid-users mailing list
</I>&gt;&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="025210.html">[squid-users] Do squid logs performence affect general request performece?
</A></li>
	<LI>Next message (by thread): <A HREF="025231.html">[squid-users] Do squid logs performence affect general request performece?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25211">[ date ]</a>
              <a href="thread.html#25211">[ thread ]</a>
              <a href="subject.html#25211">[ subject ]</a>
              <a href="author.html#25211">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
