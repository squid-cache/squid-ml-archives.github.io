<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Howto make Squid config dependent on hostname?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Howto%20make%20Squid%20config%20dependent%20on%20hostname%3F&In-Reply-To=%3C7eac75df-a0e6-3195-850f-715da132f3fb%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="025213.html">
   <LINK REL="Next"  HREF="025223.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Howto make Squid config dependent on hostname?</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Howto%20make%20Squid%20config%20dependent%20on%20hostname%3F&In-Reply-To=%3C7eac75df-a0e6-3195-850f-715da132f3fb%40measurement-factory.com%3E"
       TITLE="[squid-users] Howto make Squid config dependent on hostname?">rousskov at measurement-factory.com
       </A><BR>
    <I>Thu Sep 15 18:06:37 UTC 2022</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="025213.html">[squid-users] Howto make Squid config dependent on hostname?
</A></li>
        <LI>Next message (by thread): <A HREF="025223.html">[squid-users] Howto make Squid config dependent on hostname?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25214">[ date ]</a>
              <a href="thread.html#25214">[ thread ]</a>
              <a href="subject.html#25214">[ subject ]</a>
              <a href="author.html#25214">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 9/15/22 10:29, Hildegard Meier wrote:

&gt;<i> we have two Squid servers (Linux hosts) and each shall have the very same config file /etc/squid/squid.conf
</I>&gt;<i> which is versioned and deployed from a central deployment server.
</I>&gt;<i> So each host shall have deployed the same files.
</I>&gt;<i> 
</I>&gt;<i> Each of the two shall have the other configured as sibling cache peer.
</I>&gt;<i> 
</I>&gt;<i> So node1 shall have
</I>&gt;<i> cache_peer node2.examlpe.com sibling 3128 3130
</I>&gt;<i> 
</I>&gt;<i> and node2 shalle have
</I>&gt;<i> cache_peer node1.examlpe.com sibling 3128 3130
</I>&gt;<i> 
</I>&gt;<i> I guess it is not so nice to have both configured with both lines together, no?
</I>&gt;<i> 
</I>&gt;<i> cache_peer node1.examlpe.com sibling 3128 3130
</I>&gt;<i> cache_peer node2.examlpe.com sibling 3128 3130
</I>
 &gt; I find that ugly.

I agree.

Squid does not support being its own peer (yet?): Upon startup, Squid 
validates connectivity to peers. If that validation happens before Squid 
starts listening for requests, the validation will (silently) fail. 
There are several race conditions here, but that failure is likely in a 
self-peering case.

In your particular use case, such self-peering also does not reflect 
reality. You do not want to lie to Squid about it being its own peer 
because Squid will try to use both configured peers, creating problems 
that you do not want to solve. It also duplicates peer configurations.


&gt;<i> Does squif offer a hostname conditional if clause ?
</I>
Not yet. Squid currently only supports three kinds of conditions: true, 
false, and integer equality comparison (as documented).

The only build-in macro that always yields an integer is the 
${process_number} macro.

Depending on your setup, you may also be able to use the ${service_name} 
macro if your service name is an integer, but that is kind of hacky, and 
I have not tested it.

For now, your best option is probably to post-process the versioned 
configuration to substitute your own custom macro(s). For example, your 
Squid startup (or deployment) stript can substitute a 
${mynamespace:PeerName} macro in squid.conf.template with either true or 
false, depending on the node, producing squid.conf that Squid can use:

cache_peer ${mynamespace:PeerName} sibling 3128 3130


If you need to hard-code peer names or substantially different 
configurations for individual cache peers, then you can do something 
like this in the template configuration file:

if ${mynamespace:AtNode1()}
     cache_peer node2.example.com sibling 3128 3130
endif

if ${mynamespace:AtNode2()}
     cache_peer node1.example.com sibling 3128 3130
endif


FWIW, quality PRs introducing the following related features should be 
welcomed IMO:

* a macro function evaluating a named environment variable
* a macro function evaluating a given shell command
* string comparison in squid.conf conditionals


HTH,

Alex.


&gt;<i> I think about something like this:
</I>&gt;<i> 
</I>&gt;<i> if $MY_HOSTNAME == 'node1' then
</I>&gt;<i>      cache_peer node2.examlpe.com sibling 3128 3130
</I>&gt;<i> fi
</I>&gt;<i> 
</I>&gt;<i> if $MY_HOSTNAME == 'node2' then
</I>&gt;<i>      cache_peer node1.examlpe.com sibling 3128 3130
</I>&gt;<i> fi
</I>
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="025213.html">[squid-users] Howto make Squid config dependent on hostname?
</A></li>
	<LI>Next message (by thread): <A HREF="025223.html">[squid-users] Howto make Squid config dependent on hostname?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25214">[ date ]</a>
              <a href="thread.html#25214">[ thread ]</a>
              <a href="subject.html#25214">[ subject ]</a>
              <a href="author.html#25214">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
