<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] squid-users Digest, Vol 97, Issue 20
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid-users%20Digest%2C%20Vol%2097%2C%20Issue%2020&In-Reply-To=%3C7c4a2e62-9b38-5c42-5ecd-dcc0a576adca%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="025208.html">
   <LINK REL="Next"  HREF="025212.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] squid-users Digest, Vol 97, Issue 20</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid-users%20Digest%2C%20Vol%2097%2C%20Issue%2020&In-Reply-To=%3C7c4a2e62-9b38-5c42-5ecd-dcc0a576adca%40treenet.co.nz%3E"
       TITLE="[squid-users] squid-users Digest, Vol 97, Issue 20">squid3 at treenet.co.nz
       </A><BR>
    <I>Fri Sep 16 09:28:54 UTC 2022</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="025208.html">[squid-users] squid-users Digest, Vol 97, Issue 20
</A></li>
        <LI>Next message (by thread): <A HREF="025212.html">[squid-users] Is there a way to ignore incoming If-Modified-Since request?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25221">[ date ]</a>
              <a href="thread.html#25221">[ thread ]</a>
              <a href="subject.html#25221">[ subject ]</a>
              <a href="author.html#25221">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 13/09/22 00:39, Adiseshu Channasamudhram wrote:
&gt;<i> Hello Amos
</I>&gt;<i> 
</I>&gt;<i> Thank you for looking in to this. Below is the configuration ...
</I>&gt;<i> 
</I>

FYI, below is advice for Squid-4+, if you have an older version then 
please upgrade ASAP. Current stable Squid is v5.7.


&gt;<i> 
</I>&gt;<i> ###########################
</I>&gt;<i> logformat squid %tl %6tr %&gt;a %&lt;a %dt %&lt;rd %Ss/%&gt;Hs %&lt;st %rm %ru %un 
</I>&gt;<i> %Sh/%&lt;A %mt %&lt;tt %&lt;pt %{Nuance-Session-ID}&gt;h
</I>&gt;<i> 
</I>
&quot;squid&quot; is the registered name for Squid native log format. Some Squid 
versions will silently use the built-in format instead of yours. Recent 
versions will complain about this.

Please use a custom name for custom formats:

   logformat nuance ...


&gt;<i> cache_access_log /var/log/squid/access.log &#160;squid
</I>
This directive is called &quot;access_log&quot;. Remove the &quot;cache_&quot; part.

   access_Log daemon:/var/log/squid/access.log logformat=nuance


&gt;<i> pid_filename /var/run/squid.pid
</I>&gt;<i> 
</I>
This should not need configuring in any modern Squid.


&gt;<i> visible_hostname nuance-ak-client-test2
</I>&gt;<i> 
</I>
The above should be a FQDN resolvable in DNS. It will be used in URLs 
presented to clients in error pages etc.


&gt;<i> acl Safe_ports port 80
</I>&gt;<i> acl Safe_ports port 443
</I>&gt;<i> acl SSL_ports port 443
</I>&gt;<i> acl SSL method CONNECT
</I>&gt;<i> acl CONNECT method CONNECT
</I>&gt;<i> 
</I>&gt;<i> cache deny all
</I>
To fully disable caching you should also add:
   cache_mem 0 KB


&gt;<i> dns_v4_first on
</I>
&gt;<i> http_port 443 tcpkeepalive=60,30,3 ssl-bump 
</I>
This may be your problem.

  - Port 443 is for encrypted TLS traffic.
  - &quot;http_port&quot; requires plain-text HTTP traffic. Encrypted TLS arriving 
here directly will guaranteed result in your log &quot;error:invalid-request&quot; 
entries.

A working configuration for port 443 would be:

   https_port 443 \
     tls-cert=/etc/squid/squidCA.pem \
     cipher=HIGH:MEDIUM:!LOW:!RC4:!SEED:!IDEA:!3DES:!MD5:!EXP:!PSK:!DSS \
     options=NO_TLSv1,NO_SSLv3,NO_SSLv2,SINGLE_DH_USE,SINGLE_ECDH_USE \
     tls-dh=prime256v1:/etc/squid/bump_dhparam.pem \
     tcpkeepalive=60,30,3


FYI, NO_SSLv2 is no longer supported with latest Squid. All SSLv2 
related features are fully prohibited by default. Including these 
disable options.


&gt;<i> # Below, a.b.c.d is the backend IP
</I>&gt;<i> cache_peer a.b.c.d parent 443 0 no-query proxy-only no-digest 
</I>&gt;<i> originserver ssl sslcert=/etc/certs/abc.crt sslkey=/etc/certs/key.pem 
</I>&gt;<i> sslcapath=/etc/certs/ sslflags=DONT_VERIFY_PEER name=dev
</I>

FYI: DONT_VERIFY_PEER disables the 2-way security on these backend 
connections.

Please *actually* setup 2-way TLS validation. Like so:

  * Check that /etc/certs/abc.crt contains the *Client Certificate* 
Squid is supposed to send in 2-way TLS to this backend.

  * Check that /etc/certs/key.pem is the private key matching the 
content of /etc/certs/abc.crt.

  * Add the sslcafile= option with the specific PEM file containing the 
root CA which signed the Server Certificate of a.b.c.d.

  * Remove both sslcapath= and sslflags=DONT_VERIFY_PEER


FWIW, you could merge /etc/certs/abc.crt and /etc/certs/key.pem into one 
PEM file and load it with &quot;sslcert=/etc/certs/squid.pem&quot;. In modern 
Squid that file can also contain any necessary chained CA intermediary 
certificates.


&gt;<i> acl dev myport 443
</I>&gt;<i> acl dev myport 80
</I>&gt;<i> acl dev myport 3129
</I>&gt;<i> 
</I>
Use &quot;myportname&quot; ACL type instead.

   acl dev myportname 443 80 3129


FWIW, you have not shown any port 80 or 3129 settings. Without 
http(s)_port lines using those as names the values are pointless in this 
ACL.


&gt;<i> http_access allow all
</I>&gt;<i> 
</I>
Your network description specified there is a &quot;frontend&quot; receiving 
traffic before relaying it to Squid. You should configure these 
http_access to deny traffic arriving without going through those 
frontend(s). The default squid.conf defines an ACL called &quot;localnet&quot; for 
things like this.


&gt;<i> cache_peer_access dev allow dev
</I>&gt;<i> #cache_peer_access dev deny all
</I>
There are no rules specifying what to do with traffic that does not go 
through the peer. That means Squid will currently try to go directly to 
the Internet for all that.

Your network topology description specified that there was a backend 
receiving all traffic. To enforce that you need the following rule:

   never_direct allow all


&gt;<i> #URL_REWRITE_PROGRAM /etc/squid/rewrite-http.pl
</I>&gt;<i> sslcrtd_program /usr/lib64/squid/ssl_crtd -s /var/lib/squid/ssl_db -M 4MB
</I>&gt;<i> sslcrtd_children 5
</I>&gt;<i> ssl_bump server-first all
</I>
With the port 443 configuration fixed your Squid is no longer performing 
SSL-Bump. You can remove all these above settings.


&gt;<i> sslproxy_cert_error allow all
</I>&gt;<i> sslproxy_flags DONT_VERIFY_PEER
</I>
These settings should never be configured like this. All it does is hide 
log entries informing you about security issues. The issues themselves 
still occur.

You should remove them and resolve any issues that are then visible.
FWIW, once never_direct is used and the cache_peer is fixed these should 
not be necessary configuring at all.


HTH
Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="025208.html">[squid-users] squid-users Digest, Vol 97, Issue 20
</A></li>
	<LI>Next message (by thread): <A HREF="025212.html">[squid-users] Is there a way to ignore incoming If-Modified-Since request?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25221">[ date ]</a>
              <a href="thread.html#25221">[ thread ]</a>
              <a href="subject.html#25221">[ subject ]</a>
              <a href="author.html#25221">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
