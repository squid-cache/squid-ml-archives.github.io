<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Howto make Squid config dependent on hostname?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Howto%20make%20Squid%20config%20dependent%20on%20hostname%3F&In-Reply-To=%3Ctrinity-9a073eae-d1de-47e0-8d9a-1af4ec01f3b3-1663338160778%403c-app-gmx-bs10%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="025224.html">
   <LINK REL="Next"  HREF="025227.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Howto make Squid config dependent on hostname?</H1>
    <B>Hildegard Meier</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Howto%20make%20Squid%20config%20dependent%20on%20hostname%3F&In-Reply-To=%3Ctrinity-9a073eae-d1de-47e0-8d9a-1af4ec01f3b3-1663338160778%403c-app-gmx-bs10%3E"
       TITLE="[squid-users] Howto make Squid config dependent on hostname?">daku8938 at gmx.de
       </A><BR>
    <I>Fri Sep 16 14:22:40 UTC 2022</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="025224.html">[squid-users] Howto make Squid config dependent on hostname?
</A></li>
        <LI>Next message (by thread): <A HREF="025227.html">[squid-users] Howto make Squid config dependent on hostname?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25226">[ date ]</a>
              <a href="thread.html#25226">[ thread ]</a>
              <a href="subject.html#25226">[ subject ]</a>
              <a href="author.html#25226">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I found about

man squid

-f file     Use the given config-file instead of /etc/squid/squid.conf .  If the file name starts with a !  or | then it is assumed  to  be
                   an  external  command  or  command  line.   Can for example be used to pre-process the configuration before it is being read by
                   Squid.  To facilitate this Squid also understands the common #line notion to indicate the real source file.

While I dnot know what &quot;common #line notion&quot; should be (searching on internet matches only the squid man page),

I found the following solution for Ubuntu 18.04 server (Squid 3.5.27):

Create a script
--------------------
/usr/local/script/squid/pre_process_squid_config_file.sh

#!/bin/bash

readonly SQUID_CONFIG_TEMPLATE_FILE='/etc/squid/squid.conf.TEMPLATE'

case &quot;${HOSTNAME}&quot; in
    'node1')  readonly HOSTNAME_PEER='node2' ;;
    'node2')  readonly HOSTNAME_PEER='node1' ;;
    *)
        echo &quot;invalid hostname in script ${0}. Exit&quot;
        exit 1
        ;;
esac

sed \
-e &quot;s@{HOSTNAME}@${HOSTNAME}@g&quot; \
-e &quot;s@{HOSTNAME_PEER}@${HOSTNAME_PEER}@g&quot; \
&quot;${SQUID_CONFIG_TEMPLATE_FILE}&quot;
--------------------

Create file /etc/default/squid with content
CONFIG='|/usr/local/script/squid/pre_process_squid_config_file.sh'
SQUID_ARGS=&quot;-YC -f $CONFIG&quot;

Now you can use the Macros {HOSTNAME} (which will give the actual hosts name) and {HOSTNAME_PEER} (name of the other host)

I have only one problem with it, is that a bug?

/usr/sbin/squid -k parse -f '|/usr/local/script/squid/pre_process_squid_config_file.sh'

works, but

/usr/sbin/squid -k reconfigure -f '|/usr/local/script/squid/pre_process_squid_config_file.sh'

gives the following line in /var/log/squid/cache.log

2022/09/16 16:20:55 kid1| storeDirWriteCleanLogs: Starting...
2022/09/16 16:20:55 kid1|   Finished.  Wrote 0 entries.
2022/09/16 16:20:55 kid1|   Took 0.00 seconds (  0.00 entries/sec).
FATAL: parseConfigFile: '|/usr/local/script/squid/pre_process_squid_config_file.sh' failed with exit code -1

Squid Cache (Version 3.5.27): Terminated abnormally.
CPU Usage: 1.267 seconds = 0.760 user + 0.507 sys
Maximum Resident Size: 107296 KB
Page faults with physical i/o: 7
2022/09/16 16:20:58 kid1| Current Directory is /


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="025224.html">[squid-users] Howto make Squid config dependent on hostname?
</A></li>
	<LI>Next message (by thread): <A HREF="025227.html">[squid-users] Howto make Squid config dependent on hostname?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25226">[ date ]</a>
              <a href="thread.html#25226">[ thread ]</a>
              <a href="subject.html#25226">[ subject ]</a>
              <a href="author.html#25226">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
