<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Howto make Squid config dependent on hostname?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Howto%20make%20Squid%20config%20dependent%20on%20hostname%3F&In-Reply-To=%3C4162e00d-90a4-bd94-c2eb-6fe4bf78d01b%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="025226.html">
   <LINK REL="Next"  HREF="025228.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Howto make Squid config dependent on hostname?</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Howto%20make%20Squid%20config%20dependent%20on%20hostname%3F&In-Reply-To=%3C4162e00d-90a4-bd94-c2eb-6fe4bf78d01b%40measurement-factory.com%3E"
       TITLE="[squid-users] Howto make Squid config dependent on hostname?">rousskov at measurement-factory.com
       </A><BR>
    <I>Fri Sep 16 18:03:19 UTC 2022</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="025226.html">[squid-users] Howto make Squid config dependent on hostname?
</A></li>
        <LI>Next message (by thread): <A HREF="025228.html">[squid-users] Howto make Squid config dependent on hostname?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25227">[ date ]</a>
              <a href="thread.html#25227">[ thread ]</a>
              <a href="subject.html#25227">[ subject ]</a>
              <a href="author.html#25227">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 9/16/22 10:22, Hildegard Meier wrote:

&gt;<i> I dnot know what &quot;common #line notion&quot; should be (searching on internet matches only the squid man page)
</I>
It is a poorly worded reference to &quot;#line&quot; directives used by some 
programming languages for documenting the original location of lines in 
preprocessed files. Here are the corresponding C++ preprocessor docs, 
for example: <A HREF="https://en.cppreference.com/w/cpp/preprocessor/line">https://en.cppreference.com/w/cpp/preprocessor/line</A>

Your template preprocessing script may (but does not have to) insert 
#line directives so that Squid can attribute configuration lines to the 
original configuration template rather than its processed result.


&gt;<i> /usr/sbin/squid -k parse -f '|/usr/local/script/squid/pre_process_squid_config_file.sh'
</I>&gt;<i> 
</I>&gt;<i> works, but
</I>&gt;<i> 
</I>&gt;<i> /usr/sbin/squid -k reconfigure -f '|/usr/local/script/squid/pre_process_squid_config_file.sh'
</I>&gt;<i> 
</I>&gt;<i> gives the following line in /var/log/squid/cache.log
</I>
&gt;<i> 2022/09/16 16:20:55 kid1| storeDirWriteCleanLogs: Starting...
</I>&gt;<i> 2022/09/16 16:20:55 kid1|   Finished.  Wrote 0 entries.
</I>&gt;<i> 2022/09/16 16:20:55 kid1|   Took 0.00 seconds (  0.00 entries/sec).
</I>&gt;<i> FATAL: parseConfigFile: '|/usr/local/script/squid/pre_process_squid_config_file.sh' failed with exit code -1
</I>
 &gt; is that a bug?

I am not sure. I cannot reproduce this problem with a modern/supported 
Squid version, but my test environment may be too different from yours. 
If you are willing to try this with Squid v5, I can help with triaging 
this further, but it may take a few iterations to get to the bottom of 
this (e.g., using &quot;bash -x&quot; and adding some no-output command at the 
very end of the script might provide more clues). Others on this mailing 
list may have better ideas/suspects.


&gt;<i> /usr/local/script/squid/pre_process_squid_config_file.sh
</I>&gt;<i> 
</I>&gt;<i> #!/bin/bash
</I>&gt;<i> 
</I>&gt;<i> readonly SQUID_CONFIG_TEMPLATE_FILE='/etc/squid/squid.conf.TEMPLATE'
</I>&gt;<i> 
</I>&gt;<i> case &quot;${HOSTNAME}&quot; in
</I>&gt;<i>     'node1')  readonly HOSTNAME_PEER='node2' ;;
</I>&gt;<i>     'node2')  readonly HOSTNAME_PEER='node1' ;;
</I>&gt;<i>     *)
</I>&gt;<i>         echo &quot;invalid hostname in script ${0}. Exit&quot;
</I>&gt;<i>         exit 1
</I>&gt;<i>         ;;
</I>&gt;<i> esac
</I>&gt;<i> 
</I>&gt;<i> sed \
</I>&gt;<i> -e &quot;s@{HOSTNAME}@${HOSTNAME}@g&quot; \
</I>&gt;<i> -e &quot;s@{HOSTNAME_PEER}@${HOSTNAME_PEER}@g&quot; \
</I>&gt;<i> &quot;${SQUID_CONFIG_TEMPLATE_FILE}&quot;
</I>&gt;<i> --------------------
</I>

FWIW, the &quot;invalid hostname&quot; error should be reported to stderr rather 
than stdout. Otherwise, the error text will be interpreted as Squid 
configuration file contents, producing a somewhat confusing output:

&gt;<i> 2022/09/16 13:49:27| Processing Configuration File: |/tmp/t.sh (depth 0)
</I>
&gt;<i> 2022/09/16 13:49:27| /tmp/t.sh(1): unrecognized: 'invalid'
</I>


HTH,

Alex.

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="025226.html">[squid-users] Howto make Squid config dependent on hostname?
</A></li>
	<LI>Next message (by thread): <A HREF="025228.html">[squid-users] Howto make Squid config dependent on hostname?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25227">[ date ]</a>
              <a href="thread.html#25227">[ thread ]</a>
              <a href="subject.html#25227">[ subject ]</a>
              <a href="author.html#25227">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
