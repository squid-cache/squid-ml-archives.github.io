<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Do squid logs performence affect general request performece?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Do%20squid%20logs%20performence%20affect%20general%20request%0A%20performece%3F&In-Reply-To=%3Cb9487dcc-1874-42b6-9830-be9290cbf7e0%40Spark%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="025211.html">
   <LINK REL="Next"  HREF="025205.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Do squid logs performence affect general request performece?</H1>
    <B>roee klinger</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Do%20squid%20logs%20performence%20affect%20general%20request%0A%20performece%3F&In-Reply-To=%3Cb9487dcc-1874-42b6-9830-be9290cbf7e0%40Spark%3E"
       TITLE="[squid-users] Do squid logs performence affect general request performece?">roeeklinger60 at gmail.com
       </A><BR>
    <I>Sun Sep 18 16:51:40 UTC 2022</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="025211.html">[squid-users] Do squid logs performence affect general request performece?
</A></li>
        <LI>Next message (by thread): <A HREF="025205.html">[squid-users] https on frontend
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25231">[ date ]</a>
              <a href="thread.html#25231">[ thread ]</a>
              <a href="subject.html#25231">[ subject ]</a>
              <a href="author.html#25231">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Thank you for the advice, Alex.

I just wanted to update anyone following or who might follow that the problem ended up being in
my Logstash server, not in Squid, it performed too slow due to a miss configuration, so Squid kept
sending logs but the slow server got over flooded.

After fixing the server I simply set these configuration normally:
access_log <A HREF="tcp://server:port">tcp://server:port</A> logformat=logs

and everything seems to be working fine by default.

I did however notice that UDP does aggregate logs before sending them, and TCP does not,
even when set explicitly.

If anybody runs into this issue in the future it might be worth to follow Alex advice on how to get
this to work.

Thanks,
Roee


On 13 Sep 2022, 6:30 +0300, Alex Rousskov &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt;, wrote:
&gt;<i> On 9/12/22 18:20, roee klinger wrote:
</I>&gt;<i>
</I>&gt;<i> &gt; Thank you for your advice, as suggested I tested a both TCP and UDP, and
</I>&gt;<i> &gt; found TCP to be so slow
</I>&gt;<i> &gt; that is it practically unusable, UDP however works fine, but has the
</I>&gt;<i> &gt; normal disadvantages of UDP.
</I>&gt;<i>
</I>&gt;<i> Glad that test yielded useful results in your environment!
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; It seems that TCP sends each message by itself, and UDP sends them in
</I>&gt;<i> &gt; bulk (10-20 at a time),
</I>&gt;<i> &gt; which seems to be a big part of the performance difference, in fact TCP
</I>&gt;<i> &gt; is so slow that it causes Squid to crash after a while.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; After carefully reading the logs, I tried to get TCP to send in bulk as
</I>&gt;<i> &gt; well by configuring:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; logformat logstash %ts.%03tu %6tr %&gt;a %&lt;la %&gt;lp %Ss/%03&gt;Hs %&lt;st %rm
</I>&gt;<i> &gt; %ru %[un %Sh/%&lt;a %mt %{Client-Tags}&gt;h
</I>&gt;<i> &gt; access_log <A HREF="tcp://127.0.0.1:5400">tcp://127.0.0.1:5400</A> logformat=logstash buffer-size=64KB
</I>&gt;<i> &gt; buffered_logs on
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; But it seems to still be sending the logs line by line, am I missing
</I>&gt;<i> &gt; something?
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> I have not tested this, but if my interpretation of the underlying code
</I>&gt;<i> is correct, then the TCP logging module code does not flush the buffer
</I>&gt;<i> when it accumulates (close to) buffer-size bytes. Instead, the module
</I>&gt;<i> starts writing its buffer after accumulating more than 16KB (2*MAX_URL).
</I>&gt;<i> How long are your typical access.log records?
</I>&gt;<i>
</I>&gt;<i> Each write(2) call of a buffering TCP logging module during normal Squid
</I>&gt;<i> operation should be 16KB, regardless of the buffer-size setting.
</I>&gt;<i>
</I>&gt;<i> FWIW, the official access_log buffer-size documentation hints at
</I>&gt;<i> module-specific flushing algorithms. I cannot describe the exact
</I>&gt;<i> algorithm used by the TCP logging module in a few words, but it is not
</I>&gt;<i> as simple as &quot;accumulate buffer-size bytes and then write the
</I>&gt;<i> accumulated bytes&quot;.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> HTH,
</I>&gt;<i>
</I>&gt;<i> Alex.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; On 9 Sep 2022, 19:57 +0300, Alex Rousskov wrote:
</I>&gt;<i> &gt; &gt; On 9/9/22 08:49, roee klinger wrote:
</I>&gt;<i> &gt; &gt; &gt; Hello,
</I>&gt;<i> &gt; &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt; I have just recently started exploring ingesting logs from Squid via
</I>&gt;<i> &gt; &gt; &gt; Logstash (TCP log ingestion)
</I>&gt;<i> &gt; &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt; I now have to make the decision of how to deploy Logstash, it seems to
</I>&gt;<i> &gt; &gt; &gt; me that I have two options:
</I>&gt;<i> &gt; &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt; 1. Deploy a Logstash instance for every region where I have a Squid
</I>&gt;<i> &gt; &gt; &gt; instance running, resulting in the lowest latency possible between
</I>&gt;<i> &gt; &gt; &gt; Squid and Logstash.
</I>&gt;<i> &gt; &gt; &gt; 2. Deploy a central Logstash instance for all Squid instance worldwide,
</I>&gt;<i> &gt; &gt; &gt; which is the cheapest and easiest option, but will have high latency
</I>&gt;<i> &gt; &gt; &gt; for some of the Squid instance which are located far away
</I>&gt;<i> &gt; &gt; &gt; geographically from the Logstash instance.
</I>&gt;<i> &gt; &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt; I already know that if the log server crashes in Squid, then Squid will
</I>&gt;<i> &gt; &gt; &gt; crash with a fatal error,
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; FYI: Logging error handling is configurable via &quot;access_log on-error&quot;.
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt; so Squid takes logging very seriously, so my
</I>&gt;<i> &gt; &gt; &gt; question is: does TCP logging performance in Squid effect the total
</I>&gt;<i> &gt; &gt; &gt; request performance, or are they independent from each other?
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; TCP logger uses asynchronous non-blocking I/O. Individual HTTP
</I>&gt;<i> &gt; &gt; transactions do not wait for individual log records to be sent. Needless
</I>&gt;<i> &gt; &gt; to say, logging does consume resources and, hence, may affect overall
</I>&gt;<i> &gt; &gt; HTTP transaction performance. And if the log record recipient is too
</I>&gt;<i> &gt; &gt; slow, then Squid will die and/or log records will be dropped.
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; &gt; What would be you recommendations, if request performance is crucial
</I>&gt;<i> &gt; &gt; &gt; (and log performance is not)?
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; I would not be surprised if you would not be able to measure meaningful
</I>&gt;<i> &gt; &gt; performance difference among these modules. From general performance
</I>&gt;<i> &gt; &gt; point of view, and module-specific bugs and limitations notwithstanding,
</I>&gt;<i> &gt; &gt; I would expect &quot;daemon&quot; and &quot;udp&quot; modules to have smaller performance
</I>&gt;<i> &gt; &gt; overhead/cost for Squid workers than the &quot;tcp&quot; module because I expect
</I>&gt;<i> &gt; &gt; that TCP has to &quot;do more&quot; than stdout I/O and UDP. However, I would not
</I>&gt;<i> &gt; &gt; base this decision on such high-level speculations and test various
</I>&gt;<i> &gt; &gt; options instead.
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; HTH,
</I>&gt;<i> &gt; &gt;
</I>&gt;<i> &gt; &gt; Alex.
</I>&gt;<i> &gt; &gt; _______________________________________________
</I>&gt;<i> &gt; &gt; squid-users mailing list
</I>&gt;<i> &gt; &gt; <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> &gt; &gt; <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20220918/ca9a3fc9/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20220918/ca9a3fc9/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="025211.html">[squid-users] Do squid logs performence affect general request performece?
</A></li>
	<LI>Next message (by thread): <A HREF="025205.html">[squid-users] https on frontend
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25231">[ date ]</a>
              <a href="thread.html#25231">[ thread ]</a>
              <a href="subject.html#25231">[ subject ]</a>
              <a href="author.html#25231">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
