<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Prevent squid user to go out through server's IP
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Prevent%20squid%20user%20to%20go%20out%20through%20server%27s%20IP&In-Reply-To=%3Ca8e7ce5a-e3b9-b003-9e3b-8ef519ff4f1e%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="025258.html">
   <LINK REL="Next"  HREF="025263.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Prevent squid user to go out through server's IP</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Prevent%20squid%20user%20to%20go%20out%20through%20server%27s%20IP&In-Reply-To=%3Ca8e7ce5a-e3b9-b003-9e3b-8ef519ff4f1e%40treenet.co.nz%3E"
       TITLE="[squid-users] Prevent squid user to go out through server's IP">squid3 at treenet.co.nz
       </A><BR>
    <I>Thu Sep 29 13:37:53 UTC 2022</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="025258.html">[squid-users] Prevent squid user to go out through server's IP
</A></li>
        <LI>Next message (by thread): <A HREF="025263.html">[squid-users] Frequent disruption of Microsoft Teams and other online VC applications through Squid Proxy
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25267">[ date ]</a>
              <a href="thread.html#25267">[ thread ]</a>
              <a href="subject.html#25267">[ subject ]</a>
              <a href="author.html#25267">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 27/09/22 17:27, Marcelo wrote:
&gt;<i> Hi,
</I>&gt;<i> 
</I>&gt;<i> Even after Squid fulfill ACLs and Cache Peer rules, the client 
</I>&gt;<i> connection keeps going out through squid server&#8217;s IP.
</I>&gt;<i> 
</I>&gt;<i> How can I prevent it to happen?
</I>&gt;<i> 
</I>&gt;<i> For instance, some rule ends with a IPv6 address on 
</I>&gt;<i> tcp_outgoing_address, but when a proxy client connects, he can see this 
</I>&gt;<i> IPv6 address plus the squid server IPv4 address in a ipleak.net and 
</I>&gt;<i> other kinds of proxy detect website.
</I>&gt;<i> 
</I>
You cannot trust external websites like these to show Squid behaviour. 
They employ a number of tricks to uncover IP details regardless of what 
Squid is doing.


&gt;<i> How can I create a rule to say in squid.conf that is forbidden to going 
</I>&gt;<i> out through server&#8217;s IP?
</I>&gt;<i> 
</I>

What you need to look at is:

  a) what HTTP message headers the client is sending to Squid, and

    - specifically whether any hostname or IPs are being mentioned.

  b) what Squid is sending to the server based on those, and

    - specifically whether any hostname or IPs are being mentioned.

  c) what IP address is used on the TCP layer for Squid's server message.

    - specifically whether your tcp_outgoing_address are being used by 
Squid.

Check the above for connections to an IPv6-only server and to an 
IPv4-only server, and also to a dual-stack server.


Be aware that tcp_outgoing_address with an IPv6 can only be used on 
connections to IPv6 servers. It cannot be used for IPv4 connections.


Be aware that HTTP Via header allows the client and Squid to both inform 
origin servers about network topology using hostnames. These can be used 
by the origin to identify Squid's public IP(s) even if those IPs are not 
used for the traffic.
  Disable with &quot;via off&quot; in squid.conf


Be aware that HTTP Forwarded (and X-Forwarded-For, X-Forwarded-By, 
Client-IP, X-Client-IP, X-Origin-IP + maybe others) headers allow the 
client and Squid to both inform origin servers about network topology 
using IP addresses. These can be used to identify client and/or Squid 
internal IPs used for the actually traffic regardless of the publicly 
available name info.
  Disable X-Forwarded-For and Forwarded with &quot;forwarded_for delete&quot; in 
squid.conf
  Disable others with request_header_access directives as-needed.


HTH
Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="025258.html">[squid-users] Prevent squid user to go out through server's IP
</A></li>
	<LI>Next message (by thread): <A HREF="025263.html">[squid-users] Frequent disruption of Microsoft Teams and other online VC applications through Squid Proxy
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25267">[ date ]</a>
              <a href="thread.html#25267">[ thread ]</a>
              <a href="subject.html#25267">[ subject ]</a>
              <a href="author.html#25267">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
