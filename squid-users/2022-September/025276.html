<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Prevent squid user to go out through
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Prevent%20squid%20user%20to%20go%20out%20through&In-Reply-To=%3C4848d533-d7a5-8661-4a22-6c3dd7219432%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="025273.html">
   <LINK REL="Next"  HREF="025274.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Prevent squid user to go out through</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Prevent%20squid%20user%20to%20go%20out%20through&In-Reply-To=%3C4848d533-d7a5-8661-4a22-6c3dd7219432%40treenet.co.nz%3E"
       TITLE="[squid-users] Prevent squid user to go out through">squid3 at treenet.co.nz
       </A><BR>
    <I>Fri Sep 30 07:31:26 UTC 2022</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="025273.html">[squid-users] Prevent squid user to go out through
</A></li>
        <LI>Next message (by thread): <A HREF="025274.html">[squid-users] RES:  Prevent squid user to go out through
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25276">[ date ]</a>
              <a href="thread.html#25276">[ thread ]</a>
              <a href="subject.html#25276">[ subject ]</a>
              <a href="author.html#25276">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 30/09/22 07:38, Marcelo wrote:
&gt;<i> ANSWERS BELOW.
</I>&gt;<i> 
</I>&gt;<i> On 27/09/22 17:27, Marcelo wrote:
</I>&gt;&gt;<i> Hi,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Even after Squid fulfill ACLs and Cache Peer rules, the client
</I>&gt;&gt;<i> connection keeps going out through squid server?s IP.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> How can I prevent it to happen?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> For instance, some rule ends with a IPv6 address on
</I>&gt;&gt;<i> tcp_outgoing_address, but when a proxy client connects, he can see this
</I>&gt;&gt;<i> IPv6 address plus the squid server IPv4 address in a ipleak.net and
</I>&gt;&gt;<i> other kinds of proxy detect website.
</I>&gt;&gt;<i>
</I>&gt;<i> 
</I>&gt;<i> You cannot trust external websites like these to show Squid behaviour.
</I>&gt;<i> They employ a number of tricks to uncover IP details regardless of what
</I>&gt;<i> Squid is doing.
</I>&gt;<i> 
</I>&gt;<i> ==&gt; MARCELO'S ANWWER:
</I>&gt;<i> I know it, but I use the same APIs to identify proxies that the social
</I>&gt;<i> network I have to mimic.
</I>&gt;<i> So the data I get is what I need.
</I>&gt;<i> 
</I>
What I mean is that they can do things like use javascript to have the 
client Browser report its knowledge of the network and/or scan for 
information. So the source of the leak may be something outside of 
Squid's ability to prevent.

Squid can only control details in the HTTP message headers and tell the 
OS what TCP details it would *like* to use. The OS can decide otherwise, 
for example with outgoing NAT.


&gt;&gt;<i> How can I create a rule to say in squid.conf that is forbidden to going
</I>&gt;&gt;<i> out through server?s IP?
</I>&gt;&gt;<i>
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> What you need to look at is:
</I>&gt;<i> 
</I>&gt;<i>    a) what HTTP message headers the client is sending to Squid, and
</I>&gt;<i> 
</I>&gt;<i>      - specifically whether any hostname or IPs are being mentioned.
</I>&gt;<i> 
</I>&gt;<i>    b) what Squid is sending to the server based on those, and
</I>&gt;<i> 
</I>&gt;<i>      - specifically whether any hostname or IPs are being mentioned.
</I>&gt;<i> 
</I>&gt;<i>    c) what IP address is used on the TCP layer for Squid's server message.
</I>&gt;<i> 
</I>&gt;<i> ==&gt; MARCELO'S ANWWER:
</I>&gt;<i> Sure, that I already did, and the result is ok.
</I>&gt;<i> 
</I>&gt;<i>      - specifically whether your tcp_outgoing_address are being used by
</I>&gt;<i> Squid.
</I>&gt;<i> 
</I>
... the only way your two statements (above) and (below) can be true at 
the same time is when a NAT system is changing the correct IP (from 
tcp_outgoing_address) to the wrong one (what you call &quot;'leaked' IPv4 
server IP&quot;).

&gt;<i> 
</I>&gt;<i> The real problem is that Squid are &quot;leaking&quot; the IPv4 server IP. It is going
</I>&gt;<i> out via server IP.
</I>&gt;<i> It's as if squid server's IP was in a TCP_OUTGOING_ADDRESS, but it does not.
</I>&gt;<i> 
</I>
... OR, you have ACLs limiting use of that tcp_outgoing_address to some 
traffic. Leaving Squids default machine IP to be used on the rest.

... OR, you have traffic interception that requires Squid to use 
identical dst-IP used by the client on its request connection (eg for 
TLS decryption).

Eliminating those possibilities is why I had you check TCP layer was 
acting as you want.

... OR, you have a NAT somewhere screwing things ups.


&gt;<i> 
</I>&gt;<i> That is why my original question is how to suppress the IPv4 server's IP in
</I>&gt;<i> Squid.conf?
</I>
You are apparently doing everything that can be done in squid.conf. Time 
to look outside Squid at what the routing system is doing. NAT's on the 
IPv4 traffic being the prime suspect for causing this behaviour.


&gt;<i> Is there any kind of ACL (I have tested MYIP, SRS and DST ones) that I could
</I>&gt;<i> use to deny the connections to goes out via server's IP?
</I>&gt;<i> 
</I>&gt;<i> Something like:
</I>&gt;<i> ACL server_IP &quot;typeN&quot; 192.168.12.1
</I>&gt;<i> HTTP_ACCESS deny server_IP
</I>&gt;<i> 
</I>
If you cannot find what is doing the odd behaviour only for IPv4 (it is 
not normal AFAICT). Then you can setup a rule like that in the Squid 
machines firewall.

Squid does not have any control that can do what you ask.


HTH
Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="025273.html">[squid-users] Prevent squid user to go out through
</A></li>
	<LI>Next message (by thread): <A HREF="025274.html">[squid-users] RES:  Prevent squid user to go out through
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25276">[ date ]</a>
              <a href="thread.html#25276">[ thread ]</a>
              <a href="subject.html#25276">[ subject ]</a>
              <a href="author.html#25276">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
