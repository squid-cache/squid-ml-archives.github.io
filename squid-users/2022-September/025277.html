<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] NTLM V2 Set up for Squid issue
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20NTLM%20V2%20Set%20up%20for%20Squid%20issue&In-Reply-To=%3C8cf8bba2-9475-2992-5616-d46811f41ca9%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="025272.html">
   <LINK REL="Next"  HREF="025273.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] NTLM V2 Set up for Squid issue</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20NTLM%20V2%20Set%20up%20for%20Squid%20issue&In-Reply-To=%3C8cf8bba2-9475-2992-5616-d46811f41ca9%40treenet.co.nz%3E"
       TITLE="[squid-users] NTLM V2 Set up for Squid issue">squid3 at treenet.co.nz
       </A><BR>
    <I>Fri Sep 30 08:05:25 UTC 2022</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="025272.html">[squid-users] NTLM V2 Set up for Squid issue
</A></li>
        <LI>Next message (by thread): <A HREF="025273.html">[squid-users] Prevent squid user to go out through
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25277">[ date ]</a>
              <a href="thread.html#25277">[ thread ]</a>
              <a href="subject.html#25277">[ subject ]</a>
              <a href="author.html#25277">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 30/09/22 06:28, K R, Bharath wrote:
&gt;<i> 
</I>&gt;<i> Hi Team,
</I>&gt;<i> 
</I>&gt;<i> We see the below error while configuring Squid for NTLM V2.
</I>&gt;<i> 
</I>
FYI: NTLM was formally deprecated by Microsoft on April 2006. It should 
not be used except as a last resort for supporting ancient client software.

Please consider implementing its replacement, Negotiate/Kerberos 
authentication instead.



&gt;<i> 1664469456.486&#160;&#160;&#160;&#160; 73 10.65.140.107 *TCP_DENIED/407* 4408 GET 
</I>&gt;<i> <A HREF="http://detectportal.firefox.com/canonical.html">http://detectportal.firefox.com/canonical.html</A> 
</I>&gt;<i> &lt;<A HREF="http://detectportal.firefox.com/canonical.html">http://detectportal.firefox.com/canonical.html</A>&gt; - HIER_NONE/- text/html
</I>&gt;<i> 
</I>
Please be aware that NTLM authentication has the following properties:

  1) each TCP connection needs its own unique handshake.

  2) auth handshake is split over multiple HTTP requests. The first 
several of which *will* receive a 407 response status.

  2) it does not work outside LAN environments


The log provided does not make it clear whether these 407 are the result 
of auth rejection, or just the proxy receiving a lot of new TCP 
connections suddenly.


FWIW, From behaviour seen elsewhere with non-NTLM auth I suspect the 
pattern of detectportal.firefox.com and push.services.mozilla.com 
requests are Firefox automation that runs on opening, but does not try 
to complete auth handshakes initially.
  If you are only seeing these excess of 407 for those domains I would 
ignore as normal.



&gt;<i> 1664469612.625&#160;&#160;&#160;&#160; 34 10.65.140.107 TCP_DENIED/407 4326 CONNECT 
</I>&gt;<i> push.services.mozilla.com:443 - HIER_NONE/- text/html
</I>&gt;<i> 
</I>&gt;<i> auth_param ntlm program /usr/bin/ntlm_auth --diagnostics 
</I>&gt;<i> --helper-protocol=squid-2.5-ntlmssp --domain=xxxxx.com
</I>&gt;<i> 
</I>&gt;<i> auth_param ntlm children 10
</I>&gt;<i> 
</I>&gt;<i> auth_param ntlm keep_alive off
</I>&gt;<i> 
</I>&gt;<i> auth_param ntlm program /usr/lib/squid/ntlm_auth 
</I>&gt;<i> xxxx.com/xxxxx.informatica.com
</I>&gt;<i> 
</I>&gt;<i> auth_param ntlm children 5
</I>&gt;<i> 
</I>&gt;<i> auth_param ntlm max_challenge_reuses 0
</I>&gt;<i> 
</I>&gt;<i> auth_param ntlm max_challenge_lifetime 2 minutes
</I>&gt;<i> 
</I>
FYI, these max_challenge_* parameters have not been supported since 
Squid-2.6.

If you are still using that version or older *PLEASE* upgrade. Current 
supported versions are the Squid-4 and Squid-5 series.



&gt;<i> acl ntlm_users proxy_auth REQUIRED
</I>&gt;<i> 
</I>&gt;<i> http_access allow ntlm_users
</I>&gt;<i> 
</I>
This will permit anyone to supply bad credentials and still use the proxy.

I suggest replacing the above line with:

  http_access deny !ntlm_users

... then followup with any policy rules for allowing users.


&gt;<i> #http_access deny all
</I>&gt;<i> 
</I>&gt;<i> NOTE: Our wbinfo component is working as expected.
</I>&gt;<i> 
</I>&gt;<i> We made use of 
</I>&gt;<i> <A HREF="https://wiki.squid-cache.org/ConfigExamples/Authenticate/Ntlm">https://wiki.squid-cache.org/ConfigExamples/Authenticate/Ntlm</A> 
</I>&gt;<i> &lt;<A HREF="https://wiki.squid-cache.org/ConfigExamples/Authenticate/Ntlm">https://wiki.squid-cache.org/ConfigExamples/Authenticate/Ntlm</A>&gt; for doc.
</I>&gt;<i> 
</I>&gt;<i> Regards,
</I>&gt;<i> 
</I>&gt;<i> Bharath
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="025272.html">[squid-users] NTLM V2 Set up for Squid issue
</A></li>
	<LI>Next message (by thread): <A HREF="025273.html">[squid-users] Prevent squid user to go out through
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25277">[ date ]</a>
              <a href="thread.html#25277">[ thread ]</a>
              <a href="subject.html#25277">[ subject ]</a>
              <a href="author.html#25277">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
