From 0xff1f at gmail.com  Sun Apr  2 13:08:08 2023
From: 0xff1f at gmail.com (Dr.X)
Date: Sun, 2 Apr 2023 13:08:08 +0000
Subject: [squid-users] limit down- & upload speed for each proxy to 30
 Mbit
In-Reply-To: <DBBPR09MB45235C26CF89E81C683F2035F7B99@DBBPR09MB4523.eurprd09.prod.outlook.com>
References: <AS2PR10MB69254794BA0D55D2973A682A92B89@AS2PR10MB6925.EURPRD10.PROD.OUTLOOK.COM>
 <7446ebb6-f8fd-0971-0bdc-9f8fd1aaab26@treenet.co.nz>
 <CADJwPw+SoAh92D-sakXyP0ZYwR+raWzk3sDkGydYDtQNjTvrig@mail.gmail.com>
 <10755d8e-2db7-b76b-f4d2-e5c7acdab5d0@treenet.co.nz>
 <DBBPR09MB45235C26CF89E81C683F2035F7B99@DBBPR09MB4523.eurprd09.prod.outlook.com>
Message-ID: <DBBPR09MB45231180F0C542F5ABB68854F78D9@DBBPR09MB4523.eurprd09.prod.outlook.com>

Hi Amos,

Have not heard back from you regarding squid 4. x which has delay pools really working.
Do you have any squid4.x that works with delay pools?

I put Alex in CC now.


Thanks


From: Dr.X <0xff1f at gmail.com>
Date: Monday, 13 March 2023 12:24
To: Amos Jeffries <squid3 at treenet.co.nz>
Cc: squid-users at lists.squid-cache.org <squid-users at lists.squid-cache.org>
Subject: Re: [squid-users] limit down- & upload speed for each proxy to 30 Mbit
Hi Amos ,

Alex already confirmed this bug with me, which still needs to be solved with all squid4.x versions.

Squid 4.x has a bug that accepts the config, but the config has no meaning.

Please, if you have any running squid 4.x that support delay pools, let me know the version ?.  I will be thankful.

Best.




From: squid-users <squid-users-bounces at lists.squid-cache.org> on behalf of Amos Jeffries <squid3 at treenet.co.nz>
Date: Monday, 13 March 2023 13:10
To:
Cc: squid-users at lists.squid-cache.org <squid-users at lists.squid-cache.org>
Subject: Re: [squid-users] limit down- & upload speed for each proxy to 30 Mbit
On 13/03/2023 1:11 pm, Dr.X wrote:
> None of squid 4.x has delay pools supported .

This is not true unless you built your Squid with pools disabled.

YMMV due to some types of traffic not being able to pool.

Amos

_______________________________________________
squid-users mailing list
squid-users at lists.squid-cache.org
http://lists.squid-cache.org/listinfo/squid-users
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230402/ce939981/attachment.htm>

From rousskov at measurement-factory.com  Mon Apr  3 00:55:06 2023
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Sun, 2 Apr 2023 20:55:06 -0400
Subject: [squid-users] logging: TCP connection to x.x.x.x/3128 failed
In-Reply-To: <ZCV5SBq85hDNEyzv@waldemar-brodkorb.de>
References: <ZCV5SBq85hDNEyzv@waldemar-brodkorb.de>
Message-ID: <583fc758-1b73-877a-4d67-303c69d7fbf0@measurement-factory.com>

On 3/30/23 07:58, Waldemar Brodkorb wrote:

> we recently updated one of our stage 1 proxies to Ubuntu 22.04 with
> Squid 5.8. The setup is like so:
> clients <-> loadbalancer <-> stage 1 proxies <-> stage 2 proxies <-> internet
> 
> Now the cache.log on the stage 1 proxy is polluted with a lot of
> messages like: TCP connection to x.x.x.x/3128 failed
> 
> The message appear when a client tries to connect to a website which
> does not resolve via DNS. The parent stage 2 proxy sends then a
> 50x error and the stage 1 proxy logs messages like above for every
> of the six stage 2 proxies.

> How can we suppress these messages 

I do not think you can suppress these messages without changing Squid 
source code.

Please note that when Squid considers the connection to a cache_peer 
failed, it decrements the "up" counter for that peer. If that counter 
reaches zero, the peer will be marked as dead. The counter starts at 
connect-fail-limit=N level. The counter is restored to N when a 
connection succeeds, so you may not normally see a dead peer for this 
specific reasons, but it is just luck.


> or can they be fixed to what is really happening?

I suspect any fixes would require changing Squid sources. Squid v6 
commit 022dbab might be helpful here, at least as an inspiration (it 
does not apply to v5 cleanly and it focuses on 4xx peer responses while 
your messages are related to 5xx peer responses).

Squid v6 has cache_log_message directive that can be used to suppress 
some level-1 errors, but the error you are writing about is not one of 
them, and, more importantly, I would not recommend suppressing it (see 
the "Please note..." paragraph above for the discussion of this error 
potential importance). That directive is not available in v5.


Ultimately, what you are describing sounds like a Squid bug to me: Squid 
should not blame its cache_peer for request-target DNS resolution errors 
outside that peer control. Fixing that bug can be controversial because 
an admin may want Squid to automatically start bypassing a cache_peer 
that is, for example, misconfigured and cannot resolve _any_ 
request-targets. One could argue that detection (and bypass) of (such) 
problematic cache_peers should be done differently, but it is unknown 
whether others would agree with any specific logic changes in that area.

For example, the proposal to add an ACL-driven cache_peer_fault 
directive[1] (to give the admin more control over alive/dead decisions) 
was rejected as "overkill"[2], preserving the approach that relies on 
hard-coding decisions (including commit 022dbab fixes mentioned above).

[1] 
https://github.com/squid-cache/squid/blob/25431f18f2f5e796b8704c85fc51f93b6cc2a73d/src/cf.data.pre#L4019

[2] https://github.com/squid-cache/squid/pull/1166#issuecomment-1295806530


Going forward, one can try to argue that HTTP 502 cache_peer responses 
should never be treated as that cache_peer fault (as far as alive/dead 
decisions are concerned) despite the fact that some 502 responses may be 
related to cache_peer problems rather than basic DNS errors. That would 
be a straightforward change, especially in v6. (If that attempt fails,) 
one could also try to re-introduce the cache_peer_fault directive to let 
admin decide.


https://wiki.squid-cache.org/SquidFaq/AboutSquid#how-to-add-a-new-squid-feature-enhance-of-fix-something


Cheers,

Alex.



From rousskov at measurement-factory.com  Mon Apr  3 13:51:40 2023
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Mon, 3 Apr 2023 09:51:40 -0400
Subject: [squid-users] limit down- & upload speed for each proxy to 30
 Mbit
In-Reply-To: <DBBPR09MB45231180F0C542F5ABB68854F78D9@DBBPR09MB4523.eurprd09.prod.outlook.com>
References: <AS2PR10MB69254794BA0D55D2973A682A92B89@AS2PR10MB6925.EURPRD10.PROD.OUTLOOK.COM>
 <7446ebb6-f8fd-0971-0bdc-9f8fd1aaab26@treenet.co.nz>
 <CADJwPw+SoAh92D-sakXyP0ZYwR+raWzk3sDkGydYDtQNjTvrig@mail.gmail.com>
 <10755d8e-2db7-b76b-f4d2-e5c7acdab5d0@treenet.co.nz>
 <DBBPR09MB45235C26CF89E81C683F2035F7B99@DBBPR09MB4523.eurprd09.prod.outlook.com>
 <DBBPR09MB45231180F0C542F5ABB68854F78D9@DBBPR09MB4523.eurprd09.prod.outlook.com>
Message-ID: <6b4f1a64-667a-17ee-7d34-4837f2a12dcb@measurement-factory.com>

On 4/2/23 09:08, Dr.X wrote:
> Hi Amos,
> 
> Have not heard back from you regarding squid 4. x which has delay pools 
> really working.
> 
> Do you have any squid4.x that works with delay pools?

I cannot answer for Amos, but I would like to clarify delay pools 
support status: For some traffic, some delay pools configurations are 
probably working OK in Squid v4+. The Squid bug Ahmad has been referring 
to is Bug 4913 (Delay Pools don't work for Tunneled traffic):

* https://bugs.squid-cache.org/show_bug.cgi?id=4913

* http://lists.squid-cache.org/pipermail/squid-users/2022-June/024922.html


> I put Alex in CC now.

No need -- I am on this list.


Cheers,

Alex.

> *From: *Dr.X <0xff1f at gmail.com>
> *Date: *Monday, 13 March 2023 12:24
> *To: *Amos Jeffries <squid3 at treenet.co.nz>
> *Cc: *squid-users at lists.squid-cache.org <squid-users at lists.squid-cache.org>
> *Subject: *Re: [squid-users] limit down- & upload speed for each proxy 
> to 30 Mbit
> 
> Hi Amos ,
> 
> Alex already confirmed this bug with me, which still needs to be solved 
> with all squid4.x versions.
> 
> Squid 4.x has a bug that accepts the config, but the config has no meaning.
> 
> Please, if you have any running squid 4.x that support delay pools, let 
> me know the version ?. ?I will be thankful.
> 
> Best.
> 
> *From: *squid-users <squid-users-bounces at lists.squid-cache.org> on 
> behalf of Amos Jeffries <squid3 at treenet.co.nz>
> *Date: *Monday, 13 March 2023 13:10
> *To: *
> *Cc: *squid-users at lists.squid-cache.org <squid-users at lists.squid-cache.org>
> *Subject: *Re: [squid-users] limit down- & upload speed for each proxy 
> to 30 Mbit
> 
> On 13/03/2023 1:11 pm, Dr.X wrote:
>> None of squid 4.x has delay pools supported .
> 
> This is not true unless you built your Squid with pools disabled.
> 
> YMMV due to some types of traffic not being able to pool.
> 
> Amos
> 
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users 
> <http://lists.squid-cache.org/listinfo/squid-users>
> 



From ankor2023 at gmail.com  Wed Apr  5 10:07:45 2023
From: ankor2023 at gmail.com (Andrey K)
Date: Wed, 5 Apr 2023 13:07:45 +0300
Subject: [squid-users] Enable caching
Message-ID: <CADJd0Y1qBCX17D71jLtDFE2Dbxjf70_pT5yTJkpSJwnUMx=3zg@mail.gmail.com>

Hello,

Previously, caching was disabled on our proxy servers. Now we need to cache
some content (files about 10 MB in size).
So we changed the squid.conf:

#Disable caching
#cache deny all
#no_cache deny all
#cache_mem 0

cache_dir ufs /data/squid/cache 32000 16 256 max-size=12000000

We have 24 workers on each proxy.

We saw that some requests were taken from the cache, and some were not.
The documentation says:
"In SMP configurations, cache_dir must not precede the workers option and
should use configuration macros or conditionals to give each worker
interested in disk caching a dedicated cache directory."

I found Amos' comment that "rock cache type *is* SMP-aware" (
http://lists.squid-cache.org/pipermail/squid-users/2018-October/019410.html)
So we switched to a rock cache_dir:
cache_dir rock /data/squid/cache 32000 max-size=12000000

Now everything seems to be working fine in the test environment, but I
found limitations on the RockStore (
https://wiki.squid-cache.org/Features/RockStore):
"Objects larger than 32,000 bytes cannot be cached when cache_dirs are
shared among workers."

Does this mean that RockStore is not suitable for caching large files?
Should I switch back to the UFS and configure 24 cache_dirs (this will lead
to a significant consumption of disk space)?

Kind regards,
      Ankor
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230405/afb0b696/attachment.htm>

From rousskov at measurement-factory.com  Wed Apr  5 13:27:07 2023
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Wed, 5 Apr 2023 09:27:07 -0400
Subject: [squid-users] Enable caching
In-Reply-To: <CADJd0Y1qBCX17D71jLtDFE2Dbxjf70_pT5yTJkpSJwnUMx=3zg@mail.gmail.com>
References: <CADJd0Y1qBCX17D71jLtDFE2Dbxjf70_pT5yTJkpSJwnUMx=3zg@mail.gmail.com>
Message-ID: <1171a8a3-bf15-67ca-1635-64f8ef425c57@measurement-factory.com>

On 4/5/23 06:07, Andrey K wrote:

> Previously, caching was disabled on our proxy servers. Now we need to 
> cache some content (files about 10 MB in size).
> So we changed the squid.conf:

> cache_dir ufs /data/squid/cache 32000 16 256 max-size=12000000
> 
> We have 24 workers on each proxy.

UFS-based cache_dirs are not supported in multi-worker configurations 
and, in most cases, should not be used in such configurations. The 
combination will violate basic HTTP caching rules and may crash Squid 
and/or corrupt responses.


> We saw that some requests were taken from the cache, and some were not.
> The documentation?says:
> "In SMP configurations, cache_dir must not precede the workers option 
> and should use configuration macros or conditionals to give each worker 
> interested in disk caching a dedicated cache directory."

The official documentation quoted above is stale and very misleading in 
modern Squids. Ignore it. I will try to find the time to post a PR to 
fix this.


> So we switched to a rock cache_dir:
> cache_dir rock /data/squid/cache 32000 max-size=12000000
> 
> Now everything seems to be working fine in the test environment, but I 
> found limitations on the RockStore 
> (https://wiki.squid-cache.org/Features/RockStore:
> "Objects larger than 32,000 bytes cannot be cached when cache_dirs are 
> shared among workers."

The Feature/RockStore page is stale and can easily mislead. In general, 
Feature/Foo wiki pages are often development-focused and get stale with 
time. They cannot be reliably used as a Squid feature documentation.


> Does this mean that?RockStore?is not suitable for caching large files?

No, it does not. Rock storage has evolved since that Feature page was 
written. You can see the following wiki page discussing evolved rock 
storage design, but that page probably has some stale info as well:
https://wiki.squid-cache.org/Features/LargeRockStore


> Should I switch back?to the UFS and configure 24 cache_dirs

If everything is "working fine", then you should not. Otherwise, I 
recommend discussing specific problems before switching to that 
unsupported and dangerous hack.


HTH,

Alex.



From venkataganesh_x_thoppae at fanniemae.com  Wed Apr  5 18:17:42 2023
From: venkataganesh_x_thoppae at fanniemae.com (Thoppae, Venkataganesh x (Contractor))
Date: Wed, 5 Apr 2023 18:17:42 +0000
Subject: [squid-users] Question for Enterprise adoption
Message-ID: <PH0PR06MB736792DA62330EFC63DB81FCAC909@PH0PR06MB7367.namprd06.prod.outlook.com>


Hello
We are looking to get squid proxy as an authorized product for internal use at Fannie Mae and the approval team here has the below question, which is generally asked for all third party products. Any response or guidance would be extremely helpful.

"Are any advanced algorithms, predictive analytics, dynamic components, machine learning, or artificial intelligence are used within or by this product, and whether any part of the input or output process involves any of these techniques. Examples of non-traditional modeling capabilities include but are not limited to: auto-complete or suggested text functionalities; optical character recognition (OCR) or other image recognition and processing; transcription, translation, speech-to-text or text-to-speech; search engines; virtual assistants; and other assistive technologies."

Regards
Venkataganesh Thoppae



Fannie Mae Confidential
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230405/3b48fef4/attachment.htm>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: image001.gif
Type: image/gif
Size: 92 bytes
Desc: image001.gif
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230405/3b48fef4/attachment.gif>

From rousskov at measurement-factory.com  Wed Apr  5 18:50:36 2023
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Wed, 5 Apr 2023 14:50:36 -0400
Subject: [squid-users] Question for Enterprise adoption
In-Reply-To: <PH0PR06MB736792DA62330EFC63DB81FCAC909@PH0PR06MB7367.namprd06.prod.outlook.com>
References: <PH0PR06MB736792DA62330EFC63DB81FCAC909@PH0PR06MB7367.namprd06.prod.outlook.com>
Message-ID: <034a94cf-6a11-ca26-d267-93fc4659e61c@measurement-factory.com>

On 4/5/23 14:17, Thoppae, Venkataganesh x (Contractor) wrote:

> We are looking to get squid proxy as an authorized product for internal 
> use at Fannie Mae and the approval team here has the below question, 
> which is generally asked for all third party products. Any response or 
> guidance would be extremely helpful.

> "Are any advanced algorithms, predictive analytics, dynamic components, 
> machine learning, or artificial intelligence are used within or by this 
> product, and whether any part of the input or output process involves 
> any of these techniques. 

Yes, for some definition of those techniques.

For example, Squid supports such "dynamic components" as eCAP adaptation 
modules (that may use AI and similar techniques), and some Squid 
developers use "auto-complete or suggested text functionalities" and 
automated "translation" mentioned below as examples of (presumably) the 
"techniques" in the above question.

Nothing related to the above question should affect Squid adoption at 
Fannie Mae IMHO: FWIW, Squid code is created and/or curated by humans, 
just like it has been for decades, but we may use any new techniques at 
our disposal, so the past should not really matter.


> Examples of non-traditional modeling 
> capabilities include but are not limited to: auto-complete or suggested 
> text functionalities; optical character recognition (OCR) or other image 
> recognition and processing; transcription, translation, speech-to-text 
> or text-to-speech; search engines; virtual assistants; and other 
> assistive technologies."

Please note that the above examples do not quite match the question: The 
question does not use the words "non-traditional modeling capabilities".

If you explain the actual goal of these questions, you may receive 
better guidance. Right now, it feels like virtually any complex software 
is likely to qualify for a "yes" answer because the question is so vague 
and so broad. For example, auto-complete has been in use for many years, 
long before large language models and AI bots using them became popular.


Cheers,

Alex.



From wbx at openadk.org  Thu Apr  6 10:41:09 2023
From: wbx at openadk.org (Waldemar Brodkorb)
Date: Thu, 6 Apr 2023 12:41:09 +0200
Subject: [squid-users] logging: TCP connection to x.x.x.x/3128 failed
In-Reply-To: <583fc758-1b73-877a-4d67-303c69d7fbf0@measurement-factory.com>
References: <ZCV5SBq85hDNEyzv@waldemar-brodkorb.de>
 <583fc758-1b73-877a-4d67-303c69d7fbf0@measurement-factory.com>
Message-ID: <ZC6hxX5zyPd5inz8@waldemar-brodkorb.de>

Hi Alex,
Alex Rousskov wrote,

Thanks for your detailed answer.

> On 3/30/23 07:58, Waldemar Brodkorb wrote:
> 
> > we recently updated one of our stage 1 proxies to Ubuntu 22.04 with
> > Squid 5.8. The setup is like so:
> > clients <-> loadbalancer <-> stage 1 proxies <-> stage 2 proxies <-> internet
> > 
> > Now the cache.log on the stage 1 proxy is polluted with a lot of
> > messages like: TCP connection to x.x.x.x/3128 failed
> > 
> > The message appear when a client tries to connect to a website which
> > does not resolve via DNS. The parent stage 2 proxy sends then a
> > 50x error and the stage 1 proxy logs messages like above for every
> > of the six stage 2 proxies.
> 
> > How can we suppress these messages
> 
> I do not think you can suppress these messages without changing Squid source
> code.

Okay, we changed the loglevel for this message.
 
> Please note that when Squid considers the connection to a cache_peer failed,
> it decrements the "up" counter for that peer. If that counter reaches zero,
> the peer will be marked as dead. The counter starts at connect-fail-limit=N
> level. The counter is restored to N when a connection succeeds, so you may
> not normally see a dead peer for this specific reasons, but it is just luck.

We had no luck, we are seeing a lot of dead peer messages so we set
connect-fail-limit=100 and now everything looks okay to us.

There is still one assertion which happens sometimes:
cache.log:2023/04/06 07:24:48 kid1| assertion failed: ../src/base/CbcPointer.h:181: "EX"

Have you ever seen this in the wild? What does it mean?

best regards
 Waldemar
 
> Cheers,
> 
> Alex.


From ankor2023 at gmail.com  Thu Apr  6 13:08:16 2023
From: ankor2023 at gmail.com (Andrey K)
Date: Thu, 6 Apr 2023 16:08:16 +0300
Subject: [squid-users] Enable caching
In-Reply-To: <1171a8a3-bf15-67ca-1635-64f8ef425c57@measurement-factory.com>
References: <CADJd0Y1qBCX17D71jLtDFE2Dbxjf70_pT5yTJkpSJwnUMx=3zg@mail.gmail.com>
 <1171a8a3-bf15-67ca-1635-64f8ef425c57@measurement-factory.com>
Message-ID: <CADJd0Y2_HxZZi_Fsba8Amq=yJEdy0b-240xRNCp88MxYTGMXdQ@mail.gmail.com>

Hello Alex,

Thank you for the explanations.

Could you tell me if there is a way to view the objects (URLs) and their
statuses stored in the rock file?
I tried unsuccessfully to find this information using squidclient in
mgr:menu.

You gave me a very useful link:
https://wiki.squid-cache.org/Features/LargeRockStore
Maybe there is a more detailed description of the internal rock data
structures?
I could try to write a script that reads the necessary information from the
cache_dir file.

Kind regards,
     Ankor.


??, 5 ???. 2023??. ? 16:27, Alex Rousskov <rousskov at measurement-factory.com
>:

> On 4/5/23 06:07, Andrey K wrote:
>
> > Previously, caching was disabled on our proxy servers. Now we need to
> > cache some content (files about 10 MB in size).
> > So we changed the squid.conf:
>
> > cache_dir ufs /data/squid/cache 32000 16 256 max-size=12000000
> >
> > We have 24 workers on each proxy.
>
> UFS-based cache_dirs are not supported in multi-worker configurations
> and, in most cases, should not be used in such configurations. The
> combination will violate basic HTTP caching rules and may crash Squid
> and/or corrupt responses.
>
>
> > We saw that some requests were taken from the cache, and some were not.
> > The documentation says:
> > "In SMP configurations, cache_dir must not precede the workers option
> > and should use configuration macros or conditionals to give each worker
> > interested in disk caching a dedicated cache directory."
>
> The official documentation quoted above is stale and very misleading in
> modern Squids. Ignore it. I will try to find the time to post a PR to
> fix this.
>
>
> > So we switched to a rock cache_dir:
> > cache_dir rock /data/squid/cache 32000 max-size=12000000
> >
> > Now everything seems to be working fine in the test environment, but I
> > found limitations on the RockStore
> > (https://wiki.squid-cache.org/Features/RockStore:
> > "Objects larger than 32,000 bytes cannot be cached when cache_dirs are
> > shared among workers."
>
> The Feature/RockStore page is stale and can easily mislead. In general,
> Feature/Foo wiki pages are often development-focused and get stale with
> time. They cannot be reliably used as a Squid feature documentation.
>
>
> > Does this mean that RockStore is not suitable for caching large files?
>
> No, it does not. Rock storage has evolved since that Feature page was
> written. You can see the following wiki page discussing evolved rock
> storage design, but that page probably has some stale info as well:
> https://wiki.squid-cache.org/Features/LargeRockStore
>
>
> > Should I switch back to the UFS and configure 24 cache_dirs
>
> If everything is "working fine", then you should not. Otherwise, I
> recommend discussing specific problems before switching to that
> unsupported and dangerous hack.
>
>
> HTH,
>
> Alex.
>
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230406/366d4bce/attachment.htm>

From rousskov at measurement-factory.com  Thu Apr  6 17:35:01 2023
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Thu, 6 Apr 2023 13:35:01 -0400
Subject: [squid-users] Enable caching
In-Reply-To: <CADJd0Y2_HxZZi_Fsba8Amq=yJEdy0b-240xRNCp88MxYTGMXdQ@mail.gmail.com>
References: <CADJd0Y1qBCX17D71jLtDFE2Dbxjf70_pT5yTJkpSJwnUMx=3zg@mail.gmail.com>
 <1171a8a3-bf15-67ca-1635-64f8ef425c57@measurement-factory.com>
 <CADJd0Y2_HxZZi_Fsba8Amq=yJEdy0b-240xRNCp88MxYTGMXdQ@mail.gmail.com>
Message-ID: <4fbfd7a8-5598-fd50-c618-aaadddcb685d@measurement-factory.com>

On 4/6/23 09:08, Andrey K wrote:

> Could you tell me if there is a way to view the?objects (URLs) and?their 
> statuses stored?in the rock file?

There is no visualization software for rock db storage. One can 
obviously use xxd and similar generic tools to look at raw db bytes, 
even in a running Squid instance, but your needs are probably different.


> I tried unsuccessfully to find this information using squidclient in 
> mgr:menu.

Cache manager queries are currently ineffective for analyzing individual 
rock cache_dir objects because cache manager code relies on the legacy 
in-memory worker-specific store index while rock uses shared memory 
structures shared among workers.


> You gave me a very useful link: 
> https://wiki.squid-cache.org/Features/LargeRockStore 
> Maybe there is a more detailed description of the internal rock data 
> structures?

IIRC, the next level of detail is available in source code only. For 
starting points, consider src/fs/rock/RockDbCell.h and the end of 
Rock::SwapDir::create() that writes an all-zeroes db file header.


HTH,

Alex.


> I could try to write a script that reads the necessary information from 
> the cache_dir file.
> 
> Kind?regards,
>  ? ? ?Ankor.
> 
> 
> ??, 5 ???. 2023??. ? 16:27, Alex Rousskov 
> <rousskov at measurement-factory.com 
> <mailto:rousskov at measurement-factory.com>>:
> 
>     On 4/5/23 06:07, Andrey K wrote:
> 
>      > Previously, caching was disabled on our proxy servers. Now we
>     need to
>      > cache some content (files about 10 MB in size).
>      > So we changed the squid.conf:
> 
>      > cache_dir ufs /data/squid/cache 32000 16 256 max-size=12000000
>      >
>      > We have 24 workers on each proxy.
> 
>     UFS-based cache_dirs are not supported in multi-worker configurations
>     and, in most cases, should not be used in such configurations. The
>     combination will violate basic HTTP caching rules and may crash Squid
>     and/or corrupt responses.
> 
> 
>      > We saw that some requests were taken from the cache, and some
>     were not.
>      > The documentation?says:
>      > "In SMP configurations, cache_dir must not precede the workers
>     option
>      > and should use configuration macros or conditionals to give each
>     worker
>      > interested in disk caching a dedicated cache directory."
> 
>     The official documentation quoted above is stale and very misleading in
>     modern Squids. Ignore it. I will try to find the time to post a PR to
>     fix this.
> 
> 
>      > So we switched to a rock cache_dir:
>      > cache_dir rock /data/squid/cache 32000 max-size=12000000
>      >
>      > Now everything seems to be working fine in the test environment,
>     but I
>      > found limitations on the RockStore
>      > (https://wiki.squid-cache.org/Features/RockStore
>     <https://wiki.squid-cache.org/Features/RockStore>:
>      > "Objects larger than 32,000 bytes cannot be cached when
>     cache_dirs are
>      > shared among workers."
> 
>     The Feature/RockStore page is stale and can easily mislead. In general,
>     Feature/Foo wiki pages are often development-focused and get stale with
>     time. They cannot be reliably used as a Squid feature documentation.
> 
> 
>      > Does this mean that?RockStore?is not suitable for caching large
>     files?
> 
>     No, it does not. Rock storage has evolved since that Feature page was
>     written. You can see the following wiki page discussing evolved rock
>     storage design, but that page probably has some stale info as well:
>     https://wiki.squid-cache.org/Features/LargeRockStore
>     <https://wiki.squid-cache.org/Features/LargeRockStore>
> 
> 
>      > Should I switch back?to the UFS and configure 24 cache_dirs
> 
>     If everything is "working fine", then you should not. Otherwise, I
>     recommend discussing specific problems before switching to that
>     unsupported and dangerous hack.
> 
> 
>     HTH,
> 
>     Alex.
> 
>     _______________________________________________
>     squid-users mailing list
>     squid-users at lists.squid-cache.org
>     <mailto:squid-users at lists.squid-cache.org>
>     http://lists.squid-cache.org/listinfo/squid-users
>     <http://lists.squid-cache.org/listinfo/squid-users>
> 



From rousskov at measurement-factory.com  Thu Apr  6 17:42:59 2023
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Thu, 6 Apr 2023 13:42:59 -0400
Subject: [squid-users] logging: TCP connection to x.x.x.x/3128 failed
In-Reply-To: <ZC6hxX5zyPd5inz8@waldemar-brodkorb.de>
References: <ZCV5SBq85hDNEyzv@waldemar-brodkorb.de>
 <583fc758-1b73-877a-4d67-303c69d7fbf0@measurement-factory.com>
 <ZC6hxX5zyPd5inz8@waldemar-brodkorb.de>
Message-ID: <77671299-a89e-a5c4-e79e-799ee5f49248@measurement-factory.com>

On 4/6/23 06:41, Waldemar Brodkorb wrote:

> There is still one assertion which happens sometimes:
> cache.log:2023/04/06 07:24:48 kid1| assertion failed: ../src/base/CbcPointer.h:181: "EX"
> 
> Have you ever seen this in the wild? What does it mean?

This low-level assertion (where "EX" is usually spelled as "c") 
corresponds to many high-level Squid bugs, most of them fixed. Please 
see https://bugs.squid-cache.org/show_bug.cgi?id=5265#c1 for the 
suggested next steps.

Alex.



From alessio.ballarini at ext.noovle.com  Fri Apr  7 11:00:09 2023
From: alessio.ballarini at ext.noovle.com (Alessio Ballarini (External))
Date: Fri, 7 Apr 2023 13:00:09 +0200
Subject: [squid-users] SQUID PROXY ERRORS - SUPPORT
Message-ID: <CAGC3VAvD54kWyTQAnVwKrOGgtBQtFugNDD80Um68sML4w+N6Gg@mail.gmail.com>

Hi Squid Support,
we are facing a problem with Squid proxy, configurated on our server named
"amiproxy".

I explain the role of this proxy in the infrastructure as follow:

- There are two SAP application server that need to use a Proxy to reach a
remote server out of our local network.
- The Proxy is configured on "amiproxy" by using Squid (I attach the
squid.conf)
- The TCP connections work inconsistently: sometimes they work (200) and
sometimes they do not (503).

Specifically in the access.log of the Squid we registered these 503 erros:

1680672739.134 59768 172.29.7.148 NONE/503 0 CONNECT 195.75.144.10:22 -
HIER_NONE/- -
1680681044.960 60450 172.29.7.148 NONE/503 0 CONNECT
appbpe.pellegrinicard.it:443 - HIER_NONE/- -

We tried to debug the log of the squid, and we found that this error is a
"generic" application error that could depend on several factors.

I hope you can support us, because we are pretty sure that the cause
depends on Squid, since we tried to bypass it using a direct TCP flow to
the remote server from the SAP application server and we did not detect any
errors.

Thank you
Kind regards

Alessio

-- 

_________________________________________
[image: Noovle S.p.A.] <https://noovle.com/it>
*Alessio Ballarini (External)*
DC.O.APS

*Noovle S.p.A.*
Via Gaetano Negri 1 - 20123 Milano (MI)
+393488654039
*Twitter* <https://twitter.com/Noovle_SpA> - *Linkedin*
<https://www.linkedin.com/company/noovle/>
*www.noovle.com* <https://www.noovle.com/it/>

-- 
_INFORMATIVA SULLA PRIVACY E SULLA CONFIDENZIALITA': Ai sensi del Reg. UE 
n.2016/679 sulla tutela della privacy, Vi informiamo che il presente 
messaggio e-mail potrebbe contenere informazioni riservate e/o fondate su 
privilegio legale, oltre a dati personali. Vi informiamo che deteniamo e 
trattiamo i dati contenuti nella presente per i soli scopi di adempiere ad 
obblighi di legge e/o contrattuali e/o per la tutela di nostri legittimi 
interessi. La conoscenza di questi dati ? riservata ai soli destinatari di 
questa e-mail. Al di fuori degli scopi sopra descritti, tali dati non 
saranno da noi rivelati in alcun modo a terzi, senza il previo consenso 
scritto degli interessati coinvolti, ove prescritto e/o necessario ai sensi 
della legge applicabile.?_Qualora Voi non siate gli effettivi destinatari 
della presente e-mail, Vi informiamo che ne sono severamente proibite la 
diffusione, la copia e/o la distribuzione.?_Nel caso aveste ricevuto il 
presente messaggio per errore Vi preghiamo, pertanto, di informarci 
immediatamente e di eliminarlo dal vostro computer. Grazie.___
_
_
_PRIVACY 
AND CONFIDENTIALITY NOTICE: Pursuant to EU Regulation no.679/2016 on 
privacy protection, we inform You that his e-mail message might contain 
confidential and/or legally privileged information as well as personal 
data. We inform You that we hold and process all data contained therein for 
the sole purposes of meeting legal and/or contractual obligation(s) and/or 
for our legitimate interest. Knowledge of these data is reserved solely to 
the person(s) to whom this e-mail is addressed. Outside the scopes 
described above, these data will not be disclosed by us in any way to third 
parties without the prior written consent of the relevant data subject(s), 
where prescribed and/or deemed necessary by applicable law(s).?_If You are 
not the intended recipient, You are hereby notified that any disclosure, 
copying and/or distribution of the contents of this e-mail message is 
strictly prohibited.?_If You have received this communication in error, 
therefore, please delete it immediately and contact us to let us know it. 
Thank you._


____
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230407/8ad82807/attachment.htm>
-------------- next part --------------



acl SSL_ports port 443
acl CONNECT method CONNECT

dns_v4_first on

http_access deny !Safe_ports

http_access deny CONNECT !SSL_ports

http_access deny manager



http_access allow localnet
http_access allow localhost

http_access deny all

http_port 10.201.214.145:3128


coredump_dir /var/cache/squid

refresh_pattern ^ftp:           1440    20%     10080
refresh_pattern ^gopher:        1440    0%      1440
refresh_pattern -i (/cgi-bin/|\?) 0     0%      0
refresh_pattern .               0       20%     4320


debug_options ALL,3

From Antony.Stone at squid.open.source.it  Fri Apr  7 11:08:02 2023
From: Antony.Stone at squid.open.source.it (Antony Stone)
Date: Fri, 7 Apr 2023 13:08:02 +0200
Subject: [squid-users] Squid proxy errors - support
In-Reply-To: <CAGC3VAvD54kWyTQAnVwKrOGgtBQtFugNDD80Um68sML4w+N6Gg@mail.gmail.com>
References: <CAGC3VAvD54kWyTQAnVwKrOGgtBQtFugNDD80Um68sML4w+N6Gg@mail.gmail.com>
Message-ID: <202304071308.02715.Antony.Stone@squid.open.source.it>

On Friday 07 April 2023 at 13:00:09, Alessio Ballarini (External) wrote:

> Hi Squid Support,
> we are facing a problem with Squid proxy

Which version of Squid, and running on which version of which operating 
system?


Antony.

-- 
Normal people think "If it ain't broke, don't fix it".
Engineers think "If it ain't broke, it doesn't have enough features yet".

                                                   Please reply to the list;
                                                         please *don't* CC me.


From alessio.ballarini at ext.noovle.com  Fri Apr  7 11:10:26 2023
From: alessio.ballarini at ext.noovle.com (Alessio Ballarini (External))
Date: Fri, 7 Apr 2023 13:10:26 +0200
Subject: [squid-users] Squid proxy errors - support
In-Reply-To: <202304071308.02715.Antony.Stone@squid.open.source.it>
References: <CAGC3VAvD54kWyTQAnVwKrOGgtBQtFugNDD80Um68sML4w+N6Gg@mail.gmail.com>
 <202304071308.02715.Antony.Stone@squid.open.source.it>
Message-ID: <CAGC3VAs8djv_o2CjCXu++3HYXUsPjKXOCSexQXOOZicOXvVnHg@mail.gmail.com>

Hi Antony,
thank you so much for the fats response.

The Operating System is:

SUSE Linux Enterprise Server 15 SP3  (x86_64)

The Squid Version is:

Squid Cache: Version 4.17

If you need more information, please let me know.

Kind regards
Alessio

Il giorno ven 7 apr 2023 alle ore 13:08 Antony Stone <
Antony.Stone at squid.open.source.it> ha scritto:

> On Friday 07 April 2023 at 13:00:09, Alessio Ballarini (External) wrote:
>
> > Hi Squid Support,
> > we are facing a problem with Squid proxy
>
> Which version of Squid, and running on which version of which operating
> system?
>
>
> Antony.
>
> --
> Normal people think "If it ain't broke, don't fix it".
> Engineers think "If it ain't broke, it doesn't have enough features yet".
>
>                                                    Please reply to the
> list;
>                                                          please *don't* CC
> me.
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users
>


-- 

_________________________________________
[image: Noovle S.p.A.] <https://noovle.com/it>
*Alessio Ballarini (External)*
DC.O.APS

*Noovle S.p.A.*
Via Gaetano Negri 1 - 20123 Milano (MI)
+393488654039
*Twitter* <https://twitter.com/Noovle_SpA> - *Linkedin*
<https://www.linkedin.com/company/noovle/>
*www.noovle.com* <https://www.noovle.com/it/>

-- 
_INFORMATIVA SULLA PRIVACY E SULLA CONFIDENZIALITA': Ai sensi del Reg. UE 
n.2016/679 sulla tutela della privacy, Vi informiamo che il presente 
messaggio e-mail potrebbe contenere informazioni riservate e/o fondate su 
privilegio legale, oltre a dati personali. Vi informiamo che deteniamo e 
trattiamo i dati contenuti nella presente per i soli scopi di adempiere ad 
obblighi di legge e/o contrattuali e/o per la tutela di nostri legittimi 
interessi. La conoscenza di questi dati ? riservata ai soli destinatari di 
questa e-mail. Al di fuori degli scopi sopra descritti, tali dati non 
saranno da noi rivelati in alcun modo a terzi, senza il previo consenso 
scritto degli interessati coinvolti, ove prescritto e/o necessario ai sensi 
della legge applicabile.?_Qualora Voi non siate gli effettivi destinatari 
della presente e-mail, Vi informiamo che ne sono severamente proibite la 
diffusione, la copia e/o la distribuzione.?_Nel caso aveste ricevuto il 
presente messaggio per errore Vi preghiamo, pertanto, di informarci 
immediatamente e di eliminarlo dal vostro computer. Grazie.___
_
_
_PRIVACY 
AND CONFIDENTIALITY NOTICE: Pursuant to EU Regulation no.679/2016 on 
privacy protection, we inform You that his e-mail message might contain 
confidential and/or legally privileged information as well as personal 
data. We inform You that we hold and process all data contained therein for 
the sole purposes of meeting legal and/or contractual obligation(s) and/or 
for our legitimate interest. Knowledge of these data is reserved solely to 
the person(s) to whom this e-mail is addressed. Outside the scopes 
described above, these data will not be disclosed by us in any way to third 
parties without the prior written consent of the relevant data subject(s), 
where prescribed and/or deemed necessary by applicable law(s).?_If You are 
not the intended recipient, You are hereby notified that any disclosure, 
copying and/or distribution of the contents of this e-mail message is 
strictly prohibited.?_If You have received this communication in error, 
therefore, please delete it immediately and contact us to let us know it. 
Thank you._


____
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230407/a263ed1d/attachment.htm>

From joost at antarean.org  Fri Apr  7 13:44:57 2023
From: joost at antarean.org (Joost Roeleveld)
Date: Fri, 07 Apr 2023 13:44:57 +0000
Subject: [squid-users] Squid proxy errors - support
In-Reply-To: <202304071308.02715.Antony.Stone@squid.open.source.it>
References: <CAGC3VAvD54kWyTQAnVwKrOGgtBQtFugNDD80Um68sML4w+N6Gg@mail.gmail.com>
 <202304071308.02715.Antony.Stone@squid.open.source.it>
Message-ID: <20230407134457.EGroupware.TIWgqQEptmUMMa1qdniI4HM@_>

Hi Alessio,
The config file provided is incomplete. I don't see any definition of  
"localnet"
Also, how are the connections through the proxy configured? Is this  
done by configuring the client (SAP in this case) or is the firewall  
forcing the connection through the proxy and the client is unaware?
If unaware, you will need to configure a "https_port" and use that for  
https-connections.
--
Joost
  original message
From: "Alessio Ballarini (External)" <alessio.ballarini at ext.noovle.com >
To: Antony Stone <Antony.Stone at squid.open.source.it >
Cc: "ManagedServices_Unix" <managedservices_unix at noovle.com >,  
squid-users at lists.squid-cache.org
Date: Fri, 07 Apr 2023 13:10:26 +0200
----------------------------------------------------------------

>
>
> Hi Antony, thank you so much for the fats response.
>
> The Operating System is:
>
> SUSE Linux Enterprise Server 15 SP3 (x86_64)
>
> The Squid Version is:
>
> Squid Cache: Version 4.17
>
> If you need more information, please let me know.
>
> Kind regards
> Alessio
>
> Il giorno ven 7 apr 2023 alle ore 13:08 Antony Stone  
> <mailto:Antony.Stone at squid.open.source.it ha scritto:
>> On Friday 07 April 2023 at 13:00:09, Alessio Ballarini (External) wrote:
>>
>>> Hi Squid Support,
>>> we are facing a problem with Squid proxy
>>
>> Which version of Squid, and running on which version of which  
>> operating system?
>>
>> Antony.
>>
>> -- 
>> Normal people think "If it ain't broke, don't fix it".
>> Engineers think "If it ain't broke, it doesn't have enough features yet".
>>
>> Please reply to the list;
>> please *don't* CC me.
>> _______________________________________________
>> squid-users mailing list
>> mailto:squid-users at lists.squid-cache.org  
>> http://lists.squid-cache.org/listinfo/squid-users
>
>
> -- 
>
> _________________________________________ [ https://noovle.com/it ->  
> ] Alessio Ballarini (External) DC.O.APS Noovle S.p.A. Via Gaetano  
> Negri 1 - 20123 Milano (MI) +393488654039 [  
> https://twitter.com/Noovle_SpA -> Twitter ] - [  
> https://www.linkedin.com/company/noovle/ -> Linkedin ]
> [ https://www.noovle.com/it/ -> www.noovle.com ] INFORMATIVA SULLA  
> PRIVACY E SULLA CONFIDENZIALITA': Ai sensi del Reg. UE n.2016/679  
> sulla tutela della privacy, Vi informiamo che il presente messaggio  
> e-mail potrebbe contenere informazioni riservate e/o fondate su  
> privilegio legale, oltre a dati personali. Vi informiamo che  
> deteniamo e trattiamo i dati contenuti nella presente per i soli  
> scopi di adempiere ad obblighi di legge e/o contrattuali e/o per la  
> tutela di nostri legittimi interessi. La conoscenza di questi dati ?  
> riservata ai soli destinatari di questa e-mail. Al di fuori degli  
> scopi sopra descritti, tali dati non saranno da noi rivelati in  
> alcun modo a terzi, senza il previo consenso scritto degli  
> interessati coinvolti, ove prescritto e/o necessario ai sensi della  
> legge applicabile. Qualora Voi non siate gli effettivi destinatari  
> della presente e-mail, Vi informiamo che ne sono severamente  
> proibite la diffusione, la copia e/o la distribuzione. Nel caso  
> aveste ricevuto il presente messaggio per errore Vi preghiamo,  
> pertanto, di informarci immediatamente e di eliminarlo dal vostro  
> computer. Grazie.
> PRIVACY AND CONFIDENTIALITY NOTICE: Pursuant to EU Regulation  
> no.679/2016 on privacy protection, we inform You that his e-mail  
> message might contain confidential and/or legally privileged  
> information as well as personal data. We inform You that we hold and  
> process all data contained therein for the sole purposes of meeting  
> legal and/or contractual obligation(s) and/or for our legitimate  
> interest. Knowledge of these data is reserved solely to the  
> person(s) to whom this e-mail is addressed. Outside the scopes  
> described above, these data will not be disclosed by us in any way  
> to third parties without the prior written consent of the relevant  
> data subject(s), where prescribed and/or deemed necessary by  
> applicable law(s). If You are not the intended recipient, You are  
> hereby notified that any disclosure, copying and/or distribution of  
> the contents of this e-mail message is strictly prohibited. If You  
> have received this communication in error, therefore, please delete  
> it immediately and contact us to let us know it. Thank you.
>
>



-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230407/8cc59b56/attachment.htm>

From alessio.ballarini at ext.noovle.com  Fri Apr  7 14:07:15 2023
From: alessio.ballarini at ext.noovle.com (Alessio Ballarini (External))
Date: Fri, 7 Apr 2023 16:07:15 +0200
Subject: [squid-users] Squid proxy errors - support
In-Reply-To: <20230407134457.EGroupware.TIWgqQEptmUMMa1qdniI4HM@_>
References: <CAGC3VAvD54kWyTQAnVwKrOGgtBQtFugNDD80Um68sML4w+N6Gg@mail.gmail.com>
 <202304071308.02715.Antony.Stone@squid.open.source.it>
 <20230407134457.EGroupware.TIWgqQEptmUMMa1qdniI4HM@_>
Message-ID: <CAGC3VAvsOxR=+YzdGx6BQr_Fc_HpN8tVbKMR9shyf+nz9-A5mA@mail.gmail.com>

Hi Joost,
thank you so much for your help.

I am going to try to edit these configuration.

I would like to ask you to delete the thread we created from the archive :

[image: image.png]


Is it possible ?

Thanks
Alessio

Il giorno ven 7 apr 2023 alle ore 15:45 Joost Roeleveld <joost at antarean.org>
ha scritto:

> Hi Alessio,
>
> The config file provided is incomplete. I don't see any definition of
> "localnet"
>
> Also, how are the connections through the proxy configured? Is this done
> by configuring the client (SAP in this case) or is the firewall forcing the
> connection through the proxy and the client is unaware?
>
> If unaware, you will need to configure a "https_port" and use that for
> https-connections.
>
> --
>
> Joost
> original message From: "Alessio Ballarini (External)" <
> alessio.ballarini at ext.noovle.com>
> To: Antony Stone <Antony.Stone at squid.open.source.it>
> Cc: "ManagedServices_Unix" <managedservices_unix at noovle.com>,
> squid-users at lists.squid-cache.org
> Date: Fri, 07 Apr 2023 13:10:26 +0200
>
>
> Hi Antony,
> thank you so much for the fats response.
>
> The Operating System is:
>
> SUSE Linux Enterprise Server 15 SP3  (x86_64)
>
> The Squid Version is:
>
> Squid Cache: Version 4.17
>
> If you need more information, please let me know.
>
> Kind regards
> Alessio
>
> Il giorno ven 7 apr 2023 alle ore 13:08 Antony Stone <
> Antony.Stone at squid.open.source.it> ha scritto:
>
>> On Friday 07 April 2023 at 13:00:09, Alessio Ballarini (External) wrote:
>>
>> > Hi Squid Support,
>> > we are facing a problem with Squid proxy
>>
>> Which version of Squid, and running on which version of which operating
>> system?
>>
>>
>> Antony.
>>
>> --
>> Normal people think "If it ain't broke, don't fix it".
>> Engineers think "If it ain't broke, it doesn't have enough features yet".
>>
>>                                                    Please reply to the
>> list;
>>                                                          please *don't*
>> CC me.
>> _______________________________________________
>> squid-users mailing list
>> squid-users at lists.squid-cache.org
>> http://lists.squid-cache.org/listinfo/squid-users
>
>
>
> --
>
> _________________________________________
> [image: Noovle S.p.A. [blocked external
> image:https://workspace.internal.noovle.com/assets/noovlespa_logo_small-RGB.png]]
> <https://noovle.com/it>
> *Alessio Ballarini (External)*
> DC.O.APS
>
> *Noovle S.p.A.*
> Via Gaetano Negri 1 - 20123 Milano (MI)
> +393488654039
> *Twitter* <https://twitter.com/Noovle_SpA> - *Linkedin*
> <https://www.linkedin.com/company/noovle/>
> *www.noovle.com* <https://www.noovle.com/it/>
>
> *INFORMATIVA SULLA PRIVACY E SULLA CONFIDENZIALITA': Ai sensi del Reg. UE
> n.2016/679 sulla tutela della privacy, Vi informiamo che il presente
> messaggio e-mail potrebbe contenere informazioni riservate e/o fondate su
> privilegio legale, oltre a dati personali. Vi informiamo che deteniamo e
> trattiamo i dati contenuti nella presente per i soli scopi di adempiere ad
> obblighi di legge e/o contrattuali e/o per la tutela di nostri legittimi
> interessi. La conoscenza di questi dati ? riservata ai soli destinatari di
> questa e-mail. Al di fuori degli scopi sopra descritti, tali dati non
> saranno da noi rivelati in alcun modo a terzi, senza il previo consenso
> scritto degli interessati coinvolti, ove prescritto e/o necessario ai sensi
> della legge applicabile. **Qualora Voi non siate gli effettivi
> destinatari della presente e-mail, Vi informiamo che ne sono severamente
> proibite la diffusione, la copia e/o la distribuzione. **Nel caso aveste
> ricevuto il presente messaggio per errore Vi preghiamo, pertanto, di
> informarci immediatamente e di eliminarlo dal vostro computer. Grazie.*
>
> *PRIVACY AND CONFIDENTIALITY NOTICE: Pursuant to EU Regulation no.679/2016
> on privacy protection, we inform You that his e-mail message might contain
> confidential and/or legally privileged information as well as personal
> data. We inform You that we hold and process all data contained therein for
> the sole purposes of meeting legal and/or contractual obligation(s) and/or
> for our legitimate interest. Knowledge of these data is reserved solely to
> the person(s) to whom this e-mail is addressed. Outside the scopes
> described above, these data will not be disclosed by us in any way to third
> parties without the prior written consent of the relevant data subject(s),
> where prescribed and/or deemed necessary by applicable law(s). **If You
> are not the intended recipient, You are hereby notified that any
> disclosure, copying and/or distribution of the contents of this e-mail
> message is strictly prohibited. **If You have received this communication
> in error, therefore, please delete it immediately and contact us to let us
> know it. Thank you.*
>
>
>
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users
>


-- 

_________________________________________
[image: Noovle S.p.A.] <https://noovle.com/it>
*Alessio Ballarini (External)*
DC.O.APS

*Noovle S.p.A.*
Via Gaetano Negri 1 - 20123 Milano (MI)
+393488654039
*Twitter* <https://twitter.com/Noovle_SpA> - *Linkedin*
<https://www.linkedin.com/company/noovle/>
*www.noovle.com* <https://www.noovle.com/it/>

-- 
_INFORMATIVA SULLA PRIVACY E SULLA CONFIDENZIALITA': Ai sensi del Reg. UE 
n.2016/679 sulla tutela della privacy, Vi informiamo che il presente 
messaggio e-mail potrebbe contenere informazioni riservate e/o fondate su 
privilegio legale, oltre a dati personali. Vi informiamo che deteniamo e 
trattiamo i dati contenuti nella presente per i soli scopi di adempiere ad 
obblighi di legge e/o contrattuali e/o per la tutela di nostri legittimi 
interessi. La conoscenza di questi dati ? riservata ai soli destinatari di 
questa e-mail. Al di fuori degli scopi sopra descritti, tali dati non 
saranno da noi rivelati in alcun modo a terzi, senza il previo consenso 
scritto degli interessati coinvolti, ove prescritto e/o necessario ai sensi 
della legge applicabile.?_Qualora Voi non siate gli effettivi destinatari 
della presente e-mail, Vi informiamo che ne sono severamente proibite la 
diffusione, la copia e/o la distribuzione.?_Nel caso aveste ricevuto il 
presente messaggio per errore Vi preghiamo, pertanto, di informarci 
immediatamente e di eliminarlo dal vostro computer. Grazie.___
_
_
_PRIVACY 
AND CONFIDENTIALITY NOTICE: Pursuant to EU Regulation no.679/2016 on 
privacy protection, we inform You that his e-mail message might contain 
confidential and/or legally privileged information as well as personal 
data. We inform You that we hold and process all data contained therein for 
the sole purposes of meeting legal and/or contractual obligation(s) and/or 
for our legitimate interest. Knowledge of these data is reserved solely to 
the person(s) to whom this e-mail is addressed. Outside the scopes 
described above, these data will not be disclosed by us in any way to third 
parties without the prior written consent of the relevant data subject(s), 
where prescribed and/or deemed necessary by applicable law(s).?_If You are 
not the intended recipient, You are hereby notified that any disclosure, 
copying and/or distribution of the contents of this e-mail message is 
strictly prohibited.?_If You have received this communication in error, 
therefore, please delete it immediately and contact us to let us know it. 
Thank you._


____
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230407/6f1140a4/attachment.htm>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: image.png
Type: image/png
Size: 14219 bytes
Desc: not available
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230407/6f1140a4/attachment.png>

From rousskov at measurement-factory.com  Fri Apr  7 14:07:45 2023
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Fri, 7 Apr 2023 10:07:45 -0400
Subject: [squid-users] SQUID PROXY ERRORS - SUPPORT
In-Reply-To: <CAGC3VAvD54kWyTQAnVwKrOGgtBQtFugNDD80Um68sML4w+N6Gg@mail.gmail.com>
References: <CAGC3VAvD54kWyTQAnVwKrOGgtBQtFugNDD80Um68sML4w+N6Gg@mail.gmail.com>
Message-ID: <1f9ec1d9-b6bb-a477-cd50-b156f8a1feee@measurement-factory.com>

On 4/7/23 07:00, Alessio Ballarini (External) wrote:

> - The TCP connections work inconsistently: sometimes they work (200) and 
> sometimes they do not (503).

> Specifically in the access.log of the Squid we registered these 503 erros:
> 
> 1680672739.134 59768 172.29.7.148 NONE/503 0 CONNECT 195.75.144.10:22 - HIER_NONE/- -
> 1680681044.960 60450 172.29.7.148 NONE/503 0 CONNECT appbpe.pellegrinicard.it:443 - HIER_NONE/- -

> We tried to debug the log of the squid, and we found that this error is 
> a "generic" application error that could depend on several factors.

Your conclusion is essentially correct -- many things may trigger an 
HTTP 503 error. To know what causes these particular errors (without 
guessing), one needs more information.

In modern Squids, using a custom logformat directive to log 
%err_code/%err_detail may help detail the error further in some cases. 
In all Squids, looking at the Squid error response itself (including its 
HTTP headers) may help detail the error further. You may want to share 
those details with the list.

Alternatively, if you can reproduce the error fairly easily, analyzing 
cache.log with debug_options set to ALL,9 can often determine the cause. 
If you go this route, please do not post huge logs to the list, but 
share a link to a compressed cache.log file instead. More hints at
https://wiki.squid-cache.org/SquidFaq/BugReporting#debugging-a-single-transaction


HTH,

Alex.



From 0xff1f at gmail.com  Sat Apr  8 16:40:02 2023
From: 0xff1f at gmail.com (Dr.X)
Date: Sat, 8 Apr 2023 16:40:02 +0000
Subject: [squid-users] Is there any squid 4.x tested with Delay pools to
 work and limit well ?
Message-ID: <DBBPR09MB4523DDEC4878F0C233655EDFF7979@DBBPR09MB4523.eurprd09.prod.outlook.com>

Hello Team,

I hope everyone is doing well.

I was wondering if you have a Squid 4.x version that supports delay pools and is not buggy. I asked Alex, the developer, and he informed me that none of the 4.x versions support it. I also reached out to Amos but haven't received a response yet.

Since it has been a while, I wanted to ask again if there is any chance that there is a Squid 4.x version available that supports Delay pools?

Thank you.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230408/c5745751/attachment.htm>

From dave at killthe.net  Sat Apr  8 19:35:56 2023
From: dave at killthe.net (Dave Blanchard)
Date: Sat, 8 Apr 2023 14:35:56 -0500
Subject: [squid-users] Is there any squid 4.x tested with Delay pools to
 work and limit well ?
In-Reply-To: <DBBPR09MB4523DDEC4878F0C233655EDFF7979@DBBPR09MB4523.eurprd09.prod.outlook.com>
References: <DBBPR09MB4523DDEC4878F0C233655EDFF7979@DBBPR09MB4523.eurprd09.prod.outlook.com>
Message-ID: <20230408143556.66755d4fdc0b0d633ab9d415@killthe.net>

On Sat, 8 Apr 2023 16:40:02 +0000
Dr.X <0xff1f at gmail.com> wrote:

> I was wondering if you have a Squid 4.x version that supports delay pools and is not buggy. I asked Alex, the developer, and he informed me that none of the 4.x versions support it. I also reached out to Amos but haven't received a response yet.
> 
> Since it has been a while, I wanted to ask again if there is any chance that there is a Squid 4.x version available that supports Delay pools?

I'm interested in this also, as I've just tried setting up delay pools on 5.4 and so far haven't managed to make it work as expected. 

-- 
Dave Blanchard <dave at killthe.net>


From 0xff1f at gmail.com  Sat Apr  8 20:48:50 2023
From: 0xff1f at gmail.com (Dr.X)
Date: Sat, 8 Apr 2023 20:48:50 +0000
Subject: [squid-users] Is there any squid 4.x tested with Delay pools to
 work and limit well ?
In-Reply-To: <20230408143556.66755d4fdc0b0d633ab9d415@killthe.net>
References: <DBBPR09MB4523DDEC4878F0C233655EDFF7979@DBBPR09MB4523.eurprd09.prod.outlook.com>
 <20230408143556.66755d4fdc0b0d633ab9d415@killthe.net>
Message-ID: <DBBPR09MB4523079E054C839E4D2BFE3EF7979@DBBPR09MB4523.eurprd09.prod.outlook.com>

I'm putting @Amos Jeffries<mailto:squid3 at treenet.co.nz> in CC.

From: squid-users <squid-users-bounces at lists.squid-cache.org> on behalf of Dave Blanchard <dave at killthe.net>
Date: Saturday, 8 April 2023 22:34
To: squid-users at lists.squid-cache.org <squid-users at lists.squid-cache.org>
Subject: Re: [squid-users] Is there any squid 4.x tested with Delay pools to work and limit well ?
On Sat, 8 Apr 2023 16:40:02 +0000
Dr.X <0xff1f at gmail.com> wrote:

> I was wondering if you have a Squid 4.x version that supports delay pools and is not buggy. I asked Alex, the developer, and he informed me that none of the 4.x versions support it. I also reached out to Amos but haven't received a response yet.
>
> Since it has been a while, I wanted to ask again if there is any chance that there is a Squid 4.x version available that supports Delay pools?

I'm interested in this also, as I've just tried setting up delay pools on 5.4 and so far haven't managed to make it work as expected.

--
Dave Blanchard <dave at killthe.net>
_______________________________________________
squid-users mailing list
squid-users at lists.squid-cache.org
http://lists.squid-cache.org/listinfo/squid-users
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230408/e3e017b5/attachment.htm>

From rousskov at measurement-factory.com  Mon Apr 10 01:31:14 2023
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Sun, 9 Apr 2023 21:31:14 -0400
Subject: [squid-users] Is there any squid 4.x tested with Delay pools to
 work and limit well ?
In-Reply-To: <20230408143556.66755d4fdc0b0d633ab9d415@killthe.net>
References: <DBBPR09MB4523DDEC4878F0C233655EDFF7979@DBBPR09MB4523.eurprd09.prod.outlook.com>
 <20230408143556.66755d4fdc0b0d633ab9d415@killthe.net>
Message-ID: <7052990e-08cc-aebc-3ad1-1d7c911e37ce@measurement-factory.com>

On 4/8/23 15:35, Dave Blanchard wrote:
> On Sat, 8 Apr 2023 16:40:02 +0000
> Dr.X <0xff1f at gmail.com> wrote:

>> I was wondering if you have a Squid 4.x version that supports delay
>> pools and is not buggy. I asked Alex, the developer, and he
>> informed me that none of the 4.x versions support it. I also
>> reached out to Amos but haven't received a response yet.


> I'm interested in this also, as I've just tried setting up delay
> pools on 5.4 and so far haven't managed to make it work as expected.


I would like to clarify delay pools support status, again: For some 
traffic, some delay pools configurations are probably working OK in 
Squid v4+. The Squid bug Dr.X has been referring to above (and in other 
recent squid-user emails) is Bug 4913 (Delay Pools don't work for 
Tunneled traffic):

* https://bugs.squid-cache.org/show_bug.cgi?id=4913

* http://lists.squid-cache.org/pipermail/squid-users/2022-June/024922.html

* http://lists.squid-cache.org/pipermail/squid-users/2023-April/025725.html


HTH,

Alex.



From andre.bolinhas at articatech.com  Mon Apr 10 21:14:42 2023
From: andre.bolinhas at articatech.com (andre.bolinhas at articatech.com)
Date: Mon, 10 Apr 2023 22:14:42 +0100
Subject: [squid-users] idnsSendQuery: Can't send query, no DNS socket!
Message-ID: <!&!AAAAAAAAAAAuAAAAAAAAAIVNjRjcTGZElYgADq7oyvYBAMO2jhD3dRHOtM0AqgC7tuYAAAAAAA4AABAAAADmlE4679IMTIhoBT3ictBTAQAAAAA=@articatech.com>

Hi all

We have experienced some issue on our squid servers, time to times the
listen port fails and users are unable to connected to the proxy.
We already try use squid 4.17 and squid 5.8 but had the same issue on both
version, you can find I GDrive the extract of the cache.log on the time of
the failure.

https://drive.google.com/file/d/1gZ-ITgH4PUOr7FuKaEr3qKRn-_4duspK/view?usp=s
haring

On the cache log I see to many
idnsSendQuery: Can't send query, no DNS socket!
And
2023/04/10 16:25:59 kid4| Waiting 10 seconds for active connections to
finish
2023/04/10 16:25:59 kid4| Preparing for shutdown after 763 requests

This is the dns configuration squid/dns.conf
# Return DNS used by the system (means resolv.conf)
client_dst_passthru off
host_verify_strict off
ignore_unknown_nameservers off
dns_retransmit_interval 3 seconds
dns_v4_first on
ipcache_size 16384
ipcache_low 90
ipcache_high 95
fqdncache_size 1024
positive_dns_ttl 6 hours
negative_dns_ttl 300 seconds

Resolv.conf
domain xyz.my
search xyz.my
options attempts:2 timeout:2
nameserver 127.0.0.1
nameserver 8.8.8.8
nameserver 1.1.1.1

127.0.0.1 is the unbound internal DNS.




From 0xff1f at gmail.com  Mon Apr 10 22:41:49 2023
From: 0xff1f at gmail.com (Dr.X)
Date: Mon, 10 Apr 2023 22:41:49 +0000
Subject: [squid-users] Is there any squid 4.x tested with Delay pools to
 work and limit well ?
In-Reply-To: <7052990e-08cc-aebc-3ad1-1d7c911e37ce@measurement-factory.com>
References: <DBBPR09MB4523DDEC4878F0C233655EDFF7979@DBBPR09MB4523.eurprd09.prod.outlook.com>
 <20230408143556.66755d4fdc0b0d633ab9d415@killthe.net>
 <7052990e-08cc-aebc-3ad1-1d7c911e37ce@measurement-factory.com>
Message-ID: <DBBPR09MB45233EC844433A4EE184239DF7959@DBBPR09MB4523.eurprd09.prod.outlook.com>

Hi Alex , it seems we have bad news . FYI , 3.x is working fine  .

So do you think we will have squid 4.x to be fixed soon or latter ?


Best ,


From: Alex Rousskov <rousskov at measurement-factory.com>
Date: Monday, 10 April 2023 04:31
To: squid-users at lists.squid-cache.org <squid-users at lists.squid-cache.org>
Cc: Dr.X <0xff1f at gmail.com>, Dave Blanchard <dave at killthe.net>
Subject: Re: [squid-users] Is there any squid 4.x tested with Delay pools to work and limit well ?
On 4/8/23 15:35, Dave Blanchard wrote:
> On Sat, 8 Apr 2023 16:40:02 +0000
> Dr.X <0xff1f at gmail.com> wrote:

>> I was wondering if you have a Squid 4.x version that supports delay
>> pools and is not buggy. I asked Alex, the developer, and he
>> informed me that none of the 4.x versions support it. I also
>> reached out to Amos but haven't received a response yet.


> I'm interested in this also, as I've just tried setting up delay
> pools on 5.4 and so far haven't managed to make it work as expected.


I would like to clarify delay pools support status, again: For some
traffic, some delay pools configurations are probably working OK in
Squid v4+. The Squid bug Dr.X has been referring to above (and in other
recent squid-user emails) is Bug 4913 (Delay Pools don't work for
Tunneled traffic):

* https://bugs.squid-cache.org/show_bug.cgi?id=4913

* http://lists.squid-cache.org/pipermail/squid-users/2022-June/024922.html

* http://lists.squid-cache.org/pipermail/squid-users/2023-April/025725.html


HTH,

Alex.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230410/5456cadd/attachment.htm>

From rousskov at measurement-factory.com  Tue Apr 11 00:21:55 2023
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Mon, 10 Apr 2023 20:21:55 -0400
Subject: [squid-users] idnsSendQuery: Can't send query, no DNS socket!
In-Reply-To: <!&!AAAAAAAAAAAuAAAAAAAAAIVNjRjcTGZElYgADq7oyvYBAMO2jhD3dRHOtM0AqgC7tuYAAAAAAA4AABAAAADmlE4679IMTIhoBT3ictBTAQAAAAA=@articatech.com>
References: <!&!AAAAAAAAAAAuAAAAAAAAAIVNjRjcTGZElYgADq7oyvYBAMO2jhD3dRHOtM0AqgC7tuYAAAAAAA4AABAAAADmlE4679IMTIhoBT3ictBTAQAAAAA=@articatech.com>
Message-ID: <532b95ee-a687-bf03-7a25-7374f0bd4892@measurement-factory.com>

On 4/10/23 17:14, andre.bolinhas at articatech.com wrote:

> We have experienced some issue on our squid servers, time to times the
> listen port fails and users are unable to connected to the proxy.
> We already try use squid 4.17 and squid 5.8 but had the same issue on both
> version, you can find I GDrive the extract of the cache.log on the time of
> the failure.


> 2023/04/10 16:25:54 kid2| Starting Squid Cache version 4.17 for x86_64-pc-linux-gnu...
> 2023/04/10 16:26:00 kid2| Shutting down...
> 2023/04/10 16:26:00 kid2| Squid Cache (Version 4.17): Exiting normally.
> 2023/04/10 16:26:03 kid2| Starting Squid Cache version 4.17 for x86_64-pc-linux-gnu...
> 2023/04/10 16:26:15 kid2| Shutting down...
> 2023/04/10 16:26:15 kid2| Squid Cache (Version 4.17): Exiting normally.
> 2023/04/10 16:26:18 kid2| Starting Squid Cache version 4.17 for x86_64-pc-linux-gnu...

Are you starting and shutting down your Squids at a very high frequency? 
FWIW, older Squids, possibly including Squid v4, are not very good at 
handling this kind of exercise.


> 2023/04/10 16:23:19 kid2| Preparing for shutdown after 221344 requests
> 2023/04/10 16:23:19 kid2| Preparing for shutdown after 221344 requests
> 2023/04/10 16:23:19 kid2| Preparing for shutdown after 221344 requests
> 2023/04/10 16:23:19 kid2| Preparing for shutdown after 221344 requests
> 2023/04/10 16:23:19 kid2| Preparing for shutdown after 221344 requests

This Squid appears to be seriously confused, stuck in some kind of a 
shutdown loop. Do you see similar repeated same-kid same-request-count 
"Preparing for shutdown" messages with Squid v5+?


> On the cache log I see to many
> idnsSendQuery: Can't send query, no DNS socket!

IIRC, at a certain shutdown stage, Squid closes DNS sockets. That 
prevents Squid from sending DNS queries. I do not know if that shutdown 
aspect has improved since v4. However, I would be a lot more worried 
about frequent restarts and shutdown loops(?) at this point. Something 
unusual and probably bad is going on...


HTH,

Alex.



> And
> 2023/04/10 16:25:59 kid4| Waiting 10 seconds for active connections to
> finish
> 2023/04/10 16:25:59 kid4| Preparing for shutdown after 763 requests
> 
> This is the dns configuration squid/dns.conf
> # Return DNS used by the system (means resolv.conf)
> client_dst_passthru off
> host_verify_strict off
> ignore_unknown_nameservers off
> dns_retransmit_interval 3 seconds
> dns_v4_first on
> ipcache_size 16384
> ipcache_low 90
> ipcache_high 95
> fqdncache_size 1024
> positive_dns_ttl 6 hours
> negative_dns_ttl 300 seconds
> 
> Resolv.conf
> domain xyz.my
> search xyz.my
> options attempts:2 timeout:2
> nameserver 127.0.0.1
> nameserver 8.8.8.8
> nameserver 1.1.1.1
> 
> 127.0.0.1 is the unbound internal DNS.
> 
> 
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users



From rousskov at measurement-factory.com  Tue Apr 11 00:24:27 2023
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Mon, 10 Apr 2023 20:24:27 -0400
Subject: [squid-users] Is there any squid 4.x tested with Delay pools to
 work and limit well ?
In-Reply-To: <DBBPR09MB45233EC844433A4EE184239DF7959@DBBPR09MB4523.eurprd09.prod.outlook.com>
References: <DBBPR09MB4523DDEC4878F0C233655EDFF7979@DBBPR09MB4523.eurprd09.prod.outlook.com>
 <20230408143556.66755d4fdc0b0d633ab9d415@killthe.net>
 <7052990e-08cc-aebc-3ad1-1d7c911e37ce@measurement-factory.com>
 <DBBPR09MB45233EC844433A4EE184239DF7959@DBBPR09MB4523.eurprd09.prod.outlook.com>
Message-ID: <2d597901-a490-1e60-951d-e82e729dc15a@measurement-factory.com>

On 4/10/23 18:41, Dr.X wrote:

> So do you think we will have squid 4.x to be fixed soon or latter ?

Squid v4 receives very little attention these days. FWIW, I am not aware 
of anybody working on Bug 4913 (Delay Pools don't work for Tunneled 
traffic) right now (for any Squid version).

https://wiki.squid-cache.org/SquidFaq/AboutSquid#how-to-add-a-new-squid-feature-enhance-of-fix-something

Alex.



> *From: *Alex Rousskov <rousskov at measurement-factory.com>
> *Date: *Monday, 10 April 2023 04:31
> *To: *squid-users at lists.squid-cache.org <squid-users at lists.squid-cache.org>
> *Cc: *Dr.X <0xff1f at gmail.com>, Dave Blanchard <dave at killthe.net>
> *Subject: *Re: [squid-users] Is there any squid 4.x tested with Delay 
> pools to work and limit well ?
> 
> On 4/8/23 15:35, Dave Blanchard wrote:
>> On Sat, 8 Apr 2023 16:40:02 +0000
>> Dr.X <0xff1f at gmail.com> wrote:
> 
>>> I was wondering if you have a Squid 4.x version that supports delay
>>> pools and is not buggy. I asked Alex, the developer, and he
>>> informed me that none of the 4.x versions support it. I also
>>> reached out to Amos but haven't received a response yet.
> 
> 
>> I'm interested in this also, as I've just tried setting up delay
>> pools on 5.4 and so far haven't managed to make it work as expected.
> 
> 
> I would like to clarify delay pools support status, again: For some
> traffic, some delay pools configurations are probably working OK in
> Squid v4+. The Squid bug Dr.X has been referring to above (and in other
> recent squid-user emails) is Bug 4913 (Delay Pools don't work for
> Tunneled traffic):
> 
> * https://bugs.squid-cache.org/show_bug.cgi?id=4913 
> <https://bugs.squid-cache.org/show_bug.cgi?id=4913>
> 
> * 
> http://lists.squid-cache.org/pipermail/squid-users/2022-June/024922.html 
> <http://lists.squid-cache.org/pipermail/squid-users/2022-June/024922.html>
> 
> * 
> http://lists.squid-cache.org/pipermail/squid-users/2023-April/025725.html <http://lists.squid-cache.org/pipermail/squid-users/2023-April/025725.html>
> 
> 
> HTH,
> 
> Alex.
> 



From 0xff1f at gmail.com  Tue Apr 11 00:42:10 2023
From: 0xff1f at gmail.com (Dr.X)
Date: Tue, 11 Apr 2023 00:42:10 +0000
Subject: [squid-users] Is there any squid 4.x tested with Delay pools to
 work and limit well ?
In-Reply-To: <2d597901-a490-1e60-951d-e82e729dc15a@measurement-factory.com>
References: <DBBPR09MB4523DDEC4878F0C233655EDFF7979@DBBPR09MB4523.eurprd09.prod.outlook.com>
 <20230408143556.66755d4fdc0b0d633ab9d415@killthe.net>
 <7052990e-08cc-aebc-3ad1-1d7c911e37ce@measurement-factory.com>
 <DBBPR09MB45233EC844433A4EE184239DF7959@DBBPR09MB4523.eurprd09.prod.outlook.com>
 <2d597901-a490-1e60-951d-e82e729dc15a@measurement-factory.com>
Message-ID: <DBBPR09MB4523FF691BFFFAD9D528BA92F79A9@DBBPR09MB4523.eurprd09.prod.outlook.com>

Is it solved in squid 6.x ?


From: Alex Rousskov <rousskov at measurement-factory.com>
Date: Tuesday, 11 April 2023 03:24
To: squid-users at lists.squid-cache.org <squid-users at lists.squid-cache.org>
Cc: Dave Blanchard <dave at killthe.net>, Dr.X <0xff1f at gmail.com>
Subject: Re: [squid-users] Is there any squid 4.x tested with Delay pools to work and limit well ?
On 4/10/23 18:41, Dr.X wrote:

> So do you think we will have squid 4.x to be fixed soon or latter ?

Squid v4 receives very little attention these days. FWIW, I am not aware
of anybody working on Bug 4913 (Delay Pools don't work for Tunneled
traffic) right now (for any Squid version).

https://wiki.squid-cache.org/SquidFaq/AboutSquid#how-to-add-a-new-squid-feature-enhance-of-fix-something

Alex.



> *From: *Alex Rousskov <rousskov at measurement-factory.com>
> *Date: *Monday, 10 April 2023 04:31
> *To: *squid-users at lists.squid-cache.org <squid-users at lists.squid-cache.org>
> *Cc: *Dr.X <0xff1f at gmail.com>, Dave Blanchard <dave at killthe.net>
> *Subject: *Re: [squid-users] Is there any squid 4.x tested with Delay
> pools to work and limit well ?
>
> On 4/8/23 15:35, Dave Blanchard wrote:
>> On Sat, 8 Apr 2023 16:40:02 +0000
>> Dr.X <0xff1f at gmail.com> wrote:
>
>>> I was wondering if you have a Squid 4.x version that supports delay
>>> pools and is not buggy. I asked Alex, the developer, and he
>>> informed me that none of the 4.x versions support it. I also
>>> reached out to Amos but haven't received a response yet.
>
>
>> I'm interested in this also, as I've just tried setting up delay
>> pools on 5.4 and so far haven't managed to make it work as expected.
>
>
> I would like to clarify delay pools support status, again: For some
> traffic, some delay pools configurations are probably working OK in
> Squid v4+. The Squid bug Dr.X has been referring to above (and in other
> recent squid-user emails) is Bug 4913 (Delay Pools don't work for
> Tunneled traffic):
>
> * https://bugs.squid-cache.org/show_bug.cgi?id=4913
> <https://bugs.squid-cache.org/show_bug.cgi?id=4913>
>
> *
> http://lists.squid-cache.org/pipermail/squid-users/2022-June/024922.html
> <http://lists.squid-cache.org/pipermail/squid-users/2022-June/024922.html>
>
> *
> http://lists.squid-cache.org/pipermail/squid-users/2023-April/025725.html <http://lists.squid-cache.org/pipermail/squid-users/2023-April/025725.html>
>
>
> HTH,
>
> Alex.
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230411/b57a5b96/attachment.htm>

From rousskov at measurement-factory.com  Tue Apr 11 02:31:55 2023
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Mon, 10 Apr 2023 22:31:55 -0400
Subject: [squid-users] Is there any squid 4.x tested with Delay pools to
 work and limit well ?
In-Reply-To: <DBBPR09MB4523FF691BFFFAD9D528BA92F79A9@DBBPR09MB4523.eurprd09.prod.outlook.com>
References: <DBBPR09MB4523DDEC4878F0C233655EDFF7979@DBBPR09MB4523.eurprd09.prod.outlook.com>
 <20230408143556.66755d4fdc0b0d633ab9d415@killthe.net>
 <7052990e-08cc-aebc-3ad1-1d7c911e37ce@measurement-factory.com>
 <DBBPR09MB45233EC844433A4EE184239DF7959@DBBPR09MB4523.eurprd09.prod.outlook.com>
 <2d597901-a490-1e60-951d-e82e729dc15a@measurement-factory.com>
 <DBBPR09MB4523FF691BFFFAD9D528BA92F79A9@DBBPR09MB4523.eurprd09.prod.outlook.com>
Message-ID: <5c9affea-06f8-fd12-d7a1-5dea5ed889b0@measurement-factory.com>

On 4/10/23 20:42, Dr.X wrote:
> Is it solved in squid 6.x ?

I do not think so. AFAIK, Bug 4913 (Delay Pools don't work for Tunneled
traffic) affects all Squid versions starting with v4 (at least). IIRC, 
there were some code improvements in that area, as side effects of other 
projects, but nobody has worked on an actual fix yet.

Alex.


> *From: *Alex Rousskov <rousskov at measurement-factory.com>
> *Date: *Tuesday, 11 April 2023 03:24
> *To: *squid-users at lists.squid-cache.org <squid-users at lists.squid-cache.org>
> *Cc: *Dave Blanchard <dave at killthe.net>, Dr.X <0xff1f at gmail.com>
> *Subject: *Re: [squid-users] Is there any squid 4.x tested with Delay 
> pools to work and limit well ?
> 
> On 4/10/23 18:41, Dr.X wrote:
> 
>> So do you think we will have squid 4.x to be fixed soon or latter ?
> 
> Squid v4 receives very little attention these days. FWIW, I am not aware
> of anybody working on Bug 4913 (Delay Pools don't work for Tunneled
> traffic) right now (for any Squid version).
> 
> https://wiki.squid-cache.org/SquidFaq/AboutSquid#how-to-add-a-new-squid-feature-enhance-of-fix-something <https://wiki.squid-cache.org/SquidFaq/AboutSquid#how-to-add-a-new-squid-feature-enhance-of-fix-something>
> 
> Alex.
> 
> 
> 
>> *From: *Alex Rousskov <rousskov at measurement-factory.com>
>> *Date: *Monday, 10 April 2023 04:31
>> *To: *squid-users at lists.squid-cache.org <squid-users at lists.squid-cache.org>
>> *Cc: *Dr.X <0xff1f at gmail.com>, Dave Blanchard <dave at killthe.net>
>> *Subject: *Re: [squid-users] Is there any squid 4.x tested with Delay 
>> pools to work and limit well ?
>> 
>> On 4/8/23 15:35, Dave Blanchard wrote:
>>> On Sat, 8 Apr 2023 16:40:02 +0000
>>> Dr.X <0xff1f at gmail.com> wrote:
>> 
>>>> I was wondering if you have a Squid 4.x version that supports delay
>>>> pools and is not buggy. I asked Alex, the developer, and he
>>>> informed me that none of the 4.x versions support it. I also
>>>> reached out to Amos but haven't received a response yet.
>> 
>> 
>>> I'm interested in this also, as I've just tried setting up delay
>>> pools on 5.4 and so far haven't managed to make it work as expected.
>> 
>> 
>> I would like to clarify delay pools support status, again: For some
>> traffic, some delay pools configurations are probably working OK in
>> Squid v4+. The Squid bug Dr.X has been referring to above (and in other
>> recent squid-user emails) is Bug 4913 (Delay Pools don't work for
>> Tunneled traffic):
>> 
>> * https://bugs.squid-cache.org/show_bug.cgi?id=4913 
> <https://bugs.squid-cache.org/show_bug.cgi?id=4913>
>> <https://bugs.squid-cache.org/show_bug.cgi?id=4913 
> <https://bugs.squid-cache.org/show_bug.cgi?id=4913>>
>> 
>> * 
>> http://lists.squid-cache.org/pipermail/squid-users/2022-June/024922.html 
> <http://lists.squid-cache.org/pipermail/squid-users/2022-June/024922.html>
>> <http://lists.squid-cache.org/pipermail/squid-users/2022-June/024922.html 
> <http://lists.squid-cache.org/pipermail/squid-users/2022-June/024922.html>>
>> 
>> * 
>> http://lists.squid-cache.org/pipermail/squid-users/2023-April/025725.html <http://lists.squid-cache.org/pipermail/squid-users/2023-April/025725.html> <http://lists.squid-cache.org/pipermail/squid-users/2023-April/025725.html <http://lists.squid-cache.org/pipermail/squid-users/2023-April/025725.html>>
>> 
>> 
>> HTH,
>> 
>> Alex.
>> 
> 



From 0xff1f at gmail.com  Tue Apr 11 02:33:04 2023
From: 0xff1f at gmail.com (Dr.X)
Date: Tue, 11 Apr 2023 02:33:04 +0000
Subject: [squid-users] Is there any squid 4.x tested with Delay pools to
 work and limit well ?
In-Reply-To: <5c9affea-06f8-fd12-d7a1-5dea5ed889b0@measurement-factory.com>
References: <DBBPR09MB4523DDEC4878F0C233655EDFF7979@DBBPR09MB4523.eurprd09.prod.outlook.com>
 <20230408143556.66755d4fdc0b0d633ab9d415@killthe.net>
 <7052990e-08cc-aebc-3ad1-1d7c911e37ce@measurement-factory.com>
 <DBBPR09MB45233EC844433A4EE184239DF7959@DBBPR09MB4523.eurprd09.prod.outlook.com>
 <2d597901-a490-1e60-951d-e82e729dc15a@measurement-factory.com>
 <DBBPR09MB4523FF691BFFFAD9D528BA92F79A9@DBBPR09MB4523.eurprd09.prod.outlook.com>
 <5c9affea-06f8-fd12-d7a1-5dea5ed889b0@measurement-factory.com>
Message-ID: <DBBPR09MB452394080F36AA97A0DD95CAF79A9@DBBPR09MB4523.eurprd09.prod.outlook.com>

Ok nice , we will stick with squid 3.x then ?

Thanks


From: Alex Rousskov <rousskov at measurement-factory.com>
Date: Tuesday, 11 April 2023 05:31
To: squid-users at lists.squid-cache.org <squid-users at lists.squid-cache.org>
Cc: Dave Blanchard <dave at killthe.net>, Dr.X <0xff1f at gmail.com>
Subject: Re: [squid-users] Is there any squid 4.x tested with Delay pools to work and limit well ?
On 4/10/23 20:42, Dr.X wrote:
> Is it solved in squid 6.x ?

I do not think so. AFAIK, Bug 4913 (Delay Pools don't work for Tunneled
traffic) affects all Squid versions starting with v4 (at least). IIRC,
there were some code improvements in that area, as side effects of other
projects, but nobody has worked on an actual fix yet.

Alex.


> *From: *Alex Rousskov <rousskov at measurement-factory.com>
> *Date: *Tuesday, 11 April 2023 03:24
> *To: *squid-users at lists.squid-cache.org <squid-users at lists.squid-cache.org>
> *Cc: *Dave Blanchard <dave at killthe.net>, Dr.X <0xff1f at gmail.com>
> *Subject: *Re: [squid-users] Is there any squid 4.x tested with Delay
> pools to work and limit well ?
>
> On 4/10/23 18:41, Dr.X wrote:
>
>> So do you think we will have squid 4.x to be fixed soon or latter ?
>
> Squid v4 receives very little attention these days. FWIW, I am not aware
> of anybody working on Bug 4913 (Delay Pools don't work for Tunneled
> traffic) right now (for any Squid version).
>
> https://wiki.squid-cache.org/SquidFaq/AboutSquid#how-to-add-a-new-squid-feature-enhance-of-fix-something <https://wiki.squid-cache.org/SquidFaq/AboutSquid#how-to-add-a-new-squid-feature-enhance-of-fix-something>
>
> Alex.
>
>
>
>> *From: *Alex Rousskov <rousskov at measurement-factory.com>
>> *Date: *Monday, 10 April 2023 04:31
>> *To: *squid-users at lists.squid-cache.org <squid-users at lists.squid-cache.org>
>> *Cc: *Dr.X <0xff1f at gmail.com>, Dave Blanchard <dave at killthe.net>
>> *Subject: *Re: [squid-users] Is there any squid 4.x tested with Delay
>> pools to work and limit well ?
>>
>> On 4/8/23 15:35, Dave Blanchard wrote:
>>> On Sat, 8 Apr 2023 16:40:02 +0000
>>> Dr.X <0xff1f at gmail.com> wrote:
>>
>>>> I was wondering if you have a Squid 4.x version that supports delay
>>>> pools and is not buggy. I asked Alex, the developer, and he
>>>> informed me that none of the 4.x versions support it. I also
>>>> reached out to Amos but haven't received a response yet.
>>
>>
>>> I'm interested in this also, as I've just tried setting up delay
>>> pools on 5.4 and so far haven't managed to make it work as expected.
>>
>>
>> I would like to clarify delay pools support status, again: For some
>> traffic, some delay pools configurations are probably working OK in
>> Squid v4+. The Squid bug Dr.X has been referring to above (and in other
>> recent squid-user emails) is Bug 4913 (Delay Pools don't work for
>> Tunneled traffic):
>>
>> * https://bugs.squid-cache.org/show_bug.cgi?id=4913
> <https://bugs.squid-cache.org/show_bug.cgi?id=4913>
>> <https://bugs.squid-cache.org/show_bug.cgi?id=4913
> <https://bugs.squid-cache.org/show_bug.cgi?id=4913>>
>>
>> *
>> http://lists.squid-cache.org/pipermail/squid-users/2022-June/024922.html
> <http://lists.squid-cache.org/pipermail/squid-users/2022-June/024922.html>
>> <http://lists.squid-cache.org/pipermail/squid-users/2022-June/024922.html
> <http://lists.squid-cache.org/pipermail/squid-users/2022-June/024922.html>>
>>
>> *
>> http://lists.squid-cache.org/pipermail/squid-users/2023-April/025725.html <http://lists.squid-cache.org/pipermail/squid-users/2023-April/025725.html> <http://lists.squid-cache.org/pipermail/squid-users/2023-April/025725.html <http://lists.squid-cache.org/pipermail/squid-users/2023-April/025725.html>>
>>
>>
>> HTH,
>>
>> Alex.
>>
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230411/cd51bb7b/attachment.htm>

From joost at antarean.org  Tue Apr 11 05:50:45 2023
From: joost at antarean.org (Joost Roeleveld)
Date: Tue, 11 Apr 2023 05:50:45 +0000
Subject: [squid-users] Squid proxy errors - support
In-Reply-To: <20230407134457.EGroupware.TIWgqQEptmUMMa1qdniI4HM@_>
References: <CAGC3VAvD54kWyTQAnVwKrOGgtBQtFugNDD80Um68sML4w+N6Gg@mail.gmail.com>
 <202304071308.02715.Antony.Stone@squid.open.source.it>
 <20230407134457.EGroupware.TIWgqQEptmUMMa1qdniI4HM@_>
Message-ID: <20230411055045.EGroupware.s_FjE4dpkC9WUJZU733RpxO@_>

Hi Alessio,
Let us know if the suggested changes resolved the issue.
As for removing messages from the archive, I really hope this will  
never be done as these archives are there to assist other users facing  
similar issues. If you want to keep your request private and out of  
archives, I would suggest hiring someone with the required knowledge.
Kind regards,
Joost
  original message
From: "Alessio Ballarini (External)" <alessio.ballarini at ext.noovle.com >
To: Joost Roeleveld <joost at antarean.org >
Cc: squid-users at lists.squid-cache.org
Date: Fri, 07 Apr 2023 16:07:15 +0200
----------------------------------------------------------------

>
>
> Hi Joost, thank you so much for your help.
>
> I am going to try to edit these configuration. I would like to ask  
> you to delete the thread we created from the archive :
>
> Is it possible ?
>
> Thanks Alessio
>
> Il giorno ven 7 apr 2023 alle ore 15:45 Joost Roeleveld  
> <mailto:joost at antarean.org ha scritto:
>> Hi Alessio,
>> The config file provided is incomplete. I don't see any definition  
>> of "localnet"
>> Also, how are the connections through the proxy configured? Is this  
>> done by configuring the client (SAP in this case) or is the  
>> firewall forcing the connection through the proxy and the client is  
>> unaware?
>> If unaware, you will need to configure a "https_port" and use that  
>> for https-connections.
>> --
>> Joost
>> original message From: "Alessio Ballarini (External)"  
>> <mailto:alessio.ballarini at ext.noovle.com
>> To: Antony Stone <mailto:Antony.Stone at squid.open.source.it Cc:  
>> "ManagedServices_Unix" <mailto:managedservices_unix at noovle.com ,  
>> mailto:squid-users at lists.squid-cache.org
>> Date: Fri, 07 Apr 2023 13:10:26 +0200
>> ----------------------------------------------------------------
>>
>>>
>>>
>>> Hi Antony, thank you so much for the fats response.
>>>
>>> The Operating System is:
>>>
>>> SUSE Linux Enterprise Server 15 SP3 (x86_64)
>>>
>>> The Squid Version is:
>>>
>>> Squid Cache: Version 4.17
>>>
>>> If you need more information, please let me know.
>>>
>>> Kind regards
>>> Alessio
>>>
>>> Il giorno ven 7 apr 2023 alle ore 13:08 Antony Stone  
>>> <mailto:Antony.Stone at squid.open.source.it ha scritto:
>>>> On Friday 07 April 2023 at 13:00:09, Alessio Ballarini (External) wrote:
>>>>
>>>>> Hi Squid Support,
>>>>> we are facing a problem with Squid proxy
>>>>
>>>> Which version of Squid, and running on which version of which operating
>>>> system?
>>>>
>>>> Antony.
>>>>
>>>> -- 
>>>> Normal people think "If it ain't broke, don't fix it".
>>>> Engineers think "If it ain't broke, it doesn't have enough features yet".
>>>>
>>>> Please reply to the list;
>>>> please *don't* CC me.
>>>> _______________________________________________
>>>> squid-users mailing list
>>>> mailto:squid-users at lists.squid-cache.org  
>>>> http://lists.squid-cache.org/listinfo/squid-users
>>>
>>>
>>> -- 
>>>
>>> _________________________________________ [ https://noovle.com/it  
>>> -> ] Alessio Ballarini (External) DC.O.APS Noovle S.p.A. Via  
>>> Gaetano Negri 1 - 20123 Milano (MI) +393488654039 [  
>>> https://twitter.com/Noovle_SpA -> Twitter ] - [  
>>> https://www.linkedin.com/company/noovle/ -> Linkedin ]
>>> [ https://www.noovle.com/it/ -> www.noovle.com ] INFORMATIVA SULLA  
>>> PRIVACY E SULLA CONFIDENZIALITA': Ai sensi del Reg. UE n.2016/679  
>>> sulla tutela della privacy, Vi informiamo che il presente  
>>> messaggio e-mail potrebbe contenere informazioni riservate e/o  
>>> fondate su privilegio legale, oltre a dati personali. Vi  
>>> informiamo che deteniamo e trattiamo i dati contenuti nella  
>>> presente per i soli scopi di adempiere ad obblighi di legge e/o  
>>> contrattuali e/o per la tutela di nostri legittimi interessi. La  
>>> conoscenza di questi dati ? riservata ai soli destinatari di  
>>> questa e-mail. Al di fuori degli scopi sopra descritti, tali dati  
>>> non saranno da noi rivelati in alcun modo a terzi, senza il previo  
>>> consenso scritto degli interessati coinvolti, ove prescritto e/o  
>>> necessario ai sensi della legge applicabile. Qualora Voi non siate  
>>> gli effettivi destinatari della presente e-mail, Vi informiamo che  
>>> ne sono severamente proibite la diffusione, la copia e/o la  
>>> distribuzione. Nel caso aveste ricevuto il presente messaggio per  
>>> errore Vi preghiamo, pertanto, di informarci immediatamente e di  
>>> eliminarlo dal vostro computer. Grazie.
>>> PRIVACY AND CONFIDENTIALITY NOTICE: Pursuant to EU Regulation  
>>> no.679/2016 on privacy protection, we inform You that his e-mail  
>>> message might contain confidential and/or legally privileged  
>>> information as well as personal data. We inform You that we hold  
>>> and process all data contained therein for the sole purposes of  
>>> meeting legal and/or contractual obligation(s) and/or for our  
>>> legitimate interest. Knowledge of these data is reserved solely to  
>>> the person(s) to whom this e-mail is addressed. Outside the scopes  
>>> described above, these data will not be disclosed by us in any way  
>>> to third parties without the prior written consent of the relevant  
>>> data subject(s), where prescribed and/or deemed necessary by  
>>> applicable law(s). If You are not the intended recipient, You are  
>>> hereby notified that any disclosure, copying and/or distribution  
>>> of the contents of this e-mail message is strictly prohibited. If  
>>> You have received this communication in error, therefore, please  
>>> delete it immediately and contact us to let us know it. Thank you.
>>>
>>>
>>
>>
>> _______________________________________________
>> squid-users mailing list
>> mailto:squid-users at lists.squid-cache.org  
>> http://lists.squid-cache.org/listinfo/squid-users
>
>
> -- 
>
> _________________________________________ [ https://noovle.com/it ->  
> ] Alessio Ballarini (External) DC.O.APS Noovle S.p.A. Via Gaetano  
> Negri 1 - 20123 Milano (MI) +393488654039 [  
> https://twitter.com/Noovle_SpA -> Twitter ] - [  
> https://www.linkedin.com/company/noovle/ -> Linkedin ]
> [ https://www.noovle.com/it/ -> www.noovle.com ] INFORMATIVA SULLA  
> PRIVACY E SULLA CONFIDENZIALITA': Ai sensi del Reg. UE n.2016/679  
> sulla tutela della privacy, Vi informiamo che il presente messaggio  
> e-mail potrebbe contenere informazioni riservate e/o fondate su  
> privilegio legale, oltre a dati personali. Vi informiamo che  
> deteniamo e trattiamo i dati contenuti nella presente per i soli  
> scopi di adempiere ad obblighi di legge e/o contrattuali e/o per la  
> tutela di nostri legittimi interessi. La conoscenza di questi dati ?  
> riservata ai soli destinatari di questa e-mail. Al di fuori degli  
> scopi sopra descritti, tali dati non saranno da noi rivelati in  
> alcun modo a terzi, senza il previo consenso scritto degli  
> interessati coinvolti, ove prescritto e/o necessario ai sensi della  
> legge applicabile. Qualora Voi non siate gli effettivi destinatari  
> della presente e-mail, Vi informiamo che ne sono severamente  
> proibite la diffusione, la copia e/o la distribuzione. Nel caso  
> aveste ricevuto il presente messaggio per errore Vi preghiamo,  
> pertanto, di informarci immediatamente e di eliminarlo dal vostro  
> computer. Grazie.
> PRIVACY AND CONFIDENTIALITY NOTICE: Pursuant to EU Regulation  
> no.679/2016 on privacy protection, we inform You that his e-mail  
> message might contain confidential and/or legally privileged  
> information as well as personal data. We inform You that we hold and  
> process all data contained therein for the sole purposes of meeting  
> legal and/or contractual obligation(s) and/or for our legitimate  
> interest. Knowledge of these data is reserved solely to the  
> person(s) to whom this e-mail is addressed. Outside the scopes  
> described above, these data will not be disclosed by us in any way  
> to third parties without the prior written consent of the relevant  
> data subject(s), where prescribed and/or deemed necessary by  
> applicable law(s). If You are not the intended recipient, You are  
> hereby notified that any disclosure, copying and/or distribution of  
> the contents of this e-mail message is strictly prohibited. If You  
> have received this communication in error, therefore, please delete  
> it immediately and contact us to let us know it. Thank you.
>
>



-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230411/e859b5b7/attachment.htm>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: mail_uWYfN2
Type: image/png
Size: 14219 bytes
Desc: not available
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230411/e859b5b7/attachment.png>

From ankor2023 at gmail.com  Tue Apr 11 11:05:22 2023
From: ankor2023 at gmail.com (Andrey K)
Date: Tue, 11 Apr 2023 14:05:22 +0300
Subject: [squid-users] Enable caching
In-Reply-To: <4fbfd7a8-5598-fd50-c618-aaadddcb685d@measurement-factory.com>
References: <CADJd0Y1qBCX17D71jLtDFE2Dbxjf70_pT5yTJkpSJwnUMx=3zg@mail.gmail.com>
 <1171a8a3-bf15-67ca-1635-64f8ef425c57@measurement-factory.com>
 <CADJd0Y2_HxZZi_Fsba8Amq=yJEdy0b-240xRNCp88MxYTGMXdQ@mail.gmail.com>
 <4fbfd7a8-5598-fd50-c618-aaadddcb685d@measurement-factory.com>
Message-ID: <CADJd0Y0-auF+SfWwCw4v4iaDWy_eA2JTLJNxB-zUEd51gyazPw@mail.gmail.com>

Hello Alex,

Thanks for the help.
I have written a simple perl script that outputs the contents of the
metadata of the rock database slots Maybe it will be useful for other squid
users.
*rock_cache_dump.pl <http://rock_cache_dump.pl>*

#!/usr/bin/perl
use strict;
use warnings;
use Data::Dumper;
use Sys::Mmap;

my ($file) = @ARGV;
die "Usage: $0 <cache_dir>/rock\n" if not $file;

my @TLVS = ('VOID', 'KEY_URL', 'KEY_SHA', 'KEY_MD5', 'URL', 'STD',
'HITMETERING', 'VALID', 'VARY_HEADERS', 'STD_LFS', 'OBJSIZE', 'STOREURL',
'VARY_ID', 'END');

open my $fh, '<', $file or die;
my %H, $mmap;
mmap($mmap, 0, PROT_READ, MAP_SHARED, $fh) or die "Can't mmap: $!";

my $slots = length($mmap)/0x4000-1;
my($slot, $empty_slots, $used_slots, $first_slot, $start_time) = (0, 0, 0,
0, time);

while($slot<$slots){
        my($key, $total_len, $current_len, $version, $first_slot,
$next_slot, $meta_ok, $tlvheader_len) = unpack('H32QLLLLCL', substr($mmap,
($slot+1)<<14, 45));
        if($first_slot){$used_slots++}else{$empty_slots++}
        process_slot($slot,$version, $tlvheader_len) if($next_slot &&
$meta_ok == 3 && $first_slot == $slot);
        $slot++
}

print Dumper(\%H);
print STDERR "File size: \t".int(length($mmap)/1024/1024)." MB\nTotal
slots: \t".($empty_slots+$used_slots)."\nEmpty slots: \t$empty_slots\nUsed
 slots: \t$used_slots\nUsage:
\t\t".int($used_slots*100/($empty_slots+$used_slots))." %\nProcess
time:\t".(time-$start_time)." s\n\n";

sub process_slot{
  my($slot, $version, $tlvheader_len) = @_;
  $tlvheader_len-=5;
  $H{$slot}={VERSION => "".localtime($version)};

  my $remain=substr($mmap, (($slot+1)<<14)+45, $tlvheader_len);

  my($type, $len, $value);
  while($remain){

        ($type, $len,$remain) = unpack('cLa*', $remain);
        ($value, $remain) = unpack("a$len"."a*", $remain);
        $H{$slot}{$TLVS[$type]} = $value;
        $H{$slot}{$TLVS[$type]} = unpack("A*", $H{$slot}{$TLVS[$type]})
if($type == 4 || $type == 8); #URL || VARY_HEADERS
        $H{$slot}{$TLVS[$type]} = unpack("H*", $H{$slot}{$TLVS[$type]})
if($type == 3 ); #KEY_MD5
        $H{$slot}{$TLVS[$type]} = unpack("Q*", $H{$slot}{$TLVS[$type]})
if($type == 10); #OBJSIZE
        $H{$slot}{$TLVS[$type]} = parse_STD(unpack("qqqqQSH4",
$H{$slot}{$TLVS[$type]})) if($type == 9); #STD_LFS
  }

}

sub parse_STD{
   my($timestamp, $lastref, $expires, $lastmod) = map {"".localtime($_)}
@_[0..3];
   my($swap_file_sz, $refcount, $flags)  = ($_[4], $_[5], $_[6]);
   return {timestamp => $timestamp, lastref => $lastref, expires =>
$expires, lastmod => $lastmod, swap_file_sz => $swap_file_sz, refcount =>
$refcount, flags => "0x".$flags};
}

And maybe you will add it to new squid releases.

Kind regards,
       Ankor.

??, 6 ???. 2023??. ? 20:35, Alex Rousskov <rousskov at measurement-factory.com
>:

> On 4/6/23 09:08, Andrey K wrote:
>
> > Could you tell me if there is a way to view the objects (URLs) and their
> > statuses stored in the rock file?
>
> There is no visualization software for rock db storage. One can
> obviously use xxd and similar generic tools to look at raw db bytes,
> even in a running Squid instance, but your needs are probably different.
>
>
> > I tried unsuccessfully to find this information using squidclient in
> > mgr:menu.
>
> Cache manager queries are currently ineffective for analyzing individual
> rock cache_dir objects because cache manager code relies on the legacy
> in-memory worker-specific store index while rock uses shared memory
> structures shared among workers.
>
>
> > You gave me a very useful link:
> > https://wiki.squid-cache.org/Features/LargeRockStore
> > Maybe there is a more detailed description of the internal rock data
> > structures?
>
> IIRC, the next level of detail is available in source code only. For
> starting points, consider src/fs/rock/RockDbCell.h and the end of
> Rock::SwapDir::create() that writes an all-zeroes db file header.
>
>
> HTH,
>
> Alex.
>
>
> > I could try to write a script that reads the necessary information from
> > the cache_dir file.
> >
> > Kind regards,
> >       Ankor.
> >
> >
> > ??, 5 ???. 2023??. ? 16:27, Alex Rousskov
> > <rousskov at measurement-factory.com
> > <mailto:rousskov at measurement-factory.com>>:
> >
> >     On 4/5/23 06:07, Andrey K wrote:
> >
> >      > Previously, caching was disabled on our proxy servers. Now we
> >     need to
> >      > cache some content (files about 10 MB in size).
> >      > So we changed the squid.conf:
> >
> >      > cache_dir ufs /data/squid/cache 32000 16 256 max-size=12000000
> >      >
> >      > We have 24 workers on each proxy.
> >
> >     UFS-based cache_dirs are not supported in multi-worker configurations
> >     and, in most cases, should not be used in such configurations. The
> >     combination will violate basic HTTP caching rules and may crash Squid
> >     and/or corrupt responses.
> >
> >
> >      > We saw that some requests were taken from the cache, and some
> >     were not.
> >      > The documentation says:
> >      > "In SMP configurations, cache_dir must not precede the workers
> >     option
> >      > and should use configuration macros or conditionals to give each
> >     worker
> >      > interested in disk caching a dedicated cache directory."
> >
> >     The official documentation quoted above is stale and very misleading
> in
> >     modern Squids. Ignore it. I will try to find the time to post a PR to
> >     fix this.
> >
> >
> >      > So we switched to a rock cache_dir:
> >      > cache_dir rock /data/squid/cache 32000 max-size=12000000
> >      >
> >      > Now everything seems to be working fine in the test environment,
> >     but I
> >      > found limitations on the RockStore
> >      > (https://wiki.squid-cache.org/Features/RockStore
> >     <https://wiki.squid-cache.org/Features/RockStore>:
> >      > "Objects larger than 32,000 bytes cannot be cached when
> >     cache_dirs are
> >      > shared among workers."
> >
> >     The Feature/RockStore page is stale and can easily mislead. In
> general,
> >     Feature/Foo wiki pages are often development-focused and get stale
> with
> >     time. They cannot be reliably used as a Squid feature documentation.
> >
> >
> >      > Does this mean that RockStore is not suitable for caching large
> >     files?
> >
> >     No, it does not. Rock storage has evolved since that Feature page was
> >     written. You can see the following wiki page discussing evolved rock
> >     storage design, but that page probably has some stale info as well:
> >     https://wiki.squid-cache.org/Features/LargeRockStore
> >     <https://wiki.squid-cache.org/Features/LargeRockStore>
> >
> >
> >      > Should I switch back to the UFS and configure 24 cache_dirs
> >
> >     If everything is "working fine", then you should not. Otherwise, I
> >     recommend discussing specific problems before switching to that
> >     unsupported and dangerous hack.
> >
> >
> >     HTH,
> >
> >     Alex.
> >
> >     _______________________________________________
> >     squid-users mailing list
> >     squid-users at lists.squid-cache.org
> >     <mailto:squid-users at lists.squid-cache.org>
> >     http://lists.squid-cache.org/listinfo/squid-users
> >     <http://lists.squid-cache.org/listinfo/squid-users>
> >
>
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230411/d0cde7ad/attachment.htm>

From rousskov at measurement-factory.com  Tue Apr 11 13:22:28 2023
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Tue, 11 Apr 2023 09:22:28 -0400
Subject: [squid-users] Enable caching
In-Reply-To: <CADJd0Y0-auF+SfWwCw4v4iaDWy_eA2JTLJNxB-zUEd51gyazPw@mail.gmail.com>
References: <CADJd0Y1qBCX17D71jLtDFE2Dbxjf70_pT5yTJkpSJwnUMx=3zg@mail.gmail.com>
 <1171a8a3-bf15-67ca-1635-64f8ef425c57@measurement-factory.com>
 <CADJd0Y2_HxZZi_Fsba8Amq=yJEdy0b-240xRNCp88MxYTGMXdQ@mail.gmail.com>
 <4fbfd7a8-5598-fd50-c618-aaadddcb685d@measurement-factory.com>
 <CADJd0Y0-auF+SfWwCw4v4iaDWy_eA2JTLJNxB-zUEd51gyazPw@mail.gmail.com>
Message-ID: <fe2c0c0d-e2ef-25e5-329f-dabf001515cc@measurement-factory.com>

On 4/11/23 07:05, Andrey K wrote:

> I have written a simple perl script that outputs the contents of the 
> metadata of the rock database slots Maybe it will be useful for other 
> squid users.

> *rock_cache_dump.pl

Thanks a lot for sharing this neat script! I am sure it will be handy, 
at least as a starting point, in use cases like yours.


> And maybe you will add it to new squid releases.

I would not. I believe this script is best maintained outside of the 
official source code tree until we have the resources to properly polish 
and maintain it.


Thank you,

Alex.


> ??, 6 ???. 2023??. ? 20:35, Alex Rousskov:
> 
>     On 4/6/23 09:08, Andrey K wrote:
> 
>      > Could you tell me if there is a way to view the?objects (URLs)
>     and?their
>      > statuses stored?in the rock file?
> 
>     There is no visualization software for rock db storage. One can
>     obviously use xxd and similar generic tools to look at raw db bytes,
>     even in a running Squid instance, but your needs are probably different.
> 
> 
>      > I tried unsuccessfully to find this information using squidclient in
>      > mgr:menu.
> 
>     Cache manager queries are currently ineffective for analyzing
>     individual
>     rock cache_dir objects because cache manager code relies on the legacy
>     in-memory worker-specific store index while rock uses shared memory
>     structures shared among workers.
> 
> 
>      > You gave me a very useful link:
>      > https://wiki.squid-cache.org/Features/LargeRockStore
>     <https://wiki.squid-cache.org/Features/LargeRockStore>
>      > Maybe there is a more detailed description of the internal rock data
>      > structures?
> 
>     IIRC, the next level of detail is available in source code only. For
>     starting points, consider src/fs/rock/RockDbCell.h and the end of
>     Rock::SwapDir::create() that writes an all-zeroes db file header.
> 
> 
>     HTH,
> 
>     Alex.
> 
> 
>      > I could try to write a script that reads the necessary
>     information from
>      > the cache_dir file.
>      >
>      > Kind?regards,
>      >? ? ? ?Ankor.
>      >
>      >
>      > ??, 5 ???. 2023??. ? 16:27, Alex Rousskov
>      > <rousskov at measurement-factory.com
>     <mailto:rousskov at measurement-factory.com>
>      > <mailto:rousskov at measurement-factory.com
>     <mailto:rousskov at measurement-factory.com>>>:
>      >
>      >? ? ?On 4/5/23 06:07, Andrey K wrote:
>      >
>      >? ? ? > Previously, caching was disabled on our proxy servers. Now we
>      >? ? ?need to
>      >? ? ? > cache some content (files about 10 MB in size).
>      >? ? ? > So we changed the squid.conf:
>      >
>      >? ? ? > cache_dir ufs /data/squid/cache 32000 16 256 max-size=12000000
>      >? ? ? >
>      >? ? ? > We have 24 workers on each proxy.
>      >
>      >? ? ?UFS-based cache_dirs are not supported in multi-worker
>     configurations
>      >? ? ?and, in most cases, should not be used in such
>     configurations. The
>      >? ? ?combination will violate basic HTTP caching rules and may
>     crash Squid
>      >? ? ?and/or corrupt responses.
>      >
>      >
>      >? ? ? > We saw that some requests were taken from the cache, and some
>      >? ? ?were not.
>      >? ? ? > The documentation?says:
>      >? ? ? > "In SMP configurations, cache_dir must not precede the workers
>      >? ? ?option
>      >? ? ? > and should use configuration macros or conditionals to
>     give each
>      >? ? ?worker
>      >? ? ? > interested in disk caching a dedicated cache directory."
>      >
>      >? ? ?The official documentation quoted above is stale and very
>     misleading in
>      >? ? ?modern Squids. Ignore it. I will try to find the time to post
>     a PR to
>      >? ? ?fix this.
>      >
>      >
>      >? ? ? > So we switched to a rock cache_dir:
>      >? ? ? > cache_dir rock /data/squid/cache 32000 max-size=12000000
>      >? ? ? >
>      >? ? ? > Now everything seems to be working fine in the test
>     environment,
>      >? ? ?but I
>      >? ? ? > found limitations on the RockStore
>      >? ? ? > (https://wiki.squid-cache.org/Features/RockStore
>     <https://wiki.squid-cache.org/Features/RockStore>
>      >? ? ?<https://wiki.squid-cache.org/Features/RockStore
>     <https://wiki.squid-cache.org/Features/RockStore>>:
>      >? ? ? > "Objects larger than 32,000 bytes cannot be cached when
>      >? ? ?cache_dirs are
>      >? ? ? > shared among workers."
>      >
>      >? ? ?The Feature/RockStore page is stale and can easily mislead.
>     In general,
>      >? ? ?Feature/Foo wiki pages are often development-focused and get
>     stale with
>      >? ? ?time. They cannot be reliably used as a Squid feature
>     documentation.
>      >
>      >
>      >? ? ? > Does this mean that?RockStore?is not suitable for caching
>     large
>      >? ? ?files?
>      >
>      >? ? ?No, it does not. Rock storage has evolved since that Feature
>     page was
>      >? ? ?written. You can see the following wiki page discussing
>     evolved rock
>      >? ? ?storage design, but that page probably has some stale info as
>     well:
>      > https://wiki.squid-cache.org/Features/LargeRockStore
>     <https://wiki.squid-cache.org/Features/LargeRockStore>
>      >? ? ?<https://wiki.squid-cache.org/Features/LargeRockStore
>     <https://wiki.squid-cache.org/Features/LargeRockStore>>
>      >
>      >
>      >? ? ? > Should I switch back?to the UFS and configure 24 cache_dirs
>      >
>      >? ? ?If everything is "working fine", then you should not.
>     Otherwise, I
>      >? ? ?recommend discussing specific problems before switching to that
>      >? ? ?unsupported and dangerous hack.
>      >
>      >
>      >? ? ?HTH,
>      >
>      >? ? ?Alex.
>      >
>      >? ? ?_______________________________________________
>      >? ? ?squid-users mailing list
>      > squid-users at lists.squid-cache.org
>     <mailto:squid-users at lists.squid-cache.org>
>      >? ? ?<mailto:squid-users at lists.squid-cache.org
>     <mailto:squid-users at lists.squid-cache.org>>
>      > http://lists.squid-cache.org/listinfo/squid-users
>     <http://lists.squid-cache.org/listinfo/squid-users>
>      >? ? ?<http://lists.squid-cache.org/listinfo/squid-users
>     <http://lists.squid-cache.org/listinfo/squid-users>>
>      >
> 



From hans.peter.wurst2000 at protonmail.com  Wed Apr 12 11:14:35 2023
From: hans.peter.wurst2000 at protonmail.com (hans.peter.wurst2000)
Date: Wed, 12 Apr 2023 11:14:35 +0000
Subject: [squid-users] Squid authentication objects by source ip
Message-ID: <1l9Gdh5PW5xWwcpdX0CgqpjOwMUne9-Vmln7TSaa5FwXWJN8RLgvxcoW2I8GMuRInhEQMhYV_9ZvafIcjtW-NJUcs0xLmh5e0f7VbOkkUOY=@protonmail.com>

Hello,

i have currently a problem to setup squid authentication with kerberos. The problem is not the authentication itself. It works fine, but only for one AD-Domain. I have 6 AD Domains that have to authenticate trough this squid-proxy. In the documentation "https://wiki.squid-cache.org/Features/Authentication" i have seen that my problem could be solved by using full plain authentication with ldap. And that is the current way i will solve this. But for future squid releases would it be possible to change the Proxy authentication function to filter authentication methods by source ip.

Example:

auth_param 1 negotiate program /usr/sbin/squid_kerb_auth

-k /etc/squid/HTTP_Domain1.keytab

auth_param 1 negotiate children 10
auth_param 1 negotiate keep_alive on

auth_param 2 negotiate program /usr/sbin/squid_kerb_auth

-k /etc/squid/HTTP_Domain2.keytab

auth_param 2 negotiate children 10
auth_param 2 negotiate keep_alive on

acl dom1-auth src 10.15.0.0/255.255.255.0 proxy_auth 1 REQUIRED

acl dom2-auth src 10.16.0.0/255.255.255.0 proxy_auth 2 REQUIRED

http_access allow dom1-auth

http_access allow dom2-auth

http_access deny all

I have show an example here by separate the authenticators by numbers, but it could also be an ascii word.

Filter by LDAP Groups should also be possible like before.

Thank you for your help,
Hans-Peter
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230412/fe414b68/attachment.htm>

From tony.albers at gmx.com  Wed Apr 12 11:48:35 2023
From: tony.albers at gmx.com (Tony Albers)
Date: Wed, 12 Apr 2023 13:48:35 +0200
Subject: [squid-users] forward/reverse proxying with TLS.
Message-ID: <d73afef4-5a4a-e1e6-b518-763006014cab@gmx.com>

Hiya,

I'm quite new to squid, so please bear with me.

OS is Debian Bullseye.

What I want to do is "hide" an application behind squid, so that the 
application receives http traffic, and sends http traffic. This traffic 
then goes through squid in both directions, so that squid receives https 
on the external IP and forwards it to the application which is listening 
on the loopback interface, and squid receives outgoing traffic from the 
application on the loopback interface and then sends it out over the 
external IP with https.

Kinda like so:
Incoming: exthost1(HTTPS)->thishostname:443-> squid 
->127.0.0.1(HTTP)->127.0.0.1:1080

Outgoing: 127.0.0.1(HTTP)->127.0.0.1:8080-> squid
->exthost2:443(HTTPS)


I have the application running in a container on the host.
On the same host I also have squid installed.

The application listens on 127.0.0.1:1080 on HOST
Squid is set up as a reverse proxy, listening to https on the external 
if on HOST:443 and forwards everything as http to 127.0.0.1:1080
(this works fine)

When the application then transmits something via http, it uses 
localhost:8080 as proxy, where squid picks it up and then forwards it as 
https.
(this doesn't work)

At least that#s what I want it to do..

However, when I use squid as outgoing proxy, the server in the other 
end(88.24.12.40) says that squid doesn't present a client certificate 
and drops the connection.

But I got the impression that tls_outgoing_options is for exactly that.. 
Have I misunderstood something?


My squid config looks like this:

# prefer DNS over IPv4
dns_v4_first on

# define hosts/networks that we use
acl exthost src 88.24.12.60/32
acl inthosts src 172.27.2.0/24
acl internal src 127.0.0.1/32

# access lists
http_access allow exthost
http_access allow inthosts
http_access allow internal

# reverse SSL proxy converting to noSSL
https_port 172.27.2.118:443 accel
tls-cert=/etc/squid/certs/thishostname.crt
tls-key=/etc/squid/keys/thishostname-privkey.pem
defaultsite=thishostname
cache_peer 127.0.0.1 parent 1080 0 no-query proxy-only originserver 
name=thishostname

# forward proxy converting to SSL
http_port 127.0.0.1:8080
acl extnet dstdomain -n .somedomain.dk
acl extip dstdomain 88.24.12.40
acl intip dstdomain -n .someotherdomain.dk
url_rewrite_program /etc/squid/urlrewrite.py
tls_outgoing_options cert=/etc/squid/certs/thishostname.crt
tls_outgoing_options key=/etc/squid/keys/thishostname-privkey.pem
tls_outgoing_options cafile=/etc/squid/certs/thishostnameCA.pem
tls_outgoing_options capath=/etc/ssl/certs
tls_outgoing_options domain=somedomain.dk
never_direct deny extnet
never_direct deny extip
never_direct allow all

cache_peer_access thishostname allow exthosts
cache_peer_access thishostname allow inthosts
cache_peer_access thishostname allow internal
cache_peer_access thishostname deny all

# disable local caching
cache deny all

Thanks in advance,

Tony


From rousskov at measurement-factory.com  Wed Apr 12 13:55:39 2023
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Wed, 12 Apr 2023 09:55:39 -0400
Subject: [squid-users] forward/reverse proxying with TLS.
In-Reply-To: <d73afef4-5a4a-e1e6-b518-763006014cab@gmx.com>
References: <d73afef4-5a4a-e1e6-b518-763006014cab@gmx.com>
Message-ID: <ae7cb8b2-2faf-6d52-b6e3-6be21e74fda3@measurement-factory.com>

On 4/12/23 07:48, Tony Albers wrote:

> What I want to do is "hide" an application behind squid, so that the 
> application receives http traffic, and sends http traffic. This traffic 
> then goes through squid in both directions, so that squid receives https 
> on the external IP and forwards it to the application which is listening 
> on the loopback interface, and squid receives outgoing traffic from the 
> application on the loopback interface and then sends it out over the 
> external IP with https.

> Kinda like so:
> Incoming: exthost1(HTTPS)->thishostname:443-> squid 
> ->127.0.0.1(HTTP)->127.0.0.1:1080
> 
> Outgoing: 127.0.0.1(HTTP)->127.0.0.1:8080-> squid
> ->exthost2:443(HTTPS)

> when I use squid as outgoing proxy, the server in the other 
> end(88.24.12.40) says that squid doesn't present a client certificate
> and drops the connection.

It looks like you are trying to force Squid to encrypt traffic by using 
tls_outgoing_options. Squid cannot be forced to encrypt. Squid encrypts 
if it needs to communicate with a TLS origin server or cache_peer and 
does not encrypt otherwise. The tls_outgoing_options directive is 
consulted _if_ Squid encrypts; it cannot _force_ encryption.

There are two primary use cases where Squid should encrypt traffic on 
behalf of an HTTP application:

1. The application, when configured to use a proxy at http_port, sends 
Squid HTTP requests that have an "https" URL scheme. This is often 
referred to as "GET https" use case. Very few applications (i.e. HTTP 
user agents) do that, unfortunately.

2. The application, when configured to use a proxy at http_port, sends 
Squid HTTP requests that have an "http" URL scheme, and Squid is 
configured to forward those HTTP requests to one (or a few) cache_peers, 
each configured with "tls" and "originserver" options. This use case is 
applicable only if the application communicates with a few origin 
servers, and you know all those origin servers in advance (so that you 
can create a matching cache_peer configuration for each of them).

If your use case is #2, then you need to adjust your cache_peer 
directive to make that cache_peer a TLS peer (with appropriate client 
certificates).


N.B. Your http_access rules may benefit from a refactoring that makes 
each rule specific to the listening port that needs access protection. 
For example, do not allow exthost traffic on http_port... Similar 
"everything everywhere" problem may exist for your cache_peer access 
rules: Those rules should deny peering for traffic received on 
https_port AFAICT.


HTH,

Alex.



> I have the application running in a container on the host.
> On the same host I also have squid installed.
> 
> The application listens on 127.0.0.1:1080 on HOST
> Squid is set up as a reverse proxy, listening to https on the external 
> if on HOST:443 and forwards everything as http to 127.0.0.1:1080
> (this works fine)
> 
> When the application then transmits something via http, it uses 
> localhost:8080 as proxy, where squid picks it up and then forwards it as 
> https.
> (this doesn't work)
> 
> At least that#s what I want it to do..
> 
> However, when I use squid as outgoing proxy, the server in the other 
> end(88.24.12.40) says that squid doesn't present a client certificate 
> and drops the connection.
> 
> But I got the impression that tls_outgoing_options is for exactly that.. 
> Have I misunderstood something?
> 
> 
> My squid config looks like this:
> 
> # prefer DNS over IPv4
> dns_v4_first on
> 
> # define hosts/networks that we use
> acl exthost src 88.24.12.60/32
> acl inthosts src 172.27.2.0/24
> acl internal src 127.0.0.1/32
> 
> # access lists
> http_access allow exthost
> http_access allow inthosts
> http_access allow internal
> 
> # reverse SSL proxy converting to noSSL
> https_port 172.27.2.118:443 accel
> tls-cert=/etc/squid/certs/thishostname.crt
> tls-key=/etc/squid/keys/thishostname-privkey.pem
> defaultsite=thishostname
> cache_peer 127.0.0.1 parent 1080 0 no-query proxy-only originserver 
> name=thishostname
> 
> # forward proxy converting to SSL
> http_port 127.0.0.1:8080
> acl extnet dstdomain -n .somedomain.dk
> acl extip dstdomain 88.24.12.40
> acl intip dstdomain -n .someotherdomain.dk
> url_rewrite_program /etc/squid/urlrewrite.py
> tls_outgoing_options cert=/etc/squid/certs/thishostname.crt
> tls_outgoing_options key=/etc/squid/keys/thishostname-privkey.pem
> tls_outgoing_options cafile=/etc/squid/certs/thishostnameCA.pem
> tls_outgoing_options capath=/etc/ssl/certs
> tls_outgoing_options domain=somedomain.dk
> never_direct deny extnet
> never_direct deny extip
> never_direct allow all
> 
> cache_peer_access thishostname allow exthosts
> cache_peer_access thishostname allow inthosts
> cache_peer_access thishostname allow internal
> cache_peer_access thishostname deny all
> 
> # disable local caching
> cache deny all



From andre.bolinhas at articatech.com  Wed Apr 12 14:47:12 2023
From: andre.bolinhas at articatech.com (andre.bolinhas at articatech.com)
Date: Wed, 12 Apr 2023 15:47:12 +0100
Subject: [squid-users] idnsSendQuery: Can't send query, no DNS socket!
In-Reply-To: <532b95ee-a687-bf03-7a25-7374f0bd4892@measurement-factory.com>
References: <!&!AAAAAAAAAAAuAAAAAAAAAIVNjRjcTGZElYgADq7oyvYBAMO2jhD3dRHOtM0AqgC7tuYAAAAAAA4AABAAAADmlE4679IMTIhoBT3ictBTAQAAAAA=@articatech.com>
 <532b95ee-a687-bf03-7a25-7374f0bd4892@measurement-factory.com>
Message-ID: <01ed01d96d4d$ab584b20$0208e160$@articatech.com>

Thank you for your reply, yes the same happens with squid 5.8
on dmesg sometimes I also get this kernel panic
https://drive.google.com/file/d/1M3bzCASNGITuiTOKykIFhvGS6TvnHoKM/view?usp=s
haring

Best regards


-----Mensagem original-----
De: squid-users <squid-users-bounces at lists.squid-cache.org> Em Nome De
Alex Rousskov
Enviada: 11 de abril de 2023 01:22
Para: squid-users at lists.squid-cache.org
Assunto: Re: [squid-users] idnsSendQuery: Can't send query, no DNS socket!

On 4/10/23 17:14, andre.bolinhas at articatech.com wrote:

> We have experienced some issue on our squid servers, time to times the 
> listen port fails and users are unable to connected to the proxy.
> We already try use squid 4.17 and squid 5.8 but had the same issue on 
> both version, you can find I GDrive the extract of the cache.log on 
> the time of the failure.


> 2023/04/10 16:25:54 kid2| Starting Squid Cache version 4.17 for
x86_64-pc-linux-gnu...
> 2023/04/10 16:26:00 kid2| Shutting down...
> 2023/04/10 16:26:00 kid2| Squid Cache (Version 4.17): Exiting normally.
> 2023/04/10 16:26:03 kid2| Starting Squid Cache version 4.17 for
x86_64-pc-linux-gnu...
> 2023/04/10 16:26:15 kid2| Shutting down...
> 2023/04/10 16:26:15 kid2| Squid Cache (Version 4.17): Exiting normally.
> 2023/04/10 16:26:18 kid2| Starting Squid Cache version 4.17 for
x86_64-pc-linux-gnu...

Are you starting and shutting down your Squids at a very high frequency? 
FWIW, older Squids, possibly including Squid v4, are not very good at
handling this kind of exercise.


> 2023/04/10 16:23:19 kid2| Preparing for shutdown after 221344 requests
> 2023/04/10 16:23:19 kid2| Preparing for shutdown after 221344 requests
> 2023/04/10 16:23:19 kid2| Preparing for shutdown after 221344 requests
> 2023/04/10 16:23:19 kid2| Preparing for shutdown after 221344 requests
> 2023/04/10 16:23:19 kid2| Preparing for shutdown after 221344 requests

This Squid appears to be seriously confused, stuck in some kind of a 
shutdown loop. Do you see similar repeated same-kid same-request-count 
"Preparing for shutdown" messages with Squid v5+?


> On the cache log I see to many
> idnsSendQuery: Can't send query, no DNS socket!

IIRC, at a certain shutdown stage, Squid closes DNS sockets. That 
prevents Squid from sending DNS queries. I do not know if that shutdown 
aspect has improved since v4. However, I would be a lot more worried 
about frequent restarts and shutdown loops(?) at this point. Something 
unusual and probably bad is going on...


HTH,

Alex.



> And
> 2023/04/10 16:25:59 kid4| Waiting 10 seconds for active connections to
> finish
> 2023/04/10 16:25:59 kid4| Preparing for shutdown after 763 requests
> 
> This is the dns configuration squid/dns.conf
> # Return DNS used by the system (means resolv.conf)
> client_dst_passthru off
> host_verify_strict off
> ignore_unknown_nameservers off
> dns_retransmit_interval 3 seconds
> dns_v4_first on
> ipcache_size 16384
> ipcache_low 90
> ipcache_high 95
> fqdncache_size 1024
> positive_dns_ttl 6 hours
> negative_dns_ttl 300 seconds
> 
> Resolv.conf
> domain xyz.my
> search xyz.my
> options attempts:2 timeout:2
> nameserver 127.0.0.1
> nameserver 8.8.8.8
> nameserver 1.1.1.1
> 
> 127.0.0.1 is the unbound internal DNS.
> 
> 
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users

_______________________________________________
squid-users mailing list
squid-users at lists.squid-cache.org
http://lists.squid-cache.org/listinfo/squid-users



From rousskov at measurement-factory.com  Wed Apr 12 15:21:51 2023
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Wed, 12 Apr 2023 11:21:51 -0400
Subject: [squid-users] idnsSendQuery: Can't send query, no DNS socket!
In-Reply-To: <01ed01d96d4d$ab584b20$0208e160$@articatech.com>
References: <!&!AAAAAAAAAAAuAAAAAAAAAIVNjRjcTGZElYgADq7oyvYBAMO2jhD3dRHOtM0AqgC7tuYAAAAAAA4AABAAAADmlE4679IMTIhoBT3ictBTAQAAAAA=@articatech.com>
 <532b95ee-a687-bf03-7a25-7374f0bd4892@measurement-factory.com>
 <01ed01d96d4d$ab584b20$0208e160$@articatech.com>
Message-ID: <c4384263-0ded-a11b-62da-2d0b7e4445bd@measurement-factory.com>

On 4/12/23 10:47, andre.bolinhas at articatech.com wrote:
> yes the same happens with squid 5.8
> on dmesg sometimes I also get this kernel panic
> https://drive.google.com/file/d/1M3bzCASNGITuiTOKykIFhvGS6TvnHoKM/view?usp=sharing

That image appears to show a Squid process segmentation fault. If that 
is the case, and Squid v5 is involved, then I recommend getting a 
backtrace from that fault. Most Squid segmentation faults are Squid 
misconfigurations and/or bugs.

However, that is just a general recommendation. Without knowing more 
about your seemingly unusual environment (see my original questions in 
the email below), it is difficult for me to guide you towards a solution.

Alex.


> -----Mensagem original-----
> De: squid-users <squid-users-bounces at lists.squid-cache.org> Em Nome De
> Alex Rousskov
> Enviada: 11 de abril de 2023 01:22
> Para: squid-users at lists.squid-cache.org
> Assunto: Re: [squid-users] idnsSendQuery: Can't send query, no DNS socket!
> 
> On 4/10/23 17:14, andre.bolinhas at articatech.com wrote:
> 
>> We have experienced some issue on our squid servers, time to times the
>> listen port fails and users are unable to connected to the proxy.
>> We already try use squid 4.17 and squid 5.8 but had the same issue on
>> both version, you can find I GDrive the extract of the cache.log on
>> the time of the failure.
> 
> 
>> 2023/04/10 16:25:54 kid2| Starting Squid Cache version 4.17 for
> x86_64-pc-linux-gnu...
>> 2023/04/10 16:26:00 kid2| Shutting down...
>> 2023/04/10 16:26:00 kid2| Squid Cache (Version 4.17): Exiting normally.
>> 2023/04/10 16:26:03 kid2| Starting Squid Cache version 4.17 for
> x86_64-pc-linux-gnu...
>> 2023/04/10 16:26:15 kid2| Shutting down...
>> 2023/04/10 16:26:15 kid2| Squid Cache (Version 4.17): Exiting normally.
>> 2023/04/10 16:26:18 kid2| Starting Squid Cache version 4.17 for
> x86_64-pc-linux-gnu...
> 
> Are you starting and shutting down your Squids at a very high frequency?
> FWIW, older Squids, possibly including Squid v4, are not very good at
> handling this kind of exercise.
> 
> 
>> 2023/04/10 16:23:19 kid2| Preparing for shutdown after 221344 requests
>> 2023/04/10 16:23:19 kid2| Preparing for shutdown after 221344 requests
>> 2023/04/10 16:23:19 kid2| Preparing for shutdown after 221344 requests
>> 2023/04/10 16:23:19 kid2| Preparing for shutdown after 221344 requests
>> 2023/04/10 16:23:19 kid2| Preparing for shutdown after 221344 requests
> 
> This Squid appears to be seriously confused, stuck in some kind of a
> shutdown loop. Do you see similar repeated same-kid same-request-count
> "Preparing for shutdown" messages with Squid v5+?
> 
> 
>> On the cache log I see to many
>> idnsSendQuery: Can't send query, no DNS socket!
> 
> IIRC, at a certain shutdown stage, Squid closes DNS sockets. That
> prevents Squid from sending DNS queries. I do not know if that shutdown
> aspect has improved since v4. However, I would be a lot more worried
> about frequent restarts and shutdown loops(?) at this point. Something
> unusual and probably bad is going on...
> 
> 
> HTH,
> 
> Alex.
> 
> 
> 
>> And
>> 2023/04/10 16:25:59 kid4| Waiting 10 seconds for active connections to
>> finish
>> 2023/04/10 16:25:59 kid4| Preparing for shutdown after 763 requests
>>
>> This is the dns configuration squid/dns.conf
>> # Return DNS used by the system (means resolv.conf)
>> client_dst_passthru off
>> host_verify_strict off
>> ignore_unknown_nameservers off
>> dns_retransmit_interval 3 seconds
>> dns_v4_first on
>> ipcache_size 16384
>> ipcache_low 90
>> ipcache_high 95
>> fqdncache_size 1024
>> positive_dns_ttl 6 hours
>> negative_dns_ttl 300 seconds
>>
>> Resolv.conf
>> domain xyz.my
>> search xyz.my
>> options attempts:2 timeout:2
>> nameserver 127.0.0.1
>> nameserver 8.8.8.8
>> nameserver 1.1.1.1
>>
>> 127.0.0.1 is the unbound internal DNS.
>>
>>
>> _______________________________________________
>> squid-users mailing list
>> squid-users at lists.squid-cache.org
>> http://lists.squid-cache.org/listinfo/squid-users
> 
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users



From 0xff1f at gmail.com  Wed Apr 12 21:37:02 2023
From: 0xff1f at gmail.com (Dr.X)
Date: Wed, 12 Apr 2023 21:37:02 +0000
Subject: [squid-users] General Questions in squid 4.x
Message-ID: <DBBPR09MB45237F5BE0A9098EF57665A1F79B9@DBBPR09MB4523.eurprd09.prod.outlook.com>

Hi Squid Folks,

I have a few questions regarding Squid:

Question #1:

My Squid server is working fine, but we accidentally removed the conf file. The service is still running without any issues, but if we stop it, we won't be able to power it up again as no conf file exists. Is there a file dropped in RAM or somewhere else where we can retrieve the configuration file?

Question #2:

I believe there are some Squid config directives that are added by default to squid.conf and are hidden in the config file. Is there a way to check all the Squid directives that are loaded, whether they are hidden or not?

Question #3:

If we start Squid but mistakenly start it again, we receive the error message below:

2023/04/12 17:33:52| FATAL: squid is already running: Found fresh instance PID file (/var/run/squidtest.pid) with PID 959949
exception location: Instance.cc(121) ThrowIfAlreadyRunningWith

As a result, the old service becomes dead, and we have to stop and start it again. Is there any Squid directive that prevents the instance from crashing in case we accidentally start it again?

Thank you.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230412/88ee7f27/attachment.htm>

From 0xff1f at gmail.com  Thu Apr 13 01:11:29 2023
From: 0xff1f at gmail.com (Dr.X)
Date: Thu, 13 Apr 2023 01:11:29 +0000
Subject: [squid-users] General Questions in squid 4.x
In-Reply-To: <PH8PR09MB9775ED290220BC22AE38D5DBEA9B9@PH8PR09MB9775.namprd09.prod.outlook.com>
References: <DBBPR09MB45237F5BE0A9098EF57665A1F79B9@DBBPR09MB4523.eurprd09.prod.outlook.com>
 <PH8PR09MB9775ED290220BC22AE38D5DBEA9B9@PH8PR09MB9775.namprd09.prod.outlook.com>
Message-ID: <DBBPR09MB4523952190F2B215D9F223DFF7989@DBBPR09MB4523.eurprd09.prod.outlook.com>

Hello James ,
Thank you for your reply,
But I don?t have cache manager enabled .

From: James Zuelow <james.zuelow at juneau.gov>
Date: Thursday, 13 April 2023 02:15
To: 'Dr.X' <0xff1f at gmail.com>
Subject: RE: General Questions in squid 4.x
For question 1, try using squidclient to retrieve mgr:config from your local server.  That will at least show you the currently running setup (including things like ACLs) which will let you re-create a configuration file.

For example, on my server (running on port 8080) it would look like this:

squidclient -h 127.0.0.1 -p 8080 -U cachemgr -W password mgr:config

where password is your cachemgr_password.   Your settings may dictate a different user.

For question 2, I believe that mgr:config resolves this as well.


James Zuelow
Systems Operations Manager
City and Borough of Juneau Information Technology
(907) 586-5295 x4212

From: squid-users <squid-users-bounces at lists.squid-cache.org> On Behalf Of Dr.X
Sent: Wednesday, April 12, 2023 1:37 PM
To: squid-users at lists.squid-cache.org
Subject: [squid-users] General Questions in squid 4.x
Importance: High

Hi Squid Folks,

I have a few questions regarding Squid:

Question #1:

My Squid server is working fine, but we accidentally removed the conf file. The service is still running without any issues, but if we stop it, we won't be able to power it up again as no conf file exists. Is there a file dropped in RAM or somewhere else where we can retrieve the configuration file?

Question #2:

I believe there are some Squid config directives that are added by default to squid.conf and are hidden in the config file. Is there a way to check all the Squid directives that are loaded, whether they are hidden or not?

Question #3:

If we start Squid but mistakenly start it again, we receive the error message below:

2023/04/12 17:33:52| FATAL: squid is already running: Found fresh instance PID file (/var/run/squidtest.pid) with PID 959949
exception location: Instance.cc(121) ThrowIfAlreadyRunningWith

As a result, the old service becomes dead, and we have to stop and start it again. Is there any Squid directive that prevents the instance from crashing in case we accidentally start it again?

Thank you.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230413/701cf836/attachment.htm>

From squid3 at treenet.co.nz  Thu Apr 13 01:28:07 2023
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Thu, 13 Apr 2023 13:28:07 +1200
Subject: [squid-users] General Questions in squid 4.x
In-Reply-To: <DBBPR09MB4523952190F2B215D9F223DFF7989@DBBPR09MB4523.eurprd09.prod.outlook.com>
References: <DBBPR09MB45237F5BE0A9098EF57665A1F79B9@DBBPR09MB4523.eurprd09.prod.outlook.com>
 <PH8PR09MB9775ED290220BC22AE38D5DBEA9B9@PH8PR09MB9775.namprd09.prod.outlook.com>
 <DBBPR09MB4523952190F2B215D9F223DFF7989@DBBPR09MB4523.eurprd09.prod.outlook.com>
Message-ID: <c6a7d03b-6a68-2edd-14ab-801af327e69a@treenet.co.nz>

On 13/04/2023 1:11 pm, Dr.X wrote:
>
> Hello James ,
>
> Thank you for your reply,
>
> But I don?t have cache manager enabled .
>

Then you are out of luck. Without the manager access it would take a 
forensic analysis of an ALL,9 level cache.log to get anything about the 
config settings, and that would likely only retrieve some access 
controls and peer rules. If you would like to try that I am available 
for paid consult. Though it may be faster/better to write a new config 
from what you know of the company policies.

HTH
Amos



From rousskov at measurement-factory.com  Thu Apr 13 01:35:41 2023
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Wed, 12 Apr 2023 21:35:41 -0400
Subject: [squid-users] General Questions in squid 4.x
In-Reply-To: <DBBPR09MB45237F5BE0A9098EF57665A1F79B9@DBBPR09MB4523.eurprd09.prod.outlook.com>
References: <DBBPR09MB45237F5BE0A9098EF57665A1F79B9@DBBPR09MB4523.eurprd09.prod.outlook.com>
Message-ID: <716a9dc3-4b28-14d0-3e73-1e70b1c85681@measurement-factory.com>

On 4/12/23 17:37, Dr.X wrote:

> Question #1:
> 
> My Squid server is working fine, but we accidentally removed the conf 
> file. The service is still running without any issues, but if we stop 
> it, we won't be able to power it up again as no conf file exists. Is 
> there a file dropped in RAM or somewhere else where we can retrieve the 
> configuration file?

Short answer: No.

If your Squid was configured to allow mgr:config cache manager queries, 
then you can get a "configuration dump" from the running Squid. However, 
code dumping configuration has many bugs and design flaws, so you will 
only get something that kind of resemblance the original configuration. 
You will not be able to copy-paste that output to restore the lost 
configuration.

If your Squid was configured to deny mgr:config queries (that is the 
default IIRC), then you might still be able to get the configuration 
dump mentioned above by attaching a debugging to the running Squid 
instance and adjusting Squid memory state to allow such queries, but 
doing so requires developer-level knowledge (and will freeze the Squid 
worker while you are modifying its state). I am only mentioning this 
developer-focused option for completeness sake.

See cachemgr_passwd directive documentation for more details about 
protected cache manager queries:
http://www.squid-cache.org/Doc/config/cachemgr_passwd/


> Question #2:
> 
> I believe there are some Squid config directives that are added by 
> default to squid.conf and are hidden in the config file. Is there a way 
> to check all the Squid directives that are loaded, whether they are 
> hidden or not?

A clarification for the question itself: Nothing is secretly added to 
your squid.conf file, but, yes, Squid does apply a lot of defaults and, 
to a certain extent, they are treated as if Squid found them in your 
squid.conf file.

With that clarification in mind, the short answer to your question is "No".

You can get a sense of most of the directive defaults by searching for 
"Default:" lines in squid.conf.documented, but many of those defaults 
require manual interpretation. Some of the defaults cannot be expressed 
as squid.conf directives.

Another way to look at the "active" or "actual" configuration is the 
mgr:config dump mentioned in Q1, with all its deficiencies. That dump 
does not show some of the defaults.


> Question #3:
> 
> If we start Squid but mistakenly start it again, we receive the error 
> message below:
> 
> 2023/04/12 17:33:52| FATAL: squid is already running: Found fresh 
> instance PID file (/var/run/squidtest.pid) with PID 959949

Yes, that is correct/expected behavior.


> As a result, the old service becomes dead,

That should not be happening. If by "service" you mean "squid instance", 
and you can reproduce this "old service become dead" problem with Squid 
v5+, then please file a bug report with the instructions on how to 
reproduce, preferably without using OS-specific service commands. The 
expected behavior is that the old Squid instance continues to run as if 
nothing happened.

There were related bugs in earlier Squid versions that prevented clean 
behavior during such "competing" startups, but no such bugs are known in 
Squid v5+ IIRC.


> Is there any Squid directive that prevents the instance from 
> crashing in case we accidentally start it again?
  The second concurrently started instance should quit (with an error 
message similar to the one you have shared above) without lasting side 
effects (other than logging to console or syslog), and before it starts 
accepting or generating traffic. Resources permitting, the first 
instance should continue running as if nothing happened. Anything else 
is a misconfiguration or a bug.


HTH,

Alex.



From squid3 at treenet.co.nz  Thu Apr 13 01:52:41 2023
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Thu, 13 Apr 2023 13:52:41 +1200
Subject: [squid-users] Squid authentication objects by source ip
In-Reply-To: <1l9Gdh5PW5xWwcpdX0CgqpjOwMUne9-Vmln7TSaa5FwXWJN8RLgvxcoW2I8GMuRInhEQMhYV_9ZvafIcjtW-NJUcs0xLmh5e0f7VbOkkUOY=@protonmail.com>
References: <1l9Gdh5PW5xWwcpdX0CgqpjOwMUne9-Vmln7TSaa5FwXWJN8RLgvxcoW2I8GMuRInhEQMhYV_9ZvafIcjtW-NJUcs0xLmh5e0f7VbOkkUOY=@protonmail.com>
Message-ID: <e1ffd65f-c7ef-61d1-54f4-1a802410a678@treenet.co.nz>

On 12/04/2023 11:14 pm, hans.peter.wurst2000 wrote:
> Hello,
>
> i have currently a problem to setup squid authentication with 
> kerberos. The problem is not the authentication itself. It works fine, 
> but only for one AD-Domain. I have 6 AD Domains that have to 
> authenticate trough this squid-proxy. In the documentation 
> "https://wiki.squid-cache.org/Features/Authentication" i have seen 
> that my problem could be solved by using full plain authentication 
> with ldap. And that is the current way i will solve this. But for 
> future squid releases would it be possible to change the Proxy 
> authentication function to filter authentication methods by source ip.
>

I am afraid you have misunderstood how HTTP authentication works in Squid.

Squid is just middleware between the client and the authenticator 
system. All it does is tell the client which **types** (aka "scheme") of 
authentication are acceptable, and passes the clients credentials to a 
helper that can handle how that scheme encodes and validates credentials.

Deciding which auth database to check credentials against is the role of 
external helpers....


> Example:
>
> |auth_param 1 negotiate program /usr/sbin/squid_kerb_auth -k 
> /etc/squid/HTTP_Domain1.keytab auth_param 1 negotiate children 10 
> auth_param 1 negotiate keep_alive on|
> |auth_param 2 negotiate program /usr/sbin/squid_kerb_auth -k 
> /etc/squid/HTTP_Domain2.keytab auth_param 2 negotiate children 10 
> auth_param 2 negotiate keep_alive on|

To use completely separate keytabs you should write a wrapper script 
that takes the credentials + IP from Squid and selects which 
squid_kerb_auth (or better negotiate_kerberos_auth) helper to pass them to.

squid.conf looks like this:

|auth_param negotiate program /path/to/script auth_param negotiate 
key_extras %>a||auth_param negotiate children 10|


What the script receives is documented here:
<https://wiki.squid-cache.org/Features/NegotiateAuthentication#input-line-received-from-squid>

It needs to decide which kerberos helper to pass the request to, then 
relay the actual helpers response back to Squid.


> Filter by LDAP Groups should also be possible like before.
>

Check how your LDAP helper is configured. Likely it also needs to also 
distinguish which keytab to use to fine details about the user such as 
group(s).


Amos


From tony.albers at gmx.com  Thu Apr 13 04:28:27 2023
From: tony.albers at gmx.com (Tony Albers)
Date: Thu, 13 Apr 2023 06:28:27 +0200
Subject: [squid-users] forward/reverse proxying with TLS.
In-Reply-To: <ae7cb8b2-2faf-6d52-b6e3-6be21e74fda3@measurement-factory.com>
References: <d73afef4-5a4a-e1e6-b518-763006014cab@gmx.com>
 <ae7cb8b2-2faf-6d52-b6e3-6be21e74fda3@measurement-factory.com>
Message-ID: <5f698eac-b2cb-2daf-a5c0-2e3f5255cd56@gmx.com>

Hi Alex,

Thanks for your answer. Too bad that squid can't do what I want.

Can you think of another way of doing this, or do you know of another 
tool that can?

Thanks,

/tony

On 12/04/2023 15:55, Alex Rousskov wrote:
> On 4/12/23 07:48, Tony Albers wrote:
>
>> What I want to do is "hide" an application behind squid, so that the 
>> application receives http traffic, and sends http traffic. This 
>> traffic then goes through squid in both directions, so that squid 
>> receives https on the external IP and forwards it to the application 
>> which is listening on the loopback interface, and squid receives 
>> outgoing traffic from the application on the loopback interface and 
>> then sends it out over the external IP with https.
>
>> Kinda like so:
>> Incoming: exthost1(HTTPS)->thishostname:443-> squid 
>> ->127.0.0.1(HTTP)->127.0.0.1:1080
>>
>> Outgoing: 127.0.0.1(HTTP)->127.0.0.1:8080-> squid
>> ->exthost2:443(HTTPS)
>
>> when I use squid as outgoing proxy, the server in the other 
>> end(88.24.12.40) says that squid doesn't present a client certificate
>> and drops the connection.
>
> It looks like you are trying to force Squid to encrypt traffic by 
> using tls_outgoing_options. Squid cannot be forced to encrypt. Squid 
> encrypts if it needs to communicate with a TLS origin server or 
> cache_peer and does not encrypt otherwise. The tls_outgoing_options 
> directive is consulted _if_ Squid encrypts; it cannot _force_ encryption.
>
> There are two primary use cases where Squid should encrypt traffic on 
> behalf of an HTTP application:
>
> 1. The application, when configured to use a proxy at http_port, sends 
> Squid HTTP requests that have an "https" URL scheme. This is often 
> referred to as "GET https" use case. Very few applications (i.e. HTTP 
> user agents) do that, unfortunately.
>
> 2. The application, when configured to use a proxy at http_port, sends 
> Squid HTTP requests that have an "http" URL scheme, and Squid is 
> configured to forward those HTTP requests to one (or a few) 
> cache_peers, each configured with "tls" and "originserver" options. 
> This use case is applicable only if the application communicates with 
> a few origin servers, and you know all those origin servers in advance 
> (so that you can create a matching cache_peer configuration for each 
> of them).
>
> If your use case is #2, then you need to adjust your cache_peer 
> directive to make that cache_peer a TLS peer (with appropriate client 
> certificates).
>
>
> N.B. Your http_access rules may benefit from a refactoring that makes 
> each rule specific to the listening port that needs access protection. 
> For example, do not allow exthost traffic on http_port... Similar 
> "everything everywhere" problem may exist for your cache_peer access 
> rules: Those rules should deny peering for traffic received on 
> https_port AFAICT.
>
>
> HTH,
>
> Alex.
>
>
>
>> I have the application running in a container on the host.
>> On the same host I also have squid installed.
>>
>> The application listens on 127.0.0.1:1080 on HOST
>> Squid is set up as a reverse proxy, listening to https on the 
>> external if on HOST:443 and forwards everything as http to 
>> 127.0.0.1:1080
>> (this works fine)
>>
>> When the application then transmits something via http, it uses 
>> localhost:8080 as proxy, where squid picks it up and then forwards it 
>> as https.
>> (this doesn't work)
>>
>> At least that#s what I want it to do..
>>
>> However, when I use squid as outgoing proxy, the server in the other 
>> end(88.24.12.40) says that squid doesn't present a client certificate 
>> and drops the connection.
>>
>> But I got the impression that tls_outgoing_options is for exactly 
>> that.. Have I misunderstood something?
>>
>>
>> My squid config looks like this:
>>
>> # prefer DNS over IPv4
>> dns_v4_first on
>>
>> # define hosts/networks that we use
>> acl exthost src 88.24.12.60/32
>> acl inthosts src 172.27.2.0/24
>> acl internal src 127.0.0.1/32
>>
>> # access lists
>> http_access allow exthost
>> http_access allow inthosts
>> http_access allow internal
>>
>> # reverse SSL proxy converting to noSSL
>> https_port 172.27.2.118:443 accel
>> tls-cert=/etc/squid/certs/thishostname.crt
>> tls-key=/etc/squid/keys/thishostname-privkey.pem
>> defaultsite=thishostname
>> cache_peer 127.0.0.1 parent 1080 0 no-query proxy-only originserver 
>> name=thishostname
>>
>> # forward proxy converting to SSL
>> http_port 127.0.0.1:8080
>> acl extnet dstdomain -n .somedomain.dk
>> acl extip dstdomain 88.24.12.40
>> acl intip dstdomain -n .someotherdomain.dk
>> url_rewrite_program /etc/squid/urlrewrite.py
>> tls_outgoing_options cert=/etc/squid/certs/thishostname.crt
>> tls_outgoing_options key=/etc/squid/keys/thishostname-privkey.pem
>> tls_outgoing_options cafile=/etc/squid/certs/thishostnameCA.pem
>> tls_outgoing_options capath=/etc/ssl/certs
>> tls_outgoing_options domain=somedomain.dk
>> never_direct deny extnet
>> never_direct deny extip
>> never_direct allow all
>>
>> cache_peer_access thishostname allow exthosts
>> cache_peer_access thishostname allow inthosts
>> cache_peer_access thishostname allow internal
>> cache_peer_access thishostname deny all
>>
>> # disable local caching
>> cache deny all
>
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users



From tony.albers at gmx.com  Thu Apr 13 05:01:24 2023
From: tony.albers at gmx.com (Tony Albers)
Date: Thu, 13 Apr 2023 07:01:24 +0200
Subject: [squid-users] forward/reverse proxying with TLS.
In-Reply-To: <5f698eac-b2cb-2daf-a5c0-2e3f5255cd56@gmx.com>
References: <d73afef4-5a4a-e1e6-b518-763006014cab@gmx.com>
 <ae7cb8b2-2faf-6d52-b6e3-6be21e74fda3@measurement-factory.com>
 <5f698eac-b2cb-2daf-a5c0-2e3f5255cd56@gmx.com>
Message-ID: <156a5b93-e4ee-a47c-ee46-710f37a3034d@gmx.com>

No, wait..

I think I'm actually in a position where use case #2 is relevant.

I know the origin server, actually there is only this single one.

I'll give it a try.

Thanks

On 13/04/2023 06:28, Tony Albers wrote:
> Hi Alex,
>
> Thanks for your answer. Too bad that squid can't do what I want.
>
> Can you think of another way of doing this, or do you know of another 
> tool that can?
>
> Thanks,
>
> /tony
>
> On 12/04/2023 15:55, Alex Rousskov wrote:
>> On 4/12/23 07:48, Tony Albers wrote:
>>
>>> What I want to do is "hide" an application behind squid, so that the 
>>> application receives http traffic, and sends http traffic. This 
>>> traffic then goes through squid in both directions, so that squid 
>>> receives https on the external IP and forwards it to the application 
>>> which is listening on the loopback interface, and squid receives 
>>> outgoing traffic from the application on the loopback interface and 
>>> then sends it out over the external IP with https.
>>
>>> Kinda like so:
>>> Incoming: exthost1(HTTPS)->thishostname:443-> squid 
>>> ->127.0.0.1(HTTP)->127.0.0.1:1080
>>>
>>> Outgoing: 127.0.0.1(HTTP)->127.0.0.1:8080-> squid
>>> ->exthost2:443(HTTPS)
>>
>>> when I use squid as outgoing proxy, the server in the other 
>>> end(88.24.12.40) says that squid doesn't present a client certificate
>>> and drops the connection.
>>
>> It looks like you are trying to force Squid to encrypt traffic by 
>> using tls_outgoing_options. Squid cannot be forced to encrypt. Squid 
>> encrypts if it needs to communicate with a TLS origin server or 
>> cache_peer and does not encrypt otherwise. The tls_outgoing_options 
>> directive is consulted _if_ Squid encrypts; it cannot _force_ 
>> encryption.
>>
>> There are two primary use cases where Squid should encrypt traffic on 
>> behalf of an HTTP application:
>>
>> 1. The application, when configured to use a proxy at http_port, 
>> sends Squid HTTP requests that have an "https" URL scheme. This is 
>> often referred to as "GET https" use case. Very few applications 
>> (i.e. HTTP user agents) do that, unfortunately.
>>
>> 2. The application, when configured to use a proxy at http_port, 
>> sends Squid HTTP requests that have an "http" URL scheme, and Squid 
>> is configured to forward those HTTP requests to one (or a few) 
>> cache_peers, each configured with "tls" and "originserver" options. 
>> This use case is applicable only if the application communicates with 
>> a few origin servers, and you know all those origin servers in 
>> advance (so that you can create a matching cache_peer configuration 
>> for each of them).
>>
>> If your use case is #2, then you need to adjust your cache_peer 
>> directive to make that cache_peer a TLS peer (with appropriate client 
>> certificates).
>>
>>
>> N.B. Your http_access rules may benefit from a refactoring that makes 
>> each rule specific to the listening port that needs access 
>> protection. For example, do not allow exthost traffic on http_port... 
>> Similar "everything everywhere" problem may exist for your cache_peer 
>> access rules: Those rules should deny peering for traffic received on 
>> https_port AFAICT.
>>
>>
>> HTH,
>>
>> Alex.
>>
>>
>>
>>> I have the application running in a container on the host.
>>> On the same host I also have squid installed.
>>>
>>> The application listens on 127.0.0.1:1080 on HOST
>>> Squid is set up as a reverse proxy, listening to https on the 
>>> external if on HOST:443 and forwards everything as http to 
>>> 127.0.0.1:1080
>>> (this works fine)
>>>
>>> When the application then transmits something via http, it uses 
>>> localhost:8080 as proxy, where squid picks it up and then forwards 
>>> it as https.
>>> (this doesn't work)
>>>
>>> At least that#s what I want it to do..
>>>
>>> However, when I use squid as outgoing proxy, the server in the other 
>>> end(88.24.12.40) says that squid doesn't present a client 
>>> certificate and drops the connection.
>>>
>>> But I got the impression that tls_outgoing_options is for exactly 
>>> that.. Have I misunderstood something?
>>>
>>>
>>> My squid config looks like this:
>>>
>>> # prefer DNS over IPv4
>>> dns_v4_first on
>>>
>>> # define hosts/networks that we use
>>> acl exthost src 88.24.12.60/32
>>> acl inthosts src 172.27.2.0/24
>>> acl internal src 127.0.0.1/32
>>>
>>> # access lists
>>> http_access allow exthost
>>> http_access allow inthosts
>>> http_access allow internal
>>>
>>> # reverse SSL proxy converting to noSSL
>>> https_port 172.27.2.118:443 accel
>>> tls-cert=/etc/squid/certs/thishostname.crt
>>> tls-key=/etc/squid/keys/thishostname-privkey.pem
>>> defaultsite=thishostname
>>> cache_peer 127.0.0.1 parent 1080 0 no-query proxy-only originserver 
>>> name=thishostname
>>>
>>> # forward proxy converting to SSL
>>> http_port 127.0.0.1:8080
>>> acl extnet dstdomain -n .somedomain.dk
>>> acl extip dstdomain 88.24.12.40
>>> acl intip dstdomain -n .someotherdomain.dk
>>> url_rewrite_program /etc/squid/urlrewrite.py
>>> tls_outgoing_options cert=/etc/squid/certs/thishostname.crt
>>> tls_outgoing_options key=/etc/squid/keys/thishostname-privkey.pem
>>> tls_outgoing_options cafile=/etc/squid/certs/thishostnameCA.pem
>>> tls_outgoing_options capath=/etc/ssl/certs
>>> tls_outgoing_options domain=somedomain.dk
>>> never_direct deny extnet
>>> never_direct deny extip
>>> never_direct allow all
>>>
>>> cache_peer_access thishostname allow exthosts
>>> cache_peer_access thishostname allow inthosts
>>> cache_peer_access thishostname allow internal
>>> cache_peer_access thishostname deny all
>>>
>>> # disable local caching
>>> cache deny all
>>
>> _______________________________________________
>> squid-users mailing list
>> squid-users at lists.squid-cache.org
>> http://lists.squid-cache.org/listinfo/squid-users
>
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users



From andre.bolinhas at articatech.com  Fri Apr 14 01:23:37 2023
From: andre.bolinhas at articatech.com (andre.bolinhas at articatech.com)
Date: Fri, 14 Apr 2023 02:23:37 +0100
Subject: [squid-users] Help to understand tcp_denied in access.log
Message-ID: <!&!AAAAAAAAAAAuAAAAAAAAAIVNjRjcTGZElYgADq7oyvYBAMO2jhD3dRHOtM0AqgC7tuYAAAAAAA4AABAAAABqbjq3ZhD5TJN5sGxH+spsAQAAAAA=@articatech.com>

Hi
I'm seeing to many requests to website mainnet.infura.io, by analyzing the
access.log seams that the website is blocked but I also notice that the
request is consuming bandwidth, here a example
Squid access.log format.
%ts.%03tu %6tr %>a %Ss/%03>Hs %<st %rm %ru %[un %Sh/%<a:%<p %mt mac="%>eui"
%note ua="%{User-Agent}>h" exterr="%err_code|%err_detail"

Access.log request.
1681099742.517     35 10.81.216.114 TCP_DENIED_ABORTED/407 41154 CONNECT
mainnet.infura.io:443 - HIER_NONE/-:- text/html mac="00:00:00:00:00:00"
category:%20143%0D%0Acategory-name:%20Trackers%0D%0Aclog:%20cinfo:143-Tracke
rs;%0D%0A ua="Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7)
AppleWebKit/537.36 (KHTML, like Gecko) Chrome/111.0.0.0 Safari/537.36"
exterr="ERR_CACHE_ACCESS_DENIED|-"

1681099742.575     41 10.81.216.114 TCP_DENIED/407 511819 CONNECT
mainnet.infura.io:443 - HIER_NONE/-:- text/html mac="00:00:00:00:00:00"
category:%20143%0D%0Acategory-name:%20Trackers%0D%0Aclog:%20cinfo:143-Tracke
rs;%0D%0A ua="Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7)
AppleWebKit/537.36 (KHTML, like Gecko) Chrome/111.0.0.0 Safari/537.36"
exterr="ERR_CACHE_ACCESS_DENIED|-"

1681099742.664     73 10.81.216.114 NONE/200 0 CONNECT mainnet.infura.io:443
HLBHO/tsyafiq HIER_NONE/-:- - mac="00:00:00:00:00:00"
category:%20143%0D%0Acategory-name:%20Trackers%0D%0Aclog:%20cinfo:143-Tracke
rs;%0D%0Auser:%20HLBHO/tsyafiq%0D%0A ua="Mozilla/5.0 (Macintosh; Intel Mac
OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/111.0.0.0
Safari/537.36" exterr="-|-"

1681099742.685     20 10.81.216.114 TCP_DENIED_ABORTED/403 450655 CONNECT
mainnet.infura.io:443 HLBHO/tsyafiq HIER_NONE/-:- text/html
mac="00:00:00:00:00:00"
category:%20143%0D%0Acategory-name:%20Trackers%0D%0Aclog:%20cinfo:143-Tracke
rs;%0D%0Auser:%20HLBHO/tsyafiq%0D%0A ua="-" exterr="ERR_ACCESS_DENIED|-"

Each TCP_DENIED request is consuming 400000+ bytes so at the end of the day
sometimes I have a total of 56k request to mainnet.infura.io consuming
around 15GB of bandwidth.

My question is, assuming that %<st is the total size of reply, why
TCP_DENIED is taking a lot of bandwidth to block a website?

Best regards






From rousskov at measurement-factory.com  Fri Apr 14 03:01:28 2023
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Thu, 13 Apr 2023 23:01:28 -0400
Subject: [squid-users] Help to understand tcp_denied in access.log
In-Reply-To: <!&!AAAAAAAAAAAuAAAAAAAAAIVNjRjcTGZElYgADq7oyvYBAMO2jhD3dRHOtM0AqgC7tuYAAAAAAA4AABAAAABqbjq3ZhD5TJN5sGxH+spsAQAAAAA=@articatech.com>
References: <!&!AAAAAAAAAAAuAAAAAAAAAIVNjRjcTGZElYgADq7oyvYBAMO2jhD3dRHOtM0AqgC7tuYAAAAAAA4AABAAAABqbjq3ZhD5TJN5sGxH+spsAQAAAAA=@articatech.com>
Message-ID: <8ccdde6a-fddb-e5aa-ee90-26d1bb6fc4d7@measurement-factory.com>

On 4/13/23 21:23, andre.bolinhas at articatech.com wrote:

> I'm seeing to many requests to website mainnet.infura.io, by analyzing the
> access.log seams that the website is blocked 

Which directive/mechanism blocks them (e.g., http_access, 
reply_body_max_size, ICAP/eCAP, etc.)?


> Each TCP_DENIED request is consuming 400000+ bytes 

Assuming you do not use huge custom TCP_DENIED error pages, I agree that 
these entries look suspicious, as if Squid denied access but continued 
to tunnel the traffic. The response times are fairly small, but probably 
large enough to transmit those amounts of data from a fast server.

Since most requests (for the affected domain) are problematic, can you 
collect a packet trace and see if you can confirm that these 
transactions transmit a lot of data from Squid to the client? If IPs are 
not enough, logging client TCP port (%>p) may help you match specific 
access.log entries with TCP connections in the packet trace...


What Squid version are you using for this? Does SslBump affect the 
problematic transactions?


Thank you,

Alex.



> but I also notice that the
> request is consuming bandwidth, here a example
> Squid access.log format.
> %ts.%03tu %6tr %>a %Ss/%03>Hs %<st %rm %ru %[un %Sh/%<a:%<p %mt mac="%>eui"
> %note ua="%{User-Agent}>h" exterr="%err_code|%err_detail"
> 
> Access.log request.
> 1681099742.517     35 10.81.216.114 TCP_DENIED_ABORTED/407 41154 CONNECT
> mainnet.infura.io:443 - HIER_NONE/-:- text/html mac="00:00:00:00:00:00"
> category:%20143%0D%0Acategory-name:%20Trackers%0D%0Aclog:%20cinfo:143-Tracke
> rs;%0D%0A ua="Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7)
> AppleWebKit/537.36 (KHTML, like Gecko) Chrome/111.0.0.0 Safari/537.36"
> exterr="ERR_CACHE_ACCESS_DENIED|-"
> 
> 1681099742.575     41 10.81.216.114 TCP_DENIED/407 511819 CONNECT
> mainnet.infura.io:443 - HIER_NONE/-:- text/html mac="00:00:00:00:00:00"
> category:%20143%0D%0Acategory-name:%20Trackers%0D%0Aclog:%20cinfo:143-Tracke
> rs;%0D%0A ua="Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7)
> AppleWebKit/537.36 (KHTML, like Gecko) Chrome/111.0.0.0 Safari/537.36"
> exterr="ERR_CACHE_ACCESS_DENIED|-"
> 
> 1681099742.664     73 10.81.216.114 NONE/200 0 CONNECT mainnet.infura.io:443
> HLBHO/tsyafiq HIER_NONE/-:- - mac="00:00:00:00:00:00"
> category:%20143%0D%0Acategory-name:%20Trackers%0D%0Aclog:%20cinfo:143-Tracke
> rs;%0D%0Auser:%20HLBHO/tsyafiq%0D%0A ua="Mozilla/5.0 (Macintosh; Intel Mac
> OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/111.0.0.0
> Safari/537.36" exterr="-|-"
> 
> 1681099742.685     20 10.81.216.114 TCP_DENIED_ABORTED/403 450655 CONNECT
> mainnet.infura.io:443 HLBHO/tsyafiq HIER_NONE/-:- text/html
> mac="00:00:00:00:00:00"
> category:%20143%0D%0Acategory-name:%20Trackers%0D%0Aclog:%20cinfo:143-Tracke
> rs;%0D%0Auser:%20HLBHO/tsyafiq%0D%0A ua="-" exterr="ERR_ACCESS_DENIED|-"
> 
> Each TCP_DENIED request is consuming 400000+ bytes so at the end of the day
> sometimes I have a total of 56k request to mainnet.infura.io consuming
> around 15GB of bandwidth.
> 
> My question is, assuming that %<st is the total size of reply, why
> TCP_DENIED is taking a lot of bandwidth to block a website?
> 
> Best regards
> 
> 
> 
> 
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users



From wbx at openadk.org  Fri Apr 14 09:29:48 2023
From: wbx at openadk.org (Waldemar Brodkorb)
Date: Fri, 14 Apr 2023 11:29:48 +0200
Subject: [squid-users] logging: TCP connection to x.x.x.x/3128 failed
In-Reply-To: <77671299-a89e-a5c4-e79e-799ee5f49248@measurement-factory.com>
References: <ZCV5SBq85hDNEyzv@waldemar-brodkorb.de>
 <583fc758-1b73-877a-4d67-303c69d7fbf0@measurement-factory.com>
 <ZC6hxX5zyPd5inz8@waldemar-brodkorb.de>
 <77671299-a89e-a5c4-e79e-799ee5f49248@measurement-factory.com>
Message-ID: <ZDkdDLHlDU0APBp5@waldemar-brodkorb.de>

Hi Alex,
Alex Rousskov wrote,

> On 4/6/23 06:41, Waldemar Brodkorb wrote:
> 
> > There is still one assertion which happens sometimes:
> > cache.log:2023/04/06 07:24:48 kid1| assertion failed: ../src/base/CbcPointer.h:181: "EX"
> > 
> > Have you ever seen this in the wild? What does it mean?
> 
> This low-level assertion (where "EX" is usually spelled as "c") corresponds
> to many high-level Squid bugs, most of them fixed. Please see
> https://bugs.squid-cache.org/show_bug.cgi?id=5265#c1 for the suggested next
> steps.

We have a core dump now. Ubuntu 22.04 with Squid 5.8.

gdb /usr/sbin/squid core.13.873301.1681462147 
GNU gdb (Ubuntu 12.1-0ubuntu1~22.04) 12.1
Copyright (C) 2022 Free Software Foundation, Inc.                                                                                                                                                                   
License GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html>                                                                                                                                       
This is free software: you are free to change and redistribute it.                                                                                                                                                  
There is NO WARRANTY, to the extent permitted by law.                                                                                                                                                               
Type "show copying" and "show warranty" for details.                                                                                                                                                                
This GDB was configured as "x86_64-linux-gnu".                                                                                                                                                                      
Type "show configuration" for configuration details.                                                                                                                                                                
For bug reporting instructions, please see:                                                                                                                                                                         
<https://www.gnu.org/software/gdb/bugs/>.                                                                                                                                                                           
Find the GDB manual and other documentation resources online at:                                                                                                                                                    
    <http://www.gnu.org/software/gdb/documentation/>.                                                                                                                                                               

For help, type "help".                                                                                                                                                  
Type "apropos word" to search for commands related to "word"...                                                                                                                                                     
Reading symbols from /usr/sbin/squid...                                                                                                                                                                             
Reading symbols from /usr/lib/debug/.build-id/4d/655715326bdce358de6a95a564b6e4e                                                                                                                                    ec84d5e.debug...                                                                                                                                                                                                    
[New LWP 873301]                                                                                                                                
[Thread debugging using libthread_db enabled]                                                                                                                                                                       
Using host libthread_db library "/lib/x86_64-linux-gnu/libthread_db.so.1".                                                                                                                                          
Core was generated by `(squid-1) --kid squid-1 --foreground -sYC'.                                                                                                                                                  
Program terminated with signal SIGABRT, Aborted.                                                                                                                                                                    
--Type <RET> for more, q to quit, c to continue without paging--                                                                                                                                                    
#0  __pthread_kill_implementation (no_tid=0, signo=6, threadid=140419666299392)                                                                                                                                     
    at ./nptl/pthread_kill.c:44                                                                                                                                                                             
44      ./nptl/pthread_kill.c: No such file or directory.                                                                                                                                                           
(gdb) bt full                                                                                                                       
#0  __pthread_kill_implementation (no_tid=0, signo=6, threadid=140419666299392)                                                                                                                                     
    at ./nptl/pthread_kill.c:44                                                                                                                                                                             
        tid = <optimized out>                                                                                                                                                                       
        ret = 0                                                                                                                             
        pd = 0x7fb600544a00                                                                                                                                                                 
        old_mask = {__val = {94534848520128, 94535132367528, 94533992246864,                                                                                                                                        
            94532923700193, 94532920519424, 94532966275696, 94533267707520,                                                                                                                                         
            140419709921070, 94534848520128, 0, 140723926211296,                                                                                                                                                    
            94532958412936, 0, 8, 26902275, 140419709808628}}                                                                                                                                                       
        ret = <optimized out>                                                                                                                                                                       
        pd = <optimized out>                                                                                                                                                                    
        old_mask = <optimized out>                                                                                                                                                                                  
        ret = <optimized out>                                                                                                                                                                       
        tid = <optimized out>                                                                                                                                                                       
        ret = <optimized out>                                                                                                                                                                       
        resultvar = <optimized out>                                                                                                                                                                                 
        resultvar = <optimized out>                                                                                                                                                                                 
        __arg3 = <optimized out>                                                                                                                                                                                
        __arg2 = <optimized out>                                                                                                                                                                                
        __arg1 = <optimized out>                                                                                                                                                                                
        _a3 = <optimized out>                                                                                                                                                                       
        _a2 = <optimized out>
        _a1 = <optimized out>                                                                                                                                                                       
--Type <RET> for more, q to quit, c to continue without paging--                                                                                                                                                    
        __futex = <optimized out>                                                                                                                                                                                   
        resultvar = <optimized out>                                                                                                                                                                                 
        __arg3 = <optimized out>                                                                                                                                                                                
        __arg2 = <optimized out>                                                                                                                                                                                
        __arg1 = <optimized out>                                                                                                                                                                                
        _a3 = <optimized out>                                                                                                                                                                       
        _a2 = <optimized out>                                                                                                                                                                       
        _a1 = <optimized out>                                                                                                                                                                       
        __futex = <optimized out>                                                                                                                                                                                   
        __private = <optimized out>                                                                                                                                                                                 
        __oldval = <optimized out>                                                                                                                                                                                  
        result = <optimized out>                                                                                                                                                                                
#1  __pthread_kill_internal (signo=6, threadid=140419666299392)                                                                                                                                                     
    at ./nptl/pthread_kill.c:78                                                                                                                                                                             
No locals.                                                                                                              
#2  __GI___pthread_kill (threadid=140419666299392, signo=signo at entry=6)                                                                                                                                             
    at ./nptl/pthread_kill.c:89                                                                                                                                                                             
No locals.                                                                                                              

#3  0x00007fb602aa7476 in __GI_raise (sig=sig at entry=6)                                                                                                                                                              
    at ../sysdeps/posix/raise.c:26                                                                                                                                                                                  
        ret = <optimized out>                                                                                                                                                                       
#4  0x00007fb602a8d7f3 in __GI_abort () at ./stdlib/abort.c:79                                                                                                                                                      
        save_stage = 1                                                                                                                                                  
--Type <RET> for more, q to quit, c to continue without paging--
        act = {__sigaction_handler = {sa_handler = 0x55fa2959746f,                                                                                                                                                  
            sa_sigaction = 0x55fa2959746f}, sa_mask = {__val = {                                                                                                                                                    
              18446744073709551288, 11, 140723926211456, 94532958412928, 181,                                                                                                                                       
              94532923913327, 140419705906387, 140723926211472,                                                                                                                                                     
              140723926211456, 94532958412928, 94532925905808,                                                                                                                                                      
              140723926211472, 94532920570578, 94533607213200, 99, 99}},                                                                                                                                            
          sa_flags = 1335251568, sa_restorer = 0x55fa2959746f}                                                                                                                                                      
        sigs = {__val = {32, 0, 94533607213200, 6, 99, 140723926211136,                                                                                                                                             
            94532958413328, 0, 99, 16762180390345294848, 94532958413040,                                                                                                                                            
            140723926211456, 0, 94532958413328, 99, 16762180390345294848}}                                                                                                                                          
#5  0x000055fa29124e55 in xassert (msg=<optimized out>, file=<optimized out>,                                                                                                                                       
    line=<optimized out>) at ./src/debug.cc:624                                                                                                                                                                     
        __FUNCTION__ = <optimized out>                                                                                                                                                                              
#6  0x000055fa29118734 in CbcPointer<BodyProducer>::operator-> (                                                                                                                                                    
    this=<optimized out>) at ../src/base/CbcPointer.h:181                                                                                                                                                           
        c = <optimized out>                                                                                                                                                                 
#7  CbcPointer<BodyConsumer>::operator-> (this=<optimized out>)                                                                                                                                                     
    at ../src/base/CbcPointer.h:178                                                                                                                                                                                 
        c = <optimized out>                                                                                                                                                                 
        c = <optimized out>                                                                                                                                                                 
#8  JobDialer<BodyConsumer>::dial (call=..., this=<optimized out>)                                                                                                                                                  
    at base/AsyncJobCalls.h:182                                                                                                                                                                             
        __FUNCTION__ = <optimized out>                                                                                                                                                                              
--Type <RET> for more, q to quit, c to continue without paging--
#9  AsyncCallT<BodyConsumerDialer>::fire (this=0x55fa4f965270)                                                                                                                                                      
    at ../src/base/AsyncCall.h:145                                                                                                                                                                                  
No locals.                                                                                                              
#10 0x000055fa293cfaab in AsyncCallQueue::fireNext (this=<optimized out>)                                                                                                                                           
    at base/../../src/base/RefCount.h:73                                                                                                                                                                            
        call = {p_ = 0x55fa4f965270}                                                                                                                                                                                
        __FUNCTION__ = <optimized out>
#11 0x000055fa293d189a in AsyncCallQueue::fire (this=0x55fa2b930a20)
    at base/AsyncCallQueue.cc:43
        made = true
#12 0x000055fa291ad500 in EventLoop::dispatchCalls (this=0x7ffcd7a21ef0)
    at ./src/EventLoop.cc:144
        dispatchedSome = <optimized out>
#13 EventLoop::runOnce (this=0x7ffcd7a21ef0) at ./src/EventLoop.cc:121
        sawActivity = <optimized out>
        waitingEngine = 0x7ffcd7a21e30
        __FUNCTION__ = <optimized out>
#14 0x000055fa292b5f10 in EventLoop::run (this=0x7ffcd7a21ef0)
    at ./src/EventLoop.cc:83
No locals.
#15 SquidMain (argc=<optimized out>, argv=<optimized out>)
    at ./src/main.cc:1719
        cmdLine = {argv_ = std::vector of length 6, capacity 6 = {
--Type <RET> for more, q to quit, c to continue without paging--
            0x55fa29977220 "(squid-1)", 0x55fa299772e0 "--kid", 
            0x55fa299773a0 "squid-1", 0x55fa29977460 "--foreground", 
            0x55fa29977520 "-sYC", 0x0}, 
          shortOptions_ = 0x55fa299a2450 "CDFNRSYXa:d:f:hk:m::n:sl:u:vz?", 
          longOptions_ = std::vector of length 5, capacity 8 = {{<option> = {
                name = 0x55fa29977cc0 "foreground", has_arg = 0, flag = 0x0, 
                val = 2}, <No data fields>}, {<option> = {
                name = 0x55fa299778e0 "kid", has_arg = 1, flag = 0x0, 
                val = 3}, <No data fields>}, {<option> = {
                name = 0x55fa299779a0 "help", has_arg = 0, flag = 0x0, 
                val = 104}, <No data fields>}, {<option> = {
                name = 0x55fa29977a80 "version", has_arg = 0, flag = 0x0, 
                val = 118}, <No data fields>}, {<option> = {name = 0x0, 
                has_arg = 0, flag = 0x0, val = 0}, <No data fields>}}}
        WIN32_init_err = 0
        mainLoop = {errcount = 0, static Running = 0x7ffcd7a21ef0, 
          last_loop = false, engines = std::vector of length 4, capacity 4 = {
            0x7ffcd7a21e70, 0x55fa296e8fd0 <EventScheduler::_instance>, 
            0x7ffcd7a21e50, 0x7ffcd7a21e30}, timeService = 0x7ffcd7a21da8, 
          primaryEngine = 0x7ffcd7a21e30, loop_delay = 0, error = false, 
          runOnceResult = false}
        signalEngine = {<AsyncEngine> = {
            _vptr.AsyncEngine = 0x55fa296e1e50 <vtable for SignalEngine+16>}, <N--Type <RET> for more, q to quit, c to continue without paging--
o data fields>}
        store_engine = {<AsyncEngine> = {
            _vptr.AsyncEngine = 0x55fa296c8310 <vtable for StoreRootEngine+16>}, <No data fields>}
        comm_engine = {<AsyncEngine> = {
            _vptr.AsyncEngine = 0x55fa296e1e28 <vtable for CommSelectEngine+16>}, <No data fields>}
        time_engine = {
          _vptr.TimeEngine = 0x55fa296e2480 <vtable for TimeEngine+16>}
        __FUNCTION__ = <optimized out>
#16 0x000055fa291524e6 in SquidMainSafe (argv=0x7ffcd7a22208, argc=5)
    at ./src/main.cc:1406
        __FUNCTION__ = <optimized out>
#17 main (argc=5, argv=0x7ffcd7a22208) at ./src/main.cc:1394
No locals.
(gdb) 

Do you can see where the bug is?

best regards
 Waldemar


From andre.bolinhas at articatech.com  Fri Apr 14 10:36:07 2023
From: andre.bolinhas at articatech.com (andre.bolinhas at articatech.com)
Date: Fri, 14 Apr 2023 11:36:07 +0100
Subject: [squid-users] Help to understand tcp_denied in access.log
In-Reply-To: <8ccdde6a-fddb-e5aa-ee90-26d1bb6fc4d7@measurement-factory.com>
References: <!&!AAAAAAAAAAAuAAAAAAAAAIVNjRjcTGZElYgADq7oyvYBAMO2jhD3dRHOtM0AqgC7tuYAAAAAAA4AABAAAABqbjq3ZhD5TJN5sGxH+spsAQAAAAA=@articatech.com>
 <8ccdde6a-fddb-e5aa-ee90-26d1bb6fc4d7@measurement-factory.com>
Message-ID: <!&!AAAAAAAAAAAuAAAAAAAAAIVNjRjcTGZElYgADq7oyvYBAMO2jhD3dRHOtM0AqgC7tuYAAAAAAA4AABAAAACun8EO5DWHSKeMxm9DSfyzAQAAAAA=@articatech.com>

Hi Alex,
The mechanism is http_access, the size of error page is around 500kb.
The squid version is 5.8 and I'm not doing ssl bump for this domain.
When you ask to " collect a packet trace" is put squid in debug mode? Squid
-k debug?
Best regards

-----Mensagem original-----
De: squid-users <squid-users-bounces at lists.squid-cache.org> Em Nome De Alex
Rousskov
Enviada: 14 de abril de 2023 04:01
Para: squid-users at lists.squid-cache.org
Assunto: Re: [squid-users] Help to understand tcp_denied in access.log

On 4/13/23 21:23, andre.bolinhas at articatech.com wrote:

> I'm seeing to many requests to website mainnet.infura.io, by analyzing 
> the access.log seams that the website is blocked

Which directive/mechanism blocks them (e.g., http_access,
reply_body_max_size, ICAP/eCAP, etc.)?


> Each TCP_DENIED request is consuming 400000+ bytes 

Assuming you do not use huge custom TCP_DENIED error pages, I agree that 
these entries look suspicious, as if Squid denied access but continued 
to tunnel the traffic. The response times are fairly small, but probably 
large enough to transmit those amounts of data from a fast server.

Since most requests (for the affected domain) are problematic, can you 
collect a packet trace and see if you can confirm that these 
transactions transmit a lot of data from Squid to the client? If IPs are 
not enough, logging client TCP port (%>p) may help you match specific 
access.log entries with TCP connections in the packet trace...


What Squid version are you using for this? Does SslBump affect the 
problematic transactions?


Thank you,

Alex.



> but I also notice that the
> request is consuming bandwidth, here a example
> Squid access.log format.
> %ts.%03tu %6tr %>a %Ss/%03>Hs %<st %rm %ru %[un %Sh/%<a:%<p %mt
mac="%>eui"
> %note ua="%{User-Agent}>h" exterr="%err_code|%err_detail"
> 
> Access.log request.
> 1681099742.517     35 10.81.216.114 TCP_DENIED_ABORTED/407 41154 CONNECT
> mainnet.infura.io:443 - HIER_NONE/-:- text/html mac="00:00:00:00:00:00"
>
category:%20143%0D%0Acategory-name:%20Trackers%0D%0Aclog:%20cinfo:143-Tracke
> rs;%0D%0A ua="Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7)
> AppleWebKit/537.36 (KHTML, like Gecko) Chrome/111.0.0.0 Safari/537.36"
> exterr="ERR_CACHE_ACCESS_DENIED|-"
> 
> 1681099742.575     41 10.81.216.114 TCP_DENIED/407 511819 CONNECT
> mainnet.infura.io:443 - HIER_NONE/-:- text/html mac="00:00:00:00:00:00"
>
category:%20143%0D%0Acategory-name:%20Trackers%0D%0Aclog:%20cinfo:143-Tracke
> rs;%0D%0A ua="Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7)
> AppleWebKit/537.36 (KHTML, like Gecko) Chrome/111.0.0.0 Safari/537.36"
> exterr="ERR_CACHE_ACCESS_DENIED|-"
> 
> 1681099742.664     73 10.81.216.114 NONE/200 0 CONNECT
mainnet.infura.io:443
> HLBHO/tsyafiq HIER_NONE/-:- - mac="00:00:00:00:00:00"
>
category:%20143%0D%0Acategory-name:%20Trackers%0D%0Aclog:%20cinfo:143-Tracke
> rs;%0D%0Auser:%20HLBHO/tsyafiq%0D%0A ua="Mozilla/5.0 (Macintosh; Intel Mac
> OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/111.0.0.0
> Safari/537.36" exterr="-|-"
> 
> 1681099742.685     20 10.81.216.114 TCP_DENIED_ABORTED/403 450655 CONNECT
> mainnet.infura.io:443 HLBHO/tsyafiq HIER_NONE/-:- text/html
> mac="00:00:00:00:00:00"
>
category:%20143%0D%0Acategory-name:%20Trackers%0D%0Aclog:%20cinfo:143-Tracke
> rs;%0D%0Auser:%20HLBHO/tsyafiq%0D%0A ua="-" exterr="ERR_ACCESS_DENIED|-"
> 
> Each TCP_DENIED request is consuming 400000+ bytes so at the end of the
day
> sometimes I have a total of 56k request to mainnet.infura.io consuming
> around 15GB of bandwidth.
> 
> My question is, assuming that %<st is the total size of reply, why
> TCP_DENIED is taking a lot of bandwidth to block a website?
> 
> Best regards
> 
> 
> 
> 
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users

_______________________________________________
squid-users mailing list
squid-users at lists.squid-cache.org
http://lists.squid-cache.org/listinfo/squid-users



From rousskov at measurement-factory.com  Fri Apr 14 13:40:34 2023
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Fri, 14 Apr 2023 09:40:34 -0400
Subject: [squid-users] logging: TCP connection to x.x.x.x/3128 failed
In-Reply-To: <ZDkdDLHlDU0APBp5@waldemar-brodkorb.de>
References: <ZCV5SBq85hDNEyzv@waldemar-brodkorb.de>
 <583fc758-1b73-877a-4d67-303c69d7fbf0@measurement-factory.com>
 <ZC6hxX5zyPd5inz8@waldemar-brodkorb.de>
 <77671299-a89e-a5c4-e79e-799ee5f49248@measurement-factory.com>
 <ZDkdDLHlDU0APBp5@waldemar-brodkorb.de>
Message-ID: <cef825ed-fca1-550c-5e17-4acf9bd6caf8@measurement-factory.com>

On 4/14/23 05:29, Waldemar Brodkorb wrote:
>> On 4/6/23 06:41, Waldemar Brodkorb wrote:
>>
>>> There is still one assertion which happens sometimes:
>>> cache.log:2023/04/06 07:24:48 kid1| assertion failed: ../src/base/CbcPointer.h:181: "EX"
>>>
>>> Have you ever seen this in the wild? What does it mean?
>>
>> This low-level assertion (where "EX" is usually spelled as "c") corresponds
>> to many high-level Squid bugs, most of them fixed. Please see
>> https://bugs.squid-cache.org/show_bug.cgi?id=5265#c1 for the suggested next
>> steps.

> We have a core dump now. Ubuntu 22.04 with Squid 5.8.

 > Do you can see where the bug is?

On the surface, the stack trace looks like bug #4981 to me. That bug has 
a workaround for v4. I do not know whether that workaround patch still 
applies to v5, but it is worth trying:
https://bugs.squid-cache.org/show_bug.cgi?id=4981

Please keep us posted.

HTH,

Alex.


> gdb /usr/sbin/squid core.13.873301.1681462147
> GNU gdb (Ubuntu 12.1-0ubuntu1~22.04) 12.1
> Copyright (C) 2022 Free Software Foundation, Inc.
> License GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html>
> This is free software: you are free to change and redistribute it.
> There is NO WARRANTY, to the extent permitted by law.
> Type "show copying" and "show warranty" for details.
> This GDB was configured as "x86_64-linux-gnu".
> Type "show configuration" for configuration details.
> For bug reporting instructions, please see:
> <https://www.gnu.org/software/gdb/bugs/>.
> Find the GDB manual and other documentation resources online at:
>      <http://www.gnu.org/software/gdb/documentation/>.
> 
> For help, type "help".
> Type "apropos word" to search for commands related to "word"...
> Reading symbols from /usr/sbin/squid...
> Reading symbols from /usr/lib/debug/.build-id/4d/655715326bdce358de6a95a564b6e4e                                                                                                                                    ec84d5e.debug...
> [New LWP 873301]
> [Thread debugging using libthread_db enabled]
> Using host libthread_db library "/lib/x86_64-linux-gnu/libthread_db.so.1".
> Core was generated by `(squid-1) --kid squid-1 --foreground -sYC'.
> Program terminated with signal SIGABRT, Aborted.
> --Type <RET> for more, q to quit, c to continue without paging--
> #0  __pthread_kill_implementation (no_tid=0, signo=6, threadid=140419666299392)
>      at ./nptl/pthread_kill.c:44
> 44      ./nptl/pthread_kill.c: No such file or directory.
> (gdb) bt full
> #0  __pthread_kill_implementation (no_tid=0, signo=6, threadid=140419666299392)
>      at ./nptl/pthread_kill.c:44
>          tid = <optimized out>
>          ret = 0
>          pd = 0x7fb600544a00
>          old_mask = {__val = {94534848520128, 94535132367528, 94533992246864,
>              94532923700193, 94532920519424, 94532966275696, 94533267707520,
>              140419709921070, 94534848520128, 0, 140723926211296,
>              94532958412936, 0, 8, 26902275, 140419709808628}}
>          ret = <optimized out>
>          pd = <optimized out>
>          old_mask = <optimized out>
>          ret = <optimized out>
>          tid = <optimized out>
>          ret = <optimized out>
>          resultvar = <optimized out>
>          resultvar = <optimized out>
>          __arg3 = <optimized out>
>          __arg2 = <optimized out>
>          __arg1 = <optimized out>
>          _a3 = <optimized out>
>          _a2 = <optimized out>
>          _a1 = <optimized out>
> --Type <RET> for more, q to quit, c to continue without paging--
>          __futex = <optimized out>
>          resultvar = <optimized out>
>          __arg3 = <optimized out>
>          __arg2 = <optimized out>
>          __arg1 = <optimized out>
>          _a3 = <optimized out>
>          _a2 = <optimized out>
>          _a1 = <optimized out>
>          __futex = <optimized out>
>          __private = <optimized out>
>          __oldval = <optimized out>
>          result = <optimized out>
> #1  __pthread_kill_internal (signo=6, threadid=140419666299392)
>      at ./nptl/pthread_kill.c:78
> No locals.
> #2  __GI___pthread_kill (threadid=140419666299392, signo=signo at entry=6)
>      at ./nptl/pthread_kill.c:89
> No locals.
> 
> #3  0x00007fb602aa7476 in __GI_raise (sig=sig at entry=6)
>      at ../sysdeps/posix/raise.c:26
>          ret = <optimized out>
> #4  0x00007fb602a8d7f3 in __GI_abort () at ./stdlib/abort.c:79
>          save_stage = 1
> --Type <RET> for more, q to quit, c to continue without paging--
>          act = {__sigaction_handler = {sa_handler = 0x55fa2959746f,
>              sa_sigaction = 0x55fa2959746f}, sa_mask = {__val = {
>                18446744073709551288, 11, 140723926211456, 94532958412928, 181,
>                94532923913327, 140419705906387, 140723926211472,
>                140723926211456, 94532958412928, 94532925905808,
>                140723926211472, 94532920570578, 94533607213200, 99, 99}},
>            sa_flags = 1335251568, sa_restorer = 0x55fa2959746f}
>          sigs = {__val = {32, 0, 94533607213200, 6, 99, 140723926211136,
>              94532958413328, 0, 99, 16762180390345294848, 94532958413040,
>              140723926211456, 0, 94532958413328, 99, 16762180390345294848}}
> #5  0x000055fa29124e55 in xassert (msg=<optimized out>, file=<optimized out>,
>      line=<optimized out>) at ./src/debug.cc:624
>          __FUNCTION__ = <optimized out>
> #6  0x000055fa29118734 in CbcPointer<BodyProducer>::operator-> (
>      this=<optimized out>) at ../src/base/CbcPointer.h:181
>          c = <optimized out>
> #7  CbcPointer<BodyConsumer>::operator-> (this=<optimized out>)
>      at ../src/base/CbcPointer.h:178
>          c = <optimized out>
>          c = <optimized out>
> #8  JobDialer<BodyConsumer>::dial (call=..., this=<optimized out>)
>      at base/AsyncJobCalls.h:182
>          __FUNCTION__ = <optimized out>
> --Type <RET> for more, q to quit, c to continue without paging--
> #9  AsyncCallT<BodyConsumerDialer>::fire (this=0x55fa4f965270)
>      at ../src/base/AsyncCall.h:145
> No locals.
> #10 0x000055fa293cfaab in AsyncCallQueue::fireNext (this=<optimized out>)
>      at base/../../src/base/RefCount.h:73
>          call = {p_ = 0x55fa4f965270}
>          __FUNCTION__ = <optimized out>
> #11 0x000055fa293d189a in AsyncCallQueue::fire (this=0x55fa2b930a20)
>      at base/AsyncCallQueue.cc:43
>          made = true
> #12 0x000055fa291ad500 in EventLoop::dispatchCalls (this=0x7ffcd7a21ef0)
>      at ./src/EventLoop.cc:144
>          dispatchedSome = <optimized out>
> #13 EventLoop::runOnce (this=0x7ffcd7a21ef0) at ./src/EventLoop.cc:121
>          sawActivity = <optimized out>
>          waitingEngine = 0x7ffcd7a21e30
>          __FUNCTION__ = <optimized out>
> #14 0x000055fa292b5f10 in EventLoop::run (this=0x7ffcd7a21ef0)
>      at ./src/EventLoop.cc:83
> No locals.
> #15 SquidMain (argc=<optimized out>, argv=<optimized out>)
>      at ./src/main.cc:1719
>          cmdLine = {argv_ = std::vector of length 6, capacity 6 = {
> --Type <RET> for more, q to quit, c to continue without paging--
>              0x55fa29977220 "(squid-1)", 0x55fa299772e0 "--kid",
>              0x55fa299773a0 "squid-1", 0x55fa29977460 "--foreground",
>              0x55fa29977520 "-sYC", 0x0},
>            shortOptions_ = 0x55fa299a2450 "CDFNRSYXa:d:f:hk:m::n:sl:u:vz?",
>            longOptions_ = std::vector of length 5, capacity 8 = {{<option> = {
>                  name = 0x55fa29977cc0 "foreground", has_arg = 0, flag = 0x0,
>                  val = 2}, <No data fields>}, {<option> = {
>                  name = 0x55fa299778e0 "kid", has_arg = 1, flag = 0x0,
>                  val = 3}, <No data fields>}, {<option> = {
>                  name = 0x55fa299779a0 "help", has_arg = 0, flag = 0x0,
>                  val = 104}, <No data fields>}, {<option> = {
>                  name = 0x55fa29977a80 "version", has_arg = 0, flag = 0x0,
>                  val = 118}, <No data fields>}, {<option> = {name = 0x0,
>                  has_arg = 0, flag = 0x0, val = 0}, <No data fields>}}}
>          WIN32_init_err = 0
>          mainLoop = {errcount = 0, static Running = 0x7ffcd7a21ef0,
>            last_loop = false, engines = std::vector of length 4, capacity 4 = {
>              0x7ffcd7a21e70, 0x55fa296e8fd0 <EventScheduler::_instance>,
>              0x7ffcd7a21e50, 0x7ffcd7a21e30}, timeService = 0x7ffcd7a21da8,
>            primaryEngine = 0x7ffcd7a21e30, loop_delay = 0, error = false,
>            runOnceResult = false}
>          signalEngine = {<AsyncEngine> = {
>              _vptr.AsyncEngine = 0x55fa296e1e50 <vtable for SignalEngine+16>}, <N--Type <RET> for more, q to quit, c to continue without paging--
> o data fields>}
>          store_engine = {<AsyncEngine> = {
>              _vptr.AsyncEngine = 0x55fa296c8310 <vtable for StoreRootEngine+16>}, <No data fields>}
>          comm_engine = {<AsyncEngine> = {
>              _vptr.AsyncEngine = 0x55fa296e1e28 <vtable for CommSelectEngine+16>}, <No data fields>}
>          time_engine = {
>            _vptr.TimeEngine = 0x55fa296e2480 <vtable for TimeEngine+16>}
>          __FUNCTION__ = <optimized out>
> #16 0x000055fa291524e6 in SquidMainSafe (argv=0x7ffcd7a22208, argc=5)
>      at ./src/main.cc:1406
>          __FUNCTION__ = <optimized out>
> #17 main (argc=5, argv=0x7ffcd7a22208) at ./src/main.cc:1394
> No locals.
> (gdb)
> 
> Do you can see where the bug is?
> 
> best regards
>   Waldemar



From rousskov at measurement-factory.com  Fri Apr 14 14:08:18 2023
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Fri, 14 Apr 2023 10:08:18 -0400
Subject: [squid-users] Help to understand tcp_denied in access.log
In-Reply-To: <!&!AAAAAAAAAAAuAAAAAAAAAIVNjRjcTGZElYgADq7oyvYBAMO2jhD3dRHOtM0AqgC7tuYAAAAAAA4AABAAAACun8EO5DWHSKeMxm9DSfyzAQAAAAA=@articatech.com>
References: <!&!AAAAAAAAAAAuAAAAAAAAAIVNjRjcTGZElYgADq7oyvYBAMO2jhD3dRHOtM0AqgC7tuYAAAAAAA4AABAAAABqbjq3ZhD5TJN5sGxH+spsAQAAAAA=@articatech.com>
 <8ccdde6a-fddb-e5aa-ee90-26d1bb6fc4d7@measurement-factory.com>
 <!&!AAAAAAAAAAAuAAAAAAAAAIVNjRjcTGZElYgADq7oyvYBAMO2jhD3dRHOtM0AqgC7tuYAAAAAAA4AABAAAACun8EO5DWHSKeMxm9DSfyzAQAAAAA=@articatech.com>
Message-ID: <63d23c19-7da0-1057-6908-72b4e9bf8613@measurement-factory.com>

On 4/14/23 06:36, andre.bolinhas at articatech.com wrote:

> The mechanism is http_access, the size of error page is around 500kb.

 >> Each TCP_DENIED request is consuming 400000+ bytes

If your custom error page is around 500KB, then we should not be 
surprised that the corresponding %<st values exceed 400000 bytes!


> The squid version is 5.8 and I'm not doing ssl bump for this domain.
> When you ask to " collect a packet trace" is put squid in debug mode? Squid
> -k debug?

No, I was thinking about something along these lines:

   tcpdump -s0 -w packet-trace.pcap ...

However, with your 500KB statement, there is no need for a packet trace 
because Squid is simply sending your large custom error responses to 
denied clients, as instructed. Mystery solved.

Please note that popular browsers will not display CONNECT error 
responses, but client behavior is client-dependent, so YMMV.

Do you want Squid to respond with your custom 500KB error page? If yes, 
there is nothing you need to do. Otherwise, please clarify what you want 
Squid to do instead.


HTH,

Alex.


> -----Mensagem original-----
> De: squid-users <squid-users-bounces at lists.squid-cache.org> Em Nome De Alex
> Rousskov
> Enviada: 14 de abril de 2023 04:01
> Para: squid-users at lists.squid-cache.org
> Assunto: Re: [squid-users] Help to understand tcp_denied in access.log
> 
> On 4/13/23 21:23, andre.bolinhas at articatech.com wrote:
> 
>> I'm seeing to many requests to website mainnet.infura.io, by analyzing
>> the access.log seams that the website is blocked
> 
> Which directive/mechanism blocks them (e.g., http_access,
> reply_body_max_size, ICAP/eCAP, etc.)?
> 
> 
>> Each TCP_DENIED request is consuming 400000+ bytes
> 
> Assuming you do not use huge custom TCP_DENIED error pages, I agree that
> these entries look suspicious, as if Squid denied access but continued
> to tunnel the traffic. The response times are fairly small, but probably
> large enough to transmit those amounts of data from a fast server.
> 
> Since most requests (for the affected domain) are problematic, can you
> collect a packet trace and see if you can confirm that these
> transactions transmit a lot of data from Squid to the client? If IPs are
> not enough, logging client TCP port (%>p) may help you match specific
> access.log entries with TCP connections in the packet trace...
> 
> 
> What Squid version are you using for this? Does SslBump affect the
> problematic transactions?
> 
> 
> Thank you,
> 
> Alex.
> 
> 
> 
>> but I also notice that the
>> request is consuming bandwidth, here a example
>> Squid access.log format.
>> %ts.%03tu %6tr %>a %Ss/%03>Hs %<st %rm %ru %[un %Sh/%<a:%<p %mt
> mac="%>eui"
>> %note ua="%{User-Agent}>h" exterr="%err_code|%err_detail"
>>
>> Access.log request.
>> 1681099742.517     35 10.81.216.114 TCP_DENIED_ABORTED/407 41154 CONNECT
>> mainnet.infura.io:443 - HIER_NONE/-:- text/html mac="00:00:00:00:00:00"
>>
> category:%20143%0D%0Acategory-name:%20Trackers%0D%0Aclog:%20cinfo:143-Tracke
>> rs;%0D%0A ua="Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7)
>> AppleWebKit/537.36 (KHTML, like Gecko) Chrome/111.0.0.0 Safari/537.36"
>> exterr="ERR_CACHE_ACCESS_DENIED|-"
>>
>> 1681099742.575     41 10.81.216.114 TCP_DENIED/407 511819 CONNECT
>> mainnet.infura.io:443 - HIER_NONE/-:- text/html mac="00:00:00:00:00:00"
>>
> category:%20143%0D%0Acategory-name:%20Trackers%0D%0Aclog:%20cinfo:143-Tracke
>> rs;%0D%0A ua="Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7)
>> AppleWebKit/537.36 (KHTML, like Gecko) Chrome/111.0.0.0 Safari/537.36"
>> exterr="ERR_CACHE_ACCESS_DENIED|-"
>>
>> 1681099742.664     73 10.81.216.114 NONE/200 0 CONNECT
> mainnet.infura.io:443
>> HLBHO/tsyafiq HIER_NONE/-:- - mac="00:00:00:00:00:00"
>>
> category:%20143%0D%0Acategory-name:%20Trackers%0D%0Aclog:%20cinfo:143-Tracke
>> rs;%0D%0Auser:%20HLBHO/tsyafiq%0D%0A ua="Mozilla/5.0 (Macintosh; Intel Mac
>> OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/111.0.0.0
>> Safari/537.36" exterr="-|-"
>>
>> 1681099742.685     20 10.81.216.114 TCP_DENIED_ABORTED/403 450655 CONNECT
>> mainnet.infura.io:443 HLBHO/tsyafiq HIER_NONE/-:- text/html
>> mac="00:00:00:00:00:00"
>>
> category:%20143%0D%0Acategory-name:%20Trackers%0D%0Aclog:%20cinfo:143-Tracke
>> rs;%0D%0Auser:%20HLBHO/tsyafiq%0D%0A ua="-" exterr="ERR_ACCESS_DENIED|-"
>>
>> Each TCP_DENIED request is consuming 400000+ bytes so at the end of the
> day
>> sometimes I have a total of 56k request to mainnet.infura.io consuming
>> around 15GB of bandwidth.
>>
>> My question is, assuming that %<st is the total size of reply, why
>> TCP_DENIED is taking a lot of bandwidth to block a website?
>>
>> Best regards
>>
>>
>>
>>
>> _______________________________________________
>> squid-users mailing list
>> squid-users at lists.squid-cache.org
>> http://lists.squid-cache.org/listinfo/squid-users
> 
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users



From 0xff1f at gmail.com  Mon Apr 17 18:52:41 2023
From: 0xff1f at gmail.com (Dr.X)
Date: Mon, 17 Apr 2023 18:52:41 +0000
Subject: [squid-users] Is there any squid 4.x tested with Delay pools to
 work and limit well ?
In-Reply-To: <DBBPR09MB452394080F36AA97A0DD95CAF79A9@DBBPR09MB4523.eurprd09.prod.outlook.com>
References: <DBBPR09MB4523DDEC4878F0C233655EDFF7979@DBBPR09MB4523.eurprd09.prod.outlook.com>
 <20230408143556.66755d4fdc0b0d633ab9d415@killthe.net>
 <7052990e-08cc-aebc-3ad1-1d7c911e37ce@measurement-factory.com>
 <DBBPR09MB45233EC844433A4EE184239DF7959@DBBPR09MB4523.eurprd09.prod.outlook.com>
 <2d597901-a490-1e60-951d-e82e729dc15a@measurement-factory.com>
 <DBBPR09MB4523FF691BFFFAD9D528BA92F79A9@DBBPR09MB4523.eurprd09.prod.outlook.com>
 <5c9affea-06f8-fd12-d7a1-5dea5ed889b0@measurement-factory.com>
 <DBBPR09MB452394080F36AA97A0DD95CAF79A9@DBBPR09MB4523.eurprd09.prod.outlook.com>
Message-ID: <DBBPR09MB4523C218F91E041368617FF5F79C9@DBBPR09MB4523.eurprd09.prod.outlook.com>

Could you please explain why the developers are upgrading Squid from version 4 to 5 and 6, while ignoring a critical built-in feature like Delay Pools that has been reported as a bug since Squid 4.x?

Really  having difficulty understanding this equation.

Thank you.


From: Dr.X <0xff1f at gmail.com>
Date: Tuesday, 11 April 2023 05:33
To: Alex Rousskov <rousskov at measurement-factory.com>, squid-users at lists.squid-cache.org <squid-users at lists.squid-cache.org>
Cc: Dave Blanchard <dave at killthe.net>
Subject: Re: [squid-users] Is there any squid 4.x tested with Delay pools to work and limit well ?
Ok nice , we will stick with squid 3.x then ?

Thanks


From: Alex Rousskov <rousskov at measurement-factory.com>
Date: Tuesday, 11 April 2023 05:31
To: squid-users at lists.squid-cache.org <squid-users at lists.squid-cache.org>
Cc: Dave Blanchard <dave at killthe.net>, Dr.X <0xff1f at gmail.com>
Subject: Re: [squid-users] Is there any squid 4.x tested with Delay pools to work and limit well ?
On 4/10/23 20:42, Dr.X wrote:
> Is it solved in squid 6.x ?

I do not think so. AFAIK, Bug 4913 (Delay Pools don't work for Tunneled
traffic) affects all Squid versions starting with v4 (at least). IIRC,
there were some code improvements in that area, as side effects of other
projects, but nobody has worked on an actual fix yet.

Alex.


> *From: *Alex Rousskov <rousskov at measurement-factory.com>
> *Date: *Tuesday, 11 April 2023 03:24
> *To: *squid-users at lists.squid-cache.org <squid-users at lists.squid-cache.org>
> *Cc: *Dave Blanchard <dave at killthe.net>, Dr.X <0xff1f at gmail.com>
> *Subject: *Re: [squid-users] Is there any squid 4.x tested with Delay
> pools to work and limit well ?
>
> On 4/10/23 18:41, Dr.X wrote:
>
>> So do you think we will have squid 4.x to be fixed soon or latter ?
>
> Squid v4 receives very little attention these days. FWIW, I am not aware
> of anybody working on Bug 4913 (Delay Pools don't work for Tunneled
> traffic) right now (for any Squid version).
>
> https://wiki.squid-cache.org/SquidFaq/AboutSquid#how-to-add-a-new-squid-feature-enhance-of-fix-something <https://wiki.squid-cache.org/SquidFaq/AboutSquid#how-to-add-a-new-squid-feature-enhance-of-fix-something>
>
> Alex.
>
>
>
>> *From: *Alex Rousskov <rousskov at measurement-factory.com>
>> *Date: *Monday, 10 April 2023 04:31
>> *To: *squid-users at lists.squid-cache.org <squid-users at lists.squid-cache.org>
>> *Cc: *Dr.X <0xff1f at gmail.com>, Dave Blanchard <dave at killthe.net>
>> *Subject: *Re: [squid-users] Is there any squid 4.x tested with Delay
>> pools to work and limit well ?
>>
>> On 4/8/23 15:35, Dave Blanchard wrote:
>>> On Sat, 8 Apr 2023 16:40:02 +0000
>>> Dr.X <0xff1f at gmail.com> wrote:
>>
>>>> I was wondering if you have a Squid 4.x version that supports delay
>>>> pools and is not buggy. I asked Alex, the developer, and he
>>>> informed me that none of the 4.x versions support it. I also
>>>> reached out to Amos but haven't received a response yet.
>>
>>
>>> I'm interested in this also, as I've just tried setting up delay
>>> pools on 5.4 and so far haven't managed to make it work as expected.
>>
>>
>> I would like to clarify delay pools support status, again: For some
>> traffic, some delay pools configurations are probably working OK in
>> Squid v4+. The Squid bug Dr.X has been referring to above (and in other
>> recent squid-user emails) is Bug 4913 (Delay Pools don't work for
>> Tunneled traffic):
>>
>> * https://bugs.squid-cache.org/show_bug.cgi?id=4913
> <https://bugs.squid-cache.org/show_bug.cgi?id=4913>
>> <https://bugs.squid-cache.org/show_bug.cgi?id=4913
> <https://bugs.squid-cache.org/show_bug.cgi?id=4913>>
>>
>> *
>> http://lists.squid-cache.org/pipermail/squid-users/2022-June/024922.html
> <http://lists.squid-cache.org/pipermail/squid-users/2022-June/024922.html>
>> <http://lists.squid-cache.org/pipermail/squid-users/2022-June/024922.html
> <http://lists.squid-cache.org/pipermail/squid-users/2022-June/024922.html>>
>>
>> *
>> http://lists.squid-cache.org/pipermail/squid-users/2023-April/025725.html <http://lists.squid-cache.org/pipermail/squid-users/2023-April/025725.html> <http://lists.squid-cache.org/pipermail/squid-users/2023-April/025725.html <http://lists.squid-cache.org/pipermail/squid-users/2023-April/025725.html>>
>>
>>
>> HTH,
>>
>> Alex.
>>
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230417/89d47b1c/attachment.htm>

From Antony.Stone at squid.open.source.it  Mon Apr 17 19:14:52 2023
From: Antony.Stone at squid.open.source.it (Antony Stone)
Date: Mon, 17 Apr 2023 21:14:52 +0200
Subject: [squid-users] Is there any squid 4.x tested with Delay pools to
 work and limit well ?
In-Reply-To: <DBBPR09MB4523C218F91E041368617FF5F79C9@DBBPR09MB4523.eurprd09.prod.outlook.com>
References: <DBBPR09MB4523DDEC4878F0C233655EDFF7979@DBBPR09MB4523.eurprd09.prod.outlook.com>
 <DBBPR09MB452394080F36AA97A0DD95CAF79A9@DBBPR09MB4523.eurprd09.prod.outlook.com>
 <DBBPR09MB4523C218F91E041368617FF5F79C9@DBBPR09MB4523.eurprd09.prod.outlook.com>
Message-ID: <202304172114.52784.Antony.Stone@squid.open.source.it>

On Monday 17 April 2023 at 20:52:41, Dr.X wrote:

> Could you please explain why the developers are upgrading Squid from
> version 4 to 5 and 6, while ignoring a critical built-in feature like
> Delay Pools that has been reported as a bug since Squid 4.x?

I am not a Squid developer, and I do not even pretend to speak for those who 
are, but as someone familiar with Open Source Software in general, I would 
suggest that:

a) Squid is an Open Source project
b) most Open Source projects are developed (at least at the start) by people 
who have a personal need for whatever it is they set out to do
c) people work on the things they find most important and/or interesting
d) people work on the things they are best at (and can therefore make good 
progress with)
e) people work on things they get paid to work on
f) your idea of "critical" may not match other peoples' priorities

So, if nobody is working on something that you think is rather important:

1. they might not have have a personal use for it, and therefore don't feel 
inclined to spend time on it
2. they may not have the expertise to solve whatever the problems with it are
3. they may not have the time to make good progress on it, compared to any of 
the other things that are on the list of "things to do"

Most Open Source projects (I believe Squid is included in this) offer to 
develop specific features, or work on specific bugs, in return for payment from 
anyone who thinks they should be worked on (or worked on more quickly).

So, if something is important to you (that's a generic "you"), you can pay for 
someone to work on it.

You're also perfectly welcome to work on it yourself in order to improve the 
code which everyone uses, and which you got for free to start with.


It's a basic tenet of Open Source Software that if you think it could be 
better, you can improve it, or pay for someone else to improve it for you.  
You're not forced to accept whatever "upgrades" some closed-source development 
company decides they want to release, with no chance at all on your side to 
make changes to the code.

Many Open Source projects have been completely forked (meaning that someone, 
or some group, decides "we don't like the way this team of developers is 
taking things, so we're going to start from the code base and take it in a 
different direction") and in many cases both the original and the fork have 
long and successful lives from that point onward.  There's no way that could 
happen with proprietary (closed-source) code.


Antony.

-- 
Why are they called "The Rocky Mountains"?
What are other mountains made of?

                                                   Please reply to the list;
                                                         please *don't* CC me.


From rousskov at measurement-factory.com  Mon Apr 17 20:36:33 2023
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Mon, 17 Apr 2023 16:36:33 -0400
Subject: [squid-users] Is there any squid 4.x tested with Delay pools to
 work and limit well ?
In-Reply-To: <DBBPR09MB4523C218F91E041368617FF5F79C9@DBBPR09MB4523.eurprd09.prod.outlook.com>
References: <DBBPR09MB4523DDEC4878F0C233655EDFF7979@DBBPR09MB4523.eurprd09.prod.outlook.com>
 <20230408143556.66755d4fdc0b0d633ab9d415@killthe.net>
 <7052990e-08cc-aebc-3ad1-1d7c911e37ce@measurement-factory.com>
 <DBBPR09MB45233EC844433A4EE184239DF7959@DBBPR09MB4523.eurprd09.prod.outlook.com>
 <2d597901-a490-1e60-951d-e82e729dc15a@measurement-factory.com>
 <DBBPR09MB4523FF691BFFFAD9D528BA92F79A9@DBBPR09MB4523.eurprd09.prod.outlook.com>
 <5c9affea-06f8-fd12-d7a1-5dea5ed889b0@measurement-factory.com>
 <DBBPR09MB452394080F36AA97A0DD95CAF79A9@DBBPR09MB4523.eurprd09.prod.outlook.com>
 <DBBPR09MB4523C218F91E041368617FF5F79C9@DBBPR09MB4523.eurprd09.prod.outlook.com>
Message-ID: <6958a75c-8803-f355-8f67-b4ef7d6fdffd@measurement-factory.com>

On 4/17/23 14:52, Dr.X wrote:
> Could you please explain why the developers are upgrading Squid from 
> version 4 to 5 and 6, while ignoring a critical built-in feature like 
> Delay Pools that has been reported as a bug since Squid 4.x?

Modern Squids are released on a fixed schedule[1], regardless of how 
many old bugs are left in the code.

[1] https://wiki.squid-cache.org/ReleaseSchedule

FWIW, we have tried several other approaches, but they were all proven 
to be even more problematic. For example, the natural "let's fix all 
critical bugs before declaring a new version STABLE" approach (which we 
also tried), leads to many problems in Squid environment, including these:

* The development version can "never" be honestly declared stable 
because nobody volunteers to fix all critical bugs. Please note that we 
cannot force developers to fix bugs -- there are no Squid Project 
employees to order around.

* Some critical bug fixes are delayed forever because they require 
changes deemed too disruptive to be done when the official development 
branch code finally appears to be close of becoming stable -- working 
well in known/important/supported environments.

* Since a stable declaration is always pushed back, the number of folks 
interested in testing the development version goes down. With that 
decrease, the number of critical bugs discovered/reported decreases as 
well. As a result, if we do mark a release as stable, we are then 
flooded with new critical bug reports (for a now "stable" version!).

* Persistent fights about bug classification consume a lot of developer 
time and nerve cells. A broken feature deemed critical by one relatively 
reasonable person may be treated as dead code that should be removed by 
another reasonable person!

* The stable version is so old that it is effectively unusable in many 
modern environments because it lacks essential features for those 
environments. Those features cannot be added to that stable version 
because doing so may disrupt its stability.

* The stable version effectively becomes unstable in many environments 
because nobody volunteers to fix its bugs because most developers are 
running or supporting some other code snapshot (that works for them or 
their customers).


The Squid Project has decided that a fixed schedule of releases has a 
potential to be an overall better approach. FWIW, I agree with that 
decision. We all know that it will not fix all the problems.


Antony Stone has mentioned many good general reasons why some bugs take 
longer to fix than others, especially in an open source project. My 
response does not contradict that useful information. I was just trying 
to provide an answer that is a bit closer to your specific question...


HTH,

Alex.


> *From: *Dr.X <0xff1f at gmail.com>
> *Date: *Tuesday, 11 April 2023 05:33
> *To: *Alex Rousskov <rousskov at measurement-factory.com>, 
> squid-users at lists.squid-cache.org <squid-users at lists.squid-cache.org>
> *Cc: *Dave Blanchard <dave at killthe.net>
> *Subject: *Re: [squid-users] Is there any squid 4.x tested with Delay 
> pools to work and limit well ?
> 
> Ok nice , we will stick with squid 3.x then ?
> 
> Thanks
> 
> *From: *Alex Rousskov <rousskov at measurement-factory.com>
> *Date: *Tuesday, 11 April 2023 05:31
> *To: *squid-users at lists.squid-cache.org <squid-users at lists.squid-cache.org>
> *Cc: *Dave Blanchard <dave at killthe.net>, Dr.X <0xff1f at gmail.com>
> *Subject: *Re: [squid-users] Is there any squid 4.x tested with Delay 
> pools to work and limit well ?
> 
> On 4/10/23 20:42, Dr.X wrote:
>> Is it solved in squid 6.x ?
> 
> I do not think so. AFAIK, Bug 4913 (Delay Pools don't work for Tunneled
> traffic) affects all Squid versions starting with v4 (at least). IIRC,
> there were some code improvements in that area, as side effects of other
> projects, but nobody has worked on an actual fix yet.
> 
> Alex.
> 
> 
>> *From: *Alex Rousskov <rousskov at measurement-factory.com>
>> *Date: *Tuesday, 11 April 2023 03:24
>> *To: *squid-users at lists.squid-cache.org <squid-users at lists.squid-cache.org>
>> *Cc: *Dave Blanchard <dave at killthe.net>, Dr.X <0xff1f at gmail.com>
>> *Subject: *Re: [squid-users] Is there any squid 4.x tested with Delay 
>> pools to work and limit well ?
>> 
>> On 4/10/23 18:41, Dr.X wrote:
>> 
>>> So do you think we will have squid 4.x to be fixed soon or latter ?
>> 
>> Squid v4 receives very little attention these days. FWIW, I am not aware
>> of anybody working on Bug 4913 (Delay Pools don't work for Tunneled
>> traffic) right now (for any Squid version).
>> 
>> https://wiki.squid-cache.org/SquidFaq/AboutSquid#how-to-add-a-new-squid-feature-enhance-of-fix-something
>> 
>> Alex.
>> 
>> 
>> 
>>> *From: *Alex Rousskov <rousskov at measurement-factory.com>
>>> *Date: *Monday, 10 April 2023 04:31
>>> *To: *squid-users at lists.squid-cache.org <squid-users at lists.squid-cache.org>
>>> *Cc: *Dr.X <0xff1f at gmail.com>, Dave Blanchard <dave at killthe.net>
>>> *Subject: *Re: [squid-users] Is there any squid 4.x tested with Delay 
>>> pools to work and limit well ?
>>> 
>>> On 4/8/23 15:35, Dave Blanchard wrote:
>>>> On Sat, 8 Apr 2023 16:40:02 +0000
>>>> Dr.X <0xff1f at gmail.com> wrote:
>>> 
>>>>> I was wondering if you have a Squid 4.x version that supports delay
>>>>> pools and is not buggy. I asked Alex, the developer, and he
>>>>> informed me that none of the 4.x versions support it. I also
>>>>> reached out to Amos but haven't received a response yet.
>>> 
>>> 
>>>> I'm interested in this also, as I've just tried setting up delay
>>>> pools on 5.4 and so far haven't managed to make it work as expected.
>>> 
>>> 
>>> I would like to clarify delay pools support status, again: For some
>>> traffic, some delay pools configurations are probably working OK in
>>> Squid v4+. The Squid bug Dr.X has been referring to above (and in other
>>> recent squid-user emails) is Bug 4913 (Delay Pools don't work for
>>> Tunneled traffic):
>>> 
>>> * https://bugs.squid-cache.org/show_bug.cgi?id=4913 
>>> * http://lists.squid-cache.org/pipermail/squid-users/2022-June/024922.html 
>>> * http://lists.squid-cache.org/pipermail/squid-users/2023-April/025725.html
>>> HTH,
>>> 
>>> Alex.
>>> 
>> 
> 



From Ralf.Hildebrandt at charite.de  Tue Apr 18 07:38:14 2023
From: Ralf.Hildebrandt at charite.de (Ralf Hildebrandt)
Date: Tue, 18 Apr 2023 09:38:14 +0200
Subject: [squid-users] Disable IPV6 for certain destinations only?
Message-ID: <ZD5I5nURK5iOlBf7@charite.de>

Hi!

We're using squid-6, currently v4 only. The use case for us is mostly
our users using our proxy to retrieve full text publications of
several thousand medical journals... via IPv4.

The publishers "know" our IPv4 range for the proxies and allow us to
download freely. What they don't (yet) know is our ipv6 range.

Thus arises the need to "fall back" to ipv4 in the unlikely case some
publisher already has ipv6, we connect via ipv6 and suddenly are not
allowed to download the publications.

Is there an acl for that kind of need?

-- 
Ralf Hildebrandt
Charit? - Universit?tsmedizin Berlin
Gesch?ftsbereich IT | Abteilung Netzwerk

Campus Benjamin Franklin (CBF)
Haus I | 1. OG | Raum 105
Hindenburgdamm 30 | D-12203 Berlin

Tel. +49 30 450 570 155
ralf.hildebrandt at charite.de
https://www.charite.de


From amajer at suse.de  Tue Apr 18 08:35:03 2023
From: amajer at suse.de (Adam Majer)
Date: Tue, 18 Apr 2023 10:35:03 +0200
Subject: [squid-users] Disable IPV6 for certain destinations only?
In-Reply-To: <ZD5I5nURK5iOlBf7@charite.de>
References: <ZD5I5nURK5iOlBf7@charite.de>
Message-ID: <2d4c8a7a-accb-217d-f0e9-8b932dea1977@suse.de>

On 4/18/23 09:38, Ralf Hildebrandt wrote:
 > Thus arises the need to "fall back" to ipv4 in the unlikely case some
 > publisher already has ipv6, we connect via ipv6 and suddenly are not
 > allowed to download the publications.
 >
 > Is there an acl for that kind of need?

Hi,

The main thing about acl is that acl == access control list and it's 
there to filter if some client is allowed to access the destination and 
not so much in in specifying the route the request follows. The request 
follows the default outbound connection.

So, I don't think this is the right mechanism and I don't believe it 
exists. There is only this, and it's just flat option that will connect 
with IPv4 first, for everything. It will hide issues with dual stack sites.

http://www.squid-cache.org/Doc/config/dns_v4_first/

The correct way of doing this is to,

  1. contact the journal providers that are causing issues ... you 
cannot find problems until someone reports them, so if you are doing 
IPv4 only, you will not be part of the solution :-)

  2. don't use the above option

  3. if you need to workaround the problem temporarily, add the IPv4 
only address to the /etc/hosts of the proxy server(s). This will resolve 
the address to your override. You can also do this with a local 
recursive DNS server (like Bind) too.


I believe option #3 is the answer to your request. But do that on a 
temporarily basis, while actively fixing the issue with the journal, 
because it will cause mystery issues in the future, when the journal 
access domain is moved to a different IPv4 ;)

- Adam



From Ralf.Hildebrandt at charite.de  Tue Apr 18 09:54:25 2023
From: Ralf.Hildebrandt at charite.de (Ralf Hildebrandt)
Date: Tue, 18 Apr 2023 11:54:25 +0200
Subject: [squid-users] [ext] Re: Disable IPV6 for certain destinations
 only?
In-Reply-To: <2d4c8a7a-accb-217d-f0e9-8b932dea1977@suse.de>
References: <ZD5I5nURK5iOlBf7@charite.de>
 <2d4c8a7a-accb-217d-f0e9-8b932dea1977@suse.de>
Message-ID: <ZD5o0YeYqfRR6TjR@charite.de>

> http://www.squid-cache.org/Doc/config/dns_v4_first/

2023/04/18 11:53:33| ERROR: Directive 'dns_v4_first' is obsolete.
2023/04/18 11:53:33| dns_v4_first : Remove this line. Squid no longer supports preferential treatment of DNS A records.

>  3. if you need to workaround the problem temporarily, add the IPv4 only
> address to the /etc/hosts of the proxy server(s). This will resolve the
> address to your override. You can also do this with a local recursive DNS
> server (like Bind) too.

Will do that, thanks!

-- 
Ralf Hildebrandt
Charit? - Universit?tsmedizin Berlin
Gesch?ftsbereich IT | Abteilung Netzwerk

Campus Benjamin Franklin (CBF)
Haus I | 1. OG | Raum 105
Hindenburgdamm 30 | D-12203 Berlin

Tel. +49 30 450 570 155
ralf.hildebrandt at charite.de
https://www.charite.de


From harshseattle01 at gmail.com  Tue Apr 18 10:22:56 2023
From: harshseattle01 at gmail.com (Harsh Seattle)
Date: Tue, 18 Apr 2023 15:52:56 +0530
Subject: [squid-users] Instructions to build Squid proxy for Windows
Message-ID: <CAHKpMQ8UhAm3=7AAnCtbxmMz7V3HXVWem3YqRz-nmKK_fMO6hA@mail.gmail.com>

Hi All,

As mentioned on the page- https://wiki.squid-cache.org/KnowledgeBase/Windows,
the pre-built binary packages are available for Squid 3.3 and 4. However,
the current stable version of Squid is 5 with version 6 and 7 already under
development.

Given that pre-built packages are not readily available for Windows, I am
hoping to compile version 5/6/7 for Windows. However, the instructions
provided here- https://wiki.squid-cache.org/KnowledgeBase/Windows#compiling
are not user friendly and sort of incomplete.

Does anyone have any experience in compiling Squid for Windows? If so, can
you please share instructions for the same?

Thanks
Harsh
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230418/c7d29aa9/attachment.htm>

From rousskov at measurement-factory.com  Tue Apr 18 12:53:31 2023
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Tue, 18 Apr 2023 08:53:31 -0400
Subject: [squid-users] Disable IPV6 for certain destinations only?
In-Reply-To: <ZD5I5nURK5iOlBf7@charite.de>
References: <ZD5I5nURK5iOlBf7@charite.de>
Message-ID: <f4a1d8bf-185d-0b51-d597-fed5efa300bf@measurement-factory.com>

On 4/18/23 03:38, Ralf Hildebrandt wrote:

> We're using squid-6, currently v4 only. The use case for us is mostly
> our users using our proxy to retrieve full text publications of
> several thousand medical journals... via IPv4.
> 
> The publishers "know" our IPv4 range for the proxies and allow us to
> download freely. What they don't (yet) know is our ipv6 range.
> 
> Thus arises the need to "fall back" to ipv4 in the unlikely case some
> publisher already has ipv6, we connect via ipv6 and suddenly are not
> allowed to download the publications.
> 
> Is there an acl for that kind of need?

I will rephrase your question to avoid the distraction of "acl":

   How can I configure Squid to try IPv4 if IPv6 fails?

The answer depends on how IPv6 fails:

1. If IPv6 fails at DNS resolution time (i.e. the DNS resolver does not 
respond with a usable address to a AAAA query), then Squid will 
automatically use IPv4 (i.e. the DNS resolver address in an A response). 
There is nothing to configure.

2. If IPv6 fails at TCP connection establishment time, then Squid will 
automatically use an IPv4 connection. There is nothing to configure 
(although there are a few Happy Eyeballs configuration options that you 
can tune).

3. If IPv6 fails at TLS connection establishment time, then, IIRC, #2 
applies unless SslBump is involved. Squid will not retry failed TLS 
connections that are subject to SslBump IIRC.

4. If IPv6 fails at HTTP request time, then Squid will retry in _some_ 
cases. See [1] for a long list of conditions; you are probably mostly 
interested in the last four or five bullets, but keep in mind that the 
list is of cases where Squid does _not_ re-forward the failed request.

[1] 
https://wiki.squid-cache.org/SquidFaq/InnerWorkings#when-does-squid-re-forward-a-client-request

You can also replace your DNS resolver with a custom one (that drops 
AAAA answers) or, as Adam has suggested, with hard-coded IPv4-only 
/etc/hosts entries.


HTH,

Alex.



From Antony.Stone at squid.open.source.it  Tue Apr 18 12:58:11 2023
From: Antony.Stone at squid.open.source.it (Antony Stone)
Date: Tue, 18 Apr 2023 14:58:11 +0200
Subject: [squid-users] Disable IPV6 for certain destinations only?
In-Reply-To: <f4a1d8bf-185d-0b51-d597-fed5efa300bf@measurement-factory.com>
References: <ZD5I5nURK5iOlBf7@charite.de>
 <f4a1d8bf-185d-0b51-d597-fed5efa300bf@measurement-factory.com>
Message-ID: <202304181458.11356.Antony.Stone@squid.open.source.it>

On Tuesday 18 April 2023 at 14:53:31, Alex Rousskov wrote:

> On 4/18/23 03:38, Ralf Hildebrandt wrote:
> > We're using squid-6, currently v4 only. The use case for us is mostly
> > our users using our proxy to retrieve full text publications of
> > several thousand medical journals... via IPv4.
> > 
> > The publishers "know" our IPv4 range for the proxies and allow us to
> > download freely. What they don't (yet) know is our ipv6 range.
> > 
> > Thus arises the need to "fall back" to ipv4 in the unlikely case some
> > publisher already has ipv6, we connect via ipv6 and suddenly are not
> > allowed to download the publications.
> > 
> > Is there an acl for that kind of need?
> 
> I will rephrase your question to avoid the distraction of "acl":
> 
>    How can I configure Squid to try IPv4 if IPv6 fails?

I don't think that's the same question.

"How can I configure Squid to try IPv4 if IPv6 fails" deal with a network-level 
failure to connect to something.

I think the OP is looking for a way to tell Squid "for this destination 
hostname, don't even try to connect over IPv6, because if you do, we'll get 
rejected (not at the network level, but some application-level) so we need you 
(Squid) to connect using IPv4 only (for this destination)".


Antony.

-- 
If you can smile when all about you things are going wrong, you must have 
someone in mind to take the blame.

                                                   Please reply to the list;
                                                         please *don't* CC me.


From Ralf.Hildebrandt at charite.de  Tue Apr 18 13:14:05 2023
From: Ralf.Hildebrandt at charite.de (Ralf Hildebrandt)
Date: Tue, 18 Apr 2023 15:14:05 +0200
Subject: [squid-users] [ext] Re: Disable IPV6 for certain destinations
 only?
In-Reply-To: <202304181458.11356.Antony.Stone@squid.open.source.it>
References: <ZD5I5nURK5iOlBf7@charite.de>
 <f4a1d8bf-185d-0b51-d597-fed5efa300bf@measurement-factory.com>
 <202304181458.11356.Antony.Stone@squid.open.source.it>
Message-ID: <ZD6XnYdEFHOzlQd2@charite.de>

* Antony Stone <Antony.Stone at squid.open.source.it>:

> I think the OP is looking for a way to tell Squid "for this destination 
> hostname, don't even try to connect over IPv6, because if you do, we'll get 
> rejected (not at the network level, but some application-level) so we need you 
> (Squid) to connect using IPv4 only (for this destination)".

Exactly!

-- 
Ralf Hildebrandt
Charit? - Universit?tsmedizin Berlin
Gesch?ftsbereich IT | Abteilung Netzwerk

Campus Benjamin Franklin (CBF)
Haus I | 1. OG | Raum 105
Hindenburgdamm 30 | D-12203 Berlin

Tel. +49 30 450 570 155
ralf.hildebrandt at charite.de
https://www.charite.de


From rousskov at measurement-factory.com  Tue Apr 18 13:37:51 2023
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Tue, 18 Apr 2023 09:37:51 -0400
Subject: [squid-users] [ext] Re: Disable IPV6 for certain destinations
 only?
In-Reply-To: <ZD6XnYdEFHOzlQd2@charite.de>
References: <ZD5I5nURK5iOlBf7@charite.de>
 <f4a1d8bf-185d-0b51-d597-fed5efa300bf@measurement-factory.com>
 <202304181458.11356.Antony.Stone@squid.open.source.it>
 <ZD6XnYdEFHOzlQd2@charite.de>
Message-ID: <eec41ad3-8cda-79ea-96d0-ba03d9227e0d@measurement-factory.com>

On 4/18/23 09:14, Ralf Hildebrandt wrote:
> * Antony Stone <Antony.Stone at squid.open.source.it>:
> 
>> I think the OP is looking for a way to tell Squid "for this destination
>> hostname, don't even try to connect over IPv6, because if you do, we'll get
>> rejected (not at the network level, but some application-level) so we need you
>> (Squid) to connect using IPv4 only (for this destination)".

> Exactly!

I apologize for misinterpreting your needs. I should have paid more 
attention to the Subject line of your email. My last paragraph (quoted 
below) is the only relevant one then.

Cheers,

Alex.

> On 4/18/23 08:53, Alex Rousskov wrote:
> 
>> You can also replace your DNS resolver with a custom one (that drops 
>> AAAA answers) or, as Adam has suggested, with hard-coded IPv4-only 
>> /etc/hosts entries.



From my.shellac at gmail.com  Tue Apr 18 15:41:47 2023
From: my.shellac at gmail.com (=?UTF-8?B?QWxleGV50Y/RgCBHcnV6ZG92?=)
Date: Tue, 18 Apr 2023 20:41:47 +0500
Subject: [squid-users] cache_peer_access by dynamic ACL
Message-ID: <CAFqyDwB82whYStQnbLcjX8JUyostgeMgiWQP1o0UxoYs9FKJyQ@mail.gmail.com>

Hello Guys!

Could you explain me how the annotation transaction works and how it
related to acl that I could to use with cache_peers

ok! Lets look to my case example:

1. I have three of cache_peers:

     cache_peer peerG1.com parent 40001 0 no-query no-digest
name=peerG1 round-robin
     cache_peer peerG2.com parent 40002 0 no-query no-digest
name=peerG2 round-robin
     cache_peer peerG3.com parent 40003 0 no-query no-digest
name=peerG3 round-robin

2. I have cache_peer_acces policy:

     cache_peer_access peerG1 allow proxy_peerG1_acl cache_peer_access
peerG1 allow proxy_all_acl cache_peer_access peerG1 deny all

     cache_peer_access peerG2 allow proxy_peerG2_acl cache_peer_access
peerG2 allow proxy_all_acl cache_peer_access peerG2 deny all

     cache_peer_access peerG3 allow proxy_peerG3_acl
cache_peer_access peerG3 allow proxy_all_acl cache_peer_access peerG3 deny
all 3. And of course ACL defined: proxy_peerG1_acl proxy_auth  "../users.
peerG1.txt" proxy_peerG2_acl proxy_auth  "../users.peerG2.txt"
proxy_peerG3_acl proxy_auth  "../users.peerG3.txt"  proxy_all_acl proxy_auth
"../users.all.txt"
And these all works like I need, But - once I am changing a list of users
(add or remove) - I need to use "squid -k reconfigure"...... but of course
better to go without this reconfigure and use ACL like in a dynamic mode.
Squid supports the external ACL, but this is slow ACL, but cache_peer
doesn't support the low_acl. Also there is one more option - called
annotation_transaction - could you explain me how I could to use this in my
case ? Thank you. AlexG
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230418/d9fb1ba3/attachment.htm>

From rousskov at measurement-factory.com  Tue Apr 18 19:43:50 2023
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Tue, 18 Apr 2023 15:43:50 -0400
Subject: [squid-users] cache_peer_access by dynamic ACL
In-Reply-To: <CAFqyDwB82whYStQnbLcjX8JUyostgeMgiWQP1o0UxoYs9FKJyQ@mail.gmail.com>
References: <CAFqyDwB82whYStQnbLcjX8JUyostgeMgiWQP1o0UxoYs9FKJyQ@mail.gmail.com>
Message-ID: <647cd5f1-851c-4937-2ced-561f2e704f55@measurement-factory.com>

On 4/18/23 11:41, Alexey?? Gruzdov wrote:

> Could you explain me how the annotation transaction works and how it 
> related to acl that I could to use with cache_peers

Transactions have a (possibly empty) set of name=value annotations.

During Squid configuration time, Squid parses all ACL declarations in 
your configuration file. When Squid parses an annotation_transaction ACL 
declaration, Squid remembers what transaction annotation to add in the 
future, [every time] when that ACL is evaluated (e.g., used in 
http_access rule that Squid reaches during transaction processing).

When evaluated, an "annotation_transaction" ACL simply adds the 
previously configured annotation to the current transaction and returns 
a "yes, this transaction matches" result.

When evaluated, a "note" ACL returns a "yes, this transaction matches" 
result if and only if the current transaction already has the matching 
annotation. This ACL does not modify the set of transaction annotations.

The combination of annotate_transaction and note ACLs allows you to 
annotate a transaction at one time and check previously set transaction 
annotations at another time. The timing and meaning of those annotations 
are up to you.


> ok! Lets look to my case example:

> cache_peer peerG1.com parent 40001 0 no-query no-digest name=peerG1?round-robin

> cache_peer_access  peerG1 allow proxy_peerG1_acl
> cache_peer_access  peerG1 allow proxy_all_acl
> cache_peer_access  peerG1 deny all

> acl proxy_peerG1_acl  proxy_auth  "../users.peerG1.txt"
> acl proxy_all_acl  proxy_auth  "../users.all.txt"

[ I added the missing "acl " directive to the above ACL declarations and 
stripped rules for two out of three cache_peers ]

As you know, the above cache_peer_access configuration is not supported 
because it uses "slow" proxy_auth ACLs in cache_peer_access directives 
that only support "fast" ACLs. It does not matter (to me), whether the 
above appears to "work" in some environments. YMMV.

To fix this problem, we can use http_access rules to essentially 
remember proxy_auth evaluation results (at http_access evaluation time) 
as transaction annotations. Here is an untested sketch that omits other 
(important but irrelevant here) http_access rules and assumes that these 
sketched http_access rules _are_ evaluated:

   # if proxy_peerG1_acl matches, evaluate mark_for_peerG1
   http_access deny proxy_peerG1_acl mark_for_peerG1 !all

   # if proxy_all_acl matches, evaluate mark_for_all_peers
   http_access deny proxy_all_acl mark_for_all_peers !all


Now we can use those remembered proxy_... acl evaluation results (i.e. 
we can check for the matching annotations) in cache_peer_access rules:

   cache_peer_access peerG1 allow marked_for_peerG1
   cache_peer_access peerG1 allow marked_for_all_peers
   cache_peer_access peerG1 deny all


where the new ACLs mentioned above are declared along these lines:

   acl mark_for_peerG1 annotate_transaction for_peer_=G1
   acl mark_for_all_peers annotate_transaction for_all_peers_=true

   acl marked_for_peerG1 note for_peer_ G1
   acl marked_for_all_peers note for_all_peers_ true

This can probably be simplified further by using for_peer_=ALL instead 
of for_all_peers_=true annotation, but I wanted to preserve the symmetry 
with your original configuration.


> And these all works like I need, But - once I am changing a list of 
> users (add or remove) - I need to use "squid -k reconfigure"...... but 
> of course better to go without this reconfigure

One can avoid reconfiguration using an external ACL script that gives 
Squid the right for_peer_=... annotations (instead of using "constant" 
or "hard-coded" annotate_transaction ACLs to store the same annotations).

However, it may be better to make the above sketch to work _before_ you 
replace mark_for_peerG1 ACLs/rules with an external 
mark_for_the_right_peer ACL.


HTH,

Alex.
P.S. This thread continues the discussion started at
https://bugs.squid-cache.org/show_bug.cgi?id=5268



From stu at spacehopper.org  Wed Apr 19 08:08:14 2023
From: stu at spacehopper.org (Stuart Henderson)
Date: Wed, 19 Apr 2023 08:08:14 -0000 (UTC)
Subject: [squid-users] Disable IPV6 for certain destinations only?
References: <ZD5I5nURK5iOlBf7@charite.de>
Message-ID: <slrnu3v8be.75m.stu.lists@naiad.spacehopper.org>

On 2023-04-18, Ralf Hildebrandt <Ralf.Hildebrandt at charite.de> wrote:
> Hi!
>
> We're using squid-6, currently v4 only. The use case for us is mostly
> our users using our proxy to retrieve full text publications of
> several thousand medical journals... via IPv4.
>
> The publishers "know" our IPv4 range for the proxies and allow us to
> download freely. What they don't (yet) know is our ipv6 range.
>
> Thus arises the need to "fall back" to ipv4 in the unlikely case some
> publisher already has ipv6, we connect via ipv6 and suddenly are not
> allowed to download the publications.
>
> Is there an acl for that kind of need?

I guess you want something akin to Postfix's smtp_dns_reply_filter but
most software doesn't have anything similar.

Without code changes, the simplest quick fix may be to add a static
'reject' route to the IPv6 block used by this publisher on the proxy (it
could be kept up-to-date by a dns lookup script). That's less of a
liability than forcing resolution to a particular IP.




From Ralf.Hildebrandt at charite.de  Wed Apr 19 09:01:25 2023
From: Ralf.Hildebrandt at charite.de (Ralf Hildebrandt)
Date: Wed, 19 Apr 2023 11:01:25 +0200
Subject: [squid-users] [ext] Re: Disable IPV6 for certain destinations
 only?
In-Reply-To: <slrnu3v8be.75m.stu.lists@naiad.spacehopper.org>
References: <ZD5I5nURK5iOlBf7@charite.de>
 <slrnu3v8be.75m.stu.lists@naiad.spacehopper.org>
Message-ID: <ZD+t5cDnBO3DHsU+@charite.de>

* Stuart Henderson <stu at spacehopper.org>:

> I guess you want something akin to Postfix's smtp_dns_reply_filter but
> most software doesn't have anything similar.

One should expect me to be familiar with Postfix, but THAT option is new
to me :)
 
> Without code changes, the simplest quick fix may be to add a static
> 'reject' route to the IPv6 block used by this publisher on the proxy (it
> could be kept up-to-date by a dns lookup script). That's less of a
> liability than forcing resolution to a particular IP.

Also a nice option.

-- 
Ralf Hildebrandt
Charit? - Universit?tsmedizin Berlin
Gesch?ftsbereich IT | Abteilung Netzwerk

Campus Benjamin Franklin (CBF)
Haus I | 1. OG | Raum 105
Hindenburgdamm 30 | D-12203 Berlin

Tel. +49 30 450 570 155
ralf.hildebrandt at charite.de
https://www.charite.de


From squid3 at treenet.co.nz  Wed Apr 19 14:29:12 2023
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Thu, 20 Apr 2023 02:29:12 +1200
Subject: [squid-users] Instructions to build Squid proxy for Windows
In-Reply-To: <CAHKpMQ8UhAm3=7AAnCtbxmMz7V3HXVWem3YqRz-nmKK_fMO6hA@mail.gmail.com>
References: <CAHKpMQ8UhAm3=7AAnCtbxmMz7V3HXVWem3YqRz-nmKK_fMO6hA@mail.gmail.com>
Message-ID: <1f1858a1-bf83-ad29-3619-9bfc2df8acf1@treenet.co.nz>

On 18/04/2023 10:22 pm, Harsh Seattle wrote:
> Hi All,
>
> As mentioned on the page- 
> https://wiki.squid-cache.org/KnowledgeBase/Windows, the pre-built 
> binary packages are available for Squid 3.3 and 4.?However, the 
> current stable version of Squid is 5 with version 6 and 7 already 
> under development.
>
> Given that pre-built packages are not readily available for Windows, I 
> am hoping to compile version 5/6/7 for Windows. However, the 
> instructions provided here- 
> https://wiki.squid-cache.org/KnowledgeBase/Windows#compiling are not 
> user friendly and sort of incomplete.

FYI, The OS-specific pages assume you are already somewhat familiar with 
building code. So that page lists the build details that are unusual and 
specific to Windows.

The full build instructions are at 
https://wiki.squid-cache.org/SquidFaq/CompilingSquid


> Does anyone have any experience in compiling Squid for Windows? If so, 
> can you please share instructions for the same?

The Windows situation is a bit complicated, as you can see by the number 
of sub-sections in that "#compiling" section.

Cygwin has been maintained by Diladele. I am not sure what the current 
situation with v5+ is there.
Mingw64 was building a few versions ago, but had some C++11/17 support 
issues to work out.

If you want to try a build, identifying the process issues and/or fixes 
are very welcome. Feedback on squid-dev mailing list or our bugzilla please.


HTH
Amos



From rousskov at measurement-factory.com  Wed Apr 19 18:39:45 2023
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Wed, 19 Apr 2023 14:39:45 -0400
Subject: [squid-users] cache_peer_access by dynamic ACL
In-Reply-To: <CAFqyDwBWrZ_O-yXr0J9Bb4HqWvfq8HR+_4QPVgueQ7Pa=OmeFQ@mail.gmail.com>
References: <CAFqyDwB82whYStQnbLcjX8JUyostgeMgiWQP1o0UxoYs9FKJyQ@mail.gmail.com>
 <647cd5f1-851c-4937-2ced-561f2e704f55@measurement-factory.com>
 <CAFqyDwDt-dzfVbi5s91sEgB=viNovRjP=OWNTZrY1CVCv5SNJQ@mail.gmail.com>
 <CAFqyDwBWrZ_O-yXr0J9Bb4HqWvfq8HR+_4QPVgueQ7Pa=OmeFQ@mail.gmail.com>
Message-ID: <5a11ceaa-c3f4-4a80-3ac4-9df3c8be3c3e@measurement-factory.com>

On 4/19/23 13:30, Alexey?? Gruzdov wrote:

> cache_peer peerG1.com parent 40001 0 no-query no-digest name=peerG1

> external_acl_type ext_proxy_g1_type %LOGIN %DST /usr/local/bin/g1.py

> acl?proxy_g1_ext_acl?ext_proxy_g1_type

OK. I assume that /usr/local/bin/g1.py will only match users that should 
go to cache_peer called peerG1.


> acl?proxy_g1_ext_acl_mark? annotate_transaction proxy=g1

Please note that the name of this annotate_transaction ACL -- 
"proxy_g1_ext_acl_mark" -- implies a relationship to the external ACL 
named "proxy_g1_ext_acl", but there is no such relationship. Squid does 
not care about ACL names, but this naming problem may indicate a 
misunderstanding. To follow your naming scheme, this ACL should be 
called something like "proxy_g1_mark_acl" or "mark_for_proxy_g1_acl".


> acl proxy_peerG1_acl?note proxy g1

OK. FWIW, a more consistent ACL name would have been 
"proxy_g1_marked_acl" or "marked_for_proxy_g1_acl". Again, Squid does 
not really care about these names, so use whatever you think is 
consistent/meaningful/etc.


> http_access deny proxy_g1_ext_acl !all

This line has no (positive) effect. Squid will evaluate the external 
ACL, but since the rule, as a whole, will never match due to "!all", and 
since the external ACL has no (relevant) side effects, you can just 
delete this line from your configuration.

Needless to say, if you delete this line, then proxy_g1_ext_acl will be 
unused, which should tell you that this configuration is not doing what 
you want. See below for a fix recommendation.


> http_access deny proxy_g1_ext_acl_mark !all

This line will mark _all_ transactions. You only want to mark 
transactions that also matched proxy_g1_ext_acl. That "b only if a" 
logic is accomplished by using _both_ ACLs in the same rule:

   http_access deny proxy_g1_ext_acl proxy_g1_ext_acl_mark !all

With the above http_access rule (instead of the earlier two), Squid will 
evaluate the external ACL, and, if it matches, Squid will also evaluate 
the annotation-setting ACL. The whole rule will then be rejected due to 
"!all", but not until it annotates the transaction (if the external ACL 
matches). Again, in this sketch, we are using this rule for its 
annotation side effect only.


> And this works like I need now....

AFAICT, if the tests indicate that this configuration works, then the 
tests are broken. IMHO, you should fix the tests (while you have a 
broken configuration that can be used to test the tests) before 
proceeding with the configuration fix.


HTH,

Alex.
P.S. Please keep this email thread on squid-users instead of responding 
to me personally.




> ??, 19 ???. 2023??. ? 21:01, Alexey?? Gruzdov:
> 
>     so, ok? - Lets limit just to one cache peer and one single ACL (just
>     to understand the logic):
> 
>      ?cache_peer peerG1.com parent 40001 0 no-query no-digest name=peerG1
> 
>      ?external_acl_type ext_proxy_g1_type %LOGIN %DST
>     /usr/local/bin/g1.py? ?(this will answer "OK"? or "ERR", depends if
>     user consists in DB)
> 
>      ?acl?proxy_g1_ext_acl? ext_proxy_g1_type?annotate_transaction
>     proxy=g1? ?(If I right understood here is a key point of how to add
>     the tag to transaction related with user)
>      ?acl proxy_peerG1_acl?note proxy g1? (here we create the ACL based
>     on the tag and this is fast ACL yet and we should to use it in
>     cache_peer_access)
> 
> 
>     http_access deny proxy_g1_ext_acl !all
>     ......<others http access rules>
> 
> 
>     cache_peer_access peerG1 allow proxy_peerG1_acl
>     cache_peer_access peerG1 deny all
> 
>     Is that correct ?
> 
>     ??, 18 ???. 2023??. ? 23:44, Alex Rousskov
>     <rousskov at measurement-factory.com
>     <mailto:rousskov at measurement-factory.com>>:
> 
>         On 4/18/23 11:41, Alexey?? Gruzdov wrote:
> 
>          > Could you explain me how the annotation transaction works and
>         how it
>          > related to acl that I could to use with cache_peers
> 
>         Transactions have a (possibly empty) set of name=value annotations.
> 
>         During Squid configuration time, Squid parses all ACL
>         declarations in
>         your configuration file. When Squid parses an
>         annotation_transaction ACL
>         declaration, Squid remembers what transaction annotation to add
>         in the
>         future, [every time] when that ACL is evaluated (e.g., used in
>         http_access rule that Squid reaches during transaction processing).
> 
>         When evaluated, an "annotation_transaction" ACL simply adds the
>         previously configured annotation to the current transaction and
>         returns
>         a "yes, this transaction matches" result.
> 
>         When evaluated, a "note" ACL returns a "yes, this transaction
>         matches"
>         result if and only if the current transaction already has the
>         matching
>         annotation. This ACL does not modify the set of transaction
>         annotations.
> 
>         The combination of annotate_transaction and note ACLs allows you to
>         annotate a transaction at one time and check previously set
>         transaction
>         annotations at another time. The timing and meaning of those
>         annotations
>         are up to you.
> 
> 
>          > ok! Lets look to my case example:
> 
>          > cache_peer peerG1.com parent 40001 0 no-query no-digest
>         name=peerG1?round-robin
> 
>          > cache_peer_access? peerG1 allow proxy_peerG1_acl
>          > cache_peer_access? peerG1 allow proxy_all_acl
>          > cache_peer_access? peerG1 deny all
> 
>          > acl proxy_peerG1_acl? proxy_auth? "../users.peerG1.txt"
>          > acl proxy_all_acl? proxy_auth? "../users.all.txt"
> 
>         [ I added the missing "acl " directive to the above ACL
>         declarations and
>         stripped rules for two out of three cache_peers ]
> 
>         As you know, the above cache_peer_access configuration is not
>         supported
>         because it uses "slow" proxy_auth ACLs in cache_peer_access
>         directives
>         that only support "fast" ACLs. It does not matter (to me),
>         whether the
>         above appears to "work" in some environments. YMMV.
> 
>         To fix this problem, we can use http_access rules to essentially
>         remember proxy_auth evaluation results (at http_access
>         evaluation time)
>         as transaction annotations. Here is an untested sketch that
>         omits other
>         (important but irrelevant here) http_access rules and assumes
>         that these
>         sketched http_access rules _are_ evaluated:
> 
>          ? ?# if proxy_peerG1_acl matches, evaluate mark_for_peerG1
>          ? ?http_access deny proxy_peerG1_acl mark_for_peerG1 !all
> 
>          ? ?# if proxy_all_acl matches, evaluate mark_for_all_peers
>          ? ?http_access deny proxy_all_acl mark_for_all_peers !all
> 
> 
>         Now we can use those remembered proxy_... acl evaluation results
>         (i.e.
>         we can check for the matching annotations) in cache_peer_access
>         rules:
> 
>          ? ?cache_peer_access peerG1 allow marked_for_peerG1
>          ? ?cache_peer_access peerG1 allow marked_for_all_peers
>          ? ?cache_peer_access peerG1 deny all
> 
> 
>         where the new ACLs mentioned above are declared along these lines:
> 
>          ? ?acl mark_for_peerG1 annotate_transaction for_peer_=G1
>          ? ?acl mark_for_all_peers annotate_transaction for_all_peers_=true
> 
>          ? ?acl marked_for_peerG1 note for_peer_ G1
>          ? ?acl marked_for_all_peers note for_all_peers_ true
> 
>         This can probably be simplified further by using for_peer_=ALL
>         instead
>         of for_all_peers_=true annotation, but I wanted to preserve the
>         symmetry
>         with your original configuration.
> 
> 
>          > And these all works like I need, But - once I am changing a
>         list of
>          > users (add or remove) - I need to use "squid -k
>         reconfigure"...... but
>          > of course better to go without this reconfigure
> 
>         One can avoid reconfiguration using an external ACL script that
>         gives
>         Squid the right for_peer_=... annotations (instead of using
>         "constant"
>         or "hard-coded" annotate_transaction ACLs to store the same
>         annotations).
> 
>         However, it may be better to make the above sketch to work
>         _before_ you
>         replace mark_for_peerG1 ACLs/rules with an external
>         mark_for_the_right_peer ACL.
> 
> 
>         HTH,
> 
>         Alex.
>         P.S. This thread continues the discussion started at
>         https://bugs.squid-cache.org/show_bug.cgi?id=5268
>         <https://bugs.squid-cache.org/show_bug.cgi?id=5268>
> 
>         _______________________________________________
>         squid-users mailing list
>         squid-users at lists.squid-cache.org
>         <mailto:squid-users at lists.squid-cache.org>
>         http://lists.squid-cache.org/listinfo/squid-users
>         <http://lists.squid-cache.org/listinfo/squid-users>
> 
> 
> 
>     -- 
>     ? ????????? ? ???
>     ???????
>     +79043828661
>     620000 ?.???????????? ?2022
> 
> 
> 
> -- 
> ? ????????? ? ???
> ???????
> +79043828661
> 620000 ?.???????????? ?2022
> 



From my.shellac at gmail.com  Thu Apr 20 08:23:49 2023
From: my.shellac at gmail.com (=?UTF-8?B?QWxleGV50Y/RgCBHcnV6ZG92?=)
Date: Thu, 20 Apr 2023 12:23:49 +0400
Subject: [squid-users] cache_peer_access by dynamic ACL
In-Reply-To: <5a11ceaa-c3f4-4a80-3ac4-9df3c8be3c3e@measurement-factory.com>
References: <CAFqyDwB82whYStQnbLcjX8JUyostgeMgiWQP1o0UxoYs9FKJyQ@mail.gmail.com>
 <647cd5f1-851c-4937-2ced-561f2e704f55@measurement-factory.com>
 <CAFqyDwDt-dzfVbi5s91sEgB=viNovRjP=OWNTZrY1CVCv5SNJQ@mail.gmail.com>
 <CAFqyDwBWrZ_O-yXr0J9Bb4HqWvfq8HR+_4QPVgueQ7Pa=OmeFQ@mail.gmail.com>
 <5a11ceaa-c3f4-4a80-3ac4-9df3c8be3c3e@measurement-factory.com>
Message-ID: <CAFqyDwBsFU80tc5TsAuG109o9XGuMP7dXZ4rSnvuX4Js6CiHWg@mail.gmail.com>

Thank you!  so ok.

I configured like:

cache_peer peerG1.com parent 40001 0 no-query no-digest name=peerG1

external_acl_type ext_proxy_g1_type %LOGIN %DST /usr/local/bin/g1.py

acl proxy_g1_ext_mark_acl  ext_proxy_g1_type

acl proxy_g1_ext_marked_acl  annotate_transaction proxy=g1

acl proxy_peerG1_acl note proxy g1

http_access deny proxy_g1_ext_mark_acl  proxy_g1_ext_marked_acl !all   (
looks like this rule making the main magic of all,  )
.....
others http_access rules

And this above works.
BUT
I am worried about why this my external script for ACL  type loads the one
of core of CPU to 100%.....??? ( I used three of workers in config, but I
can see a six process called like my external helper script, looks like
squid runs x2 process for external ACL )


Because if I will put the one more group of users (that must to use another
cache_peer ) - I will need to create one more external script that will
making to check an existed users from an other DB table


??, 19 ???. 2023??. ? 22:39, Alex Rousskov <rousskov at measurement-factory.com
>:

> On 4/19/23 13:30, Alexey?? Gruzdov wrote:
>
> > cache_peer peerG1.com parent 40001 0 no-query no-digest name=peerG1
>
> > external_acl_type ext_proxy_g1_type %LOGIN %DST /usr/local/bin/g1.py
>
> > acl proxy_g1_ext_acl ext_proxy_g1_type
>
> OK. I assume that /usr/local/bin/g1.py will only match users that should
> go to cache_peer called peerG1.
>
>
> > acl proxy_g1_ext_acl_mark  annotate_transaction proxy=g1
>
> Please note that the name of this annotate_transaction ACL --
> "proxy_g1_ext_acl_mark" -- implies a relationship to the external ACL
> named "proxy_g1_ext_acl", but there is no such relationship. Squid does
> not care about ACL names, but this naming problem may indicate a
> misunderstanding. To follow your naming scheme, this ACL should be
> called something like "proxy_g1_mark_acl" or "mark_for_proxy_g1_acl".
>
>
> > acl proxy_peerG1_acl note proxy g1
>
> OK. FWIW, a more consistent ACL name would have been
> "proxy_g1_marked_acl" or "marked_for_proxy_g1_acl". Again, Squid does
> not really care about these names, so use whatever you think is
> consistent/meaningful/etc.
>
>
> > http_access deny proxy_g1_ext_acl !all
>
> This line has no (positive) effect. Squid will evaluate the external
> ACL, but since the rule, as a whole, will never match due to "!all", and
> since the external ACL has no (relevant) side effects, you can just
> delete this line from your configuration.
>
> Needless to say, if you delete this line, then proxy_g1_ext_acl will be
> unused, which should tell you that this configuration is not doing what
> you want. See below for a fix recommendation.
>
>
> > http_access deny proxy_g1_ext_acl_mark !all
>
> This line will mark _all_ transactions. You only want to mark
> transactions that also matched proxy_g1_ext_acl. That "b only if a"
> logic is accomplished by using _both_ ACLs in the same rule:
>
>    http_access deny proxy_g1_ext_acl proxy_g1_ext_acl_mark !all
>
> With the above http_access rule (instead of the earlier two), Squid will
> evaluate the external ACL, and, if it matches, Squid will also evaluate
> the annotation-setting ACL. The whole rule will then be rejected due to
> "!all", but not until it annotates the transaction (if the external ACL
> matches). Again, in this sketch, we are using this rule for its
> annotation side effect only.
>
>
> > And this works like I need now....
>
> AFAICT, if the tests indicate that this configuration works, then the
> tests are broken. IMHO, you should fix the tests (while you have a
> broken configuration that can be used to test the tests) before
> proceeding with the configuration fix.
>
>
> HTH,
>
> Alex.
> P.S. Please keep this email thread on squid-users instead of responding
> to me personally.
>
>
>
>
> > ??, 19 ???. 2023??. ? 21:01, Alexey?? Gruzdov:
> >
> >     so, ok  - Lets limit just to one cache peer and one single ACL (just
> >     to understand the logic):
> >
> >       cache_peer peerG1.com parent 40001 0 no-query no-digest name=peerG1
> >
> >       external_acl_type ext_proxy_g1_type %LOGIN %DST
> >     /usr/local/bin/g1.py   (this will answer "OK"  or "ERR", depends if
> >     user consists in DB)
> >
> >       acl proxy_g1_ext_acl  ext_proxy_g1_type annotate_transaction
> >     proxy=g1   (If I right understood here is a key point of how to add
> >     the tag to transaction related with user)
> >       acl proxy_peerG1_acl note proxy g1  (here we create the ACL based
> >     on the tag and this is fast ACL yet and we should to use it in
> >     cache_peer_access)
> >
> >
> >     http_access deny proxy_g1_ext_acl !all
> >     ......<others http access rules>
> >
> >
> >     cache_peer_access peerG1 allow proxy_peerG1_acl
> >     cache_peer_access peerG1 deny all
> >
> >     Is that correct ?
> >
> >     ??, 18 ???. 2023??. ? 23:44, Alex Rousskov
> >     <rousskov at measurement-factory.com
> >     <mailto:rousskov at measurement-factory.com>>:
> >
> >         On 4/18/23 11:41, Alexey?? Gruzdov wrote:
> >
> >          > Could you explain me how the annotation transaction works and
> >         how it
> >          > related to acl that I could to use with cache_peers
> >
> >         Transactions have a (possibly empty) set of name=value
> annotations.
> >
> >         During Squid configuration time, Squid parses all ACL
> >         declarations in
> >         your configuration file. When Squid parses an
> >         annotation_transaction ACL
> >         declaration, Squid remembers what transaction annotation to add
> >         in the
> >         future, [every time] when that ACL is evaluated (e.g., used in
> >         http_access rule that Squid reaches during transaction
> processing).
> >
> >         When evaluated, an "annotation_transaction" ACL simply adds the
> >         previously configured annotation to the current transaction and
> >         returns
> >         a "yes, this transaction matches" result.
> >
> >         When evaluated, a "note" ACL returns a "yes, this transaction
> >         matches"
> >         result if and only if the current transaction already has the
> >         matching
> >         annotation. This ACL does not modify the set of transaction
> >         annotations.
> >
> >         The combination of annotate_transaction and note ACLs allows you
> to
> >         annotate a transaction at one time and check previously set
> >         transaction
> >         annotations at another time. The timing and meaning of those
> >         annotations
> >         are up to you.
> >
> >
> >          > ok! Lets look to my case example:
> >
> >          > cache_peer peerG1.com parent 40001 0 no-query no-digest
> >         name=peerG1 round-robin
> >
> >          > cache_peer_access  peerG1 allow proxy_peerG1_acl
> >          > cache_peer_access  peerG1 allow proxy_all_acl
> >          > cache_peer_access  peerG1 deny all
> >
> >          > acl proxy_peerG1_acl  proxy_auth  "../users.peerG1.txt"
> >          > acl proxy_all_acl  proxy_auth  "../users.all.txt"
> >
> >         [ I added the missing "acl " directive to the above ACL
> >         declarations and
> >         stripped rules for two out of three cache_peers ]
> >
> >         As you know, the above cache_peer_access configuration is not
> >         supported
> >         because it uses "slow" proxy_auth ACLs in cache_peer_access
> >         directives
> >         that only support "fast" ACLs. It does not matter (to me),
> >         whether the
> >         above appears to "work" in some environments. YMMV.
> >
> >         To fix this problem, we can use http_access rules to essentially
> >         remember proxy_auth evaluation results (at http_access
> >         evaluation time)
> >         as transaction annotations. Here is an untested sketch that
> >         omits other
> >         (important but irrelevant here) http_access rules and assumes
> >         that these
> >         sketched http_access rules _are_ evaluated:
> >
> >             # if proxy_peerG1_acl matches, evaluate mark_for_peerG1
> >             http_access deny proxy_peerG1_acl mark_for_peerG1 !all
> >
> >             # if proxy_all_acl matches, evaluate mark_for_all_peers
> >             http_access deny proxy_all_acl mark_for_all_peers !all
> >
> >
> >         Now we can use those remembered proxy_... acl evaluation results
> >         (i.e.
> >         we can check for the matching annotations) in cache_peer_access
> >         rules:
> >
> >             cache_peer_access peerG1 allow marked_for_peerG1
> >             cache_peer_access peerG1 allow marked_for_all_peers
> >             cache_peer_access peerG1 deny all
> >
> >
> >         where the new ACLs mentioned above are declared along these
> lines:
> >
> >             acl mark_for_peerG1 annotate_transaction for_peer_=G1
> >             acl mark_for_all_peers annotate_transaction
> for_all_peers_=true
> >
> >             acl marked_for_peerG1 note for_peer_ G1
> >             acl marked_for_all_peers note for_all_peers_ true
> >
> >         This can probably be simplified further by using for_peer_=ALL
> >         instead
> >         of for_all_peers_=true annotation, but I wanted to preserve the
> >         symmetry
> >         with your original configuration.
> >
> >
> >          > And these all works like I need, But - once I am changing a
> >         list of
> >          > users (add or remove) - I need to use "squid -k
> >         reconfigure"...... but
> >          > of course better to go without this reconfigure
> >
> >         One can avoid reconfiguration using an external ACL script that
> >         gives
> >         Squid the right for_peer_=... annotations (instead of using
> >         "constant"
> >         or "hard-coded" annotate_transaction ACLs to store the same
> >         annotations).
> >
> >         However, it may be better to make the above sketch to work
> >         _before_ you
> >         replace mark_for_peerG1 ACLs/rules with an external
> >         mark_for_the_right_peer ACL.
> >
> >
> >         HTH,
> >
> >         Alex.
> >         P.S. This thread continues the discussion started at
> >         https://bugs.squid-cache.org/show_bug.cgi?id=5268
> >         <https://bugs.squid-cache.org/show_bug.cgi?id=5268>
> >
> >         _______________________________________________
> >         squid-users mailing list
> >         squid-users at lists.squid-cache.org
> >         <mailto:squid-users at lists.squid-cache.org>
> >         http://lists.squid-cache.org/listinfo/squid-users
> >         <http://lists.squid-cache.org/listinfo/squid-users>
> >
> >
> >
> >     --
> >     ? ????????? ? ???
> >     ???????
> >     +79043828661
> >     620000 ?.????????????  2022
> >
> >
> >
> > --
> > ? ????????? ? ???
> > ???????
> > +79043828661
> > 620000 ?.????????????  2022
> >
>
>

-- 
? ????????? ? ???
???????
+79043828661
620000 ?.????????????  2022
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230420/fffacc33/attachment.htm>

From rousskov at measurement-factory.com  Thu Apr 20 13:21:37 2023
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Thu, 20 Apr 2023 09:21:37 -0400
Subject: [squid-users] cache_peer_access by dynamic ACL
In-Reply-To: <CAFqyDwBsFU80tc5TsAuG109o9XGuMP7dXZ4rSnvuX4Js6CiHWg@mail.gmail.com>
References: <CAFqyDwB82whYStQnbLcjX8JUyostgeMgiWQP1o0UxoYs9FKJyQ@mail.gmail.com>
 <647cd5f1-851c-4937-2ced-561f2e704f55@measurement-factory.com>
 <CAFqyDwDt-dzfVbi5s91sEgB=viNovRjP=OWNTZrY1CVCv5SNJQ@mail.gmail.com>
 <CAFqyDwBWrZ_O-yXr0J9Bb4HqWvfq8HR+_4QPVgueQ7Pa=OmeFQ@mail.gmail.com>
 <5a11ceaa-c3f4-4a80-3ac4-9df3c8be3c3e@measurement-factory.com>
 <CAFqyDwBsFU80tc5TsAuG109o9XGuMP7dXZ4rSnvuX4Js6CiHWg@mail.gmail.com>
Message-ID: <4e3df8c9-52a7-1afd-b3d3-6971cdae75fb@measurement-factory.com>

On 4/20/23 04:23, Alexey?? Gruzdov wrote:

> cache_peer peerG1.com parent 40001 0 no-query no-digest name=peerG1
> 
> external_acl_type ext_proxy_g1_type %LOGIN %DST /usr/local/bin/g1.py
> 
> acl?proxy_g1_ext_mark_acl? ext_proxy_g1_type
> 
> acl?proxy_g1_ext_marked_acl? annotate_transaction proxy=g1
> 
> acl proxy_peerG1_acl?note proxy g1
> 
> http_access deny proxy_g1_ext_mark_acl??proxy_g1_ext_marked_acl?!all
> .....
> others http_access rules
> 
> And this above works.

Glad to hear that. ( If others are going to use the above as a guiding 
example, I would recommend naming these ACLs very differently, but that 
is not important to Squid. )


> BUT
> I am worried?about why this my external script for ACL? type loads the 
> one of core of CPU to 100%.....??? 

External ACL caching aside, the script will be contacted once for every 
Squid transaction. Does your script CPU usage go down to zero when there 
is no traffic? If not, then there is a bug in the script itself.

If you use the script from the command line, without Squid, does it 
consume a lot of CPU and/or take a lot of time per fake query? You can 
adjust the script to log the real query (when the script is used by 
Squid), so that you can easily replicate that query when running the 
script without Squid...

The cache key in your case is (the expansion of) "%LOGIN %DST". It is 
enabled by default IIRC. Look for "cache" related options at
http://www.squid-cache.org/Doc/config/external_acl_type/


> ( I used three of workers in config, 
> but I can see a six process called like my external helper script, looks 
> like squid runs x2 process for external ACL )

See external_acl_type children-* options:
http://www.squid-cache.org/Doc/config/external_acl_type/

In most environments, I recommend setting all three of them to the same 
value. Please note that these options are not SMP-aware (yet), so Squid 
will _not_ divide their values by the number of workers and give each 
worker as many children as you state in squid.conf.


> Because if I will put the one more group of users (that must to use 
> another cache_peer ) - I will need to create one more external script 
> that will making to check an existed users from an other?DB table

Once you get the basic setup above working for one group to your 
satisfaction, I would recommend migrating from (one script and one 
matching annotate_transaction ACL) per group to a single script for all 
groups. That single external ACL script will send the right 
annotation(s) to Squid.


HTH,

Alex.


> ??, 19 ???. 2023??. ? 22:39, Alex Rousskov:
> 
>     On 4/19/23 13:30, Alexey?? Gruzdov wrote:
> 
>      > cache_peer peerG1.com parent 40001 0 no-query no-digest name=peerG1
> 
>      > external_acl_type ext_proxy_g1_type %LOGIN %DST /usr/local/bin/g1.py
> 
>      > acl?proxy_g1_ext_acl?ext_proxy_g1_type
> 
>     OK. I assume that /usr/local/bin/g1.py will only match users that
>     should
>     go to cache_peer called peerG1.
> 
> 
>      > acl?proxy_g1_ext_acl_mark? annotate_transaction proxy=g1
> 
>     Please note that the name of this annotate_transaction ACL --
>     "proxy_g1_ext_acl_mark" -- implies a relationship to the external ACL
>     named "proxy_g1_ext_acl", but there is no such relationship. Squid does
>     not care about ACL names, but this naming problem may indicate a
>     misunderstanding. To follow your naming scheme, this ACL should be
>     called something like "proxy_g1_mark_acl" or "mark_for_proxy_g1_acl".
> 
> 
>      > acl proxy_peerG1_acl?note proxy g1
> 
>     OK. FWIW, a more consistent ACL name would have been
>     "proxy_g1_marked_acl" or "marked_for_proxy_g1_acl". Again, Squid does
>     not really care about these names, so use whatever you think is
>     consistent/meaningful/etc.
> 
> 
>      > http_access deny proxy_g1_ext_acl !all
> 
>     This line has no (positive) effect. Squid will evaluate the external
>     ACL, but since the rule, as a whole, will never match due to "!all",
>     and
>     since the external ACL has no (relevant) side effects, you can just
>     delete this line from your configuration.
> 
>     Needless to say, if you delete this line, then proxy_g1_ext_acl will be
>     unused, which should tell you that this configuration is not doing what
>     you want. See below for a fix recommendation.
> 
> 
>      > http_access deny proxy_g1_ext_acl_mark !all
> 
>     This line will mark _all_ transactions. You only want to mark
>     transactions that also matched proxy_g1_ext_acl. That "b only if a"
>     logic is accomplished by using _both_ ACLs in the same rule:
> 
>      ? ?http_access deny proxy_g1_ext_acl proxy_g1_ext_acl_mark !all
> 
>     With the above http_access rule (instead of the earlier two), Squid
>     will
>     evaluate the external ACL, and, if it matches, Squid will also evaluate
>     the annotation-setting ACL. The whole rule will then be rejected due to
>     "!all", but not until it annotates the transaction (if the external ACL
>     matches). Again, in this sketch, we are using this rule for its
>     annotation side effect only.
> 
> 
>      > And this works like I need now....
> 
>     AFAICT, if the tests indicate that this configuration works, then the
>     tests are broken. IMHO, you should fix the tests (while you have a
>     broken configuration that can be used to test the tests) before
>     proceeding with the configuration fix.
> 
> 
>     HTH,
> 
>     Alex.
>     P.S. Please keep this email thread on squid-users instead of responding
>     to me personally.
> 
> 
> 
> 
>      > ??, 19 ???. 2023??. ? 21:01, Alexey?? Gruzdov:
>      >
>      >? ? ?so, ok? - Lets limit just to one cache peer and one single
>     ACL (just
>      >? ? ?to understand the logic):
>      >
>      >? ? ? ?cache_peer peerG1.com parent 40001 0 no-query no-digest
>     name=peerG1
>      >
>      >? ? ? ?external_acl_type ext_proxy_g1_type %LOGIN %DST
>      >? ? ?/usr/local/bin/g1.py? ?(this will answer "OK"? or "ERR",
>     depends if
>      >? ? ?user consists in DB)
>      >
>      >? ? ? ?acl?proxy_g1_ext_acl? ext_proxy_g1_type?annotate_transaction
>      >? ? ?proxy=g1? ?(If I right understood here is a key point of how
>     to add
>      >? ? ?the tag to transaction related with user)
>      >? ? ? ?acl proxy_peerG1_acl?note proxy g1? (here we create the ACL
>     based
>      >? ? ?on the tag and this is fast ACL yet and we should to use it in
>      >? ? ?cache_peer_access)
>      >
>      >
>      >? ? ?http_access deny proxy_g1_ext_acl !all
>      >? ? ?......<others http access rules>
>      >
>      >
>      >? ? ?cache_peer_access peerG1 allow proxy_peerG1_acl
>      >? ? ?cache_peer_access peerG1 deny all
>      >
>      >? ? ?Is that correct ?
>      >
>      >? ? ???, 18 ???. 2023??. ? 23:44, Alex Rousskov
>      >? ? ?<rousskov at measurement-factory.com
>     <mailto:rousskov at measurement-factory.com>
>      >? ? ?<mailto:rousskov at measurement-factory.com
>     <mailto:rousskov at measurement-factory.com>>>:
>      >
>      >? ? ? ? ?On 4/18/23 11:41, Alexey?? Gruzdov wrote:
>      >
>      >? ? ? ? ? > Could you explain me how the annotation transaction
>     works and
>      >? ? ? ? ?how it
>      >? ? ? ? ? > related to acl that I could to use with cache_peers
>      >
>      >? ? ? ? ?Transactions have a (possibly empty) set of name=value
>     annotations.
>      >
>      >? ? ? ? ?During Squid configuration time, Squid parses all ACL
>      >? ? ? ? ?declarations in
>      >? ? ? ? ?your configuration file. When Squid parses an
>      >? ? ? ? ?annotation_transaction ACL
>      >? ? ? ? ?declaration, Squid remembers what transaction annotation
>     to add
>      >? ? ? ? ?in the
>      >? ? ? ? ?future, [every time] when that ACL is evaluated (e.g.,
>     used in
>      >? ? ? ? ?http_access rule that Squid reaches during transaction
>     processing).
>      >
>      >? ? ? ? ?When evaluated, an "annotation_transaction" ACL simply
>     adds the
>      >? ? ? ? ?previously configured annotation to the current
>     transaction and
>      >? ? ? ? ?returns
>      >? ? ? ? ?a "yes, this transaction matches" result.
>      >
>      >? ? ? ? ?When evaluated, a "note" ACL returns a "yes, this transaction
>      >? ? ? ? ?matches"
>      >? ? ? ? ?result if and only if the current transaction already has the
>      >? ? ? ? ?matching
>      >? ? ? ? ?annotation. This ACL does not modify the set of transaction
>      >? ? ? ? ?annotations.
>      >
>      >? ? ? ? ?The combination of annotate_transaction and note ACLs
>     allows you to
>      >? ? ? ? ?annotate a transaction at one time and check previously set
>      >? ? ? ? ?transaction
>      >? ? ? ? ?annotations at another time. The timing and meaning of those
>      >? ? ? ? ?annotations
>      >? ? ? ? ?are up to you.
>      >
>      >
>      >? ? ? ? ? > ok! Lets look to my case example:
>      >
>      >? ? ? ? ? > cache_peer peerG1.com parent 40001 0 no-query no-digest
>      >? ? ? ? ?name=peerG1?round-robin
>      >
>      >? ? ? ? ? > cache_peer_access? peerG1 allow proxy_peerG1_acl
>      >? ? ? ? ? > cache_peer_access? peerG1 allow proxy_all_acl
>      >? ? ? ? ? > cache_peer_access? peerG1 deny all
>      >
>      >? ? ? ? ? > acl proxy_peerG1_acl? proxy_auth? "../users.peerG1.txt"
>      >? ? ? ? ? > acl proxy_all_acl? proxy_auth? "../users.all.txt"
>      >
>      >? ? ? ? ?[ I added the missing "acl " directive to the above ACL
>      >? ? ? ? ?declarations and
>      >? ? ? ? ?stripped rules for two out of three cache_peers ]
>      >
>      >? ? ? ? ?As you know, the above cache_peer_access configuration is not
>      >? ? ? ? ?supported
>      >? ? ? ? ?because it uses "slow" proxy_auth ACLs in cache_peer_access
>      >? ? ? ? ?directives
>      >? ? ? ? ?that only support "fast" ACLs. It does not matter (to me),
>      >? ? ? ? ?whether the
>      >? ? ? ? ?above appears to "work" in some environments. YMMV.
>      >
>      >? ? ? ? ?To fix this problem, we can use http_access rules to
>     essentially
>      >? ? ? ? ?remember proxy_auth evaluation results (at http_access
>      >? ? ? ? ?evaluation time)
>      >? ? ? ? ?as transaction annotations. Here is an untested sketch that
>      >? ? ? ? ?omits other
>      >? ? ? ? ?(important but irrelevant here) http_access rules and assumes
>      >? ? ? ? ?that these
>      >? ? ? ? ?sketched http_access rules _are_ evaluated:
>      >
>      >? ? ? ? ? ? ?# if proxy_peerG1_acl matches, evaluate mark_for_peerG1
>      >? ? ? ? ? ? ?http_access deny proxy_peerG1_acl mark_for_peerG1 !all
>      >
>      >? ? ? ? ? ? ?# if proxy_all_acl matches, evaluate mark_for_all_peers
>      >? ? ? ? ? ? ?http_access deny proxy_all_acl mark_for_all_peers !all
>      >
>      >
>      >? ? ? ? ?Now we can use those remembered proxy_... acl evaluation
>     results
>      >? ? ? ? ?(i.e.
>      >? ? ? ? ?we can check for the matching annotations) in
>     cache_peer_access
>      >? ? ? ? ?rules:
>      >
>      >? ? ? ? ? ? ?cache_peer_access peerG1 allow marked_for_peerG1
>      >? ? ? ? ? ? ?cache_peer_access peerG1 allow marked_for_all_peers
>      >? ? ? ? ? ? ?cache_peer_access peerG1 deny all
>      >
>      >
>      >? ? ? ? ?where the new ACLs mentioned above are declared along
>     these lines:
>      >
>      >? ? ? ? ? ? ?acl mark_for_peerG1 annotate_transaction for_peer_=G1
>      >? ? ? ? ? ? ?acl mark_for_all_peers annotate_transaction
>     for_all_peers_=true
>      >
>      >? ? ? ? ? ? ?acl marked_for_peerG1 note for_peer_ G1
>      >? ? ? ? ? ? ?acl marked_for_all_peers note for_all_peers_ true
>      >
>      >? ? ? ? ?This can probably be simplified further by using
>     for_peer_=ALL
>      >? ? ? ? ?instead
>      >? ? ? ? ?of for_all_peers_=true annotation, but I wanted to
>     preserve the
>      >? ? ? ? ?symmetry
>      >? ? ? ? ?with your original configuration.
>      >
>      >
>      >? ? ? ? ? > And these all works like I need, But - once I am
>     changing a
>      >? ? ? ? ?list of
>      >? ? ? ? ? > users (add or remove) - I need to use "squid -k
>      >? ? ? ? ?reconfigure"...... but
>      >? ? ? ? ? > of course better to go without this reconfigure
>      >
>      >? ? ? ? ?One can avoid reconfiguration using an external ACL
>     script that
>      >? ? ? ? ?gives
>      >? ? ? ? ?Squid the right for_peer_=... annotations (instead of using
>      >? ? ? ? ?"constant"
>      >? ? ? ? ?or "hard-coded" annotate_transaction ACLs to store the same
>      >? ? ? ? ?annotations).
>      >
>      >? ? ? ? ?However, it may be better to make the above sketch to work
>      >? ? ? ? ?_before_ you
>      >? ? ? ? ?replace mark_for_peerG1 ACLs/rules with an external
>      >? ? ? ? ?mark_for_the_right_peer ACL.
>      >
>      >
>      >? ? ? ? ?HTH,
>      >
>      >? ? ? ? ?Alex.
>      >? ? ? ? ?P.S. This thread continues the discussion started at
>      > https://bugs.squid-cache.org/show_bug.cgi?id=5268
>     <https://bugs.squid-cache.org/show_bug.cgi?id=5268>
>      >? ? ? ? ?<https://bugs.squid-cache.org/show_bug.cgi?id=5268
>     <https://bugs.squid-cache.org/show_bug.cgi?id=5268>>
>      >
>      >? ? ? ? ?_______________________________________________
>      >? ? ? ? ?squid-users mailing list
>      > squid-users at lists.squid-cache.org
>     <mailto:squid-users at lists.squid-cache.org>
>      >? ? ? ? ?<mailto:squid-users at lists.squid-cache.org
>     <mailto:squid-users at lists.squid-cache.org>>
>      > http://lists.squid-cache.org/listinfo/squid-users
>     <http://lists.squid-cache.org/listinfo/squid-users>
>      >? ? ? ? ?<http://lists.squid-cache.org/listinfo/squid-users
>     <http://lists.squid-cache.org/listinfo/squid-users>>
>      >
>      >
>      >
>      >? ? ?--
>      >? ? ?? ????????? ? ???
>      >? ? ????????
>      >? ? ?+79043828661
>      >? ? ?620000 ?.???????????? ?2022
>      >
>      >
>      >
>      > --
>      > ? ????????? ? ???
>      > ???????
>      > +79043828661
>      > 620000 ?.???????????? ?2022
>      >
> 
> 
> 
> -- 
> ? ????????? ? ???
> ???????
> +79043828661
> 620000 ?.???????????? ?2022
> 
> 
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users



From my.shellac at gmail.com  Thu Apr 20 14:54:15 2023
From: my.shellac at gmail.com (=?UTF-8?B?QWxleGV50Y/RgCBHcnV6ZG92?=)
Date: Thu, 20 Apr 2023 18:54:15 +0400
Subject: [squid-users] cache_peer_access by dynamic ACL
In-Reply-To: <4e3df8c9-52a7-1afd-b3d3-6971cdae75fb@measurement-factory.com>
References: <CAFqyDwB82whYStQnbLcjX8JUyostgeMgiWQP1o0UxoYs9FKJyQ@mail.gmail.com>
 <647cd5f1-851c-4937-2ced-561f2e704f55@measurement-factory.com>
 <CAFqyDwDt-dzfVbi5s91sEgB=viNovRjP=OWNTZrY1CVCv5SNJQ@mail.gmail.com>
 <CAFqyDwBWrZ_O-yXr0J9Bb4HqWvfq8HR+_4QPVgueQ7Pa=OmeFQ@mail.gmail.com>
 <5a11ceaa-c3f4-4a80-3ac4-9df3c8be3c3e@measurement-factory.com>
 <CAFqyDwBsFU80tc5TsAuG109o9XGuMP7dXZ4rSnvuX4Js6CiHWg@mail.gmail.com>
 <4e3df8c9-52a7-1afd-b3d3-6971cdae75fb@measurement-factory.com>
Message-ID: <CAFqyDwCKi+CB_M-NgirDraHjUoiF5XUy8GyM-5ivU1rLe5fGGQ@mail.gmail.com>

The cpu is around 100% even no any requests is going....
For now I left just one cache_peer in configuration and got the new error:

commBind Cannot bind socket FD 28 to [::]: (13) Permission denied


??, 20 ???. 2023??. ? 17:21, Alex Rousskov <rousskov at measurement-factory.com
>:

> On 4/20/23 04:23, Alexey?? Gruzdov wrote:
>
> > cache_peer peerG1.com parent 40001 0 no-query no-digest name=peerG1
> >
> > external_acl_type ext_proxy_g1_type %LOGIN %DST /usr/local/bin/g1.py
> >
> > acl proxy_g1_ext_mark_acl  ext_proxy_g1_type
> >
> > acl proxy_g1_ext_marked_acl  annotate_transaction proxy=g1
> >
> > acl proxy_peerG1_acl note proxy g1
> >
> > http_access deny proxy_g1_ext_mark_acl  proxy_g1_ext_marked_acl !all
> > .....
> > others http_access rules
> >
> > And this above works.
>
> Glad to hear that. ( If others are going to use the above as a guiding
> example, I would recommend naming these ACLs very differently, but that
> is not important to Squid. )
>
>
> > BUT
> > I am worried about why this my external script for ACL  type loads the
> > one of core of CPU to 100%.....???
>
> External ACL caching aside, the script will be contacted once for every
> Squid transaction. Does your script CPU usage go down to zero when there
> is no traffic? If not, then there is a bug in the script itself.
>
> If you use the script from the command line, without Squid, does it
> consume a lot of CPU and/or take a lot of time per fake query? You can
> adjust the script to log the real query (when the script is used by
> Squid), so that you can easily replicate that query when running the
> script without Squid...
>
> The cache key in your case is (the expansion of) "%LOGIN %DST". It is
> enabled by default IIRC. Look for "cache" related options at
> http://www.squid-cache.org/Doc/config/external_acl_type/
>
>
> > ( I used three of workers in config,
> > but I can see a six process called like my external helper script, looks
> > like squid runs x2 process for external ACL )
>
> See external_acl_type children-* options:
> http://www.squid-cache.org/Doc/config/external_acl_type/
>
> In most environments, I recommend setting all three of them to the same
> value. Please note that these options are not SMP-aware (yet), so Squid
> will _not_ divide their values by the number of workers and give each
> worker as many children as you state in squid.conf.
>
>
> > Because if I will put the one more group of users (that must to use
> > another cache_peer ) - I will need to create one more external script
> > that will making to check an existed users from an other DB table
>
> Once you get the basic setup above working for one group to your
> satisfaction, I would recommend migrating from (one script and one
> matching annotate_transaction ACL) per group to a single script for all
> groups. That single external ACL script will send the right
> annotation(s) to Squid.
>
>
> HTH,
>
> Alex.
>
>
> > ??, 19 ???. 2023??. ? 22:39, Alex Rousskov:
> >
> >     On 4/19/23 13:30, Alexey?? Gruzdov wrote:
> >
> >      > cache_peer peerG1.com parent 40001 0 no-query no-digest
> name=peerG1
> >
> >      > external_acl_type ext_proxy_g1_type %LOGIN %DST
> /usr/local/bin/g1.py
> >
> >      > acl proxy_g1_ext_acl ext_proxy_g1_type
> >
> >     OK. I assume that /usr/local/bin/g1.py will only match users that
> >     should
> >     go to cache_peer called peerG1.
> >
> >
> >      > acl proxy_g1_ext_acl_mark  annotate_transaction proxy=g1
> >
> >     Please note that the name of this annotate_transaction ACL --
> >     "proxy_g1_ext_acl_mark" -- implies a relationship to the external ACL
> >     named "proxy_g1_ext_acl", but there is no such relationship. Squid
> does
> >     not care about ACL names, but this naming problem may indicate a
> >     misunderstanding. To follow your naming scheme, this ACL should be
> >     called something like "proxy_g1_mark_acl" or "mark_for_proxy_g1_acl".
> >
> >
> >      > acl proxy_peerG1_acl note proxy g1
> >
> >     OK. FWIW, a more consistent ACL name would have been
> >     "proxy_g1_marked_acl" or "marked_for_proxy_g1_acl". Again, Squid does
> >     not really care about these names, so use whatever you think is
> >     consistent/meaningful/etc.
> >
> >
> >      > http_access deny proxy_g1_ext_acl !all
> >
> >     This line has no (positive) effect. Squid will evaluate the external
> >     ACL, but since the rule, as a whole, will never match due to "!all",
> >     and
> >     since the external ACL has no (relevant) side effects, you can just
> >     delete this line from your configuration.
> >
> >     Needless to say, if you delete this line, then proxy_g1_ext_acl will
> be
> >     unused, which should tell you that this configuration is not doing
> what
> >     you want. See below for a fix recommendation.
> >
> >
> >      > http_access deny proxy_g1_ext_acl_mark !all
> >
> >     This line will mark _all_ transactions. You only want to mark
> >     transactions that also matched proxy_g1_ext_acl. That "b only if a"
> >     logic is accomplished by using _both_ ACLs in the same rule:
> >
> >         http_access deny proxy_g1_ext_acl proxy_g1_ext_acl_mark !all
> >
> >     With the above http_access rule (instead of the earlier two), Squid
> >     will
> >     evaluate the external ACL, and, if it matches, Squid will also
> evaluate
> >     the annotation-setting ACL. The whole rule will then be rejected due
> to
> >     "!all", but not until it annotates the transaction (if the external
> ACL
> >     matches). Again, in this sketch, we are using this rule for its
> >     annotation side effect only.
> >
> >
> >      > And this works like I need now....
> >
> >     AFAICT, if the tests indicate that this configuration works, then the
> >     tests are broken. IMHO, you should fix the tests (while you have a
> >     broken configuration that can be used to test the tests) before
> >     proceeding with the configuration fix.
> >
> >
> >     HTH,
> >
> >     Alex.
> >     P.S. Please keep this email thread on squid-users instead of
> responding
> >     to me personally.
> >
> >
> >
> >
> >      > ??, 19 ???. 2023??. ? 21:01, Alexey?? Gruzdov:
> >      >
> >      >     so, ok  - Lets limit just to one cache peer and one single
> >     ACL (just
> >      >     to understand the logic):
> >      >
> >      >       cache_peer peerG1.com parent 40001 0 no-query no-digest
> >     name=peerG1
> >      >
> >      >       external_acl_type ext_proxy_g1_type %LOGIN %DST
> >      >     /usr/local/bin/g1.py   (this will answer "OK"  or "ERR",
> >     depends if
> >      >     user consists in DB)
> >      >
> >      >       acl proxy_g1_ext_acl  ext_proxy_g1_type annotate_transaction
> >      >     proxy=g1   (If I right understood here is a key point of how
> >     to add
> >      >     the tag to transaction related with user)
> >      >       acl proxy_peerG1_acl note proxy g1  (here we create the ACL
> >     based
> >      >     on the tag and this is fast ACL yet and we should to use it in
> >      >     cache_peer_access)
> >      >
> >      >
> >      >     http_access deny proxy_g1_ext_acl !all
> >      >     ......<others http access rules>
> >      >
> >      >
> >      >     cache_peer_access peerG1 allow proxy_peerG1_acl
> >      >     cache_peer_access peerG1 deny all
> >      >
> >      >     Is that correct ?
> >      >
> >      >     ??, 18 ???. 2023??. ? 23:44, Alex Rousskov
> >      >     <rousskov at measurement-factory.com
> >     <mailto:rousskov at measurement-factory.com>
> >      >     <mailto:rousskov at measurement-factory.com
> >     <mailto:rousskov at measurement-factory.com>>>:
> >      >
> >      >         On 4/18/23 11:41, Alexey?? Gruzdov wrote:
> >      >
> >      >          > Could you explain me how the annotation transaction
> >     works and
> >      >         how it
> >      >          > related to acl that I could to use with cache_peers
> >      >
> >      >         Transactions have a (possibly empty) set of name=value
> >     annotations.
> >      >
> >      >         During Squid configuration time, Squid parses all ACL
> >      >         declarations in
> >      >         your configuration file. When Squid parses an
> >      >         annotation_transaction ACL
> >      >         declaration, Squid remembers what transaction annotation
> >     to add
> >      >         in the
> >      >         future, [every time] when that ACL is evaluated (e.g.,
> >     used in
> >      >         http_access rule that Squid reaches during transaction
> >     processing).
> >      >
> >      >         When evaluated, an "annotation_transaction" ACL simply
> >     adds the
> >      >         previously configured annotation to the current
> >     transaction and
> >      >         returns
> >      >         a "yes, this transaction matches" result.
> >      >
> >      >         When evaluated, a "note" ACL returns a "yes, this
> transaction
> >      >         matches"
> >      >         result if and only if the current transaction already has
> the
> >      >         matching
> >      >         annotation. This ACL does not modify the set of
> transaction
> >      >         annotations.
> >      >
> >      >         The combination of annotate_transaction and note ACLs
> >     allows you to
> >      >         annotate a transaction at one time and check previously
> set
> >      >         transaction
> >      >         annotations at another time. The timing and meaning of
> those
> >      >         annotations
> >      >         are up to you.
> >      >
> >      >
> >      >          > ok! Lets look to my case example:
> >      >
> >      >          > cache_peer peerG1.com parent 40001 0 no-query no-digest
> >      >         name=peerG1 round-robin
> >      >
> >      >          > cache_peer_access  peerG1 allow proxy_peerG1_acl
> >      >          > cache_peer_access  peerG1 allow proxy_all_acl
> >      >          > cache_peer_access  peerG1 deny all
> >      >
> >      >          > acl proxy_peerG1_acl  proxy_auth  "../users.peerG1.txt"
> >      >          > acl proxy_all_acl  proxy_auth  "../users.all.txt"
> >      >
> >      >         [ I added the missing "acl " directive to the above ACL
> >      >         declarations and
> >      >         stripped rules for two out of three cache_peers ]
> >      >
> >      >         As you know, the above cache_peer_access configuration is
> not
> >      >         supported
> >      >         because it uses "slow" proxy_auth ACLs in
> cache_peer_access
> >      >         directives
> >      >         that only support "fast" ACLs. It does not matter (to me),
> >      >         whether the
> >      >         above appears to "work" in some environments. YMMV.
> >      >
> >      >         To fix this problem, we can use http_access rules to
> >     essentially
> >      >         remember proxy_auth evaluation results (at http_access
> >      >         evaluation time)
> >      >         as transaction annotations. Here is an untested sketch
> that
> >      >         omits other
> >      >         (important but irrelevant here) http_access rules and
> assumes
> >      >         that these
> >      >         sketched http_access rules _are_ evaluated:
> >      >
> >      >             # if proxy_peerG1_acl matches, evaluate
> mark_for_peerG1
> >      >             http_access deny proxy_peerG1_acl mark_for_peerG1 !all
> >      >
> >      >             # if proxy_all_acl matches, evaluate
> mark_for_all_peers
> >      >             http_access deny proxy_all_acl mark_for_all_peers !all
> >      >
> >      >
> >      >         Now we can use those remembered proxy_... acl evaluation
> >     results
> >      >         (i.e.
> >      >         we can check for the matching annotations) in
> >     cache_peer_access
> >      >         rules:
> >      >
> >      >             cache_peer_access peerG1 allow marked_for_peerG1
> >      >             cache_peer_access peerG1 allow marked_for_all_peers
> >      >             cache_peer_access peerG1 deny all
> >      >
> >      >
> >      >         where the new ACLs mentioned above are declared along
> >     these lines:
> >      >
> >      >             acl mark_for_peerG1 annotate_transaction for_peer_=G1
> >      >             acl mark_for_all_peers annotate_transaction
> >     for_all_peers_=true
> >      >
> >      >             acl marked_for_peerG1 note for_peer_ G1
> >      >             acl marked_for_all_peers note for_all_peers_ true
> >      >
> >      >         This can probably be simplified further by using
> >     for_peer_=ALL
> >      >         instead
> >      >         of for_all_peers_=true annotation, but I wanted to
> >     preserve the
> >      >         symmetry
> >      >         with your original configuration.
> >      >
> >      >
> >      >          > And these all works like I need, But - once I am
> >     changing a
> >      >         list of
> >      >          > users (add or remove) - I need to use "squid -k
> >      >         reconfigure"...... but
> >      >          > of course better to go without this reconfigure
> >      >
> >      >         One can avoid reconfiguration using an external ACL
> >     script that
> >      >         gives
> >      >         Squid the right for_peer_=... annotations (instead of
> using
> >      >         "constant"
> >      >         or "hard-coded" annotate_transaction ACLs to store the
> same
> >      >         annotations).
> >      >
> >      >         However, it may be better to make the above sketch to work
> >      >         _before_ you
> >      >         replace mark_for_peerG1 ACLs/rules with an external
> >      >         mark_for_the_right_peer ACL.
> >      >
> >      >
> >      >         HTH,
> >      >
> >      >         Alex.
> >      >         P.S. This thread continues the discussion started at
> >      > https://bugs.squid-cache.org/show_bug.cgi?id=5268
> >     <https://bugs.squid-cache.org/show_bug.cgi?id=5268>
> >      >         <https://bugs.squid-cache.org/show_bug.cgi?id=5268
> >     <https://bugs.squid-cache.org/show_bug.cgi?id=5268>>
> >      >
> >      >         _______________________________________________
> >      >         squid-users mailing list
> >      > squid-users at lists.squid-cache.org
> >     <mailto:squid-users at lists.squid-cache.org>
> >      >         <mailto:squid-users at lists.squid-cache.org
> >     <mailto:squid-users at lists.squid-cache.org>>
> >      > http://lists.squid-cache.org/listinfo/squid-users
> >     <http://lists.squid-cache.org/listinfo/squid-users>
> >      >         <http://lists.squid-cache.org/listinfo/squid-users
> >     <http://lists.squid-cache.org/listinfo/squid-users>>
> >      >
> >      >
> >      >
> >      >     --
> >      >     ? ????????? ? ???
> >      >     ???????
> >      >     +79043828661
> >      >     620000 ?.????????????  2022
> >      >
> >      >
> >      >
> >      > --
> >      > ? ????????? ? ???
> >      > ???????
> >      > +79043828661
> >      > 620000 ?.????????????  2022
> >      >
> >
> >
> >
> > --
> > ? ????????? ? ???
> > ???????
> > +79043828661
> > 620000 ?.????????????  2022
> >
> >
> > _______________________________________________
> > squid-users mailing list
> > squid-users at lists.squid-cache.org
> > http://lists.squid-cache.org/listinfo/squid-users
>
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230420/3233f5cf/attachment.htm>

From rousskov at measurement-factory.com  Thu Apr 20 15:50:22 2023
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Thu, 20 Apr 2023 11:50:22 -0400
Subject: [squid-users] cache_peer_access by dynamic ACL
In-Reply-To: <CAFqyDwCKi+CB_M-NgirDraHjUoiF5XUy8GyM-5ivU1rLe5fGGQ@mail.gmail.com>
References: <CAFqyDwB82whYStQnbLcjX8JUyostgeMgiWQP1o0UxoYs9FKJyQ@mail.gmail.com>
 <647cd5f1-851c-4937-2ced-561f2e704f55@measurement-factory.com>
 <CAFqyDwDt-dzfVbi5s91sEgB=viNovRjP=OWNTZrY1CVCv5SNJQ@mail.gmail.com>
 <CAFqyDwBWrZ_O-yXr0J9Bb4HqWvfq8HR+_4QPVgueQ7Pa=OmeFQ@mail.gmail.com>
 <5a11ceaa-c3f4-4a80-3ac4-9df3c8be3c3e@measurement-factory.com>
 <CAFqyDwBsFU80tc5TsAuG109o9XGuMP7dXZ4rSnvuX4Js6CiHWg@mail.gmail.com>
 <4e3df8c9-52a7-1afd-b3d3-6971cdae75fb@measurement-factory.com>
 <CAFqyDwCKi+CB_M-NgirDraHjUoiF5XUy8GyM-5ivU1rLe5fGGQ@mail.gmail.com>
Message-ID: <3e08fdfd-63a2-6c22-a499-91ed7452eb56@measurement-factory.com>

On 4/20/23 10:54, Alexey?? Gruzdov wrote:
> The cpu is around 100% even no any requests is going....

Then the problem is most likely in your script. Foe example, the script 
actively doing something while there are no Squid requests to work on 
(instead of blocking while waiting for the next Squid request).


> For now I left just one cache_peer in configuration?and got the new error:
> 
> commBind Cannot bind socket FD 28 to [::]: (13) Permission denied

Could be one of the misconfigurations discussed at
https://wiki.squid-cache.org/Features/SmpScale#cannot-bind-socket-fd-nn-to--13-permission-denied


HTH,

Alex.


> ??, 20 ???. 2023??. ? 17:21, Alex Rousskov:
> 
>     On 4/20/23 04:23, Alexey?? Gruzdov wrote:
> 
>      > cache_peer peerG1.com parent 40001 0 no-query no-digest name=peerG1
>      >
>      > external_acl_type ext_proxy_g1_type %LOGIN %DST /usr/local/bin/g1.py
>      >
>      > acl?proxy_g1_ext_mark_acl? ext_proxy_g1_type
>      >
>      > acl?proxy_g1_ext_marked_acl? annotate_transaction proxy=g1
>      >
>      > acl proxy_peerG1_acl?note proxy g1
>      >
>      > http_access deny proxy_g1_ext_mark_acl??proxy_g1_ext_marked_acl?!all
>      > .....
>      > others http_access rules
>      >
>      > And this above works.
> 
>     Glad to hear that. ( If others are going to use the above as a guiding
>     example, I would recommend naming these ACLs very differently, but that
>     is not important to Squid. )
> 
> 
>      > BUT
>      > I am worried?about why this my external script for ACL? type
>     loads the
>      > one of core of CPU to 100%.....???
> 
>     External ACL caching aside, the script will be contacted once for every
>     Squid transaction. Does your script CPU usage go down to zero when
>     there
>     is no traffic? If not, then there is a bug in the script itself.
> 
>     If you use the script from the command line, without Squid, does it
>     consume a lot of CPU and/or take a lot of time per fake query? You can
>     adjust the script to log the real query (when the script is used by
>     Squid), so that you can easily replicate that query when running the
>     script without Squid...
> 
>     The cache key in your case is (the expansion of) "%LOGIN %DST". It is
>     enabled by default IIRC. Look for "cache" related options at
>     http://www.squid-cache.org/Doc/config/external_acl_type/
>     <http://www.squid-cache.org/Doc/config/external_acl_type/>
> 
> 
>      > ( I used three of workers in config,
>      > but I can see a six process called like my external helper
>     script, looks
>      > like squid runs x2 process for external ACL )
> 
>     See external_acl_type children-* options:
>     http://www.squid-cache.org/Doc/config/external_acl_type/
>     <http://www.squid-cache.org/Doc/config/external_acl_type/>
> 
>     In most environments, I recommend setting all three of them to the same
>     value. Please note that these options are not SMP-aware (yet), so Squid
>     will _not_ divide their values by the number of workers and give each
>     worker as many children as you state in squid.conf.
> 
> 
>      > Because if I will put the one more group of users (that must to use
>      > another cache_peer ) - I will need to create one more external
>     script
>      > that will making to check an existed users from an other?DB table
> 
>     Once you get the basic setup above working for one group to your
>     satisfaction, I would recommend migrating from (one script and one
>     matching annotate_transaction ACL) per group to a single script for all
>     groups. That single external ACL script will send the right
>     annotation(s) to Squid.
> 
> 
>     HTH,
> 
>     Alex.
> 
> 
>      > ??, 19 ???. 2023??. ? 22:39, Alex Rousskov:
>      >
>      >? ? ?On 4/19/23 13:30, Alexey?? Gruzdov wrote:
>      >
>      >? ? ? > cache_peer peerG1.com parent 40001 0 no-query no-digest
>     name=peerG1
>      >
>      >? ? ? > external_acl_type ext_proxy_g1_type %LOGIN %DST
>     /usr/local/bin/g1.py
>      >
>      >? ? ? > acl?proxy_g1_ext_acl?ext_proxy_g1_type
>      >
>      >? ? ?OK. I assume that /usr/local/bin/g1.py will only match users that
>      >? ? ?should
>      >? ? ?go to cache_peer called peerG1.
>      >
>      >
>      >? ? ? > acl?proxy_g1_ext_acl_mark? annotate_transaction proxy=g1
>      >
>      >? ? ?Please note that the name of this annotate_transaction ACL --
>      >? ? ?"proxy_g1_ext_acl_mark" -- implies a relationship to the
>     external ACL
>      >? ? ?named "proxy_g1_ext_acl", but there is no such relationship.
>     Squid does
>      >? ? ?not care about ACL names, but this naming problem may indicate a
>      >? ? ?misunderstanding. To follow your naming scheme, this ACL
>     should be
>      >? ? ?called something like "proxy_g1_mark_acl" or
>     "mark_for_proxy_g1_acl".
>      >
>      >
>      >? ? ? > acl proxy_peerG1_acl?note proxy g1
>      >
>      >? ? ?OK. FWIW, a more consistent ACL name would have been
>      >? ? ?"proxy_g1_marked_acl" or "marked_for_proxy_g1_acl". Again,
>     Squid does
>      >? ? ?not really care about these names, so use whatever you think is
>      >? ? ?consistent/meaningful/etc.
>      >
>      >
>      >? ? ? > http_access deny proxy_g1_ext_acl !all
>      >
>      >? ? ?This line has no (positive) effect. Squid will evaluate the
>     external
>      >? ? ?ACL, but since the rule, as a whole, will never match due to
>     "!all",
>      >? ? ?and
>      >? ? ?since the external ACL has no (relevant) side effects, you
>     can just
>      >? ? ?delete this line from your configuration.
>      >
>      >? ? ?Needless to say, if you delete this line, then
>     proxy_g1_ext_acl will be
>      >? ? ?unused, which should tell you that this configuration is not
>     doing what
>      >? ? ?you want. See below for a fix recommendation.
>      >
>      >
>      >? ? ? > http_access deny proxy_g1_ext_acl_mark !all
>      >
>      >? ? ?This line will mark _all_ transactions. You only want to mark
>      >? ? ?transactions that also matched proxy_g1_ext_acl. That "b only
>     if a"
>      >? ? ?logic is accomplished by using _both_ ACLs in the same rule:
>      >
>      >? ? ? ? ?http_access deny proxy_g1_ext_acl proxy_g1_ext_acl_mark !all
>      >
>      >? ? ?With the above http_access rule (instead of the earlier two),
>     Squid
>      >? ? ?will
>      >? ? ?evaluate the external ACL, and, if it matches, Squid will
>     also evaluate
>      >? ? ?the annotation-setting ACL. The whole rule will then be
>     rejected due to
>      >? ? ?"!all", but not until it annotates the transaction (if the
>     external ACL
>      >? ? ?matches). Again, in this sketch, we are using this rule for its
>      >? ? ?annotation side effect only.
>      >
>      >
>      >? ? ? > And this works like I need now....
>      >
>      >? ? ?AFAICT, if the tests indicate that this configuration works,
>     then the
>      >? ? ?tests are broken. IMHO, you should fix the tests (while you
>     have a
>      >? ? ?broken configuration that can be used to test the tests) before
>      >? ? ?proceeding with the configuration fix.
>      >
>      >
>      >? ? ?HTH,
>      >
>      >? ? ?Alex.
>      >? ? ?P.S. Please keep this email thread on squid-users instead of
>     responding
>      >? ? ?to me personally.
>      >
>      >
>      >
>      >
>      >? ? ? > ??, 19 ???. 2023??. ? 21:01, Alexey?? Gruzdov:
>      >? ? ? >
>      >? ? ? >? ? ?so, ok? - Lets limit just to one cache peer and one single
>      >? ? ?ACL (just
>      >? ? ? >? ? ?to understand the logic):
>      >? ? ? >
>      >? ? ? >? ? ? ?cache_peer peerG1.com parent 40001 0 no-query no-digest
>      >? ? ?name=peerG1
>      >? ? ? >
>      >? ? ? >? ? ? ?external_acl_type ext_proxy_g1_type %LOGIN %DST
>      >? ? ? >? ? ?/usr/local/bin/g1.py? ?(this will answer "OK"? or "ERR",
>      >? ? ?depends if
>      >? ? ? >? ? ?user consists in DB)
>      >? ? ? >
>      >? ? ? >? ? ? ?acl?proxy_g1_ext_acl 
>     ext_proxy_g1_type?annotate_transaction
>      >? ? ? >? ? ?proxy=g1? ?(If I right understood here is a key point
>     of how
>      >? ? ?to add
>      >? ? ? >? ? ?the tag to transaction related with user)
>      >? ? ? >? ? ? ?acl proxy_peerG1_acl?note proxy g1? (here we create
>     the ACL
>      >? ? ?based
>      >? ? ? >? ? ?on the tag and this is fast ACL yet and we should to
>     use it in
>      >? ? ? >? ? ?cache_peer_access)
>      >? ? ? >
>      >? ? ? >
>      >? ? ? >? ? ?http_access deny proxy_g1_ext_acl !all
>      >? ? ? >? ? ?......<others http access rules>
>      >? ? ? >
>      >? ? ? >
>      >? ? ? >? ? ?cache_peer_access peerG1 allow proxy_peerG1_acl
>      >? ? ? >? ? ?cache_peer_access peerG1 deny all
>      >? ? ? >
>      >? ? ? >? ? ?Is that correct ?
>      >? ? ? >
>      >? ? ? >? ? ???, 18 ???. 2023??. ? 23:44, Alex Rousskov
>      >? ? ? >? ? ?<rousskov at measurement-factory.com
>     <mailto:rousskov at measurement-factory.com>
>      >? ? ?<mailto:rousskov at measurement-factory.com
>     <mailto:rousskov at measurement-factory.com>>
>      >? ? ? >? ? ?<mailto:rousskov at measurement-factory.com
>     <mailto:rousskov at measurement-factory.com>
>      >? ? ?<mailto:rousskov at measurement-factory.com
>     <mailto:rousskov at measurement-factory.com>>>>:
>      >? ? ? >
>      >? ? ? >? ? ? ? ?On 4/18/23 11:41, Alexey?? Gruzdov wrote:
>      >? ? ? >
>      >? ? ? >? ? ? ? ? > Could you explain me how the annotation transaction
>      >? ? ?works and
>      >? ? ? >? ? ? ? ?how it
>      >? ? ? >? ? ? ? ? > related to acl that I could to use with cache_peers
>      >? ? ? >
>      >? ? ? >? ? ? ? ?Transactions have a (possibly empty) set of name=value
>      >? ? ?annotations.
>      >? ? ? >
>      >? ? ? >? ? ? ? ?During Squid configuration time, Squid parses all ACL
>      >? ? ? >? ? ? ? ?declarations in
>      >? ? ? >? ? ? ? ?your configuration file. When Squid parses an
>      >? ? ? >? ? ? ? ?annotation_transaction ACL
>      >? ? ? >? ? ? ? ?declaration, Squid remembers what transaction
>     annotation
>      >? ? ?to add
>      >? ? ? >? ? ? ? ?in the
>      >? ? ? >? ? ? ? ?future, [every time] when that ACL is evaluated (e.g.,
>      >? ? ?used in
>      >? ? ? >? ? ? ? ?http_access rule that Squid reaches during transaction
>      >? ? ?processing).
>      >? ? ? >
>      >? ? ? >? ? ? ? ?When evaluated, an "annotation_transaction" ACL simply
>      >? ? ?adds the
>      >? ? ? >? ? ? ? ?previously configured annotation to the current
>      >? ? ?transaction and
>      >? ? ? >? ? ? ? ?returns
>      >? ? ? >? ? ? ? ?a "yes, this transaction matches" result.
>      >? ? ? >
>      >? ? ? >? ? ? ? ?When evaluated, a "note" ACL returns a "yes, this
>     transaction
>      >? ? ? >? ? ? ? ?matches"
>      >? ? ? >? ? ? ? ?result if and only if the current transaction
>     already has the
>      >? ? ? >? ? ? ? ?matching
>      >? ? ? >? ? ? ? ?annotation. This ACL does not modify the set of
>     transaction
>      >? ? ? >? ? ? ? ?annotations.
>      >? ? ? >
>      >? ? ? >? ? ? ? ?The combination of annotate_transaction and note ACLs
>      >? ? ?allows you to
>      >? ? ? >? ? ? ? ?annotate a transaction at one time and check
>     previously set
>      >? ? ? >? ? ? ? ?transaction
>      >? ? ? >? ? ? ? ?annotations at another time. The timing and
>     meaning of those
>      >? ? ? >? ? ? ? ?annotations
>      >? ? ? >? ? ? ? ?are up to you.
>      >? ? ? >
>      >? ? ? >
>      >? ? ? >? ? ? ? ? > ok! Lets look to my case example:
>      >? ? ? >
>      >? ? ? >? ? ? ? ? > cache_peer peerG1.com parent 40001 0 no-query
>     no-digest
>      >? ? ? >? ? ? ? ?name=peerG1?round-robin
>      >? ? ? >
>      >? ? ? >? ? ? ? ? > cache_peer_access? peerG1 allow proxy_peerG1_acl
>      >? ? ? >? ? ? ? ? > cache_peer_access? peerG1 allow proxy_all_acl
>      >? ? ? >? ? ? ? ? > cache_peer_access? peerG1 deny all
>      >? ? ? >
>      >? ? ? >? ? ? ? ? > acl proxy_peerG1_acl? proxy_auth 
>     "../users.peerG1.txt"
>      >? ? ? >? ? ? ? ? > acl proxy_all_acl? proxy_auth? "../users.all.txt"
>      >? ? ? >
>      >? ? ? >? ? ? ? ?[ I added the missing "acl " directive to the
>     above ACL
>      >? ? ? >? ? ? ? ?declarations and
>      >? ? ? >? ? ? ? ?stripped rules for two out of three cache_peers ]
>      >? ? ? >
>      >? ? ? >? ? ? ? ?As you know, the above cache_peer_access
>     configuration is not
>      >? ? ? >? ? ? ? ?supported
>      >? ? ? >? ? ? ? ?because it uses "slow" proxy_auth ACLs in
>     cache_peer_access
>      >? ? ? >? ? ? ? ?directives
>      >? ? ? >? ? ? ? ?that only support "fast" ACLs. It does not matter
>     (to me),
>      >? ? ? >? ? ? ? ?whether the
>      >? ? ? >? ? ? ? ?above appears to "work" in some environments. YMMV.
>      >? ? ? >
>      >? ? ? >? ? ? ? ?To fix this problem, we can use http_access rules to
>      >? ? ?essentially
>      >? ? ? >? ? ? ? ?remember proxy_auth evaluation results (at http_access
>      >? ? ? >? ? ? ? ?evaluation time)
>      >? ? ? >? ? ? ? ?as transaction annotations. Here is an untested
>     sketch that
>      >? ? ? >? ? ? ? ?omits other
>      >? ? ? >? ? ? ? ?(important but irrelevant here) http_access rules
>     and assumes
>      >? ? ? >? ? ? ? ?that these
>      >? ? ? >? ? ? ? ?sketched http_access rules _are_ evaluated:
>      >? ? ? >
>      >? ? ? >? ? ? ? ? ? ?# if proxy_peerG1_acl matches, evaluate
>     mark_for_peerG1
>      >? ? ? >? ? ? ? ? ? ?http_access deny proxy_peerG1_acl
>     mark_for_peerG1 !all
>      >? ? ? >
>      >? ? ? >? ? ? ? ? ? ?# if proxy_all_acl matches, evaluate
>     mark_for_all_peers
>      >? ? ? >? ? ? ? ? ? ?http_access deny proxy_all_acl
>     mark_for_all_peers !all
>      >? ? ? >
>      >? ? ? >
>      >? ? ? >? ? ? ? ?Now we can use those remembered proxy_... acl
>     evaluation
>      >? ? ?results
>      >? ? ? >? ? ? ? ?(i.e.
>      >? ? ? >? ? ? ? ?we can check for the matching annotations) in
>      >? ? ?cache_peer_access
>      >? ? ? >? ? ? ? ?rules:
>      >? ? ? >
>      >? ? ? >? ? ? ? ? ? ?cache_peer_access peerG1 allow marked_for_peerG1
>      >? ? ? >? ? ? ? ? ? ?cache_peer_access peerG1 allow
>     marked_for_all_peers
>      >? ? ? >? ? ? ? ? ? ?cache_peer_access peerG1 deny all
>      >? ? ? >
>      >? ? ? >
>      >? ? ? >? ? ? ? ?where the new ACLs mentioned above are declared along
>      >? ? ?these lines:
>      >? ? ? >
>      >? ? ? >? ? ? ? ? ? ?acl mark_for_peerG1 annotate_transaction
>     for_peer_=G1
>      >? ? ? >? ? ? ? ? ? ?acl mark_for_all_peers annotate_transaction
>      >? ? ?for_all_peers_=true
>      >? ? ? >
>      >? ? ? >? ? ? ? ? ? ?acl marked_for_peerG1 note for_peer_ G1
>      >? ? ? >? ? ? ? ? ? ?acl marked_for_all_peers note for_all_peers_ true
>      >? ? ? >
>      >? ? ? >? ? ? ? ?This can probably be simplified further by using
>      >? ? ?for_peer_=ALL
>      >? ? ? >? ? ? ? ?instead
>      >? ? ? >? ? ? ? ?of for_all_peers_=true annotation, but I wanted to
>      >? ? ?preserve the
>      >? ? ? >? ? ? ? ?symmetry
>      >? ? ? >? ? ? ? ?with your original configuration.
>      >? ? ? >
>      >? ? ? >
>      >? ? ? >? ? ? ? ? > And these all works like I need, But - once I am
>      >? ? ?changing a
>      >? ? ? >? ? ? ? ?list of
>      >? ? ? >? ? ? ? ? > users (add or remove) - I need to use "squid -k
>      >? ? ? >? ? ? ? ?reconfigure"...... but
>      >? ? ? >? ? ? ? ? > of course better to go without this reconfigure
>      >? ? ? >
>      >? ? ? >? ? ? ? ?One can avoid reconfiguration using an external ACL
>      >? ? ?script that
>      >? ? ? >? ? ? ? ?gives
>      >? ? ? >? ? ? ? ?Squid the right for_peer_=... annotations (instead
>     of using
>      >? ? ? >? ? ? ? ?"constant"
>      >? ? ? >? ? ? ? ?or "hard-coded" annotate_transaction ACLs to store
>     the same
>      >? ? ? >? ? ? ? ?annotations).
>      >? ? ? >
>      >? ? ? >? ? ? ? ?However, it may be better to make the above sketch
>     to work
>      >? ? ? >? ? ? ? ?_before_ you
>      >? ? ? >? ? ? ? ?replace mark_for_peerG1 ACLs/rules with an external
>      >? ? ? >? ? ? ? ?mark_for_the_right_peer ACL.
>      >? ? ? >
>      >? ? ? >
>      >? ? ? >? ? ? ? ?HTH,
>      >? ? ? >
>      >? ? ? >? ? ? ? ?Alex.
>      >? ? ? >? ? ? ? ?P.S. This thread continues the discussion started at
>      >? ? ? > https://bugs.squid-cache.org/show_bug.cgi?id=5268
>     <https://bugs.squid-cache.org/show_bug.cgi?id=5268>
>      >? ? ?<https://bugs.squid-cache.org/show_bug.cgi?id=5268
>     <https://bugs.squid-cache.org/show_bug.cgi?id=5268>>
>      >? ? ? >? ? ? ? ?<https://bugs.squid-cache.org/show_bug.cgi?id=5268
>     <https://bugs.squid-cache.org/show_bug.cgi?id=5268>
>      >? ? ?<https://bugs.squid-cache.org/show_bug.cgi?id=5268
>     <https://bugs.squid-cache.org/show_bug.cgi?id=5268>>>
>      >? ? ? >
>      >? ? ? >? ? ? ? ?_______________________________________________
>      >? ? ? >? ? ? ? ?squid-users mailing list
>      >? ? ? > squid-users at lists.squid-cache.org
>     <mailto:squid-users at lists.squid-cache.org>
>      >? ? ?<mailto:squid-users at lists.squid-cache.org
>     <mailto:squid-users at lists.squid-cache.org>>
>      >? ? ? >? ? ? ? ?<mailto:squid-users at lists.squid-cache.org
>     <mailto:squid-users at lists.squid-cache.org>
>      >? ? ?<mailto:squid-users at lists.squid-cache.org
>     <mailto:squid-users at lists.squid-cache.org>>>
>      >? ? ? > http://lists.squid-cache.org/listinfo/squid-users
>     <http://lists.squid-cache.org/listinfo/squid-users>
>      >? ? ?<http://lists.squid-cache.org/listinfo/squid-users
>     <http://lists.squid-cache.org/listinfo/squid-users>>
>      >? ? ? >? ? ? ? ?<http://lists.squid-cache.org/listinfo/squid-users
>     <http://lists.squid-cache.org/listinfo/squid-users>
>      >? ? ?<http://lists.squid-cache.org/listinfo/squid-users
>     <http://lists.squid-cache.org/listinfo/squid-users>>>
>      >? ? ? >
>      >? ? ? >
>      >? ? ? >
>      >? ? ? >? ? ?--
>      >? ? ? >? ? ?? ????????? ? ???
>      >? ? ? >? ? ????????
>      >? ? ? >? ? ?+79043828661
>      >? ? ? >? ? ?620000 ?.???????????? ?2022
>      >? ? ? >
>      >? ? ? >
>      >? ? ? >
>      >? ? ? > --
>      >? ? ? > ? ????????? ? ???
>      >? ? ? > ???????
>      >? ? ? > +79043828661
>      >? ? ? > 620000 ?.???????????? ?2022
>      >? ? ? >
>      >
>      >
>      >
>      > --
>      > ? ????????? ? ???
>      > ???????
>      > +79043828661
>      > 620000 ?.???????????? ?2022
>      >
>      >
>      > _______________________________________________
>      > squid-users mailing list
>      > squid-users at lists.squid-cache.org
>     <mailto:squid-users at lists.squid-cache.org>
>      > http://lists.squid-cache.org/listinfo/squid-users
>     <http://lists.squid-cache.org/listinfo/squid-users>
> 
>     _______________________________________________
>     squid-users mailing list
>     squid-users at lists.squid-cache.org
>     <mailto:squid-users at lists.squid-cache.org>
>     http://lists.squid-cache.org/listinfo/squid-users
>     <http://lists.squid-cache.org/listinfo/squid-users>
> 
> 
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users



From my.shellac at gmail.com  Thu Apr 20 17:14:36 2023
From: my.shellac at gmail.com (=?UTF-8?B?QWxleGV50Y/RgCBHcnV6ZG92?=)
Date: Thu, 20 Apr 2023 21:14:36 +0400
Subject: [squid-users] Fwd:  cache_peer_access by dynamic ACL
In-Reply-To: <CAFqyDwBrys1BJG6Vc967MDmX8f=PvHMUZbpG=WxtxcbY0ukQ0Q@mail.gmail.com>
References: <CAFqyDwB82whYStQnbLcjX8JUyostgeMgiWQP1o0UxoYs9FKJyQ@mail.gmail.com>
 <647cd5f1-851c-4937-2ced-561f2e704f55@measurement-factory.com>
 <CAFqyDwDt-dzfVbi5s91sEgB=viNovRjP=OWNTZrY1CVCv5SNJQ@mail.gmail.com>
 <CAFqyDwBWrZ_O-yXr0J9Bb4HqWvfq8HR+_4QPVgueQ7Pa=OmeFQ@mail.gmail.com>
 <5a11ceaa-c3f4-4a80-3ac4-9df3c8be3c3e@measurement-factory.com>
 <CAFqyDwBsFU80tc5TsAuG109o9XGuMP7dXZ4rSnvuX4Js6CiHWg@mail.gmail.com>
 <4e3df8c9-52a7-1afd-b3d3-6971cdae75fb@measurement-factory.com>
 <CAFqyDwCKi+CB_M-NgirDraHjUoiF5XUy8GyM-5ivU1rLe5fGGQ@mail.gmail.com>
 <3e08fdfd-63a2-6c22-a499-91ed7452eb56@measurement-factory.com>
 <CAFqyDwBrys1BJG6Vc967MDmX8f=PvHMUZbpG=WxtxcbY0ukQ0Q@mail.gmail.com>
Message-ID: <CAFqyDwBM4StMYCJmKDHM3owhUy295o+qxMKQKjRugSj+XOzRJw@mail.gmail.com>

Ok. The last issues fixed. Thank you !

Tell me please If I right understood I could to get answer like
"name=value" from my ACL ext script, instead of "OK" or "ERR", right?

And does it means - I could to get answer depends from what users
authorises in to proxy.
For example:

If user "Jon"  -  the my ACL will check the policy in the DB and send
answer like "proxy=g1" to squid, or if user is "Jack" - answer will be like
"proxy=all"

and I will have ACL for this

acl proxy_g1_marked.acl note proxy g1
acl proxy_all_marked.acl note proxy all

will that correct ?

??, 20 ???. 2023??. ? 19:50, Alex Rousskov <rousskov at measurement-factory.com
>:

> On 4/20/23 10:54, Alexey?? Gruzdov wrote:
> > The cpu is around 100% even no any requests is going....
>
> Then the problem is most likely in your script. Foe example, the script
> actively doing something while there are no Squid requests to work on
> (instead of blocking while waiting for the next Squid request).
>
>
> > For now I left just one cache_peer in configuration and got the new
> error:
> >
> > commBind Cannot bind socket FD 28 to [::]: (13) Permission denied
>
> Could be one of the misconfigurations discussed at
>
> https://wiki.squid-cache.org/Features/SmpScale#cannot-bind-socket-fd-nn-to--13-permission-denied
>
>
> HTH,
>
> Alex.
>
>
> > ??, 20 ???. 2023??. ? 17:21, Alex Rousskov:
> >
> >     On 4/20/23 04:23, Alexey?? Gruzdov wrote:
> >
> >      > cache_peer peerG1.com parent 40001 0 no-query no-digest
> name=peerG1
> >      >
> >      > external_acl_type ext_proxy_g1_type %LOGIN %DST
> /usr/local/bin/g1.py
> >      >
> >      > acl proxy_g1_ext_mark_acl  ext_proxy_g1_type
> >      >
> >      > acl proxy_g1_ext_marked_acl  annotate_transaction proxy=g1
> >      >
> >      > acl proxy_peerG1_acl note proxy g1
> >      >
> >      > http_access deny
> proxy_g1_ext_mark_acl  proxy_g1_ext_marked_acl !all
> >      > .....
> >      > others http_access rules
> >      >
> >      > And this above works.
> >
> >     Glad to hear that. ( If others are going to use the above as a
> guiding
> >     example, I would recommend naming these ACLs very differently, but
> that
> >     is not important to Squid. )
> >
> >
> >      > BUT
> >      > I am worried about why this my external script for ACL  type
> >     loads the
> >      > one of core of CPU to 100%.....???
> >
> >     External ACL caching aside, the script will be contacted once for
> every
> >     Squid transaction. Does your script CPU usage go down to zero when
> >     there
> >     is no traffic? If not, then there is a bug in the script itself.
> >
> >     If you use the script from the command line, without Squid, does it
> >     consume a lot of CPU and/or take a lot of time per fake query? You
> can
> >     adjust the script to log the real query (when the script is used by
> >     Squid), so that you can easily replicate that query when running the
> >     script without Squid...
> >
> >     The cache key in your case is (the expansion of) "%LOGIN %DST". It is
> >     enabled by default IIRC. Look for "cache" related options at
> >     http://www.squid-cache.org/Doc/config/external_acl_type/
> >     <http://www.squid-cache.org/Doc/config/external_acl_type/>
> >
> >
> >      > ( I used three of workers in config,
> >      > but I can see a six process called like my external helper
> >     script, looks
> >      > like squid runs x2 process for external ACL )
> >
> >     See external_acl_type children-* options:
> >     http://www.squid-cache.org/Doc/config/external_acl_type/
> >     <http://www.squid-cache.org/Doc/config/external_acl_type/>
> >
> >     In most environments, I recommend setting all three of them to the
> same
> >     value. Please note that these options are not SMP-aware (yet), so
> Squid
> >     will _not_ divide their values by the number of workers and give each
> >     worker as many children as you state in squid.conf.
> >
> >
> >      > Because if I will put the one more group of users (that must to
> use
> >      > another cache_peer ) - I will need to create one more external
> >     script
> >      > that will making to check an existed users from an other DB table
> >
> >     Once you get the basic setup above working for one group to your
> >     satisfaction, I would recommend migrating from (one script and one
> >     matching annotate_transaction ACL) per group to a single script for
> all
> >     groups. That single external ACL script will send the right
> >     annotation(s) to Squid.
> >
> >
> >     HTH,
> >
> >     Alex.
> >
> >
> >      > ??, 19 ???. 2023??. ? 22:39, Alex Rousskov:
> >      >
> >      >     On 4/19/23 13:30, Alexey?? Gruzdov wrote:
> >      >
> >      >      > cache_peer peerG1.com parent 40001 0 no-query no-digest
> >     name=peerG1
> >      >
> >      >      > external_acl_type ext_proxy_g1_type %LOGIN %DST
> >     /usr/local/bin/g1.py
> >      >
> >      >      > acl proxy_g1_ext_acl ext_proxy_g1_type
> >      >
> >      >     OK. I assume that /usr/local/bin/g1.py will only match users
> that
> >      >     should
> >      >     go to cache_peer called peerG1.
> >      >
> >      >
> >      >      > acl proxy_g1_ext_acl_mark  annotate_transaction proxy=g1
> >      >
> >      >     Please note that the name of this annotate_transaction ACL --
> >      >     "proxy_g1_ext_acl_mark" -- implies a relationship to the
> >     external ACL
> >      >     named "proxy_g1_ext_acl", but there is no such relationship.
> >     Squid does
> >      >     not care about ACL names, but this naming problem may
> indicate a
> >      >     misunderstanding. To follow your naming scheme, this ACL
> >     should be
> >      >     called something like "proxy_g1_mark_acl" or
> >     "mark_for_proxy_g1_acl".
> >      >
> >      >
> >      >      > acl proxy_peerG1_acl note proxy g1
> >      >
> >      >     OK. FWIW, a more consistent ACL name would have been
> >      >     "proxy_g1_marked_acl" or "marked_for_proxy_g1_acl". Again,
> >     Squid does
> >      >     not really care about these names, so use whatever you think
> is
> >      >     consistent/meaningful/etc.
> >      >
> >      >
> >      >      > http_access deny proxy_g1_ext_acl !all
> >      >
> >      >     This line has no (positive) effect. Squid will evaluate the
> >     external
> >      >     ACL, but since the rule, as a whole, will never match due to
> >     "!all",
> >      >     and
> >      >     since the external ACL has no (relevant) side effects, you
> >     can just
> >      >     delete this line from your configuration.
> >      >
> >      >     Needless to say, if you delete this line, then
> >     proxy_g1_ext_acl will be
> >      >     unused, which should tell you that this configuration is not
> >     doing what
> >      >     you want. See below for a fix recommendation.
> >      >
> >      >
> >      >      > http_access deny proxy_g1_ext_acl_mark !all
> >      >
> >      >     This line will mark _all_ transactions. You only want to mark
> >      >     transactions that also matched proxy_g1_ext_acl. That "b only
> >     if a"
> >      >     logic is accomplished by using _both_ ACLs in the same rule:
> >      >
> >      >         http_access deny proxy_g1_ext_acl proxy_g1_ext_acl_mark
> !all
> >      >
> >      >     With the above http_access rule (instead of the earlier two),
> >     Squid
> >      >     will
> >      >     evaluate the external ACL, and, if it matches, Squid will
> >     also evaluate
> >      >     the annotation-setting ACL. The whole rule will then be
> >     rejected due to
> >      >     "!all", but not until it annotates the transaction (if the
> >     external ACL
> >      >     matches). Again, in this sketch, we are using this rule for
> its
> >      >     annotation side effect only.
> >      >
> >      >
> >      >      > And this works like I need now....
> >      >
> >      >     AFAICT, if the tests indicate that this configuration works,
> >     then the
> >      >     tests are broken. IMHO, you should fix the tests (while you
> >     have a
> >      >     broken configuration that can be used to test the tests)
> before
> >      >     proceeding with the configuration fix.
> >      >
> >      >
> >      >     HTH,
> >      >
> >      >     Alex.
> >      >     P.S. Please keep this email thread on squid-users instead of
> >     responding
> >      >     to me personally.
> >      >
> >      >
> >      >
> >      >
> >      >      > ??, 19 ???. 2023??. ? 21:01, Alexey?? Gruzdov:
> >      >      >
> >      >      >     so, ok  - Lets limit just to one cache peer and one
> single
> >      >     ACL (just
> >      >      >     to understand the logic):
> >      >      >
> >      >      >       cache_peer peerG1.com parent 40001 0 no-query
> no-digest
> >      >     name=peerG1
> >      >      >
> >      >      >       external_acl_type ext_proxy_g1_type %LOGIN %DST
> >      >      >     /usr/local/bin/g1.py   (this will answer "OK"  or
> "ERR",
> >      >     depends if
> >      >      >     user consists in DB)
> >      >      >
> >      >      >       acl proxy_g1_ext_acl
> >     ext_proxy_g1_type annotate_transaction
> >      >      >     proxy=g1   (If I right understood here is a key point
> >     of how
> >      >     to add
> >      >      >     the tag to transaction related with user)
> >      >      >       acl proxy_peerG1_acl note proxy g1  (here we create
> >     the ACL
> >      >     based
> >      >      >     on the tag and this is fast ACL yet and we should to
> >     use it in
> >      >      >     cache_peer_access)
> >      >      >
> >      >      >
> >      >      >     http_access deny proxy_g1_ext_acl !all
> >      >      >     ......<others http access rules>
> >      >      >
> >      >      >
> >      >      >     cache_peer_access peerG1 allow proxy_peerG1_acl
> >      >      >     cache_peer_access peerG1 deny all
> >      >      >
> >      >      >     Is that correct ?
> >      >      >
> >      >      >     ??, 18 ???. 2023??. ? 23:44, Alex Rousskov
> >      >      >     <rousskov at measurement-factory.com
> >     <mailto:rousskov at measurement-factory.com>
> >      >     <mailto:rousskov at measurement-factory.com
> >     <mailto:rousskov at measurement-factory.com>>
> >      >      >     <mailto:rousskov at measurement-factory.com
> >     <mailto:rousskov at measurement-factory.com>
> >      >     <mailto:rousskov at measurement-factory.com
> >     <mailto:rousskov at measurement-factory.com>>>>:
> >      >      >
> >      >      >         On 4/18/23 11:41, Alexey?? Gruzdov wrote:
> >      >      >
> >      >      >          > Could you explain me how the annotation
> transaction
> >      >     works and
> >      >      >         how it
> >      >      >          > related to acl that I could to use with
> cache_peers
> >      >      >
> >      >      >         Transactions have a (possibly empty) set of
> name=value
> >      >     annotations.
> >      >      >
> >      >      >         During Squid configuration time, Squid parses all
> ACL
> >      >      >         declarations in
> >      >      >         your configuration file. When Squid parses an
> >      >      >         annotation_transaction ACL
> >      >      >         declaration, Squid remembers what transaction
> >     annotation
> >      >     to add
> >      >      >         in the
> >      >      >         future, [every time] when that ACL is evaluated
> (e.g.,
> >      >     used in
> >      >      >         http_access rule that Squid reaches during
> transaction
> >      >     processing).
> >      >      >
> >      >      >         When evaluated, an "annotation_transaction" ACL
> simply
> >      >     adds the
> >      >      >         previously configured annotation to the current
> >      >     transaction and
> >      >      >         returns
> >      >      >         a "yes, this transaction matches" result.
> >      >      >
> >      >      >         When evaluated, a "note" ACL returns a "yes, this
> >     transaction
> >      >      >         matches"
> >      >      >         result if and only if the current transaction
> >     already has the
> >      >      >         matching
> >      >      >         annotation. This ACL does not modify the set of
> >     transaction
> >      >      >         annotations.
> >      >      >
> >      >      >         The combination of annotate_transaction and note
> ACLs
> >      >     allows you to
> >      >      >         annotate a transaction at one time and check
> >     previously set
> >      >      >         transaction
> >      >      >         annotations at another time. The timing and
> >     meaning of those
> >      >      >         annotations
> >      >      >         are up to you.
> >      >      >
> >      >      >
> >      >      >          > ok! Lets look to my case example:
> >      >      >
> >      >      >          > cache_peer peerG1.com parent 40001 0 no-query
> >     no-digest
> >      >      >         name=peerG1 round-robin
> >      >      >
> >      >      >          > cache_peer_access  peerG1 allow proxy_peerG1_acl
> >      >      >          > cache_peer_access  peerG1 allow proxy_all_acl
> >      >      >          > cache_peer_access  peerG1 deny all
> >      >      >
> >      >      >          > acl proxy_peerG1_acl  proxy_auth
> >     "../users.peerG1.txt"
> >      >      >          > acl proxy_all_acl  proxy_auth
> "../users.all.txt"
> >      >      >
> >      >      >         [ I added the missing "acl " directive to the
> >     above ACL
> >      >      >         declarations and
> >      >      >         stripped rules for two out of three cache_peers ]
> >      >      >
> >      >      >         As you know, the above cache_peer_access
> >     configuration is not
> >      >      >         supported
> >      >      >         because it uses "slow" proxy_auth ACLs in
> >     cache_peer_access
> >      >      >         directives
> >      >      >         that only support "fast" ACLs. It does not matter
> >     (to me),
> >      >      >         whether the
> >      >      >         above appears to "work" in some environments. YMMV.
> >      >      >
> >      >      >         To fix this problem, we can use http_access rules
> to
> >      >     essentially
> >      >      >         remember proxy_auth evaluation results (at
> http_access
> >      >      >         evaluation time)
> >      >      >         as transaction annotations. Here is an untested
> >     sketch that
> >      >      >         omits other
> >      >      >         (important but irrelevant here) http_access rules
> >     and assumes
> >      >      >         that these
> >      >      >         sketched http_access rules _are_ evaluated:
> >      >      >
> >      >      >             # if proxy_peerG1_acl matches, evaluate
> >     mark_for_peerG1
> >      >      >             http_access deny proxy_peerG1_acl
> >     mark_for_peerG1 !all
> >      >      >
> >      >      >             # if proxy_all_acl matches, evaluate
> >     mark_for_all_peers
> >      >      >             http_access deny proxy_all_acl
> >     mark_for_all_peers !all
> >      >      >
> >      >      >
> >      >      >         Now we can use those remembered proxy_... acl
> >     evaluation
> >      >     results
> >      >      >         (i.e.
> >      >      >         we can check for the matching annotations) in
> >      >     cache_peer_access
> >      >      >         rules:
> >      >      >
> >      >      >             cache_peer_access peerG1 allow
> marked_for_peerG1
> >      >      >             cache_peer_access peerG1 allow
> >     marked_for_all_peers
> >      >      >             cache_peer_access peerG1 deny all
> >      >      >
> >      >      >
> >      >      >         where the new ACLs mentioned above are declared
> along
> >      >     these lines:
> >      >      >
> >      >      >             acl mark_for_peerG1 annotate_transaction
> >     for_peer_=G1
> >      >      >             acl mark_for_all_peers annotate_transaction
> >      >     for_all_peers_=true
> >      >      >
> >      >      >             acl marked_for_peerG1 note for_peer_ G1
> >      >      >             acl marked_for_all_peers note for_all_peers_
> true
> >      >      >
> >      >      >         This can probably be simplified further by using
> >      >     for_peer_=ALL
> >      >      >         instead
> >      >      >         of for_all_peers_=true annotation, but I wanted to
> >      >     preserve the
> >      >      >         symmetry
> >      >      >         with your original configuration.
> >      >      >
> >      >      >
> >      >      >          > And these all works like I need, But - once I am
> >      >     changing a
> >      >      >         list of
> >      >      >          > users (add or remove) - I need to use "squid -k
> >      >      >         reconfigure"...... but
> >      >      >          > of course better to go without this reconfigure
> >      >      >
> >      >      >         One can avoid reconfiguration using an external ACL
> >      >     script that
> >      >      >         gives
> >      >      >         Squid the right for_peer_=... annotations (instead
> >     of using
> >      >      >         "constant"
> >      >      >         or "hard-coded" annotate_transaction ACLs to store
> >     the same
> >      >      >         annotations).
> >      >      >
> >      >      >         However, it may be better to make the above sketch
> >     to work
> >      >      >         _before_ you
> >      >      >         replace mark_for_peerG1 ACLs/rules with an external
> >      >      >         mark_for_the_right_peer ACL.
> >      >      >
> >      >      >
> >      >      >         HTH,
> >      >      >
> >      >      >         Alex.
> >      >      >         P.S. This thread continues the discussion started
> at
> >      >      > https://bugs.squid-cache.org/show_bug.cgi?id=5268
> >     <https://bugs.squid-cache.org/show_bug.cgi?id=5268>
> >      >     <https://bugs.squid-cache.org/show_bug.cgi?id=5268
> >     <https://bugs.squid-cache.org/show_bug.cgi?id=5268>>
> >      >      >         <https://bugs.squid-cache.org/show_bug.cgi?id=5268
> >     <https://bugs.squid-cache.org/show_bug.cgi?id=5268>
> >      >     <https://bugs.squid-cache.org/show_bug.cgi?id=5268
> >     <https://bugs.squid-cache.org/show_bug.cgi?id=5268>>>
> >      >      >
> >      >      >         _______________________________________________
> >      >      >         squid-users mailing list
> >      >      > squid-users at lists.squid-cache.org
> >     <mailto:squid-users at lists.squid-cache.org>
> >      >     <mailto:squid-users at lists.squid-cache.org
> >     <mailto:squid-users at lists.squid-cache.org>>
> >      >      >         <mailto:squid-users at lists.squid-cache.org
> >     <mailto:squid-users at lists.squid-cache.org>
> >      >     <mailto:squid-users at lists.squid-cache.org
> >     <mailto:squid-users at lists.squid-cache.org>>>
> >      >      > http://lists.squid-cache.org/listinfo/squid-users
> >     <http://lists.squid-cache.org/listinfo/squid-users>
> >      >     <http://lists.squid-cache.org/listinfo/squid-users
> >     <http://lists.squid-cache.org/listinfo/squid-users>>
> >      >      >         <http://lists.squid-cache.org/listinfo/squid-users
> >     <http://lists.squid-cache.org/listinfo/squid-users>
> >      >     <http://lists.squid-cache.org/listinfo/squid-users
> >     <http://lists.squid-cache.org/listinfo/squid-users>>>
> >      >      >
> >      >      >
> >      >      >
> >      >      >     --
> >      >      >     ? ????????? ? ???
> >      >      >     ???????
> >      >      >     +79043828661
> >      >      >     620000 ?.????????????  2022
> >      >      >
> >      >      >
> >      >      >
> >      >      > --
> >      >      > ? ????????? ? ???
> >      >      > ???????
> >      >      > +79043828661
> >      >      > 620000 ?.????????????  2022
> >      >      >
> >      >
> >      >
> >      >
> >      > --
> >      > ? ????????? ? ???
> >      > ???????
> >      > +79043828661
> >      > 620000 ?.????????????  2022
> >      >
> >      >
> >      > _______________________________________________
> >      > squid-users mailing list
> >      > squid-users at lists.squid-cache.org
> >     <mailto:squid-users at lists.squid-cache.org>
> >      > http://lists.squid-cache.org/listinfo/squid-users
> >     <http://lists.squid-cache.org/listinfo/squid-users>
> >
> >     _______________________________________________
> >     squid-users mailing list
> >     squid-users at lists.squid-cache.org
> >     <mailto:squid-users at lists.squid-cache.org>
> >     http://lists.squid-cache.org/listinfo/squid-users
> >     <http://lists.squid-cache.org/listinfo/squid-users>
> >
> >
> > _______________________________________________
> > squid-users mailing list
> > squid-users at lists.squid-cache.org
> > http://lists.squid-cache.org/listinfo/squid-users
>
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230420/064c81fc/attachment.htm>

From rousskov at measurement-factory.com  Thu Apr 20 18:31:11 2023
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Thu, 20 Apr 2023 14:31:11 -0400
Subject: [squid-users] Fwd: cache_peer_access by dynamic ACL
In-Reply-To: <CAFqyDwBM4StMYCJmKDHM3owhUy295o+qxMKQKjRugSj+XOzRJw@mail.gmail.com>
References: <CAFqyDwB82whYStQnbLcjX8JUyostgeMgiWQP1o0UxoYs9FKJyQ@mail.gmail.com>
 <647cd5f1-851c-4937-2ced-561f2e704f55@measurement-factory.com>
 <CAFqyDwDt-dzfVbi5s91sEgB=viNovRjP=OWNTZrY1CVCv5SNJQ@mail.gmail.com>
 <CAFqyDwBWrZ_O-yXr0J9Bb4HqWvfq8HR+_4QPVgueQ7Pa=OmeFQ@mail.gmail.com>
 <5a11ceaa-c3f4-4a80-3ac4-9df3c8be3c3e@measurement-factory.com>
 <CAFqyDwBsFU80tc5TsAuG109o9XGuMP7dXZ4rSnvuX4Js6CiHWg@mail.gmail.com>
 <4e3df8c9-52a7-1afd-b3d3-6971cdae75fb@measurement-factory.com>
 <CAFqyDwCKi+CB_M-NgirDraHjUoiF5XUy8GyM-5ivU1rLe5fGGQ@mail.gmail.com>
 <3e08fdfd-63a2-6c22-a499-91ed7452eb56@measurement-factory.com>
 <CAFqyDwBrys1BJG6Vc967MDmX8f=PvHMUZbpG=WxtxcbY0ukQ0Q@mail.gmail.com>
 <CAFqyDwBM4StMYCJmKDHM3owhUy295o+qxMKQKjRugSj+XOzRJw@mail.gmail.com>
Message-ID: <433fe77c-544a-df35-258b-85a5ebd7a39e@measurement-factory.com>

On 4/20/23 13:14, Alexey?? Gruzdov wrote:

> Tell me please If I right understood I could to get answer like 
> "name=value" from my ACL ext script, instead of "OK" or "ERR", right?

Not "instead", but in addition to either OK or ERR.

Unfortunately, our documentation of the external ACL helper protocol has 
been hidden in a transition to GitHub Pages (or I cannot find it), but 
you can use the old wiki sources at the URL below to learn about that 
protocol:

https://github.com/squid-cache/squid-cache.github.io/blob/fa00274/Features/AddonHelpers.md#access-control-acl

General information about from-helper annotations:

https://github.com/squid-cache/squid-cache.github.io/blob/fa00274/Features/AddonHelpers.md#keyvalue-pairs-kv-pairs-format


> And does it means - I could to get answer depends from what users 
> authorises in to proxy.

> For example:
> 
> If user "Jon"? -? the my ACL will check the policy in the DB and send 
> answer like "proxy=g1" to squid, or if user is "Jack" - answer will be 
> like "proxy=all"

Yes, what annotation(s) the helper script sends to Squid (and why) is up 
to you. Please note, however, that annotation _names_ not ending with an 
underscore (_) are officially reserved for Squid use. I would be 
especially worried about using single, simple, generic words like "proxy"!


> and I will have ACL for this
> 
> acl proxy_g1_marked.acl note proxy g1
> acl proxy_all_marked.acl note proxy all
> 
> will that correct ?

Yes. An no transaction_annotation ACLs.


HTH,

Alex.


> ??, 20 ???. 2023??. ? 19:50, Alex Rousskov 
> <rousskov at measurement-factory.com 
> <mailto:rousskov at measurement-factory.com>>:
> 
>     On 4/20/23 10:54, Alexey?? Gruzdov wrote:
>      > The cpu is around 100% even no any requests is going....
> 
>     Then the problem is most likely in your script. Foe example, the script
>     actively doing something while there are no Squid requests to work on
>     (instead of blocking while waiting for the next Squid request).
> 
> 
>      > For now I left just one cache_peer in configuration?and got the
>     new error:
>      >
>      > commBind Cannot bind socket FD 28 to [::]: (13) Permission denied
> 
>     Could be one of the misconfigurations discussed at
>     https://wiki.squid-cache.org/Features/SmpScale#cannot-bind-socket-fd-nn-to--13-permission-denied <https://wiki.squid-cache.org/Features/SmpScale#cannot-bind-socket-fd-nn-to--13-permission-denied>
> 
> 
>     HTH,
> 
>     Alex.
> 
> 
>      > ??, 20 ???. 2023??. ? 17:21, Alex Rousskov:
>      >
>      >? ? ?On 4/20/23 04:23, Alexey?? Gruzdov wrote:
>      >
>      >? ? ? > cache_peer peerG1.com parent 40001 0 no-query no-digest
>     name=peerG1
>      >? ? ? >
>      >? ? ? > external_acl_type ext_proxy_g1_type %LOGIN %DST
>     /usr/local/bin/g1.py
>      >? ? ? >
>      >? ? ? > acl?proxy_g1_ext_mark_acl? ext_proxy_g1_type
>      >? ? ? >
>      >? ? ? > acl?proxy_g1_ext_marked_acl? annotate_transaction proxy=g1
>      >? ? ? >
>      >? ? ? > acl proxy_peerG1_acl?note proxy g1
>      >? ? ? >
>      >? ? ? > http_access deny
>     proxy_g1_ext_mark_acl??proxy_g1_ext_marked_acl?!all
>      >? ? ? > .....
>      >? ? ? > others http_access rules
>      >? ? ? >
>      >? ? ? > And this above works.
>      >
>      >? ? ?Glad to hear that. ( If others are going to use the above as
>     a guiding
>      >? ? ?example, I would recommend naming these ACLs very
>     differently, but that
>      >? ? ?is not important to Squid. )
>      >
>      >
>      >? ? ? > BUT
>      >? ? ? > I am worried?about why this my external script for ACL? type
>      >? ? ?loads the
>      >? ? ? > one of core of CPU to 100%.....???
>      >
>      >? ? ?External ACL caching aside, the script will be contacted once
>     for every
>      >? ? ?Squid transaction. Does your script CPU usage go down to zero
>     when
>      >? ? ?there
>      >? ? ?is no traffic? If not, then there is a bug in the script itself.
>      >
>      >? ? ?If you use the script from the command line, without Squid,
>     does it
>      >? ? ?consume a lot of CPU and/or take a lot of time per fake
>     query? You can
>      >? ? ?adjust the script to log the real query (when the script is
>     used by
>      >? ? ?Squid), so that you can easily replicate that query when
>     running the
>      >? ? ?script without Squid...
>      >
>      >? ? ?The cache key in your case is (the expansion of) "%LOGIN
>     %DST". It is
>      >? ? ?enabled by default IIRC. Look for "cache" related options at
>      > http://www.squid-cache.org/Doc/config/external_acl_type/
>     <http://www.squid-cache.org/Doc/config/external_acl_type/>
>      >? ? ?<http://www.squid-cache.org/Doc/config/external_acl_type/
>     <http://www.squid-cache.org/Doc/config/external_acl_type/>>
>      >
>      >
>      >? ? ? > ( I used three of workers in config,
>      >? ? ? > but I can see a six process called like my external helper
>      >? ? ?script, looks
>      >? ? ? > like squid runs x2 process for external ACL )
>      >
>      >? ? ?See external_acl_type children-* options:
>      > http://www.squid-cache.org/Doc/config/external_acl_type/
>     <http://www.squid-cache.org/Doc/config/external_acl_type/>
>      >? ? ?<http://www.squid-cache.org/Doc/config/external_acl_type/
>     <http://www.squid-cache.org/Doc/config/external_acl_type/>>
>      >
>      >? ? ?In most environments, I recommend setting all three of them
>     to the same
>      >? ? ?value. Please note that these options are not SMP-aware
>     (yet), so Squid
>      >? ? ?will _not_ divide their values by the number of workers and
>     give each
>      >? ? ?worker as many children as you state in squid.conf.
>      >
>      >
>      >? ? ? > Because if I will put the one more group of users (that
>     must to use
>      >? ? ? > another cache_peer ) - I will need to create one more external
>      >? ? ?script
>      >? ? ? > that will making to check an existed users from an
>     other?DB table
>      >
>      >? ? ?Once you get the basic setup above working for one group to your
>      >? ? ?satisfaction, I would recommend migrating from (one script
>     and one
>      >? ? ?matching annotate_transaction ACL) per group to a single
>     script for all
>      >? ? ?groups. That single external ACL script will send the right
>      >? ? ?annotation(s) to Squid.
>      >
>      >
>      >? ? ?HTH,
>      >
>      >? ? ?Alex.
>      >
>      >
>      >? ? ? > ??, 19 ???. 2023??. ? 22:39, Alex Rousskov:
>      >? ? ? >
>      >? ? ? >? ? ?On 4/19/23 13:30, Alexey?? Gruzdov wrote:
>      >? ? ? >
>      >? ? ? >? ? ? > cache_peer peerG1.com parent 40001 0 no-query no-digest
>      >? ? ?name=peerG1
>      >? ? ? >
>      >? ? ? >? ? ? > external_acl_type ext_proxy_g1_type %LOGIN %DST
>      >? ? ?/usr/local/bin/g1.py
>      >? ? ? >
>      >? ? ? >? ? ? > acl?proxy_g1_ext_acl?ext_proxy_g1_type
>      >? ? ? >
>      >? ? ? >? ? ?OK. I assume that /usr/local/bin/g1.py will only match
>     users that
>      >? ? ? >? ? ?should
>      >? ? ? >? ? ?go to cache_peer called peerG1.
>      >? ? ? >
>      >? ? ? >
>      >? ? ? >? ? ? > acl?proxy_g1_ext_acl_mark? annotate_transaction
>     proxy=g1
>      >? ? ? >
>      >? ? ? >? ? ?Please note that the name of this annotate_transaction
>     ACL --
>      >? ? ? >? ? ?"proxy_g1_ext_acl_mark" -- implies a relationship to the
>      >? ? ?external ACL
>      >? ? ? >? ? ?named "proxy_g1_ext_acl", but there is no such
>     relationship.
>      >? ? ?Squid does
>      >? ? ? >? ? ?not care about ACL names, but this naming problem may
>     indicate a
>      >? ? ? >? ? ?misunderstanding. To follow your naming scheme, this ACL
>      >? ? ?should be
>      >? ? ? >? ? ?called something like "proxy_g1_mark_acl" or
>      >? ? ?"mark_for_proxy_g1_acl".
>      >? ? ? >
>      >? ? ? >
>      >? ? ? >? ? ? > acl proxy_peerG1_acl?note proxy g1
>      >? ? ? >
>      >? ? ? >? ? ?OK. FWIW, a more consistent ACL name would have been
>      >? ? ? >? ? ?"proxy_g1_marked_acl" or "marked_for_proxy_g1_acl". Again,
>      >? ? ?Squid does
>      >? ? ? >? ? ?not really care about these names, so use whatever you
>     think is
>      >? ? ? >? ? ?consistent/meaningful/etc.
>      >? ? ? >
>      >? ? ? >
>      >? ? ? >? ? ? > http_access deny proxy_g1_ext_acl !all
>      >? ? ? >
>      >? ? ? >? ? ?This line has no (positive) effect. Squid will
>     evaluate the
>      >? ? ?external
>      >? ? ? >? ? ?ACL, but since the rule, as a whole, will never match
>     due to
>      >? ? ?"!all",
>      >? ? ? >? ? ?and
>      >? ? ? >? ? ?since the external ACL has no (relevant) side effects, you
>      >? ? ?can just
>      >? ? ? >? ? ?delete this line from your configuration.
>      >? ? ? >
>      >? ? ? >? ? ?Needless to say, if you delete this line, then
>      >? ? ?proxy_g1_ext_acl will be
>      >? ? ? >? ? ?unused, which should tell you that this configuration
>     is not
>      >? ? ?doing what
>      >? ? ? >? ? ?you want. See below for a fix recommendation.
>      >? ? ? >
>      >? ? ? >
>      >? ? ? >? ? ? > http_access deny proxy_g1_ext_acl_mark !all
>      >? ? ? >
>      >? ? ? >? ? ?This line will mark _all_ transactions. You only want
>     to mark
>      >? ? ? >? ? ?transactions that also matched proxy_g1_ext_acl. That
>     "b only
>      >? ? ?if a"
>      >? ? ? >? ? ?logic is accomplished by using _both_ ACLs in the same
>     rule:
>      >? ? ? >
>      >? ? ? >? ? ? ? ?http_access deny proxy_g1_ext_acl
>     proxy_g1_ext_acl_mark !all
>      >? ? ? >
>      >? ? ? >? ? ?With the above http_access rule (instead of the
>     earlier two),
>      >? ? ?Squid
>      >? ? ? >? ? ?will
>      >? ? ? >? ? ?evaluate the external ACL, and, if it matches, Squid will
>      >? ? ?also evaluate
>      >? ? ? >? ? ?the annotation-setting ACL. The whole rule will then be
>      >? ? ?rejected due to
>      >? ? ? >? ? ?"!all", but not until it annotates the transaction (if the
>      >? ? ?external ACL
>      >? ? ? >? ? ?matches). Again, in this sketch, we are using this
>     rule for its
>      >? ? ? >? ? ?annotation side effect only.
>      >? ? ? >
>      >? ? ? >
>      >? ? ? >? ? ? > And this works like I need now....
>      >? ? ? >
>      >? ? ? >? ? ?AFAICT, if the tests indicate that this configuration
>     works,
>      >? ? ?then the
>      >? ? ? >? ? ?tests are broken. IMHO, you should fix the tests
>     (while you
>      >? ? ?have a
>      >? ? ? >? ? ?broken configuration that can be used to test the
>     tests) before
>      >? ? ? >? ? ?proceeding with the configuration fix.
>      >? ? ? >
>      >? ? ? >
>      >? ? ? >? ? ?HTH,
>      >? ? ? >
>      >? ? ? >? ? ?Alex.
>      >? ? ? >? ? ?P.S. Please keep this email thread on squid-users
>     instead of
>      >? ? ?responding
>      >? ? ? >? ? ?to me personally.
>      >? ? ? >
>      >? ? ? >
>      >? ? ? >
>      >? ? ? >
>      >? ? ? >? ? ? > ??, 19 ???. 2023??. ? 21:01, Alexey?? Gruzdov:
>      >? ? ? >? ? ? >
>      >? ? ? >? ? ? >? ? ?so, ok? - Lets limit just to one cache peer and
>     one single
>      >? ? ? >? ? ?ACL (just
>      >? ? ? >? ? ? >? ? ?to understand the logic):
>      >? ? ? >? ? ? >
>      >? ? ? >? ? ? >? ? ? ?cache_peer peerG1.com parent 40001 0 no-query
>     no-digest
>      >? ? ? >? ? ?name=peerG1
>      >? ? ? >? ? ? >
>      >? ? ? >? ? ? >? ? ? ?external_acl_type ext_proxy_g1_type %LOGIN %DST
>      >? ? ? >? ? ? >? ? ?/usr/local/bin/g1.py? ?(this will answer "OK" 
>     or "ERR",
>      >? ? ? >? ? ?depends if
>      >? ? ? >? ? ? >? ? ?user consists in DB)
>      >? ? ? >? ? ? >
>      >? ? ? >? ? ? >? ? ? ?acl?proxy_g1_ext_acl
>      >? ? ?ext_proxy_g1_type?annotate_transaction
>      >? ? ? >? ? ? >? ? ?proxy=g1? ?(If I right understood here is a key
>     point
>      >? ? ?of how
>      >? ? ? >? ? ?to add
>      >? ? ? >? ? ? >? ? ?the tag to transaction related with user)
>      >? ? ? >? ? ? >? ? ? ?acl proxy_peerG1_acl?note proxy g1? (here we
>     create
>      >? ? ?the ACL
>      >? ? ? >? ? ?based
>      >? ? ? >? ? ? >? ? ?on the tag and this is fast ACL yet and we
>     should to
>      >? ? ?use it in
>      >? ? ? >? ? ? >? ? ?cache_peer_access)
>      >? ? ? >? ? ? >
>      >? ? ? >? ? ? >
>      >? ? ? >? ? ? >? ? ?http_access deny proxy_g1_ext_acl !all
>      >? ? ? >? ? ? >? ? ?......<others http access rules>
>      >? ? ? >? ? ? >
>      >? ? ? >? ? ? >
>      >? ? ? >? ? ? >? ? ?cache_peer_access peerG1 allow proxy_peerG1_acl
>      >? ? ? >? ? ? >? ? ?cache_peer_access peerG1 deny all
>      >? ? ? >? ? ? >
>      >? ? ? >? ? ? >? ? ?Is that correct ?
>      >? ? ? >? ? ? >
>      >? ? ? >? ? ? >? ? ???, 18 ???. 2023??. ? 23:44, Alex Rousskov
>      >? ? ? >? ? ? >? ? ?<rousskov at measurement-factory.com
>     <mailto:rousskov at measurement-factory.com>
>      >? ? ?<mailto:rousskov at measurement-factory.com
>     <mailto:rousskov at measurement-factory.com>>
>      >? ? ? >? ? ?<mailto:rousskov at measurement-factory.com
>     <mailto:rousskov at measurement-factory.com>
>      >? ? ?<mailto:rousskov at measurement-factory.com
>     <mailto:rousskov at measurement-factory.com>>>
>      >? ? ? >? ? ? >? ? ?<mailto:rousskov at measurement-factory.com
>     <mailto:rousskov at measurement-factory.com>
>      >? ? ?<mailto:rousskov at measurement-factory.com
>     <mailto:rousskov at measurement-factory.com>>
>      >? ? ? >? ? ?<mailto:rousskov at measurement-factory.com
>     <mailto:rousskov at measurement-factory.com>
>      >? ? ?<mailto:rousskov at measurement-factory.com
>     <mailto:rousskov at measurement-factory.com>>>>>:
>      >? ? ? >? ? ? >
>      >? ? ? >? ? ? >? ? ? ? ?On 4/18/23 11:41, Alexey?? Gruzdov wrote:
>      >? ? ? >? ? ? >
>      >? ? ? >? ? ? >? ? ? ? ? > Could you explain me how the annotation
>     transaction
>      >? ? ? >? ? ?works and
>      >? ? ? >? ? ? >? ? ? ? ?how it
>      >? ? ? >? ? ? >? ? ? ? ? > related to acl that I could to use with
>     cache_peers
>      >? ? ? >? ? ? >
>      >? ? ? >? ? ? >? ? ? ? ?Transactions have a (possibly empty) set of
>     name=value
>      >? ? ? >? ? ?annotations.
>      >? ? ? >? ? ? >
>      >? ? ? >? ? ? >? ? ? ? ?During Squid configuration time, Squid
>     parses all ACL
>      >? ? ? >? ? ? >? ? ? ? ?declarations in
>      >? ? ? >? ? ? >? ? ? ? ?your configuration file. When Squid parses an
>      >? ? ? >? ? ? >? ? ? ? ?annotation_transaction ACL
>      >? ? ? >? ? ? >? ? ? ? ?declaration, Squid remembers what transaction
>      >? ? ?annotation
>      >? ? ? >? ? ?to add
>      >? ? ? >? ? ? >? ? ? ? ?in the
>      >? ? ? >? ? ? >? ? ? ? ?future, [every time] when that ACL is
>     evaluated (e.g.,
>      >? ? ? >? ? ?used in
>      >? ? ? >? ? ? >? ? ? ? ?http_access rule that Squid reaches during
>     transaction
>      >? ? ? >? ? ?processing).
>      >? ? ? >? ? ? >
>      >? ? ? >? ? ? >? ? ? ? ?When evaluated, an "annotation_transaction"
>     ACL simply
>      >? ? ? >? ? ?adds the
>      >? ? ? >? ? ? >? ? ? ? ?previously configured annotation to the current
>      >? ? ? >? ? ?transaction and
>      >? ? ? >? ? ? >? ? ? ? ?returns
>      >? ? ? >? ? ? >? ? ? ? ?a "yes, this transaction matches" result.
>      >? ? ? >? ? ? >
>      >? ? ? >? ? ? >? ? ? ? ?When evaluated, a "note" ACL returns a
>     "yes, this
>      >? ? ?transaction
>      >? ? ? >? ? ? >? ? ? ? ?matches"
>      >? ? ? >? ? ? >? ? ? ? ?result if and only if the current transaction
>      >? ? ?already has the
>      >? ? ? >? ? ? >? ? ? ? ?matching
>      >? ? ? >? ? ? >? ? ? ? ?annotation. This ACL does not modify the set of
>      >? ? ?transaction
>      >? ? ? >? ? ? >? ? ? ? ?annotations.
>      >? ? ? >? ? ? >
>      >? ? ? >? ? ? >? ? ? ? ?The combination of annotate_transaction and
>     note ACLs
>      >? ? ? >? ? ?allows you to
>      >? ? ? >? ? ? >? ? ? ? ?annotate a transaction at one time and check
>      >? ? ?previously set
>      >? ? ? >? ? ? >? ? ? ? ?transaction
>      >? ? ? >? ? ? >? ? ? ? ?annotations at another time. The timing and
>      >? ? ?meaning of those
>      >? ? ? >? ? ? >? ? ? ? ?annotations
>      >? ? ? >? ? ? >? ? ? ? ?are up to you.
>      >? ? ? >? ? ? >
>      >? ? ? >? ? ? >
>      >? ? ? >? ? ? >? ? ? ? ? > ok! Lets look to my case example:
>      >? ? ? >? ? ? >
>      >? ? ? >? ? ? >? ? ? ? ? > cache_peer peerG1.com parent 40001 0
>     no-query
>      >? ? ?no-digest
>      >? ? ? >? ? ? >? ? ? ? ?name=peerG1?round-robin
>      >? ? ? >? ? ? >
>      >? ? ? >? ? ? >? ? ? ? ? > cache_peer_access? peerG1 allow
>     proxy_peerG1_acl
>      >? ? ? >? ? ? >? ? ? ? ? > cache_peer_access? peerG1 allow
>     proxy_all_acl
>      >? ? ? >? ? ? >? ? ? ? ? > cache_peer_access? peerG1 deny all
>      >? ? ? >? ? ? >
>      >? ? ? >? ? ? >? ? ? ? ? > acl proxy_peerG1_acl? proxy_auth
>      >? ? ?"../users.peerG1.txt"
>      >? ? ? >? ? ? >? ? ? ? ? > acl proxy_all_acl? proxy_auth 
>     "../users.all.txt"
>      >? ? ? >? ? ? >
>      >? ? ? >? ? ? >? ? ? ? ?[ I added the missing "acl " directive to the
>      >? ? ?above ACL
>      >? ? ? >? ? ? >? ? ? ? ?declarations and
>      >? ? ? >? ? ? >? ? ? ? ?stripped rules for two out of three
>     cache_peers ]
>      >? ? ? >? ? ? >
>      >? ? ? >? ? ? >? ? ? ? ?As you know, the above cache_peer_access
>      >? ? ?configuration is not
>      >? ? ? >? ? ? >? ? ? ? ?supported
>      >? ? ? >? ? ? >? ? ? ? ?because it uses "slow" proxy_auth ACLs in
>      >? ? ?cache_peer_access
>      >? ? ? >? ? ? >? ? ? ? ?directives
>      >? ? ? >? ? ? >? ? ? ? ?that only support "fast" ACLs. It does not
>     matter
>      >? ? ?(to me),
>      >? ? ? >? ? ? >? ? ? ? ?whether the
>      >? ? ? >? ? ? >? ? ? ? ?above appears to "work" in some
>     environments. YMMV.
>      >? ? ? >? ? ? >
>      >? ? ? >? ? ? >? ? ? ? ?To fix this problem, we can use http_access
>     rules to
>      >? ? ? >? ? ?essentially
>      >? ? ? >? ? ? >? ? ? ? ?remember proxy_auth evaluation results (at
>     http_access
>      >? ? ? >? ? ? >? ? ? ? ?evaluation time)
>      >? ? ? >? ? ? >? ? ? ? ?as transaction annotations. Here is an untested
>      >? ? ?sketch that
>      >? ? ? >? ? ? >? ? ? ? ?omits other
>      >? ? ? >? ? ? >? ? ? ? ?(important but irrelevant here) http_access
>     rules
>      >? ? ?and assumes
>      >? ? ? >? ? ? >? ? ? ? ?that these
>      >? ? ? >? ? ? >? ? ? ? ?sketched http_access rules _are_ evaluated:
>      >? ? ? >? ? ? >
>      >? ? ? >? ? ? >? ? ? ? ? ? ?# if proxy_peerG1_acl matches, evaluate
>      >? ? ?mark_for_peerG1
>      >? ? ? >? ? ? >? ? ? ? ? ? ?http_access deny proxy_peerG1_acl
>      >? ? ?mark_for_peerG1 !all
>      >? ? ? >? ? ? >
>      >? ? ? >? ? ? >? ? ? ? ? ? ?# if proxy_all_acl matches, evaluate
>      >? ? ?mark_for_all_peers
>      >? ? ? >? ? ? >? ? ? ? ? ? ?http_access deny proxy_all_acl
>      >? ? ?mark_for_all_peers !all
>      >? ? ? >? ? ? >
>      >? ? ? >? ? ? >
>      >? ? ? >? ? ? >? ? ? ? ?Now we can use those remembered proxy_... acl
>      >? ? ?evaluation
>      >? ? ? >? ? ?results
>      >? ? ? >? ? ? >? ? ? ? ?(i.e.
>      >? ? ? >? ? ? >? ? ? ? ?we can check for the matching annotations) in
>      >? ? ? >? ? ?cache_peer_access
>      >? ? ? >? ? ? >? ? ? ? ?rules:
>      >? ? ? >? ? ? >
>      >? ? ? >? ? ? >? ? ? ? ? ? ?cache_peer_access peerG1 allow
>     marked_for_peerG1
>      >? ? ? >? ? ? >? ? ? ? ? ? ?cache_peer_access peerG1 allow
>      >? ? ?marked_for_all_peers
>      >? ? ? >? ? ? >? ? ? ? ? ? ?cache_peer_access peerG1 deny all
>      >? ? ? >? ? ? >
>      >? ? ? >? ? ? >
>      >? ? ? >? ? ? >? ? ? ? ?where the new ACLs mentioned above are
>     declared along
>      >? ? ? >? ? ?these lines:
>      >? ? ? >? ? ? >
>      >? ? ? >? ? ? >? ? ? ? ? ? ?acl mark_for_peerG1 annotate_transaction
>      >? ? ?for_peer_=G1
>      >? ? ? >? ? ? >? ? ? ? ? ? ?acl mark_for_all_peers annotate_transaction
>      >? ? ? >? ? ?for_all_peers_=true
>      >? ? ? >? ? ? >
>      >? ? ? >? ? ? >? ? ? ? ? ? ?acl marked_for_peerG1 note for_peer_ G1
>      >? ? ? >? ? ? >? ? ? ? ? ? ?acl marked_for_all_peers note
>     for_all_peers_ true
>      >? ? ? >? ? ? >
>      >? ? ? >? ? ? >? ? ? ? ?This can probably be simplified further by
>     using
>      >? ? ? >? ? ?for_peer_=ALL
>      >? ? ? >? ? ? >? ? ? ? ?instead
>      >? ? ? >? ? ? >? ? ? ? ?of for_all_peers_=true annotation, but I
>     wanted to
>      >? ? ? >? ? ?preserve the
>      >? ? ? >? ? ? >? ? ? ? ?symmetry
>      >? ? ? >? ? ? >? ? ? ? ?with your original configuration.
>      >? ? ? >? ? ? >
>      >? ? ? >? ? ? >
>      >? ? ? >? ? ? >? ? ? ? ? > And these all works like I need, But -
>     once I am
>      >? ? ? >? ? ?changing a
>      >? ? ? >? ? ? >? ? ? ? ?list of
>      >? ? ? >? ? ? >? ? ? ? ? > users (add or remove) - I need to use
>     "squid -k
>      >? ? ? >? ? ? >? ? ? ? ?reconfigure"...... but
>      >? ? ? >? ? ? >? ? ? ? ? > of course better to go without this
>     reconfigure
>      >? ? ? >? ? ? >
>      >? ? ? >? ? ? >? ? ? ? ?One can avoid reconfiguration using an
>     external ACL
>      >? ? ? >? ? ?script that
>      >? ? ? >? ? ? >? ? ? ? ?gives
>      >? ? ? >? ? ? >? ? ? ? ?Squid the right for_peer_=... annotations
>     (instead
>      >? ? ?of using
>      >? ? ? >? ? ? >? ? ? ? ?"constant"
>      >? ? ? >? ? ? >? ? ? ? ?or "hard-coded" annotate_transaction ACLs
>     to store
>      >? ? ?the same
>      >? ? ? >? ? ? >? ? ? ? ?annotations).
>      >? ? ? >? ? ? >
>      >? ? ? >? ? ? >? ? ? ? ?However, it may be better to make the above
>     sketch
>      >? ? ?to work
>      >? ? ? >? ? ? >? ? ? ? ?_before_ you
>      >? ? ? >? ? ? >? ? ? ? ?replace mark_for_peerG1 ACLs/rules with an
>     external
>      >? ? ? >? ? ? >? ? ? ? ?mark_for_the_right_peer ACL.
>      >? ? ? >? ? ? >
>      >? ? ? >? ? ? >
>      >? ? ? >? ? ? >? ? ? ? ?HTH,
>      >? ? ? >? ? ? >
>      >? ? ? >? ? ? >? ? ? ? ?Alex.
>      >? ? ? >? ? ? >? ? ? ? ?P.S. This thread continues the discussion
>     started at
>      >? ? ? >? ? ? > https://bugs.squid-cache.org/show_bug.cgi?id=5268
>     <https://bugs.squid-cache.org/show_bug.cgi?id=5268>
>      >? ? ?<https://bugs.squid-cache.org/show_bug.cgi?id=5268
>     <https://bugs.squid-cache.org/show_bug.cgi?id=5268>>
>      >? ? ? >? ? ?<https://bugs.squid-cache.org/show_bug.cgi?id=5268
>     <https://bugs.squid-cache.org/show_bug.cgi?id=5268>
>      >? ? ?<https://bugs.squid-cache.org/show_bug.cgi?id=5268
>     <https://bugs.squid-cache.org/show_bug.cgi?id=5268>>>
>      >? ? ? >? ? ? >       
>      ?<https://bugs.squid-cache.org/show_bug.cgi?id=5268
>     <https://bugs.squid-cache.org/show_bug.cgi?id=5268>
>      >? ? ?<https://bugs.squid-cache.org/show_bug.cgi?id=5268
>     <https://bugs.squid-cache.org/show_bug.cgi?id=5268>>
>      >? ? ? >? ? ?<https://bugs.squid-cache.org/show_bug.cgi?id=5268
>     <https://bugs.squid-cache.org/show_bug.cgi?id=5268>
>      >? ? ?<https://bugs.squid-cache.org/show_bug.cgi?id=5268
>     <https://bugs.squid-cache.org/show_bug.cgi?id=5268>>>>
>      >? ? ? >? ? ? >
>      >? ? ? >? ? ? >? ? ? ? ?_______________________________________________
>      >? ? ? >? ? ? >? ? ? ? ?squid-users mailing list
>      >? ? ? >? ? ? > squid-users at lists.squid-cache.org
>     <mailto:squid-users at lists.squid-cache.org>
>      >? ? ?<mailto:squid-users at lists.squid-cache.org
>     <mailto:squid-users at lists.squid-cache.org>>
>      >? ? ? >? ? ?<mailto:squid-users at lists.squid-cache.org
>     <mailto:squid-users at lists.squid-cache.org>
>      >? ? ?<mailto:squid-users at lists.squid-cache.org
>     <mailto:squid-users at lists.squid-cache.org>>>
>      >? ? ? >? ? ? >? ? ? ? ?<mailto:squid-users at lists.squid-cache.org
>     <mailto:squid-users at lists.squid-cache.org>
>      >? ? ?<mailto:squid-users at lists.squid-cache.org
>     <mailto:squid-users at lists.squid-cache.org>>
>      >? ? ? >? ? ?<mailto:squid-users at lists.squid-cache.org
>     <mailto:squid-users at lists.squid-cache.org>
>      >? ? ?<mailto:squid-users at lists.squid-cache.org
>     <mailto:squid-users at lists.squid-cache.org>>>>
>      >? ? ? >? ? ? > http://lists.squid-cache.org/listinfo/squid-users
>     <http://lists.squid-cache.org/listinfo/squid-users>
>      >? ? ?<http://lists.squid-cache.org/listinfo/squid-users
>     <http://lists.squid-cache.org/listinfo/squid-users>>
>      >? ? ? >? ? ?<http://lists.squid-cache.org/listinfo/squid-users
>     <http://lists.squid-cache.org/listinfo/squid-users>
>      >? ? ?<http://lists.squid-cache.org/listinfo/squid-users
>     <http://lists.squid-cache.org/listinfo/squid-users>>>
>      >? ? ? >? ? ? >       
>      ?<http://lists.squid-cache.org/listinfo/squid-users
>     <http://lists.squid-cache.org/listinfo/squid-users>
>      >? ? ?<http://lists.squid-cache.org/listinfo/squid-users
>     <http://lists.squid-cache.org/listinfo/squid-users>>
>      >? ? ? >? ? ?<http://lists.squid-cache.org/listinfo/squid-users
>     <http://lists.squid-cache.org/listinfo/squid-users>
>      >? ? ?<http://lists.squid-cache.org/listinfo/squid-users
>     <http://lists.squid-cache.org/listinfo/squid-users>>>>
>      >? ? ? >? ? ? >
>      >? ? ? >? ? ? >
>      >? ? ? >? ? ? >
>      >? ? ? >? ? ? >? ? ?--
>      >? ? ? >? ? ? >? ? ?? ????????? ? ???
>      >? ? ? >? ? ? >? ? ????????
>      >? ? ? >? ? ? >? ? ?+79043828661
>      >? ? ? >? ? ? >? ? ?620000 ?.???????????? ?2022
>      >? ? ? >? ? ? >
>      >? ? ? >? ? ? >
>      >? ? ? >? ? ? >
>      >? ? ? >? ? ? > --
>      >? ? ? >? ? ? > ? ????????? ? ???
>      >? ? ? >? ? ? > ???????
>      >? ? ? >? ? ? > +79043828661
>      >? ? ? >? ? ? > 620000 ?.???????????? ?2022
>      >? ? ? >? ? ? >
>      >? ? ? >
>      >? ? ? >
>      >? ? ? >
>      >? ? ? > --
>      >? ? ? > ? ????????? ? ???
>      >? ? ? > ???????
>      >? ? ? > +79043828661
>      >? ? ? > 620000 ?.???????????? ?2022
>      >? ? ? >
>      >? ? ? >
>      >? ? ? > _______________________________________________
>      >? ? ? > squid-users mailing list
>      >? ? ? > squid-users at lists.squid-cache.org
>     <mailto:squid-users at lists.squid-cache.org>
>      >? ? ?<mailto:squid-users at lists.squid-cache.org
>     <mailto:squid-users at lists.squid-cache.org>>
>      >? ? ? > http://lists.squid-cache.org/listinfo/squid-users
>     <http://lists.squid-cache.org/listinfo/squid-users>
>      >? ? ?<http://lists.squid-cache.org/listinfo/squid-users
>     <http://lists.squid-cache.org/listinfo/squid-users>>
>      >
>      >? ? ?_______________________________________________
>      >? ? ?squid-users mailing list
>      > squid-users at lists.squid-cache.org
>     <mailto:squid-users at lists.squid-cache.org>
>      >? ? ?<mailto:squid-users at lists.squid-cache.org
>     <mailto:squid-users at lists.squid-cache.org>>
>      > http://lists.squid-cache.org/listinfo/squid-users
>     <http://lists.squid-cache.org/listinfo/squid-users>
>      >? ? ?<http://lists.squid-cache.org/listinfo/squid-users
>     <http://lists.squid-cache.org/listinfo/squid-users>>
>      >
>      >
>      > _______________________________________________
>      > squid-users mailing list
>      > squid-users at lists.squid-cache.org
>     <mailto:squid-users at lists.squid-cache.org>
>      > http://lists.squid-cache.org/listinfo/squid-users
>     <http://lists.squid-cache.org/listinfo/squid-users>
> 
>     _______________________________________________
>     squid-users mailing list
>     squid-users at lists.squid-cache.org
>     <mailto:squid-users at lists.squid-cache.org>
>     http://lists.squid-cache.org/listinfo/squid-users
>     <http://lists.squid-cache.org/listinfo/squid-users>
> 
> 
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users



From squid3 at treenet.co.nz  Thu Apr 20 20:18:12 2023
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Fri, 21 Apr 2023 08:18:12 +1200
Subject: [squid-users] Fwd: cache_peer_access by dynamic ACL
In-Reply-To: <433fe77c-544a-df35-258b-85a5ebd7a39e@measurement-factory.com>
References: <CAFqyDwB82whYStQnbLcjX8JUyostgeMgiWQP1o0UxoYs9FKJyQ@mail.gmail.com>
 <647cd5f1-851c-4937-2ced-561f2e704f55@measurement-factory.com>
 <CAFqyDwDt-dzfVbi5s91sEgB=viNovRjP=OWNTZrY1CVCv5SNJQ@mail.gmail.com>
 <CAFqyDwBWrZ_O-yXr0J9Bb4HqWvfq8HR+_4QPVgueQ7Pa=OmeFQ@mail.gmail.com>
 <5a11ceaa-c3f4-4a80-3ac4-9df3c8be3c3e@measurement-factory.com>
 <CAFqyDwBsFU80tc5TsAuG109o9XGuMP7dXZ4rSnvuX4Js6CiHWg@mail.gmail.com>
 <4e3df8c9-52a7-1afd-b3d3-6971cdae75fb@measurement-factory.com>
 <CAFqyDwCKi+CB_M-NgirDraHjUoiF5XUy8GyM-5ivU1rLe5fGGQ@mail.gmail.com>
 <3e08fdfd-63a2-6c22-a499-91ed7452eb56@measurement-factory.com>
 <CAFqyDwBrys1BJG6Vc967MDmX8f=PvHMUZbpG=WxtxcbY0ukQ0Q@mail.gmail.com>
 <CAFqyDwBM4StMYCJmKDHM3owhUy295o+qxMKQKjRugSj+XOzRJw@mail.gmail.com>
 <433fe77c-544a-df35-258b-85a5ebd7a39e@measurement-factory.com>
Message-ID: <b110b6f8-8bdb-8744-f96b-2ac23cae9dbd@treenet.co.nz>

On 21/04/2023 6:31 am, Alex Rousskov wrote:
> On 4/20/23 13:14, Alexey?? Gruzdov wrote:
>
>> Tell me please If I right understood I could to get answer like 
>> "name=value" from my ACL ext script, instead of "OK" or "ERR", right?
>
> Not "instead", but in addition to either OK or ERR.
>
> Unfortunately, our documentation of the external ACL helper protocol 
> has been hidden in a transition to GitHub Pages (or I cannot find it), 
> but you can use the old wiki sources at the URL below to learn about 
> that protocol:

The URL is:

https://wiki.squid-cache.org/Features/AddonHelpers#access-control-acl


> General information about from-helper annotations:
>

and 
https://wiki.squid-cache.org/Features/AddonHelpers#keyvalue-pairs-kv-pairs-format


HTH
Amos


From rousskov at measurement-factory.com  Thu Apr 20 20:32:23 2023
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Thu, 20 Apr 2023 16:32:23 -0400
Subject: [squid-users] Fwd: cache_peer_access by dynamic ACL
In-Reply-To: <b110b6f8-8bdb-8744-f96b-2ac23cae9dbd@treenet.co.nz>
References: <CAFqyDwB82whYStQnbLcjX8JUyostgeMgiWQP1o0UxoYs9FKJyQ@mail.gmail.com>
 <647cd5f1-851c-4937-2ced-561f2e704f55@measurement-factory.com>
 <CAFqyDwDt-dzfVbi5s91sEgB=viNovRjP=OWNTZrY1CVCv5SNJQ@mail.gmail.com>
 <CAFqyDwBWrZ_O-yXr0J9Bb4HqWvfq8HR+_4QPVgueQ7Pa=OmeFQ@mail.gmail.com>
 <5a11ceaa-c3f4-4a80-3ac4-9df3c8be3c3e@measurement-factory.com>
 <CAFqyDwBsFU80tc5TsAuG109o9XGuMP7dXZ4rSnvuX4Js6CiHWg@mail.gmail.com>
 <4e3df8c9-52a7-1afd-b3d3-6971cdae75fb@measurement-factory.com>
 <CAFqyDwCKi+CB_M-NgirDraHjUoiF5XUy8GyM-5ivU1rLe5fGGQ@mail.gmail.com>
 <3e08fdfd-63a2-6c22-a499-91ed7452eb56@measurement-factory.com>
 <CAFqyDwBrys1BJG6Vc967MDmX8f=PvHMUZbpG=WxtxcbY0ukQ0Q@mail.gmail.com>
 <CAFqyDwBM4StMYCJmKDHM3owhUy295o+qxMKQKjRugSj+XOzRJw@mail.gmail.com>
 <433fe77c-544a-df35-258b-85a5ebd7a39e@measurement-factory.com>
 <b110b6f8-8bdb-8744-f96b-2ac23cae9dbd@treenet.co.nz>
Message-ID: <3a8107bf-d514-be69-e279-65a610a4fe2a@measurement-factory.com>

On 4/20/23 16:18, Amos Jeffries wrote:
> On 21/04/2023 6:31 am, Alex Rousskov wrote:
>> On 4/20/23 13:14, Alexey?? Gruzdov wrote:
>>
>>> Tell me please If I right understood I could to get answer like 
>>> "name=value" from my ACL ext script, instead of "OK" or "ERR", right?
>>
>> Not "instead", but in addition to either OK or ERR.
>>
>> Unfortunately, our documentation of the external ACL helper protocol 
>> has been hidden in a transition to GitHub Pages (or I cannot find it), 
>> but you can use the old wiki sources at the URL below to learn about 
>> that protocol:
> 
> The URL is:
> 
> https://wiki.squid-cache.org/Features/AddonHelpers#access-control-acl


Yes, Francesco has restored that wiki page a few minutes ago. Thank you, 
Francesco.

Alex.


>> General information about from-helper annotations:
>>
> 
> and 
> https://wiki.squid-cache.org/Features/AddonHelpers#keyvalue-pairs-kv-pairs-format
> 
> 
> HTH
> Amos
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users



From my.shellac at gmail.com  Sun Apr 23 05:27:52 2023
From: my.shellac at gmail.com (=?UTF-8?B?QWxleGV50Y/RgCBHcnV6ZG92?=)
Date: Sun, 23 Apr 2023 10:27:52 +0500
Subject: [squid-users] Fwd: cache_peer_access by dynamic ACL
In-Reply-To: <3a8107bf-d514-be69-e279-65a610a4fe2a@measurement-factory.com>
References: <CAFqyDwB82whYStQnbLcjX8JUyostgeMgiWQP1o0UxoYs9FKJyQ@mail.gmail.com>
 <647cd5f1-851c-4937-2ced-561f2e704f55@measurement-factory.com>
 <CAFqyDwDt-dzfVbi5s91sEgB=viNovRjP=OWNTZrY1CVCv5SNJQ@mail.gmail.com>
 <CAFqyDwBWrZ_O-yXr0J9Bb4HqWvfq8HR+_4QPVgueQ7Pa=OmeFQ@mail.gmail.com>
 <5a11ceaa-c3f4-4a80-3ac4-9df3c8be3c3e@measurement-factory.com>
 <CAFqyDwBsFU80tc5TsAuG109o9XGuMP7dXZ4rSnvuX4Js6CiHWg@mail.gmail.com>
 <4e3df8c9-52a7-1afd-b3d3-6971cdae75fb@measurement-factory.com>
 <CAFqyDwCKi+CB_M-NgirDraHjUoiF5XUy8GyM-5ivU1rLe5fGGQ@mail.gmail.com>
 <3e08fdfd-63a2-6c22-a499-91ed7452eb56@measurement-factory.com>
 <CAFqyDwBrys1BJG6Vc967MDmX8f=PvHMUZbpG=WxtxcbY0ukQ0Q@mail.gmail.com>
 <CAFqyDwBM4StMYCJmKDHM3owhUy295o+qxMKQKjRugSj+XOzRJw@mail.gmail.com>
 <433fe77c-544a-df35-258b-85a5ebd7a39e@measurement-factory.com>
 <b110b6f8-8bdb-8744-f96b-2ac23cae9dbd@treenet.co.nz>
 <3a8107bf-d514-be69-e279-65a610a4fe2a@measurement-factory.com>
Message-ID: <CAFqyDwCAUaoTKaQ+wMCYaP=tqNnkAscVmQiPhLLqHksWi754WQ@mail.gmail.com>

Hello Guys!
Thank you very much! For now all works like I needed!

But I have an one more  questions about how I could to use the kv-pair:


>From wiki :

Defined keywords:

	  user=		The users name (login)

	  password=	The users password (for login= cache_peer option)

	  message=	Message describing the reason for this response.
			Available as %o in error pages.
			Useful on (ERR and BH results).

	  tag=		Apply a tag to a request. Only sets a tag once,
			does not alter existing tags.

	  log=		String to be logged in access.log. Available as
			%ea in logformat specifications.

	  clt_conn_tag= Associates a TAG with the client TCP connection.
			Please see url_rewrite_program related documentation
			for this kv-pair.


In my case I use an ACL with notification transaction like ?proxy=all?

and then ACL with ?note proxy all ?
But how the kv-pair must to be looked for this my tag ?

I have tried to get answer from my ext script like
?OK?
?proxy=all?

But looks like it?s not correct


Could you explain a little more ?


Thank you !

??, 21 ???. 2023??. ? 00:32, Alex Rousskov <rousskov at measurement-factory.com
>:

> On 4/20/23 16:18, Amos Jeffries wrote:
> > On 21/04/2023 6:31 am, Alex Rousskov wrote:
> >> On 4/20/23 13:14, Alexey?? Gruzdov wrote:
> >>
> >>> Tell me please If I right understood I could to get answer like
> >>> "name=value" from my ACL ext script, instead of "OK" or "ERR", right?
> >>
> >> Not "instead", but in addition to either OK or ERR.
> >>
> >> Unfortunately, our documentation of the external ACL helper protocol
> >> has been hidden in a transition to GitHub Pages (or I cannot find it),
> >> but you can use the old wiki sources at the URL below to learn about
> >> that protocol:
> >
> > The URL is:
> >
> > https://wiki.squid-cache.org/Features/AddonHelpers#access-control-acl
>
>
> Yes, Francesco has restored that wiki page a few minutes ago. Thank you,
> Francesco.
>
> Alex.
>
>
> >> General information about from-helper annotations:
> >>
> >
> > and
> >
> https://wiki.squid-cache.org/Features/AddonHelpers#keyvalue-pairs-kv-pairs-format
> >
> >
> > HTH
> > Amos
> > _______________________________________________
> > squid-users mailing list
> > squid-users at lists.squid-cache.org
> > http://lists.squid-cache.org/listinfo/squid-users
>
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230423/6a16a28a/attachment.htm>

From squid3 at treenet.co.nz  Sun Apr 23 12:36:28 2023
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Mon, 24 Apr 2023 00:36:28 +1200
Subject: [squid-users] Fwd: cache_peer_access by dynamic ACL
In-Reply-To: <CAFqyDwCAUaoTKaQ+wMCYaP=tqNnkAscVmQiPhLLqHksWi754WQ@mail.gmail.com>
References: <CAFqyDwB82whYStQnbLcjX8JUyostgeMgiWQP1o0UxoYs9FKJyQ@mail.gmail.com>
 <647cd5f1-851c-4937-2ced-561f2e704f55@measurement-factory.com>
 <CAFqyDwDt-dzfVbi5s91sEgB=viNovRjP=OWNTZrY1CVCv5SNJQ@mail.gmail.com>
 <CAFqyDwBWrZ_O-yXr0J9Bb4HqWvfq8HR+_4QPVgueQ7Pa=OmeFQ@mail.gmail.com>
 <5a11ceaa-c3f4-4a80-3ac4-9df3c8be3c3e@measurement-factory.com>
 <CAFqyDwBsFU80tc5TsAuG109o9XGuMP7dXZ4rSnvuX4Js6CiHWg@mail.gmail.com>
 <4e3df8c9-52a7-1afd-b3d3-6971cdae75fb@measurement-factory.com>
 <CAFqyDwCKi+CB_M-NgirDraHjUoiF5XUy8GyM-5ivU1rLe5fGGQ@mail.gmail.com>
 <3e08fdfd-63a2-6c22-a499-91ed7452eb56@measurement-factory.com>
 <CAFqyDwBrys1BJG6Vc967MDmX8f=PvHMUZbpG=WxtxcbY0ukQ0Q@mail.gmail.com>
 <CAFqyDwBM4StMYCJmKDHM3owhUy295o+qxMKQKjRugSj+XOzRJw@mail.gmail.com>
 <433fe77c-544a-df35-258b-85a5ebd7a39e@measurement-factory.com>
 <b110b6f8-8bdb-8744-f96b-2ac23cae9dbd@treenet.co.nz>
 <3a8107bf-d514-be69-e279-65a610a4fe2a@measurement-factory.com>
 <CAFqyDwCAUaoTKaQ+wMCYaP=tqNnkAscVmQiPhLLqHksWi754WQ@mail.gmail.com>
Message-ID: <a37abc7a-4c5a-6747-fdd7-f3ad2b0b2328@treenet.co.nz>

On 23/04/2023 5:27 pm, Alexey?? Gruzdov wrote:
> Hello Guys!
> Thank you very much! For now all works like I needed!
>
> But I have an one more ?questions about how I could to use the kv-pair:
...
> and then ACL with ?note proxy all ?
> But how the kv-pair must to be looked for this my tag ?
>
> I have tried to get answer from my ext script like
> ?OK?
> ?proxy=all?
>
> But looks like it?s not correct
>

This part of the instructions were missed:
https://wiki.squid-cache.org/Features/AddonHelpers#helper-protocols
"
For every line sent by Squid exactly one line is expected back. Some 
script language such as perl and python need to be careful about the 
number of newlines in their output.
"

If your helper received something like this (with concurrency channel-id 
"1"):

 ?"1 bob 192.0.2.1"

It should produce a line like:
 ? "1 OK proxy=all"

If no concurrency channel-id is received, then output is the same but 
without sending channel-id back and MUST be sent in same order as received.

I do recommend using concurrency. It can help further debug issues with 
helpers responding incorrectly.

HTH
Amos



From my.shellac at gmail.com  Sun Apr 23 18:28:44 2023
From: my.shellac at gmail.com (=?UTF-8?B?QWxleGV50Y/RgCBHcnV6ZG92?=)
Date: Sun, 23 Apr 2023 22:28:44 +0400
Subject: [squid-users] Fwd: cache_peer_access by dynamic ACL
In-Reply-To: <a37abc7a-4c5a-6747-fdd7-f3ad2b0b2328@treenet.co.nz>
References: <CAFqyDwB82whYStQnbLcjX8JUyostgeMgiWQP1o0UxoYs9FKJyQ@mail.gmail.com>
 <647cd5f1-851c-4937-2ced-561f2e704f55@measurement-factory.com>
 <CAFqyDwDt-dzfVbi5s91sEgB=viNovRjP=OWNTZrY1CVCv5SNJQ@mail.gmail.com>
 <CAFqyDwBWrZ_O-yXr0J9Bb4HqWvfq8HR+_4QPVgueQ7Pa=OmeFQ@mail.gmail.com>
 <5a11ceaa-c3f4-4a80-3ac4-9df3c8be3c3e@measurement-factory.com>
 <CAFqyDwBsFU80tc5TsAuG109o9XGuMP7dXZ4rSnvuX4Js6CiHWg@mail.gmail.com>
 <4e3df8c9-52a7-1afd-b3d3-6971cdae75fb@measurement-factory.com>
 <CAFqyDwCKi+CB_M-NgirDraHjUoiF5XUy8GyM-5ivU1rLe5fGGQ@mail.gmail.com>
 <3e08fdfd-63a2-6c22-a499-91ed7452eb56@measurement-factory.com>
 <CAFqyDwBrys1BJG6Vc967MDmX8f=PvHMUZbpG=WxtxcbY0ukQ0Q@mail.gmail.com>
 <CAFqyDwBM4StMYCJmKDHM3owhUy295o+qxMKQKjRugSj+XOzRJw@mail.gmail.com>
 <433fe77c-544a-df35-258b-85a5ebd7a39e@measurement-factory.com>
 <b110b6f8-8bdb-8744-f96b-2ac23cae9dbd@treenet.co.nz>
 <3a8107bf-d514-be69-e279-65a610a4fe2a@measurement-factory.com>
 <CAFqyDwCAUaoTKaQ+wMCYaP=tqNnkAscVmQiPhLLqHksWi754WQ@mail.gmail.com>
 <a37abc7a-4c5a-6747-fdd7-f3ad2b0b2328@treenet.co.nz>
Message-ID: <CAFqyDwAuGQ2B+u+Crt_uAKC3tCGQ6Y-Fx9v4-OcafdiRPjqxjQ@mail.gmail.com>

Oh.... Guys ! you are wizards.....
Works like I wanted..

One more may be last thing:  - I found the strange behavior  - if I make
changes at my ext ACL script (its python ) and then "squid -k reconfigure"
then I can see that my script appears in the "TOP" of process and loads CPU
to 100%, if to restart the squid at whole "systemctl restart squid" - all
OK again.
If you could to check this at your end - will be great !

Thanks again!

Alexg


??, 23 ???. 2023??. ? 16:36, Amos Jeffries <squid3 at treenet.co.nz>:

> On 23/04/2023 5:27 pm, Alexey?? Gruzdov wrote:
> > Hello Guys!
> > Thank you very much! For now all works like I needed!
> >
> > But I have an one more  questions about how I could to use the kv-pair:
> ...
> > and then ACL with ?note proxy all ?
> > But how the kv-pair must to be looked for this my tag ?
> >
> > I have tried to get answer from my ext script like
> > ?OK?
> > ?proxy=all?
> >
> > But looks like it?s not correct
> >
>
> This part of the instructions were missed:
> https://wiki.squid-cache.org/Features/AddonHelpers#helper-protocols
> "
> For every line sent by Squid exactly one line is expected back. Some
> script language such as perl and python need to be careful about the
> number of newlines in their output.
> "
>
> If your helper received something like this (with concurrency channel-id
> "1"):
>
>   "1 bob 192.0.2.1"
>
> It should produce a line like:
>    "1 OK proxy=all"
>
> If no concurrency channel-id is received, then output is the same but
> without sending channel-id back and MUST be sent in same order as received.
>
> I do recommend using concurrency. It can help further debug issues with
> helpers responding incorrectly.
>
> HTH
> Amos
>
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230423/edfd584a/attachment.htm>

From david at articatech.com  Sun Apr 23 23:33:23 2023
From: david at articatech.com (David Touzeau)
Date: Mon, 24 Apr 2023 01:33:23 +0200
Subject: [squid-users] %LOGIN place in squid 5.8 acls
Message-ID: <3c700c5f-f8ad-d4c5-3e95-900c0df12644@articatech.com>

We have a "problem" with ACLs, and I don't know how to address this 
situation in Squid 5.8
Let me explain:
We have an Active Directory group named limited_users that is only 
allowed to surf on a very limited list of websites.
These users are therefore forbidden to surf on all sites not listed in 
allowed_domains
On the other hand, we have websites in noauth_sites that do not need to 
be authenticated by squid but are not allowed to be used by 
limited_users group

In logic, we would write the following ACLs.

external_acl_type ads_group ttl=3600 negative_ttl=1 concurrency=50 children-startup=1 children-idle=1 children-max=20 ipv4 %LOGIN /lib/squid3/groups.pl

acls limited_users ads_group limited_users
acls allowed_domains dstdomain siteallowed.com
acls allowed_domains dstdomain siteallowed.fr
acls allowed_domains dstdomain siteallowed.ch

acls noauth_sites dstdomain office365.com


http_access deny !allowed_domains limited_users all #ACL1
http_access allow noauth_sites #ACL2


But in this case, accessing to office365.com force Squid to send the 407 
Authentication? request in order to calculate the limited_users in? 
#ACL1, then the second ACL is not effective because the request is 
blocked before by the 407.
The %LOGIN switch in the external ACL ads_group activates the 
identification mode.
If we use the %un switch instead , it works but it becomes the counter, 
ACL#1 is not processed anymore since the authentication is not requested 
because the %un switch is too smooth.

What I don't understand is that SQUID is trying to calculate the 
limited_user object when the first allowed_domain object already returns 
FALSE.
Whatever the result of the objects that follow allowed_domain, the rule 
will always fail.
In the case where limited_user is in the first place, the logic is correct.

Two questions:

Is there a way for SQUID to not compute all http_access objects? if the 
first one fails?

What would be the best rule that could meet this goal?

regards
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230424/df31ccac/attachment.htm>

From squid3 at treenet.co.nz  Mon Apr 24 09:22:48 2023
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Mon, 24 Apr 2023 21:22:48 +1200
Subject: [squid-users] %LOGIN place in squid 5.8 acls
In-Reply-To: <3c700c5f-f8ad-d4c5-3e95-900c0df12644@articatech.com>
References: <3c700c5f-f8ad-d4c5-3e95-900c0df12644@articatech.com>
Message-ID: <87ae91a9-2a54-285c-cfb7-fb6ae88468ae@treenet.co.nz>

On 24/04/2023 11:33 am, David Touzeau wrote:
> We have a "problem" with ACLs, and I don't know how to address this 
> situation in Squid 5.8
> Let me explain:
> We have an Active Directory group named limited_users that is only 
> allowed to surf on a very limited list of websites.
> These users are therefore forbidden to surf on all sites not listed in 
> allowed_domains
> On the other hand, we have websites in noauth_sites that do not need 
> to be authenticated by squid but are not allowed to be used by 
> limited_users group
>
> In logic, we would write the following ACLs.
>
> external_acl_type ads_group ttl=3600 negative_ttl=1 concurrency=50 children-startup=1 children-idle=1 children-max=20 ipv4 %LOGIN /lib/squid3/groups.pl
>
> acls limited_users ads_group limited_users

This acl requires both login to succeed and group to match in order to 
return MATCH.


> acls allowed_domains dstdomain siteallowed.com
> acls allowed_domains dstdomain siteallowed.fr
> acls allowed_domains dstdomain siteallowed.ch
>
> acls noauth_sites dstdomain office365.com
>
>
> http_access deny !allowed_domains limited_users all #ACL1
> http_access allow noauth_sites #ACL2
>
> But in this case, accessing to office365.com force Squid to send the 
> 407 Authentication? request in order to calculate the limited_users 
> in? #ACL1, then the second ACL is not effective because the request is 
> blocked before by the 407.

Sounds correct.

> The %LOGIN switch in the external ACL ads_group activates the 
> identification mode.

Yes.

> If we use the %un switch instead , it works but it becomes the 
> counter, ACL#1 is not processed anymore since the authentication is 
> not requested because the %un switch is too smooth.

Yes. The login is not existing, therefore has no group.


> What I don't understand is that SQUID is trying to calculate the 
> limited_user object when the first allowed_domain object already 
> returns FALSE.

You configured the "!" (not) operator to invert the match result.
Returning FALSE becomes a MATCH.


> Whatever the result of the objects that follow allowed_domain, the 
> rule will always fail.

Not quite. A request that provides credentials associated with the 
expected group will pass.

> In the case where limited_user is in the first place, the logic is 
> correct.
>
> Two questions:
>
> Is there a way for SQUID to not compute all http_access objects if the 
> first one fails?

No. Because there is more than one HTTP request going on here. Each 
request is independent for Squid.


> What would be the best rule that could meet this goal?

Structure your access lines as such;

 ? # things not requiring login are checked first
 ? http_access allow noauth_sites

 ? # then do the login
 ? http_access deny !login

 ? # then check things that need login
 ? http_access deny limited_users !allowed_sites


HTH
Amos



From squid3 at treenet.co.nz  Mon Apr 24 09:50:30 2023
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Mon, 24 Apr 2023 21:50:30 +1200
Subject: [squid-users] Fwd: cache_peer_access by dynamic ACL
In-Reply-To: <CAFqyDwAuGQ2B+u+Crt_uAKC3tCGQ6Y-Fx9v4-OcafdiRPjqxjQ@mail.gmail.com>
References: <CAFqyDwB82whYStQnbLcjX8JUyostgeMgiWQP1o0UxoYs9FKJyQ@mail.gmail.com>
 <CAFqyDwBWrZ_O-yXr0J9Bb4HqWvfq8HR+_4QPVgueQ7Pa=OmeFQ@mail.gmail.com>
 <5a11ceaa-c3f4-4a80-3ac4-9df3c8be3c3e@measurement-factory.com>
 <CAFqyDwBsFU80tc5TsAuG109o9XGuMP7dXZ4rSnvuX4Js6CiHWg@mail.gmail.com>
 <4e3df8c9-52a7-1afd-b3d3-6971cdae75fb@measurement-factory.com>
 <CAFqyDwCKi+CB_M-NgirDraHjUoiF5XUy8GyM-5ivU1rLe5fGGQ@mail.gmail.com>
 <3e08fdfd-63a2-6c22-a499-91ed7452eb56@measurement-factory.com>
 <CAFqyDwBrys1BJG6Vc967MDmX8f=PvHMUZbpG=WxtxcbY0ukQ0Q@mail.gmail.com>
 <CAFqyDwBM4StMYCJmKDHM3owhUy295o+qxMKQKjRugSj+XOzRJw@mail.gmail.com>
 <433fe77c-544a-df35-258b-85a5ebd7a39e@measurement-factory.com>
 <b110b6f8-8bdb-8744-f96b-2ac23cae9dbd@treenet.co.nz>
 <3a8107bf-d514-be69-e279-65a610a4fe2a@measurement-factory.com>
 <CAFqyDwCAUaoTKaQ+wMCYaP=tqNnkAscVmQiPhLLqHksWi754WQ@mail.gmail.com>
 <a37abc7a-4c5a-6747-fdd7-f3ad2b0b2328@treenet.co.nz>
 <CAFqyDwAuGQ2B+u+Crt_uAKC3tCGQ6Y-Fx9v4-OcafdiRPjqxjQ@mail.gmail.com>
Message-ID: <174e4954-4ad3-76ba-5cc5-75c06db27b2c@treenet.co.nz>

On 24/04/2023 6:28 am, Alexey?? Gruzdov wrote:
> Oh.... Guys ! you are wizards.....
> Works like I wanted..
>
> One more may be last thing:? - I found the strange behavior? - if I 
> make changes at my ext ACL script (its python ) and then "squid -k 
> reconfigure"? then I can see that my script appears?in the "TOP" of 
> process and loads CPU to 100%, if to restart the squid at whole 
> "systemctl restart squid" - all OK again.

Your script using 100% CPU is not Squid. Check that that it is actually 
waiting for I/O to arrive, not infinitely looping on read of the socket.


Amos



From david at articatech.com  Mon Apr 24 12:14:35 2023
From: david at articatech.com (David Touzeau)
Date: Mon, 24 Apr 2023 14:14:35 +0200
Subject: [squid-users] %LOGIN place in squid 5.8 acls
In-Reply-To: <87ae91a9-2a54-285c-cfb7-fb6ae88468ae@treenet.co.nz>
References: <3c700c5f-f8ad-d4c5-3e95-900c0df12644@articatech.com>
 <87ae91a9-2a54-285c-cfb7-fb6ae88468ae@treenet.co.nz>
Message-ID: <355cad4a-5362-ee10-7c15-c8b77682d2f8@articatech.com>

Thanks Amos for the mistake, yes my explains was wrong.
Your are right, the first object !allowed_domains matches, so squid 
usually compute the second object. This an expected behavior.

According your suggest my problem was the first rule "http_access allow 
noauth_sites" in first place.
yes, it will allow requests but, requests will be allowed for all other 
rules too.
It make sense, why compute all others rules if the first one is allowed ?

if a add office365.com in noauth_sites object but i did not want 
office365.com for limited_users, the noauth_sites in first place will 
disable all "deny" rules.

I'm wrong ?


On 24/04/2023 11:22, Amos Jeffries wrote:
> On 24/04/2023 11:33 am, David Touzeau wrote:
>> We have a "problem" with ACLs, and I don't know how to address this 
>> situation in Squid 5.8
>> Let me explain:
>> We have an Active Directory group named limited_users that is only 
>> allowed to surf on a very limited list of websites.
>> These users are therefore forbidden to surf on all sites not listed 
>> in allowed_domains
>> On the other hand, we have websites in noauth_sites that do not need 
>> to be authenticated by squid but are not allowed to be used by 
>> limited_users group
>>
>> In logic, we would write the following ACLs.
>>
>> external_acl_type ads_group ttl=3600 negative_ttl=1 concurrency=50 
>> children-startup=1 children-idle=1 children-max=20 ipv4 %LOGIN 
>> /lib/squid3/groups.pl
>>
>> acls limited_users ads_group limited_users
>
> This acl requires both login to succeed and group to match in order to 
> return MATCH.
>
>
>> acls allowed_domains dstdomain siteallowed.com
>> acls allowed_domains dstdomain siteallowed.fr
>> acls allowed_domains dstdomain siteallowed.ch
>>
>> acls noauth_sites dstdomain office365.com
>>
>>
>> http_access deny !allowed_domains limited_users all #ACL1
>> http_access allow noauth_sites #ACL2
>>
>> But in this case, accessing to office365.com force Squid to send the 
>> 407 Authentication? request in order to calculate the limited_users 
>> in? #ACL1, then the second ACL is not effective because the request 
>> is blocked before by the 407.
>
> Sounds correct.
>
>> The %LOGIN switch in the external ACL ads_group activates the 
>> identification mode.
>
> Yes.
>
>> If we use the %un switch instead , it works but it becomes the 
>> counter, ACL#1 is not processed anymore since the authentication is 
>> not requested because the %un switch is too smooth.
>
> Yes. The login is not existing, therefore has no group.
>
>
>> What I don't understand is that SQUID is trying to calculate the 
>> limited_user object when the first allowed_domain object already 
>> returns FALSE.
>
> You configured the "!" (not) operator to invert the match result.
> Returning FALSE becomes a MATCH.
>
>
>> Whatever the result of the objects that follow allowed_domain, the 
>> rule will always fail.
>
> Not quite. A request that provides credentials associated with the 
> expected group will pass.
>
>> In the case where limited_user is in the first place, the logic is 
>> correct.
>>
>> Two questions:
>>
>> Is there a way for SQUID to not compute all http_access objects if 
>> the first one fails?
>
> No. Because there is more than one HTTP request going on here. Each 
> request is independent for Squid.
>
>
>> What would be the best rule that could meet this goal?
>
> Structure your access lines as such;
>
> ? # things not requiring login are checked first
> ? http_access allow noauth_sites
>
> ? # then do the login
> ? http_access deny !login
>
> ? # then check things that need login
> ? http_access deny limited_users !allowed_sites
>
>
> HTH
> Amos
>
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users

-- 
David Touzeau - Artica Tech France
Development team, level 3 support
----------------------------------
P: +33 6 58 44 69 46
www:https://wiki.articatech.com
www:http://articatech.net  
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230424/1ba1bf42/attachment.htm>

From rousskov at measurement-factory.com  Mon Apr 24 14:07:12 2023
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Mon, 24 Apr 2023 10:07:12 -0400
Subject: [squid-users] Fwd: cache_peer_access by dynamic ACL
In-Reply-To: <CAFqyDwAuGQ2B+u+Crt_uAKC3tCGQ6Y-Fx9v4-OcafdiRPjqxjQ@mail.gmail.com>
References: <CAFqyDwB82whYStQnbLcjX8JUyostgeMgiWQP1o0UxoYs9FKJyQ@mail.gmail.com>
 <CAFqyDwBWrZ_O-yXr0J9Bb4HqWvfq8HR+_4QPVgueQ7Pa=OmeFQ@mail.gmail.com>
 <5a11ceaa-c3f4-4a80-3ac4-9df3c8be3c3e@measurement-factory.com>
 <CAFqyDwBsFU80tc5TsAuG109o9XGuMP7dXZ4rSnvuX4Js6CiHWg@mail.gmail.com>
 <4e3df8c9-52a7-1afd-b3d3-6971cdae75fb@measurement-factory.com>
 <CAFqyDwCKi+CB_M-NgirDraHjUoiF5XUy8GyM-5ivU1rLe5fGGQ@mail.gmail.com>
 <3e08fdfd-63a2-6c22-a499-91ed7452eb56@measurement-factory.com>
 <CAFqyDwBrys1BJG6Vc967MDmX8f=PvHMUZbpG=WxtxcbY0ukQ0Q@mail.gmail.com>
 <CAFqyDwBM4StMYCJmKDHM3owhUy295o+qxMKQKjRugSj+XOzRJw@mail.gmail.com>
 <433fe77c-544a-df35-258b-85a5ebd7a39e@measurement-factory.com>
 <b110b6f8-8bdb-8744-f96b-2ac23cae9dbd@treenet.co.nz>
 <3a8107bf-d514-be69-e279-65a610a4fe2a@measurement-factory.com>
 <CAFqyDwCAUaoTKaQ+wMCYaP=tqNnkAscVmQiPhLLqHksWi754WQ@mail.gmail.com>
 <a37abc7a-4c5a-6747-fdd7-f3ad2b0b2328@treenet.co.nz>
 <CAFqyDwAuGQ2B+u+Crt_uAKC3tCGQ6Y-Fx9v4-OcafdiRPjqxjQ@mail.gmail.com>
Message-ID: <4715ad8a-5a6d-163d-e45f-60aeb75163ea@measurement-factory.com>

On 4/23/23 14:28, Alexey?? Gruzdov wrote:

> One more may be last thing:? - I found the strange behavior? - if I make 
> changes at my ext ACL script (its python ) and then "squid -k 
> reconfigure"? then I can see that my script appears?in the "TOP" of 
> process and loads CPU to 100%

Check how your ACL script reacts to stdin closure/EOF. The script should 
quit but probably does not. Same for any stdin reading errors. On EOF, 
the script should use exit code zero. All these things are easy to test 
on the command line (without Squid).

Alex.

> ??, 23 ???. 2023??. ? 16:36, Amos Jeffries <squid3 at treenet.co.nz 
> <mailto:squid3 at treenet.co.nz>>:
> 
>     On 23/04/2023 5:27 pm, Alexey?? Gruzdov wrote:
>      > Hello Guys!
>      > Thank you very much! For now all works like I needed!
>      >
>      > But I have an one more ?questions about how I could to use the
>     kv-pair:
>     ...
>      > and then ACL with ?note proxy all ?
>      > But how the kv-pair must to be looked for this my tag ?
>      >
>      > I have tried to get answer from my ext script like
>      > ?OK?
>      > ?proxy=all?
>      >
>      > But looks like it?s not correct
>      >
> 
>     This part of the instructions were missed:
>     https://wiki.squid-cache.org/Features/AddonHelpers#helper-protocols
>     <https://wiki.squid-cache.org/Features/AddonHelpers#helper-protocols>
>     "
>     For every line sent by Squid exactly one line is expected back. Some
>     script language such as perl and python need to be careful about the
>     number of newlines in their output.
>     "
> 
>     If your helper received something like this (with concurrency
>     channel-id
>     "1"):
> 
>      ??"1 bob 192.0.2.1"
> 
>     It should produce a line like:
>      ?? "1 OK proxy=all"
> 
>     If no concurrency channel-id is received, then output is the same but
>     without sending channel-id back and MUST be sent in same order as
>     received.
> 
>     I do recommend using concurrency. It can help further debug issues with
>     helpers responding incorrectly.
> 
>     HTH
>     Amos
> 
>     _______________________________________________
>     squid-users mailing list
>     squid-users at lists.squid-cache.org
>     <mailto:squid-users at lists.squid-cache.org>
>     http://lists.squid-cache.org/listinfo/squid-users
>     <http://lists.squid-cache.org/listinfo/squid-users>
> 
> 
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users



From wbx at openadk.org  Tue Apr 25 07:07:36 2023
From: wbx at openadk.org (Waldemar Brodkorb)
Date: Tue, 25 Apr 2023 09:07:36 +0200
Subject: [squid-users] logging: TCP connection to x.x.x.x/3128 failed
In-Reply-To: <cef825ed-fca1-550c-5e17-4acf9bd6caf8@measurement-factory.com>
References: <ZCV5SBq85hDNEyzv@waldemar-brodkorb.de>
 <583fc758-1b73-877a-4d67-303c69d7fbf0@measurement-factory.com>
 <ZC6hxX5zyPd5inz8@waldemar-brodkorb.de>
 <77671299-a89e-a5c4-e79e-799ee5f49248@measurement-factory.com>
 <ZDkdDLHlDU0APBp5@waldemar-brodkorb.de>
 <cef825ed-fca1-550c-5e17-4acf9bd6caf8@measurement-factory.com>
Message-ID: <ZEd8OF/avd8+RSpb@waldemar-brodkorb.de>

Hi Alex,
Alex Rousskov wrote,

> On 4/14/23 05:29, Waldemar Brodkorb wrote:
> > > On 4/6/23 06:41, Waldemar Brodkorb wrote:
> > > 
> > > > There is still one assertion which happens sometimes:
> > > > cache.log:2023/04/06 07:24:48 kid1| assertion failed: ../src/base/CbcPointer.h:181: "EX"
> > > > 
> > > > Have you ever seen this in the wild? What does it mean?
> > > 
> > > This low-level assertion (where "EX" is usually spelled as "c") corresponds
> > > to many high-level Squid bugs, most of them fixed. Please see
> > > https://bugs.squid-cache.org/show_bug.cgi?id=5265#c1 for the suggested next
> > > steps.
> 
> > We have a core dump now. Ubuntu 22.04 with Squid 5.8.
> 
> > Do you can see where the bug is?
> 
> On the surface, the stack trace looks like bug #4981 to me. That bug has a
> workaround for v4. I do not know whether that workaround patch still applies
> to v5, but it is worth trying:
> https://bugs.squid-cache.org/show_bug.cgi?id=4981
> 
> Please keep us posted.

The patch is still usable. I applied it, rebuild Squid and now I get
the messages instead of a crash. So for me the workaround works and
should be added to 5.9 :)

best regards
 Waldemar


From ankor2023 at gmail.com  Tue Apr 25 09:45:51 2023
From: ankor2023 at gmail.com (Andrey K)
Date: Tue, 25 Apr 2023 12:45:51 +0300
Subject: [squid-users] Caching uncachable resources
Message-ID: <CADJd0Y2gSOEC7AK86KvmZJ9meCfnZ8k-i61_M0eSwFuKUa1K7A@mail.gmail.com>

Hello,

We are trying to cache some resources, but they respond in the header with
the attributes that prevent caching:

Content-Type: video/MP2T
*Expires: Thu, 01 Jan 1970 00:00:01 GMT*
*Cache-Control: no-cache*
Cache: HIT
X-Cached-Since: 2023-04-25T07:43:41+00:00

Thus, we see TCP_MISS in the logs.
Is it possible to configure squid in such a way that it ignores
*Cache-control=no-cache* and *Expires *attributes and takes responses from
the cache?

Kind regards,
    Ankor.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230425/24988095/attachment.htm>

From rousskov at measurement-factory.com  Tue Apr 25 13:16:46 2023
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Tue, 25 Apr 2023 09:16:46 -0400
Subject: [squid-users] logging: TCP connection to x.x.x.x/3128 failed
In-Reply-To: <ZEd8OF/avd8+RSpb@waldemar-brodkorb.de>
References: <ZCV5SBq85hDNEyzv@waldemar-brodkorb.de>
 <583fc758-1b73-877a-4d67-303c69d7fbf0@measurement-factory.com>
 <ZC6hxX5zyPd5inz8@waldemar-brodkorb.de>
 <77671299-a89e-a5c4-e79e-799ee5f49248@measurement-factory.com>
 <ZDkdDLHlDU0APBp5@waldemar-brodkorb.de>
 <cef825ed-fca1-550c-5e17-4acf9bd6caf8@measurement-factory.com>
 <ZEd8OF/avd8+RSpb@waldemar-brodkorb.de>
Message-ID: <98c7e3d1-3a07-91c5-9754-5fc872b77c10@measurement-factory.com>

On 4/25/23 03:07, Waldemar Brodkorb wrote:
> Alex Rousskov wrote,
>> On 4/14/23 05:29, Waldemar Brodkorb wrote:
>>>> On 4/6/23 06:41, Waldemar Brodkorb wrote:
>>>>
>>>>> There is still one assertion which happens sometimes:
>>>>> cache.log:2023/04/06 07:24:48 kid1| assertion failed: ../src/base/CbcPointer.h:181: "EX"
>>>>>
>>>>> Have you ever seen this in the wild? What does it mean?
>>>>
>>>> This low-level assertion (where "EX" is usually spelled as "c") corresponds
>>>> to many high-level Squid bugs, most of them fixed. Please see
>>>> https://bugs.squid-cache.org/show_bug.cgi?id=5265#c1 for the suggested next
>>>> steps.
>>
>>> We have a core dump now. Ubuntu 22.04 with Squid 5.8.
>>
>>> Do you can see where the bug is?
>>
>> On the surface, the stack trace looks like bug #4981 to me. That bug has a
>> workaround for v4. I do not know whether that workaround patch still applies
>> to v5, but it is worth trying:
>> https://bugs.squid-cache.org/show_bug.cgi?id=4981
>>
>> Please keep us posted.
> 
> The patch is still usable. I applied it, rebuild Squid and now I get
> the messages instead of a crash. So for me the workaround works 

Thank you very much for this information! I have updated the bug report 
accordingly.

Alex.



From squid3 at treenet.co.nz  Tue Apr 25 13:24:10 2023
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Wed, 26 Apr 2023 01:24:10 +1200
Subject: [squid-users] %LOGIN place in squid 5.8 acls
In-Reply-To: <355cad4a-5362-ee10-7c15-c8b77682d2f8@articatech.com>
References: <3c700c5f-f8ad-d4c5-3e95-900c0df12644@articatech.com>
 <87ae91a9-2a54-285c-cfb7-fb6ae88468ae@treenet.co.nz>
 <355cad4a-5362-ee10-7c15-c8b77682d2f8@articatech.com>
Message-ID: <cc274759-0b31-96e2-0208-371fa579e682@treenet.co.nz>

On 25/04/2023 12:14 am, David Touzeau wrote:
> Thanks Amos for the mistake, yes my explains was wrong.
> Your are right, the first object !allowed_domains matches, so squid 
> usually compute the second object. This an expected behavior.
>
> According your suggest my problem was the first rule "http_access 
> allow noauth_sites" in first place.
> yes, it will allow requests but, requests will be allowed for all 
> other rules too.
> It make sense, why compute all others rules if the first one is allowed ?
>
> if a add office365.com in noauth_sites object but i did not want 
> office365.com for limited_users, the noauth_sites in first place will 
> disable all "deny" rules.
>
> I'm wrong ?

I assume the ACL name "noauth_..." means the domains listed there are to 
be accepted without checking the authentication.
In that case you **cannot** check (aka require) authentication before 
allowing them.

To have any authentication-based special handing on a domain requires 
that authentication happens.

So you have the choice for any given domain, whether to always-allow 
(no-auth for everybody) or to require *everyone* login before deciding 
allow/deny.


HTH
Amos


From squid3 at treenet.co.nz  Tue Apr 25 14:52:53 2023
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Wed, 26 Apr 2023 02:52:53 +1200
Subject: [squid-users] Caching uncachable resources
In-Reply-To: <CADJd0Y2gSOEC7AK86KvmZJ9meCfnZ8k-i61_M0eSwFuKUa1K7A@mail.gmail.com>
References: <CADJd0Y2gSOEC7AK86KvmZJ9meCfnZ8k-i61_M0eSwFuKUa1K7A@mail.gmail.com>
Message-ID: <46c20592-46e0-d163-961c-520d4650590c@treenet.co.nz>

On 25/04/2023 9:45 pm, Andrey K wrote:
> Hello,
>
> We are trying to cache some resources, but they respond in the header 
> with the attributes that prevent caching:
>
>     Content-Type: video/MP2T
>     *Expires: Thu, 01 Jan 1970 00:00:01 GMT*
>     *Cache-Control: no-cache*
>     Cache: HIT
>     X-Cached-Since: 2023-04-25T07:43:41+00:00
>
> Thus, we see TCP_MISS in the logs.
> Is it possible to configure squid in such a way that it ignores 
> *Cache-control=no-cache* and *Expires *attributes and takes responses 
> from the cache?
>

This is **not** uncacheable. As shown by "Cache: HIT" there was an 
object found in the cache.

The "Expires" header is overridden by the existence of Cache-Control 
header. So ignore that.

The Cache-Control:no-cache actually means Squid can cache the response, 
but *must* contact the origin server before using a HIT.

For some reason the origin produced a newer version of the object thus 
the log says "MISS".

HTH
Amos


From deennyycsgo at protonmail.com  Tue Apr 25 17:49:30 2023
From: deennyycsgo at protonmail.com (deennyycsgo)
Date: Tue, 25 Apr 2023 17:49:30 +0000
Subject: [squid-users] Cannot get Squid to start with external ACL in config
Message-ID: <a3CsZVe5D4KN40xTI3yLpY1b9r0ZlA8hz_Mcc0cs7Ie_ccoQgWJbasjWmGm4U_8sNxBeszMIG1RRwgCsMwCOPoLVazqyUkqrcJ8GiMQIjpE=@protonmail.com>

Hello, I'm having an issue configuring an external ACL, the error i get is:

Can't use proxy auth because no authentication schemes are fully configured.
FATAL: ERROR: Invalid ACL: acl ext_acl external acl_name

Here is my config: acl SSL_ports port 443 acl Safe_ports port 80 acl Safe_ports port 21 acl Safe_ports port 443 acl Safe_ports port 70 acl Safe_ports port 210 acl Safe_ports port 1025-65535 acl Safe_ports port 280 acl Safe_ports port 488 acl Safe_ports port 591 acl Safe_ports port 777 acl CONNECT method CONNECT external_acl_type acl_name %SRC %LOGIN %DST /etc/squid/ext_acl.py acl ext_acl external acl_name http_access allow ext_acl http_access deny !Safe_ports http_access deny CONNECT !SSL_ports http_access allow localhost manager http_access deny manager http_access allow localhost http_access deny all http_port 3128 coredump_dir /var/spool/squid3 refresh_pattern ^ftp: 1440 20% 10080 refresh_pattern ^gopher: 1440 0% 1440 refresh_pattern -i (/cgi-bin/|\?) 0 0% 0 refresh_pattern . 0 20% 4320

And here is the python script:
#!/usr/bin/python3
import sys
import logging
import time

def grant ():
sys.stdout.write('OK\n')
sys.stdout.flush()

def deny ():
sys.stdout.write('ERR\n')
sys.stdout.flush()

while True:
line = sys.stdin.readline().strip()
if line:
deny()
else:
time.sleep( 1 )

The python script has 777 permissions and is owned by the proxy user.
Running it through the terminal results in expected output and expected behaviour.

I'm running Squid version 4.10 on Ubuntu Server 20.04 Thanks in advance!
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230425/9d2e22e9/attachment.htm>

From rousskov at measurement-factory.com  Tue Apr 25 18:32:36 2023
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Tue, 25 Apr 2023 14:32:36 -0400
Subject: [squid-users] Cannot get Squid to start with external ACL in
 config
In-Reply-To: <a3CsZVe5D4KN40xTI3yLpY1b9r0ZlA8hz_Mcc0cs7Ie_ccoQgWJbasjWmGm4U_8sNxBeszMIG1RRwgCsMwCOPoLVazqyUkqrcJ8GiMQIjpE=@protonmail.com>
References: <a3CsZVe5D4KN40xTI3yLpY1b9r0ZlA8hz_Mcc0cs7Ie_ccoQgWJbasjWmGm4U_8sNxBeszMIG1RRwgCsMwCOPoLVazqyUkqrcJ8GiMQIjpE=@protonmail.com>
Message-ID: <342c74c6-0103-9f84-d891-daf3ab0b2859@measurement-factory.com>

On 4/25/23 13:49, deennyycsgo wrote:
> Hello, I'm having an issue configuring an external ACL, the error i get is:
> 
> Can't use proxy auth because no authentication schemes are fully configured.
> FATAL: ERROR: Invalid ACL: acl ext_acl external acl_name

Unfortunately, Squid requires at least one authentication scheme to be 
explicitly configured in squid.conf _before_ the first %LOGIN use. The 
existing error reporting does not make that fact clear enough IMHO.

To avoid the above two errors:

* either add "auth_param" directive(s) _above_ all external ACL 
declarations that use a %LOGIN format code;

* or remove %LOGIN (which probably will not contain anything useful 
without authentication configured anyway!).


HTH,

Alex.



> Here is my config: acl SSL_ports port 443 acl Safe_ports port 80 acl 
> Safe_ports port 21 acl Safe_ports port 443 acl Safe_ports port 70 acl 
> Safe_ports port 210 acl Safe_ports port 1025-65535 acl Safe_ports port 
> 280 acl Safe_ports port 488 acl Safe_ports port 591 acl Safe_ports port 
> 777 acl CONNECT method CONNECT external_acl_type acl_name %SRC %LOGIN 
> %DST /etc/squid/ext_acl.py acl ext_acl external acl_name http_access 
> allow ext_acl http_access deny !Safe_ports http_access deny CONNECT 
> !SSL_ports http_access allow localhost manager http_access deny manager 
> http_access allow localhost http_access deny all http_port 3128 
> coredump_dir /var/spool/squid3 refresh_pattern ^ftp: ? ? ? ? ? 1440   
>  ?20% ? ? 10080 refresh_pattern ^gopher: ? ? ? ?1440 ? ?0% ? ? ?1440 
> refresh_pattern -i (/cgi-bin/|\?) 0 ? ? 0% ? ? ?0 refresh_pattern .     
>  ? ? ? ? ? 0 ? ? ? 20% ? ? 4320
> 
> And here is the python script:
> #!/usr/bin/python3
> import sys
> import logging
> import time
> 
> def grant ():
>  ? ? ? sys.stdout.write('OK\n')
>  ? ? ? sys.stdout.flush()
> 
> def deny ():
>  ?? ? ?sys.stdout.write('ERR\n')
>  ? ? ? sys.stdout.flush()
> 
> while True:
>  ? ? ? line = sys.stdin.readline().strip()
>  ? ? ? if line:
>  ? ? ? ? ? ? ? deny()
>  ? ? ? else:
>  ? ? ? ? ? ? ? time.sleep( 1 )
> 
> The python script has 777 permissions and is owned by the proxy user.
> Running it through the terminal results in expected output and expected 
> behaviour.
> 
> I'm running Squid version 4.10 on Ubuntu Server 20.04 Thanks in advance!
> 
> 
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users



From ankor2023 at gmail.com  Wed Apr 26 11:00:30 2023
From: ankor2023 at gmail.com (Andrey K)
Date: Wed, 26 Apr 2023 14:00:30 +0300
Subject: [squid-users] Caching uncachable resources
In-Reply-To: <46c20592-46e0-d163-961c-520d4650590c@treenet.co.nz>
References: <CADJd0Y2gSOEC7AK86KvmZJ9meCfnZ8k-i61_M0eSwFuKUa1K7A@mail.gmail.com>
 <46c20592-46e0-d163-961c-520d4650590c@treenet.co.nz>
Message-ID: <CADJd0Y11+=+bHZ9Fmr-Bp6hdZvKFuSCMmSEgaweXX-rTW4eCGg@mail.gmail.com>

Hello, Amos,

Thank you for the information.
The headers I included in the previous message were taken from the
"outside" proxy interface, i.e. were sent by the original content server (I
think it is a CDN):
>
>     Content-Type: video/MP2T
>     *Expires: Thu, 01 Jan 1970 00:00:01 GMT*
>     *Cache-Control: no-cache*
>     Cache: HIT
>     X-Cached-Since: 2023-04-25T07:43:41+00:00
>

On the client side I see:
< HTTP/1.1 200 OK
< Server: nginx
< Date: Wed, 26 Apr 2023 10:37:29 GMT
< Content-Type: video/MP2T
< Content-Length: 1955200
< Expires: Thu, 01 Jan 1970 00:00:01 GMT
< Cache-Control: no-cache
< Access-Control-Allow-Origin: *
< access-control-allow-headers: x-vsaas-session, x-no-redirect, origin,
authorization, accept, range, x-device-screen,x-locale,x-timezone
< access-control-expose-headers: Server, range, X-Run-Time, Content-Length,
Location, x-id, x-shard, x-vhost-ver, cache
< Cache: HIT
< X-Cached-Since: 2023-04-25T07:43:43+00:00
< X-ID: m9p-up-gc39
< Accept-Ranges: bytes
< X-Cache: MISS from 0001vsg02
< X-Cache-Lookup: MISS from 0001vsg02:3131
< Connection: keep-alive

I would rephrase my question: is it possible to configure squid so that it
caches files with the extension ".ts" despite the caching control headers
passed by OCS and serves user requests from the cache?

Kind regards,
     Ankor.


??, 25 ???. 2023??. ? 17:53, Amos Jeffries <squid3 at treenet.co.nz>:

> On 25/04/2023 9:45 pm, Andrey K wrote:
> > Hello,
> >
> > We are trying to cache some resources, but they respond in the header
> > with the attributes that prevent caching:
> >
> >     Content-Type: video/MP2T
> >     *Expires: Thu, 01 Jan 1970 00:00:01 GMT*
> >     *Cache-Control: no-cache*
> >     Cache: HIT
> >     X-Cached-Since: 2023-04-25T07:43:41+00:00
> >
> > Thus, we see TCP_MISS in the logs.
> > Is it possible to configure squid in such a way that it ignores
> > *Cache-control=no-cache* and *Expires *attributes and takes responses
> > from the cache?
> >
>
> This is **not** uncacheable. As shown by "Cache: HIT" there was an
> object found in the cache.
>
> The "Expires" header is overridden by the existence of Cache-Control
> header. So ignore that.
>
> The Cache-Control:no-cache actually means Squid can cache the response,
> but *must* contact the origin server before using a HIT.
>
> For some reason the origin produced a newer version of the object thus
> the log says "MISS".
>
> HTH
> Amos
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230426/9794c77a/attachment.htm>

From my.shellac at gmail.com  Wed Apr 26 11:40:56 2023
From: my.shellac at gmail.com (=?UTF-8?B?QWxleGV50Y/RgCBHcnV6ZG92?=)
Date: Wed, 26 Apr 2023 15:40:56 +0400
Subject: [squid-users] Fwd: cache_peer_access by dynamic ACL
In-Reply-To: <4715ad8a-5a6d-163d-e45f-60aeb75163ea@measurement-factory.com>
References: <CAFqyDwB82whYStQnbLcjX8JUyostgeMgiWQP1o0UxoYs9FKJyQ@mail.gmail.com>
 <CAFqyDwBWrZ_O-yXr0J9Bb4HqWvfq8HR+_4QPVgueQ7Pa=OmeFQ@mail.gmail.com>
 <5a11ceaa-c3f4-4a80-3ac4-9df3c8be3c3e@measurement-factory.com>
 <CAFqyDwBsFU80tc5TsAuG109o9XGuMP7dXZ4rSnvuX4Js6CiHWg@mail.gmail.com>
 <4e3df8c9-52a7-1afd-b3d3-6971cdae75fb@measurement-factory.com>
 <CAFqyDwCKi+CB_M-NgirDraHjUoiF5XUy8GyM-5ivU1rLe5fGGQ@mail.gmail.com>
 <3e08fdfd-63a2-6c22-a499-91ed7452eb56@measurement-factory.com>
 <CAFqyDwBrys1BJG6Vc967MDmX8f=PvHMUZbpG=WxtxcbY0ukQ0Q@mail.gmail.com>
 <CAFqyDwBM4StMYCJmKDHM3owhUy295o+qxMKQKjRugSj+XOzRJw@mail.gmail.com>
 <433fe77c-544a-df35-258b-85a5ebd7a39e@measurement-factory.com>
 <b110b6f8-8bdb-8744-f96b-2ac23cae9dbd@treenet.co.nz>
 <3a8107bf-d514-be69-e279-65a610a4fe2a@measurement-factory.com>
 <CAFqyDwCAUaoTKaQ+wMCYaP=tqNnkAscVmQiPhLLqHksWi754WQ@mail.gmail.com>
 <a37abc7a-4c5a-6747-fdd7-f3ad2b0b2328@treenet.co.nz>
 <CAFqyDwAuGQ2B+u+Crt_uAKC3tCGQ6Y-Fx9v4-OcafdiRPjqxjQ@mail.gmail.com>
 <4715ad8a-5a6d-163d-e45f-60aeb75163ea@measurement-factory.com>
Message-ID: <CAFqyDwBHgHB5Hij1NEd2bksvifbpT5VJNEvLwiJBJRJjWupo1Q@mail.gmail.com>

Hello!
Yes!
Thank you!


One more question pls:

For example I have five of cache_peers and ACL associated  with some cache
peer.
As you know - I used the my external ACL script and now I can put the
policy to answer fo my script and squid will get an answer and used the
correct ACL for username.
For example answer is  "OK  proxy=peer1"  and user will be used the
cache_peer1, or if "OK proxy=all" and user will go over all of cache_peers
by round-robin.
All works well.
But how I can put something like a list of ACL for user ?  for example  I
want that some one user can go over peer1 and peer3 only, by round robin,
but will be denied over peer2. peer4, peer5. Of course better using
external ACL (as DB ). What do you think?






??, 24 ???. 2023??. ? 18:07, Alex Rousskov <rousskov at measurement-factory.com
>:

> On 4/23/23 14:28, Alexey?? Gruzdov wrote:
>
> > One more may be last thing:  - I found the strange behavior  - if I make
> > changes at my ext ACL script (its python ) and then "squid -k
> > reconfigure"  then I can see that my script appears in the "TOP" of
> > process and loads CPU to 100%
>
> Check how your ACL script reacts to stdin closure/EOF. The script should
> quit but probably does not. Same for any stdin reading errors. On EOF,
> the script should use exit code zero. All these things are easy to test
> on the command line (without Squid).
>
> Alex.
>
> > ??, 23 ???. 2023??. ? 16:36, Amos Jeffries <squid3 at treenet.co.nz
> > <mailto:squid3 at treenet.co.nz>>:
> >
> >     On 23/04/2023 5:27 pm, Alexey?? Gruzdov wrote:
> >      > Hello Guys!
> >      > Thank you very much! For now all works like I needed!
> >      >
> >      > But I have an one more  questions about how I could to use the
> >     kv-pair:
> >     ...
> >      > and then ACL with ?note proxy all ?
> >      > But how the kv-pair must to be looked for this my tag ?
> >      >
> >      > I have tried to get answer from my ext script like
> >      > ?OK?
> >      > ?proxy=all?
> >      >
> >      > But looks like it?s not correct
> >      >
> >
> >     This part of the instructions were missed:
> >     https://wiki.squid-cache.org/Features/AddonHelpers#helper-protocols
> >     <https://wiki.squid-cache.org/Features/AddonHelpers#helper-protocols
> >
> >     "
> >     For every line sent by Squid exactly one line is expected back. Some
> >     script language such as perl and python need to be careful about the
> >     number of newlines in their output.
> >     "
> >
> >     If your helper received something like this (with concurrency
> >     channel-id
> >     "1"):
> >
> >        "1 bob 192.0.2.1"
> >
> >     It should produce a line like:
> >         "1 OK proxy=all"
> >
> >     If no concurrency channel-id is received, then output is the same but
> >     without sending channel-id back and MUST be sent in same order as
> >     received.
> >
> >     I do recommend using concurrency. It can help further debug issues
> with
> >     helpers responding incorrectly.
> >
> >     HTH
> >     Amos
> >
> >     _______________________________________________
> >     squid-users mailing list
> >     squid-users at lists.squid-cache.org
> >     <mailto:squid-users at lists.squid-cache.org>
> >     http://lists.squid-cache.org/listinfo/squid-users
> >     <http://lists.squid-cache.org/listinfo/squid-users>
> >
> >
> > _______________________________________________
> > squid-users mailing list
> > squid-users at lists.squid-cache.org
> > http://lists.squid-cache.org/listinfo/squid-users
>
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230426/6e564ffa/attachment.htm>

From my.shellac at gmail.com  Wed Apr 26 12:08:26 2023
From: my.shellac at gmail.com (=?UTF-8?B?QWxleGV50Y/RgCBHcnV6ZG92?=)
Date: Wed, 26 Apr 2023 16:08:26 +0400
Subject: [squid-users] Fwd: cache_peer_access by dynamic ACL
In-Reply-To: <CAFqyDwBHgHB5Hij1NEd2bksvifbpT5VJNEvLwiJBJRJjWupo1Q@mail.gmail.com>
References: <CAFqyDwB82whYStQnbLcjX8JUyostgeMgiWQP1o0UxoYs9FKJyQ@mail.gmail.com>
 <CAFqyDwBWrZ_O-yXr0J9Bb4HqWvfq8HR+_4QPVgueQ7Pa=OmeFQ@mail.gmail.com>
 <5a11ceaa-c3f4-4a80-3ac4-9df3c8be3c3e@measurement-factory.com>
 <CAFqyDwBsFU80tc5TsAuG109o9XGuMP7dXZ4rSnvuX4Js6CiHWg@mail.gmail.com>
 <4e3df8c9-52a7-1afd-b3d3-6971cdae75fb@measurement-factory.com>
 <CAFqyDwCKi+CB_M-NgirDraHjUoiF5XUy8GyM-5ivU1rLe5fGGQ@mail.gmail.com>
 <3e08fdfd-63a2-6c22-a499-91ed7452eb56@measurement-factory.com>
 <CAFqyDwBrys1BJG6Vc967MDmX8f=PvHMUZbpG=WxtxcbY0ukQ0Q@mail.gmail.com>
 <CAFqyDwBM4StMYCJmKDHM3owhUy295o+qxMKQKjRugSj+XOzRJw@mail.gmail.com>
 <433fe77c-544a-df35-258b-85a5ebd7a39e@measurement-factory.com>
 <b110b6f8-8bdb-8744-f96b-2ac23cae9dbd@treenet.co.nz>
 <3a8107bf-d514-be69-e279-65a610a4fe2a@measurement-factory.com>
 <CAFqyDwCAUaoTKaQ+wMCYaP=tqNnkAscVmQiPhLLqHksWi754WQ@mail.gmail.com>
 <a37abc7a-4c5a-6747-fdd7-f3ad2b0b2328@treenet.co.nz>
 <CAFqyDwAuGQ2B+u+Crt_uAKC3tCGQ6Y-Fx9v4-OcafdiRPjqxjQ@mail.gmail.com>
 <4715ad8a-5a6d-163d-e45f-60aeb75163ea@measurement-factory.com>
 <CAFqyDwBHgHB5Hij1NEd2bksvifbpT5VJNEvLwiJBJRJjWupo1Q@mail.gmail.com>
Message-ID: <CAFqyDwCrxx9mmZN12VxP5C7+CQb4ckE2LRBhw=bhKbM+8vdscw@mail.gmail.com>

Oh... Looks like I just need to send as answer the list of my policy acl,
for example

user1 wanted to go over peer1 and peer3
the answer from external script must be like  "OK proxy=peer1 proxy=peer3"
and looks like it works well like I need. User will go over peer1 and peer3
only by round-robin.

??, 26 ???. 2023??. ? 15:40, Alexey?? Gruzdov <my.shellac at gmail.com>:

> Hello!
> Yes!
> Thank you!
>
>
> One more question pls:
>
> For example I have five of cache_peers and ACL associated  with some cache
> peer.
> As you know - I used the my external ACL script and now I can put the
> policy to answer fo my script and squid will get an answer and used the
> correct ACL for username.
> For example answer is  "OK  proxy=peer1"  and user will be used the
> cache_peer1, or if "OK proxy=all" and user will go over all of cache_peers
> by round-robin.
> All works well.
> But how I can put something like a list of ACL for user ?  for example  I
> want that some one user can go over peer1 and peer3 only, by round robin,
> but will be denied over peer2. peer4, peer5. Of course better using
> external ACL (as DB ). What do you think?
>
>
>
>
>
>
> ??, 24 ???. 2023??. ? 18:07, Alex Rousskov <
> rousskov at measurement-factory.com>:
>
>> On 4/23/23 14:28, Alexey?? Gruzdov wrote:
>>
>> > One more may be last thing:  - I found the strange behavior  - if I
>> make
>> > changes at my ext ACL script (its python ) and then "squid -k
>> > reconfigure"  then I can see that my script appears in the "TOP" of
>> > process and loads CPU to 100%
>>
>> Check how your ACL script reacts to stdin closure/EOF. The script should
>> quit but probably does not. Same for any stdin reading errors. On EOF,
>> the script should use exit code zero. All these things are easy to test
>> on the command line (without Squid).
>>
>> Alex.
>>
>> > ??, 23 ???. 2023??. ? 16:36, Amos Jeffries <squid3 at treenet.co.nz
>> > <mailto:squid3 at treenet.co.nz>>:
>> >
>> >     On 23/04/2023 5:27 pm, Alexey?? Gruzdov wrote:
>> >      > Hello Guys!
>> >      > Thank you very much! For now all works like I needed!
>> >      >
>> >      > But I have an one more  questions about how I could to use the
>> >     kv-pair:
>> >     ...
>> >      > and then ACL with ?note proxy all ?
>> >      > But how the kv-pair must to be looked for this my tag ?
>> >      >
>> >      > I have tried to get answer from my ext script like
>> >      > ?OK?
>> >      > ?proxy=all?
>> >      >
>> >      > But looks like it?s not correct
>> >      >
>> >
>> >     This part of the instructions were missed:
>> >     https://wiki.squid-cache.org/Features/AddonHelpers#helper-protocols
>> >     <
>> https://wiki.squid-cache.org/Features/AddonHelpers#helper-protocols>
>> >     "
>> >     For every line sent by Squid exactly one line is expected back. Some
>> >     script language such as perl and python need to be careful about the
>> >     number of newlines in their output.
>> >     "
>> >
>> >     If your helper received something like this (with concurrency
>> >     channel-id
>> >     "1"):
>> >
>> >        "1 bob 192.0.2.1"
>> >
>> >     It should produce a line like:
>> >         "1 OK proxy=all"
>> >
>> >     If no concurrency channel-id is received, then output is the same
>> but
>> >     without sending channel-id back and MUST be sent in same order as
>> >     received.
>> >
>> >     I do recommend using concurrency. It can help further debug issues
>> with
>> >     helpers responding incorrectly.
>> >
>> >     HTH
>> >     Amos
>> >
>> >     _______________________________________________
>> >     squid-users mailing list
>> >     squid-users at lists.squid-cache.org
>> >     <mailto:squid-users at lists.squid-cache.org>
>> >     http://lists.squid-cache.org/listinfo/squid-users
>> >     <http://lists.squid-cache.org/listinfo/squid-users>
>> >
>> >
>> > _______________________________________________
>> > squid-users mailing list
>> > squid-users at lists.squid-cache.org
>> > http://lists.squid-cache.org/listinfo/squid-users
>>
>> _______________________________________________
>> squid-users mailing list
>> squid-users at lists.squid-cache.org
>> http://lists.squid-cache.org/listinfo/squid-users
>>
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230426/eaba13e5/attachment.htm>

From rousskov at measurement-factory.com  Wed Apr 26 13:34:38 2023
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Wed, 26 Apr 2023 09:34:38 -0400
Subject: [squid-users] Fwd: cache_peer_access by dynamic ACL
In-Reply-To: <CAFqyDwCrxx9mmZN12VxP5C7+CQb4ckE2LRBhw=bhKbM+8vdscw@mail.gmail.com>
References: <CAFqyDwB82whYStQnbLcjX8JUyostgeMgiWQP1o0UxoYs9FKJyQ@mail.gmail.com>
 <4e3df8c9-52a7-1afd-b3d3-6971cdae75fb@measurement-factory.com>
 <CAFqyDwCKi+CB_M-NgirDraHjUoiF5XUy8GyM-5ivU1rLe5fGGQ@mail.gmail.com>
 <3e08fdfd-63a2-6c22-a499-91ed7452eb56@measurement-factory.com>
 <CAFqyDwBrys1BJG6Vc967MDmX8f=PvHMUZbpG=WxtxcbY0ukQ0Q@mail.gmail.com>
 <CAFqyDwBM4StMYCJmKDHM3owhUy295o+qxMKQKjRugSj+XOzRJw@mail.gmail.com>
 <433fe77c-544a-df35-258b-85a5ebd7a39e@measurement-factory.com>
 <b110b6f8-8bdb-8744-f96b-2ac23cae9dbd@treenet.co.nz>
 <3a8107bf-d514-be69-e279-65a610a4fe2a@measurement-factory.com>
 <CAFqyDwCAUaoTKaQ+wMCYaP=tqNnkAscVmQiPhLLqHksWi754WQ@mail.gmail.com>
 <a37abc7a-4c5a-6747-fdd7-f3ad2b0b2328@treenet.co.nz>
 <CAFqyDwAuGQ2B+u+Crt_uAKC3tCGQ6Y-Fx9v4-OcafdiRPjqxjQ@mail.gmail.com>
 <4715ad8a-5a6d-163d-e45f-60aeb75163ea@measurement-factory.com>
 <CAFqyDwBHgHB5Hij1NEd2bksvifbpT5VJNEvLwiJBJRJjWupo1Q@mail.gmail.com>
 <CAFqyDwCrxx9mmZN12VxP5C7+CQb4ckE2LRBhw=bhKbM+8vdscw@mail.gmail.com>
Message-ID: <18c31520-336c-951d-d93c-48ac2ca7e7d4@measurement-factory.com>

On 4/26/23 08:08, Alexey?? Gruzdov wrote:
> Oh... Looks like I just need to send as answer the list of my policy 
> acl, for example
> 
> user1 wanted to go over peer1 and peer3
> the answer from external script must be like? "OK proxy=peer1 
> proxy=peer3"? and looks like it works well like I need. User will go 
> over peer1 and peer3 only by round-robin.

Instead of sending N same-name annotations to Squid, please try sending 
one annotation with a coma-separated list of N values:

     proxy=peer1,peer3,peer4

Rationale: Even if your current N-annotation setup "works", it is 
essentially relying on undefined and/or questionable behavior that may 
change. Using N-value annotations, you are avoiding that problem.

The "note" ACL has -m option that tells Squid to interpret the 
annotation value as a list:

     acl cleared_for_peer1 note -m proxy peer1
     acl cleared_for_peer2 note -m proxy peer2
     ...


And, again, avoid using "proxy" as the annotation name: That name is 
currently reserved for Squid own use. Use "proxy_" or any other name 
ending with an underscore character. IMO, we should change the 
policy/code to be more admin-friendly, but that change may not happen 
for a long time, and modern Squids will warn you about reserved names 
like "proxy": 
https://github.com/squid-cache/squid/commit/27c36771bf145c2f8ca1efab6743b9e087867ab5


HTH,

Alex.


> ??, 26 ???. 2023??. ? 15:40, Alexey?? Gruzdov:
> 
>     Hello!
>     Yes!
>     Thank you!
> 
> 
>     One more question pls:
> 
>     For example I have five of cache_peers and ACL associated? with some
>     cache peer.
>     As you know - I used the my external ACL script and now I can put
>     the policy to answer fo my script and squid will get an answer and
>     used the correct ACL for username.
>     For example answer is? "OK? proxy=peer1"? and user will be used the
>     cache_peer1, or if "OK proxy=all" and user will go over all of
>     cache_peers by round-robin.
>     All works well.
>     But how I can put something?like a list of ACL for user ?? for
>     example? I want that some?one user can?go over peer1 and peer3 only,
>     by round robin, but will be denied?over peer2. peer4, peer5. Of
>     course better?using external ACL (as DB ). What?do you think?
> 
> 
> 
> 
> 
> 
>     ??, 24 ???. 2023??. ? 18:07, Alex Rousskov
>     <rousskov at measurement-factory.com
>     <mailto:rousskov at measurement-factory.com>>:
> 
>         On 4/23/23 14:28, Alexey?? Gruzdov wrote:
> 
>          > One more may be last thing:? - I found the strange behavior 
>         - if I make
>          > changes at my ext ACL script (its python ) and then "squid -k
>          > reconfigure"? then I can see that my script appears?in the
>         "TOP" of
>          > process and loads CPU to 100%
> 
>         Check how your ACL script reacts to stdin closure/EOF. The
>         script should
>         quit but probably does not. Same for any stdin reading errors.
>         On EOF,
>         the script should use exit code zero. All these things are easy
>         to test
>         on the command line (without Squid).
> 
>         Alex.
> 
>          > ??, 23 ???. 2023??. ? 16:36, Amos Jeffries
>         <squid3 at treenet.co.nz <mailto:squid3 at treenet.co.nz>
>          > <mailto:squid3 at treenet.co.nz <mailto:squid3 at treenet.co.nz>>>:
>          >
>          >? ? ?On 23/04/2023 5:27 pm, Alexey?? Gruzdov wrote:
>          >? ? ? > Hello Guys!
>          >? ? ? > Thank you very much! For now all works like I needed!
>          >? ? ? >
>          >? ? ? > But I have an one more ?questions about how I could to
>         use the
>          >? ? ?kv-pair:
>          >? ? ?...
>          >? ? ? > and then ACL with ?note proxy all ?
>          >? ? ? > But how the kv-pair must to be looked for this my tag ?
>          >? ? ? >
>          >? ? ? > I have tried to get answer from my ext script like
>          >? ? ? > ?OK?
>          >? ? ? > ?proxy=all?
>          >? ? ? >
>          >? ? ? > But looks like it?s not correct
>          >? ? ? >
>          >
>          >? ? ?This part of the instructions were missed:
>          >
>         https://wiki.squid-cache.org/Features/AddonHelpers#helper-protocols <https://wiki.squid-cache.org/Features/AddonHelpers#helper-protocols>
>          >   
>          ?<https://wiki.squid-cache.org/Features/AddonHelpers#helper-protocols <https://wiki.squid-cache.org/Features/AddonHelpers#helper-protocols>>
>          >? ? ?"
>          >? ? ?For every line sent by Squid exactly one line is expected
>         back. Some
>          >? ? ?script language such as perl and python need to be
>         careful about the
>          >? ? ?number of newlines in their output.
>          >? ? ?"
>          >
>          >? ? ?If your helper received something like this (with concurrency
>          >? ? ?channel-id
>          >? ? ?"1"):
>          >
>          >? ? ? ??"1 bob 192.0.2.1"
>          >
>          >? ? ?It should produce a line like:
>          >? ? ? ?? "1 OK proxy=all"
>          >
>          >? ? ?If no concurrency channel-id is received, then output is
>         the same but
>          >? ? ?without sending channel-id back and MUST be sent in same
>         order as
>          >? ? ?received.
>          >
>          >? ? ?I do recommend using concurrency. It can help further
>         debug issues with
>          >? ? ?helpers responding incorrectly.
>          >
>          >? ? ?HTH
>          >? ? ?Amos
>          >
>          >? ? ?_______________________________________________
>          >? ? ?squid-users mailing list
>          > squid-users at lists.squid-cache.org
>         <mailto:squid-users at lists.squid-cache.org>
>          >? ? ?<mailto:squid-users at lists.squid-cache.org
>         <mailto:squid-users at lists.squid-cache.org>>
>          > http://lists.squid-cache.org/listinfo/squid-users
>         <http://lists.squid-cache.org/listinfo/squid-users>
>          >? ? ?<http://lists.squid-cache.org/listinfo/squid-users
>         <http://lists.squid-cache.org/listinfo/squid-users>>
>          >
>          >
>          > _______________________________________________
>          > squid-users mailing list
>          > squid-users at lists.squid-cache.org
>         <mailto:squid-users at lists.squid-cache.org>
>          > http://lists.squid-cache.org/listinfo/squid-users
>         <http://lists.squid-cache.org/listinfo/squid-users>
> 
>         _______________________________________________
>         squid-users mailing list
>         squid-users at lists.squid-cache.org
>         <mailto:squid-users at lists.squid-cache.org>
>         http://lists.squid-cache.org/listinfo/squid-users
>         <http://lists.squid-cache.org/listinfo/squid-users>
> 
> 
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users



From my.shellac at gmail.com  Wed Apr 26 14:33:52 2023
From: my.shellac at gmail.com (=?UTF-8?B?QWxleGV50Y/RgCBHcnV6ZG92?=)
Date: Wed, 26 Apr 2023 19:33:52 +0500
Subject: [squid-users] Fwd: cache_peer_access by dynamic ACL
In-Reply-To: <18c31520-336c-951d-d93c-48ac2ca7e7d4@measurement-factory.com>
References: <CAFqyDwB82whYStQnbLcjX8JUyostgeMgiWQP1o0UxoYs9FKJyQ@mail.gmail.com>
 <4e3df8c9-52a7-1afd-b3d3-6971cdae75fb@measurement-factory.com>
 <CAFqyDwCKi+CB_M-NgirDraHjUoiF5XUy8GyM-5ivU1rLe5fGGQ@mail.gmail.com>
 <3e08fdfd-63a2-6c22-a499-91ed7452eb56@measurement-factory.com>
 <CAFqyDwBrys1BJG6Vc967MDmX8f=PvHMUZbpG=WxtxcbY0ukQ0Q@mail.gmail.com>
 <CAFqyDwBM4StMYCJmKDHM3owhUy295o+qxMKQKjRugSj+XOzRJw@mail.gmail.com>
 <433fe77c-544a-df35-258b-85a5ebd7a39e@measurement-factory.com>
 <b110b6f8-8bdb-8744-f96b-2ac23cae9dbd@treenet.co.nz>
 <3a8107bf-d514-be69-e279-65a610a4fe2a@measurement-factory.com>
 <CAFqyDwCAUaoTKaQ+wMCYaP=tqNnkAscVmQiPhLLqHksWi754WQ@mail.gmail.com>
 <a37abc7a-4c5a-6747-fdd7-f3ad2b0b2328@treenet.co.nz>
 <CAFqyDwAuGQ2B+u+Crt_uAKC3tCGQ6Y-Fx9v4-OcafdiRPjqxjQ@mail.gmail.com>
 <4715ad8a-5a6d-163d-e45f-60aeb75163ea@measurement-factory.com>
 <CAFqyDwBHgHB5Hij1NEd2bksvifbpT5VJNEvLwiJBJRJjWupo1Q@mail.gmail.com>
 <CAFqyDwCrxx9mmZN12VxP5C7+CQb4ckE2LRBhw=bhKbM+8vdscw@mail.gmail.com>
 <18c31520-336c-951d-d93c-48ac2ca7e7d4@measurement-factory.com>
Message-ID: <CAFqyDwDM7CySoVkcyGscuaCsG52cJ0hjPSZr3H7C7OM0=Th4og@mail.gmail.com>

Thank you very much for you answer and explanation

Yep, I don?t use name ?proxy? for annotations, it was just for example only
.

Bets regards!
Alexg



On Wed, 26 Apr 2023 at 18:34, Alex Rousskov <
rousskov at measurement-factory.com> wrote:

> On 4/26/23 08:08, Alexey?? Gruzdov wrote:
> > Oh... Looks like I just need to send as answer the list of my policy
> > acl, for example
> >
> > user1 wanted to go over peer1 and peer3
> > the answer from external script must be like  "OK proxy=peer1
> > proxy=peer3"  and looks like it works well like I need. User will go
> > over peer1 and peer3 only by round-robin.
>
> Instead of sending N same-name annotations to Squid, please try sending
> one annotation with a coma-separated list of N values:
>
>      proxy=peer1,peer3,peer4
>
> Rationale: Even if your current N-annotation setup "works", it is
> essentially relying on undefined and/or questionable behavior that may
> change. Using N-value annotations, you are avoiding that problem.
>
> The "note" ACL has -m option that tells Squid to interpret the
> annotation value as a list:
>
>      acl cleared_for_peer1 note -m proxy peer1
>      acl cleared_for_peer2 note -m proxy peer2
>      ...
>
>
> And, again, avoid using "proxy" as the annotation name: That name is
> currently reserved for Squid own use. Use "proxy_" or any other name
> ending with an underscore character. IMO, we should change the
> policy/code to be more admin-friendly, but that change may not happen
> for a long time, and modern Squids will warn you about reserved names
> like "proxy":
>
> https://github.com/squid-cache/squid/commit/27c36771bf145c2f8ca1efab6743b9e087867ab5
>
>
> HTH,
>
> Alex.
>
>
> > ??, 26 ???. 2023??. ? 15:40, Alexey?? Gruzdov:
> >
> >     Hello!
> >     Yes!
> >     Thank you!
> >
> >
> >     One more question pls:
> >
> >     For example I have five of cache_peers and ACL associated  with some
> >     cache peer.
> >     As you know - I used the my external ACL script and now I can put
> >     the policy to answer fo my script and squid will get an answer and
> >     used the correct ACL for username.
> >     For example answer is  "OK  proxy=peer1"  and user will be used the
> >     cache_peer1, or if "OK proxy=all" and user will go over all of
> >     cache_peers by round-robin.
> >     All works well.
> >     But how I can put something like a list of ACL for user ?  for
> >     example  I want that some one user can go over peer1 and peer3 only,
> >     by round robin, but will be denied over peer2. peer4, peer5. Of
> >     course better using external ACL (as DB ). What do you think?
> >
> >
> >
> >
> >
> >
> >     ??, 24 ???. 2023??. ? 18:07, Alex Rousskov
> >     <rousskov at measurement-factory.com
> >     <mailto:rousskov at measurement-factory.com>>:
> >
> >         On 4/23/23 14:28, Alexey?? Gruzdov wrote:
> >
> >          > One more may be last thing:  - I found the strange behavior
> >         - if I make
> >          > changes at my ext ACL script (its python ) and then "squid -k
> >          > reconfigure"  then I can see that my script appears in the
> >         "TOP" of
> >          > process and loads CPU to 100%
> >
> >         Check how your ACL script reacts to stdin closure/EOF. The
> >         script should
> >         quit but probably does not. Same for any stdin reading errors.
> >         On EOF,
> >         the script should use exit code zero. All these things are easy
> >         to test
> >         on the command line (without Squid).
> >
> >         Alex.
> >
> >          > ??, 23 ???. 2023??. ? 16:36, Amos Jeffries
> >         <squid3 at treenet.co.nz <mailto:squid3 at treenet.co.nz>
> >          > <mailto:squid3 at treenet.co.nz <mailto:squid3 at treenet.co.nz>>>:
> >          >
> >          >     On 23/04/2023 5:27 pm, Alexey?? Gruzdov wrote:
> >          >      > Hello Guys!
> >          >      > Thank you very much! For now all works like I needed!
> >          >      >
> >          >      > But I have an one more  questions about how I could to
> >         use the
> >          >     kv-pair:
> >          >     ...
> >          >      > and then ACL with ?note proxy all ?
> >          >      > But how the kv-pair must to be looked for this my tag ?
> >          >      >
> >          >      > I have tried to get answer from my ext script like
> >          >      > ?OK?
> >          >      > ?proxy=all?
> >          >      >
> >          >      > But looks like it?s not correct
> >          >      >
> >          >
> >          >     This part of the instructions were missed:
> >          >
> >
> https://wiki.squid-cache.org/Features/AddonHelpers#helper-protocols <
> https://wiki.squid-cache.org/Features/AddonHelpers#helper-protocols>
> >          >
> >           <
> https://wiki.squid-cache.org/Features/AddonHelpers#helper-protocols <
> https://wiki.squid-cache.org/Features/AddonHelpers#helper-protocols>>
> >          >     "
> >          >     For every line sent by Squid exactly one line is expected
> >         back. Some
> >          >     script language such as perl and python need to be
> >         careful about the
> >          >     number of newlines in their output.
> >          >     "
> >          >
> >          >     If your helper received something like this (with
> concurrency
> >          >     channel-id
> >          >     "1"):
> >          >
> >          >        "1 bob 192.0.2.1"
> >          >
> >          >     It should produce a line like:
> >          >         "1 OK proxy=all"
> >          >
> >          >     If no concurrency channel-id is received, then output is
> >         the same but
> >          >     without sending channel-id back and MUST be sent in same
> >         order as
> >          >     received.
> >          >
> >          >     I do recommend using concurrency. It can help further
> >         debug issues with
> >          >     helpers responding incorrectly.
> >          >
> >          >     HTH
> >          >     Amos
> >          >
> >          >     _______________________________________________
> >          >     squid-users mailing list
> >          > squid-users at lists.squid-cache.org
> >         <mailto:squid-users at lists.squid-cache.org>
> >          >     <mailto:squid-users at lists.squid-cache.org
> >         <mailto:squid-users at lists.squid-cache.org>>
> >          > http://lists.squid-cache.org/listinfo/squid-users
> >         <http://lists.squid-cache.org/listinfo/squid-users>
> >          >     <http://lists.squid-cache.org/listinfo/squid-users
> >         <http://lists.squid-cache.org/listinfo/squid-users>>
> >          >
> >          >
> >          > _______________________________________________
> >          > squid-users mailing list
> >          > squid-users at lists.squid-cache.org
> >         <mailto:squid-users at lists.squid-cache.org>
> >          > http://lists.squid-cache.org/listinfo/squid-users
> >         <http://lists.squid-cache.org/listinfo/squid-users>
> >
> >         _______________________________________________
> >         squid-users mailing list
> >         squid-users at lists.squid-cache.org
> >         <mailto:squid-users at lists.squid-cache.org>
> >         http://lists.squid-cache.org/listinfo/squid-users
> >         <http://lists.squid-cache.org/listinfo/squid-users>
> >
> >
> > _______________________________________________
> > squid-users mailing list
> > squid-users at lists.squid-cache.org
> > http://lists.squid-cache.org/listinfo/squid-users
>
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230426/bfafb96e/attachment.htm>

From squid3 at treenet.co.nz  Thu Apr 27 17:43:47 2023
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Fri, 28 Apr 2023 05:43:47 +1200
Subject: [squid-users] Caching uncachable resources
In-Reply-To: <CADJd0Y11+=+bHZ9Fmr-Bp6hdZvKFuSCMmSEgaweXX-rTW4eCGg@mail.gmail.com>
References: <CADJd0Y2gSOEC7AK86KvmZJ9meCfnZ8k-i61_M0eSwFuKUa1K7A@mail.gmail.com>
 <46c20592-46e0-d163-961c-520d4650590c@treenet.co.nz>
 <CADJd0Y11+=+bHZ9Fmr-Bp6hdZvKFuSCMmSEgaweXX-rTW4eCGg@mail.gmail.com>
Message-ID: <c0dd1410-33c6-c9f2-af60-36e4af33eb71@treenet.co.nz>

On 26/04/2023 11:00 pm, Andrey K wrote:
> Hello, Amos,
>
> Thank you for the information.
> The headers I included in the previous message were taken from the 
> "outside" proxy interface, i.e. were sent by the original content 
> server (I think it is a CDN):
> >
> >? ? ?Content-Type: video/MP2T
> >? ? ?*Expires: Thu, 01 Jan 1970 00:00:01 GMT*
> >? ? ?*Cache-Control: no-cache*
> >? ? ?Cache: HIT
> >? ? ?X-Cached-Since: 2023-04-25T07:43:41+00:00
> >
>

Ah, I see. Well both Age and Date are missing from that response. They 
matter for your cache.

> On the client side I see:
> < HTTP/1.1 200 OK
> < Server: nginx
> < Date: Wed, 26 Apr 2023 10:37:29 GMT
> < Expires: Thu, 01 Jan 1970 00:00:01 GMT
> < Cache-Control: no-cache
> < Cache: HIT
> < X-Cached-Since: 2023-04-25T07:43:43+00:00
> < X-Cache: MISS from 0001vsg02
> < X-Cache-Lookup: MISS from 0001vsg02:3131

> I would rephrase my question: is it possible to configure squid so 
> that it caches files with the extension ".ts" despite the caching 
> control headers passed by OCS and serves user requests from the cache?
>

The file extension has no relevance in HTTP. All that matters is whether 
the server says it is possible, and whether your local rules permit 
caching to obey those server

A lot of things apply to cacheability. The reply headers you have shown 
indicate that the response is cacheable. So to get a full answer you 
will need to supply the request headers of the request from client, and 
resulting requests (possibly multiple) between squid and server.


Amos


From bmatznick at pbandt.bank  Fri Apr 28 19:05:23 2023
From: bmatznick at pbandt.bank (Bobby Matznick)
Date: Fri, 28 Apr 2023 19:05:23 +0000
Subject: [squid-users] Squid ntlm_authenticator #Hlpr254332 exited
Message-ID: <MW5PR14MB5289C3F3E4652D23BF218DE7B06B9@MW5PR14MB5289.namprd14.prod.outlook.com>

Upgraded to Debian 11 and all that comes with that (updated all packages, squid, samba, winbindd, etc.) After upgrading I had no problems joining the windows domain, no issues with wbinfo -u or -g. In the squid logs I see the normal lines appearing except there are no usernames associated with the requests, thus, they are all TCP_DENIED/407. No surprise there since the usernames aren't coming through. When I look to the squid cache.log I see the following lines repeated over and over. My initial thought is that this has something to do with samba or winbindd even though they are working.... The one odd thing I noticed is that on my older version of Debian, winbindd had two separate folders, /var/run/samba/winbindd_privileged and /var/lib/samba/winbindd_privileged. Only the /var/lib/samba/winbindd_privileged folder contained the pipe though. After the upgrade I have /var/lib/samba/winbindd_privileged with a pipe present. There is no /var/run/samba/winbindd_privileged. However, there is a /var/run/samba/winbindd (this also exists on the old system) folder that has a pipe. Is the winbindd_privileged folder with the pipe in /var/run/samba/winbindd_privileged/pipe necessary? How can I tell which one squid is actually trying to use? May have nothing to do with the errors I am seeing but it does seem odd.
Any help would be greatly appreciated. Thanks!!

Squid cache log entries:
ipcCreate:  //usr/bin/ntlm_auth:  (13) Permission denied
WARNING: ntlmauthenticator #Hlpr253452 exited

Bobby
CONFIDENTIALITY NOTICE: The information contained in and attached to this email is intended only for the confidential use of the person or entity to which the email is addressed. This email and any attachments may contain privileged and confidential information. If you are not the intended recipient, you are notified that you received this email in error and that any reading, retention, use or distribution of this email and attachments is strictly prohibited. If you received this email in error, you are requested to immediately notify us by calling 888-728-3550 or by return email and immediately and permanently delete the email and any attachments. Thank you.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230428/bbba7140/attachment.htm>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: 0.jpg
Type: image/jpeg
Size: 6398 bytes
Desc: not available
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230428/bbba7140/attachment.jpg>

