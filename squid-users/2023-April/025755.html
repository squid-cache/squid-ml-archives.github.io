<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] forward/reverse proxying with TLS.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20forward/reverse%20proxying%20with%20TLS.&In-Reply-To=%3Cd73afef4-5a4a-e1e6-b518-763006014cab%40gmx.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="025763.html">
   <LINK REL="Next"  HREF="025756.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] forward/reverse proxying with TLS.</H1>
    <B>Tony Albers</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20forward/reverse%20proxying%20with%20TLS.&In-Reply-To=%3Cd73afef4-5a4a-e1e6-b518-763006014cab%40gmx.com%3E"
       TITLE="[squid-users] forward/reverse proxying with TLS.">tony.albers at gmx.com
       </A><BR>
    <I>Wed Apr 12 11:48:35 UTC 2023</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="025763.html">[squid-users] Squid authentication objects by source ip
</A></li>
        <LI>Next message (by thread): <A HREF="025756.html">[squid-users] forward/reverse proxying with TLS.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25755">[ date ]</a>
              <a href="thread.html#25755">[ thread ]</a>
              <a href="subject.html#25755">[ subject ]</a>
              <a href="author.html#25755">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hiya,

I'm quite new to squid, so please bear with me.

OS is Debian Bullseye.

What I want to do is &quot;hide&quot; an application behind squid, so that the 
application receives http traffic, and sends http traffic. This traffic 
then goes through squid in both directions, so that squid receives https 
on the external IP and forwards it to the application which is listening 
on the loopback interface, and squid receives outgoing traffic from the 
application on the loopback interface and then sends it out over the 
external IP with https.

Kinda like so:
Incoming: exthost1(HTTPS)-&gt;thishostname:443-&gt; squid 
-&gt;127.0.0.1(HTTP)-&gt;127.0.0.1:1080

Outgoing: 127.0.0.1(HTTP)-&gt;127.0.0.1:8080-&gt; squid
-&gt;exthost2:443(HTTPS)


I have the application running in a container on the host.
On the same host I also have squid installed.

The application listens on 127.0.0.1:1080 on HOST
Squid is set up as a reverse proxy, listening to https on the external 
if on HOST:443 and forwards everything as http to 127.0.0.1:1080
(this works fine)

When the application then transmits something via http, it uses 
localhost:8080 as proxy, where squid picks it up and then forwards it as 
https.
(this doesn't work)

At least that#s what I want it to do..

However, when I use squid as outgoing proxy, the server in the other 
end(88.24.12.40) says that squid doesn't present a client certificate 
and drops the connection.

But I got the impression that tls_outgoing_options is for exactly that.. 
Have I misunderstood something?


My squid config looks like this:

# prefer DNS over IPv4
dns_v4_first on

# define hosts/networks that we use
acl exthost src 88.24.12.60/32
acl inthosts src 172.27.2.0/24
acl internal src 127.0.0.1/32

# access lists
http_access allow exthost
http_access allow inthosts
http_access allow internal

# reverse SSL proxy converting to noSSL
https_port 172.27.2.118:443 accel
tls-cert=/etc/squid/certs/thishostname.crt
tls-key=/etc/squid/keys/thishostname-privkey.pem
defaultsite=thishostname
cache_peer 127.0.0.1 parent 1080 0 no-query proxy-only originserver 
name=thishostname

# forward proxy converting to SSL
http_port 127.0.0.1:8080
acl extnet dstdomain -n .somedomain.dk
acl extip dstdomain 88.24.12.40
acl intip dstdomain -n .someotherdomain.dk
url_rewrite_program /etc/squid/urlrewrite.py
tls_outgoing_options cert=/etc/squid/certs/thishostname.crt
tls_outgoing_options key=/etc/squid/keys/thishostname-privkey.pem
tls_outgoing_options cafile=/etc/squid/certs/thishostnameCA.pem
tls_outgoing_options capath=/etc/ssl/certs
tls_outgoing_options domain=somedomain.dk
never_direct deny extnet
never_direct deny extip
never_direct allow all

cache_peer_access thishostname allow exthosts
cache_peer_access thishostname allow inthosts
cache_peer_access thishostname allow internal
cache_peer_access thishostname deny all

# disable local caching
cache deny all

Thanks in advance,

Tony

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="025763.html">[squid-users] Squid authentication objects by source ip
</A></li>
	<LI>Next message (by thread): <A HREF="025756.html">[squid-users] forward/reverse proxying with TLS.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25755">[ date ]</a>
              <a href="thread.html#25755">[ thread ]</a>
              <a href="subject.html#25755">[ subject ]</a>
              <a href="author.html#25755">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
