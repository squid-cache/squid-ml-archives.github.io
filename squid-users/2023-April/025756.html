<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] forward/reverse proxying with TLS.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20forward/reverse%20proxying%20with%20TLS.&In-Reply-To=%3Cae7cb8b2-2faf-6d52-b6e3-6be21e74fda3%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="025755.html">
   <LINK REL="Next"  HREF="025764.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] forward/reverse proxying with TLS.</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20forward/reverse%20proxying%20with%20TLS.&In-Reply-To=%3Cae7cb8b2-2faf-6d52-b6e3-6be21e74fda3%40measurement-factory.com%3E"
       TITLE="[squid-users] forward/reverse proxying with TLS.">rousskov at measurement-factory.com
       </A><BR>
    <I>Wed Apr 12 13:55:39 UTC 2023</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="025755.html">[squid-users] forward/reverse proxying with TLS.
</A></li>
        <LI>Next message (by thread): <A HREF="025764.html">[squid-users] forward/reverse proxying with TLS.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25756">[ date ]</a>
              <a href="thread.html#25756">[ thread ]</a>
              <a href="subject.html#25756">[ subject ]</a>
              <a href="author.html#25756">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 4/12/23 07:48, Tony Albers wrote:

&gt;<i> What I want to do is &quot;hide&quot; an application behind squid, so that the 
</I>&gt;<i> application receives http traffic, and sends http traffic. This traffic 
</I>&gt;<i> then goes through squid in both directions, so that squid receives https 
</I>&gt;<i> on the external IP and forwards it to the application which is listening 
</I>&gt;<i> on the loopback interface, and squid receives outgoing traffic from the 
</I>&gt;<i> application on the loopback interface and then sends it out over the 
</I>&gt;<i> external IP with https.
</I>
&gt;<i> Kinda like so:
</I>&gt;<i> Incoming: exthost1(HTTPS)-&gt;thishostname:443-&gt; squid 
</I>&gt;<i> -&gt;127.0.0.1(HTTP)-&gt;127.0.0.1:1080
</I>&gt;<i> 
</I>&gt;<i> Outgoing: 127.0.0.1(HTTP)-&gt;127.0.0.1:8080-&gt; squid
</I>&gt;<i> -&gt;exthost2:443(HTTPS)
</I>
&gt;<i> when I use squid as outgoing proxy, the server in the other 
</I>&gt;<i> end(88.24.12.40) says that squid doesn't present a client certificate
</I>&gt;<i> and drops the connection.
</I>
It looks like you are trying to force Squid to encrypt traffic by using 
tls_outgoing_options. Squid cannot be forced to encrypt. Squid encrypts 
if it needs to communicate with a TLS origin server or cache_peer and 
does not encrypt otherwise. The tls_outgoing_options directive is 
consulted _if_ Squid encrypts; it cannot _force_ encryption.

There are two primary use cases where Squid should encrypt traffic on 
behalf of an HTTP application:

1. The application, when configured to use a proxy at http_port, sends 
Squid HTTP requests that have an &quot;https&quot; URL scheme. This is often 
referred to as &quot;GET https&quot; use case. Very few applications (i.e. HTTP 
user agents) do that, unfortunately.

2. The application, when configured to use a proxy at http_port, sends 
Squid HTTP requests that have an &quot;http&quot; URL scheme, and Squid is 
configured to forward those HTTP requests to one (or a few) cache_peers, 
each configured with &quot;tls&quot; and &quot;originserver&quot; options. This use case is 
applicable only if the application communicates with a few origin 
servers, and you know all those origin servers in advance (so that you 
can create a matching cache_peer configuration for each of them).

If your use case is #2, then you need to adjust your cache_peer 
directive to make that cache_peer a TLS peer (with appropriate client 
certificates).


N.B. Your http_access rules may benefit from a refactoring that makes 
each rule specific to the listening port that needs access protection. 
For example, do not allow exthost traffic on http_port... Similar 
&quot;everything everywhere&quot; problem may exist for your cache_peer access 
rules: Those rules should deny peering for traffic received on 
https_port AFAICT.


HTH,

Alex.



&gt;<i> I have the application running in a container on the host.
</I>&gt;<i> On the same host I also have squid installed.
</I>&gt;<i> 
</I>&gt;<i> The application listens on 127.0.0.1:1080 on HOST
</I>&gt;<i> Squid is set up as a reverse proxy, listening to https on the external 
</I>&gt;<i> if on HOST:443 and forwards everything as http to 127.0.0.1:1080
</I>&gt;<i> (this works fine)
</I>&gt;<i> 
</I>&gt;<i> When the application then transmits something via http, it uses 
</I>&gt;<i> localhost:8080 as proxy, where squid picks it up and then forwards it as 
</I>&gt;<i> https.
</I>&gt;<i> (this doesn't work)
</I>&gt;<i> 
</I>&gt;<i> At least that#s what I want it to do..
</I>&gt;<i> 
</I>&gt;<i> However, when I use squid as outgoing proxy, the server in the other 
</I>&gt;<i> end(88.24.12.40) says that squid doesn't present a client certificate 
</I>&gt;<i> and drops the connection.
</I>&gt;<i> 
</I>&gt;<i> But I got the impression that tls_outgoing_options is for exactly that.. 
</I>&gt;<i> Have I misunderstood something?
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> My squid config looks like this:
</I>&gt;<i> 
</I>&gt;<i> # prefer DNS over IPv4
</I>&gt;<i> dns_v4_first on
</I>&gt;<i> 
</I>&gt;<i> # define hosts/networks that we use
</I>&gt;<i> acl exthost src 88.24.12.60/32
</I>&gt;<i> acl inthosts src 172.27.2.0/24
</I>&gt;<i> acl internal src 127.0.0.1/32
</I>&gt;<i> 
</I>&gt;<i> # access lists
</I>&gt;<i> http_access allow exthost
</I>&gt;<i> http_access allow inthosts
</I>&gt;<i> http_access allow internal
</I>&gt;<i> 
</I>&gt;<i> # reverse SSL proxy converting to noSSL
</I>&gt;<i> https_port 172.27.2.118:443 accel
</I>&gt;<i> tls-cert=/etc/squid/certs/thishostname.crt
</I>&gt;<i> tls-key=/etc/squid/keys/thishostname-privkey.pem
</I>&gt;<i> defaultsite=thishostname
</I>&gt;<i> cache_peer 127.0.0.1 parent 1080 0 no-query proxy-only originserver 
</I>&gt;<i> name=thishostname
</I>&gt;<i> 
</I>&gt;<i> # forward proxy converting to SSL
</I>&gt;<i> http_port 127.0.0.1:8080
</I>&gt;<i> acl extnet dstdomain -n .somedomain.dk
</I>&gt;<i> acl extip dstdomain 88.24.12.40
</I>&gt;<i> acl intip dstdomain -n .someotherdomain.dk
</I>&gt;<i> url_rewrite_program /etc/squid/urlrewrite.py
</I>&gt;<i> tls_outgoing_options cert=/etc/squid/certs/thishostname.crt
</I>&gt;<i> tls_outgoing_options key=/etc/squid/keys/thishostname-privkey.pem
</I>&gt;<i> tls_outgoing_options cafile=/etc/squid/certs/thishostnameCA.pem
</I>&gt;<i> tls_outgoing_options capath=/etc/ssl/certs
</I>&gt;<i> tls_outgoing_options domain=somedomain.dk
</I>&gt;<i> never_direct deny extnet
</I>&gt;<i> never_direct deny extip
</I>&gt;<i> never_direct allow all
</I>&gt;<i> 
</I>&gt;<i> cache_peer_access thishostname allow exthosts
</I>&gt;<i> cache_peer_access thishostname allow inthosts
</I>&gt;<i> cache_peer_access thishostname allow internal
</I>&gt;<i> cache_peer_access thishostname deny all
</I>&gt;<i> 
</I>&gt;<i> # disable local caching
</I>&gt;<i> cache deny all
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="025755.html">[squid-users] forward/reverse proxying with TLS.
</A></li>
	<LI>Next message (by thread): <A HREF="025764.html">[squid-users] forward/reverse proxying with TLS.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25756">[ date ]</a>
              <a href="thread.html#25756">[ thread ]</a>
              <a href="subject.html#25756">[ subject ]</a>
              <a href="author.html#25756">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
