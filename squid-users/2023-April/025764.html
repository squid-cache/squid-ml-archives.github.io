<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] forward/reverse proxying with TLS.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20forward/reverse%20proxying%20with%20TLS.&In-Reply-To=%3C5f698eac-b2cb-2daf-a5c0-2e3f5255cd56%40gmx.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="025756.html">
   <LINK REL="Next"  HREF="025765.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] forward/reverse proxying with TLS.</H1>
    <B>Tony Albers</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20forward/reverse%20proxying%20with%20TLS.&In-Reply-To=%3C5f698eac-b2cb-2daf-a5c0-2e3f5255cd56%40gmx.com%3E"
       TITLE="[squid-users] forward/reverse proxying with TLS.">tony.albers at gmx.com
       </A><BR>
    <I>Thu Apr 13 04:28:27 UTC 2023</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="025756.html">[squid-users] forward/reverse proxying with TLS.
</A></li>
        <LI>Next message (by thread): <A HREF="025765.html">[squid-users] forward/reverse proxying with TLS.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25764">[ date ]</a>
              <a href="thread.html#25764">[ thread ]</a>
              <a href="subject.html#25764">[ subject ]</a>
              <a href="author.html#25764">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Alex,

Thanks for your answer. Too bad that squid can't do what I want.

Can you think of another way of doing this, or do you know of another 
tool that can?

Thanks,

/tony

On 12/04/2023 15:55, Alex Rousskov wrote:
&gt;<i> On 4/12/23 07:48, Tony Albers wrote:
</I>&gt;<i>
</I>&gt;&gt;<i> What I want to do is &quot;hide&quot; an application behind squid, so that the 
</I>&gt;&gt;<i> application receives http traffic, and sends http traffic. This 
</I>&gt;&gt;<i> traffic then goes through squid in both directions, so that squid 
</I>&gt;&gt;<i> receives https on the external IP and forwards it to the application 
</I>&gt;&gt;<i> which is listening on the loopback interface, and squid receives 
</I>&gt;&gt;<i> outgoing traffic from the application on the loopback interface and 
</I>&gt;&gt;<i> then sends it out over the external IP with https.
</I>&gt;<i>
</I>&gt;&gt;<i> Kinda like so:
</I>&gt;&gt;<i> Incoming: exthost1(HTTPS)-&gt;thishostname:443-&gt; squid 
</I>&gt;&gt;<i> -&gt;127.0.0.1(HTTP)-&gt;127.0.0.1:1080
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Outgoing: 127.0.0.1(HTTP)-&gt;127.0.0.1:8080-&gt; squid
</I>&gt;&gt;<i> -&gt;exthost2:443(HTTPS)
</I>&gt;<i>
</I>&gt;&gt;<i> when I use squid as outgoing proxy, the server in the other 
</I>&gt;&gt;<i> end(88.24.12.40) says that squid doesn't present a client certificate
</I>&gt;&gt;<i> and drops the connection.
</I>&gt;<i>
</I>&gt;<i> It looks like you are trying to force Squid to encrypt traffic by 
</I>&gt;<i> using tls_outgoing_options. Squid cannot be forced to encrypt. Squid 
</I>&gt;<i> encrypts if it needs to communicate with a TLS origin server or 
</I>&gt;<i> cache_peer and does not encrypt otherwise. The tls_outgoing_options 
</I>&gt;<i> directive is consulted _if_ Squid encrypts; it cannot _force_ encryption.
</I>&gt;<i>
</I>&gt;<i> There are two primary use cases where Squid should encrypt traffic on 
</I>&gt;<i> behalf of an HTTP application:
</I>&gt;<i>
</I>&gt;<i> 1. The application, when configured to use a proxy at http_port, sends 
</I>&gt;<i> Squid HTTP requests that have an &quot;https&quot; URL scheme. This is often 
</I>&gt;<i> referred to as &quot;GET https&quot; use case. Very few applications (i.e. HTTP 
</I>&gt;<i> user agents) do that, unfortunately.
</I>&gt;<i>
</I>&gt;<i> 2. The application, when configured to use a proxy at http_port, sends 
</I>&gt;<i> Squid HTTP requests that have an &quot;http&quot; URL scheme, and Squid is 
</I>&gt;<i> configured to forward those HTTP requests to one (or a few) 
</I>&gt;<i> cache_peers, each configured with &quot;tls&quot; and &quot;originserver&quot; options. 
</I>&gt;<i> This use case is applicable only if the application communicates with 
</I>&gt;<i> a few origin servers, and you know all those origin servers in advance 
</I>&gt;<i> (so that you can create a matching cache_peer configuration for each 
</I>&gt;<i> of them).
</I>&gt;<i>
</I>&gt;<i> If your use case is #2, then you need to adjust your cache_peer 
</I>&gt;<i> directive to make that cache_peer a TLS peer (with appropriate client 
</I>&gt;<i> certificates).
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> N.B. Your http_access rules may benefit from a refactoring that makes 
</I>&gt;<i> each rule specific to the listening port that needs access protection. 
</I>&gt;<i> For example, do not allow exthost traffic on http_port... Similar 
</I>&gt;<i> &quot;everything everywhere&quot; problem may exist for your cache_peer access 
</I>&gt;<i> rules: Those rules should deny peering for traffic received on 
</I>&gt;<i> https_port AFAICT.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> HTH,
</I>&gt;<i>
</I>&gt;<i> Alex.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> I have the application running in a container on the host.
</I>&gt;&gt;<i> On the same host I also have squid installed.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The application listens on 127.0.0.1:1080 on HOST
</I>&gt;&gt;<i> Squid is set up as a reverse proxy, listening to https on the 
</I>&gt;&gt;<i> external if on HOST:443 and forwards everything as http to 
</I>&gt;&gt;<i> 127.0.0.1:1080
</I>&gt;&gt;<i> (this works fine)
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> When the application then transmits something via http, it uses 
</I>&gt;&gt;<i> localhost:8080 as proxy, where squid picks it up and then forwards it 
</I>&gt;&gt;<i> as https.
</I>&gt;&gt;<i> (this doesn't work)
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> At least that#s what I want it to do..
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> However, when I use squid as outgoing proxy, the server in the other 
</I>&gt;&gt;<i> end(88.24.12.40) says that squid doesn't present a client certificate 
</I>&gt;&gt;<i> and drops the connection.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> But I got the impression that tls_outgoing_options is for exactly 
</I>&gt;&gt;<i> that.. Have I misunderstood something?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> My squid config looks like this:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> # prefer DNS over IPv4
</I>&gt;&gt;<i> dns_v4_first on
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> # define hosts/networks that we use
</I>&gt;&gt;<i> acl exthost src 88.24.12.60/32
</I>&gt;&gt;<i> acl inthosts src 172.27.2.0/24
</I>&gt;&gt;<i> acl internal src 127.0.0.1/32
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> # access lists
</I>&gt;&gt;<i> http_access allow exthost
</I>&gt;&gt;<i> http_access allow inthosts
</I>&gt;&gt;<i> http_access allow internal
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> # reverse SSL proxy converting to noSSL
</I>&gt;&gt;<i> https_port 172.27.2.118:443 accel
</I>&gt;&gt;<i> tls-cert=/etc/squid/certs/thishostname.crt
</I>&gt;&gt;<i> tls-key=/etc/squid/keys/thishostname-privkey.pem
</I>&gt;&gt;<i> defaultsite=thishostname
</I>&gt;&gt;<i> cache_peer 127.0.0.1 parent 1080 0 no-query proxy-only originserver 
</I>&gt;&gt;<i> name=thishostname
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> # forward proxy converting to SSL
</I>&gt;&gt;<i> http_port 127.0.0.1:8080
</I>&gt;&gt;<i> acl extnet dstdomain -n .somedomain.dk
</I>&gt;&gt;<i> acl extip dstdomain 88.24.12.40
</I>&gt;&gt;<i> acl intip dstdomain -n .someotherdomain.dk
</I>&gt;&gt;<i> url_rewrite_program /etc/squid/urlrewrite.py
</I>&gt;&gt;<i> tls_outgoing_options cert=/etc/squid/certs/thishostname.crt
</I>&gt;&gt;<i> tls_outgoing_options key=/etc/squid/keys/thishostname-privkey.pem
</I>&gt;&gt;<i> tls_outgoing_options cafile=/etc/squid/certs/thishostnameCA.pem
</I>&gt;&gt;<i> tls_outgoing_options capath=/etc/ssl/certs
</I>&gt;&gt;<i> tls_outgoing_options domain=somedomain.dk
</I>&gt;&gt;<i> never_direct deny extnet
</I>&gt;&gt;<i> never_direct deny extip
</I>&gt;&gt;<i> never_direct allow all
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> cache_peer_access thishostname allow exthosts
</I>&gt;&gt;<i> cache_peer_access thishostname allow inthosts
</I>&gt;&gt;<i> cache_peer_access thishostname allow internal
</I>&gt;&gt;<i> cache_peer_access thishostname deny all
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> # disable local caching
</I>&gt;&gt;<i> cache deny all
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="025756.html">[squid-users] forward/reverse proxying with TLS.
</A></li>
	<LI>Next message (by thread): <A HREF="025765.html">[squid-users] forward/reverse proxying with TLS.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25764">[ date ]</a>
              <a href="thread.html#25764">[ thread ]</a>
              <a href="subject.html#25764">[ subject ]</a>
              <a href="author.html#25764">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
