<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Help to understand tcp_denied in access.log
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Help%20to%20understand%20tcp_denied%20in%20access.log&In-Reply-To=%3C%21%26%21AAAAAAAAAAAuAAAAAAAAAIVNjRjcTGZElYgADq7oyvYBAMO2jhD3dRHOtM0AqgC7tuYAAAAAAA4AABAAAACun8EO5DWHSKeMxm9DSfyzAQAAAAA%3D%40articatech.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="025767.html">
   <LINK REL="Next"  HREF="025771.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Help to understand tcp_denied in access.log</H1>
    <B>andre.bolinhas at articatech.com</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Help%20to%20understand%20tcp_denied%20in%20access.log&In-Reply-To=%3C%21%26%21AAAAAAAAAAAuAAAAAAAAAIVNjRjcTGZElYgADq7oyvYBAMO2jhD3dRHOtM0AqgC7tuYAAAAAAA4AABAAAACun8EO5DWHSKeMxm9DSfyzAQAAAAA%3D%40articatech.com%3E"
       TITLE="[squid-users] Help to understand tcp_denied in access.log">andre.bolinhas at articatech.com
       </A><BR>
    <I>Fri Apr 14 10:36:07 UTC 2023</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="025767.html">[squid-users] Help to understand tcp_denied in access.log
</A></li>
        <LI>Next message (by thread): <A HREF="025771.html">[squid-users] Help to understand tcp_denied in access.log
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25769">[ date ]</a>
              <a href="thread.html#25769">[ thread ]</a>
              <a href="subject.html#25769">[ subject ]</a>
              <a href="author.html#25769">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Alex,
The mechanism is http_access, the size of error page is around 500kb.
The squid version is 5.8 and I'm not doing ssl bump for this domain.
When you ask to &quot; collect a packet trace&quot; is put squid in debug mode? Squid
-k debug?
Best regards

-----Mensagem original-----
De: squid-users &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>&gt; Em Nome De Alex
Rousskov
Enviada: 14 de abril de 2023 04:01
Para: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
Assunto: Re: [squid-users] Help to understand tcp_denied in access.log

On 4/13/23 21:23, <A HREF="https://lists.squid-cache.org/listinfo/squid-users">andre.bolinhas at articatech.com</A> wrote:

&gt;<i> I'm seeing to many requests to website mainnet.infura.io, by analyzing 
</I>&gt;<i> the access.log seams that the website is blocked
</I>
Which directive/mechanism blocks them (e.g., http_access,
reply_body_max_size, ICAP/eCAP, etc.)?


&gt;<i> Each TCP_DENIED request is consuming 400000+ bytes 
</I>
Assuming you do not use huge custom TCP_DENIED error pages, I agree that 
these entries look suspicious, as if Squid denied access but continued 
to tunnel the traffic. The response times are fairly small, but probably 
large enough to transmit those amounts of data from a fast server.

Since most requests (for the affected domain) are problematic, can you 
collect a packet trace and see if you can confirm that these 
transactions transmit a lot of data from Squid to the client? If IPs are 
not enough, logging client TCP port (%&gt;p) may help you match specific 
access.log entries with TCP connections in the packet trace...


What Squid version are you using for this? Does SslBump affect the 
problematic transactions?


Thank you,

Alex.



&gt;<i> but I also notice that the
</I>&gt;<i> request is consuming bandwidth, here a example
</I>&gt;<i> Squid access.log format.
</I>&gt;<i> %ts.%03tu %6tr %&gt;a %Ss/%03&gt;Hs %&lt;st %rm %ru %[un %Sh/%&lt;a:%&lt;p %mt
</I>mac=&quot;%&gt;eui&quot;
&gt;<i> %note ua=&quot;%{User-Agent}&gt;h&quot; exterr=&quot;%err_code|%err_detail&quot;
</I>&gt;<i> 
</I>&gt;<i> Access.log request.
</I>&gt;<i> 1681099742.517     35 10.81.216.114 TCP_DENIED_ABORTED/407 41154 CONNECT
</I>&gt;<i> mainnet.infura.io:443 - HIER_NONE/-:- text/html mac=&quot;00:00:00:00:00:00&quot;
</I>&gt;<i>
</I>category:%20143%0D%0Acategory-name:%20Trackers%0D%0Aclog:%20cinfo:143-Tracke
&gt;<i> rs;%0D%0A ua=&quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7)
</I>&gt;<i> AppleWebKit/537.36 (KHTML, like Gecko) Chrome/111.0.0.0 Safari/537.36&quot;
</I>&gt;<i> exterr=&quot;ERR_CACHE_ACCESS_DENIED|-&quot;
</I>&gt;<i> 
</I>&gt;<i> 1681099742.575     41 10.81.216.114 TCP_DENIED/407 511819 CONNECT
</I>&gt;<i> mainnet.infura.io:443 - HIER_NONE/-:- text/html mac=&quot;00:00:00:00:00:00&quot;
</I>&gt;<i>
</I>category:%20143%0D%0Acategory-name:%20Trackers%0D%0Aclog:%20cinfo:143-Tracke
&gt;<i> rs;%0D%0A ua=&quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7)
</I>&gt;<i> AppleWebKit/537.36 (KHTML, like Gecko) Chrome/111.0.0.0 Safari/537.36&quot;
</I>&gt;<i> exterr=&quot;ERR_CACHE_ACCESS_DENIED|-&quot;
</I>&gt;<i> 
</I>&gt;<i> 1681099742.664     73 10.81.216.114 NONE/200 0 CONNECT
</I>mainnet.infura.io:443
&gt;<i> HLBHO/tsyafiq HIER_NONE/-:- - mac=&quot;00:00:00:00:00:00&quot;
</I>&gt;<i>
</I>category:%20143%0D%0Acategory-name:%20Trackers%0D%0Aclog:%20cinfo:143-Tracke
&gt;<i> rs;%0D%0Auser:%20HLBHO/tsyafiq%0D%0A ua=&quot;Mozilla/5.0 (Macintosh; Intel Mac
</I>&gt;<i> OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/111.0.0.0
</I>&gt;<i> Safari/537.36&quot; exterr=&quot;-|-&quot;
</I>&gt;<i> 
</I>&gt;<i> 1681099742.685     20 10.81.216.114 TCP_DENIED_ABORTED/403 450655 CONNECT
</I>&gt;<i> mainnet.infura.io:443 HLBHO/tsyafiq HIER_NONE/-:- text/html
</I>&gt;<i> mac=&quot;00:00:00:00:00:00&quot;
</I>&gt;<i>
</I>category:%20143%0D%0Acategory-name:%20Trackers%0D%0Aclog:%20cinfo:143-Tracke
&gt;<i> rs;%0D%0Auser:%20HLBHO/tsyafiq%0D%0A ua=&quot;-&quot; exterr=&quot;ERR_ACCESS_DENIED|-&quot;
</I>&gt;<i> 
</I>&gt;<i> Each TCP_DENIED request is consuming 400000+ bytes so at the end of the
</I>day
&gt;<i> sometimes I have a total of 56k request to mainnet.infura.io consuming
</I>&gt;<i> around 15GB of bandwidth.
</I>&gt;<i> 
</I>&gt;<i> My question is, assuming that %&lt;st is the total size of reply, why
</I>&gt;<i> TCP_DENIED is taking a lot of bandwidth to block a website?
</I>&gt;<i> 
</I>&gt;<i> Best regards
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>
_______________________________________________
squid-users mailing list
<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
<A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="025767.html">[squid-users] Help to understand tcp_denied in access.log
</A></li>
	<LI>Next message (by thread): <A HREF="025771.html">[squid-users] Help to understand tcp_denied in access.log
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25769">[ date ]</a>
              <a href="thread.html#25769">[ thread ]</a>
              <a href="subject.html#25769">[ subject ]</a>
              <a href="author.html#25769">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
