<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Help to understand tcp_denied in access.log
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Help%20to%20understand%20tcp_denied%20in%20access.log&In-Reply-To=%3C63d23c19-7da0-1057-6908-72b4e9bf8613%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="025769.html">
   <LINK REL="Next"  HREF="025775.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Help to understand tcp_denied in access.log</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Help%20to%20understand%20tcp_denied%20in%20access.log&In-Reply-To=%3C63d23c19-7da0-1057-6908-72b4e9bf8613%40measurement-factory.com%3E"
       TITLE="[squid-users] Help to understand tcp_denied in access.log">rousskov at measurement-factory.com
       </A><BR>
    <I>Fri Apr 14 14:08:18 UTC 2023</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="025769.html">[squid-users] Help to understand tcp_denied in access.log
</A></li>
        <LI>Next message (by thread): <A HREF="025775.html">[squid-users] Disable IPV6 for certain destinations only?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25771">[ date ]</a>
              <a href="thread.html#25771">[ thread ]</a>
              <a href="subject.html#25771">[ subject ]</a>
              <a href="author.html#25771">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 4/14/23 06:36, <A HREF="https://lists.squid-cache.org/listinfo/squid-users">andre.bolinhas at articatech.com</A> wrote:

&gt;<i> The mechanism is http_access, the size of error page is around 500kb.
</I>
 &gt;&gt; Each TCP_DENIED request is consuming 400000+ bytes

If your custom error page is around 500KB, then we should not be 
surprised that the corresponding %&lt;st values exceed 400000 bytes!


&gt;<i> The squid version is 5.8 and I'm not doing ssl bump for this domain.
</I>&gt;<i> When you ask to &quot; collect a packet trace&quot; is put squid in debug mode? Squid
</I>&gt;<i> -k debug?
</I>
No, I was thinking about something along these lines:

   tcpdump -s0 -w packet-trace.pcap ...

However, with your 500KB statement, there is no need for a packet trace 
because Squid is simply sending your large custom error responses to 
denied clients, as instructed. Mystery solved.

Please note that popular browsers will not display CONNECT error 
responses, but client behavior is client-dependent, so YMMV.

Do you want Squid to respond with your custom 500KB error page? If yes, 
there is nothing you need to do. Otherwise, please clarify what you want 
Squid to do instead.


HTH,

Alex.


&gt;<i> -----Mensagem original-----
</I>&gt;<i> De: squid-users &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>&gt; Em Nome De Alex
</I>&gt;<i> Rousskov
</I>&gt;<i> Enviada: 14 de abril de 2023 04:01
</I>&gt;<i> Para: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> Assunto: Re: [squid-users] Help to understand tcp_denied in access.log
</I>&gt;<i> 
</I>&gt;<i> On 4/13/23 21:23, <A HREF="https://lists.squid-cache.org/listinfo/squid-users">andre.bolinhas at articatech.com</A> wrote:
</I>&gt;<i> 
</I>&gt;&gt;<i> I'm seeing to many requests to website mainnet.infura.io, by analyzing
</I>&gt;&gt;<i> the access.log seams that the website is blocked
</I>&gt;<i> 
</I>&gt;<i> Which directive/mechanism blocks them (e.g., http_access,
</I>&gt;<i> reply_body_max_size, ICAP/eCAP, etc.)?
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> Each TCP_DENIED request is consuming 400000+ bytes
</I>&gt;<i> 
</I>&gt;<i> Assuming you do not use huge custom TCP_DENIED error pages, I agree that
</I>&gt;<i> these entries look suspicious, as if Squid denied access but continued
</I>&gt;<i> to tunnel the traffic. The response times are fairly small, but probably
</I>&gt;<i> large enough to transmit those amounts of data from a fast server.
</I>&gt;<i> 
</I>&gt;<i> Since most requests (for the affected domain) are problematic, can you
</I>&gt;<i> collect a packet trace and see if you can confirm that these
</I>&gt;<i> transactions transmit a lot of data from Squid to the client? If IPs are
</I>&gt;<i> not enough, logging client TCP port (%&gt;p) may help you match specific
</I>&gt;<i> access.log entries with TCP connections in the packet trace...
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> What Squid version are you using for this? Does SslBump affect the
</I>&gt;<i> problematic transactions?
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Thank you,
</I>&gt;<i> 
</I>&gt;<i> Alex.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> but I also notice that the
</I>&gt;&gt;<i> request is consuming bandwidth, here a example
</I>&gt;&gt;<i> Squid access.log format.
</I>&gt;&gt;<i> %ts.%03tu %6tr %&gt;a %Ss/%03&gt;Hs %&lt;st %rm %ru %[un %Sh/%&lt;a:%&lt;p %mt
</I>&gt;<i> mac=&quot;%&gt;eui&quot;
</I>&gt;&gt;<i> %note ua=&quot;%{User-Agent}&gt;h&quot; exterr=&quot;%err_code|%err_detail&quot;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Access.log request.
</I>&gt;&gt;<i> 1681099742.517     35 10.81.216.114 TCP_DENIED_ABORTED/407 41154 CONNECT
</I>&gt;&gt;<i> mainnet.infura.io:443 - HIER_NONE/-:- text/html mac=&quot;00:00:00:00:00:00&quot;
</I>&gt;&gt;<i>
</I>&gt;<i> category:%20143%0D%0Acategory-name:%20Trackers%0D%0Aclog:%20cinfo:143-Tracke
</I>&gt;&gt;<i> rs;%0D%0A ua=&quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7)
</I>&gt;&gt;<i> AppleWebKit/537.36 (KHTML, like Gecko) Chrome/111.0.0.0 Safari/537.36&quot;
</I>&gt;&gt;<i> exterr=&quot;ERR_CACHE_ACCESS_DENIED|-&quot;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> 1681099742.575     41 10.81.216.114 TCP_DENIED/407 511819 CONNECT
</I>&gt;&gt;<i> mainnet.infura.io:443 - HIER_NONE/-:- text/html mac=&quot;00:00:00:00:00:00&quot;
</I>&gt;&gt;<i>
</I>&gt;<i> category:%20143%0D%0Acategory-name:%20Trackers%0D%0Aclog:%20cinfo:143-Tracke
</I>&gt;&gt;<i> rs;%0D%0A ua=&quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7)
</I>&gt;&gt;<i> AppleWebKit/537.36 (KHTML, like Gecko) Chrome/111.0.0.0 Safari/537.36&quot;
</I>&gt;&gt;<i> exterr=&quot;ERR_CACHE_ACCESS_DENIED|-&quot;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> 1681099742.664     73 10.81.216.114 NONE/200 0 CONNECT
</I>&gt;<i> mainnet.infura.io:443
</I>&gt;&gt;<i> HLBHO/tsyafiq HIER_NONE/-:- - mac=&quot;00:00:00:00:00:00&quot;
</I>&gt;&gt;<i>
</I>&gt;<i> category:%20143%0D%0Acategory-name:%20Trackers%0D%0Aclog:%20cinfo:143-Tracke
</I>&gt;&gt;<i> rs;%0D%0Auser:%20HLBHO/tsyafiq%0D%0A ua=&quot;Mozilla/5.0 (Macintosh; Intel Mac
</I>&gt;&gt;<i> OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/111.0.0.0
</I>&gt;&gt;<i> Safari/537.36&quot; exterr=&quot;-|-&quot;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> 1681099742.685     20 10.81.216.114 TCP_DENIED_ABORTED/403 450655 CONNECT
</I>&gt;&gt;<i> mainnet.infura.io:443 HLBHO/tsyafiq HIER_NONE/-:- text/html
</I>&gt;&gt;<i> mac=&quot;00:00:00:00:00:00&quot;
</I>&gt;&gt;<i>
</I>&gt;<i> category:%20143%0D%0Acategory-name:%20Trackers%0D%0Aclog:%20cinfo:143-Tracke
</I>&gt;&gt;<i> rs;%0D%0Auser:%20HLBHO/tsyafiq%0D%0A ua=&quot;-&quot; exterr=&quot;ERR_ACCESS_DENIED|-&quot;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Each TCP_DENIED request is consuming 400000+ bytes so at the end of the
</I>&gt;<i> day
</I>&gt;&gt;<i> sometimes I have a total of 56k request to mainnet.infura.io consuming
</I>&gt;&gt;<i> around 15GB of bandwidth.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> My question is, assuming that %&lt;st is the total size of reply, why
</I>&gt;&gt;<i> TCP_DENIED is taking a lot of bandwidth to block a website?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Best regards
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;<i> squid-users mailing list
</I>&gt;&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="025769.html">[squid-users] Help to understand tcp_denied in access.log
</A></li>
	<LI>Next message (by thread): <A HREF="025775.html">[squid-users] Disable IPV6 for certain destinations only?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25771">[ date ]</a>
              <a href="thread.html#25771">[ thread ]</a>
              <a href="subject.html#25771">[ subject ]</a>
              <a href="author.html#25771">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
