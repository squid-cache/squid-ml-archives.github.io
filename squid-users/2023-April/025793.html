<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Fwd:  cache_peer_access by dynamic ACL
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Fwd%3A%20%20cache_peer_access%20by%20dynamic%20ACL&In-Reply-To=%3CCAFqyDwBM4StMYCJmKDHM3owhUy295o%2BqxMKQKjRugSj%2BXOzRJw%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="025792.html">
   <LINK REL="Next"  HREF="025794.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Fwd:  cache_peer_access by dynamic ACL</H1>
    <B>Alexey&#1103;&#1088; Gruzdov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Fwd%3A%20%20cache_peer_access%20by%20dynamic%20ACL&In-Reply-To=%3CCAFqyDwBM4StMYCJmKDHM3owhUy295o%2BqxMKQKjRugSj%2BXOzRJw%40mail.gmail.com%3E"
       TITLE="[squid-users] Fwd:  cache_peer_access by dynamic ACL">my.shellac at gmail.com
       </A><BR>
    <I>Thu Apr 20 17:14:36 UTC 2023</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="025792.html">[squid-users] cache_peer_access by dynamic ACL
</A></li>
        <LI>Next message (by thread): <A HREF="025794.html">[squid-users] Fwd: cache_peer_access by dynamic ACL
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25793">[ date ]</a>
              <a href="thread.html#25793">[ thread ]</a>
              <a href="subject.html#25793">[ subject ]</a>
              <a href="author.html#25793">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Ok. The last issues fixed. Thank you !

Tell me please If I right understood I could to get answer like
&quot;name=value&quot; from my ACL ext script, instead of &quot;OK&quot; or &quot;ERR&quot;, right?

And does it means - I could to get answer depends from what users
authorises in to proxy.
For example:

If user &quot;Jon&quot;  -  the my ACL will check the policy in the DB and send
answer like &quot;proxy=g1&quot; to squid, or if user is &quot;Jack&quot; - answer will be like
&quot;proxy=all&quot;

and I will have ACL for this

acl proxy_g1_marked.acl note proxy g1
acl proxy_all_marked.acl note proxy all

will that correct ?

&#1095;&#1090;, 20 &#1072;&#1087;&#1088;. 2023&#8239;&#1075;. &#1074; 19:50, Alex Rousskov &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>
&gt;:<i>
</I>
&gt;<i> On 4/20/23 10:54, Alexey&#1103;&#1088; Gruzdov wrote:
</I>&gt;<i> &gt; The cpu is around 100% even no any requests is going....
</I>&gt;<i>
</I>&gt;<i> Then the problem is most likely in your script. Foe example, the script
</I>&gt;<i> actively doing something while there are no Squid requests to work on
</I>&gt;<i> (instead of blocking while waiting for the next Squid request).
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; For now I left just one cache_peer in configuration and got the new
</I>&gt;<i> error:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; commBind Cannot bind socket FD 28 to [::]: (13) Permission denied
</I>&gt;<i>
</I>&gt;<i> Could be one of the misconfigurations discussed at
</I>&gt;<i>
</I>&gt;<i> <A HREF="https://wiki.squid-cache.org/Features/SmpScale#cannot-bind-socket-fd-nn-to--13-permission-denied">https://wiki.squid-cache.org/Features/SmpScale#cannot-bind-socket-fd-nn-to--13-permission-denied</A>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> HTH,
</I>&gt;<i>
</I>&gt;<i> Alex.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; &#1095;&#1090;, 20 &#1072;&#1087;&#1088;. 2023&#8239;&#1075;. &#1074; 17:21, Alex Rousskov:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     On 4/20/23 04:23, Alexey&#1103;&#1088; Gruzdov wrote:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;      &gt; cache_peer peerG1.com parent 40001 0 no-query no-digest
</I>&gt;<i> name=peerG1
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt; external_acl_type ext_proxy_g1_type %LOGIN %DST
</I>&gt;<i> /usr/local/bin/g1.py
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt; acl proxy_g1_ext_mark_acl  ext_proxy_g1_type
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt; acl proxy_g1_ext_marked_acl  annotate_transaction proxy=g1
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt; acl proxy_peerG1_acl note proxy g1
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt; http_access deny
</I>&gt;<i> proxy_g1_ext_mark_acl  proxy_g1_ext_marked_acl !all
</I>&gt;<i> &gt;      &gt; .....
</I>&gt;<i> &gt;      &gt; others http_access rules
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt; And this above works.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     Glad to hear that. ( If others are going to use the above as a
</I>&gt;<i> guiding
</I>&gt;<i> &gt;     example, I would recommend naming these ACLs very differently, but
</I>&gt;<i> that
</I>&gt;<i> &gt;     is not important to Squid. )
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;      &gt; BUT
</I>&gt;<i> &gt;      &gt; I am worried about why this my external script for ACL  type
</I>&gt;<i> &gt;     loads the
</I>&gt;<i> &gt;      &gt; one of core of CPU to 100%.....???
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     External ACL caching aside, the script will be contacted once for
</I>&gt;<i> every
</I>&gt;<i> &gt;     Squid transaction. Does your script CPU usage go down to zero when
</I>&gt;<i> &gt;     there
</I>&gt;<i> &gt;     is no traffic? If not, then there is a bug in the script itself.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     If you use the script from the command line, without Squid, does it
</I>&gt;<i> &gt;     consume a lot of CPU and/or take a lot of time per fake query? You
</I>&gt;<i> can
</I>&gt;<i> &gt;     adjust the script to log the real query (when the script is used by
</I>&gt;<i> &gt;     Squid), so that you can easily replicate that query when running the
</I>&gt;<i> &gt;     script without Squid...
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     The cache key in your case is (the expansion of) &quot;%LOGIN %DST&quot;. It is
</I>&gt;<i> &gt;     enabled by default IIRC. Look for &quot;cache&quot; related options at
</I>&gt;<i> &gt;     <A HREF="http://www.squid-cache.org/Doc/config/external_acl_type/">http://www.squid-cache.org/Doc/config/external_acl_type/</A>
</I>&gt;<i> &gt;     &lt;<A HREF="http://www.squid-cache.org/Doc/config/external_acl_type/">http://www.squid-cache.org/Doc/config/external_acl_type/</A>&gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;      &gt; ( I used three of workers in config,
</I>&gt;<i> &gt;      &gt; but I can see a six process called like my external helper
</I>&gt;<i> &gt;     script, looks
</I>&gt;<i> &gt;      &gt; like squid runs x2 process for external ACL )
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     See external_acl_type children-* options:
</I>&gt;<i> &gt;     <A HREF="http://www.squid-cache.org/Doc/config/external_acl_type/">http://www.squid-cache.org/Doc/config/external_acl_type/</A>
</I>&gt;<i> &gt;     &lt;<A HREF="http://www.squid-cache.org/Doc/config/external_acl_type/">http://www.squid-cache.org/Doc/config/external_acl_type/</A>&gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     In most environments, I recommend setting all three of them to the
</I>&gt;<i> same
</I>&gt;<i> &gt;     value. Please note that these options are not SMP-aware (yet), so
</I>&gt;<i> Squid
</I>&gt;<i> &gt;     will _not_ divide their values by the number of workers and give each
</I>&gt;<i> &gt;     worker as many children as you state in squid.conf.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;      &gt; Because if I will put the one more group of users (that must to
</I>&gt;<i> use
</I>&gt;<i> &gt;      &gt; another cache_peer ) - I will need to create one more external
</I>&gt;<i> &gt;     script
</I>&gt;<i> &gt;      &gt; that will making to check an existed users from an other DB table
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     Once you get the basic setup above working for one group to your
</I>&gt;<i> &gt;     satisfaction, I would recommend migrating from (one script and one
</I>&gt;<i> &gt;     matching annotate_transaction ACL) per group to a single script for
</I>&gt;<i> all
</I>&gt;<i> &gt;     groups. That single external ACL script will send the right
</I>&gt;<i> &gt;     annotation(s) to Squid.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     HTH,
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     Alex.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;      &gt; &#1089;&#1088;, 19 &#1072;&#1087;&#1088;. 2023&#8239;&#1075;. &#1074; 22:39, Alex Rousskov:
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt;     On 4/19/23 13:30, Alexey&#1103;&#1088; Gruzdov wrote:
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt; cache_peer peerG1.com parent 40001 0 no-query no-digest
</I>&gt;<i> &gt;     name=peerG1
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt; external_acl_type ext_proxy_g1_type %LOGIN %DST
</I>&gt;<i> &gt;     /usr/local/bin/g1.py
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt; acl proxy_g1_ext_acl ext_proxy_g1_type
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt;     OK. I assume that /usr/local/bin/g1.py will only match users
</I>&gt;<i> that
</I>&gt;<i> &gt;      &gt;     should
</I>&gt;<i> &gt;      &gt;     go to cache_peer called peerG1.
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt; acl proxy_g1_ext_acl_mark  annotate_transaction proxy=g1
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt;     Please note that the name of this annotate_transaction ACL --
</I>&gt;<i> &gt;      &gt;     &quot;proxy_g1_ext_acl_mark&quot; -- implies a relationship to the
</I>&gt;<i> &gt;     external ACL
</I>&gt;<i> &gt;      &gt;     named &quot;proxy_g1_ext_acl&quot;, but there is no such relationship.
</I>&gt;<i> &gt;     Squid does
</I>&gt;<i> &gt;      &gt;     not care about ACL names, but this naming problem may
</I>&gt;<i> indicate a
</I>&gt;<i> &gt;      &gt;     misunderstanding. To follow your naming scheme, this ACL
</I>&gt;<i> &gt;     should be
</I>&gt;<i> &gt;      &gt;     called something like &quot;proxy_g1_mark_acl&quot; or
</I>&gt;<i> &gt;     &quot;mark_for_proxy_g1_acl&quot;.
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt; acl proxy_peerG1_acl note proxy g1
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt;     OK. FWIW, a more consistent ACL name would have been
</I>&gt;<i> &gt;      &gt;     &quot;proxy_g1_marked_acl&quot; or &quot;marked_for_proxy_g1_acl&quot;. Again,
</I>&gt;<i> &gt;     Squid does
</I>&gt;<i> &gt;      &gt;     not really care about these names, so use whatever you think
</I>&gt;<i> is
</I>&gt;<i> &gt;      &gt;     consistent/meaningful/etc.
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt; http_access deny proxy_g1_ext_acl !all
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt;     This line has no (positive) effect. Squid will evaluate the
</I>&gt;<i> &gt;     external
</I>&gt;<i> &gt;      &gt;     ACL, but since the rule, as a whole, will never match due to
</I>&gt;<i> &gt;     &quot;!all&quot;,
</I>&gt;<i> &gt;      &gt;     and
</I>&gt;<i> &gt;      &gt;     since the external ACL has no (relevant) side effects, you
</I>&gt;<i> &gt;     can just
</I>&gt;<i> &gt;      &gt;     delete this line from your configuration.
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt;     Needless to say, if you delete this line, then
</I>&gt;<i> &gt;     proxy_g1_ext_acl will be
</I>&gt;<i> &gt;      &gt;     unused, which should tell you that this configuration is not
</I>&gt;<i> &gt;     doing what
</I>&gt;<i> &gt;      &gt;     you want. See below for a fix recommendation.
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt; http_access deny proxy_g1_ext_acl_mark !all
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt;     This line will mark _all_ transactions. You only want to mark
</I>&gt;<i> &gt;      &gt;     transactions that also matched proxy_g1_ext_acl. That &quot;b only
</I>&gt;<i> &gt;     if a&quot;
</I>&gt;<i> &gt;      &gt;     logic is accomplished by using _both_ ACLs in the same rule:
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt;         http_access deny proxy_g1_ext_acl proxy_g1_ext_acl_mark
</I>&gt;<i> !all
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt;     With the above http_access rule (instead of the earlier two),
</I>&gt;<i> &gt;     Squid
</I>&gt;<i> &gt;      &gt;     will
</I>&gt;<i> &gt;      &gt;     evaluate the external ACL, and, if it matches, Squid will
</I>&gt;<i> &gt;     also evaluate
</I>&gt;<i> &gt;      &gt;     the annotation-setting ACL. The whole rule will then be
</I>&gt;<i> &gt;     rejected due to
</I>&gt;<i> &gt;      &gt;     &quot;!all&quot;, but not until it annotates the transaction (if the
</I>&gt;<i> &gt;     external ACL
</I>&gt;<i> &gt;      &gt;     matches). Again, in this sketch, we are using this rule for
</I>&gt;<i> its
</I>&gt;<i> &gt;      &gt;     annotation side effect only.
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt; And this works like I need now....
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt;     AFAICT, if the tests indicate that this configuration works,
</I>&gt;<i> &gt;     then the
</I>&gt;<i> &gt;      &gt;     tests are broken. IMHO, you should fix the tests (while you
</I>&gt;<i> &gt;     have a
</I>&gt;<i> &gt;      &gt;     broken configuration that can be used to test the tests)
</I>&gt;<i> before
</I>&gt;<i> &gt;      &gt;     proceeding with the configuration fix.
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt;     HTH,
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt;     Alex.
</I>&gt;<i> &gt;      &gt;     P.S. Please keep this email thread on squid-users instead of
</I>&gt;<i> &gt;     responding
</I>&gt;<i> &gt;      &gt;     to me personally.
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt; &#1089;&#1088;, 19 &#1072;&#1087;&#1088;. 2023&#8239;&#1075;. &#1074; 21:01, Alexey&#1103;&#1088; Gruzdov:
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;     so, ok  - Lets limit just to one cache peer and one
</I>&gt;<i> single
</I>&gt;<i> &gt;      &gt;     ACL (just
</I>&gt;<i> &gt;      &gt;      &gt;     to understand the logic):
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;       cache_peer peerG1.com parent 40001 0 no-query
</I>&gt;<i> no-digest
</I>&gt;<i> &gt;      &gt;     name=peerG1
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;       external_acl_type ext_proxy_g1_type %LOGIN %DST
</I>&gt;<i> &gt;      &gt;      &gt;     /usr/local/bin/g1.py   (this will answer &quot;OK&quot;  or
</I>&gt;<i> &quot;ERR&quot;,
</I>&gt;<i> &gt;      &gt;     depends if
</I>&gt;<i> &gt;      &gt;      &gt;     user consists in DB)
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;       acl proxy_g1_ext_acl
</I>&gt;<i> &gt;     ext_proxy_g1_type annotate_transaction
</I>&gt;<i> &gt;      &gt;      &gt;     proxy=g1   (If I right understood here is a key point
</I>&gt;<i> &gt;     of how
</I>&gt;<i> &gt;      &gt;     to add
</I>&gt;<i> &gt;      &gt;      &gt;     the tag to transaction related with user)
</I>&gt;<i> &gt;      &gt;      &gt;       acl proxy_peerG1_acl note proxy g1  (here we create
</I>&gt;<i> &gt;     the ACL
</I>&gt;<i> &gt;      &gt;     based
</I>&gt;<i> &gt;      &gt;      &gt;     on the tag and this is fast ACL yet and we should to
</I>&gt;<i> &gt;     use it in
</I>&gt;<i> &gt;      &gt;      &gt;     cache_peer_access)
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;     http_access deny proxy_g1_ext_acl !all
</I>&gt;<i> &gt;      &gt;      &gt;     ......&lt;others http access rules&gt;
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;     cache_peer_access peerG1 allow proxy_peerG1_acl
</I>&gt;<i> &gt;      &gt;      &gt;     cache_peer_access peerG1 deny all
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;     Is that correct ?
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;     &#1074;&#1090;, 18 &#1072;&#1087;&#1088;. 2023&#8239;&#1075;. &#1074; 23:44, Alex Rousskov
</I>&gt;<i> &gt;      &gt;      &gt;     &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>
</I>&gt;<i> &gt;     &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt;
</I>&gt;<i> &gt;      &gt;     &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>
</I>&gt;<i> &gt;     &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt;&gt;
</I>&gt;<i> &gt;      &gt;      &gt;     &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>
</I>&gt;<i> &gt;     &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt;
</I>&gt;<i> &gt;      &gt;     &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>
</I>&gt;<i> &gt;     &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt;&gt;&gt;&gt;:
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;         On 4/18/23 11:41, Alexey&#1103;&#1088; Gruzdov wrote:
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;          &gt; Could you explain me how the annotation
</I>&gt;<i> transaction
</I>&gt;<i> &gt;      &gt;     works and
</I>&gt;<i> &gt;      &gt;      &gt;         how it
</I>&gt;<i> &gt;      &gt;      &gt;          &gt; related to acl that I could to use with
</I>&gt;<i> cache_peers
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;         Transactions have a (possibly empty) set of
</I>&gt;<i> name=value
</I>&gt;<i> &gt;      &gt;     annotations.
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;         During Squid configuration time, Squid parses all
</I>&gt;<i> ACL
</I>&gt;<i> &gt;      &gt;      &gt;         declarations in
</I>&gt;<i> &gt;      &gt;      &gt;         your configuration file. When Squid parses an
</I>&gt;<i> &gt;      &gt;      &gt;         annotation_transaction ACL
</I>&gt;<i> &gt;      &gt;      &gt;         declaration, Squid remembers what transaction
</I>&gt;<i> &gt;     annotation
</I>&gt;<i> &gt;      &gt;     to add
</I>&gt;<i> &gt;      &gt;      &gt;         in the
</I>&gt;<i> &gt;      &gt;      &gt;         future, [every time] when that ACL is evaluated
</I>&gt;<i> (e.g.,
</I>&gt;<i> &gt;      &gt;     used in
</I>&gt;<i> &gt;      &gt;      &gt;         http_access rule that Squid reaches during
</I>&gt;<i> transaction
</I>&gt;<i> &gt;      &gt;     processing).
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;         When evaluated, an &quot;annotation_transaction&quot; ACL
</I>&gt;<i> simply
</I>&gt;<i> &gt;      &gt;     adds the
</I>&gt;<i> &gt;      &gt;      &gt;         previously configured annotation to the current
</I>&gt;<i> &gt;      &gt;     transaction and
</I>&gt;<i> &gt;      &gt;      &gt;         returns
</I>&gt;<i> &gt;      &gt;      &gt;         a &quot;yes, this transaction matches&quot; result.
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;         When evaluated, a &quot;note&quot; ACL returns a &quot;yes, this
</I>&gt;<i> &gt;     transaction
</I>&gt;<i> &gt;      &gt;      &gt;         matches&quot;
</I>&gt;<i> &gt;      &gt;      &gt;         result if and only if the current transaction
</I>&gt;<i> &gt;     already has the
</I>&gt;<i> &gt;      &gt;      &gt;         matching
</I>&gt;<i> &gt;      &gt;      &gt;         annotation. This ACL does not modify the set of
</I>&gt;<i> &gt;     transaction
</I>&gt;<i> &gt;      &gt;      &gt;         annotations.
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;         The combination of annotate_transaction and note
</I>&gt;<i> ACLs
</I>&gt;<i> &gt;      &gt;     allows you to
</I>&gt;<i> &gt;      &gt;      &gt;         annotate a transaction at one time and check
</I>&gt;<i> &gt;     previously set
</I>&gt;<i> &gt;      &gt;      &gt;         transaction
</I>&gt;<i> &gt;      &gt;      &gt;         annotations at another time. The timing and
</I>&gt;<i> &gt;     meaning of those
</I>&gt;<i> &gt;      &gt;      &gt;         annotations
</I>&gt;<i> &gt;      &gt;      &gt;         are up to you.
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;          &gt; ok! Lets look to my case example:
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;          &gt; cache_peer peerG1.com parent 40001 0 no-query
</I>&gt;<i> &gt;     no-digest
</I>&gt;<i> &gt;      &gt;      &gt;         name=peerG1 round-robin
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;          &gt; cache_peer_access  peerG1 allow proxy_peerG1_acl
</I>&gt;<i> &gt;      &gt;      &gt;          &gt; cache_peer_access  peerG1 allow proxy_all_acl
</I>&gt;<i> &gt;      &gt;      &gt;          &gt; cache_peer_access  peerG1 deny all
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;          &gt; acl proxy_peerG1_acl  proxy_auth
</I>&gt;<i> &gt;     &quot;../users.peerG1.txt&quot;
</I>&gt;<i> &gt;      &gt;      &gt;          &gt; acl proxy_all_acl  proxy_auth
</I>&gt;<i> &quot;../users.all.txt&quot;
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;         [ I added the missing &quot;acl &quot; directive to the
</I>&gt;<i> &gt;     above ACL
</I>&gt;<i> &gt;      &gt;      &gt;         declarations and
</I>&gt;<i> &gt;      &gt;      &gt;         stripped rules for two out of three cache_peers ]
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;         As you know, the above cache_peer_access
</I>&gt;<i> &gt;     configuration is not
</I>&gt;<i> &gt;      &gt;      &gt;         supported
</I>&gt;<i> &gt;      &gt;      &gt;         because it uses &quot;slow&quot; proxy_auth ACLs in
</I>&gt;<i> &gt;     cache_peer_access
</I>&gt;<i> &gt;      &gt;      &gt;         directives
</I>&gt;<i> &gt;      &gt;      &gt;         that only support &quot;fast&quot; ACLs. It does not matter
</I>&gt;<i> &gt;     (to me),
</I>&gt;<i> &gt;      &gt;      &gt;         whether the
</I>&gt;<i> &gt;      &gt;      &gt;         above appears to &quot;work&quot; in some environments. YMMV.
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;         To fix this problem, we can use http_access rules
</I>&gt;<i> to
</I>&gt;<i> &gt;      &gt;     essentially
</I>&gt;<i> &gt;      &gt;      &gt;         remember proxy_auth evaluation results (at
</I>&gt;<i> http_access
</I>&gt;<i> &gt;      &gt;      &gt;         evaluation time)
</I>&gt;<i> &gt;      &gt;      &gt;         as transaction annotations. Here is an untested
</I>&gt;<i> &gt;     sketch that
</I>&gt;<i> &gt;      &gt;      &gt;         omits other
</I>&gt;<i> &gt;      &gt;      &gt;         (important but irrelevant here) http_access rules
</I>&gt;<i> &gt;     and assumes
</I>&gt;<i> &gt;      &gt;      &gt;         that these
</I>&gt;<i> &gt;      &gt;      &gt;         sketched http_access rules _are_ evaluated:
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;             # if proxy_peerG1_acl matches, evaluate
</I>&gt;<i> &gt;     mark_for_peerG1
</I>&gt;<i> &gt;      &gt;      &gt;             http_access deny proxy_peerG1_acl
</I>&gt;<i> &gt;     mark_for_peerG1 !all
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;             # if proxy_all_acl matches, evaluate
</I>&gt;<i> &gt;     mark_for_all_peers
</I>&gt;<i> &gt;      &gt;      &gt;             http_access deny proxy_all_acl
</I>&gt;<i> &gt;     mark_for_all_peers !all
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;         Now we can use those remembered proxy_... acl
</I>&gt;<i> &gt;     evaluation
</I>&gt;<i> &gt;      &gt;     results
</I>&gt;<i> &gt;      &gt;      &gt;         (i.e.
</I>&gt;<i> &gt;      &gt;      &gt;         we can check for the matching annotations) in
</I>&gt;<i> &gt;      &gt;     cache_peer_access
</I>&gt;<i> &gt;      &gt;      &gt;         rules:
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;             cache_peer_access peerG1 allow
</I>&gt;<i> marked_for_peerG1
</I>&gt;<i> &gt;      &gt;      &gt;             cache_peer_access peerG1 allow
</I>&gt;<i> &gt;     marked_for_all_peers
</I>&gt;<i> &gt;      &gt;      &gt;             cache_peer_access peerG1 deny all
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;         where the new ACLs mentioned above are declared
</I>&gt;<i> along
</I>&gt;<i> &gt;      &gt;     these lines:
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;             acl mark_for_peerG1 annotate_transaction
</I>&gt;<i> &gt;     for_peer_=G1
</I>&gt;<i> &gt;      &gt;      &gt;             acl mark_for_all_peers annotate_transaction
</I>&gt;<i> &gt;      &gt;     for_all_peers_=true
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;             acl marked_for_peerG1 note for_peer_ G1
</I>&gt;<i> &gt;      &gt;      &gt;             acl marked_for_all_peers note for_all_peers_
</I>&gt;<i> true
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;         This can probably be simplified further by using
</I>&gt;<i> &gt;      &gt;     for_peer_=ALL
</I>&gt;<i> &gt;      &gt;      &gt;         instead
</I>&gt;<i> &gt;      &gt;      &gt;         of for_all_peers_=true annotation, but I wanted to
</I>&gt;<i> &gt;      &gt;     preserve the
</I>&gt;<i> &gt;      &gt;      &gt;         symmetry
</I>&gt;<i> &gt;      &gt;      &gt;         with your original configuration.
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;          &gt; And these all works like I need, But - once I am
</I>&gt;<i> &gt;      &gt;     changing a
</I>&gt;<i> &gt;      &gt;      &gt;         list of
</I>&gt;<i> &gt;      &gt;      &gt;          &gt; users (add or remove) - I need to use &quot;squid -k
</I>&gt;<i> &gt;      &gt;      &gt;         reconfigure&quot;...... but
</I>&gt;<i> &gt;      &gt;      &gt;          &gt; of course better to go without this reconfigure
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;         One can avoid reconfiguration using an external ACL
</I>&gt;<i> &gt;      &gt;     script that
</I>&gt;<i> &gt;      &gt;      &gt;         gives
</I>&gt;<i> &gt;      &gt;      &gt;         Squid the right for_peer_=... annotations (instead
</I>&gt;<i> &gt;     of using
</I>&gt;<i> &gt;      &gt;      &gt;         &quot;constant&quot;
</I>&gt;<i> &gt;      &gt;      &gt;         or &quot;hard-coded&quot; annotate_transaction ACLs to store
</I>&gt;<i> &gt;     the same
</I>&gt;<i> &gt;      &gt;      &gt;         annotations).
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;         However, it may be better to make the above sketch
</I>&gt;<i> &gt;     to work
</I>&gt;<i> &gt;      &gt;      &gt;         _before_ you
</I>&gt;<i> &gt;      &gt;      &gt;         replace mark_for_peerG1 ACLs/rules with an external
</I>&gt;<i> &gt;      &gt;      &gt;         mark_for_the_right_peer ACL.
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;         HTH,
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;         Alex.
</I>&gt;<i> &gt;      &gt;      &gt;         P.S. This thread continues the discussion started
</I>&gt;<i> at
</I>&gt;<i> &gt;      &gt;      &gt; <A HREF="https://bugs.squid-cache.org/show_bug.cgi?id=5268">https://bugs.squid-cache.org/show_bug.cgi?id=5268</A>
</I>&gt;<i> &gt;     &lt;<A HREF="https://bugs.squid-cache.org/show_bug.cgi?id=5268">https://bugs.squid-cache.org/show_bug.cgi?id=5268</A>&gt;
</I>&gt;<i> &gt;      &gt;     &lt;<A HREF="https://bugs.squid-cache.org/show_bug.cgi?id=5268">https://bugs.squid-cache.org/show_bug.cgi?id=5268</A>
</I>&gt;<i> &gt;     &lt;<A HREF="https://bugs.squid-cache.org/show_bug.cgi?id=5268">https://bugs.squid-cache.org/show_bug.cgi?id=5268</A>&gt;&gt;
</I>&gt;<i> &gt;      &gt;      &gt;         &lt;<A HREF="https://bugs.squid-cache.org/show_bug.cgi?id=5268">https://bugs.squid-cache.org/show_bug.cgi?id=5268</A>
</I>&gt;<i> &gt;     &lt;<A HREF="https://bugs.squid-cache.org/show_bug.cgi?id=5268">https://bugs.squid-cache.org/show_bug.cgi?id=5268</A>&gt;
</I>&gt;<i> &gt;      &gt;     &lt;<A HREF="https://bugs.squid-cache.org/show_bug.cgi?id=5268">https://bugs.squid-cache.org/show_bug.cgi?id=5268</A>
</I>&gt;<i> &gt;     &lt;<A HREF="https://bugs.squid-cache.org/show_bug.cgi?id=5268">https://bugs.squid-cache.org/show_bug.cgi?id=5268</A>&gt;&gt;&gt;
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;         _______________________________________________
</I>&gt;<i> &gt;      &gt;      &gt;         squid-users mailing list
</I>&gt;<i> &gt;      &gt;      &gt; <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> &gt;     &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>&gt;
</I>&gt;<i> &gt;      &gt;     &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> &gt;     &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>&gt;&gt;
</I>&gt;<i> &gt;      &gt;      &gt;         &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> &gt;     &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>&gt;
</I>&gt;<i> &gt;      &gt;     &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> &gt;     &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>&gt;&gt;&gt;
</I>&gt;<i> &gt;      &gt;      &gt; <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i> &gt;     &lt;<A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>&gt;
</I>&gt;<i> &gt;      &gt;     &lt;<A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i> &gt;     &lt;<A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>&gt;&gt;
</I>&gt;<i> &gt;      &gt;      &gt;         &lt;<A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i> &gt;     &lt;<A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>&gt;
</I>&gt;<i> &gt;      &gt;     &lt;<A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i> &gt;     &lt;<A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>&gt;&gt;&gt;
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;     --
</I>&gt;<i> &gt;      &gt;      &gt;     &#1057; &#1091;&#1074;&#1072;&#1078;&#1077;&#1085;&#1080;&#1077;&#1084; &#1082; &#1042;&#1072;&#1084;
</I>&gt;<i> &gt;      &gt;      &gt;     &#1040;&#1083;&#1077;&#1082;&#1089;&#1077;&#1081;
</I>&gt;<i> &gt;      &gt;      &gt;     +79043828661
</I>&gt;<i> &gt;      &gt;      &gt;     620000 &#1075;.&#1045;&#1082;&#1072;&#1090;&#1077;&#1088;&#1080;&#1085;&#1073;&#1091;&#1088;&#1075;  2022
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt; --
</I>&gt;<i> &gt;      &gt;      &gt; &#1057; &#1091;&#1074;&#1072;&#1078;&#1077;&#1085;&#1080;&#1077;&#1084; &#1082; &#1042;&#1072;&#1084;
</I>&gt;<i> &gt;      &gt;      &gt; &#1040;&#1083;&#1077;&#1082;&#1089;&#1077;&#1081;
</I>&gt;<i> &gt;      &gt;      &gt; +79043828661
</I>&gt;<i> &gt;      &gt;      &gt; 620000 &#1075;.&#1045;&#1082;&#1072;&#1090;&#1077;&#1088;&#1080;&#1085;&#1073;&#1091;&#1088;&#1075;  2022
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt; --
</I>&gt;<i> &gt;      &gt; &#1057; &#1091;&#1074;&#1072;&#1078;&#1077;&#1085;&#1080;&#1077;&#1084; &#1082; &#1042;&#1072;&#1084;
</I>&gt;<i> &gt;      &gt; &#1040;&#1083;&#1077;&#1082;&#1089;&#1077;&#1081;
</I>&gt;<i> &gt;      &gt; +79043828661
</I>&gt;<i> &gt;      &gt; 620000 &#1075;.&#1045;&#1082;&#1072;&#1090;&#1077;&#1088;&#1080;&#1085;&#1073;&#1091;&#1088;&#1075;  2022
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt; _______________________________________________
</I>&gt;<i> &gt;      &gt; squid-users mailing list
</I>&gt;<i> &gt;      &gt; <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> &gt;     &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>&gt;
</I>&gt;<i> &gt;      &gt; <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i> &gt;     &lt;<A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>&gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     _______________________________________________
</I>&gt;<i> &gt;     squid-users mailing list
</I>&gt;<i> &gt;     <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> &gt;     &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>&gt;
</I>&gt;<i> &gt;     <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i> &gt;     &lt;<A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>&gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; _______________________________________________
</I>&gt;<i> &gt; squid-users mailing list
</I>&gt;<i> &gt; <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> &gt; <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20230420/064c81fc/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20230420/064c81fc/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="025792.html">[squid-users] cache_peer_access by dynamic ACL
</A></li>
	<LI>Next message (by thread): <A HREF="025794.html">[squid-users] Fwd: cache_peer_access by dynamic ACL
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25793">[ date ]</a>
              <a href="thread.html#25793">[ thread ]</a>
              <a href="subject.html#25793">[ subject ]</a>
              <a href="author.html#25793">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
