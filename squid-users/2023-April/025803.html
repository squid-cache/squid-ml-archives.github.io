<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] %LOGIN place in squid 5.8 acls
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20%25LOGIN%20place%20in%20squid%205.8%20acls&In-Reply-To=%3C355cad4a-5362-ee10-7c15-c8b77682d2f8%40articatech.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="025801.html">
   <LINK REL="Next"  HREF="025808.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] %LOGIN place in squid 5.8 acls</H1>
    <B>David Touzeau</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20%25LOGIN%20place%20in%20squid%205.8%20acls&In-Reply-To=%3C355cad4a-5362-ee10-7c15-c8b77682d2f8%40articatech.com%3E"
       TITLE="[squid-users] %LOGIN place in squid 5.8 acls">david at articatech.com
       </A><BR>
    <I>Mon Apr 24 12:14:35 UTC 2023</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="025801.html">[squid-users] %LOGIN place in squid 5.8 acls
</A></li>
        <LI>Next message (by thread): <A HREF="025808.html">[squid-users] %LOGIN place in squid 5.8 acls
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25803">[ date ]</a>
              <a href="thread.html#25803">[ thread ]</a>
              <a href="subject.html#25803">[ subject ]</a>
              <a href="author.html#25803">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Thanks Amos for the mistake, yes my explains was wrong.
Your are right, the first object !allowed_domains matches, so squid 
usually compute the second object. This an expected behavior.

According your suggest my problem was the first rule &quot;http_access allow 
noauth_sites&quot; in first place.
yes, it will allow requests but, requests will be allowed for all other 
rules too.
It make sense, why compute all others rules if the first one is allowed ?

if a add office365.com in noauth_sites object but i did not want 
office365.com for limited_users, the noauth_sites in first place will 
disable all &quot;deny&quot; rules.

I'm wrong ?


On 24/04/2023 11:22, Amos Jeffries wrote:
&gt;<i> On 24/04/2023 11:33 am, David Touzeau wrote:
</I>&gt;&gt;<i> We have a &quot;problem&quot; with ACLs, and I don't know how to address this 
</I>&gt;&gt;<i> situation in Squid 5.8
</I>&gt;&gt;<i> Let me explain:
</I>&gt;&gt;<i> We have an Active Directory group named limited_users that is only 
</I>&gt;&gt;<i> allowed to surf on a very limited list of websites.
</I>&gt;&gt;<i> These users are therefore forbidden to surf on all sites not listed 
</I>&gt;&gt;<i> in allowed_domains
</I>&gt;&gt;<i> On the other hand, we have websites in noauth_sites that do not need 
</I>&gt;&gt;<i> to be authenticated by squid but are not allowed to be used by 
</I>&gt;&gt;<i> limited_users group
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> In logic, we would write the following ACLs.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> external_acl_type ads_group ttl=3600 negative_ttl=1 concurrency=50 
</I>&gt;&gt;<i> children-startup=1 children-idle=1 children-max=20 ipv4 %LOGIN 
</I>&gt;&gt;<i> /lib/squid3/groups.pl
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> acls limited_users ads_group limited_users
</I>&gt;<i>
</I>&gt;<i> This acl requires both login to succeed and group to match in order to 
</I>&gt;<i> return MATCH.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> acls allowed_domains dstdomain siteallowed.com
</I>&gt;&gt;<i> acls allowed_domains dstdomain siteallowed.fr
</I>&gt;&gt;<i> acls allowed_domains dstdomain siteallowed.ch
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> acls noauth_sites dstdomain office365.com
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> http_access deny !allowed_domains limited_users all #ACL1
</I>&gt;&gt;<i> http_access allow noauth_sites #ACL2
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> But in this case, accessing to office365.com force Squid to send the 
</I>&gt;&gt;<i> 407 Authentication&#160; request in order to calculate the limited_users 
</I>&gt;&gt;<i> in&#160; #ACL1, then the second ACL is not effective because the request 
</I>&gt;&gt;<i> is blocked before by the 407.
</I>&gt;<i>
</I>&gt;<i> Sounds correct.
</I>&gt;<i>
</I>&gt;&gt;<i> The %LOGIN switch in the external ACL ads_group activates the 
</I>&gt;&gt;<i> identification mode.
</I>&gt;<i>
</I>&gt;<i> Yes.
</I>&gt;<i>
</I>&gt;&gt;<i> If we use the %un switch instead , it works but it becomes the 
</I>&gt;&gt;<i> counter, ACL#1 is not processed anymore since the authentication is 
</I>&gt;&gt;<i> not requested because the %un switch is too smooth.
</I>&gt;<i>
</I>&gt;<i> Yes. The login is not existing, therefore has no group.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> What I don't understand is that SQUID is trying to calculate the 
</I>&gt;&gt;<i> limited_user object when the first allowed_domain object already 
</I>&gt;&gt;<i> returns FALSE.
</I>&gt;<i>
</I>&gt;<i> You configured the &quot;!&quot; (not) operator to invert the match result.
</I>&gt;<i> Returning FALSE becomes a MATCH.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> Whatever the result of the objects that follow allowed_domain, the 
</I>&gt;&gt;<i> rule will always fail.
</I>&gt;<i>
</I>&gt;<i> Not quite. A request that provides credentials associated with the 
</I>&gt;<i> expected group will pass.
</I>&gt;<i>
</I>&gt;&gt;<i> In the case where limited_user is in the first place, the logic is 
</I>&gt;&gt;<i> correct.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Two questions:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Is there a way for SQUID to not compute all http_access objects if 
</I>&gt;&gt;<i> the first one fails?
</I>&gt;<i>
</I>&gt;<i> No. Because there is more than one HTTP request going on here. Each 
</I>&gt;<i> request is independent for Squid.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> What would be the best rule that could meet this goal?
</I>&gt;<i>
</I>&gt;<i> Structure your access lines as such;
</I>&gt;<i>
</I>&gt;<i> &#160; # things not requiring login are checked first
</I>&gt;<i> &#160; http_access allow noauth_sites
</I>&gt;<i>
</I>&gt;<i> &#160; # then do the login
</I>&gt;<i> &#160; http_access deny !login
</I>&gt;<i>
</I>&gt;<i> &#160; # then check things that need login
</I>&gt;<i> &#160; http_access deny limited_users !allowed_sites
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> HTH
</I>&gt;<i> Amos
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>
-- 
David Touzeau - Artica Tech France
Development team, level 3 support
----------------------------------
P: +33 6 58 44 69 46
www:<A HREF="https://wiki.articatech.com">https://wiki.articatech.com</A>
www:<A HREF="http://articatech.net">http://articatech.net</A>  
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20230424/1ba1bf42/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20230424/1ba1bf42/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="025801.html">[squid-users] %LOGIN place in squid 5.8 acls
</A></li>
	<LI>Next message (by thread): <A HREF="025808.html">[squid-users] %LOGIN place in squid 5.8 acls
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25803">[ date ]</a>
              <a href="thread.html#25803">[ thread ]</a>
              <a href="subject.html#25803">[ subject ]</a>
              <a href="author.html#25803">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
