From frizquierdo87 at gmail.com  Tue Aug  1 03:37:30 2023
From: frizquierdo87 at gmail.com (Francisco)
Date: Mon, 31 Jul 2023 23:37:30 -0400
Subject: [squid-users] How to apply a low delay_pool to users that become
 OVERCUOTE, over certains domains and sites.
Message-ID: <CAJXDObbpAtTA5jAVWvGHSujC__wOS9Za89ZS+jvcpT3DGXdF_Q@mail.gmail.com>

I have an external ACL that check if users are OVERCUOTE (exceed assigned
cuote in MB), on this case those users can't browser certains domains and
sites specified in certain acl (domains_cuote, parcials_domains_cuote,
sites_cuote). The problem is that Squid doesn't interrupt stablished
connections for example youtube video play and OVERCUOTE user continue
video reproduction until  the video it is not finished (I'm not referring
to the case of the buffer that the video player managed to load before the
user became OVERCUOTE), although the rest of web browsing is limited
correctly, and his account is marked as exceeded (OVERCUOTE).

I need a delay_pool to OVERCUOTE users for reduce to minimun (for example
1Kbit/s) the download rate over specifcs domains and sites until the user
cuote will be restablished,
For this scenario i have an internet link with only 2Mbps (very poor).

I need help with possible delay pools config that help me. I don't
understand very well delays_pool
The idea is that the delay_pool limits web browsing on the domains and
sites specified by the acl for users exceeding the assigned quota.

## Auth config
auth_param basic program /usr/lib/squid/basic_db_auth --dsn
"DBI:mysql:database=squidmgr" --user dbuser --password dbpassword --table
"proxy_user" --usercol "squid_user_identifier" --passwdcol "passwd" --cond
"enabled = 1" --md5 --persist
auth_param basic children 15 startup=10 idle=1
auth_param basic realm Web-Proxy
auth_param basic credentialsttl 30 minute
auth_param basic casesensitive on
authenticate_ip_ttl 30 minute

acl AUTHENTICATED proxy_auth REQUIRED

##ACL check if user is cuote exceeded. An external script count users
consumption every xx seconds and update database, it work successfull.
external_acl_type CHECKOVERCUOTE concurrency=100 ttl=3 children-max=50
children-startup=15 children-idle=5  %LOGIN
/usr/lib/squid/ext_sql_session_acl --dsn "DBI:mysql:database=squidmgr"
--user dbuser --password dbpassword --table "proxy_user" --uidcol
"squid_user_identifier" --usercol "squid_user_identifier" --cond "overcuote
= 1"
acl OVERCUOTE external CHECKOVERCUOTE

## Resources to take in user cuote
acl domains_cuote dstdomain "/etc/squid/resources/domains_cuote.db"
acl parcials_domains_cuote dstdomain
"/etc/squid/resources/parcials_domains_cuote.db"
acl sites_cuote url_regex -i "/etc/squid/resources/sites_cuote.db"

## RULES
http_access allow !domains_cuote !OVERCUOTE
http_access allow !parcials_domains_cuote !OVERCUOTE
http_access allow !sites_cuote !OVERCUOTE

http_access allow CONNECT SSL_ports !domains_cuote !OVERCUOTE
http_access allow CONNECT SSL_ports !parcials_domains_cuote !OVERCUOTE
http_access allow CONNECT SSL_ports !sites_cuote !OVERCUOTE

deny_info https://proxy.lan/proxyerrors?type=OVERCUOTE CONNECT SSL_ports
domains_cuote OVERCUOTE
deny_info https://proxy.lan/proxyerrors?type=OVERCUOTE CONNECT SSL_ports
parcials_domains_cuote OVERCUOTE
deny_info https://proxy.lan/proxyerrors?type=OVERCUOTE CONNECT SSL_ports
sites_cuote OVERCUOTE

deny_info http://proxy.lan/proxyerrors?type=OVERCUOTE domains_cuote
OVERCUOTE
deny_info http://proxy.lan/proxyerrors?type=OVERCUOTE
parcials_domains_cuote OVERCUOTE
deny_info http://proxy.lan/proxyerrors?type=OVERCUOTE sites_cuote OVERCUOTE

http_access allow AUTHENTICATED
http_access deny all
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230731/a8d527a4/attachment.htm>

From botpena at gmail.com  Tue Aug  1 05:27:37 2023
From: botpena at gmail.com (botp)
Date: Tue, 1 Aug 2023 13:27:37 +0800
Subject: [squid-users] compile error in squid v6.1
In-Reply-To: <202307311731.06579.Antony.Stone@squid.open.source.it>
References: <CAAwHHQjgZ-v61t0uH5kJSraWzMXVK3qRUnv2v0M7F_yop6OQ0g@mail.gmail.com>
 <202307311731.06579.Antony.Stone@squid.open.source.it>
Message-ID: <CAAwHHQgadWMfcKGfbkRL7zftBObSvymajAQ4fNJ1Sjji00tobA@mail.gmail.com>

On Mon, Jul 31, 2023 at 11:31?PM Antony Stone <
Antony.Stone at squid.open.source.it> wrote:

> It might help to tell us what sort of system you're compiling it on:
>
>  - operating system
>  - version
>  - compiler name
>  - compiler version
>

oops, yes, Antony.

$ lsb_release -a && uname -an && gcc -v
No LSB modules are available.
Distributor ID: Ubuntu
Description:    Ubuntu 18.04.6 LTS
Release:        18.04
Codename:       bionic

Linux pc-ni-botp 5.4.0-150-generic #167~18.04.1-Ubuntu SMP Wed May 24
00:51:42 UTC 2023 x86_64 x86_64 x86_64 GNU/Linux

Using built-in specs.
COLLECT_GCC=gcc
COLLECT_LTO_WRAPPER=/usr/lib/gcc/x86_64-linux-gnu/7/lto-wrapper
OFFLOAD_TARGET_NAMES=nvptx-none
OFFLOAD_TARGET_DEFAULT=1
Target: x86_64-linux-gnu
Configured with: ../src/configure -v --with-pkgversion='Ubuntu
7.5.0-3ubuntu1~18.04' --with-bugurl=file:///usr/share/doc/gcc-7/README.Bugs
--enable-languages=c,ada,c++,go,brig,d,fortran,objc,obj-c++ --prefix=/usr
--with-gcc-major-version-only --program-suffix=-7
--program-prefix=x86_64-linux-gnu- --enable-shared --enable-linker-build-id
--libexecdir=/usr/lib --without-included-gettext --enable-threads=posix
--libdir=/usr/lib --enable-nls --enable-bootstrap --enable-clocale=gnu
--enable-libstdcxx-debug --enable-libstdcxx-time=yes
--with-default-libstdcxx-abi=new --enable-gnu-unique-object
--disable-vtable-verify --enable-libmpx --enable-plugin
--enable-default-pie --with-system-zlib --with-target-system-zlib
--enable-objc-gc=auto --enable-multiarch --disable-werror
--with-arch-32=i686 --with-abi=m64 --with-multilib-list=m32,m64,mx32
--enable-multilib --with-tune=generic --enable-offload-targets=nvptx-none
--without-cuda-driver --enable-checking=release --build=x86_64-linux-gnu
--host=x86_64-linux-gnu --target=x86_64-linux-gnu
Thread model: posix

gcc version 7.5.0 (Ubuntu 7.5.0-3ubuntu1~18.04)


thanks and best regards,
--botp
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230801/ec9f7baa/attachment.htm>

From botpena at gmail.com  Tue Aug  1 05:32:55 2023
From: botpena at gmail.com (botp)
Date: Tue, 1 Aug 2023 13:32:55 +0800
Subject: [squid-users] compile error in squid v6.1
In-Reply-To: <575eb2df-c8f5-6c93-6aad-8ce4c5cf385e@measurement-factory.com>
References: <CAAwHHQjgZ-v61t0uH5kJSraWzMXVK3qRUnv2v0M7F_yop6OQ0g@mail.gmail.com>
 <575eb2df-c8f5-6c93-6aad-8ce4c5cf385e@measurement-factory.com>
Message-ID: <CAAwHHQjCGue9mwkrCSS1xyyLYJKY2jj44Y+PJLQWXjV7M0HLHA@mail.gmail.com>

On Tue, Aug 1, 2023 at 12:05?AM Alex Rousskov <
rousskov at measurement-factory.com> wrote:

>
> IIRC, this error implies that your compiler does not fully support
> C++17. Squid v6 requires decent C++17 support.
>
> If I am right, then you will need to use a different/modern compiler
> (but consider filing an enhancement request with Squid Bugzilla to
> improve Squid handling of this specific problem -- our ./configure
> should fail with a user-friendly error instead of the current outcome).
>
>
you are probably right, Alex. I will upgrade my compiler and inform the
list of the result.

thanks and kind regards,
--botp
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230801/8cac95d7/attachment.htm>

From botpena at gmail.com  Tue Aug  1 06:27:24 2023
From: botpena at gmail.com (botp)
Date: Tue, 1 Aug 2023 14:27:24 +0800
Subject: [squid-users] compile error in squid v6.1
In-Reply-To: <CAAwHHQjCGue9mwkrCSS1xyyLYJKY2jj44Y+PJLQWXjV7M0HLHA@mail.gmail.com>
References: <CAAwHHQjgZ-v61t0uH5kJSraWzMXVK3qRUnv2v0M7F_yop6OQ0g@mail.gmail.com>
 <575eb2df-c8f5-6c93-6aad-8ce4c5cf385e@measurement-factory.com>
 <CAAwHHQjCGue9mwkrCSS1xyyLYJKY2jj44Y+PJLQWXjV7M0HLHA@mail.gmail.com>
Message-ID: <CAAwHHQjJU0uTQ_3bJaO24883VcVFNz7c1EYQeV==L9K6XO__6Q@mail.gmail.com>

On Tue, Aug 1, 2023 at 1:32?PM botp <botpena at gmail.com> wrote:

> On Tue, Aug 1, 2023 at 12:05?AM Alex Rousskov <
> rousskov at measurement-factory.com> wrote:
>
>> IIRC, this error implies that your compiler does not fully support
>> C++17. Squid v6 requires decent C++17 support.
>>
>> you are probably right, Alex. I will upgrade my compiler and inform the
> list of the result.
>

Indeed, you are right, Alex. I installed and tested two versions of the
compiler: gcc-8.4 and gcc-9.2.1, and they both worked flawlessly! (and that
makes gcc-7.5 as a no-go for squid 6.1)

thanks again and best regards,
--botp
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230801/edde92ee/attachment.htm>

From idanm at r-stealth.com  Wed Aug  2 10:40:56 2023
From: idanm at r-stealth.com (Idan Mashiach)
Date: Wed, 2 Aug 2023 10:40:56 +0000
Subject: [squid-users] Range Requests
Message-ID: <VI1PR10MB179245E8A32718F100EAB4F3F60BA@VI1PR10MB1792.EURPRD10.PROD.OUTLOOK.COM>

Hey there!
We are using Squid for caching downloaded files from our buckets using presinged URLs.
Sometimes we have large files, and for those files we are using range requests to download it in parts.
Unfortunately, we didn't managed to configure Squid to cache those partial requests.
Do Squid support caching range requests, and if so, how we can configure it to do so?
Thanks!


This e-mail message is intended only for the personal use of the recipient(s) named above. If you are not an intended recipient, you may not review, copy or distribute this message. If you have received this communication in error, please notify us immediately by e-mail and delete the original message.This e-mail message is intended only for the personal use of the recipient(s) named above. If you are not an intended recipient, you may not review, copy or distribute this message. If you have received this communication in error, please notify us immediately by e-mail and delete the original message.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230802/a8326a03/attachment.htm>

From rousskov at measurement-factory.com  Wed Aug  2 12:57:38 2023
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Wed, 2 Aug 2023 08:57:38 -0400
Subject: [squid-users] Range Requests
In-Reply-To: <VI1PR10MB179245E8A32718F100EAB4F3F60BA@VI1PR10MB1792.EURPRD10.PROD.OUTLOOK.COM>
References: <VI1PR10MB179245E8A32718F100EAB4F3F60BA@VI1PR10MB1792.EURPRD10.PROD.OUTLOOK.COM>
Message-ID: <52542689-5c98-e77a-59d9-1104c1397768@measurement-factory.com>

On 8/2/23 06:40, Idan Mashiach wrote:

> We are using Squid for caching downloaded files from our buckets using 
> presinged URLs.
> Sometimes we have large files, and for those files we are using range 
> requests to download it in parts.
> Unfortunately, we didn't managed to configure Squid to cache those 
> partial requests.
> Do Squid support caching range requests, and if so, how we can configure 
> it to do so?

No, Squid does not cache HTTP 206 (Partial Content) responses (yet?).

Alex.



From rousskov at measurement-factory.com  Wed Aug  2 14:16:06 2023
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Wed, 2 Aug 2023 10:16:06 -0400
Subject: [squid-users] Problem with 6.1 squidclient mgr:
In-Reply-To: <e610c30d-12ea-e703-7b95-7ddd6bf1021b@measurement-factory.com>
References: <CAJ6qB7KemeYiTdmYT0hkJ9TE9KD5X8Wk=i9Bv2RJZchDHcfcmQ@mail.gmail.com>
 <e610c30d-12ea-e703-7b95-7ddd6bf1021b@measurement-factory.com>
Message-ID: <52c05fbc-ffb3-aa2b-733c-ec2345665689@measurement-factory.com>

On 7/31/23 09:47, Alex Rousskov wrote:
> On 7/31/23 06:13, G?rard Parat wrote:
> 
>> I use Squid as a Windows 10 service with Cygwin since 5.7 release.
>>
>> I usually monitor activity with squidclient mgr: but since 6.1 it
>> doesn't work anymore:
>>
>> ?? * HTTP/1.1 403 Forbidden
>>
>> However, squidclient cache_object://localhost/ is working fine.
>>
>> Is there new options to add to squid.conf to access mgr: ?
> 
> Does your Squid identify itself as "localhost" in Via headers and other 
> output? If not, you are probably suffering from bug #5283:
> https://bugs.squid-cache.org/show_bug.cgi?id=5283
> 
> There are several workarounds, including Squid patches, but no long-term 
> solution yet. If you do not want to patch Squid, use "squidclient -h..." 
> as suggested at https://bugs.squid-cache.org/show_bug.cgi?id=5283#c1

Just an update in case somebody else suffers from this problem and reads 
this thread: After looking through G?rard's debugging logs, I can 
confirm that this setup suffers from Squid bug #5283, and that 
"squidclient -h" workaround helps. However, that workaround is not 
sufficient in this particular use case because

1. Like many Squids, this Squid is configured to allow manager requests 
sent from localhost only. When "squidclient -h example.text mgr:info" 
runs on the same host as Squid, and example.test resolves to something 
other than a localhost address (e.g., 192.168.28.150), squidclient 
connects from that other IP address, and Squid denies that request 
because the manager ACL matches but the localhost ACL does not.

2. On Linux, the problem in item 1 above can be overcome by telling 
squidclient (that runs on the same host as Squid) to connect from 
127.0.0.1 or another localhost address. For example:

     squidclient -v -l 127.0.0.1 -h example.text mgr:info

However, in some environments (e.g., Windows 10?), it is not possible to 
connect from 127.0.0.1 to, say, 192.168.28.150, even if both IPs belong 
to the same host where squidclient is executed. In those environments, 
forcing source address results in a squidclient TCP connection 
establishment failure:

     $ squidclient -v -l 127.0.0.1 -h example.text mgr:info
     ...
     Transport detected: IPv4-mapped  and IPv6
     Resolving 127.0.0.1 ...
     Resolving... example.test
     Connecting... example.test (192.168.28.150:3128)
     ERROR: Cannot connect to 192.168.28.150:3128

Some client have "resolve DNS name X as IP address Y" features (e.g., 
"curl --resolve") that can be used to work around item 2 problems, but 
squidclient lacks those.


HTH,

Alex.

--- cache.log analysis ---

All three cases below were handled as I would expect them to be handled 
given the current set of known Squid problems. SelfName or 
"example.test" is the host name that this Squid identifies itself as *in 
cache manager request handling context*. In general, SelfName may be 
different from the name used in Via and Cache-Status headers, 
complicating the issues further. In this setup, they are the same.


## Case A: Request not matching SelfName of the receiving Squid

     $ squidclient mgr:info

     ... HTTP Client local=[::1]:3128 remote=[::1]
     GET http://localhost:3128/squid-internal-mgr/info HTTP/1.0
     Host: localhost:3128
     User-Agent: squidclient/6.1


The above squidclient request is not recognized as a request to the 
cache manager of the receiving Squid because receiving Squid's SelfName 
is example.test rather than localhost. Squid bug #5283 is relevant here.

Receiving Squid (let's call it Squid A) forwards the above request to 
the server at localhost:3128 address (let's call that Squid B). In this 
test, Squid A and Squid B are the same Squid instance, but Squid 
forwarding code does not know that. Forwarding a request from Squid A 
instance to (the same) Squid B instance creates a forwarding loop:

     2023/08/01 11:14:15| WARNING: Forwarding loop detected for:
     GET /squid-internal-mgr/info HTTP/1.1
     Host: example.test:3128
     User-Agent: squidclient/6.1
     Via: 1.0 example.test (squid/6.1)

Squid B denies the request because Squid B has detected the above 
forwarding loop and all forwarding loops are blocked:

     HTTP/1.1 403 Forbidden
     Server: squid/6.1
     X-Squid-Error: ERR_ACCESS_DENIED 0
     Cache-Status: example.test;detail=mismatch
     Via: 1.1 example.test (squid/6.1)

Squid A forwards the above denial response to squidclient (note the two 
Cache-Status fields and two Via field values):

     HTTP/1.1 403 Forbidden
     Server: squid/6.1
     X-Squid-Error: ERR_ACCESS_DENIED 0
     Cache-Status: example.test;detail=mismatch
     Via: 1.1 example.test (squid/6.1),
          1.1 example.test (squid/6.1)
     Cache-Status: example.test;detail=no-cache


## Case B: Not-from-localhost request

     $ squidclient -h example.test mgr:info

     ... HTTP Client local=192.168.28.150:3128 remote=192.168.28.150
     GET http://example.test:3128/squid-internal-mgr/info HTTP/1.0
     Host: example.test:3128
     User-Agent: squidclient/6.1

The above squidclient request is recognized as a request to the cache 
manager of the receiving Squid and denied because access is from 
192.168.28.150 rather than localhost.

     HTTP/1.1 403 Forbidden
     X-Squid-Error: ERR_ACCESS_DENIED 0
     Cache-Status: example.test
     Via: 1.1 example.test (squid/6.1)


## Case C: Request using a relative URL

     $ curl http://localhost:3128/squid-internal-mgr/info

     ... HTTP Client local=127.0.0.1:3128 remote=127.0.0.1
     GET /squid-internal-mgr/info HTTP/1.1
     Host: localhost:3128
     User-Agent: Mozilla/5.0...

The above browser request was recognized as a request to the cache 
manager of the receiving Squid because the receiving Squid ignores the 
Host header when receiving a relative URL and creates an absolute URL 
with its own SelfName:

     checking 'http://example.test:3128/squid-internal-mgr/info'

This is a known Squid bug already marked in Squid sources. If that bug 
is fixed (without any other fixes), the above to-localhost request would 
be denied as well.

That refactored URL matches SelfName, of course. The request came from a 
localhost-matching address. It is allowed/processed:

     HTTP/1.1 200 OK
     Server: squid/6.1
     Cache-Status: example.test;detail=mismatch
     Via: 1.1 example.test (squid/6.1)




From dm at belkam.com  Mon Aug  7 08:00:15 2023
From: dm at belkam.com (Dmitry Melekhov)
Date: Mon, 7 Aug 2023 12:00:15 +0400
Subject: [squid-users] squid 6.1 esi compile error, ubuntu 22.04
Message-ID: <9c02114b-8244-d595-0fe3-3a97dfd42b75@belkam.com>

Hello!


Built? using --disable-esi without problems.



Could you tell me what can cause this?



/bin/bash ../../libtool? --tag=CXX?? --mode=compile g++ -std=c++17 
-DHAVE_CONFIG_H -DDEFAULT_CONFIG_FILE=\"/etc/squid/squid.conf\" 
-DDEFAULT_SQUID_DATA_DIR=\"/usr/share/squid\" 
-DDEFAULT_SQUID_CONFIG_DIR=\"/etc/squid\"?? -I../.. -I../../include 
-I../../lib -I../../src -I../../include? -isystem /usr/include/mit-krb5 
-isystem /usr/include/mit-krb5 -I../../libltdl? -Wall -Wextra 
-Wimplicit-fallthrough=5 -Wpointer-arith -Wwrite-strings -Wcomments 
-Wshadow -Wmissing-declarations -Woverloaded-virtual -Werror -pipe 
-D_REENTRANT -m64??? -g -O2 -MT Libxml2Parser.lo -MD -MP -MF 
$depbase.Tpo -c -o Libxml2Parser.lo Libxml2Parser.cc &&\
mv -f $depbase.Tpo $depbase.Plo
libtool: compile:? g++ -std=c++17 -DHAVE_CONFIG_H 
-DDEFAULT_CONFIG_FILE=\"/etc/squid/squid.conf\" 
-DDEFAULT_SQUID_DATA_DIR=\"/usr/share/squid\" 
-DDEFAULT_SQUID_CONFIG_DIR=\"/etc/squid\" -I../.. -I../../include 
-I../../lib -I../../src -I../../include -isystem /usr/include/mit-krb5 
-isystem /usr/include/mit-krb5 -I../../libltdl -Wall -Wextra 
-Wimplicit-fallthrough=5 -Wpointer-arith -Wwrite-strings -Wcomments 
-Wshadow -Wmissing-declarations -Woverloaded-virtual -Werror -pipe 
-D_REENTRANT -m64 -g -O2 -MT Libxml2Parser.lo -MD -MP -MF 
.deps/Libxml2Parser.Tpo -c Libxml2Parser.cc? -fPIC -DPIC -o 
.libs/Libxml2Parser.o
In file included from Libxml2Parser.cc:20:
../../src/esi/Libxml2Parser.h:66:13: error: 'xmlParserCtxtPtr' does not 
name a type
 ?? 66 |???? mutable xmlParserCtxtPtr parser; /* our parser */
 ????? |???????????? ^~~~~~~~~~~~~~~~
Libxml2Parser.cc:45:8: error: 'htmlDocPtr' does not name a type
 ?? 45 | static htmlDocPtr entity_doc = nullptr;
 ????? |??????? ^~~~~~~~~~
Libxml2Parser.cc:51:43: error: 'xmlChar' does not name a type
 ?? 51 | esi_startElementSAXFunc(void * ctx, const xmlChar * name, const 
xmlChar ** atts)
 ????? |?????????????????????????????????????????? ^~~~~~~
Libxml2Parser.cc:51:65: error: 'xmlChar' does not name a type
 ?? 51 | esi_startElementSAXFunc(void * ctx, const xmlChar * name, const 
xmlChar ** atts)
| ^~~~~~~
Libxml2Parser.cc: In function 'void esi_startElementSAXFunc(void*, const 
int*, const int**)':
Libxml2Parser.cc:54:5: error: 'xmlChar' was not declared in this scope
 ?? 54 |???? xmlChar **tmp = (xmlChar **)atts;
 ????? |???? ^~~~~~~
Libxml2Parser.cc:54:15: error: 'tmp' was not declared in this scope; did 
you mean 'tm'?
 ?? 54 |???? xmlChar **tmp = (xmlChar **)atts;
 ????? |?????????????? ^~~
 ????? |?????????????? tm
Libxml2Parser.cc:54:32: error: expected primary-expression before ')' token
 ?? 54 |???? xmlChar **tmp = (xmlChar **)atts;
 ????? |??????????????????????????????? ^
Libxml2Parser.cc: At global scope:
Libxml2Parser.cc:70:40: error: 'xmlChar' does not name a type
 ?? 70 | esi_endElementSAXFunc(void *ctx, const xmlChar *name)
 ????? |??????????????????????????????????????? ^~~~~~~
Libxml2Parser.cc:77:37: error: 'xmlChar' does not name a type
 ?? 77 | esi_commentSAXFunc(void *ctx, const xmlChar *value)
 ????? |???????????????????????????????????? ^~~~~~~
Libxml2Parser.cc:84:40: error: 'xmlChar' does not name a type
 ?? 84 | esi_charactersSAXFunc(void *ctx, const xmlChar *ch, int len)
 ????? |??????????????????????????????????????? ^~~~~~~
Libxml2Parser.cc:90:8: error: 'xmlEntityPtr' does not name a type
 ?? 90 | static xmlEntityPtr
 ????? |??????? ^~~~~~~~~~~~
Libxml2Parser.cc: In constructor 
'ESILibxml2Parser::ESILibxml2Parser(ESIParserClient*)':
Libxml2Parser.cc:110:5: error: 'xmlSAXHandler' was not declared in this 
scope
 ? 110 |???? xmlSAXHandler sax;
 ????? |???? ^~~~~~~~~~~~~
Libxml2Parser.cc:111:5: error: 'xmlInitParser' was not declared in this 
scope
 ? 111 |???? xmlInitParser();
 ????? |???? ^~~~~~~~~~~~~
Libxml2Parser.cc:112:13: error: 'sax' was not declared in this scope; 
did you mean 'max'?
 ? 112 |???? memset(&sax, 0, sizeof(sax));
 ????? |???????????? ^~~
 ????? |???????????? max
Libxml2Parser.cc:117:21: error: 'esi_getEntitySAXFunc' was not declared 
in this scope
 ? 117 |???? sax.getEntity = esi_getEntitySAXFunc;
 ????? |???????????????????? ^~~~~~~~~~~~~~~~~~~~
Libxml2Parser.cc:120:5: error: 'parser' was not declared in this scope; 
did you mean 'Parser'?
 ? 120 |???? parser = xmlCreatePushParserCtxt(&sax, static_cast<void 
*>(this), nullptr, 0, nullptr);
 ????? |???? ^~~~~~
 ????? |???? Parser
Libxml2Parser.cc:120:14: error: 'xmlCreatePushParserCtxt' was not 
declared in this scope
 ? 120 |???? parser = xmlCreatePushParserCtxt(&sax, static_cast<void 
*>(this), nullptr, 0, nullptr);
 ????? |????????????? ^~~~~~~~~~~~~~~~~~~~~~~
Libxml2Parser.cc:122:9: error: 'entity_doc' was not declared in this scope
 ? 122 |???? if (entity_doc == nullptr)
 ????? |???????? ^~~~~~~~~~
Libxml2Parser.cc:123:22: error: 'htmlNewDoc' was not declared in this scope
 ? 123 |???????? entity_doc = htmlNewDoc(nullptr, nullptr);
 ????? |????????????????????? ^~~~~~~~~~
Libxml2Parser.cc: In destructor 'virtual 
ESILibxml2Parser::~ESILibxml2Parser()':
Libxml2Parser.cc:128:23: error: 'parser' was not declared in this scope; 
did you mean 'Parser'?
 ? 128 |???? xmlFreeParserCtxt(parser);
 ????? |?????????????????????? ^~~~~~
 ????? |?????????????????????? Parser
Libxml2Parser.cc:128:5: error: 'xmlFreeParserCtxt' was not declared in 
this scope
 ? 128 |???? xmlFreeParserCtxt(parser);
 ????? |???? ^~~~~~~~~~~~~~~~~
Libxml2Parser.cc: In member function 'virtual bool 
ESILibxml2Parser::parse(const char*, size_t, bool)':
Libxml2Parser.cc:135:27: error: 'parser' was not declared in this scope; 
did you mean 'Parser'?
 ? 135 |???? return (xmlParseChunk(parser, dataToParse, lengthOfData, 
endOfStream) == 0);
 ????? |?????????????????????????? ^~~~~~
 ????? |?????????????????????????? Parser
Libxml2Parser.cc:135:13: error: 'xmlParseChunk' was not declared in this 
scope
 ? 135 |???? return (xmlParseChunk(parser, dataToParse, lengthOfData, 
endOfStream) == 0);
 ????? |???????????? ^~~~~~~~~~~~~
Libxml2Parser.cc: In member function 'virtual long int 
ESILibxml2Parser::lineNumber() const':
Libxml2Parser.cc:141:43: error: 'parser' was not declared in this scope; 
did you mean 'Parser'?
 ? 141 |???? return (long int)xmlSAX2GetLineNumber(parser);
 ????? |?????????????????????????????????????????? ^~~~~~
 ????? |?????????????????????????????????????????? Parser
Libxml2Parser.cc:141:22: error: 'xmlSAX2GetLineNumber' was not declared 
in this scope
 ? 141 |???? return (long int)xmlSAX2GetLineNumber(parser);
 ????? |????????????????????? ^~~~~~~~~~~~~~~~~~~~
Libxml2Parser.cc: In member function 'virtual const char* 
ESILibxml2Parser::errorString() const':
Libxml2Parser.cc:147:5: error: 'xmlErrorPtr' was not declared in this scope
 ? 147 |???? xmlErrorPtr error = xmlGetLastError();
 ????? |???? ^~~~~~~~~~~
Libxml2Parser.cc:149:9: error: 'error' was not declared in this scope; 
did you mean 'perror'?
 ? 149 |???? if (error == nullptr)
 ????? |???????? ^~~~~
 ????? |???????? perror
Libxml2Parser.cc:152:12: error: 'error' was not declared in this scope; 
did you mean 'perror'?
 ? 152 |???? return error->message;
 ????? |??????????? ^~~~~
 ????? |??????????? perror
make[3]: *** [Makefile:886: Libxml2Parser.lo] Error 1
make[3]: Leaving directory '/var/local/files/squid-6.1/src/esi'
make[2]: *** [Makefile:6005: all-recursive] Error 1
make[2]: Leaving directory '/var/local/files/squid-6.1/src'
make[1]: *** [Makefile:5005: all] Error 2
make[1]: Leaving directory '/var/local/files/squid-6.1/src'
make: *** [Makefile:600: all-recursive] Error 1


And how to fix it?

Thank you!



From rousskov at measurement-factory.com  Mon Aug  7 13:27:07 2023
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Mon, 7 Aug 2023 09:27:07 -0400
Subject: [squid-users] squid 6.1 esi compile error, ubuntu 22.04
In-Reply-To: <9c02114b-8244-d595-0fe3-3a97dfd42b75@belkam.com>
References: <9c02114b-8244-d595-0fe3-3a97dfd42b75@belkam.com>
Message-ID: <0e37cb56-3117-a5fe-0d34-5e296c832732@measurement-factory.com>

On 8/7/23 04:00, Dmitry Melekhov wrote:

> Built? using --disable-esi without problems.

First of all, if you do not need ESI, I recommend building with 
--disable-esi to avoid accidental exposure to dangerous ESI bugs in 
deployments that should not be using ESI features.

FWIW, in Project CI environment that also uses GCC on Ubuntu 22.04, 
Squid v6.1 ESI build[1] succeeds, including the Libxml2Parser.cc 
compilation step that fails in your environment.

[1] https://github.com/squid-cache/squid/actions/runs/5471818575

     $ grep -A6 LIBEXPAT configure.log
     checking for LIBEXPAT... yes
     checking for expat.h... yes
     checking for LIBXML2... yes
     checking for libxml/parser.h... yes
     checking for libxml/HTMLparser.h... yes
     checking for libxml/HTMLtree.h... yes
     configure: Enabling ESI processor:  -lexpat -lm  -lxml2


     $ grep HAVE_LIBXML include/autoconf.h
     #define HAVE_LIBXML2 1
     #define HAVE_LIBXML_HTMLPARSER_H 1
     #define HAVE_LIBXML_HTMLTREE_H 1
     #define HAVE_LIBXML_PARSER_H 1


Can you share the corresponding ./configure output and 
include/autoconf.h lines from your build environment?


> Could you tell me what can cause this?

I suspect your system lacks libxml/HTMLparser.h or Squid ./configure was 
unable to find that header. I cannot find relevant libxml2 
documentation, but if libxml promises to declare xmlParserCtxtPtr in 
libxml/HTMLparser.h, then this is a Squid bug: When that bug (if it is a 
Squid bug) is fixed, your build will fail at ./configure time instead of 
"make" time.

Next steps:

* If your system lacks libxml/HTMLparser.h, then install the missing 
libxml2 headers. Check the output sampled above to confirm that the 
installation led to header discovery by ./configure.

* If your system has libxml/HTMLparser.h, set/adjust CPPFLAGS given to 
./configure. Check the output sampled above to confirm that your 
adjustments led to header discovery by ./configure.



HTH,

Alex.


> /bin/bash ../../libtool? --tag=CXX?? --mode=compile g++ -std=c++17 
> -DHAVE_CONFIG_H -DDEFAULT_CONFIG_FILE=\"/etc/squid/squid.conf\" 
> -DDEFAULT_SQUID_DATA_DIR=\"/usr/share/squid\" 
> -DDEFAULT_SQUID_CONFIG_DIR=\"/etc/squid\"?? -I../.. -I../../include 
> -I../../lib -I../../src -I../../include? -isystem /usr/include/mit-krb5 
> -isystem /usr/include/mit-krb5 -I../../libltdl? -Wall -Wextra 
> -Wimplicit-fallthrough=5 -Wpointer-arith -Wwrite-strings -Wcomments 
> -Wshadow -Wmissing-declarations -Woverloaded-virtual -Werror -pipe 
> -D_REENTRANT -m64??? -g -O2 -MT Libxml2Parser.lo -MD -MP -MF 
> $depbase.Tpo -c -o Libxml2Parser.lo Libxml2Parser.cc &&\
> mv -f $depbase.Tpo $depbase.Plo
> libtool: compile:? g++ -std=c++17 -DHAVE_CONFIG_H 
> -DDEFAULT_CONFIG_FILE=\"/etc/squid/squid.conf\" 
> -DDEFAULT_SQUID_DATA_DIR=\"/usr/share/squid\" 
> -DDEFAULT_SQUID_CONFIG_DIR=\"/etc/squid\" -I../.. -I../../include 
> -I../../lib -I../../src -I../../include -isystem /usr/include/mit-krb5 
> -isystem /usr/include/mit-krb5 -I../../libltdl -Wall -Wextra 
> -Wimplicit-fallthrough=5 -Wpointer-arith -Wwrite-strings -Wcomments 
> -Wshadow -Wmissing-declarations -Woverloaded-virtual -Werror -pipe 
> -D_REENTRANT -m64 -g -O2 -MT Libxml2Parser.lo -MD -MP -MF 
> .deps/Libxml2Parser.Tpo -c Libxml2Parser.cc? -fPIC -DPIC -o 
> .libs/Libxml2Parser.o
> In file included from Libxml2Parser.cc:20:
> ../../src/esi/Libxml2Parser.h:66:13: error: 'xmlParserCtxtPtr' does not 
> name a type
>  ?? 66 |???? mutable xmlParserCtxtPtr parser; /* our parser */
>  ????? |???????????? ^~~~~~~~~~~~~~~~
> Libxml2Parser.cc:45:8: error: 'htmlDocPtr' does not name a type
>  ?? 45 | static htmlDocPtr entity_doc = nullptr;
>  ????? |??????? ^~~~~~~~~~
> Libxml2Parser.cc:51:43: error: 'xmlChar' does not name a type
>  ?? 51 | esi_startElementSAXFunc(void * ctx, const xmlChar * name, const 
> xmlChar ** atts)
>  ????? |?????????????????????????????????????????? ^~~~~~~
> Libxml2Parser.cc:51:65: error: 'xmlChar' does not name a type
>  ?? 51 | esi_startElementSAXFunc(void * ctx, const xmlChar * name, const 
> xmlChar ** atts)
> | ^~~~~~~
> Libxml2Parser.cc: In function 'void esi_startElementSAXFunc(void*, const 
> int*, const int**)':
> Libxml2Parser.cc:54:5: error: 'xmlChar' was not declared in this scope
>  ?? 54 |???? xmlChar **tmp = (xmlChar **)atts;
>  ????? |???? ^~~~~~~
> Libxml2Parser.cc:54:15: error: 'tmp' was not declared in this scope; did 
> you mean 'tm'?
>  ?? 54 |???? xmlChar **tmp = (xmlChar **)atts;
>  ????? |?????????????? ^~~
>  ????? |?????????????? tm
> Libxml2Parser.cc:54:32: error: expected primary-expression before ')' token
>  ?? 54 |???? xmlChar **tmp = (xmlChar **)atts;
>  ????? |??????????????????????????????? ^
> Libxml2Parser.cc: At global scope:
> Libxml2Parser.cc:70:40: error: 'xmlChar' does not name a type
>  ?? 70 | esi_endElementSAXFunc(void *ctx, const xmlChar *name)
>  ????? |??????????????????????????????????????? ^~~~~~~
> Libxml2Parser.cc:77:37: error: 'xmlChar' does not name a type
>  ?? 77 | esi_commentSAXFunc(void *ctx, const xmlChar *value)
>  ????? |???????????????????????????????????? ^~~~~~~
> Libxml2Parser.cc:84:40: error: 'xmlChar' does not name a type
>  ?? 84 | esi_charactersSAXFunc(void *ctx, const xmlChar *ch, int len)
>  ????? |??????????????????????????????????????? ^~~~~~~
> Libxml2Parser.cc:90:8: error: 'xmlEntityPtr' does not name a type
>  ?? 90 | static xmlEntityPtr
>  ????? |??????? ^~~~~~~~~~~~
> Libxml2Parser.cc: In constructor 
> 'ESILibxml2Parser::ESILibxml2Parser(ESIParserClient*)':
> Libxml2Parser.cc:110:5: error: 'xmlSAXHandler' was not declared in this 
> scope
>  ? 110 |???? xmlSAXHandler sax;
>  ????? |???? ^~~~~~~~~~~~~
> Libxml2Parser.cc:111:5: error: 'xmlInitParser' was not declared in this 
> scope
>  ? 111 |???? xmlInitParser();
>  ????? |???? ^~~~~~~~~~~~~
> Libxml2Parser.cc:112:13: error: 'sax' was not declared in this scope; 
> did you mean 'max'?
>  ? 112 |???? memset(&sax, 0, sizeof(sax));
>  ????? |???????????? ^~~
>  ????? |???????????? max
> Libxml2Parser.cc:117:21: error: 'esi_getEntitySAXFunc' was not declared 
> in this scope
>  ? 117 |???? sax.getEntity = esi_getEntitySAXFunc;
>  ????? |???????????????????? ^~~~~~~~~~~~~~~~~~~~
> Libxml2Parser.cc:120:5: error: 'parser' was not declared in this scope; 
> did you mean 'Parser'?
>  ? 120 |???? parser = xmlCreatePushParserCtxt(&sax, static_cast<void 
> *>(this), nullptr, 0, nullptr);
>  ????? |???? ^~~~~~
>  ????? |???? Parser
> Libxml2Parser.cc:120:14: error: 'xmlCreatePushParserCtxt' was not 
> declared in this scope
>  ? 120 |???? parser = xmlCreatePushParserCtxt(&sax, static_cast<void 
> *>(this), nullptr, 0, nullptr);
>  ????? |????????????? ^~~~~~~~~~~~~~~~~~~~~~~
> Libxml2Parser.cc:122:9: error: 'entity_doc' was not declared in this scope
>  ? 122 |???? if (entity_doc == nullptr)
>  ????? |???????? ^~~~~~~~~~
> Libxml2Parser.cc:123:22: error: 'htmlNewDoc' was not declared in this scope
>  ? 123 |???????? entity_doc = htmlNewDoc(nullptr, nullptr);
>  ????? |????????????????????? ^~~~~~~~~~
> Libxml2Parser.cc: In destructor 'virtual 
> ESILibxml2Parser::~ESILibxml2Parser()':
> Libxml2Parser.cc:128:23: error: 'parser' was not declared in this scope; 
> did you mean 'Parser'?
>  ? 128 |???? xmlFreeParserCtxt(parser);
>  ????? |?????????????????????? ^~~~~~
>  ????? |?????????????????????? Parser
> Libxml2Parser.cc:128:5: error: 'xmlFreeParserCtxt' was not declared in 
> this scope
>  ? 128 |???? xmlFreeParserCtxt(parser);
>  ????? |???? ^~~~~~~~~~~~~~~~~
> Libxml2Parser.cc: In member function 'virtual bool 
> ESILibxml2Parser::parse(const char*, size_t, bool)':
> Libxml2Parser.cc:135:27: error: 'parser' was not declared in this scope; 
> did you mean 'Parser'?
>  ? 135 |???? return (xmlParseChunk(parser, dataToParse, lengthOfData, 
> endOfStream) == 0);
>  ????? |?????????????????????????? ^~~~~~
>  ????? |?????????????????????????? Parser
> Libxml2Parser.cc:135:13: error: 'xmlParseChunk' was not declared in this 
> scope
>  ? 135 |???? return (xmlParseChunk(parser, dataToParse, lengthOfData, 
> endOfStream) == 0);
>  ????? |???????????? ^~~~~~~~~~~~~
> Libxml2Parser.cc: In member function 'virtual long int 
> ESILibxml2Parser::lineNumber() const':
> Libxml2Parser.cc:141:43: error: 'parser' was not declared in this scope; 
> did you mean 'Parser'?
>  ? 141 |???? return (long int)xmlSAX2GetLineNumber(parser);
>  ????? |?????????????????????????????????????????? ^~~~~~
>  ????? |?????????????????????????????????????????? Parser
> Libxml2Parser.cc:141:22: error: 'xmlSAX2GetLineNumber' was not declared 
> in this scope
>  ? 141 |???? return (long int)xmlSAX2GetLineNumber(parser);
>  ????? |????????????????????? ^~~~~~~~~~~~~~~~~~~~
> Libxml2Parser.cc: In member function 'virtual const char* 
> ESILibxml2Parser::errorString() const':
> Libxml2Parser.cc:147:5: error: 'xmlErrorPtr' was not declared in this scope
>  ? 147 |???? xmlErrorPtr error = xmlGetLastError();
>  ????? |???? ^~~~~~~~~~~
> Libxml2Parser.cc:149:9: error: 'error' was not declared in this scope; 
> did you mean 'perror'?
>  ? 149 |???? if (error == nullptr)
>  ????? |???????? ^~~~~
>  ????? |???????? perror
> Libxml2Parser.cc:152:12: error: 'error' was not declared in this scope; 
> did you mean 'perror'?
>  ? 152 |???? return error->message;
>  ????? |??????????? ^~~~~
>  ????? |??????????? perror
> make[3]: *** [Makefile:886: Libxml2Parser.lo] Error 1
> make[3]: Leaving directory '/var/local/files/squid-6.1/src/esi'
> make[2]: *** [Makefile:6005: all-recursive] Error 1
> make[2]: Leaving directory '/var/local/files/squid-6.1/src'
> make[1]: *** [Makefile:5005: all] Error 2
> make[1]: Leaving directory '/var/local/files/squid-6.1/src'
> make: *** [Makefile:600: all-recursive] Error 1
> 
> 
> And how to fix it?
> 
> Thank you!
> 
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users



From squid3 at treenet.co.nz  Tue Aug  8 04:46:57 2023
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Tue, 8 Aug 2023 16:46:57 +1200
Subject: [squid-users] squid 6.1 esi compile error, ubuntu 22.04
In-Reply-To: <9c02114b-8244-d595-0fe3-3a97dfd42b75@belkam.com>
References: <9c02114b-8244-d595-0fe3-3a97dfd42b75@belkam.com>
Message-ID: <5188e6b8-ae37-b389-4be4-ed3ceb2142ff@treenet.co.nz>

On 7/08/23 20:00, Dmitry Melekhov wrote:
> Hello!
> 
> 
> Built? using --disable-esi without problems.
> 
> 
> 
> Could you tell me what can cause this?
> 

Seemingly lack of the libxml2 dependency.

Please ensure you run this command before building Squid:
   apt-get build-dep squid


If this issue or others remain see Alex's response.

HTH
Amos


From dm at belkam.com  Tue Aug  8 05:10:03 2023
From: dm at belkam.com (Dmitry Melekhov)
Date: Tue, 8 Aug 2023 09:10:03 +0400
Subject: [squid-users] squid 6.1 esi compile error, ubuntu 22.04
In-Reply-To: <0e37cb56-3117-a5fe-0d34-5e296c832732@measurement-factory.com>
References: <9c02114b-8244-d595-0fe3-3a97dfd42b75@belkam.com>
 <0e37cb56-3117-a5fe-0d34-5e296c832732@measurement-factory.com>
Message-ID: <cc1f94e6-5c48-b0c2-427c-fc03b9fea21b@belkam.com>

07.08.2023 17:27, Alex Rousskov ?????:
> On 8/7/23 04:00, Dmitry Melekhov wrote:
>
>> Built? using --disable-esi without problems.
>
> First of all, if you do not need ESI, I recommend building with 
> --disable-esi to avoid accidental exposure to dangerous ESI bugs in 
> deployments that should not be using ESI features.


Thank you!

Really, I know nothing about it, so most probably I don't need it.


>
> FWIW, in Project CI environment that also uses GCC on Ubuntu 22.04, 
> Squid v6.1 ESI build[1] succeeds, including the Libxml2Parser.cc 
> compilation step that fails in your environment.
>
> [1] https://github.com/squid-cache/squid/actions/runs/5471818575
>
> ??? $ grep -A6 LIBEXPAT configure.log
> ??? checking for LIBEXPAT... yes
> ??? checking for expat.h... yes
> ??? checking for LIBXML2... yes
> ??? checking for libxml/parser.h... yes
> ??? checking for libxml/HTMLparser.h... yes
> ??? checking for libxml/HTMLtree.h... yes
> ??? configure: Enabling ESI processor:? -lexpat -lm? -lxml2
>
>
> ??? $ grep HAVE_LIBXML include/autoconf.h
> ??? #define HAVE_LIBXML2 1
> ??? #define HAVE_LIBXML_HTMLPARSER_H 1
> ??? #define HAVE_LIBXML_HTMLTREE_H 1
> ??? #define HAVE_LIBXML_PARSER_H 1
>
>
> Can you share the corresponding ./configure output and 
> include/autoconf.h lines from your build environment?
>
>
>> Could you tell me what can cause this?
>
> I suspect your system lacks libxml/HTMLparser.h or Squid ./configure 
> was unable to find that header. I cannot find relevant libxml2 
> documentation, but if libxml promises to declare xmlParserCtxtPtr in 
> libxml/HTMLparser.h, then this is a Squid bug: When that bug (if it is 
> a Squid bug) is fixed, your build will fail at ./configure time 
> instead of "make" time.
>
> Next steps:
>
> * If your system lacks libxml/HTMLparser.h, then install the missing 
> libxml2 headers. Check the output sampled above to confirm that the 
> installation led to header discovery by ./configure.
>
> * If your system has libxml/HTMLparser.h, set/adjust CPPFLAGS given to 
> ./configure. Check the output sampled above to confirm that your 
> adjustments led to header discovery by ./configure.
>
It is in place, the same as in Ubuntu 20.04,? where I compiled squid 6.1 
without problems,

but configure can't find it:


configure:28616: checking for libxml/parser.h
configure:28616: g++ -std=c++17 -c? -g -O2?? conftest.cpp >&5
conftest.cpp:120:10: fatal error: libxml/parser.h: No such file or directory
 ? 120 | #include <libxml/parser.h>
 ????? |????????? ^~~~~~~~~~~~~~~~~
compilation terminated.


export CPPFLAGS=-I/usr/include/libxml2/

helps

now :

configure:28616: checking for libxml/parser.h
configure:28616: g++ -std=c++17 -c? -g -O2 -I/usr/include/libxml2/ 
conftest.cpp >&5
configure:28616: $? = 0
configure:28616: result: yes


and squid is compiled.


This is new install of ubuntu 22.04,? just about a month ago, so I don't 
think I break something in it...


Thank you!





From rousskov at measurement-factory.com  Tue Aug  8 15:22:41 2023
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Tue, 8 Aug 2023 11:22:41 -0400
Subject: [squid-users] squid 6.1 esi compile error, ubuntu 22.04
In-Reply-To: <cc1f94e6-5c48-b0c2-427c-fc03b9fea21b@belkam.com>
References: <9c02114b-8244-d595-0fe3-3a97dfd42b75@belkam.com>
 <0e37cb56-3117-a5fe-0d34-5e296c832732@measurement-factory.com>
 <cc1f94e6-5c48-b0c2-427c-fc03b9fea21b@belkam.com>
Message-ID: <55298982-d394-99bd-7649-d57fbe278e6c@measurement-factory.com>

On 8/8/23 01:10, Dmitry Melekhov wrote:
> 07.08.2023 17:27, Alex Rousskov ?????:
>> On 8/7/23 04:00, Dmitry Melekhov wrote:
>>
>>> Built? using --disable-esi without problems.
>>
>> First of all, if you do not need ESI, I recommend building with 
>> --disable-esi to avoid accidental exposure to dangerous ESI bugs in 
>> deployments that should not be using ESI features.

> Really, I know nothing about it, so most probably I don't need it.

Agreed.


>> FWIW, in Project CI environment that also uses GCC on Ubuntu 22.04, 
>> Squid v6.1 ESI build[1] succeeds, including the Libxml2Parser.cc 
>> compilation step that fails in your environment.
>>
>> [1] https://github.com/squid-cache/squid/actions/runs/5471818575
>>
>> ??? $ grep -A6 LIBEXPAT configure.log
>> ??? checking for LIBEXPAT... yes
>> ??? checking for expat.h... yes
>> ??? checking for LIBXML2... yes
>> ??? checking for libxml/parser.h... yes
>> ??? checking for libxml/HTMLparser.h... yes
>> ??? checking for libxml/HTMLtree.h... yes
>> ??? configure: Enabling ESI processor:? -lexpat -lm? -lxml2
>>
>>
>> ??? $ grep HAVE_LIBXML include/autoconf.h
>> ??? #define HAVE_LIBXML2 1
>> ??? #define HAVE_LIBXML_HTMLPARSER_H 1
>> ??? #define HAVE_LIBXML_HTMLTREE_H 1
>> ??? #define HAVE_LIBXML_PARSER_H 1
>>
>>
>> Can you share the corresponding ./configure output and 
>> include/autoconf.h lines from your build environment?
>>
>>
>>> Could you tell me what can cause this?
>>
>> I suspect your system lacks libxml/HTMLparser.h or Squid ./configure 
>> was unable to find that header. I cannot find relevant libxml2 
>> documentation, but if libxml promises to declare xmlParserCtxtPtr in 
>> libxml/HTMLparser.h, then this is a Squid bug: When that bug (if it is 
>> a Squid bug) is fixed, your build will fail at ./configure time 
>> instead of "make" time.
>>
>> Next steps:
>>
>> * If your system lacks libxml/HTMLparser.h, then install the missing 
>> libxml2 headers. Check the output sampled above to confirm that the 
>> installation led to header discovery by ./configure.
>>
>> * If your system has libxml/HTMLparser.h, set/adjust CPPFLAGS given to 
>> ./configure. Check the output sampled above to confirm that your 
>> adjustments led to header discovery by ./configure.



> It is in place, the same as in Ubuntu 20.04,? where I compiled squid 6.1 
> without problems,
> 
> but configure can't find it:
> 
> 
> configure:28616: checking for libxml/parser.h
> configure:28616: g++ -std=c++17 -c? -g -O2?? conftest.cpp >&5
> conftest.cpp:120:10: fatal error: libxml/parser.h: No such file or 
> directory
>  ? 120 | #include <libxml/parser.h>
>  ????? |????????? ^~~~~~~~~~~~~~~~~
> compilation terminated.
> 
> 
> export CPPFLAGS=-I/usr/include/libxml2/
> 
> helps
> 
> now :
> 
> configure:28616: checking for libxml/parser.h
> configure:28616: g++ -std=c++17 -c? -g -O2 -I/usr/include/libxml2/ 
> conftest.cpp >&5
> configure:28616: $? = 0
> configure:28616: result: yes
> 
> 
> and squid is compiled.

> This is new install of ubuntu 22.04

Thank you for reporting these details! They may help others experiencing 
similar problems.

I cannot explain why setting CPPFLAGS is needed in your environment 
_but_ not needed in other very similar environments with libxml2 
installed. There might be some subtle differences in _how_ that library 
and its headers were installed, but I am just grasping at straws here.


Alex.



From tommy.brunn at klarna.com  Wed Aug  9 12:14:49 2023
From: tommy.brunn at klarna.com (Tommy Brunn)
Date: Wed, 9 Aug 2023 14:14:49 +0200
Subject: [squid-users] Recent Squid 4 versions show ERR_CANNOT_FORWARD
 instead of ERR_DNS_FAIL
Message-ID: <CAARumM=NsEt6Lkyec7bEWPOLb93k1TfOrk=uzWr+b5cQj8hJew@mail.gmail.com>

It's been 5 years since this was originally posted, but I am currently
in the process of upgrading from Squid 4.13 to 5.8, and have
encountered the same scenario when running our integration tests to
validate the existing behavior. To summarize, given the exact same
configuration in both versions, making a CONNECT request for a domain
that doesn't exist used to result in a 503 response with an
ERR_DNS_FAIL error. In Squid 5.8 this instead results in a 500
response with an ERR_CANNOT_FORWARD error.

For reference, I am using the version of Squid that is packaged in the
most recent version of Amazon Linux 2023. As requested in the last
email regarding this issue, I have attached verbose debug logs from
squid, as well as the squid configuration file, the full output of
`squid -v` and finally the output of `dig` on the non-existent domain
from the same context as squid is running in:
https://gist.github.com/Nevon/ee4d379877b9570cccb4f21df7382a63

Does anyone know if this is an intentional change or a bug? If it's an
intentional change, what is the rationale behind the change and is it
mentioned anywhere in a pull request or similar? I wasn't able to find
any other references to this other than this one thread with no
resolution from October 2018.

Thanks!

-- 
Tommy Brunn


From rousskov at measurement-factory.com  Wed Aug  9 13:38:00 2023
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Wed, 9 Aug 2023 09:38:00 -0400
Subject: [squid-users] Recent Squid 4 versions show ERR_CANNOT_FORWARD
 instead of ERR_DNS_FAIL
In-Reply-To: <CAARumM=NsEt6Lkyec7bEWPOLb93k1TfOrk=uzWr+b5cQj8hJew@mail.gmail.com>
References: <CAARumM=NsEt6Lkyec7bEWPOLb93k1TfOrk=uzWr+b5cQj8hJew@mail.gmail.com>
Message-ID: <fd27c214-0842-4392-327e-5cadac2d373e@measurement-factory.com>

On 8/9/23 08:14, Tommy Brunn wrote:

> It's been 5 years since this was originally posted, but I am currently
> in the process of upgrading from Squid 4.13 to 5.8,

FWIW, you should be upgrading to v6 instead. Squid v5 maintainer does 
not expect making regular bug-fixing v5 releases:
https://github.com/squid-cache/squid/pull/1346#issuecomment-1668901339


> and have
> encountered the same scenario when running our integration tests to
> validate the existing behavior. To summarize, given the exact same
> configuration in both versions, making a CONNECT request for a domain
> that doesn't exist used to result in a 503 response with an
> ERR_DNS_FAIL error. In Squid 5.8 this instead results in a 500
> response with an ERR_CANNOT_FORWARD error.

Mishandling/misreporting ERR_DNS_FAIL is a known problem. Or two. IIRC, 
at least two different scenarios suffer from that problem, one ends up 
with ERR_CANNOT_FORWARD and one with ERR_READ_ERROR.

FWIW, the Squid Project is improving CI tests to detect such unexpected 
changes in the future.


> For reference, I am using the version of Squid that is packaged in the
> most recent version of Amazon Linux 2023.
> I have attached verbose debug logs from > squid, as well as the squid configuration file, the full output of
> `squid -v` and finally the output of `dig` on the non-existent domain
> from the same context as squid is running in:
> https://gist.github.com/Nevon/ee4d379877b9570cccb4f21df7382a63

Thank you for sharing those details. When developers start working on a 
fix, they may find them very useful (if they can find them at that 
time). You may also want to post a bug report on Squid Bugzilla.


> Does anyone know if this is an intentional change or a bug?

The change was not intentional. In most cases, it is a bug: A catch-all 
ERR_CANNOT_FORWARD should not be used when a more specific ERR_X applies.


## Current 503 vs old 500 status code

Please note that not all ERR_DNS_FAIL should result in HTTP 503 (Service 
Unavailable) responses AFAICT.

For example, RFC 9209 section 2.3.2 recommends that DNS NXDOMAIN 
responses result in HTTP 502 (Bad Gateway) responses:
https://www.rfc-editor.org/rfc/rfc9209.html#section-2.3.2

However, the above recommendation does not quite match RFC 9110 
description of HTTP 502 (Bad Gateway) status code because NXDOMAIN is 
not an "invalid response" (it is a valid error response):
https://www.rfc-editor.org/rfc/rfc9110#section-15.6.3

The presence of multiple errors during forwarding attempts complicates 
the situation further.

Given all these uncertainties, if your infrastructure relies on a very 
specific HTTP status response code, it may be a good idea to redesign.


HTH,

Alex.



From tommy.brunn at klarna.com  Wed Aug  9 15:56:44 2023
From: tommy.brunn at klarna.com (Tommy Brunn)
Date: Wed, 9 Aug 2023 17:56:44 +0200
Subject: [squid-users] Recent Squid 4 versions show ERR_CANNOT_FORWARD
 instead of ERR_DNS_FAIL
In-Reply-To: <fd27c214-0842-4392-327e-5cadac2d373e@measurement-factory.com>
References: <CAARumM=NsEt6Lkyec7bEWPOLb93k1TfOrk=uzWr+b5cQj8hJew@mail.gmail.com>
 <fd27c214-0842-4392-327e-5cadac2d373e@measurement-factory.com>
Message-ID: <CAARumMkBqoHpsq-ZzhKGJjOTYxuxVpLoOcFBwygD2A0EiNyK3w@mail.gmail.com>

Thank you for the quick response and confirmation that this is indeed
a bug. I have since confirmed that the same bug is present also in
6.1.

On Wed, Aug 9, 2023 at 3:38?PM Alex Rousskov wrote:

> Thank you for sharing those details. When developers start working on a
> fix, they may find them very useful (if they can find them at that
> time). You may also want to post a bug report on Squid Bugzilla.

I have gone ahead and submitted bug 5294
(https://bugs.squid-cache.org/show_bug.cgi?id=5294) for this issue
now.

> Given all these uncertainties, if your infrastructure relies on a very
> specific HTTP status response code, it may be a good idea to redesign.

Indeed. I would expect clients to functionally behave the same whether
they receive a 500 or a 503 in this case. It's just less informative
and may require more investigation time to determine if there is
indeed an actual internal error in Squid or if the client just tried
to connect to a domain that doesn't exist. At least now I know that
it's not expected behavior so that I can document it accordingly for
our users.


From mailing at fuchus.de  Wed Aug  9 18:33:27 2023
From: mailing at fuchus.de (mailing at fuchus.de)
Date: Wed, 9 Aug 2023 20:33:27 +0200 (CEST)
Subject: [squid-users] Sockets not closed after ICAP
 receivedWholeAdaptedReply
Message-ID: <NbQZniy--R-9@fuchus.de>

Hi,

we have been having some issues lately with our Squid proxies on version 6.1.

We also have the patch for the REQMOD satisfaction regression installed: https://github.com/squid-cache/squid/pull/1400

The issue:

When there is a request sent to the ICAP server and the ICAP server is replying with a modified response, this modified response, after checking through receivedWholeAdeptedReply, doesn't set a BAD_LENGTH, which usually turns into a STREAM_UNPLANNED_COMPLETE, but rather a STREAM_COMPLETE (in Http::Stream::writeComplete). This in turn calls ConnStateData::kick on the current context, which has an empty pipeline at some point. Because this case is not specifically checked and the connection is just abandoned, the socket is never removed. This causes a lot of open connections and a high amount of file descriptors for the corresponding squid processes that we frequently run into limits.

As a hot fix I made the following changes in order to accommodate for this specific case:

--- a/src/client_side.cc
+++ a/src/client_side.cc
@@ -989,6 +989,9 @@ ConnStateData::kick()
???? } else if (flags.readMore) {
???????? debugs(33, 3, clientConnection << ": calling readNextRequest()");
???????? readNextRequest();
+??? } else if (pipeline.empty()) {
+??????? debugs(33, 3, "pipeline is empty - closing connection");
+??????? clientConnection->close();
???? } else {
???????? // XXX: Can this happen? CONNECT tunnels have deferredRequest set.
???????? debugs(33, DBG_IMPORTANT, MYNAME << "abandoning " << clientConnection);

This issue also seems to happen if the ICAP server has specific responses - it seems as if the STREAM_COMPLETE case happens (implying receivedWholeAdaptedReply) if there is a Connection: closed response from ICAP, rather than Connection: keep-alive. In the latter case, the connection is torn down with a STREAM_UNPLANNED_COMPLETE. The patch, setting receivedWholeAdaptedReply always to true in those cases also means that the connection is never closed and abandoned all the time if it includes REQMOD it seems, rather than just doing that if the response from ICAP implies a closed connection.

I was not able to reproduce the issue with version 5.8 as of now, so this seems to be something specific to 6.1.

Do you have any remarks on the change? Maybe you have some more insight on the interplay of the code or what seems to be causing the issue in detail.
Sincerely,

Leonardo Martinho
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230809/51de9316/attachment.htm>

From rousskov at measurement-factory.com  Wed Aug  9 20:08:03 2023
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Wed, 9 Aug 2023 16:08:03 -0400
Subject: [squid-users] Sockets not closed after ICAP
 receivedWholeAdaptedReply
In-Reply-To: <NbQZniy--R-9@fuchus.de>
References: <NbQZniy--R-9@fuchus.de>
Message-ID: <d6acd6cf-eb38-e78d-3f98-c5e97481a913@measurement-factory.com>

On 8/9/23 14:33, mailing at fuchus.de wrote:

> Do you have any remarks on the change? Maybe you have some more 
> insight on the interplay of the code or what seems to be causing the
> issue in detail.


Hi Leonardo,

     I do, but this mailing list is not the best place to discuss Squid 
code. If you want these or similar changes merged into Squid, then I 
suggest posting a draft Pull Request on GitHub, where it is easier to 
collaborate and provide code-specific feedback. Ideally, use a dedicated 
git branch that Squid core developers can modify and experiment with 
(e.g., do _not_ use a cloned official branch like "master" or a custom 
branch that you automatically deploy!).
https://wiki.squid-cache.org/MergeProcedure#pull-request


For now, I will leave you with a few questions and brief comments:

* Does the problem go away if you remove the patch in PR #1400? Or are 
you unable to test this use case without that patch?

* Please clarify whether the HTP response encapsulated in the ICAP 
response should set ENTRY_BAD_LENGTH in a bug-free Squid code. It was 
not clear (to me) whether there is something wrong with that HTTP response.

* ICAP Connection and HTTP Connection headers in ICAP responses should 
not affect encapsulated HTTP response length. If they do, there is a bug 
somewhere.

* If your patch is the right thing to do, then, most likely, more 
changes are required. For example, a similar condition may happen on the 
ConnStateData::afterClientRead() code path AFAICT.

* PR 1443 has overlapping changes. They will not fix your specific use 
case, but, ideally, I would prefer to land that (IMO, ready) PR before 
attacking this problem because that PR has relevant code changes that we 
should not revisit in a parallel PR.


HTH,

Alex.


On 8/9/23 14:33, mailing at fuchus.de wrote:
> we have been having some issues lately with our Squid proxies on version 
> 6.1.
> 
> We also have the patch for the REQMOD satisfaction regression installed: 
> https://github.com/squid-cache/squid/pull/1400 
> 
> The issue:
> 
> When there is a request sent to the ICAP server and the ICAP server is 
> replying with a modified response, this modified response, after 
> checking through receivedWholeAdeptedReply, doesn't set a BAD_LENGTH, 
> which usually turns into a STREAM_UNPLANNED_COMPLETE, but rather a 
> STREAM_COMPLETE (in Http::Stream::writeComplete). This in turn calls 
> ConnStateData::kick on the current context, which has an empty pipeline 
> at some point. Because this case is not specifically checked and the 
> connection is just abandoned, the socket is never removed. This causes a 
> lot of open connections and a high amount of file descriptors for the 
> corresponding squid processes that we frequently run into limits.
> 
> As a hot fix I made the following changes in order to accommodate for 
> this specific case:
> 
> --- a/src/client_side.cc
> +++ a/src/client_side.cc
> @@ -989,6 +989,9 @@ ConnStateData::kick()
>  ???? } else if (flags.readMore) {
>  ???????? debugs(33, 3, clientConnection << ": calling readNextRequest()");
>  ???????? readNextRequest();
> +??? } else if (pipeline.empty()) {
> +??????? debugs(33, 3, "pipeline is empty - closing connection");
> +??????? clientConnection->close();
>  ???? } else {
>  ???????? // XXX: Can this happen? CONNECT tunnels have deferredRequest set.
>  ???????? debugs(33, DBG_IMPORTANT, MYNAME << "abandoning " << 
> clientConnection);
> 
> This issue also seems to happen if the ICAP server has specific 
> responses - it seems as if the STREAM_COMPLETE case happens (implying 
> receivedWholeAdaptedReply) if there is a Connection: closed response 
> from ICAP, rather than Connection: keep-alive. In the latter case, the 
> connection is torn down with a STREAM_UNPLANNED_COMPLETE. The patch, 
> setting receivedWholeAdaptedReply always to true in those cases also 
> means that the connection is never closed and abandoned all the time if 
> it includes REQMOD it seems, rather than just doing that if the response 
> from ICAP implies a closed connection.
> 
> I was not able to reproduce the issue with version 5.8 as of now, so 
> this seems to be something specific to 6.1.
> 
> Do you have any remarks on the change? Maybe you have some more insight 
> on the interplay of the code or what seems to be causing the issue in 
> detail.
> 
> Sincerely,
> 
> Leonardo Martinho
> 
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users



From Ralf.Hildebrandt at charite.de  Thu Aug 10 09:20:47 2023
From: Ralf.Hildebrandt at charite.de (Ralf Hildebrandt)
Date: Thu, 10 Aug 2023 11:20:47 +0200
Subject: [squid-users] Some requests not being passed/processed by squid
Message-ID: <ZNSr75NT2z+mV7pe@charite.de>

We're running a cluster of 4 identical Squid proxies.

In order to check the functionality of each cluster node, were using
ldirectord which is querying each realserver like this:

GET http://127.0.0.1/proxytest.cgi 

Now we were seen some odd warning in our graphs, clusternodes being
removed and added back to the cluster only a few seconds later.

I found that these requests for http://127.0.0.1/proxytest.cgi were
sometimes (seldom -- maybe once/twice per day) failing.

In the squid access.log I'm seeing this as:
===========================================

Thu Aug 10 10:32:54 2023    115 141.42.5.218 TCP_REFRESH_ABORTED/200 0 141 GET http://127.0.0.1/proxytest.cgi - HIER_DIRECT/127.0.0.1 text/plain accessRule=- 56680
Thu Aug 10 10:33:02 2023      0 141.42.5.218 NONE_NONE_ABORTED/000 0 141 GET http://127.0.0.1/proxytest.cgi - HIER_NONE/- - accessRule=- -
Thu Aug 10 10:33:07 2023      0 141.42.5.218 NONE_NONE_ABORTED/000 0 141 GET http://127.0.0.1/proxytest.cgi - HIER_NONE/- - accessRule=- -

as opposed to the normal:
=========================

Thu Aug 10 11:02:45 2023      5 141.42.5.218 TCP_REFRESH_MODIFIED/200 314 141 GET http://127.0.0.1/proxytest.cgi - HIER_DIRECT/127.0.0.1 text/plain accessRule=- 51940

My Logformat:
=============

logformat squid-sourceport  %ts.%03tu %6tr %>a %Ss/%03>Hs %<st %>st %rm %ru %[un %Sh/%<a %mt accessRule=%{accessRule}note %<lp

* I replaced the the secondssince1970 timestamp with a human readable timeformat
* Last colument in the log is the sourceport used by squid 

I checked nginx logs on that machine and found that the requests for
http://127.0.0.1/proxytest.cgi never reached nginx (for the three
incidents marked above)

So my questions:
================

What are TCP_REFRESH_ABORTED/200 and (which looks more dire) NONE_NONE_ABORTED/000?

-- 
Ralf Hildebrandt
Charit? - Universit?tsmedizin Berlin
Gesch?ftsbereich IT | Abteilung Netzwerk

Campus Benjamin Franklin (CBF)
Haus I | 1. OG | Raum 105
Hindenburgdamm 30 | D-12203 Berlin

Tel. +49 30 450 570 155
ralf.hildebrandt at charite.de
https://www.charite.de


From rousskov at measurement-factory.com  Thu Aug 10 16:59:02 2023
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Thu, 10 Aug 2023 12:59:02 -0400
Subject: [squid-users] Some requests not being passed/processed by squid
In-Reply-To: <ZNSr75NT2z+mV7pe@charite.de>
References: <ZNSr75NT2z+mV7pe@charite.de>
Message-ID: <cf647d07-1680-0ca1-e136-769838d9a607@measurement-factory.com>

On 8/10/23 05:20, Ralf Hildebrandt wrote:
> We're running a cluster of 4 identical Squid proxies.
> 
> In order to check the functionality of each cluster node, were using
> ldirectord which is querying each realserver like this:
> 
> GET http://127.0.0.1/proxytest.cgi

I assume there is HTTP/1.x at the end and some request headers after the 
request line.


> Now we were seen some odd warning in our graphs, clusternodes being
> removed and added back to the cluster only a few seconds later.
> 
> I found that these requests for http://127.0.0.1/proxytest.cgi were
> sometimes (seldom -- maybe once/twice per day) failing.
> 
> In the squid access.log I'm seeing this as:
> ===========================================
> 
> Thu Aug 10 10:32:54 2023    115 141.42.5.218 TCP_REFRESH_ABORTED/200 0 141 GET http://127.0.0.1/proxytest.cgi - HIER_DIRECT/127.0.0.1 text/plain accessRule=- 56680
> Thu Aug 10 10:33:02 2023      0 141.42.5.218 NONE_NONE_ABORTED/000 0 141 GET http://127.0.0.1/proxytest.cgi - HIER_NONE/- - accessRule=- -
> Thu Aug 10 10:33:07 2023      0 141.42.5.218 NONE_NONE_ABORTED/000 0 141 GET http://127.0.0.1/proxytest.cgi - HIER_NONE/- - accessRule=- -
> 
> as opposed to the normal:
> =========================
> 
> Thu Aug 10 11:02:45 2023      5 141.42.5.218 TCP_REFRESH_MODIFIED/200 314 141 GET http://127.0.0.1/proxytest.cgi - HIER_DIRECT/127.0.0.1 text/plain accessRule=- 51940
> 
> My Logformat:
> =============
> 
> logformat squid-sourceport  %ts.%03tu %6tr %>a %Ss/%03>Hs %<st %>st %rm %ru %[un %Sh/%<a %mt accessRule=%{accessRule}note %<lp
> 
> * I replaced the the secondssince1970 timestamp with a human readable timeformat
> * Last colument in the log is the sourceport used by squid
> 
> I checked nginx logs on that machine and found that the requests for
> http://127.0.0.1/proxytest.cgi never reached nginx (for the three
> incidents marked above)
> 
> So my questions:
> ================
> 
> What are TCP_REFRESH_ABORTED/200 and (which looks more dire) NONE_NONE_ABORTED/000?


I can only describe a few _possible_ outcomes. They may not match what 
is actually happening in your specific use cases because I have not 
checked all the necessary details, because of Squid bugs, and because 
several different outcomes may map to the same access.log line, 
especially in older Squids, especially in Squids that do not access-log 
%err_code/%err_detail.

* TCP_REFRESH_ABORTED/200: Squid found a matching stale cached response 
and decided to revalidate it with the origin server. After (or while or 
just before) talking to the origin server and/or while (or just before) 
sending a 200 OK response to the client, the client (or something else) 
closed the client-Squid connection.

* NONE_NONE_ABORTED/000: The client (or something else) closed 
client-Squid connection much earlier than what is described in the 
TCP_REFRESH_ABORTED/200 case above, even before Squid found a matching 
stale response in its cache, if any, or even before Squid checked that 
cache. Technically, logging NONE_NONE is a Squid bug. Squid should log 
something like TCP_ABORTED instead.

I recommend logging %err_code/%err_detail. Logging Cache-Status response 
header may also be useful.


HTH,

Alex.



From Robert.Zenz at bonsaimind.org  Fri Aug 11 17:23:09 2023
From: Robert.Zenz at bonsaimind.org (Robert 'Bobby' Zenz)
Date: Fri, 11 Aug 2023 19:23:09 +0200
Subject: [squid-users] Outgoing traffic through certain device instead of IP?
Message-ID: <20230811192309.1273c28b@Dagon>

I'd like to send all the outgoing traffic from Squid through a certain
network device instead of an IP. There's `tcp_outgoing_address` and
`udp_outgoing_address` which only accepts an IP as parameter, but
there's no way to use a certain device?

I just wanted to verify that there is currently no way to have a
certain network device specified because I couldn't find anything about
it in the documentation. My use-case here is that I have multiple
OpenVPN tunnels open and use Squid to funnel traffic through them
(including DNS queries which works great!). These OpenVPN tunnels all
have their own network device, but the IP address might or might not
change at some point, and when that happens Squid won't be able to
forward traffic anymore. Of course I can work around that (OpenVPN
`--ipchange` to fire a script when the IP changes), but I just wanted
to check whether I've missed something here.


From uhlar at fantomas.sk  Sat Aug 12 07:03:54 2023
From: uhlar at fantomas.sk (Matus UHLAR - fantomas)
Date: Sat, 12 Aug 2023 09:03:54 +0200
Subject: [squid-users] Outgoing traffic through certain device instead
 of IP?
In-Reply-To: <20230811192309.1273c28b@Dagon>
References: <20230811192309.1273c28b@Dagon>
Message-ID: <ZNcu2mhPn9V/d4CC@fantomas.sk>

On 11.08.23 19:23, Robert 'Bobby' Zenz wrote:
>I'd like to send all the outgoing traffic from Squid through a certain
>network device instead of an IP. There's `tcp_outgoing_address` and
>`udp_outgoing_address` which only accepts an IP as parameter, but
>there's no way to use a certain device?

You need to make routing/firewall rules for this. 

The system does not support selecting outgoing interface other way.

-- 
Matus UHLAR - fantomas, uhlar at fantomas.sk ; http://www.fantomas.sk/
Warning: I wish NOT to receive e-mail advertising to this address.
Varovanie: na tuto adresu chcem NEDOSTAVAT akukolvek reklamnu postu.
Windows 2000: 640 MB ought to be enough for anybody


From squid3 at treenet.co.nz  Sat Aug 12 09:52:53 2023
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Sat, 12 Aug 2023 21:52:53 +1200
Subject: [squid-users] Outgoing traffic through certain device instead
 of IP?
In-Reply-To: <20230811192309.1273c28b@Dagon>
References: <20230811192309.1273c28b@Dagon>
Message-ID: <54e67c3e-4677-4ebc-af91-d77c7f507523@treenet.co.nz>

On 12/08/23 05:23, Robert 'Bobby' Zenz wrote:
> I'd like to send all the outgoing traffic from Squid through a certain
> network device instead of an IP. There's `tcp_outgoing_address` and
> `udp_outgoing_address` which only accepts an IP as parameter, but
> there's no way to use a certain device?

Squid is limited to selecting certain details of the TCP packets.
Device routing details are up to the operating system.

> 
> I just wanted to verify that there is currently no way to have a
> certain network device specified because I couldn't find anything about
> it in the documentation. 

You can have Squid can set dst-IP or TOS/QoS marking on packets. The OS 
routing services should be able to use those to do its selection.



My use-case here is that I have multiple
> OpenVPN tunnels open and use Squid to funnel traffic through them
> (including DNS queries which works great!). These OpenVPN tunnels all
> have their own network device, but the IP address might or might not
> change at some point, and when that happens Squid won't be able to
> forward traffic anymore. Of course I can work around that (OpenVPN
> `--ipchange` to fire a script when the IP changes), but I just wanted
> to check whether I've missed something here.

In this case, leaving the outgoing IP to the OS is best.
http://www.squid-cache.org/Doc/config/tcp_outgoing_mark/> is available 
to mark (aka classify in QoS terms) Squid traffic for the OS routing.

HTH
Amos


From andreas.weigel at securepoint.de  Tue Aug 15 19:04:47 2023
From: andreas.weigel at securepoint.de (Andreas Weigel)
Date: Tue, 15 Aug 2023 19:04:47 +0000
Subject: [squid-users] 'Transfer-Encoding: chunked,
 chunked' rejected by Squid
Message-ID: <20230815190447.Horde.0BLzx6aH8AqhVoL7xI6hdvq@webmail.intern.securepoint.de>

Hi,

just in reference to  
https://github.com/squid-cache/squid/pull/702#issuecomment-762459132,  
I was made aware of a(nother) buggy server in the wild, that sends the  
header quoted in the subject (Squid version 4.16) in its response:  
https://riverbird.de. Squid rejects connection to that server with an  
"Invalid response..." error message, while all browsers I used were  
able to open the website.

The server seemingly only shows the behavior if 'Accept-Encoding:  
gzip' is set in the request. The actual encoding used for the response  
is a simple (single) chunked encoding.

Kind regards,
Andreas
-- 
Andreas Weigel
UTM Backend Developer

Securepoint GmbH
Bleckeder Landstra?e 28
D-21337 L?neburg
https://www.securepoint.de

Gesch?ftsf?hrer: Ren? Hofmann
Amtsgericht L?neburg HRB 1776



From rousskov at measurement-factory.com  Thu Aug 17 18:29:20 2023
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Thu, 17 Aug 2023 14:29:20 -0400
Subject: [squid-users] 'Transfer-Encoding: chunked,
 chunked' rejected by Squid
In-Reply-To: <20230815190447.Horde.0BLzx6aH8AqhVoL7xI6hdvq@webmail.intern.securepoint.de>
References: <20230815190447.Horde.0BLzx6aH8AqhVoL7xI6hdvq@webmail.intern.securepoint.de>
Message-ID: <5e2653f2-b87c-da9d-feaa-8fcac7a593ce@measurement-factory.com>

On 8/15/23 15:04, Andreas Weigel wrote:

> just in reference to 
> https://github.com/squid-cache/squid/pull/702#issuecomment-762459132, I 
> was made aware of a(nother) buggy server in the wild, that sends the 
> header quoted in the subject (Squid version 4.16) in its response: 
> https://riverbird.de. Squid rejects connection to that server with an 
> "Invalid response..." error message, while all browsers I used were able 
> to open the website.
> 
> The server seemingly only shows the behavior if 'Accept-Encoding: gzip' 
> is set in the request. The actual encoding used for the response is a 
> simple (single) chunked encoding.

FWIW, in my test, that server sent two identical "Transfer-Encoding: 
chunked" and many other duplicated header fields:

> HTTP/1.1 200 OK
> Date: Thu, 17 Aug 2023 16:44:46 GMT
> Server: Apache
> Link: ...
> Set-Cookie: <cookie1>
> Set-Cookie: <cookie2>
> Set-Cookie: <cookie2>
> Vary: Accept-Encoding
> X-Via-NSCOPI: 1.0
> X-Via-NSCOPI: 1.0
> Transfer-Encoding: chunked
> Transfer-Encoding: chunked
> Content-Type: text/html; charset=UTF-8
> Cache-Control: no-cache
> Cache-Control: no-cache
> Strict-Transport-Security: max-age=157680000
> Strict-Transport-Security: max-age=157680000; includeSubDomains
> Content-Encoding: gzip

I could not quickly check what the actual transfer encoding was.

Alex.



From rafael.akchurin at diladele.com  Sun Aug 20 14:47:57 2023
From: rafael.akchurin at diladele.com (Rafael Akchurin)
Date: Sun, 20 Aug 2023 14:47:57 +0000
Subject: [squid-users] [icap] rewritten transparent intercept tutorials for
 squid, mikrotik, ubuntu 20, debian 12 (nftables) and rhel 9 (firewalld)
Message-ID: <AM8PR04MB77451AE52D3076F9592A24F98F19A@AM8PR04MB7745.eurprd04.prod.outlook.com>

Hello everyone,

The three tutorials on how to configure transparent interception and inspection of HTTP and HTTP traffic using Squid 5 on Ubuntu 20, Debian 12 and RHEL 9 were rewritten and re-tested for correct working with latest Web Safety 8.6 ICAP filter.

The tutorials are:

  *   RHEL 9 - https://docs.diladele.com/tutorials/transparently_filtering_https_centos/index.html
  *   Debian 12 (nftables) - https://docs.diladele.com/tutorials/transparent_proxy_debian/index.html
  *   Mikrotik 7 + Ubuntu 20 - https://docs.diladele.com/tutorials/mikrotik_transparent_squid/index.html (policy based routing)
Hope you will find it useful.

Best regards,
Rafael Akchurin
Diladele B.V.


-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230820/e8c01a37/attachment.htm>

From callum.haywood at appliansys.com  Mon Aug 21 09:06:08 2023
From: callum.haywood at appliansys.com (Callum Haywood)
Date: Mon, 21 Aug 2023 09:06:08 +0000
Subject: [squid-users] Squid 6.2 with WCCP
Message-ID: <LO0P265MB5503918F5857C242D659CF91F01EA@LO0P265MB5503.GBRP265.PROD.OUTLOOK.COM>

Hi,

We are currently testing Squid 6.2 with WCCP. Running on Ubuntu 20.04.6 LTS with a GRE tunnel to a Cisco 2821.

We are seeing the following errors in the logs:

2023/08/18 10:13:02| ERROR: Ignoring WCCPv2 message: check failed: duplicate security definition
    exception location: wccp2.cc(1254) wccp2HandleUdp
2023/08/18 10:13:12| ERROR: Ignoring WCCPv2 message: check failed: duplicate security definition
    exception location: wccp2.cc(1254) wccp2HandleUdp
2023/08/18 10:13:22| ERROR: Ignoring WCCPv2 message: check failed: duplicate security definition
    exception location: wccp2.cc(1254) wccp2HandleUdp
2023/08/18 10:13:27| ERROR: Ignoring WCCPv2 message: check failed: WCCP packet type unsupported
    exception location: wccp2.cc(1226) wccp2HandleUdp
2023/08/18 10:13:32| ERROR: Ignoring WCCPv2 message: check failed: duplicate security definition
    exception location: wccp2.cc(1254) wccp2HandleUdp
2023/08/18 10:13:42| ERROR: Ignoring WCCPv2 message: check failed: duplicate security definition
    exception location: wccp2.cc(1254) wccp2HandleUdp

The squid config is attached (it is only used in a controlled test lab), as well as the complete log.

I have built Squid 4.15 on the same host and using the same config the Cisco is able to see Squid, send traffic, and there are no WCCP errors in the logs.

I have done a diff between the wccp2.cc source in 4.15 and 6.2 and see that there are quite a few changes. In the release notes I see "WCCP: Validate packets better".

Does anyone understand what is causing these errors? Are there any known issues or patches in progress?

Thanks
Callum

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230821/ab6bc521/attachment.htm>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: squid_wccp_minimal.conf
Type: application/octet-stream
Size: 1450 bytes
Desc: squid_wccp_minimal.conf
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230821/ab6bc521/attachment.obj>
-------------- next part --------------
An embedded and charset-unspecified text was scrubbed...
Name: squid_wccp_full_log.txt
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230821/ab6bc521/attachment.txt>

From rousskov at measurement-factory.com  Mon Aug 21 13:34:09 2023
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Mon, 21 Aug 2023 09:34:09 -0400
Subject: [squid-users] Squid 6.2 with WCCP
In-Reply-To: <LO0P265MB5503918F5857C242D659CF91F01EA@LO0P265MB5503.GBRP265.PROD.OUTLOOK.COM>
References: <LO0P265MB5503918F5857C242D659CF91F01EA@LO0P265MB5503.GBRP265.PROD.OUTLOOK.COM>
Message-ID: <a41412c6-936e-c6f1-d2fd-a204e71c1dc8@measurement-factory.com>

On 8/21/23 05:06, Callum Haywood wrote:

> We are currently testing Squid 6.2 with WCCP. Running on Ubuntu 20.04.6 
> LTS with a GRE tunnel to a Cisco 2821.
> 
> We are seeing the following errors in the logs:
> 
> 2023/08/18 10:13:02| ERROR: Ignoring WCCPv2 message: check failed: duplicate security definition
>  ? ? exception location: wccp2.cc(1254) wccp2HandleUdp

> I have built Squid 4.15 on the same host and using the same config the 
> Cisco is able to see Squid, send traffic, and there are no WCCP errors 
> in the logs.
> 
> I have done a diff between the wccp2.cc source in 4.15 and 6.2 and see 
> that there are quite a few changes. In the release notes I see "WCCP: 
> Validate packets better".

FWIW, that change is present in Squid v4.17 as well.


> Does anyone understand what is causing these errors? Are there any known 
> issues or patches in progress?

A few years ago, several serious problems were discovered in WCCP code, 
including security vulnerabilities:

https://github.com/squid-cache/squid/security/advisories/GHSA-rgf3-9v3p-qp82

Some of the WCCP bugs were fixed without testing; developers fixing 
those bugs could not easily test WCCP. Some of the old WCCP bugs 
remained and some of the new fixes were buggy.

Today, WCCP code remains problematic. If your customers rely on WCCP, 
consider investing into revamping that neglected and buggy feature.


Current Squid v4-v6 releases appear to be missing the following WCCP fix 
in master/v7 (but it will probably not address the "duplicate security 
definition" issue you are facing):

https://github.com/squid-cache/squid/commit/478eba2a3392c46b12cd5abf433ac4442d7515b7


HTH,

Alex.



From Robert.Zenz at bonsaimind.org  Mon Aug 21 16:58:22 2023
From: Robert.Zenz at bonsaimind.org (Robert 'Bobby' Zenz)
Date: Mon, 21 Aug 2023 18:58:22 +0200
Subject: [squid-users] Outgoing traffic through certain device instead
 of IP?
In-Reply-To: <ZNcu2mhPn9V/d4CC@fantomas.sk>
References: <20230811192309.1273c28b@Dagon>
	<ZNcu2mhPn9V/d4CC@fantomas.sk>
Message-ID: <20230821185822.6363f39d@Dagon>

> The system does not support selecting outgoing interface other way.

Do you mean with "system" Squid or Linux? Because Dante (SOCKS server)
does have that functionality.

As a note, in exchange Dante lacks the functionality of routing DNS
requests through the outgoing device/IP address.


From Robert.Zenz at bonsaimind.org  Mon Aug 21 17:01:13 2023
From: Robert.Zenz at bonsaimind.org (Robert 'Bobby' Zenz)
Date: Mon, 21 Aug 2023 19:01:13 +0200
Subject: [squid-users] Outgoing traffic through certain device instead
 of IP?
In-Reply-To: <54e67c3e-4677-4ebc-af91-d77c7f507523@treenet.co.nz>
References: <20230811192309.1273c28b@Dagon>
 <54e67c3e-4677-4ebc-af91-d77c7f507523@treenet.co.nz>
Message-ID: <20230821190113.33056c95@Dagon>

> Squid is limited to selecting certain details of the TCP packets.
> Device routing details are up to the operating system.

I thought as much, thanks for clarifying.

> You can have Squid can set dst-IP or TOS/QoS marking on packets. The
> OS routing services should be able to use those to do its selection.

That would also be a possibility, yes. That would be
`tcp_outgoing_mark` and `tcp_outgoing_tos`, right? I'm not seeing an
option to do that for UDP, though (DNS requests).


From uhlar at fantomas.sk  Mon Aug 21 17:04:14 2023
From: uhlar at fantomas.sk (Matus UHLAR - fantomas)
Date: Mon, 21 Aug 2023 19:04:14 +0200
Subject: [squid-users] Outgoing traffic through certain device instead
 of IP?
In-Reply-To: <20230821185822.6363f39d@Dagon>
References: <20230811192309.1273c28b@Dagon> <ZNcu2mhPn9V/d4CC@fantomas.sk>
 <20230821185822.6363f39d@Dagon>
Message-ID: <ZOOZDjEn8Q1dGMxB@fantomas.sk>

On 21.08.23 18:58, Robert 'Bobby' Zenz wrote:
>> The system does not support selecting outgoing interface other way.

>Do you mean with "system" Squid or Linux? Because Dante (SOCKS server)
>does have that functionality.

AFAIK, dante can detect which IP address different interface use and use 
those address (so you can define "eth0" instead of 192.0.2.1), but routing 
is still matter of kernel, so dante does not decide which way packets will
go through.

>As a note, in exchange Dante lacks the functionality of routing DNS
>requests through the outgoing device/IP address.

-- 
Matus UHLAR - fantomas, uhlar at fantomas.sk ; http://www.fantomas.sk/
Warning: I wish NOT to receive e-mail advertising to this address.
Varovanie: na tuto adresu chcem NEDOSTAVAT akukolvek reklamnu postu.
M$ Win's are shit, do not use it !


From Robert.Zenz at bonsaimind.org  Mon Aug 21 17:11:49 2023
From: Robert.Zenz at bonsaimind.org (Robert 'Bobby' Zenz)
Date: Mon, 21 Aug 2023 19:11:49 +0200
Subject: [squid-users] Outgoing traffic through certain device instead
 of IP?
In-Reply-To: <ZOOZDjEn8Q1dGMxB@fantomas.sk>
References: <20230811192309.1273c28b@Dagon> <ZNcu2mhPn9V/d4CC@fantomas.sk>
 <20230821185822.6363f39d@Dagon> <ZOOZDjEn8Q1dGMxB@fantomas.sk>
Message-ID: <20230821191149.25b6c60f@Dagon>

> AFAIK, dante can detect which IP address different interface use and
> use those address (so you can define "eth0" instead of 192.0.2.1), ...

How would that work? `tcp_outgoing_address` and `udp_outgoing_address`
only accept IP addresses, I'm not seeing another option which would
match those and allow to use a device name instead (my original
requirement).


From squid3 at treenet.co.nz  Tue Aug 22 12:16:20 2023
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Wed, 23 Aug 2023 00:16:20 +1200
Subject: [squid-users] Squid 6.2 with WCCP
In-Reply-To: <a41412c6-936e-c6f1-d2fd-a204e71c1dc8@measurement-factory.com>
References: <LO0P265MB5503918F5857C242D659CF91F01EA@LO0P265MB5503.GBRP265.PROD.OUTLOOK.COM>
 <a41412c6-936e-c6f1-d2fd-a204e71c1dc8@measurement-factory.com>
Message-ID: <60aa4884-6bd5-481b-9995-52636dda4d1f@treenet.co.nz>

On 22/08/23 01:34, Alex Rousskov wrote:
> On 8/21/23 05:06, Callum Haywood wrote:
>> 
>> Does anyone understand what is causing these errors? Are there any 
>> known issues or patches in progress?
> 
> A few years ago, several serious problems were discovered in WCCP code, 
> including security vulnerabilities:
> 
> https://github.com/squid-cache/squid/security/advisories/GHSA-rgf3-9v3p-qp82
> 
> Some of the WCCP bugs were fixed without testing; developers fixing 
> those bugs could not easily test WCCP. Some of the old WCCP bugs 
> remained and some of the new fixes were buggy.
> 
> Today, WCCP code remains problematic. If your customers rely on WCCP, 
> consider investing into revamping that neglected and buggy feature.
> 

This PR <https://github.com/squid-cache/squid/pull/970> has some 
progress towards a fix of those. See the latest comment (currently Sept 
2022) for issues that still need to be resolved before that PR is ready 
for merge attempt.

The major issue remains the ability to test.

HTH
Amos


From andre.bolinhas at articatech.com  Wed Aug 23 12:42:22 2023
From: andre.bolinhas at articatech.com (Andre Bolinhas)
Date: Wed, 23 Aug 2023 13:42:22 +0100
Subject: [squid-users] To many ERR_CANNOT_FORWARD
Message-ID: <4fa97b8b-5f78-4af5-afcd-7ef2eefa5f40@articatech.com>

Hi

I'm using squid 5.2 but stating yesterday I'm getting too many errors 
ERR_CANNOT_FORWARD for random websites.

What's could be the issue?

This is an extract of debug log

023/08/22 15:50:28.564 kid1| 5,5| ModEpoll.cc(118) SetSelect: FD 52, 
type=1, handler=0, client_data=0, timeout=0
2023/08/22 15:50:28.564 kid1| 5,3| IoCallback.cc(112) finish: called for 
conn6384666 local=10.100.16.50:3128 remote=10.100.16.27:55496 FD 52 
flags=1 (-10, 0)
2023/08/22 15:50:28.564 kid1| 5,4| AsyncCall.cc(97) ScheduleCall: 
IoCallback.cc(131) will call TunnelBlindCopyReadHandler(conn6384666 
local=10.100.16.50:3128 remote=10.100.16.27:55496 FD 52 flags=1, 
flag=-10, data=0x56227564b5a8, size=0, buf=0x5622759c8290) [call56950993]
2023/08/22 15:50:28.564 kid1| 5,5| comm.cc(740) commCallCloseHandlers: 
commCallCloseHandlers: FD 52
2023/08/22 15:50:28.564 kid1| 5,5| comm.cc(748) commCallCloseHandlers: 
commCallCloseHandlers: ch->handler=0x5622757a60a0*2
2023/08/22 15:50:28.564 kid1| 5,4| AsyncCall.cc(97) ScheduleCall: 
comm.cc(753) will call tunnelClientClosed(FD -1, data=0x56227564b5a8) 
[call56950752]
2023/08/22 15:50:28.564 kid1| 5,5| comm.cc(748) commCallCloseHandlers: 
commCallCloseHandlers: ch->handler=0x562274eace10*1
2023/08/22 15:50:28.564 kid1| 33,5| AsyncCall.cc(97) ScheduleCall: 
comm.cc(753) will call ConnStateData::connStateClosed(FD -1, 
data=0x562276b148e8) [call56950739]
2023/08/22 15:50:28.564 kid1| 5,4| AsyncCall.cc(30) AsyncCall: The 
AsyncCall comm_close_complete constructed, this=0x5622759deec0 
[call56951079]
2023/08/22 15:50:28.564 kid1| 5,4| AsyncCall.cc(97) ScheduleCall: 
comm.cc(949) will call comm_close_complete(FD 52) [call56951079]
2023/08/22 15:50:28.564 kid1| 5,4| AsyncCallQueue.cc(61) fireNext: 
leaving TunnelBlindCopyReadHandler(conn6384669 local=10.100.16.37:18006 
remote=20.90.216.0:443 HIER_DIRECT flags=1, data=0x56227564b5a8, size=0, 
buf=0x562275f76900)
2023/08/22 15:50:28.564 kid1| 5,4| AsyncCallQueue.cc(59) fireNext: 
entering tunnelServerClosed(FD -1, data=0x56227564b5a8)
2023/08/22 15:50:28.564 kid1| 5,4| AsyncCall.cc(42) make: make call 
tunnelServerClosed [call56950820]
2023/08/22 15:50:28.564 kid1| 26,3| tunnel.cc(752) noteClosure: 
conn6384669 local=10.100.16.37:18006 remote=20.90.216.0:443 HIER_DIRECT 
flags=1
2023/08/22 15:50:28.564 kid1| 46,5| access_log.cc(308) stopPeerClock: 
First connection started: 1692715828.514861, current total response time 
value: -1000
2023/08/22 15:50:28.564 kid1| 26,4| tunnel.cc(1338) saveError: [none] ? 
ERR_CANNOT_FORWARD
2023/08/22 15:50:28.564 kid1| 33,3| Pipeline.cc(35) front: Pipeline 
0x562276b14930 front 0x56227599bf50*2
2023/08/22 15:50:28.564 kid1| 1,5| CodeContext.cc(60) Entering: conn6384666
2023/08/22 15:50:28.564 kid1| 87,3| clientStream.cc(198) 
clientStreamDetach: clientStreamDetach: Detaching node 0x562274d4f668
2023/08/22 15:50:28.564 kid1| 87,3| clientStream.cc(97) 
~clientStreamNode: Freeing clientStreamNode 0x562274d4f668
2023/08/22 15:50:28.564 kid1| 87,3| clientStream.cc(219) 
clientStreamDetach: clientStreamDetach: Calling 1 with cbdata 0x562275fa1af8
2023/08/22 15:50:28.564 kid1| 87,3| clientStream.cc(198) 
clientStreamDetach: clientStreamDetach: Detaching node 0x5622749be5d8
2023/08/22 15:50:28.564 kid1| 87,3| clientStream.cc(97) 
~clientStreamNode: Freeing clientStreamNode 0x5622749be5d8
2023/08/22 15:50:28.564 kid1| 33,3| Pipeline.cc(57) popMe: Pipeline 
0x562276b14930 drop 0x56227599bf50*3
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230823/8ee68251/attachment.htm>

From uhlar at fantomas.sk  Wed Aug 23 12:55:12 2023
From: uhlar at fantomas.sk (Matus UHLAR - fantomas)
Date: Wed, 23 Aug 2023 14:55:12 +0200
Subject: [squid-users] Outgoing traffic through certain device instead
 of IP?
In-Reply-To: <20230821191149.25b6c60f@Dagon>
References: <20230811192309.1273c28b@Dagon> <ZNcu2mhPn9V/d4CC@fantomas.sk>
 <20230821185822.6363f39d@Dagon> <ZOOZDjEn8Q1dGMxB@fantomas.sk>
 <20230821191149.25b6c60f@Dagon>
Message-ID: <ZOYBsDa7oSGuq0Tm@fantomas.sk>

On 21.08.23 19:11, Robert 'Bobby' Zenz wrote:
>> AFAIK, dante can detect which IP address different interface use and
>> use those address (so you can define "eth0" instead of 192.0.2.1), ...

>How would that work? `tcp_outgoing_address` and `udp_outgoing_address`
>only accept IP addresses, I'm not seeing another option which would
>match those and allow to use a device name instead (my original
>requirement).

you'd find that the "eth0" interface has configured address 192.0.2.1 so 
you use 192.0.2.1 as outgoing address.

-- 
Matus UHLAR - fantomas, uhlar at fantomas.sk ; http://www.fantomas.sk/
Warning: I wish NOT to receive e-mail advertising to this address.
Varovanie: na tuto adresu chcem NEDOSTAVAT akukolvek reklamnu postu.
Honk if you love peace and quiet.


From squid3 at treenet.co.nz  Thu Aug 24 03:41:20 2023
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Thu, 24 Aug 2023 15:41:20 +1200
Subject: [squid-users] To many ERR_CANNOT_FORWARD
In-Reply-To: <4fa97b8b-5f78-4af5-afcd-7ef2eefa5f40@articatech.com>
References: <4fa97b8b-5f78-4af5-afcd-7ef2eefa5f40@articatech.com>
Message-ID: <625c38ee-1d43-49c1-ba62-e3aec6c9f951@treenet.co.nz>

On 24/08/23 00:42, Andre Bolinhas wrote:
> Hi
> 
> I'm using squid 5.2 but stating yesterday I'm getting too many errors 
> ERR_CANNOT_FORWARD for random websites.
> 

FYI, current Squid is 6.2 with 6.3 due out next week. Squid-5.x are 
officially end-of-life now.


> What's could be the issue?
> 
> This is an extract of debug log
> 


> 2023/08/22 15:50:28.564 kid1| 5,4| AsyncCallQueue.cc(61) fireNext: 
> leaving TunnelBlindCopyReadHandler(conn6384669 local=10.100.16.37:18006 
> remote=20.90.216.0:443 HIER_DIRECT flags=1, data=0x56227564b5a8, size=0, 
> buf=0x562275f76900)

One endpoint (20.90.216.0) of a CONNECT tunnel delivered the "end of 
connection" signal to Squid.

It looks like the server disconnected. Likely without having sent any 
actual protocol level response.


> 2023/08/22 15:50:28.564 kid1| 5,4| AsyncCallQueue.cc(59) fireNext: 
> entering tunnelServerClosed(FD -1, data=0x56227564b5a8)
> 2023/08/22 15:50:28.564 kid1| 5,4| AsyncCall.cc(42) make: make call 
> tunnelServerClosed [call56950820]
> 2023/08/22 15:50:28.564 kid1| 26,3| tunnel.cc(752) noteClosure: 
> conn6384669 local=10.100.16.37:18006 remote=20.90.216.0:443 HIER_DIRECT 
> flags=1
> 2023/08/22 15:50:28.564 kid1| 46,5| access_log.cc(308) stopPeerClock: 
> First connection started: 1692715828.514861, current total response time 
> value: -1000
> 2023/08/22 15:50:28.564 kid1| 26,4| tunnel.cc(1338) saveError: [none] ? 
> ERR_CANNOT_FORWARD


That negative response time looks a bit weird. Maybe just a display bug, 
or your machines NTP clock doing some "time travel" that makes Squid 
think an error happened.


Amos


From bpk678 at gmail.com  Sat Aug 26 17:53:58 2023
From: bpk678 at gmail.com (Brendan Kearney)
Date: Sat, 26 Aug 2023 13:53:58 -0400
Subject: [squid-users] sharing generated certs between squid instances
Message-ID: <f71e671a-9cbc-b303-cdec-68f6639f26a8@gmail.com>

list members,

i have a couple squid instances that are performing bump/peek/splice and 
generating dynamic certs.? i want to share the certs that are generated 
by the individual instances across the rest of them, via NFS or some 
shared mechanism.? so, if squid1 creates a certs i want squid2, squidN 
to be able to leverage that cert and not have to create the cert again.

having tried to put the certs on a NFS share, i am seeing that all of 
the instances run into file locking issues when updating the database 
file "index.txt".

is there any way to share the certs between instances to save processing 
power/time?

thanks in advance,

brendan



From Matthew at marrold.co.uk  Sun Aug 27 23:28:33 2023
From: Matthew at marrold.co.uk (Matthew H)
Date: Mon, 28 Aug 2023 00:28:33 +0100
Subject: [squid-users] How can I forward most requests to another proxy,
 except a few domains?
Message-ID: <CAC-Lcd9KJ6_B62rbUeWKqD-5JgberttceMb5tshp9fCBAZvKCQ@mail.gmail.com>

Hi all,

I'm trying to use squid to proxy requests to another upstream proxy,
but a few domains should go direct rather than via a proxy.

I've set up squid with a config that I believe should work, but if I
try to access http://dialup.cutel.net I get a 403 from squid and don't
see any requests go out to the origin. Everything via the proxy works
as expected.

One possible issue is I'm using "intercept" mode, and a router with
DSTNAT rules to forward requests to the proxy; however some of the
documents state that NAT must be done on the squid box itself?

Thanks

Config below:

#debug_options ALL,2

debug_options ALL,0 85,2 88,2

# ACL definitions

acl localnet src 127.0.0.1
acl rfc_1918 src 10.0.0.0/8
acl rfc_1918 src 172.16.0.0/12
acl rfc_1918 src 192.168.0.0/16
acl protoweb src 100.80.13.0/24
acl direct_sites dstdomain dialup.cutel.net

# Listen directives
http_port 3128
http_port 0.0.0.0:8080 intercept

# Only allow localhost to access the squid management interface
http_access allow localhost manager
http_access deny manager

# Only allow private and Dial-Up clients to connect to proxy
http_access allow localnet
http_access allow rfc_1918
http_access allow protoweb
http_access allow direct_sites
http_access deny all

always_direct allow direct_sites
always_direct deny all
never_direct deny direct_sites
never_direct allow all

cache_peer wayback.protoweb.org parent 7851 0 default proxy-only


From Matthew at marrold.co.uk  Mon Aug 28 00:11:54 2023
From: Matthew at marrold.co.uk (Matthew H)
Date: Mon, 28 Aug 2023 01:11:54 +0100
Subject: [squid-users] How can I forward most requests to another proxy,
 except a few domains?
In-Reply-To: <CAC-Lcd9KJ6_B62rbUeWKqD-5JgberttceMb5tshp9fCBAZvKCQ@mail.gmail.com>
References: <CAC-Lcd9KJ6_B62rbUeWKqD-5JgberttceMb5tshp9fCBAZvKCQ@mail.gmail.com>
Message-ID: <CAC-Lcd_CVoP9oKmbsxjfwP3J4Sx9Z9Nz_-jePUfx9RjCyJ7jCQ@mail.gmail.com>

> One possible issue is I'm using "intercept" mode, and a router with
> DSTNAT rules to forward requests to the proxy; however some of the
> documents state that NAT must be done on the squid box itself?

I've since remembered this is not quite accurate. I'm using a DNS
server to reply to all requests with the IP address of the squid
proxy.

If something is accessed directly via IP address its DSTNATed to the proxy

Thanks

On Mon, Aug 28, 2023 at 12:28?AM Matthew H <Matthew at marrold.co.uk> wrote:
>
> Hi all,
>
> I'm trying to use squid to proxy requests to another upstream proxy,
> but a few domains should go direct rather than via a proxy.
>
> I've set up squid with a config that I believe should work, but if I
> try to access http://dialup.cutel.net I get a 403 from squid and don't
> see any requests go out to the origin. Everything via the proxy works
> as expected.
>
> One possible issue is I'm using "intercept" mode, and a router with
> DSTNAT rules to forward requests to the proxy; however some of the
> documents state that NAT must be done on the squid box itself?
>
> Thanks
>
> Config below:
>
> #debug_options ALL,2
>
> debug_options ALL,0 85,2 88,2
>
> # ACL definitions
>
> acl localnet src 127.0.0.1
> acl rfc_1918 src 10.0.0.0/8
> acl rfc_1918 src 172.16.0.0/12
> acl rfc_1918 src 192.168.0.0/16
> acl protoweb src 100.80.13.0/24
> acl direct_sites dstdomain dialup.cutel.net
>
> # Listen directives
> http_port 3128
> http_port 0.0.0.0:8080 intercept
>
> # Only allow localhost to access the squid management interface
> http_access allow localhost manager
> http_access deny manager
>
> # Only allow private and Dial-Up clients to connect to proxy
> http_access allow localnet
> http_access allow rfc_1918
> http_access allow protoweb
> http_access allow direct_sites
> http_access deny all
>
> always_direct allow direct_sites
> always_direct deny all
> never_direct deny direct_sites
> never_direct allow all
>
> cache_peer wayback.protoweb.org parent 7851 0 default proxy-only


From ben.goz87 at gmail.com  Mon Aug 28 10:54:51 2023
From: ben.goz87 at gmail.com (Ben Goz)
Date: Mon, 28 Aug 2023 13:54:51 +0300
Subject: [squid-users] Squid ssl_bump splice configuration
Message-ID: <CADAqQfw1P8o5QekFcsyNZmSHr9DfpsyvHzN0Z2+xt6+BjF-5xw@mail.gmail.com>

?"?

I'm using squid version:
nativ at arachimprodsrv3:/usr/local/squid/etc$ /usr/local/squid/sbin/squid -v
Squid Cache: Version 6.1-VCS
Service Name: squid

This binary uses OpenSSL 3.0.2 15 Mar 2022. configure options:
 '--with-large-files' '--with-openssl' '--enable-ssl' '--enable-ssl-crtd'
'--enable-icap-client' '--enable-linux-netfilter' '--disable-ident-lookups'

Configured with ssl_bump and tproxy:
http_port 0.0.0.0:3128
http_port 0.0.0.0:3129 tproxy
https_port 0.0.0.0:3130 tproxy ssl-bump \
  cert=/usr/local/squid/etc/ssl_cert/myCA.pem \
  generate-host-certificates=on dynamic_cert_mem_cache_size=4MB
options=ALL,NO_SSLv3 sslflags=NO_DEFAULT_CA

And the following configurations:
acl NoSSLInterceptRegexp_always ssl::server_name "splice.list"
always_direct allow all
on_unsupported_protocol tunnel
acl DiscoverSNIHost at_step SslBump1
ssl_bump splice NoSSLInterceptRegexp_always
ssl_bump peek DiscoverSNIHost
ssl_bump bump all

the content of the file splice.list:
.prog.co.il
prog.co.il
www.prog.co.il
.shipuzim.info

The tproxy redirections works fine with squid server but unfortunately the
urls in splice.list bumped although they should be spliced as seen in the
access log:

1693219853.255    626 192.168.28.254 TCP_MISS/200 64439 GET
https://www.prog.co.il/ - HIER_DIRECT/172.67.196.36 text/html

And I see in the browser's certificate viewer my squid self signed
certificate.

What am I missing here?

Thanks,
Ben
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230828/f35905fa/attachment.htm>

From service.mv at gmail.com  Mon Aug 28 13:32:23 2023
From: service.mv at gmail.com (Service MV)
Date: Mon, 28 Aug 2023 10:32:23 -0300
Subject: [squid-users] How to upgrade correctly?
Message-ID: <CA+d==oGBaZP+W=6+W69gkUpZNawiUJtJegXUVM2Vh_Y5N6BJxQ@mail.gmail.com>

Hello everyone.
I have currently installed SQUID 5.8 compiled from source on Debian 10.5.
I want to upgrade to the latest stable version, 6.2.
What is the recommended way to upgrade to a new version? Should I uninstall
the old version first? Or do I compile the new one and it overwrites the
old one?

Thank you very much for any help you can give me.

My configuration:

./configure --includedir=/include \
--mandir=/share/man \
--infodir=/share/info \
--localstatedir=/opt/squid/var \
--disable-maintainer-mode \
--disable-dependency-tracking \
--disable-silent-rules \
--enable-inline \
--enable-async-io \
--enable-storeio=ufs,aufs,diskd \
--enable-removal-policies=lru,heap \
--enable-delay-pools \
--enable-cache-digests \
--enable-underscores \
--enable-icap-client \
--enable-follow-x-forwarded-for \
--enable-arp-acl \
--enable-esi--disable-translation \
--with-logdir=/var/log/squid \
--with-pidfile=/var/run/squid.pid \
--with-filedescriptors=65536 \
--with-large-files \
--with-default-user=proxy \
--enable-linux-netfilter \
--enable-ltdl-convenience \
--with-openssl \
--enable-ssl \
--enable-ssl-crtd \
--enable-snmp \
--disable-arch-native


make
make check
make install


--
Gabriel
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230828/d7cbffc8/attachment.htm>

From david at articatech.com  Mon Aug 28 14:54:18 2023
From: david at articatech.com (David Touzeau)
Date: Mon, 28 Aug 2023 16:54:18 +0200
Subject: [squid-users] 6.2: Unsupported or unexpected from-helper annotation
 with a name reserved for Squid use
Message-ID: <16ea56f0-2e7a-fe67-cf20-63924b049368@articatech.com>


Hi

Since 6.2 ( aka migrating from 5.8 )

Squid claim about token sent by external_acl_helper

the external acl helper send
"OK itchart=PASS user=dtouzeau category=143 category-name=Trackers 
clog=cinfo:143-Trackers;"

squid claim
2023/08/28 16:47:02 kid1| WARNING: Unsupported or unexpected from-helper 
annotation with a name reserved for Squid use: itchart=PASS
 ??? advice: If this is a custom annotation, rename it to add a trailing 
underscore: itchart_
 ??? current master transaction: master278
2023/08/28 16:47:02 kid1| WARNING: Unsupported or unexpected from-helper 
annotation with a name reserved for Squid use: category=143
 ??? advice: If this is a custom annotation, rename it to add a trailing 
underscore: category_
 ??? current master transaction: master278
2023/08/28 16:47:02 kid1| WARNING: Unsupported or unexpected from-helper 
annotation with a name reserved for Squid use: category-name=Trackers
 ??? advice: If this is a custom annotation, rename it to add a trailing 
underscore: category-name_
 ??? current master transaction: master278
2023/08/28 16:47:02 kid1| WARNING: Unsupported or unexpected from-helper 
annotation with a name reserved for Squid use: clog=cinfo:143-Trackers;
 ??? advice: If this is a custom annotation, rename it to add a trailing 
underscore: clog_
 ??? current master transaction: master278
2023/08/28 16:47:02 kid1| WARNING: Unsupported or unexpected from-helper 
annotation with a name reserved for Squid use: itchart=PASS
 ??? advice: If this is a custom annotation, rename it to add a trailing 
underscore: itchart_
 ??? current master transaction: master278

Did the helper instead of "itchart=PASS" must send

"itchart_=PASS"
or
"itchart_PASS"

?




-- 
David Touzeau - Artica Tech France
Development team, level 3 support
----------------------------------
P: +33 6 58 44 69 46
www:https://wiki.articatech.com
www:http://articatech.net  
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230828/189f7241/attachment.htm>

From ngtech1ltd at gmail.com  Mon Aug 28 18:01:38 2023
From: ngtech1ltd at gmail.com (ngtech1ltd at gmail.com)
Date: Mon, 28 Aug 2023 21:01:38 +0300
Subject: [squid-users] How to upgrade correctly?
In-Reply-To: <CA+d==oGBaZP+W=6+W69gkUpZNawiUJtJegXUVM2Vh_Y5N6BJxQ@mail.gmail.com>
References: <CA+d==oGBaZP+W=6+W69gkUpZNawiUJtJegXUVM2Vh_Y5N6BJxQ@mail.gmail.com>
Message-ID: <000001d9d9d9$b1bcc790$153656b0$@gmail.com>

Hey Gabriel,
 
The first thing before doing anything at all is to backup your binaries and configuration files.
Then try to plan a way that will allow you to fall back to the older version if anything will turn bad.
If you can test on a VM the installation process before production it would be the best way to make sure everything will go smooth
and as expected.
 
I believe that you will be able to just override the current squid installation if it will build fine.
Just make sure that the squid instance/service is not running while you are installing the new version.
 
If you have more specific questions feel free to ask.
 
Eliezer
 
 
From: squid-users <squid-users-bounces at lists.squid-cache.org> On Behalf Of Service MV
Sent: Monday, August 28, 2023 16:32
To: Squid Users <squid-users at lists.squid-cache.org>
Subject: [squid-users] How to upgrade correctly?
 
Hello everyone.
I have currently installed SQUID 5.8 compiled from source on Debian 10.5.
I want to upgrade to the latest stable version, 6.2.
What is the recommended way to upgrade to a new version? Should I uninstall the old version first? Or do I compile the new one and it overwrites the old one?

Thank you very much for any help you can give me.

My configuration:
./configure --includedir=/include \
--mandir=/share/man \
--infodir=/share/info \
--localstatedir=/opt/squid/var \
--disable-maintainer-mode \
--disable-dependency-tracking \
--disable-silent-rules \
--enable-inline \
--enable-async-io \
--enable-storeio=ufs,aufs,diskd \
--enable-removal-policies=lru,heap \
--enable-delay-pools \
--enable-cache-digests \
--enable-underscores \
--enable-icap-client \
--enable-follow-x-forwarded-for \
--enable-arp-acl \
--enable-esi--disable-translation \
--with-logdir=/var/log/squid \
--with-pidfile=/var/run/squid.pid \
--with-filedescriptors=65536 \
--with-large-files \
--with-default-user=proxy \
--enable-linux-netfilter \
--enable-ltdl-convenience \
--with-openssl \
--enable-ssl \
--enable-ssl-crtd \
--enable-snmp \
--disable-arch-native


make
make check
make install
 
 
--
Gabriel
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230828/46d80c90/attachment.htm>

From gkinkie at gmail.com  Mon Aug 28 20:46:06 2023
From: gkinkie at gmail.com (Francesco Chemolli)
Date: Mon, 28 Aug 2023 21:46:06 +0100
Subject: [squid-users] 6.2: Unsupported or unexpected from-helper
 annotation with a name reserved for Squid use
In-Reply-To: <16ea56f0-2e7a-fe67-cf20-63924b049368@articatech.com>
References: <16ea56f0-2e7a-fe67-cf20-63924b049368@articatech.com>
Message-ID: <CA+Y8hcMm2awUed15XXuTmkZAx+z2TAZz-X5NZYZP0k_3Qu7KVA@mail.gmail.com>

Hi David,
   you should use
itchart_=PASS

The trailing underscore signals Squid that this is a custom header.

On Mon, Aug 28, 2023 at 3:54?PM David Touzeau <david at articatech.com> wrote:

>
> Hi
>
> Since 6.2 ( aka migrating from 5.8 )
>
> Squid claim about token sent by external_acl_helper
>
> the external acl helper send
> "OK itchart=PASS user=dtouzeau category=143 category-name=Trackers
> clog=cinfo:143-Trackers;"
>
> squid claim
> 2023/08/28 16:47:02 kid1| WARNING: Unsupported or unexpected from-helper
> annotation with a name reserved for Squid use: itchart=PASS
>     advice: If this is a custom annotation, rename it to add a trailing
> underscore: itchart_
>     current master transaction: master278
> 2023/08/28 16:47:02 kid1| WARNING: Unsupported or unexpected from-helper
> annotation with a name reserved for Squid use: category=143
>     advice: If this is a custom annotation, rename it to add a trailing
> underscore: category_
>     current master transaction: master278
> 2023/08/28 16:47:02 kid1| WARNING: Unsupported or unexpected from-helper
> annotation with a name reserved for Squid use: category-name=Trackers
>     advice: If this is a custom annotation, rename it to add a trailing
> underscore: category-name_
>     current master transaction: master278
> 2023/08/28 16:47:02 kid1| WARNING: Unsupported or unexpected from-helper
> annotation with a name reserved for Squid use: clog=cinfo:143-Trackers;
>     advice: If this is a custom annotation, rename it to add a trailing
> underscore: clog_
>     current master transaction: master278
> 2023/08/28 16:47:02 kid1| WARNING: Unsupported or unexpected from-helper
> annotation with a name reserved for Squid use: itchart=PASS
>     advice: If this is a custom annotation, rename it to add a trailing
> underscore: itchart_
>     current master transaction: master278
>
> Did the helper instead of "itchart=PASS" must send
>
> "itchart_=PASS"
> or
> "itchart_PASS"
>
> ?
>
>
>
>
> --
> David Touzeau - Artica Tech France
> Development team, level 3 support
> ----------------------------------
> P: +33 6 58 44 69 46
> www: https://wiki.articatech.com
> www: http://articatech.net
>
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> https://lists.squid-cache.org/listinfo/squid-users
>


-- 
    Francesco
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230828/9433c91d/attachment.htm>

From david at articatech.com  Mon Aug 28 20:52:21 2023
From: david at articatech.com (David Touzeau)
Date: Mon, 28 Aug 2023 22:52:21 +0200
Subject: [squid-users] 6.2: Unsupported or unexpected from-helper
 annotation with a name reserved for Squid use
In-Reply-To: <CA+Y8hcMm2awUed15XXuTmkZAx+z2TAZz-X5NZYZP0k_3Qu7KVA@mail.gmail.com>
References: <16ea56f0-2e7a-fe67-cf20-63924b049368@articatech.com>
 <CA+Y8hcMm2awUed15XXuTmkZAx+z2TAZz-X5NZYZP0k_3Qu7KVA@mail.gmail.com>
Message-ID: <c00a816c-8e8a-d123-bf20-ebf138f949ba@articatech.com>

Thanks You

As these changes affect many things for us ( use tags for statistics / 
elasticsearchs) and it seems, this behavior is just a warning (seems 
squid still work as expected like note acls)

Is there a way to remove these warnings because they increase I/O and 
cache.log dramatically.

regards

On 28/08/2023 22:46, Francesco Chemolli wrote:
> Hi David,
> ? ?you should use
> itchart_=PASS
>
> The trailing underscore signals Squid that this is a custom header.
>
> On Mon, Aug 28, 2023 at 3:54?PM David Touzeau <david at articatech.com> 
> wrote:
>
>
>     Hi
>
>     Since 6.2 ( aka migrating from 5.8 )
>
>     Squid claim about token sent by external_acl_helper
>
>     the external acl helper send
>     "OK itchart=PASS user=dtouzeau category=143 category-name=Trackers
>     clog=cinfo:143-Trackers;"
>
>     squid claim
>     2023/08/28 16:47:02 kid1| WARNING: Unsupported or unexpected
>     from-helper annotation with a name reserved for Squid use:
>     itchart=PASS
>     ??? advice: If this is a custom annotation, rename it to add a
>     trailing underscore: itchart_
>     ??? current master transaction: master278
>     2023/08/28 16:47:02 kid1| WARNING: Unsupported or unexpected
>     from-helper annotation with a name reserved for Squid use:
>     category=143
>     ??? advice: If this is a custom annotation, rename it to add a
>     trailing underscore: category_
>     ??? current master transaction: master278
>     2023/08/28 16:47:02 kid1| WARNING: Unsupported or unexpected
>     from-helper annotation with a name reserved for Squid use:
>     category-name=Trackers
>     ??? advice: If this is a custom annotation, rename it to add a
>     trailing underscore: category-name_
>     ??? current master transaction: master278
>     2023/08/28 16:47:02 kid1| WARNING: Unsupported or unexpected
>     from-helper annotation with a name reserved for Squid use:
>     clog=cinfo:143-Trackers;
>     ??? advice: If this is a custom annotation, rename it to add a
>     trailing underscore: clog_
>     ??? current master transaction: master278
>     2023/08/28 16:47:02 kid1| WARNING: Unsupported or unexpected
>     from-helper annotation with a name reserved for Squid use:
>     itchart=PASS
>     ??? advice: If this is a custom annotation, rename it to add a
>     trailing underscore: itchart_
>     ??? current master transaction: master278
>
>     Did the helper instead of "itchart=PASS" must send
>
>     "itchart_=PASS"
>     or
>     "itchart_PASS"
>
>     ?
>
>
>
>
>     -- 
>     David Touzeau - Artica Tech France
>     Development team, level 3 support
>     ----------------------------------
>     P: +33 6 58 44 69 46
>     www:https://wiki.articatech.com
>     www:http://articatech.net  
>
>     _______________________________________________
>     squid-users mailing list
>     squid-users at lists.squid-cache.org
>     https://lists.squid-cache.org/listinfo/squid-users
>
>
>
> -- 
> ? ? Francesco

-- 
David Touzeau - Artica Tech France
Development team, level 3 support
----------------------------------
P: +33 6 58 44 69 46
www:https://wiki.articatech.com
www:http://articatech.net  
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230828/fe2cb1b6/attachment.htm>

From gkinkie at gmail.com  Mon Aug 28 20:59:50 2023
From: gkinkie at gmail.com (Francesco Chemolli)
Date: Mon, 28 Aug 2023 21:59:50 +0100
Subject: [squid-users] 6.2: Unsupported or unexpected from-helper
 annotation with a name reserved for Squid use
In-Reply-To: <c00a816c-8e8a-d123-bf20-ebf138f949ba@articatech.com>
References: <16ea56f0-2e7a-fe67-cf20-63924b049368@articatech.com>
 <CA+Y8hcMm2awUed15XXuTmkZAx+z2TAZz-X5NZYZP0k_3Qu7KVA@mail.gmail.com>
 <c00a816c-8e8a-d123-bf20-ebf138f949ba@articatech.com>
Message-ID: <CA+Y8hcOwENoGeAAFgRTDikePJ2EakkaH0n-_fdZ6c8eQp=Jq=w@mail.gmail.com>

That's a good question; not right now, unless you're willing to patch the
squid sources.
In that case, just remove the debugs() statement in lines 200-203 of file
src/helper/Reply.cc .



On Mon, Aug 28, 2023 at 9:52?PM David Touzeau <david at articatech.com> wrote:

> Thanks You
>
> As these changes affect many things for us ( use tags for statistics /
> elasticsearchs) and it seems, this behavior is just a warning (seems squid
> still work as expected like note acls)
>
> Is there a way to remove these warnings because they increase I/O and
> cache.log dramatically.
>
> regards
>
> On 28/08/2023 22:46, Francesco Chemolli wrote:
>
> Hi David,
>    you should use
> itchart_=PASS
>
> The trailing underscore signals Squid that this is a custom header.
>
> On Mon, Aug 28, 2023 at 3:54?PM David Touzeau <david at articatech.com>
> wrote:
>
>>
>> Hi
>>
>> Since 6.2 ( aka migrating from 5.8 )
>>
>> Squid claim about token sent by external_acl_helper
>>
>> the external acl helper send
>> "OK itchart=PASS user=dtouzeau category=143 category-name=Trackers
>> clog=cinfo:143-Trackers;"
>>
>> squid claim
>> 2023/08/28 16:47:02 kid1| WARNING: Unsupported or unexpected from-helper
>> annotation with a name reserved for Squid use: itchart=PASS
>>     advice: If this is a custom annotation, rename it to add a trailing
>> underscore: itchart_
>>     current master transaction: master278
>> 2023/08/28 16:47:02 kid1| WARNING: Unsupported or unexpected from-helper
>> annotation with a name reserved for Squid use: category=143
>>     advice: If this is a custom annotation, rename it to add a trailing
>> underscore: category_
>>     current master transaction: master278
>> 2023/08/28 16:47:02 kid1| WARNING: Unsupported or unexpected from-helper
>> annotation with a name reserved for Squid use: category-name=Trackers
>>     advice: If this is a custom annotation, rename it to add a trailing
>> underscore: category-name_
>>     current master transaction: master278
>> 2023/08/28 16:47:02 kid1| WARNING: Unsupported or unexpected from-helper
>> annotation with a name reserved for Squid use: clog=cinfo:143-Trackers;
>>     advice: If this is a custom annotation, rename it to add a trailing
>> underscore: clog_
>>     current master transaction: master278
>> 2023/08/28 16:47:02 kid1| WARNING: Unsupported or unexpected from-helper
>> annotation with a name reserved for Squid use: itchart=PASS
>>     advice: If this is a custom annotation, rename it to add a trailing
>> underscore: itchart_
>>     current master transaction: master278
>>
>> Did the helper instead of "itchart=PASS" must send
>>
>> "itchart_=PASS"
>> or
>> "itchart_PASS"
>>
>> ?
>>
>>
>>
>>
>> --
>> David Touzeau - Artica Tech France
>> Development team, level 3 support
>> ----------------------------------
>> P: +33 6 58 44 69 46
>> www: https://wiki.articatech.com
>> www: http://articatech.net
>>
>> _______________________________________________
>> squid-users mailing list
>> squid-users at lists.squid-cache.org
>> https://lists.squid-cache.org/listinfo/squid-users
>>
>
>
> --
>     Francesco
>
>
> --
> David Touzeau - Artica Tech France
> Development team, level 3 support
> ----------------------------------
> P: +33 6 58 44 69 46
> www: https://wiki.articatech.com
> www: http://articatech.net
>
>

-- 
    Francesco
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230828/ed876825/attachment.htm>

From rousskov at measurement-factory.com  Tue Aug 29 18:34:20 2023
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Tue, 29 Aug 2023 14:34:20 -0400
Subject: [squid-users] sharing generated certs between squid instances
In-Reply-To: <f71e671a-9cbc-b303-cdec-68f6639f26a8@gmail.com>
References: <f71e671a-9cbc-b303-cdec-68f6639f26a8@gmail.com>
Message-ID: <f927b50b-da64-4eb4-b6aa-124cd297e961@measurement-factory.com>

On 8/26/23 1:53 PM, Brendan Kearney wrote:
> list members,
> 
> i have a couple squid instances that are performing bump/peek/splice and 
> generating dynamic certs.? i want to share the certs that are generated 
> by the individual instances across the rest of them, via NFS or some 
> shared mechanism.? so, if squid1 creates a certs i want squid2, squidN 
> to be able to leverage that cert and not have to create the cert again.
> 
> having tried to put the certs on a NFS share, i am seeing that all of 
> the instances run into file locking issues when updating the database 
> file "index.txt".
> 
> is there any way to share the certs between instances to save processing 
> power/time?

I believe there is. Use a file system that supports the locking 
mechanism used by Squid (sorry, I cannot recommend anything specific, 
but something basic like sshfs might work in some environments) or 
implement your own certificate generation helper that does 
locking/sharing the way you want it to.

The generated certificates themselves are meant to be 
interchangeable/stable.


HTH,

Alex.



From ben.goz87 at gmail.com  Tue Aug 29 19:57:12 2023
From: ben.goz87 at gmail.com (Ben Goz)
Date: Tue, 29 Aug 2023 22:57:12 +0300
Subject: [squid-users] Squid ssl_bump splice configuration
In-Reply-To: <CADAqQfw1P8o5QekFcsyNZmSHr9DfpsyvHzN0Z2+xt6+BjF-5xw@mail.gmail.com>
References: <CADAqQfw1P8o5QekFcsyNZmSHr9DfpsyvHzN0Z2+xt6+BjF-5xw@mail.gmail.com>
Message-ID: <CADAqQfw_Nn8i523G74ovGri=f1C-b4On6CYwisP2PndMESgRng@mail.gmail.com>

?"?

I managed to get the ssl splice configurations to work but when I'm
splicing for example: play.google.com

I see in cache log the following:

2023/08/29 22:54:53.688 kid1| 33,2| client_side.cc(3214)
fakeAConnectRequest: fake a CONNECT request to force connState to tunnel
for ssl-bump
2023/08/29 22:54:53.700 kid1| 33,2| client_side.cc(3214)
fakeAConnectRequest: fake a CONNECT request to force connState to tunnel
for splice
2023/08/29 22:54:53 kid1| SECURITY ALERT: Host header forgery detected on
conn3362 local=172.217.22.110:443 remote=192.168.26.100:55331 FD 540
flags=17 (local IP does not match any domain IP)
    current master transaction: master2737
2023/08/29 22:54:53 kid1| SECURITY ALERT: on URL: play.google.com:443

The host header forgery issue for play.google.com is observed only for
spliced connections, but when this url is bumped I don't see this error.
Why is splicing making this error?




??????? ??? ??, 28 ????? 2023 ?-13:54 ??? ?Ben Goz?? <?ben.goz87 at gmail.com
??>:?

> ?"?
>
> I'm using squid version:
> nativ at arachimprodsrv3:/usr/local/squid/etc$ /usr/local/squid/sbin/squid -v
> Squid Cache: Version 6.1-VCS
> Service Name: squid
>
> This binary uses OpenSSL 3.0.2 15 Mar 2022. configure options:
>  '--with-large-files' '--with-openssl' '--enable-ssl' '--enable-ssl-crtd'
> '--enable-icap-client' '--enable-linux-netfilter' '--disable-ident-lookups'
>
> Configured with ssl_bump and tproxy:
> http_port 0.0.0.0:3128
> http_port 0.0.0.0:3129 tproxy
> https_port 0.0.0.0:3130 tproxy ssl-bump \
>   cert=/usr/local/squid/etc/ssl_cert/myCA.pem \
>   generate-host-certificates=on dynamic_cert_mem_cache_size=4MB
> options=ALL,NO_SSLv3 sslflags=NO_DEFAULT_CA
>
> And the following configurations:
> acl NoSSLInterceptRegexp_always ssl::server_name "splice.list"
> always_direct allow all
> on_unsupported_protocol tunnel
> acl DiscoverSNIHost at_step SslBump1
> ssl_bump splice NoSSLInterceptRegexp_always
> ssl_bump peek DiscoverSNIHost
> ssl_bump bump all
>
> the content of the file splice.list:
> .prog.co.il
> prog.co.il
> www.prog.co.il
> .shipuzim.info
>
> The tproxy redirections works fine with squid server but unfortunately the
> urls in splice.list bumped although they should be spliced as seen in the
> access log:
>
> 1693219853.255    626 192.168.28.254 TCP_MISS/200 64439 GET
> https://www.prog.co.il/ - HIER_DIRECT/172.67.196.36 text/html
>
> And I see in the browser's certificate viewer my squid self signed
> certificate.
>
> What am I missing here?
>
> Thanks,
> Ben
>
>
>
>
>
>
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230829/2546512c/attachment.htm>

From squid3 at treenet.co.nz  Tue Aug 29 21:54:01 2023
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Wed, 30 Aug 2023 09:54:01 +1200
Subject: [squid-users] How to upgrade correctly?
In-Reply-To: <000001d9d9d9$b1bcc790$153656b0$@gmail.com>
References: <CA+d==oGBaZP+W=6+W69gkUpZNawiUJtJegXUVM2Vh_Y5N6BJxQ@mail.gmail.com>
 <000001d9d9d9$b1bcc790$153656b0$@gmail.com>
Message-ID: <7d8215ec-07cd-4486-9d3a-1d64f3f53b5a@treenet.co.nz>

You should only need to:

  * stop squid

  * backup your existing installation (as mentioned by Eliezer)

  * install the current Debian "squid-openssl" package

  * run "squid -k parse" to check for squid.conf settings upgrade

  * manually check what "/opt/squid/var" was being used for;
     - any configuration related files need to be updated to the 
/etc/squid system location.
     - any logs etc in there being used by scripts or non-squid other 
software need those third-party code to be updated to the new squid 
default log locations.

  * start squid


HTH
Amos


From squid3 at treenet.co.nz  Tue Aug 29 23:30:10 2023
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Wed, 30 Aug 2023 11:30:10 +1200
Subject: [squid-users] Squid ssl_bump splice configuration
In-Reply-To: <CADAqQfw_Nn8i523G74ovGri=f1C-b4On6CYwisP2PndMESgRng@mail.gmail.com>
References: <CADAqQfw1P8o5QekFcsyNZmSHr9DfpsyvHzN0Z2+xt6+BjF-5xw@mail.gmail.com>
 <CADAqQfw_Nn8i523G74ovGri=f1C-b4On6CYwisP2PndMESgRng@mail.gmail.com>
Message-ID: <a8386946-cd2c-4f11-81b3-b7ca079ce9cd@treenet.co.nz>

On 30/08/23 07:57, Ben Goz wrote:
> ?"?
> 
> I managed to get the ssl splice configurations to work but when I'm 
> splicing for example: play.google.com <http://play.google.com>
> 
> I see in cache log the following:
> 
> 2023/08/29 22:54:53.688 kid1| 33,2| client_side.cc(3214) 
> fakeAConnectRequest: fake a CONNECT request to force connState to tunnel 
> for ssl-bump
> 2023/08/29 22:54:53.700 kid1| 33,2| client_side.cc(3214) 
> fakeAConnectRequest: fake a CONNECT request to force connState to tunnel 
> for splice
> 2023/08/29 22:54:53 kid1| SECURITY ALERT: Host header forgery detected 
> on conn3362 local=172.217.22.110:443 <http://172.217.22.110:443> 
> remote=192.168.26.100:55331 <http://192.168.26.100:55331> FD 540 
> flags=17 (local IP does not match any domain IP)
>  ? ? current master transaction: master2737
> 2023/08/29 22:54:53 kid1| SECURITY ALERT: on URL: play.google.com:443 
> <http://play.google.com:443>
> 
> The host header forgery issue for play.google.com 
> <http://play.google.com> is observed only for spliced connections, but 
> when this url is bumped I don't see this error.
> Why is splicing making this error?


Likely because splice is emulating a client-generated CONNECT request, 
which then faces the same forgery checks that hits the issues Google DNS 
TTL choices cause with the forgery detection. That is just an educated 
guess though.



> 
> 
> ??????? ??? ??, 28 ????? 2023 ?-13:54 ??? ?Ben Goz?? 
> :?
> 
>     ?"?
> 
>     I'm using squid version:
>     nativ at arachimprodsrv3:/usr/local/squid/etc$
>     /usr/local/squid/sbin/squid -v
>     Squid Cache: Version 6.1-VCS
>     Service Name: squid
> 
>     This binary uses OpenSSL 3.0.2 15 Mar 2022. configure options:
>      ?'--with-large-files' '--with-openssl' '--enable-ssl'

FYI "--enable-ssl" no longer exists.

It was replaced by "--with-openssl".


>     '--enable-ssl-crtd' '--enable-icap-client'
>     '--enable-linux-netfilter' '--disable-ident-lookups'
> 
>     Configured with ssl_bump and tproxy:
>     http_port 0.0.0.0:3128 <http://0.0.0.0:3128>
>     http_port 0.0.0.0:3129 <http://0.0.0.0:3129> tproxy
>     https_port 0.0.0.0:3130 <http://0.0.0.0:3130> tproxy ssl-bump \
>      ? cert=/usr/local/squid/etc/ssl_cert/myCA.pem \
>      ? generate-host-certificates=on dynamic_cert_mem_cache_size=4MB
>     options=ALL,NO_SSLv3 sslflags=NO_DEFAULT_CA

Use tls-default-ca=off instead of the deprecated sslflags=NO_DEFAULT_CA.



> 
>     And the following configurations:
>     acl NoSSLInterceptRegexp_always ssl::server_name "splice.list"
>     always_direct allow all

The above line tells Squid to never use cache_peer.

Without cache_peer directives to ignore this is just a pointless waste 
of Squid CPU cycles.



>     on_unsupported_protocol tunnel
>     acl DiscoverSNIHost at_step SslBump1
>     ssl_bump splice NoSSLInterceptRegexp_always
>     ssl_bump peek DiscoverSNIHost
>     ssl_bump bump all
> 
>     the content of the file splice.list:
>     .prog.co.il
>     prog.co.il
>     www.prog.co.il

These later two patterns are sub-sets of the first pattern. The 
resulting pattern tree may be producing false negative ACL matches.


> 
>     The tproxy redirections works fine with squid server but
>     unfortunately the urls in splice.list bumped although they should be
>     spliced as seen in the access log:
> 
>     1693219853.255 ? ?626 192.168.28.254 TCP_MISS/200 64439 GET
>     https://www.prog.co.il/ -
>     HIER_DIRECT/172.67.196.36 text/html
> 
>     And I see in the browser's certificate viewer my squid self signed
>     certificate.
> 
>     What am I missing here?
> 


Not clear. Maybe adding the TLS SNI, server certificate serverAltName 
field, ssl-bump stage/decision, and Host header (specifically the 
header, not the URI domain) to your log may show something useful.

HTH
Amos


