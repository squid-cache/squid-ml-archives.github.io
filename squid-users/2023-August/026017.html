<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] How to apply a low delay_pool to users that become OVERCUOTE, over certains domains and sites.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20How%20to%20apply%20a%20low%20delay_pool%20to%20users%20that%20become%0A%20OVERCUOTE%2C%20over%20certains%20domains%20and%20sites.&In-Reply-To=%3CCAJXDObbpAtTA5jAVWvGHSujC__wOS9Za89ZS%2BjvcpT3DGXdF_Q%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   
   <LINK REL="Next"  HREF="026018.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] How to apply a low delay_pool to users that become OVERCUOTE, over certains domains and sites.</H1>
    <B>Francisco</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20How%20to%20apply%20a%20low%20delay_pool%20to%20users%20that%20become%0A%20OVERCUOTE%2C%20over%20certains%20domains%20and%20sites.&In-Reply-To=%3CCAJXDObbpAtTA5jAVWvGHSujC__wOS9Za89ZS%2BjvcpT3DGXdF_Q%40mail.gmail.com%3E"
       TITLE="[squid-users] How to apply a low delay_pool to users that become OVERCUOTE, over certains domains and sites.">frizquierdo87 at gmail.com
       </A><BR>
    <I>Tue Aug  1 03:37:30 UTC 2023</I>
    <P><UL>
        
        <LI>Next message (by thread): <A HREF="026018.html">[squid-users] compile error in squid v6.1
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26017">[ date ]</a>
              <a href="thread.html#26017">[ thread ]</a>
              <a href="subject.html#26017">[ subject ]</a>
              <a href="author.html#26017">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I have an external ACL that check if users are OVERCUOTE (exceed assigned
cuote in MB), on this case those users can't browser certains domains and
sites specified in certain acl (domains_cuote, parcials_domains_cuote,
sites_cuote). The problem is that Squid doesn't interrupt stablished
connections for example youtube video play and OVERCUOTE user continue
video reproduction until  the video it is not finished (I'm not referring
to the case of the buffer that the video player managed to load before the
user became OVERCUOTE), although the rest of web browsing is limited
correctly, and his account is marked as exceeded (OVERCUOTE).

I need a delay_pool to OVERCUOTE users for reduce to minimun (for example
1Kbit/s) the download rate over specifcs domains and sites until the user
cuote will be restablished,
For this scenario i have an internet link with only 2Mbps (very poor).

I need help with possible delay pools config that help me. I don't
understand very well delays_pool
The idea is that the delay_pool limits web browsing on the domains and
sites specified by the acl for users exceeding the assigned quota.

## Auth config
auth_param basic program /usr/lib/squid/basic_db_auth --dsn
&quot;DBI:mysql:database=squidmgr&quot; --user dbuser --password dbpassword --table
&quot;proxy_user&quot; --usercol &quot;squid_user_identifier&quot; --passwdcol &quot;passwd&quot; --cond
&quot;enabled = 1&quot; --md5 --persist
auth_param basic children 15 startup=10 idle=1
auth_param basic realm Web-Proxy
auth_param basic credentialsttl 30 minute
auth_param basic casesensitive on
authenticate_ip_ttl 30 minute

acl AUTHENTICATED proxy_auth REQUIRED

##ACL check if user is cuote exceeded. An external script count users
consumption every xx seconds and update database, it work successfull.
external_acl_type CHECKOVERCUOTE concurrency=100 ttl=3 children-max=50
children-startup=15 children-idle=5  %LOGIN
/usr/lib/squid/ext_sql_session_acl --dsn &quot;DBI:mysql:database=squidmgr&quot;
--user dbuser --password dbpassword --table &quot;proxy_user&quot; --uidcol
&quot;squid_user_identifier&quot; --usercol &quot;squid_user_identifier&quot; --cond &quot;overcuote
= 1&quot;
acl OVERCUOTE external CHECKOVERCUOTE

## Resources to take in user cuote
acl domains_cuote dstdomain &quot;/etc/squid/resources/domains_cuote.db&quot;
acl parcials_domains_cuote dstdomain
&quot;/etc/squid/resources/parcials_domains_cuote.db&quot;
acl sites_cuote url_regex -i &quot;/etc/squid/resources/sites_cuote.db&quot;

## RULES
http_access allow !domains_cuote !OVERCUOTE
http_access allow !parcials_domains_cuote !OVERCUOTE
http_access allow !sites_cuote !OVERCUOTE

http_access allow CONNECT SSL_ports !domains_cuote !OVERCUOTE
http_access allow CONNECT SSL_ports !parcials_domains_cuote !OVERCUOTE
http_access allow CONNECT SSL_ports !sites_cuote !OVERCUOTE

deny_info <A HREF="https://proxy.lan/proxyerrors?type=OVERCUOTE">https://proxy.lan/proxyerrors?type=OVERCUOTE</A> CONNECT SSL_ports
domains_cuote OVERCUOTE
deny_info <A HREF="https://proxy.lan/proxyerrors?type=OVERCUOTE">https://proxy.lan/proxyerrors?type=OVERCUOTE</A> CONNECT SSL_ports
parcials_domains_cuote OVERCUOTE
deny_info <A HREF="https://proxy.lan/proxyerrors?type=OVERCUOTE">https://proxy.lan/proxyerrors?type=OVERCUOTE</A> CONNECT SSL_ports
sites_cuote OVERCUOTE

deny_info <A HREF="http://proxy.lan/proxyerrors?type=OVERCUOTE">http://proxy.lan/proxyerrors?type=OVERCUOTE</A> domains_cuote
OVERCUOTE
deny_info <A HREF="http://proxy.lan/proxyerrors?type=OVERCUOTE">http://proxy.lan/proxyerrors?type=OVERCUOTE</A>
parcials_domains_cuote OVERCUOTE
deny_info <A HREF="http://proxy.lan/proxyerrors?type=OVERCUOTE">http://proxy.lan/proxyerrors?type=OVERCUOTE</A> sites_cuote OVERCUOTE

http_access allow AUTHENTICATED
http_access deny all
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20230731/a8d527a4/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20230731/a8d527a4/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	
	<LI>Next message (by thread): <A HREF="026018.html">[squid-users] compile error in squid v6.1
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26017">[ date ]</a>
              <a href="thread.html#26017">[ thread ]</a>
              <a href="subject.html#26017">[ subject ]</a>
              <a href="author.html#26017">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
