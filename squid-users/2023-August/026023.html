<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Problem with 6.1 squidclient mgr:
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Problem%20with%206.1%20squidclient%20mgr%3A&In-Reply-To=%3C52c05fbc-ffb3-aa2b-733c-ec2345665689%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="026022.html">
   <LINK REL="Next"  HREF="026024.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Problem with 6.1 squidclient mgr:</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Problem%20with%206.1%20squidclient%20mgr%3A&In-Reply-To=%3C52c05fbc-ffb3-aa2b-733c-ec2345665689%40measurement-factory.com%3E"
       TITLE="[squid-users] Problem with 6.1 squidclient mgr:">rousskov at measurement-factory.com
       </A><BR>
    <I>Wed Aug  2 14:16:06 UTC 2023</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="026022.html">[squid-users] Range Requests
</A></li>
        <LI>Next message (by thread): <A HREF="026024.html">[squid-users] squid 6.1 esi compile error, ubuntu 22.04
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26023">[ date ]</a>
              <a href="thread.html#26023">[ thread ]</a>
              <a href="subject.html#26023">[ subject ]</a>
              <a href="author.html#26023">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 7/31/23 09:47, Alex Rousskov wrote:
&gt;<i> On 7/31/23 06:13, G&#233;rard Parat wrote:
</I>&gt;<i> 
</I>&gt;&gt;<i> I use Squid as a Windows 10 service with Cygwin since 5.7 release.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I usually monitor activity with squidclient mgr: but since 6.1 it
</I>&gt;&gt;<i> doesn't work anymore:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &#160;&#160; * HTTP/1.1 403 Forbidden
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> However, squidclient cache_<A HREF="object://localhost/">object://localhost/</A> is working fine.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Is there new options to add to squid.conf to access mgr: ?
</I>&gt;<i> 
</I>&gt;<i> Does your Squid identify itself as &quot;localhost&quot; in Via headers and other 
</I>&gt;<i> output? If not, you are probably suffering from bug #5283:
</I>&gt;<i> <A HREF="https://bugs.squid-cache.org/show_bug.cgi?id=5283">https://bugs.squid-cache.org/show_bug.cgi?id=5283</A>
</I>&gt;<i> 
</I>&gt;<i> There are several workarounds, including Squid patches, but no long-term 
</I>&gt;<i> solution yet. If you do not want to patch Squid, use &quot;squidclient -h...&quot; 
</I>&gt;<i> as suggested at <A HREF="https://bugs.squid-cache.org/show_bug.cgi?id=5283#c1">https://bugs.squid-cache.org/show_bug.cgi?id=5283#c1</A>
</I>
Just an update in case somebody else suffers from this problem and reads 
this thread: After looking through G&#233;rard's debugging logs, I can 
confirm that this setup suffers from Squid bug #5283, and that 
&quot;squidclient -h&quot; workaround helps. However, that workaround is not 
sufficient in this particular use case because

1. Like many Squids, this Squid is configured to allow manager requests 
sent from localhost only. When &quot;squidclient -h example.text mgr:info&quot; 
runs on the same host as Squid, and example.test resolves to something 
other than a localhost address (e.g., 192.168.28.150), squidclient 
connects from that other IP address, and Squid denies that request 
because the manager ACL matches but the localhost ACL does not.

2. On Linux, the problem in item 1 above can be overcome by telling 
squidclient (that runs on the same host as Squid) to connect from 
127.0.0.1 or another localhost address. For example:

     squidclient -v -l 127.0.0.1 -h example.text mgr:info

However, in some environments (e.g., Windows 10?), it is not possible to 
connect from 127.0.0.1 to, say, 192.168.28.150, even if both IPs belong 
to the same host where squidclient is executed. In those environments, 
forcing source address results in a squidclient TCP connection 
establishment failure:

     $ squidclient -v -l 127.0.0.1 -h example.text mgr:info
     ...
     Transport detected: IPv4-mapped  and IPv6
     Resolving 127.0.0.1 ...
     Resolving... example.test
     Connecting... example.test (192.168.28.150:3128)
     ERROR: Cannot connect to 192.168.28.150:3128

Some client have &quot;resolve DNS name X as IP address Y&quot; features (e.g., 
&quot;curl --resolve&quot;) that can be used to work around item 2 problems, but 
squidclient lacks those.


HTH,

Alex.

--- cache.log analysis ---

All three cases below were handled as I would expect them to be handled 
given the current set of known Squid problems. SelfName or 
&quot;example.test&quot; is the host name that this Squid identifies itself as *in 
cache manager request handling context*. In general, SelfName may be 
different from the name used in Via and Cache-Status headers, 
complicating the issues further. In this setup, they are the same.


## Case A: Request not matching SelfName of the receiving Squid

     $ squidclient mgr:info

     ... HTTP Client local=[::1]:3128 remote=[::1]
     GET <A HREF="http://localhost:3128/squid-internal-mgr/info">http://localhost:3128/squid-internal-mgr/info</A> HTTP/1.0
     Host: localhost:3128
     User-Agent: squidclient/6.1


The above squidclient request is not recognized as a request to the 
cache manager of the receiving Squid because receiving Squid's SelfName 
is example.test rather than localhost. Squid bug #5283 is relevant here.

Receiving Squid (let's call it Squid A) forwards the above request to 
the server at localhost:3128 address (let's call that Squid B). In this 
test, Squid A and Squid B are the same Squid instance, but Squid 
forwarding code does not know that. Forwarding a request from Squid A 
instance to (the same) Squid B instance creates a forwarding loop:

     2023/08/01 11:14:15| WARNING: Forwarding loop detected for:
     GET /squid-internal-mgr/info HTTP/1.1
     Host: example.test:3128
     User-Agent: squidclient/6.1
     Via: 1.0 example.test (squid/6.1)

Squid B denies the request because Squid B has detected the above 
forwarding loop and all forwarding loops are blocked:

     HTTP/1.1 403 Forbidden
     Server: squid/6.1
     X-Squid-Error: ERR_ACCESS_DENIED 0
     Cache-Status: example.test;detail=mismatch
     Via: 1.1 example.test (squid/6.1)

Squid A forwards the above denial response to squidclient (note the two 
Cache-Status fields and two Via field values):

     HTTP/1.1 403 Forbidden
     Server: squid/6.1
     X-Squid-Error: ERR_ACCESS_DENIED 0
     Cache-Status: example.test;detail=mismatch
     Via: 1.1 example.test (squid/6.1),
          1.1 example.test (squid/6.1)
     Cache-Status: example.test;detail=no-cache


## Case B: Not-from-localhost request

     $ squidclient -h example.test mgr:info

     ... HTTP Client local=192.168.28.150:3128 remote=192.168.28.150
     GET <A HREF="http://example.test:3128/squid-internal-mgr/info">http://example.test:3128/squid-internal-mgr/info</A> HTTP/1.0
     Host: example.test:3128
     User-Agent: squidclient/6.1

The above squidclient request is recognized as a request to the cache 
manager of the receiving Squid and denied because access is from 
192.168.28.150 rather than localhost.

     HTTP/1.1 403 Forbidden
     X-Squid-Error: ERR_ACCESS_DENIED 0
     Cache-Status: example.test
     Via: 1.1 example.test (squid/6.1)


## Case C: Request using a relative URL

     $ curl <A HREF="http://localhost:3128/squid-internal-mgr/info">http://localhost:3128/squid-internal-mgr/info</A>

     ... HTTP Client local=127.0.0.1:3128 remote=127.0.0.1
     GET /squid-internal-mgr/info HTTP/1.1
     Host: localhost:3128
     User-Agent: Mozilla/5.0...

The above browser request was recognized as a request to the cache 
manager of the receiving Squid because the receiving Squid ignores the 
Host header when receiving a relative URL and creates an absolute URL 
with its own SelfName:

     checking '<A HREF="http://example.test:3128/squid-internal-mgr/info">http://example.test:3128/squid-internal-mgr/info</A>'

This is a known Squid bug already marked in Squid sources. If that bug 
is fixed (without any other fixes), the above to-localhost request would 
be denied as well.

That refactored URL matches SelfName, of course. The request came from a 
localhost-matching address. It is allowed/processed:

     HTTP/1.1 200 OK
     Server: squid/6.1
     Cache-Status: example.test;detail=mismatch
     Via: 1.1 example.test (squid/6.1)



</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="026022.html">[squid-users] Range Requests
</A></li>
	<LI>Next message (by thread): <A HREF="026024.html">[squid-users] squid 6.1 esi compile error, ubuntu 22.04
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26023">[ date ]</a>
              <a href="thread.html#26023">[ thread ]</a>
              <a href="subject.html#26023">[ subject ]</a>
              <a href="author.html#26023">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
