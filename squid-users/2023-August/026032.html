<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Sockets not closed after ICAP receivedWholeAdaptedReply
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Sockets%20not%20closed%20after%20ICAP%0A%20receivedWholeAdaptedReply&In-Reply-To=%3CNbQZniy--R-9%40fuchus.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="026031.html">
   <LINK REL="Next"  HREF="026033.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Sockets not closed after ICAP receivedWholeAdaptedReply</H1>
    <B>mailing at fuchus.de</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Sockets%20not%20closed%20after%20ICAP%0A%20receivedWholeAdaptedReply&In-Reply-To=%3CNbQZniy--R-9%40fuchus.de%3E"
       TITLE="[squid-users] Sockets not closed after ICAP receivedWholeAdaptedReply">mailing at fuchus.de
       </A><BR>
    <I>Wed Aug  9 18:33:27 UTC 2023</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="026031.html">[squid-users] Recent Squid 4 versions show ERR_CANNOT_FORWARD instead of ERR_DNS_FAIL
</A></li>
        <LI>Next message (by thread): <A HREF="026033.html">[squid-users] Sockets not closed after ICAP receivedWholeAdaptedReply
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26032">[ date ]</a>
              <a href="thread.html#26032">[ thread ]</a>
              <a href="subject.html#26032">[ subject ]</a>
              <a href="author.html#26032">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

we have been having some issues lately with our Squid proxies on version 6.1.

We also have the patch for the REQMOD satisfaction regression installed: <A HREF="https://github.com/squid-cache/squid/pull/1400">https://github.com/squid-cache/squid/pull/1400</A>

The issue:

When there is a request sent to the ICAP server and the ICAP server is replying with a modified response, this modified response, after checking through receivedWholeAdeptedReply, doesn't set a BAD_LENGTH, which usually turns into a STREAM_UNPLANNED_COMPLETE, but rather a STREAM_COMPLETE (in Http::Stream::writeComplete). This in turn calls ConnStateData::kick on the current context, which has an empty pipeline at some point. Because this case is not specifically checked and the connection is just abandoned, the socket is never removed. This causes a lot of open connections and a high amount of file descriptors for the corresponding squid processes that we frequently run into limits.

As a hot fix I made the following changes in order to accommodate for this specific case:

--- a/src/client_side.cc
+++ a/src/client_side.cc
@@ -989,6 +989,9 @@ ConnStateData::kick()
&#160;&#160;&#160;&#160; } else if (flags.readMore) {
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; debugs(33, 3, clientConnection &lt;&lt; &quot;: calling readNextRequest()&quot;);
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; readNextRequest();
+&#160;&#160;&#160; } else if (pipeline.empty()) {
+&#160;&#160;&#160;&#160;&#160;&#160;&#160; debugs(33, 3, &quot;pipeline is empty - closing connection&quot;);
+&#160;&#160;&#160;&#160;&#160;&#160;&#160; clientConnection-&gt;close();
&#160;&#160;&#160;&#160; } else {
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; // XXX: Can this happen? CONNECT tunnels have deferredRequest set.
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; debugs(33, DBG_IMPORTANT, MYNAME &lt;&lt; &quot;abandoning &quot; &lt;&lt; clientConnection);

This issue also seems to happen if the ICAP server has specific responses - it seems as if the STREAM_COMPLETE case happens (implying receivedWholeAdaptedReply) if there is a Connection: closed response from ICAP, rather than Connection: keep-alive. In the latter case, the connection is torn down with a STREAM_UNPLANNED_COMPLETE. The patch, setting receivedWholeAdaptedReply always to true in those cases also means that the connection is never closed and abandoned all the time if it includes REQMOD it seems, rather than just doing that if the response from ICAP implies a closed connection.

I was not able to reproduce the issue with version 5.8 as of now, so this seems to be something specific to 6.1.

Do you have any remarks on the change? Maybe you have some more insight on the interplay of the code or what seems to be causing the issue in detail.
Sincerely,

Leonardo Martinho
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20230809/51de9316/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20230809/51de9316/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="026031.html">[squid-users] Recent Squid 4 versions show ERR_CANNOT_FORWARD instead of ERR_DNS_FAIL
</A></li>
	<LI>Next message (by thread): <A HREF="026033.html">[squid-users] Sockets not closed after ICAP receivedWholeAdaptedReply
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26032">[ date ]</a>
              <a href="thread.html#26032">[ thread ]</a>
              <a href="subject.html#26032">[ subject ]</a>
              <a href="author.html#26032">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
