<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Sockets not closed after ICAP receivedWholeAdaptedReply
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Sockets%20not%20closed%20after%20ICAP%0A%20receivedWholeAdaptedReply&In-Reply-To=%3Cd6acd6cf-eb38-e78d-3f98-c5e97481a913%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="026032.html">
   <LINK REL="Next"  HREF="026034.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Sockets not closed after ICAP receivedWholeAdaptedReply</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Sockets%20not%20closed%20after%20ICAP%0A%20receivedWholeAdaptedReply&In-Reply-To=%3Cd6acd6cf-eb38-e78d-3f98-c5e97481a913%40measurement-factory.com%3E"
       TITLE="[squid-users] Sockets not closed after ICAP receivedWholeAdaptedReply">rousskov at measurement-factory.com
       </A><BR>
    <I>Wed Aug  9 20:08:03 UTC 2023</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="026032.html">[squid-users] Sockets not closed after ICAP receivedWholeAdaptedReply
</A></li>
        <LI>Next message (by thread): <A HREF="026034.html">[squid-users] Some requests not being passed/processed by squid
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26033">[ date ]</a>
              <a href="thread.html#26033">[ thread ]</a>
              <a href="subject.html#26033">[ subject ]</a>
              <a href="author.html#26033">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 8/9/23 14:33, <A HREF="https://lists.squid-cache.org/listinfo/squid-users">mailing at fuchus.de</A> wrote:

&gt;<i> Do you have any remarks on the change? Maybe you have some more 
</I>&gt;<i> insight on the interplay of the code or what seems to be causing the
</I>&gt;<i> issue in detail.
</I>

Hi Leonardo,

     I do, but this mailing list is not the best place to discuss Squid 
code. If you want these or similar changes merged into Squid, then I 
suggest posting a draft Pull Request on GitHub, where it is easier to 
collaborate and provide code-specific feedback. Ideally, use a dedicated 
git branch that Squid core developers can modify and experiment with 
(e.g., do _not_ use a cloned official branch like &quot;master&quot; or a custom 
branch that you automatically deploy!).
<A HREF="https://wiki.squid-cache.org/MergeProcedure#pull-request">https://wiki.squid-cache.org/MergeProcedure#pull-request</A>


For now, I will leave you with a few questions and brief comments:

* Does the problem go away if you remove the patch in PR #1400? Or are 
you unable to test this use case without that patch?

* Please clarify whether the HTP response encapsulated in the ICAP 
response should set ENTRY_BAD_LENGTH in a bug-free Squid code. It was 
not clear (to me) whether there is something wrong with that HTTP response.

* ICAP Connection and HTTP Connection headers in ICAP responses should 
not affect encapsulated HTTP response length. If they do, there is a bug 
somewhere.

* If your patch is the right thing to do, then, most likely, more 
changes are required. For example, a similar condition may happen on the 
ConnStateData::afterClientRead() code path AFAICT.

* PR 1443 has overlapping changes. They will not fix your specific use 
case, but, ideally, I would prefer to land that (IMO, ready) PR before 
attacking this problem because that PR has relevant code changes that we 
should not revisit in a parallel PR.


HTH,

Alex.


On 8/9/23 14:33, <A HREF="https://lists.squid-cache.org/listinfo/squid-users">mailing at fuchus.de</A> wrote:
&gt;<i> we have been having some issues lately with our Squid proxies on version 
</I>&gt;<i> 6.1.
</I>&gt;<i> 
</I>&gt;<i> We also have the patch for the REQMOD satisfaction regression installed: 
</I>&gt;<i> <A HREF="https://github.com/squid-cache/squid/pull/1400">https://github.com/squid-cache/squid/pull/1400</A> 
</I>&gt;<i> 
</I>&gt;<i> The issue:
</I>&gt;<i> 
</I>&gt;<i> When there is a request sent to the ICAP server and the ICAP server is 
</I>&gt;<i> replying with a modified response, this modified response, after 
</I>&gt;<i> checking through receivedWholeAdeptedReply, doesn't set a BAD_LENGTH, 
</I>&gt;<i> which usually turns into a STREAM_UNPLANNED_COMPLETE, but rather a 
</I>&gt;<i> STREAM_COMPLETE (in Http::Stream::writeComplete). This in turn calls 
</I>&gt;<i> ConnStateData::kick on the current context, which has an empty pipeline 
</I>&gt;<i> at some point. Because this case is not specifically checked and the 
</I>&gt;<i> connection is just abandoned, the socket is never removed. This causes a 
</I>&gt;<i> lot of open connections and a high amount of file descriptors for the 
</I>&gt;<i> corresponding squid processes that we frequently run into limits.
</I>&gt;<i> 
</I>&gt;<i> As a hot fix I made the following changes in order to accommodate for 
</I>&gt;<i> this specific case:
</I>&gt;<i> 
</I>&gt;<i> --- a/src/client_side.cc
</I>&gt;<i> +++ a/src/client_side.cc
</I>&gt;<i> @@ -989,6 +989,9 @@ ConnStateData::kick()
</I>&gt;<i>  &#160;&#160;&#160;&#160; } else if (flags.readMore) {
</I>&gt;<i>  &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; debugs(33, 3, clientConnection &lt;&lt; &quot;: calling readNextRequest()&quot;);
</I>&gt;<i>  &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; readNextRequest();
</I>&gt;<i> +&#160;&#160;&#160; } else if (pipeline.empty()) {
</I>&gt;<i> +&#160;&#160;&#160;&#160;&#160;&#160;&#160; debugs(33, 3, &quot;pipeline is empty - closing connection&quot;);
</I>&gt;<i> +&#160;&#160;&#160;&#160;&#160;&#160;&#160; clientConnection-&gt;close();
</I>&gt;<i>  &#160;&#160;&#160;&#160; } else {
</I>&gt;<i>  &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; // XXX: Can this happen? CONNECT tunnels have deferredRequest set.
</I>&gt;<i>  &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; debugs(33, DBG_IMPORTANT, MYNAME &lt;&lt; &quot;abandoning &quot; &lt;&lt; 
</I>&gt;<i> clientConnection);
</I>&gt;<i> 
</I>&gt;<i> This issue also seems to happen if the ICAP server has specific 
</I>&gt;<i> responses - it seems as if the STREAM_COMPLETE case happens (implying 
</I>&gt;<i> receivedWholeAdaptedReply) if there is a Connection: closed response 
</I>&gt;<i> from ICAP, rather than Connection: keep-alive. In the latter case, the 
</I>&gt;<i> connection is torn down with a STREAM_UNPLANNED_COMPLETE. The patch, 
</I>&gt;<i> setting receivedWholeAdaptedReply always to true in those cases also 
</I>&gt;<i> means that the connection is never closed and abandoned all the time if 
</I>&gt;<i> it includes REQMOD it seems, rather than just doing that if the response 
</I>&gt;<i> from ICAP implies a closed connection.
</I>&gt;<i> 
</I>&gt;<i> I was not able to reproduce the issue with version 5.8 as of now, so 
</I>&gt;<i> this seems to be something specific to 6.1.
</I>&gt;<i> 
</I>&gt;<i> Do you have any remarks on the change? Maybe you have some more insight 
</I>&gt;<i> on the interplay of the code or what seems to be causing the issue in 
</I>&gt;<i> detail.
</I>&gt;<i> 
</I>&gt;<i> Sincerely,
</I>&gt;<i> 
</I>&gt;<i> Leonardo Martinho
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="026032.html">[squid-users] Sockets not closed after ICAP receivedWholeAdaptedReply
</A></li>
	<LI>Next message (by thread): <A HREF="026034.html">[squid-users] Some requests not being passed/processed by squid
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26033">[ date ]</a>
              <a href="thread.html#26033">[ thread ]</a>
              <a href="subject.html#26033">[ subject ]</a>
              <a href="author.html#26033">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
