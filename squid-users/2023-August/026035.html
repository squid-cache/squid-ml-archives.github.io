<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Some requests not being passed/processed by squid
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Some%20requests%20not%20being%20passed/processed%20by%20squid&In-Reply-To=%3Ccf647d07-1680-0ca1-e136-769838d9a607%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="026034.html">
   <LINK REL="Next"  HREF="026036.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Some requests not being passed/processed by squid</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Some%20requests%20not%20being%20passed/processed%20by%20squid&In-Reply-To=%3Ccf647d07-1680-0ca1-e136-769838d9a607%40measurement-factory.com%3E"
       TITLE="[squid-users] Some requests not being passed/processed by squid">rousskov at measurement-factory.com
       </A><BR>
    <I>Thu Aug 10 16:59:02 UTC 2023</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="026034.html">[squid-users] Some requests not being passed/processed by squid
</A></li>
        <LI>Next message (by thread): <A HREF="026036.html">[squid-users] Outgoing traffic through certain device instead of IP?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26035">[ date ]</a>
              <a href="thread.html#26035">[ thread ]</a>
              <a href="subject.html#26035">[ subject ]</a>
              <a href="author.html#26035">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 8/10/23 05:20, Ralf Hildebrandt wrote:
&gt;<i> We're running a cluster of 4 identical Squid proxies.
</I>&gt;<i> 
</I>&gt;<i> In order to check the functionality of each cluster node, were using
</I>&gt;<i> ldirectord which is querying each realserver like this:
</I>&gt;<i> 
</I>&gt;<i> GET <A HREF="http://127.0.0.1/proxytest.cgi">http://127.0.0.1/proxytest.cgi</A>
</I>
I assume there is HTTP/1.x at the end and some request headers after the 
request line.


&gt;<i> Now we were seen some odd warning in our graphs, clusternodes being
</I>&gt;<i> removed and added back to the cluster only a few seconds later.
</I>&gt;<i> 
</I>&gt;<i> I found that these requests for <A HREF="http://127.0.0.1/proxytest.cgi">http://127.0.0.1/proxytest.cgi</A> were
</I>&gt;<i> sometimes (seldom -- maybe once/twice per day) failing.
</I>&gt;<i> 
</I>&gt;<i> In the squid access.log I'm seeing this as:
</I>&gt;<i> ===========================================
</I>&gt;<i> 
</I>&gt;<i> Thu Aug 10 10:32:54 2023    115 141.42.5.218 TCP_REFRESH_ABORTED/200 0 141 GET <A HREF="http://127.0.0.1/proxytest.cgi">http://127.0.0.1/proxytest.cgi</A> - HIER_DIRECT/127.0.0.1 text/plain accessRule=- 56680
</I>&gt;<i> Thu Aug 10 10:33:02 2023      0 141.42.5.218 NONE_NONE_ABORTED/000 0 141 GET <A HREF="http://127.0.0.1/proxytest.cgi">http://127.0.0.1/proxytest.cgi</A> - HIER_NONE/- - accessRule=- -
</I>&gt;<i> Thu Aug 10 10:33:07 2023      0 141.42.5.218 NONE_NONE_ABORTED/000 0 141 GET <A HREF="http://127.0.0.1/proxytest.cgi">http://127.0.0.1/proxytest.cgi</A> - HIER_NONE/- - accessRule=- -
</I>&gt;<i> 
</I>&gt;<i> as opposed to the normal:
</I>&gt;<i> =========================
</I>&gt;<i> 
</I>&gt;<i> Thu Aug 10 11:02:45 2023      5 141.42.5.218 TCP_REFRESH_MODIFIED/200 314 141 GET <A HREF="http://127.0.0.1/proxytest.cgi">http://127.0.0.1/proxytest.cgi</A> - HIER_DIRECT/127.0.0.1 text/plain accessRule=- 51940
</I>&gt;<i> 
</I>&gt;<i> My Logformat:
</I>&gt;<i> =============
</I>&gt;<i> 
</I>&gt;<i> logformat squid-sourceport  %ts.%03tu %6tr %&gt;a %Ss/%03&gt;Hs %&lt;st %&gt;st %rm %ru %[un %Sh/%&lt;a %mt accessRule=%{accessRule}note %&lt;lp
</I>&gt;<i> 
</I>&gt;<i> * I replaced the the secondssince1970 timestamp with a human readable timeformat
</I>&gt;<i> * Last colument in the log is the sourceport used by squid
</I>&gt;<i> 
</I>&gt;<i> I checked nginx logs on that machine and found that the requests for
</I>&gt;<i> <A HREF="http://127.0.0.1/proxytest.cgi">http://127.0.0.1/proxytest.cgi</A> never reached nginx (for the three
</I>&gt;<i> incidents marked above)
</I>&gt;<i> 
</I>&gt;<i> So my questions:
</I>&gt;<i> ================
</I>&gt;<i> 
</I>&gt;<i> What are TCP_REFRESH_ABORTED/200 and (which looks more dire) NONE_NONE_ABORTED/000?
</I>

I can only describe a few _possible_ outcomes. They may not match what 
is actually happening in your specific use cases because I have not 
checked all the necessary details, because of Squid bugs, and because 
several different outcomes may map to the same access.log line, 
especially in older Squids, especially in Squids that do not access-log 
%err_code/%err_detail.

* TCP_REFRESH_ABORTED/200: Squid found a matching stale cached response 
and decided to revalidate it with the origin server. After (or while or 
just before) talking to the origin server and/or while (or just before) 
sending a 200 OK response to the client, the client (or something else) 
closed the client-Squid connection.

* NONE_NONE_ABORTED/000: The client (or something else) closed 
client-Squid connection much earlier than what is described in the 
TCP_REFRESH_ABORTED/200 case above, even before Squid found a matching 
stale response in its cache, if any, or even before Squid checked that 
cache. Technically, logging NONE_NONE is a Squid bug. Squid should log 
something like TCP_ABORTED instead.

I recommend logging %err_code/%err_detail. Logging Cache-Status response 
header may also be useful.


HTH,

Alex.


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="026034.html">[squid-users] Some requests not being passed/processed by squid
</A></li>
	<LI>Next message (by thread): <A HREF="026036.html">[squid-users] Outgoing traffic through certain device instead of IP?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26035">[ date ]</a>
              <a href="thread.html#26035">[ thread ]</a>
              <a href="subject.html#26035">[ subject ]</a>
              <a href="author.html#26035">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
