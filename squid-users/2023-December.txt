From squid3 at treenet.co.nz  Fri Dec  1 20:34:30 2023
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Sat, 2 Dec 2023 09:34:30 +1300
Subject: [squid-users] SSL Virtual Hosting Problem
In-Reply-To: <ba4870c8-6ba0-12aa-52ef-d43e2c5b1172@regify.com>
References: <03a7ad35-a700-c02d-cba3-0f163c1014f5@regify.com>
 <f68d6369-1886-448d-a808-4fffe0e75cbd@treenet.co.nz>
 <31de1e7d-7f9e-5ce5-3af4-df3aeb56b05f@regify.com>
 <ba4870c8-6ba0-12aa-52ef-d43e2c5b1172@regify.com>
Message-ID: <14a1cfc7-394c-459a-a92c-59bafaa74aac@treenet.co.nz>

On 1/12/23 04:55, Mario Theodoridis wrote:
> I do have one more problem at this point.
> 
> Using openssl i can work with what i have below, but i cannot add a 2nd 
> certificate
> 
> https_port 0.0.0.0:443 accel defaultsite=regify.com \
>  ??? tls-cert=/etc/ssl/certs/regify.com.pem \
>  ??? tls-cert=/etc/ssl/certs/foo.com.pem
> 
> gives me
> 
> ERROR: OpenSSL does not support multiple server certificates. Ignoring 
> addional cert= parameters.
> 
> 
> If i instead use gnutls, i get dinged for using ssl::server
> 
> FATAL: Bungled /etc/squid/squid.conf line 29: acl stest1 
> ssl::server_name test1.regify.com
> 
> is there a way to get the SNI host with gnutls?

There is , but we have not yet implemented it.

If the HTTPS URL domain is acceptable you can use the dstdomain ACL type 
instead as a workaround.


> 
> http://www.squid-cache.org/Doc/config/acl/ did not answer that for me.
> 
> Alternatively, can i get openssl to cope with multiple certs somehow?

AFAIK, no.


HTH
Amos


From squid3 at treenet.co.nz  Sat Dec  2 06:51:38 2023
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Sat, 02 Dec 2023 06:51:38 -0000
Subject: [squid-users] [squid-announce] [ADVISORY] SQUID-2023:4 Denial of
 Service in SSL Certificate validation
Message-ID: <7a2600c3-3c96-441e-bb2e-2158732b08b1@treenet.co.nz>

__________________________________________________________________

Squid Proxy Cache Security Update Advisory SQUID-2023:4
__________________________________________________________________

Advisory ID:       | SQUID-2023:4
Date:              | November 2, 2023
Summary:           | Denial of Service in SSL Certificate validation
Affected versions: | Squid 3.3 -> 3.5.28
                    | Squid 4.x -> 4.16
                    | Squid 5.x -> 5.9
                    | Squid 6.x -> 6.3
Fixed in version:  | Squid 6.4
__________________________________________________________________

Problem Description:

  Due to an Improper Validation of Specified Index
  bug Squid is vulnerable to a Denial of Service
  attack against SSL Certificate validation.

__________________________________________________________________

Severity:

  This problem allows a remote server to perform Denial of
  Service against Squid Proxy by initiating a TLS Handshake with
  a specially crafted SSL Certificate in a server certificate
  chain.

  This attack is limited to HTTPS and SSL-Bump.

CVSS Score of 8.6
<https://nvd.nist.gov/vuln-metrics/cvss/v3-calculator?vector=AV:N/AC:L/PR:N/UI:N/S:C/C:N/I:N/A:H&version=3.1>

__________________________________________________________________

Updated Packages:

This bug is fixed by Squid version 6.4.

  In addition, patches addressing this problem for the stable
  releases can be found in our patch archives:

Squid 5:
  <http://www.squid-cache.org/Versions/v5/SQUID-2023_4.patch>

Squid 6:
  <http://www.squid-cache.org/Versions/v6/SQUID-2023_4.patch>

  If you are using a prepackaged version of Squid then please refer
  to the package vendor for availability information on updated
  packages.

__________________________________________________________________

Determining if your version is vulnerable:

  All Squid older than 3.3.0.1 are not vulnerable.

  All Squid-3.3 up to and including 3.4.14 compiled without
    --enable-ssl are not vulnerable.

  All Squid-3.3 up to and including 3.4.14 compiled using
    --enable-ssl are vulnerable.

  All Squid-3.5 up to and including 3.5.28 compiled without
    --with-openssl are not vulnerable.

  All Squid-3.5 up to and including 3.5.28 compiled using
    --with-openssl  are vulnerable.

  All Squid-4.x up to and including 4.16 compiled without
    --with-openssl are not vulnerable.

  All Squid-4.x up to and including 4.16 compiled using
    --with-openssl  are vulnerable.

  Squid-5.x up to and including 5.9 compiled without
    --with-openssl are not vulnerable.

  All Squid-5.x up to and including 5.9 compiled using
    --with-openssl  are vulnerable.

  All Squid-6.x up to and including 6.3 compiled without
    --with-openssl are not vulnerable.

  All Squid-6.x up to and including 6.3 compiled using
    --with-openssl  are vulnerable.

__________________________________________________________________

Workaround:

Either,

  Disable use of SSL-Bump features:
   * Remove all ssl-bump options from http_port and https_port
   * Remove all ssl_bump directives from squid.conf

Or,

   Rebuild Squid using --without-openssl.

__________________________________________________________________

Contact details for the Squid project:

  For installation / upgrade support on binary packaged versions
  of Squid: Your first point of contact should be your binary
  package vendor.

  If you install and build Squid from the original Squid sources
  then the <squid-users at lists.squid-cache.org> mailing list is your
  primary support point. For subscription details see
  <http://www.squid-cache.org/Support/mailing-lists.html>.

  For reporting of non-security bugs in the latest STABLE release
  the squid bugzilla database should be used
  <https://bugs.squid-cache.org/>.

  For reporting of security sensitive bugs send an email to the
  <squid-bugs at lists.squid-cache.org> mailing list. It's a closed
  list (though anyone can post) and security related bug reports
  are treated in confidence until the impact has been established.

__________________________________________________________________

Credits:

  This vulnerability was discovered by Joshua Rogers of Opera
  Software.

  Fixed by Andreas Weigel

__________________________________________________________________

Revision history:

  2023-10-12 11:53:02 UTC Initial Report
__________________________________________________________________
END
_______________________________________________
squid-announce mailing list
squid-announce at lists.squid-cache.org
https://lists.squid-cache.org/listinfo/squid-announce


From squid3 at treenet.co.nz  Sat Dec  2 05:29:40 2023
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Sat, 2 Dec 2023 18:29:40 +1300
Subject: [squid-users] [squid-announce] [ADVISORY] SQUID-2023:7 Denial of
 Service in HTTP Message Processing
Message-ID: <2a765884-c5a5-4e28-9533-c5fd85e646ca@treenet.co.nz>

__________________________________________________________________

    Squid Proxy Cache Security Update Advisory SQUID-2023:7
__________________________________________________________________

Advisory ID:       | SQUID-2023:7
Date:              | December 1, 2023
Summary:           | Denial of Service in HTTP Message Processing
Affected versions: | Squid 2.2 -> 2.7.STABLE9
                    | Squid 3.x -> 3.5.28
                    | Squid 4.x -> 4.17
                    | Squid 5.x -> 5.9
                    | Squid 6.x -> 6.4
Fixed in version:  | Squid 6.5
__________________________________________________________________

Problem Description:

  Due to a Buffer Overread bug Squid is vulnerable to a Denial of
  Service attack against Squid HTTP Message processing.

__________________________________________________________________

Severity:

  This problem allows a remote attacker to perform Denial of
  Service when sending easily crafted HTTP Messages.


CVSS Score of 8.6
<https://nvd.nist.gov/vuln-metrics/cvss/v3-calculator?vector=AV:N/AC:L/PR:N/UI:N/S:C/C:N/I:N/A:H&version=3.1>

__________________________________________________________________

Updated Packages:

  This bug is fixed by Squid version 6.5.

  In addition, patches addressing this problem for the stable
  releases can be found in our patch archives:

Squid 5 and older:
  <http://www.squid-cache.org/Versions/v5/SQUID-2023_7.patch>

Squid 6:
  <http://www.squid-cache.org/Versions/v6/SQUID-2023_7.patch>

  If you are using a prepackaged version of Squid then please refer
  to the package vendor for availability information on updated
  packages.

__________________________________________________________________

Determining if your version is vulnerable:

  All Squid-2.2 up to and including 4.17 have not been tested
  and should be assumed to be vulnerable.

  All Squid-5.x up to and including 5.9 are vulnerable.

  All Squid-6.x up to and including 6.4 are vulnerable.

__________________________________________________________________

Workaround:

  There is no workaround for this issue.

__________________________________________________________________

Contact details for the Squid project:

  For installation / upgrade support on binary packaged versions
  of Squid: Your first point of contact should be your binary
  package vendor.

  If you install and build Squid from the original Squid sources
  then the <squid-users at lists.squid-cache.org> mailing list is your
  primary support point. For subscription details see
  <http://www.squid-cache.org/Support/mailing-lists.html>.

  For reporting of non-security bugs in the latest STABLE release
  the squid bugzilla database should be used
  <https://bugs.squid-cache.org/>.

  For reporting of security sensitive bugs send an email to the
  <squid-bugs at lists.squid-cache.org> mailing list. It's a closed
  list (though anyone can post) and security related bug reports
  are treated in confidence until the impact has been established.

__________________________________________________________________

Credits:

  This vulnerability was discovered by Joshua Rogers of Opera
  Software.

  Fixed by The Measurement Factory.

__________________________________________________________________

Revision history:

  2023-10-12 11:53:02 UTC Initial Report
  2023-10-25 19:41:45 UTC Patches Released
__________________________________________________________________
END
_______________________________________________
squid-announce mailing list
squid-announce at lists.squid-cache.org
https://lists.squid-cache.org/listinfo/squid-announce


From squid3 at treenet.co.nz  Sat Dec  2 06:01:45 2023
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Sat, 2 Dec 2023 19:01:45 +1300
Subject: [squid-users] [squid-announce] [ADVISORY] SQUID-2023:8 Denial of
 Service in Helper Process management
Message-ID: <1e76915e-31e5-4327-b13b-b8d8690af21c@treenet.co.nz>

__________________________________________________________________

    Squid Proxy Cache Security Update Advisory SQUID-2023:8
__________________________________________________________________

Advisory ID:       | SQUID-2023:8
Date:              | December 1, 2023
Summary:           | Denial of Service
                    | in Helper Process management
Affected versions: | Squid 2.x -> 2.7.STABLE9
                    | Squid 3.x -> 3.5.28
                    | Squid 4.x -> 4.17
                    | Squid 5.x -> 5.9
                    | Squid 6.x -> 6.4
Fixed in version:  | Squid 6.5
__________________________________________________________________

Problem Description:

  Due to an Incorrect Check of Function Return Value
  bug Squid is vulnerable to a Denial of Service
  attack against its Helper process management.

__________________________________________________________________

Severity:

  This problem allows a trusted client or remote server to perform
  a Denial of Service attack when the Squid proxy is under load.


CVSS Score of 8.6
<https://nvd.nist.gov/vuln-metrics/cvss/v3-calculator?vector=AV:N/AC:L/PR:N/UI:N/S:C/C:N/I:N/A:H&version=3.1>

__________________________________________________________________

Updated Packages:

This bug is fixed by Squid version 6.5.

  In addition, patches addressing this problem for the stable
  releases can be found in our patch archives:

Squid 6:
  <http://www.squid-cache.org/Versions/v6/SQUID-2023_8.patch>

  If you are using a prepackaged version of Squid then please refer
  to the package vendor for availability information on updated
  packages.

__________________________________________________________________

Determining if your version is vulnerable:

  Squid older than 5.0 have not been tested and should be
  assumed to be vulnerable.

  All Squid-5.x up to and including 5.9 are vulnerable.

  All Squid-6.x up to and including 6.4 are vulnerable.

__________________________________________________________________

Workaround:

  There is no known workaround for this issue.

__________________________________________________________________

Contact details for the Squid project:

  For installation / upgrade support on binary packaged versions
  of Squid: Your first point of contact should be your binary
  package vendor.

  If you install and build Squid from the original Squid sources
  then the <squid-users at lists.squid-cache.org> mailing list is your
  primary support point. For subscription details see
  <http://www.squid-cache.org/Support/mailing-lists.html>.

  For reporting of non-security bugs in the latest STABLE release
  the squid bugzilla database should be used
  <https://bugs.squid-cache.org/>.

  For reporting of security sensitive bugs send an email to the
  <squid-bugs at lists.squid-cache.org> mailing list. It's a closed
  list (though anyone can post) and security related bug reports
  are treated in confidence until the impact has been established.

__________________________________________________________________

Credits:

This vulnerability was discovered by Joshua Rogers of Opera
Software.

Fixed by The Measurement Factory.

__________________________________________________________________

Revision history:

  2023-10-12 11:53:02 UTC Initial Report
  2023-10-27 21:27:20 UTC Patch Released
__________________________________________________________________
END
_______________________________________________
squid-announce mailing list
squid-announce at lists.squid-cache.org
https://lists.squid-cache.org/listinfo/squid-announce


From squid3 at treenet.co.nz  Sat Dec  2 06:44:03 2023
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Sat, 2 Dec 2023 19:44:03 +1300
Subject: [squid-users] [squid-announce] [ADVISORY] SQUID-2023:9 Denial of
 Service in HTTP Collapsed Forwarding
Message-ID: <62a31833-e78e-4493-9770-8582237a1e50@treenet.co.nz>

__________________________________________________________________

    Squid Proxy Cache Security Update Advisory SQUID-2023:9
__________________________________________________________________

Advisory ID:       | SQUID-2023:9
Date:              | December 1, 2023
Summary:           | Denial of Service
                    | in HTTP Collapsed Forwarding
Affected versions: | Squid 3.5 -> 3.5.28
                    | Squid 4.x -> 4.17
                    | Squid 5.x -> 5.9
Fixed in version:  | Squid 6.0.1
__________________________________________________________________

Problem Description:

  Due to a Use-After-Free bug Squid is vulnerable to a Denial of
  Service attack against collapsed forwarding

__________________________________________________________________

Severity:

  This problem allows a remote client to perform Denial of
  Service attack on demand when Squid is configured with collapsed
  forwarding.

CVSS Score of 8.6
<https://nvd.nist.gov/vuln-metrics/cvss/v3-calculator?vector=AV:N/AC:L/PR:N/UI:N/S:C/C:N/I:N/A:H&version=3.1>

__________________________________________________________________

Updated Packages:

This bug is fixed by Squid version 6.0.1.

  If you are using a prepackaged version of Squid then please refer
  to the package vendor for availability information on updated
  packages.

__________________________________________________________________

Determining if your version is vulnerable:

  Run the following command to identify how (and whether)
  your Squid has been configured with collapsed forwarding:

     squid -k parse 2>&1 | grep collapsed_forwarding


  All Squid-3.5 up to and including 5.9 configured with
  "collapsed_forwarding on" are vulnerable.

  All Squid-3.5 up to and including 5.9 configured with
  "collapsed_forwarding off" are not vulnerable.

  All Squid-3.5 up to and including 5.9 configured without any
  "collapsed_forwarding" directive are not vulnerable.

__________________________________________________________________

Workaround:

  Remove all collapsed_forwarding lines from your squid.conf.

__________________________________________________________________

Contact details for the Squid project:

  For installation / upgrade support on binary packaged versions
  of Squid: Your first point of contact should be your binary
  package vendor.

  If you install and build Squid from the original Squid sources
  then the <squid-users at lists.squid-cache.org> mailing list is your
  primary support point. For subscription details see
  <http://www.squid-cache.org/Support/mailing-lists.html>.

  For reporting of non-security bugs in the latest STABLE release
  the squid bugzilla database should be used
  <https://bugs.squid-cache.org/>.

  For reporting of security sensitive bugs send an email to the
  <squid-bugs at lists.squid-cache.org> mailing list. It's a closed
  list (though anyone can post) and security related bug reports
  are treated in confidence until the impact has been established.

__________________________________________________________________

Credits:

This vulnerability was discovered by Joshua Rogers of Opera
Software.

Fixed by The Measurement Factory.

__________________________________________________________________

Revision history:

  2022-09-03 18:41:32 UTC Patches Released
  2023-10-12 11:53:02 UTC Initial Report
__________________________________________________________________
END
_______________________________________________
squid-announce mailing list
squid-announce at lists.squid-cache.org
https://lists.squid-cache.org/listinfo/squid-announce


From tibor.matyas at dsi-as.de  Sat Dec  2 13:20:51 2023
From: tibor.matyas at dsi-as.de (MATYAS, Tibor)
Date: Sat, 2 Dec 2023 14:20:51 +0100
Subject: [squid-users] Module c-icap help
In-Reply-To: <758af944-6ad6-4a50-81b0-646c5467c67f@treenet.co.nz>
References: <D2C457D1-8638-4659-B953-E86B233559CF@rii.fr>
 <758af944-6ad6-4a50-81b0-646c5467c67f@treenet.co.nz>
Message-ID: <31e81732-ede2-4742-9612-82c225771552@dsi-as.de>

Dear all,

our experiences are as follows:
- c-icap server 0.5.10 is working fine 
(https://wiki.squid-cache.org/ConfigExamples/ContentAdaptation/C-ICAP)
- c-icap server 0.5.11 - the configuration of c-icap.conf is no longer 
compatible. We couldn't manage it work stable with squid! (-"-)
- c-icap server 0.6.0 - there are some compilation troubles on our 
gentoo systems... (we need more time to fix this...)
- c-icap server master - didn't tried
-> running on 0.5.10

BR, Tibor

Am 30.11.2023 um 11:03 schrieb Amos Jeffries:

> On 30/11/23 22:22, MIKA wrote:
>>
>> Hello everyone,
>> Thank you again for all the work you were able to do on this project.
>> I try to control the cookies with squid but it's impossible. the 
>> c-icap module in the squid.conf file does not seem to work because 
>> the c-icap server does not seem to work.
>> Can you help me please ?
>
>
> Please describe with a bit more details what setup you have, what you 
> expect it to be doing, and what you see it actually doing.
>
>
> Cheers
> Amos
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> https://lists.squid-cache.org/listinfo/squid-users



--------------------------------------------------
DSI Aerospace GmbH

Sitz der Gesellschaft: Otto-Lilienthal-Str. 1, D-28199 Bremen, Germany
Web: http://dsi.space

Geschaeftsfuehrer: Dr.-Ing. Christian Dierker
                   M. Sc. Elias Hashem

Handelsregister: HRB 17726, Amtsgericht Bremen
Umsatzsteuer-Identifikationsnummer: DE 192 681 774
--------------------------------------------------





From mario.theodoridis at regify.com  Mon Dec  4 10:17:16 2023
From: mario.theodoridis at regify.com (Mario Theodoridis)
Date: Mon, 4 Dec 2023 11:17:16 +0100
Subject: [squid-users] SSL Virtual Hosting Problem
In-Reply-To: <14a1cfc7-394c-459a-a92c-59bafaa74aac@treenet.co.nz>
References: <03a7ad35-a700-c02d-cba3-0f163c1014f5@regify.com>
 <f68d6369-1886-448d-a808-4fffe0e75cbd@treenet.co.nz>
 <31de1e7d-7f9e-5ce5-3af4-df3aeb56b05f@regify.com>
 <ba4870c8-6ba0-12aa-52ef-d43e2c5b1172@regify.com>
 <14a1cfc7-394c-459a-a92c-59bafaa74aac@treenet.co.nz>
Message-ID: <b5bcccef-c5f2-d080-c4ad-19b85ba4a3a4@regify.com>

On 01/12/23 21:34, Amos Jeffries wrote:
> On 1/12/23 04:55, Mario Theodoridis wrote:
>> I do have one more problem at this point.
>>
>> Using openssl i can work with what i have below, but i cannot add a 
>> 2nd certificate
>>
>> https_port 0.0.0.0:443 accel defaultsite=regify.com \
>> ???? tls-cert=/etc/ssl/certs/regify.com.pem \
>> ???? tls-cert=/etc/ssl/certs/foo.com.pem
>>
>> gives me
>>
>> ERROR: OpenSSL does not support multiple server certificates. 
>> Ignoring addional cert= parameters.
>>
>>
>> If i instead use gnutls, i get dinged for using ssl::server
>>
>> FATAL: Bungled /etc/squid/squid.conf line 29: acl stest1 
>> ssl::server_name test1.regify.com
>>
>> is there a way to get the SNI host with gnutls?
>
> There is , but we have not yet implemented it.
>
> If the HTTPS URL domain is acceptable you can use the dstdomain ACL 
> type instead as a workaround.

It would be acceptable to me, but i was under the impression, that this 
did not work with TLS.
So with the gnutls variant and the following config

debug_options ALL,2
pinger_enable off
shutdown_lifetime 1 second

acl TLS_ports port 443
acl Safe_ports port 443

https_port 0.0.0.0:443 accel defaultsite=regify.com \
 ??? tls-cert=/etc/ssl/certs/regify.com.pem \
 ??? tls-cert=/etc/ssl/certs/foo.com.pem

http_access deny !Safe_ports
http_access deny manager

acl stest dstdomain -n test.regify.com
http_access allow stest
cache_peer test.regify.com parent 443 0 tls \
 ??? proxy-only originserver no-digest no-netdb-exchange name=ttest
cache_peer_access ttest allow TLS_ports stest
cache_peer_access ttest deny all

acl sfoo dstdomain -n www.foo.com
http_access allow sfoo
cache_peer www.foo.com parent 443 0 tls \
 ??? proxy-only originserver no-digest no-netdb-exchange name=tfoo
cache_peer_access tfoo allow TLS_ports sfoo
cache_peer_access tfoo deny all

http_access deny all

curl https://test.regify.com/ gives me certificate errors and

2023/12/04 10:58:22.053 kid1| 5,2| TcpAcceptor.cc(224) doAccept: New 
connection on FD 12
2023/12/04 10:58:22.053 kid1| 5,2| TcpAcceptor.cc(312) acceptNext: 
connection on local=0.0.0.0:443 remote=[::] FD 12 flags=9
2023/12/04 10:58:22.054 kid1| 17,2| QosConfig.cc(125) 
getNfmarkFromConnection: QOS: Failed to retrieve connection mark: (-1) 
(1) Operation not permitted (Destination 192.168.1.123:443, source 
192.168.1.124:41380)
2023/12/04 10:58:22.075 kid1| 83,2| client_side.cc(2680) 
clientNegotiateSSL: TLS session reuse not yet implemented.
2023/12/04 10:58:22.075 kid1| 83,2| client_side.cc(2701) 
clientNegotiateSSL: Client certificate requesting not yet implemented.
2023/12/04 10:58:22.075 kid1| 11,2| client_side.cc(1306) 
parseHttpRequest: HTTP Client local=192.168.1.123:443 
remote=192.168.1.124:41380 FD 11 flags=1
2023/12/04 10:58:22.075 kid1| 11,2| client_side.cc(1307) 
parseHttpRequest: HTTP Client REQUEST:
---------
GET / HTTP/1.1
Host: test.regify.com
User-Agent: curl/7.74.0
Accept: */*


----------
2023/12/04 10:58:22.076 kid1| 85,2| client_side_request.cc(751) 
clientAccessCheckDone: The request GET https://test.regify.com/ is 
ALLOWED; last ACL checked: stest
2023/12/04 10:58:22.076 kid1| 85,2| client_side_request.cc(729) 
clientAccessCheck2: No adapted_http_access configuration. default: ALLOW
2023/12/04 10:58:22.076 kid1| 85,2| client_side_request.cc(751) 
clientAccessCheckDone: The request GET https://test.regify.com/ is 
ALLOWED; last ACL checked: stest
2023/12/04 10:58:22.076 kid1| 17,2| FwdState.cc(142) FwdState: 
Forwarding client request local=192.168.1.123:443 
remote=192.168.1.124:41380 FD 11 flags=1, url=https://test.regify.com/
2023/12/04 10:58:22.076 kid1| 44,2| peer_select.cc(295) 
peerSelectDnsPaths: Find IP destination for: https://test.regify.com/' 
via test.regify.com
2023/12/04 10:58:22.076 kid1| 44,2| peer_select.cc(316) 
peerSelectDnsPaths: Found sources for 'https://test.regify.com/'
2023/12/04 10:58:22.076 kid1| 44,2| peer_select.cc(317) 
peerSelectDnsPaths:?? always_direct = DENIED
2023/12/04 10:58:22.076 kid1| 44,2| peer_select.cc(318) 
peerSelectDnsPaths:??? never_direct = DENIED
2023/12/04 10:58:22.076 kid1| 44,2| peer_select.cc(328) 
peerSelectDnsPaths:????? cache_peer = local=0.0.0.0 remote=2.4.6.8:443 
flags=1
2023/12/04 10:58:22.076 kid1| 44,2| peer_select.cc(331) 
peerSelectDnsPaths:??????? timedout = 0
2023/12/04 10:58:22.088 kid1| 83,2| PeerConnector.cc(205) negotiate: 
handshake IN: Unknown Handshake packet
2023/12/04 10:58:22.088 kid1| 83,2| PeerConnector.cc(207) negotiate: 
handshake OUT: CLIENT HELLO
2023/12/04 10:58:22.102 kid1| 83,2| PeerConnector.cc(198) negotiate: 
local=192.168.1.123:42772 remote=2.4.6.8:443 FD 13 flags=1 TLS Session 
info: (TLS1.3)-(ECDHE-SECP256R1)-(RSA-PSS-RSAE-SHA256)-(AES-256-GCM)
2023/12/04 10:58:22.102 kid1| 11,2| http.cc(2266) sendRequest: HTTP 
Server local=192.168.1.123:42772 remote=2.4.6.8:443 FD 13 flags=1
2023/12/04 10:58:22.102 kid1| 11,2| http.cc(2267) sendRequest: HTTP 
Server REQUEST:
---------
GET / HTTP/1.1
User-Agent: curl/7.74.0
Accept: */*
Host: test.regify.com
Via: 1.1 bulls.de.regify.com (squid/4.13)
Surrogate-Capability: bulls.de.regify.com="Surrogate/1.0 ESI/1.0"
X-Forwarded-For: 192.168.1.124
Cache-Control: max-age=259200
Connection: keep-alive


----------
2023/12/04 10:58:22.114 kid1| 11,2| http.cc(1212) readReply: 
local=192.168.1.123:42772 remote=2.4.6.8:443 FD 13 flags=1: read 
failure: (0) No error.
2023/12/04 10:58:22.114 kid1| 17,2| FwdState.cc(681) 
handleUnregisteredServerEnd: self=0x55ef6a88f4b8*2 err=0x55ef6a89bcf8 
https://test.regify.com/
2023/12/04 10:58:22.114 kid1| 4,2| errorpage.cc(1259) BuildContent: No 
existing error page language negotiated for ERR_READ_ERROR. Using 
default error file.
2023/12/04 10:58:22.114 kid1| 20,2| store.cc(985) checkCachable: 
StoreEntry::checkCachable: NO: not cachable
2023/12/04 10:58:22.114 kid1| 88,2| client_side_reply.cc(2062) 
processReplyAccessResult: The reply for GET https://test.regify.com/ is 
ALLOWED, because it matched all
2023/12/04 10:58:22.114 kid1| 11,2| Stream.cc(271) sendStartOfMessage: 
HTTP Client local=192.168.1.123:443 remote=192.168.1.124:41380 FD 11 flags=1
2023/12/04 10:58:22.114 kid1| 11,2| Stream.cc(272) sendStartOfMessage: 
HTTP Client REPLY:
---------
HTTP/1.1 502 Bad Gateway
Server: squid/4.13
Mime-Version: 1.0
Date: Mon, 04 Dec 2023 09:58:22 GMT
Content-Type: text/html;charset=utf-8
Content-Length: 3510
X-Squid-Error: ERR_READ_ERROR 0
Vary: Accept-Language
Content-Language: en
X-Cache: MISS from bulls.de.regify.com
X-Cache-Lookup: MISS from bulls.de.regify.com:443
Via: 1.1 bulls.de.regify.com (squid/4.13)
Connection: keep-alive


----------
2023/12/04 10:58:22.114 kid1| 20,2| store.cc(985) checkCachable: 
StoreEntry::checkCachable: NO: not cachable
2023/12/04 10:58:22.115 kid1| 20,2| store.cc(985) checkCachable: 
StoreEntry::checkCachable: NO: not cachable
2023/12/04 10:58:22.116 kid1| 33,2| client_side.cc(586) swanSong: 
local=192.168.1.123:443 remote=192.168.1.124:41380 flags=1






And curl https://www.foo.com yeilds also certificate errors and


2023/12/04 11:00:05.110 kid1| 5,2| TcpAcceptor.cc(224) doAccept: New 
connection on FD 12
2023/12/04 11:00:05.110 kid1| 5,2| TcpAcceptor.cc(312) acceptNext: 
connection on local=0.0.0.0:443 remote=[::] FD 12 flags=9
2023/12/04 11:00:05.111 kid1| 17,2| QosConfig.cc(125) 
getNfmarkFromConnection: QOS: Failed to retrieve connection mark: (-1) 
(1) Operation not permitted (Destination 192.168.1.123:443, source 
192.168.1.124:37526)
2023/12/04 11:00:05.133 kid1| 83,2| client_side.cc(2680) 
clientNegotiateSSL: TLS session reuse not yet implemented.
2023/12/04 11:00:05.133 kid1| 83,2| client_side.cc(2701) 
clientNegotiateSSL: Client certificate requesting not yet implemented.
2023/12/04 11:00:05.133 kid1| 11,2| client_side.cc(1306) 
parseHttpRequest: HTTP Client local=192.168.1.123:443 
remote=192.168.1.124:37526 FD 11 flags=1
2023/12/04 11:00:05.133 kid1| 11,2| client_side.cc(1307) 
parseHttpRequest: HTTP Client REQUEST:
---------
GET / HTTP/1.1
Host: www.foo.com
User-Agent: curl/7.74.0
Accept: */*


----------
2023/12/04 11:00:05.134 kid1| 85,2| client_side_request.cc(751) 
clientAccessCheckDone: The request GET https://www.foo.com/ is ALLOWED; 
last ACL checked: sfoo
2023/12/04 11:00:05.134 kid1| 85,2| client_side_request.cc(729) 
clientAccessCheck2: No adapted_http_access configuration. default: ALLOW
2023/12/04 11:00:05.134 kid1| 85,2| client_side_request.cc(751) 
clientAccessCheckDone: The request GET https://www.foo.com/ is ALLOWED; 
last ACL checked: sfoo
2023/12/04 11:00:05.134 kid1| 17,2| FwdState.cc(142) FwdState: 
Forwarding client request local=192.168.1.123:443 
remote=192.168.1.124:37526 FD 11 flags=1, url=https://www.foo.com/
2023/12/04 11:00:05.134 kid1| 44,2| peer_select.cc(295) 
peerSelectDnsPaths: Find IP destination for: https://www.foo.com/' via 
www.foo.com
2023/12/04 11:00:05.134 kid1| 44,2| peer_select.cc(316) 
peerSelectDnsPaths: Found sources for 'https://www.foo.com/'
2023/12/04 11:00:05.134 kid1| 44,2| peer_select.cc(317) 
peerSelectDnsPaths:?? always_direct = DENIED
2023/12/04 11:00:05.134 kid1| 44,2| peer_select.cc(318) 
peerSelectDnsPaths:??? never_direct = DENIED
2023/12/04 11:00:05.134 kid1| 44,2| peer_select.cc(328) 
peerSelectDnsPaths:????? cache_peer = local=0.0.0.0 remote=1.2.3.4:443 
flags=1
2023/12/04 11:00:05.134 kid1| 44,2| peer_select.cc(331) 
peerSelectDnsPaths:??????? timedout = 0
2023/12/04 11:00:05.146 kid1| 83,2| PeerConnector.cc(205) negotiate: 
handshake IN: Unknown Handshake packet
2023/12/04 11:00:05.146 kid1| 83,2| PeerConnector.cc(207) negotiate: 
handshake OUT: CLIENT HELLO
2023/12/04 11:00:05.161 kid1| 83,2| PeerConnector.cc(205) negotiate: 
handshake IN: SERVER HELLO DONE
2023/12/04 11:00:05.161 kid1| 83,2| PeerConnector.cc(207) negotiate: 
handshake OUT: FINISHED
2023/12/04 11:00:05.172 kid1| 83,2| PeerConnector.cc(198) negotiate: 
local=192.168.1.123:47236 remote=1.2.3.4:443 FD 13 flags=1 TLS Session 
info: (TLS1.2)-(ECDHE-SECP256R1)-(RSA-SHA512)-(AES-256-GCM)
2023/12/04 11:00:05.173 kid1| 11,2| http.cc(2266) sendRequest: HTTP 
Server local=192.168.1.123:47236 remote=1.2.3.4:443 FD 13 flags=1
2023/12/04 11:00:05.173 kid1| 11,2| http.cc(2267) sendRequest: HTTP 
Server REQUEST:
---------
GET / HTTP/1.1
User-Agent: curl/7.74.0
Accept: */*
Host: www.foo.com
Via: 1.1 bulls.de.regify.com (squid/4.13)
Surrogate-Capability: bulls.de.regify.com="Surrogate/1.0 ESI/1.0"
X-Forwarded-For: 192.168.1.124
Cache-Control: max-age=259200
Connection: keep-alive


----------
2023/12/04 11:00:05.185 kid1| ctx: enter level? 0: 'https://www.foo.com/'
2023/12/04 11:00:05.185 kid1| 11,2| http.cc(719) processReplyHeader: 
HTTP Server local=192.168.1.123:47236 remote=1.2.3.4:443 FD 13 flags=1
2023/12/04 11:00:05.185 kid1| 11,2| http.cc(720) processReplyHeader: 
HTTP Server RESPONSE:
---------
HTTP/1.1 302 Found
Date: Mon, 04 Dec 2023 10:00:05 GMT
Server: Apache
X-Frame-Options: SAMEORIGIN
Strict-Transport-Security: max-age=31536000; includeSubdomains;
X-Content-Type-Options: nosniff
X-XSS-Protection: 1
Content-Security-Policy: default-src 'self'; script-src 'self' 
'unsafe-inline' 'unsafe-eval'; connect-src 'self' 'unsafe-inline'; 
img-src https: data: 'unsafe-inline'; frame-src 'self'; style-src 'self' 
'unsafe-inline';
Location: https://www.foo.com/foo.php?mode=direct
Content-Length: 233
Keep-Alive: timeout=5, max=100
Connection: Keep-Alive
Content-Type: text/html; charset=iso-8859-1

----------
2023/12/04 11:00:05.185 kid1| ctx: exit level? 0
2023/12/04 11:00:05.185 kid1| 20,2| store.cc(985) checkCachable: 
StoreEntry::checkCachable: NO: not cachable
2023/12/04 11:00:05.185 kid1| 88,2| client_side_reply.cc(2062) 
processReplyAccessResult: The reply for GET https://www.foo.com/ is 
ALLOWED, because it matched sfoo
2023/12/04 11:00:05.185 kid1| 11,2| Stream.cc(271) sendStartOfMessage: 
HTTP Client local=192.168.1.123:443 remote=192.168.1.124:37526 FD 11 flags=1
2023/12/04 11:00:05.185 kid1| 11,2| Stream.cc(272) sendStartOfMessage: 
HTTP Client REPLY:
---------
HTTP/1.1 302 Found
Date: Mon, 04 Dec 2023 10:00:05 GMT
Server: Apache
X-Frame-Options: SAMEORIGIN
Strict-Transport-Security: max-age=31536000; includeSubdomains;
X-Content-Type-Options: nosniff
X-XSS-Protection: 1
Content-Security-Policy: default-src 'self'; script-src 'self' 
'unsafe-inline' 'unsafe-eval'; connect-src 'self' 'unsafe-inline'; 
img-src https: data: 'unsafe-inline'; frame-src 'self'; style-src 'self' 
'unsafe-inline';
Location: https://www.foo.com/foo.php?mode=direct
Content-Length: 233
Content-Type: text/html; charset=iso-8859-1
X-Cache: MISS from bulls.de.regify.com
X-Cache-Lookup: MISS from bulls.de.regify.com:443
Via: 1.1 bulls.de.regify.com (squid/4.13)
Connection: keep-alive


----------
2023/12/04 11:00:05.185 kid1| 20,2| store.cc(985) checkCachable: 
StoreEntry::checkCachable: NO: not cachable
2023/12/04 11:00:05.185 kid1| 20,2| store.cc(985) checkCachable: 
StoreEntry::checkCachable: NO: not cachable
2023/12/04 11:00:05.185 kid1| 20,2| store.cc(985) checkCachable: 
StoreEntry::checkCachable: NO: not cachable
2023/12/04 11:00:05.185 kid1| 20,2| store.cc(985) checkCachable: 
StoreEntry::checkCachable: NO: not cachable
2023/12/04 11:00:05.186 kid1| 33,2| client_side.cc(586) swanSong: 
local=192.168.1.123:443 remote=192.168.1.124:37526 flags=1





So i'm a bit confiused.
Is there a way to make https virtual hosting with multiple certificates 
to different back ends possible at all ATM?


Mit Freundlichen Gr??en / Kind regards

Mario Theodoridis

regify GmbH
R?merstrasse 39 | D-78183 H?fingen-Behla
Amtsgericht Freiburg HRB 709343
Telefon: +49 771 8978 4238



From bpk678 at gmail.com  Wed Dec  6 13:08:23 2023
From: bpk678 at gmail.com (Brendan Kearney)
Date: Wed, 6 Dec 2023 08:08:23 -0500
Subject: [squid-users] FATAL: assertion failed: peer_digest.cc:399:
 "fetch->pd && receivedData.data"
Message-ID: <dd015ebe-449f-e54d-b180-af47a73e0035@gmail.com>

list members,

i am running squid 6.5 on fedora 38, and have found this issue when 
running "cache sharing" (or cache_peer siblings) between my 3 squid 
instances.? a couple weeks ago, this was happening and an update seems 
to have fixed the majority of issues.? when i ran into the issue, i 
could disable cache_peer siblings and restart the instances that 
failed.? the recent update seemed to have addressed the problem, but i 
turned on ssl bump for a subset of traffic and the issue returned.

when i have all 3 proxies started, all of them will work for a period of 
time, then slowly all but one of the proxies will die. the last standing 
proxy does not go down because all other cache_peer siblings are 
offline, and the logic causing the failure does not execute.

this was a larger issue before the recent patch/update, but is still an 
issue when performing ssl bumping on traffic.? is there something i can 
provide in the way of logs or diagnostics to help identify the issue?

thanks,

brendan



From rousskov at measurement-factory.com  Wed Dec  6 15:15:38 2023
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Wed, 6 Dec 2023 10:15:38 -0500
Subject: [squid-users] FATAL: assertion failed: peer_digest.cc:399:
 "fetch->pd && receivedData.data"
In-Reply-To: <dd015ebe-449f-e54d-b180-af47a73e0035@gmail.com>
References: <dd015ebe-449f-e54d-b180-af47a73e0035@gmail.com>
Message-ID: <2717442a-9345-4b37-a3e5-7ceea4b5a29a@measurement-factory.com>

On 2023-12-06 08:08, Brendan Kearney wrote:

> i am running squid 6.5

You are suffering from Bug 5318:
https://bugs.squid-cache.org/show_bug.cgi?id=5318

That bug has been fixed in v6. Recent daily snapshots contain that fix, 
and it will be a part of the upcoming v6.6 release.

Alex.


> on fedora 38, and have found this issue when 
> running "cache sharing" (or cache_peer siblings) between my 3 squid 
> instances.? a couple weeks ago, this was happening and an update seems 
> to have fixed the majority of issues.? when i ran into the issue, i 
> could disable cache_peer siblings and restart the instances that 
> failed.? the recent update seemed to have addressed the problem, but i 
> turned on ssl bump for a subset of traffic and the issue returned.
> 
> when i have all 3 proxies started, all of them will work for a period of 
> time, then slowly all but one of the proxies will die. the last standing 
> proxy does not go down because all other cache_peer siblings are 
> offline, and the logic causing the failure does not execute.
> 
> this was a larger issue before the recent patch/update, but is still an 
> issue when performing ssl bumping on traffic.? is there something i can 
> provide in the way of logs or diagnostics to help identify the issue?



From ankor2023 at gmail.com  Thu Dec  7 02:34:31 2023
From: ankor2023 at gmail.com (Andrey K)
Date: Thu, 7 Dec 2023 05:34:31 +0300
Subject: [squid-users] IP based user identification/authentication
Message-ID: <CADJd0Y1OzeSwHx79ZyHR-U4n6kLUEa0tn3ij3SiSgAboPFRb9g@mail.gmail.com>

Hello,

I was interested if I can configure some custom external helper that will
be called before any authentication helpers and can perform user
identification/authentication based on the client src-IP address.
It can look up in the external system information about the user logged in
to the IP address and return the username and some annotation information
on success.
If the user has been identified, no subsequent authentications are required.
Identified users can be authorized later using standard squid mechanisms
(for example, ldap user groups membership).

This feature can be especially useful in "transparent" proxy configurations
where 407-"Proxy Authentication Required" response code is not applicable.

Kind regards,
    Ankor
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20231207/8fbbddb9/attachment.htm>

From squid3 at treenet.co.nz  Thu Dec  7 10:39:37 2023
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Thu, 7 Dec 2023 23:39:37 +1300
Subject: [squid-users] IP based user identification/authentication
In-Reply-To: <CADJd0Y1OzeSwHx79ZyHR-U4n6kLUEa0tn3ij3SiSgAboPFRb9g@mail.gmail.com>
References: <CADJd0Y1OzeSwHx79ZyHR-U4n6kLUEa0tn3ij3SiSgAboPFRb9g@mail.gmail.com>
Message-ID: <dcce56b7-b142-46af-bdca-2c8ad9697d10@treenet.co.nz>

On 7/12/23 15:34, Andrey K wrote:
> Hello,
> 
> I was interested if I can configure some custom external helper that 
> will be called before any authentication helpers and can perform user 
> identification/authentication based on the client src-IP address.

Well, yes and no.



The order of authentication and authorization helpers is determined by 
what order you configure http_access tests.

So "yes" in that you can call it before authentication, and have it tell 
you what "user" it *thinks* is using that IP.


However, ...

> It can look up in the external system information about the user logged 
> in to the IP address and return the username and some annotation 
> information on success.

Users do not "log into IP address" and ...


> If the user has been identified, no subsequent authentications are required.
> Identified users can be authorized later using?standard squid mechanisms 
> (for example, ldap user groups membership).
> 
> This feature can be especially useful in "transparent" proxy 
> configurations where 407-"Proxy Authentication Required" response code 
> is not applicable.


... with interception the user agent is not aware of the proxy 
existence. So it *will not* provide the credentials necessary for 
authentication. Not to the proxy, nor a helper.

So "no".

This is not a way to authenticate. It is a way to **authorize**. The 
difference is very important.

For more info lookup "captive portal" on how this type of configuration 
is done and used.


Cheers
Amos


From ankor2023 at gmail.com  Thu Dec  7 15:40:54 2023
From: ankor2023 at gmail.com (Andrey K)
Date: Thu, 7 Dec 2023 18:40:54 +0300
Subject: [squid-users] IP based user identification/authentication
In-Reply-To: <dcce56b7-b142-46af-bdca-2c8ad9697d10@treenet.co.nz>
References: <CADJd0Y1OzeSwHx79ZyHR-U4n6kLUEa0tn3ij3SiSgAboPFRb9g@mail.gmail.com>
 <dcce56b7-b142-46af-bdca-2c8ad9697d10@treenet.co.nz>
Message-ID: <CADJd0Y2mxxd3OMUEeHbKa25PhrE2DtsdjgeVBjOdyk3MXczEkA@mail.gmail.com>

Hello, Amos,

Thank you for your comments.
I must have described the scenario incorrectly, I'll try again in more
detail.


Let's say we have a system that collects information that a user logged in
to a computer (it can, for example, read security logs from Active
Directory). Thus, it has a match of the user's login and the host's IP
address. Let's call it Awareness system.

When a request comes to SQUID, and the policy reaches the rules where user
information is required (for example "*http_access allow auth"*), an
external helper must be called, and the src IP address would be passed to
it.
The helper accesses the  Awareness system and asks if it has information
about the user registered on the host with this source IP address.

If the user is found, the helper must return his username to the SQUID.
SQUID should assign this username to the *%LOGIN* variable. And then this
session should be considered authenticated (for example, it should match
the "*acl aclname proxy_auth username*" acls). Next, authorization helpers
may be launched for it (for example, *ext_wbinfo_group_acl*) if necessary
according to the policy.

If there is no information about the user in the external system and
additional authentication helpers are registered in the proxy configuration
(for example, auth_param negotiate program negotiate_wrapper_auth), then
SQUID should return a 407 response and use basic/ntlm/negotiate
authentication methods as usual.

The described process is definitely not authorization, it is rather user
identification.

I hope I've cleared things up a bit.

Kind regards,
      Ankor.



??, 7 ???. 2023??. ? 13:39, Amos Jeffries <squid3 at treenet.co.nz>:

> On 7/12/23 15:34, Andrey K wrote:
> > Hello,
> >
> > I was interested if I can configure some custom external helper that
> > will be called before any authentication helpers and can perform user
> > identification/authentication based on the client src-IP address.
>
> Well, yes and no.
>
>
>
> The order of authentication and authorization helpers is determined by
> what order you configure http_access tests.
>
> So "yes" in that you can call it before authentication, and have it tell
> you what "user" it *thinks* is using that IP.
>
>
> However, ...
>
> > It can look up in the external system information about the user logged
> > in to the IP address and return the username and some annotation
> > information on success.
>
> Users do not "log into IP address" and ...
>
>
> > If the user has been identified, no subsequent authentications are
> required.
> > Identified users can be authorized later using standard squid mechanisms
> > (for example, ldap user groups membership).
> >
> > This feature can be especially useful in "transparent" proxy
> > configurations where 407-"Proxy Authentication Required" response code
> > is not applicable.
>
>
> ... with interception the user agent is not aware of the proxy
> existence. So it *will not* provide the credentials necessary for
> authentication. Not to the proxy, nor a helper.
>
> So "no".
>
> This is not a way to authenticate. It is a way to **authorize**. The
> difference is very important.
>
> For more info lookup "captive portal" on how this type of configuration
> is done and used.
>
>
> Cheers
> Amos
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> https://lists.squid-cache.org/listinfo/squid-users
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20231207/1787e313/attachment.htm>

From ankor2023 at gmail.com  Fri Dec  8 05:59:54 2023
From: ankor2023 at gmail.com (Andrey K)
Date: Fri, 8 Dec 2023 08:59:54 +0300
Subject: [squid-users] IP based user identification/authentication
In-Reply-To: <CADJd0Y2mxxd3OMUEeHbKa25PhrE2DtsdjgeVBjOdyk3MXczEkA@mail.gmail.com>
References: <CADJd0Y1OzeSwHx79ZyHR-U4n6kLUEa0tn3ij3SiSgAboPFRb9g@mail.gmail.com>
 <dcce56b7-b142-46af-bdca-2c8ad9697d10@treenet.co.nz>
 <CADJd0Y2mxxd3OMUEeHbKa25PhrE2DtsdjgeVBjOdyk3MXczEkA@mail.gmail.com>
Message-ID: <CADJd0Y3TpGam+kauXUQG20-kES2MtzY9yA2XDvybNpQnoB+Cvw@mail.gmail.com>

Hello, Amos,

For more info lookup "captive portal" on how this type of configuration
> is done and used.

Did you mean this link:
https://wiki.squid-cache.org/ConfigExamples/Portal/Splash?
It seems to be very useful in my case.
Thank you very much!



Kind regards,
      Ankor.



??, 7 ???. 2023??. ? 18:40, Andrey K <ankor2023 at gmail.com>:

> Hello, Amos,
>
> Thank you for your comments.
> I must have described the scenario incorrectly, I'll try again in more
> detail.
>
>
> Let's say we have a system that collects information that a user logged in
> to a computer (it can, for example, read security logs from Active
> Directory). Thus, it has a match of the user's login and the host's IP
> address. Let's call it Awareness system.
>
> When a request comes to SQUID, and the policy reaches the rules where user
> information is required (for example "*http_access allow auth"*), an
> external helper must be called, and the src IP address would be passed to
> it.
> The helper accesses the  Awareness system and asks if it has information
> about the user registered on the host with this source IP address.
>
> If the user is found, the helper must return his username to the SQUID.
> SQUID should assign this username to the *%LOGIN* variable. And then this
> session should be considered authenticated (for example, it should match
> the "*acl aclname proxy_auth username*" acls). Next, authorization
> helpers may be launched for it (for example, *ext_wbinfo_group_acl*) if
> necessary according to the policy.
>
> If there is no information about the user in the external system and
> additional authentication helpers are registered in the proxy configuration
> (for example, auth_param negotiate program negotiate_wrapper_auth), then
> SQUID should return a 407 response and use basic/ntlm/negotiate
> authentication methods as usual.
>
> The described process is definitely not authorization, it is rather user
> identification.
>
> I hope I've cleared things up a bit.
>
> Kind regards,
>       Ankor.
>
>
>
> ??, 7 ???. 2023??. ? 13:39, Amos Jeffries <squid3 at treenet.co.nz>:
>
>> On 7/12/23 15:34, Andrey K wrote:
>> > Hello,
>> >
>> > I was interested if I can configure some custom external helper that
>> > will be called before any authentication helpers and can perform user
>> > identification/authentication based on the client src-IP address.
>>
>> Well, yes and no.
>>
>>
>>
>> The order of authentication and authorization helpers is determined by
>> what order you configure http_access tests.
>>
>> So "yes" in that you can call it before authentication, and have it tell
>> you what "user" it *thinks* is using that IP.
>>
>>
>> However, ...
>>
>> > It can look up in the external system information about the user logged
>> > in to the IP address and return the username and some annotation
>> > information on success.
>>
>> Users do not "log into IP address" and ...
>>
>>
>> > If the user has been identified, no subsequent authentications are
>> required.
>> > Identified users can be authorized later using standard squid
>> mechanisms
>> > (for example, ldap user groups membership).
>> >
>> > This feature can be especially useful in "transparent" proxy
>> > configurations where 407-"Proxy Authentication Required" response code
>> > is not applicable.
>>
>>
>> ... with interception the user agent is not aware of the proxy
>> existence. So it *will not* provide the credentials necessary for
>> authentication. Not to the proxy, nor a helper.
>>
>> So "no".
>>
>> This is not a way to authenticate. It is a way to **authorize**. The
>> difference is very important.
>>
>> For more info lookup "captive portal" on how this type of configuration
>> is done and used.
>>
>>
>> Cheers
>> Amos
>> _______________________________________________
>> squid-users mailing list
>> squid-users at lists.squid-cache.org
>> https://lists.squid-cache.org/listinfo/squid-users
>>
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20231208/497e7cf2/attachment.htm>

From cvuosalo at cern.ch  Fri Dec  8 23:05:02 2023
From: cvuosalo at cern.ch (Carl Vuosalo)
Date: Fri, 8 Dec 2023 17:05:02 -0600
Subject: [squid-users] With Squid 6.5 -- ERROR: Failed to unpack Store entry
 metadata: swap meta MD5 mismatch?
Message-ID: <4aa30c25-cd66-2589-65ef-28ca993d39d7@cern.ch>

We updated from Squid 5.9 to Squid 6.5, and then immediately started 
seeing many of these new errors in the cache.log:

2023/12/08 23:26:52 kid1| ERROR: Failed to unpack Store entry metadata: 
swap meta MD5 mismatch
 ??? exception location: SwapMetaIn.cc(89) CheckSwapMetaKey
 ??? current master transaction: master3394333

Can anyone suggest what these errors might mean? I looked at the source 
code line indicated, but I couldn't understand what the issue might be.

Thanks.


---Carl



From gkinkie at gmail.com  Sat Dec  9 10:35:45 2023
From: gkinkie at gmail.com (Francesco Chemolli)
Date: Sat, 9 Dec 2023 10:35:45 +0000
Subject: [squid-users] With Squid 6.5 -- ERROR: Failed to unpack Store
 entry metadata: swap meta MD5 mismatch?
In-Reply-To: <4aa30c25-cd66-2589-65ef-28ca993d39d7@cern.ch>
References: <4aa30c25-cd66-2589-65ef-28ca993d39d7@cern.ch>
Message-ID: <CA+Y8hcM-mCBwJ0zRpRFKM1iB0T61izCOehHjwtS17-ycP9BaJQ@mail.gmail.com>

Hi Carl,
  a quick search led me to
https://wiki.squid-cache.org/SquidFaq/InnerWorkings#what-does-swapin-md5-mismatch-mean


Quoting: "You do not need to worry about this warning. It means that Squid
is double-checking that the disk file matches what Squid thinks should be
there, and the check failed. Squid recovers and generates a cache miss in
this case."

If the issue persists after extended usage, it might indicate a bug in
Squid's cache handling.

On Fri, Dec 8, 2023 at 11:05?PM Carl Vuosalo <cvuosalo at cern.ch> wrote:

> We updated from Squid 5.9 to Squid 6.5, and then immediately started
> seeing many of these new errors in the cache.log:
>
> 2023/12/08 23:26:52 kid1| ERROR: Failed to unpack Store entry metadata:
> swap meta MD5 mismatch
>      exception location: SwapMetaIn.cc(89) CheckSwapMetaKey
>      current master transaction: master3394333
>
> Can anyone suggest what these errors might mean? I looked at the source
> code line indicated, but I couldn't understand what the issue might be.
>
> Thanks.
>
>
> ---Carl
>
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> https://lists.squid-cache.org/listinfo/squid-users
>


-- 
    Francesco
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20231209/6aeafe27/attachment.htm>

From gaven.l.henderson at rtx.com  Tue Dec 12 16:25:59 2023
From: gaven.l.henderson at rtx.com (HENDERSON, GAVEN L     RTX)
Date: Tue, 12 Dec 2023 16:25:59 +0000
Subject: [squid-users] Cache_peer breaks Squid 5.5
In-Reply-To: <CY1P110MB06136FC6BBA99151D804EDBCBE8EA@CY1P110MB0613.NAMP110.PROD.OUTLOOK.COM>
References: <CY1P110MB06136FC6BBA99151D804EDBCBE8EA@CY1P110MB0613.NAMP110.PROD.OUTLOOK.COM>
Message-ID: <CY1P110MB06130E73C6AAE349A6429545BE8EA@CY1P110MB0613.NAMP110.PROD.OUTLOOK.COM>

Sorry if this has already been answered.  I couldn't find anything online regarding the problem I am experiencing.  I have a Squid server acting as a proxy relay.  It listens on two ports and, depending on which port a request comes in, the request is forwarded to a specific upstream proxy.  Everything was working prior to the 5.5 update.  Now, Squid starts but crashes a few seconds later.  I have traced it down to the cache_peer directives.  If I comment them out, the service is stable.  I have also tried the stock configuration with only the cache_peer directive added and it still crashes so I don't think the problem is being triggered by some other part of my configuration.  I'm not seeing anything particularly helpful in the messages log:

Nov 24 15:17:30 svr-squid squid[2259]: Squid Parent: squid-1 process 2290 exited due to signal 6 with status 0
Nov 24 15:17:30 svr-squid squid[2259]: Squid Parent: squid-1 process 2290 will not be restarted for 3600 seconds due to repeated, frequent failures
Nov 24 15:17:30 svr-squid squid[2259]: Exiting due to repeated, frequent failures
Nov 24 15:17:30 svr-squid systemd[1]: mailto:systemd-coredump at 21-2295-0.service: Deactivated successfully.
Nov 24 15:17:30 svr-squid systemd[1]: squid.service: Main process exited, code=exited, status=1/FAILURE
Nov 24 15:17:30 svr-squid systemd[1]: squid.service: Failed with result 'exit-code'.

Here is my configuration:

http_port 192.168.0.1:80 name=port80
http_port 192.168.0.1:81 name=port81

acl port80_acl myportname port80
acl port81_acl myportname port81
acl bypass_parent dstdom_regex "/etc/squid/bypass_parent.txt"
acl domain_blacklist dstdomain "/etc/squid/domain_blacklist.txt"

http_access deny all domain_blacklist
always_direct allow bypass_parent
never_direct allow port80_acl
never_direct allow port81_acl

cache_peer proxy1.domain.com parent 80 0 default name=proxy80
cache_peer_access proxy80 allow port80_acl
cache_peer_access proxy80 deny all

cache_peer proxy2.domain.com parent 80 0 default name=proxy81
cache_peer_access proxy81 allow port81_acl
cache_peer_access proxy81 deny all

http_access allow all

logformat squid [%tl] %>a %>eui %Ss/%03>Hs %<st %rm %ru %[un %Sh/%<a %mt


From rousskov at measurement-factory.com  Tue Dec 12 18:21:53 2023
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Tue, 12 Dec 2023 13:21:53 -0500
Subject: [squid-users] Cache_peer breaks Squid 5.5
In-Reply-To: <CY1P110MB06130E73C6AAE349A6429545BE8EA@CY1P110MB0613.NAMP110.PROD.OUTLOOK.COM>
References: <CY1P110MB06136FC6BBA99151D804EDBCBE8EA@CY1P110MB0613.NAMP110.PROD.OUTLOOK.COM>
 <CY1P110MB06130E73C6AAE349A6429545BE8EA@CY1P110MB0613.NAMP110.PROD.OUTLOOK.COM>
Message-ID: <b797ee71-7131-4940-bd93-76f0da0ed88f@measurement-factory.com>

On 2023-12-12 11:25, HENDERSON, GAVEN L RTX wrote:
> Sorry if this has already been answered.  I couldn't find anything online regarding the problem I am experiencing.  I have a Squid server acting as a proxy relay.  It listens on two ports and, depending on which port a request comes in, the request is forwarded to a specific upstream proxy.  Everything was working prior to the 5.5 update.  Now, Squid starts but crashes a few seconds later.  I have traced it down to the cache_peer directives.  If I comment them out, the service is stable.  I have also tried the stock configuration with only the cache_peer directive added and it still crashes so I don't think the problem is being triggered by some other part of my configuration.  I'm not seeing anything particularly helpful in the messages log:

What do you see in Squid's cache.log? I would expect a message about 
Squid hitting an assertion or detecting another catastrophic problem 
before crashing. If there is nothing in cache.log, consider (enabling 
core dumps in your OS configuration and) getting a backtrace from the 
crashed Squid process.


HTH,

Alex.



> Nov 24 15:17:30 svr-squid squid[2259]: Squid Parent: squid-1 process 2290 exited due to signal 6 with status 0
> Nov 24 15:17:30 svr-squid squid[2259]: Squid Parent: squid-1 process 2290 will not be restarted for 3600 seconds due to repeated, frequent failures
> Nov 24 15:17:30 svr-squid squid[2259]: Exiting due to repeated, frequent failures
> Nov 24 15:17:30 svr-squid systemd[1]: mailto:systemd-coredump at 21-2295-0.service: Deactivated successfully.
> Nov 24 15:17:30 svr-squid systemd[1]: squid.service: Main process exited, code=exited, status=1/FAILURE
> Nov 24 15:17:30 svr-squid systemd[1]: squid.service: Failed with result 'exit-code'.
> 
> Here is my configuration:
> 
> http_port 192.168.0.1:80 name=port80
> http_port 192.168.0.1:81 name=port81
> 
> acl port80_acl myportname port80
> acl port81_acl myportname port81
> acl bypass_parent dstdom_regex "/etc/squid/bypass_parent.txt"
> acl domain_blacklist dstdomain "/etc/squid/domain_blacklist.txt"
> 
> http_access deny all domain_blacklist
> always_direct allow bypass_parent
> never_direct allow port80_acl
> never_direct allow port81_acl
> 
> cache_peer proxy1.domain.com parent 80 0 default name=proxy80
> cache_peer_access proxy80 allow port80_acl
> cache_peer_access proxy80 deny all
> 
> cache_peer proxy2.domain.com parent 80 0 default name=proxy81
> cache_peer_access proxy81 allow port81_acl
> cache_peer_access proxy81 deny all
> 
> http_access allow all
> 
> logformat squid [%tl] %>a %>eui %Ss/%03>Hs %<st %rm %ru %[un %Sh/%<a %mt
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> https://lists.squid-cache.org/listinfo/squid-users



From gaven.l.henderson at rtx.com  Wed Dec 13 02:45:46 2023
From: gaven.l.henderson at rtx.com (HENDERSON, GAVEN L     RTX)
Date: Wed, 13 Dec 2023 02:45:46 +0000
Subject: [squid-users] [External] Re:  Cache_peer breaks Squid 5.5
In-Reply-To: <b797ee71-7131-4940-bd93-76f0da0ed88f@measurement-factory.com>
References: <CY1P110MB06136FC6BBA99151D804EDBCBE8EA@CY1P110MB0613.NAMP110.PROD.OUTLOOK.COM>
 <CY1P110MB06130E73C6AAE349A6429545BE8EA@CY1P110MB0613.NAMP110.PROD.OUTLOOK.COM>
 <b797ee71-7131-4940-bd93-76f0da0ed88f@measurement-factory.com>
Message-ID: <CY1P110MB061318CD0F41FAE296842EDCBE8DA@CY1P110MB0613.NAMP110.PROD.OUTLOOK.COM>

assertion failed: peer_digest.cc:419: "EX"

Found this:  https://access.redhat.com/solutions/7048529

Any thoughts on how to fix this on Rocky 9?


Regards,

Gaven Henderson
DT System Administrator - Raytheon Vision Systems
RIS Digital Technologies - AADS Mfg Solutions
Raytheon Technologies

+1 805-562-2614   (office)
+1 805-451-6572   (cell)
+1 805-880-6513   (pager)

This message contains information that may be confidential and privileged. Unless you are the addressee (or authorized to receive mail for the addressee), you should not use, copy or disclose to anyone this message or any information contained in this message. If you have received this message in error, please so advise the sender by reply email and delete this message. Thank you for your cooperation.

-----Original Message-----
From: squid-users <squid-users-bounces at lists.squid-cache.org> On Behalf Of Alex Rousskov
Sent: Tuesday, December 12, 2023 10:22 AM
To: squid-users at lists.squid-cache.org
Subject: [External] Re: [squid-users] Cache_peer breaks Squid 5.5

On 2023-12-12 11:25, HENDERSON, GAVEN L RTX wrote:
> Sorry if this has already been answered.  I couldn't find anything online regarding the problem I am experiencing.  I have a Squid server acting as a proxy relay.  It listens on two ports and, depending on which port a request comes in, the request is forwarded to a specific upstream proxy.  Everything was working prior to the 5.5 update.  Now, Squid starts but crashes a few seconds later.  I have traced it down to the cache_peer directives.  If I comment them out, the service is stable.  I have also tried the stock configuration with only the cache_peer directive added and it still crashes so I don't think the problem is being triggered by some other part of my configuration.  I'm not seeing anything particularly helpful in the messages log:

What do you see in Squid's cache.log? I would expect a message about Squid hitting an assertion or detecting another catastrophic problem before crashing. If there is nothing in cache.log, consider (enabling core dumps in your OS configuration and) getting a backtrace from the crashed Squid process.


HTH,

Alex.



> Nov 24 15:17:30 svr-squid squid[2259]: Squid Parent: squid-1 process
> 2290 exited due to signal 6 with status 0 Nov 24 15:17:30 svr-squid
> squid[2259]: Squid Parent: squid-1 process 2290 will not be restarted
> for 3600 seconds due to repeated, frequent failures Nov 24 15:17:30 svr-squid squid[2259]: Exiting due to repeated, frequent failures Nov 24 15:17:30 svr-squid systemd[1]: mailto:systemd-coredump at 21-2295-0.service: Deactivated successfully.
> Nov 24 15:17:30 svr-squid systemd[1]: squid.service: Main process
> exited, code=exited, status=1/FAILURE Nov 24 15:17:30 svr-squid systemd[1]: squid.service: Failed with result 'exit-code'.
>
> Here is my configuration:
>
> http_port 192.168.0.1:80 name=port80
> http_port 192.168.0.1:81 name=port81
>
> acl port80_acl myportname port80
> acl port81_acl myportname port81
> acl bypass_parent dstdom_regex "/etc/squid/bypass_parent.txt"
> acl domain_blacklist dstdomain "/etc/squid/domain_blacklist.txt"
>
> http_access deny all domain_blacklist
> always_direct allow bypass_parent
> never_direct allow port80_acl
> never_direct allow port81_acl
>
> cache_peer proxy1.domain.com parent 80 0 default name=proxy80
> cache_peer_access proxy80 allow port80_acl cache_peer_access proxy80
> deny all
>
> cache_peer proxy2.domain.com parent 80 0 default name=proxy81
> cache_peer_access proxy81 allow port81_acl cache_peer_access proxy81
> deny all
>
> http_access allow all
>
> logformat squid [%tl] %>a %>eui %Ss/%03>Hs %<st %rm %ru %[un %Sh/%<a
> %mt _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> https://urldefense.com/v3/__https://lists.squid-cache.org/listinfo/squ
> id-users__;!!MvWE!FEDTJs2pTa3njy74FPFejy1UEla67Tsxo5KMiUxhSdHn4--dUL_t
> kUqmWCJ64l_RHB9_uSLhEWcTeWWRcO7R6E68TUQsCFE6$

_______________________________________________
squid-users mailing list
squid-users at lists.squid-cache.org
https://urldefense.com/v3/__https://lists.squid-cache.org/listinfo/squid-users__;!!MvWE!FEDTJs2pTa3njy74FPFejy1UEla67Tsxo5KMiUxhSdHn4--dUL_tkUqmWCJ64l_RHB9_uSLhEWcTeWWRcO7R6E68TUQsCFE6$


From rousskov at measurement-factory.com  Wed Dec 13 16:30:47 2023
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Wed, 13 Dec 2023 11:30:47 -0500
Subject: [squid-users] [External] Re:  Cache_peer breaks Squid 5.5
In-Reply-To: <CY1P110MB061318CD0F41FAE296842EDCBE8DA@CY1P110MB0613.NAMP110.PROD.OUTLOOK.COM>
References: <CY1P110MB06136FC6BBA99151D804EDBCBE8EA@CY1P110MB0613.NAMP110.PROD.OUTLOOK.COM>
 <CY1P110MB06130E73C6AAE349A6429545BE8EA@CY1P110MB0613.NAMP110.PROD.OUTLOOK.COM>
 <b797ee71-7131-4940-bd93-76f0da0ed88f@measurement-factory.com>
 <CY1P110MB061318CD0F41FAE296842EDCBE8DA@CY1P110MB0613.NAMP110.PROD.OUTLOOK.COM>
Message-ID: <1fff05ec-930b-48c4-9ea9-6b8afad92d2b@measurement-factory.com>

On 2023-12-12 21:45, HENDERSON, GAVEN L RTX wrote:

> assertion failed: peer_digest.cc:419: "EX"

... which is one of the following assertions (quoted with their official 
Squid v5.5 line numbers, none of which is 419):

     412     assert(fetch->pd && receivedData.data);
     416     assert(fetch->buf + fetch->bufofs == receivedData.data);
     421     assert(fetch->bufofs <= SM_PAGE_SIZE);

FWIW, the latest Squid v5 branch code (and future v5.10 if it is 
released), fixes the bug that resulted in assertions logged as "EX" 
instead of the actual assertion text. The same bug is fixed in all v6 
releases.

This new bug report might be related:
https://bugs.squid-cache.org/show_bug.cgi?id=5330


> Any thoughts on how to fix this on Rocky 9?

Unfortunately, I failed to find good suspects for this v5 bug -- all 
obvious suspects came after v5.5 was released. However, I do not even 
know which version you were running before updating to v5.5. Please note 
that v5 is not officially supported by the Squid Project.


My recommendation is to update to v6.6 or later.


HTH,

Alex.


> -----Original Message-----
> From: squid-users <squid-users-bounces at lists.squid-cache.org> On Behalf Of Alex Rousskov
> Sent: Tuesday, December 12, 2023 10:22 AM
> To: squid-users at lists.squid-cache.org
> Subject: [External] Re: [squid-users] Cache_peer breaks Squid 5.5
> 
> On 2023-12-12 11:25, HENDERSON, GAVEN L RTX wrote:
>> Sorry if this has already been answered.  I couldn't find anything online regarding the problem I am experiencing.  I have a Squid server acting as a proxy relay.  It listens on two ports and, depending on which port a request comes in, the request is forwarded to a specific upstream proxy.  Everything was working prior to the 5.5 update.  Now, Squid starts but crashes a few seconds later.  I have traced it down to the cache_peer directives.  If I comment them out, the service is stable.  I have also tried the stock configuration with only the cache_peer directive added and it still crashes so I don't think the problem is being triggered by some other part of my configuration.  I'm not seeing anything particularly helpful in the messages log:
> 
> What do you see in Squid's cache.log? I would expect a message about Squid hitting an assertion or detecting another catastrophic problem before crashing. If there is nothing in cache.log, consider (enabling core dumps in your OS configuration and) getting a backtrace from the crashed Squid process.
> 
> 
> HTH,
> 
> Alex.
> 
> 
> 
>> Nov 24 15:17:30 svr-squid squid[2259]: Squid Parent: squid-1 process
>> 2290 exited due to signal 6 with status 0 Nov 24 15:17:30 svr-squid
>> squid[2259]: Squid Parent: squid-1 process 2290 will not be restarted
>> for 3600 seconds due to repeated, frequent failures Nov 24 15:17:30 svr-squid squid[2259]: Exiting due to repeated, frequent failures Nov 24 15:17:30 svr-squid systemd[1]: mailto:systemd-coredump at 21-2295-0.service: Deactivated successfully.
>> Nov 24 15:17:30 svr-squid systemd[1]: squid.service: Main process
>> exited, code=exited, status=1/FAILURE Nov 24 15:17:30 svr-squid systemd[1]: squid.service: Failed with result 'exit-code'.
>>
>> Here is my configuration:
>>
>> http_port 192.168.0.1:80 name=port80
>> http_port 192.168.0.1:81 name=port81
>>
>> acl port80_acl myportname port80
>> acl port81_acl myportname port81
>> acl bypass_parent dstdom_regex "/etc/squid/bypass_parent.txt"
>> acl domain_blacklist dstdomain "/etc/squid/domain_blacklist.txt"
>>
>> http_access deny all domain_blacklist
>> always_direct allow bypass_parent
>> never_direct allow port80_acl
>> never_direct allow port81_acl
>>
>> cache_peer proxy1.domain.com parent 80 0 default name=proxy80
>> cache_peer_access proxy80 allow port80_acl cache_peer_access proxy80
>> deny all
>>
>> cache_peer proxy2.domain.com parent 80 0 default name=proxy81
>> cache_peer_access proxy81 allow port81_acl cache_peer_access proxy81
>> deny all
>>
>> http_access allow all
>>
>> logformat squid [%tl] %>a %>eui %Ss/%03>Hs %<st %rm %ru %[un %Sh/%<a
>> %mt _______________________________________________
>> squid-users mailing list
>> squid-users at lists.squid-cache.org
>> https://urldefense.com/v3/__https://lists.squid-cache.org/listinfo/squ
>> id-users__;!!MvWE!FEDTJs2pTa3njy74FPFejy1UEla67Tsxo5KMiUxhSdHn4--dUL_t
>> kUqmWCJ64l_RHB9_uSLhEWcTeWWRcO7R6E68TUQsCFE6$
> 
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> https://urldefense.com/v3/__https://lists.squid-cache.org/listinfo/squid-users__;!!MvWE!FEDTJs2pTa3njy74FPFejy1UEla67Tsxo5KMiUxhSdHn4--dUL_tkUqmWCJ64l_RHB9_uSLhEWcTeWWRcO7R6E68TUQsCFE6$



From gaven.l.henderson at rtx.com  Wed Dec 13 19:04:11 2023
From: gaven.l.henderson at rtx.com (HENDERSON, GAVEN L     RTX)
Date: Wed, 13 Dec 2023 19:04:11 +0000
Subject: [squid-users] [External] Re:  Cache_peer breaks Squid 5.5
In-Reply-To: <1fff05ec-930b-48c4-9ea9-6b8afad92d2b@measurement-factory.com>
References: <CY1P110MB06136FC6BBA99151D804EDBCBE8EA@CY1P110MB0613.NAMP110.PROD.OUTLOOK.COM>
 <CY1P110MB06130E73C6AAE349A6429545BE8EA@CY1P110MB0613.NAMP110.PROD.OUTLOOK.COM>
 <b797ee71-7131-4940-bd93-76f0da0ed88f@measurement-factory.com>
 <CY1P110MB061318CD0F41FAE296842EDCBE8DA@CY1P110MB0613.NAMP110.PROD.OUTLOOK.COM>
 <1fff05ec-930b-48c4-9ea9-6b8afad92d2b@measurement-factory.com>
Message-ID: <CY1P110MB06133C066724793DDAFB1720BE8DA@CY1P110MB0613.NAMP110.PROD.OUTLOOK.COM>

Thanks for all the information.  I primarially deal with Windows so I'm dealing with a bit of a learning curve here.  Any suggestions on how to install Squid 6 on Rocky 9?  Can I do that with dnf/yum from a repo or an RPM?  I'm really hoping there's a way to do that without compiling.

-----Original Message-----
From: Alex Rousskov <rousskov at measurement-factory.com>
Sent: Wednesday, December 13, 2023 8:31 AM
To: HENDERSON, GAVEN L RTX <gaven.l.henderson at rtx.com>; squid-users at lists.squid-cache.org
Subject: Re: [External] Re: [squid-users] Cache_peer breaks Squid 5.5

On 2023-12-12 21:45, HENDERSON, GAVEN L RTX wrote:

> assertion failed: peer_digest.cc:419: "EX"

... which is one of the following assertions (quoted with their official Squid v5.5 line numbers, none of which is 419):

     412     assert(fetch->pd && receivedData.data);
     416     assert(fetch->buf + fetch->bufofs == receivedData.data);
     421     assert(fetch->bufofs <= SM_PAGE_SIZE);

FWIW, the latest Squid v5 branch code (and future v5.10 if it is released), fixes the bug that resulted in assertions logged as "EX"
instead of the actual assertion text. The same bug is fixed in all v6 releases.

This new bug report might be related:
https://urldefense.com/v3/__https://bugs.squid-cache.org/show_bug.cgi?id=5330__;!!MvWE!GWVUtWGdcsSlCpQnSreaelvBFVUzRBoz315_Hs-MfksgZgo0TW82oiY4HVlajT31-yti6h8AijE4eqKOQEPrRqk0IxEc-t_G$


> Any thoughts on how to fix this on Rocky 9?

Unfortunately, I failed to find good suspects for this v5 bug -- all obvious suspects came after v5.5 was released. However, I do not even know which version you were running before updating to v5.5. Please note that v5 is not officially supported by the Squid Project.


My recommendation is to update to v6.6 or later.


HTH,

Alex.


> -----Original Message-----
> From: squid-users <squid-users-bounces at lists.squid-cache.org> On
> Behalf Of Alex Rousskov
> Sent: Tuesday, December 12, 2023 10:22 AM
> To: squid-users at lists.squid-cache.org
> Subject: [External] Re: [squid-users] Cache_peer breaks Squid 5.5
>
> On 2023-12-12 11:25, HENDERSON, GAVEN L RTX wrote:
>> Sorry if this has already been answered.  I couldn't find anything online regarding the problem I am experiencing.  I have a Squid server acting as a proxy relay.  It listens on two ports and, depending on which port a request comes in, the request is forwarded to a specific upstream proxy.  Everything was working prior to the 5.5 update.  Now, Squid starts but crashes a few seconds later.  I have traced it down to the cache_peer directives.  If I comment them out, the service is stable.  I have also tried the stock configuration with only the cache_peer directive added and it still crashes so I don't think the problem is being triggered by some other part of my configuration.  I'm not seeing anything particularly helpful in the messages log:
>
> What do you see in Squid's cache.log? I would expect a message about Squid hitting an assertion or detecting another catastrophic problem before crashing. If there is nothing in cache.log, consider (enabling core dumps in your OS configuration and) getting a backtrace from the crashed Squid process.
>
>
> HTH,
>
> Alex.
>
>
>
>> Nov 24 15:17:30 svr-squid squid[2259]: Squid Parent: squid-1 process
>> 2290 exited due to signal 6 with status 0 Nov 24 15:17:30 svr-squid
>> squid[2259]: Squid Parent: squid-1 process 2290 will not be restarted
>> for 3600 seconds due to repeated, frequent failures Nov 24 15:17:30 svr-squid squid[2259]: Exiting due to repeated, frequent failures Nov 24 15:17:30 svr-squid systemd[1]: mailto:systemd-coredump at 21-2295-0.service: Deactivated successfully.
>> Nov 24 15:17:30 svr-squid systemd[1]: squid.service: Main process
>> exited, code=exited, status=1/FAILURE Nov 24 15:17:30 svr-squid systemd[1]: squid.service: Failed with result 'exit-code'.
>>
>> Here is my configuration:
>>
>> http_port 192.168.0.1:80 name=port80
>> http_port 192.168.0.1:81 name=port81
>>
>> acl port80_acl myportname port80
>> acl port81_acl myportname port81
>> acl bypass_parent dstdom_regex "/etc/squid/bypass_parent.txt"
>> acl domain_blacklist dstdomain "/etc/squid/domain_blacklist.txt"
>>
>> http_access deny all domain_blacklist always_direct allow
>> bypass_parent never_direct allow port80_acl never_direct allow
>> port81_acl
>>
>> cache_peer proxy1.domain.com parent 80 0 default name=proxy80
>> cache_peer_access proxy80 allow port80_acl cache_peer_access proxy80
>> deny all
>>
>> cache_peer proxy2.domain.com parent 80 0 default name=proxy81
>> cache_peer_access proxy81 allow port81_acl cache_peer_access proxy81
>> deny all
>>
>> http_access allow all
>>
>> logformat squid [%tl] %>a %>eui %Ss/%03>Hs %<st %rm %ru %[un %Sh/%<a
>> %mt _______________________________________________
>> squid-users mailing list
>> squid-users at lists.squid-cache.org
>> https://urldefense.com/v3/__https://lists.squid-cache.org/listinfo/sq
>> u
>> id-users__;!!MvWE!FEDTJs2pTa3njy74FPFejy1UEla67Tsxo5KMiUxhSdHn4--dUL_
>> t kUqmWCJ64l_RHB9_uSLhEWcTeWWRcO7R6E68TUQsCFE6$
>
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> https://urldefense.com/v3/__https://lists.squid-cache.org/listinfo/squ
> id-users__;!!MvWE!FEDTJs2pTa3njy74FPFejy1UEla67Tsxo5KMiUxhSdHn4--dUL_t
> kUqmWCJ64l_RHB9_uSLhEWcTeWWRcO7R6E68TUQsCFE6$


From gaven.l.henderson at rtx.com  Thu Dec 14 01:30:01 2023
From: gaven.l.henderson at rtx.com (HENDERSON, GAVEN L     RTX)
Date: Thu, 14 Dec 2023 01:30:01 +0000
Subject: [squid-users] [External] Re:  Cache_peer breaks Squid 5.5
In-Reply-To: <CY1P110MB06133C066724793DDAFB1720BE8DA@CY1P110MB0613.NAMP110.PROD.OUTLOOK.COM>
References: <CY1P110MB06136FC6BBA99151D804EDBCBE8EA@CY1P110MB0613.NAMP110.PROD.OUTLOOK.COM>
 <CY1P110MB06130E73C6AAE349A6429545BE8EA@CY1P110MB0613.NAMP110.PROD.OUTLOOK.COM>
 <b797ee71-7131-4940-bd93-76f0da0ed88f@measurement-factory.com>
 <CY1P110MB061318CD0F41FAE296842EDCBE8DA@CY1P110MB0613.NAMP110.PROD.OUTLOOK.COM>
 <1fff05ec-930b-48c4-9ea9-6b8afad92d2b@measurement-factory.com>
 <CY1P110MB06133C066724793DDAFB1720BE8DA@CY1P110MB0613.NAMP110.PROD.OUTLOOK.COM>
Message-ID: <CY1P110MB0613F28F19B8038AED10165BBE8CA@CY1P110MB0613.NAMP110.PROD.OUTLOOK.COM>

Old Good:
Name        : squid
Epoch       : 7
Version     : 5.5
Release     : 6.el9_3.1.0.1
Architecture: x86_64
Source RPM  : squid-5.5-6.el9_3.1.0.1.src.rpm
Build Date  : Fri 10 Nov 2023 11:47:19 PM EST

New Bad:
Name        : squid
Epoch       : 7
Version     : 5.5
Release     : 6.el9_3.2
Architecture: x86_64
Source RPM  : squid-5.5-6.el9_3.2.src.rpm
Build Date  : Wed 22 Nov 2023 05:13:20 PM EST


-----Original Message-----
From: HENDERSON, GAVEN L RTX
Sent: Wednesday, December 13, 2023 11:04 AM
To: squid-users at lists.squid-cache.org
Subject: RE: [External] Re: [squid-users] Cache_peer breaks Squid 5.5

Thanks for all the information.  I primarially deal with Windows so I'm dealing with a bit of a learning curve here.  Any suggestions on how to install Squid 6 on Rocky 9?  Can I do that with dnf/yum from a repo or an RPM?  I'm really hoping there's a way to do that without compiling.

-----Original Message-----
From: Alex Rousskov <rousskov at measurement-factory.com>
Sent: Wednesday, December 13, 2023 8:31 AM
To: HENDERSON, GAVEN L RTX <gaven.l.henderson at rtx.com>; squid-users at lists.squid-cache.org
Subject: Re: [External] Re: [squid-users] Cache_peer breaks Squid 5.5

On 2023-12-12 21:45, HENDERSON, GAVEN L RTX wrote:

> assertion failed: peer_digest.cc:419: "EX"

... which is one of the following assertions (quoted with their official Squid v5.5 line numbers, none of which is 419):

     412     assert(fetch->pd && receivedData.data);
     416     assert(fetch->buf + fetch->bufofs == receivedData.data);
     421     assert(fetch->bufofs <= SM_PAGE_SIZE);

FWIW, the latest Squid v5 branch code (and future v5.10 if it is released), fixes the bug that resulted in assertions logged as "EX"
instead of the actual assertion text. The same bug is fixed in all v6 releases.

This new bug report might be related:
https://urldefense.com/v3/__https://bugs.squid-cache.org/show_bug.cgi?id=5330__;!!MvWE!GWVUtWGdcsSlCpQnSreaelvBFVUzRBoz315_Hs-MfksgZgo0TW82oiY4HVlajT31-yti6h8AijE4eqKOQEPrRqk0IxEc-t_G$


> Any thoughts on how to fix this on Rocky 9?

Unfortunately, I failed to find good suspects for this v5 bug -- all obvious suspects came after v5.5 was released. However, I do not even know which version you were running before updating to v5.5. Please note that v5 is not officially supported by the Squid Project.


My recommendation is to update to v6.6 or later.


HTH,

Alex.


> -----Original Message-----
> From: squid-users <squid-users-bounces at lists.squid-cache.org> On
> Behalf Of Alex Rousskov
> Sent: Tuesday, December 12, 2023 10:22 AM
> To: squid-users at lists.squid-cache.org
> Subject: [External] Re: [squid-users] Cache_peer breaks Squid 5.5
>
> On 2023-12-12 11:25, HENDERSON, GAVEN L RTX wrote:
>> Sorry if this has already been answered.  I couldn't find anything online regarding the problem I am experiencing.  I have a Squid server acting as a proxy relay.  It listens on two ports and, depending on which port a request comes in, the request is forwarded to a specific upstream proxy.  Everything was working prior to the 5.5 update.  Now, Squid starts but crashes a few seconds later.  I have traced it down to the cache_peer directives.  If I comment them out, the service is stable.  I have also tried the stock configuration with only the cache_peer directive added and it still crashes so I don't think the problem is being triggered by some other part of my configuration.  I'm not seeing anything particularly helpful in the messages log:
>
> What do you see in Squid's cache.log? I would expect a message about Squid hitting an assertion or detecting another catastrophic problem before crashing. If there is nothing in cache.log, consider (enabling core dumps in your OS configuration and) getting a backtrace from the crashed Squid process.
>
>
> HTH,
>
> Alex.
>
>
>
>> Nov 24 15:17:30 svr-squid squid[2259]: Squid Parent: squid-1 process
>> 2290 exited due to signal 6 with status 0 Nov 24 15:17:30 svr-squid
>> squid[2259]: Squid Parent: squid-1 process 2290 will not be restarted
>> for 3600 seconds due to repeated, frequent failures Nov 24 15:17:30 svr-squid squid[2259]: Exiting due to repeated, frequent failures Nov 24 15:17:30 svr-squid systemd[1]: mailto:systemd-coredump at 21-2295-0.service: Deactivated successfully.
>> Nov 24 15:17:30 svr-squid systemd[1]: squid.service: Main process
>> exited, code=exited, status=1/FAILURE Nov 24 15:17:30 svr-squid systemd[1]: squid.service: Failed with result 'exit-code'.
>>
>> Here is my configuration:
>>
>> http_port 192.168.0.1:80 name=port80
>> http_port 192.168.0.1:81 name=port81
>>
>> acl port80_acl myportname port80
>> acl port81_acl myportname port81
>> acl bypass_parent dstdom_regex "/etc/squid/bypass_parent.txt"
>> acl domain_blacklist dstdomain "/etc/squid/domain_blacklist.txt"
>>
>> http_access deny all domain_blacklist always_direct allow
>> bypass_parent never_direct allow port80_acl never_direct allow
>> port81_acl
>>
>> cache_peer proxy1.domain.com parent 80 0 default name=proxy80
>> cache_peer_access proxy80 allow port80_acl cache_peer_access proxy80
>> deny all
>>
>> cache_peer proxy2.domain.com parent 80 0 default name=proxy81
>> cache_peer_access proxy81 allow port81_acl cache_peer_access proxy81
>> deny all
>>
>> http_access allow all
>>
>> logformat squid [%tl] %>a %>eui %Ss/%03>Hs %<st %rm %ru %[un %Sh/%<a
>> %mt _______________________________________________
>> squid-users mailing list
>> squid-users at lists.squid-cache.org
>> https://urldefense.com/v3/__https://lists.squid-cache.org/listinfo/sq
>> u
>> id-users__;!!MvWE!FEDTJs2pTa3njy74FPFejy1UEla67Tsxo5KMiUxhSdHn4--dUL_
>> t kUqmWCJ64l_RHB9_uSLhEWcTeWWRcO7R6E68TUQsCFE6$
>
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> https://urldefense.com/v3/__https://lists.squid-cache.org/listinfo/squ
> id-users__;!!MvWE!FEDTJs2pTa3njy74FPFejy1UEla67Tsxo5KMiUxhSdHn4--dUL_t
> kUqmWCJ64l_RHB9_uSLhEWcTeWWRcO7R6E68TUQsCFE6$


From rousskov at measurement-factory.com  Thu Dec 14 14:33:05 2023
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Thu, 14 Dec 2023 09:33:05 -0500
Subject: [squid-users] [External] Re: Cache_peer breaks Squid 5.5
In-Reply-To: <CY1P110MB0613F28F19B8038AED10165BBE8CA@CY1P110MB0613.NAMP110.PROD.OUTLOOK.COM>
References: <CY1P110MB06136FC6BBA99151D804EDBCBE8EA@CY1P110MB0613.NAMP110.PROD.OUTLOOK.COM>
 <CY1P110MB06130E73C6AAE349A6429545BE8EA@CY1P110MB0613.NAMP110.PROD.OUTLOOK.COM>
 <b797ee71-7131-4940-bd93-76f0da0ed88f@measurement-factory.com>
 <CY1P110MB061318CD0F41FAE296842EDCBE8DA@CY1P110MB0613.NAMP110.PROD.OUTLOOK.COM>
 <1fff05ec-930b-48c4-9ea9-6b8afad92d2b@measurement-factory.com>
 <CY1P110MB06133C066724793DDAFB1720BE8DA@CY1P110MB0613.NAMP110.PROD.OUTLOOK.COM>
 <CY1P110MB0613F28F19B8038AED10165BBE8CA@CY1P110MB0613.NAMP110.PROD.OUTLOOK.COM>
Message-ID: <8646ee00-65e9-4e89-96fa-fd0ea701b2e1@measurement-factory.com>

On 2023-12-13 20:30, HENDERSON, GAVEN L RTX wrote:

 > Old Good: squid-5.5-6.el9_3.1.0.1.src.rpm
 > New Bad:  squid-5.5-6.el9_3.2.src.rpm

It looks like you are using some v5.5-based packages that contain some 
(unknown to me) additional changes on top of official Squid v5.5 
releases. The culprit is likely among those additional changes.

Unfortunately, I currently do not have the time to investigate what 
additional changes are located inside the packages you are using. If you 
do not receive further help from others on this mailing list, consider 
contacting whoever produced those packages (they were not produced by 
the Squid Project).

Alex.


> Old Good:
> Name        : squid
> Epoch       : 7
> Version     : 5.5
> Release     : 6.el9_3.1.0.1
> Architecture: x86_64
> Source RPM  : squid-5.5-6.el9_3.1.0.1.src.rpm
> Build Date  : Fri 10 Nov 2023 11:47:19 PM EST
> 
> New Bad:
> Name        : squid
> Epoch       : 7
> Version     : 5.5
> Release     : 6.el9_3.2
> Architecture: x86_64
> Source RPM  : squid-5.5-6.el9_3.2.src.rpm
> Build Date  : Wed 22 Nov 2023 05:13:20 PM EST
> 
> 
> -----Original Message-----
> From: HENDERSON, GAVEN L RTX
> Sent: Wednesday, December 13, 2023 11:04 AM
> To: squid-users at lists.squid-cache.org
> Subject: RE: [External] Re: [squid-users] Cache_peer breaks Squid 5.5
> 
> Thanks for all the information.  I primarially deal with Windows so I'm dealing with a bit of a learning curve here.  Any suggestions on how to install Squid 6 on Rocky 9?  Can I do that with dnf/yum from a repo or an RPM?  I'm really hoping there's a way to do that without compiling.
> 
> -----Original Message-----
> From: Alex Rousskov <rousskov at measurement-factory.com>
> Sent: Wednesday, December 13, 2023 8:31 AM
> To: HENDERSON, GAVEN L RTX <gaven.l.henderson at rtx.com>; squid-users at lists.squid-cache.org
> Subject: Re: [External] Re: [squid-users] Cache_peer breaks Squid 5.5
> 
> On 2023-12-12 21:45, HENDERSON, GAVEN L RTX wrote:
> 
>> assertion failed: peer_digest.cc:419: "EX"
> 
> ... which is one of the following assertions (quoted with their official Squid v5.5 line numbers, none of which is 419):
> 
>       412     assert(fetch->pd && receivedData.data);
>       416     assert(fetch->buf + fetch->bufofs == receivedData.data);
>       421     assert(fetch->bufofs <= SM_PAGE_SIZE);
> 
> FWIW, the latest Squid v5 branch code (and future v5.10 if it is released), fixes the bug that resulted in assertions logged as "EX"
> instead of the actual assertion text. The same bug is fixed in all v6 releases.
> 
> This new bug report might be related:
> https://urldefense.com/v3/__https://bugs.squid-cache.org/show_bug.cgi?id=5330__;!!MvWE!GWVUtWGdcsSlCpQnSreaelvBFVUzRBoz315_Hs-MfksgZgo0TW82oiY4HVlajT31-yti6h8AijE4eqKOQEPrRqk0IxEc-t_G$
> 
> 
>> Any thoughts on how to fix this on Rocky 9?
> 
> Unfortunately, I failed to find good suspects for this v5 bug -- all obvious suspects came after v5.5 was released. However, I do not even know which version you were running before updating to v5.5. Please note that v5 is not officially supported by the Squid Project.
> 
> 
> My recommendation is to update to v6.6 or later.
> 
> 
> HTH,
> 
> Alex.
> 
> 
>> -----Original Message-----
>> From: squid-users <squid-users-bounces at lists.squid-cache.org> On
>> Behalf Of Alex Rousskov
>> Sent: Tuesday, December 12, 2023 10:22 AM
>> To: squid-users at lists.squid-cache.org
>> Subject: [External] Re: [squid-users] Cache_peer breaks Squid 5.5
>>
>> On 2023-12-12 11:25, HENDERSON, GAVEN L RTX wrote:
>>> Sorry if this has already been answered.  I couldn't find anything online regarding the problem I am experiencing.  I have a Squid server acting as a proxy relay.  It listens on two ports and, depending on which port a request comes in, the request is forwarded to a specific upstream proxy.  Everything was working prior to the 5.5 update.  Now, Squid starts but crashes a few seconds later.  I have traced it down to the cache_peer directives.  If I comment them out, the service is stable.  I have also tried the stock configuration with only the cache_peer directive added and it still crashes so I don't think the problem is being triggered by some other part of my configuration.  I'm not seeing anything particularly helpful in the messages log:
>>
>> What do you see in Squid's cache.log? I would expect a message about Squid hitting an assertion or detecting another catastrophic problem before crashing. If there is nothing in cache.log, consider (enabling core dumps in your OS configuration and) getting a backtrace from the crashed Squid process.
>>
>>
>> HTH,
>>
>> Alex.
>>
>>
>>
>>> Nov 24 15:17:30 svr-squid squid[2259]: Squid Parent: squid-1 process
>>> 2290 exited due to signal 6 with status 0 Nov 24 15:17:30 svr-squid
>>> squid[2259]: Squid Parent: squid-1 process 2290 will not be restarted
>>> for 3600 seconds due to repeated, frequent failures Nov 24 15:17:30 svr-squid squid[2259]: Exiting due to repeated, frequent failures Nov 24 15:17:30 svr-squid systemd[1]: mailto:systemd-coredump at 21-2295-0.service: Deactivated successfully.
>>> Nov 24 15:17:30 svr-squid systemd[1]: squid.service: Main process
>>> exited, code=exited, status=1/FAILURE Nov 24 15:17:30 svr-squid systemd[1]: squid.service: Failed with result 'exit-code'.
>>>
>>> Here is my configuration:
>>>
>>> http_port 192.168.0.1:80 name=port80
>>> http_port 192.168.0.1:81 name=port81
>>>
>>> acl port80_acl myportname port80
>>> acl port81_acl myportname port81
>>> acl bypass_parent dstdom_regex "/etc/squid/bypass_parent.txt"
>>> acl domain_blacklist dstdomain "/etc/squid/domain_blacklist.txt"
>>>
>>> http_access deny all domain_blacklist always_direct allow
>>> bypass_parent never_direct allow port80_acl never_direct allow
>>> port81_acl
>>>
>>> cache_peer proxy1.domain.com parent 80 0 default name=proxy80
>>> cache_peer_access proxy80 allow port80_acl cache_peer_access proxy80
>>> deny all
>>>
>>> cache_peer proxy2.domain.com parent 80 0 default name=proxy81
>>> cache_peer_access proxy81 allow port81_acl cache_peer_access proxy81
>>> deny all
>>>
>>> http_access allow all
>>>
>>> logformat squid [%tl] %>a %>eui %Ss/%03>Hs %<st %rm %ru %[un %Sh/%<a
>>> %mt _______________________________________________
>>> squid-users mailing list
>>> squid-users at lists.squid-cache.org
>>> https://urldefense.com/v3/__https://lists.squid-cache.org/listinfo/sq
>>> u
>>> id-users__;!!MvWE!FEDTJs2pTa3njy74FPFejy1UEla67Tsxo5KMiUxhSdHn4--dUL_
>>> t kUqmWCJ64l_RHB9_uSLhEWcTeWWRcO7R6E68TUQsCFE6$
>>
>> _______________________________________________
>> squid-users mailing list
>> squid-users at lists.squid-cache.org
>> https://urldefense.com/v3/__https://lists.squid-cache.org/listinfo/squ
>> id-users__;!!MvWE!FEDTJs2pTa3njy74FPFejy1UEla67Tsxo5KMiUxhSdHn4--dUL_t
>> kUqmWCJ64l_RHB9_uSLhEWcTeWWRcO7R6E68TUQsCFE6$
> 
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> https://lists.squid-cache.org/listinfo/squid-users



From gaven.l.henderson at rtx.com  Thu Dec 14 14:38:43 2023
From: gaven.l.henderson at rtx.com (HENDERSON, GAVEN L     RTX)
Date: Thu, 14 Dec 2023 14:38:43 +0000
Subject: [squid-users] [External] Re: Cache_peer breaks Squid 5.5
In-Reply-To: <8646ee00-65e9-4e89-96fa-fd0ea701b2e1@measurement-factory.com>
References: <CY1P110MB06136FC6BBA99151D804EDBCBE8EA@CY1P110MB0613.NAMP110.PROD.OUTLOOK.COM>
 <CY1P110MB06130E73C6AAE349A6429545BE8EA@CY1P110MB0613.NAMP110.PROD.OUTLOOK.COM>
 <b797ee71-7131-4940-bd93-76f0da0ed88f@measurement-factory.com>
 <CY1P110MB061318CD0F41FAE296842EDCBE8DA@CY1P110MB0613.NAMP110.PROD.OUTLOOK.COM>
 <1fff05ec-930b-48c4-9ea9-6b8afad92d2b@measurement-factory.com>
 <CY1P110MB06133C066724793DDAFB1720BE8DA@CY1P110MB0613.NAMP110.PROD.OUTLOOK.COM>
 <CY1P110MB0613F28F19B8038AED10165BBE8CA@CY1P110MB0613.NAMP110.PROD.OUTLOOK.COM>
 <8646ee00-65e9-4e89-96fa-fd0ea701b2e1@measurement-factory.com>
Message-ID: <CY1P110MB0613B08AF6F4FE0CA8120205BE8CA@CY1P110MB0613.NAMP110.PROD.OUTLOOK.COM>

Interesting.  It's a stock Rocky 9 install so the packages came from them.  I was able to obtain the RPM for squid-5.5-6.el9_3.5.src.rpm which resolved the problem.  Thanks for all your help.

-----Original Message-----
From: squid-users <squid-users-bounces at lists.squid-cache.org> On Behalf Of Alex Rousskov
Sent: Thursday, December 14, 2023 6:33 AM
To: squid-users at lists.squid-cache.org
Subject: Re: [squid-users] [External] Re: Cache_peer breaks Squid 5.5

On 2023-12-13 20:30, HENDERSON, GAVEN L RTX wrote:

 > Old Good: squid-5.5-6.el9_3.1.0.1.src.rpm  > New Bad:  squid-5.5-6.el9_3.2.src.rpm

It looks like you are using some v5.5-based packages that contain some (unknown to me) additional changes on top of official Squid v5.5 releases. The culprit is likely among those additional changes.

Unfortunately, I currently do not have the time to investigate what additional changes are located inside the packages you are using. If you do not receive further help from others on this mailing list, consider contacting whoever produced those packages (they were not produced by the Squid Project).

Alex.


> Old Good:
> Name        : squid
> Epoch       : 7
> Version     : 5.5
> Release     : 6.el9_3.1.0.1
> Architecture: x86_64
> Source RPM  : squid-5.5-6.el9_3.1.0.1.src.rpm Build Date  : Fri 10 Nov
> 2023 11:47:19 PM EST
>
> New Bad:
> Name        : squid
> Epoch       : 7
> Version     : 5.5
> Release     : 6.el9_3.2
> Architecture: x86_64
> Source RPM  : squid-5.5-6.el9_3.2.src.rpm Build Date  : Wed 22 Nov
> 2023 05:13:20 PM EST
>
>
> -----Original Message-----
> From: HENDERSON, GAVEN L RTX
> Sent: Wednesday, December 13, 2023 11:04 AM
> To: squid-users at lists.squid-cache.org
> Subject: RE: [External] Re: [squid-users] Cache_peer breaks Squid 5.5
>
> Thanks for all the information.  I primarially deal with Windows so I'm dealing with a bit of a learning curve here.  Any suggestions on how to install Squid 6 on Rocky 9?  Can I do that with dnf/yum from a repo or an RPM?  I'm really hoping there's a way to do that without compiling.
>
> -----Original Message-----
> From: Alex Rousskov <rousskov at measurement-factory.com>
> Sent: Wednesday, December 13, 2023 8:31 AM
> To: HENDERSON, GAVEN L RTX <gaven.l.henderson at rtx.com>;
> squid-users at lists.squid-cache.org
> Subject: Re: [External] Re: [squid-users] Cache_peer breaks Squid 5.5
>
> On 2023-12-12 21:45, HENDERSON, GAVEN L RTX wrote:
>
>> assertion failed: peer_digest.cc:419: "EX"
>
> ... which is one of the following assertions (quoted with their official Squid v5.5 line numbers, none of which is 419):
>
>       412     assert(fetch->pd && receivedData.data);
>       416     assert(fetch->buf + fetch->bufofs == receivedData.data);
>       421     assert(fetch->bufofs <= SM_PAGE_SIZE);
>
> FWIW, the latest Squid v5 branch code (and future v5.10 if it is released), fixes the bug that resulted in assertions logged as "EX"
> instead of the actual assertion text. The same bug is fixed in all v6 releases.
>
> This new bug report might be related:
> https://urldefense.com/v3/__https://bugs.squid-cache.org/show_bug.cgi?
> id=5330__;!!MvWE!GWVUtWGdcsSlCpQnSreaelvBFVUzRBoz315_Hs-MfksgZgo0TW82o
> iY4HVlajT31-yti6h8AijE4eqKOQEPrRqk0IxEc-t_G$
>
>
>> Any thoughts on how to fix this on Rocky 9?
>
> Unfortunately, I failed to find good suspects for this v5 bug -- all obvious suspects came after v5.5 was released. However, I do not even know which version you were running before updating to v5.5. Please note that v5 is not officially supported by the Squid Project.
>
>
> My recommendation is to update to v6.6 or later.
>
>
> HTH,
>
> Alex.
>
>
>> -----Original Message-----
>> From: squid-users <squid-users-bounces at lists.squid-cache.org> On
>> Behalf Of Alex Rousskov
>> Sent: Tuesday, December 12, 2023 10:22 AM
>> To: squid-users at lists.squid-cache.org
>> Subject: [External] Re: [squid-users] Cache_peer breaks Squid 5.5
>>
>> On 2023-12-12 11:25, HENDERSON, GAVEN L RTX wrote:
>>> Sorry if this has already been answered.  I couldn't find anything online regarding the problem I am experiencing.  I have a Squid server acting as a proxy relay.  It listens on two ports and, depending on which port a request comes in, the request is forwarded to a specific upstream proxy.  Everything was working prior to the 5.5 update.  Now, Squid starts but crashes a few seconds later.  I have traced it down to the cache_peer directives.  If I comment them out, the service is stable.  I have also tried the stock configuration with only the cache_peer directive added and it still crashes so I don't think the problem is being triggered by some other part of my configuration.  I'm not seeing anything particularly helpful in the messages log:
>>
>> What do you see in Squid's cache.log? I would expect a message about Squid hitting an assertion or detecting another catastrophic problem before crashing. If there is nothing in cache.log, consider (enabling core dumps in your OS configuration and) getting a backtrace from the crashed Squid process.
>>
>>
>> HTH,
>>
>> Alex.
>>
>>
>>
>>> Nov 24 15:17:30 svr-squid squid[2259]: Squid Parent: squid-1 process
>>> 2290 exited due to signal 6 with status 0 Nov 24 15:17:30 svr-squid
>>> squid[2259]: Squid Parent: squid-1 process 2290 will not be
>>> restarted for 3600 seconds due to repeated, frequent failures Nov 24 15:17:30 svr-squid squid[2259]: Exiting due to repeated, frequent failures Nov 24 15:17:30 svr-squid systemd[1]: mailto:systemd-coredump at 21-2295-0.service: Deactivated successfully.
>>> Nov 24 15:17:30 svr-squid systemd[1]: squid.service: Main process
>>> exited, code=exited, status=1/FAILURE Nov 24 15:17:30 svr-squid systemd[1]: squid.service: Failed with result 'exit-code'.
>>>
>>> Here is my configuration:
>>>
>>> http_port 192.168.0.1:80 name=port80 http_port 192.168.0.1:81
>>> name=port81
>>>
>>> acl port80_acl myportname port80
>>> acl port81_acl myportname port81
>>> acl bypass_parent dstdom_regex "/etc/squid/bypass_parent.txt"
>>> acl domain_blacklist dstdomain "/etc/squid/domain_blacklist.txt"
>>>
>>> http_access deny all domain_blacklist always_direct allow
>>> bypass_parent never_direct allow port80_acl never_direct allow
>>> port81_acl
>>>
>>> cache_peer proxy1.domain.com parent 80 0 default name=proxy80
>>> cache_peer_access proxy80 allow port80_acl cache_peer_access proxy80
>>> deny all
>>>
>>> cache_peer proxy2.domain.com parent 80 0 default name=proxy81
>>> cache_peer_access proxy81 allow port81_acl cache_peer_access proxy81
>>> deny all
>>>
>>> http_access allow all
>>>
>>> logformat squid [%tl] %>a %>eui %Ss/%03>Hs %<st %rm %ru %[un %Sh/%<a
>>> %mt _______________________________________________
>>> squid-users mailing list
>>> squid-users at lists.squid-cache.org
>>> https://urldefense.com/v3/__https://lists.squid-cache.org/listinfo/s
>>> q
>>> u
>>> id-users__;!!MvWE!FEDTJs2pTa3njy74FPFejy1UEla67Tsxo5KMiUxhSdHn4--dUL
>>> _ t kUqmWCJ64l_RHB9_uSLhEWcTeWWRcO7R6E68TUQsCFE6$
>>
>> _______________________________________________
>> squid-users mailing list
>> squid-users at lists.squid-cache.org
>> https://urldefense.com/v3/__https://lists.squid-cache.org/listinfo/sq
>> u
>> id-users__;!!MvWE!FEDTJs2pTa3njy74FPFejy1UEla67Tsxo5KMiUxhSdHn4--dUL_
>> t kUqmWCJ64l_RHB9_uSLhEWcTeWWRcO7R6E68TUQsCFE6$
>
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> https://urldefense.com/v3/__https://lists.squid-cache.org/listinfo/squ
> id-users__;!!MvWE!BqLC3KoljPCXUgi60cZ8gdNuW3jB3sFEJz5BSpYDJ8oU9fya7mJQ
> 6KLTMJhMw2Bxrjrn8x9FN5Xpp4Qxsry0gUUCL3peZYw9$

_______________________________________________
squid-users mailing list
squid-users at lists.squid-cache.org
https://urldefense.com/v3/__https://lists.squid-cache.org/listinfo/squid-users__;!!MvWE!BqLC3KoljPCXUgi60cZ8gdNuW3jB3sFEJz5BSpYDJ8oU9fya7mJQ6KLTMJhMw2Bxrjrn8x9FN5Xpp4Qxsry0gUUCL3peZYw9$


From ml at netfence.it  Fri Dec 15 08:54:33 2023
From: ml at netfence.it (Andrea Venturoli)
Date: Fri, 15 Dec 2023 09:54:33 +0100
Subject: [squid-users] Intercepted connections are not bumped [SOLVED]
In-Reply-To: <6ba031f3-ac28-4142-a4de-e23c84b55109@netfence.it>
References: <59683041-f333-4182-9e91-0bc5474abdc1@netfence.it>
 <e1510cf2-92c3-4645-a80f-01e96b5bd9dc@treenet.co.nz>
 <6ba031f3-ac28-4142-a4de-e23c84b55109@netfence.it>
Message-ID: <6b790c8e-628d-465d-9ae5-a66283f2c911@netfence.it>

On 11/27/23 16:59, Andrea Venturoli wrote:

>> That behaviour is why we typically recommend doing "peek" first

Well, I thought this was what I was doing.

As I said I had:
> acl step1 at_step SslBump1
> ssl_bump splice !bumphosts !jails
> ssl_bump splice splicedom
> ssl_bump peek step1
> ssl_bump bump all

and I expected "peek step1" would decide what to do first.



However, it seems the order of directives matters more and I solved with:
> acl step1 at_step SslBump1
> ssl_bump peek step1
> ssl_bump splice !bumphosts !jails
> ssl_bump splice splicedom
> ssl_bump bump all



Both seems to work equally, however, when explicitly using the proxy.

  bye & Thanks
	av.


From anon.amish at gmail.com  Mon Dec 18 14:35:54 2023
From: anon.amish at gmail.com (Amish)
Date: Mon, 18 Dec 2023 20:05:54 +0530
Subject: [squid-users] squid hangs and dies and can not be killed - needs
 system reboot
Message-ID: <9c9c6491-9c3c-46ff-8026-0318fa7af19c@gmail.com>

Hello,

I use Arch Linux and today I updated squid from squid 5.7 to squid 6.6.

After the update from 5.7 to 6.6, squid starts but then reaches Dead 
state in a minute or two.

# ps aux | grep squid
root???????? 601? 0.0? 0.2? 73816 22528 ???????? Ss?? 12:59?? 0:02 
/usr/bin/squid -f /etc/squid/btnet/squid.btnet.conf --foreground -sYC
proxy??????? 604? 0.0? 0.0????? 0???? 0 ???????? D??? 12:59?? 0:03 [squid]
proxy??????? 607? 0.0? 0.0? 11976? 7424 ???????? S??? 12:59?? 0:00 
(security_file_certgen) -s /var/cache/squid/ssl_db -M 4MB
proxy??????? 608? 0.0? 0.0? 11976? 7168 ???????? S??? 12:59?? 0:00 
(security_file_certgen) -s /var/cache/squid/ssl_db -M 4MB
proxy??????? 609? 0.0? 0.0? 11712? 5632 ???????? S??? 12:59?? 0:00 
(security_file_certgen) -s /var/cache/squid/ssl_db -M 4MB
proxy??????? 610? 0.0? 0.0? 11712? 5376 ???????? S??? 12:59?? 0:00 
(security_file_certgen) -s /var/cache/squid/ssl_db -M 4MB
proxy??????? 611? 0.0? 0.0? 11712? 5504 ???????? S??? 12:59?? 0:00 
(security_file_certgen) -s /var/cache/squid/ssl_db -M 4MB
proxy??????? 622? 0.0? 0.0?? 6116? 3200 ???????? S??? 12:59?? 0:00 
(logfile-daemon) /var/log/squid/access.log

And then all requests get stuck. Notice the D (dead) state of squid.

I use multiple ports for multiple purposes. (It all worked fine in squid 
5.7)

Dec 18 12:59:10 mumbai squid[601]: Starting Authentication on port [::]:3128
Dec 18 12:59:10 mumbai squid[601]: Disabling Authentication on port 
[::]:3128 (interception enabled)
Dec 18 12:59:10 mumbai squid[601]: Starting Authentication on port [::]:8081
Dec 18 12:59:10 mumbai squid[601]: Disabling Authentication on port 
[::]:8081 (interception enabled)
Dec 18 12:59:12 mumbai squid[601]: Starting Authentication on port [::]:8082
Dec 18 12:59:12 mumbai squid[601]: Disabling Authentication on port 
[::]:8082 (interception enabled)
Dec 18 12:59:12 mumbai squid[601]: Starting Authentication on port [::]:8083
Dec 18 12:59:12 mumbai squid[601]: Disabling Authentication on port 
[::]:8083 (interception enabled)
Dec 18 12:59:13 mumbai squid[601]: Starting Authentication on port [::]:8084
Dec 18 12:59:13 mumbai squid[601]: Disabling Authentication on port 
[::]:8084 (interception enabled)
Dec 18 12:59:13 mumbai squid[601]: Starting Authentication on port [::]:3136
Dec 18 12:59:13 mumbai squid[601]: Disabling Authentication on port 
[::]:3136 (interception enabled)
Dec 18 12:59:13 mumbai squid[601]: Starting Authentication on port [::]:3137
Dec 18 12:59:13 mumbai squid[601]: Disabling Authentication on port 
[::]:3137 (interception enabled)
...
Dec 18 12:59:29 mumbai squid[604]: Adaptation support is on
Dec 18 12:59:29 mumbai squid[604]: Accepting NAT intercepted HTTP Socket 
connections at conn19 local=[::]:3128 remote=[::] FD 27 flags=41
 ?????????????????????????????????????? listening port: 3128
Dec 18 12:59:29 mumbai squid[604]: Accepting SSL bumped HTTP Socket 
connections at conn21 local=[::]:8080 remote=[::] FD 28 flags=9
 ?????????????????????????????????????? listening port: 8080
Dec 18 12:59:29 mumbai squid[604]: Accepting NAT intercepted SSL bumped 
HTTPS Socket connections at conn23 local=[::]:8081 remote=[::] FD 29 
flags=41
 ?????????????????????????????????????? listening port: 8081
Dec 18 12:59:29 mumbai squid[604]: Accepting SSL bumped HTTP Socket 
connections at conn25 local=[::]:8092 remote=[::] FD 30 flags=9
 ?????????????????????????????????????? listening port: 8092
Dec 18 12:59:29 mumbai systemd[1]: Started Squid Web Proxy Server.
Dec 18 12:59:29 mumbai squid[604]: Accepting SSL bumped HTTP Socket 
connections at conn27 local=[::]:8093 remote=[::] FD 31 flags=9
 ?????????????????????????????????????? listening port: 8093
Dec 18 12:59:29 mumbai squid[604]: Accepting SSL bumped HTTP Socket 
connections at conn29 local=[::]:8094 remote=[::] FD 32 flags=9
 ?????????????????????????????????????? listening port: 8094
Dec 18 12:59:29 mumbai squid[604]: Accepting NAT intercepted SSL bumped 
HTTPS Socket connections at conn31 local=[::]:8082 remote=[::] FD 33 
flags=41
 ?????????????????????????????????????? listening port: 8082
Dec 18 12:59:29 mumbai squid[604]: Accepting NAT intercepted SSL bumped 
HTTPS Socket connections at conn33 local=[::]:8083 remote=[::] FD 34 
flags=41
 ?????????????????????????????????????? listening port: 8083
Dec 18 12:59:29 mumbai squid[604]: Accepting NAT intercepted SSL bumped 
HTTPS Socket connections at conn35 local=[::]:8084 remote=[::] FD 35 
flags=41
 ?????????????????????????????????????? listening port: 8084
Dec 18 12:59:29 mumbai squid[604]: Accepting NAT intercepted HTTP Socket 
connections at conn37 local=[::]:3136 remote=[::] FD 36 flags=41
 ?????????????????????????????????????? listening port: 3136
Dec 18 12:59:29 mumbai squid[604]: Accepting NAT intercepted HTTP Socket 
connections at conn39 local=[::]:3137 remote=[::] FD 37 flags=41
 ?????????????????????????????????????? listening port: 3137

And then following errors came:


Dec 18 12:59:45 mumbai squid[604]: ERROR: failure while accepting a TLS 
connection on conn41 local=192.168.0.1:8080 remote=192.168.0.111:53867 
FD 12 flags=1: SQUID_TLS
_ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
 ?????????????????????????????????????? current master transaction: master53
Dec 18 12:59:45 mumbai squid[604]: ERROR: failure while accepting a TLS 
connection on conn42 local=192.168.0.1:8080 remote=192.168.0.111:53868 
FD 14 flags=1: SQUID_TLS
_ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
 ?????????????????????????????????????? current master transaction: master53
Dec 18 12:59:45 mumbai squid[604]: ERROR: failure while accepting a TLS 
connection on conn43 local=192.168.0.1:8080 remote=192.168.0.111:53869 
FD 16 flags=1: SQUID_TLS
_ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
 ?????????????????????????????????????? current master transaction: master57
Dec 18 12:59:45 mumbai squid[604]: ERROR: failure while accepting a TLS 
connection on conn44 local=192.168.0.1:8080 remote=192.168.0.111:53870 
FD 12 flags=1: SQUID_TLS
_ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
 ?????????????????????????????????????? current master transaction: master57
Dec 18 12:59:56 mumbai squid[604]: ERROR: failure while accepting a TLS 
connection on conn62 local=192.168.0.1:8080 remote=192.168.0.111:53887 
FD 12 flags=1: SQUID_TLS
_ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
 ?????????????????????????????????????? current master transaction: master95
Dec 18 12:59:59 mumbai squid[604]: ERROR: failure while accepting a TLS 
connection on conn64 local=192.168.0.1:8080 remote=192.168.0.111:53888 
FD 12 flags=1: SQUID_TLS
_ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
 ?????????????????????????????????????? current master transaction: master99
Dec 18 13:00:02 mumbai squid[604]: ERROR: failure while accepting a TLS 
connection on conn65 local=192.168.0.1:8080 remote=192.168.0.178:56115 
FD 12 flags=1: SQUID_TLS
_ERR_ACCEPT+TLS_LIB_ERR=A000418+TLS_IO_ERR=1
 ?????????????????????????????????????? current master transaction: master53
Dec 18 13:01:24 mumbai squid[604]: kick abandoning conn199 
local=192.168.0.1:8093 remote=192.168.0.101:52211 FD 52 flags=1
 ?????????????????????????????????????? connection: conn199 
local=192.168.0.1:8093 remote=192.168.0.101:52211 FD 52 flags=1
Dec 18 13:01:45 mumbai squid[604]: ERROR: failure while accepting a TLS 
connection on conn240 local=192.168.0.1:8093 remote=192.168.0.111:53931 
FD 48 flags=1: SQUID_TL
S_ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
 ?????????????????????????????????????? current master transaction: 
master314


After this point there is nothing in systemd journal (via: journalctl -f 
-u squid) and same lines are in cache.log.

Squid got stuck (DEAD state) at 13:01 and right now it 19:26 (6 hours 
passed) and squid is still in dead state.

kill -9 or kill -ALRM or -HUP also does nothing.

So to restart squid - I will need to restart whole system.

I have sslbump directives but it is not really applied.

#NOTE: nosslbump_ips below contains 192.168.0.0/24 (whole LAN) so 
effectively there is no SSL bump after step1.

acl nosslbump_ips src 192.168.0.0/24
ssl_bump splice ssl_step1 nosslbump_ips
ssl_bump peek ssl_step1
ssl_bump splice nosslbump_domains
ssl_bump stare sslbump_domains
ssl_bump splice ssl_step2
ssl_bump bump all


Any idea? If anything changed from 5.7 to 6.6 that may cause this behaviour?

Looking at changelog:

Bug 5256: Intercepting port fails to accept
https://bugs.squid-cache.org/show_bug.cgi?id=5256

Bug 5154: Do not open IPv6 sockets when IPv6 is disabled
https://bugs.squid-cache.org/show_bug.cgi?id=5154

Not sure if above two bug FIXES (in between v5.7 to v6.6) are related to 
my issue.

I ran netstat:

# netstat -ntlp
Active Internet connections (only servers)
Proto Recv-Q Send-Q Local Address?????????? Foreign Address???????? 
State?????? PID/Program name
...
tcp6????? 33????? 0 :::3137 :::*??????????????????? LISTEN????? -
tcp6?????? 0????? 0 :::3136 :::*??????????????????? LISTEN????? -
tcp6?????? 4????? 0 :::3128 :::*??????????????????? LISTEN????? -
tcp6?????? 0????? 0 :::8081 :::*??????????????????? LISTEN????? -
tcp6?????? 0????? 0 :::8080 :::*??????????????????? LISTEN????? -
tcp6?????? 0????? 0 :::8083 :::*??????????????????? LISTEN????? -
tcp6?????? 0????? 0 :::8082 :::*??????????????????? LISTEN????? -
tcp6?????? 0????? 0 :::8084 :::*??????????????????? LISTEN????? -
tcp6??? 4097????? 0 :::8093 :::*??????????????????? LISTEN????? -
tcp6?????? 0????? 0 :::8092 :::*??????????????????? LISTEN????? -
tcp6?????? 0????? 0 :::8094 :::*??????????????????? LISTEN????? -
...

I do not have IPv6 enabled, yet there are 33 and 4097 numbers in Recv-Q 
and also no process/PID owns these ports.

Same IPv4 ports are not shown in use by netstat, so only IPv6 ports 
remain open, that too orphaned!

So what is happening?

Any idea to solve or any workaround?

Thank you,

Amish.



From rousskov at measurement-factory.com  Mon Dec 18 19:44:33 2023
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Mon, 18 Dec 2023 14:44:33 -0500
Subject: [squid-users] squid hangs and dies and can not be killed -
 needs system reboot
In-Reply-To: <9c9c6491-9c3c-46ff-8026-0318fa7af19c@gmail.com>
References: <9c9c6491-9c3c-46ff-8026-0318fa7af19c@gmail.com>
Message-ID: <27d80d95-0a33-4a65-a5d8-bed1fef2b6db@measurement-factory.com>

On 2023-12-18 09:35, Amish wrote:

> I use Arch Linux and today I updated squid from squid 5.7 to squid 6.6.

 > Dec 18 13:01:24 mumbai squid[604]: kick abandoning conn199

I do not know whether the above problem is the primary problem in your 
setup, but it is a red flag. Transactions on the same connection may get 
stuck after that message; it is essentially a Squid bug.

I am not sure at all, but this bug might be related to Bug 5187 
workaround that went into Squid v6.2 (commit c44cfe7): 
https://bugs.squid-cache.org/show_bug.cgi?id=5187

Does Squid accept new TCP connections after it enters what you describe 
as a dead state? For example, does "telnet 127.0.0.1 8080" establishes a 
connection if executed on the same machine as Squid?


 > kill -9 does nothing

Is it possible that you are trying to kill the wrong process? You should 
be killing this process AFAICT:

 > root         601  0.0  0.2  73816 22528 ?        Ss   12:59   0:02
 > /usr/bin/squid -f /etc/squid/btnet/squid.btnet.conf --foreground -sYC

Alex.


> After the update from 5.7 to 6.6, squid starts but then reaches Dead 
> state in a minute or two.
> 
> # ps aux | grep squid
> root???????? 601? 0.0? 0.2? 73816 22528 ???????? Ss?? 12:59?? 0:02 
> /usr/bin/squid -f /etc/squid/btnet/squid.btnet.conf --foreground -sYC
> proxy??????? 604? 0.0? 0.0????? 0???? 0 ???????? D??? 12:59?? 0:03 [squid]
> proxy??????? 607? 0.0? 0.0? 11976? 7424 ???????? S??? 12:59?? 0:00 
> (security_file_certgen) -s /var/cache/squid/ssl_db -M 4MB
> proxy??????? 608? 0.0? 0.0? 11976? 7168 ???????? S??? 12:59?? 0:00 
> (security_file_certgen) -s /var/cache/squid/ssl_db -M 4MB
> proxy??????? 609? 0.0? 0.0? 11712? 5632 ???????? S??? 12:59?? 0:00 
> (security_file_certgen) -s /var/cache/squid/ssl_db -M 4MB
> proxy??????? 610? 0.0? 0.0? 11712? 5376 ???????? S??? 12:59?? 0:00 
> (security_file_certgen) -s /var/cache/squid/ssl_db -M 4MB
> proxy??????? 611? 0.0? 0.0? 11712? 5504 ???????? S??? 12:59?? 0:00 
> (security_file_certgen) -s /var/cache/squid/ssl_db -M 4MB
> proxy??????? 622? 0.0? 0.0?? 6116? 3200 ???????? S??? 12:59?? 0:00 
> (logfile-daemon) /var/log/squid/access.log
> 
> And then all requests get stuck. Notice the D (dead) state of squid.
> 
> I use multiple ports for multiple purposes. (It all worked fine in squid 
> 5.7)
> 
> Dec 18 12:59:10 mumbai squid[601]: Starting Authentication on port 
> [::]:3128
> Dec 18 12:59:10 mumbai squid[601]: Disabling Authentication on port 
> [::]:3128 (interception enabled)
> Dec 18 12:59:10 mumbai squid[601]: Starting Authentication on port 
> [::]:8081
> Dec 18 12:59:10 mumbai squid[601]: Disabling Authentication on port 
> [::]:8081 (interception enabled)
> Dec 18 12:59:12 mumbai squid[601]: Starting Authentication on port 
> [::]:8082
> Dec 18 12:59:12 mumbai squid[601]: Disabling Authentication on port 
> [::]:8082 (interception enabled)
> Dec 18 12:59:12 mumbai squid[601]: Starting Authentication on port 
> [::]:8083
> Dec 18 12:59:12 mumbai squid[601]: Disabling Authentication on port 
> [::]:8083 (interception enabled)
> Dec 18 12:59:13 mumbai squid[601]: Starting Authentication on port 
> [::]:8084
> Dec 18 12:59:13 mumbai squid[601]: Disabling Authentication on port 
> [::]:8084 (interception enabled)
> Dec 18 12:59:13 mumbai squid[601]: Starting Authentication on port 
> [::]:3136
> Dec 18 12:59:13 mumbai squid[601]: Disabling Authentication on port 
> [::]:3136 (interception enabled)
> Dec 18 12:59:13 mumbai squid[601]: Starting Authentication on port 
> [::]:3137
> Dec 18 12:59:13 mumbai squid[601]: Disabling Authentication on port 
> [::]:3137 (interception enabled)
> ...
> Dec 18 12:59:29 mumbai squid[604]: Adaptation support is on
> Dec 18 12:59:29 mumbai squid[604]: Accepting NAT intercepted HTTP Socket 
> connections at conn19 local=[::]:3128 remote=[::] FD 27 flags=41
>  ?????????????????????????????????????? listening port: 3128
> Dec 18 12:59:29 mumbai squid[604]: Accepting SSL bumped HTTP Socket 
> connections at conn21 local=[::]:8080 remote=[::] FD 28 flags=9
>  ?????????????????????????????????????? listening port: 8080
> Dec 18 12:59:29 mumbai squid[604]: Accepting NAT intercepted SSL bumped 
> HTTPS Socket connections at conn23 local=[::]:8081 remote=[::] FD 29 
> flags=41
>  ?????????????????????????????????????? listening port: 8081
> Dec 18 12:59:29 mumbai squid[604]: Accepting SSL bumped HTTP Socket 
> connections at conn25 local=[::]:8092 remote=[::] FD 30 flags=9
>  ?????????????????????????????????????? listening port: 8092
> Dec 18 12:59:29 mumbai systemd[1]: Started Squid Web Proxy Server.
> Dec 18 12:59:29 mumbai squid[604]: Accepting SSL bumped HTTP Socket 
> connections at conn27 local=[::]:8093 remote=[::] FD 31 flags=9
>  ?????????????????????????????????????? listening port: 8093
> Dec 18 12:59:29 mumbai squid[604]: Accepting SSL bumped HTTP Socket 
> connections at conn29 local=[::]:8094 remote=[::] FD 32 flags=9
>  ?????????????????????????????????????? listening port: 8094
> Dec 18 12:59:29 mumbai squid[604]: Accepting NAT intercepted SSL bumped 
> HTTPS Socket connections at conn31 local=[::]:8082 remote=[::] FD 33 
> flags=41
>  ?????????????????????????????????????? listening port: 8082
> Dec 18 12:59:29 mumbai squid[604]: Accepting NAT intercepted SSL bumped 
> HTTPS Socket connections at conn33 local=[::]:8083 remote=[::] FD 34 
> flags=41
>  ?????????????????????????????????????? listening port: 8083
> Dec 18 12:59:29 mumbai squid[604]: Accepting NAT intercepted SSL bumped 
> HTTPS Socket connections at conn35 local=[::]:8084 remote=[::] FD 35 
> flags=41
>  ?????????????????????????????????????? listening port: 8084
> Dec 18 12:59:29 mumbai squid[604]: Accepting NAT intercepted HTTP Socket 
> connections at conn37 local=[::]:3136 remote=[::] FD 36 flags=41
>  ?????????????????????????????????????? listening port: 3136
> Dec 18 12:59:29 mumbai squid[604]: Accepting NAT intercepted HTTP Socket 
> connections at conn39 local=[::]:3137 remote=[::] FD 37 flags=41
>  ?????????????????????????????????????? listening port: 3137
> 
> And then following errors came:
> 
> 
> Dec 18 12:59:45 mumbai squid[604]: ERROR: failure while accepting a TLS 
> connection on conn41 local=192.168.0.1:8080 remote=192.168.0.111:53867 
> FD 12 flags=1: SQUID_TLS
> _ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
>  ?????????????????????????????????????? current master transaction: 
> master53
> Dec 18 12:59:45 mumbai squid[604]: ERROR: failure while accepting a TLS 
> connection on conn42 local=192.168.0.1:8080 remote=192.168.0.111:53868 
> FD 14 flags=1: SQUID_TLS
> _ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
>  ?????????????????????????????????????? current master transaction: 
> master53
> Dec 18 12:59:45 mumbai squid[604]: ERROR: failure while accepting a TLS 
> connection on conn43 local=192.168.0.1:8080 remote=192.168.0.111:53869 
> FD 16 flags=1: SQUID_TLS
> _ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
>  ?????????????????????????????????????? current master transaction: 
> master57
> Dec 18 12:59:45 mumbai squid[604]: ERROR: failure while accepting a TLS 
> connection on conn44 local=192.168.0.1:8080 remote=192.168.0.111:53870 
> FD 12 flags=1: SQUID_TLS
> _ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
>  ?????????????????????????????????????? current master transaction: 
> master57
> Dec 18 12:59:56 mumbai squid[604]: ERROR: failure while accepting a TLS 
> connection on conn62 local=192.168.0.1:8080 remote=192.168.0.111:53887 
> FD 12 flags=1: SQUID_TLS
> _ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
>  ?????????????????????????????????????? current master transaction: 
> master95
> Dec 18 12:59:59 mumbai squid[604]: ERROR: failure while accepting a TLS 
> connection on conn64 local=192.168.0.1:8080 remote=192.168.0.111:53888 
> FD 12 flags=1: SQUID_TLS
> _ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
>  ?????????????????????????????????????? current master transaction: 
> master99
> Dec 18 13:00:02 mumbai squid[604]: ERROR: failure while accepting a TLS 
> connection on conn65 local=192.168.0.1:8080 remote=192.168.0.178:56115 
> FD 12 flags=1: SQUID_TLS
> _ERR_ACCEPT+TLS_LIB_ERR=A000418+TLS_IO_ERR=1
>  ?????????????????????????????????????? current master transaction: 
> master53
> Dec 18 13:01:24 mumbai squid[604]: kick abandoning conn199 
> local=192.168.0.1:8093 remote=192.168.0.101:52211 FD 52 flags=1
>  ?????????????????????????????????????? connection: conn199 
> local=192.168.0.1:8093 remote=192.168.0.101:52211 FD 52 flags=1
> Dec 18 13:01:45 mumbai squid[604]: ERROR: failure while accepting a TLS 
> connection on conn240 local=192.168.0.1:8093 remote=192.168.0.111:53931 
> FD 48 flags=1: SQUID_TL
> S_ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
>  ?????????????????????????????????????? current master transaction: 
> master314
> 
> 
> After this point there is nothing in systemd journal (via: journalctl -f 
> -u squid) and same lines are in cache.log.
> 
> Squid got stuck (DEAD state) at 13:01 and right now it 19:26 (6 hours 
> passed) and squid is still in dead state.
> 
> kill -9 or kill -ALRM or -HUP also does nothing.
> 
> So to restart squid - I will need to restart whole system.
> 
> I have sslbump directives but it is not really applied.
> 
> #NOTE: nosslbump_ips below contains 192.168.0.0/24 (whole LAN) so 
> effectively there is no SSL bump after step1.
> 
> acl nosslbump_ips src 192.168.0.0/24
> ssl_bump splice ssl_step1 nosslbump_ips
> ssl_bump peek ssl_step1
> ssl_bump splice nosslbump_domains
> ssl_bump stare sslbump_domains
> ssl_bump splice ssl_step2
> ssl_bump bump all
> 
> 
> Any idea? If anything changed from 5.7 to 6.6 that may cause this 
> behaviour?
> 
> Looking at changelog:
> 
> Bug 5256: Intercepting port fails to accept
> https://bugs.squid-cache.org/show_bug.cgi?id=5256
> 
> Bug 5154: Do not open IPv6 sockets when IPv6 is disabled
> https://bugs.squid-cache.org/show_bug.cgi?id=5154
> 
> Not sure if above two bug FIXES (in between v5.7 to v6.6) are related to 
> my issue.
> 
> I ran netstat:
> 
> # netstat -ntlp
> Active Internet connections (only servers)
> Proto Recv-Q Send-Q Local Address?????????? Foreign Address State       
> PID/Program name
> ...
> tcp6????? 33????? 0 :::3137 :::*??????????????????? LISTEN????? -
> tcp6?????? 0????? 0 :::3136 :::*??????????????????? LISTEN????? -
> tcp6?????? 4????? 0 :::3128 :::*??????????????????? LISTEN????? -
> tcp6?????? 0????? 0 :::8081 :::*??????????????????? LISTEN????? -
> tcp6?????? 0????? 0 :::8080 :::*??????????????????? LISTEN????? -
> tcp6?????? 0????? 0 :::8083 :::*??????????????????? LISTEN????? -
> tcp6?????? 0????? 0 :::8082 :::*??????????????????? LISTEN????? -
> tcp6?????? 0????? 0 :::8084 :::*??????????????????? LISTEN????? -
> tcp6??? 4097????? 0 :::8093 :::*??????????????????? LISTEN????? -
> tcp6?????? 0????? 0 :::8092 :::*??????????????????? LISTEN????? -
> tcp6?????? 0????? 0 :::8094 :::*??????????????????? LISTEN????? -
> ...
> 
> I do not have IPv6 enabled, yet there are 33 and 4097 numbers in Recv-Q 
> and also no process/PID owns these ports.
> 
> Same IPv4 ports are not shown in use by netstat, so only IPv6 ports 
> remain open, that too orphaned!
> 
> So what is happening?
> 
> Any idea to solve or any workaround?
> 
> Thank you,
> 
> Amish.
> 
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> https://lists.squid-cache.org/listinfo/squid-users



From anon.amish at gmail.com  Tue Dec 19 03:29:38 2023
From: anon.amish at gmail.com (Amish)
Date: Tue, 19 Dec 2023 08:59:38 +0530
Subject: [squid-users] squid hangs and dies and can not be killed -
 needs system reboot
In-Reply-To: <27d80d95-0a33-4a65-a5d8-bed1fef2b6db@measurement-factory.com>
References: <9c9c6491-9c3c-46ff-8026-0318fa7af19c@gmail.com>
 <27d80d95-0a33-4a65-a5d8-bed1fef2b6db@measurement-factory.com>
Message-ID: <d7be2652-18ce-42fc-9156-7c4fcacb3f63@gmail.com>

Hi Alex,

Thank you for replying.

On 19/12/23 01:14, Alex Rousskov wrote:
> On 2023-12-18 09:35, Amish wrote:
>
>> I use Arch Linux and today I updated squid from squid 5.7 to squid 6.6.
>
> > Dec 18 13:01:24 mumbai squid[604]: kick abandoning conn199
>
> I do not know whether the above problem is the primary problem in your 
> setup, but it is a red flag. Transactions on the same connection may 
> get stuck after that message; it is essentially a Squid bug.
>
> I am not sure at all, but this bug might be related to Bug 5187 
> workaround that went into Squid v6.2 (commit c44cfe7): 
> https://bugs.squid-cache.org/show_bug.cgi?id=5187
>
> Does Squid accept new TCP connections after it enters what you 
> describe as a dead state? For example, does "telnet 127.0.0.1 8080" 
> establishes a connection if executed on the same machine as Squid?
>
Yes it establishes connection. But I do not know what to do next. 
Browser showed "Connection timed out" message. But I believe browser's 
also connected but nothing happened afterwards.

>
> > kill -9 does nothing
>
> Is it possible that you are trying to kill the wrong process? You 
> should be killing this process AFAICT:
>
> > root???????? 601? 0.0? 0.2? 73816 22528 ???????? Ss?? 12:59 0:02
> > /usr/bin/squid -f /etc/squid/btnet/squid.btnet.conf --foreground -sYC

I did not clarify but all processes needed SIGKILL and vanished except 
the Dead squid process which still remained.

# systemctl stop squid

Dec 19 08:46:38 mumbai systemd[1]: squid.service: State 'stop-sigterm' 
timed out. Killing.
Dec 19 08:46:38 mumbai systemd[1]: squid.service: Killing process 601 
(squid) with signal SIGKILL.
Dec 19 08:46:38 mumbai systemd[1]: squid.service: Killing process 604 
(squid) with signal SIGKILL.
Dec 19 08:46:38 mumbai systemd[1]: squid.service: Killing process 607 
(security_file_c) with signal SIGKILL.
Dec 19 08:46:38 mumbai systemd[1]: squid.service: Killing process 608 
(security_file_c) with signal SIGKILL.
Dec 19 08:46:38 mumbai systemd[1]: squid.service: Killing process 609 
(security_file_c) with signal SIGKILL.
Dec 19 08:46:38 mumbai systemd[1]: squid.service: Killing process 610 
(security_file_c) with signal SIGKILL.
Dec 19 08:46:38 mumbai systemd[1]: squid.service: Killing process 611 
(security_file_c) with signal SIGKILL.
Dec 19 08:46:38 mumbai systemd[1]: squid.service: Killing process 622 
(log_file_daemon) with signal SIGKILL.
Dec 19 08:46:38 mumbai systemd[1]: squid.service: Main process exited, 
code=killed, status=9/KILL
Dec 19 08:46:38 mumbai systemd[1]: squid.service: Killing process 604 
(squid) with signal SIGKILL.

Waited for 2 minutes for squid to stop then pressed ctrl-c to systemctl 
stop squid command.

As you can see in last line shows that attempt was made to kill DEAD 
process with PID 604.

# ps aux |grep squid
proxy??????? 604? 0.0? 0.0????? 0???? 0 ???????? D??? Dec18?? 0:03 [squid]

Now only DEAD squid process remains.

What next? Should I downgrade to 5.9 and check?

Regards

Amish

> Alex.
>
>
>> After the update from 5.7 to 6.6, squid starts but then reaches Dead 
>> state in a minute or two.
>>
>> # ps aux | grep squid
>> root???????? 601? 0.0? 0.2? 73816 22528 ???????? Ss?? 12:59 0:02 
>> /usr/bin/squid -f /etc/squid/btnet/squid.btnet.conf --foreground -sYC
>> proxy??????? 604? 0.0? 0.0????? 0???? 0 ???????? D??? 12:59 0:03 [squid]
>> proxy??????? 607? 0.0? 0.0? 11976? 7424 ???????? S??? 12:59 0:00 
>> (security_file_certgen) -s /var/cache/squid/ssl_db -M 4MB
>> proxy??????? 608? 0.0? 0.0? 11976? 7168 ???????? S??? 12:59 0:00 
>> (security_file_certgen) -s /var/cache/squid/ssl_db -M 4MB
>> proxy??????? 609? 0.0? 0.0? 11712? 5632 ???????? S??? 12:59 0:00 
>> (security_file_certgen) -s /var/cache/squid/ssl_db -M 4MB
>> proxy??????? 610? 0.0? 0.0? 11712? 5376 ???????? S??? 12:59 0:00 
>> (security_file_certgen) -s /var/cache/squid/ssl_db -M 4MB
>> proxy??????? 611? 0.0? 0.0? 11712? 5504 ???????? S??? 12:59 0:00 
>> (security_file_certgen) -s /var/cache/squid/ssl_db -M 4MB
>> proxy??????? 622? 0.0? 0.0?? 6116? 3200 ???????? S??? 12:59 0:00 
>> (logfile-daemon) /var/log/squid/access.log
>>
>> And then all requests get stuck. Notice the D (dead) state of squid.
>>
>> I use multiple ports for multiple purposes. (It all worked fine in 
>> squid 5.7)
>>
>> Dec 18 12:59:10 mumbai squid[601]: Starting Authentication on port 
>> [::]:3128
>> Dec 18 12:59:10 mumbai squid[601]: Disabling Authentication on port 
>> [::]:3128 (interception enabled)
>> Dec 18 12:59:10 mumbai squid[601]: Starting Authentication on port 
>> [::]:8081
>> Dec 18 12:59:10 mumbai squid[601]: Disabling Authentication on port 
>> [::]:8081 (interception enabled)
>> Dec 18 12:59:12 mumbai squid[601]: Starting Authentication on port 
>> [::]:8082
>> Dec 18 12:59:12 mumbai squid[601]: Disabling Authentication on port 
>> [::]:8082 (interception enabled)
>> Dec 18 12:59:12 mumbai squid[601]: Starting Authentication on port 
>> [::]:8083
>> Dec 18 12:59:12 mumbai squid[601]: Disabling Authentication on port 
>> [::]:8083 (interception enabled)
>> Dec 18 12:59:13 mumbai squid[601]: Starting Authentication on port 
>> [::]:8084
>> Dec 18 12:59:13 mumbai squid[601]: Disabling Authentication on port 
>> [::]:8084 (interception enabled)
>> Dec 18 12:59:13 mumbai squid[601]: Starting Authentication on port 
>> [::]:3136
>> Dec 18 12:59:13 mumbai squid[601]: Disabling Authentication on port 
>> [::]:3136 (interception enabled)
>> Dec 18 12:59:13 mumbai squid[601]: Starting Authentication on port 
>> [::]:3137
>> Dec 18 12:59:13 mumbai squid[601]: Disabling Authentication on port 
>> [::]:3137 (interception enabled)
>> ...
>> Dec 18 12:59:29 mumbai squid[604]: Adaptation support is on
>> Dec 18 12:59:29 mumbai squid[604]: Accepting NAT intercepted HTTP 
>> Socket connections at conn19 local=[::]:3128 remote=[::] FD 27 flags=41
>> ??????????????????????????????????????? listening port: 3128
>> Dec 18 12:59:29 mumbai squid[604]: Accepting SSL bumped HTTP Socket 
>> connections at conn21 local=[::]:8080 remote=[::] FD 28 flags=9
>> ??????????????????????????????????????? listening port: 8080
>> Dec 18 12:59:29 mumbai squid[604]: Accepting NAT intercepted SSL 
>> bumped HTTPS Socket connections at conn23 local=[::]:8081 remote=[::] 
>> FD 29 flags=41
>> ??????????????????????????????????????? listening port: 8081
>> Dec 18 12:59:29 mumbai squid[604]: Accepting SSL bumped HTTP Socket 
>> connections at conn25 local=[::]:8092 remote=[::] FD 30 flags=9
>> ??????????????????????????????????????? listening port: 8092
>> Dec 18 12:59:29 mumbai systemd[1]: Started Squid Web Proxy Server.
>> Dec 18 12:59:29 mumbai squid[604]: Accepting SSL bumped HTTP Socket 
>> connections at conn27 local=[::]:8093 remote=[::] FD 31 flags=9
>> ??????????????????????????????????????? listening port: 8093
>> Dec 18 12:59:29 mumbai squid[604]: Accepting SSL bumped HTTP Socket 
>> connections at conn29 local=[::]:8094 remote=[::] FD 32 flags=9
>> ??????????????????????????????????????? listening port: 8094
>> Dec 18 12:59:29 mumbai squid[604]: Accepting NAT intercepted SSL 
>> bumped HTTPS Socket connections at conn31 local=[::]:8082 remote=[::] 
>> FD 33 flags=41
>> ??????????????????????????????????????? listening port: 8082
>> Dec 18 12:59:29 mumbai squid[604]: Accepting NAT intercepted SSL 
>> bumped HTTPS Socket connections at conn33 local=[::]:8083 remote=[::] 
>> FD 34 flags=41
>> ??????????????????????????????????????? listening port: 8083
>> Dec 18 12:59:29 mumbai squid[604]: Accepting NAT intercepted SSL 
>> bumped HTTPS Socket connections at conn35 local=[::]:8084 remote=[::] 
>> FD 35 flags=41
>> ??????????????????????????????????????? listening port: 8084
>> Dec 18 12:59:29 mumbai squid[604]: Accepting NAT intercepted HTTP 
>> Socket connections at conn37 local=[::]:3136 remote=[::] FD 36 flags=41
>> ??????????????????????????????????????? listening port: 3136
>> Dec 18 12:59:29 mumbai squid[604]: Accepting NAT intercepted HTTP 
>> Socket connections at conn39 local=[::]:3137 remote=[::] FD 37 flags=41
>> ??????????????????????????????????????? listening port: 3137
>>
>> And then following errors came:
>>
>>
>> Dec 18 12:59:45 mumbai squid[604]: ERROR: failure while accepting a 
>> TLS connection on conn41 local=192.168.0.1:8080 
>> remote=192.168.0.111:53867 FD 12 flags=1: SQUID_TLS
>> _ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
>> ??????????????????????????????????????? current master transaction: 
>> master53
>> Dec 18 12:59:45 mumbai squid[604]: ERROR: failure while accepting a 
>> TLS connection on conn42 local=192.168.0.1:8080 
>> remote=192.168.0.111:53868 FD 14 flags=1: SQUID_TLS
>> _ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
>> ??????????????????????????????????????? current master transaction: 
>> master53
>> Dec 18 12:59:45 mumbai squid[604]: ERROR: failure while accepting a 
>> TLS connection on conn43 local=192.168.0.1:8080 
>> remote=192.168.0.111:53869 FD 16 flags=1: SQUID_TLS
>> _ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
>> ??????????????????????????????????????? current master transaction: 
>> master57
>> Dec 18 12:59:45 mumbai squid[604]: ERROR: failure while accepting a 
>> TLS connection on conn44 local=192.168.0.1:8080 
>> remote=192.168.0.111:53870 FD 12 flags=1: SQUID_TLS
>> _ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
>> ??????????????????????????????????????? current master transaction: 
>> master57
>> Dec 18 12:59:56 mumbai squid[604]: ERROR: failure while accepting a 
>> TLS connection on conn62 local=192.168.0.1:8080 
>> remote=192.168.0.111:53887 FD 12 flags=1: SQUID_TLS
>> _ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
>> ??????????????????????????????????????? current master transaction: 
>> master95
>> Dec 18 12:59:59 mumbai squid[604]: ERROR: failure while accepting a 
>> TLS connection on conn64 local=192.168.0.1:8080 
>> remote=192.168.0.111:53888 FD 12 flags=1: SQUID_TLS
>> _ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
>> ??????????????????????????????????????? current master transaction: 
>> master99
>> Dec 18 13:00:02 mumbai squid[604]: ERROR: failure while accepting a 
>> TLS connection on conn65 local=192.168.0.1:8080 
>> remote=192.168.0.178:56115 FD 12 flags=1: SQUID_TLS
>> _ERR_ACCEPT+TLS_LIB_ERR=A000418+TLS_IO_ERR=1
>> ??????????????????????????????????????? current master transaction: 
>> master53
>> Dec 18 13:01:24 mumbai squid[604]: kick abandoning conn199 
>> local=192.168.0.1:8093 remote=192.168.0.101:52211 FD 52 flags=1
>> ??????????????????????????????????????? connection: conn199 
>> local=192.168.0.1:8093 remote=192.168.0.101:52211 FD 52 flags=1
>> Dec 18 13:01:45 mumbai squid[604]: ERROR: failure while accepting a 
>> TLS connection on conn240 local=192.168.0.1:8093 
>> remote=192.168.0.111:53931 FD 48 flags=1: SQUID_TL
>> S_ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
>> ??????????????????????????????????????? current master transaction: 
>> master314
>>
>>
>> After this point there is nothing in systemd journal (via: journalctl 
>> -f -u squid) and same lines are in cache.log.
>>
>> Squid got stuck (DEAD state) at 13:01 and right now it 19:26 (6 hours 
>> passed) and squid is still in dead state.
>>
>> kill -9 or kill -ALRM or -HUP also does nothing.
>>
>> So to restart squid - I will need to restart whole system.
>>
>> I have sslbump directives but it is not really applied.
>>
>> #NOTE: nosslbump_ips below contains 192.168.0.0/24 (whole LAN) so 
>> effectively there is no SSL bump after step1.
>>
>> acl nosslbump_ips src 192.168.0.0/24
>> ssl_bump splice ssl_step1 nosslbump_ips
>> ssl_bump peek ssl_step1
>> ssl_bump splice nosslbump_domains
>> ssl_bump stare sslbump_domains
>> ssl_bump splice ssl_step2
>> ssl_bump bump all
>>
>>
>> Any idea? If anything changed from 5.7 to 6.6 that may cause this 
>> behaviour?
>>
>> Looking at changelog:
>>
>> Bug 5256: Intercepting port fails to accept
>> https://bugs.squid-cache.org/show_bug.cgi?id=5256
>>
>> Bug 5154: Do not open IPv6 sockets when IPv6 is disabled
>> https://bugs.squid-cache.org/show_bug.cgi?id=5154
>>
>> Not sure if above two bug FIXES (in between v5.7 to v6.6) are related 
>> to my issue.
>>
>> I ran netstat:
>>
>> # netstat -ntlp
>> Active Internet connections (only servers)
>> Proto Recv-Q Send-Q Local Address?????????? Foreign Address 
>> State?????? PID/Program name
>> ...
>> tcp6????? 33????? 0 :::3137 :::*??????????????????? LISTEN -
>> tcp6?????? 0????? 0 :::3136 :::*??????????????????? LISTEN -
>> tcp6?????? 4????? 0 :::3128 :::*??????????????????? LISTEN -
>> tcp6?????? 0????? 0 :::8081 :::*??????????????????? LISTEN -
>> tcp6?????? 0????? 0 :::8080 :::*??????????????????? LISTEN -
>> tcp6?????? 0????? 0 :::8083 :::*??????????????????? LISTEN -
>> tcp6?????? 0????? 0 :::8082 :::*??????????????????? LISTEN -
>> tcp6?????? 0????? 0 :::8084 :::*??????????????????? LISTEN -
>> tcp6??? 4097????? 0 :::8093 :::*??????????????????? LISTEN -
>> tcp6?????? 0????? 0 :::8092 :::*??????????????????? LISTEN -
>> tcp6?????? 0????? 0 :::8094 :::*??????????????????? LISTEN -
>> ...
>>
>> I do not have IPv6 enabled, yet there are 33 and 4097 numbers in 
>> Recv-Q and also no process/PID owns these ports.
>>
>> Same IPv4 ports are not shown in use by netstat, so only IPv6 ports 
>> remain open, that too orphaned!
>>
>> So what is happening?
>>
>> Any idea to solve or any workaround?
>>
>> Thank you,
>>
>> Amish.


From ngtech1ltd at gmail.com  Tue Dec 19 04:21:30 2023
From: ngtech1ltd at gmail.com (NgTech LTD)
Date: Tue, 19 Dec 2023 06:21:30 +0200
Subject: [squid-users] squid hangs and dies and can not be killed -
 needs system reboot
In-Reply-To: <9c9c6491-9c3c-46ff-8026-0318fa7af19c@gmail.com>
References: <9c9c6491-9c3c-46ff-8026-0318fa7af19c@gmail.com>
Message-ID: <CABA8h=ScgEWyKGS3rVoB_k_VGVMc2aaQp9CH24dNcCg_RLThmA@mail.gmail.com>

Hey Amish,

I want to replicate this issue on a local vm.
Can you give us some details on the version of arch and the relevant
settings for recreating the issue?
How did you installed arch and also squid?

Thanks,
Eliezer

?????? ??? ??, 18 ????? 2023, 16:36, ??? Amish ?<anon.amish at gmail.com>:

> Hello,
>
> I use Arch Linux and today I updated squid from squid 5.7 to squid 6.6.
>
> After the update from 5.7 to 6.6, squid starts but then reaches Dead
> state in a minute or two.
>
> # ps aux | grep squid
> root         601  0.0  0.2  73816 22528 ?        Ss   12:59   0:02
> /usr/bin/squid -f /etc/squid/btnet/squid.btnet.conf --foreground -sYC
> proxy        604  0.0  0.0      0     0 ?        D    12:59   0:03 [squid]
> proxy        607  0.0  0.0  11976  7424 ?        S    12:59   0:00
> (security_file_certgen) -s /var/cache/squid/ssl_db -M 4MB
> proxy        608  0.0  0.0  11976  7168 ?        S    12:59   0:00
> (security_file_certgen) -s /var/cache/squid/ssl_db -M 4MB
> proxy        609  0.0  0.0  11712  5632 ?        S    12:59   0:00
> (security_file_certgen) -s /var/cache/squid/ssl_db -M 4MB
> proxy        610  0.0  0.0  11712  5376 ?        S    12:59   0:00
> (security_file_certgen) -s /var/cache/squid/ssl_db -M 4MB
> proxy        611  0.0  0.0  11712  5504 ?        S    12:59   0:00
> (security_file_certgen) -s /var/cache/squid/ssl_db -M 4MB
> proxy        622  0.0  0.0   6116  3200 ?        S    12:59   0:00
> (logfile-daemon) /var/log/squid/access.log
>
> And then all requests get stuck. Notice the D (dead) state of squid.
>
> I use multiple ports for multiple purposes. (It all worked fine in squid
> 5.7)
>
> Dec 18 12:59:10 mumbai squid[601]: Starting Authentication on port
> [::]:3128
> Dec 18 12:59:10 mumbai squid[601]: Disabling Authentication on port
> [::]:3128 (interception enabled)
> Dec 18 12:59:10 mumbai squid[601]: Starting Authentication on port
> [::]:8081
> Dec 18 12:59:10 mumbai squid[601]: Disabling Authentication on port
> [::]:8081 (interception enabled)
> Dec 18 12:59:12 mumbai squid[601]: Starting Authentication on port
> [::]:8082
> Dec 18 12:59:12 mumbai squid[601]: Disabling Authentication on port
> [::]:8082 (interception enabled)
> Dec 18 12:59:12 mumbai squid[601]: Starting Authentication on port
> [::]:8083
> Dec 18 12:59:12 mumbai squid[601]: Disabling Authentication on port
> [::]:8083 (interception enabled)
> Dec 18 12:59:13 mumbai squid[601]: Starting Authentication on port
> [::]:8084
> Dec 18 12:59:13 mumbai squid[601]: Disabling Authentication on port
> [::]:8084 (interception enabled)
> Dec 18 12:59:13 mumbai squid[601]: Starting Authentication on port
> [::]:3136
> Dec 18 12:59:13 mumbai squid[601]: Disabling Authentication on port
> [::]:3136 (interception enabled)
> Dec 18 12:59:13 mumbai squid[601]: Starting Authentication on port
> [::]:3137
> Dec 18 12:59:13 mumbai squid[601]: Disabling Authentication on port
> [::]:3137 (interception enabled)
> ...
> Dec 18 12:59:29 mumbai squid[604]: Adaptation support is on
> Dec 18 12:59:29 mumbai squid[604]: Accepting NAT intercepted HTTP Socket
> connections at conn19 local=[::]:3128 remote=[::] FD 27 flags=41
>                                         listening port: 3128
> Dec 18 12:59:29 mumbai squid[604]: Accepting SSL bumped HTTP Socket
> connections at conn21 local=[::]:8080 remote=[::] FD 28 flags=9
>                                         listening port: 8080
> Dec 18 12:59:29 mumbai squid[604]: Accepting NAT intercepted SSL bumped
> HTTPS Socket connections at conn23 local=[::]:8081 remote=[::] FD 29
> flags=41
>                                         listening port: 8081
> Dec 18 12:59:29 mumbai squid[604]: Accepting SSL bumped HTTP Socket
> connections at conn25 local=[::]:8092 remote=[::] FD 30 flags=9
>                                         listening port: 8092
> Dec 18 12:59:29 mumbai systemd[1]: Started Squid Web Proxy Server.
> Dec 18 12:59:29 mumbai squid[604]: Accepting SSL bumped HTTP Socket
> connections at conn27 local=[::]:8093 remote=[::] FD 31 flags=9
>                                         listening port: 8093
> Dec 18 12:59:29 mumbai squid[604]: Accepting SSL bumped HTTP Socket
> connections at conn29 local=[::]:8094 remote=[::] FD 32 flags=9
>                                         listening port: 8094
> Dec 18 12:59:29 mumbai squid[604]: Accepting NAT intercepted SSL bumped
> HTTPS Socket connections at conn31 local=[::]:8082 remote=[::] FD 33
> flags=41
>                                         listening port: 8082
> Dec 18 12:59:29 mumbai squid[604]: Accepting NAT intercepted SSL bumped
> HTTPS Socket connections at conn33 local=[::]:8083 remote=[::] FD 34
> flags=41
>                                         listening port: 8083
> Dec 18 12:59:29 mumbai squid[604]: Accepting NAT intercepted SSL bumped
> HTTPS Socket connections at conn35 local=[::]:8084 remote=[::] FD 35
> flags=41
>                                         listening port: 8084
> Dec 18 12:59:29 mumbai squid[604]: Accepting NAT intercepted HTTP Socket
> connections at conn37 local=[::]:3136 remote=[::] FD 36 flags=41
>                                         listening port: 3136
> Dec 18 12:59:29 mumbai squid[604]: Accepting NAT intercepted HTTP Socket
> connections at conn39 local=[::]:3137 remote=[::] FD 37 flags=41
>                                         listening port: 3137
>
> And then following errors came:
>
>
> Dec 18 12:59:45 mumbai squid[604]: ERROR: failure while accepting a TLS
> connection on conn41 local=192.168.0.1:8080 remote=192.168.0.111:53867
> FD 12 flags=1: SQUID_TLS
> _ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
>                                         current master transaction:
> master53
> Dec 18 12:59:45 mumbai squid[604]: ERROR: failure while accepting a TLS
> connection on conn42 local=192.168.0.1:8080 remote=192.168.0.111:53868
> FD 14 flags=1: SQUID_TLS
> _ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
>                                         current master transaction:
> master53
> Dec 18 12:59:45 mumbai squid[604]: ERROR: failure while accepting a TLS
> connection on conn43 local=192.168.0.1:8080 remote=192.168.0.111:53869
> FD 16 flags=1: SQUID_TLS
> _ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
>                                         current master transaction:
> master57
> Dec 18 12:59:45 mumbai squid[604]: ERROR: failure while accepting a TLS
> connection on conn44 local=192.168.0.1:8080 remote=192.168.0.111:53870
> FD 12 flags=1: SQUID_TLS
> _ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
>                                         current master transaction:
> master57
> Dec 18 12:59:56 mumbai squid[604]: ERROR: failure while accepting a TLS
> connection on conn62 local=192.168.0.1:8080 remote=192.168.0.111:53887
> FD 12 flags=1: SQUID_TLS
> _ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
>                                         current master transaction:
> master95
> Dec 18 12:59:59 mumbai squid[604]: ERROR: failure while accepting a TLS
> connection on conn64 local=192.168.0.1:8080 remote=192.168.0.111:53888
> FD 12 flags=1: SQUID_TLS
> _ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
>                                         current master transaction:
> master99
> Dec 18 13:00:02 mumbai squid[604]: ERROR: failure while accepting a TLS
> connection on conn65 local=192.168.0.1:8080 remote=192.168.0.178:56115
> FD 12 flags=1: SQUID_TLS
> _ERR_ACCEPT+TLS_LIB_ERR=A000418+TLS_IO_ERR=1
>                                         current master transaction:
> master53
> Dec 18 13:01:24 mumbai squid[604]: kick abandoning conn199
> local=192.168.0.1:8093 remote=192.168.0.101:52211 FD 52 flags=1
>                                         connection: conn199
> local=192.168.0.1:8093 remote=192.168.0.101:52211 FD 52 flags=1
> Dec 18 13:01:45 mumbai squid[604]: ERROR: failure while accepting a TLS
> connection on conn240 local=192.168.0.1:8093 remote=192.168.0.111:53931
> FD 48 flags=1: SQUID_TL
> S_ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
>                                         current master transaction:
> master314
>
>
> After this point there is nothing in systemd journal (via: journalctl -f
> -u squid) and same lines are in cache.log.
>
> Squid got stuck (DEAD state) at 13:01 and right now it 19:26 (6 hours
> passed) and squid is still in dead state.
>
> kill -9 or kill -ALRM or -HUP also does nothing.
>
> So to restart squid - I will need to restart whole system.
>
> I have sslbump directives but it is not really applied.
>
> #NOTE: nosslbump_ips below contains 192.168.0.0/24 (whole LAN) so
> effectively there is no SSL bump after step1.
>
> acl nosslbump_ips src 192.168.0.0/24
> ssl_bump splice ssl_step1 nosslbump_ips
> ssl_bump peek ssl_step1
> ssl_bump splice nosslbump_domains
> ssl_bump stare sslbump_domains
> ssl_bump splice ssl_step2
> ssl_bump bump all
>
>
> Any idea? If anything changed from 5.7 to 6.6 that may cause this
> behaviour?
>
> Looking at changelog:
>
> Bug 5256: Intercepting port fails to accept
> https://bugs.squid-cache.org/show_bug.cgi?id=5256
>
> Bug 5154: Do not open IPv6 sockets when IPv6 is disabled
> https://bugs.squid-cache.org/show_bug.cgi?id=5154
>
> Not sure if above two bug FIXES (in between v5.7 to v6.6) are related to
> my issue.
>
> I ran netstat:
>
> # netstat -ntlp
> Active Internet connections (only servers)
> Proto Recv-Q Send-Q Local Address           Foreign Address
> State       PID/Program name
> ...
> tcp6      33      0 :::3137 :::*                    LISTEN      -
> tcp6       0      0 :::3136 :::*                    LISTEN      -
> tcp6       4      0 :::3128 :::*                    LISTEN      -
> tcp6       0      0 :::8081 :::*                    LISTEN      -
> tcp6       0      0 :::8080 :::*                    LISTEN      -
> tcp6       0      0 :::8083 :::*                    LISTEN      -
> tcp6       0      0 :::8082 :::*                    LISTEN      -
> tcp6       0      0 :::8084 :::*                    LISTEN      -
> tcp6    4097      0 :::8093 :::*                    LISTEN      -
> tcp6       0      0 :::8092 :::*                    LISTEN      -
> tcp6       0      0 :::8094 :::*                    LISTEN      -
> ...
>
> I do not have IPv6 enabled, yet there are 33 and 4097 numbers in Recv-Q
> and also no process/PID owns these ports.
>
> Same IPv4 ports are not shown in use by netstat, so only IPv6 ports
> remain open, that too orphaned!
>
> So what is happening?
>
> Any idea to solve or any workaround?
>
> Thank you,
>
> Amish.
>
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> https://lists.squid-cache.org/listinfo/squid-users
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20231219/1e3b14d2/attachment.htm>

From squid3 at treenet.co.nz  Tue Dec 19 14:55:48 2023
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Wed, 20 Dec 2023 03:55:48 +1300
Subject: [squid-users] squid hangs and dies and can not be killed -
 needs system reboot
In-Reply-To: <d7be2652-18ce-42fc-9156-7c4fcacb3f63@gmail.com>
References: <9c9c6491-9c3c-46ff-8026-0318fa7af19c@gmail.com>
 <27d80d95-0a33-4a65-a5d8-bed1fef2b6db@measurement-factory.com>
 <d7be2652-18ce-42fc-9156-7c4fcacb3f63@gmail.com>
Message-ID: <ab5b4932-086f-4477-b848-c66385c22f0b@treenet.co.nz>


On 19/12/23 16:29, Amish wrote:
> Hi Alex,
> 
> Thank you for replying.
> 
> On 19/12/23 01:14, Alex Rousskov wrote:
>> On 2023-12-18 09:35, Amish wrote:
>>
>>> I use Arch Linux and today I updated squid from squid 5.7 to squid 6.6.
>>
>> > Dec 18 13:01:24 mumbai squid[604]: kick abandoning conn199
>>
>> I do not know whether the above problem is the primary problem in your 
>> setup, but it is a red flag. Transactions on the same connection may 
>> get stuck after that message; it is essentially a Squid bug.
>>
>> I am not sure at all, but this bug might be related to Bug 5187 
>> workaround that went into Squid v6.2 (commit c44cfe7): 
>> https://bugs.squid-cache.org/show_bug.cgi?id=5187
>>
>> Does Squid accept new TCP connections after it enters what you 
>> describe as a dead state? For example, does "telnet 127.0.0.1 8080" 
>> establishes a connection if executed on the same machine as Squid?
>>
> Yes it establishes connection. But I do not know what to do next. 
> Browser showed "Connection timed out" message. But I believe browser's 
> also connected but nothing happened afterwards.
> 

Ah ... that port is an interception port. It should *not* connect.

Please ensure your firewall contains the "-t mangle" rules for each 
interception port you use. As shown at 
<https://wiki.squid-cache.org/ConfigExamples/Intercept/LinuxDnat>


>>
>> > kill -9 does nothing
>>
>> Is it possible that you are trying to kill the wrong process? You 
>> should be killing this process AFAICT:
>>
>> > root???????? 601? 0.0? 0.2? 73816 22528 ???????? Ss?? 12:59 0:02
>> > /usr/bin/squid -f /etc/squid/btnet/squid.btnet.conf --foreground -sYC
> 
> I did not clarify but all processes needed SIGKILL and vanished except 
> the Dead squid process which still remained.
> 
> # systemctl stop squid
> 
> Dec 19 08:46:38 mumbai systemd[1]: squid.service: State 'stop-sigterm' 
> timed out. Killing.


FWIW, Squid default shutdown grace period for clients to disconnect is 
longer that systemd typically is willing to wait for a service shutdown.

Please set "shutdown_lifetime 10 seconds" in your squid.conf.


> Dec 19 08:46:38 mumbai systemd[1]: squid.service: Killing process 601 
> (squid) with signal SIGKILL.
> Dec 19 08:46:38 mumbai systemd[1]: squid.service: Killing process 604 
> (squid) with signal SIGKILL.

This is systemd running the command " kill -9 604 ".

Per the Squid code: "XXX: In SMP mode, uncatchable SIGKILL only kills 
the master process".

You can try SIGTERM instead, and repeat up to 3 times if the first does 
not close the process.



HTH
Amos


From rousskov at measurement-factory.com  Tue Dec 19 15:16:17 2023
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Tue, 19 Dec 2023 10:16:17 -0500
Subject: [squid-users] squid hangs and dies and can not be killed -
 needs system reboot
In-Reply-To: <d7be2652-18ce-42fc-9156-7c4fcacb3f63@gmail.com>
References: <9c9c6491-9c3c-46ff-8026-0318fa7af19c@gmail.com>
 <27d80d95-0a33-4a65-a5d8-bed1fef2b6db@measurement-factory.com>
 <d7be2652-18ce-42fc-9156-7c4fcacb3f63@gmail.com>
Message-ID: <61d0bb96-9d31-4c67-b071-c99250714dff@measurement-factory.com>

On 2023-12-18 22:29, Amish wrote:
> On 19/12/23 01:14, Alex Rousskov wrote:
>> On 2023-12-18 09:35, Amish wrote:
>>
>>> I use Arch Linux and today I updated squid from squid 5.7 to squid 6.6.
>>
>> > Dec 18 13:01:24 mumbai squid[604]: kick abandoning conn199
>>
>> I do not know whether the above problem is the primary problem in your 
>> setup, but it is a red flag. Transactions on the same connection may 
>> get stuck after that message; it is essentially a Squid bug.
>>
>> I am not sure at all, but this bug might be related to Bug 5187 
>> workaround that went into Squid v6.2 (commit c44cfe7): 
>> https://bugs.squid-cache.org/show_bug.cgi?id=5187
>>
>> Does Squid accept new TCP connections after it enters what you 
>> describe as a dead state? For example, does "telnet 127.0.0.1 8080" 
>> establishes a connection if executed on the same machine as Squid?
>>
> Yes it establishes connection. But I do not know what to do next. 

This tells us that your Squid is still listening for incoming 
connections. Most likely, it is not "dead" but running and just unable 
to make progress with those connections (for yet unknown reasons). That 
information is helpful but not sufficient (for me) to solve the problem 
you are describing.

The next step that I would recommend is to collect debugging information 
from the running process and share a pointer to the corresponding 
compressed cache.log file:

* Ideally, start collection when Squid starts and reproduce the problem 
while collecting full debugging information:
http://wiki.squid-cache.org/SquidFaq/BugReporting#full-debug-output

* If you have to, start collection after Squid is already in bad state 
and just before you use telnet or browser to tickle Squid:
http://wiki.squid-cache.org/SquidFaq/BugReporting#debugging-a-single-transaction

Do not use any secret information (e.g., production certificate keys) 
for these tests (unless you are going to share the logs privately with 
those you trust).

Do not downgrade to v5 for these tests.


HTH,

Alex.


> Browser showed "Connection timed out" message. But I believe browser's 
> also connected but nothing happened afterwards.
> 
>>
>> > kill -9 does nothing
>>
>> Is it possible that you are trying to kill the wrong process? You 
>> should be killing this process AFAICT:
>>
>> > root???????? 601? 0.0? 0.2? 73816 22528 ???????? Ss?? 12:59 0:02
>> > /usr/bin/squid -f /etc/squid/btnet/squid.btnet.conf --foreground -sYC
> 
> I did not clarify but all processes needed SIGKILL and vanished except 
> the Dead squid process which still remained.
> 
> # systemctl stop squid
> 
> Dec 19 08:46:38 mumbai systemd[1]: squid.service: State 'stop-sigterm' 
> timed out. Killing.
> Dec 19 08:46:38 mumbai systemd[1]: squid.service: Killing process 601 
> (squid) with signal SIGKILL.
> Dec 19 08:46:38 mumbai systemd[1]: squid.service: Killing process 604 
> (squid) with signal SIGKILL.
> Dec 19 08:46:38 mumbai systemd[1]: squid.service: Killing process 607 
> (security_file_c) with signal SIGKILL.
> Dec 19 08:46:38 mumbai systemd[1]: squid.service: Killing process 608 
> (security_file_c) with signal SIGKILL.
> Dec 19 08:46:38 mumbai systemd[1]: squid.service: Killing process 609 
> (security_file_c) with signal SIGKILL.
> Dec 19 08:46:38 mumbai systemd[1]: squid.service: Killing process 610 
> (security_file_c) with signal SIGKILL.
> Dec 19 08:46:38 mumbai systemd[1]: squid.service: Killing process 611 
> (security_file_c) with signal SIGKILL.
> Dec 19 08:46:38 mumbai systemd[1]: squid.service: Killing process 622 
> (log_file_daemon) with signal SIGKILL.
> Dec 19 08:46:38 mumbai systemd[1]: squid.service: Main process exited, 
> code=killed, status=9/KILL
> Dec 19 08:46:38 mumbai systemd[1]: squid.service: Killing process 604 
> (squid) with signal SIGKILL.
> 
> Waited for 2 minutes for squid to stop then pressed ctrl-c to systemctl 
> stop squid command.
> 
> As you can see in last line shows that attempt was made to kill DEAD 
> process with PID 604.
> 
> # ps aux |grep squid
> proxy??????? 604? 0.0? 0.0????? 0???? 0 ???????? D??? Dec18?? 0:03 [squid]
> 
> Now only DEAD squid process remains.
> 
> What next? Should I downgrade to 5.9 and check?
> 
> Regards
> 
> Amish
> 
>> Alex.
>>
>>
>>> After the update from 5.7 to 6.6, squid starts but then reaches Dead 
>>> state in a minute or two.
>>>
>>> # ps aux | grep squid
>>> root???????? 601? 0.0? 0.2? 73816 22528 ???????? Ss?? 12:59 0:02 
>>> /usr/bin/squid -f /etc/squid/btnet/squid.btnet.conf --foreground -sYC
>>> proxy??????? 604? 0.0? 0.0????? 0???? 0 ???????? D??? 12:59 0:03 [squid]
>>> proxy??????? 607? 0.0? 0.0? 11976? 7424 ???????? S??? 12:59 0:00 
>>> (security_file_certgen) -s /var/cache/squid/ssl_db -M 4MB
>>> proxy??????? 608? 0.0? 0.0? 11976? 7168 ???????? S??? 12:59 0:00 
>>> (security_file_certgen) -s /var/cache/squid/ssl_db -M 4MB
>>> proxy??????? 609? 0.0? 0.0? 11712? 5632 ???????? S??? 12:59 0:00 
>>> (security_file_certgen) -s /var/cache/squid/ssl_db -M 4MB
>>> proxy??????? 610? 0.0? 0.0? 11712? 5376 ???????? S??? 12:59 0:00 
>>> (security_file_certgen) -s /var/cache/squid/ssl_db -M 4MB
>>> proxy??????? 611? 0.0? 0.0? 11712? 5504 ???????? S??? 12:59 0:00 
>>> (security_file_certgen) -s /var/cache/squid/ssl_db -M 4MB
>>> proxy??????? 622? 0.0? 0.0?? 6116? 3200 ???????? S??? 12:59 0:00 
>>> (logfile-daemon) /var/log/squid/access.log
>>>
>>> And then all requests get stuck. Notice the D (dead) state of squid.
>>>
>>> I use multiple ports for multiple purposes. (It all worked fine in 
>>> squid 5.7)
>>>
>>> Dec 18 12:59:10 mumbai squid[601]: Starting Authentication on port 
>>> [::]:3128
>>> Dec 18 12:59:10 mumbai squid[601]: Disabling Authentication on port 
>>> [::]:3128 (interception enabled)
>>> Dec 18 12:59:10 mumbai squid[601]: Starting Authentication on port 
>>> [::]:8081
>>> Dec 18 12:59:10 mumbai squid[601]: Disabling Authentication on port 
>>> [::]:8081 (interception enabled)
>>> Dec 18 12:59:12 mumbai squid[601]: Starting Authentication on port 
>>> [::]:8082
>>> Dec 18 12:59:12 mumbai squid[601]: Disabling Authentication on port 
>>> [::]:8082 (interception enabled)
>>> Dec 18 12:59:12 mumbai squid[601]: Starting Authentication on port 
>>> [::]:8083
>>> Dec 18 12:59:12 mumbai squid[601]: Disabling Authentication on port 
>>> [::]:8083 (interception enabled)
>>> Dec 18 12:59:13 mumbai squid[601]: Starting Authentication on port 
>>> [::]:8084
>>> Dec 18 12:59:13 mumbai squid[601]: Disabling Authentication on port 
>>> [::]:8084 (interception enabled)
>>> Dec 18 12:59:13 mumbai squid[601]: Starting Authentication on port 
>>> [::]:3136
>>> Dec 18 12:59:13 mumbai squid[601]: Disabling Authentication on port 
>>> [::]:3136 (interception enabled)
>>> Dec 18 12:59:13 mumbai squid[601]: Starting Authentication on port 
>>> [::]:3137
>>> Dec 18 12:59:13 mumbai squid[601]: Disabling Authentication on port 
>>> [::]:3137 (interception enabled)
>>> ...
>>> Dec 18 12:59:29 mumbai squid[604]: Adaptation support is on
>>> Dec 18 12:59:29 mumbai squid[604]: Accepting NAT intercepted HTTP 
>>> Socket connections at conn19 local=[::]:3128 remote=[::] FD 27 flags=41
>>> ??????????????????????????????????????? listening port: 3128
>>> Dec 18 12:59:29 mumbai squid[604]: Accepting SSL bumped HTTP Socket 
>>> connections at conn21 local=[::]:8080 remote=[::] FD 28 flags=9
>>> ??????????????????????????????????????? listening port: 8080
>>> Dec 18 12:59:29 mumbai squid[604]: Accepting NAT intercepted SSL 
>>> bumped HTTPS Socket connections at conn23 local=[::]:8081 remote=[::] 
>>> FD 29 flags=41
>>> ??????????????????????????????????????? listening port: 8081
>>> Dec 18 12:59:29 mumbai squid[604]: Accepting SSL bumped HTTP Socket 
>>> connections at conn25 local=[::]:8092 remote=[::] FD 30 flags=9
>>> ??????????????????????????????????????? listening port: 8092
>>> Dec 18 12:59:29 mumbai systemd[1]: Started Squid Web Proxy Server.
>>> Dec 18 12:59:29 mumbai squid[604]: Accepting SSL bumped HTTP Socket 
>>> connections at conn27 local=[::]:8093 remote=[::] FD 31 flags=9
>>> ??????????????????????????????????????? listening port: 8093
>>> Dec 18 12:59:29 mumbai squid[604]: Accepting SSL bumped HTTP Socket 
>>> connections at conn29 local=[::]:8094 remote=[::] FD 32 flags=9
>>> ??????????????????????????????????????? listening port: 8094
>>> Dec 18 12:59:29 mumbai squid[604]: Accepting NAT intercepted SSL 
>>> bumped HTTPS Socket connections at conn31 local=[::]:8082 remote=[::] 
>>> FD 33 flags=41
>>> ??????????????????????????????????????? listening port: 8082
>>> Dec 18 12:59:29 mumbai squid[604]: Accepting NAT intercepted SSL 
>>> bumped HTTPS Socket connections at conn33 local=[::]:8083 remote=[::] 
>>> FD 34 flags=41
>>> ??????????????????????????????????????? listening port: 8083
>>> Dec 18 12:59:29 mumbai squid[604]: Accepting NAT intercepted SSL 
>>> bumped HTTPS Socket connections at conn35 local=[::]:8084 remote=[::] 
>>> FD 35 flags=41
>>> ??????????????????????????????????????? listening port: 8084
>>> Dec 18 12:59:29 mumbai squid[604]: Accepting NAT intercepted HTTP 
>>> Socket connections at conn37 local=[::]:3136 remote=[::] FD 36 flags=41
>>> ??????????????????????????????????????? listening port: 3136
>>> Dec 18 12:59:29 mumbai squid[604]: Accepting NAT intercepted HTTP 
>>> Socket connections at conn39 local=[::]:3137 remote=[::] FD 37 flags=41
>>> ??????????????????????????????????????? listening port: 3137
>>>
>>> And then following errors came:
>>>
>>>
>>> Dec 18 12:59:45 mumbai squid[604]: ERROR: failure while accepting a 
>>> TLS connection on conn41 local=192.168.0.1:8080 
>>> remote=192.168.0.111:53867 FD 12 flags=1: SQUID_TLS
>>> _ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
>>> ??????????????????????????????????????? current master transaction: 
>>> master53
>>> Dec 18 12:59:45 mumbai squid[604]: ERROR: failure while accepting a 
>>> TLS connection on conn42 local=192.168.0.1:8080 
>>> remote=192.168.0.111:53868 FD 14 flags=1: SQUID_TLS
>>> _ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
>>> ??????????????????????????????????????? current master transaction: 
>>> master53
>>> Dec 18 12:59:45 mumbai squid[604]: ERROR: failure while accepting a 
>>> TLS connection on conn43 local=192.168.0.1:8080 
>>> remote=192.168.0.111:53869 FD 16 flags=1: SQUID_TLS
>>> _ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
>>> ??????????????????????????????????????? current master transaction: 
>>> master57
>>> Dec 18 12:59:45 mumbai squid[604]: ERROR: failure while accepting a 
>>> TLS connection on conn44 local=192.168.0.1:8080 
>>> remote=192.168.0.111:53870 FD 12 flags=1: SQUID_TLS
>>> _ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
>>> ??????????????????????????????????????? current master transaction: 
>>> master57
>>> Dec 18 12:59:56 mumbai squid[604]: ERROR: failure while accepting a 
>>> TLS connection on conn62 local=192.168.0.1:8080 
>>> remote=192.168.0.111:53887 FD 12 flags=1: SQUID_TLS
>>> _ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
>>> ??????????????????????????????????????? current master transaction: 
>>> master95
>>> Dec 18 12:59:59 mumbai squid[604]: ERROR: failure while accepting a 
>>> TLS connection on conn64 local=192.168.0.1:8080 
>>> remote=192.168.0.111:53888 FD 12 flags=1: SQUID_TLS
>>> _ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
>>> ??????????????????????????????????????? current master transaction: 
>>> master99
>>> Dec 18 13:00:02 mumbai squid[604]: ERROR: failure while accepting a 
>>> TLS connection on conn65 local=192.168.0.1:8080 
>>> remote=192.168.0.178:56115 FD 12 flags=1: SQUID_TLS
>>> _ERR_ACCEPT+TLS_LIB_ERR=A000418+TLS_IO_ERR=1
>>> ??????????????????????????????????????? current master transaction: 
>>> master53
>>> Dec 18 13:01:24 mumbai squid[604]: kick abandoning conn199 
>>> local=192.168.0.1:8093 remote=192.168.0.101:52211 FD 52 flags=1
>>> ??????????????????????????????????????? connection: conn199 
>>> local=192.168.0.1:8093 remote=192.168.0.101:52211 FD 52 flags=1
>>> Dec 18 13:01:45 mumbai squid[604]: ERROR: failure while accepting a 
>>> TLS connection on conn240 local=192.168.0.1:8093 
>>> remote=192.168.0.111:53931 FD 48 flags=1: SQUID_TL
>>> S_ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
>>> ??????????????????????????????????????? current master transaction: 
>>> master314
>>>
>>>
>>> After this point there is nothing in systemd journal (via: journalctl 
>>> -f -u squid) and same lines are in cache.log.
>>>
>>> Squid got stuck (DEAD state) at 13:01 and right now it 19:26 (6 hours 
>>> passed) and squid is still in dead state.
>>>
>>> kill -9 or kill -ALRM or -HUP also does nothing.
>>>
>>> So to restart squid - I will need to restart whole system.
>>>
>>> I have sslbump directives but it is not really applied.
>>>
>>> #NOTE: nosslbump_ips below contains 192.168.0.0/24 (whole LAN) so 
>>> effectively there is no SSL bump after step1.
>>>
>>> acl nosslbump_ips src 192.168.0.0/24
>>> ssl_bump splice ssl_step1 nosslbump_ips
>>> ssl_bump peek ssl_step1
>>> ssl_bump splice nosslbump_domains
>>> ssl_bump stare sslbump_domains
>>> ssl_bump splice ssl_step2
>>> ssl_bump bump all
>>>
>>>
>>> Any idea? If anything changed from 5.7 to 6.6 that may cause this 
>>> behaviour?
>>>
>>> Looking at changelog:
>>>
>>> Bug 5256: Intercepting port fails to accept
>>> https://bugs.squid-cache.org/show_bug.cgi?id=5256
>>>
>>> Bug 5154: Do not open IPv6 sockets when IPv6 is disabled
>>> https://bugs.squid-cache.org/show_bug.cgi?id=5154
>>>
>>> Not sure if above two bug FIXES (in between v5.7 to v6.6) are related 
>>> to my issue.
>>>
>>> I ran netstat:
>>>
>>> # netstat -ntlp
>>> Active Internet connections (only servers)
>>> Proto Recv-Q Send-Q Local Address?????????? Foreign Address 
>>> State?????? PID/Program name
>>> ...
>>> tcp6????? 33????? 0 :::3137 :::*??????????????????? LISTEN -
>>> tcp6?????? 0????? 0 :::3136 :::*??????????????????? LISTEN -
>>> tcp6?????? 4????? 0 :::3128 :::*??????????????????? LISTEN -
>>> tcp6?????? 0????? 0 :::8081 :::*??????????????????? LISTEN -
>>> tcp6?????? 0????? 0 :::8080 :::*??????????????????? LISTEN -
>>> tcp6?????? 0????? 0 :::8083 :::*??????????????????? LISTEN -
>>> tcp6?????? 0????? 0 :::8082 :::*??????????????????? LISTEN -
>>> tcp6?????? 0????? 0 :::8084 :::*??????????????????? LISTEN -
>>> tcp6??? 4097????? 0 :::8093 :::*??????????????????? LISTEN -
>>> tcp6?????? 0????? 0 :::8092 :::*??????????????????? LISTEN -
>>> tcp6?????? 0????? 0 :::8094 :::*??????????????????? LISTEN -
>>> ...
>>>
>>> I do not have IPv6 enabled, yet there are 33 and 4097 numbers in 
>>> Recv-Q and also no process/PID owns these ports.
>>>
>>> Same IPv4 ports are not shown in use by netstat, so only IPv6 ports 
>>> remain open, that too orphaned!
>>>
>>> So what is happening?
>>>
>>> Any idea to solve or any workaround?
>>>
>>> Thank you,
>>>
>>> Amish.
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> https://lists.squid-cache.org/listinfo/squid-users



From anon.amish at gmail.com  Wed Dec 20 03:52:10 2023
From: anon.amish at gmail.com (Amish)
Date: Wed, 20 Dec 2023 09:22:10 +0530
Subject: [squid-users] squid hangs and dies and can not be killed -
 needs system reboot
In-Reply-To: <ab5b4932-086f-4477-b848-c66385c22f0b@treenet.co.nz>
References: <9c9c6491-9c3c-46ff-8026-0318fa7af19c@gmail.com>
 <27d80d95-0a33-4a65-a5d8-bed1fef2b6db@measurement-factory.com>
 <d7be2652-18ce-42fc-9156-7c4fcacb3f63@gmail.com>
 <ab5b4932-086f-4477-b848-c66385c22f0b@treenet.co.nz>
Message-ID: <d894dad2-2ba2-4889-8a01-4573bc34df6b@gmail.com>

Hi Amos,

On 19/12/23 20:25, Amos Jeffries wrote:
>
> On 19/12/23 16:29, Amish wrote:
>> Hi Alex,
>>
>> Thank you for replying.
>>
>> On 19/12/23 01:14, Alex Rousskov wrote:
>>> On 2023-12-18 09:35, Amish wrote:
>>>
>>>> I use Arch Linux and today I updated squid from squid 5.7 to squid 
>>>> 6.6.
>>>
>>> > Dec 18 13:01:24 mumbai squid[604]: kick abandoning conn199
>>>
>>> I do not know whether the above problem is the primary problem in 
>>> your setup, but it is a red flag. Transactions on the same 
>>> connection may get stuck after that message; it is essentially a 
>>> Squid bug.
>>>
>>> I am not sure at all, but this bug might be related to Bug 5187 
>>> workaround that went into Squid v6.2 (commit c44cfe7): 
>>> https://bugs.squid-cache.org/show_bug.cgi?id=5187
>>>
>>> Does Squid accept new TCP connections after it enters what you 
>>> describe as a dead state? For example, does "telnet 127.0.0.1 8080" 
>>> establishes a connection if executed on the same machine as Squid?
>>>
>> Yes it establishes connection. But I do not know what to do next. 
>> Browser showed "Connection timed out" message. But I believe 
>> browser's also connected but nothing happened afterwards.
>>
>
> Ah ... that port is an interception port. It should *not* connect.
>
> Please ensure your firewall contains the "-t mangle" rules for each 
> interception port you use. As shown at 
> <https://wiki.squid-cache.org/ConfigExamples/Intercept/LinuxDnat>
>
No, port 8080 is not an interception port. And firewall is fine. 
Everything worked before upgrade to 6.6.

>>> > kill -9 does nothing
>>>
>>> Is it possible that you are trying to kill the wrong process? You 
>>> should be killing this process AFAICT:
>>>
>>> > root???????? 601? 0.0? 0.2? 73816 22528 ???????? Ss 12:59 0:02
>>> > /usr/bin/squid -f /etc/squid/btnet/squid.btnet.conf --foreground -sYC
>>
>> I did not clarify but all processes needed SIGKILL and vanished 
>> except the Dead squid process which still remained.
>>
>> # systemctl stop squid
>>
>> Dec 19 08:46:38 mumbai systemd[1]: squid.service: State 
>> 'stop-sigterm' timed out. Killing.
>
> FWIW, Squid default shutdown grace period for clients to disconnect is 
> longer that systemd typically is willing to wait for a service shutdown.
>
> Please set "shutdown_lifetime 10 seconds" in your squid.conf.
>
Default shutdown_lifetime is 30 seconds.

I think systemd waits 90 seconds.

>
>> Dec 19 08:46:38 mumbai systemd[1]: squid.service: Killing process 601 
>> (squid) with signal SIGKILL.
>> Dec 19 08:46:38 mumbai systemd[1]: squid.service: Killing process 604 
>> (squid) with signal SIGKILL.
>
> This is systemd running the command " kill -9 604 ".
>
> Per the Squid code: "XXX: In SMP mode, uncatchable SIGKILL only kills 
> the master process".
>
> You can try SIGTERM instead, and repeat up to 3 times if the first 
> does not close the process.

kill -9 is supposed to kill the process immediately. But it didnt. 601 
(master process) got killed but 604 did not.

Even when powering off, systemd "finished" shutdown target, unmounted 
partitions and then killed all squid processes but could not kill 
process 604.

After waiting for 2-3 minutes, I forced power off the system and restarted.

Regards,

Amish

>
> HTH
> Amos


From anon.amish at gmail.com  Thu Dec 21 12:10:40 2023
From: anon.amish at gmail.com (Amish)
Date: Thu, 21 Dec 2023 17:40:40 +0530
Subject: [squid-users] squid hangs and dies and can not be killed -
 needs system reboot
In-Reply-To: <61d0bb96-9d31-4c67-b071-c99250714dff@measurement-factory.com>
References: <9c9c6491-9c3c-46ff-8026-0318fa7af19c@gmail.com>
 <27d80d95-0a33-4a65-a5d8-bed1fef2b6db@measurement-factory.com>
 <d7be2652-18ce-42fc-9156-7c4fcacb3f63@gmail.com>
 <61d0bb96-9d31-4c67-b071-c99250714dff@measurement-factory.com>
Message-ID: <add5fbda-db7f-42f2-8225-66a87cc81e12@gmail.com>

Hi Alex,

Sorry for late reply. But this is a production system and hence 
debugging is tough. May take few days.

However I noticed that everytime squid hangs (goes dead), the dmesg has 
these errors.

[63567.802188] divide error: 0000 [#1] PREEMPT SMP PTI
[63567.802215] CPU: 3 PID: 617 Comm: squid Not tainted 6.6.7-arch1-1 #1 
4505c4baa0b3d7c4037b0e8f5402626fa360717f
[63567.802238] Hardware name: Gigabyte Technology Co., Ltd. 
H81M-S/H81M-S, BIOS F2 08/19/2015
[63567.802255] RIP: 0010:tcp_rcv_space_adjust+0xbe/0x160
[63567.802267] Code: f8 41 89 d0 29 d0 31 d2 49 0f af c2 49 f7 f0 45 8b 
81 bc 04 00 00 44 0f b6 8b 10 06 00 00 31 d2 49 8d 04 42 48 98 48 c1 e0 
08 <49> f7 f1 49 63 d0
48 98 48 39 d0 48 0f 47 c2 39 83 18 01 00 00 7c
[63567.802287] RSP: 0018:ffffba9f00da3c18 EFLAGS: 00010206
[63567.802296] RAX: 0000000004fb2800 RBX: ffff9e124acc1c80 RCX: 
0000000eccd9dace
[63567.802304] RDX: 0000000000000000 RSI: 0000000037fa4ae8 RDI: 
0000000000008349
[63567.802314] RBP: ffff9e124acc1c80 R08: 0000000000600000 R09: 
0000000000000000
[63567.802322] R10: 00000000000161d2 R11: ffff9e1346621700 R12: 
0000000000000000
[63567.802331] R13: ffff9e124acc1d58 R14: 0000000000000000 R15: 
ffff9e124acc2214
[63567.802340] FS:? 00007fc3d627c840(0000) GS:ffff9e1457380000(0000) 
knlGS:0000000000000000
[63567.802350] CS:? 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[63567.802358] CR2: 0000560b7e86d690 CR3: 0000000102f44001 CR4: 
00000000001706e0
[63567.802367] Call Trace:
[63567.802372]? <TASK>
[63567.802378]? ? die+0x36/0x90
[63567.802386]? ? do_trap+0xda/0x100
[63567.802392]? ? tcp_rcv_space_adjust+0xbe/0x160
[63567.802401]? ? do_error_trap+0x6a/0x90
[63567.802408]? ? tcp_rcv_space_adjust+0xbe/0x160
[63567.802415]? ? exc_divide_error+0x38/0x50
[63567.802423]? ? tcp_rcv_space_adjust+0xbe/0x160
[63567.802431]? ? asm_exc_divide_error+0x1a/0x20
[63567.802441]? ? tcp_rcv_space_adjust+0xbe/0x160
[63567.802449]? ? tcp_rcv_space_adjust+0x1a/0x160
[63567.802456]? tcp_recvmsg_locked+0x2d4/0x960
[63567.802464]? tcp_recvmsg+0x87/0x1f0
[63567.802471]? inet6_recvmsg+0x56/0x130
[63567.802479]? ? __pfx_bpf_lsm_socket_recvmsg+0x10/0x10
[63567.802488]? ? security_socket_recvmsg+0x44/0x70
[63567.802497]? sock_recvmsg+0x57/0xd0
[63567.802505]? sock_read_iter+0x96/0x100
[63567.802513]? vfs_read+0x303/0x350
[63567.802796]? ksys_read+0xbb/0xf0
[63567.803074]? do_syscall_64+0x60/0x90
[63567.803346]? ? syscall_exit_to_user_mode+0x2b/0x40
[63567.803619]? ? do_syscall_64+0x6c/0x90
[63567.803890]? ? syscall_exit_to_user_mode+0x2b/0x40
[63567.804163]? ? do_syscall_64+0x6c/0x90
[63567.804438]? ? do_syscall_64+0x6c/0x90
[63567.804710]? entry_SYSCALL_64_after_hwframe+0x6e/0xd8
[63567.804984] RIP: 0033:0x7fc3d5f21531
[63567.805271] Code: ff ff eb c3 67 e8 2f c9 01 00 66 2e 0f 1f 84 00 00 
00 00 00 0f 1f 44 00 00 f3 0f 1e fa 80 3d 35 ce 0d 00 00 74 13 31 c0 0f 
05 <48> 3d 00 f0 ff ff
77 57 c3 66 0f 1f 44 00 00 48 83 ec 28 48 89 54
[63567.805909] RSP: 002b:00007fffa66f6748 EFLAGS: 00000246 ORIG_RAX: 
0000000000000000
[63567.806225] RAX: ffffffffffffffda RBX: 00007fffa66f6830 RCX: 
00007fc3d5f21531
[63567.806542] RDX: 000000000000191a RSI: 000055d106003d80 RDI: 
00000000000000bd
[63567.806855] RBP: 000055d10620bc30 R08: 000055d10620bc30 R09: 
000055d1036a8e78
[63567.807163] R10: 000055d1037ad630 R11: 0000000000000246 R12: 
000000000000191a
[63567.807472] R13: 000055d10664f410 R14: 000055d106003d80 R15: 
00007fc3d627c6b8
[63567.807768]? </TASK>
[63567.808037] Modules linked in: nfnetlink_queue nf_conntrack_netlink 
xt_connmark xt_mark ip_set_hash_net xt_NFQUEUE xt_set ip_set_hash_ip 
ip_set cls_fw sch_sfq sch_h
tb nf_nat_ftp nf_conntrack_ftp tls tun cfg80211 rfkill nft_chain_nat 
xt_MASQUERADE xt_nat xt_REDIRECT nf_nat nft_limit xt_limit xt_conntrack 
nf_conntrack nf_defrag_ipv
6 nf_defrag_ipv4 xt_multiport xt_tcpudp nft_compat nf_tables libcrc32c 
intel_rapl_msr intel_rapl_common x86_pkg_temp_thermal intel_powerclamp 
snd_hda_codec_realtek cor
etemp snd_hda_codec_generic ledtrig_audio snd_hda_codec_hdmi kvm_intel 
snd_hda_intel kvm snd_intel_dspcfg snd_intel_sdw_acpi irqbypass 
snd_hda_codec snd_hda_core crct1
0dif_pclmul r8169 crc32_pclmul snd_hwdep polyval_clmulni snd_pcm 
polyval_generic gf128mul snd_timer realtek ax88179_178a spi_nor 
mdio_devres usbnet snd libphy ghash_cl
mulni_intel mtd sha512_ssse3 at24 soundcore mii mei_pxp mei_hdcp 
sha256_ssse3 sha1_ssse3 iTCO_wdt i2c_i801 mei_me spi_intel_platform 
mousedev aesni_intel intel_pmc_bxt
 ?spi_intel iTCO_vendor_support
[63567.808076]? i2c_smbus mei crypto_simd lpc_ich cryptd rapl 
intel_cstate intel_uncore psmouse mac_hid pcspkr pkcs8_key_parser fuse 
dm_mod loop nfnetlink ip_tables x_
tables ext4 crc32c_generic crc16 mbcache jbd2 i915 serio_raw 
i2c_algo_bit atkbd drm_buddy libps2 ttm vivaldi_fmap intel_gtt xhci_pci 
crc32c_intel drm_display_helper xh
ci_pci_renesas cec i8042 video serio wmi
[63567.811333] ---[ end trace 0000000000000000 ]---
[63567.811701] RIP: 0010:tcp_rcv_space_adjust+0xbe/0x160
[63567.812069] Code: f8 41 89 d0 29 d0 31 d2 49 0f af c2 49 f7 f0 45 8b 
81 bc 04 00 00 44 0f b6 8b 10 06 00 00 31 d2 49 8d 04 42 48 98 48 c1 e0 
08 <49> f7 f1 49 63 d0
48 98 48 39 d0 48 0f 47 c2 39 83 18 01 00 00 7c
[63567.812848] RSP: 0018:ffffba9f00da3c18 EFLAGS: 00010206
[63567.813252] RAX: 0000000004fb2800 RBX: ffff9e124acc1c80 RCX: 
0000000eccd9dace
[63567.813651] RDX: 0000000000000000 RSI: 0000000037fa4ae8 RDI: 
0000000000008349
[63567.814064] RBP: ffff9e124acc1c80 R08: 0000000000600000 R09: 
0000000000000000
[63567.814470] R10: 00000000000161d2 R11: ffff9e1346621700 R12: 
0000000000000000
[63567.814879] R13: ffff9e124acc1d58 R14: 0000000000000000 R15: 
ffff9e124acc2214
[63567.815290] FS:? 00007fc3d627c840(0000) GS:ffff9e1457380000(0000) 
knlGS:0000000000000000
[63567.815700] CS:? 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
[63567.816121] CR2: 0000560b7e86d690 CR3: 0000000102f44001 CR4: 
00000000001706e0

After this the "child" squid process can not be killed, even by systemd, 
even by kill -9.

It appears that squid "main" process (owned by root user) does not hang 
and hence connections on port 8080 are accepted.

But squid child process (owned by proxy user) hangs and never recovers 
after above dmesg. And hence nothing happens and connection times out.

# ps aux |grep squid
root???????? 612? 0.0? 0.2? 75500 23680 ???????? Ss?? Dec20?? 0:02 
/usr/bin/squid -f /etc/squid/btnet/squid.btnet.conf --foreground -sYC
proxy??????? 617? 0.0? 0.0????? 0???? 0 ???????? D??? Dec20?? 1:00 [squid]
proxy??????? 620? 0.0? 0.0? 12152? 7552 ???????? S??? Dec20?? 0:00 
(security_file_certgen) -s /var/cache/squid/ssl_db -M 4MB
proxy??????? 621? 0.0? 0.0? 12152? 7552 ???????? S??? Dec20?? 0:00 
(security_file_certgen) -s /var/cache/squid/ssl_db -M 4MB
proxy??????? 622? 0.0? 0.0? 11888? 5504 ???????? S??? Dec20?? 0:00 
(security_file_certgen) -s /var/cache/squid/ssl_db -M 4MB
proxy??????? 623? 0.0? 0.0? 11888? 5632 ???????? S??? Dec20?? 0:00 
(security_file_certgen) -s /var/cache/squid/ssl_db -M 4MB
proxy??????? 624? 0.0? 0.0? 11888? 5632 ???????? S??? Dec20?? 0:00 
(security_file_certgen) -s /var/cache/squid/ssl_db -M 4MB
proxy??????? 643? 0.0? 0.0?? 6116? 3200 ???????? S??? Dec20?? 0:01 
(logfile-daemon) /var/log/squid/access.log

# telnet 127.0.0.1 8080
Trying 127.0.0.1...
Connected to 127.0.0.1.
Escape character is '^]'.
^]
telnet> c

# curl -x 127.0.0.1:8080 --max-time 30 https://google.com
curl: (28) Connection timed out after 30002 milliseconds

# kill 612 617

Ran kill 5 times, nothing happened. All squid processes remained.

# kill -9 612 617

Ran once, and all squid processes except 617 (child squid process) got 
killed

# ps aux |grep squid
proxy??????? 617? 0.0? 0.0????? 0???? 0 ???????? D??? Dec20?? 1:00 [squid]
root?????? 90764? 0.0? 0.0?? 6552? 2560 pts/5??? S+?? 17:36?? 0:00 grep 
--color=auto squid

Can above information be of any help?

Thanks and regards,

Amish

On 19/12/23 20:46, Alex Rousskov wrote:
> On 2023-12-18 22:29, Amish wrote:
>> On 19/12/23 01:14, Alex Rousskov wrote:
>>> On 2023-12-18 09:35, Amish wrote:
>>>
>>>> I use Arch Linux and today I updated squid from squid 5.7 to squid 
>>>> 6.6.
>>>
>>> > Dec 18 13:01:24 mumbai squid[604]: kick abandoning conn199
>>>
>>> I do not know whether the above problem is the primary problem in 
>>> your setup, but it is a red flag. Transactions on the same 
>>> connection may get stuck after that message; it is essentially a 
>>> Squid bug.
>>>
>>> I am not sure at all, but this bug might be related to Bug 5187 
>>> workaround that went into Squid v6.2 (commit c44cfe7): 
>>> https://bugs.squid-cache.org/show_bug.cgi?id=5187
>>>
>>> Does Squid accept new TCP connections after it enters what you 
>>> describe as a dead state? For example, does "telnet 127.0.0.1 8080" 
>>> establishes a connection if executed on the same machine as Squid?
>>>
>> Yes it establishes connection. But I do not know what to do next. 
>
> This tells us that your Squid is still listening for incoming 
> connections. Most likely, it is not "dead" but running and just unable 
> to make progress with those connections (for yet unknown reasons). 
> That information is helpful but not sufficient (for me) to solve the 
> problem you are describing.
>
> The next step that I would recommend is to collect debugging 
> information from the running process and share a pointer to the 
> corresponding compressed cache.log file:
>
> * Ideally, start collection when Squid starts and reproduce the 
> problem while collecting full debugging information:
> http://wiki.squid-cache.org/SquidFaq/BugReporting#full-debug-output
>
> * If you have to, start collection after Squid is already in bad state 
> and just before you use telnet or browser to tickle Squid:
> http://wiki.squid-cache.org/SquidFaq/BugReporting#debugging-a-single-transaction 
>
>
> Do not use any secret information (e.g., production certificate keys) 
> for these tests (unless you are going to share the logs privately with 
> those you trust).
>
> Do not downgrade to v5 for these tests.
>
>
> HTH,
>
> Alex.
>
>
>> Browser showed "Connection timed out" message. But I believe 
>> browser's also connected but nothing happened afterwards.
>>
>>>
>>> > kill -9 does nothing
>>>
>>> Is it possible that you are trying to kill the wrong process? You 
>>> should be killing this process AFAICT:
>>>
>>> > root???????? 601? 0.0? 0.2? 73816 22528 ???????? Ss 12:59 0:02
>>> > /usr/bin/squid -f /etc/squid/btnet/squid.btnet.conf --foreground -sYC
>>
>> I did not clarify but all processes needed SIGKILL and vanished 
>> except the Dead squid process which still remained.
>>
>> # systemctl stop squid
>>
>> Dec 19 08:46:38 mumbai systemd[1]: squid.service: State 
>> 'stop-sigterm' timed out. Killing.
>> Dec 19 08:46:38 mumbai systemd[1]: squid.service: Killing process 601 
>> (squid) with signal SIGKILL.
>> Dec 19 08:46:38 mumbai systemd[1]: squid.service: Killing process 604 
>> (squid) with signal SIGKILL.
>> Dec 19 08:46:38 mumbai systemd[1]: squid.service: Killing process 607 
>> (security_file_c) with signal SIGKILL.
>> Dec 19 08:46:38 mumbai systemd[1]: squid.service: Killing process 608 
>> (security_file_c) with signal SIGKILL.
>> Dec 19 08:46:38 mumbai systemd[1]: squid.service: Killing process 609 
>> (security_file_c) with signal SIGKILL.
>> Dec 19 08:46:38 mumbai systemd[1]: squid.service: Killing process 610 
>> (security_file_c) with signal SIGKILL.
>> Dec 19 08:46:38 mumbai systemd[1]: squid.service: Killing process 611 
>> (security_file_c) with signal SIGKILL.
>> Dec 19 08:46:38 mumbai systemd[1]: squid.service: Killing process 622 
>> (log_file_daemon) with signal SIGKILL.
>> Dec 19 08:46:38 mumbai systemd[1]: squid.service: Main process 
>> exited, code=killed, status=9/KILL
>> Dec 19 08:46:38 mumbai systemd[1]: squid.service: Killing process 604 
>> (squid) with signal SIGKILL.
>>
>> Waited for 2 minutes for squid to stop then pressed ctrl-c to 
>> systemctl stop squid command.
>>
>> As you can see in last line shows that attempt was made to kill DEAD 
>> process with PID 604.
>>
>> # ps aux |grep squid
>> proxy??????? 604? 0.0? 0.0????? 0???? 0 ???????? D??? Dec18 0:03 [squid]
>>
>> Now only DEAD squid process remains.
>>
>> What next? Should I downgrade to 5.9 and check?
>>
>> Regards
>>
>> Amish
>>
>>> Alex.
>>>
>>>
>>>> After the update from 5.7 to 6.6, squid starts but then reaches 
>>>> Dead state in a minute or two.
>>>>
>>>> # ps aux | grep squid
>>>> root???????? 601? 0.0? 0.2? 73816 22528 ???????? Ss?? 12:59 0:02 
>>>> /usr/bin/squid -f /etc/squid/btnet/squid.btnet.conf --foreground -sYC
>>>> proxy??????? 604? 0.0? 0.0????? 0???? 0 ???????? D??? 12:59 0:03 
>>>> [squid]
>>>> proxy??????? 607? 0.0? 0.0? 11976? 7424 ???????? S??? 12:59 0:00 
>>>> (security_file_certgen) -s /var/cache/squid/ssl_db -M 4MB
>>>> proxy??????? 608? 0.0? 0.0? 11976? 7168 ???????? S??? 12:59 0:00 
>>>> (security_file_certgen) -s /var/cache/squid/ssl_db -M 4MB
>>>> proxy??????? 609? 0.0? 0.0? 11712? 5632 ???????? S??? 12:59 0:00 
>>>> (security_file_certgen) -s /var/cache/squid/ssl_db -M 4MB
>>>> proxy??????? 610? 0.0? 0.0? 11712? 5376 ???????? S??? 12:59 0:00 
>>>> (security_file_certgen) -s /var/cache/squid/ssl_db -M 4MB
>>>> proxy??????? 611? 0.0? 0.0? 11712? 5504 ???????? S??? 12:59 0:00 
>>>> (security_file_certgen) -s /var/cache/squid/ssl_db -M 4MB
>>>> proxy??????? 622? 0.0? 0.0?? 6116? 3200 ???????? S??? 12:59 0:00 
>>>> (logfile-daemon) /var/log/squid/access.log
>>>>
>>>> And then all requests get stuck. Notice the D (dead) state of squid.
>>>>
>>>> I use multiple ports for multiple purposes. (It all worked fine in 
>>>> squid 5.7)
>>>>
>>>> Dec 18 12:59:10 mumbai squid[601]: Starting Authentication on port 
>>>> [::]:3128
>>>> Dec 18 12:59:10 mumbai squid[601]: Disabling Authentication on port 
>>>> [::]:3128 (interception enabled)
>>>> Dec 18 12:59:10 mumbai squid[601]: Starting Authentication on port 
>>>> [::]:8081
>>>> Dec 18 12:59:10 mumbai squid[601]: Disabling Authentication on port 
>>>> [::]:8081 (interception enabled)
>>>> Dec 18 12:59:12 mumbai squid[601]: Starting Authentication on port 
>>>> [::]:8082
>>>> Dec 18 12:59:12 mumbai squid[601]: Disabling Authentication on port 
>>>> [::]:8082 (interception enabled)
>>>> Dec 18 12:59:12 mumbai squid[601]: Starting Authentication on port 
>>>> [::]:8083
>>>> Dec 18 12:59:12 mumbai squid[601]: Disabling Authentication on port 
>>>> [::]:8083 (interception enabled)
>>>> Dec 18 12:59:13 mumbai squid[601]: Starting Authentication on port 
>>>> [::]:8084
>>>> Dec 18 12:59:13 mumbai squid[601]: Disabling Authentication on port 
>>>> [::]:8084 (interception enabled)
>>>> Dec 18 12:59:13 mumbai squid[601]: Starting Authentication on port 
>>>> [::]:3136
>>>> Dec 18 12:59:13 mumbai squid[601]: Disabling Authentication on port 
>>>> [::]:3136 (interception enabled)
>>>> Dec 18 12:59:13 mumbai squid[601]: Starting Authentication on port 
>>>> [::]:3137
>>>> Dec 18 12:59:13 mumbai squid[601]: Disabling Authentication on port 
>>>> [::]:3137 (interception enabled)
>>>> ...
>>>> Dec 18 12:59:29 mumbai squid[604]: Adaptation support is on
>>>> Dec 18 12:59:29 mumbai squid[604]: Accepting NAT intercepted HTTP 
>>>> Socket connections at conn19 local=[::]:3128 remote=[::] FD 27 
>>>> flags=41
>>>> ??????????????????????????????????????? listening port: 3128
>>>> Dec 18 12:59:29 mumbai squid[604]: Accepting SSL bumped HTTP Socket 
>>>> connections at conn21 local=[::]:8080 remote=[::] FD 28 flags=9
>>>> ??????????????????????????????????????? listening port: 8080
>>>> Dec 18 12:59:29 mumbai squid[604]: Accepting NAT intercepted SSL 
>>>> bumped HTTPS Socket connections at conn23 local=[::]:8081 
>>>> remote=[::] FD 29 flags=41
>>>> ??????????????????????????????????????? listening port: 8081
>>>> Dec 18 12:59:29 mumbai squid[604]: Accepting SSL bumped HTTP Socket 
>>>> connections at conn25 local=[::]:8092 remote=[::] FD 30 flags=9
>>>> ??????????????????????????????????????? listening port: 8092
>>>> Dec 18 12:59:29 mumbai systemd[1]: Started Squid Web Proxy Server.
>>>> Dec 18 12:59:29 mumbai squid[604]: Accepting SSL bumped HTTP Socket 
>>>> connections at conn27 local=[::]:8093 remote=[::] FD 31 flags=9
>>>> ??????????????????????????????????????? listening port: 8093
>>>> Dec 18 12:59:29 mumbai squid[604]: Accepting SSL bumped HTTP Socket 
>>>> connections at conn29 local=[::]:8094 remote=[::] FD 32 flags=9
>>>> ??????????????????????????????????????? listening port: 8094
>>>> Dec 18 12:59:29 mumbai squid[604]: Accepting NAT intercepted SSL 
>>>> bumped HTTPS Socket connections at conn31 local=[::]:8082 
>>>> remote=[::] FD 33 flags=41
>>>> ??????????????????????????????????????? listening port: 8082
>>>> Dec 18 12:59:29 mumbai squid[604]: Accepting NAT intercepted SSL 
>>>> bumped HTTPS Socket connections at conn33 local=[::]:8083 
>>>> remote=[::] FD 34 flags=41
>>>> ??????????????????????????????????????? listening port: 8083
>>>> Dec 18 12:59:29 mumbai squid[604]: Accepting NAT intercepted SSL 
>>>> bumped HTTPS Socket connections at conn35 local=[::]:8084 
>>>> remote=[::] FD 35 flags=41
>>>> ??????????????????????????????????????? listening port: 8084
>>>> Dec 18 12:59:29 mumbai squid[604]: Accepting NAT intercepted HTTP 
>>>> Socket connections at conn37 local=[::]:3136 remote=[::] FD 36 
>>>> flags=41
>>>> ??????????????????????????????????????? listening port: 3136
>>>> Dec 18 12:59:29 mumbai squid[604]: Accepting NAT intercepted HTTP 
>>>> Socket connections at conn39 local=[::]:3137 remote=[::] FD 37 
>>>> flags=41
>>>> ??????????????????????????????????????? listening port: 3137
>>>>
>>>> And then following errors came:
>>>>
>>>>
>>>> Dec 18 12:59:45 mumbai squid[604]: ERROR: failure while accepting a 
>>>> TLS connection on conn41 local=192.168.0.1:8080 
>>>> remote=192.168.0.111:53867 FD 12 flags=1: SQUID_TLS
>>>> _ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
>>>> ??????????????????????????????????????? current master transaction: 
>>>> master53
>>>> Dec 18 12:59:45 mumbai squid[604]: ERROR: failure while accepting a 
>>>> TLS connection on conn42 local=192.168.0.1:8080 
>>>> remote=192.168.0.111:53868 FD 14 flags=1: SQUID_TLS
>>>> _ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
>>>> ??????????????????????????????????????? current master transaction: 
>>>> master53
>>>> Dec 18 12:59:45 mumbai squid[604]: ERROR: failure while accepting a 
>>>> TLS connection on conn43 local=192.168.0.1:8080 
>>>> remote=192.168.0.111:53869 FD 16 flags=1: SQUID_TLS
>>>> _ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
>>>> ??????????????????????????????????????? current master transaction: 
>>>> master57
>>>> Dec 18 12:59:45 mumbai squid[604]: ERROR: failure while accepting a 
>>>> TLS connection on conn44 local=192.168.0.1:8080 
>>>> remote=192.168.0.111:53870 FD 12 flags=1: SQUID_TLS
>>>> _ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
>>>> ??????????????????????????????????????? current master transaction: 
>>>> master57
>>>> Dec 18 12:59:56 mumbai squid[604]: ERROR: failure while accepting a 
>>>> TLS connection on conn62 local=192.168.0.1:8080 
>>>> remote=192.168.0.111:53887 FD 12 flags=1: SQUID_TLS
>>>> _ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
>>>> ??????????????????????????????????????? current master transaction: 
>>>> master95
>>>> Dec 18 12:59:59 mumbai squid[604]: ERROR: failure while accepting a 
>>>> TLS connection on conn64 local=192.168.0.1:8080 
>>>> remote=192.168.0.111:53888 FD 12 flags=1: SQUID_TLS
>>>> _ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
>>>> ??????????????????????????????????????? current master transaction: 
>>>> master99
>>>> Dec 18 13:00:02 mumbai squid[604]: ERROR: failure while accepting a 
>>>> TLS connection on conn65 local=192.168.0.1:8080 
>>>> remote=192.168.0.178:56115 FD 12 flags=1: SQUID_TLS
>>>> _ERR_ACCEPT+TLS_LIB_ERR=A000418+TLS_IO_ERR=1
>>>> ??????????????????????????????????????? current master transaction: 
>>>> master53
>>>> Dec 18 13:01:24 mumbai squid[604]: kick abandoning conn199 
>>>> local=192.168.0.1:8093 remote=192.168.0.101:52211 FD 52 flags=1
>>>> ??????????????????????????????????????? connection: conn199 
>>>> local=192.168.0.1:8093 remote=192.168.0.101:52211 FD 52 flags=1
>>>> Dec 18 13:01:45 mumbai squid[604]: ERROR: failure while accepting a 
>>>> TLS connection on conn240 local=192.168.0.1:8093 
>>>> remote=192.168.0.111:53931 FD 48 flags=1: SQUID_TL
>>>> S_ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
>>>> ??????????????????????????????????????? current master transaction: 
>>>> master314
>>>>
>>>>
>>>> After this point there is nothing in systemd journal (via: 
>>>> journalctl -f -u squid) and same lines are in cache.log.
>>>>
>>>> Squid got stuck (DEAD state) at 13:01 and right now it 19:26 (6 
>>>> hours passed) and squid is still in dead state.
>>>>
>>>> kill -9 or kill -ALRM or -HUP also does nothing.
>>>>
>>>> So to restart squid - I will need to restart whole system.
>>>>
>>>> I have sslbump directives but it is not really applied.
>>>>
>>>> #NOTE: nosslbump_ips below contains 192.168.0.0/24 (whole LAN) so 
>>>> effectively there is no SSL bump after step1.
>>>>
>>>> acl nosslbump_ips src 192.168.0.0/24
>>>> ssl_bump splice ssl_step1 nosslbump_ips
>>>> ssl_bump peek ssl_step1
>>>> ssl_bump splice nosslbump_domains
>>>> ssl_bump stare sslbump_domains
>>>> ssl_bump splice ssl_step2
>>>> ssl_bump bump all
>>>>
>>>>
>>>> Any idea? If anything changed from 5.7 to 6.6 that may cause this 
>>>> behaviour?
>>>>
>>>> Looking at changelog:
>>>>
>>>> Bug 5256: Intercepting port fails to accept
>>>> https://bugs.squid-cache.org/show_bug.cgi?id=5256
>>>>
>>>> Bug 5154: Do not open IPv6 sockets when IPv6 is disabled
>>>> https://bugs.squid-cache.org/show_bug.cgi?id=5154
>>>>
>>>> Not sure if above two bug FIXES (in between v5.7 to v6.6) are 
>>>> related to my issue.
>>>>
>>>> I ran netstat:
>>>>
>>>> # netstat -ntlp
>>>> Active Internet connections (only servers)
>>>> Proto Recv-Q Send-Q Local Address?????????? Foreign Address 
>>>> State?????? PID/Program name
>>>> ...
>>>> tcp6????? 33????? 0 :::3137 :::*??????????????????? LISTEN -
>>>> tcp6?????? 0????? 0 :::3136 :::*??????????????????? LISTEN -
>>>> tcp6?????? 4????? 0 :::3128 :::*??????????????????? LISTEN -
>>>> tcp6?????? 0????? 0 :::8081 :::*??????????????????? LISTEN -
>>>> tcp6?????? 0????? 0 :::8080 :::*??????????????????? LISTEN -
>>>> tcp6?????? 0????? 0 :::8083 :::*??????????????????? LISTEN -
>>>> tcp6?????? 0????? 0 :::8082 :::*??????????????????? LISTEN -
>>>> tcp6?????? 0????? 0 :::8084 :::*??????????????????? LISTEN -
>>>> tcp6??? 4097????? 0 :::8093 :::*??????????????????? LISTEN -
>>>> tcp6?????? 0????? 0 :::8092 :::*??????????????????? LISTEN -
>>>> tcp6?????? 0????? 0 :::8094 :::*??????????????????? LISTEN -
>>>> ...
>>>>
>>>> I do not have IPv6 enabled, yet there are 33 and 4097 numbers in 
>>>> Recv-Q and also no process/PID owns these ports.
>>>>
>>>> Same IPv4 ports are not shown in use by netstat, so only IPv6 ports 
>>>> remain open, that too orphaned!
>>>>
>>>> So what is happening?
>>>>
>>>> Any idea to solve or any workaround?
>>>>
>>>> Thank you,
>>>>
>>>> Amish.
>> _______________________________________________
>> squid-users mailing list
>> squid-users at lists.squid-cache.org
>> https://lists.squid-cache.org/listinfo/squid-users
>


From gkinkie at gmail.com  Thu Dec 21 12:25:57 2023
From: gkinkie at gmail.com (Francesco Chemolli)
Date: Thu, 21 Dec 2023 13:25:57 +0100
Subject: [squid-users] squid hangs and dies and can not be killed -
 needs system reboot
In-Reply-To: <add5fbda-db7f-42f2-8225-66a87cc81e12@gmail.com>
References: <9c9c6491-9c3c-46ff-8026-0318fa7af19c@gmail.com>
 <27d80d95-0a33-4a65-a5d8-bed1fef2b6db@measurement-factory.com>
 <d7be2652-18ce-42fc-9156-7c4fcacb3f63@gmail.com>
 <61d0bb96-9d31-4c67-b071-c99250714dff@measurement-factory.com>
 <add5fbda-db7f-42f2-8225-66a87cc81e12@gmail.com>
Message-ID: <CA+Y8hcNmB+Nybhye9qypmNJXK6858_CovrJ8xginx7As6fAeZA@mail.gmail.com>

Hi Amish,
  the message you posted really looks like a kernel bug, possibly due to
faulty code, or resulting from a hardware problem.
Nothing squid can do can cause that kind of stack traces in kernel-space.

A quick search online results in
https://lkml.kernel.org/netdev/20230526163458.2880232-1-edumazet at google.com/T/
, which looks very much like your message

On Thu, Dec 21, 2023 at 1:10?PM Amish <anon.amish at gmail.com> wrote:

> Hi Alex,
>
> Sorry for late reply. But this is a production system and hence
> debugging is tough. May take few days.
>
> However I noticed that everytime squid hangs (goes dead), the dmesg has
> these errors.
>
> [63567.802188] divide error: 0000 [#1] PREEMPT SMP PTI
> [63567.802215] CPU: 3 PID: 617 Comm: squid Not tainted 6.6.7-arch1-1 #1
> 4505c4baa0b3d7c4037b0e8f5402626fa360717f
> [63567.802238] Hardware name: Gigabyte Technology Co., Ltd.
> H81M-S/H81M-S, BIOS F2 08/19/2015
> [63567.802255] RIP: 0010:tcp_rcv_space_adjust+0xbe/0x160
> [63567.802267] Code: f8 41 89 d0 29 d0 31 d2 49 0f af c2 49 f7 f0 45 8b
> 81 bc 04 00 00 44 0f b6 8b 10 06 00 00 31 d2 49 8d 04 42 48 98 48 c1 e0
> 08 <49> f7 f1 49 63 d0
> 48 98 48 39 d0 48 0f 47 c2 39 83 18 01 00 00 7c
> [63567.802287] RSP: 0018:ffffba9f00da3c18 EFLAGS: 00010206
> [63567.802296] RAX: 0000000004fb2800 RBX: ffff9e124acc1c80 RCX:
> 0000000eccd9dace
> [63567.802304] RDX: 0000000000000000 RSI: 0000000037fa4ae8 RDI:
> 0000000000008349
> [63567.802314] RBP: ffff9e124acc1c80 R08: 0000000000600000 R09:
> 0000000000000000
> [63567.802322] R10: 00000000000161d2 R11: ffff9e1346621700 R12:
> 0000000000000000
> [63567.802331] R13: ffff9e124acc1d58 R14: 0000000000000000 R15:
> ffff9e124acc2214
> [63567.802340] FS:  00007fc3d627c840(0000) GS:ffff9e1457380000(0000)
> knlGS:0000000000000000
> [63567.802350] CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033
> [63567.802358] CR2: 0000560b7e86d690 CR3: 0000000102f44001 CR4:
> 00000000001706e0
> [63567.802367] Call Trace:
> [63567.802372]  <TASK>
> [63567.802378]  ? die+0x36/0x90
> [63567.802386]  ? do_trap+0xda/0x100
> [63567.802392]  ? tcp_rcv_space_adjust+0xbe/0x160
> [63567.802401]  ? do_error_trap+0x6a/0x90
> [63567.802408]  ? tcp_rcv_space_adjust+0xbe/0x160
> [63567.802415]  ? exc_divide_error+0x38/0x50
> [63567.802423]  ? tcp_rcv_space_adjust+0xbe/0x160
> [63567.802431]  ? asm_exc_divide_error+0x1a/0x20
> [63567.802441]  ? tcp_rcv_space_adjust+0xbe/0x160
> [63567.802449]  ? tcp_rcv_space_adjust+0x1a/0x160
> [63567.802456]  tcp_recvmsg_locked+0x2d4/0x960
> [63567.802464]  tcp_recvmsg+0x87/0x1f0
> [63567.802471]  inet6_recvmsg+0x56/0x130
> [63567.802479]  ? __pfx_bpf_lsm_socket_recvmsg+0x10/0x10
> [63567.802488]  ? security_socket_recvmsg+0x44/0x70
> [63567.802497]  sock_recvmsg+0x57/0xd0
> [63567.802505]  sock_read_iter+0x96/0x100
> [63567.802513]  vfs_read+0x303/0x350
> [63567.802796]  ksys_read+0xbb/0xf0
> [63567.803074]  do_syscall_64+0x60/0x90
> [63567.803346]  ? syscall_exit_to_user_mode+0x2b/0x40
> [63567.803619]  ? do_syscall_64+0x6c/0x90
> [63567.803890]  ? syscall_exit_to_user_mode+0x2b/0x40
> [63567.804163]  ? do_syscall_64+0x6c/0x90
> [63567.804438]  ? do_syscall_64+0x6c/0x90
> [63567.804710]  entry_SYSCALL_64_after_hwframe+0x6e/0xd8
> [63567.804984] RIP: 0033:0x7fc3d5f21531
> [63567.805271] Code: ff ff eb c3 67 e8 2f c9 01 00 66 2e 0f 1f 84 00 00
> 00 00 00 0f 1f 44 00 00 f3 0f 1e fa 80 3d 35 ce 0d 00 00 74 13 31 c0 0f
> 05 <48> 3d 00 f0 ff ff
> 77 57 c3 66 0f 1f 44 00 00 48 83 ec 28 48 89 54
> [63567.805909] RSP: 002b:00007fffa66f6748 EFLAGS: 00000246 ORIG_RAX:
> 0000000000000000
> [63567.806225] RAX: ffffffffffffffda RBX: 00007fffa66f6830 RCX:
> 00007fc3d5f21531
> [63567.806542] RDX: 000000000000191a RSI: 000055d106003d80 RDI:
> 00000000000000bd
> [63567.806855] RBP: 000055d10620bc30 R08: 000055d10620bc30 R09:
> 000055d1036a8e78
> [63567.807163] R10: 000055d1037ad630 R11: 0000000000000246 R12:
> 000000000000191a
> [63567.807472] R13: 000055d10664f410 R14: 000055d106003d80 R15:
> 00007fc3d627c6b8
> [63567.807768]  </TASK>
> [63567.808037] Modules linked in: nfnetlink_queue nf_conntrack_netlink
> xt_connmark xt_mark ip_set_hash_net xt_NFQUEUE xt_set ip_set_hash_ip
> ip_set cls_fw sch_sfq sch_h
> tb nf_nat_ftp nf_conntrack_ftp tls tun cfg80211 rfkill nft_chain_nat
> xt_MASQUERADE xt_nat xt_REDIRECT nf_nat nft_limit xt_limit xt_conntrack
> nf_conntrack nf_defrag_ipv
> 6 nf_defrag_ipv4 xt_multiport xt_tcpudp nft_compat nf_tables libcrc32c
> intel_rapl_msr intel_rapl_common x86_pkg_temp_thermal intel_powerclamp
> snd_hda_codec_realtek cor
> etemp snd_hda_codec_generic ledtrig_audio snd_hda_codec_hdmi kvm_intel
> snd_hda_intel kvm snd_intel_dspcfg snd_intel_sdw_acpi irqbypass
> snd_hda_codec snd_hda_core crct1
> 0dif_pclmul r8169 crc32_pclmul snd_hwdep polyval_clmulni snd_pcm
> polyval_generic gf128mul snd_timer realtek ax88179_178a spi_nor
> mdio_devres usbnet snd libphy ghash_cl
> mulni_intel mtd sha512_ssse3 at24 soundcore mii mei_pxp mei_hdcp
> sha256_ssse3 sha1_ssse3 iTCO_wdt i2c_i801 mei_me spi_intel_platform
> mousedev aesni_intel intel_pmc_bxt
>   spi_intel iTCO_vendor_support
> [63567.808076]  i2c_smbus mei crypto_simd lpc_ich cryptd rapl
> intel_cstate intel_uncore psmouse mac_hid pcspkr pkcs8_key_parser fuse
> dm_mod loop nfnetlink ip_tables x_
> tables ext4 crc32c_generic crc16 mbcache jbd2 i915 serio_raw
> i2c_algo_bit atkbd drm_buddy libps2 ttm vivaldi_fmap intel_gtt xhci_pci
> crc32c_intel drm_display_helper xh
> ci_pci_renesas cec i8042 video serio wmi
> [63567.811333] ---[ end trace 0000000000000000 ]---
> [63567.811701] RIP: 0010:tcp_rcv_space_adjust+0xbe/0x160
> [63567.812069] Code: f8 41 89 d0 29 d0 31 d2 49 0f af c2 49 f7 f0 45 8b
> 81 bc 04 00 00 44 0f b6 8b 10 06 00 00 31 d2 49 8d 04 42 48 98 48 c1 e0
> 08 <49> f7 f1 49 63 d0
> 48 98 48 39 d0 48 0f 47 c2 39 83 18 01 00 00 7c
> [63567.812848] RSP: 0018:ffffba9f00da3c18 EFLAGS: 00010206
> [63567.813252] RAX: 0000000004fb2800 RBX: ffff9e124acc1c80 RCX:
> 0000000eccd9dace
> [63567.813651] RDX: 0000000000000000 RSI: 0000000037fa4ae8 RDI:
> 0000000000008349
> [63567.814064] RBP: ffff9e124acc1c80 R08: 0000000000600000 R09:
> 0000000000000000
> [63567.814470] R10: 00000000000161d2 R11: ffff9e1346621700 R12:
> 0000000000000000
> [63567.814879] R13: ffff9e124acc1d58 R14: 0000000000000000 R15:
> ffff9e124acc2214
> [63567.815290] FS:  00007fc3d627c840(0000) GS:ffff9e1457380000(0000)
> knlGS:0000000000000000
> [63567.815700] CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033
> [63567.816121] CR2: 0000560b7e86d690 CR3: 0000000102f44001 CR4:
> 00000000001706e0
>
> After this the "child" squid process can not be killed, even by systemd,
> even by kill -9.
>
> It appears that squid "main" process (owned by root user) does not hang
> and hence connections on port 8080 are accepted.
>
> But squid child process (owned by proxy user) hangs and never recovers
> after above dmesg. And hence nothing happens and connection times out.
>
> # ps aux |grep squid
> root         612  0.0  0.2  75500 23680 ?        Ss   Dec20   0:02
> /usr/bin/squid -f /etc/squid/btnet/squid.btnet.conf --foreground -sYC
> proxy        617  0.0  0.0      0     0 ?        D    Dec20   1:00 [squid]
> proxy        620  0.0  0.0  12152  7552 ?        S    Dec20   0:00
> (security_file_certgen) -s /var/cache/squid/ssl_db -M 4MB
> proxy        621  0.0  0.0  12152  7552 ?        S    Dec20   0:00
> (security_file_certgen) -s /var/cache/squid/ssl_db -M 4MB
> proxy        622  0.0  0.0  11888  5504 ?        S    Dec20   0:00
> (security_file_certgen) -s /var/cache/squid/ssl_db -M 4MB
> proxy        623  0.0  0.0  11888  5632 ?        S    Dec20   0:00
> (security_file_certgen) -s /var/cache/squid/ssl_db -M 4MB
> proxy        624  0.0  0.0  11888  5632 ?        S    Dec20   0:00
> (security_file_certgen) -s /var/cache/squid/ssl_db -M 4MB
> proxy        643  0.0  0.0   6116  3200 ?        S    Dec20   0:01
> (logfile-daemon) /var/log/squid/access.log
>
> # telnet 127.0.0.1 8080
> Trying 127.0.0.1...
> Connected to 127.0.0.1.
> Escape character is '^]'.
> ^]
> telnet> c
>
> # curl -x 127.0.0.1:8080 --max-time 30 https://google.com
> curl: (28) Connection timed out after 30002 milliseconds
>
> # kill 612 617
>
> Ran kill 5 times, nothing happened. All squid processes remained.
>
> # kill -9 612 617
>
> Ran once, and all squid processes except 617 (child squid process) got
> killed
>
> # ps aux |grep squid
> proxy        617  0.0  0.0      0     0 ?        D    Dec20   1:00 [squid]
> root       90764  0.0  0.0   6552  2560 pts/5    S+   17:36   0:00 grep
> --color=auto squid
>
> Can above information be of any help?
>
> Thanks and regards,
>
> Amish
>
> On 19/12/23 20:46, Alex Rousskov wrote:
> > On 2023-12-18 22:29, Amish wrote:
> >> On 19/12/23 01:14, Alex Rousskov wrote:
> >>> On 2023-12-18 09:35, Amish wrote:
> >>>
> >>>> I use Arch Linux and today I updated squid from squid 5.7 to squid
> >>>> 6.6.
> >>>
> >>> > Dec 18 13:01:24 mumbai squid[604]: kick abandoning conn199
> >>>
> >>> I do not know whether the above problem is the primary problem in
> >>> your setup, but it is a red flag. Transactions on the same
> >>> connection may get stuck after that message; it is essentially a
> >>> Squid bug.
> >>>
> >>> I am not sure at all, but this bug might be related to Bug 5187
> >>> workaround that went into Squid v6.2 (commit c44cfe7):
> >>> https://bugs.squid-cache.org/show_bug.cgi?id=5187
> >>>
> >>> Does Squid accept new TCP connections after it enters what you
> >>> describe as a dead state? For example, does "telnet 127.0.0.1 8080"
> >>> establishes a connection if executed on the same machine as Squid?
> >>>
> >> Yes it establishes connection. But I do not know what to do next.
> >
> > This tells us that your Squid is still listening for incoming
> > connections. Most likely, it is not "dead" but running and just unable
> > to make progress with those connections (for yet unknown reasons).
> > That information is helpful but not sufficient (for me) to solve the
> > problem you are describing.
> >
> > The next step that I would recommend is to collect debugging
> > information from the running process and share a pointer to the
> > corresponding compressed cache.log file:
> >
> > * Ideally, start collection when Squid starts and reproduce the
> > problem while collecting full debugging information:
> > http://wiki.squid-cache.org/SquidFaq/BugReporting#full-debug-output
> >
> > * If you have to, start collection after Squid is already in bad state
> > and just before you use telnet or browser to tickle Squid:
> >
> http://wiki.squid-cache.org/SquidFaq/BugReporting#debugging-a-single-transaction
> >
> >
> > Do not use any secret information (e.g., production certificate keys)
> > for these tests (unless you are going to share the logs privately with
> > those you trust).
> >
> > Do not downgrade to v5 for these tests.
> >
> >
> > HTH,
> >
> > Alex.
> >
> >
> >> Browser showed "Connection timed out" message. But I believe
> >> browser's also connected but nothing happened afterwards.
> >>
> >>>
> >>> > kill -9 does nothing
> >>>
> >>> Is it possible that you are trying to kill the wrong process? You
> >>> should be killing this process AFAICT:
> >>>
> >>> > root         601  0.0  0.2  73816 22528 ?        Ss 12:59 0:02
> >>> > /usr/bin/squid -f /etc/squid/btnet/squid.btnet.conf --foreground -sYC
> >>
> >> I did not clarify but all processes needed SIGKILL and vanished
> >> except the Dead squid process which still remained.
> >>
> >> # systemctl stop squid
> >>
> >> Dec 19 08:46:38 mumbai systemd[1]: squid.service: State
> >> 'stop-sigterm' timed out. Killing.
> >> Dec 19 08:46:38 mumbai systemd[1]: squid.service: Killing process 601
> >> (squid) with signal SIGKILL.
> >> Dec 19 08:46:38 mumbai systemd[1]: squid.service: Killing process 604
> >> (squid) with signal SIGKILL.
> >> Dec 19 08:46:38 mumbai systemd[1]: squid.service: Killing process 607
> >> (security_file_c) with signal SIGKILL.
> >> Dec 19 08:46:38 mumbai systemd[1]: squid.service: Killing process 608
> >> (security_file_c) with signal SIGKILL.
> >> Dec 19 08:46:38 mumbai systemd[1]: squid.service: Killing process 609
> >> (security_file_c) with signal SIGKILL.
> >> Dec 19 08:46:38 mumbai systemd[1]: squid.service: Killing process 610
> >> (security_file_c) with signal SIGKILL.
> >> Dec 19 08:46:38 mumbai systemd[1]: squid.service: Killing process 611
> >> (security_file_c) with signal SIGKILL.
> >> Dec 19 08:46:38 mumbai systemd[1]: squid.service: Killing process 622
> >> (log_file_daemon) with signal SIGKILL.
> >> Dec 19 08:46:38 mumbai systemd[1]: squid.service: Main process
> >> exited, code=killed, status=9/KILL
> >> Dec 19 08:46:38 mumbai systemd[1]: squid.service: Killing process 604
> >> (squid) with signal SIGKILL.
> >>
> >> Waited for 2 minutes for squid to stop then pressed ctrl-c to
> >> systemctl stop squid command.
> >>
> >> As you can see in last line shows that attempt was made to kill DEAD
> >> process with PID 604.
> >>
> >> # ps aux |grep squid
> >> proxy        604  0.0  0.0      0     0 ?        D    Dec18 0:03 [squid]
> >>
> >> Now only DEAD squid process remains.
> >>
> >> What next? Should I downgrade to 5.9 and check?
> >>
> >> Regards
> >>
> >> Amish
> >>
> >>> Alex.
> >>>
> >>>
> >>>> After the update from 5.7 to 6.6, squid starts but then reaches
> >>>> Dead state in a minute or two.
> >>>>
> >>>> # ps aux | grep squid
> >>>> root         601  0.0  0.2  73816 22528 ?        Ss   12:59 0:02
> >>>> /usr/bin/squid -f /etc/squid/btnet/squid.btnet.conf --foreground -sYC
> >>>> proxy        604  0.0  0.0      0     0 ?        D    12:59 0:03
> >>>> [squid]
> >>>> proxy        607  0.0  0.0  11976  7424 ?        S    12:59 0:00
> >>>> (security_file_certgen) -s /var/cache/squid/ssl_db -M 4MB
> >>>> proxy        608  0.0  0.0  11976  7168 ?        S    12:59 0:00
> >>>> (security_file_certgen) -s /var/cache/squid/ssl_db -M 4MB
> >>>> proxy        609  0.0  0.0  11712  5632 ?        S    12:59 0:00
> >>>> (security_file_certgen) -s /var/cache/squid/ssl_db -M 4MB
> >>>> proxy        610  0.0  0.0  11712  5376 ?        S    12:59 0:00
> >>>> (security_file_certgen) -s /var/cache/squid/ssl_db -M 4MB
> >>>> proxy        611  0.0  0.0  11712  5504 ?        S    12:59 0:00
> >>>> (security_file_certgen) -s /var/cache/squid/ssl_db -M 4MB
> >>>> proxy        622  0.0  0.0   6116  3200 ?        S    12:59 0:00
> >>>> (logfile-daemon) /var/log/squid/access.log
> >>>>
> >>>> And then all requests get stuck. Notice the D (dead) state of squid.
> >>>>
> >>>> I use multiple ports for multiple purposes. (It all worked fine in
> >>>> squid 5.7)
> >>>>
> >>>> Dec 18 12:59:10 mumbai squid[601]: Starting Authentication on port
> >>>> [::]:3128
> >>>> Dec 18 12:59:10 mumbai squid[601]: Disabling Authentication on port
> >>>> [::]:3128 (interception enabled)
> >>>> Dec 18 12:59:10 mumbai squid[601]: Starting Authentication on port
> >>>> [::]:8081
> >>>> Dec 18 12:59:10 mumbai squid[601]: Disabling Authentication on port
> >>>> [::]:8081 (interception enabled)
> >>>> Dec 18 12:59:12 mumbai squid[601]: Starting Authentication on port
> >>>> [::]:8082
> >>>> Dec 18 12:59:12 mumbai squid[601]: Disabling Authentication on port
> >>>> [::]:8082 (interception enabled)
> >>>> Dec 18 12:59:12 mumbai squid[601]: Starting Authentication on port
> >>>> [::]:8083
> >>>> Dec 18 12:59:12 mumbai squid[601]: Disabling Authentication on port
> >>>> [::]:8083 (interception enabled)
> >>>> Dec 18 12:59:13 mumbai squid[601]: Starting Authentication on port
> >>>> [::]:8084
> >>>> Dec 18 12:59:13 mumbai squid[601]: Disabling Authentication on port
> >>>> [::]:8084 (interception enabled)
> >>>> Dec 18 12:59:13 mumbai squid[601]: Starting Authentication on port
> >>>> [::]:3136
> >>>> Dec 18 12:59:13 mumbai squid[601]: Disabling Authentication on port
> >>>> [::]:3136 (interception enabled)
> >>>> Dec 18 12:59:13 mumbai squid[601]: Starting Authentication on port
> >>>> [::]:3137
> >>>> Dec 18 12:59:13 mumbai squid[601]: Disabling Authentication on port
> >>>> [::]:3137 (interception enabled)
> >>>> ...
> >>>> Dec 18 12:59:29 mumbai squid[604]: Adaptation support is on
> >>>> Dec 18 12:59:29 mumbai squid[604]: Accepting NAT intercepted HTTP
> >>>> Socket connections at conn19 local=[::]:3128 remote=[::] FD 27
> >>>> flags=41
> >>>>                                         listening port: 3128
> >>>> Dec 18 12:59:29 mumbai squid[604]: Accepting SSL bumped HTTP Socket
> >>>> connections at conn21 local=[::]:8080 remote=[::] FD 28 flags=9
> >>>>                                         listening port: 8080
> >>>> Dec 18 12:59:29 mumbai squid[604]: Accepting NAT intercepted SSL
> >>>> bumped HTTPS Socket connections at conn23 local=[::]:8081
> >>>> remote=[::] FD 29 flags=41
> >>>>                                         listening port: 8081
> >>>> Dec 18 12:59:29 mumbai squid[604]: Accepting SSL bumped HTTP Socket
> >>>> connections at conn25 local=[::]:8092 remote=[::] FD 30 flags=9
> >>>>                                         listening port: 8092
> >>>> Dec 18 12:59:29 mumbai systemd[1]: Started Squid Web Proxy Server.
> >>>> Dec 18 12:59:29 mumbai squid[604]: Accepting SSL bumped HTTP Socket
> >>>> connections at conn27 local=[::]:8093 remote=[::] FD 31 flags=9
> >>>>                                         listening port: 8093
> >>>> Dec 18 12:59:29 mumbai squid[604]: Accepting SSL bumped HTTP Socket
> >>>> connections at conn29 local=[::]:8094 remote=[::] FD 32 flags=9
> >>>>                                         listening port: 8094
> >>>> Dec 18 12:59:29 mumbai squid[604]: Accepting NAT intercepted SSL
> >>>> bumped HTTPS Socket connections at conn31 local=[::]:8082
> >>>> remote=[::] FD 33 flags=41
> >>>>                                         listening port: 8082
> >>>> Dec 18 12:59:29 mumbai squid[604]: Accepting NAT intercepted SSL
> >>>> bumped HTTPS Socket connections at conn33 local=[::]:8083
> >>>> remote=[::] FD 34 flags=41
> >>>>                                         listening port: 8083
> >>>> Dec 18 12:59:29 mumbai squid[604]: Accepting NAT intercepted SSL
> >>>> bumped HTTPS Socket connections at conn35 local=[::]:8084
> >>>> remote=[::] FD 35 flags=41
> >>>>                                         listening port: 8084
> >>>> Dec 18 12:59:29 mumbai squid[604]: Accepting NAT intercepted HTTP
> >>>> Socket connections at conn37 local=[::]:3136 remote=[::] FD 36
> >>>> flags=41
> >>>>                                         listening port: 3136
> >>>> Dec 18 12:59:29 mumbai squid[604]: Accepting NAT intercepted HTTP
> >>>> Socket connections at conn39 local=[::]:3137 remote=[::] FD 37
> >>>> flags=41
> >>>>                                         listening port: 3137
> >>>>
> >>>> And then following errors came:
> >>>>
> >>>>
> >>>> Dec 18 12:59:45 mumbai squid[604]: ERROR: failure while accepting a
> >>>> TLS connection on conn41 local=192.168.0.1:8080
> >>>> remote=192.168.0.111:53867 FD 12 flags=1: SQUID_TLS
> >>>> _ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
> >>>>                                         current master transaction:
> >>>> master53
> >>>> Dec 18 12:59:45 mumbai squid[604]: ERROR: failure while accepting a
> >>>> TLS connection on conn42 local=192.168.0.1:8080
> >>>> remote=192.168.0.111:53868 FD 14 flags=1: SQUID_TLS
> >>>> _ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
> >>>>                                         current master transaction:
> >>>> master53
> >>>> Dec 18 12:59:45 mumbai squid[604]: ERROR: failure while accepting a
> >>>> TLS connection on conn43 local=192.168.0.1:8080
> >>>> remote=192.168.0.111:53869 FD 16 flags=1: SQUID_TLS
> >>>> _ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
> >>>>                                         current master transaction:
> >>>> master57
> >>>> Dec 18 12:59:45 mumbai squid[604]: ERROR: failure while accepting a
> >>>> TLS connection on conn44 local=192.168.0.1:8080
> >>>> remote=192.168.0.111:53870 FD 12 flags=1: SQUID_TLS
> >>>> _ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
> >>>>                                         current master transaction:
> >>>> master57
> >>>> Dec 18 12:59:56 mumbai squid[604]: ERROR: failure while accepting a
> >>>> TLS connection on conn62 local=192.168.0.1:8080
> >>>> remote=192.168.0.111:53887 FD 12 flags=1: SQUID_TLS
> >>>> _ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
> >>>>                                         current master transaction:
> >>>> master95
> >>>> Dec 18 12:59:59 mumbai squid[604]: ERROR: failure while accepting a
> >>>> TLS connection on conn64 local=192.168.0.1:8080
> >>>> remote=192.168.0.111:53888 FD 12 flags=1: SQUID_TLS
> >>>> _ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
> >>>>                                         current master transaction:
> >>>> master99
> >>>> Dec 18 13:00:02 mumbai squid[604]: ERROR: failure while accepting a
> >>>> TLS connection on conn65 local=192.168.0.1:8080
> >>>> remote=192.168.0.178:56115 FD 12 flags=1: SQUID_TLS
> >>>> _ERR_ACCEPT+TLS_LIB_ERR=A000418+TLS_IO_ERR=1
> >>>>                                         current master transaction:
> >>>> master53
> >>>> Dec 18 13:01:24 mumbai squid[604]: kick abandoning conn199
> >>>> local=192.168.0.1:8093 remote=192.168.0.101:52211 FD 52 flags=1
> >>>>                                         connection: conn199
> >>>> local=192.168.0.1:8093 remote=192.168.0.101:52211 FD 52 flags=1
> >>>> Dec 18 13:01:45 mumbai squid[604]: ERROR: failure while accepting a
> >>>> TLS connection on conn240 local=192.168.0.1:8093
> >>>> remote=192.168.0.111:53931 FD 48 flags=1: SQUID_TL
> >>>> S_ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
> >>>>                                         current master transaction:
> >>>> master314
> >>>>
> >>>>
> >>>> After this point there is nothing in systemd journal (via:
> >>>> journalctl -f -u squid) and same lines are in cache.log.
> >>>>
> >>>> Squid got stuck (DEAD state) at 13:01 and right now it 19:26 (6
> >>>> hours passed) and squid is still in dead state.
> >>>>
> >>>> kill -9 or kill -ALRM or -HUP also does nothing.
> >>>>
> >>>> So to restart squid - I will need to restart whole system.
> >>>>
> >>>> I have sslbump directives but it is not really applied.
> >>>>
> >>>> #NOTE: nosslbump_ips below contains 192.168.0.0/24 (whole LAN) so
> >>>> effectively there is no SSL bump after step1.
> >>>>
> >>>> acl nosslbump_ips src 192.168.0.0/24
> >>>> ssl_bump splice ssl_step1 nosslbump_ips
> >>>> ssl_bump peek ssl_step1
> >>>> ssl_bump splice nosslbump_domains
> >>>> ssl_bump stare sslbump_domains
> >>>> ssl_bump splice ssl_step2
> >>>> ssl_bump bump all
> >>>>
> >>>>
> >>>> Any idea? If anything changed from 5.7 to 6.6 that may cause this
> >>>> behaviour?
> >>>>
> >>>> Looking at changelog:
> >>>>
> >>>> Bug 5256: Intercepting port fails to accept
> >>>> https://bugs.squid-cache.org/show_bug.cgi?id=5256
> >>>>
> >>>> Bug 5154: Do not open IPv6 sockets when IPv6 is disabled
> >>>> https://bugs.squid-cache.org/show_bug.cgi?id=5154
> >>>>
> >>>> Not sure if above two bug FIXES (in between v5.7 to v6.6) are
> >>>> related to my issue.
> >>>>
> >>>> I ran netstat:
> >>>>
> >>>> # netstat -ntlp
> >>>> Active Internet connections (only servers)
> >>>> Proto Recv-Q Send-Q Local Address           Foreign Address
> >>>> State       PID/Program name
> >>>> ...
> >>>> tcp6      33      0 :::3137 :::*                    LISTEN -
> >>>> tcp6       0      0 :::3136 :::*                    LISTEN -
> >>>> tcp6       4      0 :::3128 :::*                    LISTEN -
> >>>> tcp6       0      0 :::8081 :::*                    LISTEN -
> >>>> tcp6       0      0 :::8080 :::*                    LISTEN -
> >>>> tcp6       0      0 :::8083 :::*                    LISTEN -
> >>>> tcp6       0      0 :::8082 :::*                    LISTEN -
> >>>> tcp6       0      0 :::8084 :::*                    LISTEN -
> >>>> tcp6    4097      0 :::8093 :::*                    LISTEN -
> >>>> tcp6       0      0 :::8092 :::*                    LISTEN -
> >>>> tcp6       0      0 :::8094 :::*                    LISTEN -
> >>>> ...
> >>>>
> >>>> I do not have IPv6 enabled, yet there are 33 and 4097 numbers in
> >>>> Recv-Q and also no process/PID owns these ports.
> >>>>
> >>>> Same IPv4 ports are not shown in use by netstat, so only IPv6 ports
> >>>> remain open, that too orphaned!
> >>>>
> >>>> So what is happening?
> >>>>
> >>>> Any idea to solve or any workaround?
> >>>>
> >>>> Thank you,
> >>>>
> >>>> Amish.
> >> _______________________________________________
> >> squid-users mailing list
> >> squid-users at lists.squid-cache.org
> >> https://lists.squid-cache.org/listinfo/squid-users
> >
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> https://lists.squid-cache.org/listinfo/squid-users
>


-- 
    Francesco
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20231221/71f31e3f/attachment.htm>

From anon.amish at gmail.com  Thu Dec 21 12:59:59 2023
From: anon.amish at gmail.com (Amish)
Date: Thu, 21 Dec 2023 18:29:59 +0530
Subject: [squid-users] squid hangs and dies and can not be killed -
 needs system reboot
In-Reply-To: <CA+Y8hcNmB+Nybhye9qypmNJXK6858_CovrJ8xginx7As6fAeZA@mail.gmail.com>
References: <9c9c6491-9c3c-46ff-8026-0318fa7af19c@gmail.com>
 <27d80d95-0a33-4a65-a5d8-bed1fef2b6db@measurement-factory.com>
 <d7be2652-18ce-42fc-9156-7c4fcacb3f63@gmail.com>
 <61d0bb96-9d31-4c67-b071-c99250714dff@measurement-factory.com>
 <add5fbda-db7f-42f2-8225-66a87cc81e12@gmail.com>
 <CA+Y8hcNmB+Nybhye9qypmNJXK6858_CovrJ8xginx7As6fAeZA@mail.gmail.com>
Message-ID: <58b7de48-3cd5-44b8-b574-dce10cd2181e@gmail.com>


On 21/12/23 17:55, Francesco Chemolli wrote:
> Hi Amish,
> ? the message you posted really looks like a kernel bug, possibly due 
> to faulty code, or resulting from a hardware problem.
> Nothing squid can do can cause that kind of stack traces in kernel-space.
>
> A quick search online results in 
> https://lkml.kernel.org/netdev/20230526163458.2880232-1-edumazet at google.com/T/ 
> , which looks very much like your message
>
Yes even I believe so but I wonder, why only after updating to squid 6.6?

Regards

Amish.

> On Thu, Dec 21, 2023 at 1:10?PM Amish <anon.amish at gmail.com> wrote:
>
>     Hi Alex,
>
>     Sorry for late reply. But this is a production system and hence
>     debugging is tough. May take few days.
>
>     However I noticed that everytime squid hangs (goes dead), the
>     dmesg has
>     these errors.
>
>     [63567.802188] divide error: 0000 [#1] PREEMPT SMP PTI
>     [63567.802215] CPU: 3 PID: 617 Comm: squid Not tainted
>     6.6.7-arch1-1 #1
>     4505c4baa0b3d7c4037b0e8f5402626fa360717f
>     [63567.802238] Hardware name: Gigabyte Technology Co., Ltd.
>     H81M-S/H81M-S, BIOS F2 08/19/2015
>     [63567.802255] RIP: 0010:tcp_rcv_space_adjust+0xbe/0x160
>     [63567.802267] Code: f8 41 89 d0 29 d0 31 d2 49 0f af c2 49 f7 f0
>     45 8b
>     81 bc 04 00 00 44 0f b6 8b 10 06 00 00 31 d2 49 8d 04 42 48 98 48
>     c1 e0
>     08 <49> f7 f1 49 63 d0
>     48 98 48 39 d0 48 0f 47 c2 39 83 18 01 00 00 7c
>     [63567.802287] RSP: 0018:ffffba9f00da3c18 EFLAGS: 00010206
>     [63567.802296] RAX: 0000000004fb2800 RBX: ffff9e124acc1c80 RCX:
>     0000000eccd9dace
>     [63567.802304] RDX: 0000000000000000 RSI: 0000000037fa4ae8 RDI:
>     0000000000008349
>     [63567.802314] RBP: ffff9e124acc1c80 R08: 0000000000600000 R09:
>     0000000000000000
>     [63567.802322] R10: 00000000000161d2 R11: ffff9e1346621700 R12:
>     0000000000000000
>     [63567.802331] R13: ffff9e124acc1d58 R14: 0000000000000000 R15:
>     ffff9e124acc2214
>     [63567.802340] FS:? 00007fc3d627c840(0000) GS:ffff9e1457380000(0000)
>     knlGS:0000000000000000
>     [63567.802350] CS:? 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
>     [63567.802358] CR2: 0000560b7e86d690 CR3: 0000000102f44001 CR4:
>     00000000001706e0
>     [63567.802367] Call Trace:
>     [63567.802372]? <TASK>
>     [63567.802378]? ? die+0x36/0x90
>     [63567.802386]? ? do_trap+0xda/0x100
>     [63567.802392]? ? tcp_rcv_space_adjust+0xbe/0x160
>     [63567.802401]? ? do_error_trap+0x6a/0x90
>     [63567.802408]? ? tcp_rcv_space_adjust+0xbe/0x160
>     [63567.802415]? ? exc_divide_error+0x38/0x50
>     [63567.802423]? ? tcp_rcv_space_adjust+0xbe/0x160
>     [63567.802431]? ? asm_exc_divide_error+0x1a/0x20
>     [63567.802441]? ? tcp_rcv_space_adjust+0xbe/0x160
>     [63567.802449]? ? tcp_rcv_space_adjust+0x1a/0x160
>     [63567.802456]? tcp_recvmsg_locked+0x2d4/0x960
>     [63567.802464]? tcp_recvmsg+0x87/0x1f0
>     [63567.802471]? inet6_recvmsg+0x56/0x130
>     [63567.802479]? ? __pfx_bpf_lsm_socket_recvmsg+0x10/0x10
>     [63567.802488]? ? security_socket_recvmsg+0x44/0x70
>     [63567.802497]? sock_recvmsg+0x57/0xd0
>     [63567.802505]? sock_read_iter+0x96/0x100
>     [63567.802513]? vfs_read+0x303/0x350
>     [63567.802796]? ksys_read+0xbb/0xf0
>     [63567.803074]? do_syscall_64+0x60/0x90
>     [63567.803346]? ? syscall_exit_to_user_mode+0x2b/0x40
>     [63567.803619]? ? do_syscall_64+0x6c/0x90
>     [63567.803890]? ? syscall_exit_to_user_mode+0x2b/0x40
>     [63567.804163]? ? do_syscall_64+0x6c/0x90
>     [63567.804438]? ? do_syscall_64+0x6c/0x90
>     [63567.804710]? entry_SYSCALL_64_after_hwframe+0x6e/0xd8
>     [63567.804984] RIP: 0033:0x7fc3d5f21531
>     [63567.805271] Code: ff ff eb c3 67 e8 2f c9 01 00 66 2e 0f 1f 84
>     00 00
>     00 00 00 0f 1f 44 00 00 f3 0f 1e fa 80 3d 35 ce 0d 00 00 74 13 31
>     c0 0f
>     05 <48> 3d 00 f0 ff ff
>     77 57 c3 66 0f 1f 44 00 00 48 83 ec 28 48 89 54
>     [63567.805909] RSP: 002b:00007fffa66f6748 EFLAGS: 00000246 ORIG_RAX:
>     0000000000000000
>     [63567.806225] RAX: ffffffffffffffda RBX: 00007fffa66f6830 RCX:
>     00007fc3d5f21531
>     [63567.806542] RDX: 000000000000191a RSI: 000055d106003d80 RDI:
>     00000000000000bd
>     [63567.806855] RBP: 000055d10620bc30 R08: 000055d10620bc30 R09:
>     000055d1036a8e78
>     [63567.807163] R10: 000055d1037ad630 R11: 0000000000000246 R12:
>     000000000000191a
>     [63567.807472] R13: 000055d10664f410 R14: 000055d106003d80 R15:
>     00007fc3d627c6b8
>     [63567.807768]? </TASK>
>     [63567.808037] Modules linked in: nfnetlink_queue
>     nf_conntrack_netlink
>     xt_connmark xt_mark ip_set_hash_net xt_NFQUEUE xt_set ip_set_hash_ip
>     ip_set cls_fw sch_sfq sch_h
>     tb nf_nat_ftp nf_conntrack_ftp tls tun cfg80211 rfkill nft_chain_nat
>     xt_MASQUERADE xt_nat xt_REDIRECT nf_nat nft_limit xt_limit
>     xt_conntrack
>     nf_conntrack nf_defrag_ipv
>     6 nf_defrag_ipv4 xt_multiport xt_tcpudp nft_compat nf_tables
>     libcrc32c
>     intel_rapl_msr intel_rapl_common x86_pkg_temp_thermal
>     intel_powerclamp
>     snd_hda_codec_realtek cor
>     etemp snd_hda_codec_generic ledtrig_audio snd_hda_codec_hdmi
>     kvm_intel
>     snd_hda_intel kvm snd_intel_dspcfg snd_intel_sdw_acpi irqbypass
>     snd_hda_codec snd_hda_core crct1
>     0dif_pclmul r8169 crc32_pclmul snd_hwdep polyval_clmulni snd_pcm
>     polyval_generic gf128mul snd_timer realtek ax88179_178a spi_nor
>     mdio_devres usbnet snd libphy ghash_cl
>     mulni_intel mtd sha512_ssse3 at24 soundcore mii mei_pxp mei_hdcp
>     sha256_ssse3 sha1_ssse3 iTCO_wdt i2c_i801 mei_me spi_intel_platform
>     mousedev aesni_intel intel_pmc_bxt
>     ??spi_intel iTCO_vendor_support
>     [63567.808076]? i2c_smbus mei crypto_simd lpc_ich cryptd rapl
>     intel_cstate intel_uncore psmouse mac_hid pcspkr pkcs8_key_parser
>     fuse
>     dm_mod loop nfnetlink ip_tables x_
>     tables ext4 crc32c_generic crc16 mbcache jbd2 i915 serio_raw
>     i2c_algo_bit atkbd drm_buddy libps2 ttm vivaldi_fmap intel_gtt
>     xhci_pci
>     crc32c_intel drm_display_helper xh
>     ci_pci_renesas cec i8042 video serio wmi
>     [63567.811333] ---[ end trace 0000000000000000 ]---
>     [63567.811701] RIP: 0010:tcp_rcv_space_adjust+0xbe/0x160
>     [63567.812069] Code: f8 41 89 d0 29 d0 31 d2 49 0f af c2 49 f7 f0
>     45 8b
>     81 bc 04 00 00 44 0f b6 8b 10 06 00 00 31 d2 49 8d 04 42 48 98 48
>     c1 e0
>     08 <49> f7 f1 49 63 d0
>     48 98 48 39 d0 48 0f 47 c2 39 83 18 01 00 00 7c
>     [63567.812848] RSP: 0018:ffffba9f00da3c18 EFLAGS: 00010206
>     [63567.813252] RAX: 0000000004fb2800 RBX: ffff9e124acc1c80 RCX:
>     0000000eccd9dace
>     [63567.813651] RDX: 0000000000000000 RSI: 0000000037fa4ae8 RDI:
>     0000000000008349
>     [63567.814064] RBP: ffff9e124acc1c80 R08: 0000000000600000 R09:
>     0000000000000000
>     [63567.814470] R10: 00000000000161d2 R11: ffff9e1346621700 R12:
>     0000000000000000
>     [63567.814879] R13: ffff9e124acc1d58 R14: 0000000000000000 R15:
>     ffff9e124acc2214
>     [63567.815290] FS:? 00007fc3d627c840(0000) GS:ffff9e1457380000(0000)
>     knlGS:0000000000000000
>     [63567.815700] CS:? 0010 DS: 0000 ES: 0000 CR0: 0000000080050033
>     [63567.816121] CR2: 0000560b7e86d690 CR3: 0000000102f44001 CR4:
>     00000000001706e0
>
>     After this the "child" squid process can not be killed, even by
>     systemd,
>     even by kill -9.
>
>     It appears that squid "main" process (owned by root user) does not
>     hang
>     and hence connections on port 8080 are accepted.
>
>     But squid child process (owned by proxy user) hangs and never
>     recovers
>     after above dmesg. And hence nothing happens and connection times out.
>
>     # ps aux |grep squid
>     root???????? 612? 0.0? 0.2? 75500 23680 ???????? Ss?? Dec20 0:02
>     /usr/bin/squid -f /etc/squid/btnet/squid.btnet.conf --foreground -sYC
>     proxy??????? 617? 0.0? 0.0????? 0???? 0 ???????? D??? Dec20 1:00
>     [squid]
>     proxy??????? 620? 0.0? 0.0? 12152? 7552 ???????? S??? Dec20 0:00
>     (security_file_certgen) -s /var/cache/squid/ssl_db -M 4MB
>     proxy??????? 621? 0.0? 0.0? 12152? 7552 ???????? S??? Dec20 0:00
>     (security_file_certgen) -s /var/cache/squid/ssl_db -M 4MB
>     proxy??????? 622? 0.0? 0.0? 11888? 5504 ???????? S??? Dec20 0:00
>     (security_file_certgen) -s /var/cache/squid/ssl_db -M 4MB
>     proxy??????? 623? 0.0? 0.0? 11888? 5632 ???????? S??? Dec20 0:00
>     (security_file_certgen) -s /var/cache/squid/ssl_db -M 4MB
>     proxy??????? 624? 0.0? 0.0? 11888? 5632 ???????? S??? Dec20 0:00
>     (security_file_certgen) -s /var/cache/squid/ssl_db -M 4MB
>     proxy??????? 643? 0.0? 0.0?? 6116? 3200 ???????? S??? Dec20 0:01
>     (logfile-daemon) /var/log/squid/access.log
>
>     # telnet 127.0.0.1 8080
>     Trying 127.0.0.1...
>     Connected to 127.0.0.1.
>     Escape character is '^]'.
>     ^]
>     telnet> c
>
>     # curl -x 127.0.0.1:8080 <http://127.0.0.1:8080> --max-time 30
>     https://google.com
>     curl: (28) Connection timed out after 30002 milliseconds
>
>     # kill 612 617
>
>     Ran kill 5 times, nothing happened. All squid processes remained.
>
>     # kill -9 612 617
>
>     Ran once, and all squid processes except 617 (child squid process)
>     got
>     killed
>
>     # ps aux |grep squid
>     proxy??????? 617? 0.0? 0.0????? 0???? 0 ???????? D??? Dec20 1:00
>     [squid]
>     root?????? 90764? 0.0? 0.0?? 6552? 2560 pts/5??? S+?? 17:36 0:00 grep
>     --color=auto squid
>
>     Can above information be of any help?
>
>     Thanks and regards,
>
>     Amish
>
>     On 19/12/23 20:46, Alex Rousskov wrote:
>     > On 2023-12-18 22:29, Amish wrote:
>     >> On 19/12/23 01:14, Alex Rousskov wrote:
>     >>> On 2023-12-18 09:35, Amish wrote:
>     >>>
>     >>>> I use Arch Linux and today I updated squid from squid 5.7 to
>     squid
>     >>>> 6.6.
>     >>>
>     >>> > Dec 18 13:01:24 mumbai squid[604]: kick abandoning conn199
>     >>>
>     >>> I do not know whether the above problem is the primary problem in
>     >>> your setup, but it is a red flag. Transactions on the same
>     >>> connection may get stuck after that message; it is essentially a
>     >>> Squid bug.
>     >>>
>     >>> I am not sure at all, but this bug might be related to Bug 5187
>     >>> workaround that went into Squid v6.2 (commit c44cfe7):
>     >>> https://bugs.squid-cache.org/show_bug.cgi?id=5187
>     >>>
>     >>> Does Squid accept new TCP connections after it enters what you
>     >>> describe as a dead state? For example, does "telnet 127.0.0.1
>     8080"
>     >>> establishes a connection if executed on the same machine as Squid?
>     >>>
>     >> Yes it establishes connection. But I do not know what to do next.
>     >
>     > This tells us that your Squid is still listening for incoming
>     > connections. Most likely, it is not "dead" but running and just
>     unable
>     > to make progress with those connections (for yet unknown reasons).
>     > That information is helpful but not sufficient (for me) to solve
>     the
>     > problem you are describing.
>     >
>     > The next step that I would recommend is to collect debugging
>     > information from the running process and share a pointer to the
>     > corresponding compressed cache.log file:
>     >
>     > * Ideally, start collection when Squid starts and reproduce the
>     > problem while collecting full debugging information:
>     > http://wiki.squid-cache.org/SquidFaq/BugReporting#full-debug-output
>     >
>     > * If you have to, start collection after Squid is already in bad
>     state
>     > and just before you use telnet or browser to tickle Squid:
>     >
>     http://wiki.squid-cache.org/SquidFaq/BugReporting#debugging-a-single-transaction
>
>     >
>     >
>     > Do not use any secret information (e.g., production certificate
>     keys)
>     > for these tests (unless you are going to share the logs
>     privately with
>     > those you trust).
>     >
>     > Do not downgrade to v5 for these tests.
>     >
>     >
>     > HTH,
>     >
>     > Alex.
>     >
>     >
>     >> Browser showed "Connection timed out" message. But I believe
>     >> browser's also connected but nothing happened afterwards.
>     >>
>     >>>
>     >>> > kill -9 does nothing
>     >>>
>     >>> Is it possible that you are trying to kill the wrong process? You
>     >>> should be killing this process AFAICT:
>     >>>
>     >>> > root???????? 601? 0.0? 0.2? 73816 22528 ???????? Ss 12:59 0:02
>     >>> > /usr/bin/squid -f /etc/squid/btnet/squid.btnet.conf
>     --foreground -sYC
>     >>
>     >> I did not clarify but all processes needed SIGKILL and vanished
>     >> except the Dead squid process which still remained.
>     >>
>     >> # systemctl stop squid
>     >>
>     >> Dec 19 08:46:38 mumbai systemd[1]: squid.service: State
>     >> 'stop-sigterm' timed out. Killing.
>     >> Dec 19 08:46:38 mumbai systemd[1]: squid.service: Killing
>     process 601
>     >> (squid) with signal SIGKILL.
>     >> Dec 19 08:46:38 mumbai systemd[1]: squid.service: Killing
>     process 604
>     >> (squid) with signal SIGKILL.
>     >> Dec 19 08:46:38 mumbai systemd[1]: squid.service: Killing
>     process 607
>     >> (security_file_c) with signal SIGKILL.
>     >> Dec 19 08:46:38 mumbai systemd[1]: squid.service: Killing
>     process 608
>     >> (security_file_c) with signal SIGKILL.
>     >> Dec 19 08:46:38 mumbai systemd[1]: squid.service: Killing
>     process 609
>     >> (security_file_c) with signal SIGKILL.
>     >> Dec 19 08:46:38 mumbai systemd[1]: squid.service: Killing
>     process 610
>     >> (security_file_c) with signal SIGKILL.
>     >> Dec 19 08:46:38 mumbai systemd[1]: squid.service: Killing
>     process 611
>     >> (security_file_c) with signal SIGKILL.
>     >> Dec 19 08:46:38 mumbai systemd[1]: squid.service: Killing
>     process 622
>     >> (log_file_daemon) with signal SIGKILL.
>     >> Dec 19 08:46:38 mumbai systemd[1]: squid.service: Main process
>     >> exited, code=killed, status=9/KILL
>     >> Dec 19 08:46:38 mumbai systemd[1]: squid.service: Killing
>     process 604
>     >> (squid) with signal SIGKILL.
>     >>
>     >> Waited for 2 minutes for squid to stop then pressed ctrl-c to
>     >> systemctl stop squid command.
>     >>
>     >> As you can see in last line shows that attempt was made to kill
>     DEAD
>     >> process with PID 604.
>     >>
>     >> # ps aux |grep squid
>     >> proxy??????? 604? 0.0? 0.0????? 0???? 0 ???????? D Dec18 0:03
>     [squid]
>     >>
>     >> Now only DEAD squid process remains.
>     >>
>     >> What next? Should I downgrade to 5.9 and check?
>     >>
>     >> Regards
>     >>
>     >> Amish
>     >>
>     >>> Alex.
>     >>>
>     >>>
>     >>>> After the update from 5.7 to 6.6, squid starts but then reaches
>     >>>> Dead state in a minute or two.
>     >>>>
>     >>>> # ps aux | grep squid
>     >>>> root???????? 601? 0.0? 0.2? 73816 22528 ???????? Ss?? 12:59 0:02
>     >>>> /usr/bin/squid -f /etc/squid/btnet/squid.btnet.conf
>     --foreground -sYC
>     >>>> proxy??????? 604? 0.0? 0.0????? 0???? 0 ???????? D??? 12:59 0:03
>     >>>> [squid]
>     >>>> proxy??????? 607? 0.0? 0.0? 11976? 7424 ???????? S??? 12:59 0:00
>     >>>> (security_file_certgen) -s /var/cache/squid/ssl_db -M 4MB
>     >>>> proxy??????? 608? 0.0? 0.0? 11976? 7168 ???????? S??? 12:59 0:00
>     >>>> (security_file_certgen) -s /var/cache/squid/ssl_db -M 4MB
>     >>>> proxy??????? 609? 0.0? 0.0? 11712? 5632 ???????? S??? 12:59 0:00
>     >>>> (security_file_certgen) -s /var/cache/squid/ssl_db -M 4MB
>     >>>> proxy??????? 610? 0.0? 0.0? 11712? 5376 ???????? S??? 12:59 0:00
>     >>>> (security_file_certgen) -s /var/cache/squid/ssl_db -M 4MB
>     >>>> proxy??????? 611? 0.0? 0.0? 11712? 5504 ???????? S??? 12:59 0:00
>     >>>> (security_file_certgen) -s /var/cache/squid/ssl_db -M 4MB
>     >>>> proxy??????? 622? 0.0? 0.0?? 6116? 3200 ???????? S??? 12:59 0:00
>     >>>> (logfile-daemon) /var/log/squid/access.log
>     >>>>
>     >>>> And then all requests get stuck. Notice the D (dead) state of
>     squid.
>     >>>>
>     >>>> I use multiple ports for multiple purposes. (It all worked
>     fine in
>     >>>> squid 5.7)
>     >>>>
>     >>>> Dec 18 12:59:10 mumbai squid[601]: Starting Authentication on
>     port
>     >>>> [::]:3128
>     >>>> Dec 18 12:59:10 mumbai squid[601]: Disabling Authentication
>     on port
>     >>>> [::]:3128 (interception enabled)
>     >>>> Dec 18 12:59:10 mumbai squid[601]: Starting Authentication on
>     port
>     >>>> [::]:8081
>     >>>> Dec 18 12:59:10 mumbai squid[601]: Disabling Authentication
>     on port
>     >>>> [::]:8081 (interception enabled)
>     >>>> Dec 18 12:59:12 mumbai squid[601]: Starting Authentication on
>     port
>     >>>> [::]:8082
>     >>>> Dec 18 12:59:12 mumbai squid[601]: Disabling Authentication
>     on port
>     >>>> [::]:8082 (interception enabled)
>     >>>> Dec 18 12:59:12 mumbai squid[601]: Starting Authentication on
>     port
>     >>>> [::]:8083
>     >>>> Dec 18 12:59:12 mumbai squid[601]: Disabling Authentication
>     on port
>     >>>> [::]:8083 (interception enabled)
>     >>>> Dec 18 12:59:13 mumbai squid[601]: Starting Authentication on
>     port
>     >>>> [::]:8084
>     >>>> Dec 18 12:59:13 mumbai squid[601]: Disabling Authentication
>     on port
>     >>>> [::]:8084 (interception enabled)
>     >>>> Dec 18 12:59:13 mumbai squid[601]: Starting Authentication on
>     port
>     >>>> [::]:3136
>     >>>> Dec 18 12:59:13 mumbai squid[601]: Disabling Authentication
>     on port
>     >>>> [::]:3136 (interception enabled)
>     >>>> Dec 18 12:59:13 mumbai squid[601]: Starting Authentication on
>     port
>     >>>> [::]:3137
>     >>>> Dec 18 12:59:13 mumbai squid[601]: Disabling Authentication
>     on port
>     >>>> [::]:3137 (interception enabled)
>     >>>> ...
>     >>>> Dec 18 12:59:29 mumbai squid[604]: Adaptation support is on
>     >>>> Dec 18 12:59:29 mumbai squid[604]: Accepting NAT intercepted
>     HTTP
>     >>>> Socket connections at conn19 local=[::]:3128 remote=[::] FD 27
>     >>>> flags=41
>     >>>> listening port: 3128
>     >>>> Dec 18 12:59:29 mumbai squid[604]: Accepting SSL bumped HTTP
>     Socket
>     >>>> connections at conn21 local=[::]:8080 remote=[::] FD 28 flags=9
>     >>>> listening port: 8080
>     >>>> Dec 18 12:59:29 mumbai squid[604]: Accepting NAT intercepted SSL
>     >>>> bumped HTTPS Socket connections at conn23 local=[::]:8081
>     >>>> remote=[::] FD 29 flags=41
>     >>>> listening port: 8081
>     >>>> Dec 18 12:59:29 mumbai squid[604]: Accepting SSL bumped HTTP
>     Socket
>     >>>> connections at conn25 local=[::]:8092 remote=[::] FD 30 flags=9
>     >>>> listening port: 8092
>     >>>> Dec 18 12:59:29 mumbai systemd[1]: Started Squid Web Proxy
>     Server.
>     >>>> Dec 18 12:59:29 mumbai squid[604]: Accepting SSL bumped HTTP
>     Socket
>     >>>> connections at conn27 local=[::]:8093 remote=[::] FD 31 flags=9
>     >>>> listening port: 8093
>     >>>> Dec 18 12:59:29 mumbai squid[604]: Accepting SSL bumped HTTP
>     Socket
>     >>>> connections at conn29 local=[::]:8094 remote=[::] FD 32 flags=9
>     >>>> listening port: 8094
>     >>>> Dec 18 12:59:29 mumbai squid[604]: Accepting NAT intercepted SSL
>     >>>> bumped HTTPS Socket connections at conn31 local=[::]:8082
>     >>>> remote=[::] FD 33 flags=41
>     >>>> listening port: 8082
>     >>>> Dec 18 12:59:29 mumbai squid[604]: Accepting NAT intercepted SSL
>     >>>> bumped HTTPS Socket connections at conn33 local=[::]:8083
>     >>>> remote=[::] FD 34 flags=41
>     >>>> listening port: 8083
>     >>>> Dec 18 12:59:29 mumbai squid[604]: Accepting NAT intercepted SSL
>     >>>> bumped HTTPS Socket connections at conn35 local=[::]:8084
>     >>>> remote=[::] FD 35 flags=41
>     >>>> listening port: 8084
>     >>>> Dec 18 12:59:29 mumbai squid[604]: Accepting NAT intercepted
>     HTTP
>     >>>> Socket connections at conn37 local=[::]:3136 remote=[::] FD 36
>     >>>> flags=41
>     >>>> listening port: 3136
>     >>>> Dec 18 12:59:29 mumbai squid[604]: Accepting NAT intercepted
>     HTTP
>     >>>> Socket connections at conn39 local=[::]:3137 remote=[::] FD 37
>     >>>> flags=41
>     >>>> listening port: 3137
>     >>>>
>     >>>> And then following errors came:
>     >>>>
>     >>>>
>     >>>> Dec 18 12:59:45 mumbai squid[604]: ERROR: failure while
>     accepting a
>     >>>> TLS connection on conn41 local=192.168.0.1:8080
>     <http://192.168.0.1:8080>
>     >>>> remote=192.168.0.111:53867 <http://192.168.0.111:53867> FD 12
>     flags=1: SQUID_TLS
>     >>>> _ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
>     >>>> current master transaction:
>     >>>> master53
>     >>>> Dec 18 12:59:45 mumbai squid[604]: ERROR: failure while
>     accepting a
>     >>>> TLS connection on conn42 local=192.168.0.1:8080
>     <http://192.168.0.1:8080>
>     >>>> remote=192.168.0.111:53868 <http://192.168.0.111:53868> FD 14
>     flags=1: SQUID_TLS
>     >>>> _ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
>     >>>> current master transaction:
>     >>>> master53
>     >>>> Dec 18 12:59:45 mumbai squid[604]: ERROR: failure while
>     accepting a
>     >>>> TLS connection on conn43 local=192.168.0.1:8080
>     <http://192.168.0.1:8080>
>     >>>> remote=192.168.0.111:53869 <http://192.168.0.111:53869> FD 16
>     flags=1: SQUID_TLS
>     >>>> _ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
>     >>>> current master transaction:
>     >>>> master57
>     >>>> Dec 18 12:59:45 mumbai squid[604]: ERROR: failure while
>     accepting a
>     >>>> TLS connection on conn44 local=192.168.0.1:8080
>     <http://192.168.0.1:8080>
>     >>>> remote=192.168.0.111:53870 <http://192.168.0.111:53870> FD 12
>     flags=1: SQUID_TLS
>     >>>> _ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
>     >>>> current master transaction:
>     >>>> master57
>     >>>> Dec 18 12:59:56 mumbai squid[604]: ERROR: failure while
>     accepting a
>     >>>> TLS connection on conn62 local=192.168.0.1:8080
>     <http://192.168.0.1:8080>
>     >>>> remote=192.168.0.111:53887 <http://192.168.0.111:53887> FD 12
>     flags=1: SQUID_TLS
>     >>>> _ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
>     >>>> current master transaction:
>     >>>> master95
>     >>>> Dec 18 12:59:59 mumbai squid[604]: ERROR: failure while
>     accepting a
>     >>>> TLS connection on conn64 local=192.168.0.1:8080
>     <http://192.168.0.1:8080>
>     >>>> remote=192.168.0.111:53888 <http://192.168.0.111:53888> FD 12
>     flags=1: SQUID_TLS
>     >>>> _ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
>     >>>> current master transaction:
>     >>>> master99
>     >>>> Dec 18 13:00:02 mumbai squid[604]: ERROR: failure while
>     accepting a
>     >>>> TLS connection on conn65 local=192.168.0.1:8080
>     <http://192.168.0.1:8080>
>     >>>> remote=192.168.0.178:56115 <http://192.168.0.178:56115> FD 12
>     flags=1: SQUID_TLS
>     >>>> _ERR_ACCEPT+TLS_LIB_ERR=A000418+TLS_IO_ERR=1
>     >>>> current master transaction:
>     >>>> master53
>     >>>> Dec 18 13:01:24 mumbai squid[604]: kick abandoning conn199
>     >>>> local=192.168.0.1:8093 <http://192.168.0.1:8093>
>     remote=192.168.0.101:52211 <http://192.168.0.101:52211> FD 52 flags=1
>     >>>> connection: conn199
>     >>>> local=192.168.0.1:8093 <http://192.168.0.1:8093>
>     remote=192.168.0.101:52211 <http://192.168.0.101:52211> FD 52 flags=1
>     >>>> Dec 18 13:01:45 mumbai squid[604]: ERROR: failure while
>     accepting a
>     >>>> TLS connection on conn240 local=192.168.0.1:8093
>     <http://192.168.0.1:8093>
>     >>>> remote=192.168.0.111:53931 <http://192.168.0.111:53931> FD 48
>     flags=1: SQUID_TL
>     >>>> S_ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
>     >>>> current master transaction:
>     >>>> master314
>     >>>>
>     >>>>
>     >>>> After this point there is nothing in systemd journal (via:
>     >>>> journalctl -f -u squid) and same lines are in cache.log.
>     >>>>
>     >>>> Squid got stuck (DEAD state) at 13:01 and right now it 19:26 (6
>     >>>> hours passed) and squid is still in dead state.
>     >>>>
>     >>>> kill -9 or kill -ALRM or -HUP also does nothing.
>     >>>>
>     >>>> So to restart squid - I will need to restart whole system.
>     >>>>
>     >>>> I have sslbump directives but it is not really applied.
>     >>>>
>     >>>> #NOTE: nosslbump_ips below contains 192.168.0.0/24
>     <http://192.168.0.0/24> (whole LAN) so
>     >>>> effectively there is no SSL bump after step1.
>     >>>>
>     >>>> acl nosslbump_ips src 192.168.0.0/24 <http://192.168.0.0/24>
>     >>>> ssl_bump splice ssl_step1 nosslbump_ips
>     >>>> ssl_bump peek ssl_step1
>     >>>> ssl_bump splice nosslbump_domains
>     >>>> ssl_bump stare sslbump_domains
>     >>>> ssl_bump splice ssl_step2
>     >>>> ssl_bump bump all
>     >>>>
>     >>>>
>     >>>> Any idea? If anything changed from 5.7 to 6.6 that may cause
>     this
>     >>>> behaviour?
>     >>>>
>     >>>> Looking at changelog:
>     >>>>
>     >>>> Bug 5256: Intercepting port fails to accept
>     >>>> https://bugs.squid-cache.org/show_bug.cgi?id=5256
>     >>>>
>     >>>> Bug 5154: Do not open IPv6 sockets when IPv6 is disabled
>     >>>> https://bugs.squid-cache.org/show_bug.cgi?id=5154
>     >>>>
>     >>>> Not sure if above two bug FIXES (in between v5.7 to v6.6) are
>     >>>> related to my issue.
>     >>>>
>     >>>> I ran netstat:
>     >>>>
>     >>>> # netstat -ntlp
>     >>>> Active Internet connections (only servers)
>     >>>> Proto Recv-Q Send-Q Local Address Foreign Address
>     >>>> State?????? PID/Program name
>     >>>> ...
>     >>>> tcp6????? 33????? 0 :::3137 :::*??????????????????? LISTEN -
>     >>>> tcp6?????? 0????? 0 :::3136 :::*??????????????????? LISTEN -
>     >>>> tcp6?????? 4????? 0 :::3128 :::*??????????????????? LISTEN -
>     >>>> tcp6?????? 0????? 0 :::8081 :::*??????????????????? LISTEN -
>     >>>> tcp6?????? 0????? 0 :::8080 :::*??????????????????? LISTEN -
>     >>>> tcp6?????? 0????? 0 :::8083 :::*??????????????????? LISTEN -
>     >>>> tcp6?????? 0????? 0 :::8082 :::*??????????????????? LISTEN -
>     >>>> tcp6?????? 0????? 0 :::8084 :::*??????????????????? LISTEN -
>     >>>> tcp6??? 4097????? 0 :::8093 :::*??????????????????? LISTEN -
>     >>>> tcp6?????? 0????? 0 :::8092 :::*??????????????????? LISTEN -
>     >>>> tcp6?????? 0????? 0 :::8094 :::*??????????????????? LISTEN -
>     >>>> ...
>     >>>>
>     >>>> I do not have IPv6 enabled, yet there are 33 and 4097 numbers in
>     >>>> Recv-Q and also no process/PID owns these ports.
>     >>>>
>     >>>> Same IPv4 ports are not shown in use by netstat, so only IPv6
>     ports
>     >>>> remain open, that too orphaned!
>     >>>>
>     >>>> So what is happening?
>     >>>>
>     >>>> Any idea to solve or any workaround?
>     >>>>
>     >>>> Thank you,
>     >>>>
>     >>>> Amish.
>     >> _______________________________________________
>     >> squid-users mailing list
>     >> squid-users at lists.squid-cache.org
>     >> https://lists.squid-cache.org/listinfo/squid-users
>     >
>     _______________________________________________
>     squid-users mailing list
>     squid-users at lists.squid-cache.org
>     https://lists.squid-cache.org/listinfo/squid-users
>
>
>
> -- 
> ? ? Francesco
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20231221/a1b1a966/attachment.htm>

From gkinkie at gmail.com  Thu Dec 21 16:30:51 2023
From: gkinkie at gmail.com (Francesco Chemolli)
Date: Thu, 21 Dec 2023 17:30:51 +0100
Subject: [squid-users] squid hangs and dies and can not be killed -
 needs system reboot
In-Reply-To: <58b7de48-3cd5-44b8-b574-dce10cd2181e@gmail.com>
References: <9c9c6491-9c3c-46ff-8026-0318fa7af19c@gmail.com>
 <27d80d95-0a33-4a65-a5d8-bed1fef2b6db@measurement-factory.com>
 <d7be2652-18ce-42fc-9156-7c4fcacb3f63@gmail.com>
 <61d0bb96-9d31-4c67-b071-c99250714dff@measurement-factory.com>
 <add5fbda-db7f-42f2-8225-66a87cc81e12@gmail.com>
 <CA+Y8hcNmB+Nybhye9qypmNJXK6858_CovrJ8xginx7As6fAeZA@mail.gmail.com>
 <58b7de48-3cd5-44b8-b574-dce10cd2181e@gmail.com>
Message-ID: <CA+Y8hcM-JHdJRsmWv5CAvpsQQGb3W50MTTsfWGrAdUnbJf1-qw@mail.gmail.com>

I can't correlate the two changes, it might be some other external factor.

On Thu, Dec 21, 2023 at 2:00?PM Amish <anon.amish at gmail.com> wrote:

>
> On 21/12/23 17:55, Francesco Chemolli wrote:
>
> Hi Amish,
>   the message you posted really looks like a kernel bug, possibly due to
> faulty code, or resulting from a hardware problem.
> Nothing squid can do can cause that kind of stack traces in kernel-space.
>
> A quick search online results in
> https://lkml.kernel.org/netdev/20230526163458.2880232-1-edumazet at google.com/T/
> , which looks very much like your message
>
> Yes even I believe so but I wonder, why only after updating to squid 6.6?
>
> Regards
>
> Amish.
>
> On Thu, Dec 21, 2023 at 1:10?PM Amish <anon.amish at gmail.com> wrote:
>
>> Hi Alex,
>>
>> Sorry for late reply. But this is a production system and hence
>> debugging is tough. May take few days.
>>
>> However I noticed that everytime squid hangs (goes dead), the dmesg has
>> these errors.
>>
>> [63567.802188] divide error: 0000 [#1] PREEMPT SMP PTI
>> [63567.802215] CPU: 3 PID: 617 Comm: squid Not tainted 6.6.7-arch1-1 #1
>> 4505c4baa0b3d7c4037b0e8f5402626fa360717f
>> [63567.802238] Hardware name: Gigabyte Technology Co., Ltd.
>> H81M-S/H81M-S, BIOS F2 08/19/2015
>> [63567.802255] RIP: 0010:tcp_rcv_space_adjust+0xbe/0x160
>> [63567.802267] Code: f8 41 89 d0 29 d0 31 d2 49 0f af c2 49 f7 f0 45 8b
>> 81 bc 04 00 00 44 0f b6 8b 10 06 00 00 31 d2 49 8d 04 42 48 98 48 c1 e0
>> 08 <49> f7 f1 49 63 d0
>> 48 98 48 39 d0 48 0f 47 c2 39 83 18 01 00 00 7c
>> [63567.802287] RSP: 0018:ffffba9f00da3c18 EFLAGS: 00010206
>> [63567.802296] RAX: 0000000004fb2800 RBX: ffff9e124acc1c80 RCX:
>> 0000000eccd9dace
>> [63567.802304] RDX: 0000000000000000 RSI: 0000000037fa4ae8 RDI:
>> 0000000000008349
>> [63567.802314] RBP: ffff9e124acc1c80 R08: 0000000000600000 R09:
>> 0000000000000000
>> [63567.802322] R10: 00000000000161d2 R11: ffff9e1346621700 R12:
>> 0000000000000000
>> [63567.802331] R13: ffff9e124acc1d58 R14: 0000000000000000 R15:
>> ffff9e124acc2214
>> [63567.802340] FS:  00007fc3d627c840(0000) GS:ffff9e1457380000(0000)
>> knlGS:0000000000000000
>> [63567.802350] CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033
>> [63567.802358] CR2: 0000560b7e86d690 CR3: 0000000102f44001 CR4:
>> 00000000001706e0
>> [63567.802367] Call Trace:
>> [63567.802372]  <TASK>
>> [63567.802378]  ? die+0x36/0x90
>> [63567.802386]  ? do_trap+0xda/0x100
>> [63567.802392]  ? tcp_rcv_space_adjust+0xbe/0x160
>> [63567.802401]  ? do_error_trap+0x6a/0x90
>> [63567.802408]  ? tcp_rcv_space_adjust+0xbe/0x160
>> [63567.802415]  ? exc_divide_error+0x38/0x50
>> [63567.802423]  ? tcp_rcv_space_adjust+0xbe/0x160
>> [63567.802431]  ? asm_exc_divide_error+0x1a/0x20
>> [63567.802441]  ? tcp_rcv_space_adjust+0xbe/0x160
>> [63567.802449]  ? tcp_rcv_space_adjust+0x1a/0x160
>> [63567.802456]  tcp_recvmsg_locked+0x2d4/0x960
>> [63567.802464]  tcp_recvmsg+0x87/0x1f0
>> [63567.802471]  inet6_recvmsg+0x56/0x130
>> [63567.802479]  ? __pfx_bpf_lsm_socket_recvmsg+0x10/0x10
>> [63567.802488]  ? security_socket_recvmsg+0x44/0x70
>> [63567.802497]  sock_recvmsg+0x57/0xd0
>> [63567.802505]  sock_read_iter+0x96/0x100
>> [63567.802513]  vfs_read+0x303/0x350
>> [63567.802796]  ksys_read+0xbb/0xf0
>> [63567.803074]  do_syscall_64+0x60/0x90
>> [63567.803346]  ? syscall_exit_to_user_mode+0x2b/0x40
>> [63567.803619]  ? do_syscall_64+0x6c/0x90
>> [63567.803890]  ? syscall_exit_to_user_mode+0x2b/0x40
>> [63567.804163]  ? do_syscall_64+0x6c/0x90
>> [63567.804438]  ? do_syscall_64+0x6c/0x90
>> [63567.804710]  entry_SYSCALL_64_after_hwframe+0x6e/0xd8
>> [63567.804984] RIP: 0033:0x7fc3d5f21531
>> [63567.805271] Code: ff ff eb c3 67 e8 2f c9 01 00 66 2e 0f 1f 84 00 00
>> 00 00 00 0f 1f 44 00 00 f3 0f 1e fa 80 3d 35 ce 0d 00 00 74 13 31 c0 0f
>> 05 <48> 3d 00 f0 ff ff
>> 77 57 c3 66 0f 1f 44 00 00 48 83 ec 28 48 89 54
>> [63567.805909] RSP: 002b:00007fffa66f6748 EFLAGS: 00000246 ORIG_RAX:
>> 0000000000000000
>> [63567.806225] RAX: ffffffffffffffda RBX: 00007fffa66f6830 RCX:
>> 00007fc3d5f21531
>> [63567.806542] RDX: 000000000000191a RSI: 000055d106003d80 RDI:
>> 00000000000000bd
>> [63567.806855] RBP: 000055d10620bc30 R08: 000055d10620bc30 R09:
>> 000055d1036a8e78
>> [63567.807163] R10: 000055d1037ad630 R11: 0000000000000246 R12:
>> 000000000000191a
>> [63567.807472] R13: 000055d10664f410 R14: 000055d106003d80 R15:
>> 00007fc3d627c6b8
>> [63567.807768]  </TASK>
>> [63567.808037] Modules linked in: nfnetlink_queue nf_conntrack_netlink
>> xt_connmark xt_mark ip_set_hash_net xt_NFQUEUE xt_set ip_set_hash_ip
>> ip_set cls_fw sch_sfq sch_h
>> tb nf_nat_ftp nf_conntrack_ftp tls tun cfg80211 rfkill nft_chain_nat
>> xt_MASQUERADE xt_nat xt_REDIRECT nf_nat nft_limit xt_limit xt_conntrack
>> nf_conntrack nf_defrag_ipv
>> 6 nf_defrag_ipv4 xt_multiport xt_tcpudp nft_compat nf_tables libcrc32c
>> intel_rapl_msr intel_rapl_common x86_pkg_temp_thermal intel_powerclamp
>> snd_hda_codec_realtek cor
>> etemp snd_hda_codec_generic ledtrig_audio snd_hda_codec_hdmi kvm_intel
>> snd_hda_intel kvm snd_intel_dspcfg snd_intel_sdw_acpi irqbypass
>> snd_hda_codec snd_hda_core crct1
>> 0dif_pclmul r8169 crc32_pclmul snd_hwdep polyval_clmulni snd_pcm
>> polyval_generic gf128mul snd_timer realtek ax88179_178a spi_nor
>> mdio_devres usbnet snd libphy ghash_cl
>> mulni_intel mtd sha512_ssse3 at24 soundcore mii mei_pxp mei_hdcp
>> sha256_ssse3 sha1_ssse3 iTCO_wdt i2c_i801 mei_me spi_intel_platform
>> mousedev aesni_intel intel_pmc_bxt
>>   spi_intel iTCO_vendor_support
>> [63567.808076]  i2c_smbus mei crypto_simd lpc_ich cryptd rapl
>> intel_cstate intel_uncore psmouse mac_hid pcspkr pkcs8_key_parser fuse
>> dm_mod loop nfnetlink ip_tables x_
>> tables ext4 crc32c_generic crc16 mbcache jbd2 i915 serio_raw
>> i2c_algo_bit atkbd drm_buddy libps2 ttm vivaldi_fmap intel_gtt xhci_pci
>> crc32c_intel drm_display_helper xh
>> ci_pci_renesas cec i8042 video serio wmi
>> [63567.811333] ---[ end trace 0000000000000000 ]---
>> [63567.811701] RIP: 0010:tcp_rcv_space_adjust+0xbe/0x160
>> [63567.812069] Code: f8 41 89 d0 29 d0 31 d2 49 0f af c2 49 f7 f0 45 8b
>> 81 bc 04 00 00 44 0f b6 8b 10 06 00 00 31 d2 49 8d 04 42 48 98 48 c1 e0
>> 08 <49> f7 f1 49 63 d0
>> 48 98 48 39 d0 48 0f 47 c2 39 83 18 01 00 00 7c
>> [63567.812848] RSP: 0018:ffffba9f00da3c18 EFLAGS: 00010206
>> [63567.813252] RAX: 0000000004fb2800 RBX: ffff9e124acc1c80 RCX:
>> 0000000eccd9dace
>> [63567.813651] RDX: 0000000000000000 RSI: 0000000037fa4ae8 RDI:
>> 0000000000008349
>> [63567.814064] RBP: ffff9e124acc1c80 R08: 0000000000600000 R09:
>> 0000000000000000
>> [63567.814470] R10: 00000000000161d2 R11: ffff9e1346621700 R12:
>> 0000000000000000
>> [63567.814879] R13: ffff9e124acc1d58 R14: 0000000000000000 R15:
>> ffff9e124acc2214
>> [63567.815290] FS:  00007fc3d627c840(0000) GS:ffff9e1457380000(0000)
>> knlGS:0000000000000000
>> [63567.815700] CS:  0010 DS: 0000 ES: 0000 CR0: 0000000080050033
>> [63567.816121] CR2: 0000560b7e86d690 CR3: 0000000102f44001 CR4:
>> 00000000001706e0
>>
>> After this the "child" squid process can not be killed, even by systemd,
>> even by kill -9.
>>
>> It appears that squid "main" process (owned by root user) does not hang
>> and hence connections on port 8080 are accepted.
>>
>> But squid child process (owned by proxy user) hangs and never recovers
>> after above dmesg. And hence nothing happens and connection times out.
>>
>> # ps aux |grep squid
>> root         612  0.0  0.2  75500 23680 ?        Ss   Dec20   0:02
>> /usr/bin/squid -f /etc/squid/btnet/squid.btnet.conf --foreground -sYC
>> proxy        617  0.0  0.0      0     0 ?        D    Dec20   1:00 [squid]
>> proxy        620  0.0  0.0  12152  7552 ?        S    Dec20   0:00
>> (security_file_certgen) -s /var/cache/squid/ssl_db -M 4MB
>> proxy        621  0.0  0.0  12152  7552 ?        S    Dec20   0:00
>> (security_file_certgen) -s /var/cache/squid/ssl_db -M 4MB
>> proxy        622  0.0  0.0  11888  5504 ?        S    Dec20   0:00
>> (security_file_certgen) -s /var/cache/squid/ssl_db -M 4MB
>> proxy        623  0.0  0.0  11888  5632 ?        S    Dec20   0:00
>> (security_file_certgen) -s /var/cache/squid/ssl_db -M 4MB
>> proxy        624  0.0  0.0  11888  5632 ?        S    Dec20   0:00
>> (security_file_certgen) -s /var/cache/squid/ssl_db -M 4MB
>> proxy        643  0.0  0.0   6116  3200 ?        S    Dec20   0:01
>> (logfile-daemon) /var/log/squid/access.log
>>
>> # telnet 127.0.0.1 8080
>> Trying 127.0.0.1...
>> Connected to 127.0.0.1.
>> Escape character is '^]'.
>> ^]
>> telnet> c
>>
>> # curl -x 127.0.0.1:8080 --max-time 30 https://google.com
>> curl: (28) Connection timed out after 30002 milliseconds
>>
>> # kill 612 617
>>
>> Ran kill 5 times, nothing happened. All squid processes remained.
>>
>> # kill -9 612 617
>>
>> Ran once, and all squid processes except 617 (child squid process) got
>> killed
>>
>> # ps aux |grep squid
>> proxy        617  0.0  0.0      0     0 ?        D    Dec20   1:00 [squid]
>> root       90764  0.0  0.0   6552  2560 pts/5    S+   17:36   0:00 grep
>> --color=auto squid
>>
>> Can above information be of any help?
>>
>> Thanks and regards,
>>
>> Amish
>>
>> On 19/12/23 20:46, Alex Rousskov wrote:
>> > On 2023-12-18 22:29, Amish wrote:
>> >> On 19/12/23 01:14, Alex Rousskov wrote:
>> >>> On 2023-12-18 09:35, Amish wrote:
>> >>>
>> >>>> I use Arch Linux and today I updated squid from squid 5.7 to squid
>> >>>> 6.6.
>> >>>
>> >>> > Dec 18 13:01:24 mumbai squid[604]: kick abandoning conn199
>> >>>
>> >>> I do not know whether the above problem is the primary problem in
>> >>> your setup, but it is a red flag. Transactions on the same
>> >>> connection may get stuck after that message; it is essentially a
>> >>> Squid bug.
>> >>>
>> >>> I am not sure at all, but this bug might be related to Bug 5187
>> >>> workaround that went into Squid v6.2 (commit c44cfe7):
>> >>> https://bugs.squid-cache.org/show_bug.cgi?id=5187
>> >>>
>> >>> Does Squid accept new TCP connections after it enters what you
>> >>> describe as a dead state? For example, does "telnet 127.0.0.1 8080"
>> >>> establishes a connection if executed on the same machine as Squid?
>> >>>
>> >> Yes it establishes connection. But I do not know what to do next.
>> >
>> > This tells us that your Squid is still listening for incoming
>> > connections. Most likely, it is not "dead" but running and just unable
>> > to make progress with those connections (for yet unknown reasons).
>> > That information is helpful but not sufficient (for me) to solve the
>> > problem you are describing.
>> >
>> > The next step that I would recommend is to collect debugging
>> > information from the running process and share a pointer to the
>> > corresponding compressed cache.log file:
>> >
>> > * Ideally, start collection when Squid starts and reproduce the
>> > problem while collecting full debugging information:
>> > http://wiki.squid-cache.org/SquidFaq/BugReporting#full-debug-output
>> >
>> > * If you have to, start collection after Squid is already in bad state
>> > and just before you use telnet or browser to tickle Squid:
>> >
>> http://wiki.squid-cache.org/SquidFaq/BugReporting#debugging-a-single-transaction
>> >
>> >
>> > Do not use any secret information (e.g., production certificate keys)
>> > for these tests (unless you are going to share the logs privately with
>> > those you trust).
>> >
>> > Do not downgrade to v5 for these tests.
>> >
>> >
>> > HTH,
>> >
>> > Alex.
>> >
>> >
>> >> Browser showed "Connection timed out" message. But I believe
>> >> browser's also connected but nothing happened afterwards.
>> >>
>> >>>
>> >>> > kill -9 does nothing
>> >>>
>> >>> Is it possible that you are trying to kill the wrong process? You
>> >>> should be killing this process AFAICT:
>> >>>
>> >>> > root         601  0.0  0.2  73816 22528 ?        Ss 12:59 0:02
>> >>> > /usr/bin/squid -f /etc/squid/btnet/squid.btnet.conf --foreground
>> -sYC
>> >>
>> >> I did not clarify but all processes needed SIGKILL and vanished
>> >> except the Dead squid process which still remained.
>> >>
>> >> # systemctl stop squid
>> >>
>> >> Dec 19 08:46:38 mumbai systemd[1]: squid.service: State
>> >> 'stop-sigterm' timed out. Killing.
>> >> Dec 19 08:46:38 mumbai systemd[1]: squid.service: Killing process 601
>> >> (squid) with signal SIGKILL.
>> >> Dec 19 08:46:38 mumbai systemd[1]: squid.service: Killing process 604
>> >> (squid) with signal SIGKILL.
>> >> Dec 19 08:46:38 mumbai systemd[1]: squid.service: Killing process 607
>> >> (security_file_c) with signal SIGKILL.
>> >> Dec 19 08:46:38 mumbai systemd[1]: squid.service: Killing process 608
>> >> (security_file_c) with signal SIGKILL.
>> >> Dec 19 08:46:38 mumbai systemd[1]: squid.service: Killing process 609
>> >> (security_file_c) with signal SIGKILL.
>> >> Dec 19 08:46:38 mumbai systemd[1]: squid.service: Killing process 610
>> >> (security_file_c) with signal SIGKILL.
>> >> Dec 19 08:46:38 mumbai systemd[1]: squid.service: Killing process 611
>> >> (security_file_c) with signal SIGKILL.
>> >> Dec 19 08:46:38 mumbai systemd[1]: squid.service: Killing process 622
>> >> (log_file_daemon) with signal SIGKILL.
>> >> Dec 19 08:46:38 mumbai systemd[1]: squid.service: Main process
>> >> exited, code=killed, status=9/KILL
>> >> Dec 19 08:46:38 mumbai systemd[1]: squid.service: Killing process 604
>> >> (squid) with signal SIGKILL.
>> >>
>> >> Waited for 2 minutes for squid to stop then pressed ctrl-c to
>> >> systemctl stop squid command.
>> >>
>> >> As you can see in last line shows that attempt was made to kill DEAD
>> >> process with PID 604.
>> >>
>> >> # ps aux |grep squid
>> >> proxy        604  0.0  0.0      0     0 ?        D    Dec18 0:03
>> [squid]
>> >>
>> >> Now only DEAD squid process remains.
>> >>
>> >> What next? Should I downgrade to 5.9 and check?
>> >>
>> >> Regards
>> >>
>> >> Amish
>> >>
>> >>> Alex.
>> >>>
>> >>>
>> >>>> After the update from 5.7 to 6.6, squid starts but then reaches
>> >>>> Dead state in a minute or two.
>> >>>>
>> >>>> # ps aux | grep squid
>> >>>> root         601  0.0  0.2  73816 22528 ?        Ss   12:59 0:02
>> >>>> /usr/bin/squid -f /etc/squid/btnet/squid.btnet.conf --foreground -sYC
>> >>>> proxy        604  0.0  0.0      0     0 ?        D    12:59 0:03
>> >>>> [squid]
>> >>>> proxy        607  0.0  0.0  11976  7424 ?        S    12:59 0:00
>> >>>> (security_file_certgen) -s /var/cache/squid/ssl_db -M 4MB
>> >>>> proxy        608  0.0  0.0  11976  7168 ?        S    12:59 0:00
>> >>>> (security_file_certgen) -s /var/cache/squid/ssl_db -M 4MB
>> >>>> proxy        609  0.0  0.0  11712  5632 ?        S    12:59 0:00
>> >>>> (security_file_certgen) -s /var/cache/squid/ssl_db -M 4MB
>> >>>> proxy        610  0.0  0.0  11712  5376 ?        S    12:59 0:00
>> >>>> (security_file_certgen) -s /var/cache/squid/ssl_db -M 4MB
>> >>>> proxy        611  0.0  0.0  11712  5504 ?        S    12:59 0:00
>> >>>> (security_file_certgen) -s /var/cache/squid/ssl_db -M 4MB
>> >>>> proxy        622  0.0  0.0   6116  3200 ?        S    12:59 0:00
>> >>>> (logfile-daemon) /var/log/squid/access.log
>> >>>>
>> >>>> And then all requests get stuck. Notice the D (dead) state of squid.
>> >>>>
>> >>>> I use multiple ports for multiple purposes. (It all worked fine in
>> >>>> squid 5.7)
>> >>>>
>> >>>> Dec 18 12:59:10 mumbai squid[601]: Starting Authentication on port
>> >>>> [::]:3128
>> >>>> Dec 18 12:59:10 mumbai squid[601]: Disabling Authentication on port
>> >>>> [::]:3128 (interception enabled)
>> >>>> Dec 18 12:59:10 mumbai squid[601]: Starting Authentication on port
>> >>>> [::]:8081
>> >>>> Dec 18 12:59:10 mumbai squid[601]: Disabling Authentication on port
>> >>>> [::]:8081 (interception enabled)
>> >>>> Dec 18 12:59:12 mumbai squid[601]: Starting Authentication on port
>> >>>> [::]:8082
>> >>>> Dec 18 12:59:12 mumbai squid[601]: Disabling Authentication on port
>> >>>> [::]:8082 (interception enabled)
>> >>>> Dec 18 12:59:12 mumbai squid[601]: Starting Authentication on port
>> >>>> [::]:8083
>> >>>> Dec 18 12:59:12 mumbai squid[601]: Disabling Authentication on port
>> >>>> [::]:8083 (interception enabled)
>> >>>> Dec 18 12:59:13 mumbai squid[601]: Starting Authentication on port
>> >>>> [::]:8084
>> >>>> Dec 18 12:59:13 mumbai squid[601]: Disabling Authentication on port
>> >>>> [::]:8084 (interception enabled)
>> >>>> Dec 18 12:59:13 mumbai squid[601]: Starting Authentication on port
>> >>>> [::]:3136
>> >>>> Dec 18 12:59:13 mumbai squid[601]: Disabling Authentication on port
>> >>>> [::]:3136 (interception enabled)
>> >>>> Dec 18 12:59:13 mumbai squid[601]: Starting Authentication on port
>> >>>> [::]:3137
>> >>>> Dec 18 12:59:13 mumbai squid[601]: Disabling Authentication on port
>> >>>> [::]:3137 (interception enabled)
>> >>>> ...
>> >>>> Dec 18 12:59:29 mumbai squid[604]: Adaptation support is on
>> >>>> Dec 18 12:59:29 mumbai squid[604]: Accepting NAT intercepted HTTP
>> >>>> Socket connections at conn19 local=[::]:3128 remote=[::] FD 27
>> >>>> flags=41
>> >>>>                                         listening port: 3128
>> >>>> Dec 18 12:59:29 mumbai squid[604]: Accepting SSL bumped HTTP Socket
>> >>>> connections at conn21 local=[::]:8080 remote=[::] FD 28 flags=9
>> >>>>                                         listening port: 8080
>> >>>> Dec 18 12:59:29 mumbai squid[604]: Accepting NAT intercepted SSL
>> >>>> bumped HTTPS Socket connections at conn23 local=[::]:8081
>> >>>> remote=[::] FD 29 flags=41
>> >>>>                                         listening port: 8081
>> >>>> Dec 18 12:59:29 mumbai squid[604]: Accepting SSL bumped HTTP Socket
>> >>>> connections at conn25 local=[::]:8092 remote=[::] FD 30 flags=9
>> >>>>                                         listening port: 8092
>> >>>> Dec 18 12:59:29 mumbai systemd[1]: Started Squid Web Proxy Server.
>> >>>> Dec 18 12:59:29 mumbai squid[604]: Accepting SSL bumped HTTP Socket
>> >>>> connections at conn27 local=[::]:8093 remote=[::] FD 31 flags=9
>> >>>>                                         listening port: 8093
>> >>>> Dec 18 12:59:29 mumbai squid[604]: Accepting SSL bumped HTTP Socket
>> >>>> connections at conn29 local=[::]:8094 remote=[::] FD 32 flags=9
>> >>>>                                         listening port: 8094
>> >>>> Dec 18 12:59:29 mumbai squid[604]: Accepting NAT intercepted SSL
>> >>>> bumped HTTPS Socket connections at conn31 local=[::]:8082
>> >>>> remote=[::] FD 33 flags=41
>> >>>>                                         listening port: 8082
>> >>>> Dec 18 12:59:29 mumbai squid[604]: Accepting NAT intercepted SSL
>> >>>> bumped HTTPS Socket connections at conn33 local=[::]:8083
>> >>>> remote=[::] FD 34 flags=41
>> >>>>                                         listening port: 8083
>> >>>> Dec 18 12:59:29 mumbai squid[604]: Accepting NAT intercepted SSL
>> >>>> bumped HTTPS Socket connections at conn35 local=[::]:8084
>> >>>> remote=[::] FD 35 flags=41
>> >>>>                                         listening port: 8084
>> >>>> Dec 18 12:59:29 mumbai squid[604]: Accepting NAT intercepted HTTP
>> >>>> Socket connections at conn37 local=[::]:3136 remote=[::] FD 36
>> >>>> flags=41
>> >>>>                                         listening port: 3136
>> >>>> Dec 18 12:59:29 mumbai squid[604]: Accepting NAT intercepted HTTP
>> >>>> Socket connections at conn39 local=[::]:3137 remote=[::] FD 37
>> >>>> flags=41
>> >>>>                                         listening port: 3137
>> >>>>
>> >>>> And then following errors came:
>> >>>>
>> >>>>
>> >>>> Dec 18 12:59:45 mumbai squid[604]: ERROR: failure while accepting a
>> >>>> TLS connection on conn41 local=192.168.0.1:8080
>> >>>> remote=192.168.0.111:53867 FD 12 flags=1: SQUID_TLS
>> >>>> _ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
>> >>>>                                         current master transaction:
>> >>>> master53
>> >>>> Dec 18 12:59:45 mumbai squid[604]: ERROR: failure while accepting a
>> >>>> TLS connection on conn42 local=192.168.0.1:8080
>> >>>> remote=192.168.0.111:53868 FD 14 flags=1: SQUID_TLS
>> >>>> _ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
>> >>>>                                         current master transaction:
>> >>>> master53
>> >>>> Dec 18 12:59:45 mumbai squid[604]: ERROR: failure while accepting a
>> >>>> TLS connection on conn43 local=192.168.0.1:8080
>> >>>> remote=192.168.0.111:53869 FD 16 flags=1: SQUID_TLS
>> >>>> _ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
>> >>>>                                         current master transaction:
>> >>>> master57
>> >>>> Dec 18 12:59:45 mumbai squid[604]: ERROR: failure while accepting a
>> >>>> TLS connection on conn44 local=192.168.0.1:8080
>> >>>> remote=192.168.0.111:53870 FD 12 flags=1: SQUID_TLS
>> >>>> _ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
>> >>>>                                         current master transaction:
>> >>>> master57
>> >>>> Dec 18 12:59:56 mumbai squid[604]: ERROR: failure while accepting a
>> >>>> TLS connection on conn62 local=192.168.0.1:8080
>> >>>> remote=192.168.0.111:53887 FD 12 flags=1: SQUID_TLS
>> >>>> _ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
>> >>>>                                         current master transaction:
>> >>>> master95
>> >>>> Dec 18 12:59:59 mumbai squid[604]: ERROR: failure while accepting a
>> >>>> TLS connection on conn64 local=192.168.0.1:8080
>> >>>> remote=192.168.0.111:53888 FD 12 flags=1: SQUID_TLS
>> >>>> _ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
>> >>>>                                         current master transaction:
>> >>>> master99
>> >>>> Dec 18 13:00:02 mumbai squid[604]: ERROR: failure while accepting a
>> >>>> TLS connection on conn65 local=192.168.0.1:8080
>> >>>> remote=192.168.0.178:56115 FD 12 flags=1: SQUID_TLS
>> >>>> _ERR_ACCEPT+TLS_LIB_ERR=A000418+TLS_IO_ERR=1
>> >>>>                                         current master transaction:
>> >>>> master53
>> >>>> Dec 18 13:01:24 mumbai squid[604]: kick abandoning conn199
>> >>>> local=192.168.0.1:8093 remote=192.168.0.101:52211 FD 52 flags=1
>> >>>>                                         connection: conn199
>> >>>> local=192.168.0.1:8093 remote=192.168.0.101:52211 FD 52 flags=1
>> >>>> Dec 18 13:01:45 mumbai squid[604]: ERROR: failure while accepting a
>> >>>> TLS connection on conn240 local=192.168.0.1:8093
>> >>>> remote=192.168.0.111:53931 FD 48 flags=1: SQUID_TL
>> >>>> S_ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
>> >>>>                                         current master transaction:
>> >>>> master314
>> >>>>
>> >>>>
>> >>>> After this point there is nothing in systemd journal (via:
>> >>>> journalctl -f -u squid) and same lines are in cache.log.
>> >>>>
>> >>>> Squid got stuck (DEAD state) at 13:01 and right now it 19:26 (6
>> >>>> hours passed) and squid is still in dead state.
>> >>>>
>> >>>> kill -9 or kill -ALRM or -HUP also does nothing.
>> >>>>
>> >>>> So to restart squid - I will need to restart whole system.
>> >>>>
>> >>>> I have sslbump directives but it is not really applied.
>> >>>>
>> >>>> #NOTE: nosslbump_ips below contains 192.168.0.0/24 (whole LAN) so
>> >>>> effectively there is no SSL bump after step1.
>> >>>>
>> >>>> acl nosslbump_ips src 192.168.0.0/24
>> >>>> ssl_bump splice ssl_step1 nosslbump_ips
>> >>>> ssl_bump peek ssl_step1
>> >>>> ssl_bump splice nosslbump_domains
>> >>>> ssl_bump stare sslbump_domains
>> >>>> ssl_bump splice ssl_step2
>> >>>> ssl_bump bump all
>> >>>>
>> >>>>
>> >>>> Any idea? If anything changed from 5.7 to 6.6 that may cause this
>> >>>> behaviour?
>> >>>>
>> >>>> Looking at changelog:
>> >>>>
>> >>>> Bug 5256: Intercepting port fails to accept
>> >>>> https://bugs.squid-cache.org/show_bug.cgi?id=5256
>> >>>>
>> >>>> Bug 5154: Do not open IPv6 sockets when IPv6 is disabled
>> >>>> https://bugs.squid-cache.org/show_bug.cgi?id=5154
>> >>>>
>> >>>> Not sure if above two bug FIXES (in between v5.7 to v6.6) are
>> >>>> related to my issue.
>> >>>>
>> >>>> I ran netstat:
>> >>>>
>> >>>> # netstat -ntlp
>> >>>> Active Internet connections (only servers)
>> >>>> Proto Recv-Q Send-Q Local Address           Foreign Address
>> >>>> State       PID/Program name
>> >>>> ...
>> >>>> tcp6      33      0 :::3137 :::*                    LISTEN -
>> >>>> tcp6       0      0 :::3136 :::*                    LISTEN -
>> >>>> tcp6       4      0 :::3128 :::*                    LISTEN -
>> >>>> tcp6       0      0 :::8081 :::*                    LISTEN -
>> >>>> tcp6       0      0 :::8080 :::*                    LISTEN -
>> >>>> tcp6       0      0 :::8083 :::*                    LISTEN -
>> >>>> tcp6       0      0 :::8082 :::*                    LISTEN -
>> >>>> tcp6       0      0 :::8084 :::*                    LISTEN -
>> >>>> tcp6    4097      0 :::8093 :::*                    LISTEN -
>> >>>> tcp6       0      0 :::8092 :::*                    LISTEN -
>> >>>> tcp6       0      0 :::8094 :::*                    LISTEN -
>> >>>> ...
>> >>>>
>> >>>> I do not have IPv6 enabled, yet there are 33 and 4097 numbers in
>> >>>> Recv-Q and also no process/PID owns these ports.
>> >>>>
>> >>>> Same IPv4 ports are not shown in use by netstat, so only IPv6 ports
>> >>>> remain open, that too orphaned!
>> >>>>
>> >>>> So what is happening?
>> >>>>
>> >>>> Any idea to solve or any workaround?
>> >>>>
>> >>>> Thank you,
>> >>>>
>> >>>> Amish.
>> >> _______________________________________________
>> >> squid-users mailing list
>> >> squid-users at lists.squid-cache.org
>> >> https://lists.squid-cache.org/listinfo/squid-users
>> >
>> _______________________________________________
>> squid-users mailing list
>> squid-users at lists.squid-cache.org
>> https://lists.squid-cache.org/listinfo/squid-users
>>
>
>
> --
>     Francesco
>
>

-- 
    Francesco
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20231221/9692a87d/attachment.htm>

From ben.goz87 at gmail.com  Sun Dec 24 15:10:45 2023
From: ben.goz87 at gmail.com (Ben Goz)
Date: Sun, 24 Dec 2023 17:10:45 +0200
Subject: [squid-users] Squid scales up tcp traffic to adsl users
Message-ID: <CADAqQfyy-uu_tJi5TVyrYj0MbO2o+EBkvLKfWeU5KNTZtqY-2A@mail.gmail.com>

By the help of God.

Hi,
This is basically the network topology that I'm using:
 adsl <--> vrf <--> <eth1> [squid/icap machine] <eth0> <--> vrf <-->
<internet>

When traffic goes via squid I see that eth1 (The one closes to adsl users)
is very high this is from sar output:

Average:        IFACE   rxpck/s   txpck/s    rxkB/s    txkB/s   rxcmp/s
txcmp/s  rxmcst/s   %ifutil
Average:           lo   4191.83   4191.83  16976.00  16976.00      0.00
 0.00      0.00      0.00
Average:         eth0   2921.48   1224.57   3432.46    485.77      0.00
 0.00      0.00      0.28
Average:         eth1   7558.70  11544.74    920.91  *14447.44*      0.00
   0.00      0.00      1.18

When traffic doesn't go via squid this is the output:

Average:        IFACE   rxpck/s   txpck/s    rxkB/s    txkB/s   rxcmp/s
txcmp/s  rxmcst/s   %ifutil
Average:           lo     19.10     19.10      2.25      2.25      0.00
 0.00      0.00      0.00
Average:         eth0   3666.40   2133.70   4608.70    409.59      0.00
 0.00      0.00      0.38
Average:         eth1   2213.40   3741.10    424.38   *4613.08*      0.00
   0.00      0.00      0.38

I'm can't tell for sure that this is related but I saw several times the
kernel prints:
TCP: out of memory -- consider tuning tcp_mem

The squid version I'm using is:
/usr/local/squid/sbin/squid -v
Squid Cache: Version 6.5-VCS
Service Name: squid

This binary uses OpenSSL 3.0.2 15 Mar 2022. configure options:
 '--with-large-files' '--with-openssl' '--enable-ssl' '--enable-ssl-crtd'
'--enable-icap-client' '--enable-linux-netfilter' '--disable-ident-lookups'

And I turned off persistence from client, icap and server sessions.

What could be the problem?

Thanks,
Ben
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20231224/66facecd/attachment.htm>

From squid3 at treenet.co.nz  Mon Dec 25 09:11:53 2023
From: squid3 at treenet.co.nz (=?UTF-8?B?4oCqQW1vcyBKZWZmcmllc+KArA==?=)
Date: Mon, 25 Dec 2023 22:11:53 +1300
Subject: [squid-users] Squid scales up tcp traffic to adsl users
References: <CADAqQfyy-uu_tJi5TVyrYj0MbO2o+EBkvLKfWeU5KNTZtqY-2A@mail.gmail.com>
Message-ID: <-hewvisecez9y-6m08inw7sg027fevqc-aa6rt0-1k7nts-ewbhbvnf2dgof6i7sq-hpp7a9pydwc4-nsivo8-5s6pgy-7sb1kc-ywwyhv-qwb635-6mg58w-lv0hjq-40784u-rku20d-37zm2g-r6ujfe-j4vzpp.1703495513976@email.android.com>

An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20231225/28eaa3fe/attachment.htm>

From ben.goz87 at gmail.com  Sun Dec 31 11:07:20 2023
From: ben.goz87 at gmail.com (Ben Goz)
Date: Sun, 31 Dec 2023 13:07:20 +0200
Subject: [squid-users] Squid scales up tcp traffic to adsl users
In-Reply-To: <-hewvisecez9y-6m08inw7sg027fevqc-aa6rt0-1k7nts-ewbhbvnf2dgof6i7sq-hpp7a9pydwc4-nsivo8-5s6pgy-7sb1kc-ywwyhv-qwb635-6mg58w-lv0hjq-40784u-rku20d-37zm2g-r6ujfe-j4vzpp.1703495513976@email.android.com>
References: <CADAqQfyy-uu_tJi5TVyrYj0MbO2o+EBkvLKfWeU5KNTZtqY-2A@mail.gmail.com>
 <-hewvisecez9y-6m08inw7sg027fevqc-aa6rt0-1k7nts-ewbhbvnf2dgof6i7sq-hpp7a9pydwc4-nsivo8-5s6pgy-7sb1kc-ywwyhv-qwb635-6mg58w-lv0hjq-40784u-rku20d-37zm2g-r6ujfe-j4vzpp.1703495513976@email.android.com>
Message-ID: <CADAqQfxDD9qx8TjNNKGoVfu-_=rFgC3ufedreK59C82t8R+Jqw@mail.gmail.com>

By the help of God.

Sorry I forgot to say that cache is disabled in this setup and the
increasing traffic rate on the clients side can cause a bottle neck as it
reaches the maximum
rates that the customers have.
Is there any option to limit the traffic?

??????? ??? ??, 29 ????? 2023 ?-13:15 ??? ??Amos Jeffries??? <?
squid3 at treenet.co.nz??>:?

> This may be normal. A proxy cache like Squid moves objects closer to the
> clients, reduces upstream traffic and multiplexes transactions. All of
> which increase the traffic bandwidth efficiency. Allowing clients to
> receive their downloaded content faster, and thus users can browse through
> more pages faster.
>
> This type of user traffic increase can be just the result of users doing
> more.
> Notice that the WAN/eth0 traffic has decreased by ~30% despite this LAN
> increase.
> You can check the Hit Ratio in squid mgr:info report lines up with the
> increased efficiency.
>
> Cheers,
> Amos
>
>
> -------- Original message --------
> From: Ben Goz
> Date: Mon, 25 Dec 2023, 04:11
>
> Hi,
> This is basically the network topology that I'm using:
>  adsl <--> vrf <--> <eth1> [squid/icap machine] <eth0> <--> vrf <-->
> <internet>
>
> When traffic goes via squid I see that eth1 (The one closes to adsl users)
> is very high this is from sar output:
>
> Average:        IFACE   rxpck/s   txpck/s    rxkB/s    txkB/s   rxcmp/s
> txcmp/s  rxmcst/s   %ifutil
> Average:           lo   4191.83   4191.83  16976.00  16976.00      0.00
>    0.00      0.00      0.00
> Average:         eth0   2921.48   1224.57   3432.46    485.77      0.00
>    0.00      0.00      0.28
> Average:         eth1   7558.70  11544.74    920.91  *14447.44*      0.00
>      0.00      0.00      1.18
>
> When traffic doesn't go via squid this is the output:
>
> Average:        IFACE   rxpck/s   txpck/s    rxkB/s    txkB/s   rxcmp/s
> txcmp/s  rxmcst/s   %ifutil
> Average:           lo     19.10     19.10      2.25      2.25      0.00
>    0.00      0.00      0.00
> Average:         eth0   3666.40   2133.70   4608.70    409.59      0.00
>    0.00      0.00      0.38
> Average:         eth1   2213.40   3741.10    424.38   *4613.08*      0.00
>      0.00      0.00      0.38
>
> I'm can't tell for sure that this is related but I saw several times the
> kernel prints:
> TCP: out of memory -- consider tuning tcp_mem
>
> The squid version I'm using is:
> /usr/local/squid/sbin/squid -v
> Squid Cache: Version 6.5-VCS
> Service Name: squid
>
> This binary uses OpenSSL 3.0.2 15 Mar 2022. configure options:
>  '--with-large-files' '--with-openssl' '--enable-ssl' '--enable-ssl-crtd'
> '--enable-icap-client' '--enable-linux-netfilter' '--disable-ident-lookups'
>
> And I turned off persistence from client, icap and server sessions.
>
> What could be the problem?
>
> Thanks,
> Ben
>
>
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> https://lists.squid-cache.org/listinfo/squid-users
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20231231/458dd49b/attachment.htm>

