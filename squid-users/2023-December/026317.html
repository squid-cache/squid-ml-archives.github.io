<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] SSL Virtual Hosting Problem
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20SSL%20Virtual%20Hosting%20Problem&In-Reply-To=%3Cb5bcccef-c5f2-d080-c4ad-19b85ba4a3a4%40regify.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="026307.html">
   <LINK REL="Next"  HREF="026313.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] SSL Virtual Hosting Problem</H1>
    <B>Mario Theodoridis</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20SSL%20Virtual%20Hosting%20Problem&In-Reply-To=%3Cb5bcccef-c5f2-d080-c4ad-19b85ba4a3a4%40regify.com%3E"
       TITLE="[squid-users] SSL Virtual Hosting Problem">mario.theodoridis at regify.com
       </A><BR>
    <I>Mon Dec  4 10:17:16 UTC 2023</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="026307.html">[squid-users] SSL Virtual Hosting Problem
</A></li>
        <LI>Next message (by thread): <A HREF="026313.html">[squid-users] [squid-announce] [ADVISORY] SQUID-2023:7 Denial of Service in HTTP Message Processing
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26317">[ date ]</a>
              <a href="thread.html#26317">[ thread ]</a>
              <a href="subject.html#26317">[ subject ]</a>
              <a href="author.html#26317">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 01/12/23 21:34, Amos Jeffries wrote:
&gt;<i> On 1/12/23 04:55, Mario Theodoridis wrote:
</I>&gt;&gt;<i> I do have one more problem at this point.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Using openssl i can work with what i have below, but i cannot add a 
</I>&gt;&gt;<i> 2nd certificate
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> https_port 0.0.0.0:443 accel defaultsite=regify.com \
</I>&gt;&gt;<i> &#160;&#160;&#160;&#160; tls-cert=/etc/ssl/certs/regify.com.pem \
</I>&gt;&gt;<i> &#160;&#160;&#160;&#160; tls-cert=/etc/ssl/certs/foo.com.pem
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> gives me
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> ERROR: OpenSSL does not support multiple server certificates. 
</I>&gt;&gt;<i> Ignoring addional cert= parameters.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> If i instead use gnutls, i get dinged for using ssl::server
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> FATAL: Bungled /etc/squid/squid.conf line 29: acl stest1 
</I>&gt;&gt;<i> ssl::server_name test1.regify.com
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> is there a way to get the SNI host with gnutls?
</I>&gt;<i>
</I>&gt;<i> There is , but we have not yet implemented it.
</I>&gt;<i>
</I>&gt;<i> If the HTTPS URL domain is acceptable you can use the dstdomain ACL 
</I>&gt;<i> type instead as a workaround.
</I>
It would be acceptable to me, but i was under the impression, that this 
did not work with TLS.
So with the gnutls variant and the following config

debug_options ALL,2
pinger_enable off
shutdown_lifetime 1 second

acl TLS_ports port 443
acl Safe_ports port 443

https_port 0.0.0.0:443 accel defaultsite=regify.com \
 &#160;&#160;&#160; tls-cert=/etc/ssl/certs/regify.com.pem \
 &#160;&#160;&#160; tls-cert=/etc/ssl/certs/foo.com.pem

http_access deny !Safe_ports
http_access deny manager

acl stest dstdomain -n test.regify.com
http_access allow stest
cache_peer test.regify.com parent 443 0 tls \
 &#160;&#160;&#160; proxy-only originserver no-digest no-netdb-exchange name=ttest
cache_peer_access ttest allow TLS_ports stest
cache_peer_access ttest deny all

acl sfoo dstdomain -n www.foo.com
http_access allow sfoo
cache_peer www.foo.com parent 443 0 tls \
 &#160;&#160;&#160; proxy-only originserver no-digest no-netdb-exchange name=tfoo
cache_peer_access tfoo allow TLS_ports sfoo
cache_peer_access tfoo deny all

http_access deny all

curl <A HREF="https://test.regify.com/">https://test.regify.com/</A> gives me certificate errors and

2023/12/04 10:58:22.053 kid1| 5,2| TcpAcceptor.cc(224) doAccept: New 
connection on FD 12
2023/12/04 10:58:22.053 kid1| 5,2| TcpAcceptor.cc(312) acceptNext: 
connection on local=0.0.0.0:443 remote=[::] FD 12 flags=9
2023/12/04 10:58:22.054 kid1| 17,2| QosConfig.cc(125) 
getNfmarkFromConnection: QOS: Failed to retrieve connection mark: (-1) 
(1) Operation not permitted (Destination 192.168.1.123:443, source 
192.168.1.124:41380)
2023/12/04 10:58:22.075 kid1| 83,2| client_side.cc(2680) 
clientNegotiateSSL: TLS session reuse not yet implemented.
2023/12/04 10:58:22.075 kid1| 83,2| client_side.cc(2701) 
clientNegotiateSSL: Client certificate requesting not yet implemented.
2023/12/04 10:58:22.075 kid1| 11,2| client_side.cc(1306) 
parseHttpRequest: HTTP Client local=192.168.1.123:443 
remote=192.168.1.124:41380 FD 11 flags=1
2023/12/04 10:58:22.075 kid1| 11,2| client_side.cc(1307) 
parseHttpRequest: HTTP Client REQUEST:
---------
GET / HTTP/1.1
Host: test.regify.com
User-Agent: curl/7.74.0
Accept: */*


----------
2023/12/04 10:58:22.076 kid1| 85,2| client_side_request.cc(751) 
clientAccessCheckDone: The request GET <A HREF="https://test.regify.com/">https://test.regify.com/</A> is 
ALLOWED; last ACL checked: stest
2023/12/04 10:58:22.076 kid1| 85,2| client_side_request.cc(729) 
clientAccessCheck2: No adapted_http_access configuration. default: ALLOW
2023/12/04 10:58:22.076 kid1| 85,2| client_side_request.cc(751) 
clientAccessCheckDone: The request GET <A HREF="https://test.regify.com/">https://test.regify.com/</A> is 
ALLOWED; last ACL checked: stest
2023/12/04 10:58:22.076 kid1| 17,2| FwdState.cc(142) FwdState: 
Forwarding client request local=192.168.1.123:443 
remote=192.168.1.124:41380 FD 11 flags=1, url=<A HREF="https://test.regify.com/">https://test.regify.com/</A>
2023/12/04 10:58:22.076 kid1| 44,2| peer_select.cc(295) 
peerSelectDnsPaths: Find IP destination for: <A HREF="https://test.regify.com/">https://test.regify.com/</A>' 
via test.regify.com
2023/12/04 10:58:22.076 kid1| 44,2| peer_select.cc(316) 
peerSelectDnsPaths: Found sources for '<A HREF="https://test.regify.com/">https://test.regify.com/</A>'
2023/12/04 10:58:22.076 kid1| 44,2| peer_select.cc(317) 
peerSelectDnsPaths:&#160;&#160; always_direct = DENIED
2023/12/04 10:58:22.076 kid1| 44,2| peer_select.cc(318) 
peerSelectDnsPaths:&#160;&#160;&#160; never_direct = DENIED
2023/12/04 10:58:22.076 kid1| 44,2| peer_select.cc(328) 
peerSelectDnsPaths:&#160;&#160;&#160;&#160;&#160; cache_peer = local=0.0.0.0 remote=2.4.6.8:443 
flags=1
2023/12/04 10:58:22.076 kid1| 44,2| peer_select.cc(331) 
peerSelectDnsPaths:&#160;&#160;&#160;&#160;&#160;&#160;&#160; timedout = 0
2023/12/04 10:58:22.088 kid1| 83,2| PeerConnector.cc(205) negotiate: 
handshake IN: Unknown Handshake packet
2023/12/04 10:58:22.088 kid1| 83,2| PeerConnector.cc(207) negotiate: 
handshake OUT: CLIENT HELLO
2023/12/04 10:58:22.102 kid1| 83,2| PeerConnector.cc(198) negotiate: 
local=192.168.1.123:42772 remote=2.4.6.8:443 FD 13 flags=1 TLS Session 
info: (TLS1.3)-(ECDHE-SECP256R1)-(RSA-PSS-RSAE-SHA256)-(AES-256-GCM)
2023/12/04 10:58:22.102 kid1| 11,2| http.cc(2266) sendRequest: HTTP 
Server local=192.168.1.123:42772 remote=2.4.6.8:443 FD 13 flags=1
2023/12/04 10:58:22.102 kid1| 11,2| http.cc(2267) sendRequest: HTTP 
Server REQUEST:
---------
GET / HTTP/1.1
User-Agent: curl/7.74.0
Accept: */*
Host: test.regify.com
Via: 1.1 bulls.de.regify.com (squid/4.13)
Surrogate-Capability: bulls.de.regify.com=&quot;Surrogate/1.0 ESI/1.0&quot;
X-Forwarded-For: 192.168.1.124
Cache-Control: max-age=259200
Connection: keep-alive


----------
2023/12/04 10:58:22.114 kid1| 11,2| http.cc(1212) readReply: 
local=192.168.1.123:42772 remote=2.4.6.8:443 FD 13 flags=1: read 
failure: (0) No error.
2023/12/04 10:58:22.114 kid1| 17,2| FwdState.cc(681) 
handleUnregisteredServerEnd: self=0x55ef6a88f4b8*2 err=0x55ef6a89bcf8 
<A HREF="https://test.regify.com/">https://test.regify.com/</A>
2023/12/04 10:58:22.114 kid1| 4,2| errorpage.cc(1259) BuildContent: No 
existing error page language negotiated for ERR_READ_ERROR. Using 
default error file.
2023/12/04 10:58:22.114 kid1| 20,2| store.cc(985) checkCachable: 
StoreEntry::checkCachable: NO: not cachable
2023/12/04 10:58:22.114 kid1| 88,2| client_side_reply.cc(2062) 
processReplyAccessResult: The reply for GET <A HREF="https://test.regify.com/">https://test.regify.com/</A> is 
ALLOWED, because it matched all
2023/12/04 10:58:22.114 kid1| 11,2| Stream.cc(271) sendStartOfMessage: 
HTTP Client local=192.168.1.123:443 remote=192.168.1.124:41380 FD 11 flags=1
2023/12/04 10:58:22.114 kid1| 11,2| Stream.cc(272) sendStartOfMessage: 
HTTP Client REPLY:
---------
HTTP/1.1 502 Bad Gateway
Server: squid/4.13
Mime-Version: 1.0
Date: Mon, 04 Dec 2023 09:58:22 GMT
Content-Type: text/html;charset=utf-8
Content-Length: 3510
X-Squid-Error: ERR_READ_ERROR 0
Vary: Accept-Language
Content-Language: en
X-Cache: MISS from bulls.de.regify.com
X-Cache-Lookup: MISS from bulls.de.regify.com:443
Via: 1.1 bulls.de.regify.com (squid/4.13)
Connection: keep-alive


----------
2023/12/04 10:58:22.114 kid1| 20,2| store.cc(985) checkCachable: 
StoreEntry::checkCachable: NO: not cachable
2023/12/04 10:58:22.115 kid1| 20,2| store.cc(985) checkCachable: 
StoreEntry::checkCachable: NO: not cachable
2023/12/04 10:58:22.116 kid1| 33,2| client_side.cc(586) swanSong: 
local=192.168.1.123:443 remote=192.168.1.124:41380 flags=1






And curl <A HREF="https://www.foo.com">https://www.foo.com</A> yeilds also certificate errors and


2023/12/04 11:00:05.110 kid1| 5,2| TcpAcceptor.cc(224) doAccept: New 
connection on FD 12
2023/12/04 11:00:05.110 kid1| 5,2| TcpAcceptor.cc(312) acceptNext: 
connection on local=0.0.0.0:443 remote=[::] FD 12 flags=9
2023/12/04 11:00:05.111 kid1| 17,2| QosConfig.cc(125) 
getNfmarkFromConnection: QOS: Failed to retrieve connection mark: (-1) 
(1) Operation not permitted (Destination 192.168.1.123:443, source 
192.168.1.124:37526)
2023/12/04 11:00:05.133 kid1| 83,2| client_side.cc(2680) 
clientNegotiateSSL: TLS session reuse not yet implemented.
2023/12/04 11:00:05.133 kid1| 83,2| client_side.cc(2701) 
clientNegotiateSSL: Client certificate requesting not yet implemented.
2023/12/04 11:00:05.133 kid1| 11,2| client_side.cc(1306) 
parseHttpRequest: HTTP Client local=192.168.1.123:443 
remote=192.168.1.124:37526 FD 11 flags=1
2023/12/04 11:00:05.133 kid1| 11,2| client_side.cc(1307) 
parseHttpRequest: HTTP Client REQUEST:
---------
GET / HTTP/1.1
Host: www.foo.com
User-Agent: curl/7.74.0
Accept: */*


----------
2023/12/04 11:00:05.134 kid1| 85,2| client_side_request.cc(751) 
clientAccessCheckDone: The request GET <A HREF="https://www.foo.com/">https://www.foo.com/</A> is ALLOWED; 
last ACL checked: sfoo
2023/12/04 11:00:05.134 kid1| 85,2| client_side_request.cc(729) 
clientAccessCheck2: No adapted_http_access configuration. default: ALLOW
2023/12/04 11:00:05.134 kid1| 85,2| client_side_request.cc(751) 
clientAccessCheckDone: The request GET <A HREF="https://www.foo.com/">https://www.foo.com/</A> is ALLOWED; 
last ACL checked: sfoo
2023/12/04 11:00:05.134 kid1| 17,2| FwdState.cc(142) FwdState: 
Forwarding client request local=192.168.1.123:443 
remote=192.168.1.124:37526 FD 11 flags=1, url=<A HREF="https://www.foo.com/">https://www.foo.com/</A>
2023/12/04 11:00:05.134 kid1| 44,2| peer_select.cc(295) 
peerSelectDnsPaths: Find IP destination for: <A HREF="https://www.foo.com/">https://www.foo.com/</A>' via 
www.foo.com
2023/12/04 11:00:05.134 kid1| 44,2| peer_select.cc(316) 
peerSelectDnsPaths: Found sources for '<A HREF="https://www.foo.com/">https://www.foo.com/</A>'
2023/12/04 11:00:05.134 kid1| 44,2| peer_select.cc(317) 
peerSelectDnsPaths:&#160;&#160; always_direct = DENIED
2023/12/04 11:00:05.134 kid1| 44,2| peer_select.cc(318) 
peerSelectDnsPaths:&#160;&#160;&#160; never_direct = DENIED
2023/12/04 11:00:05.134 kid1| 44,2| peer_select.cc(328) 
peerSelectDnsPaths:&#160;&#160;&#160;&#160;&#160; cache_peer = local=0.0.0.0 remote=1.2.3.4:443 
flags=1
2023/12/04 11:00:05.134 kid1| 44,2| peer_select.cc(331) 
peerSelectDnsPaths:&#160;&#160;&#160;&#160;&#160;&#160;&#160; timedout = 0
2023/12/04 11:00:05.146 kid1| 83,2| PeerConnector.cc(205) negotiate: 
handshake IN: Unknown Handshake packet
2023/12/04 11:00:05.146 kid1| 83,2| PeerConnector.cc(207) negotiate: 
handshake OUT: CLIENT HELLO
2023/12/04 11:00:05.161 kid1| 83,2| PeerConnector.cc(205) negotiate: 
handshake IN: SERVER HELLO DONE
2023/12/04 11:00:05.161 kid1| 83,2| PeerConnector.cc(207) negotiate: 
handshake OUT: FINISHED
2023/12/04 11:00:05.172 kid1| 83,2| PeerConnector.cc(198) negotiate: 
local=192.168.1.123:47236 remote=1.2.3.4:443 FD 13 flags=1 TLS Session 
info: (TLS1.2)-(ECDHE-SECP256R1)-(RSA-SHA512)-(AES-256-GCM)
2023/12/04 11:00:05.173 kid1| 11,2| http.cc(2266) sendRequest: HTTP 
Server local=192.168.1.123:47236 remote=1.2.3.4:443 FD 13 flags=1
2023/12/04 11:00:05.173 kid1| 11,2| http.cc(2267) sendRequest: HTTP 
Server REQUEST:
---------
GET / HTTP/1.1
User-Agent: curl/7.74.0
Accept: */*
Host: www.foo.com
Via: 1.1 bulls.de.regify.com (squid/4.13)
Surrogate-Capability: bulls.de.regify.com=&quot;Surrogate/1.0 ESI/1.0&quot;
X-Forwarded-For: 192.168.1.124
Cache-Control: max-age=259200
Connection: keep-alive


----------
2023/12/04 11:00:05.185 kid1| ctx: enter level&#160; 0: '<A HREF="https://www.foo.com/">https://www.foo.com/</A>'
2023/12/04 11:00:05.185 kid1| 11,2| http.cc(719) processReplyHeader: 
HTTP Server local=192.168.1.123:47236 remote=1.2.3.4:443 FD 13 flags=1
2023/12/04 11:00:05.185 kid1| 11,2| http.cc(720) processReplyHeader: 
HTTP Server RESPONSE:
---------
HTTP/1.1 302 Found
Date: Mon, 04 Dec 2023 10:00:05 GMT
Server: Apache
X-Frame-Options: SAMEORIGIN
Strict-Transport-Security: max-age=31536000; includeSubdomains;
X-Content-Type-Options: nosniff
X-XSS-Protection: 1
Content-Security-Policy: default-src 'self'; script-src 'self' 
'unsafe-inline' 'unsafe-eval'; connect-src 'self' 'unsafe-inline'; 
img-src https: data: 'unsafe-inline'; frame-src 'self'; style-src 'self' 
'unsafe-inline';
Location: <A HREF="https://www.foo.com/foo.php?mode=direct">https://www.foo.com/foo.php?mode=direct</A>
Content-Length: 233
Keep-Alive: timeout=5, max=100
Connection: Keep-Alive
Content-Type: text/html; charset=iso-8859-1

----------
2023/12/04 11:00:05.185 kid1| ctx: exit level&#160; 0
2023/12/04 11:00:05.185 kid1| 20,2| store.cc(985) checkCachable: 
StoreEntry::checkCachable: NO: not cachable
2023/12/04 11:00:05.185 kid1| 88,2| client_side_reply.cc(2062) 
processReplyAccessResult: The reply for GET <A HREF="https://www.foo.com/">https://www.foo.com/</A> is 
ALLOWED, because it matched sfoo
2023/12/04 11:00:05.185 kid1| 11,2| Stream.cc(271) sendStartOfMessage: 
HTTP Client local=192.168.1.123:443 remote=192.168.1.124:37526 FD 11 flags=1
2023/12/04 11:00:05.185 kid1| 11,2| Stream.cc(272) sendStartOfMessage: 
HTTP Client REPLY:
---------
HTTP/1.1 302 Found
Date: Mon, 04 Dec 2023 10:00:05 GMT
Server: Apache
X-Frame-Options: SAMEORIGIN
Strict-Transport-Security: max-age=31536000; includeSubdomains;
X-Content-Type-Options: nosniff
X-XSS-Protection: 1
Content-Security-Policy: default-src 'self'; script-src 'self' 
'unsafe-inline' 'unsafe-eval'; connect-src 'self' 'unsafe-inline'; 
img-src https: data: 'unsafe-inline'; frame-src 'self'; style-src 'self' 
'unsafe-inline';
Location: <A HREF="https://www.foo.com/foo.php?mode=direct">https://www.foo.com/foo.php?mode=direct</A>
Content-Length: 233
Content-Type: text/html; charset=iso-8859-1
X-Cache: MISS from bulls.de.regify.com
X-Cache-Lookup: MISS from bulls.de.regify.com:443
Via: 1.1 bulls.de.regify.com (squid/4.13)
Connection: keep-alive


----------
2023/12/04 11:00:05.185 kid1| 20,2| store.cc(985) checkCachable: 
StoreEntry::checkCachable: NO: not cachable
2023/12/04 11:00:05.185 kid1| 20,2| store.cc(985) checkCachable: 
StoreEntry::checkCachable: NO: not cachable
2023/12/04 11:00:05.185 kid1| 20,2| store.cc(985) checkCachable: 
StoreEntry::checkCachable: NO: not cachable
2023/12/04 11:00:05.185 kid1| 20,2| store.cc(985) checkCachable: 
StoreEntry::checkCachable: NO: not cachable
2023/12/04 11:00:05.186 kid1| 33,2| client_side.cc(586) swanSong: 
local=192.168.1.123:443 remote=192.168.1.124:37526 flags=1





So i'm a bit confiused.
Is there a way to make https virtual hosting with multiple certificates 
to different back ends possible at all ATM?


Mit Freundlichen Gr&#252;&#223;en / Kind regards

Mario Theodoridis

regify GmbH
R&#246;merstrasse 39 | D-78183 H&#252;fingen-Behla
Amtsgericht Freiburg HRB 709343
Telefon: +49 771 8978 4238


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="026307.html">[squid-users] SSL Virtual Hosting Problem
</A></li>
	<LI>Next message (by thread): <A HREF="026313.html">[squid-users] [squid-announce] [ADVISORY] SQUID-2023:7 Denial of Service in HTTP Message Processing
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26317">[ date ]</a>
              <a href="thread.html#26317">[ thread ]</a>
              <a href="subject.html#26317">[ subject ]</a>
              <a href="author.html#26317">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
