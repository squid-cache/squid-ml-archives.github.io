<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] [External] Re:  Cache_peer breaks Squid 5.5
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20%5BExternal%5D%20Re%3A%20%20Cache_peer%20breaks%20Squid%205.5&In-Reply-To=%3C1fff05ec-930b-48c4-9ea9-6b8afad92d2b%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="026328.html">
   <LINK REL="Next"  HREF="026330.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] [External] Re:  Cache_peer breaks Squid 5.5</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20%5BExternal%5D%20Re%3A%20%20Cache_peer%20breaks%20Squid%205.5&In-Reply-To=%3C1fff05ec-930b-48c4-9ea9-6b8afad92d2b%40measurement-factory.com%3E"
       TITLE="[squid-users] [External] Re:  Cache_peer breaks Squid 5.5">rousskov at measurement-factory.com
       </A><BR>
    <I>Wed Dec 13 16:30:47 UTC 2023</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="026328.html">[squid-users] [External] Re:  Cache_peer breaks Squid 5.5
</A></li>
        <LI>Next message (by thread): <A HREF="026330.html">[squid-users] [External] Re:  Cache_peer breaks Squid 5.5
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26329">[ date ]</a>
              <a href="thread.html#26329">[ thread ]</a>
              <a href="subject.html#26329">[ subject ]</a>
              <a href="author.html#26329">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 2023-12-12 21:45, HENDERSON, GAVEN L RTX wrote:

&gt;<i> assertion failed: peer_digest.cc:419: &quot;EX&quot;
</I>
... which is one of the following assertions (quoted with their official 
Squid v5.5 line numbers, none of which is 419):

     412     assert(fetch-&gt;pd &amp;&amp; receivedData.data);
     416     assert(fetch-&gt;buf + fetch-&gt;bufofs == receivedData.data);
     421     assert(fetch-&gt;bufofs &lt;= SM_PAGE_SIZE);

FWIW, the latest Squid v5 branch code (and future v5.10 if it is 
released), fixes the bug that resulted in assertions logged as &quot;EX&quot; 
instead of the actual assertion text. The same bug is fixed in all v6 
releases.

This new bug report might be related:
<A HREF="https://bugs.squid-cache.org/show_bug.cgi?id=5330">https://bugs.squid-cache.org/show_bug.cgi?id=5330</A>


&gt;<i> Any thoughts on how to fix this on Rocky 9?
</I>
Unfortunately, I failed to find good suspects for this v5 bug -- all 
obvious suspects came after v5.5 was released. However, I do not even 
know which version you were running before updating to v5.5. Please note 
that v5 is not officially supported by the Squid Project.


My recommendation is to update to v6.6 or later.


HTH,

Alex.


&gt;<i> -----Original Message-----
</I>&gt;<i> From: squid-users &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>&gt; On Behalf Of Alex Rousskov
</I>&gt;<i> Sent: Tuesday, December 12, 2023 10:22 AM
</I>&gt;<i> To: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> Subject: [External] Re: [squid-users] Cache_peer breaks Squid 5.5
</I>&gt;<i> 
</I>&gt;<i> On 2023-12-12 11:25, HENDERSON, GAVEN L RTX wrote:
</I>&gt;&gt;<i> Sorry if this has already been answered.  I couldn't find anything online regarding the problem I am experiencing.  I have a Squid server acting as a proxy relay.  It listens on two ports and, depending on which port a request comes in, the request is forwarded to a specific upstream proxy.  Everything was working prior to the 5.5 update.  Now, Squid starts but crashes a few seconds later.  I have traced it down to the cache_peer directives.  If I comment them out, the service is stable.  I have also tried the stock configuration with only the cache_peer directive added and it still crashes so I don't think the problem is being triggered by some other part of my configuration.  I'm not seeing anything particularly helpful in the messages log:
</I>&gt;<i> 
</I>&gt;<i> What do you see in Squid's cache.log? I would expect a message about Squid hitting an assertion or detecting another catastrophic problem before crashing. If there is nothing in cache.log, consider (enabling core dumps in your OS configuration and) getting a backtrace from the crashed Squid process.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> HTH,
</I>&gt;<i> 
</I>&gt;<i> Alex.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> Nov 24 15:17:30 svr-squid squid[2259]: Squid Parent: squid-1 process
</I>&gt;&gt;<i> 2290 exited due to signal 6 with status 0 Nov 24 15:17:30 svr-squid
</I>&gt;&gt;<i> squid[2259]: Squid Parent: squid-1 process 2290 will not be restarted
</I>&gt;&gt;<i> for 3600 seconds due to repeated, frequent failures Nov 24 15:17:30 svr-squid squid[2259]: Exiting due to repeated, frequent failures Nov 24 15:17:30 svr-squid systemd[1]: mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">systemd-coredump at 21-2295-0.service</A>: Deactivated successfully.
</I>&gt;&gt;<i> Nov 24 15:17:30 svr-squid systemd[1]: squid.service: Main process
</I>&gt;&gt;<i> exited, code=exited, status=1/FAILURE Nov 24 15:17:30 svr-squid systemd[1]: squid.service: Failed with result 'exit-code'.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Here is my configuration:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> http_port 192.168.0.1:80 name=port80
</I>&gt;&gt;<i> http_port 192.168.0.1:81 name=port81
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> acl port80_acl myportname port80
</I>&gt;&gt;<i> acl port81_acl myportname port81
</I>&gt;&gt;<i> acl bypass_parent dstdom_regex &quot;/etc/squid/bypass_parent.txt&quot;
</I>&gt;&gt;<i> acl domain_blacklist dstdomain &quot;/etc/squid/domain_blacklist.txt&quot;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> http_access deny all domain_blacklist
</I>&gt;&gt;<i> always_direct allow bypass_parent
</I>&gt;&gt;<i> never_direct allow port80_acl
</I>&gt;&gt;<i> never_direct allow port81_acl
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> cache_peer proxy1.domain.com parent 80 0 default name=proxy80
</I>&gt;&gt;<i> cache_peer_access proxy80 allow port80_acl cache_peer_access proxy80
</I>&gt;&gt;<i> deny all
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> cache_peer proxy2.domain.com parent 80 0 default name=proxy81
</I>&gt;&gt;<i> cache_peer_access proxy81 allow port81_acl cache_peer_access proxy81
</I>&gt;&gt;<i> deny all
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> http_access allow all
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> logformat squid [%tl] %&gt;a %&gt;eui %Ss/%03&gt;Hs %&lt;st %rm %ru %[un %Sh/%&lt;a
</I>&gt;&gt;<i> %mt _______________________________________________
</I>&gt;&gt;<i> squid-users mailing list
</I>&gt;&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;&gt;<i> <A HREF="https://urldefense.com/v3/__https://lists.squid-cache.org/listinfo/squ">https://urldefense.com/v3/__https://lists.squid-cache.org/listinfo/squ</A>
</I>&gt;&gt;<i> id-users__;!!MvWE!FEDTJs2pTa3njy74FPFejy1UEla67Tsxo5KMiUxhSdHn4--dUL_t
</I>&gt;&gt;<i> kUqmWCJ64l_RHB9_uSLhEWcTeWWRcO7R6E68TUQsCFE6$
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="https://urldefense.com/v3/__https://lists.squid-cache.org/listinfo/squid-users__;!!MvWE!FEDTJs2pTa3njy74FPFejy1UEla67Tsxo5KMiUxhSdHn4--dUL_tkUqmWCJ64l_RHB9_uSLhEWcTeWWRcO7R6E68TUQsCFE6$">https://urldefense.com/v3/__https://lists.squid-cache.org/listinfo/squid-users__;!!MvWE!FEDTJs2pTa3njy74FPFejy1UEla67Tsxo5KMiUxhSdHn4--dUL_tkUqmWCJ64l_RHB9_uSLhEWcTeWWRcO7R6E68TUQsCFE6$</A>
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="026328.html">[squid-users] [External] Re:  Cache_peer breaks Squid 5.5
</A></li>
	<LI>Next message (by thread): <A HREF="026330.html">[squid-users] [External] Re:  Cache_peer breaks Squid 5.5
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26329">[ date ]</a>
              <a href="thread.html#26329">[ thread ]</a>
              <a href="subject.html#26329">[ subject ]</a>
              <a href="author.html#26329">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
