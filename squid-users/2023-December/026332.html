<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] [External] Re: Cache_peer breaks Squid 5.5
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20%5BExternal%5D%20Re%3A%20Cache_peer%20breaks%20Squid%205.5&In-Reply-To=%3C8646ee00-65e9-4e89-96fa-fd0ea701b2e1%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="026331.html">
   <LINK REL="Next"  HREF="026333.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] [External] Re: Cache_peer breaks Squid 5.5</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20%5BExternal%5D%20Re%3A%20Cache_peer%20breaks%20Squid%205.5&In-Reply-To=%3C8646ee00-65e9-4e89-96fa-fd0ea701b2e1%40measurement-factory.com%3E"
       TITLE="[squid-users] [External] Re: Cache_peer breaks Squid 5.5">rousskov at measurement-factory.com
       </A><BR>
    <I>Thu Dec 14 14:33:05 UTC 2023</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="026331.html">[squid-users] [External] Re:  Cache_peer breaks Squid 5.5
</A></li>
        <LI>Next message (by thread): <A HREF="026333.html">[squid-users] [External] Re: Cache_peer breaks Squid 5.5
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26332">[ date ]</a>
              <a href="thread.html#26332">[ thread ]</a>
              <a href="subject.html#26332">[ subject ]</a>
              <a href="author.html#26332">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 2023-12-13 20:30, HENDERSON, GAVEN L RTX wrote:

 &gt; Old Good: squid-5.5-6.el9_3.1.0.1.src.rpm
 &gt; New Bad:  squid-5.5-6.el9_3.2.src.rpm

It looks like you are using some v5.5-based packages that contain some 
(unknown to me) additional changes on top of official Squid v5.5 
releases. The culprit is likely among those additional changes.

Unfortunately, I currently do not have the time to investigate what 
additional changes are located inside the packages you are using. If you 
do not receive further help from others on this mailing list, consider 
contacting whoever produced those packages (they were not produced by 
the Squid Project).

Alex.


&gt;<i> Old Good:
</I>&gt;<i> Name        : squid
</I>&gt;<i> Epoch       : 7
</I>&gt;<i> Version     : 5.5
</I>&gt;<i> Release     : 6.el9_3.1.0.1
</I>&gt;<i> Architecture: x86_64
</I>&gt;<i> Source RPM  : squid-5.5-6.el9_3.1.0.1.src.rpm
</I>&gt;<i> Build Date  : Fri 10 Nov 2023 11:47:19 PM EST
</I>&gt;<i> 
</I>&gt;<i> New Bad:
</I>&gt;<i> Name        : squid
</I>&gt;<i> Epoch       : 7
</I>&gt;<i> Version     : 5.5
</I>&gt;<i> Release     : 6.el9_3.2
</I>&gt;<i> Architecture: x86_64
</I>&gt;<i> Source RPM  : squid-5.5-6.el9_3.2.src.rpm
</I>&gt;<i> Build Date  : Wed 22 Nov 2023 05:13:20 PM EST
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> -----Original Message-----
</I>&gt;<i> From: HENDERSON, GAVEN L RTX
</I>&gt;<i> Sent: Wednesday, December 13, 2023 11:04 AM
</I>&gt;<i> To: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> Subject: RE: [External] Re: [squid-users] Cache_peer breaks Squid 5.5
</I>&gt;<i> 
</I>&gt;<i> Thanks for all the information.  I primarially deal with Windows so I'm dealing with a bit of a learning curve here.  Any suggestions on how to install Squid 6 on Rocky 9?  Can I do that with dnf/yum from a repo or an RPM?  I'm really hoping there's a way to do that without compiling.
</I>&gt;<i> 
</I>&gt;<i> -----Original Message-----
</I>&gt;<i> From: Alex Rousskov &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt;
</I>&gt;<i> Sent: Wednesday, December 13, 2023 8:31 AM
</I>&gt;<i> To: HENDERSON, GAVEN L RTX &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">gaven.l.henderson at rtx.com</A>&gt;; <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> Subject: Re: [External] Re: [squid-users] Cache_peer breaks Squid 5.5
</I>&gt;<i> 
</I>&gt;<i> On 2023-12-12 21:45, HENDERSON, GAVEN L RTX wrote:
</I>&gt;<i> 
</I>&gt;&gt;<i> assertion failed: peer_digest.cc:419: &quot;EX&quot;
</I>&gt;<i> 
</I>&gt;<i> ... which is one of the following assertions (quoted with their official Squid v5.5 line numbers, none of which is 419):
</I>&gt;<i> 
</I>&gt;<i>       412     assert(fetch-&gt;pd &amp;&amp; receivedData.data);
</I>&gt;<i>       416     assert(fetch-&gt;buf + fetch-&gt;bufofs == receivedData.data);
</I>&gt;<i>       421     assert(fetch-&gt;bufofs &lt;= SM_PAGE_SIZE);
</I>&gt;<i> 
</I>&gt;<i> FWIW, the latest Squid v5 branch code (and future v5.10 if it is released), fixes the bug that resulted in assertions logged as &quot;EX&quot;
</I>&gt;<i> instead of the actual assertion text. The same bug is fixed in all v6 releases.
</I>&gt;<i> 
</I>&gt;<i> This new bug report might be related:
</I>&gt;<i> <A HREF="https://urldefense.com/v3/__https://bugs.squid-cache.org/show_bug.cgi?id=5330__;!!MvWE!GWVUtWGdcsSlCpQnSreaelvBFVUzRBoz315_Hs-MfksgZgo0TW82oiY4HVlajT31-yti6h8AijE4eqKOQEPrRqk0IxEc-t_G$">https://urldefense.com/v3/__https://bugs.squid-cache.org/show_bug.cgi?id=5330__;!!MvWE!GWVUtWGdcsSlCpQnSreaelvBFVUzRBoz315_Hs-MfksgZgo0TW82oiY4HVlajT31-yti6h8AijE4eqKOQEPrRqk0IxEc-t_G$</A>
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> Any thoughts on how to fix this on Rocky 9?
</I>&gt;<i> 
</I>&gt;<i> Unfortunately, I failed to find good suspects for this v5 bug -- all obvious suspects came after v5.5 was released. However, I do not even know which version you were running before updating to v5.5. Please note that v5 is not officially supported by the Squid Project.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> My recommendation is to update to v6.6 or later.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> HTH,
</I>&gt;<i> 
</I>&gt;<i> Alex.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> -----Original Message-----
</I>&gt;&gt;<i> From: squid-users &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>&gt; On
</I>&gt;&gt;<i> Behalf Of Alex Rousskov
</I>&gt;&gt;<i> Sent: Tuesday, December 12, 2023 10:22 AM
</I>&gt;&gt;<i> To: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;&gt;<i> Subject: [External] Re: [squid-users] Cache_peer breaks Squid 5.5
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> On 2023-12-12 11:25, HENDERSON, GAVEN L RTX wrote:
</I>&gt;&gt;&gt;<i> Sorry if this has already been answered.  I couldn't find anything online regarding the problem I am experiencing.  I have a Squid server acting as a proxy relay.  It listens on two ports and, depending on which port a request comes in, the request is forwarded to a specific upstream proxy.  Everything was working prior to the 5.5 update.  Now, Squid starts but crashes a few seconds later.  I have traced it down to the cache_peer directives.  If I comment them out, the service is stable.  I have also tried the stock configuration with only the cache_peer directive added and it still crashes so I don't think the problem is being triggered by some other part of my configuration.  I'm not seeing anything particularly helpful in the messages log:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> What do you see in Squid's cache.log? I would expect a message about Squid hitting an assertion or detecting another catastrophic problem before crashing. If there is nothing in cache.log, consider (enabling core dumps in your OS configuration and) getting a backtrace from the crashed Squid process.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> HTH,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Alex.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Nov 24 15:17:30 svr-squid squid[2259]: Squid Parent: squid-1 process
</I>&gt;&gt;&gt;<i> 2290 exited due to signal 6 with status 0 Nov 24 15:17:30 svr-squid
</I>&gt;&gt;&gt;<i> squid[2259]: Squid Parent: squid-1 process 2290 will not be restarted
</I>&gt;&gt;&gt;<i> for 3600 seconds due to repeated, frequent failures Nov 24 15:17:30 svr-squid squid[2259]: Exiting due to repeated, frequent failures Nov 24 15:17:30 svr-squid systemd[1]: mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">systemd-coredump at 21-2295-0.service</A>: Deactivated successfully.
</I>&gt;&gt;&gt;<i> Nov 24 15:17:30 svr-squid systemd[1]: squid.service: Main process
</I>&gt;&gt;&gt;<i> exited, code=exited, status=1/FAILURE Nov 24 15:17:30 svr-squid systemd[1]: squid.service: Failed with result 'exit-code'.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Here is my configuration:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> http_port 192.168.0.1:80 name=port80
</I>&gt;&gt;&gt;<i> http_port 192.168.0.1:81 name=port81
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> acl port80_acl myportname port80
</I>&gt;&gt;&gt;<i> acl port81_acl myportname port81
</I>&gt;&gt;&gt;<i> acl bypass_parent dstdom_regex &quot;/etc/squid/bypass_parent.txt&quot;
</I>&gt;&gt;&gt;<i> acl domain_blacklist dstdomain &quot;/etc/squid/domain_blacklist.txt&quot;
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> http_access deny all domain_blacklist always_direct allow
</I>&gt;&gt;&gt;<i> bypass_parent never_direct allow port80_acl never_direct allow
</I>&gt;&gt;&gt;<i> port81_acl
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> cache_peer proxy1.domain.com parent 80 0 default name=proxy80
</I>&gt;&gt;&gt;<i> cache_peer_access proxy80 allow port80_acl cache_peer_access proxy80
</I>&gt;&gt;&gt;<i> deny all
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> cache_peer proxy2.domain.com parent 80 0 default name=proxy81
</I>&gt;&gt;&gt;<i> cache_peer_access proxy81 allow port81_acl cache_peer_access proxy81
</I>&gt;&gt;&gt;<i> deny all
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> http_access allow all
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> logformat squid [%tl] %&gt;a %&gt;eui %Ss/%03&gt;Hs %&lt;st %rm %ru %[un %Sh/%&lt;a
</I>&gt;&gt;&gt;<i> %mt _______________________________________________
</I>&gt;&gt;&gt;<i> squid-users mailing list
</I>&gt;&gt;&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;&gt;&gt;<i> <A HREF="https://urldefense.com/v3/__https://lists.squid-cache.org/listinfo/sq">https://urldefense.com/v3/__https://lists.squid-cache.org/listinfo/sq</A>
</I>&gt;&gt;&gt;<i> u
</I>&gt;&gt;&gt;<i> id-users__;!!MvWE!FEDTJs2pTa3njy74FPFejy1UEla67Tsxo5KMiUxhSdHn4--dUL_
</I>&gt;&gt;&gt;<i> t kUqmWCJ64l_RHB9_uSLhEWcTeWWRcO7R6E68TUQsCFE6$
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;<i> squid-users mailing list
</I>&gt;&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;&gt;<i> <A HREF="https://urldefense.com/v3/__https://lists.squid-cache.org/listinfo/squ">https://urldefense.com/v3/__https://lists.squid-cache.org/listinfo/squ</A>
</I>&gt;&gt;<i> id-users__;!!MvWE!FEDTJs2pTa3njy74FPFejy1UEla67Tsxo5KMiUxhSdHn4--dUL_t
</I>&gt;&gt;<i> kUqmWCJ64l_RHB9_uSLhEWcTeWWRcO7R6E68TUQsCFE6$
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">https://lists.squid-cache.org/listinfo/squid-users</A>
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="026331.html">[squid-users] [External] Re:  Cache_peer breaks Squid 5.5
</A></li>
	<LI>Next message (by thread): <A HREF="026333.html">[squid-users] [External] Re: Cache_peer breaks Squid 5.5
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26332">[ date ]</a>
              <a href="thread.html#26332">[ thread ]</a>
              <a href="subject.html#26332">[ subject ]</a>
              <a href="author.html#26332">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
