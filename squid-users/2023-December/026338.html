<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] squid hangs and dies and can not be killed - needs system reboot
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid%20hangs%20and%20dies%20and%20can%20not%20be%20killed%20-%0A%20needs%20system%20reboot&In-Reply-To=%3CCABA8h%3DScgEWyKGS3rVoB_k_VGVMc2aaQp9CH24dNcCg_RLThmA%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="026345.html">
   <LINK REL="Next"  HREF="026346.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] squid hangs and dies and can not be killed - needs system reboot</H1>
    <B>NgTech LTD</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20squid%20hangs%20and%20dies%20and%20can%20not%20be%20killed%20-%0A%20needs%20system%20reboot&In-Reply-To=%3CCABA8h%3DScgEWyKGS3rVoB_k_VGVMc2aaQp9CH24dNcCg_RLThmA%40mail.gmail.com%3E"
       TITLE="[squid-users] squid hangs and dies and can not be killed - needs system reboot">ngtech1ltd at gmail.com
       </A><BR>
    <I>Tue Dec 19 04:21:30 UTC 2023</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="026345.html">[squid-users] squid hangs and dies and can not be killed - needs system reboot
</A></li>
        <LI>Next message (by thread): <A HREF="026346.html">[squid-users] Squid scales up tcp traffic to adsl users
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26338">[ date ]</a>
              <a href="thread.html#26338">[ thread ]</a>
              <a href="subject.html#26338">[ subject ]</a>
              <a href="author.html#26338">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hey Amish,

I want to replicate this issue on a local vm.
Can you give us some details on the version of arch and the relevant
settings for recreating the issue?
How did you installed arch and also squid?

Thanks,
Eliezer

&#1489;&#1514;&#1488;&#1512;&#1497;&#1498; &#1497;&#1493;&#1501; &#1489;&#1523;, 18 &#1489;&#1491;&#1510;&#1502;&#1523; 2023, 16:36, &#1502;&#1488;&#1514; Amish &#8207;&lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">anon.amish at gmail.com</A>&gt;:

&gt;<i> Hello,
</I>&gt;<i>
</I>&gt;<i> I use Arch Linux and today I updated squid from squid 5.7 to squid 6.6.
</I>&gt;<i>
</I>&gt;<i> After the update from 5.7 to 6.6, squid starts but then reaches Dead
</I>&gt;<i> state in a minute or two.
</I>&gt;<i>
</I>&gt;<i> # ps aux | grep squid
</I>&gt;<i> root         601  0.0  0.2  73816 22528 ?        Ss   12:59   0:02
</I>&gt;<i> /usr/bin/squid -f /etc/squid/btnet/squid.btnet.conf --foreground -sYC
</I>&gt;<i> proxy        604  0.0  0.0      0     0 ?        D    12:59   0:03 [squid]
</I>&gt;<i> proxy        607  0.0  0.0  11976  7424 ?        S    12:59   0:00
</I>&gt;<i> (security_file_certgen) -s /var/cache/squid/ssl_db -M 4MB
</I>&gt;<i> proxy        608  0.0  0.0  11976  7168 ?        S    12:59   0:00
</I>&gt;<i> (security_file_certgen) -s /var/cache/squid/ssl_db -M 4MB
</I>&gt;<i> proxy        609  0.0  0.0  11712  5632 ?        S    12:59   0:00
</I>&gt;<i> (security_file_certgen) -s /var/cache/squid/ssl_db -M 4MB
</I>&gt;<i> proxy        610  0.0  0.0  11712  5376 ?        S    12:59   0:00
</I>&gt;<i> (security_file_certgen) -s /var/cache/squid/ssl_db -M 4MB
</I>&gt;<i> proxy        611  0.0  0.0  11712  5504 ?        S    12:59   0:00
</I>&gt;<i> (security_file_certgen) -s /var/cache/squid/ssl_db -M 4MB
</I>&gt;<i> proxy        622  0.0  0.0   6116  3200 ?        S    12:59   0:00
</I>&gt;<i> (logfile-daemon) /var/log/squid/access.log
</I>&gt;<i>
</I>&gt;<i> And then all requests get stuck. Notice the D (dead) state of squid.
</I>&gt;<i>
</I>&gt;<i> I use multiple ports for multiple purposes. (It all worked fine in squid
</I>&gt;<i> 5.7)
</I>&gt;<i>
</I>&gt;<i> Dec 18 12:59:10 mumbai squid[601]: Starting Authentication on port
</I>&gt;<i> [::]:3128
</I>&gt;<i> Dec 18 12:59:10 mumbai squid[601]: Disabling Authentication on port
</I>&gt;<i> [::]:3128 (interception enabled)
</I>&gt;<i> Dec 18 12:59:10 mumbai squid[601]: Starting Authentication on port
</I>&gt;<i> [::]:8081
</I>&gt;<i> Dec 18 12:59:10 mumbai squid[601]: Disabling Authentication on port
</I>&gt;<i> [::]:8081 (interception enabled)
</I>&gt;<i> Dec 18 12:59:12 mumbai squid[601]: Starting Authentication on port
</I>&gt;<i> [::]:8082
</I>&gt;<i> Dec 18 12:59:12 mumbai squid[601]: Disabling Authentication on port
</I>&gt;<i> [::]:8082 (interception enabled)
</I>&gt;<i> Dec 18 12:59:12 mumbai squid[601]: Starting Authentication on port
</I>&gt;<i> [::]:8083
</I>&gt;<i> Dec 18 12:59:12 mumbai squid[601]: Disabling Authentication on port
</I>&gt;<i> [::]:8083 (interception enabled)
</I>&gt;<i> Dec 18 12:59:13 mumbai squid[601]: Starting Authentication on port
</I>&gt;<i> [::]:8084
</I>&gt;<i> Dec 18 12:59:13 mumbai squid[601]: Disabling Authentication on port
</I>&gt;<i> [::]:8084 (interception enabled)
</I>&gt;<i> Dec 18 12:59:13 mumbai squid[601]: Starting Authentication on port
</I>&gt;<i> [::]:3136
</I>&gt;<i> Dec 18 12:59:13 mumbai squid[601]: Disabling Authentication on port
</I>&gt;<i> [::]:3136 (interception enabled)
</I>&gt;<i> Dec 18 12:59:13 mumbai squid[601]: Starting Authentication on port
</I>&gt;<i> [::]:3137
</I>&gt;<i> Dec 18 12:59:13 mumbai squid[601]: Disabling Authentication on port
</I>&gt;<i> [::]:3137 (interception enabled)
</I>&gt;<i> ...
</I>&gt;<i> Dec 18 12:59:29 mumbai squid[604]: Adaptation support is on
</I>&gt;<i> Dec 18 12:59:29 mumbai squid[604]: Accepting NAT intercepted HTTP Socket
</I>&gt;<i> connections at conn19 local=[::]:3128 remote=[::] FD 27 flags=41
</I>&gt;<i>                                         listening port: 3128
</I>&gt;<i> Dec 18 12:59:29 mumbai squid[604]: Accepting SSL bumped HTTP Socket
</I>&gt;<i> connections at conn21 local=[::]:8080 remote=[::] FD 28 flags=9
</I>&gt;<i>                                         listening port: 8080
</I>&gt;<i> Dec 18 12:59:29 mumbai squid[604]: Accepting NAT intercepted SSL bumped
</I>&gt;<i> HTTPS Socket connections at conn23 local=[::]:8081 remote=[::] FD 29
</I>&gt;<i> flags=41
</I>&gt;<i>                                         listening port: 8081
</I>&gt;<i> Dec 18 12:59:29 mumbai squid[604]: Accepting SSL bumped HTTP Socket
</I>&gt;<i> connections at conn25 local=[::]:8092 remote=[::] FD 30 flags=9
</I>&gt;<i>                                         listening port: 8092
</I>&gt;<i> Dec 18 12:59:29 mumbai systemd[1]: Started Squid Web Proxy Server.
</I>&gt;<i> Dec 18 12:59:29 mumbai squid[604]: Accepting SSL bumped HTTP Socket
</I>&gt;<i> connections at conn27 local=[::]:8093 remote=[::] FD 31 flags=9
</I>&gt;<i>                                         listening port: 8093
</I>&gt;<i> Dec 18 12:59:29 mumbai squid[604]: Accepting SSL bumped HTTP Socket
</I>&gt;<i> connections at conn29 local=[::]:8094 remote=[::] FD 32 flags=9
</I>&gt;<i>                                         listening port: 8094
</I>&gt;<i> Dec 18 12:59:29 mumbai squid[604]: Accepting NAT intercepted SSL bumped
</I>&gt;<i> HTTPS Socket connections at conn31 local=[::]:8082 remote=[::] FD 33
</I>&gt;<i> flags=41
</I>&gt;<i>                                         listening port: 8082
</I>&gt;<i> Dec 18 12:59:29 mumbai squid[604]: Accepting NAT intercepted SSL bumped
</I>&gt;<i> HTTPS Socket connections at conn33 local=[::]:8083 remote=[::] FD 34
</I>&gt;<i> flags=41
</I>&gt;<i>                                         listening port: 8083
</I>&gt;<i> Dec 18 12:59:29 mumbai squid[604]: Accepting NAT intercepted SSL bumped
</I>&gt;<i> HTTPS Socket connections at conn35 local=[::]:8084 remote=[::] FD 35
</I>&gt;<i> flags=41
</I>&gt;<i>                                         listening port: 8084
</I>&gt;<i> Dec 18 12:59:29 mumbai squid[604]: Accepting NAT intercepted HTTP Socket
</I>&gt;<i> connections at conn37 local=[::]:3136 remote=[::] FD 36 flags=41
</I>&gt;<i>                                         listening port: 3136
</I>&gt;<i> Dec 18 12:59:29 mumbai squid[604]: Accepting NAT intercepted HTTP Socket
</I>&gt;<i> connections at conn39 local=[::]:3137 remote=[::] FD 37 flags=41
</I>&gt;<i>                                         listening port: 3137
</I>&gt;<i>
</I>&gt;<i> And then following errors came:
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Dec 18 12:59:45 mumbai squid[604]: ERROR: failure while accepting a TLS
</I>&gt;<i> connection on conn41 local=192.168.0.1:8080 remote=192.168.0.111:53867
</I>&gt;<i> FD 12 flags=1: SQUID_TLS
</I>&gt;<i> _ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
</I>&gt;<i>                                         current master transaction:
</I>&gt;<i> master53
</I>&gt;<i> Dec 18 12:59:45 mumbai squid[604]: ERROR: failure while accepting a TLS
</I>&gt;<i> connection on conn42 local=192.168.0.1:8080 remote=192.168.0.111:53868
</I>&gt;<i> FD 14 flags=1: SQUID_TLS
</I>&gt;<i> _ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
</I>&gt;<i>                                         current master transaction:
</I>&gt;<i> master53
</I>&gt;<i> Dec 18 12:59:45 mumbai squid[604]: ERROR: failure while accepting a TLS
</I>&gt;<i> connection on conn43 local=192.168.0.1:8080 remote=192.168.0.111:53869
</I>&gt;<i> FD 16 flags=1: SQUID_TLS
</I>&gt;<i> _ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
</I>&gt;<i>                                         current master transaction:
</I>&gt;<i> master57
</I>&gt;<i> Dec 18 12:59:45 mumbai squid[604]: ERROR: failure while accepting a TLS
</I>&gt;<i> connection on conn44 local=192.168.0.1:8080 remote=192.168.0.111:53870
</I>&gt;<i> FD 12 flags=1: SQUID_TLS
</I>&gt;<i> _ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
</I>&gt;<i>                                         current master transaction:
</I>&gt;<i> master57
</I>&gt;<i> Dec 18 12:59:56 mumbai squid[604]: ERROR: failure while accepting a TLS
</I>&gt;<i> connection on conn62 local=192.168.0.1:8080 remote=192.168.0.111:53887
</I>&gt;<i> FD 12 flags=1: SQUID_TLS
</I>&gt;<i> _ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
</I>&gt;<i>                                         current master transaction:
</I>&gt;<i> master95
</I>&gt;<i> Dec 18 12:59:59 mumbai squid[604]: ERROR: failure while accepting a TLS
</I>&gt;<i> connection on conn64 local=192.168.0.1:8080 remote=192.168.0.111:53888
</I>&gt;<i> FD 12 flags=1: SQUID_TLS
</I>&gt;<i> _ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
</I>&gt;<i>                                         current master transaction:
</I>&gt;<i> master99
</I>&gt;<i> Dec 18 13:00:02 mumbai squid[604]: ERROR: failure while accepting a TLS
</I>&gt;<i> connection on conn65 local=192.168.0.1:8080 remote=192.168.0.178:56115
</I>&gt;<i> FD 12 flags=1: SQUID_TLS
</I>&gt;<i> _ERR_ACCEPT+TLS_LIB_ERR=A000418+TLS_IO_ERR=1
</I>&gt;<i>                                         current master transaction:
</I>&gt;<i> master53
</I>&gt;<i> Dec 18 13:01:24 mumbai squid[604]: kick abandoning conn199
</I>&gt;<i> local=192.168.0.1:8093 remote=192.168.0.101:52211 FD 52 flags=1
</I>&gt;<i>                                         connection: conn199
</I>&gt;<i> local=192.168.0.1:8093 remote=192.168.0.101:52211 FD 52 flags=1
</I>&gt;<i> Dec 18 13:01:45 mumbai squid[604]: ERROR: failure while accepting a TLS
</I>&gt;<i> connection on conn240 local=192.168.0.1:8093 remote=192.168.0.111:53931
</I>&gt;<i> FD 48 flags=1: SQUID_TL
</I>&gt;<i> S_ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
</I>&gt;<i>                                         current master transaction:
</I>&gt;<i> master314
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> After this point there is nothing in systemd journal (via: journalctl -f
</I>&gt;<i> -u squid) and same lines are in cache.log.
</I>&gt;<i>
</I>&gt;<i> Squid got stuck (DEAD state) at 13:01 and right now it 19:26 (6 hours
</I>&gt;<i> passed) and squid is still in dead state.
</I>&gt;<i>
</I>&gt;<i> kill -9 or kill -ALRM or -HUP also does nothing.
</I>&gt;<i>
</I>&gt;<i> So to restart squid - I will need to restart whole system.
</I>&gt;<i>
</I>&gt;<i> I have sslbump directives but it is not really applied.
</I>&gt;<i>
</I>&gt;<i> #NOTE: nosslbump_ips below contains 192.168.0.0/24 (whole LAN) so
</I>&gt;<i> effectively there is no SSL bump after step1.
</I>&gt;<i>
</I>&gt;<i> acl nosslbump_ips src 192.168.0.0/24
</I>&gt;<i> ssl_bump splice ssl_step1 nosslbump_ips
</I>&gt;<i> ssl_bump peek ssl_step1
</I>&gt;<i> ssl_bump splice nosslbump_domains
</I>&gt;<i> ssl_bump stare sslbump_domains
</I>&gt;<i> ssl_bump splice ssl_step2
</I>&gt;<i> ssl_bump bump all
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Any idea? If anything changed from 5.7 to 6.6 that may cause this
</I>&gt;<i> behaviour?
</I>&gt;<i>
</I>&gt;<i> Looking at changelog:
</I>&gt;<i>
</I>&gt;<i> Bug 5256: Intercepting port fails to accept
</I>&gt;<i> <A HREF="https://bugs.squid-cache.org/show_bug.cgi?id=5256">https://bugs.squid-cache.org/show_bug.cgi?id=5256</A>
</I>&gt;<i>
</I>&gt;<i> Bug 5154: Do not open IPv6 sockets when IPv6 is disabled
</I>&gt;<i> <A HREF="https://bugs.squid-cache.org/show_bug.cgi?id=5154">https://bugs.squid-cache.org/show_bug.cgi?id=5154</A>
</I>&gt;<i>
</I>&gt;<i> Not sure if above two bug FIXES (in between v5.7 to v6.6) are related to
</I>&gt;<i> my issue.
</I>&gt;<i>
</I>&gt;<i> I ran netstat:
</I>&gt;<i>
</I>&gt;<i> # netstat -ntlp
</I>&gt;<i> Active Internet connections (only servers)
</I>&gt;<i> Proto Recv-Q Send-Q Local Address           Foreign Address
</I>&gt;<i> State       PID/Program name
</I>&gt;<i> ...
</I>&gt;<i> tcp6      33      0 :::3137 :::*                    LISTEN      -
</I>&gt;<i> tcp6       0      0 :::3136 :::*                    LISTEN      -
</I>&gt;<i> tcp6       4      0 :::3128 :::*                    LISTEN      -
</I>&gt;<i> tcp6       0      0 :::8081 :::*                    LISTEN      -
</I>&gt;<i> tcp6       0      0 :::8080 :::*                    LISTEN      -
</I>&gt;<i> tcp6       0      0 :::8083 :::*                    LISTEN      -
</I>&gt;<i> tcp6       0      0 :::8082 :::*                    LISTEN      -
</I>&gt;<i> tcp6       0      0 :::8084 :::*                    LISTEN      -
</I>&gt;<i> tcp6    4097      0 :::8093 :::*                    LISTEN      -
</I>&gt;<i> tcp6       0      0 :::8092 :::*                    LISTEN      -
</I>&gt;<i> tcp6       0      0 :::8094 :::*                    LISTEN      -
</I>&gt;<i> ...
</I>&gt;<i>
</I>&gt;<i> I do not have IPv6 enabled, yet there are 33 and 4097 numbers in Recv-Q
</I>&gt;<i> and also no process/PID owns these ports.
</I>&gt;<i>
</I>&gt;<i> Same IPv4 ports are not shown in use by netstat, so only IPv6 ports
</I>&gt;<i> remain open, that too orphaned!
</I>&gt;<i>
</I>&gt;<i> So what is happening?
</I>&gt;<i>
</I>&gt;<i> Any idea to solve or any workaround?
</I>&gt;<i>
</I>&gt;<i> Thank you,
</I>&gt;<i>
</I>&gt;<i> Amish.
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">https://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20231219/1e3b14d2/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20231219/1e3b14d2/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="026345.html">[squid-users] squid hangs and dies and can not be killed - needs system reboot
</A></li>
	<LI>Next message (by thread): <A HREF="026346.html">[squid-users] Squid scales up tcp traffic to adsl users
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26338">[ date ]</a>
              <a href="thread.html#26338">[ thread ]</a>
              <a href="subject.html#26338">[ subject ]</a>
              <a href="author.html#26338">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
