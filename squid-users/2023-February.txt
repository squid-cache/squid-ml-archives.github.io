From ankor2023 at gmail.com  Wed Feb  1 07:00:52 2023
From: ankor2023 at gmail.com (Andrey K)
Date: Wed, 1 Feb 2023 10:00:52 +0300
Subject: [squid-users] Logging failed authentication attempts
In-Reply-To: <d5333579-0de2-be67-dc86-c080d91885e9@treenet.co.nz>
References: <CADJd0Y0AcPijeatbR22MpguN0k+WuhkOk0c3bJgS+qe+6-ny8w@mail.gmail.com>
 <0eec88b9-1e25-06d5-a14d-8897d786a338@treenet.co.nz>
 <CADJd0Y0eBcU85aNUqzHnV=wabKD_GC8m0GqW2SUzyZM7-UDJHA@mail.gmail.com>
 <CADJd0Y2x=Npx2_R-d_3H3oEBSJDLcMFuM3apSM6BXX9=qp29fQ@mail.gmail.com>
 <3d44889a-1da3-f7cb-0b3c-58af98098eed@treenet.co.nz>
 <CADJd0Y249ncWzrZnAffXhq3qmf-w187UNQjsajTJ+phS3q=1_g@mail.gmail.com>
 <d5333579-0de2-be67-dc86-c080d91885e9@treenet.co.nz>
Message-ID: <CADJd0Y3cH6nwvLWgG9Nq0CFRpAwHhSeLE+f7-=9TPHYKSePTmg@mail.gmail.com>

Hello Amos,

You helped me very much.

Kind regards
    Ankor

??, 31 ???. 2023 ?. ? 12:37, Amos Jeffries <squid3 at treenet.co.nz>:

> On 31/01/2023 9:16 pm, Andrey K wrote:
> > Hello Amos,
> >
> > Thank you for the idea to write a wrapper script.
> >
> > As NTLM-helper returns "NA NT_STATUS_LOGON_FAILURE" during
> > authentication failed,
>
> Oh. Your script should convert that old syntax to the current one:
>
>    ERR token=NT_STATUS_LOGON_FAILURE user="..."
>
> FYI, If it still does not show up you can change the log format to print
> %note{user}
>
> >
> > By the way, what are these acronyms for (YR, KK, TT, AF, BH, NA, LD)?
>
> see
>
> https://wiki.squid-cache.org/Features/NegotiateAuthentication#how-does-it-work-in-squid
>
>
> HTH
> Amos
>
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230201/f4132887/attachment.htm>

From tom.jabber at free.fr  Fri Feb  3 15:08:02 2023
From: tom.jabber at free.fr (Tom JABBER)
Date: Fri, 3 Feb 2023 16:08:02 +0100
Subject: [squid-users]
 why-squid-reuse-headers-from-parent-but-not-the-html-body-when-not-200-ok
In-Reply-To: <54207f43-c285-57f0-2850-3db34f1a69f1@free.fr>
References: <54207f43-c285-57f0-2850-3db34f1a69f1@free.fr>
Message-ID: <f7a7a1f6-2bae-43e3-b62c-f37199612a70@free.fr>

Hi,

I'm looking for some help regarding some awkward behaviors I see on 
squid proxies when they are chained (one proxy with one parent proxy):

As said in subject, if parent proxy returns a non 200 OK code along with 
some HTML body, "child" proxy reuses parent headers, which is already a 
matter of discussion, and among other headers, a content-length > 0 
while not forwarding the HTML received from parent.

cf. 
https://superuser.com/questions/1765082/why-squid-reuse-headers-from-parent-but-not-the-html-body-when-not-200-ok

Would there be anyone here willing to help ?

Thanks in advance,

-- 

@TJ



From squid3 at treenet.co.nz  Fri Feb  3 17:40:24 2023
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Sat, 4 Feb 2023 06:40:24 +1300
Subject: [squid-users]
 why-squid-reuse-headers-from-parent-but-not-the-html-body-when-not-200-ok
In-Reply-To: <f7a7a1f6-2bae-43e3-b62c-f37199612a70@free.fr>
References: <54207f43-c285-57f0-2850-3db34f1a69f1@free.fr>
 <f7a7a1f6-2bae-43e3-b62c-f37199612a70@free.fr>
Message-ID: <bd6b685f-01c3-80c0-3a1e-baa46b9aced1@treenet.co.nz>

On 4/02/2023 4:08 am, Tom JABBER wrote:
> Hi,
>
> I'm looking for some help regarding some awkward behaviors I see on 
> squid proxies when they are chained (one proxy with one parent proxy):
>
> As said in subject, if parent proxy returns a non 200 OK code along 
> with some HTML body, "child" proxy reuses parent headers, which is 
> already a matter of discussion, and among other headers, a 
> content-length > 0 while not forwarding the HTML received from parent.
>
> cf. 
> https://superuser.com/questions/1765082/why-squid-reuse-headers-from-parent-but-not-the-html-body-when-not-200-ok
>
> Would there be anyone here willing to help ?
>

Because you are using curl, and the method is CONNECT.

curl does the same thing when receiving errors directly from web servers:

## curl -v -x 93.184.216.34:80 https://example.com/
*?? Trying 93.184.216.34:80...
* Connected to 93.184.216.34 (93.184.216.34) port 80 (#0)
* allocate connect buffer
* Establish HTTP proxy tunnel to example.com:443
 > CONNECT example.com:443 HTTP/1.1
 > Host: example.com:443
 > User-Agent: curl/7.87.0
 > Proxy-Connection: Keep-Alive
 >
< HTTP/1.1 400 Bad Request
< Content-Type: text/html
< Content-Length: 349
< Connection: close
< Date: Fri, 03 Feb 2023 17:25:19 GMT
< Server: ECSF (oxr/8326)
<
* CONNECT tunnel failed, response 400
* Closing connection 0
curl: (56) CONNECT tunnel failed, response 400



Cheers
Amos



From rousskov at measurement-factory.com  Fri Feb  3 18:15:34 2023
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Fri, 3 Feb 2023 13:15:34 -0500
Subject: [squid-users]
 why-squid-reuse-headers-from-parent-but-not-the-html-body-when-not-200-ok
In-Reply-To: <f7a7a1f6-2bae-43e3-b62c-f37199612a70@free.fr>
References: <54207f43-c285-57f0-2850-3db34f1a69f1@free.fr>
 <f7a7a1f6-2bae-43e3-b62c-f37199612a70@free.fr>
Message-ID: <e4d6cef4-ec65-974a-097c-3274e163986c@measurement-factory.com>

On 2/3/23 10:08, Tom JABBER wrote:

> As said in subject, if parent proxy returns a non 200 OK code along with 
> some HTML body, "child" proxy reuses parent headers, which is already a 
> matter of discussion, and among other headers, a content-length > 0 
> while not forwarding the HTML received from parent.
> 
> cf. 
> https://superuser.com/questions/1765082/why-squid-reuse-headers-from-parent-but-not-the-html-body-when-not-200-ok
> 
> Would there be anyone here willing to help ?

It is a known Squid bug. AFAIK, the bug does not have a simple 
general-purpose fix, and there is probably relatively little demand for 
fixing it because popular browsers pretty much ignore CONNECT response 
headers (except for proxy authentication) and body (always?).

It is possible to modify Squid to stop promising to send the cache_peer 
response body (at an HTTP framing level), but it is probably better (and 
easier!) to modify Squid to just generate a short error response from 
scratch (instead of forwarding cache_peer response headers without a 
body). Doing so will probably break some use cases, so such a change may 
be officially rejected, but, even if it is, it may still work/help in 
some other specific use cases.

https://wiki.squid-cache.org/SquidFaq/AboutSquid#how-to-add-a-new-squid-feature-enhance-of-fix-something


HTH,

Alex.



From squid3 at treenet.co.nz  Fri Feb  3 21:15:00 2023
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Sat, 4 Feb 2023 10:15:00 +1300
Subject: [squid-users]
 why-squid-reuse-headers-from-parent-but-not-the-html-body-when-not-200-ok
In-Reply-To: <e4d6cef4-ec65-974a-097c-3274e163986c@measurement-factory.com>
References: <54207f43-c285-57f0-2850-3db34f1a69f1@free.fr>
 <f7a7a1f6-2bae-43e3-b62c-f37199612a70@free.fr>
 <e4d6cef4-ec65-974a-097c-3274e163986c@measurement-factory.com>
Message-ID: <513a1c1f-244f-c28e-dc66-cf4dbc6624fa@treenet.co.nz>

On 4/02/2023 7:15 am, Alex Rousskov wrote:
> On 2/3/23 10:08, Tom JABBER wrote:
>
>> As said in subject, if parent proxy returns a non 200 OK code along 
>> with some HTML body, "child" proxy reuses parent headers, which is 
>> already a matter of discussion, and among other headers, a 
>> content-length > 0 while not forwarding the HTML received from parent.
>>
>> cf. 
>> https://superuser.com/questions/1765082/why-squid-reuse-headers-from-parent-but-not-the-html-body-when-not-200-ok
>>
>> Would there be anyone here willing to help ?
>
> It is a known Squid bug.

@Alex, see my response. curl itself does this even without Squid.

Cheers
Amos


From rousskov at measurement-factory.com  Fri Feb  3 21:52:02 2023
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Fri, 3 Feb 2023 16:52:02 -0500
Subject: [squid-users]
 why-squid-reuse-headers-from-parent-but-not-the-html-body-when-not-200-ok
In-Reply-To: <513a1c1f-244f-c28e-dc66-cf4dbc6624fa@treenet.co.nz>
References: <54207f43-c285-57f0-2850-3db34f1a69f1@free.fr>
 <f7a7a1f6-2bae-43e3-b62c-f37199612a70@free.fr>
 <e4d6cef4-ec65-974a-097c-3274e163986c@measurement-factory.com>
 <513a1c1f-244f-c28e-dc66-cf4dbc6624fa@treenet.co.nz>
Message-ID: <5d15e286-35fe-441f-710d-f3b7d4f2e4b3@measurement-factory.com>

On 2/3/23 16:15, Amos Jeffries wrote:
> On 4/02/2023 7:15 am, Alex Rousskov wrote:
>> On 2/3/23 10:08, Tom JABBER wrote:
>>
>>> As said in subject, if parent proxy returns a non 200 OK code along 
>>> with some HTML body, "child" proxy reuses parent headers, which is 
>>> already a matter of discussion, and among other headers, a 
>>> content-length > 0 while not forwarding the HTML received from parent.
>>>
>>> cf. 
>>> https://superuser.com/questions/1765082/why-squid-reuse-headers-from-parent-but-not-the-html-body-when-not-200-ok
>>>
>>> Would there be anyone here willing to help ?
>>
>> It is a known Squid bug.


> @Alex, see my response. curl itself does this even without Squid.


I believe your earlier response does not contradict mine (and does not 
quite match the primary question about the error response body):

* Curl has a right to ignore the CONNECT error response body sent by the 
proxy. Curl is not buggy in this respect[1]. This correct curl behavior 
actually matches my assertion that browsers ignore CONNECT error 
response bodies.

* After sending (to the client) an HTTP response header promising a 
body, Squid has an obligation to send that promised (and available to 
Squid) response body. Squid does not send it. Squid is buggy.


HTH,

Alex.

[1]: I would argue that curl is also buggy with respect to header 
handling because curl stores CONNECT error response headers (e.g. when 
-i option is given) as if they came from the origin server. The caller 
might mistake those headers for a secure origin server response header. 
However, the primary question was not about the headers.


> On 2/3/23 13:15, Alex Rousskov wrote:
>> On 2/3/23 10:08, Tom JABBER wrote:
>> 
>>> As said in subject, if parent proxy returns a non 200 OK code along 
>>> with some HTML body, "child" proxy reuses parent headers, which is 
>>> already a matter of discussion, and among other headers, a 
>>> content-length > 0 while not forwarding the HTML received from parent.
>>>
>>> cf. 
>>> https://superuser.com/questions/1765082/why-squid-reuse-headers-from-parent-but-not-the-html-body-when-not-200-ok
>>>
>>> Would there be anyone here willing to help ?
>> 
>> It is a known Squid bug. AFAIK, the bug does not have a simple 
>> general-purpose fix, and there is probably relatively little demand for 
>> fixing it because popular browsers pretty much ignore CONNECT response 
>> headers (except for proxy authentication) and body (always?).
>> 
>> It is possible to modify Squid to stop promising to send the cache_peer 
>> response body (at an HTTP framing level), but it is probably better (and 
>> easier!) to modify Squid to just generate a short error response from 
>> scratch (instead of forwarding cache_peer response headers without a 
>> body). Doing so will probably break some use cases, so such a change may 
>> be officially rejected, but, even if it is, it may still work/help in 
>> some other specific use cases.
>> 
>> https://wiki.squid-cache.org/SquidFaq/AboutSquid#how-to-add-a-new-squid-feature-enhance-of-fix-something




From tom.jabber at free.fr  Fri Feb  3 22:06:12 2023
From: tom.jabber at free.fr (Tom JABBER)
Date: Fri, 3 Feb 2023 23:06:12 +0100
Subject: [squid-users]
 why-squid-reuse-headers-from-parent-but-not-the-html-body-when-not-200-ok
In-Reply-To: <5d15e286-35fe-441f-710d-f3b7d4f2e4b3@measurement-factory.com>
References: <54207f43-c285-57f0-2850-3db34f1a69f1@free.fr>
 <f7a7a1f6-2bae-43e3-b62c-f37199612a70@free.fr>
 <e4d6cef4-ec65-974a-097c-3274e163986c@measurement-factory.com>
 <513a1c1f-244f-c28e-dc66-cf4dbc6624fa@treenet.co.nz>
 <5d15e286-35fe-441f-710d-f3b7d4f2e4b3@measurement-factory.com>
Message-ID: <36c7dd96-1d23-0017-13f3-38634e514d71@free.fr>

@alex

"because popular browsers pretty much ignore CONNECT response headers 
(except for proxy authentication) and body (always?)."

Well that's exactly how we discovered it: facing a parent proxy that 
needs some AUTH.

"* After sending (to the client) an HTTP response header promising a 
body, Squid has an obligation to send that promised (and available to 
Squid) response body. Squid does not send it. Squid is buggy."

We definitively agree on this.

"It is possible to modify Squid to stop promising to send the cache_peer 
response body (at an HTTP framing level), but it is probably better (and 
easier!) to modify Squid to just generate a short error response from 
scratch (instead of forwarding cache_peer response headers without a 
body). Doing so will probably break some use cases, so such a change may 
be officially rejected, but, even if it is, it may still work/help in 
some other specific use cases."

By saying this you're suggesting I try to code this ? Or is there a 
possible configuration I missed ?


@amos

"curl itself does this even without Squid."

What do you mean ?


On 2/3/23 10:52 PM, Alex Rousskov wrote:
> On 2/3/23 16:15, Amos Jeffries wrote:
>> On 4/02/2023 7:15 am, Alex Rousskov wrote:
>>> On 2/3/23 10:08, Tom JABBER wrote:
>>>
>>>> As said in subject, if parent proxy returns a non 200 OK code along 
>>>> with some HTML body, "child" proxy reuses parent headers, which is 
>>>> already a matter of discussion, and among other headers, a 
>>>> content-length > 0 while not forwarding the HTML received from parent.
>>>>
>>>> cf. 
>>>> https://superuser.com/questions/1765082/why-squid-reuse-headers-from-parent-but-not-the-html-body-when-not-200-ok
>>>>
>>>> Would there be anyone here willing to help ?
>>>
>>> It is a known Squid bug.
>
>
>> @Alex, see my response. curl itself does this even without Squid.
>
>
> I believe your earlier response does not contradict mine (and does not 
> quite match the primary question about the error response body):
>
> * Curl has a right to ignore the CONNECT error response body sent by 
> the proxy. Curl is not buggy in this respect[1]. This correct curl 
> behavior actually matches my assertion that browsers ignore CONNECT 
> error response bodies.
>
> * After sending (to the client) an HTTP response header promising a 
> body, Squid has an obligation to send that promised (and available to 
> Squid) response body. Squid does not send it. Squid is buggy.
>
>
> HTH,
>
> Alex.
>
> [1]: I would argue that curl is also buggy with respect to header 
> handling because curl stores CONNECT error response headers (e.g. when 
> -i option is given) as if they came from the origin server. The caller 
> might mistake those headers for a secure origin server response 
> header. However, the primary question was not about the headers.
>
>
>> On 2/3/23 13:15, Alex Rousskov wrote:
>>> On 2/3/23 10:08, Tom JABBER wrote:
>>>
>>>> As said in subject, if parent proxy returns a non 200 OK code along 
>>>> with some HTML body, "child" proxy reuses parent headers, which is 
>>>> already a matter of discussion, and among other headers, a 
>>>> content-length > 0 while not forwarding the HTML received from parent.
>>>>
>>>> cf. 
>>>> https://superuser.com/questions/1765082/why-squid-reuse-headers-from-parent-but-not-the-html-body-when-not-200-ok
>>>>
>>>> Would there be anyone here willing to help ?
>>>
>>> It is a known Squid bug. AFAIK, the bug does not have a simple 
>>> general-purpose fix, and there is probably relatively little demand 
>>> for fixing it because popular browsers pretty much ignore CONNECT 
>>> response headers (except for proxy authentication) and body (always?).
>>>
>>> It is possible to modify Squid to stop promising to send the 
>>> cache_peer response body (at an HTTP framing level), but it is 
>>> probably better (and easier!) to modify Squid to just generate a 
>>> short error response from scratch (instead of forwarding cache_peer 
>>> response headers without a body). Doing so will probably break some 
>>> use cases, so such a change may be officially rejected, but, even if 
>>> it is, it may still work/help in some other specific use cases.
>>>
>>> https://wiki.squid-cache.org/SquidFaq/AboutSquid#how-to-add-a-new-squid-feature-enhance-of-fix-something 
>>>
>
>
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users

-- 
@TJ



From rousskov at measurement-factory.com  Fri Feb  3 22:45:30 2023
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Fri, 3 Feb 2023 17:45:30 -0500
Subject: [squid-users]
 why-squid-reuse-headers-from-parent-but-not-the-html-body-when-not-200-ok
In-Reply-To: <36c7dd96-1d23-0017-13f3-38634e514d71@free.fr>
References: <54207f43-c285-57f0-2850-3db34f1a69f1@free.fr>
 <f7a7a1f6-2bae-43e3-b62c-f37199612a70@free.fr>
 <e4d6cef4-ec65-974a-097c-3274e163986c@measurement-factory.com>
 <513a1c1f-244f-c28e-dc66-cf4dbc6624fa@treenet.co.nz>
 <5d15e286-35fe-441f-710d-f3b7d4f2e4b3@measurement-factory.com>
 <36c7dd96-1d23-0017-13f3-38634e514d71@free.fr>
Message-ID: <02c56f24-37af-e87f-11ac-5e97fa6d1096@measurement-factory.com>

On 2/3/23 17:06, Tom JABBER wrote:
> "* After sending (to the client) an HTTP response header promising a 
> body, Squid has an obligation to send that promised (and available to 
> Squid) response body. Squid does not send it. Squid is buggy."

> We definitively agree on this.

> "It is possible to modify Squid to stop promising to send the cache_peer 
> response body (at an HTTP framing level), but it is probably better (and 
> easier!) to modify Squid to just generate a short error response from 
> scratch (instead of forwarding cache_peer response headers without a 
> body). Doing so will probably break some use cases, so such a change may 
> be officially rejected, but, even if it is, it may still work/help in 
> some other specific use cases."

> By saying this you're suggesting I try to code this?

Sorry, I should have said "modify Squid source code". To avoid 
misunderstanding, I only state that it is _possible_ to "code this". I 
am not suggesting that _you_ should do it (or that you should _not_ do it).

Moreover, it is not clear to me whether generating a short error 
response (instead of sending a truncated one) will solve your actual 
authentication-related problem (because I do not know what that problem 
is). But, FWIW, a good starting point for generating that short error 
response could be Http::Tunneler::bailOnResponseError() which already 
generates a short error response in the "else" clause (while trying to 
forward a truncated cache_peer response in the primary "if" clause).


> Or is there a possible configuration I missed ?

I do not think there is a configuration option that would make Squid 
forward the CONNECT error response body from a cache peer to the client.


HTH,

Alex.



> @amos
> 
> "curl itself does this even without Squid."
> 
> What do you mean ?
> 
> 
> On 2/3/23 10:52 PM, Alex Rousskov wrote:
>> On 2/3/23 16:15, Amos Jeffries wrote:
>>> On 4/02/2023 7:15 am, Alex Rousskov wrote:
>>>> On 2/3/23 10:08, Tom JABBER wrote:
>>>>
>>>>> As said in subject, if parent proxy returns a non 200 OK code along 
>>>>> with some HTML body, "child" proxy reuses parent headers, which is 
>>>>> already a matter of discussion, and among other headers, a 
>>>>> content-length > 0 while not forwarding the HTML received from parent.
>>>>>
>>>>> cf. 
>>>>> https://superuser.com/questions/1765082/why-squid-reuse-headers-from-parent-but-not-the-html-body-when-not-200-ok
>>>>>
>>>>> Would there be anyone here willing to help ?
>>>>
>>>> It is a known Squid bug.
>>
>>
>>> @Alex, see my response. curl itself does this even without Squid.
>>
>>
>> I believe your earlier response does not contradict mine (and does not 
>> quite match the primary question about the error response body):
>>
>> * Curl has a right to ignore the CONNECT error response body sent by 
>> the proxy. Curl is not buggy in this respect[1]. This correct curl 
>> behavior actually matches my assertion that browsers ignore CONNECT 
>> error response bodies.
>>
>> * After sending (to the client) an HTTP response header promising a 
>> body, Squid has an obligation to send that promised (and available to 
>> Squid) response body. Squid does not send it. Squid is buggy.
>>
>>
>> HTH,
>>
>> Alex.
>>
>> [1]: I would argue that curl is also buggy with respect to header 
>> handling because curl stores CONNECT error response headers (e.g. when 
>> -i option is given) as if they came from the origin server. The caller 
>> might mistake those headers for a secure origin server response 
>> header. However, the primary question was not about the headers.
>>
>>
>>> On 2/3/23 13:15, Alex Rousskov wrote:
>>>> On 2/3/23 10:08, Tom JABBER wrote:
>>>>
>>>>> As said in subject, if parent proxy returns a non 200 OK code along 
>>>>> with some HTML body, "child" proxy reuses parent headers, which is 
>>>>> already a matter of discussion, and among other headers, a 
>>>>> content-length > 0 while not forwarding the HTML received from parent.
>>>>>
>>>>> cf. 
>>>>> https://superuser.com/questions/1765082/why-squid-reuse-headers-from-parent-but-not-the-html-body-when-not-200-ok
>>>>>
>>>>> Would there be anyone here willing to help ?
>>>>
>>>> It is a known Squid bug. AFAIK, the bug does not have a simple 
>>>> general-purpose fix, and there is probably relatively little demand 
>>>> for fixing it because popular browsers pretty much ignore CONNECT 
>>>> response headers (except for proxy authentication) and body (always?).
>>>>
>>>> It is possible to modify Squid to stop promising to send the 
>>>> cache_peer response body (at an HTTP framing level), but it is 
>>>> probably better (and easier!) to modify Squid to just generate a 
>>>> short error response from scratch (instead of forwarding cache_peer 
>>>> response headers without a body). Doing so will probably break some 
>>>> use cases, so such a change may be officially rejected, but, even if 
>>>> it is, it may still work/help in some other specific use cases.
>>>>
>>>> https://wiki.squid-cache.org/SquidFaq/AboutSquid#how-to-add-a-new-squid-feature-enhance-of-fix-something
>>
>>
>> _______________________________________________
>> squid-users mailing list
>> squid-users at lists.squid-cache.org
>> http://lists.squid-cache.org/listinfo/squid-users
> 



From squid3 at treenet.co.nz  Sat Feb  4 17:19:47 2023
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Sun, 5 Feb 2023 06:19:47 +1300
Subject: [squid-users]
 why-squid-reuse-headers-from-parent-but-not-the-html-body-when-not-200-ok
In-Reply-To: <36c7dd96-1d23-0017-13f3-38634e514d71@free.fr>
References: <54207f43-c285-57f0-2850-3db34f1a69f1@free.fr>
 <f7a7a1f6-2bae-43e3-b62c-f37199612a70@free.fr>
 <e4d6cef4-ec65-974a-097c-3274e163986c@measurement-factory.com>
 <513a1c1f-244f-c28e-dc66-cf4dbc6624fa@treenet.co.nz>
 <5d15e286-35fe-441f-710d-f3b7d4f2e4b3@measurement-factory.com>
 <36c7dd96-1d23-0017-13f3-38634e514d71@free.fr>
Message-ID: <b62ab530-4924-a2cf-b755-b67e72c3a88a@treenet.co.nz>

On 4/02/2023 11:06 am, Tom JABBER wrote:
> @alex
>
> "because popular browsers pretty much ignore CONNECT response headers 
> (except for proxy authentication) and body (always?)."
>
> Well that's exactly how we discovered it: facing a parent proxy that 
> needs some AUTH.
>
> "* After sending (to the client) an HTTP response header promising a 
> body, Squid has an obligation to send that promised (and available to 
> Squid) response body. Squid does not send it. Squid is buggy."
>
> We definitively agree on this.
>
> "It is possible to modify Squid to stop promising to send the 
> cache_peer response body (at an HTTP framing level), but it is 
> probably better (and easier!) to modify Squid to just generate a short 
> error response from scratch (instead of forwarding cache_peer response 
> headers without a body). Doing so will probably break some use cases, 
> so such a change may be officially rejected, but, even if it is, it 
> may still work/help in some other specific use cases."
>
> By saying this you're suggesting I try to code this ? Or is there a 
> possible configuration I missed ?
>
>
> @amos
>
> "curl itself does this even without Squid."
>
> What do you mean ?
>

The curl trace I showed in my post after that statement is identical in 
all the important ways to the one provided as evidence of Squid bug.
Except that my trace was done by making curl contact a web server - not 
a proxy.

In my test, using the squidclient tool to replicate the identical 
traffic shows content being delivered by the web server that curl did 
not show.

As such the curl output provided with "no content" is not evidence of 
anything other than how curl itself is behaving.


Cheers
Amos



From arignacio80 at gmail.com  Sun Feb  5 04:06:52 2023
From: arignacio80 at gmail.com (Allan Raymond Ignacio)
Date: Sat, 4 Feb 2023 20:06:52 -0800
Subject: [squid-users] Transparent-SSL and Iptables
Message-ID: <CAEOOCCWbUDCjkezEWt9Hex6TGw_etT0dobgEH=Y3nNe9_HdL-Q@mail.gmail.com>

My setup is Gateway plus Webserver (Nginx)

I'm running transparent-ssl and this is my iptables config -

#!/bin/sh
# squid server IP
SQUID_SERVER="192.168.0.8"

# Interface connected to Internet
INTERNET="eth0"

# Interface connected to LAN
LAN_IN="eth1"

# Squid port
SQUID_PORT="3129"
SQUID_PORTS="3130"

#Allowing All Incoming HTTP and HTTPS
iptables -A INPUT -p tcp -m multiport --dports 80,443 -m conntrack
--ctstate NEW,ESTABLISHED -j ACCEPT
iptables -A OUTPUT -p tcp -m multiport --dports 80,443 -m conntrack
--ctstate ESTABLISHED -j ACCEPT

#Allow outbound DNS
iptables -A INPUT -p udp --source-port 53 -j ACCEPT
#iptables -A OUTPUT -p udp -o eth0 --dport 53 -j ACCEPT
#iptables -A INPUT -p udp -i eth0 --sport 53 -j ACCEPT

# Allow UDP, DNS and Passive FTP
iptables -A INPUT -i $INTERNET -m state --state ESTABLISHED,RELATED -j
ACCEPT

# unlimited access to LAN
iptables -A INPUT -i $LAN_IN -j ACCEPT
iptables -A OUTPUT -o $LAN_IN -j ACCEPT

# DNAT port 80 request comming from LAN systems to squid 3129 ($SQUID_PORT)
aka transparent proxy (http)
iptables -t nat -A PREROUTING -i $LAN_IN -p tcp --dport 80 -j DNAT --to
$SQUID_SERVER:$SQUID_PORT

# DNAT port 443 request comming from LAN systems to squid 3130
($SQUID_PORTS) aka transparent proxy (https)
iptables -t nat -A PREROUTING -i $LAN_IN -p tcp --dport 443 -j DNAT --to
$SQUID_SERVER:$SQUID_PORTS

With the above settings, I can access my webserver in local (192.168.0.8)
but when outside (12.345.45.23) it refuses.

Is it my setting on squid or iptables that is causing the conflict? and how
do i resolve it, please?
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230204/49b179e4/attachment.htm>

From squid3 at treenet.co.nz  Sun Feb  5 10:30:30 2023
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Sun, 5 Feb 2023 23:30:30 +1300
Subject: [squid-users] Transparent-SSL and Iptables
In-Reply-To: <CAEOOCCWbUDCjkezEWt9Hex6TGw_etT0dobgEH=Y3nNe9_HdL-Q@mail.gmail.com>
References: <CAEOOCCWbUDCjkezEWt9Hex6TGw_etT0dobgEH=Y3nNe9_HdL-Q@mail.gmail.com>
Message-ID: <75102745-a48c-45a9-33f6-ffb9158b5c66@treenet.co.nz>

On 5/02/2023 5:06 pm, Allan Raymond Ignacio wrote:
> # Interface connected to LAN
> LAN_IN="eth1"
>
...
> # DNAT port 80 request comming from LAN systems to squid 3129 
> ($SQUID_PORT) aka transparent proxy (http)
> iptables -t nat -A PREROUTING -i $LAN_IN -p tcp --dport 80 -j DNAT 
> --to $SQUID_SERVER:$SQUID_PORT
>
> # DNAT port 443 request comming from LAN systems to squid 3130 
> ($SQUID_PORTS) aka transparent proxy (https)
> iptables -t nat -A PREROUTING -i $LAN_IN -p tcp --dport 443 -j DNAT 
> --to $SQUID_SERVER:$SQUID_PORTS

The above two rules are only sending traffic arriving from $LAN_IN to be 
NAT'd to Squid.
Removing the -i parameter should fix the issue.

Cheers
Amos



From tom.jabber at free.fr  Sun Feb  5 12:46:39 2023
From: tom.jabber at free.fr (Tom JABBER)
Date: Sun, 5 Feb 2023 13:46:39 +0100
Subject: [squid-users]
 why-squid-reuse-headers-from-parent-but-not-the-html-body-when-not-200-ok
In-Reply-To: <b62ab530-4924-a2cf-b755-b67e72c3a88a@treenet.co.nz>
References: <54207f43-c285-57f0-2850-3db34f1a69f1@free.fr>
 <f7a7a1f6-2bae-43e3-b62c-f37199612a70@free.fr>
 <e4d6cef4-ec65-974a-097c-3274e163986c@measurement-factory.com>
 <513a1c1f-244f-c28e-dc66-cf4dbc6624fa@treenet.co.nz>
 <5d15e286-35fe-441f-710d-f3b7d4f2e4b3@measurement-factory.com>
 <36c7dd96-1d23-0017-13f3-38634e514d71@free.fr>
 <b62ab530-4924-a2cf-b755-b67e72c3a88a@treenet.co.nz>
Message-ID: <953779ca-7205-0a4f-fb39-1e85ff0ae02b@free.fr>

@amos

"The curl trace I showed in my post after that statement"

I haven't seen this. When/Where/To Who have you sent this ?


On 2/4/23 6:19 PM, Amos Jeffries wrote:
> The curl trace I showed in my post after that statement

-- 
@TJ



From squid3 at treenet.co.nz  Sun Feb  5 13:40:57 2023
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Mon, 6 Feb 2023 02:40:57 +1300
Subject: [squid-users]
 why-squid-reuse-headers-from-parent-but-not-the-html-body-when-not-200-ok
In-Reply-To: <953779ca-7205-0a4f-fb39-1e85ff0ae02b@free.fr>
References: <54207f43-c285-57f0-2850-3db34f1a69f1@free.fr>
 <f7a7a1f6-2bae-43e3-b62c-f37199612a70@free.fr>
 <e4d6cef4-ec65-974a-097c-3274e163986c@measurement-factory.com>
 <513a1c1f-244f-c28e-dc66-cf4dbc6624fa@treenet.co.nz>
 <5d15e286-35fe-441f-710d-f3b7d4f2e4b3@measurement-factory.com>
 <36c7dd96-1d23-0017-13f3-38634e514d71@free.fr>
 <b62ab530-4924-a2cf-b755-b67e72c3a88a@treenet.co.nz>
 <953779ca-7205-0a4f-fb39-1e85ff0ae02b@free.fr>
Message-ID: <f2cfd90f-5afc-d744-e475-6bb312a8150c@treenet.co.nz>

On 6/02/2023 1:46 am, Tom JABBER wrote:
> @amos
>
> "The curl trace I showed in my post after that statement"
>
> I haven't seen this. When/Where/To Who have you sent this ?
>

http://lists.squid-cache.org/pipermail/squid-users/2023-February/025606.html

Amos



From lbrtchx at gmail.com  Tue Feb  7 01:15:18 2023
From: lbrtchx at gmail.com (Albretch Mueller)
Date: Tue, 7 Feb 2023 01:15:18 +0000
Subject: [squid-users] How configurable would be squid as some sort of
 content server?
Message-ID: <CAFakBwjVNaHmz0W17PrFtUE44sg2fSedFMBbvfGS3P+VT5qK3w@mail.gmail.com>

 Past the basic installation and utility, can squid be possibly used to:

 1) decrypt responses once they arrive from the Internet, and
 2) encrypt requests going out,
 3) make all incoming pages as javascript free as possible (no adds, ?)
 4) programmably configure where certain content should be stored
based on the site serving it
 5) use a data base to know where to find previously cached content
 6) turn all webp images into png
 7) somehow transparently inject some code between squid and the
browser, which depending on the site/URL would from just forward it to
heavily alter the content
 . . .
 I would say some people may have had such needs.
 lbrtchx


From dave at killthe.net  Tue Feb  7 02:16:24 2023
From: dave at killthe.net (Dave Blanchard)
Date: Mon, 6 Feb 2023 20:16:24 -0600
Subject: [squid-users] How configurable would be squid as some sort of
 content server?
In-Reply-To: <CAFakBwjVNaHmz0W17PrFtUE44sg2fSedFMBbvfGS3P+VT5qK3w@mail.gmail.com>
References: <CAFakBwjVNaHmz0W17PrFtUE44sg2fSedFMBbvfGS3P+VT5qK3w@mail.gmail.com>
Message-ID: <20230206201624.6e8dd3765702110c3c2a41dc@killthe.net>

I'm also interested in such functionality, for a micro-ISP I'm planning to start at some point, so as to heavily sanitize and clean up the experience for the poor end user.

The internet really sucks these days.

Dave (@killthe.net)



From robertocarna36 at gmail.com  Wed Feb  8 15:51:06 2023
From: robertocarna36 at gmail.com (Roberto Carna)
Date: Wed, 8 Feb 2023 12:51:06 -0300
Subject: [squid-users] Access to internal domains using Squid
Message-ID: <CAG2Qp6s-zw0jyc3kbNGZ+ewH8rfsL14qSc70T1saRELAhF0uYw@mail.gmail.com>

Dear all, I have a Squid server in non-transparent mode.

All my hosts go to Internet sites using this proxy in the correct way.

But now I need the following:

When my hosts want to go to the internal URL https://www.example.com,
this request reaches Squid and it tells them to go to the internal IP
from our backend web server .....Maybe a certain type of redirect.

Is this possible?

Special thanks!!!


From JOfficer at istreamfs.com  Wed Feb  8 15:55:42 2023
From: JOfficer at istreamfs.com (Joey Officer)
Date: Wed, 8 Feb 2023 15:55:42 +0000
Subject: [squid-users] [EXTERNAL] Access to internal domains using Squid
In-Reply-To: <CAG2Qp6s-zw0jyc3kbNGZ+ewH8rfsL14qSc70T1saRELAhF0uYw@mail.gmail.com>
References: <CAG2Qp6s-zw0jyc3kbNGZ+ewH8rfsL14qSc70T1saRELAhF0uYw@mail.gmail.com>
Message-ID: <CH2PR19MB3496EDF7166E11898B3DCACACDD89@CH2PR19MB3496.namprd19.prod.outlook.com>

We do something similar but using wpad/auto config script to direct local traffic ( .domain.com ) to use the DIRECT route, and else use PROXY

This is probably the better way to go, though I'm not definitive on that.

Joey


-----Original Message-----
From: squid-users <squid-users-bounces at lists.squid-cache.org> On Behalf Of Roberto Carna
Sent: Wednesday, February 8, 2023 9:51 AM
To: squid-users at lists.squid-cache.org
Subject: [EXTERNAL][squid-users] Access to internal domains using Squid

CAUTION: This email originated from outside of the organization. Do not click links or open attachments unless you recognize the sender and know the content is safe.

Dear all, I have a Squid server in non-transparent mode.

All my hosts go to Internet sites using this proxy in the correct way.

But now I need the following:

When my hosts want to go to the internal URL https://www.example.com, this request reaches Squid and it tells them to go to the internal IP from our backend web server .....Maybe a certain type of redirect.

Is this possible?

Special thanks!!!
_______________________________________________
squid-users mailing list
squid-users at lists.squid-cache.org
http://lists.squid-cache.org/listinfo/squid-users


From squid3 at treenet.co.nz  Thu Feb  9 02:52:54 2023
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Thu, 9 Feb 2023 15:52:54 +1300
Subject: [squid-users] How configurable would be squid as some sort of
 content server?
In-Reply-To: <CAFakBwjVNaHmz0W17PrFtUE44sg2fSedFMBbvfGS3P+VT5qK3w@mail.gmail.com>
References: <CAFakBwjVNaHmz0W17PrFtUE44sg2fSedFMBbvfGS3P+VT5qK3w@mail.gmail.com>
Message-ID: <c592bfa9-050b-ebc8-28ee-45a1daaf8b46@treenet.co.nz>

On 7/02/2023 2:15 pm, Albretch Mueller wrote:
>   Past the basic installation and utility, can squid be possibly used to:
>
>   1) decrypt responses once they arrive from the Internet, and
>   2) encrypt requests going out,
>   3) make all incoming pages as javascript free as possible (no adds, ?)
>   4) programmably configure where certain content should be stored
> based on the site serving it
>   5) use a data base to know where to find previously cached content
>   6) turn all webp images into png
>   7) somehow transparently inject some code between squid and the
> browser, which depending on the site/URL would from just forward it to
> heavily alter the content
>   . . .
>   I would say some people may have had such needs.

Squid is a proxy. Most of what you are asking about is content 
adaptation. Squid does not do that itself, but can use adaptation 
services with ICAP or eCAP.

Cheers
Amos


From JOfficer at istreamfs.com  Thu Feb  9 19:22:14 2023
From: JOfficer at istreamfs.com (Joey Officer)
Date: Thu, 9 Feb 2023 19:22:14 +0000
Subject: [squid-users] [EXTERNAL] Access to internal domains using Squid
In-Reply-To: <CAG2Qp6s-zw0jyc3kbNGZ+ewH8rfsL14qSc70T1saRELAhF0uYw@mail.gmail.com>
References: <CAG2Qp6s-zw0jyc3kbNGZ+ewH8rfsL14qSc70T1saRELAhF0uYw@mail.gmail.com>
Message-ID: <CH2PR19MB3496F7FDF9E30E0CA98C3272CDD99@CH2PR19MB3496.namprd19.prod.outlook.com>

Was thinking I should give an example of a proxy auto configuration script:

pac.conf : 
/* proxy auto configuration file sample */

function FindProxyForURL(url, host)
{
	var proxy_no = "DIRECT";
	var proxy_yes = "PROXY proxy.domain.com:3128";

/* Generally matches internal hosts.  Ex: "https://hostname/" */
	if (isPlainHostName(host)) return proxy_no;

/* Matches domain to not proxy */
	if (dnsDomainIs(host, "noproxydomain.com")) return proxy_no;

/* Local networks - allows skipping proxy for LAN servers */
	if (isInNet(host, "192.168.0.0", "255.255.0.0")) return proxy_no;            

	return proxy_yes;
}

You'd host that config on some internal web server and have your browsers configured to load the configuration script.  Then the client evaluates the host/IP and makes the decision to route via the proxy (proxy_yes) or not (proxy_no).  Keep in mind the configuration is top down and the first match will apply.  There are likely better and more complete examples online.  Just wanted to expand on my previous reply.

Joey

-----Original Message-----
From: squid-users <squid-users-bounces at lists.squid-cache.org> On Behalf Of Roberto Carna
Sent: Wednesday, February 8, 2023 9:51 AM
To: squid-users at lists.squid-cache.org
Subject: [EXTERNAL][squid-users] Access to internal domains using Squid

CAUTION: This email originated from outside of the organization. Do not click links or open attachments unless you recognize the sender and know the content is safe.

Dear all, I have a Squid server in non-transparent mode.

All my hosts go to Internet sites using this proxy in the correct way.

But now I need the following:

When my hosts want to go to the internal URL https://www.example.com, this request reaches Squid and it tells them to go to the internal IP from our backend web server .....Maybe a certain type of redirect.

Is this possible?

Special thanks!!!
_______________________________________________
squid-users mailing list
squid-users at lists.squid-cache.org
http://lists.squid-cache.org/listinfo/squid-users


From lbrtchx at gmail.com  Fri Feb 10 12:18:33 2023
From: lbrtchx at gmail.com (Albretch Mueller)
Date: Fri, 10 Feb 2023 12:18:33 +0000
Subject: [squid-users] How configurable would be squid as some sort of
 content server?
In-Reply-To: <c592bfa9-050b-ebc8-28ee-45a1daaf8b46@treenet.co.nz>
References: <CAFakBwjVNaHmz0W17PrFtUE44sg2fSedFMBbvfGS3P+VT5qK3w@mail.gmail.com>
 <c592bfa9-050b-ebc8-28ee-45a1daaf8b46@treenet.co.nz>
Message-ID: <CAFakBwhSkD1HCcdJ_vtwO2pZjAia-_Rj=BBEjMj_MHqx_FuGVA@mail.gmail.com>

 Any learning references you would recommend other than these basic ones?:

 https://en.wikipedia.org/wiki/Internet_Content_Adaptation_Protocol
 https://datatracker.ietf.org/doc/html/rfc3507
 http://www.icap-forum.org/documents/specification/icap_whitepaper_v1-01.pdf
~
 Or asked in another way; in hindsight, if you had to relearn that
stuff how would you do it?

 lbrtchx


From lbrtchx at gmail.com  Fri Feb 10 12:30:27 2023
From: lbrtchx at gmail.com (Albretch Mueller)
Date: Fri, 10 Feb 2023 12:30:27 +0000
Subject: [squid-users] How configurable would be squid as some sort of
 content server?
In-Reply-To: <CAFakBwhSkD1HCcdJ_vtwO2pZjAia-_Rj=BBEjMj_MHqx_FuGVA@mail.gmail.com>
References: <CAFakBwjVNaHmz0W17PrFtUE44sg2fSedFMBbvfGS3P+VT5qK3w@mail.gmail.com>
 <c592bfa9-050b-ebc8-28ee-45a1daaf8b46@treenet.co.nz>
 <CAFakBwhSkD1HCcdJ_vtwO2pZjAia-_Rj=BBEjMj_MHqx_FuGVA@mail.gmail.com>
Message-ID: <CAFakBwibdSmjDd5tFUEfjJUbDCqhfF+4VyRY+fn-aHu1FmSsKw@mail.gmail.com>

 Also the ICAP folks are saying they keep a yahoogroup as a forum:

 http://www.icap-forum.org/icap?do=resources&subdo=newsgroup
 http://www.yahoogroups.com/group/icap-discussions/

 but I couldn't find them.

 lbrtchx


From rousskov at measurement-factory.com  Fri Feb 10 14:02:07 2023
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Fri, 10 Feb 2023 09:02:07 -0500
Subject: [squid-users] How configurable would be squid as some sort of
 content server?
In-Reply-To: <CAFakBwhSkD1HCcdJ_vtwO2pZjAia-_Rj=BBEjMj_MHqx_FuGVA@mail.gmail.com>
References: <CAFakBwjVNaHmz0W17PrFtUE44sg2fSedFMBbvfGS3P+VT5qK3w@mail.gmail.com>
 <c592bfa9-050b-ebc8-28ee-45a1daaf8b46@treenet.co.nz>
 <CAFakBwhSkD1HCcdJ_vtwO2pZjAia-_Rj=BBEjMj_MHqx_FuGVA@mail.gmail.com>
Message-ID: <d5edad41-96fd-daa4-3275-27d8c99a90d3@measurement-factory.com>

On 2/10/23 07:18, Albretch Mueller wrote:
>   Any learning references you would recommend other than these basic ones?:
> 
>   https://en.wikipedia.org/wiki/Internet_Content_Adaptation_Protocol
>   https://datatracker.ietf.org/doc/html/rfc3507
>   http://www.icap-forum.org/documents/specification/icap_whitepaper_v1-01.pdf

https://wiki.squid-cache.org/SquidFaq/ContentAdaptation

And, if you are going to write a yet another ICAP server (which you 
should not), please do not overlook RFC 3507 errata:
https://www.measurement-factory.com/std/icap/

Alex.



From bfriconneau at stemarie-aizenay.fr  Mon Feb 13 08:40:53 2023
From: bfriconneau at stemarie-aizenay.fr (Bertrand Friconneau)
Date: Mon, 13 Feb 2023 09:40:53 +0100
Subject: [squid-users] Update from Squid 4 to Squid 5 :
In-Reply-To: <3e15c732-f934-6843-fb98-53e69841a83a@stemarie-aizenay.fr>
References: <ff318d21-5e79-aabb-2dc8-7024b94c64b2@stemarie-aizenay.fr>
 <56ec5a8c-a171-26bd-6c55-36e75561d971@treenet.co.nz>
 <2bc6f3a0-9c10-8292-3cdc-26a0f6aee9e0@stemarie-aizenay.fr>
 <005801d90f44$b62b3ce0$2281b6a0$@gmail.com>
 <35df2395-50c8-e1f3-346e-b34e4ca95273@riosoft.com.br>
 <3e15c732-f934-6843-fb98-53e69841a83a@stemarie-aizenay.fr>
Message-ID: <acdc53c1-6b2f-402e-5b71-a2c913699a54@stemarie-aizenay.fr>

Hi everyone,

My problem is fixed.

And my Squid server up to date (Ubuntu 22.04 LTS).

Finaly my problem was not about squid but about DNS.

Ubuntu could'nt find any more my AD server.

Solution :
Modify 2 files :
/etc/resolvconf/resolv.conf.d/head
/etc/resolv.conf

And put in it this line :
nameserver <ip of my AD/DNS server>

After serveral reboot/restart, the configuration is always in use.

Thanks for the help

Regards

Bertrand Friconneau





Le 15/12/2022 ? 11:06, Bertrand Friconneau a ?crit?:
> Hi,
>
> Here is the content of my actual /etc/resolv.conf (ubuntu 20.04) :
> ------------------------------------------------------------------------------------------------ 
>
> # Dynamic resolv.conf(5) file for glibc resolver(3) generated by 
> resolvconf(8)
> #???? DO NOT EDIT THIS FILE BY HAND -- YOUR CHANGES WILL BE OVERWRITTEN
> # 127.0.0.53 is the systemd-resolved stub resolver.
> # run "systemd-resolve --status" to see details about the actual 
> nameservers.
>
> nameserver 172.20.0.1
> nameserver 127.0.0.53
> search stemarie-aizenay.local
> ------------------------------------------------------------------------------------------------ 
>
>
> Bruno, thanks for the suggestions.
>
> I will try after Christmas Hollidays.
>
> Regards
>
> Bertrand Friconneau
>
>
>
>
>
> Le 14/12/2022 ? 13:26, Bruno de Paula Larini a ?crit?:
>> Em 13/12/2022 19:46, ngtech1ltd at gmail.com escreveu:
>>> Hey,
>>>
>>> What is the content of:
>>> /etc/resolv.conf
>>> ?
>>>
>>> It could be something related to default systemd dns services.
>>>
>>> Eliezer
>>> ----
>>> Eliezer Croitoru
>>> NgTech, Tech Support
>>> Mobile: +972-5-28704261
>>> Email: ngtech1ltd at gmail.com
>>> Web: https://ngtech.co.il/
>>> My-Tube: https://tube.ngtech.co.il/
>>>
>> Yep, I had the same issues when I upgraded from 4 to 5, because I 
>> also upgraded the distro version along with it, and systemd-resolved 
>> is enabled by default in some, such as Fedora and Ubuntu. It stopped 
>> resolving local domain names for some reason.
>> Instead of struggling to make it work on the new model, I simply 
>> disabled systemd-resolved and went back to old resolv.conf style.
>>
>> I'll quote the solution I followed here: 
>> https://askubuntu.com/questions/907246/how-to-disable-systemd-resolved-in-ubuntu
>>
>> ====
>>
>> This method works on the Ubuntu releases 17.04 (Zesty), 17.10 
>> (Artful), 18.04 (Bionic), 18.10 (Cosmic), 19.04 (Disco) and 20.04 
>> (Focal):
>>
>> Disable and stop the systemd-resolved service:
>>
>> sudo systemctl disable systemd-resolved
>> sudo systemctl stop systemd-resolved
>>
>> Then put the following line in the [main] section of your 
>> /etc/NetworkManager/NetworkManager.conf:
>>
>> dns=default
>>
>> Delete the symlink /etc/resolv.conf
>>
>> rm /etc/resolv.conf
>>
>> Restart NetworkManager
>>
>> sudo systemctl restart NetworkManager
>>
>> Also be aware that disabling systemd-resolvd might break name 
>> resolution in VPN for some users. See this bug on launchpad (Thanks, 
>> Vincent).
>>
>> ===
>



From squid3 at treenet.co.nz  Tue Feb 14 01:14:52 2023
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Tue, 14 Feb 2023 14:14:52 +1300
Subject: [squid-users] HTTPS Request Header acl
In-Reply-To: <CAFKhTfviHcjxH2r137_m2rUSAQ9cQ8nO_Py1usrDwpkSrMr3zQ@mail.gmail.com>
References: <CAFKhTfviHcjxH2r137_m2rUSAQ9cQ8nO_Py1usrDwpkSrMr3zQ@mail.gmail.com>
Message-ID: <043d8802-6ce5-6eb1-e7e3-b5d82e412112@treenet.co.nz>

On 14/02/2023 12:04 am, sanket jaiswal wrote:
> Hi Devs,
>
> I'm using Squid for my Outbound traffic?filtering and I have one use 
> case, I'm tryning to block Egress HTTP and HTTPS Request?based 
> on?certain Header and I've also?leveraged squid 
> acl?request_header_access?to check and block header, However this acl 
> is only working?for HTTP Request and not working?for HTTPS Header.
>
> Can anyone try to help me, Does Squid?have support to check & block 
> HTTPS Request Header?
>

FYI, the difference between HTTP and HTTPS is that the "S" variant 
messages are encrypted with TLS.

Look into the SSL-Bump feature of Squid for how to decrypt user traffic. 
Also, be aware that there are some major limitations with what you are 
trying to do: not all traffic can be decrypted, there are non-HTTP 
protocols using TLS, and all your users must be explicitly configured 
with trust for CA certificate your Squid uses to do the decryption.

HTH
Amos



From squid at buglecreek.com  Wed Feb 15 21:56:06 2023
From: squid at buglecreek.com (squid at buglecreek.com)
Date: Wed, 15 Feb 2023 14:56:06 -0700
Subject: [squid-users] Reverse Proxy Redirect - Stops in Browser
Message-ID: <56bfadbc-7b76-4f40-9c1f-af9ac32f8890@app.fastmail.com>

I have a reverse proxy that that does the following:

acl example_www url_regex -i ^https?:\/\/example-www?.example.com.*
http_access allow internal_IPs example_www
deny_info https://other-www.other.com%R example_www
http_access deny example_www

When a tool or a browser goes to http://example-www.example.com it immediately sends them to https://other-www.other.com as expected.

When a tool or a browser goes to https://example-www.example.com it brings up in chrome the Your connection is not private page and when you hit Advanced and hit the allow to proceed it is then redirected to the site.

This is causing us come compliance issues due to the tool thinking we are running a non-compliant https page since user interaction is required to get to the other page.

Is there a way to send to the other page earlier so the tool or user doesn't even see the Your connection is not private page?  I just want to only aloow the internal IPs and cut everyone else off.

I've tried taking out the deny_info, but that sends the user and tool to a squid error page which basically fails the test as well since it's on the same site.
I've also tried doing a TCP_RESET instead, but for some reason the squid actually send the word reset back to the client the first time and again would fail the test. 


From robertkwild at gmail.com  Thu Feb 16 16:41:02 2023
From: robertkwild at gmail.com (robert k Wild)
Date: Thu, 16 Feb 2023 16:41:02 +0000
Subject: [squid-users] repos/packages to install squid from source
Message-ID: <CAGU_Ci+spLvPKL4A=t6Y0DLKDPqkSpw3Y09YwFWjrbCgxeWHow@mail.gmail.com>

hi all,

installing squid from source and just want to know what default
repos/packages i should have before i install

atm i have these

#install epel repositry
dnf install -y epel-release
#install squid packages
dnf install -y gcc-c++ gcc g++ binutils make sudo wget tar automake
autoconf perl libxml2-devel libcap-devel openssl openssl-devel libarchive
#install clamAV packages
dnf install -y clamd clamav clamav-data clamav-devel clamav-lib
clamav-update

do i need anymore?

thanks,
rob

-- 
Regards,

Robert K Wild.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230216/380a16ac/attachment.htm>

From rousskov at measurement-factory.com  Thu Feb 16 19:38:44 2023
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Thu, 16 Feb 2023 14:38:44 -0500
Subject: [squid-users] repos/packages to install squid from source
In-Reply-To: <CAGU_Ci+spLvPKL4A=t6Y0DLKDPqkSpw3Y09YwFWjrbCgxeWHow@mail.gmail.com>
References: <CAGU_Ci+spLvPKL4A=t6Y0DLKDPqkSpw3Y09YwFWjrbCgxeWHow@mail.gmail.com>
Message-ID: <e5f609ec-0b06-3a2b-d9d0-913bd53c9419@measurement-factory.com>

On 2/16/23 11:41, robert k Wild wrote:

> installing squid from source and just want to know what default 
> repos/packages i should have before i install
> 
> atm i have these
> 
> #install epel repositry
> dnf install -y epel-release
> #install squid packages
> dnf install -y gcc-c++ gcc g++ binutils make sudo wget tar automake 
> autoconf perl libxml2-devel libcap-devel openssl openssl-devel libarchive
> #install clamAV packages
> dnf install -y clamd clamav clamav-data clamav-devel clamav-lib 
> clamav-update
> 
> do i need anymore?

Squid does not really have a concept of "default" dependencies. In 
practice, the list of dependencies is determined by what you need your 
Squid to do.

FWIW, some of the Squid CI tests running on Ubuntu install the following 
packages, but this is not a complete list of everything that a 
particular Squid may need or may use:

comerr-dev:amd64
debhelper
dh-apparmor
dh-autoreconf
dh-strip-nondeterminism
dwz
gettext
intltool-debian
krb5-multidev:amd64
libarchive-zip-perl
libcap-dev:amd64
libcppunit-1.15-0:amd64
libcppunit-dev:amd64
libdebhelper-perl
libecap3-dev:amd64
libecap3:amd64
libevent-2.1-7:amd64
libfile-stripnondeterminism-perl
libfl2:amd64
libgnutls-dane0:amd64
libgnutls-openssl27:amd64
libgnutls28-dev:amd64
libgnutlsxx28:amd64
libgssrpc4:amd64
libidn2-dev:amd64
libkadm5clnt-mit12:amd64
libkadm5srv-mit12:amd64
libkdb5-10:amd64
libkrb5-dev:amd64
libldap-dev:amd64
libldap2-dev
libnetfilter-conntrack-dev:amd64
libnfnetlink-dev
libosp5
libp11-kit-dev:amd64
libpam0g-dev:amd64
libsasl2-dev
libsub-override-perl
libsystemd-dev:amd64
libtasn1-6-dev:amd64
libtdb-dev:amd64
libunbound8:amd64
linuxdoc-tools
nettle-dev:amd64
opensp
po-debconf
sgml-base
sgml-data
xml-core


Most of the above come from "apt-get build-dep squid" executed in that 
CI environment


HTH,

Alex.



From robertkwild at gmail.com  Thu Feb 16 19:40:19 2023
From: robertkwild at gmail.com (robert k Wild)
Date: Thu, 16 Feb 2023 19:40:19 +0000
Subject: [squid-users] repos/packages to install squid from source
In-Reply-To: <e5f609ec-0b06-3a2b-d9d0-913bd53c9419@measurement-factory.com>
References: <CAGU_Ci+spLvPKL4A=t6Y0DLKDPqkSpw3Y09YwFWjrbCgxeWHow@mail.gmail.com>
 <e5f609ec-0b06-3a2b-d9d0-913bd53c9419@measurement-factory.com>
Message-ID: <CAGU_CiLhTeM_WaeNVrrxVWzQ2q3B4Y9i_MP8-vX7tMtO5ZpNiw@mail.gmail.com>

sorry i forgot to mention, its Alma Linux

On Thu, 16 Feb 2023 at 19:38, Alex Rousskov <
rousskov at measurement-factory.com> wrote:

> On 2/16/23 11:41, robert k Wild wrote:
>
> > installing squid from source and just want to know what default
> > repos/packages i should have before i install
> >
> > atm i have these
> >
> > #install epel repositry
> > dnf install -y epel-release
> > #install squid packages
> > dnf install -y gcc-c++ gcc g++ binutils make sudo wget tar automake
> > autoconf perl libxml2-devel libcap-devel openssl openssl-devel libarchive
> > #install clamAV packages
> > dnf install -y clamd clamav clamav-data clamav-devel clamav-lib
> > clamav-update
> >
> > do i need anymore?
>
> Squid does not really have a concept of "default" dependencies. In
> practice, the list of dependencies is determined by what you need your
> Squid to do.
>
> FWIW, some of the Squid CI tests running on Ubuntu install the following
> packages, but this is not a complete list of everything that a
> particular Squid may need or may use:
>
> comerr-dev:amd64
> debhelper
> dh-apparmor
> dh-autoreconf
> dh-strip-nondeterminism
> dwz
> gettext
> intltool-debian
> krb5-multidev:amd64
> libarchive-zip-perl
> libcap-dev:amd64
> libcppunit-1.15-0:amd64
> libcppunit-dev:amd64
> libdebhelper-perl
> libecap3-dev:amd64
> libecap3:amd64
> libevent-2.1-7:amd64
> libfile-stripnondeterminism-perl
> libfl2:amd64
> libgnutls-dane0:amd64
> libgnutls-openssl27:amd64
> libgnutls28-dev:amd64
> libgnutlsxx28:amd64
> libgssrpc4:amd64
> libidn2-dev:amd64
> libkadm5clnt-mit12:amd64
> libkadm5srv-mit12:amd64
> libkdb5-10:amd64
> libkrb5-dev:amd64
> libldap-dev:amd64
> libldap2-dev
> libnetfilter-conntrack-dev:amd64
> libnfnetlink-dev
> libosp5
> libp11-kit-dev:amd64
> libpam0g-dev:amd64
> libsasl2-dev
> libsub-override-perl
> libsystemd-dev:amd64
> libtasn1-6-dev:amd64
> libtdb-dev:amd64
> libunbound8:amd64
> linuxdoc-tools
> nettle-dev:amd64
> opensp
> po-debconf
> sgml-base
> sgml-data
> xml-core
>
>
> Most of the above come from "apt-get build-dep squid" executed in that
> CI environment
>
>
> HTH,
>
> Alex.
>
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users
>


-- 
Regards,

Robert K Wild.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230216/cbbb01c0/attachment.htm>

From squid3 at treenet.co.nz  Fri Feb 17 01:13:47 2023
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Fri, 17 Feb 2023 14:13:47 +1300
Subject: [squid-users] Reverse Proxy Redirect - Stops in Browser
In-Reply-To: <56bfadbc-7b76-4f40-9c1f-af9ac32f8890@app.fastmail.com>
References: <56bfadbc-7b76-4f40-9c1f-af9ac32f8890@app.fastmail.com>
Message-ID: <23ba3fa3-dea2-5e74-bb26-07fd0dd7667a@treenet.co.nz>

On 16/02/2023 10:56 am, squid wrote:
> I have a reverse proxy that that does the following:
>
> acl example_www url_regex -i ^https?:\/\/example-www?.example.com.*
> http_access allow internal_IPs example_www
> deny_info https://other-www.other.com%R example_www
> http_access deny example_www
>
> When a tool or a browser goes to http://example-www.example.com it immediately sends them to https://other-www.other.com as expected.

When opening an http:// URL Browsers etc send a message with the full 
URL including path to Squid. That provides the %R information your rules 
use to redirect them.

Browser:
 ? GET http://example-www.example.com/path HTTP/1.1
 ? ...

Squid:
 ? HTTP/1.1 304
 ? ...
 ? Location: https://other-www.other.com/path

Browser:
 ?? ... initiates request for https://other-www.other.com/path

> When a tool or a browser goes to https://example-www.example.com it brings up in chrome the Your connection is not private page and when you hit Advanced and hit the allow to proceed it is then redirected to the site.


When opening an https:// URL Browsers etc send a CONNECT message 
requesting Squid open a tunnel to the server. That lacks the %R 
information your rules use.

Browser:
 ? CONNECT example-www.example.com:443 HTTP/1.1
 ? ...

Squid:
 ? HTTP/1.1 304
 ? ...
 ? Location: https://other-www.other.com/

Browser:
 ? ... initiate request for https://other-www.other.com/


> This is causing us come compliance issues due to the tool thinking we are running a non-compliant https page since user interaction is required to get to the other page.
>
> Is there a way to send to the other page earlier so the tool or user doesn't even see the Your connection is not private page?  I just want to only aloow the internal IPs and cut everyone else off.

As you noticed the Browser displays that warning dialog when it receives 
a 304. AFAIK, the only response status that Browser permit to do 
anything at all on a CONNECT request are the 200 and 304 ones. 
Everything else gets replaced by a Browsers error page. The non-Browser 
tools may display an error from Squid, YMMV based on tool.

Squid contains the SSL-Bump feature to decrypt the TLS inside the 
tunnel. If you have the clients trusting Squid CA certificate you can 
decrypt the TLS and redirect those messages instead of the CONNECT tunnel.


> I've tried taking out the deny_info, but that sends the user and tool to a squid error page which basically fails the test as well since it's on the same site.
> I've also tried doing a TCP_RESET instead, but for some reason the squid actually send the word reset back to the client the first time and again would fail the test.

That is a bug. It should be delivering only a TCP RST packet, not any 
text words. Which Squid version are you using?

If you end up using SSL-Bump it has a "terminate" action which does the 
same/equivalent for TLS protocol.

HTH
Amos



From ankor2023 at gmail.com  Fri Feb 17 06:29:08 2023
From: ankor2023 at gmail.com (Andrey K)
Date: Fri, 17 Feb 2023 09:29:08 +0300
Subject: [squid-users] Log 407-transactions when username is known
Message-ID: <CADJd0Y11L3Y8cF4tY3Z2uevQXf-9=LAqiR3fZ1s7jx89BUFMvQ@mail.gmail.com>

Hello,

I would like to disable logging of 407-errors, except when the username is
known.
Is it possible to configure?

I have now the log configured:
acl http-407 http_status 407
access_log daemon:/var/log/squid/access.log logformat=extended-squid
on-error=drop !http-407

But I would also like to see authentication errors when a user types the
wrong password (the username is known in these cases).

Kind regards,
      Ankor.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230217/c4f4e1ea/attachment.htm>

From tibor.matyas at dsi-as.de  Fri Feb 17 09:09:14 2023
From: tibor.matyas at dsi-as.de (MATYAS, Tibor)
Date: Fri, 17 Feb 2023 10:09:14 +0100
Subject: [squid-users] Portal Splash Page 4.7 -> 5.7 FATAL:
 (ext_session_acl): Failed to open session db
Message-ID: <7ec11549-164f-7aa2-87ce-ef87dd7f3303@dsi-as.de>

Hello List,

trying to move from 4.7 to 5.7 (on gentoo Linux).
Splash portal is in use 
https://wiki.squid-cache.org/ConfigExamples/Portal/Splash

squid -k parse -> OK
/var/lib/squid/session/ is clean, old berkeleyDB session files deleted.
Owner of the folder is the squid user.

Squid compiled with tdb:

Squid Cache: Version 5.7
Service Name: squid
Gentoo squid-5.7-r1 (r: NONE)
This binary uses OpenSSL 1.1.1t? 7 Feb 2023. For legal restrictions on 
distribution see https://www.openssl.org/source/license.html
configure options:? '--prefix=/usr' '--build=x86_64-pc-linux-gnu' 
'--host=x86_64-pc-linux-gnu' '--mandir=/usr/share/man' 
'--infodir=/usr/share/info' '--datadir=/usr/share' '--sysconfdir=/etc' 
'--localstatedir=/var/lib' '--datarootdir=/usr/share' 
'--disable-dependency-tracking' '--disable-silent-rules' 
'--disable-static' '--docdir=/usr/share/doc/squid-5.7-r1' 
'--htmldir=/usr/share/doc/squid-5.7-r1/html' '--with-sysroot=/' 
'--libdir=/usr/lib64' '--datadir=/usr/share/squid' 
'--libexecdir=/usr/libexec/squid' '--localstatedir=/var' 
'--sysconfdir=/etc/squid' '--with-default-user=squid' 
'--with-logdir=/var/log/squid' '--with-pidfile=/run/squid.pid' 
'--enable-build-info=Gentoo squid-5.7-r1 (r: NONE)' 
'--enable-log-daemon-helpers' '--enable-url-rewrite-helpers' 
'--enable-cache-digests' '--enable-delay-pools' '--enable-disk-io' 
'--enable-eui' '--enable-icmp' '--enable-ipv6' 
'--enable-follow-x-forwarded-for' '--enable-removal-policies=lru,heap' 
'--disable-strict-error-checking' '--disable-arch-native' 
'--with-large-files' '--with-build-environment=default' '--with-tdb' 
'--without-included-ltdl' '--with-ltdl-include=/usr/include' 
'--with-ltdl-lib=/usr/lib64' '--with-libcap' '--enable-snmp' 
'--with-openssl' '--with-nettle' '--with-gnutls' '--enable-ssl-crtd' 
'--without-systemd' '--without-cppunit' '--disable-ecap' '--disable-esi' 
'--disable-expat' '--disable-libxml2' '--enable-htcp' '--enable-wccp' 
'--enable-wccpv2' '--without-mit-krb5' '--without-heimdal-krb5' 
'--enable-linux-netfilter' '--enable-storeio=aufs,diskd,rock,ufs' 
'--enable-auth-basic=NCSA,POP3,getpwnam,PAM' '--enable-auth-digest=file' 
'--enable-auth-ntlm=none' '--enable-auth-negotiate=none' 
'--enable-external-acl-helpers=file_userip,session,unix_group,delayer,time_quota' 
'build_alias=x86_64-pc-linux-gnu' 'host_alias=x86_64-pc-linux-gnu' 
'CC=x86_64-pc-linux-gnu-gcc' 'CFLAGS=-march=nocona -O2 -pipe 
-fomit-frame-pointer' 'LDFLAGS=-Wl,-O1 -Wl,--as-needed' 
'CXXFLAGS=-march=nocona -O2 -pipe -fomit-frame-pointer' 
'BUILDCXX=x86_64-pc-linux-gnu-g++' 'BUILDCXXFLAGS=-march=nocona -O2 
-pipe -fomit-frame-pointer'

starting squid results in:

FATAL: (ext_session_acl): Failed to open session db 
'/var/lib/squid/session/session'
2023/02/17 09:21:11 kid1| WARNING: external_acl_type #Hlpr27652 exited
 ??? current master transaction: master3
2023/02/17 09:21:11 kid1| Too few external_acl_type processes are 
running (need 1/1)
 ??? current master transaction: master3
2023/02/17 09:21:11 kid1| Starting new helpers
 ??? current master transaction: master3
2023/02/17 09:21:11 kid1| helperOpenServers: Starting 1/1 
'ext_session_acl' processes
 ??? current master transaction: master3

What am I missing?

Thanks a lot and br
Tibor




--------------------------------------------------
DSI Aerospace Technologie GmbH

Sitz der Gesellschaft: Otto-Lilienthal-Str. 1, D-28199 Bremen, Germany
Web: http://www.dsi-as.de

Geschaeftsfuehrer: Dr.-Ing. Christian Dierker
                   M. Sc. Elias Hashem

HRB 17726, Amtsgericht Bremen
USt-IdNr.: DE 192 681 774
--------------------------------------------------





From divan.whelk.0u at icloud.com  Fri Feb 17 11:14:10 2023
From: divan.whelk.0u at icloud.com (divan.whelk.0u at icloud.com)
Date: Fri, 17 Feb 2023 11:14:10 +0000
Subject: [squid-users] Understanding maximum outgoing HTTP CONNECT requests?
Message-ID: <2392320D-4BEF-4A93-9322-0344EA18EC77@kontos-home.com>

Hi there!

I?m trying to understand what would the ?theoretical? maximum amount of outgoing connections with squid setup as a HTTP CONNECT forward proxy would be (hardware permitting)?

From the [squid-users] About bottlenecks (Max number of connections, etc.) thread, I saw mention of the following:

> * The limit on number of connections any Squid can have attached is only limited by your configured FD limits and available server RAM. Squid uses ~64 KB per network socket for traffic state - which equates to around 2 GB of RAM just for I/O buffers at 20,000 concurrent client connections.

I assume the same would not apply on outgoing connections, and that there would be a limit of 65,536 connections to a single IP, port pair? For example, if we had 1 million users making requests via HTTP CONNECT, only 65K of them would be able to access the same website at any one time?

Thanks.

From tibor.matyas at dsi-as.de  Fri Feb 17 14:20:50 2023
From: tibor.matyas at dsi-as.de (MATYAS, Tibor)
Date: Fri, 17 Feb 2023 15:20:50 +0100
Subject: [squid-users] Portal Splash Page 4.7 -> 5.7 FATAL:
 (ext_session_acl): Failed to open session db
In-Reply-To: <7ec11549-164f-7aa2-87ce-ef87dd7f3303@dsi-as.de>
References: <7ec11549-164f-7aa2-87ce-ef87dd7f3303@dsi-as.de>
Message-ID: <e9176547-ae57-1a7b-99bf-093d280fecaf@dsi-as.de>

Here are my further experiments:
#1 Created an empty tdb database with tdbtool,
the errors are gone, although no sessions are stored, the file remains 
untouched.

#2 recompiled squid without tdb -> fallback to berkeleydb ? like in 4.x:
same errors in the log:

FATAL: (ext_session_acl): Failed to open session db '/tmp/session/session'
2023/02/17 15:09:15 kid1| WARNING: external_acl_type #Hlpr112520 exited
 ??? current master transaction: master3
2023/02/17 15:09:15 kid1| Too few external_acl_type processes are 
running (need 1/5)
 ??? current master transaction: master3
2023/02/17 15:09:15 kid1| Starting new helpers
 ??? current master transaction: master3
2023/02/17 15:09:15 kid1| helperOpenServers: Starting 1/5 
'ext_session_acl' processes
 ??? current master transaction: master3
FATAL: (ext_session_acl): Failed to open session db '/tmp/session/session'
2023/02/17 15:09:15 kid1| WARNING: external_acl_type #Hlpr112521 exited
 ??? current master transaction: master3
2023/02/17 15:09:15 kid1| Too few external_acl_type processes are 
running (need 1/5)
 ??? current master transaction: master3
2023/02/17 15:09:15 kid1| Starting new helpers
 ??? current master transaction: master3
2023/02/17 15:09:15 kid1| helperOpenServers: Starting 1/5 
'ext_session_acl' processes
 ??? current master transaction: master3

An empty session file with zero byte is always created (with or without 
tdb), and then the error flow.

Searched on the internet without result. Hopefully someone is still 
using splash with version 5

br, Tibor

Am 17.02.2023 um 10:09 schrieb MATYAS, Tibor:
> Hello List,
>
> trying to move from 4.7 to 5.7 (on gentoo Linux).
> Splash portal is in use 
> https://wiki.squid-cache.org/ConfigExamples/Portal/Splash
>
> squid -k parse -> OK
> /var/lib/squid/session/ is clean, old berkeleyDB session files deleted.
> Owner of the folder is the squid user.
>
> Squid compiled with tdb:
>
> Squid Cache: Version 5.7
> Service Name: squid
> Gentoo squid-5.7-r1 (r: NONE)
> This binary uses OpenSSL 1.1.1t? 7 Feb 2023. For legal restrictions on 
> distribution see https://www.openssl.org/source/license.html
> configure options:? '--prefix=/usr' '--build=x86_64-pc-linux-gnu' 
> '--host=x86_64-pc-linux-gnu' '--mandir=/usr/share/man' 
> '--infodir=/usr/share/info' '--datadir=/usr/share' '--sysconfdir=/etc' 
> '--localstatedir=/var/lib' '--datarootdir=/usr/share' 
> '--disable-dependency-tracking' '--disable-silent-rules' 
> '--disable-static' '--docdir=/usr/share/doc/squid-5.7-r1' 
> '--htmldir=/usr/share/doc/squid-5.7-r1/html' '--with-sysroot=/' 
> '--libdir=/usr/lib64' '--datadir=/usr/share/squid' 
> '--libexecdir=/usr/libexec/squid' '--localstatedir=/var' 
> '--sysconfdir=/etc/squid' '--with-default-user=squid' 
> '--with-logdir=/var/log/squid' '--with-pidfile=/run/squid.pid' 
> '--enable-build-info=Gentoo squid-5.7-r1 (r: NONE)' 
> '--enable-log-daemon-helpers' '--enable-url-rewrite-helpers' 
> '--enable-cache-digests' '--enable-delay-pools' '--enable-disk-io' 
> '--enable-eui' '--enable-icmp' '--enable-ipv6' 
> '--enable-follow-x-forwarded-for' '--enable-removal-policies=lru,heap' 
> '--disable-strict-error-checking' '--disable-arch-native' 
> '--with-large-files' '--with-build-environment=default' '--with-tdb' 
> '--without-included-ltdl' '--with-ltdl-include=/usr/include' 
> '--with-ltdl-lib=/usr/lib64' '--with-libcap' '--enable-snmp' 
> '--with-openssl' '--with-nettle' '--with-gnutls' '--enable-ssl-crtd' 
> '--without-systemd' '--without-cppunit' '--disable-ecap' 
> '--disable-esi' '--disable-expat' '--disable-libxml2' '--enable-htcp' 
> '--enable-wccp' '--enable-wccpv2' '--without-mit-krb5' 
> '--without-heimdal-krb5' '--enable-linux-netfilter' 
> '--enable-storeio=aufs,diskd,rock,ufs' 
> '--enable-auth-basic=NCSA,POP3,getpwnam,PAM' 
> '--enable-auth-digest=file' '--enable-auth-ntlm=none' 
> '--enable-auth-negotiate=none' 
> '--enable-external-acl-helpers=file_userip,session,unix_group,delayer,time_quota' 
> 'build_alias=x86_64-pc-linux-gnu' 'host_alias=x86_64-pc-linux-gnu' 
> 'CC=x86_64-pc-linux-gnu-gcc' 'CFLAGS=-march=nocona -O2 -pipe 
> -fomit-frame-pointer' 'LDFLAGS=-Wl,-O1 -Wl,--as-needed' 
> 'CXXFLAGS=-march=nocona -O2 -pipe -fomit-frame-pointer' 
> 'BUILDCXX=x86_64-pc-linux-gnu-g++' 'BUILDCXXFLAGS=-march=nocona -O2 
> -pipe -fomit-frame-pointer'
>
> starting squid results in:
>
> FATAL: (ext_session_acl): Failed to open session db 
> '/var/lib/squid/session/session'
> 2023/02/17 09:21:11 kid1| WARNING: external_acl_type #Hlpr27652 exited
> ??? current master transaction: master3
> 2023/02/17 09:21:11 kid1| Too few external_acl_type processes are 
> running (need 1/1)
> ??? current master transaction: master3
> 2023/02/17 09:21:11 kid1| Starting new helpers
> ??? current master transaction: master3
> 2023/02/17 09:21:11 kid1| helperOpenServers: Starting 1/1 
> 'ext_session_acl' processes
> ??? current master transaction: master3
>
> What am I missing?
>
> Thanks a lot and br
> Tibor
>
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users



--------------------------------------------------
DSI Aerospace Technologie GmbH

Sitz der Gesellschaft: Otto-Lilienthal-Str. 1, D-28199 Bremen, Germany
Web: http://www.dsi-as.de

Geschaeftsfuehrer: Dr.-Ing. Christian Dierker
                   M. Sc. Elias Hashem

HRB 17726, Amtsgericht Bremen
USt-IdNr.: DE 192 681 774
--------------------------------------------------





From maciej.leks at gmail.com  Fri Feb 17 14:31:18 2023
From: maciej.leks at gmail.com (Maciej Leks)
Date: Fri, 17 Feb 2023 15:31:18 +0100
Subject: [squid-users] Squid returns 500 on rapidly changing DNS records
Message-ID: <CACSz3ZRnNHbU4p05H2YuWVKTuF8LW1kzs37BmDs1BUSPV043kw@mail.gmail.com>

Hello,

We have being facing the 500 error codes in our squids (v5.7) when it
comes to communicate with Salesforce DNS for ephemeral hosts (they
live no longer than 30 days but we can delete at any moments, SF calls
them scratches):

Let's have a look at some DNS req/res for some scratch:
$dog shoyu-lagoon-5538.scratch.my.salesforce.com
CNAME shoyu-lagoon-5538.scratch.my.salesforce.com. 21s   "cs128.salesforce.com."
CNAME cs128.salesforce.com.                        21s
"cs128-fra.salesforce.com."
CNAME cs128-fra.salesforce.com.                    21s
"cs128-fra.fra.r.salesforce.com."
    A cs128-fra.fra.r.salesforce.com.              30s   85.222.154.211
    A cs128-fra.fra.r.salesforce.com.              30s   160.8.252.83
    A cs128-fra.fra.r.salesforce.com.              30s   85.222.152.83

Yep, 30 seconds. From time to time DNS answers only sending SOA record
(no A,AAAA records), e..g

dig:
IP address of sagittarius-oatmilk-722.scratch.my.salesforce.com is
cs128.salesforce.com.
cs128-fra.salesforce.com.
cs128-fra.fra.r.salesforce.com.
160.8.255.83
160.8.249.83
85.222.154.211
Failed to resolve sagittarius-oatmilk-722.scratch.my.salesforce.com
Failed to resolve sagittarius-oatmilk-722.scratch.my.salesforce.com
Failed to resolve sagittarius-oatmilk-722.scratch.my.salesforce.com
Failed to resolve sagittarius-oatmilk-722.scratch.my.salesforce.com
IP address of sagittarius-oatmilk-722.scratch.my.salesforce.com is
cs128.salesforce.com.
cs128-fra.salesforce.com.
cs128-fra.fra.r.salesforce.com.
85.222.154.211
160.8.255.83
160.8.249.83
IP address of sagittarius-oatmilk-722.scratch.my.salesforce.com is
cs128.salesforce.com.
cs128-fra.salesforce.com.
cs128-fra.fra.r.salesforce.com.
160.8.253.83

Squid outputs then:
16/Feb/2023:13:45:54 +0100 1676551554.420    107 100.113.24.84
100.113.24.84 NONE_NONE/500 0 CONNECT
canal-trailblazer-1066.scratch.my.salesforce.com:443 - HIER_NONE/- - -
- "/CN=gitlab-executor-stg.navio-services.opl-gcp.int"
16/Feb/2023:13:51:55 +0100 1676551915.973     82 100.113.25.178
100.113.25.178 NONE_NONE/500 0 CONNECT
pumpkinspice-pisces-6588.scratch.my.salesforce.com:443 - HIER_NONE/- -
- - "/CN=gitlab-executor-stg.navio-services.opl-gcp.int"
16/Feb/2023:13:52:44 +0100 1676551964.285     95 100.113.24.84
100.113.24.84 NONE_NONE/500 0 CONNECT
trailblazer-builder-1043.scratch.file.force.com:443 - HIER_NONE/- - -
Mozilla/5.0%20(X11;%20Linux%20x86_64)%20AppleWebKit/537.36%20(KHTML,%20like%20Gecko)%20HeadlessChrome/109.0.5414.74%20Safari/537.36
"/CN=gitlab-executor-stg.navio-services.opl-gcp.int"
16/Feb/2023:13:56:11 +0100 1676552171.392     43 100.121.10.183
100.121.10.183 NONE_NONE/500 0 CONNECT
pistachio-vente-806.scratch.my.salesforce.com:443 - HIER_NONE/- - - -
"/CN=gitlab-executor-stg.navio-services.opl-gcp.int"


Child squids get then (the same situation but different case):
17/Feb/2023:13:18:49 +0000 1676639929.989 88 100.121.10.104
TCP_TUNNEL/500 0 CONNECT
beans-goldengate-9524.scratch.my.salesforce.com:443 -
ANY_OLD_PARENT/100.112.36.14 -

Such a situation but not the same case from squid internals point of
view I list below:
74,5| RequestParser.cc(377) doParse: request-line: retval 1:
line={266, data='CONNECT
baybridge-module-8155.scratch.my.salesforce.com:443 HTTP/1.1
Host: baybridge-module-8155.scratch.my.salesforce.com:443
2023/02/15 15:44:24.223 kid1| 74,5| RequestParser.cc(379) doParse:
request-line: url: baybridge-module-8155.scratch.my.salesforce.com:443
2023/02/15 15:44:24.223 kid1| 74,5| Parser.cc(192) grabMimeBlock: mime
header (0-196) {Host:
baybridge-module-8155.scratch.my.salesforce.com:443
CONNECT baybridge-module-8155.scratch.my.salesforce.com:443 HTTP/1.1
Host: baybridge-module-8155.scratch.my.salesforce.com:443
Host: baybridge-module-8155.scratch.my.salesforce.com:443
2023/02/15 15:44:24.223 kid1| 23,3| Uri.cc(441) parse: Split URL
'baybridge-module-8155.scratch.my.salesforce.com:443' into proto='',
host='baybridge-module-8155.scratch.my.salesforce.com', port='443',
path=''
2023/02/15 15:44:24.223 kid1| 14,3| Address.cc(389) lookupHostIP:
Given Non-IP 'baybridge-module-8155.scratch.my.salesforce.com': Name
or service not known
2023/02/15 15:44:24.223 kid1| 33,5| Http1Server.cc(193)
buildHttpRequest: normalize 1 Host header using
baybridge-module-8155.scratch.my.salesforce.com:443
2023/02/15 15:44:24.224 kid1| 85,3| client_side_request.cc(637)
hostHeaderVerify: validate
host=baybridge-module-8155.scratch.my.salesforce.com, port=443,
portStr=443
2023/02/15 15:44:24.224 kid1| 14,3| ipcache.cc(722)
ipcache_gethostbyname: ipcache_gethostbyname:
'baybridge-module-8155.scratch.my.salesforce.com', flags=1
2023/02/15 15:44:24.224 kid1| 14,3| ipcache.cc(310) ipcacheRelease:
ipcacheRelease: Releasing entry for
'baybridge-module-8155.scratch.my.salesforce.com'
2023/02/15 15:44:24.224 kid1| 14,3| Address.cc(389) lookupHostIP:
Given Non-IP 'baybridge-module-8155.scratch.my.salesforce.com': Name
or service not known
2023/02/15 15:44:24.224 kid1| 14,4| ipcache.cc(600)
ipcache_nbgethostbyname:
baybridge-module-8155.scratch.my.salesforce.com
2023/02/15 15:44:24.224 kid1| 14,3| Address.cc(389) lookupHostIP:
Given Non-IP 'baybridge-module-8155.scratch.my.salesforce.com': Name
or service not known
2023/02/15 15:44:24.224 kid1| 14,5| ipcache.cc(660)
ipcache_nbgethostbyname_: ipcache_nbgethostbyname: MISS for
'baybridge-module-8155.scratch.my.salesforce.com'
2023/02/15 15:44:24.224 kid1| 78,3| dns_internal.cc(1788) idnsALookup:
idnsALookup: buf is 65 bytes for
baybridge-module-8155.scratch.my.salesforce.com, id = 0x9c4
2023/02/15 15:44:24.224 kid1| 78,3| dns_internal.cc(1724)
idnsSendSlaveAAAAQuery: buf is 65 bytes for
baybridge-module-8155.scratch.my.salesforce.com, id = 0x5b5e
2023/02/15 15:44:24.224 kid1| 28,3| DestinationIp.cc(78) match: can't
yet compare 'to_localhost' ACL for
baybridge-module-8155.scratch.my.salesforce.com
2023/02/15 15:44:24.224 kid1| 14,4| ipcache.cc(600)
ipcache_nbgethostbyname:
baybridge-module-8155.scratch.my.salesforce.com
2023/02/15 15:44:24.224 kid1| 14,3| Address.cc(389) lookupHostIP:
Given Non-IP 'baybridge-module-8155.scratch.my.salesforce.com': Name
or service not known
2023/02/15 15:44:24.224 kid1| 14,5| ipcache.cc(660)
ipcache_nbgethostbyname_: ipcache_nbgethostbyname: MISS for
'baybridge-module-8155.scratch.my.salesforce.com'
2023/02/15 15:44:24.247 kid1| 14,3| ipcache.cc(456) latestError: DNS
error while resolving baybridge-module-8155.scratch.my.salesforce.com:
No DNS records
2023/02/15 15:44:24.248 kid1| 14,3| ipcache.cc(456) latestError: DNS
error while resolving baybridge-module-8155.scratch.my.salesforce.com:
No DNS records
2023/02/15 15:44:24.282 kid1| 14,3| ipcache.cc(477) ipcacheParse: 3
answers for baybridge-module-8155.scratch.my.salesforce.com
2023/02/15 15:44:24.282 kid1| 14,3| ipcache.cc(576)
ipcacheHandleReply: done with
baybridge-module-8155.scratch.my.salesforce.com: [no cached IPs]
2023/02/15 15:44:24.282 kid1| 14,3| ipcache.cc(477) ipcacheParse: 3
answers for baybridge-module-8155.scratch.my.salesforce.com
2023/02/15 15:44:24.282 kid1| 14,3| ipcache.cc(576)
ipcacheHandleReply: done with
baybridge-module-8155.scratch.my.salesforce.com: [no cached IPs]
2023/02/15 15:44:24.282 kid1| 14,3| ipcache.cc(310) ipcacheRelease:
ipcacheRelease: Releasing entry for
'baybridge-module-8155.scratch.my.salesforce.com'
2023/02/15 15:44:24.282 kid1| 14,3| ipcache.cc(722)
ipcache_gethostbyname: ipcache_gethostbyname:
'baybridge-module-8155.scratch.my.salesforce.com', flags=1
2023/02/15 15:44:24.282 kid1| 28,3| DomainData.cc(110) match:
aclMatchDomainList: checking
'baybridge-module-8155.scratch.my.salesforce.com'
2023/02/15 15:44:24.282 kid1| 28,3| DomainData.cc(115) match:
aclMatchDomainList: 'baybridge-module-8155.scratch.my.salesforce.com'
NOT found
2023/02/15 15:44:24.283 kid1| 28,3| DomainData.cc(110) match:
aclMatchDomainList: checking
'baybridge-module-8155.scratch.my.salesforce.com'
2023/02/15 15:44:24.283 kid1| 28,3| DomainData.cc(115) match:
aclMatchDomainList: 'baybridge-module-8155.scratch.my.salesforce.com'
found
2023/02/15 15:44:24.283 kid1| 85,2| client_side_request.cc(745)
clientAccessCheckDone: The request CONNECT
baybridge-module-8155.scratch.my.salesforce.com:443 is ALLOWED; last
ACL checked: gitlab-executor-stg-dst
2023/02/15 15:44:24.284 kid1| 85,2| client_side_request.cc(745)
clientAccessCheckDone: The request CONNECT
baybridge-module-8155.scratch.my.salesforce.com:443 is ALLOWED; last
ACL checked: gitlab-executor-stg-dst
2023/02/15 15:44:24.284 kid1| 85,4| client_side_request.cc(1514)
processRequest: CONNECT
baybridge-module-8155.scratch.my.salesforce.com:443
2023/02/15 15:44:24.284 kid1| 26,3| tunnel.cc(1140) tunnelStart:
CONNECT baybridge-module-8155.scratch.my.salesforce.com:443 HTTP/1.1
2023/02/15 15:44:24.284 kid1| 44,3| peer_select.cc(612) selectMore:
CONNECT baybridge-module-8155.scratch.my.salesforce.com
2023/02/15 15:44:24.284 kid1| 44,3| peer_select.cc(1098) addSelection:
adding HIER_DIRECT#baybridge-module-8155.scratch.my.salesforce.com
2023/02/15 15:44:24.284 kid1| 44,2| peer_select.cc(460)
resolveSelected: Find IP destination for:
baybridge-module-8155.scratch.my.salesforce.com:443' via
baybridge-module-8155.scratch.my.salesforce.com
2023/02/15 15:44:24.284 kid1| 14,4| ipcache.cc(607) nbgethostbyname:
baybridge-module-8155.scratch.my.salesforce.com
2023/02/15 15:44:24.284 kid1| 14,3| Address.cc(389) lookupHostIP:
Given Non-IP 'baybridge-module-8155.scratch.my.salesforce.com': Name
or service not known
2023/02/15 15:44:24.284 kid1| 14,4| ipcache.cc(647)
ipcache_nbgethostbyname_: ipcache_nbgethostbyname: HIT for
'baybridge-module-8155.scratch.my.salesforce.com'
2023/02/15 15:44:24.284 kid1| 44,2| peer_select.cc(479)
resolveSelected: PeerSelector4664913 found all 0 destinations for
baybridge-module-8155.scratch.my.salesforce.com:443
2023/02/15 15:44:24.284 kid1| 4,3| errorpage.cc(1249)
compileLegacyCode: %U -->
'https://baybridge-module-8155.scratch.my.salesforce.com/*'
2023/02/15 15:44:24.284 kid1| 4,3| errorpage.cc(1249)
compileLegacyCode: %U -->
'https://baybridge-module-8155.scratch.my.salesforce.com/*'
2023/02/15 15:44:24.284 kid1| 4,3| errorpage.cc(1249)
compileLegacyCode: %W -->
'?subject=CacheErrorInfo%20-%20ERR_CANNOT_FORWARD&body=CacheHost%3A%20opl-egress-proxy-vm-31vr%0D%0AErrPage%3A%20ERR_CANNOT_FORWARD%0D%0AErr%3A%20%5Bnone%5D%0D%0ATimeStamp%3A%20Wed,%2015%20Feb%202023%2014%3A44%3A24%20GMT%0D%0A%0D%0AClientIP%3A%20100.121.10.148%0D%0A%0D%0AHTTP%20Request%3A%0D%0ACONNECT%20%20HTTP%2F1.1%0AVia%3A%201.1%20gitlab-proxy-6d445dbd8d-mxtqv%20(squid%2F5.7)%0D%0AX-Forwarded-For%3A%20100.113.24.224%0D%0ACache-Control%3A%20max-age%3D259200%0D%0AConnection%3A%20close%0D%0AHost%3A%20baybridge-module-8155.scratch.my.salesforce.com%3A443%0D%0A%0D%0A%0D%0A'
2023/02/15 15:44:24.286 kid1| 33,3| client_side_request.cc(272)
~ClientHttpRequest: httpRequestFree:
baybridge-module-8155.scratch.my.salesforce.com:443
2023/02/15 15:44:24.286 kid1| 33,5| client_side.cc(385) logRequest:
logging half-baked transaction:
baybridge-module-8155.scratch.my.salesforce.com:443

Our parent proxy settings for DNS:
negative_dns_ttl 3 seconds  #if we set 1s it behaves the same
dns_nameservers 8.8.8.8 1.1.1.1

The question is:
If you carefully look at the debug log you see:
a. I(Squid) can't find IP for the name
b. I've got 3 IPs from DNS
c. OK, so I've got IP
d. ...Oh, I cannot find any IP
e. I can't find any destinations (what's that?)
f. I'm outputing an error

So, do you think it's ok or there is a bug?

Rgds,
Maciej Leks


From rousskov at measurement-factory.com  Fri Feb 17 16:30:40 2023
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Fri, 17 Feb 2023 11:30:40 -0500
Subject: [squid-users] Portal Splash Page 4.7 -> 5.7 FATAL:
 (ext_session_acl): Failed to open session db
In-Reply-To: <e9176547-ae57-1a7b-99bf-093d280fecaf@dsi-as.de>
References: <7ec11549-164f-7aa2-87ce-ef87dd7f3303@dsi-as.de>
 <e9176547-ae57-1a7b-99bf-093d280fecaf@dsi-as.de>
Message-ID: <65f5b301-16e3-fc71-5043-7d1017422c04@measurement-factory.com>

On 2/17/23 09:20, MATYAS, Tibor wrote:

> FATAL: (ext_session_acl): Failed to open session db '/tmp/session/session'

> An empty session file with zero byte is always created (with or
> without tdb), and then the error flow.

This is a long shot, but check permissions of that file (and its 
directory). Will Squid effective user be able to open that file for 
writing? I would expect the helper to not be able to create a file at 
all if this is a permissions issue, but it is easy to check.

If checking permissions does not give you an answer, I would try 
wrapping the helper in a script to strace it (or equivalent). If you are 
lucky, you will see a failed helper system call just before the helper 
system calls that emit the above error message. That failure may explain 
what is going on.

If nothing helps, I would attach gdb to the helper, but that requires 
even more work.


HTH,

Alex.


> Am 17.02.2023 um 10:09 schrieb MATYAS, Tibor:
>> Hello List,
>>
>> trying to move from 4.7 to 5.7 (on gentoo Linux).
>> Splash portal is in use 
>> https://wiki.squid-cache.org/ConfigExamples/Portal/Splash
>>
>> squid -k parse -> OK
>> /var/lib/squid/session/ is clean, old berkeleyDB session files deleted.
>> Owner of the folder is the squid user.
>>
>> Squid compiled with tdb:
>>
>> Squid Cache: Version 5.7
>> Service Name: squid
>> Gentoo squid-5.7-r1 (r: NONE)
>> This binary uses OpenSSL 1.1.1t? 7 Feb 2023. For legal restrictions on 
>> distribution see https://www.openssl.org/source/license.html
>> configure options:? '--prefix=/usr' '--build=x86_64-pc-linux-gnu' 
>> '--host=x86_64-pc-linux-gnu' '--mandir=/usr/share/man' 
>> '--infodir=/usr/share/info' '--datadir=/usr/share' '--sysconfdir=/etc' 
>> '--localstatedir=/var/lib' '--datarootdir=/usr/share' 
>> '--disable-dependency-tracking' '--disable-silent-rules' 
>> '--disable-static' '--docdir=/usr/share/doc/squid-5.7-r1' 
>> '--htmldir=/usr/share/doc/squid-5.7-r1/html' '--with-sysroot=/' 
>> '--libdir=/usr/lib64' '--datadir=/usr/share/squid' 
>> '--libexecdir=/usr/libexec/squid' '--localstatedir=/var' 
>> '--sysconfdir=/etc/squid' '--with-default-user=squid' 
>> '--with-logdir=/var/log/squid' '--with-pidfile=/run/squid.pid' 
>> '--enable-build-info=Gentoo squid-5.7-r1 (r: NONE)' 
>> '--enable-log-daemon-helpers' '--enable-url-rewrite-helpers' 
>> '--enable-cache-digests' '--enable-delay-pools' '--enable-disk-io' 
>> '--enable-eui' '--enable-icmp' '--enable-ipv6' 
>> '--enable-follow-x-forwarded-for' '--enable-removal-policies=lru,heap' 
>> '--disable-strict-error-checking' '--disable-arch-native' 
>> '--with-large-files' '--with-build-environment=default' '--with-tdb' 
>> '--without-included-ltdl' '--with-ltdl-include=/usr/include' 
>> '--with-ltdl-lib=/usr/lib64' '--with-libcap' '--enable-snmp' 
>> '--with-openssl' '--with-nettle' '--with-gnutls' '--enable-ssl-crtd' 
>> '--without-systemd' '--without-cppunit' '--disable-ecap' 
>> '--disable-esi' '--disable-expat' '--disable-libxml2' '--enable-htcp' 
>> '--enable-wccp' '--enable-wccpv2' '--without-mit-krb5' 
>> '--without-heimdal-krb5' '--enable-linux-netfilter' 
>> '--enable-storeio=aufs,diskd,rock,ufs' 
>> '--enable-auth-basic=NCSA,POP3,getpwnam,PAM' 
>> '--enable-auth-digest=file' '--enable-auth-ntlm=none' 
>> '--enable-auth-negotiate=none' 
>> '--enable-external-acl-helpers=file_userip,session,unix_group,delayer,time_quota' 'build_alias=x86_64-pc-linux-gnu' 'host_alias=x86_64-pc-linux-gnu' 'CC=x86_64-pc-linux-gnu-gcc' 'CFLAGS=-march=nocona -O2 -pipe -fomit-frame-pointer' 'LDFLAGS=-Wl,-O1 -Wl,--as-needed' 'CXXFLAGS=-march=nocona -O2 -pipe -fomit-frame-pointer' 'BUILDCXX=x86_64-pc-linux-gnu-g++' 'BUILDCXXFLAGS=-march=nocona -O2 -pipe -fomit-frame-pointer'
>>
>> starting squid results in:
>>
>> FATAL: (ext_session_acl): Failed to open session db 
>> '/var/lib/squid/session/session'
>> 2023/02/17 09:21:11 kid1| WARNING: external_acl_type #Hlpr27652 exited
>> ??? current master transaction: master3
>> 2023/02/17 09:21:11 kid1| Too few external_acl_type processes are 
>> running (need 1/1)
>> ??? current master transaction: master3
>> 2023/02/17 09:21:11 kid1| Starting new helpers
>> ??? current master transaction: master3
>> 2023/02/17 09:21:11 kid1| helperOpenServers: Starting 1/1 
>> 'ext_session_acl' processes
>> ??? current master transaction: master3
>>
>> What am I missing?
>>
>> Thanks a lot and br
>> Tibor
>>
>> _______________________________________________
>> squid-users mailing list
>> squid-users at lists.squid-cache.org
>> http://lists.squid-cache.org/listinfo/squid-users
> 
> 
> 
> --------------------------------------------------
> DSI Aerospace Technologie GmbH
> 
> Sitz der Gesellschaft: Otto-Lilienthal-Str. 1, D-28199 Bremen, Germany
> Web: http://www.dsi-as.de
> 
> Geschaeftsfuehrer: Dr.-Ing. Christian Dierker
>  ????????????????? M. Sc. Elias Hashem
> 
> HRB 17726, Amtsgericht Bremen
> USt-IdNr.: DE 192 681 774
> --------------------------------------------------
> 
> 
> 
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users



From rousskov at measurement-factory.com  Fri Feb 17 16:46:05 2023
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Fri, 17 Feb 2023 11:46:05 -0500
Subject: [squid-users] Squid returns 500 on rapidly changing DNS records
In-Reply-To: <CACSz3ZRnNHbU4p05H2YuWVKTuF8LW1kzs37BmDs1BUSPV043kw@mail.gmail.com>
References: <CACSz3ZRnNHbU4p05H2YuWVKTuF8LW1kzs37BmDs1BUSPV043kw@mail.gmail.com>
Message-ID: <9fc40c53-38ff-2234-2cdf-23d07cc77bfc@measurement-factory.com>

On 2/17/23 09:31, Maciej Leks wrote:

> We have being facing the 500 error codes in our squids (v5.7) when it
> comes to communicate with Salesforce DNS for ephemeral hosts

>     A cs128-fra.fra.r.salesforce.com.              30s   85.222.154.211
>     A cs128-fra.fra.r.salesforce.com.              30s   160.8.252.83
>     A cs128-fra.fra.r.salesforce.com.              30s   85.222.152.83

30s TTLs will naturally limit the time Squid can cache these IPs for.


> From time to time DNS answers only sending SOA record (no A,AAAA records)

Squid will fail to forward traffic if Squid does not have the 
destination IP address cached and its new DNS lookup returns no IPv4 or 
IPv6 records. Moreover, I am not 100% sure -- needs checking/testing -- 
but Squid might cache that "negative" no-IPs result (see 
negative_dns_ttl that defaults to 60 seconds).

Do all 500 error cases correspond to DNS answers without IPs? In other 
words, is there a 500 error case after a DNS answer with IPs (within 29 
seconds from each other)?

HTH,

Alex.
P.S. Sorry for not answering your questions below directly. I do not 
have the time to document what Squid debugging logs mean, and I 
recommend sharing them without analysis (by non-developers).


> dig:
> IP address of sagittarius-oatmilk-722.scratch.my.salesforce.com is
> cs128.salesforce.com.
> cs128-fra.salesforce.com.
> cs128-fra.fra.r.salesforce.com.
> 160.8.255.83
> 160.8.249.83
> 85.222.154.211
> Failed to resolve sagittarius-oatmilk-722.scratch.my.salesforce.com
> Failed to resolve sagittarius-oatmilk-722.scratch.my.salesforce.com
> Failed to resolve sagittarius-oatmilk-722.scratch.my.salesforce.com
> Failed to resolve sagittarius-oatmilk-722.scratch.my.salesforce.com
> IP address of sagittarius-oatmilk-722.scratch.my.salesforce.com is
> cs128.salesforce.com.
> cs128-fra.salesforce.com.
> cs128-fra.fra.r.salesforce.com.
> 85.222.154.211
> 160.8.255.83
> 160.8.249.83
> IP address of sagittarius-oatmilk-722.scratch.my.salesforce.com is
> cs128.salesforce.com.
> cs128-fra.salesforce.com.
> cs128-fra.fra.r.salesforce.com.
> 160.8.253.83
> 
> Squid outputs then:
> 16/Feb/2023:13:45:54 +0100 1676551554.420    107 100.113.24.84
> 100.113.24.84 NONE_NONE/500 0 CONNECT
> canal-trailblazer-1066.scratch.my.salesforce.com:443 - HIER_NONE/- - -
> - "/CN=gitlab-executor-stg.navio-services.opl-gcp.int"
> 16/Feb/2023:13:51:55 +0100 1676551915.973     82 100.113.25.178
> 100.113.25.178 NONE_NONE/500 0 CONNECT
> pumpkinspice-pisces-6588.scratch.my.salesforce.com:443 - HIER_NONE/- -
> - - "/CN=gitlab-executor-stg.navio-services.opl-gcp.int"
> 16/Feb/2023:13:52:44 +0100 1676551964.285     95 100.113.24.84
> 100.113.24.84 NONE_NONE/500 0 CONNECT
> trailblazer-builder-1043.scratch.file.force.com:443 - HIER_NONE/- - -
> Mozilla/5.0%20(X11;%20Linux%20x86_64)%20AppleWebKit/537.36%20(KHTML,%20like%20Gecko)%20HeadlessChrome/109.0.5414.74%20Safari/537.36
> "/CN=gitlab-executor-stg.navio-services.opl-gcp.int"
> 16/Feb/2023:13:56:11 +0100 1676552171.392     43 100.121.10.183
> 100.121.10.183 NONE_NONE/500 0 CONNECT
> pistachio-vente-806.scratch.my.salesforce.com:443 - HIER_NONE/- - - -
> "/CN=gitlab-executor-stg.navio-services.opl-gcp.int"
> 
> 
> Child squids get then (the same situation but different case):
> 17/Feb/2023:13:18:49 +0000 1676639929.989 88 100.121.10.104
> TCP_TUNNEL/500 0 CONNECT
> beans-goldengate-9524.scratch.my.salesforce.com:443 -
> ANY_OLD_PARENT/100.112.36.14 -
> 
> Such a situation but not the same case from squid internals point of
> view I list below:
> 74,5| RequestParser.cc(377) doParse: request-line: retval 1:
> line={266, data='CONNECT
> baybridge-module-8155.scratch.my.salesforce.com:443 HTTP/1.1
> Host: baybridge-module-8155.scratch.my.salesforce.com:443
> 2023/02/15 15:44:24.223 kid1| 74,5| RequestParser.cc(379) doParse:
> request-line: url: baybridge-module-8155.scratch.my.salesforce.com:443
> 2023/02/15 15:44:24.223 kid1| 74,5| Parser.cc(192) grabMimeBlock: mime
> header (0-196) {Host:
> baybridge-module-8155.scratch.my.salesforce.com:443
> CONNECT baybridge-module-8155.scratch.my.salesforce.com:443 HTTP/1.1
> Host: baybridge-module-8155.scratch.my.salesforce.com:443
> Host: baybridge-module-8155.scratch.my.salesforce.com:443
> 2023/02/15 15:44:24.223 kid1| 23,3| Uri.cc(441) parse: Split URL
> 'baybridge-module-8155.scratch.my.salesforce.com:443' into proto='',
> host='baybridge-module-8155.scratch.my.salesforce.com', port='443',
> path=''
> 2023/02/15 15:44:24.223 kid1| 14,3| Address.cc(389) lookupHostIP:
> Given Non-IP 'baybridge-module-8155.scratch.my.salesforce.com': Name
> or service not known
> 2023/02/15 15:44:24.223 kid1| 33,5| Http1Server.cc(193)
> buildHttpRequest: normalize 1 Host header using
> baybridge-module-8155.scratch.my.salesforce.com:443
> 2023/02/15 15:44:24.224 kid1| 85,3| client_side_request.cc(637)
> hostHeaderVerify: validate
> host=baybridge-module-8155.scratch.my.salesforce.com, port=443,
> portStr=443
> 2023/02/15 15:44:24.224 kid1| 14,3| ipcache.cc(722)
> ipcache_gethostbyname: ipcache_gethostbyname:
> 'baybridge-module-8155.scratch.my.salesforce.com', flags=1
> 2023/02/15 15:44:24.224 kid1| 14,3| ipcache.cc(310) ipcacheRelease:
> ipcacheRelease: Releasing entry for
> 'baybridge-module-8155.scratch.my.salesforce.com'
> 2023/02/15 15:44:24.224 kid1| 14,3| Address.cc(389) lookupHostIP:
> Given Non-IP 'baybridge-module-8155.scratch.my.salesforce.com': Name
> or service not known
> 2023/02/15 15:44:24.224 kid1| 14,4| ipcache.cc(600)
> ipcache_nbgethostbyname:
> baybridge-module-8155.scratch.my.salesforce.com
> 2023/02/15 15:44:24.224 kid1| 14,3| Address.cc(389) lookupHostIP:
> Given Non-IP 'baybridge-module-8155.scratch.my.salesforce.com': Name
> or service not known
> 2023/02/15 15:44:24.224 kid1| 14,5| ipcache.cc(660)
> ipcache_nbgethostbyname_: ipcache_nbgethostbyname: MISS for
> 'baybridge-module-8155.scratch.my.salesforce.com'
> 2023/02/15 15:44:24.224 kid1| 78,3| dns_internal.cc(1788) idnsALookup:
> idnsALookup: buf is 65 bytes for
> baybridge-module-8155.scratch.my.salesforce.com, id = 0x9c4
> 2023/02/15 15:44:24.224 kid1| 78,3| dns_internal.cc(1724)
> idnsSendSlaveAAAAQuery: buf is 65 bytes for
> baybridge-module-8155.scratch.my.salesforce.com, id = 0x5b5e
> 2023/02/15 15:44:24.224 kid1| 28,3| DestinationIp.cc(78) match: can't
> yet compare 'to_localhost' ACL for
> baybridge-module-8155.scratch.my.salesforce.com
> 2023/02/15 15:44:24.224 kid1| 14,4| ipcache.cc(600)
> ipcache_nbgethostbyname:
> baybridge-module-8155.scratch.my.salesforce.com
> 2023/02/15 15:44:24.224 kid1| 14,3| Address.cc(389) lookupHostIP:
> Given Non-IP 'baybridge-module-8155.scratch.my.salesforce.com': Name
> or service not known
> 2023/02/15 15:44:24.224 kid1| 14,5| ipcache.cc(660)
> ipcache_nbgethostbyname_: ipcache_nbgethostbyname: MISS for
> 'baybridge-module-8155.scratch.my.salesforce.com'
> 2023/02/15 15:44:24.247 kid1| 14,3| ipcache.cc(456) latestError: DNS
> error while resolving baybridge-module-8155.scratch.my.salesforce.com:
> No DNS records
> 2023/02/15 15:44:24.248 kid1| 14,3| ipcache.cc(456) latestError: DNS
> error while resolving baybridge-module-8155.scratch.my.salesforce.com:
> No DNS records
> 2023/02/15 15:44:24.282 kid1| 14,3| ipcache.cc(477) ipcacheParse: 3
> answers for baybridge-module-8155.scratch.my.salesforce.com
> 2023/02/15 15:44:24.282 kid1| 14,3| ipcache.cc(576)
> ipcacheHandleReply: done with
> baybridge-module-8155.scratch.my.salesforce.com: [no cached IPs]
> 2023/02/15 15:44:24.282 kid1| 14,3| ipcache.cc(477) ipcacheParse: 3
> answers for baybridge-module-8155.scratch.my.salesforce.com
> 2023/02/15 15:44:24.282 kid1| 14,3| ipcache.cc(576)
> ipcacheHandleReply: done with
> baybridge-module-8155.scratch.my.salesforce.com: [no cached IPs]
> 2023/02/15 15:44:24.282 kid1| 14,3| ipcache.cc(310) ipcacheRelease:
> ipcacheRelease: Releasing entry for
> 'baybridge-module-8155.scratch.my.salesforce.com'
> 2023/02/15 15:44:24.282 kid1| 14,3| ipcache.cc(722)
> ipcache_gethostbyname: ipcache_gethostbyname:
> 'baybridge-module-8155.scratch.my.salesforce.com', flags=1
> 2023/02/15 15:44:24.282 kid1| 28,3| DomainData.cc(110) match:
> aclMatchDomainList: checking
> 'baybridge-module-8155.scratch.my.salesforce.com'
> 2023/02/15 15:44:24.282 kid1| 28,3| DomainData.cc(115) match:
> aclMatchDomainList: 'baybridge-module-8155.scratch.my.salesforce.com'
> NOT found
> 2023/02/15 15:44:24.283 kid1| 28,3| DomainData.cc(110) match:
> aclMatchDomainList: checking
> 'baybridge-module-8155.scratch.my.salesforce.com'
> 2023/02/15 15:44:24.283 kid1| 28,3| DomainData.cc(115) match:
> aclMatchDomainList: 'baybridge-module-8155.scratch.my.salesforce.com'
> found
> 2023/02/15 15:44:24.283 kid1| 85,2| client_side_request.cc(745)
> clientAccessCheckDone: The request CONNECT
> baybridge-module-8155.scratch.my.salesforce.com:443 is ALLOWED; last
> ACL checked: gitlab-executor-stg-dst
> 2023/02/15 15:44:24.284 kid1| 85,2| client_side_request.cc(745)
> clientAccessCheckDone: The request CONNECT
> baybridge-module-8155.scratch.my.salesforce.com:443 is ALLOWED; last
> ACL checked: gitlab-executor-stg-dst
> 2023/02/15 15:44:24.284 kid1| 85,4| client_side_request.cc(1514)
> processRequest: CONNECT
> baybridge-module-8155.scratch.my.salesforce.com:443
> 2023/02/15 15:44:24.284 kid1| 26,3| tunnel.cc(1140) tunnelStart:
> CONNECT baybridge-module-8155.scratch.my.salesforce.com:443 HTTP/1.1
> 2023/02/15 15:44:24.284 kid1| 44,3| peer_select.cc(612) selectMore:
> CONNECT baybridge-module-8155.scratch.my.salesforce.com
> 2023/02/15 15:44:24.284 kid1| 44,3| peer_select.cc(1098) addSelection:
> adding HIER_DIRECT#baybridge-module-8155.scratch.my.salesforce.com
> 2023/02/15 15:44:24.284 kid1| 44,2| peer_select.cc(460)
> resolveSelected: Find IP destination for:
> baybridge-module-8155.scratch.my.salesforce.com:443' via
> baybridge-module-8155.scratch.my.salesforce.com
> 2023/02/15 15:44:24.284 kid1| 14,4| ipcache.cc(607) nbgethostbyname:
> baybridge-module-8155.scratch.my.salesforce.com
> 2023/02/15 15:44:24.284 kid1| 14,3| Address.cc(389) lookupHostIP:
> Given Non-IP 'baybridge-module-8155.scratch.my.salesforce.com': Name
> or service not known
> 2023/02/15 15:44:24.284 kid1| 14,4| ipcache.cc(647)
> ipcache_nbgethostbyname_: ipcache_nbgethostbyname: HIT for
> 'baybridge-module-8155.scratch.my.salesforce.com'
> 2023/02/15 15:44:24.284 kid1| 44,2| peer_select.cc(479)
> resolveSelected: PeerSelector4664913 found all 0 destinations for
> baybridge-module-8155.scratch.my.salesforce.com:443
> 2023/02/15 15:44:24.284 kid1| 4,3| errorpage.cc(1249)
> compileLegacyCode: %U -->
> 'https://baybridge-module-8155.scratch.my.salesforce.com/*'
> 2023/02/15 15:44:24.284 kid1| 4,3| errorpage.cc(1249)
> compileLegacyCode: %U -->
> 'https://baybridge-module-8155.scratch.my.salesforce.com/*'
> 2023/02/15 15:44:24.284 kid1| 4,3| errorpage.cc(1249)
> compileLegacyCode: %W -->
> '?subject=CacheErrorInfo%20-%20ERR_CANNOT_FORWARD&body=CacheHost%3A%20opl-egress-proxy-vm-31vr%0D%0AErrPage%3A%20ERR_CANNOT_FORWARD%0D%0AErr%3A%20%5Bnone%5D%0D%0ATimeStamp%3A%20Wed,%2015%20Feb%202023%2014%3A44%3A24%20GMT%0D%0A%0D%0AClientIP%3A%20100.121.10.148%0D%0A%0D%0AHTTP%20Request%3A%0D%0ACONNECT%20%20HTTP%2F1.1%0AVia%3A%201.1%20gitlab-proxy-6d445dbd8d-mxtqv%20(squid%2F5.7)%0D%0AX-Forwarded-For%3A%20100.113.24.224%0D%0ACache-Control%3A%20max-age%3D259200%0D%0AConnection%3A%20close%0D%0AHost%3A%20baybridge-module-8155.scratch.my.salesforce.com%3A443%0D%0A%0D%0A%0D%0A'
> 2023/02/15 15:44:24.286 kid1| 33,3| client_side_request.cc(272)
> ~ClientHttpRequest: httpRequestFree:
> baybridge-module-8155.scratch.my.salesforce.com:443
> 2023/02/15 15:44:24.286 kid1| 33,5| client_side.cc(385) logRequest:
> logging half-baked transaction:
> baybridge-module-8155.scratch.my.salesforce.com:443
> 
> Our parent proxy settings for DNS:
> negative_dns_ttl 3 seconds  #if we set 1s it behaves the same
> dns_nameservers 8.8.8.8 1.1.1.1
> 
> The question is:
> If you carefully look at the debug log you see:
> a. I(Squid) can't find IP for the name
> b. I've got 3 IPs from DNS
> c. OK, so I've got IP
> d. ...Oh, I cannot find any IP
> e. I can't find any destinations (what's that?)
> f. I'm outputing an error
> 
> So, do you think it's ok or there is a bug?
> 
> Rgds,
> Maciej Leks
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users



From maciej.leks at gmail.com  Fri Feb 17 18:24:54 2023
From: maciej.leks at gmail.com (Maciej Leks)
Date: Fri, 17 Feb 2023 19:24:54 +0100
Subject: [squid-users] Squid returns 500 on rapidly changing DNS records
In-Reply-To: <9fc40c53-38ff-2234-2cdf-23d07cc77bfc@measurement-factory.com>
References: <CACSz3ZRnNHbU4p05H2YuWVKTuF8LW1kzs37BmDs1BUSPV043kw@mail.gmail.com>
 <9fc40c53-38ff-2234-2cdf-23d07cc77bfc@measurement-factory.com>
Message-ID: <CACSz3ZTZob9rHQudeWqmvJw+ajNxQ2T5ge6P-G-qmXRtx2psZg@mail.gmail.com>

I understand your last question but it's hard me to answer clearly -
yes/no .  Instead of this let me show you this log:

17/Feb/2023:17:16:21 +0100 1676650581.827    103 100.121.11.70
100.121.11.70 NONE_NONE/500 0 CONNECT
scala-module-5515.scratch.lightning.force.com:443 - HIER_NONE/- -
17/Feb/2023:17:16:22 +0100 1676650582.297      0 100.121.11.70
100.121.11.70 NONE_NONE/500 0 CONNECT
scala-module-5515.scratch.lightning.force.com:443 - HIER_NONE/- -
17/Feb/2023:17:16:22 +0100 1676650582.893      0 100.121.11.70
100.121.11.70 NONE_NONE/500 0 CONNECT
scala-module-5515.scratch.lightning.force.com:443 - HIER_NONE/- -
17/Feb/2023:17:16:23 +0100 1676650583.625      0 100.121.11.70
100.121.11.70 NONE_NONE/500 0 CONNECT
scala-module-5515.scratch.lightning.force.com:443 - HIER_NONE/- -
17/Feb/2023:17:16:23 +0100 1676650583.711      0 100.121.11.70
100.121.11.70 NONE_NONE/500 0 CONNECT
scala-module-5515.scratch.lightning.force.com:443 - HIER_NONE/- -
17/Feb/2023:17:16:25 +0100 1676650585.073      0 100.121.11.70
100.121.11.70 NONE_NONE/500 0 CONNECT
scala-module-5515.scratch.lightning.force.com:443 - HIER_NONE/- -
17/Feb/2023:17:16:25 +0100 1676650585.799      0 100.121.11.70
100.121.11.70 NONE_NONE/500 0 CONNECT
scala-module-5515.scratch.lightning.force.com:443 - HIER_NONE/- -
17/Feb/2023:17:16:25 +0100 1676650585.882      0 100.121.11.70
100.121.11.70 NONE_NONE/500 0 CONNECT
scala-module-5515.scratch.lightning.force.com:443 - HIER_NONE/- -
17/Feb/2023:17:16:26 +0100 1676650586.258      0 100.121.11.70
100.121.11.70 NONE_NONE/500 0 CONNECT
scala-module-5515.scratch.lightning.force.com:443 - HIER_NONE/- -
17/Feb/2023:17:16:26 +0100 1676650586.995      0 100.121.11.70
100.121.11.70 NONE_NONE/500 0 CONNECT
scala-module-5515.scratch.lightning.force.com:443 - HIER_NONE/- -
17/Feb/2023:17:16:28 +0100 1676650588.468      0 100.121.11.70
100.121.11.70 NONE_NONE/500 0 CONNECT
scala-module-5515.scratch.lightning.force.com:443 - HIER_NONE/- -
17/Feb/2023:17:16:29 +0100 1676650589.159      0 100.121.11.70
100.121.11.70 NONE_NONE/500 0 CONNECT
scala-module-5515.scratch.lightning.force.com:443 - HIER_NONE/- -
17/Feb/2023:17:16:29 +0100 1676650589.560      0 100.121.11.70
100.121.11.70 NONE_NONE/500 0 CONNECT
scala-module-5515.scratch.lightning.force.com:443 - HIER_NONE/- -
17/Feb/2023:17:16:30 +0100 1676650590.319      0 100.121.11.70
100.121.11.70 NONE_NONE/500 0 CONNECT
scala-module-5515.scratch.lightning.force.com:443 - HIER_NONE/- -

This is the last resort parent squid and the 100.121.11.70 is our
downstream squid (child). I understand it as follows, thanks to
connect_retries set to 10 (here we have more than 10 tries) try to
connect.
I suppose the A/AAAA records should already be in the DNS, but the
last resort squid gave up.

Maciek

pt., 17 lut 2023 o 17:46 Alex Rousskov
<rousskov at measurement-factory.com> napisa?(a):
>
> On 2/17/23 09:31, Maciej Leks wrote:
>
> > We have being facing the 500 error codes in our squids (v5.7) when it
> > comes to communicate with Salesforce DNS for ephemeral hosts
>
> >     A cs128-fra.fra.r.salesforce.com.              30s   85.222.154.211
> >     A cs128-fra.fra.r.salesforce.com.              30s   160.8.252.83
> >     A cs128-fra.fra.r.salesforce.com.              30s   85.222.152.83
>
> 30s TTLs will naturally limit the time Squid can cache these IPs for.
>
>
> > From time to time DNS answers only sending SOA record (no A,AAAA records)
>
> Squid will fail to forward traffic if Squid does not have the
> destination IP address cached and its new DNS lookup returns no IPv4 or
> IPv6 records. Moreover, I am not 100% sure -- needs checking/testing --
> but Squid might cache that "negative" no-IPs result (see
> negative_dns_ttl that defaults to 60 seconds).
>
> Do all 500 error cases correspond to DNS answers without IPs? In other
> words, is there a 500 error case after a DNS answer with IPs (within 29
> seconds from each other)?
>
> HTH,
>
> Alex.
> P.S. Sorry for not answering your questions below directly. I do not
> have the time to document what Squid debugging logs mean, and I
> recommend sharing them without analysis (by non-developers).
>
>
> > dig:
> > IP address of sagittarius-oatmilk-722.scratch.my.salesforce.com is
> > cs128.salesforce.com.
> > cs128-fra.salesforce.com.
> > cs128-fra.fra.r.salesforce.com.
> > 160.8.255.83
> > 160.8.249.83
> > 85.222.154.211
> > Failed to resolve sagittarius-oatmilk-722.scratch.my.salesforce.com
> > Failed to resolve sagittarius-oatmilk-722.scratch.my.salesforce.com
> > Failed to resolve sagittarius-oatmilk-722.scratch.my.salesforce.com
> > Failed to resolve sagittarius-oatmilk-722.scratch.my.salesforce.com
> > IP address of sagittarius-oatmilk-722.scratch.my.salesforce.com is
> > cs128.salesforce.com.
> > cs128-fra.salesforce.com.
> > cs128-fra.fra.r.salesforce.com.
> > 85.222.154.211
> > 160.8.255.83
> > 160.8.249.83
> > IP address of sagittarius-oatmilk-722.scratch.my.salesforce.com is
> > cs128.salesforce.com.
> > cs128-fra.salesforce.com.
> > cs128-fra.fra.r.salesforce.com.
> > 160.8.253.83
> >
> > Squid outputs then:
> > 16/Feb/2023:13:45:54 +0100 1676551554.420    107 100.113.24.84
> > 100.113.24.84 NONE_NONE/500 0 CONNECT
> > canal-trailblazer-1066.scratch.my.salesforce.com:443 - HIER_NONE/- - -
> > - "/CN=gitlab-executor-stg.navio-services.opl-gcp.int"
> > 16/Feb/2023:13:51:55 +0100 1676551915.973     82 100.113.25.178
> > 100.113.25.178 NONE_NONE/500 0 CONNECT
> > pumpkinspice-pisces-6588.scratch.my.salesforce.com:443 - HIER_NONE/- -
> > - - "/CN=gitlab-executor-stg.navio-services.opl-gcp.int"
> > 16/Feb/2023:13:52:44 +0100 1676551964.285     95 100.113.24.84
> > 100.113.24.84 NONE_NONE/500 0 CONNECT
> > trailblazer-builder-1043.scratch.file.force.com:443 - HIER_NONE/- - -
> > Mozilla/5.0%20(X11;%20Linux%20x86_64)%20AppleWebKit/537.36%20(KHTML,%20like%20Gecko)%20HeadlessChrome/109.0.5414.74%20Safari/537.36
> > "/CN=gitlab-executor-stg.navio-services.opl-gcp.int"
> > 16/Feb/2023:13:56:11 +0100 1676552171.392     43 100.121.10.183
> > 100.121.10.183 NONE_NONE/500 0 CONNECT
> > pistachio-vente-806.scratch.my.salesforce.com:443 - HIER_NONE/- - - -
> > "/CN=gitlab-executor-stg.navio-services.opl-gcp.int"
> >
> >
> > Child squids get then (the same situation but different case):
> > 17/Feb/2023:13:18:49 +0000 1676639929.989 88 100.121.10.104
> > TCP_TUNNEL/500 0 CONNECT
> > beans-goldengate-9524.scratch.my.salesforce.com:443 -
> > ANY_OLD_PARENT/100.112.36.14 -
> >
> > Such a situation but not the same case from squid internals point of
> > view I list below:
> > 74,5| RequestParser.cc(377) doParse: request-line: retval 1:
> > line={266, data='CONNECT
> > baybridge-module-8155.scratch.my.salesforce.com:443 HTTP/1.1
> > Host: baybridge-module-8155.scratch.my.salesforce.com:443
> > 2023/02/15 15:44:24.223 kid1| 74,5| RequestParser.cc(379) doParse:
> > request-line: url: baybridge-module-8155.scratch.my.salesforce.com:443
> > 2023/02/15 15:44:24.223 kid1| 74,5| Parser.cc(192) grabMimeBlock: mime
> > header (0-196) {Host:
> > baybridge-module-8155.scratch.my.salesforce.com:443
> > CONNECT baybridge-module-8155.scratch.my.salesforce.com:443 HTTP/1.1
> > Host: baybridge-module-8155.scratch.my.salesforce.com:443
> > Host: baybridge-module-8155.scratch.my.salesforce.com:443
> > 2023/02/15 15:44:24.223 kid1| 23,3| Uri.cc(441) parse: Split URL
> > 'baybridge-module-8155.scratch.my.salesforce.com:443' into proto='',
> > host='baybridge-module-8155.scratch.my.salesforce.com', port='443',
> > path=''
> > 2023/02/15 15:44:24.223 kid1| 14,3| Address.cc(389) lookupHostIP:
> > Given Non-IP 'baybridge-module-8155.scratch.my.salesforce.com': Name
> > or service not known
> > 2023/02/15 15:44:24.223 kid1| 33,5| Http1Server.cc(193)
> > buildHttpRequest: normalize 1 Host header using
> > baybridge-module-8155.scratch.my.salesforce.com:443
> > 2023/02/15 15:44:24.224 kid1| 85,3| client_side_request.cc(637)
> > hostHeaderVerify: validate
> > host=baybridge-module-8155.scratch.my.salesforce.com, port=443,
> > portStr=443
> > 2023/02/15 15:44:24.224 kid1| 14,3| ipcache.cc(722)
> > ipcache_gethostbyname: ipcache_gethostbyname:
> > 'baybridge-module-8155.scratch.my.salesforce.com', flags=1
> > 2023/02/15 15:44:24.224 kid1| 14,3| ipcache.cc(310) ipcacheRelease:
> > ipcacheRelease: Releasing entry for
> > 'baybridge-module-8155.scratch.my.salesforce.com'
> > 2023/02/15 15:44:24.224 kid1| 14,3| Address.cc(389) lookupHostIP:
> > Given Non-IP 'baybridge-module-8155.scratch.my.salesforce.com': Name
> > or service not known
> > 2023/02/15 15:44:24.224 kid1| 14,4| ipcache.cc(600)
> > ipcache_nbgethostbyname:
> > baybridge-module-8155.scratch.my.salesforce.com
> > 2023/02/15 15:44:24.224 kid1| 14,3| Address.cc(389) lookupHostIP:
> > Given Non-IP 'baybridge-module-8155.scratch.my.salesforce.com': Name
> > or service not known
> > 2023/02/15 15:44:24.224 kid1| 14,5| ipcache.cc(660)
> > ipcache_nbgethostbyname_: ipcache_nbgethostbyname: MISS for
> > 'baybridge-module-8155.scratch.my.salesforce.com'
> > 2023/02/15 15:44:24.224 kid1| 78,3| dns_internal.cc(1788) idnsALookup:
> > idnsALookup: buf is 65 bytes for
> > baybridge-module-8155.scratch.my.salesforce.com, id = 0x9c4
> > 2023/02/15 15:44:24.224 kid1| 78,3| dns_internal.cc(1724)
> > idnsSendSlaveAAAAQuery: buf is 65 bytes for
> > baybridge-module-8155.scratch.my.salesforce.com, id = 0x5b5e
> > 2023/02/15 15:44:24.224 kid1| 28,3| DestinationIp.cc(78) match: can't
> > yet compare 'to_localhost' ACL for
> > baybridge-module-8155.scratch.my.salesforce.com
> > 2023/02/15 15:44:24.224 kid1| 14,4| ipcache.cc(600)
> > ipcache_nbgethostbyname:
> > baybridge-module-8155.scratch.my.salesforce.com
> > 2023/02/15 15:44:24.224 kid1| 14,3| Address.cc(389) lookupHostIP:
> > Given Non-IP 'baybridge-module-8155.scratch.my.salesforce.com': Name
> > or service not known
> > 2023/02/15 15:44:24.224 kid1| 14,5| ipcache.cc(660)
> > ipcache_nbgethostbyname_: ipcache_nbgethostbyname: MISS for
> > 'baybridge-module-8155.scratch.my.salesforce.com'
> > 2023/02/15 15:44:24.247 kid1| 14,3| ipcache.cc(456) latestError: DNS
> > error while resolving baybridge-module-8155.scratch.my.salesforce.com:
> > No DNS records
> > 2023/02/15 15:44:24.248 kid1| 14,3| ipcache.cc(456) latestError: DNS
> > error while resolving baybridge-module-8155.scratch.my.salesforce.com:
> > No DNS records
> > 2023/02/15 15:44:24.282 kid1| 14,3| ipcache.cc(477) ipcacheParse: 3
> > answers for baybridge-module-8155.scratch.my.salesforce.com
> > 2023/02/15 15:44:24.282 kid1| 14,3| ipcache.cc(576)
> > ipcacheHandleReply: done with
> > baybridge-module-8155.scratch.my.salesforce.com: [no cached IPs]
> > 2023/02/15 15:44:24.282 kid1| 14,3| ipcache.cc(477) ipcacheParse: 3
> > answers for baybridge-module-8155.scratch.my.salesforce.com
> > 2023/02/15 15:44:24.282 kid1| 14,3| ipcache.cc(576)
> > ipcacheHandleReply: done with
> > baybridge-module-8155.scratch.my.salesforce.com: [no cached IPs]
> > 2023/02/15 15:44:24.282 kid1| 14,3| ipcache.cc(310) ipcacheRelease:
> > ipcacheRelease: Releasing entry for
> > 'baybridge-module-8155.scratch.my.salesforce.com'
> > 2023/02/15 15:44:24.282 kid1| 14,3| ipcache.cc(722)
> > ipcache_gethostbyname: ipcache_gethostbyname:
> > 'baybridge-module-8155.scratch.my.salesforce.com', flags=1
> > 2023/02/15 15:44:24.282 kid1| 28,3| DomainData.cc(110) match:
> > aclMatchDomainList: checking
> > 'baybridge-module-8155.scratch.my.salesforce.com'
> > 2023/02/15 15:44:24.282 kid1| 28,3| DomainData.cc(115) match:
> > aclMatchDomainList: 'baybridge-module-8155.scratch.my.salesforce.com'
> > NOT found
> > 2023/02/15 15:44:24.283 kid1| 28,3| DomainData.cc(110) match:
> > aclMatchDomainList: checking
> > 'baybridge-module-8155.scratch.my.salesforce.com'
> > 2023/02/15 15:44:24.283 kid1| 28,3| DomainData.cc(115) match:
> > aclMatchDomainList: 'baybridge-module-8155.scratch.my.salesforce.com'
> > found
> > 2023/02/15 15:44:24.283 kid1| 85,2| client_side_request.cc(745)
> > clientAccessCheckDone: The request CONNECT
> > baybridge-module-8155.scratch.my.salesforce.com:443 is ALLOWED; last
> > ACL checked: gitlab-executor-stg-dst
> > 2023/02/15 15:44:24.284 kid1| 85,2| client_side_request.cc(745)
> > clientAccessCheckDone: The request CONNECT
> > baybridge-module-8155.scratch.my.salesforce.com:443 is ALLOWED; last
> > ACL checked: gitlab-executor-stg-dst
> > 2023/02/15 15:44:24.284 kid1| 85,4| client_side_request.cc(1514)
> > processRequest: CONNECT
> > baybridge-module-8155.scratch.my.salesforce.com:443
> > 2023/02/15 15:44:24.284 kid1| 26,3| tunnel.cc(1140) tunnelStart:
> > CONNECT baybridge-module-8155.scratch.my.salesforce.com:443 HTTP/1.1
> > 2023/02/15 15:44:24.284 kid1| 44,3| peer_select.cc(612) selectMore:
> > CONNECT baybridge-module-8155.scratch.my.salesforce.com
> > 2023/02/15 15:44:24.284 kid1| 44,3| peer_select.cc(1098) addSelection:
> > adding HIER_DIRECT#baybridge-module-8155.scratch.my.salesforce.com
> > 2023/02/15 15:44:24.284 kid1| 44,2| peer_select.cc(460)
> > resolveSelected: Find IP destination for:
> > baybridge-module-8155.scratch.my.salesforce.com:443' via
> > baybridge-module-8155.scratch.my.salesforce.com
> > 2023/02/15 15:44:24.284 kid1| 14,4| ipcache.cc(607) nbgethostbyname:
> > baybridge-module-8155.scratch.my.salesforce.com
> > 2023/02/15 15:44:24.284 kid1| 14,3| Address.cc(389) lookupHostIP:
> > Given Non-IP 'baybridge-module-8155.scratch.my.salesforce.com': Name
> > or service not known
> > 2023/02/15 15:44:24.284 kid1| 14,4| ipcache.cc(647)
> > ipcache_nbgethostbyname_: ipcache_nbgethostbyname: HIT for
> > 'baybridge-module-8155.scratch.my.salesforce.com'
> > 2023/02/15 15:44:24.284 kid1| 44,2| peer_select.cc(479)
> > resolveSelected: PeerSelector4664913 found all 0 destinations for
> > baybridge-module-8155.scratch.my.salesforce.com:443
> > 2023/02/15 15:44:24.284 kid1| 4,3| errorpage.cc(1249)
> > compileLegacyCode: %U -->
> > 'https://baybridge-module-8155.scratch.my.salesforce.com/*'
> > 2023/02/15 15:44:24.284 kid1| 4,3| errorpage.cc(1249)
> > compileLegacyCode: %U -->
> > 'https://baybridge-module-8155.scratch.my.salesforce.com/*'
> > 2023/02/15 15:44:24.284 kid1| 4,3| errorpage.cc(1249)
> > compileLegacyCode: %W -->
> > '?subject=CacheErrorInfo%20-%20ERR_CANNOT_FORWARD&body=CacheHost%3A%20opl-egress-proxy-vm-31vr%0D%0AErrPage%3A%20ERR_CANNOT_FORWARD%0D%0AErr%3A%20%5Bnone%5D%0D%0ATimeStamp%3A%20Wed,%2015%20Feb%202023%2014%3A44%3A24%20GMT%0D%0A%0D%0AClientIP%3A%20100.121.10.148%0D%0A%0D%0AHTTP%20Request%3A%0D%0ACONNECT%20%20HTTP%2F1.1%0AVia%3A%201.1%20gitlab-proxy-6d445dbd8d-mxtqv%20(squid%2F5.7)%0D%0AX-Forwarded-For%3A%20100.113.24.224%0D%0ACache-Control%3A%20max-age%3D259200%0D%0AConnection%3A%20close%0D%0AHost%3A%20baybridge-module-8155.scratch.my.salesforce.com%3A443%0D%0A%0D%0A%0D%0A'
> > 2023/02/15 15:44:24.286 kid1| 33,3| client_side_request.cc(272)
> > ~ClientHttpRequest: httpRequestFree:
> > baybridge-module-8155.scratch.my.salesforce.com:443
> > 2023/02/15 15:44:24.286 kid1| 33,5| client_side.cc(385) logRequest:
> > logging half-baked transaction:
> > baybridge-module-8155.scratch.my.salesforce.com:443
> >
> > Our parent proxy settings for DNS:
> > negative_dns_ttl 3 seconds  #if we set 1s it behaves the same
> > dns_nameservers 8.8.8.8 1.1.1.1
> >
> > The question is:
> > If you carefully look at the debug log you see:
> > a. I(Squid) can't find IP for the name
> > b. I've got 3 IPs from DNS
> > c. OK, so I've got IP
> > d. ...Oh, I cannot find any IP
> > e. I can't find any destinations (what's that?)
> > f. I'm outputing an error
> >
> > So, do you think it's ok or there is a bug?
> >
> > Rgds,
> > Maciej Leks
> > _______________________________________________
> > squid-users mailing list
> > squid-users at lists.squid-cache.org
> > http://lists.squid-cache.org/listinfo/squid-users
>
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users


From squid3 at treenet.co.nz  Fri Feb 17 18:29:37 2023
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Sat, 18 Feb 2023 07:29:37 +1300
Subject: [squid-users] Log 407-transactions when username is known
In-Reply-To: <CADJd0Y11L3Y8cF4tY3Z2uevQXf-9=LAqiR3fZ1s7jx89BUFMvQ@mail.gmail.com>
References: <CADJd0Y11L3Y8cF4tY3Z2uevQXf-9=LAqiR3fZ1s7jx89BUFMvQ@mail.gmail.com>
Message-ID: <31d33f32-d522-3403-7153-1ae757e2ec73@treenet.co.nz>

On 17/02/2023 7:29 pm, Andrey K wrote:
> Hello,
>
> I would like to disable logging of 407-errors, except when the 
> username is known.
> Is it possible to configure?

Assuming that you have the wrapper script from your previous request 
about always logging usernames you should be able to use a note type ACL 
like so:

 ?acl knownUser note user
 ?access_log ... on-error=drop http-407 !knownUser


>
> I have now the log configured:
> acl http-407 http_status 407
> access_log daemon:/var/log/squid/access.log logformat=extended-squid 
> on-error=drop !http-407
>
> But I would also like to see authentication errors when a user types 
> the wrong password (the username is known in these cases).
>

With most HTTP authentication you could rely on all 407 meaning bad or 
unknown credentials. But NTLM (ab)uses that code for its handshake 
type-2 response, so you one distinguish a failed from an incomplete 
authentication.

At this point you are already wrapping and re-writing most of the 
NTLM->Squid helper traffic. You could adjust the challenge to also use 
the current helper syntax with a custom note to log. But I recommend 
just upgrading your systems to Kerberos which will avoid a lot of these 
complications entirely.

Cheers
Amos



From rousskov at measurement-factory.com  Fri Feb 17 18:55:51 2023
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Fri, 17 Feb 2023 13:55:51 -0500
Subject: [squid-users] Squid returns 500 on rapidly changing DNS records
In-Reply-To: <CACSz3ZTZob9rHQudeWqmvJw+ajNxQ2T5ge6P-G-qmXRtx2psZg@mail.gmail.com>
References: <CACSz3ZRnNHbU4p05H2YuWVKTuF8LW1kzs37BmDs1BUSPV043kw@mail.gmail.com>
 <9fc40c53-38ff-2234-2cdf-23d07cc77bfc@measurement-factory.com>
 <CACSz3ZTZob9rHQudeWqmvJw+ajNxQ2T5ge6P-G-qmXRtx2psZg@mail.gmail.com>
Message-ID: <1e0cdfa7-481b-5251-993f-9b2ab5c6ae0d@measurement-factory.com>

On 2/17/23 13:24, Maciej Leks wrote:
> I understand your last question but it's hard me to answer clearly -
> yes/no.

Yes, it is a difficult question to answer. Logging DNS traffic with 
tcpdump might help, but it does require some non-trivial work to 
correlate everything. For now, without that or similar additional 
information, it is easy for us to assume that you are just seeing the 
effects of DNS responses without IP addresses.

There is another way to confirm or reject a bug claim. Share a 
compressed ALL,9 cache.log while reproducing the problem with as few 
transactions as possible (privately if needed).
https://wiki.squid-cache.org/SquidFaq/BugReporting#debugging-a-single-transaction


> Instead of this let me show you this log:

> I suppose the A/AAAA records should already be in the DNS, but the
> last resort squid gave up.

Why do you think that the IP addresses should already be (or appear) in 
the parent Squid IP cache during these logged transactions?


Cheers,

Alex.


> 17/Feb/2023:17:16:21 +0100 1676650581.827    103 100.121.11.70
> 100.121.11.70 NONE_NONE/500 0 CONNECT
> scala-module-5515.scratch.lightning.force.com:443 - HIER_NONE/- -
> 17/Feb/2023:17:16:22 +0100 1676650582.297      0 100.121.11.70
> 100.121.11.70 NONE_NONE/500 0 CONNECT
> scala-module-5515.scratch.lightning.force.com:443 - HIER_NONE/- -
> 17/Feb/2023:17:16:22 +0100 1676650582.893      0 100.121.11.70
> 100.121.11.70 NONE_NONE/500 0 CONNECT
> scala-module-5515.scratch.lightning.force.com:443 - HIER_NONE/- -
> 17/Feb/2023:17:16:23 +0100 1676650583.625      0 100.121.11.70
> 100.121.11.70 NONE_NONE/500 0 CONNECT
> scala-module-5515.scratch.lightning.force.com:443 - HIER_NONE/- -
> 17/Feb/2023:17:16:23 +0100 1676650583.711      0 100.121.11.70
> 100.121.11.70 NONE_NONE/500 0 CONNECT
> scala-module-5515.scratch.lightning.force.com:443 - HIER_NONE/- -
> 17/Feb/2023:17:16:25 +0100 1676650585.073      0 100.121.11.70
> 100.121.11.70 NONE_NONE/500 0 CONNECT
> scala-module-5515.scratch.lightning.force.com:443 - HIER_NONE/- -
> 17/Feb/2023:17:16:25 +0100 1676650585.799      0 100.121.11.70
> 100.121.11.70 NONE_NONE/500 0 CONNECT
> scala-module-5515.scratch.lightning.force.com:443 - HIER_NONE/- -
> 17/Feb/2023:17:16:25 +0100 1676650585.882      0 100.121.11.70
> 100.121.11.70 NONE_NONE/500 0 CONNECT
> scala-module-5515.scratch.lightning.force.com:443 - HIER_NONE/- -
> 17/Feb/2023:17:16:26 +0100 1676650586.258      0 100.121.11.70
> 100.121.11.70 NONE_NONE/500 0 CONNECT
> scala-module-5515.scratch.lightning.force.com:443 - HIER_NONE/- -
> 17/Feb/2023:17:16:26 +0100 1676650586.995      0 100.121.11.70
> 100.121.11.70 NONE_NONE/500 0 CONNECT
> scala-module-5515.scratch.lightning.force.com:443 - HIER_NONE/- -
> 17/Feb/2023:17:16:28 +0100 1676650588.468      0 100.121.11.70
> 100.121.11.70 NONE_NONE/500 0 CONNECT
> scala-module-5515.scratch.lightning.force.com:443 - HIER_NONE/- -
> 17/Feb/2023:17:16:29 +0100 1676650589.159      0 100.121.11.70
> 100.121.11.70 NONE_NONE/500 0 CONNECT
> scala-module-5515.scratch.lightning.force.com:443 - HIER_NONE/- -
> 17/Feb/2023:17:16:29 +0100 1676650589.560      0 100.121.11.70
> 100.121.11.70 NONE_NONE/500 0 CONNECT
> scala-module-5515.scratch.lightning.force.com:443 - HIER_NONE/- -
> 17/Feb/2023:17:16:30 +0100 1676650590.319      0 100.121.11.70
> 100.121.11.70 NONE_NONE/500 0 CONNECT
> scala-module-5515.scratch.lightning.force.com:443 - HIER_NONE/- -
> 
> This is the last resort parent squid and the 100.121.11.70 is our
> downstream squid (child). I understand it as follows, thanks to
> connect_retries set to 10 (here we have more than 10 tries) try to
> connect.



> pt., 17 lut 2023 o 17:46 Alex Rousskov
> <rousskov at measurement-factory.com> napisa?(a):
>>
>> On 2/17/23 09:31, Maciej Leks wrote:
>>
>>> We have being facing the 500 error codes in our squids (v5.7) when it
>>> comes to communicate with Salesforce DNS for ephemeral hosts
>>
>>>      A cs128-fra.fra.r.salesforce.com.              30s   85.222.154.211
>>>      A cs128-fra.fra.r.salesforce.com.              30s   160.8.252.83
>>>      A cs128-fra.fra.r.salesforce.com.              30s   85.222.152.83
>>
>> 30s TTLs will naturally limit the time Squid can cache these IPs for.
>>
>>
>>>  From time to time DNS answers only sending SOA record (no A,AAAA records)
>>
>> Squid will fail to forward traffic if Squid does not have the
>> destination IP address cached and its new DNS lookup returns no IPv4 or
>> IPv6 records. Moreover, I am not 100% sure -- needs checking/testing --
>> but Squid might cache that "negative" no-IPs result (see
>> negative_dns_ttl that defaults to 60 seconds).
>>
>> Do all 500 error cases correspond to DNS answers without IPs? In other
>> words, is there a 500 error case after a DNS answer with IPs (within 29
>> seconds from each other)?
>>
>> HTH,
>>
>> Alex.
>> P.S. Sorry for not answering your questions below directly. I do not
>> have the time to document what Squid debugging logs mean, and I
>> recommend sharing them without analysis (by non-developers).
>>
>>
>>> dig:
>>> IP address of sagittarius-oatmilk-722.scratch.my.salesforce.com is
>>> cs128.salesforce.com.
>>> cs128-fra.salesforce.com.
>>> cs128-fra.fra.r.salesforce.com.
>>> 160.8.255.83
>>> 160.8.249.83
>>> 85.222.154.211
>>> Failed to resolve sagittarius-oatmilk-722.scratch.my.salesforce.com
>>> Failed to resolve sagittarius-oatmilk-722.scratch.my.salesforce.com
>>> Failed to resolve sagittarius-oatmilk-722.scratch.my.salesforce.com
>>> Failed to resolve sagittarius-oatmilk-722.scratch.my.salesforce.com
>>> IP address of sagittarius-oatmilk-722.scratch.my.salesforce.com is
>>> cs128.salesforce.com.
>>> cs128-fra.salesforce.com.
>>> cs128-fra.fra.r.salesforce.com.
>>> 85.222.154.211
>>> 160.8.255.83
>>> 160.8.249.83
>>> IP address of sagittarius-oatmilk-722.scratch.my.salesforce.com is
>>> cs128.salesforce.com.
>>> cs128-fra.salesforce.com.
>>> cs128-fra.fra.r.salesforce.com.
>>> 160.8.253.83
>>>
>>> Squid outputs then:
>>> 16/Feb/2023:13:45:54 +0100 1676551554.420    107 100.113.24.84
>>> 100.113.24.84 NONE_NONE/500 0 CONNECT
>>> canal-trailblazer-1066.scratch.my.salesforce.com:443 - HIER_NONE/- - -
>>> - "/CN=gitlab-executor-stg.navio-services.opl-gcp.int"
>>> 16/Feb/2023:13:51:55 +0100 1676551915.973     82 100.113.25.178
>>> 100.113.25.178 NONE_NONE/500 0 CONNECT
>>> pumpkinspice-pisces-6588.scratch.my.salesforce.com:443 - HIER_NONE/- -
>>> - - "/CN=gitlab-executor-stg.navio-services.opl-gcp.int"
>>> 16/Feb/2023:13:52:44 +0100 1676551964.285     95 100.113.24.84
>>> 100.113.24.84 NONE_NONE/500 0 CONNECT
>>> trailblazer-builder-1043.scratch.file.force.com:443 - HIER_NONE/- - -
>>> Mozilla/5.0%20(X11;%20Linux%20x86_64)%20AppleWebKit/537.36%20(KHTML,%20like%20Gecko)%20HeadlessChrome/109.0.5414.74%20Safari/537.36
>>> "/CN=gitlab-executor-stg.navio-services.opl-gcp.int"
>>> 16/Feb/2023:13:56:11 +0100 1676552171.392     43 100.121.10.183
>>> 100.121.10.183 NONE_NONE/500 0 CONNECT
>>> pistachio-vente-806.scratch.my.salesforce.com:443 - HIER_NONE/- - - -
>>> "/CN=gitlab-executor-stg.navio-services.opl-gcp.int"
>>>
>>>
>>> Child squids get then (the same situation but different case):
>>> 17/Feb/2023:13:18:49 +0000 1676639929.989 88 100.121.10.104
>>> TCP_TUNNEL/500 0 CONNECT
>>> beans-goldengate-9524.scratch.my.salesforce.com:443 -
>>> ANY_OLD_PARENT/100.112.36.14 -
>>>
>>> Such a situation but not the same case from squid internals point of
>>> view I list below:
>>> 74,5| RequestParser.cc(377) doParse: request-line: retval 1:
>>> line={266, data='CONNECT
>>> baybridge-module-8155.scratch.my.salesforce.com:443 HTTP/1.1
>>> Host: baybridge-module-8155.scratch.my.salesforce.com:443
>>> 2023/02/15 15:44:24.223 kid1| 74,5| RequestParser.cc(379) doParse:
>>> request-line: url: baybridge-module-8155.scratch.my.salesforce.com:443
>>> 2023/02/15 15:44:24.223 kid1| 74,5| Parser.cc(192) grabMimeBlock: mime
>>> header (0-196) {Host:
>>> baybridge-module-8155.scratch.my.salesforce.com:443
>>> CONNECT baybridge-module-8155.scratch.my.salesforce.com:443 HTTP/1.1
>>> Host: baybridge-module-8155.scratch.my.salesforce.com:443
>>> Host: baybridge-module-8155.scratch.my.salesforce.com:443
>>> 2023/02/15 15:44:24.223 kid1| 23,3| Uri.cc(441) parse: Split URL
>>> 'baybridge-module-8155.scratch.my.salesforce.com:443' into proto='',
>>> host='baybridge-module-8155.scratch.my.salesforce.com', port='443',
>>> path=''
>>> 2023/02/15 15:44:24.223 kid1| 14,3| Address.cc(389) lookupHostIP:
>>> Given Non-IP 'baybridge-module-8155.scratch.my.salesforce.com': Name
>>> or service not known
>>> 2023/02/15 15:44:24.223 kid1| 33,5| Http1Server.cc(193)
>>> buildHttpRequest: normalize 1 Host header using
>>> baybridge-module-8155.scratch.my.salesforce.com:443
>>> 2023/02/15 15:44:24.224 kid1| 85,3| client_side_request.cc(637)
>>> hostHeaderVerify: validate
>>> host=baybridge-module-8155.scratch.my.salesforce.com, port=443,
>>> portStr=443
>>> 2023/02/15 15:44:24.224 kid1| 14,3| ipcache.cc(722)
>>> ipcache_gethostbyname: ipcache_gethostbyname:
>>> 'baybridge-module-8155.scratch.my.salesforce.com', flags=1
>>> 2023/02/15 15:44:24.224 kid1| 14,3| ipcache.cc(310) ipcacheRelease:
>>> ipcacheRelease: Releasing entry for
>>> 'baybridge-module-8155.scratch.my.salesforce.com'
>>> 2023/02/15 15:44:24.224 kid1| 14,3| Address.cc(389) lookupHostIP:
>>> Given Non-IP 'baybridge-module-8155.scratch.my.salesforce.com': Name
>>> or service not known
>>> 2023/02/15 15:44:24.224 kid1| 14,4| ipcache.cc(600)
>>> ipcache_nbgethostbyname:
>>> baybridge-module-8155.scratch.my.salesforce.com
>>> 2023/02/15 15:44:24.224 kid1| 14,3| Address.cc(389) lookupHostIP:
>>> Given Non-IP 'baybridge-module-8155.scratch.my.salesforce.com': Name
>>> or service not known
>>> 2023/02/15 15:44:24.224 kid1| 14,5| ipcache.cc(660)
>>> ipcache_nbgethostbyname_: ipcache_nbgethostbyname: MISS for
>>> 'baybridge-module-8155.scratch.my.salesforce.com'
>>> 2023/02/15 15:44:24.224 kid1| 78,3| dns_internal.cc(1788) idnsALookup:
>>> idnsALookup: buf is 65 bytes for
>>> baybridge-module-8155.scratch.my.salesforce.com, id = 0x9c4
>>> 2023/02/15 15:44:24.224 kid1| 78,3| dns_internal.cc(1724)
>>> idnsSendSlaveAAAAQuery: buf is 65 bytes for
>>> baybridge-module-8155.scratch.my.salesforce.com, id = 0x5b5e
>>> 2023/02/15 15:44:24.224 kid1| 28,3| DestinationIp.cc(78) match: can't
>>> yet compare 'to_localhost' ACL for
>>> baybridge-module-8155.scratch.my.salesforce.com
>>> 2023/02/15 15:44:24.224 kid1| 14,4| ipcache.cc(600)
>>> ipcache_nbgethostbyname:
>>> baybridge-module-8155.scratch.my.salesforce.com
>>> 2023/02/15 15:44:24.224 kid1| 14,3| Address.cc(389) lookupHostIP:
>>> Given Non-IP 'baybridge-module-8155.scratch.my.salesforce.com': Name
>>> or service not known
>>> 2023/02/15 15:44:24.224 kid1| 14,5| ipcache.cc(660)
>>> ipcache_nbgethostbyname_: ipcache_nbgethostbyname: MISS for
>>> 'baybridge-module-8155.scratch.my.salesforce.com'
>>> 2023/02/15 15:44:24.247 kid1| 14,3| ipcache.cc(456) latestError: DNS
>>> error while resolving baybridge-module-8155.scratch.my.salesforce.com:
>>> No DNS records
>>> 2023/02/15 15:44:24.248 kid1| 14,3| ipcache.cc(456) latestError: DNS
>>> error while resolving baybridge-module-8155.scratch.my.salesforce.com:
>>> No DNS records
>>> 2023/02/15 15:44:24.282 kid1| 14,3| ipcache.cc(477) ipcacheParse: 3
>>> answers for baybridge-module-8155.scratch.my.salesforce.com
>>> 2023/02/15 15:44:24.282 kid1| 14,3| ipcache.cc(576)
>>> ipcacheHandleReply: done with
>>> baybridge-module-8155.scratch.my.salesforce.com: [no cached IPs]
>>> 2023/02/15 15:44:24.282 kid1| 14,3| ipcache.cc(477) ipcacheParse: 3
>>> answers for baybridge-module-8155.scratch.my.salesforce.com
>>> 2023/02/15 15:44:24.282 kid1| 14,3| ipcache.cc(576)
>>> ipcacheHandleReply: done with
>>> baybridge-module-8155.scratch.my.salesforce.com: [no cached IPs]
>>> 2023/02/15 15:44:24.282 kid1| 14,3| ipcache.cc(310) ipcacheRelease:
>>> ipcacheRelease: Releasing entry for
>>> 'baybridge-module-8155.scratch.my.salesforce.com'
>>> 2023/02/15 15:44:24.282 kid1| 14,3| ipcache.cc(722)
>>> ipcache_gethostbyname: ipcache_gethostbyname:
>>> 'baybridge-module-8155.scratch.my.salesforce.com', flags=1
>>> 2023/02/15 15:44:24.282 kid1| 28,3| DomainData.cc(110) match:
>>> aclMatchDomainList: checking
>>> 'baybridge-module-8155.scratch.my.salesforce.com'
>>> 2023/02/15 15:44:24.282 kid1| 28,3| DomainData.cc(115) match:
>>> aclMatchDomainList: 'baybridge-module-8155.scratch.my.salesforce.com'
>>> NOT found
>>> 2023/02/15 15:44:24.283 kid1| 28,3| DomainData.cc(110) match:
>>> aclMatchDomainList: checking
>>> 'baybridge-module-8155.scratch.my.salesforce.com'
>>> 2023/02/15 15:44:24.283 kid1| 28,3| DomainData.cc(115) match:
>>> aclMatchDomainList: 'baybridge-module-8155.scratch.my.salesforce.com'
>>> found
>>> 2023/02/15 15:44:24.283 kid1| 85,2| client_side_request.cc(745)
>>> clientAccessCheckDone: The request CONNECT
>>> baybridge-module-8155.scratch.my.salesforce.com:443 is ALLOWED; last
>>> ACL checked: gitlab-executor-stg-dst
>>> 2023/02/15 15:44:24.284 kid1| 85,2| client_side_request.cc(745)
>>> clientAccessCheckDone: The request CONNECT
>>> baybridge-module-8155.scratch.my.salesforce.com:443 is ALLOWED; last
>>> ACL checked: gitlab-executor-stg-dst
>>> 2023/02/15 15:44:24.284 kid1| 85,4| client_side_request.cc(1514)
>>> processRequest: CONNECT
>>> baybridge-module-8155.scratch.my.salesforce.com:443
>>> 2023/02/15 15:44:24.284 kid1| 26,3| tunnel.cc(1140) tunnelStart:
>>> CONNECT baybridge-module-8155.scratch.my.salesforce.com:443 HTTP/1.1
>>> 2023/02/15 15:44:24.284 kid1| 44,3| peer_select.cc(612) selectMore:
>>> CONNECT baybridge-module-8155.scratch.my.salesforce.com
>>> 2023/02/15 15:44:24.284 kid1| 44,3| peer_select.cc(1098) addSelection:
>>> adding HIER_DIRECT#baybridge-module-8155.scratch.my.salesforce.com
>>> 2023/02/15 15:44:24.284 kid1| 44,2| peer_select.cc(460)
>>> resolveSelected: Find IP destination for:
>>> baybridge-module-8155.scratch.my.salesforce.com:443' via
>>> baybridge-module-8155.scratch.my.salesforce.com
>>> 2023/02/15 15:44:24.284 kid1| 14,4| ipcache.cc(607) nbgethostbyname:
>>> baybridge-module-8155.scratch.my.salesforce.com
>>> 2023/02/15 15:44:24.284 kid1| 14,3| Address.cc(389) lookupHostIP:
>>> Given Non-IP 'baybridge-module-8155.scratch.my.salesforce.com': Name
>>> or service not known
>>> 2023/02/15 15:44:24.284 kid1| 14,4| ipcache.cc(647)
>>> ipcache_nbgethostbyname_: ipcache_nbgethostbyname: HIT for
>>> 'baybridge-module-8155.scratch.my.salesforce.com'
>>> 2023/02/15 15:44:24.284 kid1| 44,2| peer_select.cc(479)
>>> resolveSelected: PeerSelector4664913 found all 0 destinations for
>>> baybridge-module-8155.scratch.my.salesforce.com:443
>>> 2023/02/15 15:44:24.284 kid1| 4,3| errorpage.cc(1249)
>>> compileLegacyCode: %U -->
>>> 'https://baybridge-module-8155.scratch.my.salesforce.com/*'
>>> 2023/02/15 15:44:24.284 kid1| 4,3| errorpage.cc(1249)
>>> compileLegacyCode: %U -->
>>> 'https://baybridge-module-8155.scratch.my.salesforce.com/*'
>>> 2023/02/15 15:44:24.284 kid1| 4,3| errorpage.cc(1249)
>>> compileLegacyCode: %W -->
>>> '?subject=CacheErrorInfo%20-%20ERR_CANNOT_FORWARD&body=CacheHost%3A%20opl-egress-proxy-vm-31vr%0D%0AErrPage%3A%20ERR_CANNOT_FORWARD%0D%0AErr%3A%20%5Bnone%5D%0D%0ATimeStamp%3A%20Wed,%2015%20Feb%202023%2014%3A44%3A24%20GMT%0D%0A%0D%0AClientIP%3A%20100.121.10.148%0D%0A%0D%0AHTTP%20Request%3A%0D%0ACONNECT%20%20HTTP%2F1.1%0AVia%3A%201.1%20gitlab-proxy-6d445dbd8d-mxtqv%20(squid%2F5.7)%0D%0AX-Forwarded-For%3A%20100.113.24.224%0D%0ACache-Control%3A%20max-age%3D259200%0D%0AConnection%3A%20close%0D%0AHost%3A%20baybridge-module-8155.scratch.my.salesforce.com%3A443%0D%0A%0D%0A%0D%0A'
>>> 2023/02/15 15:44:24.286 kid1| 33,3| client_side_request.cc(272)
>>> ~ClientHttpRequest: httpRequestFree:
>>> baybridge-module-8155.scratch.my.salesforce.com:443
>>> 2023/02/15 15:44:24.286 kid1| 33,5| client_side.cc(385) logRequest:
>>> logging half-baked transaction:
>>> baybridge-module-8155.scratch.my.salesforce.com:443
>>>
>>> Our parent proxy settings for DNS:
>>> negative_dns_ttl 3 seconds  #if we set 1s it behaves the same
>>> dns_nameservers 8.8.8.8 1.1.1.1
>>>
>>> The question is:
>>> If you carefully look at the debug log you see:
>>> a. I(Squid) can't find IP for the name
>>> b. I've got 3 IPs from DNS
>>> c. OK, so I've got IP
>>> d. ...Oh, I cannot find any IP
>>> e. I can't find any destinations (what's that?)
>>> f. I'm outputing an error
>>>
>>> So, do you think it's ok or there is a bug?
>>>
>>> Rgds,
>>> Maciej Leks
>>> _______________________________________________
>>> squid-users mailing list
>>> squid-users at lists.squid-cache.org
>>> http://lists.squid-cache.org/listinfo/squid-users
>>
>> _______________________________________________
>> squid-users mailing list
>> squid-users at lists.squid-cache.org
>> http://lists.squid-cache.org/listinfo/squid-users
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users



From tibor.matyas at dsi-as.de  Fri Feb 17 19:27:13 2023
From: tibor.matyas at dsi-as.de (MATYAS, Tibor)
Date: Fri, 17 Feb 2023 20:27:13 +0100
Subject: [squid-users] Portal Splash Page 4.7 -> 5.7 FATAL:
 (ext_session_acl): Failed to open session db
In-Reply-To: <65f5b301-16e3-fc71-5043-7d1017422c04@measurement-factory.com>
References: <7ec11549-164f-7aa2-87ce-ef87dd7f3303@dsi-as.de>
 <e9176547-ae57-1a7b-99bf-093d280fecaf@dsi-as.de>
 <65f5b301-16e3-fc71-5043-7d1017422c04@measurement-factory.com>
Message-ID: <b1df488c-f83a-ff40-dd7a-9b3394df2c45@dsi-as.de>

Dear Alex,

the file permissions must be ok.
Check my log messages, I made an extra test with a short path under /tmp
squid is able to create the session file:
-rw-r----- 1 squid squid 0 17. Feb 14:44 session

and even so, I get the error messages.
The same configuration was and is perfect under squid 3.x and 4.x.

Next week I will do deeper checks, thank you for your ideas.

A statement, that that part has no regressions, works also in the 5.x 
versions would give me hope :-D

br, Tibor

Am 17.02.2023 um 17:30 schrieb Alex Rousskov:
> On 2/17/23 09:20, MATYAS, Tibor wrote:
>
>> FATAL: (ext_session_acl): Failed to open session db 
>> '/tmp/session/session'
>
>> An empty session file with zero byte is always created (with or
>> without tdb), and then the error flow.
>
> This is a long shot, but check permissions of that file (and its 
> directory). Will Squid effective user be able to open that file for 
> writing? I would expect the helper to not be able to create a file at 
> all if this is a permissions issue, but it is easy to check.
>
> If checking permissions does not give you an answer, I would try 
> wrapping the helper in a script to strace it (or equivalent). If you 
> are lucky, you will see a failed helper system call just before the 
> helper system calls that emit the above error message. That failure 
> may explain what is going on.
>
> If nothing helps, I would attach gdb to the helper, but that requires 
> even more work.
>
>
> HTH,
>
> Alex.
>
>
>> Am 17.02.2023 um 10:09 schrieb MATYAS, Tibor:
>>> Hello List,
>>>
>>> trying to move from 4.7 to 5.7 (on gentoo Linux).
>>> Splash portal is in use 
>>> https://wiki.squid-cache.org/ConfigExamples/Portal/Splash
>>>
>>> squid -k parse -> OK
>>> /var/lib/squid/session/ is clean, old berkeleyDB session files deleted.
>>> Owner of the folder is the squid user.
>>>
>>> Squid compiled with tdb:
>>>
>>> Squid Cache: Version 5.7
>>> Service Name: squid
>>> Gentoo squid-5.7-r1 (r: NONE)
>>> This binary uses OpenSSL 1.1.1t? 7 Feb 2023. For legal restrictions 
>>> on distribution see https://www.openssl.org/source/license.html
>>> configure options:? '--prefix=/usr' '--build=x86_64-pc-linux-gnu' 
>>> '--host=x86_64-pc-linux-gnu' '--mandir=/usr/share/man' 
>>> '--infodir=/usr/share/info' '--datadir=/usr/share' 
>>> '--sysconfdir=/etc' '--localstatedir=/var/lib' 
>>> '--datarootdir=/usr/share' '--disable-dependency-tracking' 
>>> '--disable-silent-rules' '--disable-static' 
>>> '--docdir=/usr/share/doc/squid-5.7-r1' 
>>> '--htmldir=/usr/share/doc/squid-5.7-r1/html' '--with-sysroot=/' 
>>> '--libdir=/usr/lib64' '--datadir=/usr/share/squid' 
>>> '--libexecdir=/usr/libexec/squid' '--localstatedir=/var' 
>>> '--sysconfdir=/etc/squid' '--with-default-user=squid' 
>>> '--with-logdir=/var/log/squid' '--with-pidfile=/run/squid.pid' 
>>> '--enable-build-info=Gentoo squid-5.7-r1 (r: NONE)' 
>>> '--enable-log-daemon-helpers' '--enable-url-rewrite-helpers' 
>>> '--enable-cache-digests' '--enable-delay-pools' '--enable-disk-io' 
>>> '--enable-eui' '--enable-icmp' '--enable-ipv6' 
>>> '--enable-follow-x-forwarded-for' 
>>> '--enable-removal-policies=lru,heap' 
>>> '--disable-strict-error-checking' '--disable-arch-native' 
>>> '--with-large-files' '--with-build-environment=default' '--with-tdb' 
>>> '--without-included-ltdl' '--with-ltdl-include=/usr/include' 
>>> '--with-ltdl-lib=/usr/lib64' '--with-libcap' '--enable-snmp' 
>>> '--with-openssl' '--with-nettle' '--with-gnutls' '--enable-ssl-crtd' 
>>> '--without-systemd' '--without-cppunit' '--disable-ecap' 
>>> '--disable-esi' '--disable-expat' '--disable-libxml2' 
>>> '--enable-htcp' '--enable-wccp' '--enable-wccpv2' 
>>> '--without-mit-krb5' '--without-heimdal-krb5' 
>>> '--enable-linux-netfilter' '--enable-storeio=aufs,diskd,rock,ufs' 
>>> '--enable-auth-basic=NCSA,POP3,getpwnam,PAM' 
>>> '--enable-auth-digest=file' '--enable-auth-ntlm=none' 
>>> '--enable-auth-negotiate=none' 
>>> '--enable-external-acl-helpers=file_userip,session,unix_group,delayer,time_quota' 
>>> 'build_alias=x86_64-pc-linux-gnu' 'host_alias=x86_64-pc-linux-gnu' 
>>> 'CC=x86_64-pc-linux-gnu-gcc' 'CFLAGS=-march=nocona -O2 -pipe 
>>> -fomit-frame-pointer' 'LDFLAGS=-Wl,-O1 -Wl,--as-needed' 
>>> 'CXXFLAGS=-march=nocona -O2 -pipe -fomit-frame-pointer' 
>>> 'BUILDCXX=x86_64-pc-linux-gnu-g++' 'BUILDCXXFLAGS=-march=nocona -O2 
>>> -pipe -fomit-frame-pointer'
>>>
>>> starting squid results in:
>>>
>>> FATAL: (ext_session_acl): Failed to open session db 
>>> '/var/lib/squid/session/session'
>>> 2023/02/17 09:21:11 kid1| WARNING: external_acl_type #Hlpr27652 exited
>>> ??? current master transaction: master3
>>> 2023/02/17 09:21:11 kid1| Too few external_acl_type processes are 
>>> running (need 1/1)
>>> ??? current master transaction: master3
>>> 2023/02/17 09:21:11 kid1| Starting new helpers
>>> ??? current master transaction: master3
>>> 2023/02/17 09:21:11 kid1| helperOpenServers: Starting 1/1 
>>> 'ext_session_acl' processes
>>> ??? current master transaction: master3
>>>
>>> What am I missing?
>>>
>>> Thanks a lot and br
>>> Tibor
>>>
>>> _______________________________________________
>>> squid-users mailing list
>>> squid-users at lists.squid-cache.org
>>> http://lists.squid-cache.org/listinfo/squid-users
>>
>>
>>
>> --------------------------------------------------
>> DSI Aerospace Technologie GmbH
>>
>> Sitz der Gesellschaft: Otto-Lilienthal-Str. 1, D-28199 Bremen, Germany
>> Web: http://www.dsi-as.de
>>
>> Geschaeftsfuehrer: Dr.-Ing. Christian Dierker
>> ?????????????????? M. Sc. Elias Hashem
>>
>> HRB 17726, Amtsgericht Bremen
>> USt-IdNr.: DE 192 681 774
>> --------------------------------------------------
>>
>>
>>
>> _______________________________________________
>> squid-users mailing list
>> squid-users at lists.squid-cache.org
>> http://lists.squid-cache.org/listinfo/squid-users
>
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users



--------------------------------------------------
DSI Aerospace Technologie GmbH

Sitz der Gesellschaft: Otto-Lilienthal-Str. 1, D-28199 Bremen, Germany
Web: http://www.dsi-as.de

Geschaeftsfuehrer: Dr.-Ing. Christian Dierker
                   M. Sc. Elias Hashem

HRB 17726, Amtsgericht Bremen
USt-IdNr.: DE 192 681 774
--------------------------------------------------





From rousskov at measurement-factory.com  Fri Feb 17 19:43:16 2023
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Fri, 17 Feb 2023 14:43:16 -0500
Subject: [squid-users] Portal Splash Page 4.7 -> 5.7 FATAL:
 (ext_session_acl): Failed to open session db
In-Reply-To: <b1df488c-f83a-ff40-dd7a-9b3394df2c45@dsi-as.de>
References: <7ec11549-164f-7aa2-87ce-ef87dd7f3303@dsi-as.de>
 <e9176547-ae57-1a7b-99bf-093d280fecaf@dsi-as.de>
 <65f5b301-16e3-fc71-5043-7d1017422c04@measurement-factory.com>
 <b1df488c-f83a-ff40-dd7a-9b3394df2c45@dsi-as.de>
Message-ID: <eded9d80-ae61-92c7-79dc-ee50e61577db@measurement-factory.com>

On 2/17/23 14:27, MATYAS, Tibor wrote:

> A statement, that that part has no regressions, works also in the 5.x 
> versions would give me hope :-D

Hopefully, somebody using the session db helper would be able to confirm 
that for you.

FWIW, some of the code involved in your test is not a part of our 
automatic regression testing suite (yet?), and the session helper code 
itself was changed since Squid v4, so regressions are very much possible.


Good luck,

Alex.


> Am 17.02.2023 um 17:30 schrieb Alex Rousskov:
>> On 2/17/23 09:20, MATYAS, Tibor wrote:
>>
>>> FATAL: (ext_session_acl): Failed to open session db 
>>> '/tmp/session/session'
>>
>>> An empty session file with zero byte is always created (with or
>>> without tdb), and then the error flow.
>>
>> This is a long shot, but check permissions of that file (and its 
>> directory). Will Squid effective user be able to open that file for 
>> writing? I would expect the helper to not be able to create a file at 
>> all if this is a permissions issue, but it is easy to check.
>>
>> If checking permissions does not give you an answer, I would try 
>> wrapping the helper in a script to strace it (or equivalent). If you 
>> are lucky, you will see a failed helper system call just before the 
>> helper system calls that emit the above error message. That failure 
>> may explain what is going on.
>>
>> If nothing helps, I would attach gdb to the helper, but that requires 
>> even more work.
>>
>>
>> HTH,
>>
>> Alex.
>>
>>
>>> Am 17.02.2023 um 10:09 schrieb MATYAS, Tibor:
>>>> Hello List,
>>>>
>>>> trying to move from 4.7 to 5.7 (on gentoo Linux).
>>>> Splash portal is in use 
>>>> https://wiki.squid-cache.org/ConfigExamples/Portal/Splash
>>>>
>>>> squid -k parse -> OK
>>>> /var/lib/squid/session/ is clean, old berkeleyDB session files deleted.
>>>> Owner of the folder is the squid user.
>>>>
>>>> Squid compiled with tdb:
>>>>
>>>> Squid Cache: Version 5.7
>>>> Service Name: squid
>>>> Gentoo squid-5.7-r1 (r: NONE)
>>>> This binary uses OpenSSL 1.1.1t? 7 Feb 2023. For legal restrictions 
>>>> on distribution see https://www.openssl.org/source/license.html
>>>> configure options:? '--prefix=/usr' '--build=x86_64-pc-linux-gnu' 
>>>> '--host=x86_64-pc-linux-gnu' '--mandir=/usr/share/man' 
>>>> '--infodir=/usr/share/info' '--datadir=/usr/share' 
>>>> '--sysconfdir=/etc' '--localstatedir=/var/lib' 
>>>> '--datarootdir=/usr/share' '--disable-dependency-tracking' 
>>>> '--disable-silent-rules' '--disable-static' 
>>>> '--docdir=/usr/share/doc/squid-5.7-r1' 
>>>> '--htmldir=/usr/share/doc/squid-5.7-r1/html' '--with-sysroot=/' 
>>>> '--libdir=/usr/lib64' '--datadir=/usr/share/squid' 
>>>> '--libexecdir=/usr/libexec/squid' '--localstatedir=/var' 
>>>> '--sysconfdir=/etc/squid' '--with-default-user=squid' 
>>>> '--with-logdir=/var/log/squid' '--with-pidfile=/run/squid.pid' 
>>>> '--enable-build-info=Gentoo squid-5.7-r1 (r: NONE)' 
>>>> '--enable-log-daemon-helpers' '--enable-url-rewrite-helpers' 
>>>> '--enable-cache-digests' '--enable-delay-pools' '--enable-disk-io' 
>>>> '--enable-eui' '--enable-icmp' '--enable-ipv6' 
>>>> '--enable-follow-x-forwarded-for' 
>>>> '--enable-removal-policies=lru,heap' 
>>>> '--disable-strict-error-checking' '--disable-arch-native' 
>>>> '--with-large-files' '--with-build-environment=default' '--with-tdb' 
>>>> '--without-included-ltdl' '--with-ltdl-include=/usr/include' 
>>>> '--with-ltdl-lib=/usr/lib64' '--with-libcap' '--enable-snmp' 
>>>> '--with-openssl' '--with-nettle' '--with-gnutls' '--enable-ssl-crtd' 
>>>> '--without-systemd' '--without-cppunit' '--disable-ecap' 
>>>> '--disable-esi' '--disable-expat' '--disable-libxml2' 
>>>> '--enable-htcp' '--enable-wccp' '--enable-wccpv2' 
>>>> '--without-mit-krb5' '--without-heimdal-krb5' 
>>>> '--enable-linux-netfilter' '--enable-storeio=aufs,diskd,rock,ufs' 
>>>> '--enable-auth-basic=NCSA,POP3,getpwnam,PAM' 
>>>> '--enable-auth-digest=file' '--enable-auth-ntlm=none' 
>>>> '--enable-auth-negotiate=none' 
>>>> '--enable-external-acl-helpers=file_userip,session,unix_group,delayer,time_quota' 'build_alias=x86_64-pc-linux-gnu' 'host_alias=x86_64-pc-linux-gnu' 'CC=x86_64-pc-linux-gnu-gcc' 'CFLAGS=-march=nocona -O2 -pipe -fomit-frame-pointer' 'LDFLAGS=-Wl,-O1 -Wl,--as-needed' 'CXXFLAGS=-march=nocona -O2 -pipe -fomit-frame-pointer' 'BUILDCXX=x86_64-pc-linux-gnu-g++' 'BUILDCXXFLAGS=-march=nocona -O2 -pipe -fomit-frame-pointer'
>>>>
>>>> starting squid results in:
>>>>
>>>> FATAL: (ext_session_acl): Failed to open session db 
>>>> '/var/lib/squid/session/session'
>>>> 2023/02/17 09:21:11 kid1| WARNING: external_acl_type #Hlpr27652 exited
>>>> ??? current master transaction: master3
>>>> 2023/02/17 09:21:11 kid1| Too few external_acl_type processes are 
>>>> running (need 1/1)
>>>> ??? current master transaction: master3
>>>> 2023/02/17 09:21:11 kid1| Starting new helpers
>>>> ??? current master transaction: master3
>>>> 2023/02/17 09:21:11 kid1| helperOpenServers: Starting 1/1 
>>>> 'ext_session_acl' processes
>>>> ??? current master transaction: master3
>>>>
>>>> What am I missing?
>>>>
>>>> Thanks a lot and br
>>>> Tibor
>>>>
>>>> _______________________________________________
>>>> squid-users mailing list
>>>> squid-users at lists.squid-cache.org
>>>> http://lists.squid-cache.org/listinfo/squid-users
>>>
>>>
>>>
>>> --------------------------------------------------
>>> DSI Aerospace Technologie GmbH
>>>
>>> Sitz der Gesellschaft: Otto-Lilienthal-Str. 1, D-28199 Bremen, Germany
>>> Web: http://www.dsi-as.de
>>>
>>> Geschaeftsfuehrer: Dr.-Ing. Christian Dierker
>>> ?????????????????? M. Sc. Elias Hashem
>>>
>>> HRB 17726, Amtsgericht Bremen
>>> USt-IdNr.: DE 192 681 774
>>> --------------------------------------------------
>>>
>>>
>>>
>>> _______________________________________________
>>> squid-users mailing list
>>> squid-users at lists.squid-cache.org
>>> http://lists.squid-cache.org/listinfo/squid-users
>>
>> _______________________________________________
>> squid-users mailing list
>> squid-users at lists.squid-cache.org
>> http://lists.squid-cache.org/listinfo/squid-users
> 
> 
> 
> --------------------------------------------------
> DSI Aerospace Technologie GmbH
> 
> Sitz der Gesellschaft: Otto-Lilienthal-Str. 1, D-28199 Bremen, Germany
> Web: http://www.dsi-as.de
> 
> Geschaeftsfuehrer: Dr.-Ing. Christian Dierker
>  ????????????????? M. Sc. Elias Hashem
> 
> HRB 17726, Amtsgericht Bremen
> USt-IdNr.: DE 192 681 774
> --------------------------------------------------
> 
> 
> 
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users



From squid3 at treenet.co.nz  Fri Feb 17 20:18:36 2023
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Sat, 18 Feb 2023 09:18:36 +1300
Subject: [squid-users] Understanding maximum outgoing HTTP CONNECT
 requests?
In-Reply-To: <2392320D-4BEF-4A93-9322-0344EA18EC77@kontos-home.com>
References: <2392320D-4BEF-4A93-9322-0344EA18EC77@kontos-home.com>
Message-ID: <aee5cd8e-2d83-ea4e-401b-5a8f997fc733@treenet.co.nz>

On 18/02/2023 12:14 am, divan.whelk.0u wrote:
> Hi there!
>
> I?m trying to understand what would the ?theoretical? maximum amount of outgoing connections with squid setup as a HTTP CONNECT forward proxy would be (hardware permitting)?

As you likely know, each TCP/IP connection uses a 4-tuple identifier 
{src-IP, src-port, dst-IP, dst-port}.

So at face value there is a protocol imposed cap of (2^128 * 2^16 * 
2^128 * 2^16) = 2^288 connections.

Being theoretical we have:
 ??? * ignored reserved IP ranges,
 ??? * ignored OS-specific ephemeral port reservations,
 ??? * assumed IPv6 availability, and
 ??? * assumed no access restrictions in Squid, network routing, nor 
firewall.

The factors to consider are:

 ?- Squid machine can be assigned multiple IP's.
 ? ? Thus src-IP on outbound and dst-IP on inbound are that N.

 ?- Squid can be configured to receive on up to 64 ports.
 ?? Thus dst-port on inbound is 2^6.

 ?- DNS can provide any number of IPs for any given server name.
 ??? Thus outbound dst-IP can be any 2^128 value.

 ?- modern websites use use Alt-Svc to spread across ports.
 ??? Thus outbound dst-port can be any 2^16 value.

So for theoretical limit the math is:

 ?inbound =??? 2^128 * 2^16 * N * 2^16? = N * 2^160

 ?outbound =? N * 2^6 * 2^128 * 2^16 = N * 2^150

Inbound and outbound are normally independent, but CONNECT is a special 
case where they are pinned 1:1.

Thus total theoretical limit of simultaneous connections Squid can be 
juggling is? N * 2^151.

Reality can be significantly different for any given installation, but 
is imposed by configuration choices and thus can be altered as needed.


>  From the [squid-users] About bottlenecks (Max number of connections, etc.) thread, I saw mention of the following:
>
>> * The limit on number of connections any Squid can have attached is only limited by your configured FD limits and available server RAM. Squid uses ~64 KB per network socket for traffic state - which equates to around 2 GB of RAM just for I/O buffers at 20,000 concurrent client connections.
> I assume the same would not apply on outgoing connections, and that there would be a limit of 65,536 connections to a single IP, port pair? For example, if we had 1 million users making requests via HTTP CONNECT, only 65K of them would be able to access the same website at any one time?

IIRC that quoted thread was discussing a Squid with more normal 
multiple-destination case hitting FD limits.? The 64K port limitation 
you refer to is a special case contingent on the "single destination 
with single IP:port" criteria - which itself is rarely true for a 
popular website. It assumes configuration restriction imposing that 
criteria somehow.


Cheers
Amos



From squid3 at treenet.co.nz  Fri Feb 17 20:20:45 2023
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Sat, 18 Feb 2023 09:20:45 +1300
Subject: [squid-users] Log 407-transactions when username is known
In-Reply-To: <31d33f32-d522-3403-7153-1ae757e2ec73@treenet.co.nz>
References: <CADJd0Y11L3Y8cF4tY3Z2uevQXf-9=LAqiR3fZ1s7jx89BUFMvQ@mail.gmail.com>
 <31d33f32-d522-3403-7153-1ae757e2ec73@treenet.co.nz>
Message-ID: <288acdee-3811-a4ef-f216-1bd6132929fc@treenet.co.nz>

On 18/02/2023 7:29 am, Amos Jeffries wrote:
> On 17/02/2023 7:29 pm, Andrey K wrote:
>> Hello,
>>
>> I would like to disable logging of 407-errors, except when the 
>> username is known.
>> Is it possible to configure?
>
> Assuming that you have the wrapper script from your previous request 
> about always logging usernames you should be able to use a note type 
> ACL like so:
>
> ?acl knownUser note user
> ?access_log ... on-error=drop http-407 !knownUser
>
>
>>
>> I have now the log configured:
>> acl http-407 http_status 407
>> access_log daemon:/var/log/squid/access.log logformat=extended-squid 
>> on-error=drop !http-407
>>
>> But I would also like to see authentication errors when a user types 
>> the wrong password (the username is known in these cases).
>>
>
> With most HTTP authentication you could rely on all 407 meaning bad or 
> unknown credentials. But NTLM (ab)uses that code for its handshake 
> type-2 response, so you one distinguish a failed from an incomplete 
> authentication.

That was meant to say "so one cannot distinguish a failed from an 
incomplete authentication."


>
> At this point you are already wrapping and re-writing most of the 
> NTLM->Squid helper traffic. You could adjust the challenge to also use 
> the current helper syntax with a custom note to log. But I recommend 
> just upgrading your systems to Kerberos which will avoid a lot of 
> these complications entirely.
>
> Cheers
> Amos
>
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users



From peter at hucker.plus.com  Sun Feb 19 21:26:40 2023
From: peter at hucker.plus.com (Peter Hucker)
Date: Sun, 19 Feb 2023 21:26:40 -0000
Subject: [squid-users] Help with using Squid proxy and VPN at the same time.
Message-ID: <op.10mtuqo1mk2j66@ryzen.home>

I use a Squid proxy just for Boinc (I have 8 PCs and it caches the downloads which all 8 machines get (large data files). I also use a VPN. I want to tell the VPN to not put Squid through it (as for some reason Boinc servers hate VPNs). I can tell the VPN to exclude certain apps by giving it the name of the executable. But what executable in Squid actually connects to the network?


From squid3 at treenet.co.nz  Mon Feb 20 02:21:52 2023
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Mon, 20 Feb 2023 15:21:52 +1300
Subject: [squid-users] Help with using Squid proxy and VPN at the same
 time.
In-Reply-To: <op.10mtuqo1mk2j66@ryzen.home>
References: <op.10mtuqo1mk2j66@ryzen.home>
Message-ID: <6cfae258-974f-2294-e670-2e958d91a4eb@treenet.co.nz>

On 20/02/2023 10:26 am, Peter Hucker wrote:
> I use a Squid proxy just for Boinc (I have 8 PCs and it caches the 
> downloads which all 8 machines get (large data files). I also use a 
> VPN. I want to tell the VPN to not put Squid through it (as for some 
> reason Boinc servers hate VPNs). I can tell the VPN to exclude certain 
> apps by giving it the name of the executable. But what executable in 
> Squid actually connects to the network?

The squid binary name is 'squid'.

Cheers
Amos



From peter at hucker.plus.com  Mon Feb 20 03:18:37 2023
From: peter at hucker.plus.com (Peter Hucker)
Date: Mon, 20 Feb 2023 03:18:37 -0000
Subject: [squid-users] Help with using Squid proxy and VPN at the same
 time.
In-Reply-To: <6cfae258-974f-2294-e670-2e958d91a4eb@treenet.co.nz>
References: <op.10mtuqo1mk2j66@ryzen.home>
 <6cfae258-974f-2294-e670-2e958d91a4eb@treenet.co.nz>
Message-ID: <op.10m95buumk2j66@ryzen.home>

On Mon, 20 Feb 2023 02:21:52 -0000, Amos Jeffries <squid3 at treenet.co.nz> wrote:

> On 20/02/2023 10:26 am, Peter Hucker wrote:
>> I use a Squid proxy just for Boinc (I have 8 PCs and it caches the
>> downloads which all 8 machines get (large data files). I also use a
>> VPN. I want to tell the VPN to not put Squid through it (as for some
>> reason Boinc servers hate VPNs). I can tell the VPN to exclude certain
>> apps by giving it the name of the executable. But what executable in
>> Squid actually connects to the network?
>
> The squid binary name is 'squid'.

Odd, I told Ivacy VPN to use split tunneling and not put "C:\Squid\bin\squid.exe" through the proxy.  Boinc is still sluggish.  Can I tell from the Squid logs if it's using the VPN?


From squid3 at treenet.co.nz  Mon Feb 20 04:42:55 2023
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Mon, 20 Feb 2023 17:42:55 +1300
Subject: [squid-users] Help with using Squid proxy and VPN at the same
 time.
In-Reply-To: <op.10m95buumk2j66@ryzen.home>
References: <op.10mtuqo1mk2j66@ryzen.home>
 <6cfae258-974f-2294-e670-2e958d91a4eb@treenet.co.nz>
 <op.10m95buumk2j66@ryzen.home>
Message-ID: <a477ddc4-f8ba-fb04-d9d9-a381e906e205@treenet.co.nz>



On 20/02/2023 4:18 pm, Peter Hucker wrote:
> On Mon, 20 Feb 2023 02:21:52 -0000, Amos Jeffries wrote:
>
>> On 20/02/2023 10:26 am, Peter Hucker wrote:
>>> I use a Squid proxy just for Boinc (I have 8 PCs and it caches the
>>> downloads which all 8 machines get (large data files). I also use a
>>> VPN. I want to tell the VPN to not put Squid through it (as for some
>>> reason Boinc servers hate VPNs). I can tell the VPN to exclude certain
>>> apps by giving it the name of the executable. But what executable in
>>> Squid actually connects to the network?
>>
>> The squid binary name is 'squid'.
>
> Odd, I told Ivacy VPN to use split tunneling and not put 
> "C:\Squid\bin\squid.exe" through the proxy.? Boinc is still sluggish.? 
> Can I tell from the Squid logs if it's using the VPN?

Hmm, not sure. Squid logs the IPs of servers it contacts. You would need 
to find out how to trace the traffic flows to or through the VNP 
externally and see if the connections match up. I am not sure how to do 
that on modern Windows machines.

HTH
Amos



From ankor2023 at gmail.com  Mon Feb 20 06:24:55 2023
From: ankor2023 at gmail.com (Andrey K)
Date: Mon, 20 Feb 2023 09:24:55 +0300
Subject: [squid-users] Log 407-transactions when username is known
In-Reply-To: <288acdee-3811-a4ef-f216-1bd6132929fc@treenet.co.nz>
References: <CADJd0Y11L3Y8cF4tY3Z2uevQXf-9=LAqiR3fZ1s7jx89BUFMvQ@mail.gmail.com>
 <31d33f32-d522-3403-7153-1ae757e2ec73@treenet.co.nz>
 <288acdee-3811-a4ef-f216-1bd6132929fc@treenet.co.nz>
Message-ID: <CADJd0Y3Aip3Z6y3TQObKPvNcgyeK33y_Uc9hzEzEHfi7Dd2nrw@mail.gmail.com>

Hello Amos,

Thank you for your recommendations.
I modified negotiate_wrapper_auth to parse NTLM tokens and to set the user
attribute in AV-pairs,
so now I can configure the desired logging using acl note-type.

But I also have BASIC authentication type users.
Usernames of those users are known to the squid even if they type wrong
passwords, but  the user-attribute is not set in the note-list in such
transactions.
Should I write a new wrapper script for the BASIC-authentication to set the
user-attribute, or I can check if the username is known without using
wrapper?

The general idea is to log wrong authentication attempts to find the
sources if user accounts are blocked in AD.

> But I recommend
> just upgrading your systems to Kerberos which will avoid a lot of
> these complications entirely.
We have many linux-users whose software can't perform Kerberos proxy
authentication, they can just NTLM, or even BASIC (or they can't work
through http-proxy at all, but we configure them to use cntlm or
proxifier). So we cannot refuse NTLM and BASIC proxy-authentications.

Kind regards,
       Ankor.




??, 17 ????. 2023 ?. ? 23:20, Amos Jeffries <squid3 at treenet.co.nz>:

> On 18/02/2023 7:29 am, Amos Jeffries wrote:
> > On 17/02/2023 7:29 pm, Andrey K wrote:
> >> Hello,
> >>
> >> I would like to disable logging of 407-errors, except when the
> >> username is known.
> >> Is it possible to configure?
> >
> > Assuming that you have the wrapper script from your previous request
> > about always logging usernames you should be able to use a note type
> > ACL like so:
> >
> >  acl knownUser note user
> >  access_log ... on-error=drop http-407 !knownUser
> >
> >
> >>
> >> I have now the log configured:
> >> acl http-407 http_status 407
> >> access_log daemon:/var/log/squid/access.log logformat=extended-squid
> >> on-error=drop !http-407
> >>
> >> But I would also like to see authentication errors when a user types
> >> the wrong password (the username is known in these cases).
> >>
> >
> > With most HTTP authentication you could rely on all 407 meaning bad or
> > unknown credentials. But NTLM (ab)uses that code for its handshake
> > type-2 response, so you one distinguish a failed from an incomplete
> > authentication.
>
> That was meant to say "so one cannot distinguish a failed from an
> incomplete authentication."
>
>
> >
> > At this point you are already wrapping and re-writing most of the
> > NTLM->Squid helper traffic. You could adjust the challenge to also use
> > the current helper syntax with a custom note to log. But I recommend
> > just upgrading your systems to Kerberos which will avoid a lot of
> > these complications entirely.
> >
> > Cheers
> > Amos
> >
> > _______________________________________________
> > squid-users mailing list
> > squid-users at lists.squid-cache.org
> > http://lists.squid-cache.org/listinfo/squid-users
>
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230220/bcc029ea/attachment.htm>

From squid3 at treenet.co.nz  Mon Feb 20 09:14:17 2023
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Mon, 20 Feb 2023 22:14:17 +1300
Subject: [squid-users] Log 407-transactions when username is known
In-Reply-To: <CADJd0Y3Aip3Z6y3TQObKPvNcgyeK33y_Uc9hzEzEHfi7Dd2nrw@mail.gmail.com>
References: <CADJd0Y11L3Y8cF4tY3Z2uevQXf-9=LAqiR3fZ1s7jx89BUFMvQ@mail.gmail.com>
 <31d33f32-d522-3403-7153-1ae757e2ec73@treenet.co.nz>
 <288acdee-3811-a4ef-f216-1bd6132929fc@treenet.co.nz>
 <CADJd0Y3Aip3Z6y3TQObKPvNcgyeK33y_Uc9hzEzEHfi7Dd2nrw@mail.gmail.com>
Message-ID: <f15b7cee-8e87-bb72-e1d0-5cbec8bd88cc@treenet.co.nz>

On 20/02/2023 7:24 pm, Andrey K wrote:
> Hello Amos,
>
> Thank you for your recommendations.
> I modified?negotiate_wrapper_auth to parse NTLM tokens and to set the 
> user attribute in AV-pairs,
> so now I can configure the desired logging using acl note-type.
>
> But I also have BASIC authentication type users.
> Usernames of those users are known to the squid even if they type 
> wrong passwords, but??the user-attribute is not set in the note-list 
> in such transactions.
> Should I write a new wrapper script for the BASIC-authentication to 
> set the user-attribute, or I can check if the username is known 
> without using wrapper?
>

The username of Basic auth should be known and available with %un or %ul 
whenever the client provides one.
If not, then yes you will have to add a wrapper there too to send user= 
on ERR responses.

HTH
Amos



From ankor2023 at gmail.com  Mon Feb 20 10:07:17 2023
From: ankor2023 at gmail.com (Andrey K)
Date: Mon, 20 Feb 2023 13:07:17 +0300
Subject: [squid-users] Log 407-transactions when username is known
In-Reply-To: <f15b7cee-8e87-bb72-e1d0-5cbec8bd88cc@treenet.co.nz>
References: <CADJd0Y11L3Y8cF4tY3Z2uevQXf-9=LAqiR3fZ1s7jx89BUFMvQ@mail.gmail.com>
 <31d33f32-d522-3403-7153-1ae757e2ec73@treenet.co.nz>
 <288acdee-3811-a4ef-f216-1bd6132929fc@treenet.co.nz>
 <CADJd0Y3Aip3Z6y3TQObKPvNcgyeK33y_Uc9hzEzEHfi7Dd2nrw@mail.gmail.com>
 <f15b7cee-8e87-bb72-e1d0-5cbec8bd88cc@treenet.co.nz>
Message-ID: <CADJd0Y3_vOvLJBJZLCe3ebKctKmyjaGhwSWQ+BKVBMV3bNNz9w@mail.gmail.com>

Thank you very much, Amos,

I have checked that both variables %un and %ul are set in squid during
failed BASIC-authentications.
But I do not know how to use them in ACL. I need an ACL that triggers if
%un is set (to log such transactions).




??, 20 ????. 2023 ?. ? 12:14, Amos Jeffries <squid3 at treenet.co.nz>:

> On 20/02/2023 7:24 pm, Andrey K wrote:
> > Hello Amos,
> >
> > Thank you for your recommendations.
> > I modified negotiate_wrapper_auth to parse NTLM tokens and to set the
> > user attribute in AV-pairs,
> > so now I can configure the desired logging using acl note-type.
> >
> > But I also have BASIC authentication type users.
> > Usernames of those users are known to the squid even if they type
> > wrong passwords, but  the user-attribute is not set in the note-list
> > in such transactions.
> > Should I write a new wrapper script for the BASIC-authentication to
> > set the user-attribute, or I can check if the username is known
> > without using wrapper?
> >
>
> The username of Basic auth should be known and available with %un or %ul
> whenever the client provides one.
> If not, then yes you will have to add a wrapper there too to send user=
> on ERR responses.
>
> HTH
> Amos
>
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230220/529d085f/attachment.htm>

From tibor.matyas at dsi-as.de  Wed Feb 22 08:10:48 2023
From: tibor.matyas at dsi-as.de (MATYAS, Tibor)
Date: Wed, 22 Feb 2023 09:10:48 +0100
Subject: [squid-users] Portal Splash Page 4.7 -> 5.7 FATAL:
 (ext_session_acl): Failed to open session db
In-Reply-To: <eded9d80-ae61-92c7-79dc-ee50e61577db@measurement-factory.com>
References: <7ec11549-164f-7aa2-87ce-ef87dd7f3303@dsi-as.de>
 <e9176547-ae57-1a7b-99bf-093d280fecaf@dsi-as.de>
 <65f5b301-16e3-fc71-5043-7d1017422c04@measurement-factory.com>
 <b1df488c-f83a-ff40-dd7a-9b3394df2c45@dsi-as.de>
 <eded9d80-ae61-92c7-79dc-ee50e61577db@measurement-factory.com>
Message-ID: <d95b4f57-17f1-0de7-8229-28f3fae2e590@dsi-as.de>

Here are the results of my further investigations and debug sessions:

#1 external_acl_type session concurrency=100 ttl=3 %SRC 
/usr/libexec/squid/ext_session_acl -a -T 10800
without -b -> use RAM for storing the session: same error result.

#2 ext_session_acl cannot be compiled without tdb, even if I compile 
squid 5 without tdb:
ldd ext_session_acl
 ??????? linux-vdso.so.1 (0x00007ffe88d43000)
 ??????? libtdb.so.1 => /usr/lib64/libtdb.so.1 (0x00007fe62eba1000)
 ??????? ...

Installed tdb version is 1.4.7 .... error result

#3 try older tdb versions 1.4.0 ... 1.4.7 same error result
test with tdb v1.3 not done, since more overhead, also v1.3 old!

note: all tests made on a gentoo system, all packages are compiled from 
source.
So in my opinion it can be a tdb version issue or a gentoo specific issue...

A list member gave me the motivation to write an own session helper.
I looked around and switched (on the test server) to my own helper with 
redis backend (ttl built-in :-) ).

br, Tibor

Am 17.02.2023 um 20:43 schrieb Alex Rousskov:
> On 2/17/23 14:27, MATYAS, Tibor wrote:
>
>> A statement, that that part has no regressions, works also in the 5.x 
>> versions would give me hope :-D
>
> Hopefully, somebody using the session db helper would be able to 
> confirm that for you.
>
> FWIW, some of the code involved in your test is not a part of our 
> automatic regression testing suite (yet?), and the session helper code 
> itself was changed since Squid v4, so regressions are very much possible.
>
>
> Good luck,
>
> Alex.
>
>
>> Am 17.02.2023 um 17:30 schrieb Alex Rousskov:
>>> On 2/17/23 09:20, MATYAS, Tibor wrote:
>>>
>>>> FATAL: (ext_session_acl): Failed to open session db 
>>>> '/tmp/session/session'
>>>
>>>> An empty session file with zero byte is always created (with or
>>>> without tdb), and then the error flow.
>>>
>>> This is a long shot, but check permissions of that file (and its 
>>> directory). Will Squid effective user be able to open that file for 
>>> writing? I would expect the helper to not be able to create a file 
>>> at all if this is a permissions issue, but it is easy to check.
>>>
>>> If checking permissions does not give you an answer, I would try 
>>> wrapping the helper in a script to strace it (or equivalent). If you 
>>> are lucky, you will see a failed helper system call just before the 
>>> helper system calls that emit the above error message. That failure 
>>> may explain what is going on.
>>>
>>> If nothing helps, I would attach gdb to the helper, but that 
>>> requires even more work.
>>>
>>>
>>> HTH,
>>>
>>> Alex.
>>>
>>>
>>>> Am 17.02.2023 um 10:09 schrieb MATYAS, Tibor:
>>>>> Hello List,
>>>>>
>>>>> trying to move from 4.7 to 5.7 (on gentoo Linux).
>>>>> Splash portal is in use 
>>>>> https://wiki.squid-cache.org/ConfigExamples/Portal/Splash
>>>>>
>>>>> squid -k parse -> OK
>>>>> /var/lib/squid/session/ is clean, old berkeleyDB session files 
>>>>> deleted.
>>>>> Owner of the folder is the squid user.
>>>>>
>>>>> Squid compiled with tdb:
>>>>>
>>>>> Squid Cache: Version 5.7
>>>>> Service Name: squid
>>>>> Gentoo squid-5.7-r1 (r: NONE)
>>>>> This binary uses OpenSSL 1.1.1t? 7 Feb 2023. For legal 
>>>>> restrictions on distribution see 
>>>>> https://www.openssl.org/source/license.html
>>>>> configure options:? '--prefix=/usr' '--build=x86_64-pc-linux-gnu' 
>>>>> '--host=x86_64-pc-linux-gnu' '--mandir=/usr/share/man' 
>>>>> '--infodir=/usr/share/info' '--datadir=/usr/share' 
>>>>> '--sysconfdir=/etc' '--localstatedir=/var/lib' 
>>>>> '--datarootdir=/usr/share' '--disable-dependency-tracking' 
>>>>> '--disable-silent-rules' '--disable-static' 
>>>>> '--docdir=/usr/share/doc/squid-5.7-r1' 
>>>>> '--htmldir=/usr/share/doc/squid-5.7-r1/html' '--with-sysroot=/' 
>>>>> '--libdir=/usr/lib64' '--datadir=/usr/share/squid' 
>>>>> '--libexecdir=/usr/libexec/squid' '--localstatedir=/var' 
>>>>> '--sysconfdir=/etc/squid' '--with-default-user=squid' 
>>>>> '--with-logdir=/var/log/squid' '--with-pidfile=/run/squid.pid' 
>>>>> '--enable-build-info=Gentoo squid-5.7-r1 (r: NONE)' 
>>>>> '--enable-log-daemon-helpers' '--enable-url-rewrite-helpers' 
>>>>> '--enable-cache-digests' '--enable-delay-pools' '--enable-disk-io' 
>>>>> '--enable-eui' '--enable-icmp' '--enable-ipv6' 
>>>>> '--enable-follow-x-forwarded-for' 
>>>>> '--enable-removal-policies=lru,heap' 
>>>>> '--disable-strict-error-checking' '--disable-arch-native' 
>>>>> '--with-large-files' '--with-build-environment=default' 
>>>>> '--with-tdb' '--without-included-ltdl' 
>>>>> '--with-ltdl-include=/usr/include' '--with-ltdl-lib=/usr/lib64' 
>>>>> '--with-libcap' '--enable-snmp' '--with-openssl' '--with-nettle' 
>>>>> '--with-gnutls' '--enable-ssl-crtd' '--without-systemd' 
>>>>> '--without-cppunit' '--disable-ecap' '--disable-esi' 
>>>>> '--disable-expat' '--disable-libxml2' '--enable-htcp' 
>>>>> '--enable-wccp' '--enable-wccpv2' '--without-mit-krb5' 
>>>>> '--without-heimdal-krb5' '--enable-linux-netfilter' 
>>>>> '--enable-storeio=aufs,diskd,rock,ufs' 
>>>>> '--enable-auth-basic=NCSA,POP3,getpwnam,PAM' 
>>>>> '--enable-auth-digest=file' '--enable-auth-ntlm=none' 
>>>>> '--enable-auth-negotiate=none' 
>>>>> '--enable-external-acl-helpers=file_userip,session,unix_group,delayer,time_quota' 
>>>>> 'build_alias=x86_64-pc-linux-gnu' 'host_alias=x86_64-pc-linux-gnu' 
>>>>> 'CC=x86_64-pc-linux-gnu-gcc' 'CFLAGS=-march=nocona -O2 -pipe 
>>>>> -fomit-frame-pointer' 'LDFLAGS=-Wl,-O1 -Wl,--as-needed' 
>>>>> 'CXXFLAGS=-march=nocona -O2 -pipe -fomit-frame-pointer' 
>>>>> 'BUILDCXX=x86_64-pc-linux-gnu-g++' 'BUILDCXXFLAGS=-march=nocona 
>>>>> -O2 -pipe -fomit-frame-pointer'
>>>>>
>>>>> starting squid results in:
>>>>>
>>>>> FATAL: (ext_session_acl): Failed to open session db 
>>>>> '/var/lib/squid/session/session'
>>>>> 2023/02/17 09:21:11 kid1| WARNING: external_acl_type #Hlpr27652 
>>>>> exited
>>>>> ??? current master transaction: master3
>>>>> 2023/02/17 09:21:11 kid1| Too few external_acl_type processes are 
>>>>> running (need 1/1)
>>>>> ??? current master transaction: master3
>>>>> 2023/02/17 09:21:11 kid1| Starting new helpers
>>>>> ??? current master transaction: master3
>>>>> 2023/02/17 09:21:11 kid1| helperOpenServers: Starting 1/1 
>>>>> 'ext_session_acl' processes
>>>>> ??? current master transaction: master3
>>>>>
>>>>> What am I missing?
>>>>>
>>>>> Thanks a lot and br
>>>>> Tibor
>>>>>
>>>>> _______________________________________________
>>>>> squid-users mailing list
>>>>> squid-users at lists.squid-cache.org
>>>>> http://lists.squid-cache.org/listinfo/squid-users
>>>>
>>>>
>>>>
>>>> --------------------------------------------------
>>>> DSI Aerospace Technologie GmbH
>>>>
>>>> Sitz der Gesellschaft: Otto-Lilienthal-Str. 1, D-28199 Bremen, Germany
>>>> Web: http://www.dsi-as.de
>>>>
>>>> Geschaeftsfuehrer: Dr.-Ing. Christian Dierker
>>>> ?????????????????? M. Sc. Elias Hashem
>>>>
>>>> HRB 17726, Amtsgericht Bremen
>>>> USt-IdNr.: DE 192 681 774
>>>> --------------------------------------------------
>>>>
>>>>
>>>>
>>>> _______________________________________________
>>>> squid-users mailing list
>>>> squid-users at lists.squid-cache.org
>>>> http://lists.squid-cache.org/listinfo/squid-users
>>>
>>> _______________________________________________
>>> squid-users mailing list
>>> squid-users at lists.squid-cache.org
>>> http://lists.squid-cache.org/listinfo/squid-users
>>
>>
>>
>> --------------------------------------------------
>> DSI Aerospace Technologie GmbH
>>
>> Sitz der Gesellschaft: Otto-Lilienthal-Str. 1, D-28199 Bremen, Germany
>> Web: http://www.dsi-as.de
>>
>> Geschaeftsfuehrer: Dr.-Ing. Christian Dierker
>> ?????????????????? M. Sc. Elias Hashem
>>
>> HRB 17726, Amtsgericht Bremen
>> USt-IdNr.: DE 192 681 774
>> --------------------------------------------------
>>
>>
>>
>> _______________________________________________
>> squid-users mailing list
>> squid-users at lists.squid-cache.org
>> http://lists.squid-cache.org/listinfo/squid-users
>
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users



--------------------------------------------------
DSI Aerospace Technologie GmbH

Sitz der Gesellschaft: Otto-Lilienthal-Str. 1, D-28199 Bremen, Germany
Web: http://www.dsi-as.de

Geschaeftsfuehrer: Dr.-Ing. Christian Dierker
                   M. Sc. Elias Hashem

HRB 17726, Amtsgericht Bremen
USt-IdNr.: DE 192 681 774
--------------------------------------------------





From maciej.leks at gmail.com  Wed Feb 22 12:15:01 2023
From: maciej.leks at gmail.com (Maciej Leks)
Date: Wed, 22 Feb 2023 13:15:01 +0100
Subject: [squid-users] Squid returns 500 on rapidly changing DNS records
In-Reply-To: <1e0cdfa7-481b-5251-993f-9b2ab5c6ae0d@measurement-factory.com>
References: <CACSz3ZRnNHbU4p05H2YuWVKTuF8LW1kzs37BmDs1BUSPV043kw@mail.gmail.com>
 <9fc40c53-38ff-2234-2cdf-23d07cc77bfc@measurement-factory.com>
 <CACSz3ZTZob9rHQudeWqmvJw+ajNxQ2T5ge6P-G-qmXRtx2psZg@mail.gmail.com>
 <1e0cdfa7-481b-5251-993f-9b2ab5c6ae0d@measurement-factory.com>
Message-ID: <CACSz3ZRhr2WatZ5jyie17UL1oqhpGa0QFcZ05h1kc=OzvCA_Sg@mail.gmail.com>

OK, so...we have prepared to make some deeper debug on this issue but now
it disappeared (for now).
We are almost sure that the problem is on the upstream side (DNS or SF
Cloud Provider) - not Squid side.

So thank you for your help.

Cheers,
Maciek Leks

pt., 17 lut 2023 o 19:55 Alex Rousskov <rousskov at measurement-factory.com>
napisa?(a):

> On 2/17/23 13:24, Maciej Leks wrote:
> > I understand your last question but it's hard me to answer clearly -
> > yes/no.
>
> Yes, it is a difficult question to answer. Logging DNS traffic with
> tcpdump might help, but it does require some non-trivial work to
> correlate everything. For now, without that or similar additional
> information, it is easy for us to assume that you are just seeing the
> effects of DNS responses without IP addresses.
>
> There is another way to confirm or reject a bug claim. Share a
> compressed ALL,9 cache.log while reproducing the problem with as few
> transactions as possible (privately if needed).
>
> https://wiki.squid-cache.org/SquidFaq/BugReporting#debugging-a-single-transaction
>
>
> > Instead of this let me show you this log:
>
> > I suppose the A/AAAA records should already be in the DNS, but the
> > last resort squid gave up.
>
> Why do you think that the IP addresses should already be (or appear) in
> the parent Squid IP cache during these logged transactions?
>
>
> Cheers,
>
> Alex.
>
>
> > 17/Feb/2023:17:16:21 +0100 1676650581.827    103 100.121.11.70
> > 100.121.11.70 NONE_NONE/500 0 CONNECT
> > scala-module-5515.scratch.lightning.force.com:443 - HIER_NONE/- -
> > 17/Feb/2023:17:16:22 +0100 1676650582.297      0 100.121.11.70
> > 100.121.11.70 NONE_NONE/500 0 CONNECT
> > scala-module-5515.scratch.lightning.force.com:443 - HIER_NONE/- -
> > 17/Feb/2023:17:16:22 +0100 1676650582.893      0 100.121.11.70
> > 100.121.11.70 NONE_NONE/500 0 CONNECT
> > scala-module-5515.scratch.lightning.force.com:443 - HIER_NONE/- -
> > 17/Feb/2023:17:16:23 +0100 1676650583.625      0 100.121.11.70
> > 100.121.11.70 NONE_NONE/500 0 CONNECT
> > scala-module-5515.scratch.lightning.force.com:443 - HIER_NONE/- -
> > 17/Feb/2023:17:16:23 +0100 1676650583.711      0 100.121.11.70
> > 100.121.11.70 NONE_NONE/500 0 CONNECT
> > scala-module-5515.scratch.lightning.force.com:443 - HIER_NONE/- -
> > 17/Feb/2023:17:16:25 +0100 1676650585.073      0 100.121.11.70
> > 100.121.11.70 NONE_NONE/500 0 CONNECT
> > scala-module-5515.scratch.lightning.force.com:443 - HIER_NONE/- -
> > 17/Feb/2023:17:16:25 +0100 1676650585.799      0 100.121.11.70
> > 100.121.11.70 NONE_NONE/500 0 CONNECT
> > scala-module-5515.scratch.lightning.force.com:443 - HIER_NONE/- -
> > 17/Feb/2023:17:16:25 +0100 1676650585.882      0 100.121.11.70
> > 100.121.11.70 NONE_NONE/500 0 CONNECT
> > scala-module-5515.scratch.lightning.force.com:443 - HIER_NONE/- -
> > 17/Feb/2023:17:16:26 +0100 1676650586.258      0 100.121.11.70
> > 100.121.11.70 NONE_NONE/500 0 CONNECT
> > scala-module-5515.scratch.lightning.force.com:443 - HIER_NONE/- -
> > 17/Feb/2023:17:16:26 +0100 1676650586.995      0 100.121.11.70
> > 100.121.11.70 NONE_NONE/500 0 CONNECT
> > scala-module-5515.scratch.lightning.force.com:443 - HIER_NONE/- -
> > 17/Feb/2023:17:16:28 +0100 1676650588.468      0 100.121.11.70
> > 100.121.11.70 NONE_NONE/500 0 CONNECT
> > scala-module-5515.scratch.lightning.force.com:443 - HIER_NONE/- -
> > 17/Feb/2023:17:16:29 +0100 1676650589.159      0 100.121.11.70
> > 100.121.11.70 NONE_NONE/500 0 CONNECT
> > scala-module-5515.scratch.lightning.force.com:443 - HIER_NONE/- -
> > 17/Feb/2023:17:16:29 +0100 1676650589.560      0 100.121.11.70
> > 100.121.11.70 NONE_NONE/500 0 CONNECT
> > scala-module-5515.scratch.lightning.force.com:443 - HIER_NONE/- -
> > 17/Feb/2023:17:16:30 +0100 1676650590.319      0 100.121.11.70
> > 100.121.11.70 NONE_NONE/500 0 CONNECT
> > scala-module-5515.scratch.lightning.force.com:443 - HIER_NONE/- -
> >
> > This is the last resort parent squid and the 100.121.11.70 is our
> > downstream squid (child). I understand it as follows, thanks to
> > connect_retries set to 10 (here we have more than 10 tries) try to
> > connect.
>
>
>
> > pt., 17 lut 2023 o 17:46 Alex Rousskov
> > <rousskov at measurement-factory.com> napisa?(a):
> >>
> >> On 2/17/23 09:31, Maciej Leks wrote:
> >>
> >>> We have being facing the 500 error codes in our squids (v5.7) when it
> >>> comes to communicate with Salesforce DNS for ephemeral hosts
> >>
> >>>      A cs128-fra.fra.r.salesforce.com.              30s
>  85.222.154.211
> >>>      A cs128-fra.fra.r.salesforce.com.              30s   160.8.252.83
> >>>      A cs128-fra.fra.r.salesforce.com.              30s
>  85.222.152.83
> >>
> >> 30s TTLs will naturally limit the time Squid can cache these IPs for.
> >>
> >>
> >>>  From time to time DNS answers only sending SOA record (no A,AAAA
> records)
> >>
> >> Squid will fail to forward traffic if Squid does not have the
> >> destination IP address cached and its new DNS lookup returns no IPv4 or
> >> IPv6 records. Moreover, I am not 100% sure -- needs checking/testing --
> >> but Squid might cache that "negative" no-IPs result (see
> >> negative_dns_ttl that defaults to 60 seconds).
> >>
> >> Do all 500 error cases correspond to DNS answers without IPs? In other
> >> words, is there a 500 error case after a DNS answer with IPs (within 29
> >> seconds from each other)?
> >>
> >> HTH,
> >>
> >> Alex.
> >> P.S. Sorry for not answering your questions below directly. I do not
> >> have the time to document what Squid debugging logs mean, and I
> >> recommend sharing them without analysis (by non-developers).
> >>
> >>
> >>> dig:
> >>> IP address of sagittarius-oatmilk-722.scratch.my.salesforce.com is
> >>> cs128.salesforce.com.
> >>> cs128-fra.salesforce.com.
> >>> cs128-fra.fra.r.salesforce.com.
> >>> 160.8.255.83
> >>> 160.8.249.83
> >>> 85.222.154.211
> >>> Failed to resolve sagittarius-oatmilk-722.scratch.my.salesforce.com
> >>> Failed to resolve sagittarius-oatmilk-722.scratch.my.salesforce.com
> >>> Failed to resolve sagittarius-oatmilk-722.scratch.my.salesforce.com
> >>> Failed to resolve sagittarius-oatmilk-722.scratch.my.salesforce.com
> >>> IP address of sagittarius-oatmilk-722.scratch.my.salesforce.com is
> >>> cs128.salesforce.com.
> >>> cs128-fra.salesforce.com.
> >>> cs128-fra.fra.r.salesforce.com.
> >>> 85.222.154.211
> >>> 160.8.255.83
> >>> 160.8.249.83
> >>> IP address of sagittarius-oatmilk-722.scratch.my.salesforce.com is
> >>> cs128.salesforce.com.
> >>> cs128-fra.salesforce.com.
> >>> cs128-fra.fra.r.salesforce.com.
> >>> 160.8.253.83
> >>>
> >>> Squid outputs then:
> >>> 16/Feb/2023:13:45:54 +0100 1676551554.420    107 100.113.24.84
> >>> 100.113.24.84 NONE_NONE/500 0 CONNECT
> >>> canal-trailblazer-1066.scratch.my.salesforce.com:443 - HIER_NONE/- - -
> >>> - "/CN=gitlab-executor-stg.navio-services.opl-gcp.int"
> >>> 16/Feb/2023:13:51:55 +0100 1676551915.973     82 100.113.25.178
> >>> 100.113.25.178 NONE_NONE/500 0 CONNECT
> >>> pumpkinspice-pisces-6588.scratch.my.salesforce.com:443 - HIER_NONE/- -
> >>> - - "/CN=gitlab-executor-stg.navio-services.opl-gcp.int"
> >>> 16/Feb/2023:13:52:44 +0100 1676551964.285     95 100.113.24.84
> >>> 100.113.24.84 NONE_NONE/500 0 CONNECT
> >>> trailblazer-builder-1043.scratch.file.force.com:443 - HIER_NONE/- - -
> >>>
> Mozilla/5.0%20(X11;%20Linux%20x86_64)%20AppleWebKit/537.36%20(KHTML,%20like%20Gecko)%20HeadlessChrome/109.0.5414.74%20Safari/537.36
> >>> "/CN=gitlab-executor-stg.navio-services.opl-gcp.int"
> >>> 16/Feb/2023:13:56:11 +0100 1676552171.392     43 100.121.10.183
> >>> 100.121.10.183 NONE_NONE/500 0 CONNECT
> >>> pistachio-vente-806.scratch.my.salesforce.com:443 - HIER_NONE/- - - -
> >>> "/CN=gitlab-executor-stg.navio-services.opl-gcp.int"
> >>>
> >>>
> >>> Child squids get then (the same situation but different case):
> >>> 17/Feb/2023:13:18:49 +0000 1676639929.989 88 100.121.10.104
> >>> TCP_TUNNEL/500 0 CONNECT
> >>> beans-goldengate-9524.scratch.my.salesforce.com:443 -
> >>> ANY_OLD_PARENT/100.112.36.14 -
> >>>
> >>> Such a situation but not the same case from squid internals point of
> >>> view I list below:
> >>> 74,5| RequestParser.cc(377) doParse: request-line: retval 1:
> >>> line={266, data='CONNECT
> >>> baybridge-module-8155.scratch.my.salesforce.com:443 HTTP/1.1
> >>> Host: baybridge-module-8155.scratch.my.salesforce.com:443
> >>> 2023/02/15 15:44:24.223 kid1| 74,5| RequestParser.cc(379) doParse:
> >>> request-line: url: baybridge-module-8155.scratch.my.salesforce.com:443
> >>> 2023/02/15 15:44:24.223 kid1| 74,5| Parser.cc(192) grabMimeBlock: mime
> >>> header (0-196) {Host:
> >>> baybridge-module-8155.scratch.my.salesforce.com:443
> >>> CONNECT baybridge-module-8155.scratch.my.salesforce.com:443 HTTP/1.1
> >>> Host: baybridge-module-8155.scratch.my.salesforce.com:443
> >>> Host: baybridge-module-8155.scratch.my.salesforce.com:443
> >>> 2023/02/15 15:44:24.223 kid1| 23,3| Uri.cc(441) parse: Split URL
> >>> 'baybridge-module-8155.scratch.my.salesforce.com:443' into proto='',
> >>> host='baybridge-module-8155.scratch.my.salesforce.com', port='443',
> >>> path=''
> >>> 2023/02/15 15:44:24.223 kid1| 14,3| Address.cc(389) lookupHostIP:
> >>> Given Non-IP 'baybridge-module-8155.scratch.my.salesforce.com': Name
> >>> or service not known
> >>> 2023/02/15 15:44:24.223 kid1| 33,5| Http1Server.cc(193)
> >>> buildHttpRequest: normalize 1 Host header using
> >>> baybridge-module-8155.scratch.my.salesforce.com:443
> >>> 2023/02/15 15:44:24.224 kid1| 85,3| client_side_request.cc(637)
> >>> hostHeaderVerify: validate
> >>> host=baybridge-module-8155.scratch.my.salesforce.com, port=443,
> >>> portStr=443
> >>> 2023/02/15 15:44:24.224 kid1| 14,3| ipcache.cc(722)
> >>> ipcache_gethostbyname: ipcache_gethostbyname:
> >>> 'baybridge-module-8155.scratch.my.salesforce.com', flags=1
> >>> 2023/02/15 15:44:24.224 kid1| 14,3| ipcache.cc(310) ipcacheRelease:
> >>> ipcacheRelease: Releasing entry for
> >>> 'baybridge-module-8155.scratch.my.salesforce.com'
> >>> 2023/02/15 15:44:24.224 kid1| 14,3| Address.cc(389) lookupHostIP:
> >>> Given Non-IP 'baybridge-module-8155.scratch.my.salesforce.com': Name
> >>> or service not known
> >>> 2023/02/15 15:44:24.224 kid1| 14,4| ipcache.cc(600)
> >>> ipcache_nbgethostbyname:
> >>> baybridge-module-8155.scratch.my.salesforce.com
> >>> 2023/02/15 15:44:24.224 kid1| 14,3| Address.cc(389) lookupHostIP:
> >>> Given Non-IP 'baybridge-module-8155.scratch.my.salesforce.com': Name
> >>> or service not known
> >>> 2023/02/15 15:44:24.224 kid1| 14,5| ipcache.cc(660)
> >>> ipcache_nbgethostbyname_: ipcache_nbgethostbyname: MISS for
> >>> 'baybridge-module-8155.scratch.my.salesforce.com'
> >>> 2023/02/15 15:44:24.224 kid1| 78,3| dns_internal.cc(1788) idnsALookup:
> >>> idnsALookup: buf is 65 bytes for
> >>> baybridge-module-8155.scratch.my.salesforce.com, id = 0x9c4
> >>> 2023/02/15 15:44:24.224 kid1| 78,3| dns_internal.cc(1724)
> >>> idnsSendSlaveAAAAQuery: buf is 65 bytes for
> >>> baybridge-module-8155.scratch.my.salesforce.com, id = 0x5b5e
> >>> 2023/02/15 15:44:24.224 kid1| 28,3| DestinationIp.cc(78) match: can't
> >>> yet compare 'to_localhost' ACL for
> >>> baybridge-module-8155.scratch.my.salesforce.com
> >>> 2023/02/15 15:44:24.224 kid1| 14,4| ipcache.cc(600)
> >>> ipcache_nbgethostbyname:
> >>> baybridge-module-8155.scratch.my.salesforce.com
> >>> 2023/02/15 15:44:24.224 kid1| 14,3| Address.cc(389) lookupHostIP:
> >>> Given Non-IP 'baybridge-module-8155.scratch.my.salesforce.com': Name
> >>> or service not known
> >>> 2023/02/15 15:44:24.224 kid1| 14,5| ipcache.cc(660)
> >>> ipcache_nbgethostbyname_: ipcache_nbgethostbyname: MISS for
> >>> 'baybridge-module-8155.scratch.my.salesforce.com'
> >>> 2023/02/15 15:44:24.247 kid1| 14,3| ipcache.cc(456) latestError: DNS
> >>> error while resolving baybridge-module-8155.scratch.my.salesforce.com:
> >>> No DNS records
> >>> 2023/02/15 15:44:24.248 kid1| 14,3| ipcache.cc(456) latestError: DNS
> >>> error while resolving baybridge-module-8155.scratch.my.salesforce.com:
> >>> No DNS records
> >>> 2023/02/15 15:44:24.282 kid1| 14,3| ipcache.cc(477) ipcacheParse: 3
> >>> answers for baybridge-module-8155.scratch.my.salesforce.com
> >>> 2023/02/15 15:44:24.282 kid1| 14,3| ipcache.cc(576)
> >>> ipcacheHandleReply: done with
> >>> baybridge-module-8155.scratch.my.salesforce.com: [no cached IPs]
> >>> 2023/02/15 15:44:24.282 kid1| 14,3| ipcache.cc(477) ipcacheParse: 3
> >>> answers for baybridge-module-8155.scratch.my.salesforce.com
> >>> 2023/02/15 15:44:24.282 kid1| 14,3| ipcache.cc(576)
> >>> ipcacheHandleReply: done with
> >>> baybridge-module-8155.scratch.my.salesforce.com: [no cached IPs]
> >>> 2023/02/15 15:44:24.282 kid1| 14,3| ipcache.cc(310) ipcacheRelease:
> >>> ipcacheRelease: Releasing entry for
> >>> 'baybridge-module-8155.scratch.my.salesforce.com'
> >>> 2023/02/15 15:44:24.282 kid1| 14,3| ipcache.cc(722)
> >>> ipcache_gethostbyname: ipcache_gethostbyname:
> >>> 'baybridge-module-8155.scratch.my.salesforce.com', flags=1
> >>> 2023/02/15 15:44:24.282 kid1| 28,3| DomainData.cc(110) match:
> >>> aclMatchDomainList: checking
> >>> 'baybridge-module-8155.scratch.my.salesforce.com'
> >>> 2023/02/15 15:44:24.282 kid1| 28,3| DomainData.cc(115) match:
> >>> aclMatchDomainList: 'baybridge-module-8155.scratch.my.salesforce.com'
> >>> NOT found
> >>> 2023/02/15 15:44:24.283 kid1| 28,3| DomainData.cc(110) match:
> >>> aclMatchDomainList: checking
> >>> 'baybridge-module-8155.scratch.my.salesforce.com'
> >>> 2023/02/15 15:44:24.283 kid1| 28,3| DomainData.cc(115) match:
> >>> aclMatchDomainList: 'baybridge-module-8155.scratch.my.salesforce.com'
> >>> found
> >>> 2023/02/15 15:44:24.283 kid1| 85,2| client_side_request.cc(745)
> >>> clientAccessCheckDone: The request CONNECT
> >>> baybridge-module-8155.scratch.my.salesforce.com:443 is ALLOWED; last
> >>> ACL checked: gitlab-executor-stg-dst
> >>> 2023/02/15 15:44:24.284 kid1| 85,2| client_side_request.cc(745)
> >>> clientAccessCheckDone: The request CONNECT
> >>> baybridge-module-8155.scratch.my.salesforce.com:443 is ALLOWED; last
> >>> ACL checked: gitlab-executor-stg-dst
> >>> 2023/02/15 15:44:24.284 kid1| 85,4| client_side_request.cc(1514)
> >>> processRequest: CONNECT
> >>> baybridge-module-8155.scratch.my.salesforce.com:443
> >>> 2023/02/15 15:44:24.284 kid1| 26,3| tunnel.cc(1140) tunnelStart:
> >>> CONNECT baybridge-module-8155.scratch.my.salesforce.com:443 HTTP/1.1
> >>> 2023/02/15 15:44:24.284 kid1| 44,3| peer_select.cc(612) selectMore:
> >>> CONNECT baybridge-module-8155.scratch.my.salesforce.com
> >>> 2023/02/15 15:44:24.284 kid1| 44,3| peer_select.cc(1098) addSelection:
> >>> adding HIER_DIRECT#baybridge-module-8155.scratch.my.salesforce.com
> >>> 2023/02/15 15:44:24.284 kid1| 44,2| peer_select.cc(460)
> >>> resolveSelected: Find IP destination for:
> >>> baybridge-module-8155.scratch.my.salesforce.com:443' via
> >>> baybridge-module-8155.scratch.my.salesforce.com
> >>> 2023/02/15 15:44:24.284 kid1| 14,4| ipcache.cc(607) nbgethostbyname:
> >>> baybridge-module-8155.scratch.my.salesforce.com
> >>> 2023/02/15 15:44:24.284 kid1| 14,3| Address.cc(389) lookupHostIP:
> >>> Given Non-IP 'baybridge-module-8155.scratch.my.salesforce.com': Name
> >>> or service not known
> >>> 2023/02/15 15:44:24.284 kid1| 14,4| ipcache.cc(647)
> >>> ipcache_nbgethostbyname_: ipcache_nbgethostbyname: HIT for
> >>> 'baybridge-module-8155.scratch.my.salesforce.com'
> >>> 2023/02/15 15:44:24.284 kid1| 44,2| peer_select.cc(479)
> >>> resolveSelected: PeerSelector4664913 found all 0 destinations for
> >>> baybridge-module-8155.scratch.my.salesforce.com:443
> >>> 2023/02/15 15:44:24.284 kid1| 4,3| errorpage.cc(1249)
> >>> compileLegacyCode: %U -->
> >>> 'https://baybridge-module-8155.scratch.my.salesforce.com/*'
> >>> 2023/02/15 15:44:24.284 kid1| 4,3| errorpage.cc(1249)
> >>> compileLegacyCode: %U -->
> >>> 'https://baybridge-module-8155.scratch.my.salesforce.com/*'
> >>> 2023/02/15 15:44:24.284 kid1| 4,3| errorpage.cc(1249)
> >>> compileLegacyCode: %W -->
> >>>
> '?subject=CacheErrorInfo%20-%20ERR_CANNOT_FORWARD&body=CacheHost%3A%20opl-egress-proxy-vm-31vr%0D%0AErrPage%3A%20ERR_CANNOT_FORWARD%0D%0AErr%3A%20%5Bnone%5D%0D%0ATimeStamp%3A%20Wed,%2015%20Feb%202023%2014%3A44%3A24%20GMT%0D%0A%0D%0AClientIP%3A%20100.121.10.148%0D%0A%0D%0AHTTP%20Request%3A%0D%0ACONNECT%20%20HTTP%2F1.1%0AVia%3A%201.1%20gitlab-proxy-6d445dbd8d-mxtqv%20(squid%2F5.7)%0D%0AX-Forwarded-For%3A%20100.113.24.224%0D%0ACache-Control%3A%20max-age%3D259200%0D%0AConnection%3A%20close%0D%0AHost%3A%
> 20baybridge-module-8155.scratch.my.salesforce.com%3A443%0D%0A%0D%0A%0D%0A'
> >>> 2023/02/15 15:44:24.286 kid1| 33,3| client_side_request.cc(272)
> >>> ~ClientHttpRequest: httpRequestFree:
> >>> baybridge-module-8155.scratch.my.salesforce.com:443
> >>> 2023/02/15 15:44:24.286 kid1| 33,5| client_side.cc(385) logRequest:
> >>> logging half-baked transaction:
> >>> baybridge-module-8155.scratch.my.salesforce.com:443
> >>>
> >>> Our parent proxy settings for DNS:
> >>> negative_dns_ttl 3 seconds  #if we set 1s it behaves the same
> >>> dns_nameservers 8.8.8.8 1.1.1.1
> >>>
> >>> The question is:
> >>> If you carefully look at the debug log you see:
> >>> a. I(Squid) can't find IP for the name
> >>> b. I've got 3 IPs from DNS
> >>> c. OK, so I've got IP
> >>> d. ...Oh, I cannot find any IP
> >>> e. I can't find any destinations (what's that?)
> >>> f. I'm outputing an error
> >>>
> >>> So, do you think it's ok or there is a bug?
> >>>
> >>> Rgds,
> >>> Maciej Leks
> >>> _______________________________________________
> >>> squid-users mailing list
> >>> squid-users at lists.squid-cache.org
> >>> http://lists.squid-cache.org/listinfo/squid-users
> >>
> >> _______________________________________________
> >> squid-users mailing list
> >> squid-users at lists.squid-cache.org
> >> http://lists.squid-cache.org/listinfo/squid-users
> > _______________________________________________
> > squid-users mailing list
> > squid-users at lists.squid-cache.org
> > http://lists.squid-cache.org/listinfo/squid-users
>
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230222/8c7f2d8c/attachment.htm>

From luhliari at redhat.com  Thu Feb 23 01:04:03 2023
From: luhliari at redhat.com (Lubos Uhliarik)
Date: Thu, 23 Feb 2023 02:04:03 +0100
Subject: [squid-users] Is samba required for kerberos authentication
Message-ID: <CAMJdYBz3h6TYwJf4aiH03mrYy=8gYVxZcXdssgUFJeEiRiVJfw@mail.gmail.com>

Hi all,

I have a question regarding kerberos authentication[1]. Is samba service
necessary to be installed on the same machine as squid is for kerberos
authentication? Is it really a prerequisite? Isn't e.g. sssd an option?

I'm sorry, but I don't have any experience in this area.

Thanks for your help.

[1] https://wiki.squid-cache.org/ConfigExamples/Authenticate/Kerberos

Best,
Lubos Uhliarik
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230223/f926d0f2/attachment.htm>

From squid3 at treenet.co.nz  Thu Feb 23 04:30:34 2023
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Thu, 23 Feb 2023 17:30:34 +1300
Subject: [squid-users] Is samba required for kerberos authentication
In-Reply-To: <CAMJdYBz3h6TYwJf4aiH03mrYy=8gYVxZcXdssgUFJeEiRiVJfw@mail.gmail.com>
References: <CAMJdYBz3h6TYwJf4aiH03mrYy=8gYVxZcXdssgUFJeEiRiVJfw@mail.gmail.com>
Message-ID: <978c63e7-432d-1a1c-c887-bbf64428fd21@treenet.co.nz>

On 23/02/2023 2:04 pm, Lubos Uhliarik wrote:
> Hi all,
>
> I have a question regarding kerberos authentication[1]. Is samba 
> service necessary to be installed on the same machine as squid is for 
> kerberos authentication? Is it really a prerequisite? Isn't e.g. sssd 
> an option?


No. Squid and the Linux/BSD Kerberos helper just need a valid keytab.

Samba is just one of several ways to manage that keytab file.

I am not sure about "sssd", it does seem to provide the right commands 
but I'm not sure if the resulting keytab is usable by the Squid helper.

However, sssd docs show what seems to be a dependency on Samba winbind 
for the Kerberos support.
So it does not seem to meet your goal of avoiding Samba even if it could 
be used for Squid.


Cheers
Amos


From frizquierdo87 at gmail.com  Thu Feb 23 14:37:42 2023
From: frizquierdo87 at gmail.com (Francisco)
Date: Thu, 23 Feb 2023 09:37:42 -0500
Subject: [squid-users] squid log in 2 mysql tables
Message-ID: <CAJXDObY2HWLaoPDEQm77cJeJKRnUcoiKjgdR-zE7ajmVDefATA@mail.gmail.com>

Is it possible to store squid logs in 2 different tables of a MySQL
database, depending on certain acl ?
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230223/0afe46e1/attachment.htm>

From frizquierdo87 at gmail.com  Thu Feb 23 15:05:14 2023
From: frizquierdo87 at gmail.com (Francisco)
Date: Thu, 23 Feb 2023 10:05:14 -0500
Subject: [squid-users] store squid logs in 2 different mysql tables
Message-ID: <CAJXDObZexpQDTiJiQ4ZbT10pz5ngj_6tLsrB1F6L7CoPo-LEtQ@mail.gmail.com>

 Is it possible to store squid logs in 2 different tables of a MySQL
database, depending on certain acl ?
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230223/5aa21b1c/attachment.htm>

From uhlar at fantomas.sk  Thu Feb 23 15:57:35 2023
From: uhlar at fantomas.sk (Matus UHLAR - fantomas)
Date: Thu, 23 Feb 2023 16:57:35 +0100
Subject: [squid-users] store squid logs in 2 different mysql tables
In-Reply-To: <CAJXDObZexpQDTiJiQ4ZbT10pz5ngj_6tLsrB1F6L7CoPo-LEtQ@mail.gmail.com>
References: <CAJXDObZexpQDTiJiQ4ZbT10pz5ngj_6tLsrB1F6L7CoPo-LEtQ@mail.gmail.com>
Message-ID: <Y/eM7+e3Z5iUTnYJ@fantomas.sk>

On 23.02.23 10:05, Francisco wrote:
> Is it possible to store squid logs in 2 different tables of a MySQL
>database, depending on certain acl ?

you can configure multiple access_log directived for use with different 
ACLs.

you apparently want to send them to different processes logging to different 
database tables.
  
-- 
Matus UHLAR - fantomas, uhlar at fantomas.sk ; http://www.fantomas.sk/
Warning: I wish NOT to receive e-mail advertising to this address.
Varovanie: na tuto adresu chcem NEDOSTAVAT akukolvek reklamnu postu.
Quantum mechanics: The dreams stuff is made of.


From rousskov at measurement-factory.com  Fri Feb 24 22:49:51 2023
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Fri, 24 Feb 2023 17:49:51 -0500
Subject: [squid-users] Are you using ESI?
Message-ID: <281cca60-f2a7-dfcb-545d-b02bbf8c4ced@measurement-factory.com>

Hello,

     ESI support in Squid has been a significant source of problems for 
many years. One of the biggest problems is affecting a lot of code that 
has nothing to do with the ESI module! I see no signs of a significant 
ESI user base, but some users may still exist. Before proposing to 
remove ESI support from Squid, I would like to better estimate the 
negative impact of that removal on existing Squid installations.

If your Squid installation uses ESI features, please respond (in private 
if necessary). How would ESI removal affect your Squids? Would you be 
willing and able to rewrite the ESI module integration with Squid 
primary APIs (or hire a developer capable of such a serious project)?


Thank you,

Alex.


From robertc at squid-cache.org  Sat Feb 25 11:26:42 2023
From: robertc at squid-cache.org (Robert Collins)
Date: Sat, 25 Feb 2023 12:26:42 +0100
Subject: [squid-users] Are you using ESI?
In-Reply-To: <281cca60-f2a7-dfcb-545d-b02bbf8c4ced@measurement-factory.com>
References: <281cca60-f2a7-dfcb-545d-b02bbf8c4ced@measurement-factory.com>
Message-ID: <CAJ3HoZ28dAf8VOTvPKLvH+k2sSwBgbo-xQmfF16nHp9FSnKyBA@mail.gmail.com>

ESI in Squid hasn't had investment done to it for neigh on twenty years
now. Not a bad run ?. I have no idea if there are users out there...
Certainly no one has reached out to me about it for many years.

I think newer models of edge compute like WASM and ICAP are generally
better: narrower interfaces that unlock huge potential.

The implementation in Squid should be savable if folk are interested - I
don't remember it being all that bad - but I certainly don't have time to
offer to do that.

HTH,
Rob

On Fri, 24 Feb 2023 at 23:50, Alex Rousskov <
rousskov at measurement-factory.com> wrote:

> Hello,
>
>      ESI support in Squid has been a significant source of problems for
> many years. One of the biggest problems is affecting a lot of code that
> has nothing to do with the ESI module! I see no signs of a significant
> ESI user base, but some users may still exist. Before proposing to
> remove ESI support from Squid, I would like to better estimate the
> negative impact of that removal on existing Squid installations.
>
> If your Squid installation uses ESI features, please respond (in private
> if necessary). How would ESI removal affect your Squids? Would you be
> willing and able to rewrite the ESI module integration with Squid
> primary APIs (or hire a developer capable of such a serious project)?
>
>
> Thank you,
>
> Alex.
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230225/4267a6cd/attachment.htm>

From squid3 at treenet.co.nz  Mon Feb 27 01:55:35 2023
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Mon, 27 Feb 2023 14:55:35 +1300
Subject: [squid-users] Are you using ESI?
In-Reply-To: <281cca60-f2a7-dfcb-545d-b02bbf8c4ced@measurement-factory.com>
References: <281cca60-f2a7-dfcb-545d-b02bbf8c4ced@measurement-factory.com>
Message-ID: <cc188fe5-b650-5aa1-21f7-753a6631ca54@treenet.co.nz>

I guess I will be the first to put hands up.


On 25/02/2023 11:49 am, Alex Rousskov wrote:
> Hello,
>
> ??? ESI support in Squid has been a significant source of problems for 
> many years. One of the biggest problems is affecting a lot of code 
> that has nothing to do with the ESI module! I see no signs of a 
> significant ESI user base, but some users may still exist. Before 
> proposing to remove ESI support from Squid, I would like to better 
> estimate the negative impact of that removal on existing Squid 
> installations.
>
> If your Squid installation uses ESI features, please respond (in 
> private if necessary). How would ESI removal affect your Squids?

This would prohibit upgrade of Squid for a good third of my companies 
client base. Niche as that is.

> Would you be willing and able to rewrite the ESI module integration 
> with Squid primary APIs (or hire a developer capable of such a serious 
> project)?

It is on my TODO list but not urgent priority at this point.

For others;
 ?do not be fooled by the use of the word "Serious" in that description. 
Long-term ESI would probably better be presented as an eCAP library. The 
bulk of the project is learning how eCAP works (libecap suffers the "no 
documentation" problem common in Open Source code). Extracting the 
classes to have eCAP call ESI logic should be relatively easy.

HTH
Amos



From service.mv at gmail.com  Mon Feb 27 14:34:44 2023
From: service.mv at gmail.com (Service MV)
Date: Mon, 27 Feb 2023 11:34:44 -0300
Subject: [squid-users] Is samba required for kerberos authentication
In-Reply-To: <CAMJdYBz3h6TYwJf4aiH03mrYy=8gYVxZcXdssgUFJeEiRiVJfw@mail.gmail.com>
References: <CAMJdYBz3h6TYwJf4aiH03mrYy=8gYVxZcXdssgUFJeEiRiVJfw@mail.gmail.com>
Message-ID: <CA+d==oHzL5GAgnTaePc5hy+MuWNjqBNpaCwQ3RbBbbuDhJbujw@mail.gmail.com>

Hi, I think that is not necessary the service but yes the packages. In the
past I setup a squid with kerberos support very well and for compilation I
installed this packages (on debian 10.5):

binutils logrotate acl attr autoconf bison nettle-dev build-essential
libacl1-dev libaio-dev libattr1-dev libblkid-dev libbsd-dev libcap2-dev
libcppunit-dev libldap2-dev pkg-config libxml2-dev libdb-dev
libgnutls28-dev openssl devscripts fakeroot libdbi-perl libssl-dev
libcppunit-dev libecap3-dev libkrb5-dev comerr-dev
libnetfilter-conntrack-dev libpam0g-dev libsasl2-dev krb5-user msktutil
libsasl2-modules-gssapi-mit libtdb-dev debhelper dh-autoreconf cdbs
smbclient krb5-user libkrb5-dev libsasl2-modules-gssapi-mit
libsasl2-modules dnsutils libsasl2-dev
libldap2-dev libsasl2-modules-ldap ldap-utils samba build-essential
winbind samba-common-bin


HTH

Gabriel


El mi?, 22 feb. 2023 22:04, Lubos Uhliarik <luhliari at redhat.com> escribi?:

> Hi all,
>
> I have a question regarding kerberos authentication[1]. Is samba service
> necessary to be installed on the same machine as squid is for kerberos
> authentication? Is it really a prerequisite? Isn't e.g. sssd an option?
>
> I'm sorry, but I don't have any experience in this area.
>
> Thanks for your help.
>
> [1] https://wiki.squid-cache.org/ConfigExamples/Authenticate/Kerberos
>
> Best,
> Lubos Uhliarik
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230227/9cecea04/attachment.htm>

From maciej.leks at gmail.com  Tue Feb 28 07:12:53 2023
From: maciej.leks at gmail.com (Maciej Leks)
Date: Tue, 28 Feb 2023 08:12:53 +0100
Subject: [squid-users] client->Squid: TCP [RST] and [RST,ACK]
Message-ID: <CACSz3ZT-BtHDeK48j2NLm5yt8Qng4+4kVGqb-G9=ufEwATdFwQ@mail.gmail.com>

For a couple of days we've  been encountering many ECONNRESET error
messages in our nodejs client to Salesforce. Even if access.log shows
only /200 tshark shows a messy communication between client->squid
(child squid).

The architecture: nodejs client->3..* child squid->2*parent
squids->cloud Salesforce

Some examples ([RST]]: 46 1.015513576 100.121.10.169 ? 100.113.27.73
TCP 66 46098 ? 3128 [ACK] Seq=1721 Ack=140135 Win=214656 Len=0
TSval=2672547296 TSecr=1443424287

   47 1.016152326 100.113.27.73 ? 100.121.10.169 TCP 66 3128 ? 46098
[FIN, ACK] Seq=140135 Ack=1721 Win=42368 Len=0 TSval=1443424288
TSecr=2672547296
   48 1.017856001 100.121.10.169 ? 100.113.27.73 TLSv1.2 97 Encrypted Alert
   49 1.017893411 100.121.10.169 ? 100.113.27.73 TCP 66 46098 ? 3128
[FIN, ACK] Seq=1752 Ack=140136 Win=214656 Len=0 TSval=2672547298
TSecr=1443424288
   50 1.018002285 100.113.27.73 ? 100.121.10.169 TCP 54 3128 ? 46098
[RST] Seq=140136 Win=0 Len=0
   51 1.018019806 100.113.27.73 ? 100.121.10.169 TCP 54 3128 ? 46098
[RST] Seq=140136 Win=0 Len=0

[RST,ACK]:
592 67.664585034 100.121.10.169 ? 100.113.27.73 TLSv1.2 97 Encrypted Alert
  593 67.664737552 100.113.27.73 ? 100.121.10.169 TCP 66 3128 ? 52202
[ACK] Seq=7973 Ack=1129 Win=42752 Len=0 TSval=1443490937
TSecr=2672613945
  594 67.664841613 100.121.10.169 ? 100.113.27.73 TCP 66 52202 ? 3128
[FIN, ACK] Seq=1129 Ack=7973 Win=42368 Len=0 TSval=2672613945
TSecr=1443490937
  595 67.664895660 100.113.27.73 ? 100.121.10.169 TCP 66 3128 ? 52202
[RST, ACK] Seq=7973 Ack=1129 Win=42752 Len=0 TSval=1443490937
TSecr=2672613945
  596 67.664936264 100.113.27.73 ? 100.121.10.169 TCP 54 3128 ? 52202
[RST] Seq=7973 Win=0 Len=0

I'm wondering how to debug it (what exactly) and whether the reason
may be on the squid side (specific configuration?).

env: GKE/k8s
client container: alpine linux
child squid container: alpine linux
version: 5.7

Cheers,
Maciek Leks


From maciej.leks at gmail.com  Tue Feb 28 13:35:17 2023
From: maciej.leks at gmail.com (Maciej Leks)
Date: Tue, 28 Feb 2023 14:35:17 +0100
Subject: [squid-users] client->Squid: TCP [RST] and [RST,ACK]
In-Reply-To: <CACSz3ZT-BtHDeK48j2NLm5yt8Qng4+4kVGqb-G9=ufEwATdFwQ@mail.gmail.com>
References: <CACSz3ZT-BtHDeK48j2NLm5yt8Qng4+4kVGqb-G9=ufEwATdFwQ@mail.gmail.com>
Message-ID: <CACSz3ZRWZhmGEkUU-ZHF2Vc4yF7mN1OC35sqRwWKzeUHRAB3pg@mail.gmail.com>

Am I right in saying that RST it's a design intent of squid to end
connections quickly? I've started digging into the squid code and see
SO_LINGER and timeout set to 0, which means that it's done on purpose
not to hang on connections in TIME_WAIT state?

Maciek

wt., 28 lut 2023 o 08:12 Maciej Leks <maciej.leks at gmail.com> napisa?(a):
>
> For a couple of days we've  been encountering many ECONNRESET error
> messages in our nodejs client to Salesforce. Even if access.log shows
> only /200 tshark shows a messy communication between client->squid
> (child squid).
>
> The architecture: nodejs client->3..* child squid->2*parent
> squids->cloud Salesforce
>
> Some examples ([RST]]: 46 1.015513576 100.121.10.169 ? 100.113.27.73
> TCP 66 46098 ? 3128 [ACK] Seq=1721 Ack=140135 Win=214656 Len=0
> TSval=2672547296 TSecr=1443424287
>
>    47 1.016152326 100.113.27.73 ? 100.121.10.169 TCP 66 3128 ? 46098
> [FIN, ACK] Seq=140135 Ack=1721 Win=42368 Len=0 TSval=1443424288
> TSecr=2672547296
>    48 1.017856001 100.121.10.169 ? 100.113.27.73 TLSv1.2 97 Encrypted Alert
>    49 1.017893411 100.121.10.169 ? 100.113.27.73 TCP 66 46098 ? 3128
> [FIN, ACK] Seq=1752 Ack=140136 Win=214656 Len=0 TSval=2672547298
> TSecr=1443424288
>    50 1.018002285 100.113.27.73 ? 100.121.10.169 TCP 54 3128 ? 46098
> [RST] Seq=140136 Win=0 Len=0
>    51 1.018019806 100.113.27.73 ? 100.121.10.169 TCP 54 3128 ? 46098
> [RST] Seq=140136 Win=0 Len=0
>
> [RST,ACK]:
> 592 67.664585034 100.121.10.169 ? 100.113.27.73 TLSv1.2 97 Encrypted Alert
>   593 67.664737552 100.113.27.73 ? 100.121.10.169 TCP 66 3128 ? 52202
> [ACK] Seq=7973 Ack=1129 Win=42752 Len=0 TSval=1443490937
> TSecr=2672613945
>   594 67.664841613 100.121.10.169 ? 100.113.27.73 TCP 66 52202 ? 3128
> [FIN, ACK] Seq=1129 Ack=7973 Win=42368 Len=0 TSval=2672613945
> TSecr=1443490937
>   595 67.664895660 100.113.27.73 ? 100.121.10.169 TCP 66 3128 ? 52202
> [RST, ACK] Seq=7973 Ack=1129 Win=42752 Len=0 TSval=1443490937
> TSecr=2672613945
>   596 67.664936264 100.113.27.73 ? 100.121.10.169 TCP 54 3128 ? 52202
> [RST] Seq=7973 Win=0 Len=0
>
> I'm wondering how to debug it (what exactly) and whether the reason
> may be on the squid side (specific configuration?).
>
> env: GKE/k8s
> client container: alpine linux
> child squid container: alpine linux
> version: 5.7
>
> Cheers,
> Maciek Leks


From rousskov at measurement-factory.com  Tue Feb 28 14:15:47 2023
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Tue, 28 Feb 2023 09:15:47 -0500
Subject: [squid-users] client->Squid: TCP [RST] and [RST,ACK]
In-Reply-To: <CACSz3ZRWZhmGEkUU-ZHF2Vc4yF7mN1OC35sqRwWKzeUHRAB3pg@mail.gmail.com>
References: <CACSz3ZT-BtHDeK48j2NLm5yt8Qng4+4kVGqb-G9=ufEwATdFwQ@mail.gmail.com>
 <CACSz3ZRWZhmGEkUU-ZHF2Vc4yF7mN1OC35sqRwWKzeUHRAB3pg@mail.gmail.com>
Message-ID: <5d421619-b312-1f72-0de1-4f4a310d02d2@measurement-factory.com>

On 2/28/23 08:35, Maciej Leks wrote:
> Am I right in saying that RST it's a design intent of squid to end
> connections quickly? I've started digging into the squid code and see
> SO_LINGER and timeout set to 0, which means that it's done on purpose
> not to hang on connections in TIME_WAIT state?

Does child Squid bump the TLS client connection, tunnel it, or 
terminates it (i.e. the child works as a reverse proxy)?

What are those TLS alerts?

If those TLS alerts are close_notify alerts, then the RST packets you 
are seeing are probably triggered by the other side doing clean TLS 
shutdown (i.e. sending a TLS close_notify alert before closing the 
connection), either after receiving a FIN packet (unlikely with 
half_closed_clients off?) or while that FIN packet is being generated or 
is in-flight. When Such RST packets would be sent by the TCP stack 
rather than Squid code itself. They may be an indication of a benign 
race condition, a bug, or some other deficiency.

Higher-level information (who initiates closure and why) may be needed 
to figure this out. I recommend sharing a link to a compressed ALL,9 
cache.log reproducing the problem with a single transaction _combined_ 
with a matching packet trace file in libpcap format.

https://wiki.squid-cache.org/SquidFaq/BugReporting#debugging-a-single-transaction

HTH,

Alex.


> wt., 28 lut 2023 o 08:12 Maciej Leks <maciej.leks at gmail.com> napisa?(a):
>>
>> For a couple of days we've  been encountering many ECONNRESET error
>> messages in our nodejs client to Salesforce. Even if access.log shows
>> only /200 tshark shows a messy communication between client->squid
>> (child squid).
>>
>> The architecture: nodejs client->3..* child squid->2*parent
>> squids->cloud Salesforce
>>
>> Some examples ([RST]]: 46 1.015513576 100.121.10.169 ? 100.113.27.73
>> TCP 66 46098 ? 3128 [ACK] Seq=1721 Ack=140135 Win=214656 Len=0
>> TSval=2672547296 TSecr=1443424287
>>
>>     47 1.016152326 100.113.27.73 ? 100.121.10.169 TCP 66 3128 ? 46098
>> [FIN, ACK] Seq=140135 Ack=1721 Win=42368 Len=0 TSval=1443424288
>> TSecr=2672547296
>>     48 1.017856001 100.121.10.169 ? 100.113.27.73 TLSv1.2 97 Encrypted Alert
>>     49 1.017893411 100.121.10.169 ? 100.113.27.73 TCP 66 46098 ? 3128
>> [FIN, ACK] Seq=1752 Ack=140136 Win=214656 Len=0 TSval=2672547298
>> TSecr=1443424288
>>     50 1.018002285 100.113.27.73 ? 100.121.10.169 TCP 54 3128 ? 46098
>> [RST] Seq=140136 Win=0 Len=0
>>     51 1.018019806 100.113.27.73 ? 100.121.10.169 TCP 54 3128 ? 46098
>> [RST] Seq=140136 Win=0 Len=0
>>
>> [RST,ACK]:
>> 592 67.664585034 100.121.10.169 ? 100.113.27.73 TLSv1.2 97 Encrypted Alert
>>    593 67.664737552 100.113.27.73 ? 100.121.10.169 TCP 66 3128 ? 52202
>> [ACK] Seq=7973 Ack=1129 Win=42752 Len=0 TSval=1443490937
>> TSecr=2672613945
>>    594 67.664841613 100.121.10.169 ? 100.113.27.73 TCP 66 52202 ? 3128
>> [FIN, ACK] Seq=1129 Ack=7973 Win=42368 Len=0 TSval=2672613945
>> TSecr=1443490937
>>    595 67.664895660 100.113.27.73 ? 100.121.10.169 TCP 66 3128 ? 52202
>> [RST, ACK] Seq=7973 Ack=1129 Win=42752 Len=0 TSval=1443490937
>> TSecr=2672613945
>>    596 67.664936264 100.113.27.73 ? 100.121.10.169 TCP 54 3128 ? 52202
>> [RST] Seq=7973 Win=0 Len=0
>>
>> I'm wondering how to debug it (what exactly) and whether the reason
>> may be on the squid side (specific configuration?).
>>
>> env: GKE/k8s
>> client container: alpine linux
>> child squid container: alpine linux
>> version: 5.7
>>
>> Cheers,
>> Maciek Leks
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users



From luhliari at redhat.com  Tue Feb 28 15:09:45 2023
From: luhliari at redhat.com (Lubos Uhliarik)
Date: Tue, 28 Feb 2023 16:09:45 +0100
Subject: [squid-users] Is samba required for kerberos authentication
In-Reply-To: <CA+d==oHzL5GAgnTaePc5hy+MuWNjqBNpaCwQ3RbBbbuDhJbujw@mail.gmail.com>
References: <CAMJdYBz3h6TYwJf4aiH03mrYy=8gYVxZcXdssgUFJeEiRiVJfw@mail.gmail.com>
 <CA+d==oHzL5GAgnTaePc5hy+MuWNjqBNpaCwQ3RbBbbuDhJbujw@mail.gmail.com>
Message-ID: <CAMJdYBy6twz2RY1KxdaEkMPUOV6e5VhJ0koWqwUrMASXDJf9zg@mail.gmail.com>

Hi Amos and Gabriel,

Thanks for your response. It was very helpful.

Best,
Lubos

On Mon, Feb 27, 2023 at 3:35 PM Service MV <service.mv at gmail.com> wrote:

> Hi, I think that is not necessary the service but yes the packages. In the
> past I setup a squid with kerberos support very well and for compilation I
> installed this packages (on debian 10.5):
>
> binutils logrotate acl attr autoconf bison nettle-dev build-essential
> libacl1-dev libaio-dev libattr1-dev libblkid-dev libbsd-dev libcap2-dev
> libcppunit-dev libldap2-dev pkg-config libxml2-dev libdb-dev
> libgnutls28-dev openssl devscripts fakeroot libdbi-perl libssl-dev
> libcppunit-dev libecap3-dev libkrb5-dev comerr-dev
> libnetfilter-conntrack-dev libpam0g-dev libsasl2-dev krb5-user msktutil
> libsasl2-modules-gssapi-mit libtdb-dev debhelper dh-autoreconf cdbs
> smbclient krb5-user libkrb5-dev libsasl2-modules-gssapi-mit libsasl2-modules dnsutils libsasl2-dev
> libldap2-dev libsasl2-modules-ldap ldap-utils samba build-essential winbind samba-common-bin
>
>
> HTH
>
> Gabriel
>
>
> El mi?, 22 feb. 2023 22:04, Lubos Uhliarik <luhliari at redhat.com> escribi?:
>
>> Hi all,
>>
>> I have a question regarding kerberos authentication[1]. Is samba service
>> necessary to be installed on the same machine as squid is for kerberos
>> authentication? Is it really a prerequisite? Isn't e.g. sssd an option?
>>
>> I'm sorry, but I don't have any experience in this area.
>>
>> Thanks for your help.
>>
>> [1] https://wiki.squid-cache.org/ConfigExamples/Authenticate/Kerberos
>>
>> Best,
>> Lubos Uhliarik
>> _______________________________________________
>> squid-users mailing list
>> squid-users at lists.squid-cache.org
>> http://lists.squid-cache.org/listinfo/squid-users
>>
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230228/966d4e9e/attachment.htm>

From maciej.leks at gmail.com  Tue Feb 28 18:07:05 2023
From: maciej.leks at gmail.com (Maciej Leks)
Date: Tue, 28 Feb 2023 19:07:05 +0100
Subject: [squid-users] client->Squid: TCP [RST] and [RST,ACK]
In-Reply-To: <5d421619-b312-1f72-0de1-4f4a310d02d2@measurement-factory.com>
References: <CACSz3ZT-BtHDeK48j2NLm5yt8Qng4+4kVGqb-G9=ufEwATdFwQ@mail.gmail.com>
 <CACSz3ZRWZhmGEkUU-ZHF2Vc4yF7mN1OC35sqRwWKzeUHRAB3pg@mail.gmail.com>
 <5d421619-b312-1f72-0de1-4f4a310d02d2@measurement-factory.com>
Message-ID: <CACSz3ZSu1nYjbPQpsXCunNxP1RVaAjFocv8rVDc9=oVj5-QyVw@mail.gmail.com>

>Does child Squid bump the TLS client connection, tunnel it, or
>terminates it (i.e. the child works as a reverse proxy)?

* client connects to child Squid's http_port without "ssl-bump".
* client sends a plain text CONNECT request to child Squid.
* child Squid connects to parent using cache_peer with mTLS.

> What are those TLS alerts?
Code 21 - decryption_failed_RESERVED(21).


>If those TLS alerts are close_notify alerts, then the RST packets you
>are seeing are probably triggered by the other side doing clean TLS
>shutdown (i.e. sending a TLS close_notify alert before closing the
>connection), either after receiving a FIN packet (unlikely with
>half_closed_clients off?) or while that FIN packet is being generated or
>is in-flight. When Such RST packets would be sent by the TCP stack
>rather than Squid code itself. They may be an indication of a benign
>race condition, a bug, or some other deficiency.

half_closed_clients is off

>Higher-level information (who initiates closure and why) may be needed
>to figure this out. I recommend sharing a link to a compressed ALL,9
>cache.log reproducing the problem with a single transaction _combined_
>with a matching packet trace file in libpcap format.

There is no other way than turning debug on.

Maciek

wt., 28 lut 2023 o 15:15 Alex Rousskov <rousskov at measurement-factory.com>
napisa?(a):

> On 2/28/23 08:35, Maciej Leks wrote:
> > Am I right in saying that RST it's a design intent of squid to end
> > connections quickly? I've started digging into the squid code and see
> > SO_LINGER and timeout set to 0, which means that it's done on purpose
> > not to hang on connections in TIME_WAIT state?
>
> Does child Squid bump the TLS client connection, tunnel it, or
> terminates it (i.e. the child works as a reverse proxy)?
>
> What are those TLS alerts?
>
> If those TLS alerts are close_notify alerts, then the RST packets you
> are seeing are probably triggered by the other side doing clean TLS
> shutdown (i.e. sending a TLS close_notify alert before closing the
> connection), either after receiving a FIN packet (unlikely with
> half_closed_clients off?) or while that FIN packet is being generated or
> is in-flight. When Such RST packets would be sent by the TCP stack
> rather than Squid code itself. They may be an indication of a benign
> race condition, a bug, or some other deficiency.
>
> Higher-level information (who initiates closure and why) may be needed
> to figure this out. I recommend sharing a link to a compressed ALL,9
> cache.log reproducing the problem with a single transaction _combined_
> with a matching packet trace file in libpcap format.
>
>
> https://wiki.squid-cache.org/SquidFaq/BugReporting#debugging-a-single-transaction
>
> HTH,
>
> Alex.
>
>
> > wt., 28 lut 2023 o 08:12 Maciej Leks <maciej.leks at gmail.com> napisa?(a):
> >>
> >> For a couple of days we've  been encountering many ECONNRESET error
> >> messages in our nodejs client to Salesforce. Even if access.log shows
> >> only /200 tshark shows a messy communication between client->squid
> >> (child squid).
> >>
> >> The architecture: nodejs client->3..* child squid->2*parent
> >> squids->cloud Salesforce
> >>
> >> Some examples ([RST]]: 46 1.015513576 100.121.10.169 ? 100.113.27.73
> >> TCP 66 46098 ? 3128 [ACK] Seq=1721 Ack=140135 Win=214656 Len=0
> >> TSval=2672547296 TSecr=1443424287
> >>
> >>     47 1.016152326 100.113.27.73 ? 100.121.10.169 TCP 66 3128 ? 46098
> >> [FIN, ACK] Seq=140135 Ack=1721 Win=42368 Len=0 TSval=1443424288
> >> TSecr=2672547296
> >>     48 1.017856001 100.121.10.169 ? 100.113.27.73 TLSv1.2 97 Encrypted
> Alert
> >>     49 1.017893411 100.121.10.169 ? 100.113.27.73 TCP 66 46098 ? 3128
> >> [FIN, ACK] Seq=1752 Ack=140136 Win=214656 Len=0 TSval=2672547298
> >> TSecr=1443424288
> >>     50 1.018002285 100.113.27.73 ? 100.121.10.169 TCP 54 3128 ? 46098
> >> [RST] Seq=140136 Win=0 Len=0
> >>     51 1.018019806 100.113.27.73 ? 100.121.10.169 TCP 54 3128 ? 46098
> >> [RST] Seq=140136 Win=0 Len=0
> >>
> >> [RST,ACK]:
> >> 592 67.664585034 100.121.10.169 ? 100.113.27.73 TLSv1.2 97 Encrypted
> Alert
> >>    593 67.664737552 100.113.27.73 ? 100.121.10.169 TCP 66 3128 ? 52202
> >> [ACK] Seq=7973 Ack=1129 Win=42752 Len=0 TSval=1443490937
> >> TSecr=2672613945
> >>    594 67.664841613 100.121.10.169 ? 100.113.27.73 TCP 66 52202 ? 3128
> >> [FIN, ACK] Seq=1129 Ack=7973 Win=42368 Len=0 TSval=2672613945
> >> TSecr=1443490937
> >>    595 67.664895660 100.113.27.73 ? 100.121.10.169 TCP 66 3128 ? 52202
> >> [RST, ACK] Seq=7973 Ack=1129 Win=42752 Len=0 TSval=1443490937
> >> TSecr=2672613945
> >>    596 67.664936264 100.113.27.73 ? 100.121.10.169 TCP 54 3128 ? 52202
> >> [RST] Seq=7973 Win=0 Len=0
> >>
> >> I'm wondering how to debug it (what exactly) and whether the reason
> >> may be on the squid side (specific configuration?).
> >>
> >> env: GKE/k8s
> >> client container: alpine linux
> >> child squid container: alpine linux
> >> version: 5.7
> >>
> >> Cheers,
> >> Maciek Leks
> > _______________________________________________
> > squid-users mailing list
> > squid-users at lists.squid-cache.org
> > http://lists.squid-cache.org/listinfo/squid-users
>
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230228/c3179597/attachment.htm>

From rousskov at measurement-factory.com  Tue Feb 28 19:06:11 2023
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Tue, 28 Feb 2023 14:06:11 -0500
Subject: [squid-users] client->Squid: TCP [RST] and [RST,ACK]
In-Reply-To: <CACSz3ZSu1nYjbPQpsXCunNxP1RVaAjFocv8rVDc9=oVj5-QyVw@mail.gmail.com>
References: <CACSz3ZT-BtHDeK48j2NLm5yt8Qng4+4kVGqb-G9=ufEwATdFwQ@mail.gmail.com>
 <CACSz3ZRWZhmGEkUU-ZHF2Vc4yF7mN1OC35sqRwWKzeUHRAB3pg@mail.gmail.com>
 <5d421619-b312-1f72-0de1-4f4a310d02d2@measurement-factory.com>
 <CACSz3ZSu1nYjbPQpsXCunNxP1RVaAjFocv8rVDc9=oVj5-QyVw@mail.gmail.com>
Message-ID: <42f6163b-321a-5c86-a6e3-0ccc7dcea44f@measurement-factory.com>

On 2/28/23 13:07, Maciej Leks wrote:
>>Does child Squid bump the TLS client connection, tunnel it, or
>>terminates it (i.e. the child works as a reverse proxy)?

> * client connects to child Squid's http_port without "ssl-bump".
> * client sends a plain text CONNECT request to child Squid.
> * child Squid connects to parent using cache_peer with mTLS.

I assume that, by mTLS, you mean a cache_peer directive with "tls" 
option _and_ with "sslcert" (or equivalent) option to specify the TLS 
client certificate to be sent to the cache peer.

I assume that the packets you pasted earlier were between a child Squid 
and its parent.


>> What are those TLS alerts?
> Code 21 - decryption_failed_RESERVED(21).

I would focus on this error and ignore RST packets for now. Most likely, 
this error is what triggers those packets.


HTH,

Alex.



>>If those TLS alerts are close_notify alerts, then the RST packets you
>>are seeing are probably triggered by the other side doing clean TLS
>>shutdown (i.e. sending a TLS close_notify alert before closing the
>>connection), either after receiving a FIN packet (unlikely with
>>half_closed_clients off?) or while that FIN packet is being generated or
>>is in-flight. When Such RST packets would be sent by the TCP stack
>>rather than Squid code itself. They may be an indication of a benign
>>race condition, a bug, or some other deficiency.
> 
> half_closed_clients is off
> 
>>Higher-level information (who initiates closure and why) may be needed
>>to figure this out. I recommend sharing a link to a compressed ALL,9
>>cache.log reproducing the problem with a single transaction _combined_
>>with a matching packet trace file in libpcap format.
> 
> There is no other way than turning debug on.
> 
> Maciek
> 
> wt., 28 lut 2023 o 15:15?Alex Rousskov <rousskov at measurement-factory.com 
> <mailto:rousskov at measurement-factory.com>> napisa?(a):
> 
>     On 2/28/23 08:35, Maciej Leks wrote:
>      > Am I right in saying that RST it's a design intent of squid to end
>      > connections quickly? I've started digging into the squid code and see
>      > SO_LINGER and timeout set to 0, which means that it's done on purpose
>      > not to hang on connections in TIME_WAIT state?
> 
>     Does child Squid bump the TLS client connection, tunnel it, or
>     terminates it (i.e. the child works as a reverse proxy)?
> 
>     What are those TLS alerts?
> 
>     If those TLS alerts are close_notify alerts, then the RST packets you
>     are seeing are probably triggered by the other side doing clean TLS
>     shutdown (i.e. sending a TLS close_notify alert before closing the
>     connection), either after receiving a FIN packet (unlikely with
>     half_closed_clients off?) or while that FIN packet is being
>     generated or
>     is in-flight. When Such RST packets would be sent by the TCP stack
>     rather than Squid code itself. They may be an indication of a benign
>     race condition, a bug, or some other deficiency.
> 
>     Higher-level information (who initiates closure and why) may be needed
>     to figure this out. I recommend sharing a link to a compressed ALL,9
>     cache.log reproducing the problem with a single transaction _combined_
>     with a matching packet trace file in libpcap format.
> 
>     https://wiki.squid-cache.org/SquidFaq/BugReporting#debugging-a-single-transaction <https://wiki.squid-cache.org/SquidFaq/BugReporting#debugging-a-single-transaction>
> 
>     HTH,
> 
>     Alex.
> 
> 
>      > wt., 28 lut 2023 o 08:12 Maciej Leks <maciej.leks at gmail.com
>     <mailto:maciej.leks at gmail.com>> napisa?(a):
>      >>
>      >> For a couple of days we've? been encountering many ECONNRESET error
>      >> messages in our nodejs client to Salesforce. Even if access.log
>     shows
>      >> only /200 tshark shows a messy communication between client->squid
>      >> (child squid).
>      >>
>      >> The architecture: nodejs client->3..* child squid->2*parent
>      >> squids->cloud Salesforce
>      >>
>      >> Some examples ([RST]]: 46 1.015513576 100.121.10.169 ? 100.113.27.73
>      >> TCP 66 46098 ? 3128 [ACK] Seq=1721 Ack=140135 Win=214656 Len=0
>      >> TSval=2672547296 TSecr=1443424287
>      >>
>      >>? ? ?47 1.016152326 100.113.27.73 ? 100.121.10.169 TCP 66 3128 ?
>     46098
>      >> [FIN, ACK] Seq=140135 Ack=1721 Win=42368 Len=0 TSval=1443424288
>      >> TSecr=2672547296
>      >>? ? ?48 1.017856001 100.121.10.169 ? 100.113.27.73 TLSv1.2 97
>     Encrypted Alert
>      >>? ? ?49 1.017893411 100.121.10.169 ? 100.113.27.73 TCP 66 46098 ?
>     3128
>      >> [FIN, ACK] Seq=1752 Ack=140136 Win=214656 Len=0 TSval=2672547298
>      >> TSecr=1443424288
>      >>? ? ?50 1.018002285 100.113.27.73 ? 100.121.10.169 TCP 54 3128 ?
>     46098
>      >> [RST] Seq=140136 Win=0 Len=0
>      >>? ? ?51 1.018019806 100.113.27.73 ? 100.121.10.169 TCP 54 3128 ?
>     46098
>      >> [RST] Seq=140136 Win=0 Len=0
>      >>
>      >> [RST,ACK]:
>      >> 592 67.664585034 100.121.10.169 ? 100.113.27.73 TLSv1.2 97
>     Encrypted Alert
>      >>? ? 593 67.664737552 100.113.27.73 ? 100.121.10.169 TCP 66 3128 ?
>     52202
>      >> [ACK] Seq=7973 Ack=1129 Win=42752 Len=0 TSval=1443490937
>      >> TSecr=2672613945
>      >>? ? 594 67.664841613 100.121.10.169 ? 100.113.27.73 TCP 66 52202
>     ? 3128
>      >> [FIN, ACK] Seq=1129 Ack=7973 Win=42368 Len=0 TSval=2672613945
>      >> TSecr=1443490937
>      >>? ? 595 67.664895660 100.113.27.73 ? 100.121.10.169 TCP 66 3128 ?
>     52202
>      >> [RST, ACK] Seq=7973 Ack=1129 Win=42752 Len=0 TSval=1443490937
>      >> TSecr=2672613945
>      >>? ? 596 67.664936264 100.113.27.73 ? 100.121.10.169 TCP 54 3128 ?
>     52202
>      >> [RST] Seq=7973 Win=0 Len=0
>      >>
>      >> I'm wondering how to debug it (what exactly) and whether the reason
>      >> may be on the squid side (specific configuration?).
>      >>
>      >> env: GKE/k8s
>      >> client container: alpine linux
>      >> child squid container: alpine linux
>      >> version: 5.7
>      >>
>      >> Cheers,
>      >> Maciek Leks
>      > _______________________________________________
>      > squid-users mailing list
>      > squid-users at lists.squid-cache.org
>     <mailto:squid-users at lists.squid-cache.org>
>      > http://lists.squid-cache.org/listinfo/squid-users
>     <http://lists.squid-cache.org/listinfo/squid-users>
> 
>     _______________________________________________
>     squid-users mailing list
>     squid-users at lists.squid-cache.org
>     <mailto:squid-users at lists.squid-cache.org>
>     http://lists.squid-cache.org/listinfo/squid-users
>     <http://lists.squid-cache.org/listinfo/squid-users>
> 
> 
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users



From maciej.leks at gmail.com  Tue Feb 28 20:34:45 2023
From: maciej.leks at gmail.com (Maciej Leks)
Date: Tue, 28 Feb 2023 21:34:45 +0100
Subject: [squid-users] client->Squid: TCP [RST] and [RST,ACK]
In-Reply-To: <42f6163b-321a-5c86-a6e3-0ccc7dcea44f@measurement-factory.com>
References: <CACSz3ZT-BtHDeK48j2NLm5yt8Qng4+4kVGqb-G9=ufEwATdFwQ@mail.gmail.com>
 <CACSz3ZRWZhmGEkUU-ZHF2Vc4yF7mN1OC35sqRwWKzeUHRAB3pg@mail.gmail.com>
 <5d421619-b312-1f72-0de1-4f4a310d02d2@measurement-factory.com>
 <CACSz3ZSu1nYjbPQpsXCunNxP1RVaAjFocv8rVDc9=oVj5-QyVw@mail.gmail.com>
 <42f6163b-321a-5c86-a6e3-0ccc7dcea44f@measurement-factory.com>
Message-ID: <CACSz3ZSFKYNNcoLHuTmh=jC3KP1-xQpZ+KErbc0K9Gw3=1L8XQ@mail.gmail.com>

wt., 28 lut 2023 o 20:06 Alex Rousskov
<rousskov at measurement-factory.com> napisa?(a):
>
> On 2/28/23 13:07, Maciej Leks wrote:
> >>Does child Squid bump the TLS client connection, tunnel it, or
> >>terminates it (i.e. the child works as a reverse proxy)?
>
> > * client connects to child Squid's http_port without "ssl-bump".
> > * client sends a plain text CONNECT request to child Squid.
> > * child Squid connects to parent using cache_peer with mTLS.
>
> I assume that, by mTLS, you mean a cache_peer directive with "tls"
> option _and_ with "sslcert" (or equivalent) option to specify the TLS
> client certificate to be sent to the cache peer.
>
> I assume that the packets you pasted earlier were between a child Squid
> and its parent.

Exactly.

> >> What are those TLS alerts?
> > Code 21 - decryption_failed_RESERVED(21).
>
> I would focus on this error and ignore RST packets for now. Most likely,
> this error is what triggers those packets.
>
>
> HTH,
>
> Alex.

According to your experience - who sends this TLS "Encrypted Alert"
and RST - either the server (Salesforce) or parent squid?

Rgrds,
Maciek

> >>If those TLS alerts are close_notify alerts, then the RST packets you
> >>are seeing are probably triggered by the other side doing clean TLS
> >>shutdown (i.e. sending a TLS close_notify alert before closing the
> >>connection), either after receiving a FIN packet (unlikely with
> >>half_closed_clients off?) or while that FIN packet is being generated or
> >>is in-flight. When Such RST packets would be sent by the TCP stack
> >>rather than Squid code itself. They may be an indication of a benign
> >>race condition, a bug, or some other deficiency.
> >
> > half_closed_clients is off
> >
> >>Higher-level information (who initiates closure and why) may be needed
> >>to figure this out. I recommend sharing a link to a compressed ALL,9
> >>cache.log reproducing the problem with a single transaction _combined_
> >>with a matching packet trace file in libpcap format.
> >
> > There is no other way than turning debug on.
> >
> > Maciek
> >
> > wt., 28 lut 2023 o 15:15 Alex Rousskov <rousskov at measurement-factory.com
> > <mailto:rousskov at measurement-factory.com>> napisa?(a):
> >
> >     On 2/28/23 08:35, Maciej Leks wrote:
> >      > Am I right in saying that RST it's a design intent of squid to end
> >      > connections quickly? I've started digging into the squid code and see
> >      > SO_LINGER and timeout set to 0, which means that it's done on purpose
> >      > not to hang on connections in TIME_WAIT state?
> >
> >     Does child Squid bump the TLS client connection, tunnel it, or
> >     terminates it (i.e. the child works as a reverse proxy)?
> >
> >     What are those TLS alerts?
> >
> >     If those TLS alerts are close_notify alerts, then the RST packets you
> >     are seeing are probably triggered by the other side doing clean TLS
> >     shutdown (i.e. sending a TLS close_notify alert before closing the
> >     connection), either after receiving a FIN packet (unlikely with
> >     half_closed_clients off?) or while that FIN packet is being
> >     generated or
> >     is in-flight. When Such RST packets would be sent by the TCP stack
> >     rather than Squid code itself. They may be an indication of a benign
> >     race condition, a bug, or some other deficiency.
> >
> >     Higher-level information (who initiates closure and why) may be needed
> >     to figure this out. I recommend sharing a link to a compressed ALL,9
> >     cache.log reproducing the problem with a single transaction _combined_
> >     with a matching packet trace file in libpcap format.
> >
> >     https://wiki.squid-cache.org/SquidFaq/BugReporting#debugging-a-single-transaction <https://wiki.squid-cache.org/SquidFaq/BugReporting#debugging-a-single-transaction>
> >
> >     HTH,
> >
> >     Alex.
> >
> >
> >      > wt., 28 lut 2023 o 08:12 Maciej Leks <maciej.leks at gmail.com
> >     <mailto:maciej.leks at gmail.com>> napisa?(a):
> >      >>
> >      >> For a couple of days we've  been encountering many ECONNRESET error
> >      >> messages in our nodejs client to Salesforce. Even if access.log
> >     shows
> >      >> only /200 tshark shows a messy communication between client->squid
> >      >> (child squid).
> >      >>
> >      >> The architecture: nodejs client->3..* child squid->2*parent
> >      >> squids->cloud Salesforce
> >      >>
> >      >> Some examples ([RST]]: 46 1.015513576 100.121.10.169 ? 100.113.27.73
> >      >> TCP 66 46098 ? 3128 [ACK] Seq=1721 Ack=140135 Win=214656 Len=0
> >      >> TSval=2672547296 TSecr=1443424287
> >      >>
> >      >>     47 1.016152326 100.113.27.73 ? 100.121.10.169 TCP 66 3128 ?
> >     46098
> >      >> [FIN, ACK] Seq=140135 Ack=1721 Win=42368 Len=0 TSval=1443424288
> >      >> TSecr=2672547296
> >      >>     48 1.017856001 100.121.10.169 ? 100.113.27.73 TLSv1.2 97
> >     Encrypted Alert
> >      >>     49 1.017893411 100.121.10.169 ? 100.113.27.73 TCP 66 46098 ?
> >     3128
> >      >> [FIN, ACK] Seq=1752 Ack=140136 Win=214656 Len=0 TSval=2672547298
> >      >> TSecr=1443424288
> >      >>     50 1.018002285 100.113.27.73 ? 100.121.10.169 TCP 54 3128 ?
> >     46098
> >      >> [RST] Seq=140136 Win=0 Len=0
> >      >>     51 1.018019806 100.113.27.73 ? 100.121.10.169 TCP 54 3128 ?
> >     46098
> >      >> [RST] Seq=140136 Win=0 Len=0
> >      >>
> >      >> [RST,ACK]:
> >      >> 592 67.664585034 100.121.10.169 ? 100.113.27.73 TLSv1.2 97
> >     Encrypted Alert
> >      >>    593 67.664737552 100.113.27.73 ? 100.121.10.169 TCP 66 3128 ?
> >     52202
> >      >> [ACK] Seq=7973 Ack=1129 Win=42752 Len=0 TSval=1443490937
> >      >> TSecr=2672613945
> >      >>    594 67.664841613 100.121.10.169 ? 100.113.27.73 TCP 66 52202
> >     ? 3128
> >      >> [FIN, ACK] Seq=1129 Ack=7973 Win=42368 Len=0 TSval=2672613945
> >      >> TSecr=1443490937
> >      >>    595 67.664895660 100.113.27.73 ? 100.121.10.169 TCP 66 3128 ?
> >     52202
> >      >> [RST, ACK] Seq=7973 Ack=1129 Win=42752 Len=0 TSval=1443490937
> >      >> TSecr=2672613945
> >      >>    596 67.664936264 100.113.27.73 ? 100.121.10.169 TCP 54 3128 ?
> >     52202
> >      >> [RST] Seq=7973 Win=0 Len=0
> >      >>
> >      >> I'm wondering how to debug it (what exactly) and whether the reason
> >      >> may be on the squid side (specific configuration?).
> >      >>
> >      >> env: GKE/k8s
> >      >> client container: alpine linux
> >      >> child squid container: alpine linux
> >      >> version: 5.7
> >      >>
> >      >> Cheers,
> >      >> Maciek Leks
> >      > _______________________________________________
> >      > squid-users mailing list
> >      > squid-users at lists.squid-cache.org
> >     <mailto:squid-users at lists.squid-cache.org>
> >      > http://lists.squid-cache.org/listinfo/squid-users
> >     <http://lists.squid-cache.org/listinfo/squid-users>
> >
> >     _______________________________________________
> >     squid-users mailing list
> >     squid-users at lists.squid-cache.org
> >     <mailto:squid-users at lists.squid-cache.org>
> >     http://lists.squid-cache.org/listinfo/squid-users
> >     <http://lists.squid-cache.org/listinfo/squid-users>
> >
> >
> > _______________________________________________
> > squid-users mailing list
> > squid-users at lists.squid-cache.org
> > http://lists.squid-cache.org/listinfo/squid-users
>
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users


From rousskov at measurement-factory.com  Tue Feb 28 21:13:22 2023
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Tue, 28 Feb 2023 16:13:22 -0500
Subject: [squid-users] client->Squid: TCP [RST] and [RST,ACK]
In-Reply-To: <CACSz3ZSFKYNNcoLHuTmh=jC3KP1-xQpZ+KErbc0K9Gw3=1L8XQ@mail.gmail.com>
References: <CACSz3ZT-BtHDeK48j2NLm5yt8Qng4+4kVGqb-G9=ufEwATdFwQ@mail.gmail.com>
 <CACSz3ZRWZhmGEkUU-ZHF2Vc4yF7mN1OC35sqRwWKzeUHRAB3pg@mail.gmail.com>
 <5d421619-b312-1f72-0de1-4f4a310d02d2@measurement-factory.com>
 <CACSz3ZSu1nYjbPQpsXCunNxP1RVaAjFocv8rVDc9=oVj5-QyVw@mail.gmail.com>
 <42f6163b-321a-5c86-a6e3-0ccc7dcea44f@measurement-factory.com>
 <CACSz3ZSFKYNNcoLHuTmh=jC3KP1-xQpZ+KErbc0K9Gw3=1L8XQ@mail.gmail.com>
Message-ID: <75d8ab79-b68c-933a-72fb-2d99f4a369ac@measurement-factory.com>

On 2/28/23 15:34, Maciej Leks wrote:
> wt., 28 lut 2023 o 20:06 Alex Rousskov
> <rousskov at measurement-factory.com> napisa?(a):
>>
>> On 2/28/23 13:07, Maciej Leks wrote:
>>>> Does child Squid bump the TLS client connection, tunnel it, or
>>>> terminates it (i.e. the child works as a reverse proxy)?
>>
>>> * client connects to child Squid's http_port without "ssl-bump".
>>> * client sends a plain text CONNECT request to child Squid.
>>> * child Squid connects to parent using cache_peer with mTLS.
>>
>> I assume that, by mTLS, you mean a cache_peer directive with "tls"
>> option _and_ with "sslcert" (or equivalent) option to specify the TLS
>> client certificate to be sent to the cache peer.
>>
>> I assume that the packets you pasted earlier were between a child Squid
>> and its parent.

> Exactly.

>>>> What are those TLS alerts?
>>> Code 21 - decryption_failed_RESERVED(21).

Are you sure that 21 is actually the alert description ID and _not_ the 
TLS message content type (all alert messages have TLS content type 21)? 
See "ContentType" and "AlertDescription" definitions in RFC 8446. Below, 
I will assume that it is the former because you said 
"decryption_failed_RESERVED" above, but this looks very suspicious! 
Where did you get that "21" from? Perhaps you can show Wireshark 
dissection of the corresponding alert message?


According to obsoleted RFC 5246 (TLS v1.2):

>    decryption_failed_RESERVED
>       This alert was used in some earlier versions of TLS, and may have
>       permitted certain attacks against the CBC mode [CBCATT].  It MUST
>       NOT be sent by compliant implementations.



>> I would focus on this error and ignore RST packets for now. Most likely,
>> this error is what triggers those packets.

> According to your experience - who sends this TLS "Encrypted Alert"
> and RST - either the server (Salesforce) or parent squid?

FWIW, I do not recall seeing these specific alerts. It might be 
Salesforce greasing TLS messages, I guess, but I cannot quickly find 
evidence of alerts being used for that purpose (RFC 8701 does not 
mention this greasing vector AFAICT). Typical greased values do not 
violate MUSTs, but perhaps they can violate MUSTs from obsoleted RFCs? 
Or this is not a decryption_failed_RESERVED alert ;-).

However, I am surprised you are asking the list this question. Don't you 
know (e.g., from packet captures) who is sending the alert in question?!


Cheers,

Alex.

>>>> If those TLS alerts are close_notify alerts, then the RST packets you
>>>> are seeing are probably triggered by the other side doing clean TLS
>>>> shutdown (i.e. sending a TLS close_notify alert before closing the
>>>> connection), either after receiving a FIN packet (unlikely with
>>>> half_closed_clients off?) or while that FIN packet is being generated or
>>>> is in-flight. When Such RST packets would be sent by the TCP stack
>>>> rather than Squid code itself. They may be an indication of a benign
>>>> race condition, a bug, or some other deficiency.
>>>
>>> half_closed_clients is off
>>>
>>>> Higher-level information (who initiates closure and why) may be needed
>>>> to figure this out. I recommend sharing a link to a compressed ALL,9
>>>> cache.log reproducing the problem with a single transaction _combined_
>>>> with a matching packet trace file in libpcap format.
>>>
>>> There is no other way than turning debug on.
>>>
>>> Maciek
>>>
>>> wt., 28 lut 2023 o 15:15 Alex Rousskov <rousskov at measurement-factory.com
>>> <mailto:rousskov at measurement-factory.com>> napisa?(a):
>>>
>>>      On 2/28/23 08:35, Maciej Leks wrote:
>>>       > Am I right in saying that RST it's a design intent of squid to end
>>>       > connections quickly? I've started digging into the squid code and see
>>>       > SO_LINGER and timeout set to 0, which means that it's done on purpose
>>>       > not to hang on connections in TIME_WAIT state?
>>>
>>>      Does child Squid bump the TLS client connection, tunnel it, or
>>>      terminates it (i.e. the child works as a reverse proxy)?
>>>
>>>      What are those TLS alerts?
>>>
>>>      If those TLS alerts are close_notify alerts, then the RST packets you
>>>      are seeing are probably triggered by the other side doing clean TLS
>>>      shutdown (i.e. sending a TLS close_notify alert before closing the
>>>      connection), either after receiving a FIN packet (unlikely with
>>>      half_closed_clients off?) or while that FIN packet is being
>>>      generated or
>>>      is in-flight. When Such RST packets would be sent by the TCP stack
>>>      rather than Squid code itself. They may be an indication of a benign
>>>      race condition, a bug, or some other deficiency.
>>>
>>>      Higher-level information (who initiates closure and why) may be needed
>>>      to figure this out. I recommend sharing a link to a compressed ALL,9
>>>      cache.log reproducing the problem with a single transaction _combined_
>>>      with a matching packet trace file in libpcap format.
>>>
>>>      https://wiki.squid-cache.org/SquidFaq/BugReporting#debugging-a-single-transaction <https://wiki.squid-cache.org/SquidFaq/BugReporting#debugging-a-single-transaction>
>>>
>>>      HTH,
>>>
>>>      Alex.
>>>
>>>
>>>       > wt., 28 lut 2023 o 08:12 Maciej Leks <maciej.leks at gmail.com
>>>      <mailto:maciej.leks at gmail.com>> napisa?(a):
>>>       >>
>>>       >> For a couple of days we've  been encountering many ECONNRESET error
>>>       >> messages in our nodejs client to Salesforce. Even if access.log
>>>      shows
>>>       >> only /200 tshark shows a messy communication between client->squid
>>>       >> (child squid).
>>>       >>
>>>       >> The architecture: nodejs client->3..* child squid->2*parent
>>>       >> squids->cloud Salesforce
>>>       >>
>>>       >> Some examples ([RST]]: 46 1.015513576 100.121.10.169 ? 100.113.27.73
>>>       >> TCP 66 46098 ? 3128 [ACK] Seq=1721 Ack=140135 Win=214656 Len=0
>>>       >> TSval=2672547296 TSecr=1443424287
>>>       >>
>>>       >>     47 1.016152326 100.113.27.73 ? 100.121.10.169 TCP 66 3128 ?
>>>      46098
>>>       >> [FIN, ACK] Seq=140135 Ack=1721 Win=42368 Len=0 TSval=1443424288
>>>       >> TSecr=2672547296
>>>       >>     48 1.017856001 100.121.10.169 ? 100.113.27.73 TLSv1.2 97
>>>      Encrypted Alert
>>>       >>     49 1.017893411 100.121.10.169 ? 100.113.27.73 TCP 66 46098 ?
>>>      3128
>>>       >> [FIN, ACK] Seq=1752 Ack=140136 Win=214656 Len=0 TSval=2672547298
>>>       >> TSecr=1443424288
>>>       >>     50 1.018002285 100.113.27.73 ? 100.121.10.169 TCP 54 3128 ?
>>>      46098
>>>       >> [RST] Seq=140136 Win=0 Len=0
>>>       >>     51 1.018019806 100.113.27.73 ? 100.121.10.169 TCP 54 3128 ?
>>>      46098
>>>       >> [RST] Seq=140136 Win=0 Len=0
>>>       >>
>>>       >> [RST,ACK]:
>>>       >> 592 67.664585034 100.121.10.169 ? 100.113.27.73 TLSv1.2 97
>>>      Encrypted Alert
>>>       >>    593 67.664737552 100.113.27.73 ? 100.121.10.169 TCP 66 3128 ?
>>>      52202
>>>       >> [ACK] Seq=7973 Ack=1129 Win=42752 Len=0 TSval=1443490937
>>>       >> TSecr=2672613945
>>>       >>    594 67.664841613 100.121.10.169 ? 100.113.27.73 TCP 66 52202
>>>      ? 3128
>>>       >> [FIN, ACK] Seq=1129 Ack=7973 Win=42368 Len=0 TSval=2672613945
>>>       >> TSecr=1443490937
>>>       >>    595 67.664895660 100.113.27.73 ? 100.121.10.169 TCP 66 3128 ?
>>>      52202
>>>       >> [RST, ACK] Seq=7973 Ack=1129 Win=42752 Len=0 TSval=1443490937
>>>       >> TSecr=2672613945
>>>       >>    596 67.664936264 100.113.27.73 ? 100.121.10.169 TCP 54 3128 ?
>>>      52202
>>>       >> [RST] Seq=7973 Win=0 Len=0
>>>       >>
>>>       >> I'm wondering how to debug it (what exactly) and whether the reason
>>>       >> may be on the squid side (specific configuration?).
>>>       >>
>>>       >> env: GKE/k8s
>>>       >> client container: alpine linux
>>>       >> child squid container: alpine linux
>>>       >> version: 5.7
>>>       >>
>>>       >> Cheers,
>>>       >> Maciek Leks
>>>       > _______________________________________________
>>>       > squid-users mailing list
>>>       > squid-users at lists.squid-cache.org
>>>      <mailto:squid-users at lists.squid-cache.org>
>>>       > http://lists.squid-cache.org/listinfo/squid-users
>>>      <http://lists.squid-cache.org/listinfo/squid-users>
>>>
>>>      _______________________________________________
>>>      squid-users mailing list
>>>      squid-users at lists.squid-cache.org
>>>      <mailto:squid-users at lists.squid-cache.org>
>>>      http://lists.squid-cache.org/listinfo/squid-users
>>>      <http://lists.squid-cache.org/listinfo/squid-users>
>>>
>>>
>>> _______________________________________________
>>> squid-users mailing list
>>> squid-users at lists.squid-cache.org
>>> http://lists.squid-cache.org/listinfo/squid-users
>>
>> _______________________________________________
>> squid-users mailing list
>> squid-users at lists.squid-cache.org
>> http://lists.squid-cache.org/listinfo/squid-users
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users



From maciej.leks at gmail.com  Tue Feb 28 22:15:24 2023
From: maciej.leks at gmail.com (Maciej Leks)
Date: Tue, 28 Feb 2023 23:15:24 +0100
Subject: [squid-users] client->Squid: TCP [RST] and [RST,ACK]
In-Reply-To: <75d8ab79-b68c-933a-72fb-2d99f4a369ac@measurement-factory.com>
References: <CACSz3ZT-BtHDeK48j2NLm5yt8Qng4+4kVGqb-G9=ufEwATdFwQ@mail.gmail.com>
 <CACSz3ZRWZhmGEkUU-ZHF2Vc4yF7mN1OC35sqRwWKzeUHRAB3pg@mail.gmail.com>
 <5d421619-b312-1f72-0de1-4f4a310d02d2@measurement-factory.com>
 <CACSz3ZSu1nYjbPQpsXCunNxP1RVaAjFocv8rVDc9=oVj5-QyVw@mail.gmail.com>
 <42f6163b-321a-5c86-a6e3-0ccc7dcea44f@measurement-factory.com>
 <CACSz3ZSFKYNNcoLHuTmh=jC3KP1-xQpZ+KErbc0K9Gw3=1L8XQ@mail.gmail.com>
 <75d8ab79-b68c-933a-72fb-2d99f4a369ac@measurement-factory.com>
Message-ID: <CACSz3ZRC+vyuhrQkz0CDM28cjtvEz47KnPMegpeRP7bNyD+juQ@mail.gmail.com>

wt., 28 lut 2023 o 22:13 Alex Rousskov
<rousskov at measurement-factory.com> napisa?(a):
>
> On 2/28/23 15:34, Maciej Leks wrote:
> > wt., 28 lut 2023 o 20:06 Alex Rousskov
> > <rousskov at measurement-factory.com> napisa?(a):
> >>
> >> On 2/28/23 13:07, Maciej Leks wrote:
> >>>> Does child Squid bump the TLS client connection, tunnel it, or
> >>>> terminates it (i.e. the child works as a reverse proxy)?
> >>
> >>> * client connects to child Squid's http_port without "ssl-bump".
> >>> * client sends a plain text CONNECT request to child Squid.
> >>> * child Squid connects to parent using cache_peer with mTLS.
> >>
> >> I assume that, by mTLS, you mean a cache_peer directive with "tls"
> >> option _and_ with "sslcert" (or equivalent) option to specify the TLS
> >> client certificate to be sent to the cache peer.
> >>
> >> I assume that the packets you pasted earlier were between a child Squid
> >> and its parent.
>
> > Exactly.
>
> >>>> What are those TLS alerts?
> >>> Code 21 - decryption_failed_RESERVED(21).
>
> Are you sure that 21 is actually the alert description ID and _not_ the
> TLS message content type (all alert messages have TLS content type 21)?
> See "ContentType" and "AlertDescription" definitions in RFC 8446. Below,
> I will assume that it is the former because you said
> "decryption_failed_RESERVED" above, but this looks very suspicious!
> Where did you get that "21" from? Perhaps you can show Wireshark
> dissection of the corresponding alert message?
>
>
> According to obsoleted RFC 5246 (TLS v1.2):
>
> >    decryption_failed_RESERVED
> >       This alert was used in some earlier versions of TLS, and may have
> >       permitted certain attacks against the CBC mode [CBCATT].  It MUST
> >       NOT be sent by compliant implementations.

TLSv1.2 Record Layer: Encrypted Alert
    Content Type: Alert (21)
    Version: TLS 1.2 (0x0303)
    Length: 26
    Alert Message: Encrypted Alert


> >> I would focus on this error and ignore RST packets for now. Most likely,
> >> this error is what triggers those packets.
>
> > According to your experience - who sends this TLS "Encrypted Alert"
> > and RST - either the server (Salesforce) or parent squid?
>
> FWIW, I do not recall seeing these specific alerts. It might be
> Salesforce greasing TLS messages, I guess, but I cannot quickly find
> evidence of alerts being used for that purpose (RFC 8701 does not
> mention this greasing vector AFAICT). Typical greased values do not
> violate MUSTs, but perhaps they can violate MUSTs from obsoleted RFCs?
> Or this is not a decryption_failed_RESERVED alert ;-).
>
> However, I am surprised you are asking the list this question. Don't you
> know (e.g., from packet captures) who is sending the alert in question?!

:) I'm sniffing hierarchy of proxies for the very first time. I've
created the lab yesterday:
nodejs client->squid->server (the server's only role is to accept a
connection and then send RST flag back).
And you now what I got on client side? 502 from the squid.
So, I'm asking just because it looks like Salesforce alert and RST but
at the same time it's not fit my observations from the lab.
When I was watching some pcacps from the parent squid side I've seen
not many RST from SF's, a few from parent squid side but I've got a
lot of them on my child squid side.
You ask me a very good question. The more I look the less I understand :)

Tomorrow morning I'll turn on debugging.

Maciek

> >>>> If those TLS alerts are close_notify alerts, then the RST packets you
> >>>> are seeing are probably triggered by the other side doing clean TLS
> >>>> shutdown (i.e. sending a TLS close_notify alert before closing the
> >>>> connection), either after receiving a FIN packet (unlikely with
> >>>> half_closed_clients off?) or while that FIN packet is being generated or
> >>>> is in-flight. When Such RST packets would be sent by the TCP stack
> >>>> rather than Squid code itself. They may be an indication of a benign
> >>>> race condition, a bug, or some other deficiency.
> >>>
> >>> half_closed_clients is off
> >>>
> >>>> Higher-level information (who initiates closure and why) may be needed
> >>>> to figure this out. I recommend sharing a link to a compressed ALL,9
> >>>> cache.log reproducing the problem with a single transaction _combined_
> >>>> with a matching packet trace file in libpcap format.
> >>>
> >>> There is no other way than turning debug on.
> >>>
> >>> Maciek
> >>>
> >>> wt., 28 lut 2023 o 15:15 Alex Rousskov <rousskov at measurement-factory.com
> >>> <mailto:rousskov at measurement-factory.com>> napisa?(a):
> >>>
> >>>      On 2/28/23 08:35, Maciej Leks wrote:
> >>>       > Am I right in saying that RST it's a design intent of squid to end
> >>>       > connections quickly? I've started digging into the squid code and see
> >>>       > SO_LINGER and timeout set to 0, which means that it's done on purpose
> >>>       > not to hang on connections in TIME_WAIT state?
> >>>
> >>>      Does child Squid bump the TLS client connection, tunnel it, or
> >>>      terminates it (i.e. the child works as a reverse proxy)?
> >>>
> >>>      What are those TLS alerts?
> >>>
> >>>      If those TLS alerts are close_notify alerts, then the RST packets you
> >>>      are seeing are probably triggered by the other side doing clean TLS
> >>>      shutdown (i.e. sending a TLS close_notify alert before closing the
> >>>      connection), either after receiving a FIN packet (unlikely with
> >>>      half_closed_clients off?) or while that FIN packet is being
> >>>      generated or
> >>>      is in-flight. When Such RST packets would be sent by the TCP stack
> >>>      rather than Squid code itself. They may be an indication of a benign
> >>>      race condition, a bug, or some other deficiency.
> >>>
> >>>      Higher-level information (who initiates closure and why) may be needed
> >>>      to figure this out. I recommend sharing a link to a compressed ALL,9
> >>>      cache.log reproducing the problem with a single transaction _combined_
> >>>      with a matching packet trace file in libpcap format.
> >>>
> >>>      https://wiki.squid-cache.org/SquidFaq/BugReporting#debugging-a-single-transaction <https://wiki.squid-cache.org/SquidFaq/BugReporting#debugging-a-single-transaction>
> >>>
> >>>      HTH,
> >>>
> >>>      Alex.
> >>>
> >>>
> >>>       > wt., 28 lut 2023 o 08:12 Maciej Leks <maciej.leks at gmail.com
> >>>      <mailto:maciej.leks at gmail.com>> napisa?(a):
> >>>       >>
> >>>       >> For a couple of days we've  been encountering many ECONNRESET error
> >>>       >> messages in our nodejs client to Salesforce. Even if access.log
> >>>      shows
> >>>       >> only /200 tshark shows a messy communication between client->squid
> >>>       >> (child squid).
> >>>       >>
> >>>       >> The architecture: nodejs client->3..* child squid->2*parent
> >>>       >> squids->cloud Salesforce
> >>>       >>
> >>>       >> Some examples ([RST]]: 46 1.015513576 100.121.10.169 ? 100.113.27.73
> >>>       >> TCP 66 46098 ? 3128 [ACK] Seq=1721 Ack=140135 Win=214656 Len=0
> >>>       >> TSval=2672547296 TSecr=1443424287
> >>>       >>
> >>>       >>     47 1.016152326 100.113.27.73 ? 100.121.10.169 TCP 66 3128 ?
> >>>      46098
> >>>       >> [FIN, ACK] Seq=140135 Ack=1721 Win=42368 Len=0 TSval=1443424288
> >>>       >> TSecr=2672547296
> >>>       >>     48 1.017856001 100.121.10.169 ? 100.113.27.73 TLSv1.2 97
> >>>      Encrypted Alert
> >>>       >>     49 1.017893411 100.121.10.169 ? 100.113.27.73 TCP 66 46098 ?
> >>>      3128
> >>>       >> [FIN, ACK] Seq=1752 Ack=140136 Win=214656 Len=0 TSval=2672547298
> >>>       >> TSecr=1443424288
> >>>       >>     50 1.018002285 100.113.27.73 ? 100.121.10.169 TCP 54 3128 ?
> >>>      46098
> >>>       >> [RST] Seq=140136 Win=0 Len=0
> >>>       >>     51 1.018019806 100.113.27.73 ? 100.121.10.169 TCP 54 3128 ?
> >>>      46098
> >>>       >> [RST] Seq=140136 Win=0 Len=0
> >>>       >>
> >>>       >> [RST,ACK]:
> >>>       >> 592 67.664585034 100.121.10.169 ? 100.113.27.73 TLSv1.2 97
> >>>      Encrypted Alert
> >>>       >>    593 67.664737552 100.113.27.73 ? 100.121.10.169 TCP 66 3128 ?
> >>>      52202
> >>>       >> [ACK] Seq=7973 Ack=1129 Win=42752 Len=0 TSval=1443490937
> >>>       >> TSecr=2672613945
> >>>       >>    594 67.664841613 100.121.10.169 ? 100.113.27.73 TCP 66 52202
> >>>      ? 3128
> >>>       >> [FIN, ACK] Seq=1129 Ack=7973 Win=42368 Len=0 TSval=2672613945
> >>>       >> TSecr=1443490937
> >>>       >>    595 67.664895660 100.113.27.73 ? 100.121.10.169 TCP 66 3128 ?
> >>>      52202
> >>>       >> [RST, ACK] Seq=7973 Ack=1129 Win=42752 Len=0 TSval=1443490937
> >>>       >> TSecr=2672613945
> >>>       >>    596 67.664936264 100.113.27.73 ? 100.121.10.169 TCP 54 3128 ?
> >>>      52202
> >>>       >> [RST] Seq=7973 Win=0 Len=0
> >>>       >>
> >>>       >> I'm wondering how to debug it (what exactly) and whether the reason
> >>>       >> may be on the squid side (specific configuration?).
> >>>       >>
> >>>       >> env: GKE/k8s
> >>>       >> client container: alpine linux
> >>>       >> child squid container: alpine linux
> >>>       >> version: 5.7
> >>>       >>
> >>>       >> Cheers,
> >>>       >> Maciek Leks
> >>>       > _______________________________________________
> >>>       > squid-users mailing list
> >>>       > squid-users at lists.squid-cache.org
> >>>      <mailto:squid-users at lists.squid-cache.org>
> >>>       > http://lists.squid-cache.org/listinfo/squid-users
> >>>      <http://lists.squid-cache.org/listinfo/squid-users>
> >>>
> >>>      _______________________________________________
> >>>      squid-users mailing list
> >>>      squid-users at lists.squid-cache.org
> >>>      <mailto:squid-users at lists.squid-cache.org>
> >>>      http://lists.squid-cache.org/listinfo/squid-users
> >>>      <http://lists.squid-cache.org/listinfo/squid-users>
> >>>
> >>>
> >>> _______________________________________________
> >>> squid-users mailing list
> >>> squid-users at lists.squid-cache.org
> >>> http://lists.squid-cache.org/listinfo/squid-users
> >>
> >> _______________________________________________
> >> squid-users mailing list
> >> squid-users at lists.squid-cache.org
> >> http://lists.squid-cache.org/listinfo/squid-users
> > _______________________________________________
> > squid-users mailing list
> > squid-users at lists.squid-cache.org
> > http://lists.squid-cache.org/listinfo/squid-users
>
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users


From rousskov at measurement-factory.com  Tue Feb 28 22:26:53 2023
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Tue, 28 Feb 2023 17:26:53 -0500
Subject: [squid-users] client->Squid: TCP [RST] and [RST,ACK]
In-Reply-To: <CACSz3ZRC+vyuhrQkz0CDM28cjtvEz47KnPMegpeRP7bNyD+juQ@mail.gmail.com>
References: <CACSz3ZT-BtHDeK48j2NLm5yt8Qng4+4kVGqb-G9=ufEwATdFwQ@mail.gmail.com>
 <CACSz3ZRWZhmGEkUU-ZHF2Vc4yF7mN1OC35sqRwWKzeUHRAB3pg@mail.gmail.com>
 <5d421619-b312-1f72-0de1-4f4a310d02d2@measurement-factory.com>
 <CACSz3ZSu1nYjbPQpsXCunNxP1RVaAjFocv8rVDc9=oVj5-QyVw@mail.gmail.com>
 <42f6163b-321a-5c86-a6e3-0ccc7dcea44f@measurement-factory.com>
 <CACSz3ZSFKYNNcoLHuTmh=jC3KP1-xQpZ+KErbc0K9Gw3=1L8XQ@mail.gmail.com>
 <75d8ab79-b68c-933a-72fb-2d99f4a369ac@measurement-factory.com>
 <CACSz3ZRC+vyuhrQkz0CDM28cjtvEz47KnPMegpeRP7bNyD+juQ@mail.gmail.com>
Message-ID: <e7ce4a79-9316-7399-b2e0-0efa8898e8a9@measurement-factory.com>

On 2/28/23 17:15, Maciej Leks wrote:
>>>>>> What are those TLS alerts?
>>>>> Code 21 - decryption_failed_RESERVED(21).

>> Are you sure that 21 is actually the alert description ID and _not_ the
>> TLS message content type (all alert messages have TLS content type 21)?

> TLSv1.2 Record Layer: Encrypted Alert
>      Content Type: Alert (21)
>      Version: TLS 1.2 (0x0303)
>      Length: 26
>      Alert Message: Encrypted Alert

This is _not_ a decryption_failed_RESERVED alert (ContentType=21 
AlertDescription=21)!

This is an alert (ContentType=21) with a AlertDescription ID unknown to 
us. Wireshark cannot report that AlertDescription ID to us because you 
did not configure Wireshark to decrypt captured TLS traffic. For 
example, it could be a benign close_notify alert (ContentType=21 
AlertDescription=0).

Hopefully, there will be fewer unknowns after you share debugging logs 
from lab tests.


HTH,

Alex.



> nodejs client->squid->server (the server's only role is to accept a
> connection and then send RST flag back).
> And you now what I got on client side? 502 from the squid.
> So, I'm asking just because it looks like Salesforce alert and RST but
> at the same time it's not fit my observations from the lab.
> When I was watching some pcacps from the parent squid side I've seen
> not many RST from SF's, a few from parent squid side but I've got a
> lot of them on my child squid side.
> You ask me a very good question. The more I look the less I understand :)
> 
> Tomorrow morning I'll turn on debugging.

>>>>>> If those TLS alerts are close_notify alerts, then the RST packets you
>>>>>> are seeing are probably triggered by the other side doing clean TLS
>>>>>> shutdown (i.e. sending a TLS close_notify alert before closing the
>>>>>> connection), either after receiving a FIN packet (unlikely with
>>>>>> half_closed_clients off?) or while that FIN packet is being generated or
>>>>>> is in-flight. When Such RST packets would be sent by the TCP stack
>>>>>> rather than Squid code itself. They may be an indication of a benign
>>>>>> race condition, a bug, or some other deficiency.
>>>>>
>>>>> half_closed_clients is off
>>>>>
>>>>>> Higher-level information (who initiates closure and why) may be needed
>>>>>> to figure this out. I recommend sharing a link to a compressed ALL,9
>>>>>> cache.log reproducing the problem with a single transaction _combined_
>>>>>> with a matching packet trace file in libpcap format.
>>>>>
>>>>> There is no other way than turning debug on.
>>>>>
>>>>> Maciek
>>>>>
>>>>> wt., 28 lut 2023 o 15:15 Alex Rousskov <rousskov at measurement-factory.com
>>>>> <mailto:rousskov at measurement-factory.com>> napisa?(a):
>>>>>
>>>>>       On 2/28/23 08:35, Maciej Leks wrote:
>>>>>        > Am I right in saying that RST it's a design intent of squid to end
>>>>>        > connections quickly? I've started digging into the squid code and see
>>>>>        > SO_LINGER and timeout set to 0, which means that it's done on purpose
>>>>>        > not to hang on connections in TIME_WAIT state?
>>>>>
>>>>>       Does child Squid bump the TLS client connection, tunnel it, or
>>>>>       terminates it (i.e. the child works as a reverse proxy)?
>>>>>
>>>>>       What are those TLS alerts?
>>>>>
>>>>>       If those TLS alerts are close_notify alerts, then the RST packets you
>>>>>       are seeing are probably triggered by the other side doing clean TLS
>>>>>       shutdown (i.e. sending a TLS close_notify alert before closing the
>>>>>       connection), either after receiving a FIN packet (unlikely with
>>>>>       half_closed_clients off?) or while that FIN packet is being
>>>>>       generated or
>>>>>       is in-flight. When Such RST packets would be sent by the TCP stack
>>>>>       rather than Squid code itself. They may be an indication of a benign
>>>>>       race condition, a bug, or some other deficiency.
>>>>>
>>>>>       Higher-level information (who initiates closure and why) may be needed
>>>>>       to figure this out. I recommend sharing a link to a compressed ALL,9
>>>>>       cache.log reproducing the problem with a single transaction _combined_
>>>>>       with a matching packet trace file in libpcap format.
>>>>>
>>>>>       https://wiki.squid-cache.org/SquidFaq/BugReporting#debugging-a-single-transaction <https://wiki.squid-cache.org/SquidFaq/BugReporting#debugging-a-single-transaction>
>>>>>
>>>>>       HTH,
>>>>>
>>>>>       Alex.
>>>>>
>>>>>
>>>>>        > wt., 28 lut 2023 o 08:12 Maciej Leks <maciej.leks at gmail.com
>>>>>       <mailto:maciej.leks at gmail.com>> napisa?(a):
>>>>>        >>
>>>>>        >> For a couple of days we've  been encountering many ECONNRESET error
>>>>>        >> messages in our nodejs client to Salesforce. Even if access.log
>>>>>       shows
>>>>>        >> only /200 tshark shows a messy communication between client->squid
>>>>>        >> (child squid).
>>>>>        >>
>>>>>        >> The architecture: nodejs client->3..* child squid->2*parent
>>>>>        >> squids->cloud Salesforce
>>>>>        >>
>>>>>        >> Some examples ([RST]]: 46 1.015513576 100.121.10.169 ? 100.113.27.73
>>>>>        >> TCP 66 46098 ? 3128 [ACK] Seq=1721 Ack=140135 Win=214656 Len=0
>>>>>        >> TSval=2672547296 TSecr=1443424287
>>>>>        >>
>>>>>        >>     47 1.016152326 100.113.27.73 ? 100.121.10.169 TCP 66 3128 ?
>>>>>       46098
>>>>>        >> [FIN, ACK] Seq=140135 Ack=1721 Win=42368 Len=0 TSval=1443424288
>>>>>        >> TSecr=2672547296
>>>>>        >>     48 1.017856001 100.121.10.169 ? 100.113.27.73 TLSv1.2 97
>>>>>       Encrypted Alert
>>>>>        >>     49 1.017893411 100.121.10.169 ? 100.113.27.73 TCP 66 46098 ?
>>>>>       3128
>>>>>        >> [FIN, ACK] Seq=1752 Ack=140136 Win=214656 Len=0 TSval=2672547298
>>>>>        >> TSecr=1443424288
>>>>>        >>     50 1.018002285 100.113.27.73 ? 100.121.10.169 TCP 54 3128 ?
>>>>>       46098
>>>>>        >> [RST] Seq=140136 Win=0 Len=0
>>>>>        >>     51 1.018019806 100.113.27.73 ? 100.121.10.169 TCP 54 3128 ?
>>>>>       46098
>>>>>        >> [RST] Seq=140136 Win=0 Len=0
>>>>>        >>
>>>>>        >> [RST,ACK]:
>>>>>        >> 592 67.664585034 100.121.10.169 ? 100.113.27.73 TLSv1.2 97
>>>>>       Encrypted Alert
>>>>>        >>    593 67.664737552 100.113.27.73 ? 100.121.10.169 TCP 66 3128 ?
>>>>>       52202
>>>>>        >> [ACK] Seq=7973 Ack=1129 Win=42752 Len=0 TSval=1443490937
>>>>>        >> TSecr=2672613945
>>>>>        >>    594 67.664841613 100.121.10.169 ? 100.113.27.73 TCP 66 52202
>>>>>       ? 3128
>>>>>        >> [FIN, ACK] Seq=1129 Ack=7973 Win=42368 Len=0 TSval=2672613945
>>>>>        >> TSecr=1443490937
>>>>>        >>    595 67.664895660 100.113.27.73 ? 100.121.10.169 TCP 66 3128 ?
>>>>>       52202
>>>>>        >> [RST, ACK] Seq=7973 Ack=1129 Win=42752 Len=0 TSval=1443490937
>>>>>        >> TSecr=2672613945
>>>>>        >>    596 67.664936264 100.113.27.73 ? 100.121.10.169 TCP 54 3128 ?
>>>>>       52202
>>>>>        >> [RST] Seq=7973 Win=0 Len=0
>>>>>        >>
>>>>>        >> I'm wondering how to debug it (what exactly) and whether the reason
>>>>>        >> may be on the squid side (specific configuration?).
>>>>>        >>
>>>>>        >> env: GKE/k8s
>>>>>        >> client container: alpine linux
>>>>>        >> child squid container: alpine linux
>>>>>        >> version: 5.7
>>>>>        >>
>>>>>        >> Cheers,
>>>>>        >> Maciek Leks
>>>>>        > _______________________________________________
>>>>>        > squid-users mailing list
>>>>>        > squid-users at lists.squid-cache.org
>>>>>       <mailto:squid-users at lists.squid-cache.org>
>>>>>        > http://lists.squid-cache.org/listinfo/squid-users
>>>>>       <http://lists.squid-cache.org/listinfo/squid-users>
>>>>>
>>>>>       _______________________________________________
>>>>>       squid-users mailing list
>>>>>       squid-users at lists.squid-cache.org
>>>>>       <mailto:squid-users at lists.squid-cache.org>
>>>>>       http://lists.squid-cache.org/listinfo/squid-users
>>>>>       <http://lists.squid-cache.org/listinfo/squid-users>
>>>>>
>>>>>
>>>>> _______________________________________________
>>>>> squid-users mailing list
>>>>> squid-users at lists.squid-cache.org
>>>>> http://lists.squid-cache.org/listinfo/squid-users
>>>>
>>>> _______________________________________________
>>>> squid-users mailing list
>>>> squid-users at lists.squid-cache.org
>>>> http://lists.squid-cache.org/listinfo/squid-users
>>> _______________________________________________
>>> squid-users mailing list
>>> squid-users at lists.squid-cache.org
>>> http://lists.squid-cache.org/listinfo/squid-users
>>
>> _______________________________________________
>> squid-users mailing list
>> squid-users at lists.squid-cache.org
>> http://lists.squid-cache.org/listinfo/squid-users
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users



From squid3 at treenet.co.nz  Tue Feb 28 11:39:32 2023
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Wed, 1 Mar 2023 00:39:32 +1300
Subject: [squid-users] [squid-announce] Squid 5.8 is available
Message-ID: <13b5a6e1-2cd1-a9de-bbdf-3288ef3246f8@treenet.co.nz>

The Squid HTTP Proxy team is very pleased to announce the
availability of the Squid-5.8 release!


This release is a bug fix release resolving several issues
found in the prior Squid-5 releases.

The major changes to be aware of:

 ?* Bug 5162: mgr:index URL do not produce MGR_INDEX template

This bug shows up as Squid producing just the text "mgr_index" instead 
of the intended template contents when the cache manager API is 
requested. Breaking the use of third-party cache management tools and 
also cachemgr.cgi auto-detection of support for those tools.


 ?* Bug 5241: Block all non-localhost requests by default

This release changes the default squid.conf to disable the rule:
 ? http_access allow localnet

This change affects new Squid installs only.


 ?* Bug 5241: Block to-localhost, to-link-local requests by default

This release adds a predefined ACL named "to_linklocal" which matches 
traffic attempting to access link-local network services. Such traffic 
can be a problem for proxy operating within Cloud services or container 
hosting.

Squid installations which have enabled:
http_access deny to_localhost

May wish to also enable:
 ? http_access deny to_linklocal



 ? All users of Squid-5 are encouraged to upgrade as soon as
 ? possible.

 ? Users of Squid-4 holding back due to earlier release issues
 ? are encouraged to test this version for upgrade.


See the ChangeLog for the full list of changes in this and
earlier releases.

Please refer to the release notes at
http://www.squid-cache.org/Versions/v5/RELEASENOTES.html
when you are ready to make the switch to Squid-5

This new release can be downloaded from our HTTP or FTP servers

http://www.squid-cache.org/Versions/v5/
ftp://ftp.squid-cache.org/pub/squid/
ftp://ftp.squid-cache.org/pub/archive/5/

or the mirrors. For a list of mirror sites see

http://www.squid-cache.org/Download/http-mirrors.html
http://www.squid-cache.org/Download/mirrors.html

If you encounter any issues with this release please file a bug
report.
https://bugs.squid-cache.org/


Amos Jeffries

_______________________________________________
squid-announce mailing list
squid-announce at lists.squid-cache.org
http://lists.squid-cache.org/listinfo/squid-announce

From squid3 at treenet.co.nz  Tue Feb 28 12:28:37 2023
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Wed, 1 Mar 2023 01:28:37 +1300
Subject: [squid-users] [squid-announce] Squid 6.0.1 beta is available
Message-ID: <fce4e7d1-3a1e-a491-437c-8cb094175feb@treenet.co.nz>

The Squid Software Foundation is very pleased to announce the
availability of the Squid-6.0.1 beta release!


This new 6.x series of Squid brings useful new features and changes
providing improved performance over earlier release series.

More detailed descriptions of the major new features are available in
the release notes and wiki:
   <http://www.squid-cache.org/Versions/v6/RELEASENOTES.html>
   <https://wiki.squid-cache.org/Releases/Squid-6>

Detailed lists of the ./configure build and squid.conf changes can also
be found in the release notes.

This code is released as beta for wider testing purposes and potential
use. There are no more planned alterations to the existing features,
./configure options or squid.conf options.


This release adds a dependency on C++17 support in any compiler used to
build Squid. GCC 8+ and Clang 8+ are known to have working C++17 support
and are usable. Older compilers will no longer build successfully.


This Squid version takes a major departure from the policy of providing
a working proxy "out of the box" for new installations. Network security
is now given a higher priority and fresh installs of Squid will not pass
most types of traffic until explicitly configured to do so. This policy
change is enacted by new squid.conf default configuration:

   http_access allow localhost
   http_access deny to_localhost
   http_access deny to_linklocal
   # http_access allow localnet

These changes only affect the default squid.conf and new installs.
Upgraded installations will continue to use their previous settings.
More details in the squid.conf documentation.


Squid now supports the Cache-Status HTTP header introduced by RFC 9211.
This HTTP header replaces/X-Cache/  and/X-Cache-Lookup/  which are no longer
emitted by Squid.
Any tools or management systems relying on those/X-/* headers need to
be upgraded to work with the new standardized header.


Major features dropped:

  * Gopher protocol support

With this change, Gopher requests will be handled like any other request
with an unknown (to Squid) protocol. For example, HTTP requests with
/gopher:///  URL scheme result in ERR_UNSUP_REQ.

Default Squid configuration still considers TCP port 70 safe. The
corresponding Safe_ports ACL rule has not been removed.


  * Outdated OS and compiler support

With the move to C++17 older compilers will no longer be able to compile
Squid code. Toolchain support for these compilers has been dropped. Also,
toolchain support for OS too old to run a required C++17 compiler have
been removed.


 ?* Outdated Tools

A number of outdated or otherwise broken tools have been removed from the
packaged Squid sources.
See the release notes for a complete list.



All users are encouraged to give this Squid release a test run as soon
as time permits. All feedback welcome.


Please refer to the release notes at
<http://www.squid-cache.org/Versions/v6/RELEASENOTES.html>  if and when
you are ready to make the switch to Squid-6

This new release can be downloaded from our HTTP or FTP servers

   <http://www.squid-cache.org/Versions/v6/>
   <ftp://ftp.squid-cache.org/pub/squid/>
   <ftp://ftp.squid-cache.org/pub/archive/6/>

or the mirrors. For a list of mirror sites see

   <http://www.squid-cache.org/Download/http-mirrors.html>
   <http://www.squid-cache.org/Download/mirrors.html>

If you encounter any issues with this release please file a bug report.
   <https://bugs.squid-cache.org/>

Amos Jeffries

_______________________________________________
squid-announce mailing list
squid-announce at lists.squid-cache.org
http://lists.squid-cache.org/listinfo/squid-announce

