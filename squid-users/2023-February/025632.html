<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Reverse Proxy Redirect - Stops in Browser
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Reverse%20Proxy%20Redirect%20-%20Stops%20in%20Browser&In-Reply-To=%3C23ba3fa3-dea2-5e74-bb26-07fd0dd7667a%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="025628.html">
   <LINK REL="Next"  HREF="025629.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Reverse Proxy Redirect - Stops in Browser</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Reverse%20Proxy%20Redirect%20-%20Stops%20in%20Browser&In-Reply-To=%3C23ba3fa3-dea2-5e74-bb26-07fd0dd7667a%40treenet.co.nz%3E"
       TITLE="[squid-users] Reverse Proxy Redirect - Stops in Browser">squid3 at treenet.co.nz
       </A><BR>
    <I>Fri Feb 17 01:13:47 UTC 2023</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="025628.html">[squid-users] Reverse Proxy Redirect - Stops in Browser
</A></li>
        <LI>Next message (by thread): <A HREF="025629.html">[squid-users] repos/packages to install squid from source
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25632">[ date ]</a>
              <a href="thread.html#25632">[ thread ]</a>
              <a href="subject.html#25632">[ subject ]</a>
              <a href="author.html#25632">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 16/02/2023 10:56 am, squid wrote:
&gt;<i> I have a reverse proxy that that does the following:
</I>&gt;<i>
</I>&gt;<i> acl example_www url_regex -i ^https?:\/\/example-www?.example.com.*
</I>&gt;<i> http_access allow internal_IPs example_www
</I>&gt;<i> deny_info <A HREF="https://other-www.other.com%R">https://other-www.other.com%R</A> example_www
</I>&gt;<i> http_access deny example_www
</I>&gt;<i>
</I>&gt;<i> When a tool or a browser goes to <A HREF="http://example-www.example.com">http://example-www.example.com</A> it immediately sends them to <A HREF="https://other-www.other.com">https://other-www.other.com</A> as expected.
</I>
When opening an <A HREF="http://">http://</A> URL Browsers etc send a message with the full 
URL including path to Squid. That provides the %R information your rules 
use to redirect them.

Browser:
 &#160; GET <A HREF="http://example-www.example.com/path">http://example-www.example.com/path</A> HTTP/1.1
 &#160; ...

Squid:
 &#160; HTTP/1.1 304
 &#160; ...
 &#160; Location: <A HREF="https://other-www.other.com/path">https://other-www.other.com/path</A>

Browser:
 &#160;&#160; ... initiates request for <A HREF="https://other-www.other.com/path">https://other-www.other.com/path</A>

&gt;<i> When a tool or a browser goes to <A HREF="https://example-www.example.com">https://example-www.example.com</A> it brings up in chrome the Your connection is not private page and when you hit Advanced and hit the allow to proceed it is then redirected to the site.
</I>

When opening an <A HREF="https://">https://</A> URL Browsers etc send a CONNECT message 
requesting Squid open a tunnel to the server. That lacks the %R 
information your rules use.

Browser:
 &#160; CONNECT example-www.example.com:443 HTTP/1.1
 &#160; ...

Squid:
 &#160; HTTP/1.1 304
 &#160; ...
 &#160; Location: <A HREF="https://other-www.other.com/">https://other-www.other.com/</A>

Browser:
 &#160; ... initiate request for <A HREF="https://other-www.other.com/">https://other-www.other.com/</A>


&gt;<i> This is causing us come compliance issues due to the tool thinking we are running a non-compliant https page since user interaction is required to get to the other page.
</I>&gt;<i>
</I>&gt;<i> Is there a way to send to the other page earlier so the tool or user doesn't even see the Your connection is not private page?  I just want to only aloow the internal IPs and cut everyone else off.
</I>
As you noticed the Browser displays that warning dialog when it receives 
a 304. AFAIK, the only response status that Browser permit to do 
anything at all on a CONNECT request are the 200 and 304 ones. 
Everything else gets replaced by a Browsers error page. The non-Browser 
tools may display an error from Squid, YMMV based on tool.

Squid contains the SSL-Bump feature to decrypt the TLS inside the 
tunnel. If you have the clients trusting Squid CA certificate you can 
decrypt the TLS and redirect those messages instead of the CONNECT tunnel.


&gt;<i> I've tried taking out the deny_info, but that sends the user and tool to a squid error page which basically fails the test as well since it's on the same site.
</I>&gt;<i> I've also tried doing a TCP_RESET instead, but for some reason the squid actually send the word reset back to the client the first time and again would fail the test.
</I>
That is a bug. It should be delivering only a TCP RST packet, not any 
text words. Which Squid version are you using?

If you end up using SSL-Bump it has a &quot;terminate&quot; action which does the 
same/equivalent for TLS protocol.

HTH
Amos


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="025628.html">[squid-users] Reverse Proxy Redirect - Stops in Browser
</A></li>
	<LI>Next message (by thread): <A HREF="025629.html">[squid-users] repos/packages to install squid from source
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25632">[ date ]</a>
              <a href="thread.html#25632">[ thread ]</a>
              <a href="subject.html#25632">[ subject ]</a>
              <a href="author.html#25632">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
