<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid returns 500 on rapidly changing DNS records
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20returns%20500%20on%20rapidly%20changing%20DNS%20records&In-Reply-To=%3C9fc40c53-38ff-2234-2cdf-23d07cc77bfc%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="025637.html">
   <LINK REL="Next"  HREF="025640.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid returns 500 on rapidly changing DNS records</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20returns%20500%20on%20rapidly%20changing%20DNS%20records&In-Reply-To=%3C9fc40c53-38ff-2234-2cdf-23d07cc77bfc%40measurement-factory.com%3E"
       TITLE="[squid-users] Squid returns 500 on rapidly changing DNS records">rousskov at measurement-factory.com
       </A><BR>
    <I>Fri Feb 17 16:46:05 UTC 2023</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="025637.html">[squid-users] Squid returns 500 on rapidly changing DNS records
</A></li>
        <LI>Next message (by thread): <A HREF="025640.html">[squid-users] Squid returns 500 on rapidly changing DNS records
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25639">[ date ]</a>
              <a href="thread.html#25639">[ thread ]</a>
              <a href="subject.html#25639">[ subject ]</a>
              <a href="author.html#25639">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 2/17/23 09:31, Maciej Leks wrote:

&gt;<i> We have being facing the 500 error codes in our squids (v5.7) when it
</I>&gt;<i> comes to communicate with Salesforce DNS for ephemeral hosts
</I>
&gt;<i>     A cs128-fra.fra.r.salesforce.com.              30s   85.222.154.211
</I>&gt;<i>     A cs128-fra.fra.r.salesforce.com.              30s   160.8.252.83
</I>&gt;<i>     A cs128-fra.fra.r.salesforce.com.              30s   85.222.152.83
</I>
30s TTLs will naturally limit the time Squid can cache these IPs for.


&gt;<i> From time to time DNS answers only sending SOA record (no A,AAAA records)
</I>
Squid will fail to forward traffic if Squid does not have the 
destination IP address cached and its new DNS lookup returns no IPv4 or 
IPv6 records. Moreover, I am not 100% sure -- needs checking/testing -- 
but Squid might cache that &quot;negative&quot; no-IPs result (see 
negative_dns_ttl that defaults to 60 seconds).

Do all 500 error cases correspond to DNS answers without IPs? In other 
words, is there a 500 error case after a DNS answer with IPs (within 29 
seconds from each other)?

HTH,

Alex.
P.S. Sorry for not answering your questions below directly. I do not 
have the time to document what Squid debugging logs mean, and I 
recommend sharing them without analysis (by non-developers).


&gt;<i> dig:
</I>&gt;<i> IP address of sagittarius-oatmilk-722.scratch.my.salesforce.com is
</I>&gt;<i> cs128.salesforce.com.
</I>&gt;<i> cs128-fra.salesforce.com.
</I>&gt;<i> cs128-fra.fra.r.salesforce.com.
</I>&gt;<i> 160.8.255.83
</I>&gt;<i> 160.8.249.83
</I>&gt;<i> 85.222.154.211
</I>&gt;<i> Failed to resolve sagittarius-oatmilk-722.scratch.my.salesforce.com
</I>&gt;<i> Failed to resolve sagittarius-oatmilk-722.scratch.my.salesforce.com
</I>&gt;<i> Failed to resolve sagittarius-oatmilk-722.scratch.my.salesforce.com
</I>&gt;<i> Failed to resolve sagittarius-oatmilk-722.scratch.my.salesforce.com
</I>&gt;<i> IP address of sagittarius-oatmilk-722.scratch.my.salesforce.com is
</I>&gt;<i> cs128.salesforce.com.
</I>&gt;<i> cs128-fra.salesforce.com.
</I>&gt;<i> cs128-fra.fra.r.salesforce.com.
</I>&gt;<i> 85.222.154.211
</I>&gt;<i> 160.8.255.83
</I>&gt;<i> 160.8.249.83
</I>&gt;<i> IP address of sagittarius-oatmilk-722.scratch.my.salesforce.com is
</I>&gt;<i> cs128.salesforce.com.
</I>&gt;<i> cs128-fra.salesforce.com.
</I>&gt;<i> cs128-fra.fra.r.salesforce.com.
</I>&gt;<i> 160.8.253.83
</I>&gt;<i> 
</I>&gt;<i> Squid outputs then:
</I>&gt;<i> 16/Feb/2023:13:45:54 +0100 1676551554.420    107 100.113.24.84
</I>&gt;<i> 100.113.24.84 NONE_NONE/500 0 CONNECT
</I>&gt;<i> canal-trailblazer-1066.scratch.my.salesforce.com:443 - HIER_NONE/- - -
</I>&gt;<i> - &quot;/CN=gitlab-executor-stg.navio-services.opl-gcp.int&quot;
</I>&gt;<i> 16/Feb/2023:13:51:55 +0100 1676551915.973     82 100.113.25.178
</I>&gt;<i> 100.113.25.178 NONE_NONE/500 0 CONNECT
</I>&gt;<i> pumpkinspice-pisces-6588.scratch.my.salesforce.com:443 - HIER_NONE/- -
</I>&gt;<i> - - &quot;/CN=gitlab-executor-stg.navio-services.opl-gcp.int&quot;
</I>&gt;<i> 16/Feb/2023:13:52:44 +0100 1676551964.285     95 100.113.24.84
</I>&gt;<i> 100.113.24.84 NONE_NONE/500 0 CONNECT
</I>&gt;<i> trailblazer-builder-1043.scratch.file.force.com:443 - HIER_NONE/- - -
</I>&gt;<i> Mozilla/5.0%20(X11;%20Linux%20x86_64)%20AppleWebKit/537.36%20(KHTML,%20like%20Gecko)%20HeadlessChrome/109.0.5414.74%20Safari/537.36
</I>&gt;<i> &quot;/CN=gitlab-executor-stg.navio-services.opl-gcp.int&quot;
</I>&gt;<i> 16/Feb/2023:13:56:11 +0100 1676552171.392     43 100.121.10.183
</I>&gt;<i> 100.121.10.183 NONE_NONE/500 0 CONNECT
</I>&gt;<i> pistachio-vente-806.scratch.my.salesforce.com:443 - HIER_NONE/- - - -
</I>&gt;<i> &quot;/CN=gitlab-executor-stg.navio-services.opl-gcp.int&quot;
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Child squids get then (the same situation but different case):
</I>&gt;<i> 17/Feb/2023:13:18:49 +0000 1676639929.989 88 100.121.10.104
</I>&gt;<i> TCP_TUNNEL/500 0 CONNECT
</I>&gt;<i> beans-goldengate-9524.scratch.my.salesforce.com:443 -
</I>&gt;<i> ANY_OLD_PARENT/100.112.36.14 -
</I>&gt;<i> 
</I>&gt;<i> Such a situation but not the same case from squid internals point of
</I>&gt;<i> view I list below:
</I>&gt;<i> 74,5| RequestParser.cc(377) doParse: request-line: retval 1:
</I>&gt;<i> line={266, data='CONNECT
</I>&gt;<i> baybridge-module-8155.scratch.my.salesforce.com:443 HTTP/1.1
</I>&gt;<i> Host: baybridge-module-8155.scratch.my.salesforce.com:443
</I>&gt;<i> 2023/02/15 15:44:24.223 kid1| 74,5| RequestParser.cc(379) doParse:
</I>&gt;<i> request-line: url: baybridge-module-8155.scratch.my.salesforce.com:443
</I>&gt;<i> 2023/02/15 15:44:24.223 kid1| 74,5| Parser.cc(192) grabMimeBlock: mime
</I>&gt;<i> header (0-196) {Host:
</I>&gt;<i> baybridge-module-8155.scratch.my.salesforce.com:443
</I>&gt;<i> CONNECT baybridge-module-8155.scratch.my.salesforce.com:443 HTTP/1.1
</I>&gt;<i> Host: baybridge-module-8155.scratch.my.salesforce.com:443
</I>&gt;<i> Host: baybridge-module-8155.scratch.my.salesforce.com:443
</I>&gt;<i> 2023/02/15 15:44:24.223 kid1| 23,3| Uri.cc(441) parse: Split URL
</I>&gt;<i> 'baybridge-module-8155.scratch.my.salesforce.com:443' into proto='',
</I>&gt;<i> host='baybridge-module-8155.scratch.my.salesforce.com', port='443',
</I>&gt;<i> path=''
</I>&gt;<i> 2023/02/15 15:44:24.223 kid1| 14,3| Address.cc(389) lookupHostIP:
</I>&gt;<i> Given Non-IP 'baybridge-module-8155.scratch.my.salesforce.com': Name
</I>&gt;<i> or service not known
</I>&gt;<i> 2023/02/15 15:44:24.223 kid1| 33,5| Http1Server.cc(193)
</I>&gt;<i> buildHttpRequest: normalize 1 Host header using
</I>&gt;<i> baybridge-module-8155.scratch.my.salesforce.com:443
</I>&gt;<i> 2023/02/15 15:44:24.224 kid1| 85,3| client_side_request.cc(637)
</I>&gt;<i> hostHeaderVerify: validate
</I>&gt;<i> host=baybridge-module-8155.scratch.my.salesforce.com, port=443,
</I>&gt;<i> portStr=443
</I>&gt;<i> 2023/02/15 15:44:24.224 kid1| 14,3| ipcache.cc(722)
</I>&gt;<i> ipcache_gethostbyname: ipcache_gethostbyname:
</I>&gt;<i> 'baybridge-module-8155.scratch.my.salesforce.com', flags=1
</I>&gt;<i> 2023/02/15 15:44:24.224 kid1| 14,3| ipcache.cc(310) ipcacheRelease:
</I>&gt;<i> ipcacheRelease: Releasing entry for
</I>&gt;<i> 'baybridge-module-8155.scratch.my.salesforce.com'
</I>&gt;<i> 2023/02/15 15:44:24.224 kid1| 14,3| Address.cc(389) lookupHostIP:
</I>&gt;<i> Given Non-IP 'baybridge-module-8155.scratch.my.salesforce.com': Name
</I>&gt;<i> or service not known
</I>&gt;<i> 2023/02/15 15:44:24.224 kid1| 14,4| ipcache.cc(600)
</I>&gt;<i> ipcache_nbgethostbyname:
</I>&gt;<i> baybridge-module-8155.scratch.my.salesforce.com
</I>&gt;<i> 2023/02/15 15:44:24.224 kid1| 14,3| Address.cc(389) lookupHostIP:
</I>&gt;<i> Given Non-IP 'baybridge-module-8155.scratch.my.salesforce.com': Name
</I>&gt;<i> or service not known
</I>&gt;<i> 2023/02/15 15:44:24.224 kid1| 14,5| ipcache.cc(660)
</I>&gt;<i> ipcache_nbgethostbyname_: ipcache_nbgethostbyname: MISS for
</I>&gt;<i> 'baybridge-module-8155.scratch.my.salesforce.com'
</I>&gt;<i> 2023/02/15 15:44:24.224 kid1| 78,3| dns_internal.cc(1788) idnsALookup:
</I>&gt;<i> idnsALookup: buf is 65 bytes for
</I>&gt;<i> baybridge-module-8155.scratch.my.salesforce.com, id = 0x9c4
</I>&gt;<i> 2023/02/15 15:44:24.224 kid1| 78,3| dns_internal.cc(1724)
</I>&gt;<i> idnsSendSlaveAAAAQuery: buf is 65 bytes for
</I>&gt;<i> baybridge-module-8155.scratch.my.salesforce.com, id = 0x5b5e
</I>&gt;<i> 2023/02/15 15:44:24.224 kid1| 28,3| DestinationIp.cc(78) match: can't
</I>&gt;<i> yet compare 'to_localhost' ACL for
</I>&gt;<i> baybridge-module-8155.scratch.my.salesforce.com
</I>&gt;<i> 2023/02/15 15:44:24.224 kid1| 14,4| ipcache.cc(600)
</I>&gt;<i> ipcache_nbgethostbyname:
</I>&gt;<i> baybridge-module-8155.scratch.my.salesforce.com
</I>&gt;<i> 2023/02/15 15:44:24.224 kid1| 14,3| Address.cc(389) lookupHostIP:
</I>&gt;<i> Given Non-IP 'baybridge-module-8155.scratch.my.salesforce.com': Name
</I>&gt;<i> or service not known
</I>&gt;<i> 2023/02/15 15:44:24.224 kid1| 14,5| ipcache.cc(660)
</I>&gt;<i> ipcache_nbgethostbyname_: ipcache_nbgethostbyname: MISS for
</I>&gt;<i> 'baybridge-module-8155.scratch.my.salesforce.com'
</I>&gt;<i> 2023/02/15 15:44:24.247 kid1| 14,3| ipcache.cc(456) latestError: DNS
</I>&gt;<i> error while resolving baybridge-module-8155.scratch.my.salesforce.com:
</I>&gt;<i> No DNS records
</I>&gt;<i> 2023/02/15 15:44:24.248 kid1| 14,3| ipcache.cc(456) latestError: DNS
</I>&gt;<i> error while resolving baybridge-module-8155.scratch.my.salesforce.com:
</I>&gt;<i> No DNS records
</I>&gt;<i> 2023/02/15 15:44:24.282 kid1| 14,3| ipcache.cc(477) ipcacheParse: 3
</I>&gt;<i> answers for baybridge-module-8155.scratch.my.salesforce.com
</I>&gt;<i> 2023/02/15 15:44:24.282 kid1| 14,3| ipcache.cc(576)
</I>&gt;<i> ipcacheHandleReply: done with
</I>&gt;<i> baybridge-module-8155.scratch.my.salesforce.com: [no cached IPs]
</I>&gt;<i> 2023/02/15 15:44:24.282 kid1| 14,3| ipcache.cc(477) ipcacheParse: 3
</I>&gt;<i> answers for baybridge-module-8155.scratch.my.salesforce.com
</I>&gt;<i> 2023/02/15 15:44:24.282 kid1| 14,3| ipcache.cc(576)
</I>&gt;<i> ipcacheHandleReply: done with
</I>&gt;<i> baybridge-module-8155.scratch.my.salesforce.com: [no cached IPs]
</I>&gt;<i> 2023/02/15 15:44:24.282 kid1| 14,3| ipcache.cc(310) ipcacheRelease:
</I>&gt;<i> ipcacheRelease: Releasing entry for
</I>&gt;<i> 'baybridge-module-8155.scratch.my.salesforce.com'
</I>&gt;<i> 2023/02/15 15:44:24.282 kid1| 14,3| ipcache.cc(722)
</I>&gt;<i> ipcache_gethostbyname: ipcache_gethostbyname:
</I>&gt;<i> 'baybridge-module-8155.scratch.my.salesforce.com', flags=1
</I>&gt;<i> 2023/02/15 15:44:24.282 kid1| 28,3| DomainData.cc(110) match:
</I>&gt;<i> aclMatchDomainList: checking
</I>&gt;<i> 'baybridge-module-8155.scratch.my.salesforce.com'
</I>&gt;<i> 2023/02/15 15:44:24.282 kid1| 28,3| DomainData.cc(115) match:
</I>&gt;<i> aclMatchDomainList: 'baybridge-module-8155.scratch.my.salesforce.com'
</I>&gt;<i> NOT found
</I>&gt;<i> 2023/02/15 15:44:24.283 kid1| 28,3| DomainData.cc(110) match:
</I>&gt;<i> aclMatchDomainList: checking
</I>&gt;<i> 'baybridge-module-8155.scratch.my.salesforce.com'
</I>&gt;<i> 2023/02/15 15:44:24.283 kid1| 28,3| DomainData.cc(115) match:
</I>&gt;<i> aclMatchDomainList: 'baybridge-module-8155.scratch.my.salesforce.com'
</I>&gt;<i> found
</I>&gt;<i> 2023/02/15 15:44:24.283 kid1| 85,2| client_side_request.cc(745)
</I>&gt;<i> clientAccessCheckDone: The request CONNECT
</I>&gt;<i> baybridge-module-8155.scratch.my.salesforce.com:443 is ALLOWED; last
</I>&gt;<i> ACL checked: gitlab-executor-stg-dst
</I>&gt;<i> 2023/02/15 15:44:24.284 kid1| 85,2| client_side_request.cc(745)
</I>&gt;<i> clientAccessCheckDone: The request CONNECT
</I>&gt;<i> baybridge-module-8155.scratch.my.salesforce.com:443 is ALLOWED; last
</I>&gt;<i> ACL checked: gitlab-executor-stg-dst
</I>&gt;<i> 2023/02/15 15:44:24.284 kid1| 85,4| client_side_request.cc(1514)
</I>&gt;<i> processRequest: CONNECT
</I>&gt;<i> baybridge-module-8155.scratch.my.salesforce.com:443
</I>&gt;<i> 2023/02/15 15:44:24.284 kid1| 26,3| tunnel.cc(1140) tunnelStart:
</I>&gt;<i> CONNECT baybridge-module-8155.scratch.my.salesforce.com:443 HTTP/1.1
</I>&gt;<i> 2023/02/15 15:44:24.284 kid1| 44,3| peer_select.cc(612) selectMore:
</I>&gt;<i> CONNECT baybridge-module-8155.scratch.my.salesforce.com
</I>&gt;<i> 2023/02/15 15:44:24.284 kid1| 44,3| peer_select.cc(1098) addSelection:
</I>&gt;<i> adding HIER_DIRECT#baybridge-module-8155.scratch.my.salesforce.com
</I>&gt;<i> 2023/02/15 15:44:24.284 kid1| 44,2| peer_select.cc(460)
</I>&gt;<i> resolveSelected: Find IP destination for:
</I>&gt;<i> baybridge-module-8155.scratch.my.salesforce.com:443' via
</I>&gt;<i> baybridge-module-8155.scratch.my.salesforce.com
</I>&gt;<i> 2023/02/15 15:44:24.284 kid1| 14,4| ipcache.cc(607) nbgethostbyname:
</I>&gt;<i> baybridge-module-8155.scratch.my.salesforce.com
</I>&gt;<i> 2023/02/15 15:44:24.284 kid1| 14,3| Address.cc(389) lookupHostIP:
</I>&gt;<i> Given Non-IP 'baybridge-module-8155.scratch.my.salesforce.com': Name
</I>&gt;<i> or service not known
</I>&gt;<i> 2023/02/15 15:44:24.284 kid1| 14,4| ipcache.cc(647)
</I>&gt;<i> ipcache_nbgethostbyname_: ipcache_nbgethostbyname: HIT for
</I>&gt;<i> 'baybridge-module-8155.scratch.my.salesforce.com'
</I>&gt;<i> 2023/02/15 15:44:24.284 kid1| 44,2| peer_select.cc(479)
</I>&gt;<i> resolveSelected: PeerSelector4664913 found all 0 destinations for
</I>&gt;<i> baybridge-module-8155.scratch.my.salesforce.com:443
</I>&gt;<i> 2023/02/15 15:44:24.284 kid1| 4,3| errorpage.cc(1249)
</I>&gt;<i> compileLegacyCode: %U --&gt;
</I>&gt;<i> '<A HREF="https://baybridge-module-8155.scratch.my.salesforce.com/*">https://baybridge-module-8155.scratch.my.salesforce.com/*</A>'
</I>&gt;<i> 2023/02/15 15:44:24.284 kid1| 4,3| errorpage.cc(1249)
</I>&gt;<i> compileLegacyCode: %U --&gt;
</I>&gt;<i> '<A HREF="https://baybridge-module-8155.scratch.my.salesforce.com/*">https://baybridge-module-8155.scratch.my.salesforce.com/*</A>'
</I>&gt;<i> 2023/02/15 15:44:24.284 kid1| 4,3| errorpage.cc(1249)
</I>&gt;<i> compileLegacyCode: %W --&gt;
</I>&gt;<i> '?subject=CacheErrorInfo%20-%20ERR_CANNOT_FORWARD&amp;body=CacheHost%3A%20opl-egress-proxy-vm-31vr%0D%0AErrPage%3A%20ERR_CANNOT_FORWARD%0D%0AErr%3A%20%5Bnone%5D%0D%0ATimeStamp%3A%20Wed,%2015%20Feb%202023%2014%3A44%3A24%20GMT%0D%0A%0D%0AClientIP%3A%20100.121.10.148%0D%0A%0D%0AHTTP%20Request%3A%0D%0ACONNECT%20%20HTTP%2F1.1%0AVia%3A%201.1%20gitlab-proxy-6d445dbd8d-mxtqv%20(squid%2F5.7)%0D%0AX-Forwarded-For%3A%20100.113.24.224%0D%0ACache-Control%3A%20max-age%3D259200%0D%0AConnection%3A%20close%0D%0AHost%3A%20baybridge-module-8155.scratch.my.salesforce.com%3A443%0D%0A%0D%0A%0D%0A'
</I>&gt;<i> 2023/02/15 15:44:24.286 kid1| 33,3| client_side_request.cc(272)
</I>&gt;<i> ~ClientHttpRequest: httpRequestFree:
</I>&gt;<i> baybridge-module-8155.scratch.my.salesforce.com:443
</I>&gt;<i> 2023/02/15 15:44:24.286 kid1| 33,5| client_side.cc(385) logRequest:
</I>&gt;<i> logging half-baked transaction:
</I>&gt;<i> baybridge-module-8155.scratch.my.salesforce.com:443
</I>&gt;<i> 
</I>&gt;<i> Our parent proxy settings for DNS:
</I>&gt;<i> negative_dns_ttl 3 seconds  #if we set 1s it behaves the same
</I>&gt;<i> dns_nameservers 8.8.8.8 1.1.1.1
</I>&gt;<i> 
</I>&gt;<i> The question is:
</I>&gt;<i> If you carefully look at the debug log you see:
</I>&gt;<i> a. I(Squid) can't find IP for the name
</I>&gt;<i> b. I've got 3 IPs from DNS
</I>&gt;<i> c. OK, so I've got IP
</I>&gt;<i> d. ...Oh, I cannot find any IP
</I>&gt;<i> e. I can't find any destinations (what's that?)
</I>&gt;<i> f. I'm outputing an error
</I>&gt;<i> 
</I>&gt;<i> So, do you think it's ok or there is a bug?
</I>&gt;<i> 
</I>&gt;<i> Rgds,
</I>&gt;<i> Maciej Leks
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="025637.html">[squid-users] Squid returns 500 on rapidly changing DNS records
</A></li>
	<LI>Next message (by thread): <A HREF="025640.html">[squid-users] Squid returns 500 on rapidly changing DNS records
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25639">[ date ]</a>
              <a href="thread.html#25639">[ thread ]</a>
              <a href="subject.html#25639">[ subject ]</a>
              <a href="author.html#25639">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
