<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] client-&gt;Squid: TCP [RST] and [RST,ACK]
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20client-%3ESquid%3A%20TCP%20%5BRST%5D%20and%20%5BRST%2CACK%5D&In-Reply-To=%3C75d8ab79-b68c-933a-72fb-2d99f4a369ac%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="025671.html">
   <LINK REL="Next"  HREF="025673.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] client-&gt;Squid: TCP [RST] and [RST,ACK]</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20client-%3ESquid%3A%20TCP%20%5BRST%5D%20and%20%5BRST%2CACK%5D&In-Reply-To=%3C75d8ab79-b68c-933a-72fb-2d99f4a369ac%40measurement-factory.com%3E"
       TITLE="[squid-users] client-&gt;Squid: TCP [RST] and [RST,ACK]">rousskov at measurement-factory.com
       </A><BR>
    <I>Tue Feb 28 21:13:22 UTC 2023</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="025671.html">[squid-users] client-&gt;Squid: TCP [RST] and [RST,ACK]
</A></li>
        <LI>Next message (by thread): <A HREF="025673.html">[squid-users] client-&gt;Squid: TCP [RST] and [RST,ACK]
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25672">[ date ]</a>
              <a href="thread.html#25672">[ thread ]</a>
              <a href="subject.html#25672">[ subject ]</a>
              <a href="author.html#25672">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 2/28/23 15:34, Maciej Leks wrote:
&gt;<i> wt., 28 lut 2023 o 20:06 Alex Rousskov
</I>&gt;<i> &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt; napisa&#322;(a):
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> On 2/28/23 13:07, Maciej Leks wrote:
</I>&gt;&gt;&gt;&gt;<i> Does child Squid bump the TLS client connection, tunnel it, or
</I>&gt;&gt;&gt;&gt;<i> terminates it (i.e. the child works as a reverse proxy)?
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> * client connects to child Squid's http_port without &quot;ssl-bump&quot;.
</I>&gt;&gt;&gt;<i> * client sends a plain text CONNECT request to child Squid.
</I>&gt;&gt;&gt;<i> * child Squid connects to parent using cache_peer with mTLS.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I assume that, by mTLS, you mean a cache_peer directive with &quot;tls&quot;
</I>&gt;&gt;<i> option _and_ with &quot;sslcert&quot; (or equivalent) option to specify the TLS
</I>&gt;&gt;<i> client certificate to be sent to the cache peer.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I assume that the packets you pasted earlier were between a child Squid
</I>&gt;&gt;<i> and its parent.
</I>
&gt;<i> Exactly.
</I>
&gt;&gt;&gt;&gt;<i> What are those TLS alerts?
</I>&gt;&gt;&gt;<i> Code 21 - decryption_failed_RESERVED(21).
</I>
Are you sure that 21 is actually the alert description ID and _not_ the 
TLS message content type (all alert messages have TLS content type 21)? 
See &quot;ContentType&quot; and &quot;AlertDescription&quot; definitions in RFC 8446. Below, 
I will assume that it is the former because you said 
&quot;decryption_failed_RESERVED&quot; above, but this looks very suspicious! 
Where did you get that &quot;21&quot; from? Perhaps you can show Wireshark 
dissection of the corresponding alert message?


According to obsoleted RFC 5246 (TLS v1.2):

&gt;<i>    decryption_failed_RESERVED
</I>&gt;<i>       This alert was used in some earlier versions of TLS, and may have
</I>&gt;<i>       permitted certain attacks against the CBC mode [CBCATT].  It MUST
</I>&gt;<i>       NOT be sent by compliant implementations.
</I>


&gt;&gt;<i> I would focus on this error and ignore RST packets for now. Most likely,
</I>&gt;&gt;<i> this error is what triggers those packets.
</I>
&gt;<i> According to your experience - who sends this TLS &quot;Encrypted Alert&quot;
</I>&gt;<i> and RST - either the server (Salesforce) or parent squid?
</I>
FWIW, I do not recall seeing these specific alerts. It might be 
Salesforce greasing TLS messages, I guess, but I cannot quickly find 
evidence of alerts being used for that purpose (RFC 8701 does not 
mention this greasing vector AFAICT). Typical greased values do not 
violate MUSTs, but perhaps they can violate MUSTs from obsoleted RFCs? 
Or this is not a decryption_failed_RESERVED alert ;-).

However, I am surprised you are asking the list this question. Don't you 
know (e.g., from packet captures) who is sending the alert in question?!


Cheers,

Alex.

&gt;&gt;&gt;&gt;<i> If those TLS alerts are close_notify alerts, then the RST packets you
</I>&gt;&gt;&gt;&gt;<i> are seeing are probably triggered by the other side doing clean TLS
</I>&gt;&gt;&gt;&gt;<i> shutdown (i.e. sending a TLS close_notify alert before closing the
</I>&gt;&gt;&gt;&gt;<i> connection), either after receiving a FIN packet (unlikely with
</I>&gt;&gt;&gt;&gt;<i> half_closed_clients off?) or while that FIN packet is being generated or
</I>&gt;&gt;&gt;&gt;<i> is in-flight. When Such RST packets would be sent by the TCP stack
</I>&gt;&gt;&gt;&gt;<i> rather than Squid code itself. They may be an indication of a benign
</I>&gt;&gt;&gt;&gt;<i> race condition, a bug, or some other deficiency.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> half_closed_clients is off
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> Higher-level information (who initiates closure and why) may be needed
</I>&gt;&gt;&gt;&gt;<i> to figure this out. I recommend sharing a link to a compressed ALL,9
</I>&gt;&gt;&gt;&gt;<i> cache.log reproducing the problem with a single transaction _combined_
</I>&gt;&gt;&gt;&gt;<i> with a matching packet trace file in libpcap format.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> There is no other way than turning debug on.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Maciek
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> wt., 28 lut 2023 o 15:15 Alex Rousskov &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>
</I>&gt;&gt;&gt;<i> &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt;&gt; napisa&#322;(a):
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>      On 2/28/23 08:35, Maciej Leks wrote:
</I>&gt;&gt;&gt;<i>       &gt; Am I right in saying that RST it's a design intent of squid to end
</I>&gt;&gt;&gt;<i>       &gt; connections quickly? I've started digging into the squid code and see
</I>&gt;&gt;&gt;<i>       &gt; SO_LINGER and timeout set to 0, which means that it's done on purpose
</I>&gt;&gt;&gt;<i>       &gt; not to hang on connections in TIME_WAIT state?
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>      Does child Squid bump the TLS client connection, tunnel it, or
</I>&gt;&gt;&gt;<i>      terminates it (i.e. the child works as a reverse proxy)?
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>      What are those TLS alerts?
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>      If those TLS alerts are close_notify alerts, then the RST packets you
</I>&gt;&gt;&gt;<i>      are seeing are probably triggered by the other side doing clean TLS
</I>&gt;&gt;&gt;<i>      shutdown (i.e. sending a TLS close_notify alert before closing the
</I>&gt;&gt;&gt;<i>      connection), either after receiving a FIN packet (unlikely with
</I>&gt;&gt;&gt;<i>      half_closed_clients off?) or while that FIN packet is being
</I>&gt;&gt;&gt;<i>      generated or
</I>&gt;&gt;&gt;<i>      is in-flight. When Such RST packets would be sent by the TCP stack
</I>&gt;&gt;&gt;<i>      rather than Squid code itself. They may be an indication of a benign
</I>&gt;&gt;&gt;<i>      race condition, a bug, or some other deficiency.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>      Higher-level information (who initiates closure and why) may be needed
</I>&gt;&gt;&gt;<i>      to figure this out. I recommend sharing a link to a compressed ALL,9
</I>&gt;&gt;&gt;<i>      cache.log reproducing the problem with a single transaction _combined_
</I>&gt;&gt;&gt;<i>      with a matching packet trace file in libpcap format.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>      <A HREF="https://wiki.squid-cache.org/SquidFaq/BugReporting#debugging-a-single-transaction">https://wiki.squid-cache.org/SquidFaq/BugReporting#debugging-a-single-transaction</A> &lt;<A HREF="https://wiki.squid-cache.org/SquidFaq/BugReporting#debugging-a-single-transaction">https://wiki.squid-cache.org/SquidFaq/BugReporting#debugging-a-single-transaction</A>&gt;
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>      HTH,
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>      Alex.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>       &gt; wt., 28 lut 2023 o 08:12 Maciej Leks &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">maciej.leks at gmail.com</A>
</I>&gt;&gt;&gt;<i>      &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">maciej.leks at gmail.com</A>&gt;&gt; napisa&#322;(a):
</I>&gt;&gt;&gt;<i>       &gt;&gt;
</I>&gt;&gt;&gt;<i>       &gt;&gt; For a couple of days we've  been encountering many ECONNRESET error
</I>&gt;&gt;&gt;<i>       &gt;&gt; messages in our nodejs client to Salesforce. Even if access.log
</I>&gt;&gt;&gt;<i>      shows
</I>&gt;&gt;&gt;<i>       &gt;&gt; only /200 tshark shows a messy communication between client-&gt;squid
</I>&gt;&gt;&gt;<i>       &gt;&gt; (child squid).
</I>&gt;&gt;&gt;<i>       &gt;&gt;
</I>&gt;&gt;&gt;<i>       &gt;&gt; The architecture: nodejs client-&gt;3..* child squid-&gt;2*parent
</I>&gt;&gt;&gt;<i>       &gt;&gt; squids-&gt;cloud Salesforce
</I>&gt;&gt;&gt;<i>       &gt;&gt;
</I>&gt;&gt;&gt;<i>       &gt;&gt; Some examples ([RST]]: 46 1.015513576 100.121.10.169 &#8594; 100.113.27.73
</I>&gt;&gt;&gt;<i>       &gt;&gt; TCP 66 46098 &#8594; 3128 [ACK] Seq=1721 Ack=140135 Win=214656 Len=0
</I>&gt;&gt;&gt;<i>       &gt;&gt; TSval=2672547296 TSecr=1443424287
</I>&gt;&gt;&gt;<i>       &gt;&gt;
</I>&gt;&gt;&gt;<i>       &gt;&gt;     47 1.016152326 100.113.27.73 &#8594; 100.121.10.169 TCP 66 3128 &#8594;
</I>&gt;&gt;&gt;<i>      46098
</I>&gt;&gt;&gt;<i>       &gt;&gt; [FIN, ACK] Seq=140135 Ack=1721 Win=42368 Len=0 TSval=1443424288
</I>&gt;&gt;&gt;<i>       &gt;&gt; TSecr=2672547296
</I>&gt;&gt;&gt;<i>       &gt;&gt;     48 1.017856001 100.121.10.169 &#8594; 100.113.27.73 TLSv1.2 97
</I>&gt;&gt;&gt;<i>      Encrypted Alert
</I>&gt;&gt;&gt;<i>       &gt;&gt;     49 1.017893411 100.121.10.169 &#8594; 100.113.27.73 TCP 66 46098 &#8594;
</I>&gt;&gt;&gt;<i>      3128
</I>&gt;&gt;&gt;<i>       &gt;&gt; [FIN, ACK] Seq=1752 Ack=140136 Win=214656 Len=0 TSval=2672547298
</I>&gt;&gt;&gt;<i>       &gt;&gt; TSecr=1443424288
</I>&gt;&gt;&gt;<i>       &gt;&gt;     50 1.018002285 100.113.27.73 &#8594; 100.121.10.169 TCP 54 3128 &#8594;
</I>&gt;&gt;&gt;<i>      46098
</I>&gt;&gt;&gt;<i>       &gt;&gt; [RST] Seq=140136 Win=0 Len=0
</I>&gt;&gt;&gt;<i>       &gt;&gt;     51 1.018019806 100.113.27.73 &#8594; 100.121.10.169 TCP 54 3128 &#8594;
</I>&gt;&gt;&gt;<i>      46098
</I>&gt;&gt;&gt;<i>       &gt;&gt; [RST] Seq=140136 Win=0 Len=0
</I>&gt;&gt;&gt;<i>       &gt;&gt;
</I>&gt;&gt;&gt;<i>       &gt;&gt; [RST,ACK]:
</I>&gt;&gt;&gt;<i>       &gt;&gt; 592 67.664585034 100.121.10.169 &#8594; 100.113.27.73 TLSv1.2 97
</I>&gt;&gt;&gt;<i>      Encrypted Alert
</I>&gt;&gt;&gt;<i>       &gt;&gt;    593 67.664737552 100.113.27.73 &#8594; 100.121.10.169 TCP 66 3128 &#8594;
</I>&gt;&gt;&gt;<i>      52202
</I>&gt;&gt;&gt;<i>       &gt;&gt; [ACK] Seq=7973 Ack=1129 Win=42752 Len=0 TSval=1443490937
</I>&gt;&gt;&gt;<i>       &gt;&gt; TSecr=2672613945
</I>&gt;&gt;&gt;<i>       &gt;&gt;    594 67.664841613 100.121.10.169 &#8594; 100.113.27.73 TCP 66 52202
</I>&gt;&gt;&gt;<i>      &#8594; 3128
</I>&gt;&gt;&gt;<i>       &gt;&gt; [FIN, ACK] Seq=1129 Ack=7973 Win=42368 Len=0 TSval=2672613945
</I>&gt;&gt;&gt;<i>       &gt;&gt; TSecr=1443490937
</I>&gt;&gt;&gt;<i>       &gt;&gt;    595 67.664895660 100.113.27.73 &#8594; 100.121.10.169 TCP 66 3128 &#8594;
</I>&gt;&gt;&gt;<i>      52202
</I>&gt;&gt;&gt;<i>       &gt;&gt; [RST, ACK] Seq=7973 Ack=1129 Win=42752 Len=0 TSval=1443490937
</I>&gt;&gt;&gt;<i>       &gt;&gt; TSecr=2672613945
</I>&gt;&gt;&gt;<i>       &gt;&gt;    596 67.664936264 100.113.27.73 &#8594; 100.121.10.169 TCP 54 3128 &#8594;
</I>&gt;&gt;&gt;<i>      52202
</I>&gt;&gt;&gt;<i>       &gt;&gt; [RST] Seq=7973 Win=0 Len=0
</I>&gt;&gt;&gt;<i>       &gt;&gt;
</I>&gt;&gt;&gt;<i>       &gt;&gt; I'm wondering how to debug it (what exactly) and whether the reason
</I>&gt;&gt;&gt;<i>       &gt;&gt; may be on the squid side (specific configuration?).
</I>&gt;&gt;&gt;<i>       &gt;&gt;
</I>&gt;&gt;&gt;<i>       &gt;&gt; env: GKE/k8s
</I>&gt;&gt;&gt;<i>       &gt;&gt; client container: alpine linux
</I>&gt;&gt;&gt;<i>       &gt;&gt; child squid container: alpine linux
</I>&gt;&gt;&gt;<i>       &gt;&gt; version: 5.7
</I>&gt;&gt;&gt;<i>       &gt;&gt;
</I>&gt;&gt;&gt;<i>       &gt;&gt; Cheers,
</I>&gt;&gt;&gt;<i>       &gt;&gt; Maciek Leks
</I>&gt;&gt;&gt;<i>       &gt; _______________________________________________
</I>&gt;&gt;&gt;<i>       &gt; squid-users mailing list
</I>&gt;&gt;&gt;<i>       &gt; <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;&gt;&gt;<i>      &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>&gt;
</I>&gt;&gt;&gt;<i>       &gt; <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;&gt;&gt;<i>      &lt;<A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>&gt;
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>      _______________________________________________
</I>&gt;&gt;&gt;<i>      squid-users mailing list
</I>&gt;&gt;&gt;<i>      <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;&gt;&gt;<i>      &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>&gt;
</I>&gt;&gt;&gt;<i>      <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;&gt;&gt;<i>      &lt;<A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>&gt;
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;&gt;<i> squid-users mailing list
</I>&gt;&gt;&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;&gt;&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;<i> squid-users mailing list
</I>&gt;&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="025671.html">[squid-users] client-&gt;Squid: TCP [RST] and [RST,ACK]
</A></li>
	<LI>Next message (by thread): <A HREF="025673.html">[squid-users] client-&gt;Squid: TCP [RST] and [RST,ACK]
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25672">[ date ]</a>
              <a href="thread.html#25672">[ thread ]</a>
              <a href="subject.html#25672">[ subject ]</a>
              <a href="author.html#25672">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
