From rousskov at measurement-factory.com  Sun Jan  1 17:30:42 2023
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Sun, 1 Jan 2023 12:30:42 -0500
Subject: [squid-users] Squid log shows peer_response_time = 0 and status
 is 200
In-Reply-To: <CAMzzUS6qRE0opFgswWg3MRc+j85sQD9Ud50-Fd4FAquzDKbu=Q@mail.gmail.com>
References: <CAMzzUS6Y3Tai02of=+aopgJdcxg1AM9BWQiz3JqEUHwyp0_NRw@mail.gmail.com>
 <51d6dde5-d0b9-4d7d-a47f-cd17dfe7d1ab@measurement-factory.com>
 <CAMzzUS6qRE0opFgswWg3MRc+j85sQD9Ud50-Fd4FAquzDKbu=Q@mail.gmail.com>
Message-ID: <29825585-90df-dd66-41ea-8f97f5586438@measurement-factory.com>

On 12/30/22 12:29, Raghav P wrote:
> Thank you Alex.
> 
> We modified the log format as per your suggestion and here is the 
> relevant log entries (its been parsed) for one such log entry
> 
>  ? "http_method": "CONNECT",
>  ? "request_method_from_client": "CONNECT",
>  ? "request_method_to_server": "CONNECT",
>  ? "status": 200,
>  ? "vendor_action": "TCP_TUNNEL",
>  ? "err_code": "-",
>  ? "err_detail": "-",
>  ? "dest_status": "HIER_DIRECT",
>  ? "response_time": 8612,
>  ? "total_time_milliseconds": 8608,
>  ? "peer_response_time": 0,
>  ? "http_content_type": "-",
>  ? "bytes": 13071,
>  ? "bytes_in": 5373,
>  ? "bytes_out": 7698,
>  ? "sni": "-",
>  ? "X-Forwarded-For": "-"

Several use cases might result in the above combination of fields, but I 
think the following one is the most likely:

* Squid successfully opened an HTTP CONNECT tunnel to the origin server.

* The client and the origin server exchanged some data.

* The client was either the last to send data or it sent data during the 
same millisecond when Squid received the last data from the server.

In this use case, we see a clash between %<pt definition that was based 
on a basic GET request exchange (client sends TCP payload then server 
sends TCP payload) and the way HTTP CONNECT tunnels usually function 
when forwarding encrypted traffic (both sides send TCP data from time to 
time):

> [http::]<pt Peer response time in milliseconds. The timer starts
> when the last request byte is sent to the next hop
> and stops when the last response byte is received.

The above definition makes %<pt measurements useless in many CONNECT 
tunnel cases. There is even a source code comment about that: "The peer 
response time (%<pt) stopwatch is currently defined to start when we 
wrote the entire request. Thus, if we wrote something after the last 
read, report zero peer response time." In this case, "we wrote" means 
"we forwarded client bytes to the server" and "the last read" means "the 
last read from the origin server".


HTH,

Alex.


> On Fri, Dec 30, 2022 at 4:01 AM Alex Rousskov 
> <rousskov at measurement-factory.com 
> <mailto:rousskov at measurement-factory.com>> wrote:
> 
>     On 12/29/22 16:17, Raghav P wrote:
>      > We have a squid proxy configured as a forward proxy. But we see
>     that for
>      > some requests the log shows peer_response_time =0 but has status
>     is 200.
>      > At times users on their browser see this as a page not loading.
>      >
>      > As we couldn't find documentation around this. We wish to know
>     what this
>      > actually means and if this is an issue how to resolve it.
> 
>     It is difficult to say for sure what is going on without a lot more
>     details, but it is likely that Squid experienced some kind of an error
>     after receiving the beginning of a 200 OK response from the peer. I am
>     guessing that when handling certain kinds of errors, Squid may
>     forget to
>     update the transaction response time clock and log zero. It is also
>     possible, in some environments, that the transaction took less than one
>     millisecond.
> 
>     I recommend configuring Squid to log all the standard fields in "squid"
>     logformat, including %Ss (you probably log that already) and to add
>     %err_code/%err_detail fields (you probably do not log those now). Share
>     the values of those three specific fields (at least) with this mailing
>     list. In general, the more logged fields you can share, the higher are
>     the chances that somebody here will know what is going on with those
>     transactions.
> 
>     You may also want to mention whether these transactions are HTTP or
>     HTTPS, and, if HTTPS, whether your Squid has ssl_bump rules for those
>     transactions.
> 
> 
>     HTH,
> 
>     Alex.
> 
>     _______________________________________________
>     squid-users mailing list
>     squid-users at lists.squid-cache.org
>     <mailto:squid-users at lists.squid-cache.org>
>     http://lists.squid-cache.org/listinfo/squid-users
>     <http://lists.squid-cache.org/listinfo/squid-users>
> 



From admin at eduaicta.ro  Mon Jan  2 13:56:21 2023
From: admin at eduaicta.ro (Avram-Teodor Berindeie)
Date: Mon, 2 Jan 2023 15:56:21 +0200
Subject: [squid-users] e-CAP future development
Message-ID: <CAOsGNXyRju-PC3e5OMGSFExkB+bgADU7Ud1n=Ui9dr30zDP=vw@mail.gmail.com>

I don't have a Launchpad account so I'll post my question here.
I have been using SOPHOS SAVDI as an ICAP server for Squid for about 2
years (quite successfully).
http://lists.squid-cache.org/pipermail/squid-users/2020-January/021620.html
The problem is that SOPHOS SAVDI entered EOL and I can't really use it
anymore.
The only viable alternatives I have found so far are:
1. Kaspersky Scan Engine in ICAP mode with Squid
<https://support.kaspersky.com/ScanEngine/1.0/en-US/179904.htm>;
2. Dr.Web for UNIX Internet Gateways with Squid
<https://download.geo.drweb.com/pub/drweb/unix/gateway/11.0/documentation/html/en/index.html?dw_9_squid_integration.htm>
.
These two were a solution until the government of my country passed a law
restricting the use of Russian products due to the current political and
military context (the war in Ukraine).
In an attempt to find a solution, I installed libecap and Securepoint eCAP
antivirus adapter <https://github.com/Securepoint/squid-ecap-av/tree/master>
.
The solution works, but due to the problems related to the scanning speed
<https://github.com/Cisco-Talos/clamav/issues/590> for Clamav 1.0.0, it is
still a variant to be tested.
And now after the end of the presentation, I would like to know what is
expected regarding the further development of eCAP, considering that
libecap-1.0.1 was launched in 2015.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230102/0cf54a0a/attachment.htm>

From squid3 at treenet.co.nz  Mon Jan  2 16:04:03 2023
From: squid3 at treenet.co.nz (=?UTF-8?B?4oCqQW1vcyBKZWZmcmllc+KArA==?=)
Date: Tue, 03 Jan 2023 05:04:03 +1300
Subject: [squid-users] e-CAP future development
References: <CAOsGNXyRju-PC3e5OMGSFExkB+bgADU7Ud1n=Ui9dr30zDP=vw@mail.gmail.com>
Message-ID: <-fu60ib-7aqxv3z7fun2-ur44z9s1te0sxdjubz-2crzdx-ftlv1jbc78u5wq5gw5-3ym90c-30kf1w-y313ro-adxvv48bgusfwumr6b2p6cka-l05dpb-n7ovly-hvvwp1odp8g8-b2dh7jhjl5dksvwm1b.1672675058191@email.android.com>

An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230103/3cca403c/attachment.htm>

From rousskov at measurement-factory.com  Mon Jan  2 16:24:59 2023
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Mon, 2 Jan 2023 11:24:59 -0500
Subject: [squid-users] e-CAP future development
In-Reply-To: <CAOsGNXyRju-PC3e5OMGSFExkB+bgADU7Ud1n=Ui9dr30zDP=vw@mail.gmail.com>
References: <CAOsGNXyRju-PC3e5OMGSFExkB+bgADU7Ud1n=Ui9dr30zDP=vw@mail.gmail.com>
Message-ID: <2ac8462a-ae32-606d-6189-746e53c1034b@measurement-factory.com>

On 1/2/23 08:56, Avram-Teodor Berindeie wrote:
> I would like to know what is 
> expected regarding the further development of eCAP

There are at least two changes that should happen to eCAP:

1. Removal of used-to-be-experimental C++ APIs from official 
declarations: https://bugs.launchpad.net/ecap/+bug/1595488

2. Replacement of the current API with a much simpler/better one.

AFAICT: Distros took care of #1 (but we should still do a corresponding 
official update). There is currently not enough demand to do #2.


HTH,

Alex.



From admin at eduaicta.ro  Mon Jan  2 18:44:42 2023
From: admin at eduaicta.ro (Avram-Teodor Berindeie)
Date: Mon, 2 Jan 2023 20:44:42 +0200
Subject: [squid-users] e-CAP future development
In-Reply-To: <CAOsGNXxM9c=e9g3qfu=a2u_Vu5fhvHi+Gt+Mpvbyyt4wF6p7qw@mail.gmail.com>
References: <CAOsGNXyRju-PC3e5OMGSFExkB+bgADU7Ud1n=Ui9dr30zDP=vw@mail.gmail.com>
 <2ac8462a-ae32-606d-6189-746e53c1034b@measurement-factory.com>
 <CAOsGNXxM9c=e9g3qfu=a2u_Vu5fhvHi+Gt+Mpvbyyt4wF6p7qw@mail.gmail.com>
Message-ID: <CAOsGNXxVuSEtpvyAQDfow0g8ebvpNpRyRVTX2ac5wL0AMP=S0g@mail.gmail.com>

So there will be a libecap 1.1
<https://bugs.launchpad.net/ecap/+bug/1595488/comments/5> someday!
In my environment I use ICAP and I hope to be able to use eCAP as well, but
for that a new version of libecap would be good and of course the Clamav to
solve the problem related to the scanning speed.

On Mon, Jan 2, 2023 at 6:25 PM Alex Rousskov <
rousskov at measurement-factory.com> wrote:

> On 1/2/23 08:56, Avram-Teodor Berindeie wrote:
> > I would like to know what is
> > expected regarding the further development of eCAP
>
> There are at least two changes that should happen to eCAP:
>
> 1. Removal of used-to-be-experimental C++ APIs from official
> declarations: https://bugs.launchpad.net/ecap/+bug/1595488
>
> 2. Replacement of the current API with a much simpler/better one.
>
> AFAICT: Distros took care of #1 (but we should still do a corresponding
> official update). There is currently not enough demand to do #2.
>
>
> HTH,
>
> Alex.
>
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230102/b37485cb/attachment.htm>

From rousskov at measurement-factory.com  Mon Jan  2 19:06:07 2023
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Mon, 2 Jan 2023 14:06:07 -0500
Subject: [squid-users] e-CAP future development
In-Reply-To: <CAOsGNXxVuSEtpvyAQDfow0g8ebvpNpRyRVTX2ac5wL0AMP=S0g@mail.gmail.com>
References: <CAOsGNXyRju-PC3e5OMGSFExkB+bgADU7Ud1n=Ui9dr30zDP=vw@mail.gmail.com>
 <2ac8462a-ae32-606d-6189-746e53c1034b@measurement-factory.com>
 <CAOsGNXxM9c=e9g3qfu=a2u_Vu5fhvHi+Gt+Mpvbyyt4wF6p7qw@mail.gmail.com>
 <CAOsGNXxVuSEtpvyAQDfow0g8ebvpNpRyRVTX2ac5wL0AMP=S0g@mail.gmail.com>
Message-ID: <f33ded79-9046-a814-f550-f09f63225eb5@measurement-factory.com>

On 1/2/23 13:44, Avram-Teodor Berindeie wrote:
> So there will be a libecap 1.1 
> <https://bugs.launchpad.net/ecap/+bug/1595488/comments/5> someday!

That is difficult to predict IMO. There should be libecap v2 someday, 
but whether that will actually happen, and whether there will be a v1.1 
release before that, I do not know.


> In my environment I use ICAP and I hope to be able to use eCAP as well, 
> but for that a new version of libecap would be good and of course the 
> Clamav to solve the problem related to the scanning speed.

Most folks would not benefit from a a minor libecap release (directly) 
-- they can just use the library provided in your distro already. There 
is demand for ClamAV improvements indeed, but those improvements can 
happen using the existing libecap code.


Cheers,

Alex.


> On Mon, Jan 2, 2023 at 6:25 PM Alex Rousskov wrote:
> 
>     On 1/2/23 08:56, Avram-Teodor Berindeie wrote:
>      > I would like to know what is
>      > expected regarding the further development of eCAP
> 
>     There are at least two changes that should happen to eCAP:
> 
>     1. Removal of used-to-be-experimental C++ APIs from official
>     declarations: https://bugs.launchpad.net/ecap/+bug/1595488
>     <https://bugs.launchpad.net/ecap/+bug/1595488>
> 
>     2. Replacement of the current API with a much simpler/better one.
> 
>     AFAICT: Distros took care of #1 (but we should still do a corresponding
>     official update). There is currently not enough demand to do #2.
> 
> 
>     HTH,
> 
>     Alex.




From admin at eduaicta.ro  Wed Jan 11 10:17:52 2023
From: admin at eduaicta.ro (Avram-Teodor Berindeie)
Date: Wed, 11 Jan 2023 12:17:52 +0200
Subject: [squid-users] e-CAP future development
Message-ID: <CAOsGNXyKXZEp4hdGQOYOsDkCHkRJcPfgO49XkFs0fsFv5U1WQQ@mail.gmail.com>

"That is difficult to predict IMO. There should be libecap v2 someday,
but whether that will actually happen, and whether there will be a v1.1
release before that, I do not know."

Does this mean libecap v2 for Squid 6 with C++17?
Maybe there won't be libecap v1.1 for Squid 5 with C++11?
Anyway, Squid with support for eCAP + Clamav will be one of the
solutions to consider and I intend to use it.
I am currently testing libecap 1.0.1 (C++11) + Securepoint eCAP
antivirus adapter v1.0.14 (C++11) + Clamav 1.0.0 + Squid 5.7 (C++11)
and the only problem is the dizzying scan speed of Clamav.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230111/f5ebf88c/attachment.htm>

From robertkwild at gmail.com  Wed Jan 11 20:10:12 2023
From: robertkwild at gmail.com (robert k Wild)
Date: Wed, 11 Jan 2023 20:10:12 +0000
Subject: [squid-users] eicar website not reachable
Message-ID: <CAGU_Ci+W6xjiVsQ_6ZUX5eD40OfaheN0aZqSEuCm9dFwZxiD7A@mail.gmail.com>

hi all,

i have made a whitelist to go to some website, atm i have temp commented
out #http_access deny to go to any website

when i browse the web i can go on gmail,o365,hsbc,facebook etc

but when i try to go to "eicar.org" i get the following error

The following error was encountered while trying to retrieve the URL:
https://www.eicar.org/*

*Connection to 2a00:1828:1000:2497::2 failed.*

The system returned: *(101) Network is unreachable*

The remote host or network may be down. Please try the request again.

Your cache administrator is webmaster
<webmaster?subject=CacheErrorInfo%20-%20ERR_CONNECT_FAIL&body=CacheHost%3A%20localhost.localdomain%0D%0AErrPage%3A%20ERR_CONNECT_FAIL%0D%0AErr%3A%20(101)%20Network%20is%20unreachable%0D%0ATimeStamp%3A%20Wed,%2011%20Jan%202023%2020%3A08%3A22%20GMT%0D%0A%0D%0AClientIP%3A%2010.100.1.10%0D%0AServerIP%3A%20www.eicar.org%0D%0A%0D%0AHTTP%20Request%3A%0D%0ACONNECT%20%20HTTP%2F1.1%0AUser-Agent%3A%20Mozilla%2F5.0%20(Windows%20NT%2010.0%3B%20Win64%3B%20x64%3B%20rv%3A108.0)%20Gecko%2F20100101%20Firefox%2F108.0%0D%0AProxy-Connection%3A%20keep-alive%0D%0AConnection%3A%20keep-alive%0D%0AHost%3A%20www.eicar.org%3A443%0D%0A%0D%0A%0D%0A>
.

im running squid 5.7

any help would be greatly appreciated
thanks,
rob

-- 
Regards,

Robert K Wild.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230111/c2283a41/attachment.htm>

From robertkwild at gmail.com  Thu Jan 12 15:22:21 2023
From: robertkwild at gmail.com (robert k Wild)
Date: Thu, 12 Jan 2023 15:22:21 +0000
Subject: [squid-users] server_name_regex acl doesnt work anymore
Message-ID: <CAGU_Ci+_yLUubMRwOV9OT++p-DtQ9U-Pw-VTn=ryyRYgnemPFQ@mail.gmail.com>

hi all,

i have no idea why but my acl for url whitelist doesnt work anymore

this is the output of my parse

/usr/local/squid/sbin/squid -k parse
2023/01/12 15:10:56| Startup: Initializing Authentication Schemes ...
2023/01/12 15:10:56| Startup: Initialized Authentication Scheme 'basic'
2023/01/12 15:10:56| Startup: Initialized Authentication Scheme 'digest'
2023/01/12 15:10:56| Startup: Initialized Authentication Scheme 'negotiate'
2023/01/12 15:10:56| Startup: Initialized Authentication Scheme 'ntlm'
2023/01/12 15:10:56| Startup: Initialized Authentication.
2023/01/12 15:10:56| Processing Configuration File:
/usr/local/squid/etc/squid.conf (depth 0)
2023/01/12 15:10:56| Processing: acl localnet src 0.0.0.1-0.255.255.255 #
RFC 1122 "this" network (LAN)
2023/01/12 15:10:56| Processing: acl localnet src 10.0.0.0/8            #
RFC 1918 local private network (LAN)
2023/01/12 15:10:56| Processing: acl localnet src 100.64.0.0/10         #
RFC 6598 shared address space (CGN)
2023/01/12 15:10:56| Processing: acl localnet src 169.254.0.0/16        #
RFC 3927 link-local (directly plugged) machines
2023/01/12 15:10:56| Processing: acl localnet src 172.16.0.0/12         #
RFC 1918 local private network (LAN)
2023/01/12 15:10:56| Processing: acl localnet src 192.168.0.0/16
     # RFC 1918 local private network (LAN)
2023/01/12 15:10:56| Processing: acl localnet src fc00::/7              #
RFC 4193 local private network range
2023/01/12 15:10:56| Processing: acl localnet src fe80::/10             #
RFC 4291 link-local (directly plugged) machines
2023/01/12 15:10:56| Processing: acl SSL_ports port 443
2023/01/12 15:10:56| Processing: acl Safe_ports port 80         # http
2023/01/12 15:10:56| Processing: acl Safe_ports port 21         # ftp
2023/01/12 15:10:56| Processing: acl Safe_ports port 443                #
https
2023/01/12 15:10:56| Processing: acl Safe_ports port 70         # gopher
2023/01/12 15:10:56| Processing: acl Safe_ports port 210                #
wais
2023/01/12 15:10:56| Processing: acl Safe_ports port 1025-65535 #
unregistered ports
2023/01/12 15:10:56| Processing: acl Safe_ports port 280                #
http-mgmt
2023/01/12 15:10:56| Processing: acl Safe_ports port 488                #
gss-http
2023/01/12 15:10:56| Processing: acl Safe_ports port 591                #
filemaker
2023/01/12 15:10:56| Processing: acl Safe_ports port 777                #
multiling http
2023/01/12 15:10:56| Processing: acl CONNECT method CONNECT
2023/01/12 15:10:56| Processing: http_access allow localhost manager
2023/01/12 15:10:56| Processing: http_access deny manager
2023/01/12 15:10:56| Processing: include
/usr/local/squid/etc/squidrules.conf
2023/01/12 15:10:56| Processing Configuration File:
/usr/local/squid/etc/squidrules.conf (depth 1)
2023/01/12 15:10:56| Processing: acl DiscoverSNIHost at_step SslBump1
2023/01/12 15:10:56| Processing: acl NoSSLIntercept ssl::server_name_regex
/usr/local/squid/etc/pubkey.txt
2023/01/12 15:10:56| Processing: ssl_bump peek DiscoverSNIHost
2023/01/12 15:10:56| Processing: ssl_bump splice NoSSLIntercept
2023/01/12 15:10:56| Processing: ssl_bump bump all
2023/01/12 15:10:56| Processing: http_port 3128 ssl-bump
cert=/usr/local/squid/etc/ssl_cert/myCA.pem generate-host-certificates=on
dynamic_cert_mem_cache_size=4MB
2023/01/12 15:10:56| Processing: sslcrtd_program
/usr/local/squid/libexec/security_file_certgen -s /var/lib/ssl_db -M 4MB
2023/01/12 15:10:56| Processing: acl upmime req_mime_type
/usr/local/squid/etc/mimedeny.txt
2023/01/12 15:10:56| Processing: acl url_links url_regex
/usr/local/squid/etc/linksurl.txt
2023/01/12 15:10:56| Processing: acl special_url url_regex
/usr/local/squid/etc/urlspecial.txt
2023/01/12 15:10:56| Processing: acl downmime rep_mime_type
/usr/local/squid/etc/mimedeny.txt
2023/01/12 15:10:56| Processing: http_reply_access allow special_url
2023/01/12 15:10:56| Processing: http_reply_access deny downmime
2023/01/12 15:10:56| Processing: acl whitelist ssl::server_name_regex
/usr/local/squid/etc/urlwhite.txt
2023/01/12 15:10:56| Processing: acl activation port 80 443
2023/01/12 15:10:56| Processing: http_access allow activation whitelist
2023/01/12 15:10:56| Processing: http_access deny all
2023/01/12 15:10:56| Processing: http_access allow localnet
2023/01/12 15:10:56| Processing: http_access allow localhost
2023/01/12 15:10:56| Processing: http_access deny all
2023/01/12 15:10:56| Processing: coredump_dir
/usr/local/squid/var/cache/squid
2023/01/12 15:10:56| Processing: refresh_pattern ^ftp:          1440    20%
    10080
2023/01/12 15:10:56| Processing: refresh_pattern ^gopher:       1440    0%
     1440
2023/01/12 15:10:56| Processing: refresh_pattern -i (/cgi-bin/|\?) 0    0%
     0
2023/01/12 15:10:56| Processing: refresh_pattern .              0       20%
    4320
2023/01/12 15:10:56| Processing: icap_enable on
2023/01/12 15:10:56| Processing: adaptation_uses_indirect_client on
2023/01/12 15:10:56| Processing: icap_send_client_ip on
2023/01/12 15:10:56| Processing: icap_send_client_username on
2023/01/12 15:10:56| Processing: icap_client_username_header
X-Authenticated-User
2023/01/12 15:10:56| Processing: icap_service service_req reqmod_precache
bypass=0 icap://127.0.0.1:1344/squidclamav
2023/01/12 15:10:56| Processing: adaptation_access service_req allow all
2023/01/12 15:10:56| Processing: icap_service service_resp respmod_precache
bypass=0 icap://127.0.0.1:1344/squidclamav
2023/01/12 15:10:56| Processing: adaptation_access service_resp allow all
2023/01/12 15:10:56| Initializing https:// proxy context
2023/01/12 15:10:56| Initializing http_port [::]:3128 TLS contexts
2023/01/12 15:10:56| Using certificate in
/usr/local/squid/etc/ssl_cert/myCA.pem
2023/01/12 15:10:56| Using certificate chain in
/usr/local/squid/etc/ssl_cert/myCA.pem
2023/01/12 15:10:56| Adding issuer CA: /C=XX/L=Default City/O=Default
Company Ltd
2023/01/12 15:10:56| Using key in /usr/local/squid/etc/ssl_cert/myCA.pem

acl whitelist ssl::server_name_regex /usr/local/squid/etc/urlwhite.txt

and in the url whitelist file is adobe.com

(^|\.)adobe.com$

but when i try to access on my browser "adobe.com" i get the proxy access
denied page

can anyone shed some light as im struggling to sort this out

thanks,
rob

-- 
Regards,

Robert K Wild.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230112/8e5faa55/attachment.htm>

From robertkwild at gmail.com  Thu Jan 12 16:09:41 2023
From: robertkwild at gmail.com (robert k Wild)
Date: Thu, 12 Jan 2023 16:09:41 +0000
Subject: [squid-users] server_name_regex acl doesnt work anymore
In-Reply-To: <CAGU_Ci+_yLUubMRwOV9OT++p-DtQ9U-Pw-VTn=ryyRYgnemPFQ@mail.gmail.com>
References: <CAGU_Ci+_yLUubMRwOV9OT++p-DtQ9U-Pw-VTn=ryyRYgnemPFQ@mail.gmail.com>
Message-ID: <CAGU_CiJ686YnbE8qcMzqQXvvFHAvR+KUHvwcTNMVhuR1MYOk8g@mail.gmail.com>

I've sorted it, I had to put quotes around my file path to the URL whitelist

On Thu, 12 Jan 2023, 15:22 robert k Wild, <robertkwild at gmail.com> wrote:

> hi all,
>
> i have no idea why but my acl for url whitelist doesnt work anymore
>
> this is the output of my parse
>
> /usr/local/squid/sbin/squid -k parse
> 2023/01/12 15:10:56| Startup: Initializing Authentication Schemes ...
> 2023/01/12 15:10:56| Startup: Initialized Authentication Scheme 'basic'
> 2023/01/12 15:10:56| Startup: Initialized Authentication Scheme 'digest'
> 2023/01/12 15:10:56| Startup: Initialized Authentication Scheme 'negotiate'
> 2023/01/12 15:10:56| Startup: Initialized Authentication Scheme 'ntlm'
> 2023/01/12 15:10:56| Startup: Initialized Authentication.
> 2023/01/12 15:10:56| Processing Configuration File:
> /usr/local/squid/etc/squid.conf (depth 0)
> 2023/01/12 15:10:56| Processing: acl localnet src 0.0.0.1-0.255.255.255 #
> RFC 1122 "this" network (LAN)
> 2023/01/12 15:10:56| Processing: acl localnet src 10.0.0.0/8            #
> RFC 1918 local private network (LAN)
> 2023/01/12 15:10:56| Processing: acl localnet src 100.64.0.0/10         #
> RFC 6598 shared address space (CGN)
> 2023/01/12 15:10:56| Processing: acl localnet src 169.254.0.0/16        #
> RFC 3927 link-local (directly plugged) machines
> 2023/01/12 15:10:56| Processing: acl localnet src 172.16.0.0/12         #
> RFC 1918 local private network (LAN)
> 2023/01/12 15:10:56| Processing: acl localnet src 192.168.0.0/16
>        # RFC 1918 local private network (LAN)
> 2023/01/12 15:10:56| Processing: acl localnet src fc00::/7              #
> RFC 4193 local private network range
> 2023/01/12 15:10:56| Processing: acl localnet src fe80::/10             #
> RFC 4291 link-local (directly plugged) machines
> 2023/01/12 15:10:56| Processing: acl SSL_ports port 443
> 2023/01/12 15:10:56| Processing: acl Safe_ports port 80         # http
> 2023/01/12 15:10:56| Processing: acl Safe_ports port 21         # ftp
> 2023/01/12 15:10:56| Processing: acl Safe_ports port 443                #
> https
> 2023/01/12 15:10:56| Processing: acl Safe_ports port 70         # gopher
> 2023/01/12 15:10:56| Processing: acl Safe_ports port 210                #
> wais
> 2023/01/12 15:10:56| Processing: acl Safe_ports port 1025-65535 #
> unregistered ports
> 2023/01/12 15:10:56| Processing: acl Safe_ports port 280                #
> http-mgmt
> 2023/01/12 15:10:56| Processing: acl Safe_ports port 488                #
> gss-http
> 2023/01/12 15:10:56| Processing: acl Safe_ports port 591                #
> filemaker
> 2023/01/12 15:10:56| Processing: acl Safe_ports port 777                #
> multiling http
> 2023/01/12 15:10:56| Processing: acl CONNECT method CONNECT
> 2023/01/12 15:10:56| Processing: http_access allow localhost manager
> 2023/01/12 15:10:56| Processing: http_access deny manager
> 2023/01/12 15:10:56| Processing: include
> /usr/local/squid/etc/squidrules.conf
> 2023/01/12 15:10:56| Processing Configuration File:
> /usr/local/squid/etc/squidrules.conf (depth 1)
> 2023/01/12 15:10:56| Processing: acl DiscoverSNIHost at_step SslBump1
> 2023/01/12 15:10:56| Processing: acl NoSSLIntercept ssl::server_name_regex
> /usr/local/squid/etc/pubkey.txt
> 2023/01/12 15:10:56| Processing: ssl_bump peek DiscoverSNIHost
> 2023/01/12 15:10:56| Processing: ssl_bump splice NoSSLIntercept
> 2023/01/12 15:10:56| Processing: ssl_bump bump all
> 2023/01/12 15:10:56| Processing: http_port 3128 ssl-bump
> cert=/usr/local/squid/etc/ssl_cert/myCA.pem generate-host-certificates=on
> dynamic_cert_mem_cache_size=4MB
> 2023/01/12 15:10:56| Processing: sslcrtd_program
> /usr/local/squid/libexec/security_file_certgen -s /var/lib/ssl_db -M 4MB
> 2023/01/12 15:10:56| Processing: acl upmime req_mime_type
> /usr/local/squid/etc/mimedeny.txt
> 2023/01/12 15:10:56| Processing: acl url_links url_regex
> /usr/local/squid/etc/linksurl.txt
> 2023/01/12 15:10:56| Processing: acl special_url url_regex
> /usr/local/squid/etc/urlspecial.txt
> 2023/01/12 15:10:56| Processing: acl downmime rep_mime_type
> /usr/local/squid/etc/mimedeny.txt
> 2023/01/12 15:10:56| Processing: http_reply_access allow special_url
> 2023/01/12 15:10:56| Processing: http_reply_access deny downmime
> 2023/01/12 15:10:56| Processing: acl whitelist ssl::server_name_regex
> /usr/local/squid/etc/urlwhite.txt
> 2023/01/12 15:10:56| Processing: acl activation port 80 443
> 2023/01/12 15:10:56| Processing: http_access allow activation whitelist
> 2023/01/12 15:10:56| Processing: http_access deny all
> 2023/01/12 15:10:56| Processing: http_access allow localnet
> 2023/01/12 15:10:56| Processing: http_access allow localhost
> 2023/01/12 15:10:56| Processing: http_access deny all
> 2023/01/12 15:10:56| Processing: coredump_dir
> /usr/local/squid/var/cache/squid
> 2023/01/12 15:10:56| Processing: refresh_pattern ^ftp:          1440
>  20%     10080
> 2023/01/12 15:10:56| Processing: refresh_pattern ^gopher:       1440    0%
>      1440
> 2023/01/12 15:10:56| Processing: refresh_pattern -i (/cgi-bin/|\?) 0    0%
>      0
> 2023/01/12 15:10:56| Processing: refresh_pattern .              0
> 20%     4320
> 2023/01/12 15:10:56| Processing: icap_enable on
> 2023/01/12 15:10:56| Processing: adaptation_uses_indirect_client on
> 2023/01/12 15:10:56| Processing: icap_send_client_ip on
> 2023/01/12 15:10:56| Processing: icap_send_client_username on
> 2023/01/12 15:10:56| Processing: icap_client_username_header
> X-Authenticated-User
> 2023/01/12 15:10:56| Processing: icap_service service_req reqmod_precache
> bypass=0 icap://127.0.0.1:1344/squidclamav
> 2023/01/12 15:10:56| Processing: adaptation_access service_req allow all
> 2023/01/12 15:10:56| Processing: icap_service service_resp
> respmod_precache bypass=0 icap://127.0.0.1:1344/squidclamav
> 2023/01/12 15:10:56| Processing: adaptation_access service_resp allow all
> 2023/01/12 15:10:56| Initializing https:// proxy context
> 2023/01/12 15:10:56| Initializing http_port [::]:3128 TLS contexts
> 2023/01/12 15:10:56| Using certificate in
> /usr/local/squid/etc/ssl_cert/myCA.pem
> 2023/01/12 15:10:56| Using certificate chain in
> /usr/local/squid/etc/ssl_cert/myCA.pem
> 2023/01/12 15:10:56| Adding issuer CA: /C=XX/L=Default City/O=Default
> Company Ltd
> 2023/01/12 15:10:56| Using key in /usr/local/squid/etc/ssl_cert/myCA.pem
>
> acl whitelist ssl::server_name_regex /usr/local/squid/etc/urlwhite.txt
>
> and in the url whitelist file is adobe.com
>
> (^|\.)adobe.com$
>
> but when i try to access on my browser "adobe.com" i get the proxy access
> denied page
>
> can anyone shed some light as im struggling to sort this out
>
> thanks,
> rob
>
> --
> Regards,
>
> Robert K Wild.
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230112/3b75ee86/attachment.htm>

From rousskov at measurement-factory.com  Thu Jan 12 17:10:17 2023
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Thu, 12 Jan 2023 12:10:17 -0500
Subject: [squid-users] server_name_regex acl doesnt work anymore
In-Reply-To: <CAGU_CiJ686YnbE8qcMzqQXvvFHAvR+KUHvwcTNMVhuR1MYOk8g@mail.gmail.com>
References: <CAGU_Ci+_yLUubMRwOV9OT++p-DtQ9U-Pw-VTn=ryyRYgnemPFQ@mail.gmail.com>
 <CAGU_CiJ686YnbE8qcMzqQXvvFHAvR+KUHvwcTNMVhuR1MYOk8g@mail.gmail.com>
Message-ID: <87893720-5fd2-6726-fc5c-9000f2e0e7cf@measurement-factory.com>

On 1/12/23 11:09, robert k Wild wrote:
> I've sorted it, I had to put quotes around my file path to the URL whitelist

Glad you found the problem! I hope that somebody adds a warning about 
suspected filenames in ACL parameter values.

Alex.


> On Thu, 12 Jan 2023, 15:22 robert k Wild wrote:
> 
> acl whitelist ssl::server_name_regex /usr/local/squid/etc/urlwhite.txt




From andre.bolinhas at articatech.com  Thu Jan 12 17:37:45 2023
From: andre.bolinhas at articatech.com (andre.bolinhas at articatech.com)
Date: Thu, 12 Jan 2023 17:37:45 -0000
Subject: [squid-users] SSLBUMP for specific domains
Message-ID: <!&!AAAAAAAAAAAuAAAAAAAAAIVNjRjcTGZElYgADq7oyvYBAMO2jhD3dRHOtM0AqgC7tuYAAAAAAA4AABAAAADcFbMUZxTHSLrHYYF78z9zAQAAAAA=@articatech.com>

Hi

It's possible configure squid to intercept ssl traffic just for a group of
domain and leave the all of rest out of ssl interceptation?

If so, can you send me an example of config?

I have try search for this on Google and in forums but I just find config to
intercept all.

 

Best regards

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230112/2b101bd4/attachment.htm>

From squid3 at treenet.co.nz  Thu Jan 12 19:13:25 2023
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Fri, 13 Jan 2023 08:13:25 +1300
Subject: [squid-users] SSLBUMP for specific domains
In-Reply-To: <!&!AAAAAAAAAAAuAAAAAAAAAIVNjRjcTGZElYgADq7oyvYBAMO2jhD3dRHOtM0AqgC7tuYAAAAAAA4AABAAAADcFbMUZxTHSLrHYYF78z9zAQAAAAA=@articatech.com>
References: <!&!AAAAAAAAAAAuAAAAAAAAAIVNjRjcTGZElYgADq7oyvYBAMO2jhD3dRHOtM0AqgC7tuYAAAAAAA4AABAAAADcFbMUZxTHSLrHYYF78z9zAQAAAAA=@articatech.com>
Message-ID: <bd46b556-2f7b-8b98-cb94-8884b9359bfc@treenet.co.nz>

On 13/01/2023 6:37 am, andre.bolinhas wrote:
>
> Hi
>
> It?s possible configure squid to intercept ssl traffic just for a 
> group of domain and leave the all of rest out of ssl interceptation?
>

Yes, with one caveat: that Squid is able to identify the domain/server 
to make the decision.

> If so, can you send me an example of config?
>
> I have try search for this on Google and in forums but I just find 
> config to intercept all.
>

You will find a simple example here:
<https://wiki.squid-cache.org/Features/SslPeekAndSplice#peek-at-sni-and-bump>


Amos



From robertkwild at gmail.com  Thu Jan 12 20:22:38 2023
From: robertkwild at gmail.com (robert k Wild)
Date: Thu, 12 Jan 2023 20:22:38 +0000
Subject: [squid-users] packages for alma linux
Message-ID: <CAGU_CiJa=Ls6cpeW3pFgtdbfPbnbU4wDUN+NFzJ6y0ZrMmJwyA@mail.gmail.com>

hi all,

before i compile squid with ssl bump c-icap, squidclamav i want to get the
pre req packages first, let me know if i have missed any out

#install epel repositry
dnf install -y epel-release

#install squid packages
dnf install -y gcc-c++ gcc g++ binutils make sudo wget tar automake
autoconf perl libxml2-devel libcap-devel openssl openssl-devel

#install clamAV packages
dnf install -y clamd clamav clamav-data clamav-devel clamav-lib
clamav-update

thanks,
rob

-- 
Regards,

Robert K Wild.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230112/1434a579/attachment.htm>

From andre.bolinhas at articatech.com  Thu Jan 12 21:03:14 2023
From: andre.bolinhas at articatech.com (andre.bolinhas at articatech.com)
Date: Thu, 12 Jan 2023 21:03:14 -0000
Subject: [squid-users] SSLBUMP for specific domains
In-Reply-To: <bd46b556-2f7b-8b98-cb94-8884b9359bfc@treenet.co.nz>
References: <!&!AAAAAAAAAAAuAAAAAAAAAIVNjRjcTGZElYgADq7oyvYBAMO2jhD3dRHOtM0AqgC7tuYAAAAAAA4AABAAAADcFbMUZxTHSLrHYYF78z9zAQAAAAA=@articatech.com>
 <bd46b556-2f7b-8b98-cb94-8884b9359bfc@treenet.co.nz>
Message-ID: <!&!AAAAAAAAAAAuAAAAAAAAAIVNjRjcTGZElYgADq7oyvYBAMO2jhD3dRHOtM0AqgC7tuYAAAAAAA4AABAAAAAffT/XKNiMSJYe3HQwwyMDAQAAAAA=@articatech.com>

Hi Amos
Thansk for your quick reply, I have done it as example but now, even the internet surf is ok for all website I get to many TCP_TUNNEL/500  on access.log for all  websites that we are not decrypting

1673531433.924  31315 192.168.60.30 TCP_TUNNEL/500 4096 CONNECT sapo.pt:443 - HIER_DIRECT/213.13.146.142:443 - mac="d6:8b:66:2a:9b:92" accessrule:%20ntlm_white_dstdomain%0D%0Awebfilter:%20pass%0D%0Acategory:%203%0D%0Acategory-name:%20Society%0D%0Aclog:%20cinfo:3-Society;%0D%0A exterr="-|- splice"
1673531433.933  31324 192.168.60.30 TCP_TUNNEL/500 4695 CONNECT sapo.pt:443 - HIER_DIRECT/213.13.146.142:443 - mac="d6:8b:66:2a:9b:92" accessrule:%20ntlm_white_dstdomain%0D%0Awebfilter:%20pass%0D%0Acategory:%203%0D%0Acategory-name:%20Society%0D%0Aclog:%20cinfo:3-Society;%0D%0A exterr="-|- splice"
1673531437.798  35024 192.168.60.30 TCP_TUNNEL/500 76572 CONNECT www.sapo.pt:443 - HIER_DIRECT/213.13.146.142:443 - mac="d6:8b:66:2a:9b:92" accessrule:%20ntlm_white_dstdomain%0D%0Awebfilter:%20pass%0D%0Acategory:%203%0D%0Acategory-name:%20Society%0D%0Aclog:%20cinfo:3-Society;%0D%0A exterr="-|- splice"


-----Mensagem original-----
De: squid-users <squid-users-bounces at lists.squid-cache.org> Em Nome De Amos Jeffries
Enviada: 12 de janeiro de 2023 19:13
Para: squid-users at lists.squid-cache.org
Assunto: Re: [squid-users] SSLBUMP for specific domains

On 13/01/2023 6:37 am, andre.bolinhas wrote:
>
> Hi
>
> It?s possible configure squid to intercept ssl traffic just for a 
> group of domain and leave the all of rest out of ssl interceptation?
>

Yes, with one caveat: that Squid is able to identify the domain/server to make the decision.

> If so, can you send me an example of config?
>
> I have try search for this on Google and in forums but I just find 
> config to intercept all.
>

You will find a simple example here:
<https://wiki.squid-cache.org/Features/SslPeekAndSplice#peek-at-sni-and-bump>


Amos

_______________________________________________
squid-users mailing list
squid-users at lists.squid-cache.org
http://lists.squid-cache.org/listinfo/squid-users



From andre.bolinhas at articatech.com  Thu Jan 12 21:04:43 2023
From: andre.bolinhas at articatech.com (andre.bolinhas at articatech.com)
Date: Thu, 12 Jan 2023 21:04:43 -0000
Subject: [squid-users] SSLBUMP for specific domains
In-Reply-To: <!&!AAAAAAAAAAAuAAAAAAAAAIVNjRjcTGZElYgADq7oyvYBAMO2jhD3dRHOtM0AqgC7tuYAAAAAAA4AABAAAAAffT/XKNiMSJYe3HQwwyMDAQAAAAA=@articatech.com>
References: <!&!AAAAAAAAAAAuAAAAAAAAAIVNjRjcTGZElYgADq7oyvYBAMO2jhD3dRHOtM0AqgC7tuYAAAAAAA4AABAAAADcFbMUZxTHSLrHYYF78z9zAQAAAAA=@articatech.com>
 <bd46b556-2f7b-8b98-cb94-8884b9359bfc@treenet.co.nz>
 <!&!AAAAAAAAAAAuAAAAAAAAAIVNjRjcTGZElYgADq7oyvYBAMO2jhD3dRHOtM0AqgC7tuYAAAAAAA4AABAAAAAffT/XKNiMSJYe3HQwwyMDAQAAAAA=@articatech.com>
Message-ID: <!&!AAAAAAAAAAAuAAAAAAAAAIVNjRjcTGZElYgADq7oyvYBAMO2jhD3dRHOtM0AqgC7tuYAAAAAAA4AABAAAAAXOkifN1NmQbUlttM4hIF4AQAAAAA=@articatech.com>

Forgot to attach the config file

root at proxy01:~# cat /etc/squid3/ssl.conf
# Squid 5.x branch
# SSL used for port ID 1, :3128 on
# Patch 2020 - 08 - 03 SquidMikrotikEnabled = 0
# SSL Proxy options  Proxy version:5.7 [146]
sslcrtd_program /lib/squid3/security_file_certgen -s /media/squidtmpfs/ssl/ssl_db -M 64MB
sslcrtd_children 32 startup=5 idle=1 queue-size=64
acl AnnotateSSLGBW2 annotate_transaction whitelistssl=yes
#The AppStore application in IOS (iPhone, iPad, MacOS) uses SSL Certificate Pinning,
#it means the application knows what certificate to expect when accessing AppStore.
#When you enable SSL Bump of HTTPS connections Squid replaces the default certificate with a ?mimicked? one;
#the application detects that and refuses to function.
#
acl FakeCert ssl::server_name .apple.com
acl FakeCert ssl::server_name .icloud.com
acl FakeCert ssl::server_name .mzstatic.com
acl FakeCert ssl::server_name .dropbox.com
acl FakeCert ssl::server_name .bnpparisbas
acl SSLInternalNets dst 10.0.0.0/8
acl SSLInternalNets dst 172.16.0.0/12
acl SSLInternalNets dst 192.168.0.0/16
acl ssl_step1 at_step SslBump1
acl ssl_step2 at_step SslBump2
acl ssl_step3 at_step SslBump3
include /etc/squid3/ssl_whitelist.conf
ssl_bump peek ssl_step1
acl GlobalWhitelistDSTNet dst "/etc/squid3/acls_whitelist.dst.conf"
ssl_bump splice GlobalWhitelistDSTNet AnnotateSSLGBW2
ssl_bump splice ByPassRBL AnnotateSSLGBW2
ssl_bump splice SSLInternalNets AnnotateSSLGBW2
ssl_bump splice FakeCert AnnotateSSLGBW2
# IMPRIM_RULE:5
ssl_bump splice ByPassRBL AnnotateSSLGBW2
ssl_bump splice GlobalWhitelistDSTNet AnnotateSSLGBW2

# Rules (spliced) added by admins....
# 5 rules...
# -------------- Personal rules -----------------

# id:5
# decrypt_cnn order:0
acl AnnotateSSLW5 annotate_transaction bumprule=5
ssl_bump bump Group26 AnnotateSSLW5
ssl_bump splice all

tls_outgoing_options options=NO_SSLv3,NO_TICKET cipher=ALL:!SSLv2:!SSLv3:!ADH:!DSS:!MD5:!EXP:!DES:!PSK:!SRP:!RC4:!IDEA:!SEED:!aNULL:!eNULL flags=DONT_VERIFY_PEER
sslproxy_cert_error allow all
on_unsupported_protocol tunnel all

-----Mensagem original-----
De: squid-users <squid-users-bounces at lists.squid-cache.org> Em Nome De andre.bolinhas at articatech.com
Enviada: 12 de janeiro de 2023 21:03
Para: 'Amos Jeffries' <squid3 at treenet.co.nz>; squid-users at lists.squid-cache.org
Assunto: Re: [squid-users] SSLBUMP for specific domains

Hi Amos
Thansk for your quick reply, I have done it as example but now, even the internet surf is ok for all website I get to many TCP_TUNNEL/500  on access.log for all  websites that we are not decrypting

1673531433.924  31315 192.168.60.30 TCP_TUNNEL/500 4096 CONNECT sapo.pt:443 - HIER_DIRECT/213.13.146.142:443 - mac="d6:8b:66:2a:9b:92" accessrule:%20ntlm_white_dstdomain%0D%0Awebfilter:%20pass%0D%0Acategory:%203%0D%0Acategory-name:%20Society%0D%0Aclog:%20cinfo:3-Society;%0D%0A exterr="-|- splice"
1673531433.933  31324 192.168.60.30 TCP_TUNNEL/500 4695 CONNECT sapo.pt:443 - HIER_DIRECT/213.13.146.142:443 - mac="d6:8b:66:2a:9b:92" accessrule:%20ntlm_white_dstdomain%0D%0Awebfilter:%20pass%0D%0Acategory:%203%0D%0Acategory-name:%20Society%0D%0Aclog:%20cinfo:3-Society;%0D%0A exterr="-|- splice"
1673531437.798  35024 192.168.60.30 TCP_TUNNEL/500 76572 CONNECT www.sapo.pt:443 - HIER_DIRECT/213.13.146.142:443 - mac="d6:8b:66:2a:9b:92" accessrule:%20ntlm_white_dstdomain%0D%0Awebfilter:%20pass%0D%0Acategory:%203%0D%0Acategory-name:%20Society%0D%0Aclog:%20cinfo:3-Society;%0D%0A exterr="-|- splice"


-----Mensagem original-----
De: squid-users <squid-users-bounces at lists.squid-cache.org> Em Nome De Amos Jeffries
Enviada: 12 de janeiro de 2023 19:13
Para: squid-users at lists.squid-cache.org
Assunto: Re: [squid-users] SSLBUMP for specific domains

On 13/01/2023 6:37 am, andre.bolinhas wrote:
>
> Hi
>
> It?s possible configure squid to intercept ssl traffic just for a 
> group of domain and leave the all of rest out of ssl interceptation?
>

Yes, with one caveat: that Squid is able to identify the domain/server to make the decision.

> If so, can you send me an example of config?
>
> I have try search for this on Google and in forums but I just find 
> config to intercept all.
>

You will find a simple example here:
<https://wiki.squid-cache.org/Features/SslPeekAndSplice#peek-at-sni-and-bump>


Amos

_______________________________________________
squid-users mailing list
squid-users at lists.squid-cache.org
http://lists.squid-cache.org/listinfo/squid-users

_______________________________________________
squid-users mailing list
squid-users at lists.squid-cache.org
http://lists.squid-cache.org/listinfo/squid-users



From squid3 at treenet.co.nz  Thu Jan 12 21:21:58 2023
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Fri, 13 Jan 2023 10:21:58 +1300
Subject: [squid-users] SSLBUMP for specific domains
In-Reply-To: <!&!AAAAAAAAAAAuAAAAAAAAAIVNjRjcTGZElYgADq7oyvYBAMO2jhD3dRHOtM0AqgC7tuYAAAAAAA4AABAAAAAXOkifN1NmQbUlttM4hIF4AQAAAAA=@articatech.com>
References: <!&!AAAAAAAAAAAuAAAAAAAAAIVNjRjcTGZElYgADq7oyvYBAMO2jhD3dRHOtM0AqgC7tuYAAAAAAA4AABAAAADcFbMUZxTHSLrHYYF78z9zAQAAAAA=@articatech.com>
 <bd46b556-2f7b-8b98-cb94-8884b9359bfc@treenet.co.nz>
 <!&!AAAAAAAAAAAuAAAAAAAAAIVNjRjcTGZElYgADq7oyvYBAMO2jhD3dRHOtM0AqgC7tuYAAAAAAA4AABAAAAAffT/XKNiMSJYe3HQwwyMDAQAAAAA=@articatech.com>
 <!&!AAAAAAAAAAAuAAAAAAAAAIVNjRjcTGZElYgADq7oyvYBAMO2jhD3dRHOtM0AqgC7tuYAAAAAAA4AABAAAAAXOkifN1NmQbUlttM4hIF4AQAAAAA=@articatech.com>
Message-ID: <d1552e55-0c59-a3d7-0a3e-6ab24bc09a80@treenet.co.nz>

On 13/01/2023 10:04 am, andre.bolinhas wrote:
> Forgot to attach the config file
>
> root at proxy01:~# cat /etc/squid3/ssl.conf
> # Squid 5.x branch
> # SSL used for port ID 1, :3128 on
> # Patch 2020 - 08 - 03 SquidMikrotikEnabled = 0
> # SSL Proxy options  Proxy version:5.7 [146]
> sslcrtd_program /lib/squid3/security_file_certgen -s /media/squidtmpfs/ssl/ssl_db -M 64MB
> sslcrtd_children 32 startup=5 idle=1 queue-size=64
> acl AnnotateSSLGBW2 annotate_transaction whitelistssl=yes
> #The AppStore application in IOS (iPhone, iPad, MacOS) uses SSL Certificate Pinning,
> #it means the application knows what certificate to expect when accessing AppStore.
> #When you enable SSL Bump of HTTPS connections Squid replaces the default certificate with a ?mimicked? one;
> #the application detects that and refuses to function.
> #
> acl FakeCert ssl::server_name .apple.com
> acl FakeCert ssl::server_name .icloud.com
> acl FakeCert ssl::server_name .mzstatic.com
> acl FakeCert ssl::server_name .dropbox.com
> acl FakeCert ssl::server_name .bnpparisbas
> acl SSLInternalNets dst 10.0.0.0/8
> acl SSLInternalNets dst 172.16.0.0/12
> acl SSLInternalNets dst 192.168.0.0/16
> acl ssl_step1 at_step SslBump1
> acl ssl_step2 at_step SslBump2
> acl ssl_step3 at_step SslBump3
> include /etc/squid3/ssl_whitelist.conf
> ssl_bump peek ssl_step1
> acl GlobalWhitelistDSTNet dst "/etc/squid3/acls_whitelist.dst.conf"
> ssl_bump splice GlobalWhitelistDSTNet AnnotateSSLGBW2
> ssl_bump splice ByPassRBL AnnotateSSLGBW2
> ssl_bump splice SSLInternalNets AnnotateSSLGBW2
> ssl_bump splice FakeCert AnnotateSSLGBW2
> # IMPRIM_RULE:5
> ssl_bump splice ByPassRBL AnnotateSSLGBW2
> ssl_bump splice GlobalWhitelistDSTNet AnnotateSSLGBW2

FYI, Those two lines are duplicates of the first ssl_bump rules. They do 
nothing here except waste CPU cycles.


> # Rules (spliced) added by admins....
> # 5 rules...
> # -------------- Personal rules -----------------
>
> # id:5
> # decrypt_cnn order:0
> acl AnnotateSSLW5 annotate_transaction bumprule=5
> ssl_bump bump Group26 AnnotateSSLW5
> ssl_bump splice all
>
> tls_outgoing_options options=NO_SSLv3,NO_TICKET cipher=ALL:!SSLv2:!SSLv3:!ADH:!DSS:!MD5:!EXP:!DES:!PSK:!SRP:!RC4:!IDEA:!SEED:!aNULL:!eNULL flags=DONT_VERIFY_PEER
> sslproxy_cert_error allow all
> on_unsupported_protocol tunnel all
>
> -----Mensagem original-----
> De: squid-users Em Nome De andre.bolinhas
> Enviada: 12 de janeiro de 2023 21:03
> Assunto: Re: [squid-users] SSLBUMP for specific domains
>
> Hi Amos
> Thansk for your quick reply, I have done it as example but now, even the internet surf is ok for all website I get to many TCP_TUNNEL/500  on access.log for all  websites that we are not decrypting
>
> 1673531433.924  31315 192.168.60.30 TCP_TUNNEL/500 4096 CONNECT sapo.pt:443 - HIER_DIRECT/213.13.146.142:443 - mac="d6:8b:66:2a:9b:92" accessrule:%20ntlm_white_dstdomain%0D%0Awebfilter:%20pass%0D%0Acategory:%203%0D%0Acategory-name:%20Society%0D%0Aclog:%20cinfo:3-Society;%0D%0A exterr="-|- splice"
> 1673531433.933  31324 192.168.60.30 TCP_TUNNEL/500 4695 CONNECT sapo.pt:443 - HIER_DIRECT/213.13.146.142:443 - mac="d6:8b:66:2a:9b:92" accessrule:%20ntlm_white_dstdomain%0D%0Awebfilter:%20pass%0D%0Acategory:%203%0D%0Acategory-name:%20Society%0D%0Aclog:%20cinfo:3-Society;%0D%0A exterr="-|- splice"
> 1673531437.798  35024 192.168.60.30 TCP_TUNNEL/500 76572 CONNECT www.sapo.pt:443 - HIER_DIRECT/213.13.146.142:443 - mac="d6:8b:66:2a:9b:92" accessrule:%20ntlm_white_dstdomain%0D%0Awebfilter:%20pass%0D%0Acategory:%203%0D%0Acategory-name:%20Society%0D%0Aclog:%20cinfo:3-Society;%0D%0A exterr="-|- splice"

By the differences on size and the existence of a remote server IP 
address in the log entry, I guess this is 
<https://bugs.squid-cache.org/show_bug.cgi?id=5252>.

Amos



From andre.bolinhas at articatech.com  Thu Jan 12 21:47:47 2023
From: andre.bolinhas at articatech.com (andre.bolinhas at articatech.com)
Date: Thu, 12 Jan 2023 21:47:47 -0000
Subject: [squid-users] SSLBUMP for specific domains
In-Reply-To: <d1552e55-0c59-a3d7-0a3e-6ab24bc09a80@treenet.co.nz>
References: <!&!AAAAAAAAAAAuAAAAAAAAAIVNjRjcTGZElYgADq7oyvYBAMO2jhD3dRHOtM0AqgC7tuYAAAAAAA4AABAAAADcFbMUZxTHSLrHYYF78z9zAQAAAAA=@articatech.com>
 <bd46b556-2f7b-8b98-cb94-8884b9359bfc@treenet.co.nz>
 <!&!AAAAAAAAAAAuAAAAAAAAAIVNjRjcTGZElYgADq7oyvYBAMO2jhD3dRHOtM0AqgC7tuYAAAAAAA4AABAAAAAffT/XKNiMSJYe3HQwwyMDAQAAAAA=@articatech.com>
 <!&!AAAAAAAAAAAuAAAAAAAAAIVNjRjcTGZElYgADq7oyvYBAMO2jhD3dRHOtM0AqgC7tuYAAAAAAA4AABAAAAAXOkifN1NmQbUlttM4hIF4AQAAAAA=@articatech.com>
 <d1552e55-0c59-a3d7-0a3e-6ab24bc09a80@treenet.co.nz>
Message-ID: <!&!AAAAAAAAAAAuAAAAAAAAAIVNjRjcTGZElYgADq7oyvYBAMO2jhD3dRHOtM0AqgC7tuYAAAAAAA4AABAAAACNgncRmIH+To9+S4eBdVnRAQAAAAA=@articatech.com>

So is a bug for 500 or a bad configuration?
I have also tried this setup and seams to "fix" the tcp_tunnel/500

# Squid 5.x branch
# SSL used for port ID 1, :3128 on
# Patch 2020 - 08 - 03 SquidMikrotikEnabled = 0
# SSL Proxy options  Proxy version:5.7 [146]
sslcrtd_program /lib/squid3/security_file_certgen -s /media/squidtmpfs/ssl/ssl_db -M 64MB
sslcrtd_children 32 startup=5 idle=1 queue-size=64
acl AnnotateSSLGBW2 annotate_transaction whitelistssl=yes
#The AppStore application in IOS (iPhone, iPad, MacOS) uses SSL Certificate Pinning,
#it means the application knows what certificate to expect when accessing AppStore.
#When you enable SSL Bump of HTTPS connections Squid replaces the default certificate with a ?mimicked? one;
#the application detects that and refuses to function.
#
acl FakeCert ssl::server_name .apple.com
acl FakeCert ssl::server_name .icloud.com
acl FakeCert ssl::server_name .mzstatic.com
acl FakeCert ssl::server_name .dropbox.com
acl FakeCert ssl::server_name .bnpparisbas
acl SSLInternalNets dst 10.0.0.0/8
acl SSLInternalNets dst 172.16.0.0/12
acl SSLInternalNets dst 192.168.0.0/16
acl ssl_step1 at_step SslBump1
acl ssl_step2 at_step SslBump2
acl ssl_step3 at_step SslBump3
include /etc/squid3/ssl_whitelist.conf
acl NotPeek any-of Group26
ssl_bump peek !NotPeek
acl GlobalWhitelistDSTNet dst "/etc/squid3/acls_whitelist.dst.conf"
ssl_bump splice GlobalWhitelistDSTNet AnnotateSSLGBW2
ssl_bump splice ByPassRBL AnnotateSSLGBW2
ssl_bump splice SSLInternalNets AnnotateSSLGBW2
ssl_bump splice FakeCert AnnotateSSLGBW2

# Rules (spliced) added by admins....
# 5 rules...
# -------------- Personal rules -----------------

# id:5
# decrypt_cnn order:0
acl AnnotateSSLW5 annotate_transaction bumprule=5
ssl_bump bump Group26 AnnotateSSLW5
ssl_bump splice all

tls_outgoing_options options=NO_SSLv3,NO_TICKET cipher=ALL:!SSLv2:!SSLv3:!ADH:!DSS:!MD5:!EXP:!DES:!PSK:!SRP:!RC4:!IDEA:!SEED:!aNULL:!eNULL flags=DONT_VERIFY_PEER
sslproxy_cert_error allow all
on_unsupported_protocol tunnel all


Basically the changes that I made is on peek step changing from
ssl_bump peek ssl_step1
To
acl NotPeek any-of Group26
ssl_bump peek !NotPeek

This is a good idea?


-----Mensagem original-----
De: squid-users <squid-users-bounces at lists.squid-cache.org> Em Nome De Amos Jeffries
Enviada: 12 de janeiro de 2023 21:22
Para: squid-users at lists.squid-cache.org
Assunto: Re: [squid-users] SSLBUMP for specific domains

On 13/01/2023 10:04 am, andre.bolinhas wrote:
> Forgot to attach the config file
>
> root at proxy01:~# cat /etc/squid3/ssl.conf # Squid 5.x branch # SSL used 
> for port ID 1, :3128 on # Patch 2020 - 08 - 03 SquidMikrotikEnabled = 
> 0 # SSL Proxy options  Proxy version:5.7 [146] sslcrtd_program 
> /lib/squid3/security_file_certgen -s /media/squidtmpfs/ssl/ssl_db -M 
> 64MB sslcrtd_children 32 startup=5 idle=1 queue-size=64 acl 
> AnnotateSSLGBW2 annotate_transaction whitelistssl=yes #The AppStore 
> application in IOS (iPhone, iPad, MacOS) uses SSL Certificate Pinning, 
> #it means the application knows what certificate to expect when accessing AppStore.
> #When you enable SSL Bump of HTTPS connections Squid replaces the 
> default certificate with a ?mimicked? one; #the application detects that and refuses to function.
> #
> acl FakeCert ssl::server_name .apple.com acl FakeCert ssl::server_name 
> .icloud.com acl FakeCert ssl::server_name .mzstatic.com acl FakeCert 
> ssl::server_name .dropbox.com acl FakeCert ssl::server_name 
> .bnpparisbas acl SSLInternalNets dst 10.0.0.0/8 acl SSLInternalNets 
> dst 172.16.0.0/12 acl SSLInternalNets dst 192.168.0.0/16 acl ssl_step1 
> at_step SslBump1 acl ssl_step2 at_step SslBump2 acl ssl_step3 at_step 
> SslBump3 include /etc/squid3/ssl_whitelist.conf ssl_bump peek 
> ssl_step1 acl GlobalWhitelistDSTNet dst 
> "/etc/squid3/acls_whitelist.dst.conf"
> ssl_bump splice GlobalWhitelistDSTNet AnnotateSSLGBW2 ssl_bump splice 
> ByPassRBL AnnotateSSLGBW2 ssl_bump splice SSLInternalNets 
> AnnotateSSLGBW2 ssl_bump splice FakeCert AnnotateSSLGBW2 # 
> IMPRIM_RULE:5 ssl_bump splice ByPassRBL AnnotateSSLGBW2 ssl_bump 
> splice GlobalWhitelistDSTNet AnnotateSSLGBW2

FYI, Those two lines are duplicates of the first ssl_bump rules. They do nothing here except waste CPU cycles.


> # Rules (spliced) added by admins....
> # 5 rules...
> # -------------- Personal rules -----------------
>
> # id:5
> # decrypt_cnn order:0
> acl AnnotateSSLW5 annotate_transaction bumprule=5
> ssl_bump bump Group26 AnnotateSSLW5
> ssl_bump splice all
>
> tls_outgoing_options options=NO_SSLv3,NO_TICKET cipher=ALL:!SSLv2:!SSLv3:!ADH:!DSS:!MD5:!EXP:!DES:!PSK:!SRP:!RC4:!IDEA:!SEED:!aNULL:!eNULL flags=DONT_VERIFY_PEER
> sslproxy_cert_error allow all
> on_unsupported_protocol tunnel all
>
> -----Mensagem original-----
> De: squid-users Em Nome De andre.bolinhas
> Enviada: 12 de janeiro de 2023 21:03
> Assunto: Re: [squid-users] SSLBUMP for specific domains
>
> Hi Amos
> Thansk for your quick reply, I have done it as example but now, even the internet surf is ok for all website I get to many TCP_TUNNEL/500  on access.log for all  websites that we are not decrypting
>
> 1673531433.924  31315 192.168.60.30 TCP_TUNNEL/500 4096 CONNECT sapo.pt:443 - HIER_DIRECT/213.13.146.142:443 - mac="d6:8b:66:2a:9b:92" accessrule:%20ntlm_white_dstdomain%0D%0Awebfilter:%20pass%0D%0Acategory:%203%0D%0Acategory-name:%20Society%0D%0Aclog:%20cinfo:3-Society;%0D%0A exterr="-|- splice"
> 1673531433.933  31324 192.168.60.30 TCP_TUNNEL/500 4695 CONNECT sapo.pt:443 - HIER_DIRECT/213.13.146.142:443 - mac="d6:8b:66:2a:9b:92" accessrule:%20ntlm_white_dstdomain%0D%0Awebfilter:%20pass%0D%0Acategory:%203%0D%0Acategory-name:%20Society%0D%0Aclog:%20cinfo:3-Society;%0D%0A exterr="-|- splice"
> 1673531437.798  35024 192.168.60.30 TCP_TUNNEL/500 76572 CONNECT www.sapo.pt:443 - HIER_DIRECT/213.13.146.142:443 - mac="d6:8b:66:2a:9b:92" accessrule:%20ntlm_white_dstdomain%0D%0Awebfilter:%20pass%0D%0Acategory:%203%0D%0Acategory-name:%20Society%0D%0Aclog:%20cinfo:3-Society;%0D%0A exterr="-|- splice"

By the differences on size and the existence of a remote server IP 
address in the log entry, I guess this is 
<https://bugs.squid-cache.org/show_bug.cgi?id=5252>.

Amos

_______________________________________________
squid-users mailing list
squid-users at lists.squid-cache.org
http://lists.squid-cache.org/listinfo/squid-users



From squid.org at bloms.de  Fri Jan 13 11:13:02 2023
From: squid.org at bloms.de (Dieter Bloms)
Date: Fri, 13 Jan 2023 12:13:02 +0100
Subject: [squid-users] is it possible to restrict the use of websocket for
 security reason?
Message-ID: <20230113111302.jvd25ycza3q2zhcu@bloms.de>

Hello,

is it possible to restrict the use of websockets for seurity reason like
prevent long-lived Websocket communication or define a limit for total size
of transfered payload?

-- 
Regards

  Dieter

--
I do not get viruses because I do not use MS software.
If you use Outlook then please do not put my email address in your
address-book so that WHEN you get a virus it won't use my address in the
>From field.


From squid3 at treenet.co.nz  Fri Jan 13 22:54:04 2023
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Sat, 14 Jan 2023 11:54:04 +1300
Subject: [squid-users] is it possible to restrict the use of websocket
 for security reason?
In-Reply-To: <20230113111302.jvd25ycza3q2zhcu@bloms.de>
References: <20230113111302.jvd25ycza3q2zhcu@bloms.de>
Message-ID: <b26b9507-bce5-04ac-a0ac-02e13bacf27d@treenet.co.nz>

On 14/01/2023 12:13 am, Dieter Bloms wrote:
> Hello,
>
> is it possible to restrict the use of websockets for seurity reason like
> prevent long-lived Websocket communication or define a limit for total size
> of transfered payload?

No. Squid support for WebSockets is only to reject its HTTP/1.1 mapping 
such that it can failover cleanly to other forms which are not going 
through Squid.

Amos



From squid3 at treenet.co.nz  Fri Jan 13 23:08:45 2023
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Sat, 14 Jan 2023 12:08:45 +1300
Subject: [squid-users] SSLBUMP for specific domains
In-Reply-To: <!&!AAAAAAAAAAAuAAAAAAAAAIVNjRjcTGZElYgADq7oyvYBAMO2jhD3dRHOtM0AqgC7tuYAAAAAAA4AABAAAACNgncRmIH+To9+S4eBdVnRAQAAAAA=@articatech.com>
References: <!&!AAAAAAAAAAAuAAAAAAAAAIVNjRjcTGZElYgADq7oyvYBAMO2jhD3dRHOtM0AqgC7tuYAAAAAAA4AABAAAADcFbMUZxTHSLrHYYF78z9zAQAAAAA=@articatech.com>
 <bd46b556-2f7b-8b98-cb94-8884b9359bfc@treenet.co.nz>
 <!&!AAAAAAAAAAAuAAAAAAAAAIVNjRjcTGZElYgADq7oyvYBAMO2jhD3dRHOtM0AqgC7tuYAAAAAAA4AABAAAAAffT/XKNiMSJYe3HQwwyMDAQAAAAA=@articatech.com>
 <!&!AAAAAAAAAAAuAAAAAAAAAIVNjRjcTGZElYgADq7oyvYBAMO2jhD3dRHOtM0AqgC7tuYAAAAAAA4AABAAAAAXOkifN1NmQbUlttM4hIF4AQAAAAA=@articatech.com>
 <d1552e55-0c59-a3d7-0a3e-6ab24bc09a80@treenet.co.nz>
 <!&!AAAAAAAAAAAuAAAAAAAAAIVNjRjcTGZElYgADq7oyvYBAMO2jhD3dRHOtM0AqgC7tuYAAAAAAA4AABAAAACNgncRmIH+To9+S4eBdVnRAQAAAAA=@articatech.com>
Message-ID: <b57bd803-0991-eb62-ad9c-c0e2844dc9e5@treenet.co.nz>



On 13/01/2023 10:47 am, andre.bolinhas wrote:
> So is a bug for 500 or a bad configuration?
> I have also tried this setup and seams to "fix" the tcp_tunnel/500
...
> Basically the changes that I made is on peek step changing from
> ssl_bump peek ssl_step1
> To
> acl NotPeek any-of Group26

You should not need "any-of" ACL with a single entry. Just use "Group26" 
directly.

> ssl_bump peek !NotPeek
>
> This is a good idea?

What you have done here is tell Squid to peek at both step1 and step2.
The peek action is not relevant at step3, which lets Squid reach the 
splice rules.

The "bump" action will now be performed at step1 before any details of 
the server cert are available.
This can work, but generally is a bad idea with current TLS. I recommend 
doing a peek, stare, bump sequence instead for the NotPeek/Group26 traffic.

Amos



From squid3 at treenet.co.nz  Fri Jan 13 23:14:36 2023
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Sat, 14 Jan 2023 12:14:36 +1300
Subject: [squid-users] eicar website not reachable
In-Reply-To: <CAGU_Ci+W6xjiVsQ_6ZUX5eD40OfaheN0aZqSEuCm9dFwZxiD7A@mail.gmail.com>
References: <CAGU_Ci+W6xjiVsQ_6ZUX5eD40OfaheN0aZqSEuCm9dFwZxiD7A@mail.gmail.com>
Message-ID: <f120fbcf-6d71-00e9-24a6-146c6d4033d4@treenet.co.nz>

On 12/01/2023 9:10 am, robert k Wild wrote:
> hi all,
>
> i have made a whitelist to go to some website, atm i have temp 
> commented out #http_access deny to go to any website
>
> when i browse the web i can go on gmail,o365,hsbc,facebook etc
>
> but when i try to go to "eicar.org <http://eicar.org>" i get the 
> following error
>
> The following error was encountered while trying to retrieve the URL: 
> https://www.eicar.org/*
>
>     *Connection to 2a00:1828:1000:2497::2 failed.*
>
> The system returned: /(101) Network is unreachable/
>

So what I/we can tell from that is that the traffic is HTTPS, and the 
server IP address(es) (all of them) are not accessible to your proxy.
You will have to investigate the logs and traffic connectivity to see if 
you can find out why they are unreachable.

Amos



From ben.goz87 at gmail.com  Sun Jan 15 13:17:26 2023
From: ben.goz87 at gmail.com (Ben Goz)
Date: Sun, 15 Jan 2023 15:17:26 +0200
Subject: [squid-users] Bypass ssl-bump urls that using web sockets
Message-ID: <CADAqQfxDvmj-gCCh9eHrj7SYYmVZ5QtkWfiWaP6E-nL=KQsk7Q@mail.gmail.com>

By the help of God.

I'm using the latest squid version built from github sources and the squid
server configured with ssl-bump. The problem starts when the same URL
serves as regular web page and also for certain web socket communication.

If I bypass this URL it bypasses the whole web site, Is it possible to
configure squid that it'll bypass ssl-bump only when the URL is used for
unsupported protocols (like web sockets)?

Thanks,
Ben
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230115/cdb6e630/attachment.htm>

From squid3 at treenet.co.nz  Sun Jan 15 15:36:11 2023
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Mon, 16 Jan 2023 04:36:11 +1300
Subject: [squid-users] Bypass ssl-bump urls that using web sockets
In-Reply-To: <CADAqQfxDvmj-gCCh9eHrj7SYYmVZ5QtkWfiWaP6E-nL=KQsk7Q@mail.gmail.com>
References: <CADAqQfxDvmj-gCCh9eHrj7SYYmVZ5QtkWfiWaP6E-nL=KQsk7Q@mail.gmail.com>
Message-ID: <b48c8948-ff8f-1ec4-a6d6-7b2be98c0fd5@treenet.co.nz>

On 16/01/2023 2:17 am, Ben Goz wrote:
> By the help of God.
>
> I'm using the latest squid version built from github sources and the 
> squid server configured with ssl-bump.

That could mean a lot of things depending on which hour you built it.
Please use the output of "squid -v" to provide details of custom built 
squid.

> The problem starts when the same URL serves as regular?web page and 
> also for certain web socket communication.
>
> If I bypass this URL it bypasses the whole web site, Is it possible to 
> configure squid that it'll bypass ssl-bump only when the URL is used 
> for unsupported protocols (like web sockets)?

The issue you are facing is that TLS is used to wrap entire 
communication sequences to a server. There is no way to decrypt/bump 
only selective parts of it.
If the initial WebSockets uses HTTP(S) protocol then Squid sees it as 
HTTP and treats it as such (eg. reject unsupported URI scheme) until 
something invalid in HTTP causes the connection to terminate.
If the WebSockets starts using native WebSocket format from the first 
decrypted bytes then Squid on_unsupported_protocol directive behaviour 
should occur (I have not tested that, so YMMV).

To resolve this situation Squid will need to grow support for WebSockets 
(none working on it) and ability to support more than just a TCP vs TLS 
transport layer (under QA discussion, no ETA).

HTH
Amos



From dave at killthe.net  Sun Jan 15 17:00:26 2023
From: dave at killthe.net (Dave Blanchard)
Date: Sun, 15 Jan 2023 11:00:26 -0600
Subject: [squid-users] Bypass ssl-bump urls that using web sockets
In-Reply-To: <b48c8948-ff8f-1ec4-a6d6-7b2be98c0fd5@treenet.co.nz>
References: <CADAqQfxDvmj-gCCh9eHrj7SYYmVZ5QtkWfiWaP6E-nL=KQsk7Q@mail.gmail.com>
 <b48c8948-ff8f-1ec4-a6d6-7b2be98c0fd5@treenet.co.nz>
Message-ID: <20230115110026.375491419c99adf7487d18ea@killthe.net>

> To resolve this situation Squid will need to grow support for WebSockets 
> (none working on it) and ability to support more than just a TCP vs TLS 
> transport layer (under QA discussion, no ETA).

My only contribution to this discussion is to condemn the losers who created the trash that is WebSockets in the first place, and forced it down our throats. What an incredibly stupid idea. DO NOT WANT.



From pheriko.support at gmail.com  Mon Jan 16 18:29:35 2023
From: pheriko.support at gmail.com (Periko Support)
Date: Mon, 16 Jan 2023 10:29:35 -0800
Subject: [squid-users] Issues with blacklist and a domain.
Message-ID: <CAK2yrTZJ4iEGYF78bLiphQCYvtP3WCsp2B+A-zZq8H0sVJH2fA@mail.gmail.com>

Hello people.

I running squid 5.7, I got an issue that would like to know if I could fix this.
In my blacklist I got this entries:

.party
.porn
.xxx
.vip
.me

Which I have found on adult sites that I want to block.

Now, the problem is the ".me" because I found that it is blocking a
government domain on my country.

"dof.gob.mx"

If I remove ".me" from my blacklist I can surf on my government site.

Then what I see is that once squid detects ".m" it will block any domain.

If I add the url on the whitelist won't fix the issue.

Any recommendations?

Regards!!!


From ngtech1ltd at gmail.com  Mon Jan 16 21:45:28 2023
From: ngtech1ltd at gmail.com (ngtech1ltd at gmail.com)
Date: Mon, 16 Jan 2023 23:45:28 +0200
Subject: [squid-users] Since Squid-Cache wiki is moving to another era I had
 to...
Message-ID: <003401d929f3$da6823b0$8f386b10$@gmail.com>

Overengineering your personal website.
A very nice demo of how a single page can become a major headache .... if you do it the wrong way:
https://www.youtube.com/watch?v=7NolBv9G2VE

I hope someone will have a laugh a this :D

----
Eliezer Croitoru
NgTech, Tech Support
Mobile: +972-5-28704261
Email: ngtech1ltd at gmail.com
Web: https://ngtech.co.il/
My-Tube: https://tube.ngtech.co.il/




From ngtech1ltd at gmail.com  Mon Jan 16 21:47:24 2023
From: ngtech1ltd at gmail.com (ngtech1ltd at gmail.com)
Date: Mon, 16 Jan 2023 23:47:24 +0200
Subject: [squid-users] Issues with blacklist and a domain.
In-Reply-To: <CAK2yrTZJ4iEGYF78bLiphQCYvtP3WCsp2B+A-zZq8H0sVJH2fA@mail.gmail.com>
References: <CAK2yrTZJ4iEGYF78bLiphQCYvtP3WCsp2B+A-zZq8H0sVJH2fA@mail.gmail.com>
Message-ID: <003501d929f4$1f5f5240$5e1df6c0$@gmail.com>

Hey,

I am not sure how exactly how the domain:
dof.gob.mx

is being blocked by the:
.me

Domain suffix?
What exactly your squid.conf is doing? (remove private info).

Eliezer

----
Eliezer Croitoru
NgTech, Tech Support
Mobile: +972-5-28704261
Email: ngtech1ltd at gmail.com
Web: https://ngtech.co.il/
My-Tube: https://tube.ngtech.co.il/

-----Original Message-----
From: squid-users <squid-users-bounces at lists.squid-cache.org> On Behalf Of Periko Support
Sent: Monday, 16 January 2023 20:30
To: squid-users at lists.squid-cache.org
Subject: [squid-users] Issues with blacklist and a domain.

Hello people.

I running squid 5.7, I got an issue that would like to know if I could fix this.
In my blacklist I got this entries:

.party
.porn
.xxx
.vip
.me

Which I have found on adult sites that I want to block.

Now, the problem is the ".me" because I found that it is blocking a
government domain on my country.

"dof.gob.mx"

If I remove ".me" from my blacklist I can surf on my government site.

Then what I see is that once squid detects ".m" it will block any domain.

If I add the url on the whitelist won't fix the issue.

Any recommendations?

Regards!!!
_______________________________________________
squid-users mailing list
squid-users at lists.squid-cache.org
http://lists.squid-cache.org/listinfo/squid-users



From ngtech1ltd at gmail.com  Mon Jan 16 21:51:40 2023
From: ngtech1ltd at gmail.com (ngtech1ltd at gmail.com)
Date: Mon, 16 Jan 2023 23:51:40 +0200
Subject: [squid-users] Bypass ssl-bump urls that using web sockets
In-Reply-To: <CADAqQfxDvmj-gCCh9eHrj7SYYmVZ5QtkWfiWaP6E-nL=KQsk7Q@mail.gmail.com>
References: <CADAqQfxDvmj-gCCh9eHrj7SYYmVZ5QtkWfiWaP6E-nL=KQsk7Q@mail.gmail.com>
Message-ID: <003601d929f4$b7f1daa0$27d58fe0$@gmail.com>

Hey Ben,

Depends on the size and the load of your setup there are other solutions out there you can try and make sure if they meet your needs.

Eliezer

----
Eliezer Croitoru
NgTech, Tech Support
Mobile: +972-5-28704261
Email: mailto:ngtech1ltd at gmail.com
Web: https://ngtech.co.il/
My-Tube: https://tube.ngtech.co.il/

From: squid-users <squid-users-bounces at lists.squid-cache.org> On Behalf Of Ben Goz
Sent: Sunday, 15 January 2023 15:17
To: squid-users at lists.squid-cache.org
Subject: [squid-users] Bypass ssl-bump urls that using web sockets

By the help of God.

I'm using the latest squid version built from github sources and the squid server configured with ssl-bump.
The problem starts when the same URL serves as regular web page and also for certain web socket communication.

If I bypass this URL it bypasses the whole web site, Is it possible to configure squid that it'll bypass ssl-bump only when the URL is used for unsupported protocols (like web sockets)?

Thanks,
Ben




From pheriko.support at gmail.com  Tue Jan 17 00:29:08 2023
From: pheriko.support at gmail.com (Periko Support)
Date: Mon, 16 Jan 2023 16:29:08 -0800
Subject: [squid-users] Issues with blacklist and a domain.
In-Reply-To: <003501d929f4$1f5f5240$5e1df6c0$@gmail.com>
References: <CAK2yrTZJ4iEGYF78bLiphQCYvtP3WCsp2B+A-zZq8H0sVJH2fA@mail.gmail.com>
 <003501d929f4$1f5f5240$5e1df6c0$@gmail.com>
Message-ID: <CAK2yrTagB9UQf_5GLEkq7P-J4EEFsxVttTLuR9Dsx9dxQuTxDg@mail.gmail.com>

I got the same question, why is doing that...

This is the blacklist setting:

acl blacklist dstdom_regex -i "/var/squid/acl/blacklist.acl"

http_access deny blacklist

Regards!!!

On Mon, Jan 16, 2023 at 1:47 PM <ngtech1ltd at gmail.com> wrote:
>
> Hey,
>
> I am not sure how exactly how the domain:
> dof.gob.mx
>
> is being blocked by the:
> .me
>
> Domain suffix?
> What exactly your squid.conf is doing? (remove private info).
>
> Eliezer
>
> ----
> Eliezer Croitoru
> NgTech, Tech Support
> Mobile: +972-5-28704261
> Email: ngtech1ltd at gmail.com
> Web: https://ngtech.co.il/
> My-Tube: https://tube.ngtech.co.il/
>
> -----Original Message-----
> From: squid-users <squid-users-bounces at lists.squid-cache.org> On Behalf Of Periko Support
> Sent: Monday, 16 January 2023 20:30
> To: squid-users at lists.squid-cache.org
> Subject: [squid-users] Issues with blacklist and a domain.
>
> Hello people.
>
> I running squid 5.7, I got an issue that would like to know if I could fix this.
> In my blacklist I got this entries:
>
> .party
> .porn
> .xxx
> .vip
> .me
>
> Which I have found on adult sites that I want to block.
>
> Now, the problem is the ".me" because I found that it is blocking a
> government domain on my country.
>
> "dof.gob.mx"
>
> If I remove ".me" from my blacklist I can surf on my government site.
>
> Then what I see is that once squid detects ".m" it will block any domain.
>
> If I add the url on the whitelist won't fix the issue.
>
> Any recommendations?
>
> Regards!!!
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users
>
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users


From uhlar at fantomas.sk  Tue Jan 17 09:38:44 2023
From: uhlar at fantomas.sk (Matus UHLAR - fantomas)
Date: Tue, 17 Jan 2023 10:38:44 +0100
Subject: [squid-users] Issues with blacklist and a domain.
In-Reply-To: <CAK2yrTagB9UQf_5GLEkq7P-J4EEFsxVttTLuR9Dsx9dxQuTxDg@mail.gmail.com>
References: <CAK2yrTZJ4iEGYF78bLiphQCYvtP3WCsp2B+A-zZq8H0sVJH2fA@mail.gmail.com>
 <003501d929f4$1f5f5240$5e1df6c0$@gmail.com>
 <CAK2yrTagB9UQf_5GLEkq7P-J4EEFsxVttTLuR9Dsx9dxQuTxDg@mail.gmail.com>
Message-ID: <Y8ZspJrazgxCTbwt@fantomas.sk>

On 16.01.23 16:29, Periko Support wrote:
>I got the same question, why is doing that...
>
>This is the blacklist setting:
>
>acl blacklist dstdom_regex -i "/var/squid/acl/blacklist.acl"

regular expressions are not that simple to understand and use
incorrect regular expressions may have sideeffects you apparently encounter.

they may also be quite ineffeicient.

for your list you can use "dstdomain" instead.

what's the particular log message that bans your site?


>On Mon, Jan 16, 2023 at 1:47 PM <ngtech1ltd at gmail.com> wrote:
>> I am not sure how exactly how the domain:
>> dof.gob.mx
>>
>> is being blocked by the:
>> .me
>>
>> Domain suffix?
>> What exactly your squid.conf is doing? (remove private info).

>> -----Original Message-----
>> From: squid-users <squid-users-bounces at lists.squid-cache.org> On Behalf Of Periko Support
>> Sent: Monday, 16 January 2023 20:30
>> To: squid-users at lists.squid-cache.org
>> Subject: [squid-users] Issues with blacklist and a domain.
>>
>> Hello people.
>>
>> I running squid 5.7, I got an issue that would like to know if I could fix this.
>> In my blacklist I got this entries:
>>
>> .party
>> .porn
>> .xxx
>> .vip
>> .me

-- 
Matus UHLAR - fantomas, uhlar at fantomas.sk ; http://www.fantomas.sk/
Warning: I wish NOT to receive e-mail advertising to this address.
Varovanie: na tuto adresu chcem NEDOSTAVAT akukolvek reklamnu postu.
A day without sunshine is like, night.


From ngtech1ltd at gmail.com  Tue Jan 17 10:00:15 2023
From: ngtech1ltd at gmail.com (ngtech1ltd at gmail.com)
Date: Tue, 17 Jan 2023 12:00:15 +0200
Subject: [squid-users] Issues with blacklist and a domain.
In-Reply-To: <CAK2yrTagB9UQf_5GLEkq7P-J4EEFsxVttTLuR9Dsx9dxQuTxDg@mail.gmail.com>
References: <CAK2yrTZJ4iEGYF78bLiphQCYvtP3WCsp2B+A-zZq8H0sVJH2fA@mail.gmail.com>
 <003501d929f4$1f5f5240$5e1df6c0$@gmail.com>
 <CAK2yrTagB9UQf_5GLEkq7P-J4EEFsxVttTLuR9Dsx9dxQuTxDg@mail.gmail.com>
Message-ID: <000501d92a5a$80267ed0$80737c70$@gmail.com>

Hey,

What you are using is regular expression and as Matus wrote you need dstdom and not dst_domrex.
To understand better what maybe is going on we can try to use a regex visual editor.
I like very much:
https://rubular.com/

What you actually want is the next:
\.(party|porn|xxx|vip|me)$

Which will only match the suffix of a domain.
What you are writing in your file is actually the equivalent of:
.*(party|porn|xxx|vip|me).*

Which shouldn't match to the domain you mentioned and I assume it might be because of something else.
What is the error message you are receiving in the browser?
Also, how do you use your proxy, forward or Intercept mode?

Eliezer

----
Eliezer Croitoru
NgTech, Tech Support
Mobile: +972-5-28704261
Email: ngtech1ltd at gmail.com
Web: https://ngtech.co.il/
My-Tube: https://tube.ngtech.co.il/

-----Original Message-----
From: squid-users <squid-users-bounces at lists.squid-cache.org> On Behalf Of Periko Support
Sent: Tuesday, 17 January 2023 2:29
To: squid-users at lists.squid-cache.org
Subject: Re: [squid-users] Issues with blacklist and a domain.

I got the same question, why is doing that...

This is the blacklist setting:

acl blacklist dstdom_regex -i "/var/squid/acl/blacklist.acl"

http_access deny blacklist

Regards!!!

On Mon, Jan 16, 2023 at 1:47 PM <ngtech1ltd at gmail.com> wrote:
>
> Hey,
>
> I am not sure how exactly how the domain:
> dof.gob.mx
>
> is being blocked by the:
> .me
>
> Domain suffix?
> What exactly your squid.conf is doing? (remove private info).
>
> Eliezer
>
> ----
> Eliezer Croitoru
> NgTech, Tech Support
> Mobile: +972-5-28704261
> Email: ngtech1ltd at gmail.com
> Web: https://ngtech.co.il/
> My-Tube: https://tube.ngtech.co.il/
>
> -----Original Message-----
> From: squid-users <squid-users-bounces at lists.squid-cache.org> On Behalf Of Periko Support
> Sent: Monday, 16 January 2023 20:30
> To: squid-users at lists.squid-cache.org
> Subject: [squid-users] Issues with blacklist and a domain.
>
> Hello people.
>
> I running squid 5.7, I got an issue that would like to know if I could fix this.
> In my blacklist I got this entries:
>
> .party
> .porn
> .xxx
> .vip
> .me
>
> Which I have found on adult sites that I want to block.
>
> Now, the problem is the ".me" because I found that it is blocking a
> government domain on my country.
>
> "dof.gob.mx"
>
> If I remove ".me" from my blacklist I can surf on my government site.
>
> Then what I see is that once squid detects ".m" it will block any domain.
>
> If I add the url on the whitelist won't fix the issue.
>
> Any recommendations?
>
> Regards!!!
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users
>
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users
_______________________________________________
squid-users mailing list
squid-users at lists.squid-cache.org
http://lists.squid-cache.org/listinfo/squid-users



From ben.goz87 at gmail.com  Tue Jan 17 12:42:11 2023
From: ben.goz87 at gmail.com (Ben Goz)
Date: Tue, 17 Jan 2023 14:42:11 +0200
Subject: [squid-users] Bypass ssl-bump urls that using web sockets
In-Reply-To: <003601d929f4$b7f1daa0$27d58fe0$@gmail.com>
References: <CADAqQfxDvmj-gCCh9eHrj7SYYmVZ5QtkWfiWaP6E-nL=KQsk7Q@mail.gmail.com>
 <003601d929f4$b7f1daa0$27d58fe0$@gmail.com>
Message-ID: <CADAqQfyWjshJtffWmwq5YawKWv17=KRCsUUPZ_roaEwBAxg95Q@mail.gmail.com>

By the help of God.

Hi Eliezer,
Can you please elaborate more?

??????? ??? ??, 16 ????? 2023 ?-23:51 ??? <?ngtech1ltd at gmail.com??>:?

> Hey Ben,
>
> Depends on the size and the load of your setup there are other solutions
> out there you can try and make sure if they meet your needs.
>
> Eliezer
>
> ----
> Eliezer Croitoru
> NgTech, Tech Support
> Mobile: +972-5-28704261
> Email: mailto:ngtech1ltd at gmail.com
> Web: https://ngtech.co.il/
> My-Tube: https://tube.ngtech.co.il/
>
> From: squid-users <squid-users-bounces at lists.squid-cache.org> On Behalf
> Of Ben Goz
> Sent: Sunday, 15 January 2023 15:17
> To: squid-users at lists.squid-cache.org
> Subject: [squid-users] Bypass ssl-bump urls that using web sockets
>
> By the help of God.
>
> I'm using the latest squid version built from github sources and the squid
> server configured with ssl-bump.
> The problem starts when the same URL serves as regular web page and also
> for certain web socket communication.
>
> If I bypass this URL it bypasses the whole web site, Is it possible to
> configure squid that it'll bypass ssl-bump only when the URL is used for
> unsupported protocols (like web sockets)?
>
> Thanks,
> Ben
>
>
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230117/21781293/attachment.htm>

From ngtech1ltd at gmail.com  Tue Jan 17 14:18:37 2023
From: ngtech1ltd at gmail.com (ngtech1ltd at gmail.com)
Date: Tue, 17 Jan 2023 16:18:37 +0200
Subject: [squid-users] Bypass ssl-bump urls that using web sockets
In-Reply-To: <CADAqQfyWjshJtffWmwq5YawKWv17=KRCsUUPZ_roaEwBAxg95Q@mail.gmail.com>
References: <CADAqQfxDvmj-gCCh9eHrj7SYYmVZ5QtkWfiWaP6E-nL=KQsk7Q@mail.gmail.com>
 <003601d929f4$b7f1daa0$27d58fe0$@gmail.com>
 <CADAqQfyWjshJtffWmwq5YawKWv17=KRCsUUPZ_roaEwBAxg95Q@mail.gmail.com>
Message-ID: <001601d92a7e$97c66db0$c7534910$@gmail.com>

Hey Ben,
 
For example:
https://github.com/andybalholm/redwood
 
is good if you are not using tproxy.
 
Eliezer
----
Eliezer Croitoru
NgTech, Tech Support
Mobile: +972-5-28704261
Email: ngtech1ltd at gmail.com <mailto:ngtech1ltd at gmail.com> 
Web: https://ngtech.co.il/
My-Tube: https://tube.ngtech.co.il/
 
From: Ben Goz <ben.goz87 at gmail.com> 
Sent: Tuesday, 17 January 2023 14:42
To: ngtech1ltd at gmail.com
Cc: squid-users at lists.squid-cache.org
Subject: Re: [squid-users] Bypass ssl-bump urls that using web sockets
 
By the help of God.
 
Hi Eliezer,
Can you please elaborate more?
 
??????? ??? ??, 16 ????? 2023 ?-23:51 ??? <? <mailto:ngtech1ltd at gmail.com> ngtech1ltd at gmail.com?>:
Hey Ben,

Depends on the size and the load of your setup there are other solutions out there you can try and make sure if they meet your needs.

Eliezer

----
Eliezer Croitoru
NgTech, Tech Support
Mobile: +972-5-28704261
Email: mailto:ngtech1ltd at gmail.com <mailto:ngtech1ltd at gmail.com> 
Web: https://ngtech.co.il/
My-Tube: https://tube.ngtech.co.il/

From: squid-users <squid-users-bounces at lists.squid-cache.org <mailto:squid-users-bounces at lists.squid-cache.org> > On Behalf Of Ben Goz
Sent: Sunday, 15 January 2023 15:17
To: squid-users at lists.squid-cache.org <mailto:squid-users at lists.squid-cache.org> 
Subject: [squid-users] Bypass ssl-bump urls that using web sockets

By the help of God.

I'm using the latest squid version built from github sources and the squid server configured with ssl-bump.
The problem starts when the same URL serves as regular web page and also for certain web socket communication.

If I bypass this URL it bypasses the whole web site, Is it possible to configure squid that it'll bypass ssl-bump only when the URL is used for unsupported protocols (like web sockets)?

Thanks,
Ben


_______________________________________________
squid-users mailing list
squid-users at lists.squid-cache.org <mailto:squid-users at lists.squid-cache.org> 
http://lists.squid-cache.org/listinfo/squid-users
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230117/f1a543eb/attachment.htm>

From admin at sneakerspace.co.uk  Wed Jan 18 11:30:14 2023
From: admin at sneakerspace.co.uk (Sneaker Space LTD)
Date: Wed, 18 Jan 2023 11:30:14 +0000
Subject: [squid-users] Squid Dual HTTP & SOCKS Set-Up
In-Reply-To: <CAGzU65oL47JgW5V-b=EJKFhJ1_Tf6JgdOY1hxQ1spkWLg=o5NA@mail.gmail.com>
References: <CAGzU65oL47JgW5V-b=EJKFhJ1_Tf6JgdOY1hxQ1spkWLg=o5NA@mail.gmail.com>
Message-ID: <CAGzU65rbK10maF3gLH+X2NtSPQUF6CTb2P13yrfiKcJgiVkW3Q@mail.gmail.com>

Didn't get any replies here - was wondering if anyone had any ideas?

On Tue, Nov 8, 2022 at 6:39 AM Sneaker Space LTD <admin at sneakerspace.co.uk>
wrote:

> Hello everyone,
>
> Can anyone recommend a good setup for a dual HTTP and SOCKS proxy
> configuration?
>
> I want to obviously use Squid as the HTTP proxy and I also see that it may
> support SOCKS with the correct install binds, however, from my research,
> this would likely mean that I need to run two separate processes at the
> same time (Squid HTTP and Squid SOCKS) since apparently, SOCKS Squid can't
> handle both connections types at the same time.
>
> I am wondering if there is any better solution to this? And if not, can
> these processes run off the same configuration, and will the SOCKS Squid
> process have the differences i.e is authentication, and logging the same?
>
> Any insight is appreciated here as I am unfamiliar with this kind of
> set-up and there isn't much documentation online about it.
>
> Many Thanks,
> James
>
>
>
>
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230118/6cc70627/attachment.htm>

From uhlar at fantomas.sk  Wed Jan 18 12:32:24 2023
From: uhlar at fantomas.sk (Matus UHLAR - fantomas)
Date: Wed, 18 Jan 2023 13:32:24 +0100
Subject: [squid-users] Squid Dual HTTP & SOCKS Set-Up
In-Reply-To: <CAGzU65rbK10maF3gLH+X2NtSPQUF6CTb2P13yrfiKcJgiVkW3Q@mail.gmail.com>
References: <CAGzU65oL47JgW5V-b=EJKFhJ1_Tf6JgdOY1hxQ1spkWLg=o5NA@mail.gmail.com>
 <CAGzU65rbK10maF3gLH+X2NtSPQUF6CTb2P13yrfiKcJgiVkW3Q@mail.gmail.com>
Message-ID: <Y8fm2A8wZpJHKsfj@fantomas.sk>

On 18.01.23 11:30, Sneaker Space LTD wrote:
>Didn't get any replies here - was wondering if anyone had any ideas?

for socks we now use danted.
I haven't used socks with squid since status is "testing".
https://wiki.squid-cache.org/Features/Socks

generally, there should be no need for separate socks process if squid could 
handle socks server.
of course, implementation can be different.

>On Tue, Nov 8, 2022 at 6:39 AM Sneaker Space LTD <admin at sneakerspace.co.uk>
>wrote:
>> Can anyone recommend a good setup for a dual HTTP and SOCKS proxy
>> configuration?
>>
>> I want to obviously use Squid as the HTTP proxy and I also see that it may
>> support SOCKS with the correct install binds, however, from my research,
>> this would likely mean that I need to run two separate processes at the
>> same time (Squid HTTP and Squid SOCKS) since apparently, SOCKS Squid can't
>> handle both connections types at the same time.
>>
>> I am wondering if there is any better solution to this? And if not, can
>> these processes run off the same configuration, and will the SOCKS Squid
>> process have the differences i.e is authentication, and logging the same?
>>
>> Any insight is appreciated here as I am unfamiliar with this kind of
>> set-up and there isn't much documentation online about it.

-- 
Matus UHLAR - fantomas, uhlar at fantomas.sk ; http://www.fantomas.sk/
Warning: I wish NOT to receive e-mail advertising to this address.
Varovanie: na tuto adresu chcem NEDOSTAVAT akukolvek reklamnu postu.
Depression is merely anger without enthusiasm.


From squid3 at treenet.co.nz  Thu Jan 19 08:18:07 2023
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Thu, 19 Jan 2023 21:18:07 +1300
Subject: [squid-users] Squid Dual HTTP & SOCKS Set-Up
In-Reply-To: <CAGzU65rbK10maF3gLH+X2NtSPQUF6CTb2P13yrfiKcJgiVkW3Q@mail.gmail.com>
References: <CAGzU65oL47JgW5V-b=EJKFhJ1_Tf6JgdOY1hxQ1spkWLg=o5NA@mail.gmail.com>
 <CAGzU65rbK10maF3gLH+X2NtSPQUF6CTb2P13yrfiKcJgiVkW3Q@mail.gmail.com>
Message-ID: <b080d491-4599-a0e9-ec67-9835ae14fec6@treenet.co.nz>

On 19/01/2023 12:30 am, Sneaker Space LTD wrote:
> Didn't get any replies here - was wondering if anyone had any ideas?
>

Apologies, I meant to reply then end of year life happened.

> On Tue, Nov 8, 2022 at 6:39 AM Sneaker Space LTD wrote:
>
>     Hello everyone,
>
>     Can anyone recommend a good setup for a dual HTTP and SOCKS proxy
>     configuration?
>
>     I want to obviously use Squid as the HTTP proxy and I also see
>     that it may support SOCKS with the correct install binds, however,
>     from my research, this would likely?mean that I need to run two
>     separate?processes at the same time (Squid HTTP and Squid SOCKS)
>     since apparently, SOCKS Squid can't handle both connections types
>     at the same time.
>

AFAIK, the "existing state of Squid" at 
<https://wiki.squid-cache.org/Features/Socks> is still correct.

To clarify a bit:

* the "bind=SOCKSbind"

 ?? A SOCKS server should be capable of _receiving_ either SOCKS or 
non-SOCKS wrapped HTTP at the same port.

 ?? Problems, **except** when the destination is another SOCKS server:
 ?? 1) cannot use tcp_outgoing_address
 ?? 2) NAT intercept and TPROXY traffic only expected to work


* the "connect=SOCKSconnect" flag

 ?Status is unknown with current Squid versions. In theory it should 
imply that all outbound connections are going to SOCKS servers.


The project I was working on to resolve those problems with bind and 
make cache_peer configurable SOCKS support -? is outdated and most of 
the code needs to be re-written.


>     I am wondering if there is any better solution to this? And if
>     not, can these processes run off the same configuration, and will
>     the SOCKS Squid process have the differences?i.e is
>     authentication, and logging the same?
>

As Matus danted. That is the best I found some years back, and quite 
portable. On some OS it is the only choice.


HTH
Amos



From squid3 at treenet.co.nz  Thu Jan 19 10:08:52 2023
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Thu, 19 Jan 2023 23:08:52 +1300
Subject: [squid-users] Squid Dual HTTP & SOCKS Set-Up
In-Reply-To: <b080d491-4599-a0e9-ec67-9835ae14fec6@treenet.co.nz>
References: <CAGzU65oL47JgW5V-b=EJKFhJ1_Tf6JgdOY1hxQ1spkWLg=o5NA@mail.gmail.com>
 <CAGzU65rbK10maF3gLH+X2NtSPQUF6CTb2P13yrfiKcJgiVkW3Q@mail.gmail.com>
 <b080d491-4599-a0e9-ec67-9835ae14fec6@treenet.co.nz>
Message-ID: <f6d2b53f-3483-6cf0-e576-288fb2bb8739@treenet.co.nz>

On 19/01/2023 9:18 pm, Amos Jeffries wrote:
> On 19/01/2023 12:30 am, Sneaker Space LTD wrote:
>> Didn't get any replies here - was wondering if anyone had any ideas?
>>
>
> Apologies, I meant to reply then end of year life happened.
>
>> On Tue, Nov 8, 2022 at 6:39 AM Sneaker Space LTD wrote:
>>
>> ??? Hello everyone,
>>
>> ??? Can anyone recommend a good setup for a dual HTTP and SOCKS proxy
>> ??? configuration?
>>
>> ??? I want to obviously use Squid as the HTTP proxy and I also see
>> ??? that it may support SOCKS with the correct install binds, however,
>> ??? from my research, this would likely?mean that I need to run two
>> ??? separate?processes at the same time (Squid HTTP and Squid SOCKS)
>> ??? since apparently, SOCKS Squid can't handle both connections types
>> ??? at the same time.
>>
>
> AFAIK, the "existing state of Squid" at 
> <https://wiki.squid-cache.org/Features/Socks> is still correct.
>
> To clarify a bit:
>
> * the "bind=SOCKSbind"
>
> ?? A SOCKS server should be capable of _receiving_ either SOCKS or 
> non-SOCKS wrapped HTTP at the same port.
>
> ?? Problems, **except** when the destination is another SOCKS server:
> ?? 1) cannot use tcp_outgoing_address
> ?? 2) NAT intercept and TPROXY traffic only expected to work

that should say " **not** expected to work".


>
>
> * the "connect=SOCKSconnect" flag
>
> ?Status is unknown with current Squid versions. In theory it should 
> imply that all outbound connections are going to SOCKS servers.
>
>
> The project I was working on to resolve those problems with bind and 
> make cache_peer configurable SOCKS support -? is outdated and most of 
> the code needs to be re-written.
>
>
>> ??? I am wondering if there is any better solution to this? And if
>> ??? not, can these processes run off the same configuration, and will
>> ??? the SOCKS Squid process have the differences?i.e is
>> ??? authentication, and logging the same?
>>
>
> As Matus danted. That is the best I found some years back, and quite 
> portable. On some OS it is the only choice.
>
>
> HTH
> Amos
>
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users



From emanuel_gonzalez at live.com.ar  Thu Jan 19 13:45:51 2023
From: emanuel_gonzalez at live.com.ar (Emanuel Gonzalez)
Date: Thu, 19 Jan 2023 13:45:51 +0000
Subject: [squid-users] Allow SFTP connection to port 9122
Message-ID: <CP6P284MB162439452C55D6662114C142B4C49@CP6P284MB1624.BRAP284.PROD.OUTLOOK.COM>

Hi all,

Hi, I need some help.

I have configured an instance with squid as a proxy service. HTTP/HTTPS requests pass through the proxy correctly.

acl Safe_ports port 9122
acl SSL_ports port 9122
acl Safe_ports port 22
acl SSL_ports port 22


But I need to connect to an SFTP service that listens on port 9122.

On the squid configuration side I have added port 9122 to the secure ports and the connection host to the hosts allowed in the dstdomain.

I have created the environment variables necessary to be able to exit through the proxy:

http_proxy=http://myprox.prod:3142

ftp_proxy=http://myproxy.prod:3142

https_proxy=http://myproxy.prod:3142

i try the connection but never happen

sftp -v -oProxyCommand='nc -v -xtheprovider-front.prod:3142 %h %p' -oPort=9122 user at sftp.server.com
OpenSSH_6.7p1 Debian-5+deb8u3, OpenSSL 1.0.1t  3 May 2016
debug1: Reading configuration data /etc/ssh/ssh_config
debug1: /etc/ssh/ssh_config line 18: Applying options for *
debug1: Executing proxy command: exec nc -v -xtheprovider front.prod:3142 sftp.server.com 9122
debug1: permanently_set_uid: 0/0
debug1: permanently_drop_suid: 0
debug1: key_load_public: No such file or directory
debug1: identity file /root/.ssh/id_rsa type -1
debug1: key_load_public: No such file or directory
debug1: identity file /root/.ssh/id_rsa-cert type -1
debug1: key_load_public: No such file or directory
debug1: identity file /root/.ssh/id_dsa type -1
debug1: key_load_public: No such file or directory
debug1: identity file /root/.ssh/id_dsa-cert type -1
debug1: key_load_public: No such file or directory
debug1: identity file /root/.ssh/id_ecdsa type -1
debug1: key_load_public: No such file or directory
debug1: identity file /root/.ssh/id_ecdsa-cert type -1
debug1: key_load_public: No such file or directory
debug1: identity file /root/.ssh/id_ed25519 type -1
debug1: key_load_public: No such file or directory
debug1: identity file /root/.ssh/id_ed25519-cert type -1
debug1: Enabling compatibility mode for protocol 2.0
debug1: Local version string SSH-2.0-OpenSSH_6.7p1 Debian-5+deb8u3



#### squid logs

1674134582.904      0 172.31.29.227 NONE/000 0 NONE error:transaction-end-before-headers - HIER_NONE/- -


Any help?
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230119/c6a2ba1c/attachment.htm>

From uhlar at fantomas.sk  Thu Jan 19 14:23:42 2023
From: uhlar at fantomas.sk (Matus UHLAR - fantomas)
Date: Thu, 19 Jan 2023 15:23:42 +0100
Subject: [squid-users] Allow SFTP connection to port 9122
In-Reply-To: <CP6P284MB162439452C55D6662114C142B4C49@CP6P284MB1624.BRAP284.PROD.OUTLOOK.COM>
References: <CP6P284MB162439452C55D6662114C142B4C49@CP6P284MB1624.BRAP284.PROD.OUTLOOK.COM>
Message-ID: <Y8lSbhuVe+Fn1+i0@fantomas.sk>

On 19.01.23 13:45, Emanuel Gonzalez wrote:
>I have created the environment variables necessary to be able to exit through the proxy:
>
>http_proxy=http://myprox.prod:3142
>
>ftp_proxy=http://myproxy.prod:3142
>
>https_proxy=http://myproxy.prod:3142
>
>i try the connection but never happen
>
>sftp -v -oProxyCommand='nc -v -xtheprovider-front.prod:3142 %h %p' -oPort=9122 user at sftp.server.com
[...]
>debug1: Enabling compatibility mode for protocol 2.0
>debug1: Local version string SSH-2.0-OpenSSH_6.7p1 Debian-5+deb8u3

I don't see here any attempt to connect destination server not 

however, NC uses socks proxy by default, you should configure it to use http 
connect proxy using the -X option.

I would try configuring proxychains or connect-proxy instead of nc.

-- 
Matus UHLAR - fantomas, uhlar at fantomas.sk ; http://www.fantomas.sk/
Warning: I wish NOT to receive e-mail advertising to this address.
Varovanie: na tuto adresu chcem NEDOSTAVAT akukolvek reklamnu postu.
Fucking windows! Bring Bill Gates! (Southpark the movie)


From ben.goz87 at gmail.com  Thu Jan 19 15:48:13 2023
From: ben.goz87 at gmail.com (Ben Goz)
Date: Thu, 19 Jan 2023 17:48:13 +0200
Subject: [squid-users] Counting unique devices connected to squid proxy
Message-ID: <CADAqQfxJbTXyJ=Eqyua5Q1L4HxwjL5T=XSHJVfyoKqUxbTJXzg@mail.gmail.com>

By the help of God.

Hello,
I have a certain task to count the number of unique devices connected
(Could be also transparently) to squid proxy server. While the users can be
on different networks and behind NAT.
Is it possible?
What is the best approach of implement it?

Thanks.
Ben
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230119/bc1c066b/attachment.htm>

From marcus.kool at urlfilterdb.com  Thu Jan 19 20:16:21 2023
From: marcus.kool at urlfilterdb.com (Marcus Kool)
Date: Thu, 19 Jan 2023 20:16:21 +0000
Subject: [squid-users] Counting unique devices connected to squid proxy
In-Reply-To: <CADAqQfxJbTXyJ=Eqyua5Q1L4HxwjL5T=XSHJVfyoKqUxbTJXzg@mail.gmail.com>
References: <CADAqQfxJbTXyJ=Eqyua5Q1L4HxwjL5T=XSHJVfyoKqUxbTJXzg@mail.gmail.com>
Message-ID: <1d8a7528-28e3-b2c5-2f11-f39f47232fcf@urlfilterdb.com>

The squid log file contains the IP address of clients and could be a good field to use for counting users.? But a NAT shows 1 IP for all users behind the NAT...

Marcus


On 19/01/2023 15:48, Ben Goz wrote:
> By the help of God.
>
> Hello,
> I have a certain task to count the number of unique devices connected (Could be also transparently) to squid proxy server. While the users can be on different networks and behind NAT.
> Is it possible?
> What is the best approach?of implement?it?
>
> Thanks.
> Ben
>
>
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users


From athos.ribeiro at canonical.com  Fri Jan 20 15:02:09 2023
From: athos.ribeiro at canonical.com (Athos Ribeiro)
Date: Fri, 20 Jan 2023 12:02:09 -0300
Subject: [squid-users] Question regarding the release process
Message-ID: <Y8qs8S2xodhp8T8i@castor>

Hi! I am trying to understand how accurate the discussion in
http://lists.squid-cache.org/pipermail/squid-dev/2015-March/001853.html
is nowadays, so I can understand the guides in
http://wiki.squid-cache.org/DeveloperResources/ReleaseProcess regarding
the release process.

What I am interested in understanding is if there is a hard commitment
on the backwards compatibility between point releases since 4.x.

In other words, is there any commitment for no feature changes between
5.x and 5.(x+1)?

regards,


-- 
Athos Ribeiro


From squid3 at treenet.co.nz  Sat Jan 21 12:48:01 2023
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Sun, 22 Jan 2023 01:48:01 +1300
Subject: [squid-users] Allow SFTP connection to port 9122
In-Reply-To: <CP6P284MB162439452C55D6662114C142B4C49@CP6P284MB1624.BRAP284.PROD.OUTLOOK.COM>
References: <CP6P284MB162439452C55D6662114C142B4C49@CP6P284MB1624.BRAP284.PROD.OUTLOOK.COM>
Message-ID: <e8ad2ae1-29fb-b60c-6cd9-178b3bf399d0@treenet.co.nz>

On 20/01/2023 2:45 am, Emanuel Gonzalez wrote:
> Hi all,
>
> Hi, I need some help.
>
> I have configured an instance with squid as a proxy service. 
> HTTP/HTTPS requests pass through the proxy correctly.
>
> aclSafe_ports port9122
> aclSSL_ports port9122
> aclSafe_ports port22
> aclSSL_ports port22
>
>
> But I need to connect to an SFTP service that listens on port 9122.
>
> On the squid configuration side I have added port 9122 to the secure 
> ports and the connection host to the hosts allowed in the dstdomain.
>
> I have created the environment variables necessary to be able to exit 
> through the proxy:
>
> http_proxy=http://myprox.prod:3142
>
> ftp_proxy=http://myproxy.prod:3142
>
> https_proxy=http://myproxy.prod:3142
>

Squid does not support this type of configuration. Each type of protocol 
syntax needs to use a different proxy port number.

Current Squid versions also do not have working support for native 
SFTP.? For now you can only pass it through Squid if the client software 
sends the SFTP traffic over a HTTP(S) CONNECT tunnel.


> i try the connection but never happen
...
> 1674134582.904 ? ? ?0 172.31.29.227 NONE/000 0 NONE 
> error:transaction-end-before-headers - HIER_NONE/- -
>

This is the expected outcome of a server-initiated protocol like FTP 
being handled by a Squid listening port expecting client-initiated 
protocol (HTTP or HTTPS).

HTH
Amos



From squid3 at treenet.co.nz  Sat Jan 21 12:59:37 2023
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Sun, 22 Jan 2023 01:59:37 +1300
Subject: [squid-users] Counting unique devices connected to squid proxy
In-Reply-To: <1d8a7528-28e3-b2c5-2f11-f39f47232fcf@urlfilterdb.com>
References: <CADAqQfxJbTXyJ=Eqyua5Q1L4HxwjL5T=XSHJVfyoKqUxbTJXzg@mail.gmail.com>
 <1d8a7528-28e3-b2c5-2f11-f39f47232fcf@urlfilterdb.com>
Message-ID: <4d1ab8c8-e8a0-4fa4-f117-403cdc7a893d@treenet.co.nz>

On 20/01/2023 9:16 am, Marcus Kool wrote:
> The squid log file contains the IP address of clients and could be a 
> good field to use for counting users.? But a NAT shows 1 IP for all 
> users behind the NAT...
>
> Marcus
>
>
> On 19/01/2023 15:48, Ben Goz wrote:
>> By the help of God.
>>
>> Hello,
>> I have a certain task to count the number of unique devices connected 
>> (Could be also transparently) to squid proxy server. While the users 
>> can be on different networks and behind NAT.
>> Is it possible?

No, not really. As Marcus said NAT erases information. As does any HTTP 
multiplexing being performed by downstream proxies.

>> What is the best approach?of implement?it?
>>

Squid provides a management report "client_list" with all recently seen 
client devices. It is reliable for the *currently* connected clients, 
but once a client disconnects entries are discarded relative to how much 
traffic they have used.

Or there are the logs which contain (or can be configured to record) a 
details of *completed* transactions.

HTH
Amos



From squid3 at treenet.co.nz  Sat Jan 21 13:55:54 2023
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Sun, 22 Jan 2023 02:55:54 +1300
Subject: [squid-users] Question regarding the release process
In-Reply-To: <Y8qs8S2xodhp8T8i@castor>
References: <Y8qs8S2xodhp8T8i@castor>
Message-ID: <69e540e0-cf2b-3485-17da-9b2eed573d23@treenet.co.nz>

On 21/01/2023 4:02 am, Athos Ribeiro wrote:
> Hi! I am trying to understand how accurate the discussion in
> http://lists.squid-cache.org/pipermail/squid-dev/2015-March/001853.html
> is nowadays,

That discussion was the latest on Squid numbering. There have been 
modifications to release timing, but the numbering still follows that plan.

> so I can understand the guides in
> http://wiki.squid-cache.org/DeveloperResources/ReleaseProcess regarding
> the release process.

Feature changes should be proposed against the "master" branch in our 
github. If/when accepted they become part of the next Squid-N release 
series. Which are now on a <https://wiki.squid-cache.org/ReleaseSchedule>.

Point releases within a series should only contain documentation 
corrections, bug and security vulnerability fixes. Exception may occur 
at the release maintainers choice.

> What I am interested in understanding is if there is a hard commitment
> on the backwards compatibility between point releases since 4.x.
> In other words, is there any commitment for no feature changes between
> 5.x and 5.(x+1)?

Yes. Feature changes should only occur between Squid-(N).x and 
Squid-(N+m).x with non-0 'm'.

HTH
Amos



From uhlar at fantomas.sk  Sat Jan 21 15:59:54 2023
From: uhlar at fantomas.sk (Matus UHLAR - fantomas)
Date: Sat, 21 Jan 2023 16:59:54 +0100
Subject: [squid-users] Allow SFTP connection to port 9122
In-Reply-To: <e8ad2ae1-29fb-b60c-6cd9-178b3bf399d0@treenet.co.nz>
References: <CP6P284MB162439452C55D6662114C142B4C49@CP6P284MB1624.BRAP284.PROD.OUTLOOK.COM>
 <e8ad2ae1-29fb-b60c-6cd9-178b3bf399d0@treenet.co.nz>
Message-ID: <Y8wL+luURknpxsQS@fantomas.sk>

>On 20/01/2023 2:45 am, Emanuel Gonzalez wrote:
>>I have configured an instance with squid as a proxy service. 
>>HTTP/HTTPS requests pass through the proxy correctly.
>>
>>aclSafe_ports port9122
>>aclSSL_ports port9122
>>aclSafe_ports port22
>>aclSSL_ports port22
>>
>>
>>But I need to connect to an SFTP service that listens on port 9122.
>>
>>On the squid configuration side I have added port 9122 to the secure 
>>ports and the connection host to the hosts allowed in the dstdomain.
>>
>>I have created the environment variables necessary to be able to 
>>exit through the proxy:
>>
>>http_proxy=http://myprox.prod:3142
>>
>>ftp_proxy=http://myproxy.prod:3142
>>
>>https_proxy=http://myproxy.prod:3142

On 22.01.23 01:48, Amos Jeffries wrote:
>Squid does not support this type of configuration. Each type of 
>protocol syntax needs to use a different proxy port number.

they are three types of requests to be passed over HTTP, which is 
exactly what squid supports on single port.

GET http://
GET ftp://
CONNECT

imho the problem is that "nc -x" expects SOCKS proxy by default and OP issues:

'nc -v -xtheprovider-front.prod:3142 %h %p'

>Current Squid versions also do not have working support for native 
>SFTP.? For now you can only pass it through Squid if the client 
>software sends the SFTP traffic over a HTTP(S) CONNECT tunnel.

nc would do that if he added "-X connect":

      -X proxy_protocol
              Use proxy_protocol when talking to the proxy server.  Supported
              protocols are 4 (SOCKS v.4), 5 (SOCKS v.5) and connect (HTTPS
              proxy).  If the protocol is not specified, SOCKS version 5 is
              used.

-- 
Matus UHLAR - fantomas, uhlar at fantomas.sk ; http://www.fantomas.sk/
Warning: I wish NOT to receive e-mail advertising to this address.
Varovanie: na tuto adresu chcem NEDOSTAVAT akukolvek reklamnu postu.
M$ Win's are shit, do not use it !


From ben.goz87 at gmail.com  Sun Jan 22 12:37:03 2023
From: ben.goz87 at gmail.com (Ben Goz)
Date: Sun, 22 Jan 2023 14:37:03 +0200
Subject: [squid-users] Counting unique devices connected to squid proxy
In-Reply-To: <4d1ab8c8-e8a0-4fa4-f117-403cdc7a893d@treenet.co.nz>
References: <CADAqQfxJbTXyJ=Eqyua5Q1L4HxwjL5T=XSHJVfyoKqUxbTJXzg@mail.gmail.com>
 <1d8a7528-28e3-b2c5-2f11-f39f47232fcf@urlfilterdb.com>
 <4d1ab8c8-e8a0-4fa4-f117-403cdc7a893d@treenet.co.nz>
Message-ID: <dd1dff9f-dd1b-149b-c7c5-abe9409716b3@gmail.com>


On 21/01/2023 14:59, Amos Jeffries wrote:
> On 20/01/2023 9:16 am, Marcus Kool wrote:
>> The squid log file contains the IP address of clients and could be a 
>> good field to use for counting users. But a NAT shows 1 IP for all 
>> users behind the NAT...
>>
>> Marcus
>>
>>
>> On 19/01/2023 15:48, Ben Goz wrote:
>>> By the help of God.
>>>
>>> Hello,
>>> I have a certain task to count the number of unique devices 
>>> connected (Could be also transparently) to squid proxy server. While 
>>> the users can be on different networks and behind NAT.
>>> Is it possible?
>
> No, not really. As Marcus said NAT erases information. As does any 
> HTTP multiplexing being performed by downstream proxies.
Is it possible for squid to identify NAT?
>
>>> What is the best approach?of implement?it?
>>>
>
> Squid provides a management report "client_list" with all recently 
> seen client devices. It is reliable for the *currently* connected 
> clients, but once a client disconnects entries are discarded relative 
> to how much traffic they have used.
Does this report also words behind NAT? can you refer me to more 
descriptive information about "client_list"?
>
> Or there are the logs which contain (or can be configured to record) a 
> details of *completed* transactions.
>
> HTH
> Amos
>
Thanks Ben

> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users


From gustavocarv4872 at gmail.com  Thu Jan 26 20:30:44 2023
From: gustavocarv4872 at gmail.com (Gustavo Carvalho)
Date: Thu, 26 Jan 2023 17:30:44 -0300
Subject: [squid-users] Squid use all memory ram
Message-ID: <CAL5gn0WmNXX5ikV-4yuEKKsOBhxFyBwag+d5p9DRGG9PE+BL6g@mail.gmail.com>

Hi,

I have Squid 5.6 on a FreeBSD 13.1 server with 16GB RAM

I noticed that squid starts to consume a lot of ram until it starts to
consume swap space. When this happens, browsing becomes extremely
slow.

This is happening at least once a week when I have to restart squid to
get it back to normal.

Any ideas?

############# Wed Jan 25 08:30:00 -03 2023 #############

HTTP/1.1 200 OK
Server: squid
Mime-Version: 1.0
Date: Wed, 25 Jan 2023 11:30:00 GMT
Content-Type: text/plain;charset=utf-8
Expires: Wed, 25 Jan 2023 11:30:00 GMT
Last-Modified: Wed, 25 Jan 2023 11:30:00 GMT
X-Cache: MISS from xxxx.xxxx.xxxx
X-Cache-Lookup: MISS from xxxx.xxxx.xxxx:3128
Via: 1.1 xxxx.xxxx.xxxx (squid)
Connection: close

Squid Object Cache: Version 5.6
Build Info:
Service Name: squid
Start Time: Thu, 19 Jan 2023 20:25:17 GMT
Current Time: Wed, 25 Jan 2023 11:30:00 GMT
Connection information for squid:
     Number of clients accessing cache: 224
     Number of HTTP requests received: 7541590
     Number of ICP messages received: 0
     Number of ICP messages sent: 0
     Number of queued ICP replies: 0
     Number of HTCP messages received: 0
     Number of HTCP messages sent: 0
     Request failure ratio: 0.00
     Average HTTP requests per minute since start: 930.5
     Average ICP messages per minute since start: 0.0
     Select loop called: 78733524 times, 6.176 ms avg
Cache information for squid:
     Hits as % of all requests: 5min: 8.4%, 60min: 12.1%
     Hits as % of bytes sent: 5min: 21.6%, 60min: 14.1%
     Memory hits as % of hit requests: 5min: 90.8%, 60min: 75.9%
     Disk hits as % of hit requests: 5min: 4.0%, 60min: 19.7%
     Storage Swap size: 2829956 KB
     Storage Swap capacity: 90.0% used, 10.0% free
     Storage Mem size: 16172 KB
     Storage Mem capacity: 98.7% used,  1.3% free
     Mean Object Size: 28.95 KB
     Requests given to unlinkd: 186982
Median Service Times (seconds)  5 min    60 min:
HTTP Requests (All):   0.00562  0.01847
     Cache Misses:          0.15048  0.23230
     Cache Hits:            0.00000  0.00000
     Near Hits:             0.14252  0.13498
     Not-Modified Replies:  0.00865  0.03066
     DNS Lookups:           0.00000  0.00372
     ICP Queries:           0.00000  0.00000
Resource usage for squid:
     UP Time: 486282.612 seconds
     CPU Time: 65555.712 seconds
     CPU Usage: 13.48%
     CPU Usage, 5 minute avg: 26.89%
     CPU Usage, 60 minute avg: 68.00%
     Maximum Resident Size: 37896960 KB
     Page faults with physical i/o: 10843
Memory accounted for:
     Total accounted:       -1459461 KB
     memPoolAlloc calls:     11408
     memPoolFree calls:  1888969689
File descriptor usage for squid:
     Maximum number of file descriptors:   4096
     Largest file desc currently in use:   2149
     Number of file desc currently in use:  679
     Files queued for open:                   0
     Available number of file descriptors: 3417
     Reserved number of file descriptors:   100
     Store Disk files open:                   0
Internal Data Structures:
     97906 StoreEntries
     3002 StoreEntries with MemObjects
     2838 Hot Object Cache Items
     97742 on-disk objects

------ pfctl -si ------

Status: Enabled for 25 days 22:58:24          Debug: Urgent

State Table                          Total             Rate
  current entries                     8085
  searches                      6650475717         2965.4/s
  inserts                        133521957           59.5/s
  removals                       133552376           59.5/s
Counters
  match                          605960865          270.2/s
  bad-offset                             0            0.0/s
  fragment                               1            0.0/s
  short                                 54            0.0/s
  normalize                            659            0.0/s
  memory                                 0            0.0/s
  bad-timestamp                          0            0.0/s
  congestion                             0            0.0/s
  ip-option                              0            0.0/s
  proto-cksum                            0            0.0/s
  state-mismatch                    104674            0.0/s
  state-insert                       38501            0.0/s
  state-limit                            0            0.0/s
  src-limit                              0            0.0/s
  synproxy                               0            0.0/s
  map-failed                             0            0.0/s

------ sysctl -a | grep swap  ------

swap_pager: out of swap space
swp_pager_getswapspace(32): failed
swap_pager: out of swap space
swp_pager_getswapspace(31): failed
swap_pager: out of swap space
swp_pager_getswapspace(1): failed
1 PART da0p2 2147483648 512 i 2 o 544768 ty freebsd-swap xs GPT xt
516e7cb5-6ecf-11d6-8ff8-00022d09712b
0 MD md1 94371840 512 u 1 s 512 f 0 fs 0 l 94371840 t swap label
0 MD md0 62914560 512 u 0 s 512 f 0 fs 0 l 62914560 t swap label
z0xfffff80003ec5800 [shape=box,label="SWAP\nswap\nr#3"];
      <name>swap</name>
    <type>swap</type>
    <type>swap</type>
    <type>freebsd-swap</type>
vm.swap_enabled: 1
vm.domain.0.stats.unswappable: 2044
vm.swap_idle_threshold2: 10
vm.swap_idle_threshold1: 2
vm.swap_idle_enabled: 0
vm.disable_swapspace_pageouts: 0
vm.stats.vm.v_swappgsout: 3154299
vm.stats.vm.v_swappgsin: 510404
vm.stats.vm.v_swapout: 174446
vm.stats.vm.v_swapin: 62590
vm.stats.swap.free_completed: 54375
vm.stats.swap.free_deferred: 56992
vm.nswapdev: 1
vm.swap_fragmentation:
vm.swap_async_max: 4
vm.swap_maxpages: 32572800
vm.swap_total: 2147483648
vm.swap_reserved: 384676114432

------ /usr/sbin/swapinfo -h  ------

Device              Size     Used    Avail Capacity
/dev/da0p2          2.0G     2.0G     8.0K   100%


############# squid.conf #############

http_port 3128 ssl-bump generate-host-certificates=on
dynamic_cert_mem_cache_size=20MB cert=/xxxx/conf/certs/ca.crt
key=/xxxx/conf/certs/ca.key
http_port 3129 intercept
https_port 3130 intercept ssl-bump generate-host-certificates=on
dynamic_cert_mem_cache_size=20MB cert=/xxxx/conf/certs/ca.crt
key=/xxxx/conf/certs/ca.key
visible_hostname xxxx.xxxx.xxxx
max_filedescriptors 4096
maximum_object_size 4096 KB
minimum_object_size 0 KB
maximum_object_size_in_memory 256 KB
fqdncache_size 1024
cache_mgr xxxx at xxxx
dns_nameservers 127.0.0.1
cache_replacement_policy                heap LFUDA
memory_replacement_policy               heap GDSF
cache_mem 16 MB
cache_dir               ufs /xxxx/chroot/osproxy/cache 3072 32 256
forwarded_for on
memory_pools off
logformat xxxx %ts|%6tr|%>a|%Ss|%03>Hs|%<st|%rm|%un|%mt|%ea|%ru
logfile_rotate 0
httpd_suppress_version_string on
strip_query_terms off


From hamilton.coutinho at gmail.com  Thu Jan 26 20:43:38 2023
From: hamilton.coutinho at gmail.com (Hamilton Coutinho)
Date: Thu, 26 Jan 2023 12:43:38 -0800
Subject: [squid-users] Squid use all memory ram
In-Reply-To: <CAL5gn0WmNXX5ikV-4yuEKKsOBhxFyBwag+d5p9DRGG9PE+BL6g@mail.gmail.com>
References: <CAL5gn0WmNXX5ikV-4yuEKKsOBhxFyBwag+d5p9DRGG9PE+BL6g@mail.gmail.com>
Message-ID: <CAL34ibmo7p51ZEUhW=JOQp8YAH72bZMrjh4RwhJ-JHb4F8XZkg@mail.gmail.com>

Hi Gustavo,

I'm seeing the same thing. I could narrow down (but can't say with 100%
confidence) to the code that does certificate verification when configured
for SSL decryption. What is the output of squidclient mgr:mem for you? Do
you see unexplainably high counts for in-use objects like HttpRequest,
PeekingPeerConnector, Comm::Connection, Security::ErrorDetail?


On Thu, Jan 26, 2023 at 12:31 PM Gustavo Carvalho <gustavocarv4872 at gmail.com>
wrote:

> Hi,
>
> I have Squid 5.6 on a FreeBSD 13.1 server with 16GB RAM
>
> I noticed that squid starts to consume a lot of ram until it starts to
> consume swap space. When this happens, browsing becomes extremely
> slow.
>
> This is happening at least once a week when I have to restart squid to
> get it back to normal.
>
> Any ideas?
>
> ############# Wed Jan 25 08:30:00 -03 2023 #############
>
> HTTP/1.1 200 OK
> Server: squid
> Mime-Version: 1.0
> Date: Wed, 25 Jan 2023 11:30:00 GMT
> Content-Type: text/plain;charset=utf-8
> Expires: Wed, 25 Jan 2023 11:30:00 GMT
> Last-Modified: Wed, 25 Jan 2023 11:30:00 GMT
> X-Cache: MISS from xxxx.xxxx.xxxx
> X-Cache-Lookup: MISS from xxxx.xxxx.xxxx:3128
> Via: 1.1 xxxx.xxxx.xxxx (squid)
> Connection: close
>
> Squid Object Cache: Version 5.6
> Build Info:
> Service Name: squid
> Start Time: Thu, 19 Jan 2023 20:25:17 GMT
> Current Time: Wed, 25 Jan 2023 11:30:00 GMT
> Connection information for squid:
>      Number of clients accessing cache: 224
>      Number of HTTP requests received: 7541590
>      Number of ICP messages received: 0
>      Number of ICP messages sent: 0
>      Number of queued ICP replies: 0
>      Number of HTCP messages received: 0
>      Number of HTCP messages sent: 0
>      Request failure ratio: 0.00
>      Average HTTP requests per minute since start: 930.5
>      Average ICP messages per minute since start: 0.0
>      Select loop called: 78733524 times, 6.176 ms avg
> Cache information for squid:
>      Hits as % of all requests: 5min: 8.4%, 60min: 12.1%
>      Hits as % of bytes sent: 5min: 21.6%, 60min: 14.1%
>      Memory hits as % of hit requests: 5min: 90.8%, 60min: 75.9%
>      Disk hits as % of hit requests: 5min: 4.0%, 60min: 19.7%
>      Storage Swap size: 2829956 KB
>      Storage Swap capacity: 90.0% used, 10.0% free
>      Storage Mem size: 16172 KB
>      Storage Mem capacity: 98.7% used,  1.3% free
>      Mean Object Size: 28.95 KB
>      Requests given to unlinkd: 186982
> Median Service Times (seconds)  5 min    60 min:
> HTTP Requests (All):   0.00562  0.01847
>      Cache Misses:          0.15048  0.23230
>      Cache Hits:            0.00000  0.00000
>      Near Hits:             0.14252  0.13498
>      Not-Modified Replies:  0.00865  0.03066
>      DNS Lookups:           0.00000  0.00372
>      ICP Queries:           0.00000  0.00000
> Resource usage for squid:
>      UP Time: 486282.612 seconds
>      CPU Time: 65555.712 seconds
>      CPU Usage: 13.48%
>      CPU Usage, 5 minute avg: 26.89%
>      CPU Usage, 60 minute avg: 68.00%
>      Maximum Resident Size: 37896960 KB
>      Page faults with physical i/o: 10843
> Memory accounted for:
>      Total accounted:       -1459461 KB
>      memPoolAlloc calls:     11408
>      memPoolFree calls:  1888969689
> File descriptor usage for squid:
>      Maximum number of file descriptors:   4096
>      Largest file desc currently in use:   2149
>      Number of file desc currently in use:  679
>      Files queued for open:                   0
>      Available number of file descriptors: 3417
>      Reserved number of file descriptors:   100
>      Store Disk files open:                   0
> Internal Data Structures:
>      97906 StoreEntries
>      3002 StoreEntries with MemObjects
>      2838 Hot Object Cache Items
>      97742 on-disk objects
>
> ------ pfctl -si ------
>
> Status: Enabled for 25 days 22:58:24          Debug: Urgent
>
> State Table                          Total             Rate
>   current entries                     8085
>   searches                      6650475717         2965.4/s
>   inserts                        133521957           59.5/s
>   removals                       133552376           59.5/s
> Counters
>   match                          605960865          270.2/s
>   bad-offset                             0            0.0/s
>   fragment                               1            0.0/s
>   short                                 54            0.0/s
>   normalize                            659            0.0/s
>   memory                                 0            0.0/s
>   bad-timestamp                          0            0.0/s
>   congestion                             0            0.0/s
>   ip-option                              0            0.0/s
>   proto-cksum                            0            0.0/s
>   state-mismatch                    104674            0.0/s
>   state-insert                       38501            0.0/s
>   state-limit                            0            0.0/s
>   src-limit                              0            0.0/s
>   synproxy                               0            0.0/s
>   map-failed                             0            0.0/s
>
> ------ sysctl -a | grep swap  ------
>
> swap_pager: out of swap space
> swp_pager_getswapspace(32): failed
> swap_pager: out of swap space
> swp_pager_getswapspace(31): failed
> swap_pager: out of swap space
> swp_pager_getswapspace(1): failed
> 1 PART da0p2 2147483648 512 i 2 o 544768 ty freebsd-swap xs GPT xt
> 516e7cb5-6ecf-11d6-8ff8-00022d09712b
> 0 MD md1 94371840 512 u 1 s 512 f 0 fs 0 l 94371840 t swap label
> 0 MD md0 62914560 512 u 0 s 512 f 0 fs 0 l 62914560 t swap label
> z0xfffff80003ec5800 [shape=box,label="SWAP\nswap\nr#3"];
>       <name>swap</name>
>     <type>swap</type>
>     <type>swap</type>
>     <type>freebsd-swap</type>
> vm.swap_enabled: 1
> vm.domain.0.stats.unswappable: 2044
> vm.swap_idle_threshold2: 10
> vm.swap_idle_threshold1: 2
> vm.swap_idle_enabled: 0
> vm.disable_swapspace_pageouts: 0
> vm.stats.vm.v_swappgsout: 3154299
> vm.stats.vm.v_swappgsin: 510404
> vm.stats.vm.v_swapout: 174446
> vm.stats.vm.v_swapin: 62590
> vm.stats.swap.free_completed: 54375
> vm.stats.swap.free_deferred: 56992
> vm.nswapdev: 1
> vm.swap_fragmentation:
> vm.swap_async_max: 4
> vm.swap_maxpages: 32572800
> vm.swap_total: 2147483648
> vm.swap_reserved: 384676114432
>
> ------ /usr/sbin/swapinfo -h  ------
>
> Device              Size     Used    Avail Capacity
> /dev/da0p2          2.0G     2.0G     8.0K   100%
>
>
> ############# squid.conf #############
>
> http_port 3128 ssl-bump generate-host-certificates=on
> dynamic_cert_mem_cache_size=20MB cert=/xxxx/conf/certs/ca.crt
> key=/xxxx/conf/certs/ca.key
> http_port 3129 intercept
> https_port 3130 intercept ssl-bump generate-host-certificates=on
> dynamic_cert_mem_cache_size=20MB cert=/xxxx/conf/certs/ca.crt
> key=/xxxx/conf/certs/ca.key
> visible_hostname xxxx.xxxx.xxxx
> max_filedescriptors 4096
> maximum_object_size 4096 KB
> minimum_object_size 0 KB
> maximum_object_size_in_memory 256 KB
> fqdncache_size 1024
> cache_mgr xxxx at xxxx
> dns_nameservers 127.0.0.1
> cache_replacement_policy                heap LFUDA
> memory_replacement_policy               heap GDSF
> cache_mem 16 MB
> cache_dir               ufs /xxxx/chroot/osproxy/cache 3072 32 256
> forwarded_for on
> memory_pools off
> logformat xxxx %ts|%6tr|%>a|%Ss|%03>Hs|%<st|%rm|%un|%mt|%ea|%ru
> logfile_rotate 0
> httpd_suppress_version_string on
> strip_query_terms off
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users
>


-- 
Hamilton
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230126/3cb85ffb/attachment.htm>

From sreekanth.iitb at gmail.com  Fri Jan 27 07:18:39 2023
From: sreekanth.iitb at gmail.com (sreekanth guru)
Date: Thu, 26 Jan 2023 23:18:39 -0800
Subject: [squid-users] Fwd: WebSocket support in v4
In-Reply-To: <CA+dPJ1oYkknHG4OuAtLs_dJCZbshDUkP39_bEUTaPQA_jE05Qg@mail.gmail.com>
References: <CA+dPJ1oYkknHG4OuAtLs_dJCZbshDUkP39_bEUTaPQA_jE05Qg@mail.gmail.com>
Message-ID: <CA+dPJ1oGV=P+OayG+Emom0VhnzWWn9HB4RaaMkTE9856YP0Ehw@mail.gmail.com>

Hi,

Could you please let me know if squid v4 release supports websockets.

Thank you.
-Sreekanth
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230126/4199743c/attachment.htm>

From squid3 at treenet.co.nz  Fri Jan 27 12:36:05 2023
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Sat, 28 Jan 2023 01:36:05 +1300
Subject: [squid-users] Fwd: WebSocket support in v4
In-Reply-To: <CA+dPJ1oGV=P+OayG+Emom0VhnzWWn9HB4RaaMkTE9856YP0Ehw@mail.gmail.com>
References: <CA+dPJ1oYkknHG4OuAtLs_dJCZbshDUkP39_bEUTaPQA_jE05Qg@mail.gmail.com>
 <CA+dPJ1oGV=P+OayG+Emom0VhnzWWn9HB4RaaMkTE9856YP0Ehw@mail.gmail.com>
Message-ID: <9a9f060c-4552-6a52-1b81-26ac15f9a2c2@treenet.co.nz>

On 27/01/2023 8:18 pm, sreekanth guru wrote:
> Hi,
>
> Could you please let me know if squid v4 release supports websockets.

WebSockets is only supported in so far as it is rejected in the manner 
to correctly trigger WebSockets failover mechnism. That goes for Squid-5 
as well.

The upcoming Squid-6 brings HTTP Upgrade support to allow WebSockets to 
tunnel through a proxy much like HTTPS. That has not had much testing 
yet though so YMMV.

HTH
Amos



From uhlar at fantomas.sk  Fri Jan 27 13:19:32 2023
From: uhlar at fantomas.sk (Matus UHLAR - fantomas)
Date: Fri, 27 Jan 2023 14:19:32 +0100
Subject: [squid-users] Counting unique devices connected to squid proxy
In-Reply-To: <dd1dff9f-dd1b-149b-c7c5-abe9409716b3@gmail.com>
References: <CADAqQfxJbTXyJ=Eqyua5Q1L4HxwjL5T=XSHJVfyoKqUxbTJXzg@mail.gmail.com>
 <1d8a7528-28e3-b2c5-2f11-f39f47232fcf@urlfilterdb.com>
 <4d1ab8c8-e8a0-4fa4-f117-403cdc7a893d@treenet.co.nz>
 <dd1dff9f-dd1b-149b-c7c5-abe9409716b3@gmail.com>
Message-ID: <Y9PPZEZJGjF/vhDw@fantomas.sk>

>>On 20/01/2023 9:16 am, Marcus Kool wrote:
>>>The squid log file contains the IP address of clients and could be 
>>>a good field to use for counting users. But a NAT shows 1 IP for 
>>>all users behind the NAT...

>>>On 19/01/2023 15:48, Ben Goz wrote:
>>>>I have a certain task to count the number of unique devices 
>>>>connected (Could be also transparently) to squid proxy server. 
>>>>While the users can be on different networks and behind NAT.
>>>>Is it possible?

>On 21/01/2023 14:59, Amos Jeffries wrote:
>>No, not really. As Marcus said NAT erases information. As does any 
>>HTTP multiplexing being performed by downstream proxies.

On 22.01.23 14:37, Ben Goz wrote:
>Is it possible for squid to identify NAT?

not really.

>>>>What is the best approach?of implement?it?

>>Squid provides a management report "client_list" with all recently 
>>seen client devices. It is reliable for the *currently* connected 
>>clients, but once a client disconnects entries are discarded 
>>relative to how much traffic they have used.

>Does this report also words behind NAT? can you refer me to more 
>descriptive information about "client_list"?

you should understand that web pages consist of multiple (tens, hundreds) of 
objects and they are fetched using multiple HTTP transactions to multiple 
servers and between, connections may be closed between multiple clicks.

So, it's really hard to distinguish between one client fetching 100 objects 
from 10 servers and 5 clients fetching 20 objects from 2 servers each.


>>Or there are the logs which contain (or can be configured to record) 
>>a details of *completed* transactions.

-- 
Matus UHLAR - fantomas, uhlar at fantomas.sk ; http://www.fantomas.sk/
Warning: I wish NOT to receive e-mail advertising to this address.
Varovanie: na tuto adresu chcem NEDOSTAVAT akukolvek reklamnu postu.
42.7 percent of all statistics are made up on the spot.


From athos.ribeiro at canonical.com  Fri Jan 27 14:35:24 2023
From: athos.ribeiro at canonical.com (Athos Ribeiro)
Date: Fri, 27 Jan 2023 11:35:24 -0300
Subject: [squid-users] Question regarding the release process
In-Reply-To: <69e540e0-cf2b-3485-17da-9b2eed573d23@treenet.co.nz>
References: <Y8qs8S2xodhp8T8i@castor>
 <69e540e0-cf2b-3485-17da-9b2eed573d23@treenet.co.nz>
Message-ID: <Y9PhLIUSBZinRGBf@castor>

On Sun, Jan 22, 2023 at 02:55:54AM +1300, Amos Jeffries wrote:
>On 21/01/2023 4:02 am, Athos Ribeiro wrote:
>>Hi! I am trying to understand how accurate the discussion in
>>http://lists.squid-cache.org/pipermail/squid-dev/2015-March/001853.html
>>is nowadays,
>
>That discussion was the latest on Squid numbering. There have been 
>modifications to release timing, but the numbering still follows that 
>plan.
>
>>so I can understand the guides in
>>http://wiki.squid-cache.org/DeveloperResources/ReleaseProcess regarding
>>the release process.
>
>Feature changes should be proposed against the "master" branch in our 
>github. If/when accepted they become part of the next Squid-N release 
>series. Which are now on a 
><https://wiki.squid-cache.org/ReleaseSchedule>.
>
>Point releases within a series should only contain documentation 
>corrections, bug and security vulnerability fixes. Exception may occur 
>at the release maintainers choice.
>
>>What I am interested in understanding is if there is a hard commitment
>>on the backwards compatibility between point releases since 4.x.
>>In other words, is there any commitment for no feature changes between
>>5.x and 5.(x+1)?
>
>Yes. Feature changes should only occur between Squid-(N).x and 
>Squid-(N+m).x with non-0 'm'.
>
>HTH

It does. Thanks, Amos!

>Amos

-- 
Athos Ribeiro


From gustavocarv4872 at gmail.com  Fri Jan 27 22:27:59 2023
From: gustavocarv4872 at gmail.com (Gustavo Carvalho)
Date: Fri, 27 Jan 2023 19:27:59 -0300
Subject: [squid-users] Squid use all memory ram
In-Reply-To: <CAL34ibmo7p51ZEUhW=JOQp8YAH72bZMrjh4RwhJ-JHb4F8XZkg@mail.gmail.com>
References: <CAL5gn0WmNXX5ikV-4yuEKKsOBhxFyBwag+d5p9DRGG9PE+BL6g@mail.gmail.com>
 <CAL34ibmo7p51ZEUhW=JOQp8YAH72bZMrjh4RwhJ-JHb4F8XZkg@mail.gmail.com>
Message-ID: <CAL5gn0VWzntX-1SVZ0O_8qE=DTC_WycKRbrOaSdqGJ5J90TZGg@mail.gmail.com>

Hi Hamilton, thanks for helping!

I wish I could provide this log while squid is crashing, but there
have been no incidents since wednesday. From what I've heard, the RAM
on that server's VM has been increased to 32GB.

Anyway, here is the squidclient mgr:mem log output. I hope it can be helpful.

On Thu, Jan 26, 2023 at 5:43 PM Hamilton Coutinho
<hamilton.coutinho at gmail.com> wrote:
>
> Hi Gustavo,
>
> I'm seeing the same thing. I could narrow down (but can't say with 100% confidence) to the code that does certificate verification when configured for SSL decryption. What is the output of squidclient mgr:mem for you? Do you see unexplainably high counts for in-use objects like HttpRequest, PeekingPeerConnector, Comm::Connection, Security::ErrorDetail?
>
>
> On Thu, Jan 26, 2023 at 12:31 PM Gustavo Carvalho <gustavocarv4872 at gmail.com> wrote:
>>
>> Hi,
>>
>> I have Squid 5.6 on a FreeBSD 13.1 server with 16GB RAM
>>
>> I noticed that squid starts to consume a lot of ram until it starts to
>> consume swap space. When this happens, browsing becomes extremely
>> slow.
>>
>> This is happening at least once a week when I have to restart squid to
>> get it back to normal.
>>
>> Any ideas?
>>
>> ############# Wed Jan 25 08:30:00 -03 2023 #############
>>
>> HTTP/1.1 200 OK
>> Server: squid
>> Mime-Version: 1.0
>> Date: Wed, 25 Jan 2023 11:30:00 GMT
>> Content-Type: text/plain;charset=utf-8
>> Expires: Wed, 25 Jan 2023 11:30:00 GMT
>> Last-Modified: Wed, 25 Jan 2023 11:30:00 GMT
>> X-Cache: MISS from xxxx.xxxx.xxxx
>> X-Cache-Lookup: MISS from xxxx.xxxx.xxxx:3128
>> Via: 1.1 xxxx.xxxx.xxxx (squid)
>> Connection: close
>>
>> Squid Object Cache: Version 5.6
>> Build Info:
>> Service Name: squid
>> Start Time: Thu, 19 Jan 2023 20:25:17 GMT
>> Current Time: Wed, 25 Jan 2023 11:30:00 GMT
>> Connection information for squid:
>>      Number of clients accessing cache: 224
>>      Number of HTTP requests received: 7541590
>>      Number of ICP messages received: 0
>>      Number of ICP messages sent: 0
>>      Number of queued ICP replies: 0
>>      Number of HTCP messages received: 0
>>      Number of HTCP messages sent: 0
>>      Request failure ratio: 0.00
>>      Average HTTP requests per minute since start: 930.5
>>      Average ICP messages per minute since start: 0.0
>>      Select loop called: 78733524 times, 6.176 ms avg
>> Cache information for squid:
>>      Hits as % of all requests: 5min: 8.4%, 60min: 12.1%
>>      Hits as % of bytes sent: 5min: 21.6%, 60min: 14.1%
>>      Memory hits as % of hit requests: 5min: 90.8%, 60min: 75.9%
>>      Disk hits as % of hit requests: 5min: 4.0%, 60min: 19.7%
>>      Storage Swap size: 2829956 KB
>>      Storage Swap capacity: 90.0% used, 10.0% free
>>      Storage Mem size: 16172 KB
>>      Storage Mem capacity: 98.7% used,  1.3% free
>>      Mean Object Size: 28.95 KB
>>      Requests given to unlinkd: 186982
>> Median Service Times (seconds)  5 min    60 min:
>> HTTP Requests (All):   0.00562  0.01847
>>      Cache Misses:          0.15048  0.23230
>>      Cache Hits:            0.00000  0.00000
>>      Near Hits:             0.14252  0.13498
>>      Not-Modified Replies:  0.00865  0.03066
>>      DNS Lookups:           0.00000  0.00372
>>      ICP Queries:           0.00000  0.00000
>> Resource usage for squid:
>>      UP Time: 486282.612 seconds
>>      CPU Time: 65555.712 seconds
>>      CPU Usage: 13.48%
>>      CPU Usage, 5 minute avg: 26.89%
>>      CPU Usage, 60 minute avg: 68.00%
>>      Maximum Resident Size: 37896960 KB
>>      Page faults with physical i/o: 10843
>> Memory accounted for:
>>      Total accounted:       -1459461 KB
>>      memPoolAlloc calls:     11408
>>      memPoolFree calls:  1888969689
>> File descriptor usage for squid:
>>      Maximum number of file descriptors:   4096
>>      Largest file desc currently in use:   2149
>>      Number of file desc currently in use:  679
>>      Files queued for open:                   0
>>      Available number of file descriptors: 3417
>>      Reserved number of file descriptors:   100
>>      Store Disk files open:                   0
>> Internal Data Structures:
>>      97906 StoreEntries
>>      3002 StoreEntries with MemObjects
>>      2838 Hot Object Cache Items
>>      97742 on-disk objects
>>
>> ------ pfctl -si ------
>>
>> Status: Enabled for 25 days 22:58:24          Debug: Urgent
>>
>> State Table                          Total             Rate
>>   current entries                     8085
>>   searches                      6650475717         2965.4/s
>>   inserts                        133521957           59.5/s
>>   removals                       133552376           59.5/s
>> Counters
>>   match                          605960865          270.2/s
>>   bad-offset                             0            0.0/s
>>   fragment                               1            0.0/s
>>   short                                 54            0.0/s
>>   normalize                            659            0.0/s
>>   memory                                 0            0.0/s
>>   bad-timestamp                          0            0.0/s
>>   congestion                             0            0.0/s
>>   ip-option                              0            0.0/s
>>   proto-cksum                            0            0.0/s
>>   state-mismatch                    104674            0.0/s
>>   state-insert                       38501            0.0/s
>>   state-limit                            0            0.0/s
>>   src-limit                              0            0.0/s
>>   synproxy                               0            0.0/s
>>   map-failed                             0            0.0/s
>>
>> ------ sysctl -a | grep swap  ------
>>
>> swap_pager: out of swap space
>> swp_pager_getswapspace(32): failed
>> swap_pager: out of swap space
>> swp_pager_getswapspace(31): failed
>> swap_pager: out of swap space
>> swp_pager_getswapspace(1): failed
>> 1 PART da0p2 2147483648 512 i 2 o 544768 ty freebsd-swap xs GPT xt
>> 516e7cb5-6ecf-11d6-8ff8-00022d09712b
>> 0 MD md1 94371840 512 u 1 s 512 f 0 fs 0 l 94371840 t swap label
>> 0 MD md0 62914560 512 u 0 s 512 f 0 fs 0 l 62914560 t swap label
>> z0xfffff80003ec5800 [shape=box,label="SWAP\nswap\nr#3"];
>>       <name>swap</name>
>>     <type>swap</type>
>>     <type>swap</type>
>>     <type>freebsd-swap</type>
>> vm.swap_enabled: 1
>> vm.domain.0.stats.unswappable: 2044
>> vm.swap_idle_threshold2: 10
>> vm.swap_idle_threshold1: 2
>> vm.swap_idle_enabled: 0
>> vm.disable_swapspace_pageouts: 0
>> vm.stats.vm.v_swappgsout: 3154299
>> vm.stats.vm.v_swappgsin: 510404
>> vm.stats.vm.v_swapout: 174446
>> vm.stats.vm.v_swapin: 62590
>> vm.stats.swap.free_completed: 54375
>> vm.stats.swap.free_deferred: 56992
>> vm.nswapdev: 1
>> vm.swap_fragmentation:
>> vm.swap_async_max: 4
>> vm.swap_maxpages: 32572800
>> vm.swap_total: 2147483648
>> vm.swap_reserved: 384676114432
>>
>> ------ /usr/sbin/swapinfo -h  ------
>>
>> Device              Size     Used    Avail Capacity
>> /dev/da0p2          2.0G     2.0G     8.0K   100%
>>
>>
>> ############# squid.conf #############
>>
>> http_port 3128 ssl-bump generate-host-certificates=on
>> dynamic_cert_mem_cache_size=20MB cert=/xxxx/conf/certs/ca.crt
>> key=/xxxx/conf/certs/ca.key
>> http_port 3129 intercept
>> https_port 3130 intercept ssl-bump generate-host-certificates=on
>> dynamic_cert_mem_cache_size=20MB cert=/xxxx/conf/certs/ca.crt
>> key=/xxxx/conf/certs/ca.key
>> visible_hostname xxxx.xxxx.xxxx
>> max_filedescriptors 4096
>> maximum_object_size 4096 KB
>> minimum_object_size 0 KB
>> maximum_object_size_in_memory 256 KB
>> fqdncache_size 1024
>> cache_mgr xxxx at xxxx
>> dns_nameservers 127.0.0.1
>> cache_replacement_policy                heap LFUDA
>> memory_replacement_policy               heap GDSF
>> cache_mem 16 MB
>> cache_dir               ufs /xxxx/chroot/osproxy/cache 3072 32 256
>> forwarded_for on
>> memory_pools off
>> logformat xxxx %ts|%6tr|%>a|%Ss|%03>Hs|%<st|%rm|%un|%mt|%ea|%ru
>> logfile_rotate 0
>> httpd_suppress_version_string on
>> strip_query_terms off
>> _______________________________________________
>> squid-users mailing list
>> squid-users at lists.squid-cache.org
>> http://lists.squid-cache.org/listinfo/squid-users
>
>
>
> --
> Hamilton
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users
-------------- next part --------------
stub time| WARNING: BCP 177 violation. IPv6 transport forced OFF by build parameters.
HTTP/1.1 200 OK
Server: squid
Mime-Version: 1.0
Date: Fri, 27 Jan 2023 22:04:09 GMT
Content-Type: text/plain;charset=utf-8
Expires: Fri, 27 Jan 2023 22:04:09 GMT
Last-Modified: Fri, 27 Jan 2023 22:04:09 GMT
Connection: close

Current memory usage:
Pool     Obj Size       Chunks                                                  Allocated                                       In Use                                  Idle                    Allocations Saved                       Rate
         (bytes)        KB/ch    obj/ch (#)      used    free    part    %Frag   (#)     (KB)    high (KB)       high (hrs)      %Tot   (#)      (KB)    high (KB)       high (hrs)      %alloc (#)      (KB)    high (KB)      (#)      %cnt    %vol   (#)/sec
HttpRequest              1872                                                            5573    10189   10209   0.01    18.345  5573    10189   10209   0.01    100.000         0       0       0       0       0.000   0.000   1.543
mem_node                 4136                                                            2493    10070   10086   0.01    18.131  2493    10070   10086   0.01    100.000         0       0       0       0       0.000   0.000   1.334
StoreEntry                104                                                            87775   8915    8962    1.17    16.052  87775   8915    8962    1.17    100.000         0       0       0       0       0.000   0.000   1.126
Long Strings              512                                                            12581   6291    6301    0.00    11.327  12581   6291    6301    0.00    100.000         0       0       1       12      0.000   0.000   7.131
cbdata Server (13)        776                                                            5519    4183    4193    0.01    7.531   5519    4183    4193    0.01    100.000         0       0       0       0       0.000   0.000   0.959
Short Strings              40                                                            88539   3459    3610    0.22    6.227   88539   3459    3610    0.22    100.000         0       0       29      5051    0.038   0.006   119.766
HttpReply                 296                                                            6390    1848    1850    0.01    3.326   6390    1848    1850    0.01    100.000         0       0       0       0       0.000   0.000   3.795
cbdata PeekingPeerConnector (28)          288                                                            5394    1518    1518    0.01    2.732   5394    1518    1518    0.01    100.000         0       0       0       0       0.000   0.000   0.125
MemBlob                    48                                                            31859   1494    1649    0.25    2.689   31859   1494    1649    0.25    100.000         0       0       34      5167    0.039   0.007   65.304
MD5 digest                 16                                                            87775   1372    1379    1.17    2.469   87775   1372    1379    1.17    100.000         0       0       0       0       0.000   0.000   1.209
Comm::Connection          216                                                            5580    1178    1183    0.02    2.119   5580    1178    1183    0.02    100.000         0       0       0       0       0.000   0.000   3.128
HttpHeaderEntry            56                                                            17658   966     1145    0.25    1.739   17658   966     1145    0.25    100.000         0       0       0       0       0.000   0.000   33.152
Security::ErrorDetail     168                                                            5377    883     883     0.01    1.588   5377    883     883     0.01    100.000         0       0       0       0       0.000   0.000   0.250
cbdata Downloader (29)    152                                                            5394    801     801     0.01    1.442   5394    801     801     0.01    100.000         0       0       0       0       0.000   0.000   0.125
4KB Strings              4096                                                            177     708     4032    1.27    1.275   177     708     4032    1.27    100.000         0       0       4       60      0.000   0.007   2.919
Medium Strings            128                                                            2399    300     317     0.11    0.540   2399    300     317     0.11    100.000         0       0       2       32      0.000   0.000   3.336
16KB Strings             16384                                                           15      240     1328    0.78    0.432   15      240     1328    0.78    100.000         0       0       0       0       0.000   0.000   0.959
MemObject                 328                                                            704     226     236     0.11    0.406   704     226     236     0.11    100.000         0       0       0       0       0.000   0.000   1.126
32K Buffer               32768                                                           7       224     800     0.18    0.403   7       224     800     0.18    100.000         0       0       0       0       0.000   0.000   0.000
cbdata ipcache_entry (5)          200                                                            471     92      98      0.18    0.166   471     92      98      0.18    100.000         0       0       0       0       0.000   0.000   0.667
Entry                      72                                                            1028    73      120     0.63    0.130   1028    73      120     0.63    100.000         0       0       0       0       0.000   0.000   156.796
HttpHdrCc                  96                                                            739     70      72      0.11    0.125   739     70      72      0.11    100.000         0       0       0       0       0.000   0.000   1.043
acl_proxy_auth_match_cache         40                                                            1473    58      145     0.60    0.104   1473    58      145     0.60    100.000         0       0       0       0       0.000   0.000   1.668
acl_ip_data                96                                                            509     48      48      0.05    0.086   509     48      48      0.05    100.000         0       0       1       876     0.007   0.002   0.000
ClientInfo                464                                                            101     46      46      0.56    0.082   101     46      46      0.56    100.000         0       0       0       0       0.000   0.000   0.000
cbdata clientReplyContext (17)   4352                                                            8       34      370     1.19    0.061   8       34      370     1.19    100.000         0       0       0       0       0.000   0.000   1.543
Stream                   4224                                                            8       33      359     1.19    0.059   8       33      359     1.19    100.000         0       0       0       0       0.000   0.000   1.418
1KB Strings              1024                                                            32      32      44      0.18    0.058   32      32      44      0.18    100.000         0       0       1       14      0.000   0.000   0.792
Auth::Negotiate::User     216                                                            126     27      32      0.18    0.048   126     27      32      0.18    100.000         0       0       0       0       0.000   0.000   0.209
fqdncache_entry           160                                                            155     25      25      0.56    0.044   155     25      25      0.56    100.000         0       0       0       0       0.000   0.000   0.250
AndNode                   120                                                            177     21      21      1.36    0.037   177     21      21      1.36    100.000         0       0       0       0       0.000   0.000   0.000
MimeEntry                 112                                                            177     20      20      1.37    0.035   177     20      20      1.37    100.000         0       0       0       0       0.000   0.000   0.000
cbdata IdleConnList (40)         4168                                                            3       13      29      0.65    0.022   3       13      29      0.65    100.000         0       0       0       0       0.000   0.000   0.250
2K Buffer                2048                                                            5       10      58      1.37    0.018   5       10      58      1.37    100.000         0       0       4       179     0.001   0.010   6.922
ACLStrategised            120                                                            72      9       9       1.37    0.015   72      9       9       1.37    100.000         0       0       0       0       0.000   0.000   0.000
AuthUserIP                 64                                                            131     9       10      0.56    0.015   131     9       10      0.56    100.000         0       0       0       0       0.000   0.000   0.000
4K Buffer                4096                                                            2       8       24      1.08    0.014   2       8       24      1.08    100.000         0       0       0       0       0.000   0.000   0.584
IndividualPool           1336                                                            5       7       21      1.17    0.012   5       7       21      1.17    100.000         0       0       0       0       0.000   0.000   0.000
ACLProxyAuth              112                                                            49      6       6       1.37    0.010   49      6       6       1.37    100.000         0       0       0       0       0.000   0.000   0.000
ACLSourceIP               104                                                            42      5       5       1.37    0.008   42      5       5       1.37    100.000         0       0       0       0       0.000   0.000   0.000
wordlist                   16                                                            270     5       5       0.05    0.008   270     5       5       0.05    100.000         0       0       0       0       0.000   0.000   0.000
cbdata ACLFilledChecklist (20)    472                                                            8       4       24      0.77    0.007   8       4       24      0.77    100.000         0       0       0       0       0.000   0.000   3.294
ev_entry                   48                                                            71      4       4       0.05    0.006   71      4       4       0.05    100.000         0       0       0       0       0.000   0.000   2.419
cbdata Tree (3)           176                                                            19      4       5       1.17    0.006   19      4       5       1.17    100.000         0       0       0       0       0.000   0.000   0.000
cbdata ClientHttpRequest (16)     408                                                            8       4       35      1.19    0.006   8       4       35      1.19    100.000         0       0       0       0       0.000   0.000   1.543
ACLUserData                48                                                            49      3       3       1.37    0.004   49      3       3       1.37    100.000         0       0       0       0       0.000   0.000   0.000
cbdata Logfile (10)      1120                                                            2       3       3       1.37    0.004   2       3       3       1.37    100.000         0       0       0       0       0.000   0.000   0.000
cbdata clientStreamNode (18)      128                                                            16      2       22      1.19    0.004   16      2       22      1.19    100.000         0       0       0       0       0.000   0.000   3.086
cbdata store_client (23)          168                                                            12      2       10      0.78    0.004   12      2       10      0.78    100.000         0       0       0       0       0.000   0.000   1.585
cbdata helper_server (7)          320                                                            5       2       4       1.37    0.003   5       2       4       1.37    100.000         0       0       0       0       0.000   0.000   0.000
ACLRegexData               32                                                            48      2       2       1.37    0.003   48      2       2       1.37    100.000         0       0       0       0       0.000   0.000   0.000
cbdata TunnelStateData (42)       496                                                            3       2       40      1.19    0.003   3       2       40      1.19    100.000         0       0       0       0       0.000   0.000   0.042
cbdata HttpStateData (39)         368                                                            4       2       5       0.78    0.003   4       2       5       0.78    100.000         0       0       0       0       0.000   0.000   0.250
cbdata FwdState (24)      304                                                            4       2       9       0.78    0.002   4       2       9       0.78    100.000         0       0       0       0       0.000   0.000   0.375
cbdata HappyConnOpener (26)       376                                                            3       2       31      1.19    0.002   3       2       31      1.19    100.000         0       0       0       0       0.000   0.000   0.417
DelayVector::Id            56                                                            15      1       6       1.19    0.001   15      1       6       1.19    100.000         0       0       0       0       0.000   0.000   2.961
Auth::Negotiate::UserRequest       88                                                            9       1       6       1.34    0.001   9       1       6       1.34    100.000         0       0       0       0       0.000   0.000   0.209
NullDelayId                24                                                            30      1       5       1.19    0.001   30      1       5       1.19    100.000         0       0       0       0       0.000   0.000   5.922
cbdata ServerBump (22)     88                                                            7       1       5       0.77    0.001   7       1       5       0.77    100.000         0       0       0       0       0.000   0.000   0.250
ACLStrategised            120                                                            5       1       1       1.37    0.001   5       1       1       1.37    100.000         0       0       0       0       0.000   0.000   0.000
cbdata helper (6)         280                                                            2       1       1       1.37    0.001   2       1       1       1.37    100.000         0       0       0       0       0.000   0.000   0.000
cbdata helper_stateful_server (37)        272                                                            2       1       6       0.18    0.001   2       1       6       0.18    100.000         0       0       0       0       0.000   0.000   0.000
ResolvedPeers              72                                                            7       1       7       1.19    0.001   7       1       7       1.19    100.000         0       0       0       0       0.000   0.000   0.417
ACLDomainData              16                                                            24      1       1       1.37    0.001   24      1       1       1.37    100.000         0       0       0       0       0.000   0.000   0.000
NotNode                   120                                                            3       1       1       1.37    0.001   3       1       1       1.37    100.000         0       0       0       0       0.000   0.000   0.000
cbdata MemBuf (8)          72                                                            5       1       1       1.37    0.001   5       1       1       1.37    100.000         0       0       0       0       0.000   0.000   1.543
ACLStrategised            120                                                            3       1       1       1.37    0.001   3       1       1       1.37    100.000         0       0       0       0       0.000   0.000   0.000
cbdata statefulhelper (9)         320                                                            1       1       1       1.37    0.001   1       1       1       1.37    100.000         0       0       0       0       0.000   0.000   0.000
cbdata TcpAcceptor (12)   104                                                            3       1       1       1.37    0.001   3       1       1       1.37    100.000         0       0       0       0       0.000   0.000   0.000
cbdata Address (4)         72                                                            4       1       1       1.36    0.001   4       1       1       1.36    100.000         0       0       0       0       0.000   0.000   0.000
DelayVector                56                                                            5       1       1       1.17    0.000   5       1       1       1.17    100.000         0       0       0       0       0.000   0.000   0.000
Aggregate                  56                                                            5       1       1       1.17    0.000   5       1       1       1.17    100.000         0       0       0       0       0.000   0.000   0.000
ACLSslErrorData            48                                                            5       1       1       1.37    0.000   5       1       1       1.37    100.000         0       0       0       0       0.000   0.000   0.000
ACLStrategised            120                                                            2       1       1       1.37    0.000   2       1       1       1.37    100.000         0       0       0       0       0.000   0.000   0.000
cbdata external_acl (2)   240                                                            1       1       1       1.37    0.000   1       1       1       1.37    100.000         0       0       0       0       0.000   0.000   0.000
ACLDestinationIP          112                                                            2       1       1       1.37    0.000   2       1       1       1.37    100.000         0       0       0       0       0.000   0.000   0.000
cbdata RemovalPolicy (1)          104                                                            2       1       1       1.37    0.000   2       1       1       1.37    100.000         0       0       0       0       0.000   0.000   0.000
ACLTimeData                32                                                            6       1       1       1.37    0.000   6       1       1       1.37    100.000         0       0       0       0       0.000   0.000   0.000
ACLStrategised            120                                                            1       1       1       1.37    0.000   1       1       1       1.37    100.000         0       0       0       0       0.000   0.000   0.000
ACLStrategised            120                                                            1       1       1       1.37    0.000   1       1       1       1.37    100.000         0       0       0       0       0.000   0.000   0.000
cbdata LocalSearch (21)    80                                                            1       1       1       1.37    0.000   1       1       1       1.37    100.000         0       0       0       0       0.000   0.000   0.000
cbdata CredentialsCache (38)       80                                                            1       1       1       1.37    0.000   1       1       1       1.37    100.000         0       0       0       0       0.000   0.000   0.000
ACLMethodData              32                                                            2       1       1       1.37    0.000   2       1       1       1.37    100.000         0       0       0       0       0.000   0.000   0.000
CacheDigest                40                                                            1       1       1       1.37    0.000   1       1       1       1.37    100.000         0       0       0       0       0.000   0.000   0.000
ACLProtocolData            32                                                            1       1       1       1.37    0.000   1       1       1       1.37    100.000         0       0       0       0       0.000   0.000   0.000
CommonPool                 24                                                            1       1       1       1.37    0.000   1       1       1       1.37    100.000         0       0       1       1       0.000   0.000   0.000
8K Buffer                8192                                                            0       0       64      1.34    0.000   0       0       64      1.34    -1.000  0       0       0       0       0.000   0.000   0.000
HttpHdrRange               32                                                            0       0       1       1.37    0.000   0       0       1       1.37    -1.000  0       0       0       0       0.000   0.000   0.000
HttpHdrRangeSpec           16                                                            0       0       1       1.37    0.000   0       0       1       1.37    -1.000  0       0       0       0       0.000   0.000   0.000
HttpHdrContRange           24                                                            0       0       1       1.37    0.000   0       0       1       1.37    -1.000  0       0       0       0       0.000   0.000   0.000
cbdata CbDataList (43)     96                                                            0       0       1       1.37    0.000   0       0       1       1.37    -1.000  0       0       0       0       0.000   0.000   0.000
SysErrorDetail             32                                                            0       0       1       0.76    0.000   0       0       1       0.76    -1.000  0       0       0       0       0.000   0.000   0.000
ExceptionErrorDetail       32                                                            0       0       1       1.37    0.000   0       0       1       1.37    -1.000  0       0       0       0       0.000   0.000   0.000
StoreMetaVary              32                                                            0       0       1       1.36    0.000   0       0       1       1.36    -1.000  0       0       0       0       0.000   0.000   0.000
cbdata RemovalPolicyWalker (44)    56                                                            0       0       1       1.24    0.000   0       0       1       1.24    -1.000  0       0       0       0       0.000   0.000   0.000
cbdata RebuildState (11)          920                                                            0       0       1       1.37    0.000   0       0       1       1.37    -1.000  0       0       0       0       0.000   0.000   0.000
cbdata RemovalPurgeWalker (45)     72                                                            0       0       1       1.17    0.000   0       0       1       1.17    -1.000  0       0       0       0       0.000   0.000   0.000
StoreSwapLogData           72                                                            0       0       1       1.37    0.000   0       0       1       1.37    -1.000  0       0       0       0       0.000   0.000   0.083
cbdata generic_cbdata (14)         32                                                            0       0       2       1.37    0.000   0       0       2       1.37    -1.000  0       0       0       0       0.000   0.000   0.292
cbdata idns_query (15)   8704                                                            0       0       944     1.37    0.000   0       0       944     1.37    -1.000  0       0       0       0       0.000   0.000   0.917
cbdata ClientRequestContext (19)          104                                                            0       0       5       1.37    0.000   0       0       5       1.37    -1.000  0       0       0       0       0.000   0.000   1.293
BodyPipe                  136                                                            0       0       2       1.35    0.000   0       0       2       1.35    -1.000  0       0       0       0       0.000   0.000   0.000
cbdata PeerSelector (25)          296                                                            0       0       1       1.37    0.000   0       0       1       1.37    -1.000  0       0       0       0       0.000   0.000   0.417
FwdServer                  32                                                            0       0       1       1.37    0.000   0       0       1       1.37    -1.000  0       0       0       0       0.000   0.000   0.417
cbdata ConnOpener (27)    144                                                            0       0       3       0.92    0.000   0       0       3       0.92    -1.000  0       0       0       0       0.000   0.000   0.250
DownloaderContext        4144                                                            0       0       9       0.35    0.000   0       0       9       0.35    -1.000  0       0       0       0       0.000   0.000   0.125
cbdata UFSStoreState (30)         264                                                            0       0       4       1.34    0.000   0       0       4       1.34    -1.000  0       0       0       0       0.000   0.000   0.042
cbdata BlockingFile (31)           88                                                            0       0       2       1.34    0.000   0       0       2       1.34    -1.000  0       0       0       0       0.000   0.000   0.042
cbdata ReadRequest (32)    72                                                            0       0       1       1.36    0.000   0       0       1       1.36    -1.000  0       0       0       0       0.000   0.000   0.000
StoreMetaMD5               32                                                            0       0       1       1.37    0.000   0       0       1       1.37    -1.000  0       0       0       0       0.000   0.000   0.042
StoreMetaSTDLFS            32                                                            0       0       1       1.37    0.000   0       0       1       1.37    -1.000  0       0       0       0       0.000   0.000   0.042
StoreMetaURL               32                                                            0       0       1       1.37    0.000   0       0       1       1.37    -1.000  0       0       0       0       0.000   0.000   0.042
StoreMetaObjSize           32                                                            0       0       1       1.37    0.000   0       0       1       1.37    -1.000  0       0       0       0       0.000   0.000   0.042
cbdata CbDataList (33)     56                                                            0       0       1       1.37    0.000   0       0       1       1.37    -1.000  0       0       0       0       0.000   0.000   0.250
cbdata ErrorState (34)    272                                                            0       0       1       1.31    0.000   0       0       1       1.31    -1.000  0       0       0       0       0.000   0.000   0.667
cbdata GeneratorRequest (35)       72                                                            0       0       1       1.37    0.000   0       0       1       1.37    -1.000  0       0       0       0       0.000   0.000   0.125
Helper::Xaction           176                                                            0       0       4       0.18    0.000   0       0       4       0.18    -1.000  0       0       0       0       0.000   0.000   0.334
cbdata StateData (36)      48                                                            0       0       1       0.18    0.000   0       0       1       0.18    -1.000  0       0       0       0       0.000   0.000   0.209
dwrite_q                   48                                                            0       0       1       1.37    0.000   0       0       1       1.37    -1.000  0       0       0       0       0.000   0.000   0.167
dread_ctrl                 56                                                            0       0       1       1.36    0.000   0       0       1       1.36    -1.000  0       0       0       0       0.000   0.000   0.000
16K Buffer               16384                                                           0       0       48      1.33    0.000   0       0       48      1.33    -1.000  0       0       0       0       0.000   0.000   0.000
cbdata WriteRequest (41)           80                                                            0       0       1       1.37    0.000   0       0       1       1.37    -1.000  0       0       0       0       0.000   0.000   0.083
Total                       1                                                            377201  55538   55686   0.00    100.000         377201  55538   55686   0.00    100.000         0       0       1       11392   0.086   0.032   552659.839
Cumulative allocated volume: 3.623 GB
Current overhead: 34651 bytes (0.061%)
Idle pool limit: 0.00 MB
Total Pools created: 123
Pools ever used:     122 (shown above)
Currently in use:    86
String Pool      Impact
         (%strings)      (%volume)
Short Strings            85      28
Medium Strings           2       2
Long Strings             12      52
1KB Strings              0       0
4KB Strings              0       6
16KB Strings             0       2
Other Strings            0       9

Large buffers: 0 (0 KB)

From sreekanth.iitb at gmail.com  Tue Jan 31 01:17:06 2023
From: sreekanth.iitb at gmail.com (sreekanth guru)
Date: Mon, 30 Jan 2023 17:17:06 -0800
Subject: [squid-users] Fwd: WebSocket support in v4
In-Reply-To: <9a9f060c-4552-6a52-1b81-26ac15f9a2c2@treenet.co.nz>
References: <CA+dPJ1oYkknHG4OuAtLs_dJCZbshDUkP39_bEUTaPQA_jE05Qg@mail.gmail.com>
 <CA+dPJ1oGV=P+OayG+Emom0VhnzWWn9HB4RaaMkTE9856YP0Ehw@mail.gmail.com>
 <9a9f060c-4552-6a52-1b81-26ac15f9a2c2@treenet.co.nz>
Message-ID: <CA+dPJ1p1BH51TC01OKEcSrp7za7g3Xzyv-=H9cv+MhEqtYZ+kg@mail.gmail.com>

Hi Amos,

Thank you for your reply.

Currently WebSockets failover is not a requirement for me. I have a
followup question. For HTTPS web sockets as it uses TCP tunnel, it should
work on all the versions of Squid proxy, is my understanding correct?

Also For HTTP websockets is there any squid(v6) beta version to play around
in dev environments?

Thank you.

-Sreekanth



On Fri, Jan 27, 2023 at 4:36 AM Amos Jeffries <squid3 at treenet.co.nz> wrote:

> On 27/01/2023 8:18 pm, sreekanth guru wrote:
> > Hi,
> >
> > Could you please let me know if squid v4 release supports websockets.
>
> WebSockets is only supported in so far as it is rejected in the manner
> to correctly trigger WebSockets failover mechnism. That goes for Squid-5
> as well.
>
> The upcoming Squid-6 brings HTTP Upgrade support to allow WebSockets to
> tunnel through a proxy much like HTTPS. That has not had much testing
> yet though so YMMV.
>
> HTH
> Amos
>
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230130/814bad0d/attachment.htm>

From ankor2023 at gmail.com  Tue Jan 31 03:55:21 2023
From: ankor2023 at gmail.com (Andrey K)
Date: Tue, 31 Jan 2023 06:55:21 +0300
Subject: [squid-users] Logging failed authentication attempts
Message-ID: <CADJd0Y0AcPijeatbR22MpguN0k+WuhkOk0c3bJgS+qe+6-ny8w@mail.gmail.com>

Hello,

I need to log failed Proxy-authentication attempts. The log information
should contain timestamp, username and client IP address.
407-records in the access.log file do not contain username if
NTLM-authentication is used.
I was wondering if it is possible to set up such a configuration?

Kind regards,
    Ankor.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230131/a6c9cc50/attachment.htm>

From squid3 at treenet.co.nz  Tue Jan 31 04:09:38 2023
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Tue, 31 Jan 2023 17:09:38 +1300
Subject: [squid-users] Logging failed authentication attempts
In-Reply-To: <CADJd0Y0AcPijeatbR22MpguN0k+WuhkOk0c3bJgS+qe+6-ny8w@mail.gmail.com>
References: <CADJd0Y0AcPijeatbR22MpguN0k+WuhkOk0c3bJgS+qe+6-ny8w@mail.gmail.com>
Message-ID: <0eec88b9-1e25-06d5-a14d-8897d786a338@treenet.co.nz>

On 31/01/2023 4:55 pm, Andrey K wrote:
> Hello,
>
> I need to log failed Proxy-authentication attempts. The log 
> information should contain timestamp, username and client IP address.
> 407-records in the access.log file do not contain username if 
> NTLM-authentication is used.
> I was wondering if it is possible to set up?such?a configuration?

Squid log entries record username for all authentication types as soon 
as a username exists.
I expect you are being confused by log records for the part of NTLM 
handshake before the username is sent to Squid.

Amos



From ankor2023 at gmail.com  Tue Jan 31 04:56:59 2023
From: ankor2023 at gmail.com (Andrey K)
Date: Tue, 31 Jan 2023 07:56:59 +0300
Subject: [squid-users] Logging failed authentication attempts
In-Reply-To: <0eec88b9-1e25-06d5-a14d-8897d786a338@treenet.co.nz>
References: <CADJd0Y0AcPijeatbR22MpguN0k+WuhkOk0c3bJgS+qe+6-ny8w@mail.gmail.com>
 <0eec88b9-1e25-06d5-a14d-8897d786a338@treenet.co.nz>
Message-ID: <CADJd0Y0eBcU85aNUqzHnV=wabKD_GC8m0GqW2SUzyZM7-UDJHA@mail.gmail.com>

Hello Amos,

Thank you for the information.

I turned on squid debug_options 84,9 and see in the cashe.log that in the
first NTLM_NEGOTIATE request (YR) there is no username:
TlRMTVNTUAABAAAABoIIAAAAAAAAAAAAAAAAAAAAAAA=
00000000  4e 54 4c 4d 53 53 50 00  01 00 00 00 06 82 08 00
 |NTLMSSP.........|
00000010  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
 |................|

so SQUID responded with the NTLMSSP_CHALLENGE (TT).

But in the second NTLMSSP_AUTH request (KK) client sends username (
sa0000bcmon) as well as hostname (0001bcreport02):
TlRMTVNTUAADAAAAGAAYAEAAAAAYABgAWAAAAAAAAABwAAAACwALAHAAAAAOAA4AewAAAAAAAAAAAAAABoKJAm44QOlyF2D5AAAAAAAAAAAAAAAAAAAAAJKh7kcqRqVVNSgqcPvvcdzH8RvXVpAE4nNhMDAwMGJjbW9uMDAwMWJjcmVwb3J0MDI=

00000000  4e 54 4c 4d 53 53 50 00  03 00 00 00 18 00 18 00
 |NTLMSSP.........|
00000010  40 00 00 00 18 00 18 00  58 00 00 00 00 00 00 00
 |@.......X.......|
00000020  70 00 00 00 0b 00 0b 00  70 00 00 00 0e 00 0e 00
 |p.......p.......|
00000030  7b 00 00 00 00 00 00 00  00 00 00 00 06 82 89 02
 |{...............|
00000040  6e 38 40 e9 72 17 60 f9  00 00 00 00 00 00 00 00  |n8@
.r.`.........|
00000050  00 00 00 00 00 00 00 00  92 a1 ee 47 2a 46 a5 55
 |...........G*F.U|
00000060  35 28 2a 70 fb ef 71 dc  c7 f1 1b d7 56 90 04 e2
 |5(*p..q.....V...|
00000070  73 61 30 30 30 30 62 63  6d 6f 6e 30 30 30 31 62
 |sa0000bcmon0001b|
00000080  63 72 65 70 6f 72 74 30  32                       |creport02|

Client uses wrong password to calculate NTLM response so helper returns
NT_STATUS_LOGON_FAILURE:
2023/01/31 07:21:18.916 kid2| 84,9| helper.cc(666) submit: placeholder:
'0',  buf[188]=KK
TlRMTVNTUAADAAAAGAAYAEAAAAAYABgAWAAAAAAAAABwAAAACwALAHAAAAAOAA4AewAAAAAAAAAAAAAABoKJAm44QOlyF2D5AAAAAAAAAAAAAAAAAAAAAJKh7kcqRqVVNSgqcPvvcdzH8RvXVpAE4nNhMDAwMGJjbW9uMDAwMWJjcmVwb3J0MDI=

2023/01/31 07:21:18.935 kid2| 84,5| helper.cc(1107)
helperStatefulHandleRead: helperStatefulHandleRead: 27 bytes from
ntlmauthenticator #Hlpr25
2023/01/31 07:21:18.935 kid2| 84,9| helper.cc(1117)
helperStatefulHandleRead:  accumulated[27]=NA NT_STATUS_LOGON_FAILURE



In the acess.log there are two records, but there is no username in both:
2023-01-31 07:21:18|      2 10.73.16.136 TCP_DENIED/407/- 4531 CONNECT
google.com:443 - HIER_NONE/- text/html -
2023-01-31 07:21:18|     19 10.73.16.136 TCP_DENIED/407/- 4500 CONNECT
google.com:443 - HIER_NONE/- text/html -



??, 31 ???. 2023 ?. ? 07:09, Amos Jeffries <squid3 at treenet.co.nz>:

> On 31/01/2023 4:55 pm, Andrey K wrote:
> > Hello,
> >
> > I need to log failed Proxy-authentication attempts. The log
> > information should contain timestamp, username and client IP address.
> > 407-records in the access.log file do not contain username if
> > NTLM-authentication is used.
> > I was wondering if it is possible to set up such a configuration?
>
> Squid log entries record username for all authentication types as soon
> as a username exists.
> I expect you are being confused by log records for the part of NTLM
> handshake before the username is sent to Squid.
>
> Amos
>
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230131/438877c8/attachment.htm>

From ankor2023 at gmail.com  Tue Jan 31 05:13:32 2023
From: ankor2023 at gmail.com (Andrey K)
Date: Tue, 31 Jan 2023 08:13:32 +0300
Subject: [squid-users] Logging failed authentication attempts
In-Reply-To: <CADJd0Y0eBcU85aNUqzHnV=wabKD_GC8m0GqW2SUzyZM7-UDJHA@mail.gmail.com>
References: <CADJd0Y0AcPijeatbR22MpguN0k+WuhkOk0c3bJgS+qe+6-ny8w@mail.gmail.com>
 <0eec88b9-1e25-06d5-a14d-8897d786a338@treenet.co.nz>
 <CADJd0Y0eBcU85aNUqzHnV=wabKD_GC8m0GqW2SUzyZM7-UDJHA@mail.gmail.com>
Message-ID: <CADJd0Y2x=Npx2_R-d_3H3oEBSJDLcMFuM3apSM6BXX9=qp29fQ@mail.gmail.com>

Amos,

I understood: the helper.cc does not parse the KK-request and does not know
about the username. He can only get the username information from the reply
of the external helper. But since the external helper returns only an error
without a username, this information is missing from the logs.

Is there any other possibility to log username and source IP address in
such NTLM-failed authentication attempts?

Kind regards,
   Ankor.

??, 31 ???. 2023 ?. ? 07:56, Andrey K <ankor2023 at gmail.com>:

> Hello Amos,
>
> Thank you for the information.
>
> I turned on squid debug_options 84,9 and see in the cashe.log that in the
> first NTLM_NEGOTIATE request (YR) there is no username:
> TlRMTVNTUAABAAAABoIIAAAAAAAAAAAAAAAAAAAAAAA=
> 00000000  4e 54 4c 4d 53 53 50 00  01 00 00 00 06 82 08 00
>  |NTLMSSP.........|
> 00000010  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
>  |................|
>
> so SQUID responded with the NTLMSSP_CHALLENGE (TT).
>
> But in the second NTLMSSP_AUTH request (KK) client sends username (
> sa0000bcmon) as well as hostname (0001bcreport02):
>
> TlRMTVNTUAADAAAAGAAYAEAAAAAYABgAWAAAAAAAAABwAAAACwALAHAAAAAOAA4AewAAAAAAAAAAAAAABoKJAm44QOlyF2D5AAAAAAAAAAAAAAAAAAAAAJKh7kcqRqVVNSgqcPvvcdzH8RvXVpAE4nNhMDAwMGJjbW9uMDAwMWJjcmVwb3J0MDI=
>
> 00000000  4e 54 4c 4d 53 53 50 00  03 00 00 00 18 00 18 00
>  |NTLMSSP.........|
> 00000010  40 00 00 00 18 00 18 00  58 00 00 00 00 00 00 00
>  |@.......X.......|
> 00000020  70 00 00 00 0b 00 0b 00  70 00 00 00 0e 00 0e 00
>  |p.......p.......|
> 00000030  7b 00 00 00 00 00 00 00  00 00 00 00 06 82 89 02
>  |{...............|
> 00000040  6e 38 40 e9 72 17 60 f9  00 00 00 00 00 00 00 00  |n8@
> .r.`.........|
> 00000050  00 00 00 00 00 00 00 00  92 a1 ee 47 2a 46 a5 55
>  |...........G*F.U|
> 00000060  35 28 2a 70 fb ef 71 dc  c7 f1 1b d7 56 90 04 e2
>  |5(*p..q.....V...|
> 00000070  73 61 30 30 30 30 62 63  6d 6f 6e 30 30 30 31 62
>  |sa0000bcmon0001b|
> 00000080  63 72 65 70 6f 72 74 30  32                       |creport02|
>
> Client uses wrong password to calculate NTLM response so helper returns
> NT_STATUS_LOGON_FAILURE:
> 2023/01/31 07:21:18.916 kid2| 84,9| helper.cc(666) submit: placeholder:
> '0',  buf[188]=KK
> TlRMTVNTUAADAAAAGAAYAEAAAAAYABgAWAAAAAAAAABwAAAACwALAHAAAAAOAA4AewAAAAAAAAAAAAAABoKJAm44QOlyF2D5AAAAAAAAAAAAAAAAAAAAAJKh7kcqRqVVNSgqcPvvcdzH8RvXVpAE4nNhMDAwMGJjbW9uMDAwMWJjcmVwb3J0MDI=
>
> 2023/01/31 07:21:18.935 kid2| 84,5| helper.cc(1107)
> helperStatefulHandleRead: helperStatefulHandleRead: 27 bytes from
> ntlmauthenticator #Hlpr25
> 2023/01/31 07:21:18.935 kid2| 84,9| helper.cc(1117)
> helperStatefulHandleRead:  accumulated[27]=NA NT_STATUS_LOGON_FAILURE
>
>
>
> In the acess.log there are two records, but there is no username in both:
> 2023-01-31 07:21:18|      2 10.73.16.136 TCP_DENIED/407/- 4531 CONNECT
> google.com:443 - HIER_NONE/- text/html -
> 2023-01-31 07:21:18|     19 10.73.16.136 TCP_DENIED/407/- 4500 CONNECT
> google.com:443 - HIER_NONE/- text/html -
>
>
>
> ??, 31 ???. 2023 ?. ? 07:09, Amos Jeffries <squid3 at treenet.co.nz>:
>
>> On 31/01/2023 4:55 pm, Andrey K wrote:
>> > Hello,
>> >
>> > I need to log failed Proxy-authentication attempts. The log
>> > information should contain timestamp, username and client IP address.
>> > 407-records in the access.log file do not contain username if
>> > NTLM-authentication is used.
>> > I was wondering if it is possible to set up such a configuration?
>>
>> Squid log entries record username for all authentication types as soon
>> as a username exists.
>> I expect you are being confused by log records for the part of NTLM
>> handshake before the username is sent to Squid.
>>
>> Amos
>>
>> _______________________________________________
>> squid-users mailing list
>> squid-users at lists.squid-cache.org
>> http://lists.squid-cache.org/listinfo/squid-users
>>
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230131/bbe01aa8/attachment.htm>

From squid3 at treenet.co.nz  Tue Jan 31 05:54:18 2023
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Tue, 31 Jan 2023 18:54:18 +1300
Subject: [squid-users] Logging failed authentication attempts
In-Reply-To: <CADJd0Y2x=Npx2_R-d_3H3oEBSJDLcMFuM3apSM6BXX9=qp29fQ@mail.gmail.com>
References: <CADJd0Y0AcPijeatbR22MpguN0k+WuhkOk0c3bJgS+qe+6-ny8w@mail.gmail.com>
 <0eec88b9-1e25-06d5-a14d-8897d786a338@treenet.co.nz>
 <CADJd0Y0eBcU85aNUqzHnV=wabKD_GC8m0GqW2SUzyZM7-UDJHA@mail.gmail.com>
 <CADJd0Y2x=Npx2_R-d_3H3oEBSJDLcMFuM3apSM6BXX9=qp29fQ@mail.gmail.com>
Message-ID: <3d44889a-1da3-f7cb-0b3c-58af98098eed@treenet.co.nz>

On 31/01/2023 6:13 pm, Andrey K wrote:
> Amos,
>
> I understood: the helper.cc does not parse the KK-request and does not 
> know about the username. He can only get the username information from 
> the reply of the external helper. But since the external helper 
> returns only an error without a username, this information is missing 
> from the logs.
>
> Is there any other possibility to log username and source IP address 
> in such NTLM-failed authentication attempts?

You could make a wrapper script that decodes the KK request and returns 
user=name along with the real helpers result.
The problem is tat the credentials are known to be invalid at that 
point, so it may just be garbage instead of a username.

Amos



From ankor2023 at gmail.com  Tue Jan 31 08:16:30 2023
From: ankor2023 at gmail.com (Andrey K)
Date: Tue, 31 Jan 2023 11:16:30 +0300
Subject: [squid-users] Logging failed authentication attempts
In-Reply-To: <3d44889a-1da3-f7cb-0b3c-58af98098eed@treenet.co.nz>
References: <CADJd0Y0AcPijeatbR22MpguN0k+WuhkOk0c3bJgS+qe+6-ny8w@mail.gmail.com>
 <0eec88b9-1e25-06d5-a14d-8897d786a338@treenet.co.nz>
 <CADJd0Y0eBcU85aNUqzHnV=wabKD_GC8m0GqW2SUzyZM7-UDJHA@mail.gmail.com>
 <CADJd0Y2x=Npx2_R-d_3H3oEBSJDLcMFuM3apSM6BXX9=qp29fQ@mail.gmail.com>
 <3d44889a-1da3-f7cb-0b3c-58af98098eed@treenet.co.nz>
Message-ID: <CADJd0Y249ncWzrZnAffXhq3qmf-w187UNQjsajTJ+phS3q=1_g@mail.gmail.com>

Hello Amos,

Thank you for the idea to write a wrapper script.

As NTLM-helper returns "NA NT_STATUS_LOGON_FAILURE" during authentication
failed, I think it is also required to patch the squid sources to copy the
value of the user attribute, returned by the wrapper,
to auth_user_request->user()->username().
As I see, I need to modify the following functions:
Helper::Reply::finalize()  - add parsing of additional attributes in the
case when returned value is "NA  " ,
Auth::Ntlm/Negotiate::UserRequest::HandleReply() - add finding the "user"
attribute and copping it to the username:
auth_user_request->user()->username(userLabel) in the case of returned
Helper::Error;

By the way, what are these acronyms for (YR, KK, TT, AF, BH, NA, LD)?

Kind regards,
     Ankor.

??, 31 ???. 2023 ?. ? 08:54, Amos Jeffries <squid3 at treenet.co.nz>:

> On 31/01/2023 6:13 pm, Andrey K wrote:
> > Amos,
> >
> > I understood: the helper.cc does not parse the KK-request and does not
> > know about the username. He can only get the username information from
> > the reply of the external helper. But since the external helper
> > returns only an error without a username, this information is missing
> > from the logs.
> >
> > Is there any other possibility to log username and source IP address
> > in such NTLM-failed authentication attempts?
>
> You could make a wrapper script that decodes the KK request and returns
> user=name along with the real helpers result.
> The problem is tat the credentials are known to be invalid at that
> point, so it may just be garbage instead of a username.
>
> Amos
>
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230131/bedf5d1a/attachment.htm>

From squid3 at treenet.co.nz  Tue Jan 31 09:37:38 2023
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Tue, 31 Jan 2023 22:37:38 +1300
Subject: [squid-users] Logging failed authentication attempts
In-Reply-To: <CADJd0Y249ncWzrZnAffXhq3qmf-w187UNQjsajTJ+phS3q=1_g@mail.gmail.com>
References: <CADJd0Y0AcPijeatbR22MpguN0k+WuhkOk0c3bJgS+qe+6-ny8w@mail.gmail.com>
 <0eec88b9-1e25-06d5-a14d-8897d786a338@treenet.co.nz>
 <CADJd0Y0eBcU85aNUqzHnV=wabKD_GC8m0GqW2SUzyZM7-UDJHA@mail.gmail.com>
 <CADJd0Y2x=Npx2_R-d_3H3oEBSJDLcMFuM3apSM6BXX9=qp29fQ@mail.gmail.com>
 <3d44889a-1da3-f7cb-0b3c-58af98098eed@treenet.co.nz>
 <CADJd0Y249ncWzrZnAffXhq3qmf-w187UNQjsajTJ+phS3q=1_g@mail.gmail.com>
Message-ID: <d5333579-0de2-be67-dc86-c080d91885e9@treenet.co.nz>

On 31/01/2023 9:16 pm, Andrey K wrote:
> Hello Amos,
>
> Thank you for the idea to write a wrapper script.
>
> As NTLM-helper returns "NA NT_STATUS_LOGON_FAILURE" during 
> authentication failed,

Oh. Your script should convert that old syntax to the current one:

 ? ERR token=NT_STATUS_LOGON_FAILURE user="..."

FYI, If it still does not show up you can change the log format to print 
%note{user}

>
> By the way, what are these acronyms for (YR, KK, TT, AF, BH, NA, LD)?

see 
https://wiki.squid-cache.org/Features/NegotiateAuthentication#how-does-it-work-in-squid


HTH
Amos



From squid3 at treenet.co.nz  Wed Jan 18 01:29:57 2023
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Wed, 18 Jan 2023 01:29:57 -0000
Subject: [squid-users] [squid-announce] SQUID-2021:7 Denial of Service in
 Gopher Processing
Message-ID: <c19ed729-8ac6-ded4-350c-ad19f2888394@treenet.co.nz>

__________________________________________________________________

     Squid Proxy Cache Security Update Advisory SQUID-2021:7
__________________________________________________________________

Advisory ID:       | SQUID-2021:7
Date:              | Jun 06, 2022
Summary:           | Denial of Service in Gopher Processing
Affected versions: | Squid 3.x -> 3.5.28
                    | Squid 4.x -> 4.17
                    | Squid 5.x -> 5.5
Fixed in version:  | Squid 5.6
__________________________________________________________________

   <http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-46784>
__________________________________________________________________

### Problem Description:

  Due to improper buffer management Squid is vulnerable to a Denial
  of Service attack when processing Gopher server responses.

__________________________________________________________________

### Severity:

  This problem allows a remote server to perform Denial of Service
  when processing Gopher responses.

CVSS Score of 9.8
<https://nvd.nist.gov/vuln-metrics/cvss/v3-calculator?vector=AV:N/AC:L/PR:N/UI:N/S:U/C:N/I:H/A:H/E:X/RL:X/RC:C/CR:X/IR:X/AR:H/MAV:N/MAC:L/MPR:N/MUI:X/MS:U/MC:X/MI:X/MA:H&version=3.1>

__________________________________________________________________

### Updated Packages:

#### This bug is fixed by Squid version 5.6.

  In addition, patches addressing this problem for the stable
  releases can be found in our patch archives:

#### Squid 4:
  <http://www.squid-cache.org/Versions/v4/changesets/SQUID-2021_7.patch>

#### Squid 5:
  <http://www.squid-cache.org/Versions/v5/changesets/SQUID-2021_7.patch>

  If you are using a prepackaged version of Squid then please refer
  to the package vendor for availability information on updated
  packages.

__________________________________________________________________

### Determining if your version is vulnerable:

  All Squid-3.x up to and including 3.5.28 are vulnerable.

  All Squid-4.x up to and including 4.17 are vulnerable.

  All Squid-5.x up to and including 5.5 are vulnerable.

__________________________________________________________________

### Workaround:

   Deny access to gopher:// resources by adding the following lines
   to the top of squid.conf:

     acl gopher proto gopher
     http_access deny gopher

  Please be mindful that removing port 70 from the Safe_ports ACL
  definition is not sufficient. A malicious actor may easily
  operate gopher servers on other ports.

__________________________________________________________________

### Contact details for the Squid project:

  For installation / upgrade support on binary packaged versions
  of Squid: Your first point of contact should be your binary
  package vendor.

  If you install and build Squid from the original Squid sources
  then the <squid-users at lists.squid-cache.org> mailing list is your
  primary support point. For subscription details see
  <http://www.squid-cache.org/Support/mailing-lists.html>.

  For reporting of non-security bugs in the latest STABLE release
  the squid bugzilla database should be used
  <http://bugs.squid-cache.org/>.

  For reporting of security sensitive bugs send an email to the
  <squid-bugs at lists.squid-cache.org> mailing list. It's a closed
  list (though anyone can post) and security related bug reports
  are treated in confidence until the impact has been established.

__________________________________________________________________

### Credits:

  This vulnerability was discovered and fixed by Joshua Rogers of
  Opera Software.

__________________________________________________________________

### Revision history:

  2021-02-20 23:38:06 UTC Initial Report
  2022-04-18 13:42:36 UTC Patch Released
  2022-04-21 08:29:13 UTC CVE Allocation
__________________________________________________________________
END
_______________________________________________
squid-announce mailing list
squid-announce at lists.squid-cache.org
http://lists.squid-cache.org/listinfo/squid-announce


From squid3 at treenet.co.nz  Wed Jan 18 01:30:00 2023
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Wed, 18 Jan 2023 01:30:00 -0000
Subject: [squid-users] [squid-announce] [ADVISORY] SQUID-2022:1 Exposure of
 Sensitive Information in Cache Manager
Message-ID: <97571a44-c83f-a64f-9e4d-71e4472e073a@treenet.co.nz>

__________________________________________________________________

     Squid Proxy Cache Security Update Advisory SQUID-2022:1
__________________________________________________________________

Advisory ID:       | SQUID-2022:1
Date:              | September 23, 2022
Summary:           | Exposure of Sensitive Information
                    | in Cache Manager
Affected versions: | Squid 4.15 -> 4.17
                    | Squid 5.0.6 -> 5.6
Fixed in version:  | Squid 5.7
__________________________________________________________________

<http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2022-41317>
__________________________________________________________________

Problem Description:

  Due to inconsistent handling of internal URIs Squid is
  vulnerable to Exposure of Sensitive Information about clients
  using the proxy.

__________________________________________________________________

Severity:

  This problem allows a trusted client to directly access cache
  manager information bypassing the manager ACL protection.

  The available cache manager information contains records of
  internal network structure, client credentials, client identity
  and client traffic behaviour.

CVSS Score of 6.4
<https://nvd.nist.gov/vuln-metrics/cvss/v3-calculator?vector=AV:N/AC:L/PR:L/UI:N/S:U/C:H/I:N/A:N/E:F/RL:X/RC:C/CR:M/IR:X/AR:X/MAV:X/MAC:L/MPR:L/MUI:X/MS:X/MC:H/MI:X/MA:X&version=3.1>

__________________________________________________________________

Updated Packages:

This bug is fixed by Squid version 5.7.

  In addition, patches addressing this problem for the stable
  releases can be found in our patch archives:

Squid 4:
  <http://www.squid-cache.org/Versions/v4/changesets/SQUID-2022_1.patch>

Squid 5:
  <http://www.squid-cache.org/Versions/v5/changesets/SQUID-2022_1.patch>

  If you are using a prepackaged version of Squid then please refer
  to the package vendor for availability information on updated
  packages.

__________________________________________________________________

Determining if your version is vulnerable:

  Squid older than 4.9 are not vulnerable.

  All Squid-4.9 up to and including 4.14 have not been tested, but
  should be assumed to be vulnerable.

  All Squid-4.15 up to and including 4.17 are vulnerable.

  All Squid-5.0.6 up to and including 5.6 are vulnerable.

__________________________________________________________________

Workaround:

   Add the following to squid.conf:

     acl manager url_regex +i ^[^:]+://[^/]+/squid-internal-mgr/

__________________________________________________________________

Contact details for the Squid project:

  For installation / upgrade support on binary packaged versions
  of Squid: Your first point of contact should be your binary
  package vendor.

  If you install and build Squid from the original Squid sources
  then the <squid-users at lists.squid-cache.org> mailing list is your
  primary support point. For subscription details see
  <http://www.squid-cache.org/Support/mailing-lists.html>.

  For reporting of non-security bugs in the latest STABLE release
  the squid bugzilla database should be used
  <http://bugs.squid-cache.org/>.

  For reporting of security sensitive bugs send an email to the
  <squid-bugs at lists.squid-cache.org> mailing list. It's a closed
  list (though anyone can post) and security related bug reports
  are treated in confidence until the impact has been established.

__________________________________________________________________

Credits:

  This vulnerability was discovered by Mikhail Evdokimov
  (aka konata).

  Initial fix by Amos Jeffries of Treehouse Networks Ltd.

__________________________________________________________________

Revision history:

  2022-04-17 18:30:52 UTC Initial Report
  2022-08-08 11:01:47 UTC Initial Fix released
  2022-09-23 05:00:00 UTC Advisory Released
__________________________________________________________________
END
_______________________________________________
squid-announce mailing list
squid-announce at lists.squid-cache.org
http://lists.squid-cache.org/listinfo/squid-announce


From squid3 at treenet.co.nz  Wed Jan 18 01:30:04 2023
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Wed, 18 Jan 2023 01:30:04 -0000
Subject: [squid-users] [squid-announce] [ADVISORY] SQUID-2022:2 Buffer Over
 Read in SSPI and SMB Authentication
Message-ID: <61966eb4-6778-8293-0cec-841db62f21ce@treenet.co.nz>

__________________________________________________________________

Squid Proxy Cache Security Update Advisory SQUID-2022:2
__________________________________________________________________

Advisory ID:       | SQUID-2022:2
Date:              | September 23, 2022
Summary:           | Buffer Over Read
                    | in SSPI and SMB Authentication
Affected versions: | Squid 2.5.STABLE1 -> 2.7.STABLE9
                    | Squid 3.x -> 3.5.28
                    | Squid 4.x -> 4.17
                    | Squid 5.x -> 5.6
Fixed in version:  | Squid 5.7
__________________________________________________________________

  <http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2022-41318>
__________________________________________________________________

Problem Description:

  Due to an incorrect integer overflow protection Squid SSPI and
  SMB authentication helpers are vulnerable to a Buffer Overflow
  attack.

__________________________________________________________________

Severity:

  This problem allows a remote client to perform a Denial of
  Service attack when Squid is configured to use NTLM or Negotiate
  authentication with one of the vulnerable helpers.

  This problem allows a remote client to extract sensitive
  information from machine memory when Squid is configured to use
  NTLM or Negotiate authentication with one of the vulnerable
  helpers. The scope of this information includes user credentials
  in decrypted forms, and also arbitrary memory areas beyond Squid
  and the helper itself.

  This attack is limited to authentication helpers built using the
  libntlmauth library shipped by Squid.

CVSS Score of 8.2
<https://nvd.nist.gov/vuln-metrics/cvss/v3-calculator?vector=AV:N/AC:H/PR:N/UI:N/S:C/C:H/I:L/A:H/E:P/RL:O/RC:C/CR:H/IR:H/AR:H/MAV:X/MAC:X/MPR:X/MUI:X/MS:C/MC:X/MI:L/MA:H&version=3.1>
__________________________________________________________________

Updated Packages:

This bug is fixed by Squid version 5.7.

  In addition, patches addressing this problem for the stable
  releases can be found in our patch archives:

Squid 4:
  <http://www.squid-cache.org/Versions/v4/changesets/SQUID-2022_2.patch>

Squid 5:
  <http://www.squid-cache.org/Versions/v5/changesets/SQUID-2022_2.patch>

  If you are using a prepackaged version of Squid then please refer
  to the package vendor for availability information on updated
  packages.

__________________________________________________________________

Determining if your version is vulnerable:

  Run this command to view the configured authentication helpers:

    (squid -k parse 2>&1) | grep "Processing: auth_param"

  Your Squid may be vulnerable if the result contains any of the following:
    ntlm_smb_lm_auth
    ntlm_sspi_auth
    ntlm_fake_auth
    negotiate_sspi_auth

  All Squid-2.5 up to and including 4.17 have vulnerable helpers.

  All Squid-5.x up to and including 5.6 have vulnerable helpers.

__________________________________________________________________

Workaround:

Either,

  Disable use of the vulnerable authentication scheme.

Or,

  Replace the vulnerable helper with an alternative helper for the
  same authentication scheme.

Or,

  Replace the vulnerable helper binary with one built from an
  updated or patched Squid release. The remainder of Squid does not
  need updating to fix this.

__________________________________________________________________

Contact details for the Squid project:

  For installation / upgrade support on binary packaged versions
  of Squid: Your first point of contact should be your binary
  package vendor.

  If you install and build Squid from the original Squid sources
  then the <squid-users at lists.squid-cache.org> mailing list is your
  primary support point. For subscription details see
  <http://www.squid-cache.org/Support/mailing-lists.html>.

  For reporting of non-security bugs in the latest STABLE release
  the squid bugzilla database should be used
  <http://bugs.squid-cache.org/>.

  For reporting of security sensitive bugs send an email to the
  <squid-bugs at lists.squid-cache.org> mailing list. It's a closed
  list (though anyone can post) and security related bug reports
  are treated in confidence until the impact has been established.

__________________________________________________________________

Credits:

  This vulnerability was discovered by LWIC.

  Fixed by Amos Jeffries of Treehouse Networks Ltd,
  based on patch by LWIC.

__________________________________________________________________

Revision history:

  2019-03-17 14:24:42 UTC Initial Report
  2022-08-08 12:16:43 UTC Fix Released
  2022-09-23 05:00:00 UTC Advisory Released
__________________________________________________________________
END
_______________________________________________
squid-announce mailing list
squid-announce at lists.squid-cache.org
http://lists.squid-cache.org/listinfo/squid-announce


