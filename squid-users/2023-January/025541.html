<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid log shows peer_response_time = 0 and status is 200
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20log%20shows%20peer_response_time%20%3D%200%20and%20status%0A%20is%20200&In-Reply-To=%3C29825585-90df-dd66-41ea-8f97f5586438%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   
   <LINK REL="Next"  HREF="025542.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid log shows peer_response_time = 0 and status is 200</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20log%20shows%20peer_response_time%20%3D%200%20and%20status%0A%20is%20200&In-Reply-To=%3C29825585-90df-dd66-41ea-8f97f5586438%40measurement-factory.com%3E"
       TITLE="[squid-users] Squid log shows peer_response_time = 0 and status is 200">rousskov at measurement-factory.com
       </A><BR>
    <I>Sun Jan  1 17:30:42 UTC 2023</I>
    <P><UL>
        
        <LI>Next message (by thread): <A HREF="025542.html">[squid-users] e-CAP future development
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25541">[ date ]</a>
              <a href="thread.html#25541">[ thread ]</a>
              <a href="subject.html#25541">[ subject ]</a>
              <a href="author.html#25541">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 12/30/22 12:29, Raghav P wrote:
&gt;<i> Thank you Alex.
</I>&gt;<i> 
</I>&gt;<i> We modified the log format as per your suggestion and here is the 
</I>&gt;<i> relevant log entries (its been parsed) for one such log entry
</I>&gt;<i> 
</I>&gt;<i>  &#160; &quot;http_method&quot;: &quot;CONNECT&quot;,
</I>&gt;<i>  &#160; &quot;request_method_from_client&quot;: &quot;CONNECT&quot;,
</I>&gt;<i>  &#160; &quot;request_method_to_server&quot;: &quot;CONNECT&quot;,
</I>&gt;<i>  &#160; &quot;status&quot;: 200,
</I>&gt;<i>  &#160; &quot;vendor_action&quot;: &quot;TCP_TUNNEL&quot;,
</I>&gt;<i>  &#160; &quot;err_code&quot;: &quot;-&quot;,
</I>&gt;<i>  &#160; &quot;err_detail&quot;: &quot;-&quot;,
</I>&gt;<i>  &#160; &quot;dest_status&quot;: &quot;HIER_DIRECT&quot;,
</I>&gt;<i>  &#160; &quot;response_time&quot;: 8612,
</I>&gt;<i>  &#160; &quot;total_time_milliseconds&quot;: 8608,
</I>&gt;<i>  &#160; &quot;peer_response_time&quot;: 0,
</I>&gt;<i>  &#160; &quot;http_content_type&quot;: &quot;-&quot;,
</I>&gt;<i>  &#160; &quot;bytes&quot;: 13071,
</I>&gt;<i>  &#160; &quot;bytes_in&quot;: 5373,
</I>&gt;<i>  &#160; &quot;bytes_out&quot;: 7698,
</I>&gt;<i>  &#160; &quot;sni&quot;: &quot;-&quot;,
</I>&gt;<i>  &#160; &quot;X-Forwarded-For&quot;: &quot;-&quot;
</I>
Several use cases might result in the above combination of fields, but I 
think the following one is the most likely:

* Squid successfully opened an HTTP CONNECT tunnel to the origin server.

* The client and the origin server exchanged some data.

* The client was either the last to send data or it sent data during the 
same millisecond when Squid received the last data from the server.

In this use case, we see a clash between %&lt;pt definition that was based 
on a basic GET request exchange (client sends TCP payload then server 
sends TCP payload) and the way HTTP CONNECT tunnels usually function 
when forwarding encrypted traffic (both sides send TCP data from time to 
time):

&gt;<i> [http::]&lt;pt Peer response time in milliseconds. The timer starts
</I>&gt;<i> when the last request byte is sent to the next hop
</I>&gt;<i> and stops when the last response byte is received.
</I>
The above definition makes %&lt;pt measurements useless in many CONNECT 
tunnel cases. There is even a source code comment about that: &quot;The peer 
response time (%&lt;pt) stopwatch is currently defined to start when we 
wrote the entire request. Thus, if we wrote something after the last 
read, report zero peer response time.&quot; In this case, &quot;we wrote&quot; means 
&quot;we forwarded client bytes to the server&quot; and &quot;the last read&quot; means &quot;the 
last read from the origin server&quot;.


HTH,

Alex.


&gt;<i> On Fri, Dec 30, 2022 at 4:01 AM Alex Rousskov 
</I>&gt;<i> &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A> 
</I>&gt;<i> &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt;&gt; wrote:
</I>&gt;<i> 
</I>&gt;<i>     On 12/29/22 16:17, Raghav P wrote:
</I>&gt;<i>      &gt; We have a squid proxy configured as a forward proxy. But we see
</I>&gt;<i>     that for
</I>&gt;<i>      &gt; some requests the log shows peer_response_time =0 but has status
</I>&gt;<i>     is 200.
</I>&gt;<i>      &gt; At times users on their browser see this as a page not loading.
</I>&gt;<i>      &gt;
</I>&gt;<i>      &gt; As we couldn't find documentation around this. We wish to know
</I>&gt;<i>     what this
</I>&gt;<i>      &gt; actually means and if this is an issue how to resolve it.
</I>&gt;<i> 
</I>&gt;<i>     It is difficult to say for sure what is going on without a lot more
</I>&gt;<i>     details, but it is likely that Squid experienced some kind of an error
</I>&gt;<i>     after receiving the beginning of a 200 OK response from the peer. I am
</I>&gt;<i>     guessing that when handling certain kinds of errors, Squid may
</I>&gt;<i>     forget to
</I>&gt;<i>     update the transaction response time clock and log zero. It is also
</I>&gt;<i>     possible, in some environments, that the transaction took less than one
</I>&gt;<i>     millisecond.
</I>&gt;<i> 
</I>&gt;<i>     I recommend configuring Squid to log all the standard fields in &quot;squid&quot;
</I>&gt;<i>     logformat, including %Ss (you probably log that already) and to add
</I>&gt;<i>     %err_code/%err_detail fields (you probably do not log those now). Share
</I>&gt;<i>     the values of those three specific fields (at least) with this mailing
</I>&gt;<i>     list. In general, the more logged fields you can share, the higher are
</I>&gt;<i>     the chances that somebody here will know what is going on with those
</I>&gt;<i>     transactions.
</I>&gt;<i> 
</I>&gt;<i>     You may also want to mention whether these transactions are HTTP or
</I>&gt;<i>     HTTPS, and, if HTTPS, whether your Squid has ssl_bump rules for those
</I>&gt;<i>     transactions.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i>     HTH,
</I>&gt;<i> 
</I>&gt;<i>     Alex.
</I>&gt;<i> 
</I>&gt;<i>     _______________________________________________
</I>&gt;<i>     squid-users mailing list
</I>&gt;<i>     <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i>     &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>&gt;
</I>&gt;<i>     <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i>     &lt;<A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>&gt;
</I>&gt;<i> 
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	
	<LI>Next message (by thread): <A HREF="025542.html">[squid-users] e-CAP future development
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25541">[ date ]</a>
              <a href="thread.html#25541">[ thread ]</a>
              <a href="subject.html#25541">[ subject ]</a>
              <a href="author.html#25541">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
