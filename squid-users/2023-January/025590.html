<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid use all memory ram
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20use%20all%20memory%20ram&In-Reply-To=%3CCAL34ibmo7p51ZEUhW%3DJOQp8YAH72bZMrjh4RwhJ-JHb4F8XZkg%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="025589.html">
   <LINK REL="Next"  HREF="025595.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid use all memory ram</H1>
    <B>Hamilton Coutinho</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20use%20all%20memory%20ram&In-Reply-To=%3CCAL34ibmo7p51ZEUhW%3DJOQp8YAH72bZMrjh4RwhJ-JHb4F8XZkg%40mail.gmail.com%3E"
       TITLE="[squid-users] Squid use all memory ram">hamilton.coutinho at gmail.com
       </A><BR>
    <I>Thu Jan 26 20:43:38 UTC 2023</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="025589.html">[squid-users] Squid use all memory ram
</A></li>
        <LI>Next message (by thread): <A HREF="025595.html">[squid-users] Squid use all memory ram
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25590">[ date ]</a>
              <a href="thread.html#25590">[ thread ]</a>
              <a href="subject.html#25590">[ subject ]</a>
              <a href="author.html#25590">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Gustavo,

I'm seeing the same thing. I could narrow down (but can't say with 100%
confidence) to the code that does certificate verification when configured
for SSL decryption. What is the output of squidclient mgr:mem for you? Do
you see unexplainably high counts for in-use objects like HttpRequest,
PeekingPeerConnector, Comm::Connection, Security::ErrorDetail?


On Thu, Jan 26, 2023 at 12:31 PM Gustavo Carvalho &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">gustavocarv4872 at gmail.com</A>&gt;
wrote:

&gt;<i> Hi,
</I>&gt;<i>
</I>&gt;<i> I have Squid 5.6 on a FreeBSD 13.1 server with 16GB RAM
</I>&gt;<i>
</I>&gt;<i> I noticed that squid starts to consume a lot of ram until it starts to
</I>&gt;<i> consume swap space. When this happens, browsing becomes extremely
</I>&gt;<i> slow.
</I>&gt;<i>
</I>&gt;<i> This is happening at least once a week when I have to restart squid to
</I>&gt;<i> get it back to normal.
</I>&gt;<i>
</I>&gt;<i> Any ideas?
</I>&gt;<i>
</I>&gt;<i> ############# Wed Jan 25 08:30:00 -03 2023 #############
</I>&gt;<i>
</I>&gt;<i> HTTP/1.1 200 OK
</I>&gt;<i> Server: squid
</I>&gt;<i> Mime-Version: 1.0
</I>&gt;<i> Date: Wed, 25 Jan 2023 11:30:00 GMT
</I>&gt;<i> Content-Type: text/plain;charset=utf-8
</I>&gt;<i> Expires: Wed, 25 Jan 2023 11:30:00 GMT
</I>&gt;<i> Last-Modified: Wed, 25 Jan 2023 11:30:00 GMT
</I>&gt;<i> X-Cache: MISS from xxxx.xxxx.xxxx
</I>&gt;<i> X-Cache-Lookup: MISS from xxxx.xxxx.xxxx:3128
</I>&gt;<i> Via: 1.1 xxxx.xxxx.xxxx (squid)
</I>&gt;<i> Connection: close
</I>&gt;<i>
</I>&gt;<i> Squid Object Cache: Version 5.6
</I>&gt;<i> Build Info:
</I>&gt;<i> Service Name: squid
</I>&gt;<i> Start Time: Thu, 19 Jan 2023 20:25:17 GMT
</I>&gt;<i> Current Time: Wed, 25 Jan 2023 11:30:00 GMT
</I>&gt;<i> Connection information for squid:
</I>&gt;<i>      Number of clients accessing cache: 224
</I>&gt;<i>      Number of HTTP requests received: 7541590
</I>&gt;<i>      Number of ICP messages received: 0
</I>&gt;<i>      Number of ICP messages sent: 0
</I>&gt;<i>      Number of queued ICP replies: 0
</I>&gt;<i>      Number of HTCP messages received: 0
</I>&gt;<i>      Number of HTCP messages sent: 0
</I>&gt;<i>      Request failure ratio: 0.00
</I>&gt;<i>      Average HTTP requests per minute since start: 930.5
</I>&gt;<i>      Average ICP messages per minute since start: 0.0
</I>&gt;<i>      Select loop called: 78733524 times, 6.176 ms avg
</I>&gt;<i> Cache information for squid:
</I>&gt;<i>      Hits as % of all requests: 5min: 8.4%, 60min: 12.1%
</I>&gt;<i>      Hits as % of bytes sent: 5min: 21.6%, 60min: 14.1%
</I>&gt;<i>      Memory hits as % of hit requests: 5min: 90.8%, 60min: 75.9%
</I>&gt;<i>      Disk hits as % of hit requests: 5min: 4.0%, 60min: 19.7%
</I>&gt;<i>      Storage Swap size: 2829956 KB
</I>&gt;<i>      Storage Swap capacity: 90.0% used, 10.0% free
</I>&gt;<i>      Storage Mem size: 16172 KB
</I>&gt;<i>      Storage Mem capacity: 98.7% used,  1.3% free
</I>&gt;<i>      Mean Object Size: 28.95 KB
</I>&gt;<i>      Requests given to unlinkd: 186982
</I>&gt;<i> Median Service Times (seconds)  5 min    60 min:
</I>&gt;<i> HTTP Requests (All):   0.00562  0.01847
</I>&gt;<i>      Cache Misses:          0.15048  0.23230
</I>&gt;<i>      Cache Hits:            0.00000  0.00000
</I>&gt;<i>      Near Hits:             0.14252  0.13498
</I>&gt;<i>      Not-Modified Replies:  0.00865  0.03066
</I>&gt;<i>      DNS Lookups:           0.00000  0.00372
</I>&gt;<i>      ICP Queries:           0.00000  0.00000
</I>&gt;<i> Resource usage for squid:
</I>&gt;<i>      UP Time: 486282.612 seconds
</I>&gt;<i>      CPU Time: 65555.712 seconds
</I>&gt;<i>      CPU Usage: 13.48%
</I>&gt;<i>      CPU Usage, 5 minute avg: 26.89%
</I>&gt;<i>      CPU Usage, 60 minute avg: 68.00%
</I>&gt;<i>      Maximum Resident Size: 37896960 KB
</I>&gt;<i>      Page faults with physical i/o: 10843
</I>&gt;<i> Memory accounted for:
</I>&gt;<i>      Total accounted:       -1459461 KB
</I>&gt;<i>      memPoolAlloc calls:     11408
</I>&gt;<i>      memPoolFree calls:  1888969689
</I>&gt;<i> File descriptor usage for squid:
</I>&gt;<i>      Maximum number of file descriptors:   4096
</I>&gt;<i>      Largest file desc currently in use:   2149
</I>&gt;<i>      Number of file desc currently in use:  679
</I>&gt;<i>      Files queued for open:                   0
</I>&gt;<i>      Available number of file descriptors: 3417
</I>&gt;<i>      Reserved number of file descriptors:   100
</I>&gt;<i>      Store Disk files open:                   0
</I>&gt;<i> Internal Data Structures:
</I>&gt;<i>      97906 StoreEntries
</I>&gt;<i>      3002 StoreEntries with MemObjects
</I>&gt;<i>      2838 Hot Object Cache Items
</I>&gt;<i>      97742 on-disk objects
</I>&gt;<i>
</I>&gt;<i> ------ pfctl -si ------
</I>&gt;<i>
</I>&gt;<i> Status: Enabled for 25 days 22:58:24          Debug: Urgent
</I>&gt;<i>
</I>&gt;<i> State Table                          Total             Rate
</I>&gt;<i>   current entries                     8085
</I>&gt;<i>   searches                      6650475717         2965.4/s
</I>&gt;<i>   inserts                        133521957           59.5/s
</I>&gt;<i>   removals                       133552376           59.5/s
</I>&gt;<i> Counters
</I>&gt;<i>   match                          605960865          270.2/s
</I>&gt;<i>   bad-offset                             0            0.0/s
</I>&gt;<i>   fragment                               1            0.0/s
</I>&gt;<i>   short                                 54            0.0/s
</I>&gt;<i>   normalize                            659            0.0/s
</I>&gt;<i>   memory                                 0            0.0/s
</I>&gt;<i>   bad-timestamp                          0            0.0/s
</I>&gt;<i>   congestion                             0            0.0/s
</I>&gt;<i>   ip-option                              0            0.0/s
</I>&gt;<i>   proto-cksum                            0            0.0/s
</I>&gt;<i>   state-mismatch                    104674            0.0/s
</I>&gt;<i>   state-insert                       38501            0.0/s
</I>&gt;<i>   state-limit                            0            0.0/s
</I>&gt;<i>   src-limit                              0            0.0/s
</I>&gt;<i>   synproxy                               0            0.0/s
</I>&gt;<i>   map-failed                             0            0.0/s
</I>&gt;<i>
</I>&gt;<i> ------ sysctl -a | grep swap  ------
</I>&gt;<i>
</I>&gt;<i> swap_pager: out of swap space
</I>&gt;<i> swp_pager_getswapspace(32): failed
</I>&gt;<i> swap_pager: out of swap space
</I>&gt;<i> swp_pager_getswapspace(31): failed
</I>&gt;<i> swap_pager: out of swap space
</I>&gt;<i> swp_pager_getswapspace(1): failed
</I>&gt;<i> 1 PART da0p2 2147483648 512 i 2 o 544768 ty freebsd-swap xs GPT xt
</I>&gt;<i> 516e7cb5-6ecf-11d6-8ff8-00022d09712b
</I>&gt;<i> 0 MD md1 94371840 512 u 1 s 512 f 0 fs 0 l 94371840 t swap label
</I>&gt;<i> 0 MD md0 62914560 512 u 0 s 512 f 0 fs 0 l 62914560 t swap label
</I>&gt;<i> z0xfffff80003ec5800 [shape=box,label=&quot;SWAP\nswap\nr#3&quot;];
</I>&gt;<i>       &lt;name&gt;swap&lt;/name&gt;
</I>&gt;<i>     &lt;type&gt;swap&lt;/type&gt;
</I>&gt;<i>     &lt;type&gt;swap&lt;/type&gt;
</I>&gt;<i>     &lt;type&gt;freebsd-swap&lt;/type&gt;
</I>&gt;<i> vm.swap_enabled: 1
</I>&gt;<i> vm.domain.0.stats.unswappable: 2044
</I>&gt;<i> vm.swap_idle_threshold2: 10
</I>&gt;<i> vm.swap_idle_threshold1: 2
</I>&gt;<i> vm.swap_idle_enabled: 0
</I>&gt;<i> vm.disable_swapspace_pageouts: 0
</I>&gt;<i> vm.stats.vm.v_swappgsout: 3154299
</I>&gt;<i> vm.stats.vm.v_swappgsin: 510404
</I>&gt;<i> vm.stats.vm.v_swapout: 174446
</I>&gt;<i> vm.stats.vm.v_swapin: 62590
</I>&gt;<i> vm.stats.swap.free_completed: 54375
</I>&gt;<i> vm.stats.swap.free_deferred: 56992
</I>&gt;<i> vm.nswapdev: 1
</I>&gt;<i> vm.swap_fragmentation:
</I>&gt;<i> vm.swap_async_max: 4
</I>&gt;<i> vm.swap_maxpages: 32572800
</I>&gt;<i> vm.swap_total: 2147483648
</I>&gt;<i> vm.swap_reserved: 384676114432
</I>&gt;<i>
</I>&gt;<i> ------ /usr/sbin/swapinfo -h  ------
</I>&gt;<i>
</I>&gt;<i> Device              Size     Used    Avail Capacity
</I>&gt;<i> /dev/da0p2          2.0G     2.0G     8.0K   100%
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> ############# squid.conf #############
</I>&gt;<i>
</I>&gt;<i> http_port 3128 ssl-bump generate-host-certificates=on
</I>&gt;<i> dynamic_cert_mem_cache_size=20MB cert=/xxxx/conf/certs/ca.crt
</I>&gt;<i> key=/xxxx/conf/certs/ca.key
</I>&gt;<i> http_port 3129 intercept
</I>&gt;<i> https_port 3130 intercept ssl-bump generate-host-certificates=on
</I>&gt;<i> dynamic_cert_mem_cache_size=20MB cert=/xxxx/conf/certs/ca.crt
</I>&gt;<i> key=/xxxx/conf/certs/ca.key
</I>&gt;<i> visible_hostname xxxx.xxxx.xxxx
</I>&gt;<i> max_filedescriptors 4096
</I>&gt;<i> maximum_object_size 4096 KB
</I>&gt;<i> minimum_object_size 0 KB
</I>&gt;<i> maximum_object_size_in_memory 256 KB
</I>&gt;<i> fqdncache_size 1024
</I>&gt;<i> cache_mgr <A HREF="https://lists.squid-cache.org/listinfo/squid-users">xxxx at xxxx</A>
</I>&gt;<i> dns_nameservers 127.0.0.1
</I>&gt;<i> cache_replacement_policy                heap LFUDA
</I>&gt;<i> memory_replacement_policy               heap GDSF
</I>&gt;<i> cache_mem 16 MB
</I>&gt;<i> cache_dir               ufs /xxxx/chroot/osproxy/cache 3072 32 256
</I>&gt;<i> forwarded_for on
</I>&gt;<i> memory_pools off
</I>&gt;<i> logformat xxxx %ts|%6tr|%&gt;a|%Ss|%03&gt;Hs|%&lt;st|%rm|%un|%mt|%ea|%ru
</I>&gt;<i> logfile_rotate 0
</I>&gt;<i> httpd_suppress_version_string on
</I>&gt;<i> strip_query_terms off
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i>
</I>

-- 
Hamilton
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20230126/3cb85ffb/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20230126/3cb85ffb/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="025589.html">[squid-users] Squid use all memory ram
</A></li>
	<LI>Next message (by thread): <A HREF="025595.html">[squid-users] Squid use all memory ram
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25590">[ date ]</a>
              <a href="thread.html#25590">[ thread ]</a>
              <a href="subject.html#25590">[ subject ]</a>
              <a href="author.html#25590">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
