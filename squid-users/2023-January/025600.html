<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Logging failed authentication attempts
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Logging%20failed%20authentication%20attempts&In-Reply-To=%3CCADJd0Y2x%3DNpx2_R-d_3H3oEBSJDLcMFuM3apSM6BXX9%3Dqp29fQ%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="025599.html">
   <LINK REL="Next"  HREF="025601.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Logging failed authentication attempts</H1>
    <B>Andrey K</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Logging%20failed%20authentication%20attempts&In-Reply-To=%3CCADJd0Y2x%3DNpx2_R-d_3H3oEBSJDLcMFuM3apSM6BXX9%3Dqp29fQ%40mail.gmail.com%3E"
       TITLE="[squid-users] Logging failed authentication attempts">ankor2023 at gmail.com
       </A><BR>
    <I>Tue Jan 31 05:13:32 UTC 2023</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="025599.html">[squid-users] Logging failed authentication attempts
</A></li>
        <LI>Next message (by thread): <A HREF="025601.html">[squid-users] Logging failed authentication attempts
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25600">[ date ]</a>
              <a href="thread.html#25600">[ thread ]</a>
              <a href="subject.html#25600">[ subject ]</a>
              <a href="author.html#25600">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Amos,

I understood: the helper.cc does not parse the KK-request and does not know
about the username. He can only get the username information from the reply
of the external helper. But since the external helper returns only an error
without a username, this information is missing from the logs.

Is there any other possibility to log username and source IP address in
such NTLM-failed authentication attempts?

Kind regards,
   Ankor.

&#1074;&#1090;, 31 &#1103;&#1085;&#1074;. 2023 &#1075;. &#1074; 07:56, Andrey K &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">ankor2023 at gmail.com</A>&gt;:

&gt;<i> Hello Amos,
</I>&gt;<i>
</I>&gt;<i> Thank you for the information.
</I>&gt;<i>
</I>&gt;<i> I turned on squid debug_options 84,9 and see in the cashe.log that in the
</I>&gt;<i> first NTLM_NEGOTIATE request (YR) there is no username:
</I>&gt;<i> TlRMTVNTUAABAAAABoIIAAAAAAAAAAAAAAAAAAAAAAA=
</I>&gt;<i> 00000000  4e 54 4c 4d 53 53 50 00  01 00 00 00 06 82 08 00
</I>&gt;<i>  |NTLMSSP.........|
</I>&gt;<i> 00000010  00 00 00 00 00 00 00 00  00 00 00 00 00 00 00 00
</I>&gt;<i>  |................|
</I>&gt;<i>
</I>&gt;<i> so SQUID responded with the NTLMSSP_CHALLENGE (TT).
</I>&gt;<i>
</I>&gt;<i> But in the second NTLMSSP_AUTH request (KK) client sends username (
</I>&gt;<i> sa0000bcmon) as well as hostname (0001bcreport02):
</I>&gt;<i>
</I>&gt;<i> TlRMTVNTUAADAAAAGAAYAEAAAAAYABgAWAAAAAAAAABwAAAACwALAHAAAAAOAA4AewAAAAAAAAAAAAAABoKJAm44QOlyF2D5AAAAAAAAAAAAAAAAAAAAAJKh7kcqRqVVNSgqcPvvcdzH8RvXVpAE4nNhMDAwMGJjbW9uMDAwMWJjcmVwb3J0MDI=
</I>&gt;<i>
</I>&gt;<i> 00000000  4e 54 4c 4d 53 53 50 00  03 00 00 00 18 00 18 00
</I>&gt;<i>  |NTLMSSP.........|
</I>&gt;<i> 00000010  40 00 00 00 18 00 18 00  58 00 00 00 00 00 00 00
</I>&gt;<i>  |@.......X.......|
</I>&gt;<i> 00000020  70 00 00 00 0b 00 0b 00  70 00 00 00 0e 00 0e 00
</I>&gt;<i>  |p.......p.......|
</I>&gt;<i> 00000030  7b 00 00 00 00 00 00 00  00 00 00 00 06 82 89 02
</I>&gt;<i>  |{...............|
</I>&gt;<i> 00000040  6e 38 40 e9 72 17 60 f9  00 00 00 00 00 00 00 00  |n8@
</I>&gt;<i> .r.`.........|
</I>&gt;<i> 00000050  00 00 00 00 00 00 00 00  92 a1 ee 47 2a 46 a5 55
</I>&gt;<i>  |...........G*F.U|
</I>&gt;<i> 00000060  35 28 2a 70 fb ef 71 dc  c7 f1 1b d7 56 90 04 e2
</I>&gt;<i>  |5(*p..q.....V...|
</I>&gt;<i> 00000070  73 61 30 30 30 30 62 63  6d 6f 6e 30 30 30 31 62
</I>&gt;<i>  |sa0000bcmon0001b|
</I>&gt;<i> 00000080  63 72 65 70 6f 72 74 30  32                       |creport02|
</I>&gt;<i>
</I>&gt;<i> Client uses wrong password to calculate NTLM response so helper returns
</I>&gt;<i> NT_STATUS_LOGON_FAILURE:
</I>&gt;<i> 2023/01/31 07:21:18.916 kid2| 84,9| helper.cc(666) submit: placeholder:
</I>&gt;<i> '0',  buf[188]=KK
</I>&gt;<i> TlRMTVNTUAADAAAAGAAYAEAAAAAYABgAWAAAAAAAAABwAAAACwALAHAAAAAOAA4AewAAAAAAAAAAAAAABoKJAm44QOlyF2D5AAAAAAAAAAAAAAAAAAAAAJKh7kcqRqVVNSgqcPvvcdzH8RvXVpAE4nNhMDAwMGJjbW9uMDAwMWJjcmVwb3J0MDI=
</I>&gt;<i>
</I>&gt;<i> 2023/01/31 07:21:18.935 kid2| 84,5| helper.cc(1107)
</I>&gt;<i> helperStatefulHandleRead: helperStatefulHandleRead: 27 bytes from
</I>&gt;<i> ntlmauthenticator #Hlpr25
</I>&gt;<i> 2023/01/31 07:21:18.935 kid2| 84,9| helper.cc(1117)
</I>&gt;<i> helperStatefulHandleRead:  accumulated[27]=NA NT_STATUS_LOGON_FAILURE
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> In the acess.log there are two records, but there is no username in both:
</I>&gt;<i> 2023-01-31 07:21:18|      2 10.73.16.136 TCP_DENIED/407/- 4531 CONNECT
</I>&gt;<i> google.com:443 - HIER_NONE/- text/html -
</I>&gt;<i> 2023-01-31 07:21:18|     19 10.73.16.136 TCP_DENIED/407/- 4500 CONNECT
</I>&gt;<i> google.com:443 - HIER_NONE/- text/html -
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &#1074;&#1090;, 31 &#1103;&#1085;&#1074;. 2023 &#1075;. &#1074; 07:09, Amos Jeffries &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt;:
</I>&gt;<i>
</I>&gt;&gt;<i> On 31/01/2023 4:55 pm, Andrey K wrote:
</I>&gt;&gt;<i> &gt; Hello,
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; I need to log failed Proxy-authentication attempts. The log
</I>&gt;&gt;<i> &gt; information should contain timestamp, username and client IP address.
</I>&gt;&gt;<i> &gt; 407-records in the access.log file do not contain username if
</I>&gt;&gt;<i> &gt; NTLM-authentication is used.
</I>&gt;&gt;<i> &gt; I was wondering if it is possible to set up such a configuration?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Squid log entries record username for all authentication types as soon
</I>&gt;&gt;<i> as a username exists.
</I>&gt;&gt;<i> I expect you are being confused by log records for the part of NTLM
</I>&gt;&gt;<i> handshake before the username is sent to Squid.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Amos
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;<i> squid-users mailing list
</I>&gt;&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20230131/bbe01aa8/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20230131/bbe01aa8/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="025599.html">[squid-users] Logging failed authentication attempts
</A></li>
	<LI>Next message (by thread): <A HREF="025601.html">[squid-users] Logging failed authentication attempts
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25600">[ date ]</a>
              <a href="thread.html#25600">[ thread ]</a>
              <a href="subject.html#25600">[ subject ]</a>
              <a href="author.html#25600">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
