From robertkwild at gmail.com  Sat Jul  1 21:59:43 2023
From: robertkwild at gmail.com (robert k Wild)
Date: Sat, 1 Jul 2023 22:59:43 +0100
Subject: [squid-users] Getting ping to work via proxy
Message-ID: <CAGU_CiKtW0S337d-BguxoZwnnFDxdT00tftF7BLR7vEXHowbNg@mail.gmail.com>

Hi all,

Is there a way to get ping to work via the proxy.

Thanks,
Rob
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230701/d65c261b/attachment.htm>

From Antony.Stone at squid.open.source.it  Sat Jul  1 22:08:20 2023
From: Antony.Stone at squid.open.source.it (Antony Stone)
Date: Sat, 1 Jul 2023 23:08:20 +0100
Subject: [squid-users] Getting ping to work via proxy
In-Reply-To: <CAGU_CiKtW0S337d-BguxoZwnnFDxdT00tftF7BLR7vEXHowbNg@mail.gmail.com>
References: <CAGU_CiKtW0S337d-BguxoZwnnFDxdT00tftF7BLR7vEXHowbNg@mail.gmail.com>
Message-ID: <202307012308.21067.Antony.Stone@squid.open.source.it>

On Saturday 01 July 2023 at 22:59:43, robert k Wild wrote:

> Hi all,
> 
> Is there a way to get ping to work via the proxy.

There is no such thing as an ICMP proxy.


Antony.

-- 
"Can you keep a secret?"
"Well, I shouldn't really tell you this, but... no."


                                                   Please reply to the list;
                                                         please *don't* CC me.


From robertkwild at gmail.com  Sat Jul  1 22:15:28 2023
From: robertkwild at gmail.com (robert k Wild)
Date: Sat, 1 Jul 2023 23:15:28 +0100
Subject: [squid-users] Getting ping to work via proxy
In-Reply-To: <202307012308.21067.Antony.Stone@squid.open.source.it>
References: <CAGU_CiKtW0S337d-BguxoZwnnFDxdT00tftF7BLR7vEXHowbNg@mail.gmail.com>
 <202307012308.21067.Antony.Stone@squid.open.source.it>
Message-ID: <CAGU_CiJp_tTnVgM_oeSEFk7qYnqiU9fUmRJ9bm1_ooWTjZngtA@mail.gmail.com>

So you can't get clients that go through the proxy server to ping to
destination servers

On Sat, 1 Jul 2023, 23:10 Antony Stone, <Antony.Stone at squid.open.source.it>
wrote:

> On Saturday 01 July 2023 at 22:59:43, robert k Wild wrote:
>
> > Hi all,
> >
> > Is there a way to get ping to work via the proxy.
>
> There is no such thing as an ICMP proxy.
>
>
> Antony.
>
> --
> "Can you keep a secret?"
> "Well, I shouldn't really tell you this, but... no."
>
>
>                                                    Please reply to the
> list;
>                                                          please *don't* CC
> me.
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230701/cbc3f223/attachment.htm>

From robertkwild at gmail.com  Sat Jul  1 22:29:03 2023
From: robertkwild at gmail.com (robert k Wild)
Date: Sat, 1 Jul 2023 23:29:03 +0100
Subject: [squid-users] Getting ping to work via proxy
In-Reply-To: <CAGU_CiJp_tTnVgM_oeSEFk7qYnqiU9fUmRJ9bm1_ooWTjZngtA@mail.gmail.com>
References: <CAGU_CiKtW0S337d-BguxoZwnnFDxdT00tftF7BLR7vEXHowbNg@mail.gmail.com>
 <202307012308.21067.Antony.Stone@squid.open.source.it>
 <CAGU_CiJp_tTnVgM_oeSEFk7qYnqiU9fUmRJ9bm1_ooWTjZngtA@mail.gmail.com>
Message-ID: <CAGU_CiJujVZrk12DRjhAd9zs1yn7-EN2Typ+-y9pTsCDJyXCmA@mail.gmail.com>

Will it work if I make my squid into a intercept proxy instead like below

https://wiki.squid-cache.org/SquidFaq/InterceptionProxy

https://wiki.squid-cache.org/ConfigExamples/Intercept/SslBumpWithIntermediateCA

Thanks


On Sat, 1 Jul 2023, 23:15 robert k Wild, <robertkwild at gmail.com> wrote:

> So you can't get clients that go through the proxy server to ping to
> destination servers
>
> On Sat, 1 Jul 2023, 23:10 Antony Stone, <Antony.Stone at squid.open.source.it>
> wrote:
>
>> On Saturday 01 July 2023 at 22:59:43, robert k Wild wrote:
>>
>> > Hi all,
>> >
>> > Is there a way to get ping to work via the proxy.
>>
>> There is no such thing as an ICMP proxy.
>>
>>
>> Antony.
>>
>> --
>> "Can you keep a secret?"
>> "Well, I shouldn't really tell you this, but... no."
>>
>>
>>                                                    Please reply to the
>> list;
>>                                                          please *don't*
>> CC me.
>> _______________________________________________
>> squid-users mailing list
>> squid-users at lists.squid-cache.org
>> http://lists.squid-cache.org/listinfo/squid-users
>>
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230701/a1a9e4f6/attachment.htm>

From Antony.Stone at squid.open.source.it  Sat Jul  1 23:38:43 2023
From: Antony.Stone at squid.open.source.it (Antony Stone)
Date: Sun, 2 Jul 2023 00:38:43 +0100
Subject: [squid-users] Getting ping to work via proxy
In-Reply-To: <CAGU_CiJp_tTnVgM_oeSEFk7qYnqiU9fUmRJ9bm1_ooWTjZngtA@mail.gmail.com>
References: <CAGU_CiKtW0S337d-BguxoZwnnFDxdT00tftF7BLR7vEXHowbNg@mail.gmail.com>
 <202307012308.21067.Antony.Stone@squid.open.source.it>
 <CAGU_CiJp_tTnVgM_oeSEFk7qYnqiU9fUmRJ9bm1_ooWTjZngtA@mail.gmail.com>
Message-ID: <202307020038.43274.Antony.Stone@squid.open.source.it>

On Saturday 01 July 2023 at 23:15:28, robert k Wild wrote:

> So you can't get clients that go through the proxy server to ping to
> destination servers

That depends entirely on whether the clients have a route to send ICMP echo 
requests ("pings") to the destination servers, and whether the replies are 
routed back to the clients.

This routing could be quite different from the routing of HTTP/S requests, 
which is what Squid is (mostly) used for,

> On Sat, 1 Jul 2023, 23:10 Antony Stone wrote:
>
> > On Saturday 01 July 2023 at 22:59:43, robert k Wild wrote:
> > > Hi all,
> > > 
> > > Is there a way to get ping to work via the proxy.
> > 
> > There is no such thing as an ICMP proxy.

On Saturday 01 July 2023 at 23:29:03, robert k Wild wrote:

> Will it work if I make my squid into a intercept proxy instead like below
> 
> https://wiki.squid-cache.org/SquidFaq/InterceptionProxy
> 
> https://wiki.squid-cache.org/ConfigExamples/Intercept/SslBumpWithIntermedia
> teCA

Squid is (primarily) an HTTP/S proxy (it can also do a few other protocols 
such as FTP and Gopher), but it does not proxy ICMP (which is what "pings" 
use).

So, setting up Squid as an intercepting proxy will allow it to intercept 
HTTP/S requests for clients which are not explicitly configured to use a proxy.

It will not make Squid able to proxy ICMP.


What are you trying to achieve here?


Antony.

-- 
Software development can be quick, high quality, or low cost.

The customer gets to pick any two out of three.

                                                   Please reply to the list;
                                                         please *don't* CC me.


From uhlar at fantomas.sk  Sun Jul  2 09:02:14 2023
From: uhlar at fantomas.sk (Matus UHLAR - fantomas)
Date: Sun, 2 Jul 2023 11:02:14 +0200
Subject: [squid-users] Getting ping to work via proxy
In-Reply-To: <CAGU_CiJujVZrk12DRjhAd9zs1yn7-EN2Typ+-y9pTsCDJyXCmA@mail.gmail.com>
References: <CAGU_CiKtW0S337d-BguxoZwnnFDxdT00tftF7BLR7vEXHowbNg@mail.gmail.com>
 <202307012308.21067.Antony.Stone@squid.open.source.it>
 <CAGU_CiJp_tTnVgM_oeSEFk7qYnqiU9fUmRJ9bm1_ooWTjZngtA@mail.gmail.com>
 <CAGU_CiJujVZrk12DRjhAd9zs1yn7-EN2Typ+-y9pTsCDJyXCmA@mail.gmail.com>
Message-ID: <ZKE9FmV1BSpmWeY+@fantomas.sk>

On 01.07.23 23:29, robert k Wild wrote:
>Will it work if I make my squid into a intercept proxy instead like below

no, because of the same reason.

>>> On Saturday 01 July 2023 at 22:59:43, robert k Wild wrote:
>>> > Is there a way to get ping to work via the proxy.

>> On Sat, 1 Jul 2023, 23:10 Antony Stone, <Antony.Stone at squid.open.source.it>
>> wrote:
>>> There is no such thing as an ICMP proxy.

-- 
Matus UHLAR - fantomas, uhlar at fantomas.sk ; http://www.fantomas.sk/
Warning: I wish NOT to receive e-mail advertising to this address.
Varovanie: na tuto adresu chcem NEDOSTAVAT akukolvek reklamnu postu.
The early bird may get the worm, but the second mouse gets the cheese.


From robertkwild at gmail.com  Sun Jul  2 14:28:30 2023
From: robertkwild at gmail.com (robert k Wild)
Date: Sun, 2 Jul 2023 15:28:30 +0100
Subject: [squid-users] Getting ping to work via proxy
In-Reply-To: <ZKE9FmV1BSpmWeY+@fantomas.sk>
References: <CAGU_CiKtW0S337d-BguxoZwnnFDxdT00tftF7BLR7vEXHowbNg@mail.gmail.com>
 <202307012308.21067.Antony.Stone@squid.open.source.it>
 <CAGU_CiJp_tTnVgM_oeSEFk7qYnqiU9fUmRJ9bm1_ooWTjZngtA@mail.gmail.com>
 <CAGU_CiJujVZrk12DRjhAd9zs1yn7-EN2Typ+-y9pTsCDJyXCmA@mail.gmail.com>
 <ZKE9FmV1BSpmWeY+@fantomas.sk>
Message-ID: <CAGU_CiLo5XdpB8Wz8BeJn4H18pG=QaVJagZ9Xs5uTL4Xy6746g@mail.gmail.com>

Yes I understand as squid is a http/Https proxy only, even tho if you make
into an intercept proxy?

Is there a way I can make some traffic use iptables to get to the URL
instead of going through squid

On Sun, 2 Jul 2023, 10:02 Matus UHLAR - fantomas, <uhlar at fantomas.sk> wrote:

> On 01.07.23 23:29, robert k Wild wrote:
> >Will it work if I make my squid into a intercept proxy instead like below
>
> no, because of the same reason.
>
> >>> On Saturday 01 July 2023 at 22:59:43, robert k Wild wrote:
> >>> > Is there a way to get ping to work via the proxy.
>
> >> On Sat, 1 Jul 2023, 23:10 Antony Stone, <
> Antony.Stone at squid.open.source.it>
> >> wrote:
> >>> There is no such thing as an ICMP proxy.
>
> --
> Matus UHLAR - fantomas, uhlar at fantomas.sk ; http://www.fantomas.sk/
> Warning: I wish NOT to receive e-mail advertising to this address.
> Varovanie: na tuto adresu chcem NEDOSTAVAT akukolvek reklamnu postu.
> The early bird may get the worm, but the second mouse gets the cheese.
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230702/b0b0058c/attachment.htm>

From gtaylor at tnetconsulting.net  Mon Jul  3 04:14:25 2023
From: gtaylor at tnetconsulting.net (Grant Taylor)
Date: Sun, 2 Jul 2023 23:14:25 -0500
Subject: [squid-users] Getting ping to work via proxy
In-Reply-To: <202307012308.21067.Antony.Stone@squid.open.source.it>
References: <CAGU_CiKtW0S337d-BguxoZwnnFDxdT00tftF7BLR7vEXHowbNg@mail.gmail.com>
 <202307012308.21067.Antony.Stone@squid.open.source.it>
Message-ID: <fe6bb0b5-33e3-b9c6-def4-714aba9eb928@tnetconsulting.net>

Pre-script:  The following is in response to one specific statement from 
Antony and not really Squid related.

On 7/1/23 5:08?PM, Antony Stone wrote:
> There is no such thing as an ICMP proxy.

I'm not aware of an ICMP proxy.  But my ignorance of one doesn't 
preclude one (or more) from existing.

Also, Building Internet Firewalls from O'Reilly, both 1st and 2nd 
edition, make reference to "SOCKS wrappers for ping and traceroute.

Section 9.5.3 SOCKS Components

--8<--
The SOCKS package includes the following components:

  - The SOCKS server. This server must run on a Unix system, although it 
has been ported to many different variants of Unix.

  - The SOCKS client library for Unix machines.

  - SOCKS-ified versions of several standard Unix client programs sucn 
as FTP and Telnet.

  - SOCKS wrappers for ping and traceroute.

  - The runsocks program to SOCKS-ify dynamically linked programs at 
runtime without recompiling.

In addition, client libraries for Macintosh and Windows systems are 
available as separate packages.

Figure 9-4. Using SOCKS for proxying.
-->8--

So there seems to have been a way to use ping and traceroute via SOCKS 
proxy once upon a time.  It may have been lost to the sands of time.

I suspect that the book is talking about the SOCKS server from NEC, 
something that I've not been able to get my hands on yet.

It may be talking about something from Trusted Internet Solutions' 
(a.k.a. TIS's) Firewall Toolkit (a.k.a. fwtk).  I've not yet messed with 
the old copies of TIS FWTK that I have.

Seeing as how this is SOCKS related and me not being aware of Squid 
supporting SOCKS, it's still very much a "no, Squid doesn't support ICMP 
proxying".  At least not without doing some things that encapsulate ICMP 
traffic in some sort of tunnel that happens to flow through Squid.  But 
even that is HTTP(S) traffic as far as Squid is concerned.

Maybe websocket has something that it can do, but I'm not up on that.





Grant. . . .


From robertkwild at gmail.com  Mon Jul  3 10:46:20 2023
From: robertkwild at gmail.com (robert k Wild)
Date: Mon, 3 Jul 2023 11:46:20 +0100
Subject: [squid-users] acl follow_x_forwarded_for
Message-ID: <CAGU_CiLEUR-mUczssfviT9BFqOvbBk1wmaqpX28Eg47ijjY+9A@mail.gmail.com>

hi all,

im reading this acl

http://www.squid-cache.org/Doc/config/follow_x_forwarded_for/

is this to fool the dst server to think its coming from the client pc
instead of squid proxy

thanks,
rob

-- 
Regards,

Robert K Wild.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230703/5331c5ef/attachment.htm>

From Antony.Stone at squid.open.source.it  Mon Jul  3 10:54:20 2023
From: Antony.Stone at squid.open.source.it (Antony Stone)
Date: Mon, 3 Jul 2023 11:54:20 +0100
Subject: [squid-users] acl follow_x_forwarded_for
In-Reply-To: <CAGU_CiLEUR-mUczssfviT9BFqOvbBk1wmaqpX28Eg47ijjY+9A@mail.gmail.com>
References: <CAGU_CiLEUR-mUczssfviT9BFqOvbBk1wmaqpX28Eg47ijjY+9A@mail.gmail.com>
Message-ID: <202307031154.20702.Antony.Stone@squid.open.source.it>

On Monday 03 July 2023 at 11:46:20, robert k Wild wrote:

> hi all,
> 
> im reading this acl
> 
> http://www.squid-cache.org/Doc/config/follow_x_forwarded_for/
> 
> is this to fool the dst server to think its coming from the client pc
> instead of squid proxy

No; it tells Squid to accept connection requests from other proxies which 
present the correct X-Forwarded-For header:

"If a request reaches us from a source that is allowed by this directive, then 
we trust the information it provides regarding the IP of the client it 
received from (if any)."


Antony.

-- 
Wanted: telepath.   You know where to apply.

                                                   Please reply to the list;
                                                         please *don't* CC me.


From robertkwild at gmail.com  Mon Jul  3 10:56:20 2023
From: robertkwild at gmail.com (robert k Wild)
Date: Mon, 3 Jul 2023 11:56:20 +0100
Subject: [squid-users] acl follow_x_forwarded_for
In-Reply-To: <202307031154.20702.Antony.Stone@squid.open.source.it>
References: <CAGU_CiLEUR-mUczssfviT9BFqOvbBk1wmaqpX28Eg47ijjY+9A@mail.gmail.com>
 <202307031154.20702.Antony.Stone@squid.open.source.it>
Message-ID: <CAGU_CiJ533SERFS=udkDRabm0=HysJq5HHTFnonXj94J1S3KrA@mail.gmail.com>

thanks Antony

On Mon, 3 Jul 2023 at 11:54, Antony Stone <Antony.Stone at squid.open.source.it>
wrote:

> On Monday 03 July 2023 at 11:46:20, robert k Wild wrote:
>
> > hi all,
> >
> > im reading this acl
> >
> > http://www.squid-cache.org/Doc/config/follow_x_forwarded_for/
> >
> > is this to fool the dst server to think its coming from the client pc
> > instead of squid proxy
>
> No; it tells Squid to accept connection requests from other proxies which
> present the correct X-Forwarded-For header:
>
> "If a request reaches us from a source that is allowed by this directive,
> then
> we trust the information it provides regarding the IP of the client it
> received from (if any)."
>
>
> Antony.
>
> --
> Wanted: telepath.   You know where to apply.
>
>                                                    Please reply to the
> list;
>                                                          please *don't* CC
> me.
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users
>


-- 
Regards,

Robert K Wild.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230703/28a1bee1/attachment.htm>

From robertkwild at gmail.com  Mon Jul  3 18:02:58 2023
From: robertkwild at gmail.com (robert k Wild)
Date: Mon, 3 Jul 2023 19:02:58 +0100
Subject: [squid-users] change squid proxy into intercept instead
Message-ID: <CAGU_CiKCn6F1Aw=gOCfS8xx-UHLdhS6CB7ePFm4Z1YMKYOJJJg@mail.gmail.com>

hi all,

running squid proxy with SSL-bump and some sites dont like squid being MITM
and it breaks the SSL cert, so i do peek/splice/bump so the SSL cert goes
straight to the client without squid inspecting it

do you think if i make squid into an intercept proxy it will resolve the
peek/splice/bump issue ie i wont need it anymore

thanks,
rob
-- 
Regards,

Robert K Wild.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230703/daecb375/attachment.htm>

From rousskov at measurement-factory.com  Wed Jul  5 14:40:44 2023
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Wed, 5 Jul 2023 10:40:44 -0400
Subject: [squid-users] trickeling support in squid as icap client
In-Reply-To: <20230630095544.wrlyaujecj4v2yxf@bloms.de>
References: <20230630095544.wrlyaujecj4v2yxf@bloms.de>
Message-ID: <b2a09869-6818-500c-9fe9-e06d3ff5e7f0@measurement-factory.com>

On 6/30/23 05:55, Dieter Bloms wrote:
> Hello,
> 
> we are currently using the Squid with an ICAP virus scanner, which is capable of trickling.
> There are many manufacturers who support the ICAP protocol but not trickling.
> 
> Therefore, in my opinion, it would make sense if squid supported trickeling as ICAP client.
> 
> Then you could use any ICAP virus scanner independent from trickling support of the scanner.
> 
> What do you think about the idea?

I think it is a good idea to add quality trickling support on top of 
Squid adaptation layer, covering not just ICAP services, but eCAP 
adapters as well. Most of the trickling code should probably be located 
outside of ICAP- or eCAP-specific code.

Based on my team experience with implementing trickling in ICAP and eCAP 
adapters, proper trickling support is far from trivial and requires a 
few configuration options. If somebody decides to work on this project, 
I recommend starting with a squid-dev RFC detailing essential Squid 
configuration and API changes.


Cheers,

Alex.



From squid3 at treenet.co.nz  Wed Jul  5 17:28:01 2023
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Thu, 6 Jul 2023 05:28:01 +1200
Subject: [squid-users] change squid proxy into intercept instead
In-Reply-To: <CAGU_CiKCn6F1Aw=gOCfS8xx-UHLdhS6CB7ePFm4Z1YMKYOJJJg@mail.gmail.com>
References: <CAGU_CiKCn6F1Aw=gOCfS8xx-UHLdhS6CB7ePFm4Z1YMKYOJJJg@mail.gmail.com>
Message-ID: <ee2042c7-92a0-a055-2096-80b148093a6e@treenet.co.nz>

On 4/07/23 06:02, robert k Wild wrote:
> hi all,
> 
> running squid proxy with SSL-bump and some sites dont like squid being 
> MITM and it breaks the SSL cert, so i do peek/splice/bump so the SSL 
> cert goes straight to the client without squid inspecting it
> 
> do you think if i make squid into an intercept proxy it will resolve the 
> peek/splice/bump issue ie i wont need it anymore
> 

It will not have any effect on your problem.


Cheers
Amos


From robertkwild at gmail.com  Wed Jul  5 17:57:54 2023
From: robertkwild at gmail.com (robert k Wild)
Date: Wed, 5 Jul 2023 18:57:54 +0100
Subject: [squid-users] change squid proxy into intercept instead
In-Reply-To: <ee2042c7-92a0-a055-2096-80b148093a6e@treenet.co.nz>
References: <CAGU_CiKCn6F1Aw=gOCfS8xx-UHLdhS6CB7ePFm4Z1YMKYOJJJg@mail.gmail.com>
 <ee2042c7-92a0-a055-2096-80b148093a6e@treenet.co.nz>
Message-ID: <CAGU_CiL4cgJqH1x2n2E6=uGj5y6oa4+3O3s6DRdC_2mNFcbndA@mail.gmail.com>

Great thanks Amos for that clarification :)

On Wed, 5 Jul 2023, 18:28 Amos Jeffries, <squid3 at treenet.co.nz> wrote:

> On 4/07/23 06:02, robert k Wild wrote:
> > hi all,
> >
> > running squid proxy with SSL-bump and some sites dont like squid being
> > MITM and it breaks the SSL cert, so i do peek/splice/bump so the SSL
> > cert goes straight to the client without squid inspecting it
> >
> > do you think if i make squid into an intercept proxy it will resolve the
> > peek/splice/bump issue ie i wont need it anymore
> >
>
> It will not have any effect on your problem.
>
>
> Cheers
> Amos
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230705/e722d784/attachment.htm>

From robertkwild at gmail.com  Thu Jul  6 12:29:51 2023
From: robertkwild at gmail.com (robert k Wild)
Date: Thu, 6 Jul 2023 13:29:51 +0100
Subject: [squid-users] make URL bypass squid proxy
In-Reply-To: <005101d9aa76$1a7cce30$4f766a90$@gmail.com>
References: <CAGU_CiJaVNkM7g28rSmXg+QVDRcLa05vEsNEpAe1+dMOdAjjPg@mail.gmail.com>
 <001501d9a87e$81662140$843263c0$@gmail.com>
 <CAGU_CiK5EXtYuK4dPod=sLvUHGWr63WeLdKW9k45RLjt_=e=Bg@mail.gmail.com>
 <003601d9aa22$1505c550$3f114ff0$@gmail.com>
 <CAGU_CiKqgxK0ejJoL1F0n5YF3y-4JY2OJbpSJe7TUK6sskRKzw@mail.gmail.com>
 <005101d9aa76$1a7cce30$4f766a90$@gmail.com>
Message-ID: <CAGU_Ci+c_BbOYXED69V6EgTCKYkWhGp69F5c1LSUY5CK-xHTJQ@mail.gmail.com>

hi Eliezer,

unfortunately that did not work ie

acl NoSSLInterceptRegEx ssl::server_name_regex (^|.*\.)redshift3d\.com$
acl NoSSLInterceptDstDom ssl::server_name .redshift3d.com

acl NoSSLInterceptAnyOf any-of NoSSLInterceptDstDom NoSSLInterceptRegEx

ssl_bump peek DiscoverSNIHost
ssl_bump splice NoSSLInterceptAnyOf
ssl_bump bump all

but strange is on the firewall if i make a rule for that network, port 80,
443 to access redshift3d.com it works, so ive narrowed it down to the squid

thanks,
rob

On Thu, 29 Jun 2023 at 11:40, <ngtech1ltd at gmail.com> wrote:

> Hey Rob,
>
> it?s a great question.
> I will assume you are using squid 5.x since it?s the stable one.
> There is a configuration reference documentation at:
> http://www.squid-cache.org/Versions/v5/cfgman/
>
> And the relevant one is ?acl?:
> http://www.squid-cache.org/Versions/v5/cfgman/acl.html
>
> In the config we the next options:
> * dstdom_regex
> * dstdomain
> * ssl::server_name
> * ssl::server_name_regex
>
> Each one of them is different in two things.
> The dstdomain is happening when the http request verification is done,
> usually in the http_access part.
> So for a CONNECT request in your case it should work but will only work
> for http_access rules ie allow or deny the connection to being proxied by
> the proxy.
> All this happens before the bump stage.
> The dstdom_regex is doing the same but with another "lookup" mechanism.
> Just to illustrate we will use the domain www.example.com.
>
> With dstdomain .example.com which is a wildcard domain the www.example
> .com will match since what it does it..
> Take apart the .example.com into .com and .example and example
> (logically, not the code actually does..)
> Then when a request for www.example-2.com arrives the dstdomain acl
> checks the strings one by one ie:
> com
> example-2
> www
>
> So the "com" would match and since it has a dot "." as a prefix it
> continues to the next part of the domain name ie:
> example-2
>
> and it will try to match it to "example" from the ".example.com'.
> then it will fail and there for it will declare the specific definition in
> the acl as "do not match.
> But for www.example .com it would be different:
>
> Squid will find that the .com is in the "com" part of www.example.com and
> will continue to the next part ie
> "example" and it will match.
> Then it will see the dot "." which means that all subdomains are a part of
> this rule ie both example.com and any other domain
> under .example.com will match so... www.example.com and www2.example.com
> and w.example.com will match and this is compared to
> example.com
>
> with dstdomain example.com it will only match a full match of example.com
> but not www.example.com and it's pointless to define both:
> - example.com
> - .example.com
>
> In the same acl file.
> Squid will compare it to the basic proxy url request and the Host: header
> inside of it.
> (Amos might remember which one of these wins or which one is the main one)
>
> So that's how a dstdomain test works.
> The dstdom_regex is applied on the same "part" of the proxy request ie
> request url and Host header but...
> Tries to match it with a regex that is a much more "CPU" intensive but can
> do magic if you know how to use it right.
> The pros are that you can use one regex to match about 100 domains however
> dstdomain is much faster in many cases.
> To test regex in general I love:
> https://rubular.com/
>
> and it's very simple to put a line with the url or the domain itself and
> write the pattern and then get instant result.
> There are many sites which does this exact same thing.
> You need: activate.redshift3d.com  for the test.
>
> For the server_name dstdom and regex the difference is on what part of the
> "known" information on the request done.
> Ie it's not on the known plain text proxy request but a "peek" into the
> client or server TLS part of the connection bumping.
> It's possible on TLS 1.2 with ease but 1.3 with encryption it's a whole
> other story.
> (Alex and his team is more involved in this part then me)
>
> It's a bit more complex in the server_name part since from what I remember
> the server_name can be the SNI itself or parts of the
> certificate of the server.
> In the certificate of the server in many cases there is no real domain but
> a catch all ie multidomain which is for example:
> *.example.com
>
> The ssl::server_name is like dstdomain so .example.com should match both
> SNI with www.example.com and the *.example.com
> If it doesn't then it?s a bug..
>
> About the ssl::server_name_regex you will need to test and match the regex
> against couple possibilities that are in the certificate ie:
> *.example.com
> activation.example.com
>
> etc...
>
> The current certificate I see is:
> Certificate:
>     Data:
>         Version: 3 (0x2)
>         Serial Number:
>             c0:71:02:fc:1f:e5:64:5b:0d:d6:ae:c8:1a:17:e6:80
>         Signature Algorithm: sha256WithRSAEncryption
>         Issuer: C = GB, ST = Greater Manchester, L = Salford, O = Sectigo
> Limited, CN = Sectigo RSA Domain Validation Secure Server CA
>         Validity
>             Not Before: Dec 14 00:00:00 2022 GMT
>             Not After : Jan 12 23:59:59 2024 GMT
>         Subject: CN = activate.redshift3d.com
>         Subject Public Key Info:
>             Public Key Algorithm: rsaEncryption
>                 RSA Public-Key: (2048 bit)
>                 Modulus:
>                     00:cd:f9:bd:58:a4:7a:16:3f:23:12:9d:e0:1e:39:
>                     a0:ef:66:ae:b3:ae:32:5c:69:9e:cc:89:83:fb:a2:
>                     e0:c7:9d:86:aa:e6:9b:b3:d9:0c:bb:35:36:2f:cf:
>                     be:ec:1e:62:ca:d8:ab:16:66:6e:00:8d:f7:42:3d:
>                     5b:d6:bf:a0:30:a1:c2:6f:5e:69:76:ef:0c:38:73:
>                     d2:e8:42:b8:83:04:a3:2c:da:22:a4:c4:13:71:38:
>                     36:00:1b:e7:b3:f0:fe:6e:59:17:11:e7:0a:81:3e:
>                     04:b2:ad:e0:61:c1:15:f3:9a:36:33:24:a6:f1:0d:
>                     b6:e6:32:91:34:54:7c:da:40:14:72:06:25:91:78:
>                     75:07:84:62:47:7b:3f:05:60:e6:35:d3:27:55:1e:
>                     ff:23:82:18:09:f5:8a:0f:a6:cb:02:bc:d6:09:98:
>                     54:5b:10:e3:d2:09:4e:31:2a:75:42:29:00:86:9b:
>                     f9:78:2f:fd:99:9e:2e:10:3e:bc:84:f5:9b:3a:3f:
>                     fa:d9:b6:20:c0:2e:86:f3:de:14:be:3a:1a:05:30:
>                     3b:00:e6:50:8d:4c:13:a3:97:dc:f4:03:9e:84:31:
>                     0d:23:f2:02:50:6d:53:a5:30:03:b0:fd:f2:46:64:
>                     49:22:a4:d1:5a:00:fb:78:37:fc:51:b1:f0:6e:41:
>                     3b:5d
>                 Exponent: 65537 (0x10001)
>         X509v3 extensions:
>             X509v3 Authority Key Identifier:
>
> keyid:8D:8C:5E:C4:54:AD:8A:E1:77:E9:9B:F9:9B:05:E1:B8:01:8D:61:E1
>
>             X509v3 Subject Key Identifier:
>                 5D:BC:D9:F2:C4:99:83:5E:C0:3A:F1:BF:FE:F2:E3:92:92:F1:F0:29
>             X509v3 Key Usage: critical
>                 Digital Signature, Key Encipherment
>             X509v3 Basic Constraints: critical
>                 CA:FALSE
>             X509v3 Extended Key Usage:
>                 TLS Web Server Authentication, TLS Web Client
> Authentication
>             X509v3 Certificate Policies:
>                 Policy: 1.3.6.1.4.1.6449.1.2.2.7
>                   CPS: https://sectigo.com/CPS
>                 Policy: 2.23.140.1.2.1
>
>             Authority Information Access:
>                 CA Issuers - URI:
> http://crt.sectigo.com/SectigoRSADomainValidationSecureServerCA.crt
>                 OCSP - URI:http://ocsp.sectigo.com
>
>             X509v3 Subject Alternative Name:
>                 DNS:activate.redshift3d.com, DNS:
> www.activate.redshift3d.com
>             CT Precertificate SCTs:
>                 Signed Certificate Timestamp:
>                     Version   : v1 (0x0)
>                     Log ID    :
> 76:FF:88:3F:0A:B6:FB:95:51:C2:61:CC:F5:87:BA:34:
>
> B4:A4:CD:BB:29:DC:68:42:0A:9F:E6:67:4C:5A:3A:74
>                     Timestamp : Dec 14 15:34:39.227 2022 GMT
>                     Extensions: none
>                     Signature : ecdsa-with-SHA256
>
> 30:44:02:20:6E:D0:96:68:F3:07:A0:5F:DD:C5:B2:61:
>
> 2F:51:6B:06:4A:3C:7F:9B:DA:08:6D:5A:31:0D:B8:0B:
>
> 83:7D:D6:37:02:20:64:66:3F:A2:40:87:78:9E:C8:90:
>
> 7C:EE:7C:77:3C:BB:43:C1:9F:52:54:F1:04:85:B6:AC:
>                                 6B:F2:36:8E:E3:03
>                 Signed Certificate Timestamp:
>                     Version   : v1 (0x0)
>                     Log ID    :
> 3B:53:77:75:3E:2D:B9:80:4E:8B:30:5B:06:FE:40:3B:
>
> 67:D8:4F:C3:F4:C7:BD:00:0D:2D:72:6F:E1:FA:D4:17
>                     Timestamp : Dec 14 15:34:39.153 2022 GMT
>                     Extensions: none
>                     Signature : ecdsa-with-SHA256
>
> 30:44:02:20:69:BA:F2:DD:32:B3:48:0C:26:E3:FB:F0:
>
> DD:4E:5E:10:95:1E:B4:59:5B:67:64:C4:F2:40:7C:A8:
>
> 62:35:71:FE:02:20:13:15:41:26:E5:9C:DB:34:DA:D7:
>
> B9:CB:B3:1A:4E:33:C7:46:7F:D9:93:45:25:7F:DE:A3:
>                                 72:EB:07:03:DB:C5
>                 Signed Certificate Timestamp:
>                     Version   : v1 (0x0)
>                     Log ID    :
> EE:CD:D0:64:D5:DB:1A:CE:C5:5C:B7:9D:B4:CD:13:A2:
>
> 32:87:46:7C:BC:EC:DE:C3:51:48:59:46:71:1F:B5:9B
>                     Timestamp : Dec 14 15:34:39.124 2022 GMT
>                     Extensions: none
>                     Signature : ecdsa-with-SHA256
>
> 30:45:02:20:2C:E2:85:9C:A6:54:1B:1C:31:E5:F8:37:
>
> E9:CD:09:8B:D8:26:29:E4:C7:65:94:9C:FF:32:D2:41:
>
> CD:16:A3:51:02:21:00:A0:2F:C3:F7:A6:55:3B:21:EB:
>
> 9B:CA:6E:4E:07:A2:8C:40:4B:E2:27:D6:82:44:0F:09:
>                                 C9:F7:7D:1B:72:6F:13
>     Signature Algorithm: sha256WithRSAEncryption
>          25:bd:bb:de:57:c0:7f:07:5e:18:62:2e:0b:d3:03:54:a7:45:
>          ab:c6:1f:e2:f6:58:ff:6e:8e:6b:4f:09:9a:87:66:32:81:7f:
>          f4:35:4f:7e:65:e5:6a:04:d6:62:62:ff:d9:3a:f2:6f:19:ba:
>          fa:e6:35:0e:2a:44:5c:3b:ee:9d:97:72:05:86:0c:4c:01:c1:
>          f0:8c:21:c1:c4:84:54:d8:a8:05:25:18:72:db:f7:53:9b:f1:
>          13:d6:0b:bc:92:6e:01:e3:fd:de:a1:45:e9:29:37:e1:2e:64:
>          36:b4:4d:38:c1:60:02:6a:17:3d:87:a2:5f:33:3b:86:eb:0d:
>          cc:dd:fa:d4:43:58:50:43:e7:b7:ec:0a:4f:86:72:15:e5:30:
>          c9:bb:5f:0b:83:9c:26:6f:60:49:dd:1a:7c:92:45:45:4e:b5:
>          ce:cd:64:8c:12:83:e9:3d:5c:6b:65:97:75:99:4c:66:eb:d0:
>          3a:ca:18:62:8a:08:07:16:ab:09:66:bd:65:43:94:00:d9:79:
>          3e:84:b4:60:7d:7e:f9:09:3c:fe:2d:ad:98:94:17:0c:24:8f:
>          e1:a2:74:b6:3b:68:c0:01:f9:67:e8:b9:d2:6a:65:9e:99:a3:
>          4a:5f:39:31:ae:c1:59:02:7b:ef:db:b2:94:06:f8:1a:74:c1:
>          d7:5b:5b:6a
>
> So the DNS names it will check are:
>         Subject: CN = activate.redshift3d.com
>                 DNS:activate.redshift3d.com, DNS:
> www.activate.redshift3d.com
>
> So to summarize the checks of ssl::server_name/ will be done on:
> * activate.redshift3d.com
> * activate.redshift3d.com
> * www.activate.redshift3d.com
>
> So . redshift3d.com ssl::server_name should match the certificate.
> If for any reason it doesn't work you can try ssl::server_name_regex with
> something like:
> (^|\.)activate\.redshift3d\.com$
>
> Or just to verify if there is a bug in squid code try:
> (^|\.)activate\.redshift3d\.com
>
> Now, the splice should be able to take into account also dstdomain and
> dstdom_regex but it should match them only if they exist in a plain text
> form like in any simple forward proxy CONNECT request.
> If for any reason it doesn?t work we should investigate what might cause
> this issue.
>
> I hope the scroll I wrote make sense to you and with hopes it will clear
> out the doubts about the wiki article you mentioned.
> I believe this is considered a summary of the subject and if Alex and
> others might think so it can be converted into an example article in the
> wiki.
>
> Let me know if this makes sense and resolve the issue.
>
> Yours,
> Eliezer
>
> From: robert k Wild <robertkwild at gmail.com>
> Sent: Thursday, June 29, 2023 12:18
> To: ngtech1ltd at gmail.com
> Cc: Squid Users <squid-users at lists.squid-cache.org>
> Subject: Re: [squid-users] make URL bypass squid proxy
>
> very clever, so you bunch all the acls up
>
> acl NoSSLInterceptAnyOf any-of NoSSLInterceptDstDom
> NoSSLInterceptDstDomFile NoSSLInterceptRegEx NoSSLInterceptRegExFile
>
> the key word is "any-of" ie if the url hits any one do that first
>
> what about instead of making it
>
> ssl::server_name_regex
>
> i make it
>
> dstdom_regex
>
> On Thu, 29 Jun 2023 at 01:38, <mailto:ngtech1ltd at gmail.com> wrote:
> Hey Rob,
>
> The first thing is to allow the domain in the http_acces just to be sure
> and use a basic deny all bottom line.
> Let me try to simplify your squid.conf
> In a link:
> https://gist.github.com/elico/b49f4a28d4b5db5ba882b10d40872d5e
>
> In plain text:
> ## START OF FILE
> # SSL Interception  basic rules
> acl DiscoverSNIHost at_step SslBump1
>
> acl NoSSLInterceptRegEx ssl::server_name_regex (^|.*\.)redshift3d\.com$
> acl NoSSLInterceptRegExFile ssl::server_name_regex
> "/usr/local/squid/etc/no-intercept-ssl-regex.txt"
>
> acl NoSSLInterceptDstDom ssl::server_name .redshift3d.com
> acl NoSSLInterceptDstDomFile ssl::server_name
> "/usr/local/squid/etc/no-intercept-ssl-dstdom.txt"
>
> ## Any of will test what ever rule match first in a first match/hit fasion
> acl NoSSLInterceptAnyOf any-of NoSSLInterceptDstDom
> NoSSLInterceptDstDomFile NoSSLInterceptRegEx NoSSLInterceptRegExFile
>
> ssl_bump peek DiscoverSNIHost
> ssl_bump splice NoSSLInterceptAnyOf
> ssl_bump bump all
>
> #SSL Bump port
> http_port 3128 ssl-bump cert=/usr/local/squid/etc/ssl_cert/myCA.pem
> generate-host-certificates=on dynamic_cert_mem_cache_size=4MB
> sslcrtd_program /usr/local/squid/libexec/security_file_certgen -s
> /var/lib/ssl_db -M 4MB
>
> ## http_access acls, will apply on incomming requests and not on responses
> acl special_url_regex url_regex https?://(^|.*\.)redshift3d\.com\/
> acl special_url_regex_file url_regex
> "/usr/local/squid/etc/special_url_regex.txt"
>
> acl special_url_dst_dom dstdomain .redshift3d.com
> acl special_url_dst_dom_file dstdomain
> "/usr/local/squid/etc/special_url_dstdom.txt"
>
> acl special_url_any_of any-of special_url_dst_dom special_url_dst_dom_file
> special_url_regex special_url_regex_file
>
> acl localnet src http://192.168.0.0/16
> acl localnet src http://10.0.0.0/8
>
> http_access allow localnet special_url_any_of
> http_access deny all
> ## END OF FILE
>
>  Once the above will work try to add other http_access rule like reply
> access rules
>
> Let me know what happens,
> Eliezer
>
> From: robert k Wild <mailto:robertkwild at gmail.com>
> Sent: Tuesday, June 27, 2023 09:36
> To: mailto:ngtech1ltd at gmail.com
> Cc: Squid Users <mailto:squid-users at lists.squid-cache.org>
> Subject: Re: [squid-users] make URL bypass squid proxy
>
> Hi Eliezer,
>
> this is a snippet of my whitelist and no intercept SSL config
>
> #SSL Interception
> acl DiscoverSNIHost at_step SslBump1
> acl NoSSLIntercept ssl::server_name_regex
> "/usr/local/squid/etc/interceptssl.txt"
> ssl_bump peek DiscoverSNIHost
> ssl_bump splice NoSSLIntercept
> ssl_bump bump all
> #
> #SSL Bump
> http_port 3128 ssl-bump cert=/usr/local/squid/etc/ssl_cert/myCA.pem
> generate-host-certificates=on dynamic_cert_mem_cache_size=4MB
> sslcrtd_program /usr/local/squid/libexec/security_file_certgen -s
> /var/lib/ssl_db -M 4MB
> #
> #deny up MIME types
> acl upmime req_mime_type "/usr/local/squid/etc/mimedeny.txt"
> #
> #deny URL links
> acl url_links url_regex "/usr/local/squid/etc/linksurl.txt"
> #
> #allow special URL paths
> acl special_url url_regex "/usr/local/squid/etc/urlspecial.txt"
> #
> #deny down MIME types
> acl downmime rep_mime_type "/usr/local/squid/etc/mimedeny.txt"
> #
> http_reply_access allow special_url
> http_reply_access deny downmime
> #http_access deny upmime
> #http_access deny url_links
> #
> #HTTP_HTTPS whitelist websites
> acl whitelist ssl::server_name_regex "/usr/local/squid/etc/urlwhite.txt"
> #
> http_access allow activation whitelist
> http_access deny all
>
> so basically no SSL interception
>
> #SSL Interception
> acl DiscoverSNIHost at_step SslBump1
> acl NoSSLIntercept ssl::server_name_regex
> "/usr/local/squid/etc/interceptssl.txt"
> ssl_bump peek DiscoverSNIHost
> ssl_bump splice NoSSLIntercept
> ssl_bump bump all
>
> and whitelisting
>
> #HTTP_HTTPS whitelist websites
> acl whitelist ssl::server_name_regex "/usr/local/squid/etc/urlwhite.txt"
>
> in both txt files ie
>
> /usr/local/squid/etc/interceptssl.txt
> /usr/local/squid/etc/urlwhite.txt
>
> i have a URL that first i have to whitelist and then if i want squid not
> to inspect the url traffic i put it in the SSL interception (i do this as
> some websites dont like MITM )
>
> but even putting the URL in question in both files im still having issues
> with this website ie its still being detected that its passing through a
> proxy
>
> thanks,
> rob
>
> On Mon, 26 Jun 2023 at 23:35, <mailto:mailto:ngtech1ltd at gmail.com> wrote:
> Hey Robert,
>
> I am not sure what forward proxy setup you have there.
> A simple forward proxy?
> What tool are you using for whitelisting?
> You can use an external acl helper to allow dynamic updates of the
> whitelists or
> to periodic update your lists and reload.
> It will depend on the size of your lists.
> What OS are you using for your squid proxy?
>
> More details will help us help you.
>
> Eliezer
>
> From: squid-users <mailto:mailto:squid-users-bounces at lists.squid-cache.org>
> On Behalf Of robert k Wild
> Sent: Monday, June 26, 2023 22:25
> To: Squid Users <mailto:mailto:squid-users at lists.squid-cache.org>
> Subject: [squid-users] make URL bypass squid proxy
>
> hi all,
>
> i have set up squid for url whitelisting and no intercept SSL (see below)
>
> https://wiki.squid-cache.org/ConfigExamples/Caching/AdobeProducts
>
> but some websites i want the client to bypass the squid proxy and go
> straight to the website as i think this is why a url isnt working even when
> i add the url to both files ie urlwhite and no intercept SSL
>
>
>
> thanks,
> rob
>
> --
> Regards,
>
> Robert K Wild.
>
>
> --
> Regards,
>
> Robert K Wild.
>
>
> --
> Regards,
>
> Robert K Wild.
>
>

-- 
Regards,

Robert K Wild.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230706/95040306/attachment.htm>

From Alessandro.Baritello at eng.it  Thu Jul  6 12:32:13 2023
From: Alessandro.Baritello at eng.it (Alessandro Baritello)
Date: Thu, 6 Jul 2023 12:32:13 +0000
Subject: [squid-users] Squid config Teams add-on in Outlook
Message-ID: <AS4PR01MB101292B88388A282257884BAAF32CA@AS4PR01MB10129.eurprd01.prod.exchangelabs.com>

Hello, I need help with a Squid ver. 4.15 used with kerberos authentication to windows, whitelists and cache_peers to McAfee Web Gateway appliances.
Everything works, except for a teams add-on integrated in Outlook, i.e. when a teams meeting is created from Outlook it does not open Teams correctly, and therefore the relative part with the Teams Meeting ID is not seen in the email.
Consulting access.log you can see numerous TCP_DENIED/407 errors even if previously there was TCP_TUNNEL/200 with the connect. It is not clear if this error, which seems to be extended to other urls that have nothing to do with Teams, Outlook and Microsoft, is indicative of this issue. Considering that navigation (for permitted sites) happens perfectly.
We can neglect the peer component of the McAfee Web Gateway as the old TMG proxies that we are discontinuing point to the same appliances, and do not have this problem.
Thanks to anyone who can suggest a solution.

--
Alessandro Baritello
Managed Operations ? Cloud & Technology Services
alessandro.baritello at eng.it<mailto:Giovanni.bombino at eng.it>

Engineering D?HUB S.p.A. - Gruppo Engineering Ingegneria Informatica S.p.A.
Corso Mortara, 22 ? 10149 Torino
www.eng.it<http://www.eng.it/>

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230706/123422d1/attachment.htm>

From squid3 at treenet.co.nz  Fri Jul  7 08:46:34 2023
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Fri, 7 Jul 2023 20:46:34 +1200
Subject: [squid-users] [squid-announce] Squid 6.1 is available
Message-ID: <947c49c0-a6af-539b-2590-6415f60e339e@treenet.co.nz>

The Squid HTTP Proxy team is very pleased to announce the availability
of the Squid-6.1 release!


This release is we believe, stable enough for general production use.


Support for Squid-5 bug fixes has now officially ceased. Bugs in 5.x
will continue to be fixed, however the fixes will be added to the 6.x
series. All users of Squid-5.x are encouraged to plan for upgrades.


A short list of the major new features is:

  * TLS ServerHello
  * Log TLS Communication Secrets
  * RFC 9211: HTTP Cache-Status support
  * ext_kerberos_ldap_group_acl: Support -b with -D


Some features have been removed in 6.1:

  * Remove Gopher Protocol Support
  * Removed Outdated Tools
  * Ban ACL key changes in ACLs
  * Block to-local Traffic
  * RFC 9111: Stop treating Warning specially


Further details can be found in the release notes or the wiki.
  http://www.squid-cache.org/Versions/v6/RELEASENOTES.html
  https://wiki.squid-cache.org/Releases/Squid-6


Please remember to run "squid -k parse" when testing upgrade to a new
version of Squid. It will audit your configuration files and report
any identifiable issues the new release will have in your installation
before you "press go".


All feature additions are considered *experimental* until they have
survived at least one series of releases in general production use.
Please be aware of that when rolling out features which are new in
this series. Not all use-cases have been well tested yet and some may
not even have been implemented. Assistance is still needed despite the
releases general stability level.


Plans for the next series of releases is already well underway. Our
future release plan and upcoming features can be found at:
   https://wiki.squid-cache.org/ReleaseSchedule
   https://wiki.squid-cache.org/RoadMap


  See the ChangeLog for the full list of changes in this and earlier
  releases.

   All users of Squid-6.0 beta releases are urged to
   upgrade to this release as soon as possible.

   All users of Squid-5 are encouraged to
   upgrade where possible.


See the ChangeLog for the full list of changes in this and earlier
releases.

Please refer to the release notes at
http://www.squid-cache.org/Versions/v6/RELEASENOTES.html
when you are ready to make the switch to Squid-6

This new release can be downloaded from our HTTP or FTP servers

   http://www.squid-cache.org/Versions/v6/
   ftp://ftp.squid-cache.org/pub/squid/
   ftp://ftp.squid-cache.org/pub/archive/6/

or the mirrors. For a list of mirror sites see

   http://www.squid-cache.org/Download/http-mirrors.html
   http://www.squid-cache.org/Download/mirrors.html

If you encounter any issues with this release please file a bug report.
   https://bugs.squid-cache.org/


Amos Jeffries
_______________________________________________
squid-announce mailing list
squid-announce at lists.squid-cache.org
http://lists.squid-cache.org/listinfo/squid-announce


From squid3 at treenet.co.nz  Fri Jul  7 09:31:42 2023
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Fri, 7 Jul 2023 21:31:42 +1200
Subject: [squid-users] [squid-announce] Squid 4 end of support
Message-ID: <ca8d2e09-5f35-5936-ebc3-fa616baaff90@treenet.co.nz>

Hi all,

With Squid v6.1 release the Squid Project will no longer
officially support Squid v4.

What does this mean?

Effective immediately;

  * no more official Squid v4 snapshots will be published.

  * security vulnerabilities only affecting Squid v4 (or older
    releases) will not get a formal Squid advisory issued.

In the following days/weeks;

  * Squid Official CI testing specific to Squid v4 will be
    disabled and removed.

  * Bug reports submitted against Squid v4 (or older releases)
    may be asked to confirm that the problem is still present
    in Squid v5 (or later releases).


Amos Jeffries
The Squid Software Foundation
_______________________________________________
squid-announce mailing list
squid-announce at lists.squid-cache.org
http://lists.squid-cache.org/listinfo/squid-announce


From robertkwild at gmail.com  Fri Jul  7 13:50:10 2023
From: robertkwild at gmail.com (robert k Wild)
Date: Fri, 7 Jul 2023 14:50:10 +0100
Subject: [squid-users] squid 6.1 new lines when i do squid -k reconfigure
Message-ID: <CAGU_Ci+pn969ce78nSa=LEgDk53vuaRstB3RoD2TKMK6m7OhwQ@mail.gmail.com>

hi all,

i think this is a new feature in squid as i never saw it in squid 4/5
basically when you do

/usr/local/squid/sbin/squid -k reconfigure

you get back a blank line but now you get information regarding the
reconfigure which is a nice touch but how do you get rid of it, ie only
show back errors

/usr/local/squid/sbin/squid -k reconfigure
2023/07/07 09:43:54| Processing Configuration File:
/usr/local/squid/etc/squid.conf (depth 0)
2023/07/07 09:43:54| Processing Configuration File:
/usr/local/squid/etc/squidrules.conf (depth 1)
2023/07/07 09:43:54| Set Current Directory to
/usr/local/squid/var/cache/squid

-- 
Regards,

Robert K Wild.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230707/4a3c52e6/attachment.htm>

From rousskov at measurement-factory.com  Fri Jul  7 14:40:35 2023
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Fri, 7 Jul 2023 10:40:35 -0400
Subject: [squid-users] squid 6.1 new lines when i do squid -k reconfigure
In-Reply-To: <CAGU_Ci+pn969ce78nSa=LEgDk53vuaRstB3RoD2TKMK6m7OhwQ@mail.gmail.com>
References: <CAGU_Ci+pn969ce78nSa=LEgDk53vuaRstB3RoD2TKMK6m7OhwQ@mail.gmail.com>
Message-ID: <224da973-bcae-7ca6-1c03-1ed2cc73686c@measurement-factory.com>

On 7/7/23 09:50, robert k Wild wrote:

> i think this is a new feature in squid as i never saw it in squid 4/5 

It is, essentially, a bug fix: Depending on the Squid version, these 
lines were previously either logged to unlocked cache.log or not logged 
at all.


> basically when you do
> 
> /usr/local/squid/sbin/squid -k reconfigure
> 
> you get back a blank line but now you get information regarding the 
> reconfigure which is a nice touch but how do you get rid of it, ie only 
> show back errors

Unfortunately, Squid developers lack consensus regarding which lines 
should be logged at debug levels 0 and 1. Fortunately, you can now 
control many of these messages using cache_log_message directive:

http://www.squid-cache.org/Doc/config/cache_log_message/

For example, the following configuration will raise the level of the 
reconfiguration messages sampled below to 2:

     cache_log_message id=4 level=2
     cache_log_message id=68 level=2


> 2023/07/07 09:43:54| Processing Configuration File: /usr/local/squid/etc/squid.conf (depth 0)
> 2023/07/07 09:43:54| Processing Configuration File: /usr/local/squid/etc/squidrules.conf (depth 1)

The above messages have ID 68.


> 2023/07/07 09:43:54| Set Current Directory to /usr/local/squid/var/cache/squid

The above message has ID 4.


See doc/debug-messages.dox for message IDs. If the message you want to 
control is not covered, see 
https://wiki.squid-cache.org/SquidFaq/AboutSquid#how-to-add-a-new-squid-feature-enhance-of-fix-something


Please note that messages printed before Squid configuration is parsed 
for the very first time are not controlled by that configuration. We 
plan to address that limitation by accepting "early" configuration 
options from the command line, but I cannot give you an ETA for that 
feature delivery because the corresponding project is currently dormant.


HTH,

Alex.



From robertkwild at gmail.com  Fri Jul  7 15:03:44 2023
From: robertkwild at gmail.com (robert k Wild)
Date: Fri, 7 Jul 2023 16:03:44 +0100
Subject: [squid-users] squid 6.1 new lines when i do squid -k reconfigure
In-Reply-To: <224da973-bcae-7ca6-1c03-1ed2cc73686c@measurement-factory.com>
References: <CAGU_Ci+pn969ce78nSa=LEgDk53vuaRstB3RoD2TKMK6m7OhwQ@mail.gmail.com>
 <224da973-bcae-7ca6-1c03-1ed2cc73686c@measurement-factory.com>
Message-ID: <CAGU_CiJkGTHsUCS2QADURMdmrkd2SgAt57cHE1Xn3C=Sk1ozrQ@mail.gmail.com>

Thanks Alex

On Fri, 7 Jul 2023, 15:40 Alex Rousskov, <rousskov at measurement-factory.com>
wrote:

> On 7/7/23 09:50, robert k Wild wrote:
>
> > i think this is a new feature in squid as i never saw it in squid 4/5
>
> It is, essentially, a bug fix: Depending on the Squid version, these
> lines were previously either logged to unlocked cache.log or not logged
> at all.
>
>
> > basically when you do
> >
> > /usr/local/squid/sbin/squid -k reconfigure
> >
> > you get back a blank line but now you get information regarding the
> > reconfigure which is a nice touch but how do you get rid of it, ie only
> > show back errors
>
> Unfortunately, Squid developers lack consensus regarding which lines
> should be logged at debug levels 0 and 1. Fortunately, you can now
> control many of these messages using cache_log_message directive:
>
> http://www.squid-cache.org/Doc/config/cache_log_message/
>
> For example, the following configuration will raise the level of the
> reconfiguration messages sampled below to 2:
>
>      cache_log_message id=4 level=2
>      cache_log_message id=68 level=2
>
>
> > 2023/07/07 09:43:54| Processing Configuration File:
> /usr/local/squid/etc/squid.conf (depth 0)
> > 2023/07/07 09:43:54| Processing Configuration File:
> /usr/local/squid/etc/squidrules.conf (depth 1)
>
> The above messages have ID 68.
>
>
> > 2023/07/07 09:43:54| Set Current Directory to
> /usr/local/squid/var/cache/squid
>
> The above message has ID 4.
>
>
> See doc/debug-messages.dox for message IDs. If the message you want to
> control is not covered, see
>
> https://wiki.squid-cache.org/SquidFaq/AboutSquid#how-to-add-a-new-squid-feature-enhance-of-fix-something
>
>
> Please note that messages printed before Squid configuration is parsed
> for the very first time are not controlled by that configuration. We
> plan to address that limitation by accepting "early" configuration
> options from the command line, but I cannot give you an ETA for that
> feature delivery because the corresponding project is currently dormant.
>
>
> HTH,
>
> Alex.
>
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230707/9e346b3d/attachment.htm>

From squid3 at treenet.co.nz  Fri Jul  7 16:02:36 2023
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Sat, 8 Jul 2023 04:02:36 +1200
Subject: [squid-users] Squid config Teams add-on in Outlook
In-Reply-To: <AS4PR01MB101292B88388A282257884BAAF32CA@AS4PR01MB10129.eurprd01.prod.exchangelabs.com>
References: <AS4PR01MB101292B88388A282257884BAAF32CA@AS4PR01MB10129.eurprd01.prod.exchangelabs.com>
Message-ID: <0af0dfdf-b792-a355-1629-6597c8a0bf32@treenet.co.nz>

On 7/07/23 00:32, Alessandro Baritello wrote:
> Hello, I need help with a Squid ver. 4.15 used with kerberos 
> authentication to windows, whitelists and cache_peers to McAfee Web 
> Gateway appliances.


Squid 6.1 was released a few days ago and 4.x have reached their 
official EOS. You may want to try a newer version now.
  There have been numerous changes to CONNECT tunnel handling since 4.15 
which may help with your issue. Better debugging and logging of tunnel 
activities at very least may be useful to you.

> 
> Everything works, except for a teams add-on integrated in Outlook, i.e. 
> when a teams meeting is created from Outlook it does not open Teams 
> correctly, and therefore the relative part with the Teams Meeting ID is 
> not seen in the email.
> 
> Consulting access.log you can see numerous TCP_DENIED/407 errors even if 
> previously there was TCP_TUNNEL/200 with the connect.

Status 407 means the TCP connection which is being used has not yet been 
authenticated, OR the credentials given for it are not permitted to 
perform the action requested.

You will need to check:
  * whether those status 200 were using the same TCP connection (likely 
not), and
  * whether credentials were provided on the TCP connection (in the 
current HTTP request headers, or any prior HTTP request on that 
connection), and
  * what type of authentication is happening. The MS schemes have some 
peculiar and annoying impacts on HTTP.


HTH
Amos


From robertkwild at gmail.com  Fri Jul  7 20:13:25 2023
From: robertkwild at gmail.com (robert k Wild)
Date: Fri, 7 Jul 2023 21:13:25 +0100
Subject: [squid-users] correct regular expression to use to capture all
Message-ID: <CAGU_Ci+Kn+XcXWHCYr6=UPnCu3QcztrKWTEsCWx2JQO8ho+PXA@mail.gmail.com>

hi all,

i know ive been talking about this before but i want to understand why i
cant use this regex

(^|.*)redshift3d.com$

instead i have to use this

(^|\.)redshift3d.com$ OR

(^|\.)redshift3d\.com$

for strings

www.redshift3d.com
activate.redshift3d.com
redshift3d.com

thanks,

rob

-- 
Regards,

Robert K Wild.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230707/c3476738/attachment.htm>

From stu.lists at spacehopper.org  Sat Jul  8 10:14:32 2023
From: stu.lists at spacehopper.org (Stuart Henderson)
Date: Sat, 8 Jul 2023 10:14:32 -0000 (UTC)
Subject: [squid-users] correct regular expression to use to capture all
References: <CAGU_Ci+Kn+XcXWHCYr6=UPnCu3QcztrKWTEsCWx2JQO8ho+PXA@mail.gmail.com>
Message-ID: <slrnuaido8.2j29.stu.lists@naiad.spacehopper.org>

On 2023-07-07, robert k Wild <robertkwild at gmail.com> wrote:
> --===============6398075081121841451==
> Content-Type: multipart/alternative; boundary="000000000000a03dcc05ffeb4428"
>
> --000000000000a03dcc05ffeb4428
> Content-Type: text/plain; charset="UTF-8"
>
> hi all,
>
> i know ive been talking about this before but i want to understand why i
> cant use this regex
>
> (^|.*)redshift3d.com$

this matches anythingredshift3d[any single character or nothing]com

> instead i have to use this
>
> (^|\.)redshift3d.com$ OR

this matches redshift3d[any single character or nothing]com
or anything.redshift3d[any single character or nothing]com

> (^|\.)redshift3d\.com$

this only matches redshift3d.com or anything.redshift3d.com

So, if you only want to match on things exactly in the redshift3d.com
domain and no others, you need the last one.




From uhlar at fantomas.sk  Sat Jul  8 11:57:35 2023
From: uhlar at fantomas.sk (Matus UHLAR - fantomas)
Date: Sat, 8 Jul 2023 13:57:35 +0200
Subject: [squid-users] correct regular expression to use to capture all
In-Reply-To: <CAGU_Ci+Kn+XcXWHCYr6=UPnCu3QcztrKWTEsCWx2JQO8ho+PXA@mail.gmail.com>
References: <CAGU_Ci+Kn+XcXWHCYr6=UPnCu3QcztrKWTEsCWx2JQO8ho+PXA@mail.gmail.com>
Message-ID: <ZKlPL/QY69t2vaNM@fantomas.sk>

On 07.07.23 21:13, robert k Wild wrote:
>i know ive been talking about this before but i want to understand why i
>cant use this regex
>
>(^|.*)redshift3d.com$
>
>instead i have to use this
>
>(^|\.)redshift3d.com$ OR
>
>(^|\.)redshift3d\.com$
>
>for strings
>
>www.redshift3d.com
>activate.redshift3d.com
>redshift3d.com

AFAIK "dstdomain .redshift3d.com"

matches the same, but without complicated, cpu-expensive and hardly readable 
regular expressions

-- 
Matus UHLAR - fantomas, uhlar at fantomas.sk ; http://www.fantomas.sk/
Warning: I wish NOT to receive e-mail advertising to this address.
Varovanie: na tuto adresu chcem NEDOSTAVAT akukolvek reklamnu postu.
Despite the cost of living, have you noticed how popular it remains?


From robertkwild at gmail.com  Sat Jul  8 12:07:09 2023
From: robertkwild at gmail.com (robert k Wild)
Date: Sat, 8 Jul 2023 13:07:09 +0100
Subject: [squid-users] correct regular expression to use to capture all
In-Reply-To: <ZKlPL/QY69t2vaNM@fantomas.sk>
References: <CAGU_Ci+Kn+XcXWHCYr6=UPnCu3QcztrKWTEsCWx2JQO8ho+PXA@mail.gmail.com>
 <ZKlPL/QY69t2vaNM@fantomas.sk>
Message-ID: <CAGU_CiK+-1THPDzeEs+Lz__ctJ=Xhwyxiju6p_9VQxqpsRX15g@mail.gmail.com>

True but I don't want to create two ACL lists, one for "ssl name" and one
for "ssl name regex"



On Sat, 8 Jul 2023, 12:57 Matus UHLAR - fantomas, <uhlar at fantomas.sk> wrote:

> On 07.07.23 21:13, robert k Wild wrote:
> >i know ive been talking about this before but i want to understand why i
> >cant use this regex
> >
> >(^|.*)redshift3d.com$
> >
> >instead i have to use this
> >
> >(^|\.)redshift3d.com$ OR
> >
> >(^|\.)redshift3d\.com$
> >
> >for strings
> >
> >www.redshift3d.com
> >activate.redshift3d.com
> >redshift3d.com
>
> AFAIK "dstdomain .redshift3d.com"
>
> matches the same, but without complicated, cpu-expensive and hardly
> readable
> regular expressions
>
> --
> Matus UHLAR - fantomas, uhlar at fantomas.sk ; http://www.fantomas.sk/
> Warning: I wish NOT to receive e-mail advertising to this address.
> Varovanie: na tuto adresu chcem NEDOSTAVAT akukolvek reklamnu postu.
> Despite the cost of living, have you noticed how popular it remains?
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230708/12b5d4bc/attachment.htm>

From rousskov at measurement-factory.com  Sat Jul  8 21:32:24 2023
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Sat, 8 Jul 2023 17:32:24 -0400
Subject: [squid-users] correct regular expression to use to capture all
In-Reply-To: <slrnuaido8.2j29.stu.lists@naiad.spacehopper.org>
References: <CAGU_Ci+Kn+XcXWHCYr6=UPnCu3QcztrKWTEsCWx2JQO8ho+PXA@mail.gmail.com>
 <slrnuaido8.2j29.stu.lists@naiad.spacehopper.org>
Message-ID: <d40c05c1-501d-d2a4-43bc-60ef5f431756@measurement-factory.com>

On 7/8/23 06:14, Stuart Henderson wrote:
> On 2023-07-07, robert k Wild <robertkwild at gmail.com> wrote:
>> --===============6398075081121841451==
>> Content-Type: multipart/alternative; boundary="000000000000a03dcc05ffeb4428"
>>
>> --000000000000a03dcc05ffeb4428
>> Content-Type: text/plain; charset="UTF-8"
>>
>> hi all,
>>
>> i know ive been talking about this before but i want to understand why i
>> cant use this regex
>>
>> (^|.*)redshift3d.com$
> 
> this matches anythingredshift3d[any single character or nothing]com

Correction: A regular expression "." does _not_ match "nothing" (i.e. 
zero characters).

In some contexts, "." may not even match some special single characters, 
but those contexts are probably not applicable to this thread scope.


>> instead i have to use this
>>
>> (^|\.)redshift3d.com$ OR
> 
> this matches redshift3d[any single character or nothing]com
> or anything.redshift3d[any single character or nothing]com

... or .redshift3d.com

Same "nothing" correction here.


>> (^|\.)redshift3d\.com$
> 
> this only matches redshift3d.com or anything.redshift3d.com

... or .redshift3d.com


Alex.


> So, if you only want to match on things exactly in the redshift3d.com
> domain and no others, you need the last one.





From robertkwild at gmail.com  Sat Jul  8 21:49:23 2023
From: robertkwild at gmail.com (robert k Wild)
Date: Sat, 8 Jul 2023 22:49:23 +0100
Subject: [squid-users] correct regular expression to use to capture all
In-Reply-To: <d40c05c1-501d-d2a4-43bc-60ef5f431756@measurement-factory.com>
References: <CAGU_Ci+Kn+XcXWHCYr6=UPnCu3QcztrKWTEsCWx2JQO8ho+PXA@mail.gmail.com>
 <slrnuaido8.2j29.stu.lists@naiad.spacehopper.org>
 <d40c05c1-501d-d2a4-43bc-60ef5f431756@measurement-factory.com>
Message-ID: <CAGU_CiKq8Y=LNXxXO8-FXdg50jUutJR_afW5BpoXxmB7sq6+mA@mail.gmail.com>

So will this

(^|\.)redshift3d\.com$

I know it will match

Blah.redshift3d.com and
redshift3d.com

But what about

Blah.Blah.redshift3d.com

On Sat, 8 Jul 2023, 22:32 Alex Rousskov, <rousskov at measurement-factory.com>
wrote:

> On 7/8/23 06:14, Stuart Henderson wrote:
> > On 2023-07-07, robert k Wild <robertkwild at gmail.com> wrote:
> >> --===============6398075081121841451==
> >> Content-Type: multipart/alternative;
> boundary="000000000000a03dcc05ffeb4428"
> >>
> >> --000000000000a03dcc05ffeb4428
> >> Content-Type: text/plain; charset="UTF-8"
> >>
> >> hi all,
> >>
> >> i know ive been talking about this before but i want to understand why i
> >> cant use this regex
> >>
> >> (^|.*)redshift3d.com$
> >
> > this matches anythingredshift3d[any single character or nothing]com
>
> Correction: A regular expression "." does _not_ match "nothing" (i.e.
> zero characters).
>
> In some contexts, "." may not even match some special single characters,
> but those contexts are probably not applicable to this thread scope.
>
>
> >> instead i have to use this
> >>
> >> (^|\.)redshift3d.com$ OR
> >
> > this matches redshift3d[any single character or nothing]com
> > or anything.redshift3d[any single character or nothing]com
>
> ... or .redshift3d.com
>
> Same "nothing" correction here.
>
>
> >> (^|\.)redshift3d\.com$
> >
> > this only matches redshift3d.com or anything.redshift3d.com
>
> ... or .redshift3d.com
>
>
> Alex.
>
>
> > So, if you only want to match on things exactly in the redshift3d.com
> > domain and no others, you need the last one.
>
>
>
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230708/6537757f/attachment.htm>

From rousskov at measurement-factory.com  Sun Jul  9 01:07:22 2023
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Sat, 8 Jul 2023 21:07:22 -0400
Subject: [squid-users] correct regular expression to use to capture all
In-Reply-To: <CAGU_CiKq8Y=LNXxXO8-FXdg50jUutJR_afW5BpoXxmB7sq6+mA@mail.gmail.com>
References: <CAGU_Ci+Kn+XcXWHCYr6=UPnCu3QcztrKWTEsCWx2JQO8ho+PXA@mail.gmail.com>
 <slrnuaido8.2j29.stu.lists@naiad.spacehopper.org>
 <d40c05c1-501d-d2a4-43bc-60ef5f431756@measurement-factory.com>
 <CAGU_CiKq8Y=LNXxXO8-FXdg50jUutJR_afW5BpoXxmB7sq6+mA@mail.gmail.com>
Message-ID: <f316b854-e780-9143-2b2a-511cc757ad59@measurement-factory.com>

On 7/8/23 17:49, robert k Wild wrote:
> So will this
> 
> (^|\.)redshift3d\.com$
> 
> I know it will match
> 
> Blah.redshift3d.com and redshift3d.com
> 
> But what about
> 
> Blah.Blah.redshift3d.com

It will also match, for the same set of reasons.

FWIW, I am worried that you keep asking about specific basic matching 
examples. If necessary, you can test such matches online[1] or using 
something like "grep -E" (not to mention Squid itself). The answers here 
will vary in quality and will usually not cover what you really want to 
know -- what input the regular expression will (not) match besides your 
specific examples. Have you tried reading regular expression tutorials 
and using tools[1] that explain the meaning of specific regular 
expressions? There ought to be a better way to learn how regular 
expressions work!

[1] For example: regexr.com/7gms6


Cheers,

Alex.


> On Sat, 8 Jul 2023, 22:32 Alex Rousskov wrote:
> 
>     On 7/8/23 06:14, Stuart Henderson wrote:
>      > On 2023-07-07, robert k Wild <robertkwild at gmail.com
>     <mailto:robertkwild at gmail.com>> wrote:
>      >> --===============6398075081121841451==
>      >> Content-Type: multipart/alternative;
>     boundary="000000000000a03dcc05ffeb4428"
>      >>
>      >> --000000000000a03dcc05ffeb4428
>      >> Content-Type: text/plain; charset="UTF-8"
>      >>
>      >> hi all,
>      >>
>      >> i know ive been talking about this before but i want to
>     understand why i
>      >> cant use this regex
>      >>
>      >> (^|.*)redshift3d.com <http://redshift3d.com>$
>      >
>      > this matches anythingredshift3d[any single character or nothing]com
> 
>     Correction: A regular expression "." does _not_ match "nothing" (i.e.
>     zero characters).
> 
>     In some contexts, "." may not even match some special single
>     characters,
>     but those contexts are probably not applicable to this thread scope.
> 
> 
>      >> instead i have to use this
>      >>
>      >> (^|\.)redshift3d.com <http://redshift3d.com>$ OR
>      >
>      > this matches redshift3d[any single character or nothing]com
>      > or anything.redshift3d[any single character or nothing]com
> 
>     ... or .redshift3d.com <http://redshift3d.com>
> 
>     Same "nothing" correction here.
> 
> 
>      >> (^|\.)redshift3d\.com$
>      >
>      > this only matches redshift3d.com <http://redshift3d.com> or
>     anything.redshift3d.com <http://anything.redshift3d.com>
> 
>     ... or .redshift3d.com <http://redshift3d.com>
> 
> 
>     Alex.
> 
> 
>      > So, if you only want to match on things exactly in the
>     redshift3d.com <http://redshift3d.com>
>      > domain and no others, you need the last one.
> 
> 
> 
>     _______________________________________________
>     squid-users mailing list
>     squid-users at lists.squid-cache.org
>     <mailto:squid-users at lists.squid-cache.org>
>     http://lists.squid-cache.org/listinfo/squid-users
>     <http://lists.squid-cache.org/listinfo/squid-users>
> 



From Walter.H at mathemainzel.info  Sun Jul  9 09:33:51 2023
From: Walter.H at mathemainzel.info (Walter H.)
Date: Sun, 9 Jul 2023 11:33:51 +0200
Subject: [squid-users] correct regular expression to use to capture all
In-Reply-To: <CAGU_CiK+-1THPDzeEs+Lz__ctJ=Xhwyxiju6p_9VQxqpsRX15g@mail.gmail.com>
References: <CAGU_Ci+Kn+XcXWHCYr6=UPnCu3QcztrKWTEsCWx2JQO8ho+PXA@mail.gmail.com>
 <ZKlPL/QY69t2vaNM@fantomas.sk>
 <CAGU_CiK+-1THPDzeEs+Lz__ctJ=Xhwyxiju6p_9VQxqpsRX15g@mail.gmail.com>
Message-ID: <7b4115d1-2a22-1853-ec0f-89ca9fea02b6@mathemainzel.info>

On 08.07.2023 14:07, robert k Wild wrote:
> True but I don't want to create two ACL lists, one for "ssl name" and 
> one for "ssl name regex"
>
If I were you, I would create two ACL lists, because the one without 
regex as already mentioned needs

less resources - CPU, memory - and can have more rules; the regex thing 
has a limit in number of rules;


-------------- next part --------------
A non-text attachment was scrubbed...
Name: smime.p7s
Type: application/pkcs7-signature
Size: 3550 bytes
Desc: S/MIME Cryptographic Signature
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230709/b8fe5e0e/attachment.bin>

From uhlar at fantomas.sk  Sun Jul  9 15:04:19 2023
From: uhlar at fantomas.sk (Matus UHLAR - fantomas)
Date: Sun, 9 Jul 2023 17:04:19 +0200
Subject: [squid-users] correct regular expression to use to capture all
In-Reply-To: <CAGU_CiK+-1THPDzeEs+Lz__ctJ=Xhwyxiju6p_9VQxqpsRX15g@mail.gmail.com>
References: <CAGU_Ci+Kn+XcXWHCYr6=UPnCu3QcztrKWTEsCWx2JQO8ho+PXA@mail.gmail.com>
 <ZKlPL/QY69t2vaNM@fantomas.sk>
 <CAGU_CiK+-1THPDzeEs+Lz__ctJ=Xhwyxiju6p_9VQxqpsRX15g@mail.gmail.com>
Message-ID: <ZKrMcxy13hz2i+IV@fantomas.sk>

On 08.07.23 13:07, robert k Wild wrote:
>True but I don't want to create two ACL lists, one for "ssl name" and one
>for "ssl name regex"

try only create one for ssl name. You rarely need regex.
performance will thank youl

>On Sat, 8 Jul 2023, 12:57 Matus UHLAR - fantomas, <uhlar at fantomas.sk> wrote:
>
>> On 07.07.23 21:13, robert k Wild wrote:
>> >i know ive been talking about this before but i want to understand why i
>> >cant use this regex
>> >
>> >(^|.*)redshift3d.com$
>> >
>> >instead i have to use this
>> >
>> >(^|\.)redshift3d.com$ OR
>> >
>> >(^|\.)redshift3d\.com$
>> >
>> >for strings
>> >
>> >www.redshift3d.com
>> >activate.redshift3d.com
>> >redshift3d.com
>>
>> AFAIK "dstdomain .redshift3d.com"
>>
>> matches the same, but without complicated, cpu-expensive and hardly
>> readable
>> regular expressions

-- 
Matus UHLAR - fantomas, uhlar at fantomas.sk ; http://www.fantomas.sk/
Warning: I wish NOT to receive e-mail advertising to this address.
Varovanie: na tuto adresu chcem NEDOSTAVAT akukolvek reklamnu postu.
Depression is merely anger without enthusiasm.


From robertkwild at gmail.com  Sun Jul  9 15:08:46 2023
From: robertkwild at gmail.com (robert k Wild)
Date: Sun, 9 Jul 2023 16:08:46 +0100
Subject: [squid-users] correct regular expression to use to capture all
In-Reply-To: <ZKrMcxy13hz2i+IV@fantomas.sk>
References: <CAGU_Ci+Kn+XcXWHCYr6=UPnCu3QcztrKWTEsCWx2JQO8ho+PXA@mail.gmail.com>
 <ZKlPL/QY69t2vaNM@fantomas.sk>
 <CAGU_CiK+-1THPDzeEs+Lz__ctJ=Xhwyxiju6p_9VQxqpsRX15g@mail.gmail.com>
 <ZKrMcxy13hz2i+IV@fantomas.sk>
Message-ID: <CAGU_CiJUxPuq0Fd6XCNCKjshhy3c0qCLpDMhC8gzBGQ6Yk5x9w@mail.gmail.com>

Thank you guys,

Tbh I didn't think regex would be more CPU intense so thanks for that

On Sun, 9 Jul 2023, 16:04 Matus UHLAR - fantomas, <uhlar at fantomas.sk> wrote:

> On 08.07.23 13:07, robert k Wild wrote:
> >True but I don't want to create two ACL lists, one for "ssl name" and one
> >for "ssl name regex"
>
> try only create one for ssl name. You rarely need regex.
> performance will thank youl
>
> >On Sat, 8 Jul 2023, 12:57 Matus UHLAR - fantomas, <uhlar at fantomas.sk>
> wrote:
> >
> >> On 07.07.23 21:13, robert k Wild wrote:
> >> >i know ive been talking about this before but i want to understand why
> i
> >> >cant use this regex
> >> >
> >> >(^|.*)redshift3d.com$
> >> >
> >> >instead i have to use this
> >> >
> >> >(^|\.)redshift3d.com$ OR
> >> >
> >> >(^|\.)redshift3d\.com$
> >> >
> >> >for strings
> >> >
> >> >www.redshift3d.com
> >> >activate.redshift3d.com
> >> >redshift3d.com
> >>
> >> AFAIK "dstdomain .redshift3d.com"
> >>
> >> matches the same, but without complicated, cpu-expensive and hardly
> >> readable
> >> regular expressions
>
> --
> Matus UHLAR - fantomas, uhlar at fantomas.sk ; http://www.fantomas.sk/
> Warning: I wish NOT to receive e-mail advertising to this address.
> Varovanie: na tuto adresu chcem NEDOSTAVAT akukolvek reklamnu postu.
> Depression is merely anger without enthusiasm.
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230709/d20d5599/attachment.htm>

From ngtech1ltd at gmail.com  Sun Jul  9 17:47:55 2023
From: ngtech1ltd at gmail.com (ngtech1ltd at gmail.com)
Date: Sun, 9 Jul 2023 20:47:55 +0300
Subject: [squid-users] correct regular expression to use to capture all
In-Reply-To: <CAGU_CiJUxPuq0Fd6XCNCKjshhy3c0qCLpDMhC8gzBGQ6Yk5x9w@mail.gmail.com>
References: <CAGU_Ci+Kn+XcXWHCYr6=UPnCu3QcztrKWTEsCWx2JQO8ho+PXA@mail.gmail.com>
 <ZKlPL/QY69t2vaNM@fantomas.sk>
 <CAGU_CiK+-1THPDzeEs+Lz__ctJ=Xhwyxiju6p_9VQxqpsRX15g@mail.gmail.com>
 <ZKrMcxy13hz2i+IV@fantomas.sk>
 <CAGU_CiJUxPuq0Fd6XCNCKjshhy3c0qCLpDMhC8gzBGQ6Yk5x9w@mail.gmail.com>
Message-ID: <002f01d9b28d$7e5a24b0$7b0e6e10$@gmail.com>

Hey Rob,

It uses more CPU then dstdomain and the equivalent of ssl::server_name  but... You should only care about the cpu
usage in case you have lots of regex in your config files.

Usually a few of them are worth when it gets the job done.
I have some config in my archives that used a lot of regex and if I have used other methods
to implement the same config the config would look ugly and long.

Eliezer

From: squid-users <squid-users-bounces at lists.squid-cache.org> On Behalf Of robert k Wild
Sent: Sunday, July 9, 2023 18:09
To: Squid Users <squid-users at lists.squid-cache.org>
Subject: Re: [squid-users] correct regular expression to use to capture all

Thank you guys,

Tbh I didn't think regex would be more CPU intense so thanks for that

On Sun, 9 Jul 2023, 16:04 Matus UHLAR - fantomas, <mailto:uhlar at fantomas.sk> wrote:
On 08.07.23 13:07, robert k Wild wrote:
>True but I don't want to create two ACL lists, one for "ssl name" and one
>for "ssl name regex"

try only create one for ssl name. You rarely need regex.
performance will thank youl

>On Sat, 8 Jul 2023, 12:57 Matus UHLAR - fantomas, <mailto:uhlar at fantomas.sk> wrote:
>
>> On 07.07.23 21:13, robert k Wild wrote:
>> >i know ive been talking about this before but i want to understand why i
>> >cant use this regex
>> >
>> >(^|.*)http://redshift3d.com$
>> >
>> >instead i have to use this
>> >
>> >(^|\.)http://redshift3d.com$ OR
>> >
>> >(^|\.)redshift3d\.com$
>> >
>> >for strings
>> >
>> >http://www.redshift3d.com
>> >http://activate.redshift3d.com
>> >http://redshift3d.com
>>
>> AFAIK "dstdomain .http://redshift3d.com"
>>
>> matches the same, but without complicated, cpu-expensive and hardly
>> readable
>> regular expressions

-- 
Matus UHLAR - fantomas, mailto:uhlar at fantomas.sk ; http://www.fantomas.sk/
Warning: I wish NOT to receive e-mail advertising to this address.
Varovanie: na tuto adresu chcem NEDOSTAVAT akukolvek reklamnu postu.
Depression is merely anger without enthusiasm.
_______________________________________________
squid-users mailing list
mailto:squid-users at lists.squid-cache.org
http://lists.squid-cache.org/listinfo/squid-users



From franta at hanzlici.cz  Mon Jul 10 18:50:32 2023
From: franta at hanzlici.cz (Franta =?UTF-8?B?SGFuemzDrWs=?=)
Date: Mon, 10 Jul 2023 20:50:32 +0200
Subject: [squid-users] 4.0.23 -> 5.9 : ERROR: Failed to acquire TLS
 certificate '/etc/pki/tls/private/xy.pem': error:0480006C:PEM routines::no
 start line
Message-ID: <20230710205032.6aa3e4ef@franta.hanzlici.cz>

After upgrading my Fedora 27/Squid-4.0.23 to Fedora 38/Squid-5.9, the
Squid refuses to start with the error message:

Jul 10 09:55:42 jona squid[56320]: 2023/07/10 09:55:42| ERROR: Failed to acquire TLS certificate '/etc/pki/tls/private/server.pem': error:0480006C:PEM routines::no start line
Jul 10 09:55:42 jona squid[56320]: 2023/07/10 09:55:42| FATAL: HTTPS_port 192.168.20.2:22225 initialization error
Jul 10 09:55:42 jona squid[56320]: 2023/07/10 09:55:42| Squid Cache (Version 5.9): Terminated abnormally.

The problem is probably related to the reverse https proxy definition
line in squid.conf :
https_port 192.168.20.2:22225 accel cert=/etc/pki/tls/private/server.pem defaultsite=mail.kyenar.cz no-vhost name=reverzpe

server.pem is the symlink to realFile.pem with this content:
-----BEGIN RSA PRIVATE KEY-----
MIIEpQ...
...
...vo=
-----END RSA PRIVATE KEY-----

-----BEGIN CERTIFICATE-----
MIIGO...
...
...c5s=
-----END CERTIFICATE-----

and it worked fine in the older Squid-4.0.23 version.

I tried:
- tls-cert= instead of cert=
- replacing the symlink server.pem with a real file.
- arrange certificate in PEM file as first and key second
- split PEM file into separate certificate and key and use it with syntax:

https_port 192.168.20.2:22225 accel tls-cert=/etc/pki/tls/private/cert.pem tls-key=/etc/pki/tls/private/key.pem defaultsite=mail.kyenar.cz no-vhost name=reverzpe

but squid still not start with this same message:
ERROR: Failed to acquire TLS certificate '/etc/pki/tls/private/cert.pem': error:0480006C:PEM routines::no start line

Can anyone help?
---
Thanks in advance! Franta Hanzlik


From robertkwild at gmail.com  Mon Jul 10 19:30:15 2023
From: robertkwild at gmail.com (robert k Wild)
Date: Mon, 10 Jul 2023 20:30:15 +0100
Subject: [squid-users] Making squid into socks proxy
Message-ID: <CAGU_CiLXT3meZZ+_Y9vj9a6wBJ4bSSTqbXDhHP2Eq__aF5w=QQ@mail.gmail.com>

Hi all,

Sorry for the dumb question but what is the point of making squid into a
socks5 proxy and if I have already built squid how do I add it to squid

https://serverfault.com/questions/820578/how-to-enable-socks5-for-squid-proxy#820612

Thanks,
Rob
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230710/62c01b2b/attachment.htm>

From gkinkie at gmail.com  Mon Jul 10 19:36:05 2023
From: gkinkie at gmail.com (Francesco Chemolli)
Date: Mon, 10 Jul 2023 21:36:05 +0200
Subject: [squid-users] Making squid into socks proxy
In-Reply-To: <CAGU_CiLXT3meZZ+_Y9vj9a6wBJ4bSSTqbXDhHP2Eq__aF5w=QQ@mail.gmail.com>
References: <CAGU_CiLXT3meZZ+_Y9vj9a6wBJ4bSSTqbXDhHP2Eq__aF5w=QQ@mail.gmail.com>
Message-ID: <CA+Y8hcPgzy87hF8WtNGvF170iojtOKyMYuQm741Cgb0Kg6NXQA@mail.gmail.com>

Hi Robert,
  in my understanding that configuration turns Squid into a Socks client.
Outbound squid connections will then be proxied through a socks proxy.
There might be a point, in some use cases, but I agree it's a stretch.
For instance it could help if there's a need to log URLs being accessed,
which socks by itself can' tdo; it might also work as a TLS interception
proxy which then needs to access some tightly-controlled network segment.

On Mon, Jul 10, 2023 at 9:30?PM robert k Wild <robertkwild at gmail.com> wrote:

> Hi all,
>
> Sorry for the dumb question but what is the point of making squid into a
> socks5 proxy and if I have already built squid how do I add it to squid
>
>
> https://serverfault.com/questions/820578/how-to-enable-socks5-for-squid-proxy#820612
>
> Thanks,
> Rob
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users
>


-- 
    Francesco
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230710/e20f1e63/attachment.htm>

From gtaylor at tnetconsulting.net  Mon Jul 10 23:52:35 2023
From: gtaylor at tnetconsulting.net (Grant Taylor)
Date: Mon, 10 Jul 2023 18:52:35 -0500
Subject: [squid-users] Making squid into socks proxy
In-Reply-To: <CA+Y8hcPgzy87hF8WtNGvF170iojtOKyMYuQm741Cgb0Kg6NXQA@mail.gmail.com>
References: <CAGU_CiLXT3meZZ+_Y9vj9a6wBJ4bSSTqbXDhHP2Eq__aF5w=QQ@mail.gmail.com>
 <CA+Y8hcPgzy87hF8WtNGvF170iojtOKyMYuQm741Cgb0Kg6NXQA@mail.gmail.com>
Message-ID: <e9bad6c4-141a-e5ae-4fe2-c74f262308e6@tnetconsulting.net>

On 7/10/23 2:36?PM, Francesco Chemolli wrote:
> Hi Robert,

Hi Francesco,

> in my understanding that configuration?turns Squid into a Socks 
> client. Outbound squid connections will then be proxied through a socks 
> proxy.

According to "this  page" [1] linked from the "How to enable SOCKS5 for 
Squid Proxy?" page [2] that Rob linked to, this seems like it is both 
client /and/ server support.

--8<--
Details:

Squid handles many HTTP related protocols. But presently is unable to 
natively accept or send HTTP connections over SOCKS.

The aim of this project will be to make http_port accept SOCKS 
connections and make outgoing connections to SOCKS cache_peers so that 
Squid can send requests easily through to SOCKS gateways or act as an 
HTTP SOCKS gateway itself.
-->8--

Particularly germane are "accept ... HTTP connections over SOCKS", "make 
http_port accept SOCKS connections", and "act as an HTTP SOCKS gateway 
itself".

> There?might be a point, in some use cases, but I agree it's a stretch.
> For instance it could help if there's a need to log URLs being accessed, 
> which socks by itself can' tdo; it might also work as a TLS interception 
> proxy which then needs to access some tightly-controlled network segment.

I can see a modicum of value in making Squid be a SOCKS client -- via 
something more graceful than an LD_PRELOAD.  I suspect that I'd turn to 
a different SOCKS daemon before I'd turn to Squid as such.  Dante comes 
to mind.

I can see a LOT of value in SOCKS proxy support.  Especially 
authenticated access to the SOCKS proxy.  Even more so if you 
communicate with the proxy over encrypted channels

In some ways a SOCKS proxy acts sort of like a remote TCP/IP client / 
stack.  Combine this functionality with authentication and I can easily 
allow controlled remote access into a segregated network and know which 
authenticated user did what.  Much like a VPN, but at the application level.

At a former job we used a lot of SOCKS servers.  We would have a pair 
(for redundancy) of SOCKS servers co-located at client networks and 
required authentication of our employees to be able to utilize said 
SOCKS servers.  This configuration made it relatively trivial to our 
employees change which SOCKS server they were using to switch between 
the client they were doing administration work for.

One of the biggest advantages that I saw with SOCKS was the VPN like 
connectivity, which required authentication, and the ability to filter 
each packet / connection completely independently of the underlying 
transport between the employee and the SOCKS server(s).

What's more is that the SOCKS servers appeared as if they were on the 
client's network.  Thus the, and the remote employees using them, could 
access things on the client's network without any routing changes to the 
client's network.

Think of it sort of like a remote extension of a network in a manner 
that's completely divorced from the underlying network topology / 
transport between clients and the SOCKS server.

This complete separation also means that things that aren't expressly 
configured to use the SOCKS server can't accidentally be routed through 
the SOCKS server.  So when there is a security incident on the network, 
it will be much better isolated to one side of the SOCKS server than if 
it were a more traditional routed VPN type connection.

I can definitely see value in enabling Squid to be a SOCKS client to be 
able to utilize / benefit from the perks that SOCKS servers can offer.

I see less value in having Squid be a SOCKS server.

That being said, I wonder how closely related SOCKS server functionality 
and WebSocket support provide.  Perhaps SOCKS can be another side door 
into code needed to support WebSocket.

[1] Feature: SOCKS Support - http://wiki.squid-cache.org/Features/Socks

[2] How to enable SOCKS5 for Squid proxy? - 
https://serverfault.com/questions/820578/how-to-enable-socks5-for-squid-proxy#820612



Grant. . . .


From kevin at rentec.com  Tue Jul 11 15:00:01 2023
From: kevin at rentec.com (Kevin Kretz)
Date: Tue, 11 Jul 2023 11:00:01 -0400 (EDT)
Subject: [squid-users] instances/queues when same script for multiple
 external_acl_type rules
Message-ID: <1321463103.1239804.1689087601439.JavaMail.zimbra@rentec.com>

Hi,

I have a script that queries a database when a request is made to squid.  It handles two different types of request:  those made from authenticated users, and unauthenticated requests which can be allowed based on the requesting host. 

Requests of each type are defined with a different external_acl_type definition in squid.conf and different arguments are sent to the script depending which type it is.

Recently we hit the limits of the default children_max and its associated queue length.  It was addressed by increasing children_max - but it made me wonder:  if I have two external_acl_type rules calling the same external script, does squid maintain separate counts for the script instances associated for each external_acl_type definition?  Does

external_acl_type children-max 10 host_based blah blah blah script.py
external_acl_type children-max 10 user_based blah blah blah script.py

... have a max of 10 instances for each acl_type?  Or 10 instances total?


thanks

Kevin


From rousskov at measurement-factory.com  Tue Jul 11 15:20:26 2023
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Tue, 11 Jul 2023 11:20:26 -0400
Subject: [squid-users] instances/queues when same script for multiple
 external_acl_type rules
In-Reply-To: <1321463103.1239804.1689087601439.JavaMail.zimbra@rentec.com>
References: <1321463103.1239804.1689087601439.JavaMail.zimbra@rentec.com>
Message-ID: <809c1d2f-bfe6-9aa0-2e89-4ea6ef6af063@measurement-factory.com>

On 7/11/23 11:00, Kevin Kretz wrote:

> I have a script that queries a database when a request is made to
> squid.  It handles two different types of request:  those made from
> authenticated users, and unauthenticated requests which can be
> allowed based on the requesting host.

> Requests of each type are defined with a different external_acl_type
> definition in squid.conf and different arguments are sent to the
> script depending which type it is.

> Recently we hit the limits of the default children_max and its
> associated queue length.  It was addressed by increasing children_max
> - but it made me wonder:  if I have two external_acl_type rules
> calling the same external script, does squid maintain separate counts
> for the script instances associated for each external_acl_type
> definition?  Does


> external_acl_type children-max 10 host_based blah blah blah script.py
> external_acl_type children-max 10 user_based blah blah blah script.py

> ... have a max of 10 instances for each acl_type?  Or 10 instances total?

The above external_acl_type configuration lines appear to contain 
out-of-order tokens and other syntax violations, but children-max limit 
(and all other external_acl_type parameters) are dedicated to the 
corresponding external_acl_type. Squid may start 10 helper instances for 
each external_acl_type (with a unique external_acl_type name), even if 
all of them have the same script name.

BTW, AFAICT by glancing through Squid source code and without testing, 
Squid does not reject configurations with multiple external_acl_type 
lines that use the same external_acl_type name parameter value (a Squid 
bug). Squid will effectively ignore all but the very first such line.


HTH,

Alex.



From rousskov at measurement-factory.com  Tue Jul 11 17:34:47 2023
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Tue, 11 Jul 2023 13:34:47 -0400
Subject: [squid-users] 4.0.23 -> 5.9 : ERROR: Failed to acquire TLS
 certificate '/etc/pki/tls/private/xy.pem': error:0480006C:PEM routines::no
 start line
In-Reply-To: <20230710205032.6aa3e4ef@franta.hanzlici.cz>
References: <20230710205032.6aa3e4ef@franta.hanzlici.cz>
Message-ID: <787e0ab2-48d4-99a6-16e2-031ddcf7eefc@measurement-factory.com>

On 7/10/23 14:50, Franta Hanzl?k wrote:
> After upgrading my Fedora 27/Squid-4.0.23 to Fedora 38/Squid-5.9, the
> Squid refuses to start with the error message:
> 
> ERROR: Failed to acquire TLS certificate '/etc/pki/tls/private/server.pem': error:0480006C:PEM routines::no start line

I suspect the actual problem is different than "no start line". Due to a 
mismatch between OpenSSL error handling approach and Squid code, Squid 
often reports wrong/stale/irrelevant OpenSSL errors. Certificate loading 
code is especially prone to such mismatches! Refactoring OpenSSL error 
handling is an known to-do item.

Several different things could go wrong while showing the above 
symptoms, and there are several ways to troubleshoot this, but I would 
start with the following simple test.

Run the following (or similar) command on the same machine as Squid, 
using the same OS user as Squid ("nobody" in the example below), using 
the openssl tool from the same OpenSSL version as Squid was built with:

     sudo -u nobody \
     openssl x509 -in /etc/pki/tls/private/server.pem -noout -subject

You should see the certificate subject field. Any warnings or errors?

If the above works fine, and the certificate file ownership/permissions 
look reasonable to you, then the next step could be to start Squid under 
"strace" or a similar tool to check whether some system call fails when 
OpenSSL is trying to load that certificate file. In most cases, you 
should be able to find the certificate filename in strace output and 
check for subsequent syscall errors (e.g., permission denied). We can 
help with that analysis, but be careful with posting private key 
contents. If you can, temporary replace that production certificate with 
some throw-away/temporary/example one.

Beyond that, I would recommend patching Squid to report the last OpenSSL 
error instead of the first one (in this context). This will require you 
to rebuild your Squid from sources. Please let me know if you want to 
pursue that and I will provide a patch.


HTH,

Alex.

> The problem is probably related to the reverse https proxy definition
> line in squid.conf :
> https_port 192.168.20.2:22225 accel cert=/etc/pki/tls/private/server.pem defaultsite=mail.kyenar.cz no-vhost name=reverzpe

> server.pem is the symlink to realFile.pem with this content:
> -----BEGIN RSA PRIVATE KEY-----
> MIIEpQ...
> ...
> ...vo=
> -----END RSA PRIVATE KEY-----
> 
> -----BEGIN CERTIFICATE-----
> MIIGO...
> ...
> ...c5s=
> -----END CERTIFICATE-----
> 
> and it worked fine in the older Squid-4.0.23 version.
> 
> I tried:
> - tls-cert= instead of cert=
> - replacing the symlink server.pem with a real file.
> - arrange certificate in PEM file as first and key second
> - split PEM file into separate certificate and key and use it with syntax:
> 
> https_port 192.168.20.2:22225 accel tls-cert=/etc/pki/tls/private/cert.pem tls-key=/etc/pki/tls/private/key.pem defaultsite=mail.kyenar.cz no-vhost name=reverzpe
> 
> but squid still not start with this same message:
> ERROR: Failed to acquire TLS certificate '/etc/pki/tls/private/cert.pem': error:0480006C:PEM routines::no start line
> 
> Can anyone help?
> ---
> Thanks in advance! Franta Hanzlik
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users



From hfasching at barracuda.com  Wed Jul 12 07:09:35 2023
From: hfasching at barracuda.com (Hannes Fasching)
Date: Wed, 12 Jul 2023 07:09:35 +0000
Subject: [squid-users] [EXTERNAL] Re: 4.0.23 -> 5.9 : ERROR: Failed to
 acquire TLS certificate '/etc/pki/tls/private/xy.pem': error:0480006C:PEM
 routines::no start line
In-Reply-To: <787e0ab2-48d4-99a6-16e2-031ddcf7eefc@measurement-factory.com>
References: <20230710205032.6aa3e4ef@franta.hanzlici.cz>
 <787e0ab2-48d4-99a6-16e2-031ddcf7eefc@measurement-factory.com>
Message-ID: <DM6PR10MB374048551AB3C0DE1501AB80B336A@DM6PR10MB3740.namprd10.prod.outlook.com>

Hi!
we had the same problem when we switched from openssl 1.1 to openssl 3 with certificates using the SHA1 algorithm for signature. The reason for this was in openssl 3 SHA1 is deprecated.

Kind regards,
?Hannes


Von: squid-users <squid-users-bounces at lists.squid-cache.org>
Gesendet: Dienstag, 11. Juli 2023 19:34
An: squid-users at lists.squid-cache.org <squid-users at lists.squid-cache.org>
Betreff: [EXTERNAL] Re: [squid-users] 4.0.23 -> 5.9 : ERROR: Failed to acquire TLS certificate '/etc/pki/tls/private/xy.pem': error:0480006C:PEM routines::no start line

On 7/10/23 14:50, Franta Hanzl?k wrote:
> After upgrading my Fedora 27/Squid-4.0.23 to Fedora 38/Squid-5.9, the
> Squid refuses to start with the error message:
>
> ERROR: Failed to acquire TLS certificate '/etc/pki/tls/private/server.pem': error:0480006C:PEM routines::no start line

I suspect the actual problem is different than "no start line". Due to a
mismatch between OpenSSL error handling approach and Squid code, Squid
often reports wrong/stale/irrelevant OpenSSL errors. Certificate loading
code is especially prone to such mismatches! Refactoring OpenSSL error
handling is an known to-do item.

Several different things could go wrong while showing the above
symptoms, and there are several ways to troubleshoot this, but I would
start with the following simple test.

Run the following (or similar) command on the same machine as Squid,
using the same OS user as Squid ("nobody" in the example below), using
the openssl tool from the same OpenSSL version as Squid was built with:

     sudo -u nobody \
     openssl x509 -in /etc/pki/tls/private/server.pem -noout -subject

You should see the certificate subject field. Any warnings or errors?

If the above works fine, and the certificate file ownership/permissions
look reasonable to you, then the next step could be to start Squid under
"strace" or a similar tool to check whether some system call fails when
OpenSSL is trying to load that certificate file. In most cases, you
should be able to find the certificate filename in strace output and
check for subsequent syscall errors (e.g., permission denied). We can
help with that analysis, but be careful with posting private key
contents. If you can, temporary replace that production certificate with
some throw-away/temporary/example one.

Beyond that, I would recommend patching Squid to report the last OpenSSL
error instead of the first one (in this context). This will require you
to rebuild your Squid from sources. Please let me know if you want to
pursue that and I will provide a patch.


HTH,

Alex.

> The problem is probably related to the reverse https proxy definition
> line in squid.conf :
> https_port 192.168.20.2:22225 accel cert=/etc/pki/tls/private/server.pem defaultsite=mail.kyenar.cz no-vhost name=reverzpe

> server.pem is the symlink to realFile.pem with this content:
> -----BEGIN RSA PRIVATE KEY-----
> MIIEpQ...
> ...
> ...vo=
> -----END RSA PRIVATE KEY-----
>
> -----BEGIN CERTIFICATE-----
> MIIGO...
> ...
> ...c5s=
> -----END CERTIFICATE-----
>
> and it worked fine in the older Squid-4.0.23 version.
>
> I tried:
> - tls-cert= instead of cert=
> - replacing the symlink server.pem with a real file.
> - arrange certificate in PEM file as first and key second
> - split PEM file into separate certificate and key and use it with syntax:
>
> https_port 192.168.20.2:22225 accel tls-cert=/etc/pki/tls/private/cert.pem tls-key=/etc/pki/tls/private/key.pem defaultsite=mail.kyenar.cz no-vhost name=reverzpe
>
> but squid still not start with this same message:
> ERROR: Failed to acquire TLS certificate '/etc/pki/tls/private/cert.pem': error:0480006C:PEM routines::no start line
>
> Can anyone help?
> ---
> Thanks in advance! Franta Hanzlik
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users

_______________________________________________
squid-users mailing list
squid-users at lists.squid-cache.org
http://lists.squid-cache.org/listinfo/squid-users

Get the 13 Email Threat Types eBook

https://www.barracuda.com/

This e-mail and any attachments to it contain confidential and proprietary material of Barracuda, its affiliates or agents, and is solely for the use of the intended recipient. Any review, use, disclosure, distribution or copying of this transmittal is prohibited except by or on behalf of the intended recipient. If you have received this transmittal in error, please notify the sender and destroy this e-mail and any attachments and all copies, whether electronic or printed.

________________________________

From aregalado at clinicanorte.do  Wed Jul 12 16:11:08 2023
From: aregalado at clinicanorte.do (=?UTF-8?Q?Andr=C3=A9s_Leandro_Regalado?=)
Date: Wed, 12 Jul 2023 16:11:08 +0000
Subject: [squid-users] Help with squid Proxy
Message-ID: <26a2c879497560bd60a75a95acff0f73@clinicanorte.do>



hello Dear community,


I need help, because I implemented squid proxy in a small office to 
filter the internet and now it blocks the communication of the mail 
client with the mail server, I need to know how I can allow outlook or 
thunderbird to work through squid.

thank you.

-- 
Ing. Andr?s Leandro Regalado
Cl?nica Independencia Norte
Tecnolog?a
809-385-2787 ext. 348


From Antony.Stone at squid.open.source.it  Wed Jul 12 16:25:29 2023
From: Antony.Stone at squid.open.source.it (Antony Stone)
Date: Wed, 12 Jul 2023 18:25:29 +0200
Subject: [squid-users] Help with squid Proxy
In-Reply-To: <26a2c879497560bd60a75a95acff0f73@clinicanorte.do>
References: <26a2c879497560bd60a75a95acff0f73@clinicanorte.do>
Message-ID: <202307121825.29717.Antony.Stone@squid.open.source.it>

On Wednesday 12 July 2023 at 18:11:08, Andr?s Leandro Regalado wrote:

> I implemented squid proxy in a small office to filter the internet and now it
> blocks the communication of the mail client with the mail server, I need to
> know how I can allow outlook or thunderbird to work through squid.

I'm strongly tempted simply to say that you need to change your Squid or 
router configuration in order to fix this problem.

For further details, please give us further details of what you have configured 
so far, otherwise we're just guessing in the dark.

You tell us enough about your setup that we would be able to reproduce it on 
our own networks, and we might be able to suggest to you what needs changing.


Don't forget to include details of how Outlook and Thunderbird are connecting 
(or at least trying to) to your mail server.


Antony.

-- 
Programming is a Dark Art, and it will always be. The programmer is
fighting against the two most destructive forces in the universe:
entropy and human stupidity. They're not things you can always
overcome with a "methodology" or on a schedule.

 - Damian Conway, Perl God

                                                   Please reply to the list;
                                                         please *don't* CC me.


From ben.goz87 at gmail.com  Thu Jul 13 08:29:50 2023
From: ben.goz87 at gmail.com (Ben Goz)
Date: Thu, 13 Jul 2023 11:29:50 +0300
Subject: [squid-users] Bypass sslbump using ACL's regex
Message-ID: <CADAqQfxi1sb+uZRqatgmebsGtrOYP-+tpdaRg+QYVwEZSVGL=w@mail.gmail.com>

By the help of God.

I'm trying to bypass chat.google.com domain from my squid (with sslbump),
But still no success.
 I tried build acl using:

acl bypass url_regex  -i chat.google.com

and

acl bypass ssl::server_name_regex -i chat.google.com

And still I can see in the logs that chat.google.com is bumped.

What am I doing wrong?

Regards,
Ben
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230713/8fa1f9c0/attachment.htm>

From uhlar at fantomas.sk  Thu Jul 13 09:26:08 2023
From: uhlar at fantomas.sk (Matus UHLAR - fantomas)
Date: Thu, 13 Jul 2023 11:26:08 +0200
Subject: [squid-users] Bypass sslbump using ACL's regex
In-Reply-To: <CADAqQfxi1sb+uZRqatgmebsGtrOYP-+tpdaRg+QYVwEZSVGL=w@mail.gmail.com>
References: <CADAqQfxi1sb+uZRqatgmebsGtrOYP-+tpdaRg+QYVwEZSVGL=w@mail.gmail.com>
Message-ID: <ZK/DML+18wnSJXs+@fantomas.sk>

On 13.07.23 11:29, Ben Goz wrote:
>By the help of God.

so, do you want us to help you or not?

>I'm trying to bypass chat.google.com domain from my squid (with sslbump),
>But still no success.
> I tried build acl using:
>
>acl bypass url_regex  -i chat.google.com
>
>and
>
>acl bypass ssl::server_name_regex -i chat.google.com
>
>And still I can see in the logs that chat.google.com is bumped.

acl just defines "access class list"
bumping is configed by using other directives, notably ssl_bump.


-- 
Matus UHLAR - fantomas, uhlar at fantomas.sk ; http://www.fantomas.sk/
Warning: I wish NOT to receive e-mail advertising to this address.
Varovanie: na tuto adresu chcem NEDOSTAVAT akukolvek reklamnu postu.
I feel like I'm diagonally parked in a parallel universe.


From squid3 at treenet.co.nz  Thu Jul 13 09:44:10 2023
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Thu, 13 Jul 2023 21:44:10 +1200
Subject: [squid-users] Bypass sslbump using ACL's regex
In-Reply-To: <CADAqQfxi1sb+uZRqatgmebsGtrOYP-+tpdaRg+QYVwEZSVGL=w@mail.gmail.com>
References: <CADAqQfxi1sb+uZRqatgmebsGtrOYP-+tpdaRg+QYVwEZSVGL=w@mail.gmail.com>
Message-ID: <452913cd-367e-6129-49e2-494951763ad9@treenet.co.nz>

On 13/07/23 20:29, Ben Goz wrote:
> By the help of God.
> 
> I'm trying to bypass chat.google.com domain 
> from my squid (with sslbump),
> But still no success.
>  ?I tried build acl using:
> 
> acl bypass url_regex ?-i chat.google.com
> 
> and
> 
> acl bypass ssl::server_name_regex -i chat.google.com
> 
> And still I can see in the logs that chat.google.com 
> is bumped.
> 
> What am I doing wrong?


How are you using those ACL tests?

Cheers
Amos


From rafael.akchurin at diladele.com  Thu Jul 13 11:38:39 2023
From: rafael.akchurin at diladele.com (Rafael Akchurin)
Date: Thu, 13 Jul 2023 11:38:39 +0000
Subject: [squid-users] squid 6.1 - auth scheme 'ntlm' is not recognized
Message-ID: <AM8PR04MB774547AEE394CC2C8D29527D8F37A@AM8PR04MB7745.eurprd04.prod.outlook.com>

Good day everyone,

We are now trying to move the configuration with was valid and working in Squid 5.7 to Squid 6.1 and hitting the following error:
Unknown authentication scheme 'ntlm'

The problem seem to be with the following configuration we use (output from squid -k parse).

023/07/13 13:34:04| Processing: auth_param ntlm program /opt/websafety/bin/wsauth --dc1addr=dc1.diladele.lan --dc1port=389
2023/07/13 13:34:04| ERROR: Failure while parsing Config File: Unknown authentication scheme 'ntlm'.
2023/07/13 13:34:04| FATAL: Bungled /opt/websafety/etc/squid/authentication.conf line 231: auth_param ntlm program /opt/websafety/bin/wsauth --dc1addr=dc1.diladele.lan --dc1port=389
2023/07/13 13:34:04| Squid Cache (Version 6.1): Terminated abnormally.

Comparing the contents of squid-5.9/src/AuthReg.cc and squid-6.1/src/AuthReg.cc it seems the support for NTLM authentication was indeed removed from the codebase (see below).

May I ask if the NTLM scheme is not needed at all now and we should continue using only Negotiate scheme (letting it handle the NTLM as usual)?

Best regards,
Rafael Akchurin
Diladele B.V.


In 5.0 the AuthReg.cc was

/**
* Initialize the authentication modules (if any)
* This is required once, before any configuration actions are taken.
*/
void
Auth::Init()
{
    debugs(29,DBG_IMPORTANT,"Startup: Initializing Authentication Schemes ...");
#if HAVE_AUTH_MODULE_BASIC
    static const char *basic_type = Auth::Basic::Scheme::GetInstance()->type();
    debugs(29,DBG_IMPORTANT,"Startup: Initialized Authentication Scheme '" << basic_type << "'");
#endif
#if HAVE_AUTH_MODULE_DIGEST
    static const char *digest_type = Auth::Digest::Scheme::GetInstance()->type();
    debugs(29,DBG_IMPORTANT,"Startup: Initialized Authentication Scheme '" << digest_type << "'");
#endif
#if HAVE_AUTH_MODULE_NEGOTIATE
    static const char *negotiate_type = Auth::Negotiate::Scheme::GetInstance()->type();
    debugs(29,DBG_IMPORTANT,"Startup: Initialized Authentication Scheme '" << negotiate_type << "'");
#endif
#if HAVE_AUTH_MODULE_NTLM
    static const char *ntlm_type = Auth::Ntlm::Scheme::GetInstance()->type();
    debugs(29,DBG_IMPORTANT,"Startup: Initialized Authentication Scheme '" << ntlm_type << "'");
#endif
    debugs(29,DBG_IMPORTANT,"Startup: Initialized Authentication.");
}


In 6.1 it is now



/**
* Initialize the authentication modules (if any)
* This is required once, before any configuration actions are taken.
*/
void
Auth::Init()
{
    debugs(29, 2, "Initializing Authentication Schemes ...");
#if HAVE_AUTH_MODULE_BASIC
    static const char *basic_type = Auth::Basic::Scheme::GetInstance()->type();
    debugs(29, 2, "Initialized Authentication Scheme '" << basic_type << "'");
#endif
#if HAVE_AUTH_MODULE_DIGEST
    static const char *digest_type = Auth::Digest::Scheme::GetInstance()->type();
    debugs(29, 2, "Initialized Authentication Scheme '" << digest_type << "'");
#endif
#if HAVE_AUTH_MODULE_NEGOTIATE
    static const char *negotiate_type = Auth::Negotiate::Scheme::GetInstance()->type();
    debugs(29, 2, "Initialized Authentication Scheme '" << negotiate_type << "'");
#endif
}
-------------- next part --------------
A non-text attachment was scrubbed...
Name: winmail.dat
Type: application/ms-tnef
Size: 20765 bytes
Desc: not available
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230713/bee8e520/attachment.bin>

From gkinkie at gmail.com  Thu Jul 13 14:29:36 2023
From: gkinkie at gmail.com (Francesco Chemolli)
Date: Thu, 13 Jul 2023 16:29:36 +0200
Subject: [squid-users] squid 6.1 - auth scheme 'ntlm' is not recognized
In-Reply-To: <AM8PR04MB774547AEE394CC2C8D29527D8F37A@AM8PR04MB7745.eurprd04.prod.outlook.com>
References: <AM8PR04MB774547AEE394CC2C8D29527D8F37A@AM8PR04MB7745.eurprd04.prod.outlook.com>
Message-ID: <CA+Y8hcPAvgdrqQJO5ic=eBJ--F3D9qaFFRBwgk7+f-8YE7WC1A@mail.gmail.com>

Hi Rafael,
  that code was moved to a RegisteredRunner in commit
09490bb867d0b3f00a29911a65c715108e95b782 .
I'm not sure why it is not working for you; what is the output of 'squid
-v' to get configure options?

Thanks,
  Francesco

On Thu, Jul 13, 2023 at 1:38?PM Rafael Akchurin <
rafael.akchurin at diladele.com> wrote:

> Good day everyone,
>
> We are now trying to move the configuration with was valid and working in
> Squid 5.7 to Squid 6.1 and hitting the following error:
> Unknown authentication scheme 'ntlm'
>
> The problem seem to be with the following configuration we use (output
> from squid -k parse).
>
> 023/07/13 13:34:04| Processing: auth_param ntlm program
> /opt/websafety/bin/wsauth --dc1addr=dc1.diladele.lan --dc1port=389
> 2023/07/13 13:34:04| ERROR: Failure while parsing Config File: Unknown
> authentication scheme 'ntlm'.
> 2023/07/13 13:34:04| FATAL: Bungled
> /opt/websafety/etc/squid/authentication.conf line 231: auth_param ntlm
> program /opt/websafety/bin/wsauth --dc1addr=dc1.diladele.lan --dc1port=389
> 2023/07/13 13:34:04| Squid Cache (Version 6.1): Terminated abnormally.
>
> Comparing the contents of squid-5.9/src/AuthReg.cc and
> squid-6.1/src/AuthReg.cc it seems the support for NTLM authentication was
> indeed removed from the codebase (see below).
>
> May I ask if the NTLM scheme is not needed at all now and we should
> continue using only Negotiate scheme (letting it handle the NTLM as usual)?
>
> Best regards,
> Rafael Akchurin
> Diladele B.V.
>
>
> In 5.0 the AuthReg.cc was
>
> /**
> * Initialize the authentication modules (if any)
> * This is required once, before any configuration actions are taken.
> */
> void
> Auth::Init()
> {
>     debugs(29,DBG_IMPORTANT,"Startup: Initializing Authentication Schemes
> ...");
> #if HAVE_AUTH_MODULE_BASIC
>     static const char *basic_type =
> Auth::Basic::Scheme::GetInstance()->type();
>     debugs(29,DBG_IMPORTANT,"Startup: Initialized Authentication Scheme '"
> << basic_type << "'");
> #endif
> #if HAVE_AUTH_MODULE_DIGEST
>     static const char *digest_type =
> Auth::Digest::Scheme::GetInstance()->type();
>     debugs(29,DBG_IMPORTANT,"Startup: Initialized Authentication Scheme '"
> << digest_type << "'");
> #endif
> #if HAVE_AUTH_MODULE_NEGOTIATE
>     static const char *negotiate_type =
> Auth::Negotiate::Scheme::GetInstance()->type();
>     debugs(29,DBG_IMPORTANT,"Startup: Initialized Authentication Scheme '"
> << negotiate_type << "'");
> #endif
> #if HAVE_AUTH_MODULE_NTLM
>     static const char *ntlm_type =
> Auth::Ntlm::Scheme::GetInstance()->type();
>     debugs(29,DBG_IMPORTANT,"Startup: Initialized Authentication Scheme '"
> << ntlm_type << "'");
> #endif
>     debugs(29,DBG_IMPORTANT,"Startup: Initialized Authentication.");
> }
>
>
> In 6.1 it is now
>
>
>
> /**
> * Initialize the authentication modules (if any)
> * This is required once, before any configuration actions are taken.
> */
> void
> Auth::Init()
> {
>     debugs(29, 2, "Initializing Authentication Schemes ...");
> #if HAVE_AUTH_MODULE_BASIC
>     static const char *basic_type =
> Auth::Basic::Scheme::GetInstance()->type();
>     debugs(29, 2, "Initialized Authentication Scheme '" << basic_type <<
> "'");
> #endif
> #if HAVE_AUTH_MODULE_DIGEST
>     static const char *digest_type =
> Auth::Digest::Scheme::GetInstance()->type();
>     debugs(29, 2, "Initialized Authentication Scheme '" << digest_type <<
> "'");
> #endif
> #if HAVE_AUTH_MODULE_NEGOTIATE
>     static const char *negotiate_type =
> Auth::Negotiate::Scheme::GetInstance()->type();
>     debugs(29, 2, "Initialized Authentication Scheme '" << negotiate_type
> << "'");
> #endif
> }
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users
>


-- 
    Francesco
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230713/5fc0c84c/attachment.htm>

From rousskov at measurement-factory.com  Thu Jul 13 15:02:17 2023
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Thu, 13 Jul 2023 11:02:17 -0400
Subject: [squid-users] squid 6.1 - auth scheme 'ntlm' is not recognized
In-Reply-To: <CA+Y8hcPAvgdrqQJO5ic=eBJ--F3D9qaFFRBwgk7+f-8YE7WC1A@mail.gmail.com>
References: <AM8PR04MB774547AEE394CC2C8D29527D8F37A@AM8PR04MB7745.eurprd04.prod.outlook.com>
 <CA+Y8hcPAvgdrqQJO5ic=eBJ--F3D9qaFFRBwgk7+f-8YE7WC1A@mail.gmail.com>
Message-ID: <5d1af93c-26c1-de88-d37d-22e6eac9e203@measurement-factory.com>

On 7/13/23 10:29, Francesco Chemolli wrote:
> Hi Rafael,
>  ? that code was moved to a RegisteredRunner in commit 
> 09490bb867d0b3f00a29911a65c715108e95b782 .
> I'm not sure why it is not working for you

That commit broke NTLM support in some environments because the linker 
in those environments does not add src/auth/ntlm/Scheme.cc code to squid 
executable. Linkers are allowed to drop modules that they think are 
unused. We will need to find a solution to that problem.

Alex.


> On Thu, Jul 13, 2023 at 1:38?PM Rafael Akchurin 
> <rafael.akchurin at diladele.com <mailto:rafael.akchurin at diladele.com>> wrote:
> 
>     Good day everyone,
> 
>     We are now trying to move the configuration with was valid and
>     working in Squid 5.7 to Squid 6.1 and hitting the following error:
>     Unknown authentication scheme 'ntlm'
> 
>     The problem seem to be with the following configuration we use
>     (output from squid -k parse).
> 
>     023/07/13 13:34:04| Processing: auth_param ntlm program
>     /opt/websafety/bin/wsauth --dc1addr=dc1.diladele.lan --dc1port=389
>     2023/07/13 13:34:04| ERROR: Failure while parsing Config File:
>     Unknown authentication scheme 'ntlm'.
>     2023/07/13 13:34:04| FATAL: Bungled
>     /opt/websafety/etc/squid/authentication.conf line 231: auth_param
>     ntlm program /opt/websafety/bin/wsauth --dc1addr=dc1.diladele.lan
>     --dc1port=389
>     2023/07/13 13:34:04| Squid Cache (Version 6.1): Terminated abnormally.
> 
>     Comparing the contents of squid-5.9/src/AuthReg.cc and
>     squid-6.1/src/AuthReg.cc it seems the support for NTLM
>     authentication was indeed removed from the codebase (see below).
> 
>     May I ask if the NTLM scheme is not needed at all now and we should
>     continue using only Negotiate scheme (letting it handle the NTLM as
>     usual)?
> 
>     Best regards,
>     Rafael Akchurin
>     Diladele B.V.
> 
> 
>     In 5.0 the AuthReg.cc was
> 
>     /**
>     * Initialize the authentication modules (if any)
>     * This is required once, before any configuration actions are taken.
>     */
>     void
>     Auth::Init()
>     {
>      ? ? debugs(29,DBG_IMPORTANT,"Startup: Initializing Authentication
>     Schemes ...");
>     #if HAVE_AUTH_MODULE_BASIC
>      ? ? static const char *basic_type =
>     Auth::Basic::Scheme::GetInstance()->type();
>      ? ? debugs(29,DBG_IMPORTANT,"Startup: Initialized Authentication
>     Scheme '" << basic_type << "'");
>     #endif
>     #if HAVE_AUTH_MODULE_DIGEST
>      ? ? static const char *digest_type =
>     Auth::Digest::Scheme::GetInstance()->type();
>      ? ? debugs(29,DBG_IMPORTANT,"Startup: Initialized Authentication
>     Scheme '" << digest_type << "'");
>     #endif
>     #if HAVE_AUTH_MODULE_NEGOTIATE
>      ? ? static const char *negotiate_type =
>     Auth::Negotiate::Scheme::GetInstance()->type();
>      ? ? debugs(29,DBG_IMPORTANT,"Startup: Initialized Authentication
>     Scheme '" << negotiate_type << "'");
>     #endif
>     #if HAVE_AUTH_MODULE_NTLM
>      ? ? static const char *ntlm_type =
>     Auth::Ntlm::Scheme::GetInstance()->type();
>      ? ? debugs(29,DBG_IMPORTANT,"Startup: Initialized Authentication
>     Scheme '" << ntlm_type << "'");
>     #endif
>      ? ? debugs(29,DBG_IMPORTANT,"Startup: Initialized Authentication.");
>     }
> 
> 
>     In 6.1 it is now
> 
> 
> 
>     /**
>     * Initialize the authentication modules (if any)
>     * This is required once, before any configuration actions are taken.
>     */
>     void
>     Auth::Init()
>     {
>      ? ? debugs(29, 2, "Initializing Authentication Schemes ...");
>     #if HAVE_AUTH_MODULE_BASIC
>      ? ? static const char *basic_type =
>     Auth::Basic::Scheme::GetInstance()->type();
>      ? ? debugs(29, 2, "Initialized Authentication Scheme '" <<
>     basic_type << "'");
>     #endif
>     #if HAVE_AUTH_MODULE_DIGEST
>      ? ? static const char *digest_type =
>     Auth::Digest::Scheme::GetInstance()->type();
>      ? ? debugs(29, 2, "Initialized Authentication Scheme '" <<
>     digest_type << "'");
>     #endif
>     #if HAVE_AUTH_MODULE_NEGOTIATE
>      ? ? static const char *negotiate_type =
>     Auth::Negotiate::Scheme::GetInstance()->type();
>      ? ? debugs(29, 2, "Initialized Authentication Scheme '" <<
>     negotiate_type << "'");
>     #endif
>     }
>     _______________________________________________
>     squid-users mailing list
>     squid-users at lists.squid-cache.org
>     <mailto:squid-users at lists.squid-cache.org>
>     http://lists.squid-cache.org/listinfo/squid-users
>     <http://lists.squid-cache.org/listinfo/squid-users>
> 
> 
> 
> -- 
>  ? ? Francesco
> 
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users



From rafael.akchurin at diladele.com  Thu Jul 13 16:53:54 2023
From: rafael.akchurin at diladele.com (Rafael Akchurin)
Date: Thu, 13 Jul 2023 16:53:54 +0000
Subject: [squid-users] squid 6.1 - auth scheme 'ntlm' is not recognized
In-Reply-To: <5d1af93c-26c1-de88-d37d-22e6eac9e203@measurement-factory.com>
References: <AM8PR04MB774547AEE394CC2C8D29527D8F37A@AM8PR04MB7745.eurprd04.prod.outlook.com>
 <CA+Y8hcPAvgdrqQJO5ic=eBJ--F3D9qaFFRBwgk7+f-8YE7WC1A@mail.gmail.com>
 <5d1af93c-26c1-de88-d37d-22e6eac9e203@measurement-factory.com>
Message-ID: <AM8PR04MB77456ECF04473E500F6C9B728F37A@AM8PR04MB7745.eurprd04.prod.outlook.com>

And the configure options are just those from Debian Unstable (I just added the --disable-optimizations to be able to debug in vscode):


./configure \
	--with-build-environment=default \
	--disable-optimizations \
	--enable-build-info="ubuntu 22" \
	--datadir=/usr/share/squid \
	--sysconfdir=/etc/squid \
	--libexecdir=/usr/lib/squid \
	--mandir=/usr/share/man \
	--enable-inline \
	--disable-arch-native \
	--enable-async-io=8 \
	--enable-storeio="ufs,aufs,diskd,rock" \
	--enable-removal-policies="lru,heap" \
	--enable-delay-pools \
	--enable-cache-digests \
	--enable-icap-client \
	--enable-follow-x-forwarded-for \
	--enable-auth-basic="DB,fake,getpwnam,LDAP,NCSA,PAM,POP3,RADIUS,SASL,SMB" \
	--enable-auth-digest="file,LDAP" \
	--enable-auth-negotiate="kerberos,wrapper" \
	--enable-auth-ntlm="fake,SMB_LM" \
	--enable-external-acl-helpers="file_userip,kerberos_ldap_group,LDAP_group,session,SQL_session,time_quota,unix_group,wbinfo_group" \
	--enable-security-cert-validators="fake" \
	--enable-storeid-rewrite-helpers="file" \
	--enable-url-rewrite-helpers="fake" \
	--enable-eui \
	--enable-esi \
	--enable-icmp \
	--enable-zph-qos \
	--enable-ecap \
	--disable-translation \
	--with-swapdir=/var/spool/squid \
	--with-logdir=/var/log/squid \
	--with-pidfile=/run/squid.pid \
	--with-filedescriptors=65536 \
	--with-large-files \
	--with-default-user=proxy \
	--enable-linux-netfilter \
	--with-systemd



-----Original Message-----
From: squid-users <squid-users-bounces at lists.squid-cache.org> On Behalf Of Alex Rousskov
Sent: Thursday, July 13, 2023 5:02 PM
To: squid-users at lists.squid-cache.org
Subject: Re: [squid-users] squid 6.1 - auth scheme 'ntlm' is not recognized

On 7/13/23 10:29, Francesco Chemolli wrote:
> Hi Rafael,
>  ? that code was moved to a RegisteredRunner in commit
> 09490bb867d0b3f00a29911a65c715108e95b782 .
> I'm not sure why it is not working for you

That commit broke NTLM support in some environments because the linker in those environments does not add src/auth/ntlm/Scheme.cc code to squid executable. Linkers are allowed to drop modules that they think are unused. We will need to find a solution to that problem.

Alex.


> On Thu, Jul 13, 2023 at 1:38?PM Rafael Akchurin 
> <rafael.akchurin at diladele.com <mailto:rafael.akchurin at diladele.com>> wrote:
> 
>     Good day everyone,
> 
>     We are now trying to move the configuration with was valid and
>     working in Squid 5.7 to Squid 6.1 and hitting the following error:
>     Unknown authentication scheme 'ntlm'
> 
>     The problem seem to be with the following configuration we use
>     (output from squid -k parse).
> 
>     023/07/13 13:34:04| Processing: auth_param ntlm program
>     /opt/websafety/bin/wsauth --dc1addr=dc1.diladele.lan --dc1port=389
>     2023/07/13 13:34:04| ERROR: Failure while parsing Config File:
>     Unknown authentication scheme 'ntlm'.
>     2023/07/13 13:34:04| FATAL: Bungled
>     /opt/websafety/etc/squid/authentication.conf line 231: auth_param
>     ntlm program /opt/websafety/bin/wsauth --dc1addr=dc1.diladele.lan
>     --dc1port=389
>     2023/07/13 13:34:04| Squid Cache (Version 6.1): Terminated abnormally.
> 
>     Comparing the contents of squid-5.9/src/AuthReg.cc and
>     squid-6.1/src/AuthReg.cc it seems the support for NTLM
>     authentication was indeed removed from the codebase (see below).
> 
>     May I ask if the NTLM scheme is not needed at all now and we should
>     continue using only Negotiate scheme (letting it handle the NTLM as
>     usual)?
> 
>     Best regards,
>     Rafael Akchurin
>     Diladele B.V.
> 
> 
>     In 5.0 the AuthReg.cc was
> 
>     /**
>     * Initialize the authentication modules (if any)
>     * This is required once, before any configuration actions are taken.
>     */
>     void
>     Auth::Init()
>     {
>      ? ? debugs(29,DBG_IMPORTANT,"Startup: Initializing Authentication
>     Schemes ...");
>     #if HAVE_AUTH_MODULE_BASIC
>      ? ? static const char *basic_type =
>     Auth::Basic::Scheme::GetInstance()->type();
>      ? ? debugs(29,DBG_IMPORTANT,"Startup: Initialized Authentication
>     Scheme '" << basic_type << "'");
>     #endif
>     #if HAVE_AUTH_MODULE_DIGEST
>      ? ? static const char *digest_type =
>     Auth::Digest::Scheme::GetInstance()->type();
>      ? ? debugs(29,DBG_IMPORTANT,"Startup: Initialized Authentication
>     Scheme '" << digest_type << "'");
>     #endif
>     #if HAVE_AUTH_MODULE_NEGOTIATE
>      ? ? static const char *negotiate_type =
>     Auth::Negotiate::Scheme::GetInstance()->type();
>      ? ? debugs(29,DBG_IMPORTANT,"Startup: Initialized Authentication
>     Scheme '" << negotiate_type << "'");
>     #endif
>     #if HAVE_AUTH_MODULE_NTLM
>      ? ? static const char *ntlm_type =
>     Auth::Ntlm::Scheme::GetInstance()->type();
>      ? ? debugs(29,DBG_IMPORTANT,"Startup: Initialized Authentication
>     Scheme '" << ntlm_type << "'");
>     #endif
>      ? ? debugs(29,DBG_IMPORTANT,"Startup: Initialized Authentication.");
>     }
> 
> 
>     In 6.1 it is now
> 
> 
> 
>     /**
>     * Initialize the authentication modules (if any)
>     * This is required once, before any configuration actions are taken.
>     */
>     void
>     Auth::Init()
>     {
>      ? ? debugs(29, 2, "Initializing Authentication Schemes ...");
>     #if HAVE_AUTH_MODULE_BASIC
>      ? ? static const char *basic_type =
>     Auth::Basic::Scheme::GetInstance()->type();
>      ? ? debugs(29, 2, "Initialized Authentication Scheme '" <<
>     basic_type << "'");
>     #endif
>     #if HAVE_AUTH_MODULE_DIGEST
>      ? ? static const char *digest_type =
>     Auth::Digest::Scheme::GetInstance()->type();
>      ? ? debugs(29, 2, "Initialized Authentication Scheme '" <<
>     digest_type << "'");
>     #endif
>     #if HAVE_AUTH_MODULE_NEGOTIATE
>      ? ? static const char *negotiate_type =
>     Auth::Negotiate::Scheme::GetInstance()->type();
>      ? ? debugs(29, 2, "Initialized Authentication Scheme '" <<
>     negotiate_type << "'");
>     #endif
>     }
>     _______________________________________________
>     squid-users mailing list
>     squid-users at lists.squid-cache.org
>     <mailto:squid-users at lists.squid-cache.org>
>     http://lists.squid-cache.org/listinfo/squid-users
>     <http://lists.squid-cache.org/listinfo/squid-users>
> 
> 
> 
> --
>  ? ? Francesco
> 
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users

_______________________________________________
squid-users mailing list
squid-users at lists.squid-cache.org
http://lists.squid-cache.org/listinfo/squid-users

From rousskov at measurement-factory.com  Thu Jul 13 18:20:16 2023
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Thu, 13 Jul 2023 14:20:16 -0400
Subject: [squid-users] squid 6.1 - auth scheme 'ntlm' is not recognized
In-Reply-To: <AM8PR04MB77456ECF04473E500F6C9B728F37A@AM8PR04MB7745.eurprd04.prod.outlook.com>
References: <AM8PR04MB774547AEE394CC2C8D29527D8F37A@AM8PR04MB7745.eurprd04.prod.outlook.com>
 <CA+Y8hcPAvgdrqQJO5ic=eBJ--F3D9qaFFRBwgk7+f-8YE7WC1A@mail.gmail.com>
 <5d1af93c-26c1-de88-d37d-22e6eac9e203@measurement-factory.com>
 <AM8PR04MB77456ECF04473E500F6C9B728F37A@AM8PR04MB7745.eurprd04.prod.outlook.com>
Message-ID: <578f6258-40a1-47e1-71db-525e813cc355@measurement-factory.com>

Please see if the following partial fix helps in your environment:

https://github.com/squid-cache/squid/commit/5596a2f4894f80864b660b035d05f5aec74f8312.patch

The fix has been posted for preliminary review as draft PR 1422:
https://github.com/squid-cache/squid/pull/1422


Thank you,

Alex.



On 7/13/23 12:53, Rafael Akchurin wrote:
> And the configure options are just those from Debian Unstable (I just added the --disable-optimizations to be able to debug in vscode):
> 
> 
> ./configure \
> 	--with-build-environment=default \
> 	--disable-optimizations \
> 	--enable-build-info="ubuntu 22" \
> 	--datadir=/usr/share/squid \
> 	--sysconfdir=/etc/squid \
> 	--libexecdir=/usr/lib/squid \
> 	--mandir=/usr/share/man \
> 	--enable-inline \
> 	--disable-arch-native \
> 	--enable-async-io=8 \
> 	--enable-storeio="ufs,aufs,diskd,rock" \
> 	--enable-removal-policies="lru,heap" \
> 	--enable-delay-pools \
> 	--enable-cache-digests \
> 	--enable-icap-client \
> 	--enable-follow-x-forwarded-for \
> 	--enable-auth-basic="DB,fake,getpwnam,LDAP,NCSA,PAM,POP3,RADIUS,SASL,SMB" \
> 	--enable-auth-digest="file,LDAP" \
> 	--enable-auth-negotiate="kerberos,wrapper" \
> 	--enable-auth-ntlm="fake,SMB_LM" \
> 	--enable-external-acl-helpers="file_userip,kerberos_ldap_group,LDAP_group,session,SQL_session,time_quota,unix_group,wbinfo_group" \
> 	--enable-security-cert-validators="fake" \
> 	--enable-storeid-rewrite-helpers="file" \
> 	--enable-url-rewrite-helpers="fake" \
> 	--enable-eui \
> 	--enable-esi \
> 	--enable-icmp \
> 	--enable-zph-qos \
> 	--enable-ecap \
> 	--disable-translation \
> 	--with-swapdir=/var/spool/squid \
> 	--with-logdir=/var/log/squid \
> 	--with-pidfile=/run/squid.pid \
> 	--with-filedescriptors=65536 \
> 	--with-large-files \
> 	--with-default-user=proxy \
> 	--enable-linux-netfilter \
> 	--with-systemd
> 
> 
> 
> -----Original Message-----
> From: squid-users <squid-users-bounces at lists.squid-cache.org> On Behalf Of Alex Rousskov
> Sent: Thursday, July 13, 2023 5:02 PM
> To: squid-users at lists.squid-cache.org
> Subject: Re: [squid-users] squid 6.1 - auth scheme 'ntlm' is not recognized
> 
> On 7/13/23 10:29, Francesco Chemolli wrote:
>> Hi Rafael,
>>   ? that code was moved to a RegisteredRunner in commit
>> 09490bb867d0b3f00a29911a65c715108e95b782 .
>> I'm not sure why it is not working for you
> 
> That commit broke NTLM support in some environments because the linker in those environments does not add src/auth/ntlm/Scheme.cc code to squid executable. Linkers are allowed to drop modules that they think are unused. We will need to find a solution to that problem.
> 
> Alex.
> 
> 
>> On Thu, Jul 13, 2023 at 1:38?PM Rafael Akchurin
>> <rafael.akchurin at diladele.com <mailto:rafael.akchurin at diladele.com>> wrote:
>>
>>      Good day everyone,
>>
>>      We are now trying to move the configuration with was valid and
>>      working in Squid 5.7 to Squid 6.1 and hitting the following error:
>>      Unknown authentication scheme 'ntlm'
>>
>>      The problem seem to be with the following configuration we use
>>      (output from squid -k parse).
>>
>>      023/07/13 13:34:04| Processing: auth_param ntlm program
>>      /opt/websafety/bin/wsauth --dc1addr=dc1.diladele.lan --dc1port=389
>>      2023/07/13 13:34:04| ERROR: Failure while parsing Config File:
>>      Unknown authentication scheme 'ntlm'.
>>      2023/07/13 13:34:04| FATAL: Bungled
>>      /opt/websafety/etc/squid/authentication.conf line 231: auth_param
>>      ntlm program /opt/websafety/bin/wsauth --dc1addr=dc1.diladele.lan
>>      --dc1port=389
>>      2023/07/13 13:34:04| Squid Cache (Version 6.1): Terminated abnormally.
>>
>>      Comparing the contents of squid-5.9/src/AuthReg.cc and
>>      squid-6.1/src/AuthReg.cc it seems the support for NTLM
>>      authentication was indeed removed from the codebase (see below).
>>
>>      May I ask if the NTLM scheme is not needed at all now and we should
>>      continue using only Negotiate scheme (letting it handle the NTLM as
>>      usual)?
>>
>>      Best regards,
>>      Rafael Akchurin
>>      Diladele B.V.
>>
>>
>>      In 5.0 the AuthReg.cc was
>>
>>      /**
>>      * Initialize the authentication modules (if any)
>>      * This is required once, before any configuration actions are taken.
>>      */
>>      void
>>      Auth::Init()
>>      {
>>       ? ? debugs(29,DBG_IMPORTANT,"Startup: Initializing Authentication
>>      Schemes ...");
>>      #if HAVE_AUTH_MODULE_BASIC
>>       ? ? static const char *basic_type =
>>      Auth::Basic::Scheme::GetInstance()->type();
>>       ? ? debugs(29,DBG_IMPORTANT,"Startup: Initialized Authentication
>>      Scheme '" << basic_type << "'");
>>      #endif
>>      #if HAVE_AUTH_MODULE_DIGEST
>>       ? ? static const char *digest_type =
>>      Auth::Digest::Scheme::GetInstance()->type();
>>       ? ? debugs(29,DBG_IMPORTANT,"Startup: Initialized Authentication
>>      Scheme '" << digest_type << "'");
>>      #endif
>>      #if HAVE_AUTH_MODULE_NEGOTIATE
>>       ? ? static const char *negotiate_type =
>>      Auth::Negotiate::Scheme::GetInstance()->type();
>>       ? ? debugs(29,DBG_IMPORTANT,"Startup: Initialized Authentication
>>      Scheme '" << negotiate_type << "'");
>>      #endif
>>      #if HAVE_AUTH_MODULE_NTLM
>>       ? ? static const char *ntlm_type =
>>      Auth::Ntlm::Scheme::GetInstance()->type();
>>       ? ? debugs(29,DBG_IMPORTANT,"Startup: Initialized Authentication
>>      Scheme '" << ntlm_type << "'");
>>      #endif
>>       ? ? debugs(29,DBG_IMPORTANT,"Startup: Initialized Authentication.");
>>      }
>>
>>
>>      In 6.1 it is now
>>
>>
>>
>>      /**
>>      * Initialize the authentication modules (if any)
>>      * This is required once, before any configuration actions are taken.
>>      */
>>      void
>>      Auth::Init()
>>      {
>>       ? ? debugs(29, 2, "Initializing Authentication Schemes ...");
>>      #if HAVE_AUTH_MODULE_BASIC
>>       ? ? static const char *basic_type =
>>      Auth::Basic::Scheme::GetInstance()->type();
>>       ? ? debugs(29, 2, "Initialized Authentication Scheme '" <<
>>      basic_type << "'");
>>      #endif
>>      #if HAVE_AUTH_MODULE_DIGEST
>>       ? ? static const char *digest_type =
>>      Auth::Digest::Scheme::GetInstance()->type();
>>       ? ? debugs(29, 2, "Initialized Authentication Scheme '" <<
>>      digest_type << "'");
>>      #endif
>>      #if HAVE_AUTH_MODULE_NEGOTIATE
>>       ? ? static const char *negotiate_type =
>>      Auth::Negotiate::Scheme::GetInstance()->type();
>>       ? ? debugs(29, 2, "Initialized Authentication Scheme '" <<
>>      negotiate_type << "'");
>>      #endif
>>      }
>>      _______________________________________________
>>      squid-users mailing list
>>      squid-users at lists.squid-cache.org
>>      <mailto:squid-users at lists.squid-cache.org>
>>      http://lists.squid-cache.org/listinfo/squid-users
>>      <http://lists.squid-cache.org/listinfo/squid-users>
>>
>>
>>
>> --
>>   ? ? Francesco
>>
>> _______________________________________________
>> squid-users mailing list
>> squid-users at lists.squid-cache.org
>> http://lists.squid-cache.org/listinfo/squid-users
> 
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users



From mglover at pobox.com  Fri Jul 14 00:51:17 2023
From: mglover at pobox.com (Mike Glover)
Date: Thu, 13 Jul 2023 18:51:17 -0600
Subject: [squid-users] Rate limiting outbound connections with http_access?
Message-ID: <6bcaab6f-f287-4799-917c-b58f8e2cf28b@app.fastmail.com>

Hi,

My project makes user-initiated requests to a selection of HTTPS API,  I'm using squid 5.7 as a forward proxy with SSL bumping to aggressively cache results, and it's working great for that.

One of the API (let's call it 'foobar.org') has a strict 1 request per second limit. I would like to throttle outbound requests from my server using squid.*

I've written a simple external ACL program (rate_limit.py) that works as a throttle, and I've hooked it up like this in my config:

acl delayhosts dstdomain foobar.org

external_acl_type rate1 ttl=0 children-max=1 children-startup=1 %ACL \
    ./rate_limit.py
acl 1ps external rate1

acl putdelay annotate_transaction needs_delay=1
acl checkdelay all-of !CONNECT delayhosts putdelay
acl getdelay note needs_delay
acl dodelay all-of getdelay 1ps

# dodelay can and should move somewhere after the cache check
http_access allow checkdelay dodelay

This is almost what I'm looking for.**  The problem is that the delay happens before the cache check, so I'm needlesslly throttling requests that I can serve locally. 

I can't find any hook post-cache-check that will accept a slow ACL.  Does such a thing exist in squid?

Best,

-mg

* Yes, perhaps this would be simpler with iptables.  I'm not currently using iptables in this project, I'm not terribly familiar with it, and everything else works happily unprivileged, so even a slightly kludgy solution in squid would be preferable (at this stage, at least) than learning, configuring, monitoring, and debugging another component.

** And yes, better than iptables rn



From rousskov at measurement-factory.com  Fri Jul 14 14:35:48 2023
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Fri, 14 Jul 2023 10:35:48 -0400
Subject: [squid-users] Rate limiting outbound connections with
 http_access?
In-Reply-To: <6bcaab6f-f287-4799-917c-b58f8e2cf28b@app.fastmail.com>
References: <6bcaab6f-f287-4799-917c-b58f8e2cf28b@app.fastmail.com>
Message-ID: <cd6ae5c0-7036-c546-4c1a-094c7f9c868d@measurement-factory.com>

On 7/13/23 20:51, Mike Glover wrote:

> My project makes user-initiated requests to a selection of HTTPS API,  I'm using squid 5.7 as a forward proxy with SSL bumping to aggressively cache results, and it's working great for that.
> 
> One of the API (let's call it 'foobar.org') has a strict 1 request per second limit. I would like to throttle outbound requests from my server using squid.*
> 
> I've written a simple external ACL program (rate_limit.py) that works as a throttle, and I've hooked it up like this in my config:
> 
> acl delayhosts dstdomain foobar.org
> 
> external_acl_type rate1 ttl=0 children-max=1 children-startup=1 %ACL \
>      ./rate_limit.py
> acl 1ps external rate1
> 
> acl putdelay annotate_transaction needs_delay=1
> acl checkdelay all-of !CONNECT delayhosts putdelay
> acl getdelay note needs_delay
> acl dodelay all-of getdelay 1ps
> 
> # dodelay can and should move somewhere after the cache check
> http_access allow checkdelay dodelay
> 
> This is almost what I'm looking for.**  The problem is that the delay happens before the cache check, so I'm needlesslly throttling requests that I can serve locally.
> 
> I can't find any hook post-cache-check that will accept a slow ACL.  Does such a thing exist in squid?


Yes, several post-cache-check directives support slow ACLs, including 
always_direct and never_direct.

Technically, http_reply_access fits that criteria as well, but that 
directive is checked too late for your purposes AFAICT: You need a 
directive that is checked _before_ Squid sends the request.


HTH,

Alex.


> Best,
> 
> -mg
> 
> * Yes, perhaps this would be simpler with iptables.  I'm not currently using iptables in this project, I'm not terribly familiar with it, and everything else works happily unprivileged, so even a slightly kludgy solution in squid would be preferable (at this stage, at least) than learning, configuring, monitoring, and debugging another component.
> 
> ** And yes, better than iptables rn
> 
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users



From hsv at energy.dk  Fri Jul 14 23:07:59 2023
From: hsv at energy.dk (Henning Svane)
Date: Fri, 14 Jul 2023 23:07:59 +0000
Subject: [squid-users] How to build Squid 6
Message-ID: <78f0ecdf721e40b092e263f173bd4881@energy.dk>

Hi
I try to find a how to build Squid 6 on Ubuntu 22.04 (Jammy)
I have read the compile/build instruction on the Wiki
Compiling Squid | Squid Web Cache wiki (squid-cache.org)<https://wiki.squid-cache.org/SquidFaq/CompilingSquid>
But I am not sure to do it after read the explanation.
I have also looked at the build "example" from the
dockerfiles/ubuntu-jammy/Dockerfile at master * kinkie/dockerfiles * GitHub<https://github.com/kinkie/dockerfiles/blob/master/ubuntu-jammy/Dockerfile>

I have searched for a how to without luck.

So do any one know where to find a description or how to.

Regards
Henning
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230714/855166a3/attachment.htm>

From rousskov at measurement-factory.com  Sat Jul 15 02:30:56 2023
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Fri, 14 Jul 2023 22:30:56 -0400
Subject: [squid-users] How to build Squid 6
In-Reply-To: <78f0ecdf721e40b092e263f173bd4881@energy.dk>
References: <78f0ecdf721e40b092e263f173bd4881@energy.dk>
Message-ID: <6cacd36d-2c16-a034-56b8-8f163630f8b4@measurement-factory.com>

On 7/14/23 19:07, Henning Svane wrote:

> I try to find a how to build Squid 6 on Ubuntu 22.04 (Jammy)

To build Squid v6 on Ubuntu from a source tarball with many optional 
features enabled, consider using the same commands that Squid CI tests 
are using:

     # deb-src sources are required for "apt-get build-dep" below,
     # but you may find a better way to enable them in
     # /etc/apt/sources.list, or you may already have them enabled
     sudo sed --in-place -E 's/# (deb-src.*updates main)/  \1/g' \
         /etc/apt/sources.list
     sudo apt-get update

     # install various prerequisites and optional dependencies
     sudo apt-get build-dep squid
     sudo apt-get install linuxdoc-tools

     # download and unpack Squid sources; if you want a more secure
     # option, use the official git repository instead; our CI commands
     # use the git repository, not wget
     wget http://www.squid-cache.org/Versions/v6/squid-6.1.tar.gz
     tar -vzf squid-6.1.tar.gz

     cd squid-6.1

     # this step is not necessary when using bootstrapped sources
     # as shown by the wget command above; this step is necessary
     # if you get Squid sources from git
     ./bootstrap.sh

     # you do not have to specify --with-openssl but if you need
     # SslBump features, you should specify it (IMHO);
     # see ./configure --help for many other options
     ./configure --with-openssl

     # if you have n CPU cores available, then use "make -jn" or
     # some such to speed the build up
     make

     # this will install Squid into default directories unless
     # you customize that during the ./configure step above
     sudo make install


HTH,

Alex.



> I have read the compile/build instruction on the Wiki
> 
> Compiling Squid | Squid Web Cache wiki (squid-cache.org) 
> <https://wiki.squid-cache.org/SquidFaq/CompilingSquid>
> 
> But I am not sure to do it after read the explanation.
> 
> I have also looked at the build ?example? from the
> 
> dockerfiles/ubuntu-jammy/Dockerfile at master ? kinkie/dockerfiles ? 
> GitHub 
> <https://github.com/kinkie/dockerfiles/blob/master/ubuntu-jammy/Dockerfile>
> 
> I have searched for a how to without luck.
> 
> So do any one know where to find a description or how to.
> 
> Regards
> 
> Henning
> 
> 
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users



From dave at killthe.net  Sat Jul 15 16:25:20 2023
From: dave at killthe.net (Dave Blanchard)
Date: Sat, 15 Jul 2023 11:25:20 -0500
Subject: [squid-users] Bug in Squid configure script kills build
Message-ID: <20230715112520.47fad67eb62d4921fe2068a4@killthe.net>

There seems to be a bug in Squid 5.x's configure script which, on my system at least, consistently kills the calling process thus preventing the build from completing. I haven't tried earlier versions yet. This problem appears with various recent GCC versions, and does not appear to be a bug in my system as there are literally over a thousand other packages that build fine, while Squid consistently dies. This is what it looks like:


checking for a BSD-compatible install... /usr/bin/install -c
checking whether build environment is sane... yes
checking for a race-free mkdir -p... /usr/bin/mkdir -p
checking for gawk... gawk
checking whether make sets $(MAKE)... yes
checking whether make supports nested variables... yes
checking whether UID '0' is supported by ustar format... yes
checking whether GID '0' is supported by ustar format... yes
checking how to create a ustar tar archive... gnutar
checking whether to enable maintainer-specific portions of Makefiles... no
checking for gcc... gcc
checking whether the C compiler works... yes
checking for C compiler default output file name... a.out
checking for suffix of executables... 
checking whether we are cross compiling... no
checking for suffix of object files... o
checking whether the compiler supports GNU C... yes
checking whether gcc accepts -g... yes
checking for gcc option to enable C11 features... none needed
checking whether gcc understands -c and -o together... yes
checking whether make supports the include directive... yes (GNU style)
checking dependency style of gcc... gcc3
checking whether the compiler supports GNU C++... yes
checking whether g++ accepts -g... yes
checking for g++ option to enable C++11 features... none needed
checking dependency style of g++... gcc3
checking build system type... x86_64-pc-linux-gnu
checking host system type... x86_64-pc-linux-gnu
configure: CPU arch native optimization enabled: auto
checking whether compiler accepts -march=native... yes
checking simplified host os... linux (version )
checking whether g++ supports C++11 features by default... yes
checking for ranlib... ranlib
checking how to run the C preprocessor... Killed        <------ here is the problem
# gcc -E
checking whether ln -s works... yes
checking for grep that handles long lines and -e... /usr/bin/grep
checking for egrep... /usr/bin/grep -E
checking for sh... /usr/bin/sh
checking for false... /usr/bin/false
checking for true... /usr/bin/true
checking for mv... /usr/bin/mv
checking for mkdir... /usr/bin/mkdir
checking for ln... /usr/bin/ln
checking for chmod... /usr/bin/chmod
checking for tr... /usr/bin/tr
checking for rm... /usr/bin/rm
checking for pkg-config... /usr/bin/pkg-config
checking pkg-config is at least version 0.9.0... yes
checking for perl... /usr/bin/perl

[...]

checking for dirent.h... yes
checking for closedir... yes
checking for opendir... yes
checking for readdir... yes
checking for strlcat... no
checking for strlcpy... no
checking that generated files are newer than configure... done
configure: creating ./config.status
config.status: creating Makefile
config.status: creating config.h
config.status: executing depfiles commands
config.status: executing libtool commands

At this point the script seems to hang, but actually I only have to press the enter key and the prompt reappears, as the process had been killed.

Anyone seen this before?

Dave


From dave at killthe.net  Sat Jul 15 16:31:29 2023
From: dave at killthe.net (Dave Blanchard)
Date: Sat, 15 Jul 2023 11:31:29 -0500
Subject: [squid-users] Bug in Squid configure script kills build
In-Reply-To: <20230715112520.47fad67eb62d4921fe2068a4@killthe.net>
References: <20230715112520.47fad67eb62d4921fe2068a4@killthe.net>
Message-ID: <20230715113129.d00e6b4d05d98950180ba21a@killthe.net>


Just checked and the problem is occurring with Squid 4.6 also. Will continue trying different versions to see if I can find a version that will build. It appears to happen somewhat randomly. 

I actually do think this bug was triggered by a change to some other aspect of my system, as Squid has built successfully until recently, but I'm at a loss as to what exactly could be causing the problem. It may not be a bug in Squid's script, but in autotools or some of this other garbage GNU software. 

[...]

checking for gnutls/x509.h... yes
checking gnutls/abstract.h usability... yes
checking gnutls/abstract.h presence... yes
checking for gnutls/abstract.h... yes
configure: GnuTLS library support: auto  -lgnutls 
checking openssl/asn1.h usability... yes
checking openssl/asn1.h presence... yes
checking for openssl/asn1.h... yes
checking openssl/bio.h usability... Killed

[...]


From dave at killthe.net  Sat Jul 15 16:53:17 2023
From: dave at killthe.net (Dave Blanchard)
Date: Sat, 15 Jul 2023 11:53:17 -0500
Subject: [squid-users] Bug in Squid configure script kills build
In-Reply-To: <20230715113129.d00e6b4d05d98950180ba21a@killthe.net>
References: <20230715112520.47fad67eb62d4921fe2068a4@killthe.net>
 <20230715113129.d00e6b4d05d98950180ba21a@killthe.net>
Message-ID: <20230715115317.f8b94eaed826e540e9177ee3@killthe.net>

Update--I don't believe the problem is in Squid at all, or in autotools, but elsewhere. This is a REALLY strange problem. Will let you know what it was if I figure it out.


From 3m9n51s2ewut at thismonkey.com  Sun Jul 16 12:03:34 2023
From: 3m9n51s2ewut at thismonkey.com (Scott)
Date: Sun, 16 Jul 2023 22:03:34 +1000
Subject: [squid-users] ACL with a non-contiguous mask - using multiple
 outgoing addresses
Message-ID: <ZLPclgzeW8Or9ypj@thismonkey.com>

Hi all,

I have four IPv4s that I use for outgoing source addresses to origin servers.
I currently have them used randomly, but this sometimes causes issues for 
certain sites that get confused if your source changes for various resources.  
For these sites I have an exception to the random IPs.

I decided to create the following acls which should match on the 2 low-order 
bits in the client addresses:

acl tm_src_v4_00 src 10.0.0.0 255.0.0.3
acl tm_src_v4_01 src 10.0.0.1 255.0.0.3
acl tm_src_v4_10 src 10.0.0.2 255.0.0.3
acl tm_src_v4_11 src 10.0.0.3 255.0.0.3

tcp_outgoing_address 10.1.22.21 tm_src_v4_00
tcp_outgoing_address 10.1.22.22 tm_src_v4_01
tcp_outgoing_address 10.1.22.23 tm_src_v4_10
tcp_outgoing_address 10.1.22.24 tm_src_v4_11

However I did not get the behaviour I was after, rather all clients use the 
same outgoing address.

Is there a way to share multiple outgoing IPs while maintaining consistency 
per-source?

Follow-up: can I do the same for IPv6 clients?

Thanks,
Scott

PS: As an aside, the following ACL generated the following warning:

acl tm_src_11 src 0.0.0.3 0.0.0.3

Configuration for squid passes.
2023/07/15 23:38:40| WARNING: (B) '0.0.0.3' is a subnetwork of (A) '0.0.0.3'
2023/07/15 23:38:40| WARNING: because of this '0.0.0.3' is ignored to keep splay tree searching predictable
2023/07/15 23:38:40| WARNING: You should probably remove '0.0.0.3' from the ACL named 'tm_src_11'

Could someone please explain what the issue is with that ACL?  Thanks.


From ben.goz87 at gmail.com  Sun Jul 16 12:43:18 2023
From: ben.goz87 at gmail.com (Ben Goz)
Date: Sun, 16 Jul 2023 15:43:18 +0300
Subject: [squid-users] Bypass sslbump using ACL's regex
In-Reply-To: <452913cd-367e-6129-49e2-494951763ad9@treenet.co.nz>
References: <CADAqQfxi1sb+uZRqatgmebsGtrOYP-+tpdaRg+QYVwEZSVGL=w@mail.gmail.com>
 <452913cd-367e-6129-49e2-494951763ad9@treenet.co.nz>
Message-ID: <CADAqQfz9QP_rRYJut7HBRc7r-RQg__CAc9XQgACSr1SkpQORBA@mail.gmail.com>

By the help of God.

Amos,
This is how I'm splicing the ACL from above.

ssl_bump splice bypass

acl DiscoverSNIHost at_step SslBump1
ssl_bump peek DiscoverSNIHost

??????? ??? ??, 13 ????? 2023 ?-12:44 ??? ?Amos Jeffries?? <?
squid3 at treenet.co.nz??>:?

> On 13/07/23 20:29, Ben Goz wrote:
> > By the help of God.
> >
> > I'm trying to bypass chat.google.com domain
> > from my squid (with sslbump),
> > But still no success.
> >   I tried build acl using:
> >
> > acl bypass url_regex  -i chat.google.com
> >
> > and
> >
> > acl bypass ssl::server_name_regex -i chat.google.com
> >
> > And still I can see in the logs that chat.google.com
> > is bumped.
> >
> > What am I doing wrong?
>
>
> How are you using those ACL tests?
>
> Cheers
> Amos
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230716/ee28b625/attachment.htm>

From rousskov at measurement-factory.com  Sun Jul 16 13:43:14 2023
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Sun, 16 Jul 2023 09:43:14 -0400
Subject: [squid-users] ACL with a non-contiguous mask - using multiple
 outgoing addresses
In-Reply-To: <ZLPclgzeW8Or9ypj@thismonkey.com>
References: <ZLPclgzeW8Or9ypj@thismonkey.com>
Message-ID: <4f4ead52-0727-abb2-574b-51086c88d19d@measurement-factory.com>

On 7/16/23 08:03, Scott wrote:
> Hi all,
> 
> I have four IPv4s that I use for outgoing source addresses to origin servers.
> I currently have them used randomly, but this sometimes causes issues for
> certain sites that get confused if your source changes for various resources.
> For these sites I have an exception to the random IPs.
> 
> I decided to create the following acls which should match on the 2 low-order
> bits in the client addresses:
> 
> acl tm_src_v4_00 src 10.0.0.0 255.0.0.3

The above adds two IP addresses to the tm_src_v4_00 ACL: 10.0.0.0 and 
255.0.0.3.

Try this (untested but matching the documented syntax) instead:

     acl tm_src_v4_00 src 10.0.0.0/255.0.0.3


HTH,

Alex.


> acl tm_src_v4_01 src 10.0.0.1 255.0.0.3
> acl tm_src_v4_10 src 10.0.0.2 255.0.0.3
> acl tm_src_v4_11 src 10.0.0.3 255.0.0.3
> 
> tcp_outgoing_address 10.1.22.21 tm_src_v4_00
> tcp_outgoing_address 10.1.22.22 tm_src_v4_01
> tcp_outgoing_address 10.1.22.23 tm_src_v4_10
> tcp_outgoing_address 10.1.22.24 tm_src_v4_11
> 
> However I did not get the behaviour I was after, rather all clients use the
> same outgoing address.
> 
> Is there a way to share multiple outgoing IPs while maintaining consistency
> per-source?
> 
> Follow-up: can I do the same for IPv6 clients?
> 
> Thanks,
> Scott
> 
> PS: As an aside, the following ACL generated the following warning:
> 
> acl tm_src_11 src 0.0.0.3 0.0.0.3
> 
> Configuration for squid passes.
> 2023/07/15 23:38:40| WARNING: (B) '0.0.0.3' is a subnetwork of (A) '0.0.0.3'
> 2023/07/15 23:38:40| WARNING: because of this '0.0.0.3' is ignored to keep splay tree searching predictable
> 2023/07/15 23:38:40| WARNING: You should probably remove '0.0.0.3' from the ACL named 'tm_src_11'
> 
> Could someone please explain what the issue is with that ACL?  Thanks.
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users



From 3m9n51s2ewut at thismonkey.com  Mon Jul 17 12:28:16 2023
From: 3m9n51s2ewut at thismonkey.com (Scott)
Date: Mon, 17 Jul 2023 22:28:16 +1000
Subject: [squid-users] ACL with a non-contiguous mask - using multiple
 outgoing addresses
In-Reply-To: <mailman.2.1689595201.119160.squid-users@lists.squid-cache.org>
References: <mailman.2.1689595201.119160.squid-users@lists.squid-cache.org>
Message-ID: <ZLUz4DTcNHd4bxNN@thismonkey.com>

> On 7/16/23 08:03, Scott wrote:
> > Hi all,
> > 
> > I have four IPv4s that I use for outgoing source addresses to origin servers.
> > I currently have them used randomly, but this sometimes causes issues for
> > certain sites that get confused if your source changes for various resources.
> > For these sites I have an exception to the random IPs.
> > 
> > I decided to create the following acls which should match on the 2 low-order
> > bits in the client addresses:
> > 
> > acl tm_src_v4_00 src 10.0.0.0 255.0.0.3
> 
> The above adds two IP addresses to the tm_src_v4_00 ACL: 10.0.0.0 and 
> 255.0.0.3.
> 
> Try this (untested but matching the documented syntax) instead:
> 
>      acl tm_src_v4_00 src 10.0.0.0/255.0.0.3
> 
> 
> HTH,
> 
> Alex.
Thanks Alex,

I should have looked more closely at the doco :)

Unfortunately your suggestion didn't work: all clients ended up with same 
outgoing IP.

The warning in the logs gives the reason:
2023/07/17 22:19:28| WARNING: Netmasks are deprecated. Please use CIDR masks instead.
2023/07/17 22:19:28| WARNING: IPv4 netmasks are particularly nasty when used to compare IPv6 to IPv4 ranges.
2023/07/17 22:19:28| WARNING: For now we will assume you meant to write /8
2023/07/17 22:19:28| aclIpParseIpData: WARNING: Netmask masks away part of the specified IP in '10.0.0.3/255.0.0.3'

It's treating the mask as a /8.

So back to my problem statement - is there any way to use all four outgoing 
IPs (v4 and v6) with the clients tied to a consistent address?

Thanks,
Scott


From rousskov at measurement-factory.com  Mon Jul 17 13:30:23 2023
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Mon, 17 Jul 2023 09:30:23 -0400
Subject: [squid-users] ACL with a non-contiguous mask - using multiple
 outgoing addresses
In-Reply-To: <ZLUz4DTcNHd4bxNN@thismonkey.com>
References: <mailman.2.1689595201.119160.squid-users@lists.squid-cache.org>
 <ZLUz4DTcNHd4bxNN@thismonkey.com>
Message-ID: <39c563d4-b53c-2c04-f921-3f06ee44ab3b@measurement-factory.com>

On 7/17/23 08:28, Scott wrote:
>> On 7/16/23 08:03, Scott wrote:
>>> Hi all,
>>>
>>> I have four IPv4s that I use for outgoing source addresses to origin servers.
>>> I currently have them used randomly, but this sometimes causes issues for
>>> certain sites that get confused if your source changes for various resources.
>>> For these sites I have an exception to the random IPs.
>>>
>>> I decided to create the following acls which should match on the 2 low-order
>>> bits in the client addresses:
>>>
>>> acl tm_src_v4_00 src 10.0.0.0 255.0.0.3
>>
>> The above adds two IP addresses to the tm_src_v4_00 ACL: 10.0.0.0 and
>> 255.0.0.3.
>>
>> Try this (untested but matching the documented syntax) instead:
>>
>>       acl tm_src_v4_00 src 10.0.0.0/255.0.0.3

> Unfortunately your suggestion didn't work: all clients ended up with same
> outgoing IP.

Noted. I was only focusing on the wrong syntax. I did not check any 
other details and did not mean to imply that the above sketch should work.


> The warning in the logs gives the reason:
> 2023/07/17 22:19:28| WARNING: Netmasks are deprecated. Please use CIDR masks instead.
> 2023/07/17 22:19:28| WARNING: IPv4 netmasks are particularly nasty when used to compare IPv6 to IPv4 ranges.
> 2023/07/17 22:19:28| WARNING: For now we will assume you meant to write /8
> 2023/07/17 22:19:28| aclIpParseIpData: WARNING: Netmask masks away part of the specified IP in '10.0.0.3/255.0.0.3'
> 
> It's treating the mask as a /8.
> 
> So back to my problem statement - is there any way to use all four outgoing
> IPs (v4 and v6) with the clients tied to a consistent address?

If you cannot use CIDR masks suggested by the WARNING above (again, I 
have not checked any details, including whether they can be used for 
your use case), then you can (at, say, http_access time) use an external 
ACL that implements whatever mapping algorithm you want and annotates 
the transaction accordingly, so that you can check that annotation using 
"note" ACL at tcp_outgoing_address time.

There are relevant examples in the email thread referenced below (which 
uses "cache_peer_access" instead of your "tcp_outgoing_address", but 
those directives are similar as far as your use case is concerned).

http://lists.squid-cache.org/pipermail/squid-users/2023-April/025783.html


HTH,

Alex.



From franta at hanzlici.cz  Tue Jul 18 05:07:21 2023
From: franta at hanzlici.cz (Franta =?UTF-8?B?SGFuemzDrWs=?=)
Date: Tue, 18 Jul 2023 07:07:21 +0200
Subject: [squid-users] [EXTERNAL] Re: 4.0.23 -> 5.9 : ERROR: Failed to
 acquire TLS certificate '/etc/pki/tls/private/xy.pem': error:0480006C:PEM
 routines::no start line
In-Reply-To: <DM6PR10MB374048551AB3C0DE1501AB80B336A@DM6PR10MB3740.namprd10.prod.outlook.com>
References: <20230710205032.6aa3e4ef@franta.hanzlici.cz>
 <787e0ab2-48d4-99a6-16e2-031ddcf7eefc@measurement-factory.com>
 <DM6PR10MB374048551AB3C0DE1501AB80B336A@DM6PR10MB3740.namprd10.prod.outlook.com>
Message-ID: <20230718070721.2e25806f@franta.hanzlici.cz>

On Wed, 12 Jul 2023 07:09:35 +0000
Hannes Fasching <hfasching at barracuda.com> wrote:

> Hi!
> we had the same problem when we switched from openssl 1.1 to openssl 3 with certificates using the SHA1 algorithm for signature. The reason for this was in openssl 3 SHA1 is deprecated.
> 
> Kind regards,
> ?Hannes
> 
> 
> Von: squid-users <squid-users-bounces at lists.squid-cache.org>
> Gesendet: Dienstag, 11. Juli 2023 19:34
> An: squid-users at lists.squid-cache.org <squid-users at lists.squid-cache.org>
> Betreff: [EXTERNAL] Re: [squid-users] 4.0.23 -> 5.9 : ERROR: Failed to acquire TLS certificate '/etc/pki/tls/private/xy.pem': error:0480006C:PEM routines::no start line
> 
> On 7/10/23 14:50, Franta Hanzl?k wrote:
> > After upgrading my Fedora 27/Squid-4.0.23 to Fedora 38/Squid-5.9, the
> > Squid refuses to start with the error message:
> >
> > ERROR: Failed to acquire TLS certificate '/etc/pki/tls/private/server.pem': error:0480006C:PEM routines::no start line  
> 
> I suspect the actual problem is different than "no start line". Due to a
> mismatch between OpenSSL error handling approach and Squid code, Squid
> often reports wrong/stale/irrelevant OpenSSL errors. Certificate loading
> code is especially prone to such mismatches! Refactoring OpenSSL error
> handling is an known to-do item.
> 
> Several different things could go wrong while showing the above
> symptoms, and there are several ways to troubleshoot this, but I would
> start with the following simple test.
> 
> Run the following (or similar) command on the same machine as Squid,
> using the same OS user as Squid ("nobody" in the example below), using
> the openssl tool from the same OpenSSL version as Squid was built with:
> 
>      sudo -u nobody \
>      openssl x509 -in /etc/pki/tls/private/server.pem -noout -subject
> 
> You should see the certificate subject field. Any warnings or errors?
> 
> If the above works fine, and the certificate file ownership/permissions
> look reasonable to you, then the next step could be to start Squid under
> "strace" or a similar tool to check whether some system call fails when
> OpenSSL is trying to load that certificate file. In most cases, you
> should be able to find the certificate filename in strace output and
> check for subsequent syscall errors (e.g., permission denied). We can
> help with that analysis, but be careful with posting private key
> contents. If you can, temporary replace that production certificate with
> some throw-away/temporary/example one.
> 
> Beyond that, I would recommend patching Squid to report the last OpenSSL
> error instead of the first one (in this context). This will require you
> to rebuild your Squid from sources. Please let me know if you want to
> pursue that and I will provide a patch.
> 
> 
> HTH,
> 
> Alex.
> 
> > The problem is probably related to the reverse https proxy definition
> > line in squid.conf :
> > https_port 192.168.20.2:22225 accel cert=/etc/pki/tls/private/server.pem defaultsite=mail.kyenar.cz no-vhost name=reverzpe  
> 
> > server.pem is the symlink to realFile.pem with this content:
> > -----BEGIN RSA PRIVATE KEY-----
> > MIIEpQ...
> > ...
> > ...vo=
> > -----END RSA PRIVATE KEY-----
> >
> > -----BEGIN CERTIFICATE-----
> > MIIGO...
> > ...
> > ...c5s=
> > -----END CERTIFICATE-----
> >
> > and it worked fine in the older Squid-4.0.23 version.
> >
> > I tried:
> > - tls-cert= instead of cert=
> > - replacing the symlink server.pem with a real file.
> > - arrange certificate in PEM file as first and key second
> > - split PEM file into separate certificate and key and use it with syntax:
> >
> > https_port 192.168.20.2:22225 accel tls-cert=/etc/pki/tls/private/cert.pem tls-key=/etc/pki/tls/private/key.pem defaultsite=mail.kyenar.cz no-vhost name=reverzpe
> >
> > but squid still not start with this same message:
> > ERROR: Failed to acquire TLS certificate '/etc/pki/tls/private/cert.pem': error:0480006C:PEM routines::no start line
> >
> > Can anyone help?
> > ---
> > Thanks in advance! Franta Hanzlik
> > _______________________________________________
> _______________________________________________


Hi Karl, you hit the spot - my 2015 certificate used SHA1 algorithm.
And after generating a new one using sha256, the SQUID works correctly.
Big thanks!

Alex, thanks too for the nice systematic approach to solving the problem!
Thank you very much!
---
Franta Hanzl?k


From swayzone at skrilltech84.org  Tue Jul 18 05:19:24 2023
From: swayzone at skrilltech84.org (Mark Kenna)
Date: Tue, 18 Jul 2023 15:19:24 +1000
Subject: [squid-users] New blood
Message-ID: <CAJo-8GiTkO5rbxGBx+wK1CvBigZ2vMPHP87z7Y+RTwdAp=PWhA@mail.gmail.com>

Hi all, I'm very new been struggling to lean how to do all of this can I
get a few pointer please
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230718/f955b62c/attachment.htm>

From my.shellac at gmail.com  Thu Jul 20 06:11:57 2023
From: my.shellac at gmail.com (=?UTF-8?B?QWxleGV50Y/RgCBHcnV6ZG92?=)
Date: Thu, 20 Jul 2023 11:11:57 +0500
Subject: [squid-users] Dstdomain from external ACL
Message-ID: <CAFqyDwAP4qmOiGNgfk6ZhcmSN2bu3GP01BROfakw0M5Fs_yD+Q@mail.gmail.com>

Hello guys!

Could you explain to me the best way - how to get the list of domain names
from some external acl and use it in squid.conf for policy? I looked how to
get it working using the external file, but I need to use a script (as
example to save the url in DB).
I need to understand the format of the answer from the external helper
script - what it must be?

Thanks.
Alexey
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230720/82123382/attachment.htm>

From my.shellac at gmail.com  Thu Jul 20 12:23:07 2023
From: my.shellac at gmail.com (=?UTF-8?B?QWxleGV50Y/RgCBHcnV6ZG92?=)
Date: Thu, 20 Jul 2023 17:23:07 +0500
Subject: [squid-users] Dstdomain from external ACL
In-Reply-To: <CAFqyDwAP4qmOiGNgfk6ZhcmSN2bu3GP01BROfakw0M5Fs_yD+Q@mail.gmail.com>
References: <CAFqyDwAP4qmOiGNgfk6ZhcmSN2bu3GP01BROfakw0M5Fs_yD+Q@mail.gmail.com>
Message-ID: <CAFqyDwAriGaC+zz6OhsWucfFVWWz3m9yJh0Rn=NmYTiisDuRkw@mail.gmail.com>

Hello.

Looks I found how to do that and this works well for me:

The external helper script must check if the url is in DB and answer as OK
(if there is) or ERR (if there isnt)


Best regards
Alexey

??, 20 ???. 2023??. ? 11:11, Alexey?? Gruzdov <my.shellac at gmail.com>:

> Hello guys!
>
> Could you explain to me the best way - how to get the list of domain names
> from some external acl and use it in squid.conf for policy? I looked how to
> get it working using the external file, but I need to use a script (as
> example to save the url in DB).
> I need to understand the format of the answer from the external helper
> script - what it must be?
>
> Thanks.
> Alexey
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230720/55531b6c/attachment.htm>

From rousskov at measurement-factory.com  Thu Jul 20 13:27:29 2023
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Thu, 20 Jul 2023 09:27:29 -0400
Subject: [squid-users] Dstdomain from external ACL
In-Reply-To: <CAFqyDwAriGaC+zz6OhsWucfFVWWz3m9yJh0Rn=NmYTiisDuRkw@mail.gmail.com>
References: <CAFqyDwAP4qmOiGNgfk6ZhcmSN2bu3GP01BROfakw0M5Fs_yD+Q@mail.gmail.com>
 <CAFqyDwAriGaC+zz6OhsWucfFVWWz3m9yJh0Rn=NmYTiisDuRkw@mail.gmail.com>
Message-ID: <868ab013-049d-79b2-33da-5edad5bfbdff@measurement-factory.com>

On 7/20/23 08:23, Alexey?? Gruzdov wrote:
> Hello.
> 
> Looks I found how to do that and this works well for me:
> 
> The external helper script must check if the url is in DB and answer as 
> OK (if there is) or ERR (if there isnt)


External ACL helper protocol is documented at
https://wiki.squid-cache.org/Features/AddonHelpers#access-control-acl

Alex.


> ??, 20 ???. 2023??. ? 11:11, Alexey?? Gruzdov <my.shellac at gmail.com 
> <mailto:my.shellac at gmail.com>>:
> 
>     Hello guys!
> 
>     Could you explain to me the best way - how to get the list of domain
>     names from some external?acl and use it in squid.conf for policy? I
>     looked?how?to get it working using the external file,?but I need?to
>     use a?script (as example to save the url?in DB).
>     I need to understand the format of the answer from the external
>     helper script - what it must be?
> 
>     Thanks.
>     Alexey
> 
> 
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users



From marc.morad at fabasoft.com  Fri Jul 21 08:46:16 2023
From: marc.morad at fabasoft.com (Morad, Marc)
Date: Fri, 21 Jul 2023 08:46:16 +0000
Subject: [squid-users] Squid Proxy - Block Access Why ?
Message-ID: <5550c827fba944e995dabacada5069ca@fabasoft.com>

Hello squid experts,

I have a question and I'm not quite sure if this is normal default behaviour or part of my squid configuration. 

The scenario is like this: 

I am sending a request from Server A (IP: 192.10.16.20) via the squid proxy to Server B (IP: 192.10.16.21) in the same internal Subnet (192.10.16.0/22). 
This request is getting blocked, which is a behaviour we want to have.
Why is it like that ? I read through all my configuration settings and looked what they do but cannot find a definite answer to that.

Kind regards,

Marc


From rousskov at measurement-factory.com  Fri Jul 21 14:21:09 2023
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Fri, 21 Jul 2023 10:21:09 -0400
Subject: [squid-users] Squid Proxy - Block Access Why ?
In-Reply-To: <5550c827fba944e995dabacada5069ca@fabasoft.com>
References: <5550c827fba944e995dabacada5069ca@fabasoft.com>
Message-ID: <c5b4c4e6-71ae-13e0-7f58-88969fbce7d8@measurement-factory.com>

On 7/21/23 04:46, Morad, Marc wrote:

> I am sending a request from Server A (IP: 192.10.16.20) via the squid
> proxy to Server B (IP: 192.10.16.21) in the same internal Subnet
> (192.10.16.0/22). This request is getting blocked, which is a
> behaviour we want to have. Why is it like that ? I read through all
> my configuration settings and looked what they do but cannot find a
> definite answer to that.

In most cases where Squid denies a request, that request matches an 
"http_access deny" rule. That rule may be implicit or explicit. Without 
seeing your configuration or debugging (combined with request details), 
it is impossible to tell you which deny rule (if any) matched the 
request in question.

One way to make progress here if for you to post your http_access rules 
and explain which "http_access allow" rule you expect the request to 
match (and _why_). We may be able to find a flaw in that explanation.

See also:

* https://wiki.squid-cache.org/SquidFaq/SquidAcl#access-lists

* 
https://wiki.squid-cache.org/SquidFaq/SquidAcl#how-do-i-allow-my-clients-to-use-the-cache


HTH,

Alex.



From squid3 at treenet.co.nz  Fri Jul 21 23:50:37 2023
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Sat, 22 Jul 2023 11:50:37 +1200
Subject: [squid-users] New blood
In-Reply-To: <CAJo-8GiTkO5rbxGBx+wK1CvBigZ2vMPHP87z7Y+RTwdAp=PWhA@mail.gmail.com>
References: <CAJo-8GiTkO5rbxGBx+wK1CvBigZ2vMPHP87z7Y+RTwdAp=PWhA@mail.gmail.com>
Message-ID: <96694d00-1d7d-3bb9-4633-ef3a060ac5f2@treenet.co.nz>

On 18/07/23 17:19, Mark Kenna wrote:
> Hi all, I'm very new been struggling to lean how to do all of this can I 
> get a few pointer please
> 

Hi Mark,
  welcome to the Squid community.

First off, do you have any particular goals you are trying to make Squid 
perform?

For general knowledge about Squid capabilities and features you can 
explore the Squid wiki at <https://wiki.squid-cache.org>. It has a wide 
range of age, but can give you a basic idea of the types of things you 
might use Squid for in your network.

Amos


From squid3 at treenet.co.nz  Sat Jul 22 05:00:07 2023
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Sat, 22 Jul 2023 17:00:07 +1200
Subject: [squid-users] Dstdomain from external ACL
In-Reply-To: <CAFqyDwAriGaC+zz6OhsWucfFVWWz3m9yJh0Rn=NmYTiisDuRkw@mail.gmail.com>
References: <CAFqyDwAP4qmOiGNgfk6ZhcmSN2bu3GP01BROfakw0M5Fs_yD+Q@mail.gmail.com>
 <CAFqyDwAriGaC+zz6OhsWucfFVWWz3m9yJh0Rn=NmYTiisDuRkw@mail.gmail.com>
Message-ID: <0ebd0b6d-8d4f-b2bb-577c-96fb046c51df@treenet.co.nz>

On 21/07/23 00:23, Alexey?? Gruzdov wrote:
> Hello.
> 
> Looks I found how to do that and this works well for me:
> 
> The external helper script must check if the url is in DB and answer as 
> OK (if there is) or ERR (if there isnt)
> 

You can probably use the ext_sql_session_acl helper bundled with Squid 
instead of writing your own from scratch.
See 
<http://www.squid-cache.org/Versions/v4/manuals/ext_sql_session_acl.html> 
for its parameters.

AIUI, you want the --uidcol to be the table of URLs and leave both 
--usercol and --tagcol unset.


Amos


From my.shellac at gmail.com  Sat Jul 22 05:20:58 2023
From: my.shellac at gmail.com (=?UTF-8?B?QWxleGV50Y/RgCBHcnV6ZG92?=)
Date: Sat, 22 Jul 2023 10:20:58 +0500
Subject: [squid-users] Dstdomain from external ACL
In-Reply-To: <0ebd0b6d-8d4f-b2bb-577c-96fb046c51df@treenet.co.nz>
References: <CAFqyDwAP4qmOiGNgfk6ZhcmSN2bu3GP01BROfakw0M5Fs_yD+Q@mail.gmail.com>
 <CAFqyDwAriGaC+zz6OhsWucfFVWWz3m9yJh0Rn=NmYTiisDuRkw@mail.gmail.com>
 <0ebd0b6d-8d4f-b2bb-577c-96fb046c51df@treenet.co.nz>
Message-ID: <CAFqyDwDV0V6Ae6Qxosi-_ayxJgAjyVvZmD4LOpkMYem76gdbhQ@mail.gmail.com>

Wow?
Thank you so much !

For now I used a simple .py script that checks if url is in table and send
reply OK or ERR, depends from result.

But allow ask you - how squid parse the url???
I think it uses the regexp, is that true???

Because for example if I add the url to DB like example.com ( base url name)
And if the proxy request will be even like to  example.com/page1/ - this
will be matched. That?s great.


Thank you !
Alexey G.

On Sat, 22 Jul 2023 at 10:00, Amos Jeffries <squid3 at treenet.co.nz> wrote:

> On 21/07/23 00:23, Alexey?? Gruzdov wrote:
> > Hello.
> >
> > Looks I found how to do that and this works well for me:
> >
> > The external helper script must check if the url is in DB and answer as
> > OK (if there is) or ERR (if there isnt)
> >
>
> You can probably use the ext_sql_session_acl helper bundled with Squid
> instead of writing your own from scratch.
> See
> <http://www.squid-cache.org/Versions/v4/manuals/ext_sql_session_acl.html>
> for its parameters.
>
> AIUI, you want the --uidcol to be the table of URLs and leave both
> --usercol and --tagcol unset.
>
>
> Amos
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230722/1d8b833e/attachment.htm>

From squid3 at treenet.co.nz  Sat Jul 22 07:12:23 2023
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Sat, 22 Jul 2023 19:12:23 +1200
Subject: [squid-users] Dstdomain from external ACL
In-Reply-To: <CAFqyDwDV0V6Ae6Qxosi-_ayxJgAjyVvZmD4LOpkMYem76gdbhQ@mail.gmail.com>
References: <CAFqyDwAP4qmOiGNgfk6ZhcmSN2bu3GP01BROfakw0M5Fs_yD+Q@mail.gmail.com>
 <CAFqyDwAriGaC+zz6OhsWucfFVWWz3m9yJh0Rn=NmYTiisDuRkw@mail.gmail.com>
 <0ebd0b6d-8d4f-b2bb-577c-96fb046c51df@treenet.co.nz>
 <CAFqyDwDV0V6Ae6Qxosi-_ayxJgAjyVvZmD4LOpkMYem76gdbhQ@mail.gmail.com>
Message-ID: <569cccbd-c391-5929-3de4-39e806cb0b5e@treenet.co.nz>

On 22/07/23 17:20, Alexey?? Gruzdov wrote:
> Wow?
> Thank you?so much !
> 
> For now I used a simple .py script that checks if url is in table and 
> send reply OK or ERR, depends from result.
> 
> But allow ask you - how squid parse the url???
> I think it uses the regexp, is that true???

All parsers in the 'squid' binary perform full parse with validation.


> 
> Because for example if I add the url to DB like example.com 
> ( base url name)
> And if the proxy request will be even like to example.com/page1/ 
>  - this will be matched. That?s great.
> 

Oh, there are many moving parts involved there.

First is the HTTP request URL that Squid received, it could be any of 
origin-form, authority-form, or relative-url.

(... probably you configured Squid to only send the URL domain name to 
the helper.)

Second is what details you configured the external_acl_type directive to 
pass on.

Third is how the helper receives its input. The helper I suggested uses 
Perl string split to separate the concurrency channel-ID from the UID 
portion and pack("H*",...) for binary safety.

Fourth is how the helper is using its input to lookup the database.
  The helper I suggested uses SQL "=" operator, whose matching is 
string-wise exact equality.

As far as I know only the Perl string split is potentially using regex, 
but not in any way which would case the behaviour you describe.

If you are still using your own custom helper, look into how it is doing 
those third and fourth things.


HTH
Amos


From hsv at energy.dk  Sat Jul 22 23:57:54 2023
From: hsv at energy.dk (Henning Svane)
Date: Sat, 22 Jul 2023 23:57:54 +0000
Subject: [squid-users] How to build Squid 6
In-Reply-To: <87e3c9d46b5a49549ebfd843b88a443f@energy.dk>
References: <78f0ecdf721e40b092e263f173bd4881@energy.dk>
 <6cacd36d-2c16-a034-56b8-8f163630f8b4@measurement-factory.com>
 <87e3c9d46b5a49549ebfd843b88a443f@energy.dk>
Message-ID: <471b7b6f037940309684be4172a7fda3@energy.dk>

Hi Alex

I have now followed the instruction below.
All compiling and building was done without problems.

When I run
sudo systemctl status squid
I get this message
Unit squid.service could not be found.
And /usr/sbin/squid do not exist

What do I miss?

I can see that the directory /etc/squid is not create I guess I have to make it myself, correct?
Can I used the old files from the old 5.2 installation?

Regards
Henning

PS Here is the steps I used

sudo apt-get update
sudo apt install build-essential       # to install C++
sudo sed --in-place -E 's/# (deb-src.*updates main)/  \1/g' \ /etc/apt/sources.list sudo apt-get update sudo apt-get build-dep squid sudo apt-get install linuxdoc-tools sudo apt-get upgrade wget http://www.squid-cache.org/Versions/v6/squid-6.1.tar.gz
tar -xzvf squid-6.1.tar.gz
cd squid-6.1
./configure --with-openssl
make -j2
sudo make install



-----Oprindelig meddelelse-----
Fra: squid-users <squid-users-bounces at lists.squid-cache.org> P? vegne af Alex Rousskov
Sendt: 15. juli 2023 04:31
Til: squid-users at lists.squid-cache.org
Emne: Re: [squid-users] How to build Squid 6

On 7/14/23 19:07, Henning Svane wrote:

> I try to find a how to build Squid 6 on Ubuntu 22.04 (Jammy)

To build Squid v6 on Ubuntu from a source tarball with many optional features enabled, consider using the same commands that Squid CI tests are using:

     # deb-src sources are required for "apt-get build-dep" below,
     # but you may find a better way to enable them in
     # /etc/apt/sources.list, or you may already have them enabled
     sudo sed --in-place -E 's/# (deb-src.*updates main)/  \1/g' \
         /etc/apt/sources.list
     sudo apt-get update

     # install various prerequisites and optional dependencies
     sudo apt-get build-dep squid
     sudo apt-get install linuxdoc-tools

     # download and unpack Squid sources; if you want a more secure
     # option, use the official git repository instead; our CI commands
     # use the git repository, not wget
     wget http://www.squid-cache.org/Versions/v6/squid-6.1.tar.gz
     tar -vzf squid-6.1.tar.gz

     cd squid-6.1

     # this step is not necessary when using bootstrapped sources
     # as shown by the wget command above; this step is necessary
     # if you get Squid sources from git
     ./bootstrap.sh

     # you do not have to specify --with-openssl but if you need
     # SslBump features, you should specify it (IMHO);
     # see ./configure --help for many other options
     ./configure --with-openssl

     # if you have n CPU cores available, then use "make -jn" or
     # some such to speed the build up
     make

     # this will install Squid into default directories unless
     # you customize that during the ./configure step above
     sudo make install


HTH,

Alex.



> I have read the compile/build instruction on the Wiki
> 
> Compiling Squid | Squid Web Cache wiki (squid-cache.org) 
> <https://wiki.squid-cache.org/SquidFaq/CompilingSquid>
> 
> But I am not sure to do it after read the explanation.
> 
> I have also looked at the build ?example? from the
> 
> dockerfiles/ubuntu-jammy/Dockerfile at master ? kinkie/dockerfiles ? 
> GitHub 
> <https://github.com/kinkie/dockerfiles/blob/master/ubuntu-jammy/Docker
> file>
> 
> I have searched for a how to without luck.
> 
> So do any one know where to find a description or how to.
> 
> Regards
> 
> Henning
> 
> 
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users

_______________________________________________
squid-users mailing list
squid-users at lists.squid-cache.org
http://lists.squid-cache.org/listinfo/squid-users

From hsv at energy.dk  Sun Jul 23 00:01:03 2023
From: hsv at energy.dk (Henning Svane)
Date: Sun, 23 Jul 2023 00:01:03 +0000
Subject: [squid-users] How to build Squid 6
In-Reply-To: <5e30ef5d-8f35-c528-8c35-f57161738a72@measurement-factory.com>
References: <78f0ecdf721e40b092e263f173bd4881@energy.dk>
 <6cacd36d-2c16-a034-56b8-8f163630f8b4@measurement-factory.com>
 <87e3c9d46b5a49549ebfd843b88a443f@energy.dk>
 <5e30ef5d-8f35-c528-8c35-f57161738a72@measurement-factory.com>
Message-ID: <20ed63ef72614b25a5b05db39c176cf4@energy.dk>

Hi Alex
I realized it after I hit send. I have already resend it.
Sorry.

Regards
Henning


-----Oprindelig meddelelse-----
Fra: Alex Rousskov <rousskov at measurement-factory.com> 
Sendt: 23. juli 2023 01:57
Til: Henning Svane <hsv at energy.dk>
Emne: Re: SV: [squid-users] How to build Squid 6

For free Squid support, please keep the conversation on the mailing list, where others may benefit from the discussion. Thank you! --Alex.



On 7/22/23 19:39, Henning Svane wrote:
> Hi Alex
> 
> I have now followed the instruction below
> All compiling and building was done without problems.
> 
> When I run
> sudo systemctl status squid
> I get this message
> Unit squid.service could not be found.
> 
> What do I miss?
> 
> I can see that the directory /etc/squid is not create I guess I have to make it myself, correct?
> Can I used the old files from the old 5.2 installation?
> 
> Regards
> Henning
> 
> PS Here is the steps I used
> 
> sudo apt-get update
> sudo apt install build-essential       # to install C++
> sudo sed --in-place -E 's/# (deb-src.*updates main)/  \1/g' \ /etc/apt/sources.list
> sudo apt-get update
> sudo apt-get build-dep squid
> sudo apt-get install linuxdoc-tools
> sudo apt-get upgrade
> wget http://www.squid-cache.org/Versions/v6/squid-6.1.tar.gz
> tar -xzvf squid-6.1.tar.gz
> cd squid-6.1
> ./configure --with-openssl
> make -j2
> sudo make install
> 
> 
> 
> -----Oprindelig meddelelse-----
> Fra: squid-users <squid-users-bounces at lists.squid-cache.org> P? vegne af Alex Rousskov
> Sendt: 15. juli 2023 04:31
> Til: squid-users at lists.squid-cache.org
> Emne: Re: [squid-users] How to build Squid 6
> 
> On 7/14/23 19:07, Henning Svane wrote:
> 
>> I try to find a how to build Squid 6 on Ubuntu 22.04 (Jammy)
> 
> To build Squid v6 on Ubuntu from a source tarball with many optional features enabled, consider using the same commands that Squid CI tests are using:
> 
>       # deb-src sources are required for "apt-get build-dep" below,
>       # but you may find a better way to enable them in
>       # /etc/apt/sources.list, or you may already have them enabled
>       sudo sed --in-place -E 's/# (deb-src.*updates main)/  \1/g' \
>           /etc/apt/sources.list
>       sudo apt-get update
> 
>       # install various prerequisites and optional dependencies
>       sudo apt-get build-dep squid
>       sudo apt-get install linuxdoc-tools
> 
>       # download and unpack Squid sources; if you want a more secure
>       # option, use the official git repository instead; our CI commands
>       # use the git repository, not wget
>       wget http://www.squid-cache.org/Versions/v6/squid-6.1.tar.gz
>       tar -vzf squid-6.1.tar.gz
> 
>       cd squid-6.1
> 
>       # this step is not necessary when using bootstrapped sources
>       # as shown by the wget command above; this step is necessary
>       # if you get Squid sources from git
>       ./bootstrap.sh
> 
>       # you do not have to specify --with-openssl but if you need
>       # SslBump features, you should specify it (IMHO);
>       # see ./configure --help for many other options
>       ./configure --with-openssl
> 
>       # if you have n CPU cores available, then use "make -jn" or
>       # some such to speed the build up
>       make
> 
>       # this will install Squid into default directories unless
>       # you customize that during the ./configure step above
>       sudo make install
> 
> 
> HTH,
> 
> Alex.
> 
> 
> 
>> I have read the compile/build instruction on the Wiki
>>
>> Compiling Squid | Squid Web Cache wiki (squid-cache.org)
>> <https://wiki.squid-cache.org/SquidFaq/CompilingSquid>
>>
>> But I am not sure to do it after read the explanation.
>>
>> I have also looked at the build ?example? from the
>>
>> dockerfiles/ubuntu-jammy/Dockerfile at master ? kinkie/dockerfiles ?
>> GitHub
>> <https://github.com/kinkie/dockerfiles/blob/master/ubuntu-jammy/Docker
>> file>
>>
>> I have searched for a how to without luck.
>>
>> So do any one know where to find a description or how to.
>>
>> Regards
>>
>> Henning
>>
>>
>> _______________________________________________
>> squid-users mailing list
>> squid-users at lists.squid-cache.org
>> http://lists.squid-cache.org/listinfo/squid-users
> 
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users


From squid3 at treenet.co.nz  Sun Jul 23 09:49:23 2023
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Sun, 23 Jul 2023 21:49:23 +1200
Subject: [squid-users] How to build Squid 6
In-Reply-To: <471b7b6f037940309684be4172a7fda3@energy.dk>
References: <78f0ecdf721e40b092e263f173bd4881@energy.dk>
 <6cacd36d-2c16-a034-56b8-8f163630f8b4@measurement-factory.com>
 <87e3c9d46b5a49549ebfd843b88a443f@energy.dk>
 <471b7b6f037940309684be4172a7fda3@energy.dk>
Message-ID: <277667fa-e6af-c7ee-605b-ed53dbf2422a@treenet.co.nz>

On 23/07/23 11:57, Henning Svane wrote:
> Hi Alex
> 
> I have now followed the instruction below.
> All compiling and building was done without problems.
> 
> When I run
> sudo systemctl status squid
> I get this message
> Unit squid.service could not be found.
> And /usr/sbin/squid do not exist
> 
> What do I miss?
> 

The instructions Alex gave will build Squid under a /usr/local directory.

To have Squid installed where the system package would put it you need 
these ./configure options:

--prefix=/usr \
--localstatedir=/var \
--libexecdir=${prefix}/lib/squid \
--datadir=${prefix}/share/squid \
--sysconfdir=/etc/squid \
--with-default-user=proxy \
--with-logdir=/var/log/squid \
--with-pidfile=/run/squid.pid




> I can see that the directory /etc/squid is not create I guess I have to make it myself, correct?
> Can I used the old files from the old 5.2 installation?
> 
If you wish to use the old config yes. Run "squid -k parse" first to see 
if there are any updates needed with the new version.

The /usr/lib/systemd/system/squid.service file from 5.2 might work, or 
you can also try the Debian 13 one attached.

HTH
Amos
-------------- next part --------------
A non-text attachment was scrubbed...
Name: squid.service
Type: text/x-dbus-service
Size: 703 bytes
Desc: not available
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230723/8c01b6b9/attachment.bin>

From my.shellac at gmail.com  Mon Jul 24 05:26:39 2023
From: my.shellac at gmail.com (=?UTF-8?B?QWxleGV50Y/RgCBHcnV6ZG92?=)
Date: Mon, 24 Jul 2023 10:26:39 +0500
Subject: [squid-users] Dstdomain from external ACL
In-Reply-To: <569cccbd-c391-5929-3de4-39e806cb0b5e@treenet.co.nz>
References: <CAFqyDwAP4qmOiGNgfk6ZhcmSN2bu3GP01BROfakw0M5Fs_yD+Q@mail.gmail.com>
 <CAFqyDwAriGaC+zz6OhsWucfFVWWz3m9yJh0Rn=NmYTiisDuRkw@mail.gmail.com>
 <0ebd0b6d-8d4f-b2bb-577c-96fb046c51df@treenet.co.nz>
 <CAFqyDwDV0V6Ae6Qxosi-_ayxJgAjyVvZmD4LOpkMYem76gdbhQ@mail.gmail.com>
 <569cccbd-c391-5929-3de4-39e806cb0b5e@treenet.co.nz>
Message-ID: <CAFqyDwDY-rDUFvtPmEnUFQe4e+WZcpS8O43Xt-PFqWTBVrUJDg@mail.gmail.com>

Hello!

For get it worked I used the next things:

1. In squid.conf
      external_acl_type ext_proxy_url_acl_type ttl=10 children-max=30
children-startup=5 ipv4 %LOGIN %DST /etc/squid/ext_helper/ext_acl_urls.py
2. Inside of my acl_url_direct.conf
                   acl proxy_direct_url_mark_acl external
ext_proxy_url_acl_type
                   acl proxy_direct_url_acl note url_name passed
3. Inside of http_acces.conf

                   http_access deny proxy_direct_url_mark_acl !all

4. The my owned helper reads the incoming arguments like login and dst url
and then checks url in the DB,  then replies something like:
                 OK url_name=passed   (if url is in DB)
                     or
                 ERR
   And of course If I got the OK I can use the acl  called
"proxy_direct_url_acl" in policy I wanted.

My case as a whole is to pass the URL to the  cache_peers, but some URL
must be proxying  on the server (without forwarding to the cache_peers).
This was so curious to know how the squid parses these URL's (to prevent
the problems in the future).



Best Regards.
Alexey

??, 22 ???. 2023??. ? 12:12, Amos Jeffries <squid3 at treenet.co.nz>:

> On 22/07/23 17:20, Alexey?? Gruzdov wrote:
> > Wow?
> > Thank you so much !
> >
> > For now I used a simple .py script that checks if url is in table and
> > send reply OK or ERR, depends from result.
> >
> > But allow ask you - how squid parse the url???
> > I think it uses the regexp, is that true???
>
> All parsers in the 'squid' binary perform full parse with validation.
>
>
> >
> > Because for example if I add the url to DB like example.com
> > ( base url name)
> > And if the proxy request will be even like to example.com/page1/
> >  - this will be matched. That?s great.
> >
>
> Oh, there are many moving parts involved there.
>
> First is the HTTP request URL that Squid received, it could be any of
> origin-form, authority-form, or relative-url.
>
> (... probably you configured Squid to only send the URL domain name to
> the helper.)
>
> Second is what details you configured the external_acl_type directive to
> pass on.
>
> Third is how the helper receives its input. The helper I suggested uses
> Perl string split to separate the concurrency channel-ID from the UID
> portion and pack("H*",...) for binary safety.
>
> Fourth is how the helper is using its input to lookup the database.
>   The helper I suggested uses SQL "=" operator, whose matching is
> string-wise exact equality.
>
> As far as I know only the Perl string split is potentially using regex,
> but not in any way which would case the behaviour you describe.
>
> If you are still using your own custom helper, look into how it is doing
> those third and fourth things.
>
>
> HTH
> Amos
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230724/70e80990/attachment.htm>

From marc.morad at fabasoft.com  Mon Jul 24 10:47:06 2023
From: marc.morad at fabasoft.com (Morad, Marc)
Date: Mon, 24 Jul 2023 10:47:06 +0000
Subject: [squid-users] Squid Proxy - Block Access Why ?
In-Reply-To: <c5b4c4e6-71ae-13e0-7f58-88969fbce7d8@measurement-factory.com>
References: <5550c827fba944e995dabacada5069ca@fabasoft.com>
 <c5b4c4e6-71ae-13e0-7f58-88969fbce7d8@measurement-factory.com>
Message-ID: <ceedd224b0cb4e23bb786c80832e901a@fabasoft.com>

Hello Alex,

thanks for your answer !

We did some more testing and apparently did some things wrong while testing. We now have our solution we need. 

Kind regards,
Marc

-----Urspr?ngliche Nachricht-----
Von: squid-users <squid-users-bounces at lists.squid-cache.org> Im Auftrag von Alex Rousskov
Gesendet: Freitag, 21. Juli 2023 16:21
An: squid-users at lists.squid-cache.org
Betreff: Re: [squid-users] Squid Proxy - Block Access Why ?

On 7/21/23 04:46, Morad, Marc wrote:

> I am sending a request from Server A (IP: 192.10.16.20) via the squid 
> proxy to Server B (IP: 192.10.16.21) in the same internal Subnet 
> (192.10.16.0/22). This request is getting blocked, which is a 
> behaviour we want to have. Why is it like that ? I read through all my 
> configuration settings and looked what they do but cannot find a 
> definite answer to that.

In most cases where Squid denies a request, that request matches an "http_access deny" rule. That rule may be implicit or explicit. Without seeing your configuration or debugging (combined with request details), it is impossible to tell you which deny rule (if any) matched the request in question.

One way to make progress here if for you to post your http_access rules and explain which "http_access allow" rule you expect the request to match (and _why_). We may be able to find a flaw in that explanation.

See also:

* https://wiki.squid-cache.org/SquidFaq/SquidAcl#access-lists

*
https://wiki.squid-cache.org/SquidFaq/SquidAcl#how-do-i-allow-my-clients-to-use-the-cache


HTH,

Alex.

_______________________________________________
squid-users mailing list
squid-users at lists.squid-cache.org
http://lists.squid-cache.org/listinfo/squid-users


From magri at web.de  Wed Jul 26 15:25:18 2023
From: magri at web.de (magri at web.de)
Date: Wed, 26 Jul 2023 17:25:18 +0200
Subject: [squid-users] Stack overflow with large IP lists
Message-ID: <bae25019-58e0-a19b-8315-ff0809c1cd0d@web.de>

Hi squid community,

we experience segfaults with squid 6.1 (and also older versions) during
"squid -k reconfigure" on several linux systems, caused by a stack overflow.

The circumstances are rather special:

- we have a huge dst ip blacklist (> 300.000 enties)
- this original list is sorted (by raw ip value)
- the proxy is a hot standby system so there are no client requests
   between start of squid and reconfigure

We could trace the cause of the segfault to the destroy-method of
SplayNode (in include/splay.h):
- destroy of the top node is run on every reconfigure
- destroy is recursive, so the function calls stack on the stack :-)
   up to the depth of the splay tree
- the insertion of an ordered ip list into the splay tree creates a
   degenerate splay tree (each node has only a left child) with a depth
   of the number of ip entries in the list
- due to the inactivity of the proxy there is no rebalancing of the
   tree through find calls

On amd64 every stack frame needs 32 byte. So the regular linux stack of
8 MB can hold about ~262.000 stack frames. On other architectures
the limit is reached even faster (s390x: 160 bytes per stack frame ->
52.000 frames).

We tried to increase the stack size via ulimits and systemd, but though
the squid master process got the increased limits, the kid-processes are
always spawned with a soft limit of 8 MB and crash on reaching it.
Only forcing a new soft limit via prlimit on an already running kid
could avoid the crash.

I've attached a patch that modifies the destroy method of SplayNode to
avoid recursive calls of destroy in single child nodes by moving the
subtrees of the child to the parent node before destroying the child non
recursively.
With this patch we could no longer reproduce the segfaults, even with a
list of 10.000.000 ordered ips.

Any ideas, comments, better solutions?

Thanks in advance for any advice.

best regards
  Martin











-------------- next part --------------
A non-text attachment was scrubbed...
Name: splaynode_destroy_workaround.patch
Type: text/x-patch
Size: 1283 bytes
Desc: not available
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230726/f41bc228/attachment.bin>

From rousskov at measurement-factory.com  Wed Jul 26 16:22:21 2023
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Wed, 26 Jul 2023 12:22:21 -0400
Subject: [squid-users] Stack overflow with large IP lists
In-Reply-To: <bae25019-58e0-a19b-8315-ff0809c1cd0d@web.de>
References: <bae25019-58e0-a19b-8315-ff0809c1cd0d@web.de>
Message-ID: <83a4285a-3c1b-8ea1-507e-fd2d51631eca@measurement-factory.com>

On 7/26/23 11:25, magri at web.de wrote:

> I've attached a patch that modifies the destroy method of SplayNode
> to avoid recursive calls of destroy in single child nodes by moving
> the subtrees of the child to the parent node before destroying the
> child non recursively.

Hi Martin,

     Thanks a lot for sharing your well-documented fix! Would you be 
willing to post it as a GitHub Pull Request? If you do, then the 
following questions can be discussed on GitHub instead:

* The patch reduces recursion during tree destruction. Squid splay tree 
implementation contains other recursive operations (e.g., visit()). 
Would not those other operations suffer from the same problem if left 
untouched? (And, if they are immune, then why not mimic their wonderful 
code to destroy the tree as well?!)

* The proposed patch still destroys one child recursively (when both 
children are present). That feels like an incomplete solution that will 
still hit stack limits on some trees. I do understand that you are 
addressing a specific case of an idle Squid with a freshly configured 
degenerate tree, but there ought to be other cases that lead to similar 
results as well (accidentally or with a malicious actor help). Have you 
considered removing recursion completely instead (by using more heap 
memory as needed)?

* I am curious whether your specific use case (going beyond splay tree 
destruction) be better addressed by a different storage type than splay 
trees. For example, have you considered whether using a IP 
address-friendly hash would be faster for, say, one million IP addresses?


Cheers,

Alex.


On 7/26/23 11:25, magri at web.de wrote:
> Hi squid community,
> 
> we experience segfaults with squid 6.1 (and also older versions) during
> "squid -k reconfigure" on several linux systems, caused by a stack 
> overflow.
> 
> The circumstances are rather special:
> 
> - we have a huge dst ip blacklist (> 300.000 enties)
> - this original list is sorted (by raw ip value)
> - the proxy is a hot standby system so there are no client requests
>  ? between start of squid and reconfigure
> 
> We could trace the cause of the segfault to the destroy-method of
> SplayNode (in include/splay.h):
> - destroy of the top node is run on every reconfigure
> - destroy is recursive, so the function calls stack on the stack :-)
>  ? up to the depth of the splay tree
> - the insertion of an ordered ip list into the splay tree creates a
>  ? degenerate splay tree (each node has only a left child) with a depth
>  ? of the number of ip entries in the list
> - due to the inactivity of the proxy there is no rebalancing of the
>  ? tree through find calls
> 
> On amd64 every stack frame needs 32 byte. So the regular linux stack of
> 8 MB can hold about ~262.000 stack frames. On other architectures
> the limit is reached even faster (s390x: 160 bytes per stack frame ->
> 52.000 frames).
> 
> We tried to increase the stack size via ulimits and systemd, but though
> the squid master process got the increased limits, the kid-processes are
> always spawned with a soft limit of 8 MB and crash on reaching it.
> Only forcing a new soft limit via prlimit on an already running kid
> could avoid the crash.
> 
> I've attached a patch that modifies the destroy method of SplayNode to
> avoid recursive calls of destroy in single child nodes by moving the
> subtrees of the child to the parent node before destroying the child non
> recursively.
> With this patch we could no longer reproduce the segfaults, even with a
> list of 10.000.000 ordered ips.
> 
> Any ideas, comments, better solutions?
> 
> Thanks in advance for any advice.
> 
> best regards
>  ?Martin
> 
> 
> 
> 
> 
> 
> 
> 
> 
> 
> 
> 
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users



From squid3 at treenet.co.nz  Thu Jul 27 11:24:47 2023
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Thu, 27 Jul 2023 23:24:47 +1200
Subject: [squid-users] Stack overflow with large IP lists
In-Reply-To: <83a4285a-3c1b-8ea1-507e-fd2d51631eca@measurement-factory.com>
References: <bae25019-58e0-a19b-8315-ff0809c1cd0d@web.de>
 <83a4285a-3c1b-8ea1-507e-fd2d51631eca@measurement-factory.com>
Message-ID: <fb574c13-5757-7698-79d6-648eef3a02a9@treenet.co.nz>

On 27/07/23 04:22, Alex Rousskov wrote:>
> * I am curious whether your specific use case (going beyond splay tree 
> destruction) be better addressed by a different storage type than splay 
> trees. For example, have you considered whether using a IP 
> address-friendly hash would be faster for, say, one million IP addresses?
> 

There is a trie algorithm developed for rbldnsd which is extremely 
efficient for IP address storage and lookup on large lists. Using that 
for Squid ACL has been on my TODO list for years.

That software also contains efficient algorithms for automatic 
aggregation of overlapping IP ranges. Which is functionality Squid has 
needed for along time.

Any volunteers to assist with that are very welcome. Please contact 
squid-dev mailing list for followup.

Amos


From wbx at openadk.org  Fri Jul 28 09:05:36 2023
From: wbx at openadk.org (Waldemar Brodkorb)
Date: Fri, 28 Jul 2023 11:05:36 +0200
Subject: [squid-users] FATAL: Dying from an exception handling failure;
 exception: [no active exception]
Message-ID: <ZMOE4L2ujSS/NSSE@waldemar-brodkorb.de>

Hi Squid community,

we recently updated our proxies to 6.1 on Ubuntu 22.04 (x86_64) and
now seeing sometime following fatal errors in the cache.log:

FATAL: Dying from an exception handling failure; exception: [no
active exception]

What does it mean and how can I further analyze the problem?

best regards
 Waldemar



From Ralf.Hildebrandt at charite.de  Fri Jul 28 09:13:54 2023
From: Ralf.Hildebrandt at charite.de (Ralf Hildebrandt)
Date: Fri, 28 Jul 2023 11:13:54 +0200
Subject: [squid-users] [ext] FATAL: Dying from an exception handling
 failure; exception: [no active exception]
In-Reply-To: <ZMOE4L2ujSS/NSSE@waldemar-brodkorb.de>
References: <ZMOE4L2ujSS/NSSE@waldemar-brodkorb.de>
Message-ID: <ZMOG0n7J+pxRLV1p@charite.de>

* Waldemar Brodkorb <wbx at openadk.org>:
> Hi Squid community,
> 
> we recently updated our proxies to 6.1 on Ubuntu 22.04 (x86_64) and
> now seeing sometime following fatal errors in the cache.log:
> 
> FATAL: Dying from an exception handling failure; exception: [no
> active exception]
> 
> What does it mean and how can I further analyze the problem?

In most cases you'll need to run squid from within an debugger.

I use a script for that:
========================

#!/bin/bash
rm /var/run/squid.pid
echo 512 >  /proc/sys/kernel/msgmni
ulimit -n 262144
ulimit -c unlimited
ulimit -v 85000000

backtrace=`mktemp`
outfile=`mktemp`
gdb -q -x /etc/service/squid5/gdbcommands /usr/sbin/squid 2>&1 >$backtrace
cat $backtrace | \
      /usr/bin/mail -s "`hostname`: Squid wurde beendet" Ralf.Hildebrandt at charite.de
rm $backtrace
rm $outfile


The file /etc/service/squid5/gdbcommands contains the commands for the
GDB debugger:

# snip
set args -NsYC
handle SIGPIPE pass nostop noprint
handle SIGTERM pass nostop noprint
handle SIGUSR1 pass nostop noprint
handle SIGHUP  pass nostop noprint
handle SIGSEGV stop
handle SIGABRT stop
run
set print pretty
backtrace full
generate-core-file
quit
# snip

I hope this helps.

-- 
Ralf Hildebrandt
Charit? - Universit?tsmedizin Berlin
Gesch?ftsbereich IT | Abteilung Netzwerk

Campus Benjamin Franklin (CBF)
Haus I | 1. OG | Raum 105
Hindenburgdamm 30 | D-12203 Berlin

Tel. +49 30 450 570 155
ralf.hildebrandt at charite.de
https://www.charite.de


From rousskov at measurement-factory.com  Fri Jul 28 13:01:54 2023
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Fri, 28 Jul 2023 09:01:54 -0400
Subject: [squid-users] FATAL: Dying from an exception handling failure;
 exception: [no active exception]
In-Reply-To: <ZMOE4L2ujSS/NSSE@waldemar-brodkorb.de>
References: <ZMOE4L2ujSS/NSSE@waldemar-brodkorb.de>
Message-ID: <04564e61-7061-e8f6-75a3-9f48bd4a29a3@measurement-factory.com>

On 7/28/23 05:05, Waldemar Brodkorb wrote:

> we recently updated our proxies to 6.1 on Ubuntu 22.04 (x86_64) and
> now seeing sometime following fatal errors in the cache.log:
> 
> FATAL: Dying from an exception handling failure; exception: [no
> active exception]
> 
> What does it mean and how can I further analyze the problem?

It means your Squid hit a bug and quit.

* If you configure your environment to allow Squid to dump its core, the 
crash should leave a core file that you can analyze with a debugger. 
Please be mindful of Ubuntu's apport attempts to "help" you.

* Alternatively, you can start Squid from the debugger, but that usually 
requires more work/hacks. See Ralf's response for helpful hints.
  There is one known Squid v6+ bug with the same symptom. If your 
debugger backtrace shows functions with letters "Ftp" in their names, 
then you are probably hitting that bug. That bug has a proposed fix. If 
you can, please test it: 
https://bugs.squid-cache.org/show_bug.cgi?id=5290#c2


Thank you,

Alex.



From Ralf.Hildebrandt at charite.de  Fri Jul 28 13:32:05 2023
From: Ralf.Hildebrandt at charite.de (Ralf Hildebrandt)
Date: Fri, 28 Jul 2023 15:32:05 +0200
Subject: [squid-users] [ext] Re: FATAL: Dying from an exception handling
 failure; exception: [no active exception]
In-Reply-To: <04564e61-7061-e8f6-75a3-9f48bd4a29a3@measurement-factory.com>
References: <ZMOE4L2ujSS/NSSE@waldemar-brodkorb.de>
 <04564e61-7061-e8f6-75a3-9f48bd4a29a3@measurement-factory.com>
Message-ID: <ZMPDVUvs7aALM5QV@charite.de>

* Alex Rousskov <rousskov at measurement-factory.com>:

> * Alternatively, you can start Squid from the debugger, but that usually
> requires more work/hacks. See Ralf's response for helpful hints.
> There is one known Squid v6+ bug with the same symptom.

That's why I chimed in :)

> If your debugger
> backtrace shows functions with letters "Ftp" in their names, then you are
> probably hitting that bug. That bug has a proposed fix. If you can, please
> test it: https://bugs.squid-cache.org/show_bug.cgi?id=5290#c2

-- 
Ralf Hildebrandt
Charit? - Universit?tsmedizin Berlin
Gesch?ftsbereich IT | Abteilung Netzwerk

Campus Benjamin Franklin (CBF)
Haus I | 1. OG | Raum 105
Hindenburgdamm 30 | D-12203 Berlin

Tel. +49 30 450 570 155
ralf.hildebrandt at charite.de
https://www.charite.de


From magri at web.de  Fri Jul 28 14:51:02 2023
From: magri at web.de (magri at web.de)
Date: Fri, 28 Jul 2023 16:51:02 +0200
Subject: [squid-users] Stack overflow with large IP lists
In-Reply-To: <83a4285a-3c1b-8ea1-507e-fd2d51631eca@measurement-factory.com>
References: <bae25019-58e0-a19b-8315-ff0809c1cd0d@web.de>
 <83a4285a-3c1b-8ea1-507e-fd2d51631eca@measurement-factory.com>
Message-ID: <3d2c22de-b39c-8b46-9163-5bbf52fb3cc1@web.de>

Hi Alex,

visit and walk should share the same problem, but they don't seem to be
used for acls, except for dumping.

Regardless I did a complete rewrite of my patch to remove all recursive
calls in SplayNode. See GitHub Pull Request #1431.

For our large number of IP addresses and clients (request/s) a different
storage type should indeed be better suited to avoid the overhead of
permanent tree rebalancing.


Cheers,
Martin

Am 26.07.23 um 18:22 schrieb Alex Rousskov:
> On 7/26/23 11:25, magri at web.de wrote:
>
>> I've attached a patch that modifies the destroy method of SplayNode
>> to avoid recursive calls of destroy in single child nodes by moving
>> the subtrees of the child to the parent node before destroying the
>> child non recursively.
>
> Hi Martin,
>
>  ??? Thanks a lot for sharing your well-documented fix! Would you be
> willing to post it as a GitHub Pull Request? If you do, then the
> following questions can be discussed on GitHub instead:
>
> * The patch reduces recursion during tree destruction. Squid splay tree
> implementation contains other recursive operations (e.g., visit()).
> Would not those other operations suffer from the same problem if left
> untouched? (And, if they are immune, then why not mimic their wonderful
> code to destroy the tree as well?!)
>
> * The proposed patch still destroys one child recursively (when both
> children are present). That feels like an incomplete solution that will
> still hit stack limits on some trees. I do understand that you are
> addressing a specific case of an idle Squid with a freshly configured
> degenerate tree, but there ought to be other cases that lead to similar
> results as well (accidentally or with a malicious actor help). Have you
> considered removing recursion completely instead (by using more heap
> memory as needed)?
>
> * I am curious whether your specific use case (going beyond splay tree
> destruction) be better addressed by a different storage type than splay
> trees. For example, have you considered whether using a IP
> address-friendly hash would be faster for, say, one million IP addresses?
>
>
> Cheers,
>
> Alex.
>
>
> On 7/26/23 11:25, magri at web.de wrote:
>> Hi squid community,
>>
>> we experience segfaults with squid 6.1 (and also older versions) during
>> "squid -k reconfigure" on several linux systems, caused by a stack
>> overflow.
>>
>> The circumstances are rather special:
>>
>> - we have a huge dst ip blacklist (> 300.000 enties)
>> - this original list is sorted (by raw ip value)
>> - the proxy is a hot standby system so there are no client requests
>> ?? between start of squid and reconfigure
>>
>> We could trace the cause of the segfault to the destroy-method of
>> SplayNode (in include/splay.h):
>> - destroy of the top node is run on every reconfigure
>> - destroy is recursive, so the function calls stack on the stack :-)
>> ?? up to the depth of the splay tree
>> - the insertion of an ordered ip list into the splay tree creates a
>> ?? degenerate splay tree (each node has only a left child) with a depth
>> ?? of the number of ip entries in the list
>> - due to the inactivity of the proxy there is no rebalancing of the
>> ?? tree through find calls
>>
>> On amd64 every stack frame needs 32 byte. So the regular linux stack of
>> 8 MB can hold about ~262.000 stack frames. On other architectures
>> the limit is reached even faster (s390x: 160 bytes per stack frame ->
>> 52.000 frames).
>>
>> We tried to increase the stack size via ulimits and systemd, but though
>> the squid master process got the increased limits, the kid-processes are
>> always spawned with a soft limit of 8 MB and crash on reaching it.
>> Only forcing a new soft limit via prlimit on an already running kid
>> could avoid the crash.
>>
>> I've attached a patch that modifies the destroy method of SplayNode to
>> avoid recursive calls of destroy in single child nodes by moving the
>> subtrees of the child to the parent node before destroying the child non
>> recursively.
>> With this patch we could no longer reproduce the segfaults, even with a
>> list of 10.000.000 ordered ips.
>>
>> Any ideas, comments, better solutions?
>>
>> Thanks in advance for any advice.
>>
>> best regards
>> ??Martin
>>
>>
>>
>>
>>
>>
>>
>>
>>
>>
>>
>>
>> _______________________________________________
>> squid-users mailing list
>> squid-users at lists.squid-cache.org
>> http://lists.squid-cache.org/listinfo/squid-users
>
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users


From rousskov at measurement-factory.com  Fri Jul 28 16:24:58 2023
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Fri, 28 Jul 2023 12:24:58 -0400
Subject: [squid-users] Stack overflow with large IP lists
In-Reply-To: <3d2c22de-b39c-8b46-9163-5bbf52fb3cc1@web.de>
References: <bae25019-58e0-a19b-8315-ff0809c1cd0d@web.de>
 <83a4285a-3c1b-8ea1-507e-fd2d51631eca@measurement-factory.com>
 <3d2c22de-b39c-8b46-9163-5bbf52fb3cc1@web.de>
Message-ID: <0f678c0a-900a-cb6b-dd3a-a3a549b68981@measurement-factory.com>

On 7/28/23 10:51, magri at web.de wrote:

> I did a complete rewrite of my patch to remove all recursive
> calls in SplayNode. See GitHub Pull Request #1431.

Thank you! Already reviewed :-).


> For our large number of IP addresses and clients (request/s) a different
> storage type should indeed be better suited to avoid the overhead of
> permanent tree rebalancing.

There seems to be strong consensus regarding replacing Squid splay 
trees. I hope somebody will do it in the foreseeable future, but I do 
not know of anybody working on that replacement right now.

FWIW, my _primary_ replacement motivation is not persistent rebalancing 
costs but terrible worst-case performance combined with a real 
possibility of triggering that worst-case performance, completely 
outside admin knowledge or control. Your use case with an idle Squid is 
a good illustration of that problem, but things can get much worse.


Cheers,

Alex.


> Am 26.07.23 um 18:22 schrieb Alex Rousskov:
>> On 7/26/23 11:25, magri at web.de wrote:
>>
>>> I've attached a patch that modifies the destroy method of SplayNode
>>> to avoid recursive calls of destroy in single child nodes by moving
>>> the subtrees of the child to the parent node before destroying the
>>> child non recursively.
>>
>> Hi Martin,
>>
>> ???? Thanks a lot for sharing your well-documented fix! Would you be
>> willing to post it as a GitHub Pull Request? If you do, then the
>> following questions can be discussed on GitHub instead:
>>
>> * The patch reduces recursion during tree destruction. Squid splay tree
>> implementation contains other recursive operations (e.g., visit()).
>> Would not those other operations suffer from the same problem if left
>> untouched? (And, if they are immune, then why not mimic their wonderful
>> code to destroy the tree as well?!)
>>
>> * The proposed patch still destroys one child recursively (when both
>> children are present). That feels like an incomplete solution that will
>> still hit stack limits on some trees. I do understand that you are
>> addressing a specific case of an idle Squid with a freshly configured
>> degenerate tree, but there ought to be other cases that lead to similar
>> results as well (accidentally or with a malicious actor help). Have you
>> considered removing recursion completely instead (by using more heap
>> memory as needed)?
>>
>> * I am curious whether your specific use case (going beyond splay tree
>> destruction) be better addressed by a different storage type than splay
>> trees. For example, have you considered whether using a IP
>> address-friendly hash would be faster for, say, one million IP addresses?
>>
>>
>> Cheers,
>>
>> Alex.
>>
>>
>> On 7/26/23 11:25, magri at web.de wrote:
>>> Hi squid community,
>>>
>>> we experience segfaults with squid 6.1 (and also older versions) during
>>> "squid -k reconfigure" on several linux systems, caused by a stack
>>> overflow.
>>>
>>> The circumstances are rather special:
>>>
>>> - we have a huge dst ip blacklist (> 300.000 enties)
>>> - this original list is sorted (by raw ip value)
>>> - the proxy is a hot standby system so there are no client requests
>>> ?? between start of squid and reconfigure
>>>
>>> We could trace the cause of the segfault to the destroy-method of
>>> SplayNode (in include/splay.h):
>>> - destroy of the top node is run on every reconfigure
>>> - destroy is recursive, so the function calls stack on the stack :-)
>>> ?? up to the depth of the splay tree
>>> - the insertion of an ordered ip list into the splay tree creates a
>>> ?? degenerate splay tree (each node has only a left child) with a depth
>>> ?? of the number of ip entries in the list
>>> - due to the inactivity of the proxy there is no rebalancing of the
>>> ?? tree through find calls
>>>
>>> On amd64 every stack frame needs 32 byte. So the regular linux stack of
>>> 8 MB can hold about ~262.000 stack frames. On other architectures
>>> the limit is reached even faster (s390x: 160 bytes per stack frame ->
>>> 52.000 frames).
>>>
>>> We tried to increase the stack size via ulimits and systemd, but though
>>> the squid master process got the increased limits, the kid-processes are
>>> always spawned with a soft limit of 8 MB and crash on reaching it.
>>> Only forcing a new soft limit via prlimit on an already running kid
>>> could avoid the crash.
>>>
>>> I've attached a patch that modifies the destroy method of SplayNode to
>>> avoid recursive calls of destroy in single child nodes by moving the
>>> subtrees of the child to the parent node before destroying the child non
>>> recursively.
>>> With this patch we could no longer reproduce the segfaults, even with a
>>> list of 10.000.000 ordered ips.
>>>
>>> Any ideas, comments, better solutions?
>>>
>>> Thanks in advance for any advice.
>>>
>>> best regards
>>> ??Martin
>>>
>>>
>>>
>>>
>>>
>>>
>>>
>>>
>>>
>>>
>>>
>>>
>>> _______________________________________________
>>> squid-users mailing list
>>> squid-users at lists.squid-cache.org
>>> http://lists.squid-cache.org/listinfo/squid-users
>>
>> _______________________________________________
>> squid-users mailing list
>> squid-users at lists.squid-cache.org
>> http://lists.squid-cache.org/listinfo/squid-users
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users



From wbx at openadk.org  Fri Jul 28 16:34:00 2023
From: wbx at openadk.org (Waldemar Brodkorb)
Date: Fri, 28 Jul 2023 18:34:00 +0200
Subject: [squid-users] FATAL: Dying from an exception handling failure;
 exception: [no active exception]
In-Reply-To: <04564e61-7061-e8f6-75a3-9f48bd4a29a3@measurement-factory.com>
References: <ZMOE4L2ujSS/NSSE@waldemar-brodkorb.de>
 <04564e61-7061-e8f6-75a3-9f48bd4a29a3@measurement-factory.com>
Message-ID: <ZMPt+Jcm589pP1eN@waldemar-brodkorb.de>

Hi Alex,
Alex Rousskov wrote,

> On 7/28/23 05:05, Waldemar Brodkorb wrote:
> 
> > we recently updated our proxies to 6.1 on Ubuntu 22.04 (x86_64) and
> > now seeing sometime following fatal errors in the cache.log:
> > 
> > FATAL: Dying from an exception handling failure; exception: [no
> > active exception]
> > 
> > What does it mean and how can I further analyze the problem?
> 
> It means your Squid hit a bug and quit.
> 
> * If you configure your environment to allow Squid to dump its core, the
> crash should leave a core file that you can analyze with a debugger. Please
> be mindful of Ubuntu's apport attempts to "help" you.
> 
> * Alternatively, you can start Squid from the debugger, but that usually
> requires more work/hacks. See Ralf's response for helpful hints.
>  There is one known Squid v6+ bug with the same symptom. If your debugger
> backtrace shows functions with letters "Ftp" in their names, then you are
> probably hitting that bug. That bug has a proposed fix. If you can, please
> test it: https://bugs.squid-cache.org/show_bug.cgi?id=5290#c2

I tested this patch and it fixes my crash.
After your hint about Ftp issues, I could regenerate the crash just
by visiting ftp://ftp.gwdg.de via internet explorer.

Thanks for the patch and fast replies,
 best regards
  Waldemar


From bpk678 at gmail.com  Sat Jul 29 00:08:39 2023
From: bpk678 at gmail.com (Brendan Kearney)
Date: Fri, 28 Jul 2023 20:08:39 -0400
Subject: [squid-users] cachemgr.cgi & Internal Error: Missing Template
 MGR_INDEX
Message-ID: <d05e4ae5-3f30-9070-c33b-a9cae5958d60@gmail.com>

list members,

i am running squid 6.1 on fedora 38, and cannot get the cachemgr.cgi 
working on this box.? I am getting the error:

Internal Error: Missing Template MGR_INDEX

when i try to connect using the cache manager interface.? oddly, when i 
connect from a different host running squid, using the older squid 4.14 
on fedora 32 cachemgr.cgi, i am able to get into the cache manager 
interface.? is there something i am missing?

thanks,

brendan



From rousskov at measurement-factory.com  Sat Jul 29 02:42:25 2023
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Fri, 28 Jul 2023 22:42:25 -0400
Subject: [squid-users] cachemgr.cgi & Internal Error: Missing Template
 MGR_INDEX
In-Reply-To: <d05e4ae5-3f30-9070-c33b-a9cae5958d60@gmail.com>
References: <d05e4ae5-3f30-9070-c33b-a9cae5958d60@gmail.com>
Message-ID: <9f929826-4b70-896d-0729-ee815e64a568@measurement-factory.com>

On 7/28/23 20:08, Brendan Kearney wrote:

> i am running squid 6.1 on fedora 38, and cannot get the cachemgr.cgi 
> working on this box.? I am getting the error:
> 
> Internal Error: Missing Template MGR_INDEX
> 
> when i try to connect using the cache manager interface.


Hi Brendan,

     AFAICT, Squid v6 looks for a template file called "MGR_INDEX". 
Squid checks up to three directories (in the listed order):

* <error_directory>
* DATA_DIR / "errors" / <error_default_language>
* DATA_DIR / "errors" / "templates"

... where

* <error_directory> and <error_default_language> are the values of the 
corresponding squid.conf directives; they (and the corresponding list 
items above) are unused by default;

* DATA_DIR is set by ./configure --datadir (including its --datarootdir- 
or --prefix-dependent default value);

* "errors" and "templates" are those exact words.


For example, in my test without those squid.conf directives configured, 
Squid v6 tried to load /usr/local/squid/share/errors/templates/MGR_INDEX


Where is your MGR_INDEX file? Is it readable by Squid?


If you start your Squid with "-X", then you can grep cache.log for 
MGR_INDEX to find the location(s) Squid was considering. For example, I 
see the following cache.log line:

2023/07/28 22:32:41.589| 50,3| fs_io.cc(60) file_open: error opening 
file /usr/local/squid/share/errors/templates/MGR_INDEX: (2) No such file 
or directory


It is possible that your Squid loads the file but cannot serve it when 
satisfying the cache manager request. If that happens, it could be a 
Squid bug. I did not test things that far.


HTH,

Alex.

> oddly, when i 
> connect from a different host running squid, using the older squid 4.14 
> on fedora 32 cachemgr.cgi, i am able to get into the cache manager 
> interface.? is there something i am missing?
> 
> thanks,
> 
> brendan
> 
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users



From squid3 at treenet.co.nz  Sat Jul 29 05:26:31 2023
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Sat, 29 Jul 2023 17:26:31 +1200
Subject: [squid-users] cachemgr.cgi & Internal Error: Missing Template
 MGR_INDEX
In-Reply-To: <9f929826-4b70-896d-0729-ee815e64a568@measurement-factory.com>
References: <d05e4ae5-3f30-9070-c33b-a9cae5958d60@gmail.com>
 <9f929826-4b70-896d-0729-ee815e64a568@measurement-factory.com>
Message-ID: <367668dd-b7af-b2ca-63d9-afcb21f872a7@treenet.co.nz>

On 29/07/23 14:42, Alex Rousskov wrote:
> On 7/28/23 20:08, Brendan Kearney wrote:
> 
>> i am running squid 6.1 on fedora 38, and cannot get the cachemgr.cgi 
>> working on this box.? I am getting the error:
>>
>> Internal Error: Missing Template MGR_INDEX
>>
>> when i try to connect using the cache manager interface.
> 

That is the expected output when you are trying to access the manager 
interface directly from Squid. **Instead** of via the cachemgr.cgi.

If you want to try the new manager interface I have a prototype 
javascript tool available at <https://github.com/yadij/cachemgr.js/>.


Amos


From bpk678 at gmail.com  Sat Jul 29 15:07:17 2023
From: bpk678 at gmail.com (Brendan Kearney)
Date: Sat, 29 Jul 2023 11:07:17 -0400
Subject: [squid-users] cachemgr.cgi & Internal Error: Missing Template
 MGR_INDEX
In-Reply-To: <367668dd-b7af-b2ca-63d9-afcb21f872a7@treenet.co.nz>
References: <d05e4ae5-3f30-9070-c33b-a9cae5958d60@gmail.com>
 <9f929826-4b70-896d-0729-ee815e64a568@measurement-factory.com>
 <367668dd-b7af-b2ca-63d9-afcb21f872a7@treenet.co.nz>
Message-ID: <f70504f0-48f0-7651-257f-3543f9410087@gmail.com>

@alex,

the package installed does not have any file named MGR_INDEX. running 
"rpm -ql squid |grep -i index" does not return anything. searching in 
/usr/share/squid for the file does not find it, either.? funny that 
neither the old version of squid, nor the new version of squid have that 
file at all.

@amos,

i ran firefox with developer tools open, and browsed to the cachemgr 
URL, and reproduced the issue.? the traffic is not being proxied through 
squid, and is making the requests directly.? i am not sure if that is 
what you mean.? i saved the session as a HAR file, if that helps.

thank you,

brendan

On 7/29/23 1:26 AM, Amos Jeffries wrote:
> On 29/07/23 14:42, Alex Rousskov wrote:
>> On 7/28/23 20:08, Brendan Kearney wrote:
>>
>>> i am running squid 6.1 on fedora 38, and cannot get the cachemgr.cgi 
>>> working on this box.? I am getting the error:
>>>
>>> Internal Error: Missing Template MGR_INDEX
>>>
>>> when i try to connect using the cache manager interface.
>>
>
> That is the expected output when you are trying to access the manager 
> interface directly from Squid. **Instead** of via the cachemgr.cgi.
>
> If you want to try the new manager interface I have a prototype 
> javascript tool available at <https://github.com/yadij/cachemgr.js/>.
>
>
> Amos
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users


From rousskov at measurement-factory.com  Sat Jul 29 16:22:50 2023
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Sat, 29 Jul 2023 12:22:50 -0400
Subject: [squid-users] cachemgr.cgi & Internal Error: Missing Template
 MGR_INDEX
In-Reply-To: <f70504f0-48f0-7651-257f-3543f9410087@gmail.com>
References: <d05e4ae5-3f30-9070-c33b-a9cae5958d60@gmail.com>
 <9f929826-4b70-896d-0729-ee815e64a568@measurement-factory.com>
 <367668dd-b7af-b2ca-63d9-afcb21f872a7@treenet.co.nz>
 <f70504f0-48f0-7651-257f-3543f9410087@gmail.com>
Message-ID: <e04e1c59-b21e-725d-bb08-cf9bb05fcc31@measurement-factory.com>

On 7/29/23 11:07, Brendan Kearney wrote:

> the package installed does not have any file named MGR_INDEX. running 
> "rpm -ql squid |grep -i index" does not return anything. searching in 
> /usr/share/squid for the file does not find it, either.? funny that 
> neither the old version of squid, nor the new version of squid have that 
> file at all.

Yes, the lack of MGR_INDEX file in Squid sources is "by design" of that 
MGR_INDEX feature -- an "external tool" is supposed to provide that file 
in certain cases[1]. Please do not misinterpret my statement as defense 
of the corresponding design decisions or their side effects; I am just 
stating the facts rather than trying to justify bad user experience.

[1] https://github.com/squid-cache/squid/pull/1176#discussion_r1010534845


Alex.


> @amos,
> 
> i ran firefox with developer tools open, and browsed to the cachemgr 
> URL, and reproduced the issue.? the traffic is not being proxied through 
> squid, and is making the requests directly.? i am not sure if that is 
> what you mean.? i saved the session as a HAR file, if that helps.
> 
> thank you,
> 
> brendan
> 
> On 7/29/23 1:26 AM, Amos Jeffries wrote:
>> On 29/07/23 14:42, Alex Rousskov wrote:
>>> On 7/28/23 20:08, Brendan Kearney wrote:
>>>
>>>> i am running squid 6.1 on fedora 38, and cannot get the cachemgr.cgi 
>>>> working on this box.? I am getting the error:
>>>>
>>>> Internal Error: Missing Template MGR_INDEX
>>>>
>>>> when i try to connect using the cache manager interface.
>>>
>>
>> That is the expected output when you are trying to access the manager 
>> interface directly from Squid. **Instead** of via the cachemgr.cgi.
>>
>> If you want to try the new manager interface I have a prototype 
>> javascript tool available at <https://github.com/yadij/cachemgr.js/>.
>>
>>
>> Amos
>> _______________________________________________
>> squid-users mailing list
>> squid-users at lists.squid-cache.org
>> http://lists.squid-cache.org/listinfo/squid-users
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users



From bpk678 at gmail.com  Sat Jul 29 16:31:30 2023
From: bpk678 at gmail.com (Brendan Kearney)
Date: Sat, 29 Jul 2023 12:31:30 -0400
Subject: [squid-users] cachemgr.cgi & Internal Error: Missing Template
 MGR_INDEX
In-Reply-To: <e04e1c59-b21e-725d-bb08-cf9bb05fcc31@measurement-factory.com>
References: <d05e4ae5-3f30-9070-c33b-a9cae5958d60@gmail.com>
 <9f929826-4b70-896d-0729-ee815e64a568@measurement-factory.com>
 <367668dd-b7af-b2ca-63d9-afcb21f872a7@treenet.co.nz>
 <f70504f0-48f0-7651-257f-3543f9410087@gmail.com>
 <e04e1c59-b21e-725d-bb08-cf9bb05fcc31@measurement-factory.com>
Message-ID: <9a6119d9-c7a6-8d8f-4292-79a5a99d17f3@gmail.com>

i am not following.

squid 4.14 on fedora 32 does not have the file, nor does it exhibit the 
issue.
squid 6.1 on fedora 38 does not have the file, but does exhibit the issue.

what am i missing, and is there a way to provide this functionality in 
6.1?? if an external tool, or different package, is needed what is that?

thanks,

brendan

On 7/29/23 12:22 PM, Alex Rousskov wrote:
> On 7/29/23 11:07, Brendan Kearney wrote:
>
>> the package installed does not have any file named MGR_INDEX. running 
>> "rpm -ql squid |grep -i index" does not return anything. searching in 
>> /usr/share/squid for the file does not find it, either.? funny that 
>> neither the old version of squid, nor the new version of squid have 
>> that file at all.
>
> Yes, the lack of MGR_INDEX file in Squid sources is "by design" of 
> that MGR_INDEX feature -- an "external tool" is supposed to provide 
> that file in certain cases[1]. Please do not misinterpret my statement 
> as defense of the corresponding design decisions or their side 
> effects; I am just stating the facts rather than trying to justify bad 
> user experience.
>
> [1] https://github.com/squid-cache/squid/pull/1176#discussion_r1010534845
>
>
> Alex.
>
>
>> @amos,
>>
>> i ran firefox with developer tools open, and browsed to the cachemgr 
>> URL, and reproduced the issue.? the traffic is not being proxied 
>> through squid, and is making the requests directly.? i am not sure if 
>> that is what you mean.? i saved the session as a HAR file, if that 
>> helps.
>>
>> thank you,
>>
>> brendan
>>
>> On 7/29/23 1:26 AM, Amos Jeffries wrote:
>>> On 29/07/23 14:42, Alex Rousskov wrote:
>>>> On 7/28/23 20:08, Brendan Kearney wrote:
>>>>
>>>>> i am running squid 6.1 on fedora 38, and cannot get the 
>>>>> cachemgr.cgi working on this box.? I am getting the error:
>>>>>
>>>>> Internal Error: Missing Template MGR_INDEX
>>>>>
>>>>> when i try to connect using the cache manager interface.
>>>>
>>>
>>> That is the expected output when you are trying to access the 
>>> manager interface directly from Squid. **Instead** of via the 
>>> cachemgr.cgi.
>>>
>>> If you want to try the new manager interface I have a prototype 
>>> javascript tool available at <https://github.com/yadij/cachemgr.js/>.
>>>
>>>
>>> Amos
>>> _______________________________________________
>>> squid-users mailing list
>>> squid-users at lists.squid-cache.org
>>> http://lists.squid-cache.org/listinfo/squid-users
>> _______________________________________________
>> squid-users mailing list
>> squid-users at lists.squid-cache.org
>> http://lists.squid-cache.org/listinfo/squid-users
>
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users


From rousskov at measurement-factory.com  Sat Jul 29 20:01:46 2023
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Sat, 29 Jul 2023 16:01:46 -0400
Subject: [squid-users] cachemgr.cgi & Internal Error: Missing Template
 MGR_INDEX
In-Reply-To: <9a6119d9-c7a6-8d8f-4292-79a5a99d17f3@gmail.com>
References: <d05e4ae5-3f30-9070-c33b-a9cae5958d60@gmail.com>
 <9f929826-4b70-896d-0729-ee815e64a568@measurement-factory.com>
 <367668dd-b7af-b2ca-63d9-afcb21f872a7@treenet.co.nz>
 <f70504f0-48f0-7651-257f-3543f9410087@gmail.com>
 <e04e1c59-b21e-725d-bb08-cf9bb05fcc31@measurement-factory.com>
 <9a6119d9-c7a6-8d8f-4292-79a5a99d17f3@gmail.com>
Message-ID: <97b6e8fc-5760-c1b2-4c8e-590a764f5d0b@measurement-factory.com>

On 7/29/23 12:31, Brendan Kearney wrote:
> i am not following.

Sorry, I was just gathering evidence and explaining what you saw. I have 
not confirmed a bug and have not been offering a solution (yet?).


> squid 4.14 on fedora 32 does not have the file, nor does it exhibit the 
> issue.

> squid 6.1 on fedora 38 does not have the file, but does exhibit the issue.

... and you do not have a MGR_INDEX file and, presumably, did not have 
that file before. That piece of information was missing. Now we have it. 
Let's call that progress, even though it may not look like one :-).

One additional checkbox to tick is to make sure that the cachemgr.cgi 
script you are using comes from the Squid version you are testing.


> what am i missing, and is there a way to provide this functionality in 
> 6.1?? if an external tool, or different package, is needed what is that?

cachemgr.cgi is not my area of expertise, but I believe that, bugs 
notwithstanding, the functionality you want should be available without 
an external tool.

The next step, AFAICT, is for you to detail:

* what HTTP response cachemgr.cgi script gets from Squid and
* what HTTP response your browser gets from cachemgr.cgi

According to [2], Squid should send a 404 response to cachemgr.cgi. You 
may be able to find some Squid response details (e.g., status code) in 
Squid access.log. If your cachemgr.cgi is sending plain text requests to 
Squid, you can also capture HTTP traffic to and from cachemgr.cgi using 
tcpdump, wireshark, or similar tools.

[2] https://github.com/squid-cache/squid/pull/1176#discussion_r1010645870


Thank you,

Alex.


> On 7/29/23 12:22 PM, Alex Rousskov wrote:
>> On 7/29/23 11:07, Brendan Kearney wrote:
>>
>>> the package installed does not have any file named MGR_INDEX. running 
>>> "rpm -ql squid |grep -i index" does not return anything. searching in 
>>> /usr/share/squid for the file does not find it, either.? funny that 
>>> neither the old version of squid, nor the new version of squid have 
>>> that file at all.
>>
>> Yes, the lack of MGR_INDEX file in Squid sources is "by design" of 
>> that MGR_INDEX feature -- an "external tool" is supposed to provide 
>> that file in certain cases[1]. Please do not misinterpret my statement 
>> as defense of the corresponding design decisions or their side 
>> effects; I am just stating the facts rather than trying to justify bad 
>> user experience.
>>
>> [1] https://github.com/squid-cache/squid/pull/1176#discussion_r1010534845
>>
>>
>> Alex.
>>
>>
>>> @amos,
>>>
>>> i ran firefox with developer tools open, and browsed to the cachemgr 
>>> URL, and reproduced the issue.? the traffic is not being proxied 
>>> through squid, and is making the requests directly.? i am not sure if 
>>> that is what you mean.? i saved the session as a HAR file, if that 
>>> helps.
>>>
>>> thank you,
>>>
>>> brendan
>>>
>>> On 7/29/23 1:26 AM, Amos Jeffries wrote:
>>>> On 29/07/23 14:42, Alex Rousskov wrote:
>>>>> On 7/28/23 20:08, Brendan Kearney wrote:
>>>>>
>>>>>> i am running squid 6.1 on fedora 38, and cannot get the 
>>>>>> cachemgr.cgi working on this box.? I am getting the error:
>>>>>>
>>>>>> Internal Error: Missing Template MGR_INDEX
>>>>>>
>>>>>> when i try to connect using the cache manager interface.
>>>>>
>>>>
>>>> That is the expected output when you are trying to access the 
>>>> manager interface directly from Squid. **Instead** of via the 
>>>> cachemgr.cgi.
>>>>
>>>> If you want to try the new manager interface I have a prototype 
>>>> javascript tool available at <https://github.com/yadij/cachemgr.js/>.
>>>>
>>>>
>>>> Amos
>>>> _______________________________________________
>>>> squid-users mailing list
>>>> squid-users at lists.squid-cache.org
>>>> http://lists.squid-cache.org/listinfo/squid-users
>>> _______________________________________________
>>> squid-users mailing list
>>> squid-users at lists.squid-cache.org
>>> http://lists.squid-cache.org/listinfo/squid-users
>>
>> _______________________________________________
>> squid-users mailing list
>> squid-users at lists.squid-cache.org
>> http://lists.squid-cache.org/listinfo/squid-users
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users



From bpk678 at gmail.com  Sun Jul 30 15:25:42 2023
From: bpk678 at gmail.com (Brendan Kearney)
Date: Sun, 30 Jul 2023 11:25:42 -0400
Subject: [squid-users] cachemgr.cgi & Internal Error: Missing Template
 MGR_INDEX
In-Reply-To: <97b6e8fc-5760-c1b2-4c8e-590a764f5d0b@measurement-factory.com>
References: <d05e4ae5-3f30-9070-c33b-a9cae5958d60@gmail.com>
 <9f929826-4b70-896d-0729-ee815e64a568@measurement-factory.com>
 <367668dd-b7af-b2ca-63d9-afcb21f872a7@treenet.co.nz>
 <f70504f0-48f0-7651-257f-3543f9410087@gmail.com>
 <e04e1c59-b21e-725d-bb08-cf9bb05fcc31@measurement-factory.com>
 <9a6119d9-c7a6-8d8f-4292-79a5a99d17f3@gmail.com>
 <97b6e8fc-5760-c1b2-4c8e-590a764f5d0b@measurement-factory.com>
Message-ID: <40263f48-5c45-3ec9-85f6-fee4aba9dafa@gmail.com>

the cachemgr.cgi i am using is packaged with the squid server i run, all 
from the fedora rpm.? i have two instances, one older and one recently 
upgraded.

you can see in the squid logs all of the requests. cachemgr.cgi/6.1 
always returns a 404.? cachemgr.cgi/4.14 does work and is the instance 
on the older box connecting/talking to the squid instance on the new 
box.? i do get a 404 in the browser.? are the below logs enough or would 
it help if i am to run a packet capture?

[root at server2 ~]# journalctl -rlu squid |grep cachemgr.cgi
Jul 29 10:56:04 server2 (squid-1)[288884]: 
192.168.88.2,server2.bpk2.com,-,29/Jul/2023:10:56:04 
-0400,192.168.88.2,3128,-,"squid",GET,"HTTP/1.0","http://proxy2.bpk2.com:3128/squid-internal-mgr/","cachemgr.cgi/6.1",404,372,-,"TCP_MISS/HIER_NONE","text/html"
Jul 29 10:55:29 server2 (squid-1)[288884]: 
192.168.88.2,server2.bpk2.com,-,29/Jul/2023:10:55:29 
-0400,192.168.88.2,3128,-,"squid",GET,"HTTP/1.0","http://proxy2.bpk2.com:3128/squid-internal-mgr/","cachemgr.cgi/6.1",404,372,-,"TCP_MISS/HIER_NONE","text/html"
Jul 29 10:54:38 server2 (squid-1)[288884]: 
192.168.88.2,192.168.88.2,-,29/Jul/2023:10:54:38 
-0400,192.168.88.2,3128,-,"squid",GET,"HTTP/1.0","http://proxy2.bpk2.com:3128/squid-internal-mgr/","cachemgr.cgi/6.1",404,372,-,"TCP_MISS/HIER_NONE","text/html"
Jul 28 20:02:08 server2 (squid-1)[227457]: 
192.168.88.2,server2.bpk2.com,-,28/Jul/2023:20:02:08 
-0400,192.168.88.2,3128,-,"squid",GET,"HTTP/1.0","http://proxy2.bpk2.com:3128/squid-internal-mgr/","cachemgr.cgi/6.1",404,372,-,"TCP_MISS/HIER_NONE","text/html"
Jul 28 19:55:00 server2 (squid-1)[227457]: 
192.168.88.2,server2.bpk2.com,-,28/Jul/2023:19:55:00 
-0400,192.168.88.2,3128,-,"squid",GET,"HTTP/1.0","http://proxy2.bpk2.com:3128/squid-internal-mgr/","cachemgr.cgi/6.1",404,372,-,"TCP_MISS/HIER_NONE","text/html"
Jul 28 13:13:48 server2 (squid-1)[227457]: 
192.168.88.1,server1.bpk2.com,-,28/Jul/2023:13:13:48 
-0400,192.168.88.2,3128,-,"squid",GET,"HTTP/1.0","cache_object://server2.bpk2.com/config","cachemgr.cgi/4.14",200,18284,-,"TCP_MISS/HIER_NONE","text/plain"
Jul 28 13:13:45 server2 (squid-1)[227457]: 
192.168.88.1,server1.bpk2.com,-,28/Jul/2023:13:13:45 
-0400,192.168.88.2,3128,-,"squid",GET,"HTTP/1.0","cache_object://server2.bpk2.com/","cachemgr.cgi/4.14",200,3817,-,"TCP_MISS/HIER_NONE","text/plain"
Jul 28 13:10:29 server2 (squid-1)[227457]: 
192.168.88.1,server1.bpk2.com,-,28/Jul/2023:13:10:29 
-0400,192.168.88.2,3128,-,"squid",GET,"HTTP/1.0","cache_object://server2.bpk2.com/info","cachemgr.cgi/4.14",200,2571,-,"TCP_MISS/HIER_NONE","text/plain"
Jul 28 13:10:24 server2 (squid-1)[227457]: 
192.168.88.1,server1.bpk2.com,-,28/Jul/2023:13:10:24 
-0400,192.168.88.2,3128,-,"squid",GET,"HTTP/1.0","cache_object://server2.bpk2.com/menu","cachemgr.cgi/4.14",200,3817,-,"TCP_MISS/HIER_NONE","text/plain"
Jul 28 13:10:12 server2 (squid-1)[227457]: 
192.168.88.1,server1.bpk2.com,-,28/Jul/2023:13:10:12 
-0400,192.168.88.2,3128,-,"squid",GET,"HTTP/1.0","cache_object://server2.bpk2.com/idns","cachemgr.cgi/4.14",200,1545,-,"TCP_MISS/HIER_NONE","text/plain"
Jul 28 13:10:10 server2 (squid-1)[227457]: 
192.168.88.1,server1.bpk2.com,-,28/Jul/2023:13:10:10 
-0400,192.168.88.2,3128,-,"squid",GET,"HTTP/1.0","cache_object://server2.bpk2.com/menu","cachemgr.cgi/4.14",200,3817,-,"TCP_MISS/HIER_NONE","text/plain"
Jul 28 13:10:03 server2 (squid-1)[227457]: 
192.168.88.1,server1.bpk2.com,-,28/Jul/2023:13:10:03 
-0400,192.168.88.2,3128,-,"squid",GET,"HTTP/1.0","cache_object://server2.bpk2.com/fqdncache","cachemgr.cgi/4.14",200,1394,-,"TCP_MISS/HIER_NONE","text/plain"
Jul 28 13:10:01 server2 (squid-1)[227457]: 
192.168.88.1,server1.bpk2.com,-,28/Jul/2023:13:10:01 
-0400,192.168.88.2,3128,-,"squid",GET,"HTTP/1.0","cache_object://server2.bpk2.com/menu","cachemgr.cgi/4.14",200,3817,-,"TCP_MISS/HIER_NONE","text/plain"
Jul 28 13:09:54 server2 (squid-1)[227457]: 
192.168.88.1,server1.bpk2.com,-,28/Jul/2023:13:09:54 
-0400,192.168.88.2,3128,-,"squid",GET,"HTTP/1.0","cache_object://server2.bpk2.com/ipcache","cachemgr.cgi/4.14",200,201730,-,"TCP_MISS/HIER_NONE","text/plain"
Jul 28 13:09:50 server2 (squid-1)[227457]: 
192.168.88.1,server1.bpk2.com,-,28/Jul/2023:13:09:50 
-0400,192.168.88.2,3128,-,"squid",GET,"HTTP/1.0","cache_object://server2.bpk2.com/menu","cachemgr.cgi/4.14",200,3817,-,"TCP_MISS/HIER_NONE","text/plain"
Jul 28 13:09:30 server2 (squid-1)[227457]: 
192.168.88.1,server1.bpk2.com,-,28/Jul/2023:13:09:30 
-0400,192.168.88.2,3128,-,"squid",GET,"HTTP/1.0","cache_object://server2.bpk2.com/config","cachemgr.cgi/4.14",200,18284,-,"TCP_MISS/HIER_NONE","text/plain"
Jul 28 13:09:26 server2 (squid-1)[227457]: 
192.168.88.1,server1.bpk2.com,-,28/Jul/2023:13:09:26 
-0400,192.168.88.2,3128,-,"squid",GET,"HTTP/1.0","cache_object://server2.bpk2.com/","cachemgr.cgi/4.14",200,3817,-,"TCP_MISS/HIER_NONE","text/plain"
Jul 28 13:08:44 server2 (squid-1)[227457]: 
192.168.88.2,server2.bpk2.com,-,28/Jul/2023:13:08:44 
-0400,192.168.88.2,3128,-,"squid",GET,"HTTP/1.0","http://proxy2.bpk2.com:3128/squid-internal-mgr/","cachemgr.cgi/6.1",404,372,-,"TCP_MISS/HIER_NONE","text/html"
Jul 28 13:04:46 server2 (squid-1)[227457]: 
192.168.88.2,server2.bpk2.com,-,28/Jul/2023:13:04:46 
-0400,192.168.88.2,3128,-,"squid",GET,"HTTP/1.0","http://proxy2.bpk2.com:3128/squid-internal-mgr/","cachemgr.cgi/6.1",404,372,-,"TCP_MISS/HIER_NONE","text/html"
Jul 28 13:03:30 server2 (squid-1)[227457]: 
192.168.88.2,server2.bpk2.com,-,28/Jul/2023:13:03:30 
-0400,192.168.88.2,3128,-,"squid",GET,"HTTP/1.0","http://proxy2.bpk2.com:3128/squid-internal-mgr/","cachemgr.cgi/6.1",404,372,-,"TCP_MISS/HIER_NONE","text/html"
Jul 28 13:01:02 server2 (squid-1)[227457]: 
192.168.88.2,server2.bpk2.com,-,28/Jul/2023:13:01:02 
-0400,192.168.88.2,3128,-,"squid",GET,"HTTP/1.0","http://proxy2.bpk2.com:3128/squid-internal-mgr/","cachemgr.cgi/6.1",404,372,-,"TCP_MISS/HIER_NONE","text/html"
Jul 28 12:59:15 server2 (squid-1)[227457]: 
192.168.88.2,server2.bpk2.com,-,28/Jul/2023:12:59:15 
-0400,192.168.88.2,3128,-,"squid",GET,"HTTP/1.0","http://proxy2.bpk2.com:3128/squid-internal-mgr/","cachemgr.cgi/6.1",404,372,-,"TCP_MISS/HIER_NONE","text/html"
Jul 28 12:59:11 server2 (squid-1)[227457]: 
192.168.88.2,server2.bpk2.com,-,28/Jul/2023:12:59:11 
-0400,192.168.88.2,3128,-,"squid",GET,"HTTP/1.0","http://proxy2.bpk2.com:3128/squid-internal-mgr/","cachemgr.cgi/6.1",404,372,-,"TCP_MISS/HIER_NONE","text/html"
Jul 28 12:58:27 server2 (squid-1)[227457]: 
192.168.88.2,server2.bpk2.com,-,28/Jul/2023:12:58:27 
-0400,192.168.88.2,3128,-,"squid",GET,"HTTP/1.0","http://proxy2.bpk2.com:3128/squid-internal-mgr/","cachemgr.cgi/6.1",404,372,-,"TCP_MISS/HIER_NONE","text/html"
Jul 28 12:58:14 server2 (squid-1)[227457]: 
192.168.88.2,server2.bpk2.com,-,28/Jul/2023:12:58:14 
-0400,192.168.88.2,3128,-,"squid",GET,"HTTP/1.0","http://proxy2.bpk2.com:3128/squid-internal-mgr/","cachemgr.cgi/6.1",404,372,-,"TCP_MISS/HIER_NONE","text/html"

On 7/29/23 4:01 PM, Alex Rousskov wrote:
> On 7/29/23 12:31, Brendan Kearney wrote:
>> i am not following.
>
> Sorry, I was just gathering evidence and explaining what you saw. I 
> have not confirmed a bug and have not been offering a solution (yet?).
>
>
>> squid 4.14 on fedora 32 does not have the file, nor does it exhibit 
>> the issue.
>
>> squid 6.1 on fedora 38 does not have the file, but does exhibit the 
>> issue.
>
> ... and you do not have a MGR_INDEX file and, presumably, did not have 
> that file before. That piece of information was missing. Now we have 
> it. Let's call that progress, even though it may not look like one :-).
>
> One additional checkbox to tick is to make sure that the cachemgr.cgi 
> script you are using comes from the Squid version you are testing.
>
>
>> what am i missing, and is there a way to provide this functionality 
>> in 6.1?? if an external tool, or different package, is needed what is 
>> that?
>
> cachemgr.cgi is not my area of expertise, but I believe that, bugs 
> notwithstanding, the functionality you want should be available 
> without an external tool.
>
> The next step, AFAICT, is for you to detail:
>
> * what HTTP response cachemgr.cgi script gets from Squid and
> * what HTTP response your browser gets from cachemgr.cgi
>
> According to [2], Squid should send a 404 response to cachemgr.cgi. 
> You may be able to find some Squid response details (e.g., status 
> code) in Squid access.log. If your cachemgr.cgi is sending plain text 
> requests to Squid, you can also capture HTTP traffic to and from 
> cachemgr.cgi using tcpdump, wireshark, or similar tools.
>
> [2] https://github.com/squid-cache/squid/pull/1176#discussion_r1010645870
>
>
> Thank you,
>
> Alex.
>
>
>> On 7/29/23 12:22 PM, Alex Rousskov wrote:
>>> On 7/29/23 11:07, Brendan Kearney wrote:
>>>
>>>> the package installed does not have any file named MGR_INDEX. 
>>>> running "rpm -ql squid |grep -i index" does not return anything. 
>>>> searching in /usr/share/squid for the file does not find it, 
>>>> either. funny that neither the old version of squid, nor the new 
>>>> version of squid have that file at all.
>>>
>>> Yes, the lack of MGR_INDEX file in Squid sources is "by design" of 
>>> that MGR_INDEX feature -- an "external tool" is supposed to provide 
>>> that file in certain cases[1]. Please do not misinterpret my 
>>> statement as defense of the corresponding design decisions or their 
>>> side effects; I am just stating the facts rather than trying to 
>>> justify bad user experience.
>>>
>>> [1] 
>>> https://github.com/squid-cache/squid/pull/1176#discussion_r1010534845
>>>
>>>
>>> Alex.
>>>
>>>
>>>> @amos,
>>>>
>>>> i ran firefox with developer tools open, and browsed to the 
>>>> cachemgr URL, and reproduced the issue.? the traffic is not being 
>>>> proxied through squid, and is making the requests directly.? i am 
>>>> not sure if that is what you mean.? i saved the session as a HAR 
>>>> file, if that helps.
>>>>
>>>> thank you,
>>>>
>>>> brendan
>>>>
>>>> On 7/29/23 1:26 AM, Amos Jeffries wrote:
>>>>> On 29/07/23 14:42, Alex Rousskov wrote:
>>>>>> On 7/28/23 20:08, Brendan Kearney wrote:
>>>>>>
>>>>>>> i am running squid 6.1 on fedora 38, and cannot get the 
>>>>>>> cachemgr.cgi working on this box.? I am getting the error:
>>>>>>>
>>>>>>> Internal Error: Missing Template MGR_INDEX
>>>>>>>
>>>>>>> when i try to connect using the cache manager interface.
>>>>>>
>>>>>
>>>>> That is the expected output when you are trying to access the 
>>>>> manager interface directly from Squid. **Instead** of via the 
>>>>> cachemgr.cgi.
>>>>>
>>>>> If you want to try the new manager interface I have a prototype 
>>>>> javascript tool available at <https://github.com/yadij/cachemgr.js/>.
>>>>>
>>>>>
>>>>> Amos
>>>>> _______________________________________________
>>>>> squid-users mailing list
>>>>> squid-users at lists.squid-cache.org
>>>>> http://lists.squid-cache.org/listinfo/squid-users
>>>> _______________________________________________
>>>> squid-users mailing list
>>>> squid-users at lists.squid-cache.org
>>>> http://lists.squid-cache.org/listinfo/squid-users
>>>
>>> _______________________________________________
>>> squid-users mailing list
>>> squid-users at lists.squid-cache.org
>>> http://lists.squid-cache.org/listinfo/squid-users
>> _______________________________________________
>> squid-users mailing list
>> squid-users at lists.squid-cache.org
>> http://lists.squid-cache.org/listinfo/squid-users
>
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users


From squid at lunique.fr  Mon Jul 31 09:18:36 2023
From: squid at lunique.fr (=?UTF-8?Q?G=c3=a9rard_Parat?=)
Date: Mon, 31 Jul 2023 11:18:36 +0200
Subject: [squid-users] Problem with 6.1 squidclient mgr:
Message-ID: <97899e97-fa00-dcc3-6520-5f7cc53389d6@lunique.fr>

Hi all,

I use Squid as a Windows 10 service with Cygwin since 5.7 release.

I usually monitor activity with squidclient mgr: but since 6.1 it 
doesn't work anymore:

 ? * HTTP/1.1 403 Forbidden

However, squidclient cache_object://localhost/ is working fine.

Is there new options to add to squid.conf to access mgr: ?

Thanks,

G?rard



From parat.gerard at gmail.com  Mon Jul 31 10:13:43 2023
From: parat.gerard at gmail.com (=?UTF-8?Q?G=C3=A9rard_Parat?=)
Date: Mon, 31 Jul 2023 12:13:43 +0200
Subject: [squid-users] Problem with 6.1 squidclient mgr:
Message-ID: <CAJ6qB7KemeYiTdmYT0hkJ9TE9KD5X8Wk=i9Bv2RJZchDHcfcmQ@mail.gmail.com>

Hi all,

I use Squid as a Windows 10 service with Cygwin since 5.7 release.

I usually monitor activity with squidclient mgr: but since 6.1 it
doesn't work anymore:

  * HTTP/1.1 403 Forbidden

However, squidclient cache_object://localhost/ is working fine.

Is there new options to add to squid.conf to access mgr: ?

Thanks,

G?rard


From rousskov at measurement-factory.com  Mon Jul 31 13:47:10 2023
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Mon, 31 Jul 2023 09:47:10 -0400
Subject: [squid-users] Problem with 6.1 squidclient mgr:
In-Reply-To: <CAJ6qB7KemeYiTdmYT0hkJ9TE9KD5X8Wk=i9Bv2RJZchDHcfcmQ@mail.gmail.com>
References: <CAJ6qB7KemeYiTdmYT0hkJ9TE9KD5X8Wk=i9Bv2RJZchDHcfcmQ@mail.gmail.com>
Message-ID: <e610c30d-12ea-e703-7b95-7ddd6bf1021b@measurement-factory.com>

On 7/31/23 06:13, G?rard Parat wrote:

> I use Squid as a Windows 10 service with Cygwin since 5.7 release.
> 
> I usually monitor activity with squidclient mgr: but since 6.1 it
> doesn't work anymore:
> 
>    * HTTP/1.1 403 Forbidden
> 
> However, squidclient cache_object://localhost/ is working fine.
> 
> Is there new options to add to squid.conf to access mgr: ?

Does your Squid identify itself as "localhost" in Via headers and other 
output? If not, you are probably suffering from bug #5283:
https://bugs.squid-cache.org/show_bug.cgi?id=5283

There are several workarounds, including Squid patches, but no long-term 
solution yet. If you do not want to patch Squid, use "squidclient -h..." 
as suggested at https://bugs.squid-cache.org/show_bug.cgi?id=5283#c1


HTH,

Alex.



From rousskov at measurement-factory.com  Mon Jul 31 14:27:45 2023
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Mon, 31 Jul 2023 10:27:45 -0400
Subject: [squid-users] cachemgr.cgi & Internal Error: Missing Template
 MGR_INDEX
In-Reply-To: <40263f48-5c45-3ec9-85f6-fee4aba9dafa@gmail.com>
References: <d05e4ae5-3f30-9070-c33b-a9cae5958d60@gmail.com>
 <9f929826-4b70-896d-0729-ee815e64a568@measurement-factory.com>
 <367668dd-b7af-b2ca-63d9-afcb21f872a7@treenet.co.nz>
 <f70504f0-48f0-7651-257f-3543f9410087@gmail.com>
 <e04e1c59-b21e-725d-bb08-cf9bb05fcc31@measurement-factory.com>
 <9a6119d9-c7a6-8d8f-4292-79a5a99d17f3@gmail.com>
 <97b6e8fc-5760-c1b2-4c8e-590a764f5d0b@measurement-factory.com>
 <40263f48-5c45-3ec9-85f6-fee4aba9dafa@gmail.com>
Message-ID: <a60c2324-c5e3-6052-68e7-71a073d90cb7@measurement-factory.com>

On 7/30/23 11:25, Brendan Kearney wrote:
> the cachemgr.cgi i am using is packaged with the squid server i run, all 
> from the fedora rpm.? i have two instances, one older and one recently 
> upgraded.
> 
> you can see in the squid logs all of the requests. cachemgr.cgi/6.1 
> always returns a 404.? cachemgr.cgi/4.14 does work and is the instance 
> on the older box connecting/talking to the squid instance on the new 
> box.? i do get a 404 in the browser.

Assuming the log records your shared correspond to cachemgr.cgi 
communication with Squid, Squid answers with 404 to cachemgr.cgi/v6 
requests, as expected. Why cachemgr.cgi/v6 (allegedly) translates that 
expected 404 answer to a 404 response to the browser (instead of 
translating it to the expected 200 response), I do not know -- it could 
be a cachemgr.cgi/v6 bug or a problem with those expectations.


> are the below logs enough or would 
> it help if i am to run a packet capture?

This question is best answered by those who will be assisting you 
further. At this point, the information you have provided appears to 
clear Squid itself from wrongdoing (as I detailed above). I could help 
you with Squid, but I do not know enough about cachemgr.cgi and do not 
have enough free time to gain that knowledge (especially since I believe 
that tool should not be a part of Squid in the first place). I hope that 
others will volunteer to assist you with cachemgr.cgi.


Good luck,

Alex.


> [root at server2 ~]# journalctl -rlu squid |grep cachemgr.cgi
> Jul 29 10:56:04 server2 (squid-1)[288884]: 
> 192.168.88.2,server2.bpk2.com,-,29/Jul/2023:10:56:04 
> -0400,192.168.88.2,3128,-,"squid",GET,"HTTP/1.0","http://proxy2.bpk2.com:3128/squid-internal-mgr/","cachemgr.cgi/6.1",404,372,-,"TCP_MISS/HIER_NONE","text/html"
> Jul 29 10:55:29 server2 (squid-1)[288884]: 
> 192.168.88.2,server2.bpk2.com,-,29/Jul/2023:10:55:29 
> -0400,192.168.88.2,3128,-,"squid",GET,"HTTP/1.0","http://proxy2.bpk2.com:3128/squid-internal-mgr/","cachemgr.cgi/6.1",404,372,-,"TCP_MISS/HIER_NONE","text/html"
> Jul 29 10:54:38 server2 (squid-1)[288884]: 
> 192.168.88.2,192.168.88.2,-,29/Jul/2023:10:54:38 
> -0400,192.168.88.2,3128,-,"squid",GET,"HTTP/1.0","http://proxy2.bpk2.com:3128/squid-internal-mgr/","cachemgr.cgi/6.1",404,372,-,"TCP_MISS/HIER_NONE","text/html"
> Jul 28 20:02:08 server2 (squid-1)[227457]: 
> 192.168.88.2,server2.bpk2.com,-,28/Jul/2023:20:02:08 
> -0400,192.168.88.2,3128,-,"squid",GET,"HTTP/1.0","http://proxy2.bpk2.com:3128/squid-internal-mgr/","cachemgr.cgi/6.1",404,372,-,"TCP_MISS/HIER_NONE","text/html"
> Jul 28 19:55:00 server2 (squid-1)[227457]: 
> 192.168.88.2,server2.bpk2.com,-,28/Jul/2023:19:55:00 
> -0400,192.168.88.2,3128,-,"squid",GET,"HTTP/1.0","http://proxy2.bpk2.com:3128/squid-internal-mgr/","cachemgr.cgi/6.1",404,372,-,"TCP_MISS/HIER_NONE","text/html"
> Jul 28 13:13:48 server2 (squid-1)[227457]: 
> 192.168.88.1,server1.bpk2.com,-,28/Jul/2023:13:13:48 
> -0400,192.168.88.2,3128,-,"squid",GET,"HTTP/1.0","cache_object://server2.bpk2.com/config","cachemgr.cgi/4.14",200,18284,-,"TCP_MISS/HIER_NONE","text/plain"
> Jul 28 13:13:45 server2 (squid-1)[227457]: 
> 192.168.88.1,server1.bpk2.com,-,28/Jul/2023:13:13:45 
> -0400,192.168.88.2,3128,-,"squid",GET,"HTTP/1.0","cache_object://server2.bpk2.com/","cachemgr.cgi/4.14",200,3817,-,"TCP_MISS/HIER_NONE","text/plain"
> Jul 28 13:10:29 server2 (squid-1)[227457]: 
> 192.168.88.1,server1.bpk2.com,-,28/Jul/2023:13:10:29 
> -0400,192.168.88.2,3128,-,"squid",GET,"HTTP/1.0","cache_object://server2.bpk2.com/info","cachemgr.cgi/4.14",200,2571,-,"TCP_MISS/HIER_NONE","text/plain"
> Jul 28 13:10:24 server2 (squid-1)[227457]: 
> 192.168.88.1,server1.bpk2.com,-,28/Jul/2023:13:10:24 
> -0400,192.168.88.2,3128,-,"squid",GET,"HTTP/1.0","cache_object://server2.bpk2.com/menu","cachemgr.cgi/4.14",200,3817,-,"TCP_MISS/HIER_NONE","text/plain"
> Jul 28 13:10:12 server2 (squid-1)[227457]: 
> 192.168.88.1,server1.bpk2.com,-,28/Jul/2023:13:10:12 
> -0400,192.168.88.2,3128,-,"squid",GET,"HTTP/1.0","cache_object://server2.bpk2.com/idns","cachemgr.cgi/4.14",200,1545,-,"TCP_MISS/HIER_NONE","text/plain"
> Jul 28 13:10:10 server2 (squid-1)[227457]: 
> 192.168.88.1,server1.bpk2.com,-,28/Jul/2023:13:10:10 
> -0400,192.168.88.2,3128,-,"squid",GET,"HTTP/1.0","cache_object://server2.bpk2.com/menu","cachemgr.cgi/4.14",200,3817,-,"TCP_MISS/HIER_NONE","text/plain"
> Jul 28 13:10:03 server2 (squid-1)[227457]: 
> 192.168.88.1,server1.bpk2.com,-,28/Jul/2023:13:10:03 
> -0400,192.168.88.2,3128,-,"squid",GET,"HTTP/1.0","cache_object://server2.bpk2.com/fqdncache","cachemgr.cgi/4.14",200,1394,-,"TCP_MISS/HIER_NONE","text/plain"
> Jul 28 13:10:01 server2 (squid-1)[227457]: 
> 192.168.88.1,server1.bpk2.com,-,28/Jul/2023:13:10:01 
> -0400,192.168.88.2,3128,-,"squid",GET,"HTTP/1.0","cache_object://server2.bpk2.com/menu","cachemgr.cgi/4.14",200,3817,-,"TCP_MISS/HIER_NONE","text/plain"
> Jul 28 13:09:54 server2 (squid-1)[227457]: 
> 192.168.88.1,server1.bpk2.com,-,28/Jul/2023:13:09:54 
> -0400,192.168.88.2,3128,-,"squid",GET,"HTTP/1.0","cache_object://server2.bpk2.com/ipcache","cachemgr.cgi/4.14",200,201730,-,"TCP_MISS/HIER_NONE","text/plain"
> Jul 28 13:09:50 server2 (squid-1)[227457]: 
> 192.168.88.1,server1.bpk2.com,-,28/Jul/2023:13:09:50 
> -0400,192.168.88.2,3128,-,"squid",GET,"HTTP/1.0","cache_object://server2.bpk2.com/menu","cachemgr.cgi/4.14",200,3817,-,"TCP_MISS/HIER_NONE","text/plain"
> Jul 28 13:09:30 server2 (squid-1)[227457]: 
> 192.168.88.1,server1.bpk2.com,-,28/Jul/2023:13:09:30 
> -0400,192.168.88.2,3128,-,"squid",GET,"HTTP/1.0","cache_object://server2.bpk2.com/config","cachemgr.cgi/4.14",200,18284,-,"TCP_MISS/HIER_NONE","text/plain"
> Jul 28 13:09:26 server2 (squid-1)[227457]: 
> 192.168.88.1,server1.bpk2.com,-,28/Jul/2023:13:09:26 
> -0400,192.168.88.2,3128,-,"squid",GET,"HTTP/1.0","cache_object://server2.bpk2.com/","cachemgr.cgi/4.14",200,3817,-,"TCP_MISS/HIER_NONE","text/plain"
> Jul 28 13:08:44 server2 (squid-1)[227457]: 
> 192.168.88.2,server2.bpk2.com,-,28/Jul/2023:13:08:44 
> -0400,192.168.88.2,3128,-,"squid",GET,"HTTP/1.0","http://proxy2.bpk2.com:3128/squid-internal-mgr/","cachemgr.cgi/6.1",404,372,-,"TCP_MISS/HIER_NONE","text/html"
> Jul 28 13:04:46 server2 (squid-1)[227457]: 
> 192.168.88.2,server2.bpk2.com,-,28/Jul/2023:13:04:46 
> -0400,192.168.88.2,3128,-,"squid",GET,"HTTP/1.0","http://proxy2.bpk2.com:3128/squid-internal-mgr/","cachemgr.cgi/6.1",404,372,-,"TCP_MISS/HIER_NONE","text/html"
> Jul 28 13:03:30 server2 (squid-1)[227457]: 
> 192.168.88.2,server2.bpk2.com,-,28/Jul/2023:13:03:30 
> -0400,192.168.88.2,3128,-,"squid",GET,"HTTP/1.0","http://proxy2.bpk2.com:3128/squid-internal-mgr/","cachemgr.cgi/6.1",404,372,-,"TCP_MISS/HIER_NONE","text/html"
> Jul 28 13:01:02 server2 (squid-1)[227457]: 
> 192.168.88.2,server2.bpk2.com,-,28/Jul/2023:13:01:02 
> -0400,192.168.88.2,3128,-,"squid",GET,"HTTP/1.0","http://proxy2.bpk2.com:3128/squid-internal-mgr/","cachemgr.cgi/6.1",404,372,-,"TCP_MISS/HIER_NONE","text/html"
> Jul 28 12:59:15 server2 (squid-1)[227457]: 
> 192.168.88.2,server2.bpk2.com,-,28/Jul/2023:12:59:15 
> -0400,192.168.88.2,3128,-,"squid",GET,"HTTP/1.0","http://proxy2.bpk2.com:3128/squid-internal-mgr/","cachemgr.cgi/6.1",404,372,-,"TCP_MISS/HIER_NONE","text/html"
> Jul 28 12:59:11 server2 (squid-1)[227457]: 
> 192.168.88.2,server2.bpk2.com,-,28/Jul/2023:12:59:11 
> -0400,192.168.88.2,3128,-,"squid",GET,"HTTP/1.0","http://proxy2.bpk2.com:3128/squid-internal-mgr/","cachemgr.cgi/6.1",404,372,-,"TCP_MISS/HIER_NONE","text/html"
> Jul 28 12:58:27 server2 (squid-1)[227457]: 
> 192.168.88.2,server2.bpk2.com,-,28/Jul/2023:12:58:27 
> -0400,192.168.88.2,3128,-,"squid",GET,"HTTP/1.0","http://proxy2.bpk2.com:3128/squid-internal-mgr/","cachemgr.cgi/6.1",404,372,-,"TCP_MISS/HIER_NONE","text/html"
> Jul 28 12:58:14 server2 (squid-1)[227457]: 
> 192.168.88.2,server2.bpk2.com,-,28/Jul/2023:12:58:14 
> -0400,192.168.88.2,3128,-,"squid",GET,"HTTP/1.0","http://proxy2.bpk2.com:3128/squid-internal-mgr/","cachemgr.cgi/6.1",404,372,-,"TCP_MISS/HIER_NONE","text/html"
> 
> On 7/29/23 4:01 PM, Alex Rousskov wrote:
>> On 7/29/23 12:31, Brendan Kearney wrote:
>>> i am not following.
>>
>> Sorry, I was just gathering evidence and explaining what you saw. I 
>> have not confirmed a bug and have not been offering a solution (yet?).
>>
>>
>>> squid 4.14 on fedora 32 does not have the file, nor does it exhibit 
>>> the issue.
>>
>>> squid 6.1 on fedora 38 does not have the file, but does exhibit the 
>>> issue.
>>
>> ... and you do not have a MGR_INDEX file and, presumably, did not have 
>> that file before. That piece of information was missing. Now we have 
>> it. Let's call that progress, even though it may not look like one :-).
>>
>> One additional checkbox to tick is to make sure that the cachemgr.cgi 
>> script you are using comes from the Squid version you are testing.
>>
>>
>>> what am i missing, and is there a way to provide this functionality 
>>> in 6.1?? if an external tool, or different package, is needed what is 
>>> that?
>>
>> cachemgr.cgi is not my area of expertise, but I believe that, bugs 
>> notwithstanding, the functionality you want should be available 
>> without an external tool.
>>
>> The next step, AFAICT, is for you to detail:
>>
>> * what HTTP response cachemgr.cgi script gets from Squid and
>> * what HTTP response your browser gets from cachemgr.cgi
>>
>> According to [2], Squid should send a 404 response to cachemgr.cgi. 
>> You may be able to find some Squid response details (e.g., status 
>> code) in Squid access.log. If your cachemgr.cgi is sending plain text 
>> requests to Squid, you can also capture HTTP traffic to and from 
>> cachemgr.cgi using tcpdump, wireshark, or similar tools.
>>
>> [2] https://github.com/squid-cache/squid/pull/1176#discussion_r1010645870
>>
>>
>> Thank you,
>>
>> Alex.
>>
>>
>>> On 7/29/23 12:22 PM, Alex Rousskov wrote:
>>>> On 7/29/23 11:07, Brendan Kearney wrote:
>>>>
>>>>> the package installed does not have any file named MGR_INDEX. 
>>>>> running "rpm -ql squid |grep -i index" does not return anything. 
>>>>> searching in /usr/share/squid for the file does not find it, 
>>>>> either. funny that neither the old version of squid, nor the new 
>>>>> version of squid have that file at all.
>>>>
>>>> Yes, the lack of MGR_INDEX file in Squid sources is "by design" of 
>>>> that MGR_INDEX feature -- an "external tool" is supposed to provide 
>>>> that file in certain cases[1]. Please do not misinterpret my 
>>>> statement as defense of the corresponding design decisions or their 
>>>> side effects; I am just stating the facts rather than trying to 
>>>> justify bad user experience.
>>>>
>>>> [1] 
>>>> https://github.com/squid-cache/squid/pull/1176#discussion_r1010534845
>>>>
>>>>
>>>> Alex.
>>>>
>>>>
>>>>> @amos,
>>>>>
>>>>> i ran firefox with developer tools open, and browsed to the 
>>>>> cachemgr URL, and reproduced the issue.? the traffic is not being 
>>>>> proxied through squid, and is making the requests directly.? i am 
>>>>> not sure if that is what you mean.? i saved the session as a HAR 
>>>>> file, if that helps.
>>>>>
>>>>> thank you,
>>>>>
>>>>> brendan
>>>>>
>>>>> On 7/29/23 1:26 AM, Amos Jeffries wrote:
>>>>>> On 29/07/23 14:42, Alex Rousskov wrote:
>>>>>>> On 7/28/23 20:08, Brendan Kearney wrote:
>>>>>>>
>>>>>>>> i am running squid 6.1 on fedora 38, and cannot get the 
>>>>>>>> cachemgr.cgi working on this box.? I am getting the error:
>>>>>>>>
>>>>>>>> Internal Error: Missing Template MGR_INDEX
>>>>>>>>
>>>>>>>> when i try to connect using the cache manager interface.
>>>>>>>
>>>>>>
>>>>>> That is the expected output when you are trying to access the 
>>>>>> manager interface directly from Squid. **Instead** of via the 
>>>>>> cachemgr.cgi.
>>>>>>
>>>>>> If you want to try the new manager interface I have a prototype 
>>>>>> javascript tool available at <https://github.com/yadij/cachemgr.js/>.
>>>>>>
>>>>>>
>>>>>> Amos
>>>>>> _______________________________________________
>>>>>> squid-users mailing list
>>>>>> squid-users at lists.squid-cache.org
>>>>>> http://lists.squid-cache.org/listinfo/squid-users
>>>>> _______________________________________________
>>>>> squid-users mailing list
>>>>> squid-users at lists.squid-cache.org
>>>>> http://lists.squid-cache.org/listinfo/squid-users
>>>>
>>>> _______________________________________________
>>>> squid-users mailing list
>>>> squid-users at lists.squid-cache.org
>>>> http://lists.squid-cache.org/listinfo/squid-users
>>> _______________________________________________
>>> squid-users mailing list
>>> squid-users at lists.squid-cache.org
>>> http://lists.squid-cache.org/listinfo/squid-users
>>
>> _______________________________________________
>> squid-users mailing list
>> squid-users at lists.squid-cache.org
>> http://lists.squid-cache.org/listinfo/squid-users
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users



From botpena at gmail.com  Mon Jul 31 15:26:38 2023
From: botpena at gmail.com (botp)
Date: Mon, 31 Jul 2023 23:26:38 +0800
Subject: [squid-users] compile error in squid v6.1
Message-ID: <CAAwHHQjgZ-v61t0uH5kJSraWzMXVK3qRUnv2v0M7F_yop6OQ0g@mail.gmail.com>

Hi All,

' been  compiling (using default setting) squid since v5, my last version
was 5.9, but, when i tried 6.1, i get the following error (enclosed in
dashed lines):
---------------------------------------------
In file included from ActionParams.cc:13:0:
../../src/ipc/TypedMsgHdr.h: In instantiation of ?void
Ipc::TypedMsgHdr::getPod(Pod&) const [with Pod = RequestFlags]?:
ActionParams.cc:29:25:   required from here
../../src/ipc/TypedMsgHdr.h:120:5: error: static assertion failed: getPod()
used for a POD
     static_assert(std::is_trivially_copyable<Pod>::value, "getPod() used
for a POD");
     ^~~~~~~~~~~~~
../../src/ipc/TypedMsgHdr.h: In instantiation of ?void
Ipc::TypedMsgHdr::putPod(const Pod&) [with Pod = RequestFlags]?:
ActionParams.cc:44:25:   required from here
../../src/ipc/TypedMsgHdr.h:128:5: error: static assertion failed: putPod()
used for a POD
     static_assert(std::is_trivially_copyable<Pod>::value, "putPod() used
for a POD");
     ^~~~~~~~~~~~~
Makefile:894: recipe for target 'ActionParams.lo' failed
---------------------------

my steps are just basic:
1. ./configure
2. make
3. make install

they work fine, until i tried v6.1.

its obvious i have no knowledge on this. any help is highly appreciated.

thanks and kind regards
--botp
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230731/2cdf5979/attachment.htm>

From Antony.Stone at squid.open.source.it  Mon Jul 31 15:31:06 2023
From: Antony.Stone at squid.open.source.it (Antony Stone)
Date: Mon, 31 Jul 2023 17:31:06 +0200
Subject: [squid-users] compile error in squid v6.1
In-Reply-To: <CAAwHHQjgZ-v61t0uH5kJSraWzMXVK3qRUnv2v0M7F_yop6OQ0g@mail.gmail.com>
References: <CAAwHHQjgZ-v61t0uH5kJSraWzMXVK3qRUnv2v0M7F_yop6OQ0g@mail.gmail.com>
Message-ID: <202307311731.06579.Antony.Stone@squid.open.source.it>

On Monday 31 July 2023 at 17:26:38, botp wrote:

> Hi All,
> 
> ' been  compiling

It might help to tell us what sort of system you're compiling it on:

 - operating system
 - version
 - compiler name
 - compiler version


Antony.

-- 
"I estimate there's a world market for about five computers."

 - Thomas J Watson, Chairman of IBM

                                                   Please reply to the list;
                                                         please *don't* CC me.


From rousskov at measurement-factory.com  Mon Jul 31 16:05:27 2023
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Mon, 31 Jul 2023 12:05:27 -0400
Subject: [squid-users] compile error in squid v6.1
In-Reply-To: <CAAwHHQjgZ-v61t0uH5kJSraWzMXVK3qRUnv2v0M7F_yop6OQ0g@mail.gmail.com>
References: <CAAwHHQjgZ-v61t0uH5kJSraWzMXVK3qRUnv2v0M7F_yop6OQ0g@mail.gmail.com>
Message-ID: <575eb2df-c8f5-6c93-6aad-8ce4c5cf385e@measurement-factory.com>

On 7/31/23 11:26, botp wrote:
> Hi All,
> 
> ' been? compiling (using default setting) squid since v5, my last 
> version was 5.9, but, when i tried 6.1, i get the?following error 
> (enclosed in dashed lines):
> ---------------------------------------------
> src/ipc/TypedMsgHdr.h:120:5: error: static assertion failed: 
> getPod() used for a POD
>  ? ? ?static_assert(std::is_trivially_copyable<Pod>::value, "getPod() 
> used for a POD");
> ---------------------------

IIRC, this error implies that your compiler does not fully support 
C++17. Squid v6 requires decent C++17 support.

If I am right, then you will need to use a different/modern compiler 
(but consider filing an enhancement request with Squid Bugzilla to 
improve Squid handling of this specific problem -- our ./configure 
should fail with a user-friendly error instead of the current outcome).


HTH,

Alex.



