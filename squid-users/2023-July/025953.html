<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] [EXTERNAL] Re: 4.0.23 -&gt; 5.9 : ERROR: Failed to acquire TLS certificate '/etc/pki/tls/private/xy.pem': error:0480006C:PEM routines::no start line
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20%5BEXTERNAL%5D%20Re%3A%204.0.23%20-%3E%205.9%20%3A%20ERROR%3A%20Failed%20to%0A%20acquire%20TLS%20certificate%20%27/etc/pki/tls/private/xy.pem%27%3A%20error%3A0480006C%3APEM%0A%20routines%3A%3Ano%20start%20line&In-Reply-To=%3CDM6PR10MB374048551AB3C0DE1501AB80B336A%40DM6PR10MB3740.namprd10.prod.outlook.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="025952.html">
   <LINK REL="Next"  HREF="025976.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] [EXTERNAL] Re: 4.0.23 -&gt; 5.9 : ERROR: Failed to acquire TLS certificate '/etc/pki/tls/private/xy.pem': error:0480006C:PEM routines::no start line</H1>
    <B>Hannes Fasching</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20%5BEXTERNAL%5D%20Re%3A%204.0.23%20-%3E%205.9%20%3A%20ERROR%3A%20Failed%20to%0A%20acquire%20TLS%20certificate%20%27/etc/pki/tls/private/xy.pem%27%3A%20error%3A0480006C%3APEM%0A%20routines%3A%3Ano%20start%20line&In-Reply-To=%3CDM6PR10MB374048551AB3C0DE1501AB80B336A%40DM6PR10MB3740.namprd10.prod.outlook.com%3E"
       TITLE="[squid-users] [EXTERNAL] Re: 4.0.23 -&gt; 5.9 : ERROR: Failed to acquire TLS certificate '/etc/pki/tls/private/xy.pem': error:0480006C:PEM routines::no start line">hfasching at barracuda.com
       </A><BR>
    <I>Wed Jul 12 07:09:35 UTC 2023</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="025952.html">[squid-users] 4.0.23 -&gt; 5.9 : ERROR: Failed to acquire TLS certificate '/etc/pki/tls/private/xy.pem': error:0480006C:PEM routines::no start line
</A></li>
        <LI>Next message (by thread): <A HREF="025976.html">[squid-users] [EXTERNAL] Re: 4.0.23 -&gt; 5.9 : ERROR: Failed to acquire TLS certificate '/etc/pki/tls/private/xy.pem': error:0480006C:PEM routines::no start line
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25953">[ date ]</a>
              <a href="thread.html#25953">[ thread ]</a>
              <a href="subject.html#25953">[ subject ]</a>
              <a href="author.html#25953">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi!
we had the same problem when we switched from openssl 1.1 to openssl 3 with certificates using the SHA1 algorithm for signature. The reason for this was in openssl 3 SHA1 is deprecated.

Kind regards,
&#8203;Hannes


Von: squid-users &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>&gt;
Gesendet: Dienstag, 11. Juli 2023 19:34
An: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A> &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>&gt;
Betreff: [EXTERNAL] Re: [squid-users] 4.0.23 -&gt; 5.9 : ERROR: Failed to acquire TLS certificate '/etc/pki/tls/private/xy.pem': error:0480006C:PEM routines::no start line

On 7/10/23 14:50, Franta Hanzl&#237;k wrote:
&gt;<i> After upgrading my Fedora 27/Squid-4.0.23 to Fedora 38/Squid-5.9, the
</I>&gt;<i> Squid refuses to start with the error message:
</I>&gt;<i>
</I>&gt;<i> ERROR: Failed to acquire TLS certificate '/etc/pki/tls/private/server.pem': error:0480006C:PEM routines::no start line
</I>
I suspect the actual problem is different than &quot;no start line&quot;. Due to a
mismatch between OpenSSL error handling approach and Squid code, Squid
often reports wrong/stale/irrelevant OpenSSL errors. Certificate loading
code is especially prone to such mismatches! Refactoring OpenSSL error
handling is an known to-do item.

Several different things could go wrong while showing the above
symptoms, and there are several ways to troubleshoot this, but I would
start with the following simple test.

Run the following (or similar) command on the same machine as Squid,
using the same OS user as Squid (&quot;nobody&quot; in the example below), using
the openssl tool from the same OpenSSL version as Squid was built with:

     sudo -u nobody \
     openssl x509 -in /etc/pki/tls/private/server.pem -noout -subject

You should see the certificate subject field. Any warnings or errors?

If the above works fine, and the certificate file ownership/permissions
look reasonable to you, then the next step could be to start Squid under
&quot;strace&quot; or a similar tool to check whether some system call fails when
OpenSSL is trying to load that certificate file. In most cases, you
should be able to find the certificate filename in strace output and
check for subsequent syscall errors (e.g., permission denied). We can
help with that analysis, but be careful with posting private key
contents. If you can, temporary replace that production certificate with
some throw-away/temporary/example one.

Beyond that, I would recommend patching Squid to report the last OpenSSL
error instead of the first one (in this context). This will require you
to rebuild your Squid from sources. Please let me know if you want to
pursue that and I will provide a patch.


HTH,

Alex.

&gt;<i> The problem is probably related to the reverse https proxy definition
</I>&gt;<i> line in squid.conf :
</I>&gt;<i> https_port 192.168.20.2:22225 accel cert=/etc/pki/tls/private/server.pem defaultsite=mail.kyenar.cz no-vhost name=reverzpe
</I>
&gt;<i> server.pem is the symlink to realFile.pem with this content:
</I>&gt;<i> -----BEGIN RSA PRIVATE KEY-----
</I>&gt;<i> MIIEpQ...
</I>&gt;<i> ...
</I>&gt;<i> ...vo=
</I>&gt;<i> -----END RSA PRIVATE KEY-----
</I>&gt;<i>
</I>&gt;<i> -----BEGIN CERTIFICATE-----
</I>&gt;<i> MIIGO...
</I>&gt;<i> ...
</I>&gt;<i> ...c5s=
</I>&gt;<i> -----END CERTIFICATE-----
</I>&gt;<i>
</I>&gt;<i> and it worked fine in the older Squid-4.0.23 version.
</I>&gt;<i>
</I>&gt;<i> I tried:
</I>&gt;<i> - tls-cert= instead of cert=
</I>&gt;<i> - replacing the symlink server.pem with a real file.
</I>&gt;<i> - arrange certificate in PEM file as first and key second
</I>&gt;<i> - split PEM file into separate certificate and key and use it with syntax:
</I>&gt;<i>
</I>&gt;<i> https_port 192.168.20.2:22225 accel tls-cert=/etc/pki/tls/private/cert.pem tls-key=/etc/pki/tls/private/key.pem defaultsite=mail.kyenar.cz no-vhost name=reverzpe
</I>&gt;<i>
</I>&gt;<i> but squid still not start with this same message:
</I>&gt;<i> ERROR: Failed to acquire TLS certificate '/etc/pki/tls/private/cert.pem': error:0480006C:PEM routines::no start line
</I>&gt;<i>
</I>&gt;<i> Can anyone help?
</I>&gt;<i> ---
</I>&gt;<i> Thanks in advance! Franta Hanzlik
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>
_______________________________________________
squid-users mailing list
<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
<A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>

Get the 13 Email Threat Types eBook

<A HREF="https://www.barracuda.com/">https://www.barracuda.com/</A>

This e-mail and any attachments to it contain confidential and proprietary material of Barracuda, its affiliates or agents, and is solely for the use of the intended recipient. Any review, use, disclosure, distribution or copying of this transmittal is prohibited except by or on behalf of the intended recipient. If you have received this transmittal in error, please notify the sender and destroy this e-mail and any attachments and all copies, whether electronic or printed.

________________________________
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="025952.html">[squid-users] 4.0.23 -&gt; 5.9 : ERROR: Failed to acquire TLS certificate '/etc/pki/tls/private/xy.pem': error:0480006C:PEM routines::no start line
</A></li>
	<LI>Next message (by thread): <A HREF="025976.html">[squid-users] [EXTERNAL] Re: 4.0.23 -&gt; 5.9 : ERROR: Failed to acquire TLS certificate '/etc/pki/tls/private/xy.pem': error:0480006C:PEM routines::no start line
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25953">[ date ]</a>
              <a href="thread.html#25953">[ thread ]</a>
              <a href="subject.html#25953">[ subject ]</a>
              <a href="author.html#25953">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
