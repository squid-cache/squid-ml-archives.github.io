<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Stack overflow with large IP lists
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Stack%20overflow%20with%20large%20IP%20lists&In-Reply-To=%3Cbae25019-58e0-a19b-8315-ff0809c1cd0d%40web.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="025991.html">
   <LINK REL="Next"  HREF="025993.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Stack overflow with large IP lists</H1>
    <B>magri at web.de</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Stack%20overflow%20with%20large%20IP%20lists&In-Reply-To=%3Cbae25019-58e0-a19b-8315-ff0809c1cd0d%40web.de%3E"
       TITLE="[squid-users] Stack overflow with large IP lists">magri at web.de
       </A><BR>
    <I>Wed Jul 26 15:25:18 UTC 2023</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="025991.html">[squid-users] Squid Proxy - Block Access Why ?
</A></li>
        <LI>Next message (by thread): <A HREF="025993.html">[squid-users] Stack overflow with large IP lists
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25992">[ date ]</a>
              <a href="thread.html#25992">[ thread ]</a>
              <a href="subject.html#25992">[ subject ]</a>
              <a href="author.html#25992">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi squid community,

we experience segfaults with squid 6.1 (and also older versions) during
&quot;squid -k reconfigure&quot; on several linux systems, caused by a stack overflow.

The circumstances are rather special:

- we have a huge dst ip blacklist (&gt; 300.000 enties)
- this original list is sorted (by raw ip value)
- the proxy is a hot standby system so there are no client requests
   between start of squid and reconfigure

We could trace the cause of the segfault to the destroy-method of
SplayNode (in include/splay.h):
- destroy of the top node is run on every reconfigure
- destroy is recursive, so the function calls stack on the stack :-)
   up to the depth of the splay tree
- the insertion of an ordered ip list into the splay tree creates a
   degenerate splay tree (each node has only a left child) with a depth
   of the number of ip entries in the list
- due to the inactivity of the proxy there is no rebalancing of the
   tree through find calls

On amd64 every stack frame needs 32 byte. So the regular linux stack of
8 MB can hold about ~262.000 stack frames. On other architectures
the limit is reached even faster (s390x: 160 bytes per stack frame -&gt;
52.000 frames).

We tried to increase the stack size via ulimits and systemd, but though
the squid master process got the increased limits, the kid-processes are
always spawned with a soft limit of 8 MB and crash on reaching it.
Only forcing a new soft limit via prlimit on an already running kid
could avoid the crash.

I've attached a patch that modifies the destroy method of SplayNode to
avoid recursive calls of destroy in single child nodes by moving the
subtrees of the child to the parent node before destroying the child non
recursively.
With this patch we could no longer reproduce the segfaults, even with a
list of 10.000.000 ordered ips.

Any ideas, comments, better solutions?

Thanks in advance for any advice.

best regards
  Martin











-------------- next part --------------
A non-text attachment was scrubbed...
Name: splaynode_destroy_workaround.patch
Type: text/x-patch
Size: 1283 bytes
Desc: not available
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20230726/f41bc228/attachment.bin">http://lists.squid-cache.org/pipermail/squid-users/attachments/20230726/f41bc228/attachment.bin</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="025991.html">[squid-users] Squid Proxy - Block Access Why ?
</A></li>
	<LI>Next message (by thread): <A HREF="025993.html">[squid-users] Stack overflow with large IP lists
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25992">[ date ]</a>
              <a href="thread.html#25992">[ thread ]</a>
              <a href="subject.html#25992">[ subject ]</a>
              <a href="author.html#25992">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
