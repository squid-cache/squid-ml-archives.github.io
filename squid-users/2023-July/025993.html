<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Stack overflow with large IP lists
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Stack%20overflow%20with%20large%20IP%20lists&In-Reply-To=%3C83a4285a-3c1b-8ea1-507e-fd2d51631eca%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="025992.html">
   <LINK REL="Next"  HREF="025994.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Stack overflow with large IP lists</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Stack%20overflow%20with%20large%20IP%20lists&In-Reply-To=%3C83a4285a-3c1b-8ea1-507e-fd2d51631eca%40measurement-factory.com%3E"
       TITLE="[squid-users] Stack overflow with large IP lists">rousskov at measurement-factory.com
       </A><BR>
    <I>Wed Jul 26 16:22:21 UTC 2023</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="025992.html">[squid-users] Stack overflow with large IP lists
</A></li>
        <LI>Next message (by thread): <A HREF="025994.html">[squid-users] Stack overflow with large IP lists
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25993">[ date ]</a>
              <a href="thread.html#25993">[ thread ]</a>
              <a href="subject.html#25993">[ subject ]</a>
              <a href="author.html#25993">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 7/26/23 11:25, <A HREF="https://lists.squid-cache.org/listinfo/squid-users">magri at web.de</A> wrote:

&gt;<i> I've attached a patch that modifies the destroy method of SplayNode
</I>&gt;<i> to avoid recursive calls of destroy in single child nodes by moving
</I>&gt;<i> the subtrees of the child to the parent node before destroying the
</I>&gt;<i> child non recursively.
</I>
Hi Martin,

     Thanks a lot for sharing your well-documented fix! Would you be 
willing to post it as a GitHub Pull Request? If you do, then the 
following questions can be discussed on GitHub instead:

* The patch reduces recursion during tree destruction. Squid splay tree 
implementation contains other recursive operations (e.g., visit()). 
Would not those other operations suffer from the same problem if left 
untouched? (And, if they are immune, then why not mimic their wonderful 
code to destroy the tree as well?!)

* The proposed patch still destroys one child recursively (when both 
children are present). That feels like an incomplete solution that will 
still hit stack limits on some trees. I do understand that you are 
addressing a specific case of an idle Squid with a freshly configured 
degenerate tree, but there ought to be other cases that lead to similar 
results as well (accidentally or with a malicious actor help). Have you 
considered removing recursion completely instead (by using more heap 
memory as needed)?

* I am curious whether your specific use case (going beyond splay tree 
destruction) be better addressed by a different storage type than splay 
trees. For example, have you considered whether using a IP 
address-friendly hash would be faster for, say, one million IP addresses?


Cheers,

Alex.


On 7/26/23 11:25, <A HREF="https://lists.squid-cache.org/listinfo/squid-users">magri at web.de</A> wrote:
&gt;<i> Hi squid community,
</I>&gt;<i> 
</I>&gt;<i> we experience segfaults with squid 6.1 (and also older versions) during
</I>&gt;<i> &quot;squid -k reconfigure&quot; on several linux systems, caused by a stack 
</I>&gt;<i> overflow.
</I>&gt;<i> 
</I>&gt;<i> The circumstances are rather special:
</I>&gt;<i> 
</I>&gt;<i> - we have a huge dst ip blacklist (&gt; 300.000 enties)
</I>&gt;<i> - this original list is sorted (by raw ip value)
</I>&gt;<i> - the proxy is a hot standby system so there are no client requests
</I>&gt;<i>  &#160; between start of squid and reconfigure
</I>&gt;<i> 
</I>&gt;<i> We could trace the cause of the segfault to the destroy-method of
</I>&gt;<i> SplayNode (in include/splay.h):
</I>&gt;<i> - destroy of the top node is run on every reconfigure
</I>&gt;<i> - destroy is recursive, so the function calls stack on the stack :-)
</I>&gt;<i>  &#160; up to the depth of the splay tree
</I>&gt;<i> - the insertion of an ordered ip list into the splay tree creates a
</I>&gt;<i>  &#160; degenerate splay tree (each node has only a left child) with a depth
</I>&gt;<i>  &#160; of the number of ip entries in the list
</I>&gt;<i> - due to the inactivity of the proxy there is no rebalancing of the
</I>&gt;<i>  &#160; tree through find calls
</I>&gt;<i> 
</I>&gt;<i> On amd64 every stack frame needs 32 byte. So the regular linux stack of
</I>&gt;<i> 8 MB can hold about ~262.000 stack frames. On other architectures
</I>&gt;<i> the limit is reached even faster (s390x: 160 bytes per stack frame -&gt;
</I>&gt;<i> 52.000 frames).
</I>&gt;<i> 
</I>&gt;<i> We tried to increase the stack size via ulimits and systemd, but though
</I>&gt;<i> the squid master process got the increased limits, the kid-processes are
</I>&gt;<i> always spawned with a soft limit of 8 MB and crash on reaching it.
</I>&gt;<i> Only forcing a new soft limit via prlimit on an already running kid
</I>&gt;<i> could avoid the crash.
</I>&gt;<i> 
</I>&gt;<i> I've attached a patch that modifies the destroy method of SplayNode to
</I>&gt;<i> avoid recursive calls of destroy in single child nodes by moving the
</I>&gt;<i> subtrees of the child to the parent node before destroying the child non
</I>&gt;<i> recursively.
</I>&gt;<i> With this patch we could no longer reproduce the segfaults, even with a
</I>&gt;<i> list of 10.000.000 ordered ips.
</I>&gt;<i> 
</I>&gt;<i> Any ideas, comments, better solutions?
</I>&gt;<i> 
</I>&gt;<i> Thanks in advance for any advice.
</I>&gt;<i> 
</I>&gt;<i> best regards
</I>&gt;<i>  &#160;Martin
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="025992.html">[squid-users] Stack overflow with large IP lists
</A></li>
	<LI>Next message (by thread): <A HREF="025994.html">[squid-users] Stack overflow with large IP lists
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25993">[ date ]</a>
              <a href="thread.html#25993">[ thread ]</a>
              <a href="subject.html#25993">[ subject ]</a>
              <a href="author.html#25993">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
