<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Proxy server to support a large number of simultaneous requests
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Proxy%20server%20to%20support%20a%20large%20number%20of%0A%20simultaneous%20requests&In-Reply-To=%3C6087ae32-c719-d2da-170a-7116554e1421%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="025854.html">
   <LINK REL="Next"  HREF="025856.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Proxy server to support a large number of simultaneous requests</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Proxy%20server%20to%20support%20a%20large%20number%20of%0A%20simultaneous%20requests&In-Reply-To=%3C6087ae32-c719-d2da-170a-7116554e1421%40measurement-factory.com%3E"
       TITLE="[squid-users] Proxy server to support a large number of simultaneous requests">rousskov at measurement-factory.com
       </A><BR>
    <I>Thu Jun  1 16:15:06 UTC 2023</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="025854.html">[squid-users] Proxy server to support a large number of simultaneous requests
</A></li>
        <LI>Next message (by thread): <A HREF="025856.html">[squid-users] Proxy server to support a large number of simultaneous requests
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25855">[ date ]</a>
              <a href="thread.html#25855">[ thread ]</a>
              <a href="subject.html#25855">[ subject ]</a>
              <a href="author.html#25855">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 6/1/23 05:20, Andrey K wrote:

&gt;<i>  &gt; The next step I would recommend is to study the very first cache miss
</I>&gt;<i>  &gt; _after_ the 500 or 200 concurrent threads test. Doing so may shed light
</I>&gt;<i>  &gt; on why Squid is refusing to serve that (presumably cached) object from
</I>&gt;<i>  &gt; the cache. I suspect that the object was marked for deletion earlier
</I>
&gt;<i> openForReadingAt: cannot open marked entry 11138 for reading cache_mem_map
</I>&gt;<i> openForReadingAt: cannot open marked entry 719406 for reading /data/squid.user/cache_map
</I>

The debugging log you have shared confirms that Squid deleted[1] the 
previously cached entry, from both caches (memory and disk). Now comes 
the hard part -- figuring out why Squid deleted that entry.

&gt;<i> I cleared the rock cache, changed the squid.conf (added debug_options
</I>&gt;<i> ALL,9), restarted the squid, ran a test with 500 concurrent threads
</I>
Can you repeat this test and share a pointer to the corresponding 
compressed cache.log, containing those 500 (or fewer, as long as the 
problem is reproduced!) concurrent transactions. One or many of those 
concurrent transactions resulted in the unwanted entry deletion. The log 
may show what happened in that case.

FWIW, I do not recommend spending your time analyzing that huge log. 
Efficient analysis requires specialized knowledge in this case. I will 
share the results here, of course.


Thank you,

Alex.

[1] That entry deletion does not imply that all (or any) of the cached 
entry bytes are gone from the cache file on disk. It is likely that only 
the shared memory _index_ for that disk file was adjusted in your micro 
test. That index adjustment is enough for Squid to declare a cache miss.


&gt;<i> &#1089;&#1088;, 31 &#1084;&#1072;&#1103; 2023&#8239;&#1075;. &#1074; 16:43, Alex Rousskov:
</I>&gt;<i> 
</I>&gt;<i>     On 5/31/23 02:56, Andrey K wrote:
</I>&gt;<i> 
</I>&gt;<i>      &gt;&#160; &gt; Do you get close to 100% hit ratio if clients access these URLs
</I>&gt;<i>      &gt;&#160; &gt; sequentially rather than concurrently? If not, then focus on that
</I>&gt;<i>      &gt;&#160; &gt; problem before you open the collapsed forwarding Pandora box.
</I>&gt;<i>      &gt; When I run curl sequentially&#160;like this:
</I>&gt;<i>      &gt; for i in `seq 500`; do curl --tlsv1.2 -k &#160; --proxy 0001vsg01:3131
</I>&gt;<i>      &#160;-v
</I>&gt;<i>      &gt; $URL&#160;&#160;&gt;/dev/null 2&gt;&amp;1; done
</I>&gt;<i>      &gt; I get only the first request with a status TCP_MISS&#160;and all
</I>&gt;<i>     others with
</I>&gt;<i>      &gt; TCP_MEM_HIT:
</I>&gt;<i>      &gt;&#160; &#160; &#160; Cnt Status&#160; &#160; &#160; &#160; &#160; &#160; Parent
</I>&gt;<i>      &gt;&#160; &#160; 499 TCP_MEM_HIT/200/- HIER_NONE/-
</I>&gt;<i>      &gt;&#160; &#160; &#160; &#160; 1 TCP_MISS/200/200 FIRSTUP_PARENT/parent_proxy
</I>&gt;<i> 
</I>&gt;<i>     Excellent. This confirms that your Squid can successfully cache this
</I>&gt;<i>     object (in memory).
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i>      &gt; It is interesting to note that on both squid versions if I run a
</I>&gt;<i>      &gt; separate curl after processing 500 or 200 concurrent threads, I
</I>&gt;<i>     get a
</I>&gt;<i>      &gt; result with the status TCP_MISS/200
</I>&gt;<i> 
</I>&gt;<i>     The next step I would recommend is to study the very first cache miss
</I>&gt;<i>     _after_ the 500 or 200 concurrent threads test. Doing so may shed light
</I>&gt;<i>     on why Squid is refusing to serve that (presumably cached) object from
</I>&gt;<i>     the cache. I suspect that the object was marked for deletion earlier,
</I>&gt;<i>     but we should check before spending more time on more complex triage of
</I>&gt;<i>     concurrent cases. If you can share a (link to) compressed ALL,9
</I>&gt;<i>     cache.log from that single transaction against Squid v6, I may be able
</I>&gt;<i>     to help you with that step.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i>     Cheers,
</I>&gt;<i> 
</I>&gt;<i>     Alex.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i>      &gt;&#160; &gt; What is your Squid version? Older Squids have more collapsed
</I>&gt;<i>     forwarding
</I>&gt;<i>      &gt;&#160; &gt; bugs than newer ones. I recommend testing with Squid v6 or
</I>&gt;<i>     master/v7, at
</I>&gt;<i>      &gt;&#160; &gt; least to confirm that the problem is still present in the latest
</I>&gt;<i>      &gt;&#160; &gt; official code.
</I>&gt;<i>      &gt; I run tests on SQUID 5.9.
</I>&gt;<i>      &gt; We compiled&#160;6.0.2 (with disabled delay-pools) and increased memory
</I>&gt;<i>      &gt; parameters:
</I>&gt;<i>      &gt;&#160; &#160; cache_mem 2048 MB
</I>&gt;<i>      &gt;&#160; &#160; maximum_object_size_in_memory 10 MB
</I>&gt;<i>      &gt; The complete configuration is shown below.
</I>&gt;<i>      &gt;
</I>&gt;<i>      &gt; Now on the version 6.0.2 we have the next results:
</I>&gt;<i>      &gt; 500 threads -&#160; Hit ratio 3.8%:
</I>&gt;<i>      &gt;&#160; &#160; &#160; &#160; 3 TCP_CF_HIT/200/- HIER_NONE/-
</I>&gt;<i>      &gt;&#160; &#160; &#160; &#160; 2 TCP_CF_MISS/200/200 FIRSTUP_PARENT/parent_proxy
</I>&gt;<i>      &gt;&#160; &#160; &#160; &#160;16 TCP_HIT/200/- HIER_NONE/-
</I>&gt;<i>      &gt;&#160; &#160; &#160; 467 TCP_MISS/200/200 FIRSTUP_PARENT/parent_proxy
</I>&gt;<i>      &gt;&#160; &#160; &#160; &#160;12 TCP_SWAPFAIL_MISS/200/200 FIRSTUP_PARENT/parent_proxy
</I>&gt;<i>      &gt;
</I>&gt;<i>      &gt; 200 threads - 6%
</I>&gt;<i>      &gt;&#160; &#160; &#160; &#160; 6 TCP_CF_HIT/200/- HIER_NONE/-
</I>&gt;<i>      &gt;&#160; &#160; &#160; &#160;10 TCP_HIT/200/- HIER_NONE/-
</I>&gt;<i>      &gt;&#160; &#160; &#160; 176 TCP_MISS/200/200 FIRSTUP_PARENT/parent_proxy
</I>&gt;<i>      &gt;&#160; &#160; &#160; &#160; 8 TCP_SWAPFAIL_MISS/200/200 FIRSTUP_PARENT/parent_proxy
</I>&gt;<i>      &gt;
</I>&gt;<i>      &gt; 50 threads - 82%
</I>&gt;<i>      &gt;&#160; &#160; &#160; &#160;30 TCP_CF_HIT/200/- HIER_NONE/-
</I>&gt;<i>      &gt;&#160; &#160; &#160; &#160;11 TCP_HIT/200/- HIER_NONE/-
</I>&gt;<i>      &gt;&#160; &#160; &#160; &#160; 1 TCP_MISS/200/200 FIRSTUP_PARENT/parent_proxy
</I>&gt;<i>      &gt;&#160; &#160; &#160; &#160; 8 TCP_SWAPFAIL_MISS/200/200 FIRSTUP_PARENT/parent_proxy
</I>&gt;<i>      &gt;
</I>&gt;<i>      &gt; The results are slightly worse than they were on the version 5.9.
</I>&gt;<i>      &gt; It is interesting to note that on both squid versions if I run a
</I>&gt;<i>      &gt; separate curl after processing 500 or 200 concurrent threads, I
</I>&gt;<i>     get a
</I>&gt;<i>      &gt; result with the status TCP_MISS/200, although the requested URL is
</I>&gt;<i>      &gt; already in the rock cache (I can see it in the contents of the cache
</I>&gt;<i>      &gt; using the utility I developed rock_cache_dump.pl
</I>&gt;<i>     &lt;<A HREF="http://rock_cache_dump.pl">http://rock_cache_dump.pl</A>&gt;
</I>&gt;<i>      &gt; &lt;<A HREF="http://rock_cache_dump.pl">http://rock_cache_dump.pl</A> &lt;<A HREF="http://rock_cache_dump.pl">http://rock_cache_dump.pl</A>&gt;&gt;:
</I>&gt;<i>      &gt; $VAR1 = {
</I>&gt;<i>      &gt;&#160; &#160; &#160; &#160; &#160; &#160; '1' =&gt; {
</I>&gt;<i>      &gt;&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;'VERSION' =&gt; 'Wed May 31 09:18:05 2023',
</I>&gt;<i>      &gt;&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;'KEY_MD5' =&gt; 'e5eb10f0ab7d84ff9d3fd1e5a6d3eb9c',
</I>&gt;<i>      &gt;&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;'OBJSIZE' =&gt; 446985,
</I>&gt;<i>      &gt;&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;'STD_LFS' =&gt; {
</I>&gt;<i>      &gt;&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; 'lastref' =&gt; 'Wed May 31
</I>&gt;<i>     09:18:05 2023',
</I>&gt;<i>      &gt;&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; 'flags' =&gt; '0x4004',
</I>&gt;<i>      &gt;&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; 'expires' =&gt; 'Wed May 31
</I>&gt;<i>     15:18:05 2023',
</I>&gt;<i>      &gt;&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; 'swap_file_sz' =&gt; 0,
</I>&gt;<i>      &gt;&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; 'refcount' =&gt; 1,
</I>&gt;<i>      &gt;&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; 'lastmod' =&gt; 'Wed Jun 29
</I>&gt;<i>     16:09:14 2016',
</I>&gt;<i>      &gt;&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; 'timestamp' =&gt; 'Wed May 31
</I>&gt;<i>     09:18:05 2023'
</I>&gt;<i>      &gt;&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; },
</I>&gt;<i>      &gt;&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;'URL' =&gt;
</I>&gt;<i>      &gt;
</I>&gt;<i>     '<A HREF="https://ia800406.us.archive.org/13/items/romeo-y-julieta-texto-completo/Romeo%20y%20Julieta%20-%20William%20Shakespeare.pdf">https://ia800406.us.archive.org/13/items/romeo-y-julieta-texto-completo/Romeo%20y%20Julieta%20-%20William%20Shakespeare.pdf</A> &lt;<A HREF="https://ia800406.us.archive.org/13/items/romeo-y-julieta-texto-completo/Romeo%20y%20Julieta%20-%20William%20Shakespeare.pdf">https://ia800406.us.archive.org/13/items/romeo-y-julieta-texto-completo/Romeo%20y%20Julieta%20-%20William%20Shakespeare.pdf</A>&gt; &lt;<A HREF="https://ia800406.us.archive.org/13/items/romeo-y-julieta-texto-completo/Romeo%20y%20Julieta%20-%20William%20Shakespeare.pdf">https://ia800406.us.archive.org/13/items/romeo-y-julieta-texto-completo/Romeo%20y%20Julieta%20-%20William%20Shakespeare.pdf</A> &lt;<A HREF="https://ia800406.us.archive.org/13/items/romeo-y-julieta-texto-completo/Romeo%20y%20Julieta%20-%20William%20Shakespeare.pdf">https://ia800406.us.archive.org/13/items/romeo-y-julieta-texto-completo/Romeo%20y%20Julieta%20-%20William%20Shakespeare.pdf</A>&gt;&gt;'
</I>&gt;<i>      &gt;&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;}
</I>&gt;<i>      &gt;&#160; &#160; &#160; &#160; &#160; };
</I>&gt;<i>      &gt;
</I>&gt;<i>      &gt; ).
</I>&gt;<i>      &gt;
</I>&gt;<i>      &gt;&#160; &gt; How much RAM does your server have? You are using default
</I>&gt;<i>     256MB memory
</I>&gt;<i>      &gt;&#160; &gt; cache (cache_mem). If you have spare memory, make your memory
</I>&gt;<i>     cache much
</I>&gt;<i>      &gt;&#160; &gt; larger: A rock cache_dir cannot (yet) share the response
</I>&gt;<i>     _while_ the
</I>&gt;<i>      &gt;&#160; &gt; response is being written to disk, so relying on cache_dir too
</I>&gt;<i>     much will
</I>&gt;<i>      &gt;&#160; &gt; decrease your hit ratio, especially in a collapsed forwarding
</I>&gt;<i>      &gt; environment.
</I>&gt;<i>      &gt; The VM has 32 GB RAM. I configured cache_mem 2048 MB on the 6.0.2
</I>&gt;<i>     version.
</I>&gt;<i>      &gt;
</I>&gt;<i>      &gt;&#160; &gt; Is your Squid built with --enable-delay-pools? If yes,
</I>&gt;<i>     TCP_MISS does not
</I>&gt;<i>      &gt;&#160; &gt; necessarily mean a cache miss (an old Squid bug), even if you
</I>&gt;<i>     do not use
</I>&gt;<i>      &gt;&#160; &gt; any delay pools.
</I>&gt;<i>      &gt; Yes, delay pools on the version 5.9 were enabled though&#160;we don't use
</I>&gt;<i>      &gt; them. I disabled this feature on the 6.0.2 version.
</I>&gt;<i>      &gt;
</I>&gt;<i>      &gt;
</I>&gt;<i>      &gt;&#160; &gt; Since you are trying to cache objects lager than 512KB, see
</I>&gt;<i>      &gt;&#160; &gt; maximum_object_size_in_memory.
</I>&gt;<i>      &gt; I configured maximum_object_size_in_memory 10 MB&#160;on the 6.0.2
</I>&gt;<i>     version
</I>&gt;<i>      &gt; (as videochunks are less than 7 MB).
</I>&gt;<i>      &gt;
</I>&gt;<i>      &gt;&#160; &gt; Consider making your test much longer (more sequential
</I>&gt;<i>     requests per
</I>&gt;<i>      &gt;&#160; &gt; client/curl worker), to see whether the cache becomes &quot;stable&quot;
</I>&gt;<i>     after one
</I>&gt;<i>      &gt;&#160; &gt; of the first transactions manages to fully cache the response.
</I>&gt;<i>     This may
</I>&gt;<i>      &gt;&#160; &gt; not help with older Squids, but might help with newer ones.
</I>&gt;<i>     However, you
</I>&gt;<i>      &gt;&#160; &gt; should not test using real origin servers (that you do not
</I>&gt;<i>     control)!
</I>&gt;<i>      &gt; I don't have any of my own web servers for tests, so I choose some
</I>&gt;<i>      &gt; resources on the public internet that have a robust infrastructure.
</I>&gt;<i>      &gt; I will conduct the longer tests next week.
</I>&gt;<i>      &gt;
</I>&gt;<i>      &gt; Kind regards,
</I>&gt;<i>      &gt;&#160; &#160; &#160; &#160; Ankor.
</I>&gt;<i>      &gt;
</I>&gt;<i>      &gt; *squid.conf*
</I>&gt;<i>      &gt; workers 21
</I>&gt;<i>      &gt;
</I>&gt;<i>      &gt; sslcrtd_program
</I>&gt;<i>     /data/squid.user/usr/lib/squid/security_file_certgen -s
</I>&gt;<i>      &gt; /data/squid.user/var/lib/squid/ssl_db -M 20MB
</I>&gt;<i>      &gt; sslcrtd_children 21
</I>&gt;<i>      &gt;
</I>&gt;<i>      &gt; logformat extended-squid %{%Y-%m-%d %H:%M:%S}tl| %6tr %&gt;a
</I>&gt;<i>      &gt; %Ss/%03&gt;Hs/%&lt;Hs %&lt;st %rm %ru %un %Sh/%&lt;A %mt %ea
</I>&gt;<i>      &gt;
</I>&gt;<i>      &gt; logfile_rotate 0
</I>&gt;<i>      &gt; access_log daemon:/var/log/squid.user/access.log
</I>&gt;<i>      &gt; logformat=extended-squid on-error=drop
</I>&gt;<i>      &gt;
</I>&gt;<i>      &gt; cache_peer parent_proxy &#160;parent 3128 0
</I>&gt;<i>      &gt; never_direct allow all
</I>&gt;<i>      &gt;
</I>&gt;<i>      &gt; cachemgr_passwd pass config
</I>&gt;<i>      &gt;
</I>&gt;<i>      &gt; acl PURGE method PURGE
</I>&gt;<i>      &gt; http_access allow PURGE
</I>&gt;<i>      &gt;
</I>&gt;<i>      &gt; http_access allow all
</I>&gt;<i>      &gt;
</I>&gt;<i>      &gt; http_port 3131 ssl-bump generate-host-certificates=on
</I>&gt;<i>      &gt; dynamic_cert_mem_cache_size=20MB
</I>&gt;<i>      &gt; tls-cert=/etc/squid.user/sslbump/bump.crt
</I>&gt;<i>      &gt; tls-key=/etc/squid.user/sslbump/bump.key
</I>&gt;<i>      &gt; sslproxy_cert_error allow all
</I>&gt;<i>      &gt;
</I>&gt;<i>      &gt; acl step1 at_step SslBump1
</I>&gt;<i>      &gt; acl step2 at_step SslBump2
</I>&gt;<i>      &gt; acl step3 at_step SslBump3
</I>&gt;<i>      &gt;
</I>&gt;<i>      &gt; ssl_bump peek step1
</I>&gt;<i>      &gt; ssl_bump bump step2
</I>&gt;<i>      &gt; ssl_bump bump step3
</I>&gt;<i>      &gt;
</I>&gt;<i>      &gt; cache_dir rock /data/squid.user/cache 20000 max-size=12000000
</I>&gt;<i>      &gt; cache_swap_low 85
</I>&gt;<i>      &gt; cache_swap_high 90
</I>&gt;<i>      &gt;
</I>&gt;<i>      &gt; collapsed_forwarding on
</I>&gt;<i>      &gt; cache_mem 2048 MB
</I>&gt;<i>      &gt; maximum_object_size_in_memory 10 MB
</I>&gt;<i>      &gt;
</I>&gt;<i>      &gt; pinger_enable off
</I>&gt;<i>      &gt; max_filedesc 8192
</I>&gt;<i>      &gt; shutdown_lifetime 5 seconds
</I>&gt;<i>      &gt; netdb_filename none
</I>&gt;<i>      &gt; log_icp_queries off
</I>&gt;<i>      &gt;
</I>&gt;<i>      &gt; via off
</I>&gt;<i>      &gt; forwarded_for delete
</I>&gt;<i>      &gt;
</I>&gt;<i>      &gt; client_request_buffer_max_size 100 MB
</I>&gt;<i>      &gt;
</I>&gt;<i>      &gt; coredump_dir /data/squid.user/var/cache/squid
</I>&gt;<i>      &gt;
</I>&gt;<i>      &gt;
</I>&gt;<i>      &gt;
</I>&gt;<i>      &gt;
</I>&gt;<i>      &gt; &#1087;&#1085;, 29 &#1084;&#1072;&#1103; 2023&#8239;&#1075;. &#1074; 23:17, Alex Rousskov
</I>&gt;<i>      &gt; &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>
</I>&gt;<i>     &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt;
</I>&gt;<i>      &gt; &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>
</I>&gt;<i>     &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt;&gt;&gt;:
</I>&gt;<i>      &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160;On 5/29/23 10:43, Andrey K wrote:
</I>&gt;<i>      &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt; We need to configure a dedicated proxy server to provide
</I>&gt;<i>     caching of
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt; online video broadcasts in order to reduce the load on the
</I>&gt;<i>     uplink
</I>&gt;<i>      &gt;&#160; &#160; &#160;proxy.
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt; Hundreds of users will access the same video-chunks
</I>&gt;<i>     simultaneously.
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt; I developed a simple configuration for the test purposes
</I>&gt;<i>     (it is
</I>&gt;<i>      &gt;&#160; &#160; &#160;shown
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt; below).
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt; The *collapsed_forwarding*&#160;option is on.
</I>&gt;<i>      &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160;Do you get close to 100% hit ratio if clients access these URLs
</I>&gt;<i>      &gt;&#160; &#160; &#160;sequentially rather than concurrently? If not, then focus on that
</I>&gt;<i>      &gt;&#160; &#160; &#160;problem before you open the collapsed forwarding Pandora box.
</I>&gt;<i>      &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160;What is your Squid version? Older Squids have more collapsed
</I>&gt;<i>     forwarding
</I>&gt;<i>      &gt;&#160; &#160; &#160;bugs than newer ones. I recommend testing with Squid v6 or
</I>&gt;<i>      &gt;&#160; &#160; &#160;master/v7, at
</I>&gt;<i>      &gt;&#160; &#160; &#160;least to confirm that the problem is still present in the latest
</I>&gt;<i>      &gt;&#160; &#160; &#160;official code.
</I>&gt;<i>      &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160;How much RAM does your server have? You are using default
</I>&gt;<i>     256MB memory
</I>&gt;<i>      &gt;&#160; &#160; &#160;cache (cache_mem). If you have spare memory, make your memory
</I>&gt;<i>     cache
</I>&gt;<i>      &gt;&#160; &#160; &#160;much
</I>&gt;<i>      &gt;&#160; &#160; &#160;larger: A rock cache_dir cannot (yet) share the response
</I>&gt;<i>     _while_ the
</I>&gt;<i>      &gt;&#160; &#160; &#160;response is being written to disk, so relying on cache_dir
</I>&gt;<i>     too much
</I>&gt;<i>      &gt;&#160; &#160; &#160;will
</I>&gt;<i>      &gt;&#160; &#160; &#160;decrease your hit ratio, especially in a collapsed forwarding
</I>&gt;<i>      &gt;&#160; &#160; &#160;environment.
</I>&gt;<i>      &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160;Is your Squid built with --enable-delay-pools? If yes,
</I>&gt;<i>     TCP_MISS does
</I>&gt;<i>      &gt;&#160; &#160; &#160;not
</I>&gt;<i>      &gt;&#160; &#160; &#160;necessarily mean a cache miss (an old Squid bug), even if you
</I>&gt;<i>     do not
</I>&gt;<i>      &gt;&#160; &#160; &#160;use
</I>&gt;<i>      &gt;&#160; &#160; &#160;any delay pools.
</I>&gt;<i>      &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160;Since you are trying to cache objects lager than 512KB, see
</I>&gt;<i>      &gt;&#160; &#160; &#160;maximum_object_size_in_memory.
</I>&gt;<i>      &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160;Consider making your test much longer (more sequential
</I>&gt;<i>     requests per
</I>&gt;<i>      &gt;&#160; &#160; &#160;client/curl worker), to see whether the cache becomes
</I>&gt;<i>     &quot;stable&quot; after
</I>&gt;<i>      &gt;&#160; &#160; &#160;one
</I>&gt;<i>      &gt;&#160; &#160; &#160;of the first transactions manages to fully cache the
</I>&gt;<i>     response. This may
</I>&gt;<i>      &gt;&#160; &#160; &#160;not help with older Squids, but might help with newer ones.
</I>&gt;<i>     However,
</I>&gt;<i>      &gt;&#160; &#160; &#160;you
</I>&gt;<i>      &gt;&#160; &#160; &#160;should not test using real origin servers (that you do not
</I>&gt;<i>     control)!
</I>&gt;<i>      &gt;
</I>&gt;<i>      &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt; Could you clarify if this behavior of my squid is
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt; a bug/misconfiguration, or if I'm running into server
</I>&gt;<i>     performance
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt; limitations (squid is running on a VM with 22 cores)?
</I>&gt;<i>      &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160;Most likely, reduction of hit ratio with increase of
</I>&gt;<i>     concurrency is
</I>&gt;<i>      &gt;&#160; &#160; &#160;_not_ a performance limitation.
</I>&gt;<i>      &gt;
</I>&gt;<i>      &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160;HTH,
</I>&gt;<i>      &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160;Alex.
</I>&gt;<i>      &gt;
</I>&gt;<i>      &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt; I selected a couple of cacheable resources in the internet for
</I>&gt;<i>      &gt;&#160; &#160; &#160;testing:
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160;- small size (~400 KB):
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;
</I>&gt;<i>      &gt;
</I>&gt;<i>     <A HREF="https://ia800406.us.archive.org/13/items/romeo-y-julieta-texto-completo/Romeo%20y%20Julieta%20-%20William%20Shakespeare.pdf">https://ia800406.us.archive.org/13/items/romeo-y-julieta-texto-completo/Romeo%20y%20Julieta%20-%20William%20Shakespeare.pdf</A> &lt;<A HREF="https://ia800406.us.archive.org/13/items/romeo-y-julieta-texto-completo/Romeo%20y%20Julieta%20-%20William%20Shakespeare.pdf">https://ia800406.us.archive.org/13/items/romeo-y-julieta-texto-completo/Romeo%20y%20Julieta%20-%20William%20Shakespeare.pdf</A>&gt; &lt;<A HREF="https://ia800406.us.archive.org/13/items/romeo-y-julieta-texto-completo/Romeo%20y%20Julieta%20-%20William%20Shakespeare.pdf">https://ia800406.us.archive.org/13/items/romeo-y-julieta-texto-completo/Romeo%20y%20Julieta%20-%20William%20Shakespeare.pdf</A> &lt;<A HREF="https://ia800406.us.archive.org/13/items/romeo-y-julieta-texto-completo/Romeo%20y%20Julieta%20-%20William%20Shakespeare.pdf">https://ia800406.us.archive.org/13/items/romeo-y-julieta-texto-completo/Romeo%20y%20Julieta%20-%20William%20Shakespeare.pdf</A>&gt;&gt; &lt;<A HREF="https://ia800406.us.archive.org/13/items/romeo-y-julieta-texto-completo/Romeo%20y%20Julieta%20-%20William%20Shakespeare.pdf">https://ia800406.us.archive.org/13/items/romeo-y-julieta-texto-completo/Romeo%20y%20Julieta%20-%20William%20Shakespeare.pdf</A> &lt;<A HREF="https://ia800406.us.archive.org/13/items/romeo-y-julieta-texto-completo/Romeo%20y%20Julieta%20-%20William%20Shakespeare.pdf">https://ia800406.us.archive.org/13/items/romeo-y-julieta-texto-completo/Romeo%20y%20Julieta%20-%20William%20Shakespeare.pdf</A>&gt; &lt;<A HREF="https://ia800406.us.archive.org/13/items/romeo-y-julieta-texto-completo/Romeo%20y%20Julieta%20-%20William%20Shakespeare.pdf">https://ia800406.us.archive.org/13/items/romeo-y-julieta-texto-completo/Romeo%20y%20Julieta%20-%20William%20Shakespeare.pdf</A> &lt;<A HREF="https://ia800406.us.archive.org/13/items/romeo-y-julieta-texto-completo/Romeo%20y%20Julieta%20-%20William%20Shakespeare.pdf">https://ia800406.us.archive.org/13/items/romeo-y-julieta-texto-completo/Romeo%20y%20Julieta%20-%20William%20Shakespeare.pdf</A>&gt;&gt;&gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160;- large (~8 MB):
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;
</I>&gt;<i>      &gt;
</I>&gt;<i>     <A HREF="https://ia600601.us.archive.org/10/items/Linux-Journal-2015-01/Linux-Journal-2015-01.pdf">https://ia600601.us.archive.org/10/items/Linux-Journal-2015-01/Linux-Journal-2015-01.pdf</A> &lt;<A HREF="https://ia600601.us.archive.org/10/items/Linux-Journal-2015-01/Linux-Journal-2015-01.pdf">https://ia600601.us.archive.org/10/items/Linux-Journal-2015-01/Linux-Journal-2015-01.pdf</A>&gt; &lt;<A HREF="https://ia600601.us.archive.org/10/items/Linux-Journal-2015-01/Linux-Journal-2015-01.pdf">https://ia600601.us.archive.org/10/items/Linux-Journal-2015-01/Linux-Journal-2015-01.pdf</A> &lt;<A HREF="https://ia600601.us.archive.org/10/items/Linux-Journal-2015-01/Linux-Journal-2015-01.pdf">https://ia600601.us.archive.org/10/items/Linux-Journal-2015-01/Linux-Journal-2015-01.pdf</A>&gt;&gt; &lt;<A HREF="https://ia600601.us.archive.org/10/items/Linux-Journal-2015-01/Linux-Journal-2015-01.pdf">https://ia600601.us.archive.org/10/items/Linux-Journal-2015-01/Linux-Journal-2015-01.pdf</A> &lt;<A HREF="https://ia600601.us.archive.org/10/items/Linux-Journal-2015-01/Linux-Journal-2015-01.pdf">https://ia600601.us.archive.org/10/items/Linux-Journal-2015-01/Linux-Journal-2015-01.pdf</A>&gt; &lt;<A HREF="https://ia600601.us.archive.org/10/items/Linux-Journal-2015-01/Linux-Journal-2015-01.pdf">https://ia600601.us.archive.org/10/items/Linux-Journal-2015-01/Linux-Journal-2015-01.pdf</A> &lt;<A HREF="https://ia600601.us.archive.org/10/items/Linux-Journal-2015-01/Linux-Journal-2015-01.pdf">https://ia600601.us.archive.org/10/items/Linux-Journal-2015-01/Linux-Journal-2015-01.pdf</A>&gt;&gt;&gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt; To test simultaneous connections I am forking curl using a
</I>&gt;<i>     simple
</I>&gt;<i>      &gt;&#160; &#160; &#160;script
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt; (it is also shown below).
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt; When I run a test (500 curl threads to
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;
</I>&gt;<i>      &gt;
</I>&gt;<i>     <A HREF="https://ia800406.us.archive.org/13/items/romeo-y-julieta-texto-completo/Romeo%20y%20Julieta%20-%20William%20Shakespeare.pdf">https://ia800406.us.archive.org/13/items/romeo-y-julieta-texto-completo/Romeo%20y%20Julieta%20-%20William%20Shakespeare.pdf</A> &lt;<A HREF="https://ia800406.us.archive.org/13/items/romeo-y-julieta-texto-completo/Romeo%20y%20Julieta%20-%20William%20Shakespeare.pdf">https://ia800406.us.archive.org/13/items/romeo-y-julieta-texto-completo/Romeo%20y%20Julieta%20-%20William%20Shakespeare.pdf</A>&gt; &lt;<A HREF="https://ia800406.us.archive.org/13/items/romeo-y-julieta-texto-completo/Romeo%20y%20Julieta%20-%20William%20Shakespeare.pdf">https://ia800406.us.archive.org/13/items/romeo-y-julieta-texto-completo/Romeo%20y%20Julieta%20-%20William%20Shakespeare.pdf</A> &lt;<A HREF="https://ia800406.us.archive.org/13/items/romeo-y-julieta-texto-completo/Romeo%20y%20Julieta%20-%20William%20Shakespeare.pdf">https://ia800406.us.archive.org/13/items/romeo-y-julieta-texto-completo/Romeo%20y%20Julieta%20-%20William%20Shakespeare.pdf</A>&gt;&gt; &lt;<A HREF="https://ia800406.us.archive.org/13/items/romeo-y-julieta-texto-completo/Romeo%20y%20Julieta%20-%20William%20Shakespeare.pdf">https://ia800406.us.archive.org/13/items/romeo-y-julieta-texto-completo/Romeo%20y%20Julieta%20-%20William%20Shakespeare.pdf</A> &lt;<A HREF="https://ia800406.us.archive.org/13/items/romeo-y-julieta-texto-completo/Romeo%20y%20Julieta%20-%20William%20Shakespeare.pdf">https://ia800406.us.archive.org/13/items/romeo-y-julieta-texto-completo/Romeo%20y%20Julieta%20-%20William%20Shakespeare.pdf</A>&gt; &lt;<A HREF="https://ia800406.us.archive.org/13/items/romeo-y-julieta-texto-completo/Romeo%20y%20Julieta%20-%20William%20Shakespeare.pdf">https://ia800406.us.archive.org/13/items/romeo-y-julieta-texto-completo/Romeo%20y%20Julieta%20-%20William%20Shakespeare.pdf</A> &lt;<A HREF="https://ia800406.us.archive.org/13/items/romeo-y-julieta-texto-completo/Romeo%20y%20Julieta%20-%20William%20Shakespeare.pdf">https://ia800406.us.archive.org/13/items/romeo-y-julieta-texto-completo/Romeo%20y%20Julieta%20-%20William%20Shakespeare.pdf</A>&gt;&gt;&gt;) I see lots of&#160;TCP_MISS/200 with&#160;FIRSTUP_PARENT/parent_proxy records in the logs.
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt; A simple analysis shows&#160;a low percentage of cache hits:
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt; cat /var/log/squid.user/access.log| grep '2023-05-29 14' |
</I>&gt;<i>     grep
</I>&gt;<i>      &gt;&#160; &#160; &#160;pdf &#160;|
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt; awk '{print $5&quot; &quot; $10}' | sort | uniq -c
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &#160;24 TCP_CF_MISS/200/- HIER_NONE/-
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; 457 TCP_MISS/200/200 FIRSTUP_PARENT/parent_proxy
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &#160;10 TCP_MISS/200/- HIER_NONE/-
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &#160; 9 TCP_SWAPFAIL_MISS/200/200 FIRSTUP_PARENT/parent_proxy
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt; So the Hit ratio is about (500-457-9)*100/500=6.8%
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt; Almost the same situation we see when run 200 threads:
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt; cat /var/log/squid.user/access.log| grep '2023-05-29 15:45' |
</I>&gt;<i>      &gt;&#160; &#160; &#160;grep pdf
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160;| awk '{print $5&quot; &quot; $10}' | sort | uniq -c
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &#160; 4 TCP_CF_MISS/200/- HIER_NONE/-
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; 140 TCP_MISS/200/200 FIRSTUP_PARENT/parent_proxy
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &#160;40 TCP_MISS/200/- HIER_NONE/-
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &#160;16 TCP_SWAPFAIL_MISS/200/200 FIRSTUP_PARENT/parent_proxy
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt; This time the Hit ratio is about (200-140-16)*100/500=21%
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt; With 50 threads the Hit ratio is 90%:
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt; cat /var/log/squid.user/access.log| grep '2023-05-29 15:50' |
</I>&gt;<i>      &gt;&#160; &#160; &#160;grep pdf
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160;| awk '{print $5&quot; &quot; $10}' | sort | uniq -c
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &#160;27 TCP_CF_MISS/200/- HIER_NONE/-
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &#160; 1 TCP_MISS/200/200 FIRSTUP_PARENT/parent_proxy
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &#160;18 TCP_MISS/200/- HIER_NONE/-
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &#160; 4 TCP_SWAPFAIL_MISS/200/200 FIRSTUP_PARENT/parent_proxy
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt; I thought that it should always be near 99% - only the first
</I>&gt;<i>      &gt;&#160; &#160; &#160;request to
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt; an URL should be forwarded to the parent proxy and all
</I>&gt;<i>     subsequent
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt; requests should be served from the cache.
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt; The situation is even worse with downloading a large file:
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt; 500 threads (0.4%):
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt; cat /var/log/squid.user/access.log| grep '2023-05-29 17:2'
</I>&gt;<i>     | grep
</I>&gt;<i>      &gt;&#160; &#160; &#160;pdf &#160;|
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt; awk '{print $5&quot; &quot; $10}' | sort | uniq -c
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &#160;10 TCP_CF_MISS/200/200 FIRSTUP_PARENT/parent_proxy
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &#160; 2 TCP_CF_MISS/200/- HIER_NONE/-
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; 488 TCP_MISS/200/200 FIRSTUP_PARENT/parent_proxy
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt; 200 threads (3%):
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt; cat /var/log/squid.user/access.log| grep '2023-05-29 17:3'
</I>&gt;<i>     | grep
</I>&gt;<i>      &gt;&#160; &#160; &#160;pdf &#160;|
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt; awk '{print $5&quot; &quot; $10}' | sort | uniq -c
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &#160; 9 TCP_CF_MISS/200/200 FIRSTUP_PARENT/parent_proxy
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &#160; 6 TCP_CF_MISS/200/- HIER_NONE/-
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; 180 TCP_MISS/200/200 FIRSTUP_PARENT/parent_proxy
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &#160; 5 TCP_SWAPFAIL_MISS/200/200 FIRSTUP_PARENT/parent_proxy
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt; 50 threads (98%):
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt; cat /var/log/squid.user/access.log| grep '2023-05-29 17:36' |
</I>&gt;<i>      &gt;&#160; &#160; &#160;grep pdf
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160;| awk '{print $5&quot; &quot; $10}' | sort | uniq -c
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &#160;25 TCP_CF_HIT/200/- HIER_NONE/-
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &#160;12 TCP_CF_MISS/200/- HIER_NONE/-
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &#160;12 TCP_HIT/200/- HIER_NONE/-
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &#160; 1 TCP_MISS/200/200 FIRSTUP_PARENT/parent_proxy
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt; Could you clarify if this behavior of my squid is a
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt; bug/misconfiguration, or if I'm running into server
</I>&gt;<i>     performance
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt; limitations (squid is running on a VM with 22 cores)?
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt; Kind regards,
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &#160;Ankor
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt; *squid.conf:*
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt; workers 21
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt; sslcrtd_program
</I>&gt;<i>      &gt;&#160; &#160; &#160;/data/squid.user/usr/lib/squid/security_file_certgen -s
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt; /data/squid.user/var/lib/squid/ssl_db -M 20MB
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt; sslcrtd_children 21
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt; logformat extended-squid %{%Y-%m-%d %H:%M:%S}tl| %6tr %&gt;a
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt; %Ss/%03&gt;Hs/%&lt;Hs %&lt;st %rm %ru %un %Sh/%&lt;A %mt %ea
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt; logfile_rotate 0
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt; access_log daemon:/var/log/squid.user/access.log
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt; logformat=extended-squid on-error=drop
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt; cache_peer parent_proxy &#160;parent 3128 0
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt; never_direct allow all
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt; cachemgr_passwd pass config
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt; acl PURGE method PURGE
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt; http_access allow PURGE
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt; http_access allow all
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt; http_port 3131 ssl-bump generate-host-certificates=on
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt; dynamic_cert_mem_cache_size=20MB
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt; tls-cert=/etc/squid.user/sslbump/bump.crt
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt; tls-key=/etc/squid.user/sslbump/bump.key
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt; sslproxy_cert_error allow all
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt; acl step1 at_step SslBump1
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt; acl step2 at_step SslBump2
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt; acl step3 at_step SslBump3
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt; ssl_bump peek step1
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt; ssl_bump bump step2
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt; ssl_bump bump step3
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt; cache_dir rock /data/squid.user/cache 20000 max-size=12000000
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt; cache_swap_low 85
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt; cache_swap_high 90
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt; *collapsed_forwarding on*
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt; pinger_enable off
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt; max_filedesc 8192
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt; shutdown_lifetime 5 seconds
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt; netdb_filename none
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt; log_icp_queries off
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt; client_request_buffer_max_size 100 MB
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt; via off
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt; forwarded_for delete
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt; coredump_dir /data/squid.user/var/cache/squid
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt; *curl_forker.sh:*
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt; #!/bin/sh
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt; N=100
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;
</I>&gt;<i>      &gt;   
</I>&gt;<i>      &#160;URL=<A HREF="https://ia600601.us.archive.org/10/items/Linux-Journal-2015-01/Linux-Journal-2015-01.pdf">https://ia600601.us.archive.org/10/items/Linux-Journal-2015-01/Linux-Journal-2015-01.pdf</A> &lt;<A HREF="https://ia600601.us.archive.org/10/items/Linux-Journal-2015-01/Linux-Journal-2015-01.pdf">https://ia600601.us.archive.org/10/items/Linux-Journal-2015-01/Linux-Journal-2015-01.pdf</A>&gt; &lt;<A HREF="https://ia600601.us.archive.org/10/items/Linux-Journal-2015-01/Linux-Journal-2015-01.pdf">https://ia600601.us.archive.org/10/items/Linux-Journal-2015-01/Linux-Journal-2015-01.pdf</A> &lt;<A HREF="https://ia600601.us.archive.org/10/items/Linux-Journal-2015-01/Linux-Journal-2015-01.pdf">https://ia600601.us.archive.org/10/items/Linux-Journal-2015-01/Linux-Journal-2015-01.pdf</A>&gt;&gt; &lt;<A HREF="https://ia600601.us.archive.org/10/items/Linux-Journal-2015-01/Linux-Journal-2015-01.pdf">https://ia600601.us.archive.org/10/items/Linux-Journal-2015-01/Linux-Journal-2015-01.pdf</A> &lt;<A HREF="https://ia600601.us.archive.org/10/items/Linux-Journal-2015-01/Linux-Journal-2015-01.pdf">https://ia600601.us.archive.org/10/items/Linux-Journal-2015-01/Linux-Journal-2015-01.pdf</A>&gt; &lt;<A HREF="https://ia600601.us.archive.org/10/items/Linux-Journal-2015-01/Linux-Journal-2015-01.pdf">https://ia600601.us.archive.org/10/items/Linux-Journal-2015-01/Linux-Journal-2015-01.pdf</A> &lt;<A HREF="https://ia600601.us.archive.org/10/items/Linux-Journal-2015-01/Linux-Journal-2015-01.pdf">https://ia600601.us.archive.org/10/items/Linux-Journal-2015-01/Linux-Journal-2015-01.pdf</A>&gt;&gt;&gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt; if [[ &#160;-n $1 &amp;&amp; &#160;$1 =~ help$ &#160;]];
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt; then
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160;echo &quot;Usage: $0 [&lt;cnt&gt;] [&lt;url&gt;]&quot;
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160;echo
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160;echo &quot;Example: $0 10
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;
</I>&gt;<i>      &gt;
</I>&gt;<i>     <A HREF="https://ia600601.us.archive.org/10/items/Linux-Journal-2015-01/Linux-Journal-2015-01.pdf">https://ia600601.us.archive.org/10/items/Linux-Journal-2015-01/Linux-Journal-2015-01.pdf</A> &lt;<A HREF="https://ia600601.us.archive.org/10/items/Linux-Journal-2015-01/Linux-Journal-2015-01.pdf">https://ia600601.us.archive.org/10/items/Linux-Journal-2015-01/Linux-Journal-2015-01.pdf</A>&gt; &lt;<A HREF="https://ia600601.us.archive.org/10/items/Linux-Journal-2015-01/Linux-Journal-2015-01.pdf">https://ia600601.us.archive.org/10/items/Linux-Journal-2015-01/Linux-Journal-2015-01.pdf</A> &lt;<A HREF="https://ia600601.us.archive.org/10/items/Linux-Journal-2015-01/Linux-Journal-2015-01.pdf">https://ia600601.us.archive.org/10/items/Linux-Journal-2015-01/Linux-Journal-2015-01.pdf</A>&gt;&gt; &lt;<A HREF="https://ia600601.us.archive.org/10/items/Linux-Journal-2015-01/Linux-Journal-2015-01.pdf">https://ia600601.us.archive.org/10/items/Linux-Journal-2015-01/Linux-Journal-2015-01.pdf</A> &lt;<A HREF="https://ia600601.us.archive.org/10/items/Linux-Journal-2015-01/Linux-Journal-2015-01.pdf">https://ia600601.us.archive.org/10/items/Linux-Journal-2015-01/Linux-Journal-2015-01.pdf</A>&gt; &lt;<A HREF="https://ia600601.us.archive.org/10/items/Linux-Journal-2015-01/Linux-Journal-2015-01.pdf">https://ia600601.us.archive.org/10/items/Linux-Journal-2015-01/Linux-Journal-2015-01.pdf</A> &lt;<A HREF="https://ia600601.us.archive.org/10/items/Linux-Journal-2015-01/Linux-Journal-2015-01.pdf">https://ia600601.us.archive.org/10/items/Linux-Journal-2015-01/Linux-Journal-2015-01.pdf</A>&gt;&gt;&gt;&quot;;
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160;echo
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160;exit;
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt; fi
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt; while [[ $# -gt 0 ]]
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt; do
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; if [[ $1 =~ ^[0-9]+$ ]]
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; then
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &#160;N=$1
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; else
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &#160;URL=$1
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; fi
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; shift
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt; done
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt; echo $URL
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt; echo $N threads
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt; for i in `seq $N`
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt; do
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; nohup curl --tlsv1.2 -k &#160; --proxy 0001vsg01:3131 &#160;-v $URL
</I>&gt;<i>      &gt;&#160; &#160; &#160; &#160;&gt;/dev/null
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160;2&gt;&amp;1 &amp;
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt; done
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt; _______________________________________________
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt; squid-users mailing list
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt; <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i>     &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>&gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160;&lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i>     &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>&gt;&gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt; <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i>     &lt;<A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>&gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160;&lt;<A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i>     &lt;<A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>&gt;&gt;
</I>&gt;<i>      &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160;_______________________________________________
</I>&gt;<i>      &gt;&#160; &#160; &#160;squid-users mailing list
</I>&gt;<i>      &gt; <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i>     &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>&gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160;&lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i>     &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>&gt;&gt;
</I>&gt;<i>      &gt; <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i>     &lt;<A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>&gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160;&lt;<A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i>     &lt;<A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>&gt;&gt;
</I>&gt;<i>      &gt;
</I>&gt;<i> 
</I>
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="025854.html">[squid-users] Proxy server to support a large number of simultaneous requests
</A></li>
	<LI>Next message (by thread): <A HREF="025856.html">[squid-users] Proxy server to support a large number of simultaneous requests
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25855">[ date ]</a>
              <a href="thread.html#25855">[ thread ]</a>
              <a href="subject.html#25855">[ subject ]</a>
              <a href="author.html#25855">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
