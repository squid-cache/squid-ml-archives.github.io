<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Proxy server to support a large number of simultaneous requests
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Proxy%20server%20to%20support%20a%20large%20number%20of%0A%20simultaneous%20requests&In-Reply-To=%3CCADJd0Y2OsT-uZjHFMSUmCnGbAZq9FdbUhR6s4RfsfHdMUkbz2A%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="025855.html">
   <LINK REL="Next"  HREF="025861.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Proxy server to support a large number of simultaneous requests</H1>
    <B>Andrey K</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Proxy%20server%20to%20support%20a%20large%20number%20of%0A%20simultaneous%20requests&In-Reply-To=%3CCADJd0Y2OsT-uZjHFMSUmCnGbAZq9FdbUhR6s4RfsfHdMUkbz2A%40mail.gmail.com%3E"
       TITLE="[squid-users] Proxy server to support a large number of simultaneous requests">ankor2023 at gmail.com
       </A><BR>
    <I>Fri Jun  2 07:29:21 UTC 2023</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="025855.html">[squid-users] Proxy server to support a large number of simultaneous requests
</A></li>
        <LI>Next message (by thread): <A HREF="025861.html">[squid-users] Proxy server to support a large number of simultaneous requests
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25856">[ date ]</a>
              <a href="thread.html#25856">[ thread ]</a>
              <a href="subject.html#25856">[ subject ]</a>
              <a href="author.html#25856">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello, Alex,

Thank you very much.

&gt;<i> Can you repeat this test and share a pointer to the corresponding
</I>&gt;<i> compressed cache.log, containing those 500 (or fewer, as long as the
</I>&gt;<i> problem is reproduced!) concurrent transactions. One or many of those
</I>&gt;<i> concurrent transactions resulted in the unwanted entry deletion. The log
</I>&gt;<i> may show what happened in that case.
</I>I cleared the rock cache, set the debug level, restarted squid, cleared the
cache.log, ran 500-threads test, waited for it to finish and launched curl
to make sure it returned TCP_MISS.
Then stopped squid to limit the cache.log file.
The link to the cache.log is
<A HREF="https://drive.google.com/file/d/1kC8oV8WAelsBYoZDoqnNsnyd7cfYOoDi/view?usp=sharing">https://drive.google.com/file/d/1kC8oV8WAelsBYoZDoqnNsnyd7cfYOoDi/view?usp=sharing</A>
I think the access.log file may be helpful for analyzing the problem too:
<A HREF="https://drive.google.com/file/d/1_fDd2mXgeIIHKdZPEavg50KUqTIR5Ltu/view?usp=sharing">https://drive.google.com/file/d/1_fDd2mXgeIIHKdZPEavg50KUqTIR5Ltu/view?usp=sharing</A>
The last record in the file (2023-06-02 09:52:48) is a single curl test
request.

The test statistics are:
Count   STATUS
     22 TCP_CF_HIT/200/- HIER_NONE/-
     72 TCP_HIT/200/- HIER_NONE/-
    404 TCP_MISS/200/200 FIRSTUP_PARENT/parent_proxy
      3 TCP_SWAPFAIL_MISS/200/200 FIRSTUP_PARENT/parent_proxy

Kind regards,
     Ankor.



&#1095;&#1090;, 1 &#1080;&#1102;&#1085;. 2023&#8239;&#1075;. &#1074; 19:15, Alex Rousskov &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>
&gt;:<i>
</I>
&gt;<i> On 6/1/23 05:20, Andrey K wrote:
</I>&gt;<i>
</I>&gt;<i> &gt;  &gt; The next step I would recommend is to study the very first cache miss
</I>&gt;<i> &gt;  &gt; _after_ the 500 or 200 concurrent threads test. Doing so may shed
</I>&gt;<i> light
</I>&gt;<i> &gt;  &gt; on why Squid is refusing to serve that (presumably cached) object from
</I>&gt;<i> &gt;  &gt; the cache. I suspect that the object was marked for deletion earlier
</I>&gt;<i>
</I>&gt;<i> &gt; openForReadingAt: cannot open marked entry 11138 for reading
</I>&gt;<i> cache_mem_map
</I>&gt;<i> &gt; openForReadingAt: cannot open marked entry 719406 for reading
</I>&gt;<i> /data/squid.user/cache_map
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> The debugging log you have shared confirms that Squid deleted[1] the
</I>&gt;<i> previously cached entry, from both caches (memory and disk). Now comes
</I>&gt;<i> the hard part -- figuring out why Squid deleted that entry.
</I>&gt;<i>
</I>&gt;<i> &gt; I cleared the rock cache, changed the squid.conf (added debug_options
</I>&gt;<i> &gt; ALL,9), restarted the squid, ran a test with 500 concurrent threads
</I>&gt;<i>
</I>&gt;<i> Can you repeat this test and share a pointer to the corresponding
</I>&gt;<i> compressed cache.log, containing those 500 (or fewer, as long as the
</I>&gt;<i> problem is reproduced!) concurrent transactions. One or many of those
</I>&gt;<i> concurrent transactions resulted in the unwanted entry deletion. The log
</I>&gt;<i> may show what happened in that case.
</I>&gt;<i>
</I>&gt;<i> FWIW, I do not recommend spending your time analyzing that huge log.
</I>&gt;<i> Efficient analysis requires specialized knowledge in this case. I will
</I>&gt;<i> share the results here, of course.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Thank you,
</I>&gt;<i>
</I>&gt;<i> Alex.
</I>&gt;<i>
</I>&gt;<i> [1] That entry deletion does not imply that all (or any) of the cached
</I>&gt;<i> entry bytes are gone from the cache file on disk. It is likely that only
</I>&gt;<i> the shared memory _index_ for that disk file was adjusted in your micro
</I>&gt;<i> test. That index adjustment is enough for Squid to declare a cache miss.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; &#1089;&#1088;, 31 &#1084;&#1072;&#1103; 2023&#8239;&#1075;. &#1074; 16:43, Alex Rousskov:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     On 5/31/23 02:56, Andrey K wrote:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;      &gt;  &gt; Do you get close to 100% hit ratio if clients access these URLs
</I>&gt;<i> &gt;      &gt;  &gt; sequentially rather than concurrently? If not, then focus on
</I>&gt;<i> that
</I>&gt;<i> &gt;      &gt;  &gt; problem before you open the collapsed forwarding Pandora box.
</I>&gt;<i> &gt;      &gt; When I run curl sequentially like this:
</I>&gt;<i> &gt;      &gt; for i in `seq 500`; do curl --tlsv1.2 -k   --proxy 0001vsg01:3131
</I>&gt;<i> &gt;       -v
</I>&gt;<i> &gt;      &gt; $URL  &gt;/dev/null 2&gt;&amp;1; done
</I>&gt;<i> &gt;      &gt; I get only the first request with a status TCP_MISS and all
</I>&gt;<i> &gt;     others with
</I>&gt;<i> &gt;      &gt; TCP_MEM_HIT:
</I>&gt;<i> &gt;      &gt;      Cnt Status            Parent
</I>&gt;<i> &gt;      &gt;    499 TCP_MEM_HIT/200/- HIER_NONE/-
</I>&gt;<i> &gt;      &gt;        1 TCP_MISS/200/200 FIRSTUP_PARENT/parent_proxy
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     Excellent. This confirms that your Squid can successfully cache this
</I>&gt;<i> &gt;     object (in memory).
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;      &gt; It is interesting to note that on both squid versions if I run a
</I>&gt;<i> &gt;      &gt; separate curl after processing 500 or 200 concurrent threads, I
</I>&gt;<i> &gt;     get a
</I>&gt;<i> &gt;      &gt; result with the status TCP_MISS/200
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     The next step I would recommend is to study the very first cache miss
</I>&gt;<i> &gt;     _after_ the 500 or 200 concurrent threads test. Doing so may shed
</I>&gt;<i> light
</I>&gt;<i> &gt;     on why Squid is refusing to serve that (presumably cached) object
</I>&gt;<i> from
</I>&gt;<i> &gt;     the cache. I suspect that the object was marked for deletion earlier,
</I>&gt;<i> &gt;     but we should check before spending more time on more complex triage
</I>&gt;<i> of
</I>&gt;<i> &gt;     concurrent cases. If you can share a (link to) compressed ALL,9
</I>&gt;<i> &gt;     cache.log from that single transaction against Squid v6, I may be
</I>&gt;<i> able
</I>&gt;<i> &gt;     to help you with that step.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     Cheers,
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     Alex.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;      &gt;  &gt; What is your Squid version? Older Squids have more collapsed
</I>&gt;<i> &gt;     forwarding
</I>&gt;<i> &gt;      &gt;  &gt; bugs than newer ones. I recommend testing with Squid v6 or
</I>&gt;<i> &gt;     master/v7, at
</I>&gt;<i> &gt;      &gt;  &gt; least to confirm that the problem is still present in the
</I>&gt;<i> latest
</I>&gt;<i> &gt;      &gt;  &gt; official code.
</I>&gt;<i> &gt;      &gt; I run tests on SQUID 5.9.
</I>&gt;<i> &gt;      &gt; We compiled 6.0.2 (with disabled delay-pools) and increased memory
</I>&gt;<i> &gt;      &gt; parameters:
</I>&gt;<i> &gt;      &gt;    cache_mem 2048 MB
</I>&gt;<i> &gt;      &gt;    maximum_object_size_in_memory 10 MB
</I>&gt;<i> &gt;      &gt; The complete configuration is shown below.
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt; Now on the version 6.0.2 we have the next results:
</I>&gt;<i> &gt;      &gt; 500 threads -  Hit ratio 3.8%:
</I>&gt;<i> &gt;      &gt;        3 TCP_CF_HIT/200/- HIER_NONE/-
</I>&gt;<i> &gt;      &gt;        2 TCP_CF_MISS/200/200 FIRSTUP_PARENT/parent_proxy
</I>&gt;<i> &gt;      &gt;       16 TCP_HIT/200/- HIER_NONE/-
</I>&gt;<i> &gt;      &gt;      467 TCP_MISS/200/200 FIRSTUP_PARENT/parent_proxy
</I>&gt;<i> &gt;      &gt;       12 TCP_SWAPFAIL_MISS/200/200 FIRSTUP_PARENT/parent_proxy
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt; 200 threads - 6%
</I>&gt;<i> &gt;      &gt;        6 TCP_CF_HIT/200/- HIER_NONE/-
</I>&gt;<i> &gt;      &gt;       10 TCP_HIT/200/- HIER_NONE/-
</I>&gt;<i> &gt;      &gt;      176 TCP_MISS/200/200 FIRSTUP_PARENT/parent_proxy
</I>&gt;<i> &gt;      &gt;        8 TCP_SWAPFAIL_MISS/200/200 FIRSTUP_PARENT/parent_proxy
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt; 50 threads - 82%
</I>&gt;<i> &gt;      &gt;       30 TCP_CF_HIT/200/- HIER_NONE/-
</I>&gt;<i> &gt;      &gt;       11 TCP_HIT/200/- HIER_NONE/-
</I>&gt;<i> &gt;      &gt;        1 TCP_MISS/200/200 FIRSTUP_PARENT/parent_proxy
</I>&gt;<i> &gt;      &gt;        8 TCP_SWAPFAIL_MISS/200/200 FIRSTUP_PARENT/parent_proxy
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt; The results are slightly worse than they were on the version 5.9.
</I>&gt;<i> &gt;      &gt; It is interesting to note that on both squid versions if I run a
</I>&gt;<i> &gt;      &gt; separate curl after processing 500 or 200 concurrent threads, I
</I>&gt;<i> &gt;     get a
</I>&gt;<i> &gt;      &gt; result with the status TCP_MISS/200, although the requested URL is
</I>&gt;<i> &gt;      &gt; already in the rock cache (I can see it in the contents of the
</I>&gt;<i> cache
</I>&gt;<i> &gt;      &gt; using the utility I developed rock_cache_dump.pl
</I>&gt;<i> &gt;     &lt;<A HREF="http://rock_cache_dump.pl">http://rock_cache_dump.pl</A>&gt;
</I>&gt;<i> &gt;      &gt; &lt;<A HREF="http://rock_cache_dump.pl">http://rock_cache_dump.pl</A> &lt;<A HREF="http://rock_cache_dump.pl">http://rock_cache_dump.pl</A>&gt;&gt;:
</I>&gt;<i> &gt;      &gt; $VAR1 = {
</I>&gt;<i> &gt;      &gt;            '1' =&gt; {
</I>&gt;<i> &gt;      &gt;                     'VERSION' =&gt; 'Wed May 31 09:18:05 2023',
</I>&gt;<i> &gt;      &gt;                     'KEY_MD5' =&gt;
</I>&gt;<i> 'e5eb10f0ab7d84ff9d3fd1e5a6d3eb9c',
</I>&gt;<i> &gt;      &gt;                     'OBJSIZE' =&gt; 446985,
</I>&gt;<i> &gt;      &gt;                     'STD_LFS' =&gt; {
</I>&gt;<i> &gt;      &gt;                                    'lastref' =&gt; 'Wed May 31
</I>&gt;<i> &gt;     09:18:05 2023',
</I>&gt;<i> &gt;      &gt;                                    'flags' =&gt; '0x4004',
</I>&gt;<i> &gt;      &gt;                                    'expires' =&gt; 'Wed May 31
</I>&gt;<i> &gt;     15:18:05 2023',
</I>&gt;<i> &gt;      &gt;                                    'swap_file_sz' =&gt; 0,
</I>&gt;<i> &gt;      &gt;                                    'refcount' =&gt; 1,
</I>&gt;<i> &gt;      &gt;                                    'lastmod' =&gt; 'Wed Jun 29
</I>&gt;<i> &gt;     16:09:14 2016',
</I>&gt;<i> &gt;      &gt;                                    'timestamp' =&gt; 'Wed May 31
</I>&gt;<i> &gt;     09:18:05 2023'
</I>&gt;<i> &gt;      &gt;                                  },
</I>&gt;<i> &gt;      &gt;                     'URL' =&gt;
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;     '
</I>&gt;<i> <A HREF="https://ia800406.us.archive.org/13/items/romeo-y-julieta-texto-completo/Romeo%20y%20Julieta%20-%20William%20Shakespeare.pdf">https://ia800406.us.archive.org/13/items/romeo-y-julieta-texto-completo/Romeo%20y%20Julieta%20-%20William%20Shakespeare.pdf</A>
</I>&gt;<i> &lt;
</I>&gt;<i> <A HREF="https://ia800406.us.archive.org/13/items/romeo-y-julieta-texto-completo/Romeo%20y%20Julieta%20-%20William%20Shakespeare.pdf">https://ia800406.us.archive.org/13/items/romeo-y-julieta-texto-completo/Romeo%20y%20Julieta%20-%20William%20Shakespeare.pdf</A>&gt;
</I>&gt;<i> &lt;
</I>&gt;<i> <A HREF="https://ia800406.us.archive.org/13/items/romeo-y-julieta-texto-completo/Romeo%20y%20Julieta%20-%20William%20Shakespeare.pdf">https://ia800406.us.archive.org/13/items/romeo-y-julieta-texto-completo/Romeo%20y%20Julieta%20-%20William%20Shakespeare.pdf</A>
</I>&gt;<i> &lt;
</I>&gt;<i> <A HREF="https://ia800406.us.archive.org/13/items/romeo-y-julieta-texto-completo/Romeo%20y%20Julieta%20-%20William%20Shakespeare.pdf">https://ia800406.us.archive.org/13/items/romeo-y-julieta-texto-completo/Romeo%20y%20Julieta%20-%20William%20Shakespeare.pdf</A>
</I>&gt;<i> &gt;&gt;'
</I>&gt;<i> &gt;      &gt;                   }
</I>&gt;<i> &gt;      &gt;          };
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt; ).
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt;  &gt; How much RAM does your server have? You are using default
</I>&gt;<i> &gt;     256MB memory
</I>&gt;<i> &gt;      &gt;  &gt; cache (cache_mem). If you have spare memory, make your memory
</I>&gt;<i> &gt;     cache much
</I>&gt;<i> &gt;      &gt;  &gt; larger: A rock cache_dir cannot (yet) share the response
</I>&gt;<i> &gt;     _while_ the
</I>&gt;<i> &gt;      &gt;  &gt; response is being written to disk, so relying on cache_dir too
</I>&gt;<i> &gt;     much will
</I>&gt;<i> &gt;      &gt;  &gt; decrease your hit ratio, especially in a collapsed forwarding
</I>&gt;<i> &gt;      &gt; environment.
</I>&gt;<i> &gt;      &gt; The VM has 32 GB RAM. I configured cache_mem 2048 MB on the 6.0.2
</I>&gt;<i> &gt;     version.
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt;  &gt; Is your Squid built with --enable-delay-pools? If yes,
</I>&gt;<i> &gt;     TCP_MISS does not
</I>&gt;<i> &gt;      &gt;  &gt; necessarily mean a cache miss (an old Squid bug), even if you
</I>&gt;<i> &gt;     do not use
</I>&gt;<i> &gt;      &gt;  &gt; any delay pools.
</I>&gt;<i> &gt;      &gt; Yes, delay pools on the version 5.9 were enabled though we don't
</I>&gt;<i> use
</I>&gt;<i> &gt;      &gt; them. I disabled this feature on the 6.0.2 version.
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt;  &gt; Since you are trying to cache objects lager than 512KB, see
</I>&gt;<i> &gt;      &gt;  &gt; maximum_object_size_in_memory.
</I>&gt;<i> &gt;      &gt; I configured maximum_object_size_in_memory 10 MB on the 6.0.2
</I>&gt;<i> &gt;     version
</I>&gt;<i> &gt;      &gt; (as videochunks are less than 7 MB).
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt;  &gt; Consider making your test much longer (more sequential
</I>&gt;<i> &gt;     requests per
</I>&gt;<i> &gt;      &gt;  &gt; client/curl worker), to see whether the cache becomes &quot;stable&quot;
</I>&gt;<i> &gt;     after one
</I>&gt;<i> &gt;      &gt;  &gt; of the first transactions manages to fully cache the response.
</I>&gt;<i> &gt;     This may
</I>&gt;<i> &gt;      &gt;  &gt; not help with older Squids, but might help with newer ones.
</I>&gt;<i> &gt;     However, you
</I>&gt;<i> &gt;      &gt;  &gt; should not test using real origin servers (that you do not
</I>&gt;<i> &gt;     control)!
</I>&gt;<i> &gt;      &gt; I don't have any of my own web servers for tests, so I choose some
</I>&gt;<i> &gt;      &gt; resources on the public internet that have a robust
</I>&gt;<i> infrastructure.
</I>&gt;<i> &gt;      &gt; I will conduct the longer tests next week.
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt; Kind regards,
</I>&gt;<i> &gt;      &gt;        Ankor.
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt; *squid.conf*
</I>&gt;<i> &gt;      &gt; workers 21
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt; sslcrtd_program
</I>&gt;<i> &gt;     /data/squid.user/usr/lib/squid/security_file_certgen -s
</I>&gt;<i> &gt;      &gt; /data/squid.user/var/lib/squid/ssl_db -M 20MB
</I>&gt;<i> &gt;      &gt; sslcrtd_children 21
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt; logformat extended-squid %{%Y-%m-%d %H:%M:%S}tl| %6tr %&gt;a
</I>&gt;<i> &gt;      &gt; %Ss/%03&gt;Hs/%&lt;Hs %&lt;st %rm %ru %un %Sh/%&lt;A %mt %ea
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt; logfile_rotate 0
</I>&gt;<i> &gt;      &gt; access_log daemon:/var/log/squid.user/access.log
</I>&gt;<i> &gt;      &gt; logformat=extended-squid on-error=drop
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt; cache_peer parent_proxy  parent 3128 0
</I>&gt;<i> &gt;      &gt; never_direct allow all
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt; cachemgr_passwd pass config
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt; acl PURGE method PURGE
</I>&gt;<i> &gt;      &gt; http_access allow PURGE
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt; http_access allow all
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt; http_port 3131 ssl-bump generate-host-certificates=on
</I>&gt;<i> &gt;      &gt; dynamic_cert_mem_cache_size=20MB
</I>&gt;<i> &gt;      &gt; tls-cert=/etc/squid.user/sslbump/bump.crt
</I>&gt;<i> &gt;      &gt; tls-key=/etc/squid.user/sslbump/bump.key
</I>&gt;<i> &gt;      &gt; sslproxy_cert_error allow all
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt; acl step1 at_step SslBump1
</I>&gt;<i> &gt;      &gt; acl step2 at_step SslBump2
</I>&gt;<i> &gt;      &gt; acl step3 at_step SslBump3
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt; ssl_bump peek step1
</I>&gt;<i> &gt;      &gt; ssl_bump bump step2
</I>&gt;<i> &gt;      &gt; ssl_bump bump step3
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt; cache_dir rock /data/squid.user/cache 20000 max-size=12000000
</I>&gt;<i> &gt;      &gt; cache_swap_low 85
</I>&gt;<i> &gt;      &gt; cache_swap_high 90
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt; collapsed_forwarding on
</I>&gt;<i> &gt;      &gt; cache_mem 2048 MB
</I>&gt;<i> &gt;      &gt; maximum_object_size_in_memory 10 MB
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt; pinger_enable off
</I>&gt;<i> &gt;      &gt; max_filedesc 8192
</I>&gt;<i> &gt;      &gt; shutdown_lifetime 5 seconds
</I>&gt;<i> &gt;      &gt; netdb_filename none
</I>&gt;<i> &gt;      &gt; log_icp_queries off
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt; via off
</I>&gt;<i> &gt;      &gt; forwarded_for delete
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt; client_request_buffer_max_size 100 MB
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt; coredump_dir /data/squid.user/var/cache/squid
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt; &#1087;&#1085;, 29 &#1084;&#1072;&#1103; 2023&#8239;&#1075;. &#1074; 23:17, Alex Rousskov
</I>&gt;<i> &gt;      &gt; &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>
</I>&gt;<i> &gt;     &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt;
</I>&gt;<i> &gt;      &gt; &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>
</I>&gt;<i> &gt;     &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt;&gt;&gt;:
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt;     On 5/29/23 10:43, Andrey K wrote:
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt; We need to configure a dedicated proxy server to provide
</I>&gt;<i> &gt;     caching of
</I>&gt;<i> &gt;      &gt;      &gt; online video broadcasts in order to reduce the load on the
</I>&gt;<i> &gt;     uplink
</I>&gt;<i> &gt;      &gt;     proxy.
</I>&gt;<i> &gt;      &gt;      &gt; Hundreds of users will access the same video-chunks
</I>&gt;<i> &gt;     simultaneously.
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt; I developed a simple configuration for the test purposes
</I>&gt;<i> &gt;     (it is
</I>&gt;<i> &gt;      &gt;     shown
</I>&gt;<i> &gt;      &gt;      &gt; below).
</I>&gt;<i> &gt;      &gt;      &gt; The *collapsed_forwarding* option is on.
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt;     Do you get close to 100% hit ratio if clients access these
</I>&gt;<i> URLs
</I>&gt;<i> &gt;      &gt;     sequentially rather than concurrently? If not, then focus on
</I>&gt;<i> that
</I>&gt;<i> &gt;      &gt;     problem before you open the collapsed forwarding Pandora box.
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt;     What is your Squid version? Older Squids have more collapsed
</I>&gt;<i> &gt;     forwarding
</I>&gt;<i> &gt;      &gt;     bugs than newer ones. I recommend testing with Squid v6 or
</I>&gt;<i> &gt;      &gt;     master/v7, at
</I>&gt;<i> &gt;      &gt;     least to confirm that the problem is still present in the
</I>&gt;<i> latest
</I>&gt;<i> &gt;      &gt;     official code.
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt;     How much RAM does your server have? You are using default
</I>&gt;<i> &gt;     256MB memory
</I>&gt;<i> &gt;      &gt;     cache (cache_mem). If you have spare memory, make your memory
</I>&gt;<i> &gt;     cache
</I>&gt;<i> &gt;      &gt;     much
</I>&gt;<i> &gt;      &gt;     larger: A rock cache_dir cannot (yet) share the response
</I>&gt;<i> &gt;     _while_ the
</I>&gt;<i> &gt;      &gt;     response is being written to disk, so relying on cache_dir
</I>&gt;<i> &gt;     too much
</I>&gt;<i> &gt;      &gt;     will
</I>&gt;<i> &gt;      &gt;     decrease your hit ratio, especially in a collapsed forwarding
</I>&gt;<i> &gt;      &gt;     environment.
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt;     Is your Squid built with --enable-delay-pools? If yes,
</I>&gt;<i> &gt;     TCP_MISS does
</I>&gt;<i> &gt;      &gt;     not
</I>&gt;<i> &gt;      &gt;     necessarily mean a cache miss (an old Squid bug), even if you
</I>&gt;<i> &gt;     do not
</I>&gt;<i> &gt;      &gt;     use
</I>&gt;<i> &gt;      &gt;     any delay pools.
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt;     Since you are trying to cache objects lager than 512KB, see
</I>&gt;<i> &gt;      &gt;     maximum_object_size_in_memory.
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt;     Consider making your test much longer (more sequential
</I>&gt;<i> &gt;     requests per
</I>&gt;<i> &gt;      &gt;     client/curl worker), to see whether the cache becomes
</I>&gt;<i> &gt;     &quot;stable&quot; after
</I>&gt;<i> &gt;      &gt;     one
</I>&gt;<i> &gt;      &gt;     of the first transactions manages to fully cache the
</I>&gt;<i> &gt;     response. This may
</I>&gt;<i> &gt;      &gt;     not help with older Squids, but might help with newer ones.
</I>&gt;<i> &gt;     However,
</I>&gt;<i> &gt;      &gt;     you
</I>&gt;<i> &gt;      &gt;     should not test using real origin servers (that you do not
</I>&gt;<i> &gt;     control)!
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt; Could you clarify if this behavior of my squid is
</I>&gt;<i> &gt;      &gt;      &gt; a bug/misconfiguration, or if I'm running into server
</I>&gt;<i> &gt;     performance
</I>&gt;<i> &gt;      &gt;      &gt; limitations (squid is running on a VM with 22 cores)?
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt;     Most likely, reduction of hit ratio with increase of
</I>&gt;<i> &gt;     concurrency is
</I>&gt;<i> &gt;      &gt;     _not_ a performance limitation.
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt;     HTH,
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt;     Alex.
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt; I selected a couple of cacheable resources in the internet
</I>&gt;<i> for
</I>&gt;<i> &gt;      &gt;     testing:
</I>&gt;<i> &gt;      &gt;      &gt;   - small size (~400 KB):
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> <A HREF="https://ia800406.us.archive.org/13/items/romeo-y-julieta-texto-completo/Romeo%20y%20Julieta%20-%20William%20Shakespeare.pdf">https://ia800406.us.archive.org/13/items/romeo-y-julieta-texto-completo/Romeo%20y%20Julieta%20-%20William%20Shakespeare.pdf</A>
</I>&gt;<i> &lt;
</I>&gt;<i> <A HREF="https://ia800406.us.archive.org/13/items/romeo-y-julieta-texto-completo/Romeo%20y%20Julieta%20-%20William%20Shakespeare.pdf">https://ia800406.us.archive.org/13/items/romeo-y-julieta-texto-completo/Romeo%20y%20Julieta%20-%20William%20Shakespeare.pdf</A>&gt;
</I>&gt;<i> &lt;
</I>&gt;<i> <A HREF="https://ia800406.us.archive.org/13/items/romeo-y-julieta-texto-completo/Romeo%20y%20Julieta%20-%20William%20Shakespeare.pdf">https://ia800406.us.archive.org/13/items/romeo-y-julieta-texto-completo/Romeo%20y%20Julieta%20-%20William%20Shakespeare.pdf</A>
</I>&gt;<i> &lt;
</I>&gt;<i> <A HREF="https://ia800406.us.archive.org/13/items/romeo-y-julieta-texto-completo/Romeo%20y%20Julieta%20-%20William%20Shakespeare.pdf">https://ia800406.us.archive.org/13/items/romeo-y-julieta-texto-completo/Romeo%20y%20Julieta%20-%20William%20Shakespeare.pdf</A>&gt;&gt;
</I>&gt;<i> &lt;
</I>&gt;<i> <A HREF="https://ia800406.us.archive.org/13/items/romeo-y-julieta-texto-completo/Romeo%20y%20Julieta%20-%20William%20Shakespeare.pdf">https://ia800406.us.archive.org/13/items/romeo-y-julieta-texto-completo/Romeo%20y%20Julieta%20-%20William%20Shakespeare.pdf</A>
</I>&gt;<i> &lt;
</I>&gt;<i> <A HREF="https://ia800406.us.archive.org/13/items/romeo-y-julieta-texto-completo/Romeo%20y%20Julieta%20-%20William%20Shakespeare.pdf">https://ia800406.us.archive.org/13/items/romeo-y-julieta-texto-completo/Romeo%20y%20Julieta%20-%20William%20Shakespeare.pdf</A>&gt;
</I>&gt;<i> &lt;
</I>&gt;<i> <A HREF="https://ia800406.us.archive.org/13/items/romeo-y-julieta-texto-completo/Romeo%20y%20Julieta%20-%20William%20Shakespeare.pdf">https://ia800406.us.archive.org/13/items/romeo-y-julieta-texto-completo/Romeo%20y%20Julieta%20-%20William%20Shakespeare.pdf</A>
</I>&gt;<i> &lt;
</I>&gt;<i> <A HREF="https://ia800406.us.archive.org/13/items/romeo-y-julieta-texto-completo/Romeo%20y%20Julieta%20-%20William%20Shakespeare.pdf">https://ia800406.us.archive.org/13/items/romeo-y-julieta-texto-completo/Romeo%20y%20Julieta%20-%20William%20Shakespeare.pdf</A>
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;      &gt;      &gt;   - large (~8 MB):
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> <A HREF="https://ia600601.us.archive.org/10/items/Linux-Journal-2015-01/Linux-Journal-2015-01.pdf">https://ia600601.us.archive.org/10/items/Linux-Journal-2015-01/Linux-Journal-2015-01.pdf</A>
</I>&gt;<i> &lt;
</I>&gt;<i> <A HREF="https://ia600601.us.archive.org/10/items/Linux-Journal-2015-01/Linux-Journal-2015-01.pdf">https://ia600601.us.archive.org/10/items/Linux-Journal-2015-01/Linux-Journal-2015-01.pdf</A>&gt;
</I>&gt;<i> &lt;
</I>&gt;<i> <A HREF="https://ia600601.us.archive.org/10/items/Linux-Journal-2015-01/Linux-Journal-2015-01.pdf">https://ia600601.us.archive.org/10/items/Linux-Journal-2015-01/Linux-Journal-2015-01.pdf</A>
</I>&gt;<i> &lt;
</I>&gt;<i> <A HREF="https://ia600601.us.archive.org/10/items/Linux-Journal-2015-01/Linux-Journal-2015-01.pdf">https://ia600601.us.archive.org/10/items/Linux-Journal-2015-01/Linux-Journal-2015-01.pdf</A>&gt;&gt;
</I>&gt;<i> &lt;
</I>&gt;<i> <A HREF="https://ia600601.us.archive.org/10/items/Linux-Journal-2015-01/Linux-Journal-2015-01.pdf">https://ia600601.us.archive.org/10/items/Linux-Journal-2015-01/Linux-Journal-2015-01.pdf</A>
</I>&gt;<i> &lt;
</I>&gt;<i> <A HREF="https://ia600601.us.archive.org/10/items/Linux-Journal-2015-01/Linux-Journal-2015-01.pdf">https://ia600601.us.archive.org/10/items/Linux-Journal-2015-01/Linux-Journal-2015-01.pdf</A>&gt;
</I>&gt;<i> &lt;
</I>&gt;<i> <A HREF="https://ia600601.us.archive.org/10/items/Linux-Journal-2015-01/Linux-Journal-2015-01.pdf">https://ia600601.us.archive.org/10/items/Linux-Journal-2015-01/Linux-Journal-2015-01.pdf</A>
</I>&gt;<i> &lt;
</I>&gt;<i> <A HREF="https://ia600601.us.archive.org/10/items/Linux-Journal-2015-01/Linux-Journal-2015-01.pdf">https://ia600601.us.archive.org/10/items/Linux-Journal-2015-01/Linux-Journal-2015-01.pdf</A>
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;      &gt;      &gt; To test simultaneous connections I am forking curl using a
</I>&gt;<i> &gt;     simple
</I>&gt;<i> &gt;      &gt;     script
</I>&gt;<i> &gt;      &gt;      &gt; (it is also shown below).
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt; When I run a test (500 curl threads to
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> <A HREF="https://ia800406.us.archive.org/13/items/romeo-y-julieta-texto-completo/Romeo%20y%20Julieta%20-%20William%20Shakespeare.pdf">https://ia800406.us.archive.org/13/items/romeo-y-julieta-texto-completo/Romeo%20y%20Julieta%20-%20William%20Shakespeare.pdf</A>
</I>&gt;<i> &lt;
</I>&gt;<i> <A HREF="https://ia800406.us.archive.org/13/items/romeo-y-julieta-texto-completo/Romeo%20y%20Julieta%20-%20William%20Shakespeare.pdf">https://ia800406.us.archive.org/13/items/romeo-y-julieta-texto-completo/Romeo%20y%20Julieta%20-%20William%20Shakespeare.pdf</A>&gt;
</I>&gt;<i> &lt;
</I>&gt;<i> <A HREF="https://ia800406.us.archive.org/13/items/romeo-y-julieta-texto-completo/Romeo%20y%20Julieta%20-%20William%20Shakespeare.pdf">https://ia800406.us.archive.org/13/items/romeo-y-julieta-texto-completo/Romeo%20y%20Julieta%20-%20William%20Shakespeare.pdf</A>
</I>&gt;<i> &lt;
</I>&gt;<i> <A HREF="https://ia800406.us.archive.org/13/items/romeo-y-julieta-texto-completo/Romeo%20y%20Julieta%20-%20William%20Shakespeare.pdf">https://ia800406.us.archive.org/13/items/romeo-y-julieta-texto-completo/Romeo%20y%20Julieta%20-%20William%20Shakespeare.pdf</A>&gt;&gt;
</I>&gt;<i> &lt;
</I>&gt;<i> <A HREF="https://ia800406.us.archive.org/13/items/romeo-y-julieta-texto-completo/Romeo%20y%20Julieta%20-%20William%20Shakespeare.pdf">https://ia800406.us.archive.org/13/items/romeo-y-julieta-texto-completo/Romeo%20y%20Julieta%20-%20William%20Shakespeare.pdf</A>
</I>&gt;<i> &lt;
</I>&gt;<i> <A HREF="https://ia800406.us.archive.org/13/items/romeo-y-julieta-texto-completo/Romeo%20y%20Julieta%20-%20William%20Shakespeare.pdf">https://ia800406.us.archive.org/13/items/romeo-y-julieta-texto-completo/Romeo%20y%20Julieta%20-%20William%20Shakespeare.pdf</A>&gt;
</I>&gt;<i> &lt;
</I>&gt;<i> <A HREF="https://ia800406.us.archive.org/13/items/romeo-y-julieta-texto-completo/Romeo%20y%20Julieta%20-%20William%20Shakespeare.pdf">https://ia800406.us.archive.org/13/items/romeo-y-julieta-texto-completo/Romeo%20y%20Julieta%20-%20William%20Shakespeare.pdf</A>
</I>&gt;<i> &lt;
</I>&gt;<i> <A HREF="https://ia800406.us.archive.org/13/items/romeo-y-julieta-texto-completo/Romeo%20y%20Julieta%20-%20William%20Shakespeare.pdf">https://ia800406.us.archive.org/13/items/romeo-y-julieta-texto-completo/Romeo%20y%20Julieta%20-%20William%20Shakespeare.pdf</A>&gt;&gt;&gt;)
</I>&gt;<i> I see lots of TCP_MISS/200 with FIRSTUP_PARENT/parent_proxy records in the
</I>&gt;<i> logs.
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt; A simple analysis shows a low percentage of cache hits:
</I>&gt;<i> &gt;      &gt;      &gt; cat /var/log/squid.user/access.log| grep '2023-05-29 14' |
</I>&gt;<i> &gt;     grep
</I>&gt;<i> &gt;      &gt;     pdf  |
</I>&gt;<i> &gt;      &gt;      &gt; awk '{print $5&quot; &quot; $10}' | sort | uniq -c
</I>&gt;<i> &gt;      &gt;      &gt;       24 TCP_CF_MISS/200/- HIER_NONE/-
</I>&gt;<i> &gt;      &gt;      &gt;      457 TCP_MISS/200/200 FIRSTUP_PARENT/parent_proxy
</I>&gt;<i> &gt;      &gt;      &gt;       10 TCP_MISS/200/- HIER_NONE/-
</I>&gt;<i> &gt;      &gt;      &gt;        9 TCP_SWAPFAIL_MISS/200/200
</I>&gt;<i> FIRSTUP_PARENT/parent_proxy
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt; So the Hit ratio is about (500-457-9)*100/500=6.8%
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt; Almost the same situation we see when run 200 threads:
</I>&gt;<i> &gt;      &gt;      &gt; cat /var/log/squid.user/access.log| grep '2023-05-29
</I>&gt;<i> 15:45' |
</I>&gt;<i> &gt;      &gt;     grep pdf
</I>&gt;<i> &gt;      &gt;      &gt;   | awk '{print $5&quot; &quot; $10}' | sort | uniq -c
</I>&gt;<i> &gt;      &gt;      &gt;        4 TCP_CF_MISS/200/- HIER_NONE/-
</I>&gt;<i> &gt;      &gt;      &gt;      140 TCP_MISS/200/200 FIRSTUP_PARENT/parent_proxy
</I>&gt;<i> &gt;      &gt;      &gt;       40 TCP_MISS/200/- HIER_NONE/-
</I>&gt;<i> &gt;      &gt;      &gt;       16 TCP_SWAPFAIL_MISS/200/200
</I>&gt;<i> FIRSTUP_PARENT/parent_proxy
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt; This time the Hit ratio is about (200-140-16)*100/500=21%
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt; With 50 threads the Hit ratio is 90%:
</I>&gt;<i> &gt;      &gt;      &gt; cat /var/log/squid.user/access.log| grep '2023-05-29
</I>&gt;<i> 15:50' |
</I>&gt;<i> &gt;      &gt;     grep pdf
</I>&gt;<i> &gt;      &gt;      &gt;   | awk '{print $5&quot; &quot; $10}' | sort | uniq -c
</I>&gt;<i> &gt;      &gt;      &gt;       27 TCP_CF_MISS/200/- HIER_NONE/-
</I>&gt;<i> &gt;      &gt;      &gt;        1 TCP_MISS/200/200 FIRSTUP_PARENT/parent_proxy
</I>&gt;<i> &gt;      &gt;      &gt;       18 TCP_MISS/200/- HIER_NONE/-
</I>&gt;<i> &gt;      &gt;      &gt;        4 TCP_SWAPFAIL_MISS/200/200
</I>&gt;<i> FIRSTUP_PARENT/parent_proxy
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt; I thought that it should always be near 99% - only the
</I>&gt;<i> first
</I>&gt;<i> &gt;      &gt;     request to
</I>&gt;<i> &gt;      &gt;      &gt; an URL should be forwarded to the parent proxy and all
</I>&gt;<i> &gt;     subsequent
</I>&gt;<i> &gt;      &gt;      &gt; requests should be served from the cache.
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt; The situation is even worse with downloading a large file:
</I>&gt;<i> &gt;      &gt;      &gt; 500 threads (0.4%):
</I>&gt;<i> &gt;      &gt;      &gt; cat /var/log/squid.user/access.log| grep '2023-05-29 17:2'
</I>&gt;<i> &gt;     | grep
</I>&gt;<i> &gt;      &gt;     pdf  |
</I>&gt;<i> &gt;      &gt;      &gt; awk '{print $5&quot; &quot; $10}' | sort | uniq -c
</I>&gt;<i> &gt;      &gt;      &gt;       10 TCP_CF_MISS/200/200 FIRSTUP_PARENT/parent_proxy
</I>&gt;<i> &gt;      &gt;      &gt;        2 TCP_CF_MISS/200/- HIER_NONE/-
</I>&gt;<i> &gt;      &gt;      &gt;      488 TCP_MISS/200/200 FIRSTUP_PARENT/parent_proxy
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt; 200 threads (3%):
</I>&gt;<i> &gt;      &gt;      &gt; cat /var/log/squid.user/access.log| grep '2023-05-29 17:3'
</I>&gt;<i> &gt;     | grep
</I>&gt;<i> &gt;      &gt;     pdf  |
</I>&gt;<i> &gt;      &gt;      &gt; awk '{print $5&quot; &quot; $10}' | sort | uniq -c
</I>&gt;<i> &gt;      &gt;      &gt;        9 TCP_CF_MISS/200/200 FIRSTUP_PARENT/parent_proxy
</I>&gt;<i> &gt;      &gt;      &gt;        6 TCP_CF_MISS/200/- HIER_NONE/-
</I>&gt;<i> &gt;      &gt;      &gt;      180 TCP_MISS/200/200 FIRSTUP_PARENT/parent_proxy
</I>&gt;<i> &gt;      &gt;      &gt;        5 TCP_SWAPFAIL_MISS/200/200
</I>&gt;<i> FIRSTUP_PARENT/parent_proxy
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt; 50 threads (98%):
</I>&gt;<i> &gt;      &gt;      &gt; cat /var/log/squid.user/access.log| grep '2023-05-29
</I>&gt;<i> 17:36' |
</I>&gt;<i> &gt;      &gt;     grep pdf
</I>&gt;<i> &gt;      &gt;      &gt;   | awk '{print $5&quot; &quot; $10}' | sort | uniq -c
</I>&gt;<i> &gt;      &gt;      &gt;       25 TCP_CF_HIT/200/- HIER_NONE/-
</I>&gt;<i> &gt;      &gt;      &gt;       12 TCP_CF_MISS/200/- HIER_NONE/-
</I>&gt;<i> &gt;      &gt;      &gt;       12 TCP_HIT/200/- HIER_NONE/-
</I>&gt;<i> &gt;      &gt;      &gt;        1 TCP_MISS/200/200 FIRSTUP_PARENT/parent_proxy
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt; Could you clarify if this behavior of my squid is a
</I>&gt;<i> &gt;      &gt;      &gt; bug/misconfiguration, or if I'm running into server
</I>&gt;<i> &gt;     performance
</I>&gt;<i> &gt;      &gt;      &gt; limitations (squid is running on a VM with 22 cores)?
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt; Kind regards,
</I>&gt;<i> &gt;      &gt;      &gt;       Ankor
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt; *squid.conf:*
</I>&gt;<i> &gt;      &gt;      &gt; workers 21
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt; sslcrtd_program
</I>&gt;<i> &gt;      &gt;     /data/squid.user/usr/lib/squid/security_file_certgen -s
</I>&gt;<i> &gt;      &gt;      &gt; /data/squid.user/var/lib/squid/ssl_db -M 20MB
</I>&gt;<i> &gt;      &gt;      &gt; sslcrtd_children 21
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt; logformat extended-squid %{%Y-%m-%d %H:%M:%S}tl| %6tr %&gt;a
</I>&gt;<i> &gt;      &gt;      &gt; %Ss/%03&gt;Hs/%&lt;Hs %&lt;st %rm %ru %un %Sh/%&lt;A %mt %ea
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt; logfile_rotate 0
</I>&gt;<i> &gt;      &gt;      &gt; access_log daemon:/var/log/squid.user/access.log
</I>&gt;<i> &gt;      &gt;      &gt; logformat=extended-squid on-error=drop
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt; cache_peer parent_proxy  parent 3128 0
</I>&gt;<i> &gt;      &gt;      &gt; never_direct allow all
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt; cachemgr_passwd pass config
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt; acl PURGE method PURGE
</I>&gt;<i> &gt;      &gt;      &gt; http_access allow PURGE
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt; http_access allow all
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt; http_port 3131 ssl-bump generate-host-certificates=on
</I>&gt;<i> &gt;      &gt;      &gt; dynamic_cert_mem_cache_size=20MB
</I>&gt;<i> &gt;      &gt;      &gt; tls-cert=/etc/squid.user/sslbump/bump.crt
</I>&gt;<i> &gt;      &gt;      &gt; tls-key=/etc/squid.user/sslbump/bump.key
</I>&gt;<i> &gt;      &gt;      &gt; sslproxy_cert_error allow all
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt; acl step1 at_step SslBump1
</I>&gt;<i> &gt;      &gt;      &gt; acl step2 at_step SslBump2
</I>&gt;<i> &gt;      &gt;      &gt; acl step3 at_step SslBump3
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt; ssl_bump peek step1
</I>&gt;<i> &gt;      &gt;      &gt; ssl_bump bump step2
</I>&gt;<i> &gt;      &gt;      &gt; ssl_bump bump step3
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt; cache_dir rock /data/squid.user/cache 20000
</I>&gt;<i> max-size=12000000
</I>&gt;<i> &gt;      &gt;      &gt; cache_swap_low 85
</I>&gt;<i> &gt;      &gt;      &gt; cache_swap_high 90
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt; *collapsed_forwarding on*
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt; pinger_enable off
</I>&gt;<i> &gt;      &gt;      &gt; max_filedesc 8192
</I>&gt;<i> &gt;      &gt;      &gt; shutdown_lifetime 5 seconds
</I>&gt;<i> &gt;      &gt;      &gt; netdb_filename none
</I>&gt;<i> &gt;      &gt;      &gt; log_icp_queries off
</I>&gt;<i> &gt;      &gt;      &gt; client_request_buffer_max_size 100 MB
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt; via off
</I>&gt;<i> &gt;      &gt;      &gt; forwarded_for delete
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt; coredump_dir /data/squid.user/var/cache/squid
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt; *curl_forker.sh:*
</I>&gt;<i> &gt;      &gt;      &gt; #!/bin/sh
</I>&gt;<i> &gt;      &gt;      &gt; N=100
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;       URL=
</I>&gt;<i> <A HREF="https://ia600601.us.archive.org/10/items/Linux-Journal-2015-01/Linux-Journal-2015-01.pdf">https://ia600601.us.archive.org/10/items/Linux-Journal-2015-01/Linux-Journal-2015-01.pdf</A>
</I>&gt;<i> &lt;
</I>&gt;<i> <A HREF="https://ia600601.us.archive.org/10/items/Linux-Journal-2015-01/Linux-Journal-2015-01.pdf">https://ia600601.us.archive.org/10/items/Linux-Journal-2015-01/Linux-Journal-2015-01.pdf</A>&gt;
</I>&gt;<i> &lt;
</I>&gt;<i> <A HREF="https://ia600601.us.archive.org/10/items/Linux-Journal-2015-01/Linux-Journal-2015-01.pdf">https://ia600601.us.archive.org/10/items/Linux-Journal-2015-01/Linux-Journal-2015-01.pdf</A>
</I>&gt;<i> &lt;
</I>&gt;<i> <A HREF="https://ia600601.us.archive.org/10/items/Linux-Journal-2015-01/Linux-Journal-2015-01.pdf">https://ia600601.us.archive.org/10/items/Linux-Journal-2015-01/Linux-Journal-2015-01.pdf</A>&gt;&gt;
</I>&gt;<i> &lt;
</I>&gt;<i> <A HREF="https://ia600601.us.archive.org/10/items/Linux-Journal-2015-01/Linux-Journal-2015-01.pdf">https://ia600601.us.archive.org/10/items/Linux-Journal-2015-01/Linux-Journal-2015-01.pdf</A>
</I>&gt;<i> &lt;
</I>&gt;<i> <A HREF="https://ia600601.us.archive.org/10/items/Linux-Journal-2015-01/Linux-Journal-2015-01.pdf">https://ia600601.us.archive.org/10/items/Linux-Journal-2015-01/Linux-Journal-2015-01.pdf</A>&gt;
</I>&gt;<i> &lt;
</I>&gt;<i> <A HREF="https://ia600601.us.archive.org/10/items/Linux-Journal-2015-01/Linux-Journal-2015-01.pdf">https://ia600601.us.archive.org/10/items/Linux-Journal-2015-01/Linux-Journal-2015-01.pdf</A>
</I>&gt;<i> &lt;
</I>&gt;<i> <A HREF="https://ia600601.us.archive.org/10/items/Linux-Journal-2015-01/Linux-Journal-2015-01.pdf">https://ia600601.us.archive.org/10/items/Linux-Journal-2015-01/Linux-Journal-2015-01.pdf</A>
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt; if [[  -n $1 &amp;&amp;  $1 =~ help$  ]];
</I>&gt;<i> &gt;      &gt;      &gt; then
</I>&gt;<i> &gt;      &gt;      &gt;     echo &quot;Usage: $0 [&lt;cnt&gt;] [&lt;url&gt;]&quot;
</I>&gt;<i> &gt;      &gt;      &gt;     echo
</I>&gt;<i> &gt;      &gt;      &gt;     echo &quot;Example: $0 10
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> <A HREF="https://ia600601.us.archive.org/10/items/Linux-Journal-2015-01/Linux-Journal-2015-01.pdf">https://ia600601.us.archive.org/10/items/Linux-Journal-2015-01/Linux-Journal-2015-01.pdf</A>
</I>&gt;<i> &lt;
</I>&gt;<i> <A HREF="https://ia600601.us.archive.org/10/items/Linux-Journal-2015-01/Linux-Journal-2015-01.pdf">https://ia600601.us.archive.org/10/items/Linux-Journal-2015-01/Linux-Journal-2015-01.pdf</A>&gt;
</I>&gt;<i> &lt;
</I>&gt;<i> <A HREF="https://ia600601.us.archive.org/10/items/Linux-Journal-2015-01/Linux-Journal-2015-01.pdf">https://ia600601.us.archive.org/10/items/Linux-Journal-2015-01/Linux-Journal-2015-01.pdf</A>
</I>&gt;<i> &lt;
</I>&gt;<i> <A HREF="https://ia600601.us.archive.org/10/items/Linux-Journal-2015-01/Linux-Journal-2015-01.pdf">https://ia600601.us.archive.org/10/items/Linux-Journal-2015-01/Linux-Journal-2015-01.pdf</A>&gt;&gt;
</I>&gt;<i> &lt;
</I>&gt;<i> <A HREF="https://ia600601.us.archive.org/10/items/Linux-Journal-2015-01/Linux-Journal-2015-01.pdf">https://ia600601.us.archive.org/10/items/Linux-Journal-2015-01/Linux-Journal-2015-01.pdf</A>
</I>&gt;<i> &lt;
</I>&gt;<i> <A HREF="https://ia600601.us.archive.org/10/items/Linux-Journal-2015-01/Linux-Journal-2015-01.pdf">https://ia600601.us.archive.org/10/items/Linux-Journal-2015-01/Linux-Journal-2015-01.pdf</A>&gt;
</I>&gt;<i> &lt;
</I>&gt;<i> <A HREF="https://ia600601.us.archive.org/10/items/Linux-Journal-2015-01/Linux-Journal-2015-01.pdf">https://ia600601.us.archive.org/10/items/Linux-Journal-2015-01/Linux-Journal-2015-01.pdf</A>
</I>&gt;<i> &lt;
</I>&gt;<i> <A HREF="https://ia600601.us.archive.org/10/items/Linux-Journal-2015-01/Linux-Journal-2015-01.pdf">https://ia600601.us.archive.org/10/items/Linux-Journal-2015-01/Linux-Journal-2015-01.pdf</A>
</I>&gt;<i> &gt;&gt;&gt;&quot;;
</I>&gt;<i> &gt;      &gt;      &gt;     echo
</I>&gt;<i> &gt;      &gt;      &gt;     exit;
</I>&gt;<i> &gt;      &gt;      &gt; fi
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt; while [[ $# -gt 0 ]]
</I>&gt;<i> &gt;      &gt;      &gt; do
</I>&gt;<i> &gt;      &gt;      &gt;    if [[ $1 =~ ^[0-9]+$ ]]
</I>&gt;<i> &gt;      &gt;      &gt;    then
</I>&gt;<i> &gt;      &gt;      &gt;       N=$1
</I>&gt;<i> &gt;      &gt;      &gt;    else
</I>&gt;<i> &gt;      &gt;      &gt;       URL=$1
</I>&gt;<i> &gt;      &gt;      &gt;    fi
</I>&gt;<i> &gt;      &gt;      &gt;    shift
</I>&gt;<i> &gt;      &gt;      &gt; done
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt; echo $URL
</I>&gt;<i> &gt;      &gt;      &gt; echo $N threads
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt; for i in `seq $N`
</I>&gt;<i> &gt;      &gt;      &gt; do
</I>&gt;<i> &gt;      &gt;      &gt;    nohup curl --tlsv1.2 -k   --proxy 0001vsg01:3131  -v
</I>&gt;<i> $URL
</I>&gt;<i> &gt;      &gt;       &gt;/dev/null
</I>&gt;<i> &gt;      &gt;      &gt;   2&gt;&amp;1 &amp;
</I>&gt;<i> &gt;      &gt;      &gt; done
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt; _______________________________________________
</I>&gt;<i> &gt;      &gt;      &gt; squid-users mailing list
</I>&gt;<i> &gt;      &gt;      &gt; <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> &gt;     &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>&gt;
</I>&gt;<i> &gt;      &gt;     &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> &gt;     &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>&gt;&gt;
</I>&gt;<i> &gt;      &gt;      &gt; <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i> &gt;     &lt;<A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>&gt;
</I>&gt;<i> &gt;      &gt;     &lt;<A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i> &gt;     &lt;<A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>&gt;&gt;
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt;     _______________________________________________
</I>&gt;<i> &gt;      &gt;     squid-users mailing list
</I>&gt;<i> &gt;      &gt; <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> &gt;     &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>&gt;
</I>&gt;<i> &gt;      &gt;     &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> &gt;     &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>&gt;&gt;
</I>&gt;<i> &gt;      &gt; <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i> &gt;     &lt;<A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>&gt;
</I>&gt;<i> &gt;      &gt;     &lt;<A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i> &gt;     &lt;<A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>&gt;&gt;
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;
</I>&gt;<i>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20230602/f50db762/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20230602/f50db762/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="025855.html">[squid-users] Proxy server to support a large number of simultaneous requests
</A></li>
	<LI>Next message (by thread): <A HREF="025861.html">[squid-users] Proxy server to support a large number of simultaneous requests
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25856">[ date ]</a>
              <a href="thread.html#25856">[ thread ]</a>
              <a href="subject.html#25856">[ subject ]</a>
              <a href="author.html#25856">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
