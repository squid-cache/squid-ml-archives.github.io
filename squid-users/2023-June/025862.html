<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Proxy server to support a large number of simultaneous requests
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Proxy%20server%20to%20support%20a%20large%20number%20of%0A%20simultaneous%20requests&In-Reply-To=%3CCADJd0Y2_5%3Dbnbx57myZHpCTPxbtr6fBtYWBUAB_hEx-EZ1LHyA%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="025861.html">
   <LINK REL="Next"  HREF="025865.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Proxy server to support a large number of simultaneous requests</H1>
    <B>Andrey K</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Proxy%20server%20to%20support%20a%20large%20number%20of%0A%20simultaneous%20requests&In-Reply-To=%3CCADJd0Y2_5%3Dbnbx57myZHpCTPxbtr6fBtYWBUAB_hEx-EZ1LHyA%40mail.gmail.com%3E"
       TITLE="[squid-users] Proxy server to support a large number of simultaneous requests">ankor2023 at gmail.com
       </A><BR>
    <I>Tue Jun  6 13:07:33 UTC 2023</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="025861.html">[squid-users] Proxy server to support a large number of simultaneous requests
</A></li>
        <LI>Next message (by thread): <A HREF="025865.html">[squid-users] Proxy server to support a large number of simultaneous requests
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25862">[ date ]</a>
              <a href="thread.html#25862">[ thread ]</a>
              <a href="subject.html#25862">[ subject ]</a>
              <a href="author.html#25862">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello, Alex,

I have shortened the correspondence because it does not meet the size
requirements for the mailing list.

Thank you so much for your time, the analysis and recommendations.

I disabled the cache_dir and now squid works as expected -  there is only
one request to the original content server:
- on the small file:
      1 NONE_NONE/503/- HIER_NONE/-
      4 TCP_CF_HIT/200/- HIER_NONE/-
    128 TCP_HIT/200/- HIER_NONE/-
    366 TCP_MEM_HIT/200/- HIER_NONE/-
      1 TCP_MISS/200/200 FIRSTUP_PARENT/parent_proxy

- on the large file:
     17 TCP_CF_HIT/200/- HIER_NONE/-
    482 TCP_HIT/200/- HIER_NONE/-
      1 TCP_MISS/200/200 FIRSTUP_PARENT/parent_proxy

I think this configuration is perfect for caching online video broadcasts.
Chanks of video are required by clients simultaneously only for a short
period of time, so there is no need to save them to disk..
As my VM has 32 GB of RAM, I can configure a sufficient amount of
cache_mem, say 20000 MB to provide caching of video broadcasts.


Kind regards,
     Ankor.


&gt;<i>
</I>&gt;<i> &#1087;&#1085;, 5 &#1080;&#1102;&#1085;. 2023&#8239;&#1075;. &#1074; 17:31, Alex Rousskov &lt;
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt;:
</I>&gt;<i>
</I>&gt;&gt;<i> On 6/2/23 03:29, Andrey K wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &gt;  &gt; Can you repeat this test and share a pointer to the corresponding
</I>&gt;&gt;<i> &gt;  &gt; compressed cache.log, containing those 500 (or fewer, as long as the
</I>&gt;&gt;<i> &gt;  &gt; problem is reproduced!) concurrent transactions. One or many of those
</I>&gt;&gt;<i> &gt;  &gt; concurrent transactions resulted in the unwanted entry deletion. The
</I>&gt;&gt;<i> log
</I>&gt;&gt;<i> &gt;  &gt; may show what happened in that case.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &gt; I cleared the rock cache, set the debug level, restarted squid, cleared
</I>&gt;&gt;<i> &gt; the cache.log, ran 500-threads test, waited for it to finish and
</I>&gt;&gt;<i> &gt; launched curl to make sure it returned TCP_MISS.
</I>&gt;&gt;<i> &gt; Then stopped squid to limit the cache.log file.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Thank you for sharing that log! I only had time to study a few misses.
</I>&gt;&gt;<i> They all stemmed from the same sequence of events:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> 1. A collapsed request finds the corresponding entry in the cache.
</I>&gt;&gt;<i> 2. Squid decides that this request should open the disk file.
</I>&gt;&gt;<i> 3. The rock disk entry is still being written (i.e. &quot;swapped out&quot;),
</I>&gt;&gt;<i>     so the attempt to swap it in fails (TCP_SWAPFAIL_MISS).
</I>&gt;&gt;<i> 4. The request goes to the origin server.
</I>&gt;&gt;<i> 5. The fresh response deletes the existing cached entry.
</I>&gt;&gt;<i> 6. When a subsequent request finds the cached entry marked for
</I>&gt;&gt;<i>     deletion, it declares a cache miss (TCP_MISS) and goes to step 4.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Disclaimer: The above sequence of events causes misses, but it may not
</I>&gt;&gt;<i> be the only or even the primary cause. I do not have enough free time to
</I>&gt;&gt;<i> rule out or confirm other causes (and order them by severity).
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Squid can (and should) handle concurrent swapout/swapins better, and we
</I>&gt;&gt;<i> may be able to estimate that improvement potential for your workload
</I>&gt;&gt;<i> without significant development, but, for the next step, I suggest
</I>&gt;&gt;<i> disabling cache_dir and testing whether your get substantially better
</I>&gt;&gt;<i> results with memory cache alone. Shared memory cache also has periods
</I>&gt;&gt;<i> where a being-written entry cannot be read, but, compared to the disk
</I>&gt;&gt;<i> cache, those periods are much shorter IIRC. I would like to confirm that
</I>&gt;&gt;<i> this simplified mode of operation works well for your workload before I
</I>&gt;&gt;<i> suggest code changes that would rely, in part, on this mode.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Thank you,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Alex.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20230606/e2c4867b/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20230606/e2c4867b/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="025861.html">[squid-users] Proxy server to support a large number of simultaneous requests
</A></li>
	<LI>Next message (by thread): <A HREF="025865.html">[squid-users] Proxy server to support a large number of simultaneous requests
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25862">[ date ]</a>
              <a href="thread.html#25862">[ thread ]</a>
              <a href="subject.html#25862">[ subject ]</a>
              <a href="author.html#25862">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
