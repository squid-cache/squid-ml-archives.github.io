<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Proxy server to support a large number of simultaneous requests
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Proxy%20server%20to%20support%20a%20large%20number%20of%0A%20simultaneous%20requests&In-Reply-To=%3C001501d99d05%240429b5e0%240c7d21a0%24%40gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="025862.html">
   <LINK REL="Next"  HREF="025886.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Proxy server to support a large number of simultaneous requests</H1>
    <B>ngtech1ltd at gmail.com</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Proxy%20server%20to%20support%20a%20large%20number%20of%0A%20simultaneous%20requests&In-Reply-To=%3C001501d99d05%240429b5e0%240c7d21a0%24%40gmail.com%3E"
       TITLE="[squid-users] Proxy server to support a large number of simultaneous requests">ngtech1ltd at gmail.com
       </A><BR>
    <I>Mon Jun 12 08:08:04 UTC 2023</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="025862.html">[squid-users] Proxy server to support a large number of simultaneous requests
</A></li>
        <LI>Next message (by thread): <A HREF="025886.html">[squid-users] Proxy server to support a large number of simultaneous requests
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25865">[ date ]</a>
              <a href="thread.html#25865">[ thread ]</a>
              <a href="subject.html#25865">[ subject ]</a>
              <a href="author.html#25865">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hey Ankor,

Thanks for sharing the scenario.
At the beginning I was thinking to myself: Why Squid? Is it the best choice for the scenario?
And after walking through my list of caching proxies, including couple I wrote myself I got to the conclusion:
Well.. Squid-Cache is simple to use and just works.
Compared to other caching mechanisms squid is so simple to configure and it really leaves dust
behind to all many other cache mechanisms.

Thanks,
Eliezer


From: squid-users &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>&gt; On Behalf Of Andrey K
Sent: Tuesday, June 6, 2023 16:08
To: Alex Rousskov &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt;
Cc: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
Subject: Re: [squid-users] Proxy server to support a large number of simultaneous requests

Hello, Alex,

I have shortened the correspondence because it does not meet the size requirements for the mailing list.

Thank you so much for your time, the analysis and recommendations.

I disabled the cache_dir and now squid works as expected -  there is only one request to the original content server:
- on the small file:
      1 NONE_NONE/503/- HIER_NONE/-
      4 TCP_CF_HIT/200/- HIER_NONE/-
    128 TCP_HIT/200/- HIER_NONE/-
    366 TCP_MEM_HIT/200/- HIER_NONE/-
      1 TCP_MISS/200/200 FIRSTUP_PARENT/parent_proxy

- on the large file:
     17 TCP_CF_HIT/200/- HIER_NONE/-
    482 TCP_HIT/200/- HIER_NONE/-
      1 TCP_MISS/200/200 FIRSTUP_PARENT/parent_proxy

I think this configuration is perfect for caching online video broadcasts. Chanks of video are required by clients simultaneously only for a short period of time, so there is no need to save them to disk..
As my VM has 32 GB of RAM, I can configure a sufficient amount of cache_mem, say 20000 MB to provide caching of video broadcasts.


Kind regards,
     Ankor.



&#1087;&#1085;, 5 &#1080;&#1102;&#1085;. 2023&#8239;&#1075;. &#1074; 17:31, Alex Rousskov &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt;:
On 6/2/23 03:29, Andrey K wrote:

&gt;<i>  &gt; Can you repeat this test and share a pointer to the corresponding
</I>&gt;<i>  &gt; compressed cache.log, containing those 500 (or fewer, as long as the
</I>&gt;<i>  &gt; problem is reproduced!) concurrent transactions. One or many of those
</I>&gt;<i>  &gt; concurrent transactions resulted in the unwanted entry deletion. The log
</I>&gt;<i>  &gt; may show what happened in that case.
</I>
&gt;<i> I cleared the rock cache, set the debug level, restarted squid, cleared 
</I>&gt;<i> the cache.log, ran 500-threads test, waited for it to finish and 
</I>&gt;<i> launched curl to make sure it returned TCP_MISS.
</I>&gt;<i> Then stopped squid to limit the cache.log file.
</I>

Thank you for sharing that log! I only had time to study a few misses. 
They all stemmed from the same sequence of events:

1. A collapsed request finds the corresponding entry in the cache.
2. Squid decides that this request should open the disk file.
3. The rock disk entry is still being written (i.e. &quot;swapped out&quot;),
    so the attempt to swap it in fails (TCP_SWAPFAIL_MISS).
4. The request goes to the origin server.
5. The fresh response deletes the existing cached entry.
6. When a subsequent request finds the cached entry marked for
    deletion, it declares a cache miss (TCP_MISS) and goes to step 4.

Disclaimer: The above sequence of events causes misses, but it may not 
be the only or even the primary cause. I do not have enough free time to 
rule out or confirm other causes (and order them by severity).


Squid can (and should) handle concurrent swapout/swapins better, and we 
may be able to estimate that improvement potential for your workload 
without significant development, but, for the next step, I suggest 
disabling cache_dir and testing whether your get substantially better 
results with memory cache alone. Shared memory cache also has periods 
where a being-written entry cannot be read, but, compared to the disk 
cache, those periods are much shorter IIRC. I would like to confirm that 
this simplified mode of operation works well for your workload before I 
suggest code changes that would rely, in part, on this mode.


Thank you,

Alex.



</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="025862.html">[squid-users] Proxy server to support a large number of simultaneous requests
</A></li>
	<LI>Next message (by thread): <A HREF="025886.html">[squid-users] Proxy server to support a large number of simultaneous requests
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25865">[ date ]</a>
              <a href="thread.html#25865">[ thread ]</a>
              <a href="subject.html#25865">[ subject ]</a>
              <a href="author.html#25865">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
