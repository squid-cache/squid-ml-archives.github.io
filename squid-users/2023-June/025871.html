<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Certificate error using using squid with tproxy configuration
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Certificate%20error%20using%20using%20squid%20with%20tproxy%0A%20configuration&In-Reply-To=%3CCADAqQfw0Tk0JE0ppmWGKPGuYW_6Vnb90WKCu1GGvGKdfKZ0OSg%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="025870.html">
   <LINK REL="Next"  HREF="025872.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Certificate error using using squid with tproxy configuration</H1>
    <B>Ben Goz</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Certificate%20error%20using%20using%20squid%20with%20tproxy%0A%20configuration&In-Reply-To=%3CCADAqQfw0Tk0JE0ppmWGKPGuYW_6Vnb90WKCu1GGvGKdfKZ0OSg%40mail.gmail.com%3E"
       TITLE="[squid-users] Certificate error using using squid with tproxy configuration">ben.goz87 at gmail.com
       </A><BR>
    <I>Thu Jun 15 11:31:17 UTC 2023</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="025870.html">[squid-users] [squid-announce] Squid 6.0.3 beta is available
</A></li>
        <LI>Next message (by thread): <A HREF="025872.html">[squid-users] Certificate error using using squid with tproxy configuration
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25871">[ date ]</a>
              <a href="thread.html#25871">[ thread ]</a>
              <a href="subject.html#25871">[ subject ]</a>
              <a href="author.html#25871">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>By the help of God.

Hi,
I'm using squid with tproxy including https interception configuration.

The squid version is:
$ /usr/local/squid/sbin/squid -v
Squid Cache: Version 7.0.0-VCS
Service Name: squid

This binary uses OpenSSL 3.0.2 15 Mar 2022. configure options:
 '--with-openssl' '--enable-ssl' '--enable-ssl-crtd' '--enable-icap-client'
'--enable-linux-netfilter'


And the tproxy configuration works perfectly using http without ssl,
But using ssl I'm getting in browser ssl error &quot;ERR_SSL_PROTOCOL_ERROR&quot;
And using curl I get the following output:

$ curl -iv <A HREF="https://www.google.com">https://www.google.com</A> --cert ~/myCA.der
*   Trying 172.217.22.68:443...
* Connected to www.google.com (172.217.22.68) port 443 (#0)
* ALPN, offering h2
* ALPN, offering http/1.1
* could not load PEM client certificate, OpenSSL error error:0480006C:PEM
routines::no start line, (no key found, wrong pass phrase, or wrong file
format?)
* Closing connection 0
curl: (58) could not load PEM client certificate, OpenSSL error
error:0480006C:PEM routines::no start line, (no key found, wrong pass
phrase, or wrong file format?)

Squid's configuration:
http_port 0.0.0.0:3130 tproxy ssl-bump \
  cert=/usr/local/squid/etc/ssl_cert/myCA.der \
  key=/usr/local/squid/etc/ssl_cert/myCA.pem \
  generate-host-certificates=on dynamic_cert_mem_cache_size=4MB

iptables rule:
$ sudo iptables -t mangle -L
Chain PREROUTING (policy ACCEPT)
target     prot opt source               destination
DIVERT     tcp  --  anywhere             anywhere             socket
TPROXY     tcp  --  anywhere             anywhere             tcp dpt:http
TPROXY redirect 0.0.0.0:3129 mark 0x1/0x1
TPROXY     tcp  --  anywhere             anywhere             tcp dpt:https
TPROXY redirect 0.0.0.0:3130 mark 0x1/0x1

Chain INPUT (policy ACCEPT)
target     prot opt source               destination

Chain FORWARD (policy ACCEPT)
target     prot opt source               destination

Chain OUTPUT (policy ACCEPT)
target     prot opt source               destination

Chain POSTROUTING (policy ACCEPT)
target     prot opt source               destination

Chain DIVERT (1 references)
target     prot opt source               destination
MARK       all  --  anywhere             anywhere             MARK set 0x1
ACCEPT     all  --  anywhere             anywhere

Did I miss something?

Thanks,
Ben
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20230615/7eef0174/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20230615/7eef0174/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="025870.html">[squid-users] [squid-announce] Squid 6.0.3 beta is available
</A></li>
	<LI>Next message (by thread): <A HREF="025872.html">[squid-users] Certificate error using using squid with tproxy configuration
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25871">[ date ]</a>
              <a href="thread.html#25871">[ thread ]</a>
              <a href="subject.html#25871">[ subject ]</a>
              <a href="author.html#25871">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
