From rafael.akchurin at diladele.com  Wed Mar  1 16:31:41 2023
From: rafael.akchurin at diladele.com (Rafael Akchurin)
Date: Wed, 1 Mar 2023 16:31:41 +0000
Subject: [squid-users] ClamAV crash in eCAP Adapter
Message-ID: <AM8PR04MB774568FCAA7FD5D54A280BBD8FAD9@AM8PR04MB7745.eurprd04.prod.outlook.com>

Hello everyone,

May I ask for your experiences with the latest update of ClamAV with eCAP adapter enabled. Running Squid 5.7 on Ubuntu 20.04.
Starting from today (01-March-2023) the following crash stops Squid process.

#0  0x00007fab13a44ff0 in cli_bm_scanbuff () from /lib/x86_64-linux-gnu/libclamav.so.9
#1  0x00007fab13a4c8da in ?? () from /lib/x86_64-linux-gnu/libclamav.so.9
#2  0x00007fab13a52023 in ?? () from /lib/x86_64-linux-gnu/libclamav.so.9
#3  0x00007fab13a545a9 in ?? () from /lib/x86_64-linux-gnu/libclamav.so.9
#4  0x00007fab13a5a589 in ?? () from /lib/x86_64-linux-gnu/libclamav.so.9
#5  0x00007fab13a5b4cf in ?? () from /lib/x86_64-linux-gnu/libclamav.so.9
#6  0x00007fab13a54251 in ?? () from /lib/x86_64-linux-gnu/libclamav.so.9
#7  0x00007fab13a5767a in cl_load () from /lib/x86_64-linux-gnu/libclamav.so.9
#8  0x00007fab13c123e5 in Adapter::ClamAv::loadDatabase (this=this at entry=0x56119a5f4290) at ClamAv.cc:137
#9  0x00007fab13c12658 in Adapter::ClamAv::configure (this=0x56119a5f4290, cfg=...) at ClamAv.cc:83
#10 0x00007fab13c0939d in Adapter::Service::configure (this=0x56119a5ef940, cfg=warning: RTTI symbol not found for class 'Adaptation::Ecap::ConfigRep'
...) at /usr/include/c++/9/tr1/shared_ptr.h:668
#11 0x000056119979bd04 in Adaptation::Ecap::ServiceRep::tryConfigureAndStart() ()
#12 0x000056119979c38b in Adaptation::Ecap::ServiceRep::finalize() ()
#13 0x0000561199783126 in Adaptation::Config::Finalize(bool) ()
#14 0x000056119951ba3f in SquidMain(int, char**) ()
#15 0x00005611993a8ef6 in main ()

Am I correct to think the crash might be related to some definition file update issued by ClamAV team?

Already tried re-download of the definition files using freshclam, but without any success.
Disabling eCAP adapter solves the problems but I would rather find out why it crashes.

Best regards,
Rafael

-------------- next part --------------
A non-text attachment was scrubbed...
Name: winmail.dat
Type: application/ms-tnef
Size: 18249 bytes
Desc: not available
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230301/d6b46090/attachment.bin>

From rousskov at measurement-factory.com  Wed Mar  1 17:07:22 2023
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Wed, 1 Mar 2023 12:07:22 -0500
Subject: [squid-users] ClamAV crash in eCAP Adapter
In-Reply-To: <AM8PR04MB774568FCAA7FD5D54A280BBD8FAD9@AM8PR04MB7745.eurprd04.prod.outlook.com>
References: <AM8PR04MB774568FCAA7FD5D54A280BBD8FAD9@AM8PR04MB7745.eurprd04.prod.outlook.com>
Message-ID: <29ff3195-5a94-de06-e9a2-559aacd4d22e@measurement-factory.com>

On 3/1/23 11:31, Rafael Akchurin wrote:
> Hello everyone,
> 
> May I ask for your experiences with the latest update of ClamAV with eCAP adapter enabled. Running Squid 5.7 on Ubuntu 20.04.
> Starting from today (01-March-2023) the following crash stops Squid process.

For ClamAV eCAP adapter support, please use that adapter support 
channels rather that squid-users: https://www.e-cap.org/support/
It may help if you define "crash" more precisely when following up there.


> #0  0x00007fab13a44ff0 in cli_bm_scanbuff () from /lib/x86_64-linux-gnu/libclamav.so.9
> #1  0x00007fab13a4c8da in ?? () from /lib/x86_64-linux-gnu/libclamav.so.9
> #2  0x00007fab13a52023 in ?? () from /lib/x86_64-linux-gnu/libclamav.so.9
> #3  0x00007fab13a545a9 in ?? () from /lib/x86_64-linux-gnu/libclamav.so.9
> #4  0x00007fab13a5a589 in ?? () from /lib/x86_64-linux-gnu/libclamav.so.9
> #5  0x00007fab13a5b4cf in ?? () from /lib/x86_64-linux-gnu/libclamav.so.9
> #6  0x00007fab13a54251 in ?? () from /lib/x86_64-linux-gnu/libclamav.so.9
> #7  0x00007fab13a5767a in cl_load () from /lib/x86_64-linux-gnu/libclamav.so.9
> #8  0x00007fab13c123e5 in Adapter::ClamAv::loadDatabase (this=this at entry=0x56119a5f4290) at ClamAv.cc:137
> #9  0x00007fab13c12658 in Adapter::ClamAv::configure (this=0x56119a5f4290, cfg=...) at ClamAv.cc:83
> #10 0x00007fab13c0939d in Adapter::Service::configure (this=0x56119a5ef940, cfg=warning: RTTI symbol not found for class 'Adaptation::Ecap::ConfigRep'
> ...) at /usr/include/c++/9/tr1/shared_ptr.h:668
> #11 0x000056119979bd04 in Adaptation::Ecap::ServiceRep::tryConfigureAndStart() ()
> #12 0x000056119979c38b in Adaptation::Ecap::ServiceRep::finalize() ()
> #13 0x0000561199783126 in Adaptation::Config::Finalize(bool) ()
> #14 0x000056119951ba3f in SquidMain(int, char**) ()
> #15 0x00005611993a8ef6 in main ()
> 
> Am I correct to think the crash might be related to some definition file update issued by ClamAV team?


It might be. In the past, the changes in the ClamAV database file 
location and/or name resulted in crashes with similar symptoms as 
detailed at https://bugs.launchpad.net/ecap/+bug/1426095

That information may no longer be relevant, but according to the triage 
of that (very old!) issue, you may want to enable Squid debugging and 
search for errors like the following:

LibClamAV Error: cl_load(): No such file or directory: 
/usr/local/clamav/share/clamav


HTH,

Alex.



From matthias.fischer at ipfire.org  Thu Mar  2 17:40:52 2023
From: matthias.fischer at ipfire.org (Matthias Fischer)
Date: Thu, 2 Mar 2023 18:40:52 +0100
Subject: [squid-users] Missing translation directories und 'errors' in squid
 5.8
Message-ID: <c5114dde-e744-21e4-1ad1-2f0dc364a91c@ipfire.org>

Hello,

I'm a bit puzzled - sorry if I just overlooked something, but...:

Since 'squid 5.8' there are no "translation directories" in the source
code anymore, only 'templates' and the usual scripts.

No 'errors/af', 'errors/ar', 'errors/az' containing
'\squid-5.8\errors\af\ERR_ACCESS_DENIED' (e.g.).

The TRANSLATORS are still listed but none of their files...

Did I miss something?

Regards,

Matthias


From admin at eduaicta.ro  Fri Mar  3 06:22:04 2023
From: admin at eduaicta.ro (Avram-Teodor Berindeie)
Date: Fri, 3 Mar 2023 08:22:04 +0200
Subject: [squid-users] Missing translation directories und 'errors' in squid
 5.8
Message-ID: <CAOsGNXym7XBcEap_vwbO3zCQpRRXVJ1d6WDPMUuVY5PSMUacMQ@mail.gmail.com>

A solution if the error messages in English are OK is to set this directive
in squid.conf:
error_directory /<path to>/squid/share/errors/templates
For error messages in other languages, information in this link
<https://wiki.squid-cache.org/Translations>.
This configuration options can also be used:
*--enable*/disable*-translation*
By default, Squid tries to present error and manual pages in a local
language. If we don't want this to happen, then we can use this option.
*--enable*/disable*-auto-locale*
Based on a client's request headers, Squid tries to automatically provide
localized error pages. We can use this option to disable automatic
localization. The error_directory tag in the Squid configuration file must
be configured if we use this option.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230303/b4004808/attachment.htm>

From frizquierdo87 at gmail.com  Fri Mar  3 19:22:27 2023
From: frizquierdo87 at gmail.com (Francisco)
Date: Fri, 3 Mar 2023 14:22:27 -0500
Subject: [squid-users] Can't store log in mysql 8.0 database
Message-ID: <CAJXDObZaB3bjqZ41+tDKKvTx_w4Q6B+4uqgMKwruMO6SL7fTZA@mail.gmail.com>

Hi, I\m trying to store logs in a mysql server 8.0 database from squid 5.7
in Debian 11.

My idea is store all logs in /var/log/squid/ dir, and logs from specifics
urls, domains and sites store in mysql database ('access_log_internet'
table) to restrict those users that overcuote an specific amount of MB.


*The config:*
*access_log /var/log/squid/nav_basica-access.log squid dominios*

* access_log /var/log/squid/nav_basica-access.log squid dominios_parciales *

* access_log /var/log/squid/nav_basica-access.log squid sitios *
* access_log /var/log/squid/nav_basica-access.log squid dominio_cu*
* access_log /var/log/squid/internet-access.log squid !dominios
!dominios_parciales !sitios !dominio_cu*

*logfile_daemon /usr/lib/squid/log_db_daemon*
*access_log
daemon:/192.168.56.2:3306/squidmgr/access_log_internet/squidmgr/squidmgrsquid
<http://192.168.56.2:3306/squidmgr/access_log_internet/squidmgr/squidmgrsquid>
!dominios !dominios_parciales !sitios !dominio_cu*

when try start squid, it's fail:



















*Dec 31 19:00:00 1969Use of uninitialized value $DBI::errstr in
concatenation (.) or string at /usr/lib/squid/log_db_daemon line 403.Dec 31
19:00:00 1969Cannot connect to database:  at /usr/lib/squid/log_db_daemon
line 403.Dec 31 19:33:43 1969/03/03 14:10:32| pinger: Initialising ICMP
pinger ...Dec 31 19:33:43 1969/03/03 14:10:32| pinger: ICMP socket
opened.Dec 31 19:33:43 1969/03/03 14:10:32| pinger: ICMPv6 socket openedDec
31 19:33:43 1969/03/03 14:10:32| Pinger exiting.Dec 31 19:33:43 1969/03/03
14:10:32 kid1| logfileHandleWrite:
daemon:/192.168.56.1:3306/squidmgr/access_log_internet/squidmgr/squidmgr
<http://192.168.56.1:3306/squidmgr/access_log_internet/squidmgr/squidmgr>:
error writing ((32) Broken pipe)Dec 31 19:33:43 1969/03/03 14:10:32 kid1|
Closing HTTP(S) port 192.168.56.2:8080 <http://192.168.56.2:8080>Dec 31
19:33:43 1969/03/03 14:10:32 kid1| storeDirWriteCleanLogs: Starting...Dec
31 19:33:43 1969/03/03 14:10:32 kid1|   Finished.  Wrote 134 entries.Dec 31
19:33:43 1969/03/03 14:10:32 kid1|   Took 0.00 seconds (308045.98
entries/sec).Dec 31 19:33:43 1969/03/03 14:10:32 kid1| FATAL: I don't
handle this error well!Dec 31 19:33:43 1969/03/03 14:10:32 kid1| Squid
Cache (Version 5.7): Terminated abnormally.Dec 31 19:00:00 1969CPU Usage:
0.161 seconds = 0.132 user + 0.029 sysDec 31 19:00:00 1969Maximum Resident
Size: 109440 KBDec 31 19:00:00 1969Page faults with physical i/o: 0Dec 31
19:33:43 1969/03/03 14:10:32 kid1| Closing Pinger socket on FD 66Dec 31
19:33:43 1969/03/03 14:10:32| Removing PID file (/run/squid.pid)*
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230303/b066310c/attachment.htm>

From squid3 at treenet.co.nz  Sat Mar  4 12:15:48 2023
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Sun, 5 Mar 2023 01:15:48 +1300
Subject: [squid-users] Missing translation directories und 'errors' in
 squid 5.8
In-Reply-To: <CAOsGNXym7XBcEap_vwbO3zCQpRRXVJ1d6WDPMUuVY5PSMUacMQ@mail.gmail.com>
References: <CAOsGNXym7XBcEap_vwbO3zCQpRRXVJ1d6WDPMUuVY5PSMUacMQ@mail.gmail.com>
Message-ID: <c84158f3-159d-6fe8-d947-9aea9f63ebd8@treenet.co.nz>


FYI, The missing files from 5.8 can be downloaded from here as a 
stand-alone package:
 ? <http://www.squid-cache.org/Versions/langpack/>

Cheers
Amos

On 3/03/2023 7:22 pm, Avram-Teodor Berindeie wrote:
> A solution if the error messages in English are OK is to set this 
> directive in squid.conf:
> error_directory /<path to>/squid/share/errors/templates
> For error messages in other languages, information in this link 
> <https://wiki.squid-cache.org/Translations>.
> This configuration options can also be used:
> *--enable*/disable*-translation*
> By default, Squid tries to present error and manual pages in a local 
> language. If we don't want this to happen, then we can use this option.
> *--enable*/disable*-auto-locale*
> Based on a client's request headers, Squid tries to automatically 
> provide localized error pages. We can use this option to disable 
> automatic localization. The error_directory tag in the Squid 
> configuration file must be configured if we use this option.
>
>
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users



From squid3 at treenet.co.nz  Sat Mar  4 12:16:08 2023
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Sun, 5 Mar 2023 01:16:08 +1300
Subject: [squid-users] Missing translation directories und 'errors' in
 squid 5.8
In-Reply-To: <c5114dde-e744-21e4-1ad1-2f0dc364a91c@ipfire.org>
References: <c5114dde-e744-21e4-1ad1-2f0dc364a91c@ipfire.org>
Message-ID: <3e134177-1ed1-431e-bfc0-fe2ba1d8b52d@treenet.co.nz>

Ouch, sorry about that.


FYI, The missing files from 5.8 can be downloaded from here as a 
stand-alone package:
 ? <http://www.squid-cache.org/Versions/langpack/>

Cheers
Amos


On 3/03/2023 6:40 am, Matthias Fischer wrote:
> Hello,
>
> I'm a bit puzzled - sorry if I just overlooked something, but...:
>
> Since 'squid 5.8' there are no "translation directories" in the source
> code anymore, only 'templates' and the usual scripts.
>
> No 'errors/af', 'errors/ar', 'errors/az' containing
> '\squid-5.8\errors\af\ERR_ACCESS_DENIED' (e.g.).
>
> The TRANSLATORS are still listed but none of their files...
>
> Did I miss something?
>
> Regards,
>
> Matthias
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users



From squid3 at treenet.co.nz  Sat Mar  4 12:23:54 2023
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Sun, 5 Mar 2023 01:23:54 +1300
Subject: [squid-users] Can't store log in mysql 8.0 database
In-Reply-To: <CAJXDObZaB3bjqZ41+tDKKvTx_w4Q6B+4uqgMKwruMO6SL7fTZA@mail.gmail.com>
References: <CAJXDObZaB3bjqZ41+tDKKvTx_w4Q6B+4uqgMKwruMO6SL7fTZA@mail.gmail.com>
Message-ID: <3a1726b6-4ca7-bf33-bedc-fe32e3a9420e@treenet.co.nz>

On 4/03/2023 8:22 am, Francisco wrote:
> Hi, I\m trying to store logs in a mysql server 8.0 database from squid 
> 5.7 in Debian 11.
>
> My idea is store all logs in /var/log/squid/ dir, and logs from 
> specifics urls, domains and sites store in mysql database 
> ('access_log_internet' table) to restrict those users that overcuote 
> an specific amount of MB.
>
>
> *The config:*
> /access_log /var/log/squid/nav_basica-access.log squid dominios/
> /access_log /var/log/squid/nav_basica-access.log squid dominios_parciales
> /
> /access_log /var/log/squid/nav_basica-access.log squid sitios
> /
> /access_log /var/log/squid/nav_basica-access.log squid dominio_cu/
> /access_log /var/log/squid/internet-access.log squid !dominios 
> !dominios_parciales !sitios !dominio_cu/
>
> /logfile_daemon /usr/lib/squid/log_db_daemon/
> /access_log 
> daemon:/192.168.56.2:3306/squidmgr/access_log_internet/squidmgr/squidmgrsquid 
> <http://192.168.56.2:3306/squidmgr/access_log_internet/squidmgr/squidmgrsquid> 
> !dominios !dominios_parciales !sitios !dominio_cu/
>
> when try start squid, it's fail:
>
> /Dec 31 19:00:00 1969Use of uninitialized value $DBI::errstr in 
> concatenation (.) or string at /usr/lib/squid/log_db_daemon line 403.
> Dec 31 19:00:00 1969Cannot connect to database: ?at 
> /usr/lib/squid/log_db_daemon line 403.
> /

What version of Perl do you have on this machine?

Do you have both libdbd-mysql-perl and libdbi-perl packages installed?


Cheers
Amos


From matthias.fischer at ipfire.org  Sat Mar  4 12:34:23 2023
From: matthias.fischer at ipfire.org (Matthias Fischer)
Date: Sat, 4 Mar 2023 13:34:23 +0100
Subject: [squid-users] Missing translation directories und 'errors' in
 squid 5.8
In-Reply-To: <c84158f3-159d-6fe8-d947-9aea9f63ebd8@treenet.co.nz>
References: <CAOsGNXym7XBcEap_vwbO3zCQpRRXVJ1d6WDPMUuVY5PSMUacMQ@mail.gmail.com>
 <c84158f3-159d-6fe8-d947-9aea9f63ebd8@treenet.co.nz>
Message-ID: <e903ea55-88eb-ee66-70d1-9220d9d90bac@ipfire.org>

Hello,

On 04.03.2023 13:15, Amos Jeffries wrote:
> FYI, The missing files from 5.8 can be downloaded from here as a 
> stand-alone package:
>  ? <http://www.squid-cache.org/Versions/langpack/>

Yep. In the meantime ( ;-) ) I've found them. I was just a bit puzzled,
in 5.7 these files were still included in the source code.

> Cheers
> Amos

Many thanks!

Best,
Matthias



From divan.whelk.0u at icloud.com  Sat Mar  4 12:42:53 2023
From: divan.whelk.0u at icloud.com (divan.whelk.0u at icloud.com)
Date: Sat, 4 Mar 2023 12:42:53 +0000
Subject: [squid-users] Understanding maximum outgoing HTTP CONNECT
 requests?
Message-ID: <9C815592-A998-4908-842A-A98412D6613F@kontos-home.com>

 
Thank you for the prompt reply!

> - Squid can be configured to receive on up to 64 ports.
>   Thus dst-port on **inbound** is 2^6.

> outbound =  N * 2^6 * 2^128 * 2^16 = N * 2^150

Would that be 2^6 dst-port on outbound, rather than inbound (ignoring Alt-Svc)? Or am misunderstand the theoretical limit formulae after?

> Thus total theoretical limit of simultaneous connections Squid can be juggling is  N * 2^151.

So, for example a single box HTTP CONNECT proxy might be listening on one IPv4 address and one IPv6 address, which would be making the outbound connections (and opening the TCP tunnel) and only able to make outbound connections to either port 80 or 443 (2^16 for each respective port, ignoring Alt-Svc). 

Whereas for incoming, listening on dst-port (3128) (2^16 incoming), with a theoretical limit of 2^32 IPv4 addresses or 2^128 IPv6 addresses (or do you use 2^128 including IPv4)?

> Reality can be significantly different for any given installation, but is imposed by configuration choices and thus can be altered as needed.

Understood, thanks! I think I?ve got a good idea now, with the clarifications.

Alex

> On 17 Feb 2023, at 20:18, Amos Jeffries <squid3 at treenet.co.nz> wrote:
> 
> On 18/02/2023 12:14 am, divan.whelk.0u wrote:
>> Hi there!
>> 
>> I?m trying to understand what would the ?theoretical? maximum amount of outgoing connections with squid setup as a HTTP CONNECT forward proxy would be (hardware permitting)?
> 
> As you likely know, each TCP/IP connection uses a 4-tuple identifier {src-IP, src-port, dst-IP, dst-port}.
> 
> So at face value there is a protocol imposed cap of (2^128 * 2^16 * 2^128 * 2^16) = 2^288 connections.
> 
> Being theoretical we have:
>     * ignored reserved IP ranges,
>     * ignored OS-specific ephemeral port reservations,
>     * assumed IPv6 availability, and
>     * assumed no access restrictions in Squid, network routing, nor firewall.
> 
> The factors to consider are:
> 
>  - Squid machine can be assigned multiple IP's.
>     Thus src-IP on outbound and dst-IP on inbound are that N.
> 
>  - Squid can be configured to receive on up to 64 ports.
>    Thus dst-port on inbound is 2^6.
> 
>  - DNS can provide any number of IPs for any given server name.
>     Thus outbound dst-IP can be any 2^128 value.
> 
>  - modern websites use use Alt-Svc to spread across ports.
>     Thus outbound dst-port can be any 2^16 value.
> 
> So for theoretical limit the math is:
> 
>  inbound =    2^128 * 2^16 * N * 2^16  = N * 2^160
> 
>  outbound =  N * 2^6 * 2^128 * 2^16 = N * 2^150
> 
> Inbound and outbound are normally independent, but CONNECT is a special case where they are pinned 1:1.
> 
> Thus total theoretical limit of simultaneous connections Squid can be juggling is  N * 2^151.
> 
> Reality can be significantly different for any given installation, but is imposed by configuration choices and thus can be altered as needed.
> 
> 
>> From the [squid-users] About bottlenecks (Max number of connections, etc.) thread, I saw mention of the following:
>> 
>>> * The limit on number of connections any Squid can have attached is only limited by your configured FD limits and available server RAM. Squid uses ~64 KB per network socket for traffic state - which equates to around 2 GB of RAM just for I/O buffers at 20,000 concurrent client connections.
>> I assume the same would not apply on outgoing connections, and that there would be a limit of 65,536 connections to a single IP, port pair? For example, if we had 1 million users making requests via HTTP CONNECT, only 65K of them would be able to access the same website at any one time?
> 
> IIRC that quoted thread was discussing a Squid with more normal multiple-destination case hitting FD limits.  The 64K port limitation you refer to is a special case contingent on the "single destination with single IP:port" criteria - which itself is rarely true for a popular website. It assumes configuration restriction imposing that criteria somehow.
> 
> 
> Cheers
> Amos
> 
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users


From frizquierdo87 at gmail.com  Sat Mar  4 14:04:32 2023
From: frizquierdo87 at gmail.com (Francisco)
Date: Sat, 4 Mar 2023 09:04:32 -0500
Subject: [squid-users] Can't store log in mysql 8.0 database (Amos
 Jeffries)
In-Reply-To: <mailman.7581.1677933782.1112.squid-users@lists.squid-cache.org>
References: <mailman.7581.1677933782.1112.squid-users@lists.squid-cache.org>
Message-ID: <CAJXDOba8HK9Bff_J7e66wrx63Ynp-DK-2iQqR70TFpy7OPGh6w@mail.gmail.com>

Ohh, thanks!!!! libdbd-mysql-perl was not installed.
Work like a charm!!!

El s?b., 4 de mar. de 2023 7:43 a.m., <
squid-users-request at lists.squid-cache.org> escribi?:

> Send squid-users mailing list submissions to
>         squid-users at lists.squid-cache.org
>
> To subscribe or unsubscribe via the World Wide Web, visit
>         http://lists.squid-cache.org/listinfo/squid-users
> or, via email, send a message with subject or body 'help' to
>         squid-users-request at lists.squid-cache.org
>
> You can reach the person managing the list at
>         squid-users-owner at lists.squid-cache.org
>
> When replying, please edit your Subject line so it is more specific
> than "Re: Contents of squid-users digest..."
>
>
> Today's Topics:
>
>    1. Re: Missing translation directories und 'errors' in squid 5.8
>       (Amos Jeffries)
>    2. Re: Missing translation directories und 'errors' in squid 5.8
>       (Amos Jeffries)
>    3. Re: Can't store log in mysql 8.0 database (Amos Jeffries)
>    4. Re: Missing translation directories und 'errors' in squid 5.8
>       (Matthias Fischer)
>    5. Re: Understanding maximum outgoing HTTP CONNECT requests?
>       (divan.whelk.0u at icloud.com)
>
>
> ----------------------------------------------------------------------
>
> Message: 1
> Date: Sun, 5 Mar 2023 01:15:48 +1300
> From: Amos Jeffries <squid3 at treenet.co.nz>
> To: squid-users at lists.squid-cache.org
> Subject: Re: [squid-users] Missing translation directories und
>         'errors' in squid 5.8
> Message-ID: <c84158f3-159d-6fe8-d947-9aea9f63ebd8 at treenet.co.nz>
> Content-Type: text/plain; charset=UTF-8; format=flowed
>
>
> FYI, The missing files from 5.8 can be downloaded from here as a
> stand-alone package:
>  ? <http://www.squid-cache.org/Versions/langpack/>
>
> Cheers
> Amos
>
> On 3/03/2023 7:22 pm, Avram-Teodor Berindeie wrote:
> > A solution if the error messages in English are OK is to set this
> > directive in squid.conf:
> > error_directory /<path to>/squid/share/errors/templates
> > For error messages in other languages, information in this link
> > <https://wiki.squid-cache.org/Translations>.
> > This configuration options can also be used:
> > *--enable*/disable*-translation*
> > By default, Squid tries to present error and manual pages in a local
> > language. If we don't want this to happen, then we can use this option.
> > *--enable*/disable*-auto-locale*
> > Based on a client's request headers, Squid tries to automatically
> > provide localized error pages. We can use this option to disable
> > automatic localization. The error_directory tag in the Squid
> > configuration file must be configured if we use this option.
> >
> >
> > _______________________________________________
> > squid-users mailing list
> > squid-users at lists.squid-cache.org
> > http://lists.squid-cache.org/listinfo/squid-users
>
>
>
> ------------------------------
>
> Message: 2
> Date: Sun, 5 Mar 2023 01:16:08 +1300
> From: Amos Jeffries <squid3 at treenet.co.nz>
> To: squid-users at lists.squid-cache.org
> Subject: Re: [squid-users] Missing translation directories und
>         'errors' in squid 5.8
> Message-ID: <3e134177-1ed1-431e-bfc0-fe2ba1d8b52d at treenet.co.nz>
> Content-Type: text/plain; charset=UTF-8; format=flowed
>
> Ouch, sorry about that.
>
>
> FYI, The missing files from 5.8 can be downloaded from here as a
> stand-alone package:
>  ? <http://www.squid-cache.org/Versions/langpack/>
>
> Cheers
> Amos
>
>
> On 3/03/2023 6:40 am, Matthias Fischer wrote:
> > Hello,
> >
> > I'm a bit puzzled - sorry if I just overlooked something, but...:
> >
> > Since 'squid 5.8' there are no "translation directories" in the source
> > code anymore, only 'templates' and the usual scripts.
> >
> > No 'errors/af', 'errors/ar', 'errors/az' containing
> > '\squid-5.8\errors\af\ERR_ACCESS_DENIED' (e.g.).
> >
> > The TRANSLATORS are still listed but none of their files...
> >
> > Did I miss something?
> >
> > Regards,
> >
> > Matthias
> > _______________________________________________
> > squid-users mailing list
> > squid-users at lists.squid-cache.org
> > http://lists.squid-cache.org/listinfo/squid-users
>
>
>
> ------------------------------
>
> Message: 3
> Date: Sun, 5 Mar 2023 01:23:54 +1300
> From: Amos Jeffries <squid3 at treenet.co.nz>
> To: squid-users at lists.squid-cache.org
> Subject: Re: [squid-users] Can't store log in mysql 8.0 database
> Message-ID: <3a1726b6-4ca7-bf33-bedc-fe32e3a9420e at treenet.co.nz>
> Content-Type: text/plain; charset=UTF-8; format=flowed
>
> On 4/03/2023 8:22 am, Francisco wrote:
> > Hi, I\m trying to store logs in a mysql server 8.0 database from squid
> > 5.7 in Debian 11.
> >
> > My idea is store all logs in /var/log/squid/ dir, and logs from
> > specifics urls, domains and sites store in mysql database
> > ('access_log_internet' table) to restrict those users that overcuote
> > an specific amount of MB.
> >
> >
> > *The config:*
> > /access_log /var/log/squid/nav_basica-access.log squid dominios/
> > /access_log /var/log/squid/nav_basica-access.log squid dominios_parciales
> > /
> > /access_log /var/log/squid/nav_basica-access.log squid sitios
> > /
> > /access_log /var/log/squid/nav_basica-access.log squid dominio_cu/
> > /access_log /var/log/squid/internet-access.log squid !dominios
> > !dominios_parciales !sitios !dominio_cu/
> >
> > /logfile_daemon /usr/lib/squid/log_db_daemon/
> > /access_log
> > daemon:/
> 192.168.56.2:3306/squidmgr/access_log_internet/squidmgr/squidmgrsquid
> > <
> http://192.168.56.2:3306/squidmgr/access_log_internet/squidmgr/squidmgrsquid>
>
> > !dominios !dominios_parciales !sitios !dominio_cu/
> >
> > when try start squid, it's fail:
> >
> > /Dec 31 19:00:00 1969Use of uninitialized value $DBI::errstr in
> > concatenation (.) or string at /usr/lib/squid/log_db_daemon line 403.
> > Dec 31 19:00:00 1969Cannot connect to database: ?at
> > /usr/lib/squid/log_db_daemon line 403.
> > /
>
> What version of Perl do you have on this machine?
>
> Do you have both libdbd-mysql-perl and libdbi-perl packages installed?
>
>
> Cheers
> Amos
>
>
> ------------------------------
>
> Message: 4
> Date: Sat, 4 Mar 2023 13:34:23 +0100
> From: Matthias Fischer <matthias.fischer at ipfire.org>
> To: Amos Jeffries <squid3 at treenet.co.nz>,
>         squid-users at lists.squid-cache.org
> Subject: Re: [squid-users] Missing translation directories und
>         'errors' in squid 5.8
> Message-ID: <e903ea55-88eb-ee66-70d1-9220d9d90bac at ipfire.org>
> Content-Type: text/plain; charset=UTF-8
>
> Hello,
>
> On 04.03.2023 13:15, Amos Jeffries wrote:
> > FYI, The missing files from 5.8 can be downloaded from here as a
> > stand-alone package:
> >  ? <http://www.squid-cache.org/Versions/langpack/>
>
> Yep. In the meantime ( ;-) ) I've found them. I was just a bit puzzled,
> in 5.7 these files were still included in the source code.
>
> > Cheers
> > Amos
>
> Many thanks!
>
> Best,
> Matthias
>
>
>
> ------------------------------
>
> Message: 5
> Date: Sat, 4 Mar 2023 12:42:53 +0000
> From: divan.whelk.0u at icloud.com
> To: squid-users at lists.squid-cache.org
> Subject: Re: [squid-users] Understanding maximum outgoing HTTP CONNECT
>         requests?
> Message-ID: <9C815592-A998-4908-842A-A98412D6613F at kontos-home.com>
> Content-Type: text/plain; charset="utf-8"
>
>
> Thank you for the prompt reply!
>
> > - Squid can be configured to receive on up to 64 ports.
> >   Thus dst-port on **inbound** is 2^6.
>
> > outbound =  N * 2^6 * 2^128 * 2^16 = N * 2^150
>
> Would that be 2^6 dst-port on outbound, rather than inbound (ignoring
> Alt-Svc)? Or am misunderstand the theoretical limit formulae after?
>
> > Thus total theoretical limit of simultaneous connections Squid can be
> juggling is  N * 2^151.
>
> So, for example a single box HTTP CONNECT proxy might be listening on one
> IPv4 address and one IPv6 address, which would be making the outbound
> connections (and opening the TCP tunnel) and only able to make outbound
> connections to either port 80 or 443 (2^16 for each respective port,
> ignoring Alt-Svc).
>
> Whereas for incoming, listening on dst-port (3128) (2^16 incoming), with a
> theoretical limit of 2^32 IPv4 addresses or 2^128 IPv6 addresses (or do you
> use 2^128 including IPv4)?
>
> > Reality can be significantly different for any given installation, but
> is imposed by configuration choices and thus can be altered as needed.
>
> Understood, thanks! I think I?ve got a good idea now, with the
> clarifications.
>
> Alex
>
> > On 17 Feb 2023, at 20:18, Amos Jeffries <squid3 at treenet.co.nz> wrote:
> >
> > On 18/02/2023 12:14 am, divan.whelk.0u wrote:
> >> Hi there!
> >>
> >> I?m trying to understand what would the ?theoretical? maximum amount of
> outgoing connections with squid setup as a HTTP CONNECT forward proxy would
> be (hardware permitting)?
> >
> > As you likely know, each TCP/IP connection uses a 4-tuple identifier
> {src-IP, src-port, dst-IP, dst-port}.
> >
> > So at face value there is a protocol imposed cap of (2^128 * 2^16 *
> 2^128 * 2^16) = 2^288 connections.
> >
> > Being theoretical we have:
> >     * ignored reserved IP ranges,
> >     * ignored OS-specific ephemeral port reservations,
> >     * assumed IPv6 availability, and
> >     * assumed no access restrictions in Squid, network routing, nor
> firewall.
> >
> > The factors to consider are:
> >
> >  - Squid machine can be assigned multiple IP's.
> >     Thus src-IP on outbound and dst-IP on inbound are that N.
> >
> >  - Squid can be configured to receive on up to 64 ports.
> >    Thus dst-port on inbound is 2^6.
> >
> >  - DNS can provide any number of IPs for any given server name.
> >     Thus outbound dst-IP can be any 2^128 value.
> >
> >  - modern websites use use Alt-Svc to spread across ports.
> >     Thus outbound dst-port can be any 2^16 value.
> >
> > So for theoretical limit the math is:
> >
> >  inbound =    2^128 * 2^16 * N * 2^16  = N * 2^160
> >
> >  outbound =  N * 2^6 * 2^128 * 2^16 = N * 2^150
> >
> > Inbound and outbound are normally independent, but CONNECT is a special
> case where they are pinned 1:1.
> >
> > Thus total theoretical limit of simultaneous connections Squid can be
> juggling is  N * 2^151.
> >
> > Reality can be significantly different for any given installation, but
> is imposed by configuration choices and thus can be altered as needed.
> >
> >
> >> From the [squid-users] About bottlenecks (Max number of connections,
> etc.) thread, I saw mention of the following:
> >>
> >>> * The limit on number of connections any Squid can have attached is
> only limited by your configured FD limits and available server RAM. Squid
> uses ~64 KB per network socket for traffic state - which equates to around
> 2 GB of RAM just for I/O buffers at 20,000 concurrent client connections.
> >> I assume the same would not apply on outgoing connections, and that
> there would be a limit of 65,536 connections to a single IP, port pair? For
> example, if we had 1 million users making requests via HTTP CONNECT, only
> 65K of them would be able to access the same website at any one time?
> >
> > IIRC that quoted thread was discussing a Squid with more normal
> multiple-destination case hitting FD limits.  The 64K port limitation you
> refer to is a special case contingent on the "single destination with
> single IP:port" criteria - which itself is rarely true for a popular
> website. It assumes configuration restriction imposing that criteria
> somehow.
> >
> >
> > Cheers
> > Amos
> >
> > _______________________________________________
> > squid-users mailing list
> > squid-users at lists.squid-cache.org
> > http://lists.squid-cache.org/listinfo/squid-users
>
>
> ------------------------------
>
> Subject: Digest Footer
>
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users
>
>
> ------------------------------
>
> End of squid-users Digest, Vol 103, Issue 6
> *******************************************
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230304/2da5d5c4/attachment.htm>

From matteo.savatteri at unimi.it  Sun Mar  5 09:44:38 2023
From: matteo.savatteri at unimi.it (Dott. Matteo Savatteri)
Date: Sun, 05 Mar 2023 10:44:38 +0100
Subject: [squid-users] Access based on auth and referer
In-Reply-To: <3da76a82-5b9a-6b36-fc5e-6d3d3a526e6c@unimi.it>
References: <3da76a82-5b9a-6b36-fc5e-6d3d3a526e6c@unimi.it>
Message-ID: <90ec6f50-66b7-7313-6f96-91e130b4fb49@unimi.it>


Hello fellow Squid users,

we use Squid 3.5 at my company and we want to give access to all sites 
to authenticated users. If a user is not authenticated we need to allow 
only HTTP/S requests that present a referer header matching a regex. Is 
this even possible?

I have tried a combination of proxy_auth and referer_regex ACLs with no 
results. sslbump is working.

This is a snippet from my conf:


# example regex to be substituted by a regex list
acl myreferer referer_regex -i ^https://www.example.com/
acl password proxy_auth REQUIRED
acl all src
acl manager proto cache_object
acl SSL_ports port 443 563
acl Safe_ports port 80????????? # http
acl Safe_ports port 21????????? # ftp
acl Safe_ports port 443 563???? # https, snews
acl Safe_ports port 70????????? # gopher
acl Safe_ports port 210???????? # wais
acl Safe_ports port 1025-65535? # unregistered ports
acl Safe_ports port 280???????? # http-mgmt
acl Safe_ports port 488???????? # gss-http
acl Safe_ports port 591???????? # filemaker
acl Safe_ports port 777???????? # multiling http
acl CONNECT method CONNECT

http_access allow manager localhost
http_access deny manager
http_access deny !Safe_ports
http_access deny CONNECT !SSL_ports
http_access allow CONNECT
http_access allow myreferer
http_access allow password
http_access deny all


Using this configuration the requests are correctly filtered based on 
regex, but the proxy does not ask for auth credentials when the regex is 
not matched. If I put? "http_access allow password" above "http_access 
allow CONNECT" like this:


[...]

http_access deny CONNECT !SSL_ports

http_access allow password

http_access allow CONNECT

[...]


the proxy asks for auth for each request not matching the referer regex 
and the anonymous users are bothered.

I have read the docs but i have not found an answer. Please, help me.

Thank you for your kindness,

--
Matteo Savatteri



From uhlar at fantomas.sk  Sun Mar  5 15:15:29 2023
From: uhlar at fantomas.sk (Matus UHLAR - fantomas)
Date: Sun, 5 Mar 2023 16:15:29 +0100
Subject: [squid-users] Can't store log in mysql 8.0 database
In-Reply-To: <CAJXDObZaB3bjqZ41+tDKKvTx_w4Q6B+4uqgMKwruMO6SL7fTZA@mail.gmail.com>
References: <CAJXDObZaB3bjqZ41+tDKKvTx_w4Q6B+4uqgMKwruMO6SL7fTZA@mail.gmail.com>
Message-ID: <ZASyEabdNCAh3lsB@fantomas.sk>

On 03.03.23 14:22, Francisco wrote:
>Hi, I\m trying to store logs in a mysql server 8.0 database from squid 5.7
>in Debian 11.
>
>My idea is store all logs in /var/log/squid/ dir, and logs from specifics
>urls, domains and sites store in mysql database ('access_log_internet'
>table) to restrict those users that overcuote an specific amount of MB.
>
>

>*logfile_daemon /usr/lib/squid/log_db_daemon*
>*access_log
>daemon:/192.168.56.2:3306/squidmgr/access_log_internet/squidmgr/squidmgrsquid
>!dominios !dominios_parciales !sitios !dominio_cu*

>when try start squid, it's fail:
>*Dec 31 19:00:00 1969Use of uninitialized value $DBI::errstr in
>concatenation (.) or string at /usr/lib/squid/log_db_daemon line 403.Dec 31
>19:00:00 1969Cannot connect to database:  at /usr/lib/squid/log_db_daemon
>line 403.


if you run the logfile daemon manually, does it work?
it may be problem in permissions
-- 
Matus UHLAR - fantomas, uhlar at fantomas.sk ; http://www.fantomas.sk/
Warning: I wish NOT to receive e-mail advertising to this address.
Varovanie: na tuto adresu chcem NEDOSTAVAT akukolvek reklamnu postu.
Saving Private Ryan...
Private Ryan exists. Overwrite? (Y/N)


From squid3 at treenet.co.nz  Mon Mar  6 06:34:57 2023
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Mon, 6 Mar 2023 19:34:57 +1300
Subject: [squid-users] Access based on auth and referer
In-Reply-To: <90ec6f50-66b7-7313-6f96-91e130b4fb49@unimi.it>
References: <3da76a82-5b9a-6b36-fc5e-6d3d3a526e6c@unimi.it>
 <90ec6f50-66b7-7313-6f96-91e130b4fb49@unimi.it>
Message-ID: <e1e639b4-3079-04b6-e351-ea0ad7d25064@treenet.co.nz>

On 5/03/2023 10:44 pm, Dott. Matteo Savatteri wrote:
>
> Hello fellow Squid users,
>
> we use Squid 3.5 at my company and we want to give access to all sites 
> to authenticated users. If a user is not authenticated we need to 
> allow only HTTP/S requests that present a referer header matching a 
> regex. Is this even possible?
>
> I have tried a combination of proxy_auth and referer_regex ACLs with 
> no results. sslbump is working.

Try these rules:

 ? # initial security protection
 ? http_access deny !Safe_ports
 ? http_access deny CONNECT !SSL_ports

 ? # forbid access to cache manager from non-localhost
 ? http_access deny manager !localhost
 ? # leave the below commented to require a login for cache manager access
 ? # http_access allow manager

 ? # forbid unauthenticated, except when providing the special Referer 
header
 ? http_access deny !myreferer !password

 ? # users not denied are allowed
 ? http_access allow all


Cheers
Amos



From matteo.savatteri at unimi.it  Mon Mar  6 08:25:13 2023
From: matteo.savatteri at unimi.it (Dott. Matteo Savatteri)
Date: Mon, 06 Mar 2023 09:25:13 +0100
Subject: [squid-users] Access based on auth and referer
In-Reply-To: <e1e639b4-3079-04b6-e351-ea0ad7d25064@treenet.co.nz>
References: <3da76a82-5b9a-6b36-fc5e-6d3d3a526e6c@unimi.it>
 <90ec6f50-66b7-7313-6f96-91e130b4fb49@unimi.it>
 <e1e639b4-3079-04b6-e351-ea0ad7d25064@treenet.co.nz>
Message-ID: <36caccf1-41d0-c6b7-9a9a-49e04c6a04e6@unimi.it>

Hi Amos,

thank you for your answer.

Unfortunately, the config you suggested does not seem to work: using 
that the proxy ask for password for every sites.

I think this is because CONNECT requests naturally does not present the 
referer header. The special referer header in only present in subsequent 
requests, those that get ssl-bumped.

This is an example CONNECT request found in logs:


CONNECT pixel.sitescout.com:443 HTTP/1.1
Host: pixel.sitescout.com:443
Proxy-Connection: keep-alive
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 
(KHTML, like Gecko) Chrome/108.0.0.0 Safari/537.36 Edg/108.0.1462.76


How can I solve this? Is even possible to mix up auth based and referer 
based access?

Thank you for your patience and your kind help,

Matteo

On 3/6/23 07:34, Amos Jeffries wrote:
> On 5/03/2023 10:44 pm, Dott. Matteo Savatteri wrote:
>>
>> Hello fellow Squid users,
>>
>> we use Squid 3.5 at my company and we want to give access to all 
>> sites to authenticated users. If a user is not authenticated we need 
>> to allow only HTTP/S requests that present a referer header matching 
>> a regex. Is this even possible?
>>
>> I have tried a combination of proxy_auth and referer_regex ACLs with 
>> no results. sslbump is working.
>
> Try these rules:
>
> ? # initial security protection
> ? http_access deny !Safe_ports
> ? http_access deny CONNECT !SSL_ports
>
> ? # forbid access to cache manager from non-localhost
> ? http_access deny manager !localhost
> ? # leave the below commented to require a login for cache manager access
> ? # http_access allow manager
>
> ? # forbid unauthenticated, except when providing the special Referer 
> header
> ? http_access deny !myreferer !password
>
> ? # users not denied are allowed
> ? http_access allow all
>
>
> Cheers
> Amos
>
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users

-- 
Dott. Matteo Savatteri

Responsabile Ufficio Piattaforme Tecnologiche
Direzione Servizio Bibliotecario di Ateneo
Universit? degli Studi di Milano

Indirizzo: Via Santa Sofia, 9 20122 MILANO (MI)
Tel. ufficio: 02503 12227
Email: Matteo.Savatteri at unimi.it



From rousskov at measurement-factory.com  Mon Mar  6 19:31:45 2023
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Mon, 6 Mar 2023 14:31:45 -0500
Subject: [squid-users] client->Squid: TCP [RST] and [RST,ACK]
In-Reply-To: <CACSz3ZRC+vyuhrQkz0CDM28cjtvEz47KnPMegpeRP7bNyD+juQ@mail.gmail.com>
References: <CACSz3ZT-BtHDeK48j2NLm5yt8Qng4+4kVGqb-G9=ufEwATdFwQ@mail.gmail.com>
 <CACSz3ZRWZhmGEkUU-ZHF2Vc4yF7mN1OC35sqRwWKzeUHRAB3pg@mail.gmail.com>
 <5d421619-b312-1f72-0de1-4f4a310d02d2@measurement-factory.com>
 <CACSz3ZSu1nYjbPQpsXCunNxP1RVaAjFocv8rVDc9=oVj5-QyVw@mail.gmail.com>
 <42f6163b-321a-5c86-a6e3-0ccc7dcea44f@measurement-factory.com>
 <CACSz3ZSFKYNNcoLHuTmh=jC3KP1-xQpZ+KErbc0K9Gw3=1L8XQ@mail.gmail.com>
 <75d8ab79-b68c-933a-72fb-2d99f4a369ac@measurement-factory.com>
 <CACSz3ZRC+vyuhrQkz0CDM28cjtvEz47KnPMegpeRP7bNyD+juQ@mail.gmail.com>
Message-ID: <aaba86ae-48ba-d339-0d4e-85bd5e91de46@measurement-factory.com>

Hi Maciek,

     Thank you for sharing your debugging logs (off list). My working 
theory is that your child Squid suffers from one of the manifestations 
of Squid Bug #5084 (TLS I/O outcomes mistreated as socket I/O outcomes): 
https://bugs.squid-cache.org/show_bug.cgi?id=5084

I can also speculate that the parent Squid suffers from the same bug, 
and the _combination_ of the bug effects in two Squids triggers some or 
all of the RST packets in your trace.

I have updated the bug report accordingly.

While I am sure that Bug 5084 exists and has bad side effects, my 
confidence in the above working theory is low. There are lots of RST 
packets in the packet capture, and we do not know whether all of them 
are related to ECONNRESET error messages in your nodejs clients. We 
could be looking at problematic exchanges that are not related to those 
ECONNRESET errors! If you can isolate the failure to a specific 
client-Squid connection and add the corresponding cache_peer ALL,9 logs 
to the set, it may help.

Unfortunately, Bug 5084 does not have a simple fix (known to me), and 
its proper solution probably requires significant code refactoring, with 
several technical and non-technical problems in the way. I cannot think 
of some quick hack to test the working theory.

Alex.


On 2/28/23 17:15, Maciej Leks wrote:
> wt., 28 lut 2023 o 22:13 Alex Rousskov
> <rousskov at measurement-factory.com> napisa?(a):
>>
>> On 2/28/23 15:34, Maciej Leks wrote:
>>> wt., 28 lut 2023 o 20:06 Alex Rousskov
>>> <rousskov at measurement-factory.com> napisa?(a):
>>>>
>>>> On 2/28/23 13:07, Maciej Leks wrote:
>>>>>> Does child Squid bump the TLS client connection, tunnel it, or
>>>>>> terminates it (i.e. the child works as a reverse proxy)?
>>>>
>>>>> * client connects to child Squid's http_port without "ssl-bump".
>>>>> * client sends a plain text CONNECT request to child Squid.
>>>>> * child Squid connects to parent using cache_peer with mTLS.
>>>>
>>>> I assume that, by mTLS, you mean a cache_peer directive with "tls"
>>>> option _and_ with "sslcert" (or equivalent) option to specify the TLS
>>>> client certificate to be sent to the cache peer.
>>>>
>>>> I assume that the packets you pasted earlier were between a child Squid
>>>> and its parent.
>>
>>> Exactly.
>>
>>>>>> What are those TLS alerts?
>>>>> Code 21 - decryption_failed_RESERVED(21).
>>
>> Are you sure that 21 is actually the alert description ID and _not_ the
>> TLS message content type (all alert messages have TLS content type 21)?
>> See "ContentType" and "AlertDescription" definitions in RFC 8446. Below,
>> I will assume that it is the former because you said
>> "decryption_failed_RESERVED" above, but this looks very suspicious!
>> Where did you get that "21" from? Perhaps you can show Wireshark
>> dissection of the corresponding alert message?
>>
>>
>> According to obsoleted RFC 5246 (TLS v1.2):
>>
>>>     decryption_failed_RESERVED
>>>        This alert was used in some earlier versions of TLS, and may have
>>>        permitted certain attacks against the CBC mode [CBCATT].  It MUST
>>>        NOT be sent by compliant implementations.
> 
> TLSv1.2 Record Layer: Encrypted Alert
>      Content Type: Alert (21)
>      Version: TLS 1.2 (0x0303)
>      Length: 26
>      Alert Message: Encrypted Alert
> 
> 
>>>> I would focus on this error and ignore RST packets for now. Most likely,
>>>> this error is what triggers those packets.
>>
>>> According to your experience - who sends this TLS "Encrypted Alert"
>>> and RST - either the server (Salesforce) or parent squid?
>>
>> FWIW, I do not recall seeing these specific alerts. It might be
>> Salesforce greasing TLS messages, I guess, but I cannot quickly find
>> evidence of alerts being used for that purpose (RFC 8701 does not
>> mention this greasing vector AFAICT). Typical greased values do not
>> violate MUSTs, but perhaps they can violate MUSTs from obsoleted RFCs?
>> Or this is not a decryption_failed_RESERVED alert ;-).
>>
>> However, I am surprised you are asking the list this question. Don't you
>> know (e.g., from packet captures) who is sending the alert in question?!
> 
> :) I'm sniffing hierarchy of proxies for the very first time. I've
> created the lab yesterday:
> nodejs client->squid->server (the server's only role is to accept a
> connection and then send RST flag back).
> And you now what I got on client side? 502 from the squid.
> So, I'm asking just because it looks like Salesforce alert and RST but
> at the same time it's not fit my observations from the lab.
> When I was watching some pcacps from the parent squid side I've seen
> not many RST from SF's, a few from parent squid side but I've got a
> lot of them on my child squid side.
> You ask me a very good question. The more I look the less I understand :)
> 
> Tomorrow morning I'll turn on debugging.
> 
> Maciek
> 
>>>>>> If those TLS alerts are close_notify alerts, then the RST packets you
>>>>>> are seeing are probably triggered by the other side doing clean TLS
>>>>>> shutdown (i.e. sending a TLS close_notify alert before closing the
>>>>>> connection), either after receiving a FIN packet (unlikely with
>>>>>> half_closed_clients off?) or while that FIN packet is being generated or
>>>>>> is in-flight. When Such RST packets would be sent by the TCP stack
>>>>>> rather than Squid code itself. They may be an indication of a benign
>>>>>> race condition, a bug, or some other deficiency.
>>>>>
>>>>> half_closed_clients is off
>>>>>
>>>>>> Higher-level information (who initiates closure and why) may be needed
>>>>>> to figure this out. I recommend sharing a link to a compressed ALL,9
>>>>>> cache.log reproducing the problem with a single transaction _combined_
>>>>>> with a matching packet trace file in libpcap format.
>>>>>
>>>>> There is no other way than turning debug on.
>>>>>
>>>>> Maciek
>>>>>
>>>>> wt., 28 lut 2023 o 15:15 Alex Rousskov <rousskov at measurement-factory.com
>>>>> <mailto:rousskov at measurement-factory.com>> napisa?(a):
>>>>>
>>>>>       On 2/28/23 08:35, Maciej Leks wrote:
>>>>>        > Am I right in saying that RST it's a design intent of squid to end
>>>>>        > connections quickly? I've started digging into the squid code and see
>>>>>        > SO_LINGER and timeout set to 0, which means that it's done on purpose
>>>>>        > not to hang on connections in TIME_WAIT state?
>>>>>
>>>>>       Does child Squid bump the TLS client connection, tunnel it, or
>>>>>       terminates it (i.e. the child works as a reverse proxy)?
>>>>>
>>>>>       What are those TLS alerts?
>>>>>
>>>>>       If those TLS alerts are close_notify alerts, then the RST packets you
>>>>>       are seeing are probably triggered by the other side doing clean TLS
>>>>>       shutdown (i.e. sending a TLS close_notify alert before closing the
>>>>>       connection), either after receiving a FIN packet (unlikely with
>>>>>       half_closed_clients off?) or while that FIN packet is being
>>>>>       generated or
>>>>>       is in-flight. When Such RST packets would be sent by the TCP stack
>>>>>       rather than Squid code itself. They may be an indication of a benign
>>>>>       race condition, a bug, or some other deficiency.
>>>>>
>>>>>       Higher-level information (who initiates closure and why) may be needed
>>>>>       to figure this out. I recommend sharing a link to a compressed ALL,9
>>>>>       cache.log reproducing the problem with a single transaction _combined_
>>>>>       with a matching packet trace file in libpcap format.
>>>>>
>>>>>       https://wiki.squid-cache.org/SquidFaq/BugReporting#debugging-a-single-transaction <https://wiki.squid-cache.org/SquidFaq/BugReporting#debugging-a-single-transaction>
>>>>>
>>>>>       HTH,
>>>>>
>>>>>       Alex.
>>>>>
>>>>>
>>>>>        > wt., 28 lut 2023 o 08:12 Maciej Leks <maciej.leks at gmail.com
>>>>>       <mailto:maciej.leks at gmail.com>> napisa?(a):
>>>>>        >>
>>>>>        >> For a couple of days we've  been encountering many ECONNRESET error
>>>>>        >> messages in our nodejs client to Salesforce. Even if access.log
>>>>>       shows
>>>>>        >> only /200 tshark shows a messy communication between client->squid
>>>>>        >> (child squid).
>>>>>        >>
>>>>>        >> The architecture: nodejs client->3..* child squid->2*parent
>>>>>        >> squids->cloud Salesforce
>>>>>        >>
>>>>>        >> Some examples ([RST]]: 46 1.015513576 100.121.10.169 ? 100.113.27.73
>>>>>        >> TCP 66 46098 ? 3128 [ACK] Seq=1721 Ack=140135 Win=214656 Len=0
>>>>>        >> TSval=2672547296 TSecr=1443424287
>>>>>        >>
>>>>>        >>     47 1.016152326 100.113.27.73 ? 100.121.10.169 TCP 66 3128 ?
>>>>>       46098
>>>>>        >> [FIN, ACK] Seq=140135 Ack=1721 Win=42368 Len=0 TSval=1443424288
>>>>>        >> TSecr=2672547296
>>>>>        >>     48 1.017856001 100.121.10.169 ? 100.113.27.73 TLSv1.2 97
>>>>>       Encrypted Alert
>>>>>        >>     49 1.017893411 100.121.10.169 ? 100.113.27.73 TCP 66 46098 ?
>>>>>       3128
>>>>>        >> [FIN, ACK] Seq=1752 Ack=140136 Win=214656 Len=0 TSval=2672547298
>>>>>        >> TSecr=1443424288
>>>>>        >>     50 1.018002285 100.113.27.73 ? 100.121.10.169 TCP 54 3128 ?
>>>>>       46098
>>>>>        >> [RST] Seq=140136 Win=0 Len=0
>>>>>        >>     51 1.018019806 100.113.27.73 ? 100.121.10.169 TCP 54 3128 ?
>>>>>       46098
>>>>>        >> [RST] Seq=140136 Win=0 Len=0
>>>>>        >>
>>>>>        >> [RST,ACK]:
>>>>>        >> 592 67.664585034 100.121.10.169 ? 100.113.27.73 TLSv1.2 97
>>>>>       Encrypted Alert
>>>>>        >>    593 67.664737552 100.113.27.73 ? 100.121.10.169 TCP 66 3128 ?
>>>>>       52202
>>>>>        >> [ACK] Seq=7973 Ack=1129 Win=42752 Len=0 TSval=1443490937
>>>>>        >> TSecr=2672613945
>>>>>        >>    594 67.664841613 100.121.10.169 ? 100.113.27.73 TCP 66 52202
>>>>>       ? 3128
>>>>>        >> [FIN, ACK] Seq=1129 Ack=7973 Win=42368 Len=0 TSval=2672613945
>>>>>        >> TSecr=1443490937
>>>>>        >>    595 67.664895660 100.113.27.73 ? 100.121.10.169 TCP 66 3128 ?
>>>>>       52202
>>>>>        >> [RST, ACK] Seq=7973 Ack=1129 Win=42752 Len=0 TSval=1443490937
>>>>>        >> TSecr=2672613945
>>>>>        >>    596 67.664936264 100.113.27.73 ? 100.121.10.169 TCP 54 3128 ?
>>>>>       52202
>>>>>        >> [RST] Seq=7973 Win=0 Len=0
>>>>>        >>
>>>>>        >> I'm wondering how to debug it (what exactly) and whether the reason
>>>>>        >> may be on the squid side (specific configuration?).
>>>>>        >>
>>>>>        >> env: GKE/k8s
>>>>>        >> client container: alpine linux
>>>>>        >> child squid container: alpine linux
>>>>>        >> version: 5.7
>>>>>        >>
>>>>>        >> Cheers,
>>>>>        >> Maciek Leks
>>>>>        > _______________________________________________
>>>>>        > squid-users mailing list
>>>>>        > squid-users at lists.squid-cache.org
>>>>>       <mailto:squid-users at lists.squid-cache.org>
>>>>>        > http://lists.squid-cache.org/listinfo/squid-users
>>>>>       <http://lists.squid-cache.org/listinfo/squid-users>
>>>>>
>>>>>       _______________________________________________
>>>>>       squid-users mailing list
>>>>>       squid-users at lists.squid-cache.org
>>>>>       <mailto:squid-users at lists.squid-cache.org>
>>>>>       http://lists.squid-cache.org/listinfo/squid-users
>>>>>       <http://lists.squid-cache.org/listinfo/squid-users>
>>>>>
>>>>>
>>>>> _______________________________________________
>>>>> squid-users mailing list
>>>>> squid-users at lists.squid-cache.org
>>>>> http://lists.squid-cache.org/listinfo/squid-users
>>>>
>>>> _______________________________________________
>>>> squid-users mailing list
>>>> squid-users at lists.squid-cache.org
>>>> http://lists.squid-cache.org/listinfo/squid-users
>>> _______________________________________________
>>> squid-users mailing list
>>> squid-users at lists.squid-cache.org
>>> http://lists.squid-cache.org/listinfo/squid-users
>>
>> _______________________________________________
>> squid-users mailing list
>> squid-users at lists.squid-cache.org
>> http://lists.squid-cache.org/listinfo/squid-users
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users



From john.rmesi at gmail.com  Tue Mar  7 14:00:43 2023
From: john.rmesi at gmail.com (john jacob)
Date: Tue, 7 Mar 2023 19:30:43 +0530
Subject: [squid-users] acl dst ipv6 does not matches all IPv6 addresses
Message-ID: <CAGMRTB0ynor496Mh-afhs=Mjk8TPGm8rqbcXtB3_BW9+QBNWNg@mail.gmail.com>

Hi,

I am facing the same issue as described in
https://bugs.squid-cache.org/show_bug.cgi?id=5154 where ipv6 literal URLs
are casuing squid, v5.7, to restart. As a work around I am testing the
below to deny ipv6 requests.

acl to_ipv6 dst ipv6
acl from_ipv6 src ipv6

# Prevent ipv6 requests to avoid crash in squid > 5.x
http_access deny to_ipv6
http_access deny from_ipv6

While this works for most of the ipv6 URLs , some of the cases like
http://[FEDC:BA98:7654:3210:FEDC:BA98:7654:3210]:80/index.html
, ACL is not matched.

2023/03/06 20:01:03.049 kid1| 28,3| Checklist.cc(70) preCheck: 0x15c1278
checking slow rules
2023/03/06 20:01:03.049 kid1| 28,5| Acl.cc(124) matches: checking
http_access
2023/03/06 20:01:03.049 kid1| 28,5| Checklist.cc(398) bannedAction: Action
'DENIED/0' is not banned
2023/03/06 20:01:03.050 kid1| 28,5| Acl.cc(124) matches: checking
http_access#1
2023/03/06 20:01:03.050 kid1| 28,5| Acl.cc(124) matches: checking to_ipv6
2023/03/06 20:01:03.050 kid1| 28,9| Ip.cc(96) aclIpAddrNetworkCompare:
aclIpAddrNetworkCompare: compare:
[fedc:ba98:7654:3210:fedc:ba98:7654:3210]/[ffc0::] ([fec0::])  vs
[fe80::]-[::]/[ffc0::]
2023/03/06 20:01:03.050 kid1| 28,3| Ip.cc(538) match: aclIpMatchIp:
'[fedc:ba98:7654:3210:fedc:ba98:7654:3210]' NOT found
2023/03/06 20:01:03.050 kid1| 28,3| Acl.cc(151) matches: checked: to_ipv6 =
0
2023/03/06 20:01:03.050 kid1| 28,3| Acl.cc(151) matches: checked:
http_access#1 = 0
2023/03/06 20:01:03.050 kid1| 28,5| Checklist.cc(398) bannedAction: Action
'DENIED/0' is not banned
2023/03/06 20:01:03.050 kid1| 28,5| Acl.cc(124) matches: checking
http_access#2

I could not find any reference which mentions
FEDC:BA98:7654:3210:FEDC:BA98:7654:3210 as a special type of IPv6. I am
wondering why FEDC:BA98:7654:3210:FEDC:BA98:7654:3210 does not match ipv6
check.

Regards,
John
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230307/e1f895be/attachment.htm>

From squid3 at treenet.co.nz  Wed Mar  8 07:18:04 2023
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Wed, 8 Mar 2023 20:18:04 +1300
Subject: [squid-users] acl dst ipv6 does not matches all IPv6 addresses
In-Reply-To: <CAGMRTB0ynor496Mh-afhs=Mjk8TPGm8rqbcXtB3_BW9+QBNWNg@mail.gmail.com>
References: <CAGMRTB0ynor496Mh-afhs=Mjk8TPGm8rqbcXtB3_BW9+QBNWNg@mail.gmail.com>
Message-ID: <1e4828af-c224-6491-cb72-2f8bb758ac17@treenet.co.nz>

On 8/03/2023 3:00 am, john jacob wrote:
> Hi,
>
> I am facing the same issue as described in 
> https://bugs.squid-cache.org/show_bug.cgi?id=5154 where ipv6 literal 
> URLs are casuing squid, v5.7, to restart. As a work around I am 
> testing the below to deny ipv6 requests.
>
> acl to_ipv6 dst ipv6
> acl from_ipv6 src ipv6
>
...
> I could not find any reference which mentions 
> FEDC:BA98:7654:3210:FEDC:BA98:7654:3210 as a special type of IPv6. I 
> am wondering why FEDC:BA98:7654:3210:FEDC:BA98:7654:3210 does not 
> match ipv6 check.

TL;DR: it is not an IPv6 address.

The "ipv6" magic name is not the same as the ::/0 address range. The 
IPv6 addresses have sections carved out for mapping other IP protocol 
addresses. eg several ways to map IPv4, some ranges for IPv5, and some 
IPv7+ experimental ranges. Most of the F000::/4 addresses fall into that 
experimental future IP versions category.

Thanks for the reminder of this particular carve-out. It is probably 
long overdue removing these F-range exceptions from Squid.
I will get onto that right now.

Meanwhile, the patterns you can set in your ACLs are:

 ? acl to_ipv6 dst ipv6
 ? ? ::1:0:0-::EFFF:0:0/32 ::1:0:0:0/17 \
 ??? F000:/7 FE00::/9 FEC0::/10 \
 ??? FF00::-FFFF:FFFF:FFFF:FFFF:FFFF:FFFF:FFFF:FFFE/128

(note the 'E' on that last long one)

Or you could switch from "block IPv6" to "only allow IPv4", eg:

 ?? acl to_ipv4 dst ipv4
 ?? http_access deny !ipv4



HTH
Amos



From peter at hucker.plus.com  Sat Mar 11 02:19:51 2023
From: peter at hucker.plus.com (Peter Hucker)
Date: Sat, 11 Mar 2023 02:19:51 -0000
Subject: [squid-users] Use squid to disable outdated security certificate
 warning?
Message-ID: <op.11md3dgimk2j66@ryzen.home>

I'm having a problem with BOINC (it's a volunteer distributed computing network).  It uploads and downloads data from the webservers of various projects.  Often these projects have expired certificates, and I can bypass this easily on a browser.  But the Boinc program has no such option.  Somebody mentioned if Boinc accesses the internet through a proxy (and I already have it going through squid to cache data) I can get the proxy to disable this.  Is this possible and how?


From datpwny at outlook.com  Sun Mar 12 17:17:03 2023
From: datpwny at outlook.com (Marcus Boldt)
Date: Sun, 12 Mar 2023 17:17:03 +0000
Subject: [squid-users] limit down- & upload speed for each proxy to 30 Mbit
Message-ID: <AS2PR10MB69254794BA0D55D2973A682A92B89@AS2PR10MB6925.EURPRD10.PROD.OUTLOOK.COM>

Hi everyone,

I currently have Squid 4.13 installed on Debian 11 and have several outgoing IPv4 addresses with authentication.
I would now like to limit the download & upload speed for all proxies to 30 Mbit download & upload speed.
I came across the "pools" and tried different configurations, but unfortunately not one of them works.

My config looks like this:

delay_pools 1
delay_class 1 1
delay_parameters 1 32000/75000
delay_access 1 allow All

or

delay_pools 1
delay_class 1 2
delay_parameters 1 20480/20480 2048/2048
delay_access 1 allow all

I've tried some guides (https://www.howtoforge.com/squid-delay-pools-bandwidth-management) but unfortunately none of them work. However, the required Squid module is activated.

I would be very happy if someone could help me.

kind regards
PWNY
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230312/c8b9a640/attachment.htm>

From squid3 at treenet.co.nz  Sun Mar 12 21:45:40 2023
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Mon, 13 Mar 2023 10:45:40 +1300
Subject: [squid-users] limit down- & upload speed for each proxy to 30
 Mbit
In-Reply-To: <AS2PR10MB69254794BA0D55D2973A682A92B89@AS2PR10MB6925.EURPRD10.PROD.OUTLOOK.COM>
References: <AS2PR10MB69254794BA0D55D2973A682A92B89@AS2PR10MB6925.EURPRD10.PROD.OUTLOOK.COM>
Message-ID: <7446ebb6-f8fd-0971-0bdc-9f8fd1aaab26@treenet.co.nz>

On 13/03/2023 6:17 am, Marcus Boldt wrote:
> Hi everyone,
>
> I currently have Squid 4.13 installed on Debian 11 and have several 
> outgoing IPv4 addresses with authentication.
> I would now like to limit the download & upload speed for all proxies 
> to 30 Mbit download & upload speed.
> I came across the "pools" and tried different configurations, but 
> unfortunately not one of them works.
>

Squid delay pools are for traffic control of specific clients using 
in-band criteria from HTTP itself.

What you appear to be asking for is actually traffic shaping of the 
entire process.
On Linux systems the <https://man7.org/linux/man-pages/man8/tc.8.html> 
tool does that.


Cheers
Amos


From squid3 at treenet.co.nz  Sun Mar 12 21:50:44 2023
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Mon, 13 Mar 2023 10:50:44 +1300
Subject: [squid-users] Use squid to disable outdated security
 certificate warning?
In-Reply-To: <op.11md3dgimk2j66@ryzen.home>
References: <op.11md3dgimk2j66@ryzen.home>
Message-ID: <c82f83a2-a91b-7ef2-1b36-4794ce5c0b24@treenet.co.nz>

On 11/03/2023 3:19 pm, Peter Hucker wrote:
> I'm having a problem with BOINC (it's a volunteer distributed 
> computing network).? It uploads and downloads data from the webservers 
> of various projects.? Often these projects have expired certificates, 
> and I can bypass this easily on a browser.? But the Boinc program has 
> no such option.? Somebody mentioned if Boinc accesses the internet 
> through a proxy (and I already have it going through squid to cache 
> data) I can get the proxy to disable this. Is this possible and how?

The answer depends on what is going on.
Can you share an example of the access.log for some of these BOINC 
transactions?

Amos


From squid3 at treenet.co.nz  Sun Mar 12 22:00:44 2023
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Mon, 13 Mar 2023 11:00:44 +1300
Subject: [squid-users] Understanding maximum outgoing HTTP CONNECT
 requests?
In-Reply-To: <9C815592-A998-4908-842A-A98412D6613F@kontos-home.com>
References: <9C815592-A998-4908-842A-A98412D6613F@kontos-home.com>
Message-ID: <d4c003c4-e4df-07e7-3349-a8ba638e8ad8@treenet.co.nz>

On 5/03/2023 1:42 am, divan.whelk.0u wrote:
>   
> Thank you for the prompt reply!
>
>> - Squid can be configured to receive on up to 64 ports.
>>    Thus dst-port on **inbound** is 2^6.
>> outbound =  N * 2^6 * 2^128 * 2^16 = N * 2^150
> Would that be 2^6 dst-port on outbound, rather than inbound (ignoring Alt-Svc)? Or am misunderstand the theoretical limit formulae after?

Oops. No the 2^6 should be on the inbound formula, and outbound have 
2^16 in that place.
Net effect is the same though one is 2^150 and the other 2^160.


>> Thus total theoretical limit of simultaneous connections Squid can be juggling is  N * 2^151.
> So, for example a single box HTTP CONNECT proxy might be listening on one IPv4 address and one IPv6 address, which would be making the outbound connections (and opening the TCP tunnel) and only able to make outbound connections to either port 80 or 443 (2^16 for each respective port, ignoring Alt-Svc).
>
> Whereas for incoming, listening on dst-port (3128) (2^16 incoming), with a theoretical limit of 2^32 IPv4 addresses or 2^128 IPv6 addresses (or do you use 2^128 including IPv4)?

Ah, yes. I also assumed a typical hybrid or dual stack machine where 
IPv4 is mapped as part of the IPv6 2^128 range.

>
>> Reality can be significantly different for any given installation, but is imposed by configuration choices and thus can be altered as needed.
> Understood, thanks! I think I?ve got a good idea now, with the clarifications.
>
> Alex
>
>> On 17 Feb 2023, at 20:18, Amos Jeffries <squid3 at treenet.co.nz> wrote:
>>
>> On 18/02/2023 12:14 am, divan.whelk.0u wrote:
>>> Hi there!
>>>
>>> I?m trying to understand what would the ?theoretical? maximum amount of outgoing connections with squid setup as a HTTP CONNECT forward proxy would be (hardware permitting)?
>> As you likely know, each TCP/IP connection uses a 4-tuple identifier {src-IP, src-port, dst-IP, dst-port}.
>>
>> So at face value there is a protocol imposed cap of (2^128 * 2^16 * 2^128 * 2^16) = 2^288 connections.
>>
>> Being theoretical we have:
>>      * ignored reserved IP ranges,
>>      * ignored OS-specific ephemeral port reservations,
>>      * assumed IPv6 availability, and
>>      * assumed no access restrictions in Squid, network routing, nor firewall.
>>
>> The factors to consider are:
>>
>>   - Squid machine can be assigned multiple IP's.
>>      Thus src-IP on outbound and dst-IP on inbound are that N.
>>
>>   - Squid can be configured to receive on up to 64 ports.
>>     Thus dst-port on inbound is 2^6.
>>
>>   - DNS can provide any number of IPs for any given server name.
>>      Thus outbound dst-IP can be any 2^128 value.
>>
>>   - modern websites use use Alt-Svc to spread across ports.
>>      Thus outbound dst-port can be any 2^16 value.
>>
>> So for theoretical limit the math is:
>>
>>   inbound =    2^128 * 2^16 * N * 2^16  = N * 2^160
>>
>>   outbound =  N * 2^6 * 2^128 * 2^16 = N * 2^150
>>
>> Inbound and outbound are normally independent, but CONNECT is a special case where they are pinned 1:1.
>>
>> Thus total theoretical limit of simultaneous connections Squid can be juggling is  N * 2^151.
>>
>> Reality can be significantly different for any given installation, but is imposed by configuration choices and thus can be altered as needed.
>>
>>
>>>  From the [squid-users] About bottlenecks (Max number of connections, etc.) thread, I saw mention of the following:
>>>
>>>> * The limit on number of connections any Squid can have attached is only limited by your configured FD limits and available server RAM. Squid uses ~64 KB per network socket for traffic state - which equates to around 2 GB of RAM just for I/O buffers at 20,000 concurrent client connections.
>>> I assume the same would not apply on outgoing connections, and that there would be a limit of 65,536 connections to a single IP, port pair? For example, if we had 1 million users making requests via HTTP CONNECT, only 65K of them would be able to access the same website at any one time?
>> IIRC that quoted thread was discussing a Squid with more normal multiple-destination case hitting FD limits.  The 64K port limitation you refer to is a special case contingent on the "single destination with single IP:port" criteria - which itself is rarely true for a popular website. It assumes configuration restriction imposing that criteria somehow.
>>
>>
>> Cheers
>> Amos
>>
>> _______________________________________________
>> squid-users mailing list
>> squid-users at lists.squid-cache.org
>> http://lists.squid-cache.org/listinfo/squid-users
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users



From gtaylor at tnetconsulting.net  Sun Mar 12 22:18:51 2023
From: gtaylor at tnetconsulting.net (Grant Taylor)
Date: Sun, 12 Mar 2023 16:18:51 -0600
Subject: [squid-users] Use squid to disable outdated security
 certificate warning?
In-Reply-To: <op.11md3dgimk2j66@ryzen.home>
References: <op.11md3dgimk2j66@ryzen.home>
Message-ID: <4004996c-3e4b-5a8c-6eab-a625a4d46872@spamtrap.tnetconsulting.net>

On 3/10/23 7:19 PM, Peter Hucker wrote:
> Somebody mentioned if Boinc accesses the internet through a proxy 
> (and I already have it going through squid to cache data) I can get 
> the proxy to disable this.  Is this possible and how?

As Amos said, it depends.

I would assume that you could use something like Squid's TLS 
intercepting capability to present current certificates from a locally 
trusted root CA to the Boinc client.

I think the biggest hurtle will be getting Squid to accept expired 
certificates from upstream servers and / or expired root certificates 
needed by upstream servers.  Maybe there are some knobs that can be 
twiddled to allow this.

There might be other ways to address this.  This starts to get into 
black hat TLS busting methodology, but for what seems to be a white hat 
reason.



-- 
Grant. . . .
unix || die

-------------- next part --------------
A non-text attachment was scrubbed...
Name: smime.p7s
Type: application/pkcs7-signature
Size: 4017 bytes
Desc: S/MIME Cryptographic Signature
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230312/0b5f4642/attachment.bin>

From 0xff1f at gmail.com  Mon Mar 13 00:11:42 2023
From: 0xff1f at gmail.com (Dr.X)
Date: Sun, 12 Mar 2023 20:11:42 -0400
Subject: [squid-users] limit down- & upload speed for each proxy to 30
 Mbit
In-Reply-To: <7446ebb6-f8fd-0971-0bdc-9f8fd1aaab26@treenet.co.nz>
References: <AS2PR10MB69254794BA0D55D2973A682A92B89@AS2PR10MB6925.EURPRD10.PROD.OUTLOOK.COM>
 <7446ebb6-f8fd-0971-0bdc-9f8fd1aaab26@treenet.co.nz>
Message-ID: <CADJwPw+SoAh92D-sakXyP0ZYwR+raWzk3sDkGydYDtQNjTvrig@mail.gmail.com>

None of squid 4.x has delay pools supported .
Move back to squid 3.x and it should works .

Good luck ?

On Monday, March 13, 2023, Amos Jeffries <squid3 at treenet.co.nz> wrote:

> On 13/03/2023 6:17 am, Marcus Boldt wrote:
>
>> Hi everyone,
>>
>> I currently have Squid 4.13 installed on Debian 11 and have several
>> outgoing IPv4 addresses with authentication.
>> I would now like to limit the download & upload speed for all proxies to
>> 30 Mbit download & upload speed.
>> I came across the "pools" and tried different configurations, but
>> unfortunately not one of them works.
>>
>>
> Squid delay pools are for traffic control of specific clients using
> in-band criteria from HTTP itself.
>
> What you appear to be asking for is actually traffic shaping of the entire
> process.
> On Linux systems the <https://man7.org/linux/man-pages/man8/tc.8.html>
> tool does that.
>
>
> Cheers
> Amos
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230312/24f8a09a/attachment.htm>

From matteo.savatteri at unimi.it  Mon Mar 13 07:55:57 2023
From: matteo.savatteri at unimi.it (Dott. Matteo Savatteri)
Date: Mon, 13 Mar 2023 08:55:57 +0100
Subject: [squid-users] Access based on auth and referer
In-Reply-To: <36caccf1-41d0-c6b7-9a9a-49e04c6a04e6@unimi.it>
References: <3da76a82-5b9a-6b36-fc5e-6d3d3a526e6c@unimi.it>
 <90ec6f50-66b7-7313-6f96-91e130b4fb49@unimi.it>
 <e1e639b4-3079-04b6-e351-ea0ad7d25064@treenet.co.nz>
 <36caccf1-41d0-c6b7-9a9a-49e04c6a04e6@unimi.it>
Message-ID: <15bb2e2b-d689-88b9-e2da-d6f628569890@unimi.it>

Hi Amos, list,

please, can you help me to solve the issue described below?

Or, if not possible at all, to find an alternative solution.

Thank you for your patience and your help.

Cheers,

Matteo

On 3/6/23 09:25, Dott. Matteo Savatteri wrote:
> Hi Amos,
>
> thank you for your answer.
>
> Unfortunately, the config you suggested does not seem to work: using 
> that the proxy ask for password for every sites.
>
> I think this is because CONNECT requests naturally does not present 
> the referer header. The special referer header in only present in 
> subsequent requests, those that get ssl-bumped.
>
> This is an example CONNECT request found in logs:
>
>
> CONNECT pixel.sitescout.com:443 HTTP/1.1
> Host: pixel.sitescout.com:443
> Proxy-Connection: keep-alive
> User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) 
> AppleWebKit/537.36 (KHTML, like Gecko) Chrome/108.0.0.0 Safari/537.36 
> Edg/108.0.1462.76
>
>
> How can I solve this? Is even possible to mix up auth based and 
> referer based access?
>
> Thank you for your patience and your kind help,
>
> Matteo
>
> On 3/6/23 07:34, Amos Jeffries wrote:
>> On 5/03/2023 10:44 pm, Dott. Matteo Savatteri wrote:
>>>
>>> Hello fellow Squid users,
>>>
>>> we use Squid 3.5 at my company and we want to give access to all 
>>> sites to authenticated users. If a user is not authenticated we need 
>>> to allow only HTTP/S requests that present a referer header matching 
>>> a regex. Is this even possible?
>>>
>>> I have tried a combination of proxy_auth and referer_regex ACLs with 
>>> no results. sslbump is working.
>>
>> Try these rules:
>>
>> ? # initial security protection
>> ? http_access deny !Safe_ports
>> ? http_access deny CONNECT !SSL_ports
>>
>> ? # forbid access to cache manager from non-localhost
>> ? http_access deny manager !localhost
>> ? # leave the below commented to require a login for cache manager 
>> access
>> ? # http_access allow manager
>>
>> ? # forbid unauthenticated, except when providing the special Referer 
>> header
>> ? http_access deny !myreferer !password
>>
>> ? # users not denied are allowed
>> ? http_access allow all
>>
>>
>> Cheers
>> Amos
>>
>> _______________________________________________
>> squid-users mailing list
>> squid-users at lists.squid-cache.org
>> http://lists.squid-cache.org/listinfo/squid-users
>
-- 
Dott. Matteo Savatteri

Responsabile Ufficio Piattaforme Tecnologiche
Direzione Servizio Bibliotecario di Ateneo
Universit? degli Studi di Milano

Indirizzo: Via Santa Sofia, 9 20122 MILANO (MI)
Tel. ufficio: 02503 12227
Email: Matteo.Savatteri at unimi.it



From squid3 at treenet.co.nz  Mon Mar 13 10:10:23 2023
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Mon, 13 Mar 2023 23:10:23 +1300
Subject: [squid-users] limit down- & upload speed for each proxy to 30
 Mbit
In-Reply-To: <CADJwPw+SoAh92D-sakXyP0ZYwR+raWzk3sDkGydYDtQNjTvrig@mail.gmail.com>
References: <AS2PR10MB69254794BA0D55D2973A682A92B89@AS2PR10MB6925.EURPRD10.PROD.OUTLOOK.COM>
 <7446ebb6-f8fd-0971-0bdc-9f8fd1aaab26@treenet.co.nz>
 <CADJwPw+SoAh92D-sakXyP0ZYwR+raWzk3sDkGydYDtQNjTvrig@mail.gmail.com>
Message-ID: <10755d8e-2db7-b76b-f4d2-e5c7acdab5d0@treenet.co.nz>

On 13/03/2023 1:11 pm, Dr.X wrote:
> None of squid 4.x has delay pools supported .

This is not true unless you built your Squid with pools disabled.

YMMV due to some types of traffic not being able to pool.

Amos



From 0xff1f at gmail.com  Mon Mar 13 10:24:43 2023
From: 0xff1f at gmail.com (Dr.X)
Date: Mon, 13 Mar 2023 10:24:43 +0000
Subject: [squid-users] limit down- & upload speed for each proxy to 30
 Mbit
In-Reply-To: <10755d8e-2db7-b76b-f4d2-e5c7acdab5d0@treenet.co.nz>
References: <AS2PR10MB69254794BA0D55D2973A682A92B89@AS2PR10MB6925.EURPRD10.PROD.OUTLOOK.COM>
 <7446ebb6-f8fd-0971-0bdc-9f8fd1aaab26@treenet.co.nz>
 <CADJwPw+SoAh92D-sakXyP0ZYwR+raWzk3sDkGydYDtQNjTvrig@mail.gmail.com>
 <10755d8e-2db7-b76b-f4d2-e5c7acdab5d0@treenet.co.nz>
Message-ID: <DBBPR09MB45235C26CF89E81C683F2035F7B99@DBBPR09MB4523.eurprd09.prod.outlook.com>

Hi Amos ,

Alex already confirmed this bug with me, which still needs to be solved with all squid4.x versions.

Squid 4.x has a bug that accepts the config, but the config has no meaning.

Please, if you have any running squid 4.x that support delay pools, let me know the version ?.  I will be thankful.

Best.




From: squid-users <squid-users-bounces at lists.squid-cache.org> on behalf of Amos Jeffries <squid3 at treenet.co.nz>
Date: Monday, 13 March 2023 13:10
To:
Cc: squid-users at lists.squid-cache.org <squid-users at lists.squid-cache.org>
Subject: Re: [squid-users] limit down- & upload speed for each proxy to 30 Mbit
On 13/03/2023 1:11 pm, Dr.X wrote:
> None of squid 4.x has delay pools supported .

This is not true unless you built your Squid with pools disabled.

YMMV due to some types of traffic not being able to pool.

Amos

_______________________________________________
squid-users mailing list
squid-users at lists.squid-cache.org
http://lists.squid-cache.org/listinfo/squid-users
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230313/889f47f1/attachment.htm>

From squid3 at treenet.co.nz  Mon Mar 13 12:10:35 2023
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Tue, 14 Mar 2023 01:10:35 +1300
Subject: [squid-users] limit down- & upload speed for each proxy to 30
 Mbit
In-Reply-To: <DBBPR09MB45235C26CF89E81C683F2035F7B99@DBBPR09MB4523.eurprd09.prod.outlook.com>
References: <AS2PR10MB69254794BA0D55D2973A682A92B89@AS2PR10MB6925.EURPRD10.PROD.OUTLOOK.COM>
 <7446ebb6-f8fd-0971-0bdc-9f8fd1aaab26@treenet.co.nz>
 <CADJwPw+SoAh92D-sakXyP0ZYwR+raWzk3sDkGydYDtQNjTvrig@mail.gmail.com>
 <10755d8e-2db7-b76b-f4d2-e5c7acdab5d0@treenet.co.nz>
 <DBBPR09MB45235C26CF89E81C683F2035F7B99@DBBPR09MB4523.eurprd09.prod.outlook.com>
Message-ID: <c79f8695-1121-1ceb-538b-098b9bbcb895@treenet.co.nz>

On 13/03/2023 11:24 pm, Dr.X wrote:
>
> Hi Amos ,
>
> Alex already confirmed this bug with me, which still needs to be 
> solved with all squid4.x versions.
>
> Squid 4.x has a bug that accepts the config, but the config has no 
> meaning.
>

Which bug are you talking about?


Amos



From gameplayer2019pl at tutamail.com  Tue Mar 14 13:21:17 2023
From: gameplayer2019pl at tutamail.com (Jakub Graczykowski)
Date: Tue, 14 Mar 2023 14:21:17 +0100 (CET)
Subject: [squid-users] Problems while connecting through Firefox.
Message-ID: <NQVGrVS--7-9@tutamail.com>

Good afternoon,

I have a problem with Squid HTTPS proxy. I'm getting an error Error code: SEC_ERROR_INADEQUATE_KEY_USAGE in Firefox.

What should I do to fix it?
Squid configuration file & cache.log in the attachments.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230314/a21b0d61/attachment.htm>
-------------- next part --------------
http_port 3127 ssl-bump \
   generate-host-certificates=on \
   cert=/server/squid/conf/squid.crt \
   key=/server/squid/conf/squid.key \
   dynamic_cert_mem_cache_size=16MB
#http_port 3127 intercept ssl-bump \
#   generate-host-certificates=on \
#   cert=/server/squid/conf/squid.crt \
#   key=/server/squid/conf/squid.key \
#   dynamic_cert_mem_cache_size=16MB

ssl_bump bump all
#ssl_bump splice all

refresh_pattern ^ftp:		1440	20%	10080
refresh_pattern ^gopher:	1440	0%	1440
refresh_pattern -i (/cgi-bin/|\?) 0	0%	0
refresh_pattern .		0	20%	4320

acl localnet src 192.168.0.0/24
acl localnet src 192.168.6.0/24
acl localnet src 192.168.3.0/24
acl localnet src 127.0.0.0/8

acl SSL_ports port 443         # https

acl Safe_ports port 80          # http
acl Safe_ports port 21          # ftp
acl Safe_ports port 443         # https
acl Safe_ports port 70          # gopher
acl Safe_ports port 210         # wais
acl Safe_ports port 1025-65535  # unregistered ports
acl Safe_ports port 280         # http-mgmt
acl Safe_ports port 488         # gss-http
acl Safe_ports port 591         # filemaker
acl Safe_ports port 777         # multiling http
acl Safe_ports port 8080        # http proxy
acl Safe_ports port 3127

forwarded_for off

http_access deny CONNECT !SSL_ports
http_access deny !localnet
dns_nameservers 192.168.2.9
httpd_suppress_version_string on
shutdown_lifetime 30 seconds
cache_mem 1024 MB

cache_dir aufs /server/squid/app/var/cache/squid 1024 16 256

maximum_object_size 10 MB
read_ahead_gap 64 KB

error_directory /server/squid/conf/pages/

coredump_dir /server/squid/app/var/coredump

acl QUERY urlpath_regex cgi-bin \? asp aspx jsp
cache deny QUERY

access_log none

pid_filename /server/squid/conf/squid.pid
-------------- next part --------------
2023/03/14 13:57:05| storeDirWriteCleanLogs: Starting...
2023/03/14 13:57:05|   Finished.  Wrote 0 entries.
2023/03/14 13:57:05|   Took 0.00 seconds (  0.00 entries/sec).
CPU Usage: 2.162 seconds = 2.101 user + 0.061 sys
Maximum Resident Size: 117040 KB
Page faults with physical i/o: 0
2023/03/14 13:57:05| Open FD UNSTARTED     0 stdin
2023/03/14 13:57:05| Open FD UNSTARTED     1 stdout
2023/03/14 13:57:05| Open FD UNSTARTED     2 stderr
2023/03/14 13:57:05| Open FD READ/WRITE   12 security_file_certgen #1
2023/03/14 13:57:05| Open FD READ/WRITE   14 security_file_certgen #2
2023/03/14 13:57:05| Open FD UNSTARTED    16 security_file_certgen #3
2023/03/14 13:57:05| Open FD UNSTARTED    18 security_file_certgen #4
2023/03/14 13:57:05| Open FD UNSTARTED    20 security_file_certgen #5
2023/03/14 13:57:05| Squid Cache (Version 7.0.0-VCS): Exiting normally.
2023/03/14 13:57:05| Removing PID file (/server/squid/conf/squid.pid)
2023/03/14 13:57:32| Processing Configuration File: /server/squid/conf/squid.conf (depth 0)
2023/03/14 13:57:32| Created PID file (/server/squid/conf/squid.pid)
2023/03/14 13:57:32| Set Current Directory to /server/squid/app/var/coredump
2023/03/14 13:57:32| Starting Squid Cache version 7.0.0-VCS for x86_64-pc-linux-gnu...
2023/03/14 13:57:32| Service Name: squid
2023/03/14 13:57:32| Process ID 8021
2023/03/14 13:57:32| Process Roles: master worker
2023/03/14 13:57:32| With 1024 file descriptors available
2023/03/14 13:57:32| Initializing IP Cache...
2023/03/14 13:57:32| DNS IPv6 socket created at [::], FD 10
2023/03/14 13:57:32| DNS IPv4 socket created at 0.0.0.0, FD 11
2023/03/14 13:57:32| Adding nameserver 192.168.2.9 from squid.conf
2023/03/14 13:57:32| helperOpenServers: Starting 5/32 'security_file_certgen' processes
2023/03/14 13:57:32| WARNING: no_suid: setuid(0): (1) Operation not permitted
2023/03/14 13:57:32| WARNING: no_suid: setuid(0): (1) Operation not permitted
2023/03/14 13:57:32| WARNING: no_suid: setuid(0): (1) Operation not permitted
2023/03/14 13:57:32| WARNING: no_suid: setuid(0): (1) Operation not permitted
2023/03/14 13:57:32| WARNING: no_suid: setuid(0): (1) Operation not permitted
2023/03/14 13:57:32| Local cache digest enabled; rebuild/rewrite every 3600/3600 sec
2023/03/14 13:57:32| Store logging disabled
2023/03/14 13:57:32| Swap maxSize 1048576 + 1048576 KB, estimated 161319 objects
2023/03/14 13:57:32| Target number of buckets: 8065
2023/03/14 13:57:32| Using 8192 Store buckets
2023/03/14 13:57:32| Max Mem  size: 1048576 KB
2023/03/14 13:57:32| Max Swap size: 1048576 KB
2023/03/14 13:57:32| Rebuilding storage in /server/squid/app/var/cache/squid (clean log)
2023/03/14 13:57:32| Using Least Load store dir selection
2023/03/14 13:57:32| Set Current Directory to /server/squid/app/var/coredump
2023/03/14 13:57:32| Finished loading MIME types and icons.
2023/03/14 13:57:32| HTCP Disabled.
2023/03/14 13:57:32| Squid plugin modules loaded: 0
2023/03/14 13:57:32| Adaptation support is off.
2023/03/14 13:57:32| Accepting SSL bumped HTTP Socket connections at conn13 local=[::]:3127 remote=[::] FD 24 flags=9
    listening port: 3127
2023/03/14 13:57:32| Done reading /server/squid/app/var/cache/squid swaplog (0 entries)
2023/03/14 13:57:32| Indexing cache entries: 0.00% (0 out of 1)
2023/03/14 13:57:32| Finished rebuilding storage from disk.
          0 Entries scanned
          0 Invalid entries
          0 With invalid flags
          0 Objects loaded
          0 Objects expired
          0 Objects canceled
          0 Duplicate URLs purged
          0 Swapfile clashes avoided
    Took 0.02 seconds (0.00 objects/sec).
2023/03/14 13:57:32| Beginning Validation Procedure
2023/03/14 13:57:32| Completed Validation Procedure
    Validated 0 Entries
    store_swap_size = 0.00 KB
2023/03/14 13:57:33| storeLateRelease: released 0 objects
2023/03/14 13:57:35| ERROR: failure while accepting a TLS connection on conn15 local=192.168.6.1:3127 remote=192.168.6.2:57116 FD 15 flags=1: SQUID_TLS_ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
    current master transaction: master54
2023/03/14 13:57:41| ERROR: failure while accepting a TLS connection on conn16 local=192.168.6.1:3127 remote=192.168.6.2:57122 FD 15 flags=1: SQUID_TLS_ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
    current master transaction: master54
2023/03/14 13:57:41| ERROR: failure while accepting a TLS connection on conn17 local=192.168.6.1:3127 remote=192.168.6.2:57138 FD 15 flags=1: SQUID_TLS_ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
    current master transaction: master54
2023/03/14 13:57:43| ERROR: failure while accepting a TLS connection on conn18 local=192.168.3.1:3127 remote=192.168.3.3:53546 FD 15 flags=1: SQUID_TLS_ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
    current master transaction: master60
2023/03/14 13:57:43| ERROR: failure while accepting a TLS connection on conn19 local=192.168.3.1:3127 remote=192.168.3.3:53548 FD 17 flags=1: SQUID_TLS_ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
    current master transaction: master62
2023/03/14 13:58:27| ERROR: failure while accepting a TLS connection on conn20 local=192.168.6.1:3127 remote=192.168.6.2:38018 FD 15 flags=1: SQUID_TLS_ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
    current master transaction: master54
2023/03/14 13:58:28| ERROR: failure while accepting a TLS connection on conn21 local=192.168.6.1:3127 remote=192.168.6.2:38034 FD 15 flags=1: SQUID_TLS_ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
    current master transaction: master54
2023/03/14 13:58:28| ERROR: failure while accepting a TLS connection on conn22 local=192.168.6.1:3127 remote=192.168.6.2:38038 FD 17 flags=1: SQUID_TLS_ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
    current master transaction: master54
2023/03/14 13:58:28| ERROR: failure while accepting a TLS connection on conn23 local=192.168.6.1:3127 remote=192.168.6.2:38050 FD 15 flags=1: SQUID_TLS_ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
    current master transaction: master54
2023/03/14 13:58:28| ERROR: failure while accepting a TLS connection on conn24 local=192.168.6.1:3127 remote=192.168.6.2:38052 FD 15 flags=1: SQUID_TLS_ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
    current master transaction: master54
2023/03/14 13:58:28| ERROR: failure while accepting a TLS connection on conn25 local=192.168.6.1:3127 remote=192.168.6.2:38066 FD 15 flags=1: SQUID_TLS_ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
    current master transaction: master74
2023/03/14 13:58:28| ERROR: failure while accepting a TLS connection on conn26 local=192.168.6.1:3127 remote=192.168.6.2:38080 FD 17 flags=1: SQUID_TLS_ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
    current master transaction: master76
2023/03/14 13:58:29| ERROR: failure while accepting a TLS connection on conn27 local=192.168.6.1:3127 remote=192.168.6.2:38090 FD 15 flags=1: SQUID_TLS_ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
    current master transaction: master54
2023/03/14 13:58:32| ERROR: failure while accepting a TLS connection on conn28 local=192.168.6.1:3127 remote=192.168.6.2:48670 FD 15 flags=1: SQUID_TLS_ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
    current master transaction: master80
2023/03/14 13:58:36| ERROR: failure while accepting a TLS connection on conn29 local=192.168.6.1:3127 remote=192.168.6.2:48672 FD 15 flags=1: SQUID_TLS_ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
    current master transaction: master82
2023/03/14 13:58:36| ERROR: failure while accepting a TLS connection on conn30 local=192.168.6.1:3127 remote=192.168.6.2:48674 FD 17 flags=1: SQUID_TLS_ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
    current master transaction: master84
2023/03/14 13:58:39| ERROR: failure while accepting a TLS connection on conn31 local=192.168.6.1:3127 remote=192.168.6.2:48690 FD 15 flags=1: SQUID_TLS_ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
    current master transaction: master86
2023/03/14 13:58:40| ERROR: failure while accepting a TLS connection on conn32 local=192.168.6.1:3127 remote=192.168.6.2:48706 FD 15 flags=1: SQUID_TLS_ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
    current master transaction: master54
2023/03/14 13:58:42| ERROR: failure while accepting a TLS connection on conn33 local=192.168.6.1:3127 remote=192.168.6.2:43416 FD 15 flags=1: SQUID_TLS_ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
    current master transaction: master90
2023/03/14 13:58:43| ERROR: failure while accepting a TLS connection on conn34 local=192.168.3.1:3127 remote=192.168.3.3:41086 FD 15 flags=1: SQUID_TLS_ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
    current master transaction: master92
2023/03/14 13:58:43| ERROR: failure while accepting a TLS connection on conn35 local=192.168.3.1:3127 remote=192.168.3.3:41094 FD 17 flags=1: SQUID_TLS_ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
    current master transaction: master94
2023/03/14 13:58:49| ERROR: failure while accepting a TLS connection on conn36 local=192.168.6.1:3127 remote=192.168.6.2:43420 FD 15 flags=1: SQUID_TLS_ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
    current master transaction: master96
2023/03/14 13:59:02| ERROR: failure while accepting a TLS connection on conn37 local=192.168.6.1:3127 remote=192.168.6.2:43896 FD 15 flags=1: SQUID_TLS_ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
    current master transaction: master98
2023/03/14 13:59:10| ERROR: failure while accepting a TLS connection on conn38 local=192.168.6.1:3127 remote=192.168.6.2:43912 FD 15 flags=1: SQUID_TLS_ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
    current master transaction: master100
2023/03/14 13:59:36| ERROR: failure while accepting a TLS connection on conn39 local=192.168.6.1:3127 remote=192.168.6.2:54888 FD 15 flags=1: SQUID_TLS_ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
    current master transaction: master102
2023/03/14 13:59:36| ERROR: failure while accepting a TLS connection on conn40 local=192.168.6.1:3127 remote=192.168.6.2:54896 FD 17 flags=1: SQUID_TLS_ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
    current master transaction: master104
2023/03/14 13:59:40| ERROR: failure while accepting a TLS connection on conn41 local=192.168.6.1:3127 remote=192.168.6.2:54898 FD 15 flags=1: SQUID_TLS_ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
    current master transaction: master106
2023/03/14 13:59:42| ERROR: failure while accepting a TLS connection on conn42 local=192.168.6.1:3127 remote=192.168.6.2:48774 FD 15 flags=1: SQUID_TLS_ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
    current master transaction: master108
2023/03/14 13:59:43| ERROR: failure while accepting a TLS connection on conn43 local=192.168.3.1:3127 remote=192.168.3.3:42222 FD 15 flags=1: SQUID_TLS_ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
    current master transaction: master110
2023/03/14 13:59:43| ERROR: failure while accepting a TLS connection on conn44 local=192.168.3.1:3127 remote=192.168.3.3:42234 FD 17 flags=1: SQUID_TLS_ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
    current master transaction: master112
2023/03/14 14:00:10| ERROR: failure while accepting a TLS connection on conn45 local=192.168.6.1:3127 remote=192.168.6.2:38710 FD 15 flags=1: SQUID_TLS_ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
    current master transaction: master114
2023/03/14 14:00:36| ERROR: failure while accepting a TLS connection on conn46 local=192.168.6.1:3127 remote=192.168.6.2:51996 FD 15 flags=1: SQUID_TLS_ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
    current master transaction: master116
2023/03/14 14:00:36| ERROR: failure while accepting a TLS connection on conn47 local=192.168.6.1:3127 remote=192.168.6.2:52006 FD 17 flags=1: SQUID_TLS_ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
    current master transaction: master118
2023/03/14 14:00:43| ERROR: failure while accepting a TLS connection on conn48 local=192.168.3.1:3127 remote=192.168.3.3:37424 FD 15 flags=1: SQUID_TLS_ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
    current master transaction: master120
2023/03/14 14:00:43| ERROR: failure while accepting a TLS connection on conn49 local=192.168.3.1:3127 remote=192.168.3.3:37438 FD 17 flags=1: SQUID_TLS_ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
    current master transaction: master122
2023/03/14 14:01:02| ERROR: failure while accepting a TLS connection on conn50 local=192.168.6.1:3127 remote=192.168.6.2:53956 FD 15 flags=1: SQUID_TLS_ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
    current master transaction: master124
2023/03/14 14:01:24| ERROR: failure while accepting a TLS connection on conn51 local=192.168.6.1:3127 remote=192.168.6.2:51130 FD 15 flags=1: SQUID_TLS_ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
    current master transaction: master54
2023/03/14 14:01:34| ERROR: failure while accepting a TLS connection on conn64 local=192.168.6.1:3127 remote=192.168.6.2:55266 FD 22 flags=1: SQUID_TLS_ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
    current master transaction: master131
2023/03/14 14:01:36| ERROR: failure while accepting a TLS connection on conn65 local=192.168.6.1:3127 remote=192.168.6.2:55278 FD 22 flags=1: SQUID_TLS_ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
    current master transaction: master133
2023/03/14 14:01:36| ERROR: failure while accepting a TLS connection on conn66 local=192.168.6.1:3127 remote=192.168.6.2:55282 FD 23 flags=1: SQUID_TLS_ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
    current master transaction: master135
2023/03/14 14:01:44| ERROR: failure while accepting a TLS connection on conn67 local=192.168.3.1:3127 remote=192.168.3.3:43602 FD 22 flags=1: SQUID_TLS_ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
    current master transaction: master137
2023/03/14 14:01:44| ERROR: failure while accepting a TLS connection on conn68 local=192.168.3.1:3127 remote=192.168.3.3:43612 FD 23 flags=1: SQUID_TLS_ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
    current master transaction: master139
2023/03/14 14:02:36| ERROR: failure while accepting a TLS connection on conn75 local=192.168.6.1:3127 remote=192.168.6.2:35958 FD 17 flags=1: SQUID_TLS_ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
    current master transaction: master153
2023/03/14 14:02:36| ERROR: failure while accepting a TLS connection on conn76 local=192.168.6.1:3127 remote=192.168.6.2:35970 FD 22 flags=1: SQUID_TLS_ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
    current master transaction: master155
2023/03/14 14:02:41| ERROR: failure while accepting a TLS connection on conn77 local=192.168.6.1:3127 remote=192.168.6.2:60960 FD 17 flags=1: SQUID_TLS_ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
    current master transaction: master54
2023/03/14 14:02:43| ERROR: failure while accepting a TLS connection on conn78 local=192.168.6.1:3127 remote=192.168.6.2:60962 FD 17 flags=1: SQUID_TLS_ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
    current master transaction: master159
2023/03/14 14:02:44| ERROR: failure while accepting a TLS connection on conn81 local=192.168.6.1:3127 remote=192.168.6.2:60976 FD 23 flags=1: SQUID_TLS_ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
    current master transaction: master165
2023/03/14 14:02:44| ERROR: failure while accepting a TLS connection on conn79 local=192.168.3.1:3127 remote=192.168.3.3:40642 FD 17 flags=1: SQUID_TLS_ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
    current master transaction: master161
2023/03/14 14:02:44| ERROR: failure while accepting a TLS connection on conn80 local=192.168.3.1:3127 remote=192.168.3.3:40652 FD 22 flags=1: SQUID_TLS_ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
    current master transaction: master163
2023/03/14 14:03:37| ERROR: failure while accepting a TLS connection on conn82 local=192.168.6.1:3127 remote=192.168.6.2:33646 FD 15 flags=1: SQUID_TLS_ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
    current master transaction: master167
2023/03/14 14:03:37| ERROR: failure while accepting a TLS connection on conn83 local=192.168.6.1:3127 remote=192.168.6.2:33650 FD 17 flags=1: SQUID_TLS_ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
    current master transaction: master169
2023/03/14 14:03:42| ERROR: failure while accepting a TLS connection on conn84 local=192.168.6.1:3127 remote=192.168.6.2:49452 FD 15 flags=1: SQUID_TLS_ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
    current master transaction: master171
2023/03/14 14:03:44| ERROR: failure while accepting a TLS connection on conn85 local=192.168.3.1:3127 remote=192.168.3.3:40678 FD 15 flags=1: SQUID_TLS_ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
    current master transaction: master173
2023/03/14 14:03:44| ERROR: failure while accepting a TLS connection on conn86 local=192.168.3.1:3127 remote=192.168.3.3:40692 FD 17 flags=1: SQUID_TLS_ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
    current master transaction: master175
2023/03/14 14:04:37| ERROR: failure while accepting a TLS connection on conn87 local=192.168.6.1:3127 remote=192.168.6.2:34004 FD 15 flags=1: SQUID_TLS_ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
    current master transaction: master177
2023/03/14 14:04:37| ERROR: failure while accepting a TLS connection on conn88 local=192.168.6.1:3127 remote=192.168.6.2:34018 FD 17 flags=1: SQUID_TLS_ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
    current master transaction: master179
2023/03/14 14:04:44| ERROR: failure while accepting a TLS connection on conn89 local=192.168.3.1:3127 remote=192.168.3.3:45516 FD 15 flags=1: SQUID_TLS_ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
    current master transaction: master181
2023/03/14 14:04:44| ERROR: failure while accepting a TLS connection on conn90 local=192.168.3.1:3127 remote=192.168.3.3:45518 FD 17 flags=1: SQUID_TLS_ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
    current master transaction: master183
2023/03/14 14:05:37| ERROR: failure while accepting a TLS connection on conn91 local=192.168.6.1:3127 remote=192.168.6.2:45780 FD 15 flags=1: SQUID_TLS_ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
    current master transaction: master185
2023/03/14 14:05:37| ERROR: failure while accepting a TLS connection on conn92 local=192.168.6.1:3127 remote=192.168.6.2:45796 FD 17 flags=1: SQUID_TLS_ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
    current master transaction: master187
2023/03/14 14:05:45| ERROR: failure while accepting a TLS connection on conn93 local=192.168.3.1:3127 remote=192.168.3.3:37490 FD 15 flags=1: SQUID_TLS_ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
    current master transaction: master189
2023/03/14 14:05:45| ERROR: failure while accepting a TLS connection on conn94 local=192.168.3.1:3127 remote=192.168.3.3:37504 FD 17 flags=1: SQUID_TLS_ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
    current master transaction: master191
2023/03/14 14:05:46| ERROR: failure while accepting a TLS connection on conn95 local=192.168.3.1:3127 remote=192.168.3.3:37518 FD 15 flags=1: SQUID_TLS_ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
    current master transaction: master193
2023/03/14 14:05:46| ERROR: failure while accepting a TLS connection on conn96 local=192.168.3.1:3127 remote=192.168.3.3:37520 FD 17 flags=1: SQUID_TLS_ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
    current master transaction: master195
2023/03/14 14:05:46| ERROR: failure while accepting a TLS connection on conn97 local=192.168.3.1:3127 remote=192.168.3.3:37530 FD 15 flags=1: SQUID_TLS_ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
    current master transaction: master197
2023/03/14 14:05:46| ERROR: failure while accepting a TLS connection on conn98 local=192.168.3.1:3127 remote=192.168.3.3:37542 FD 17 flags=1: SQUID_TLS_ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
    current master transaction: master199
2023/03/14 14:05:52| ERROR: failure while accepting a TLS connection on conn99 local=192.168.3.1:3127 remote=192.168.3.3:37550 FD 15 flags=1: SQUID_TLS_ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
    current master transaction: master201
2023/03/14 14:06:37| ERROR: failure while accepting a TLS connection on conn100 local=192.168.6.1:3127 remote=192.168.6.2:48690 FD 15 flags=1: SQUID_TLS_ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
    current master transaction: master203
2023/03/14 14:06:37| ERROR: failure while accepting a TLS connection on conn101 local=192.168.6.1:3127 remote=192.168.6.2:48704 FD 17 flags=1: SQUID_TLS_ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
    current master transaction: master205
2023/03/14 14:06:50| ERROR: failure while accepting a TLS connection on conn102 local=192.168.6.1:3127 remote=192.168.6.2:49994 FD 15 flags=1: SQUID_TLS_ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
    current master transaction: master207
2023/03/14 14:06:50| ERROR: failure while accepting a TLS connection on conn103 local=192.168.6.1:3127 remote=192.168.6.2:50006 FD 17 flags=1: SQUID_TLS_ERR_ACCEPT+TLS_LIB_ERR=A000416+TLS_IO_ERR=1
    current master transaction: master209
2023/03/14 14:10:54| Preparing for shutdown after 79 requests
2023/03/14 14:10:54| Waiting 0 seconds for active connections to finish
2023/03/14 14:10:54| Closing HTTP(S) port [::]:3127
    listening port: 3127
2023/03/14 14:10:55| Shutdown: Negotiate authentication.
2023/03/14 14:10:55| Shutdown: Digest authentication.
2023/03/14 14:10:55| Shutdown: Basic authentication.
2023/03/14 14:10:55| Shutting down...
2023/03/14 14:10:55| storeDirWriteCleanLogs: Starting...
2023/03/14 14:10:55|   Finished.  Wrote 2 entries.
2023/03/14 14:10:55|   Took 0.00 seconds (5602.24 entries/sec).
CPU Usage: 1.797 seconds = 1.742 user + 0.055 sys
Maximum Resident Size: 117104 KB
Page faults with physical i/o: 1
2023/03/14 14:10:55| Open FD UNSTARTED     0 stdin
2023/03/14 14:10:55| Open FD UNSTARTED     1 stdout
2023/03/14 14:10:55| Open FD UNSTARTED     2 stderr
2023/03/14 14:10:55| Open FD READ/WRITE   12 security_file_certgen #1
2023/03/14 14:10:55| Open FD UNSTARTED    14 security_file_certgen #2
2023/03/14 14:10:55| Open FD UNSTARTED    16 security_file_certgen #3
2023/03/14 14:10:55| Open FD UNSTARTED    18 security_file_certgen #4
2023/03/14 14:10:55| Open FD UNSTARTED    20 security_file_certgen #5
2023/03/14 14:10:55| Squid Cache (Version 7.0.0-VCS): Exiting normally.
2023/03/14 14:10:55| Removing PID file (/server/squid/conf/squid.pid)

From pheriko.support at gmail.com  Mon Mar 20 17:38:02 2023
From: pheriko.support at gmail.com (Periko Support)
Date: Mon, 20 Mar 2023 10:38:02 -0700
Subject: [squid-users] FreeBSD 12 thousands connections
Message-ID: <CAK2yrTYKKmwbwgBsAsWep=XwY-SSH4eO-WZwV=Qe6f2KBeAdXw@mail.gmail.com>

Hello guys.

I 'm going to run a squid-proxy for around 3000 users simultaneously.

The server is a Supermicro Intel 8 cores with 64GB RAM, SSD disk, I
will not enable caching.

The switches are 1GB HP.

Any recommendations for this deployment that could help tuning my
FreeBSD 12.3 box to take into consideration?

Thanks all for your time!!!


From luciano at vespaperitivo.it  Mon Mar 20 18:01:41 2023
From: luciano at vespaperitivo.it (Luciano Mannucci)
Date: Mon, 20 Mar 2023 19:01:41 +0100
Subject: [squid-users] FreeBSD 12 thousands connections
In-Reply-To: <CAK2yrTYKKmwbwgBsAsWep=XwY-SSH4eO-WZwV=Qe6f2KBeAdXw@mail.gmail.com>
References: <CAK2yrTYKKmwbwgBsAsWep=XwY-SSH4eO-WZwV=Qe6f2KBeAdXw@mail.gmail.com>
Message-ID: <4PgMxf43fyzZ5R@baobab.bilink.it>

On Mon, 20 Mar 2023 10:38:02 -0700
Periko Support <pheriko.support at gmail.com> wrote:

> Any recommendations for this deployment that could help tuning my
> FreeBSD 12.3 box to take into consideration?
Well, 12.3 is EOL.
You should consider upgrading at least to 12.4...

Luciano.
-- 
 /"\                         /Via A. Salaino, 7 - 20144 Milano (Italy)
 \ /  ASCII RIBBON CAMPAIGN / PHONE : +39 02485781 FAX: +39 0248028247
  X   AGAINST HTML MAIL    /  E-MAIL: posthamster at sublink.sublink.ORG
 / \  AND POSTINGS        /   WWW: http://www.lesassaie.IT/


From JOfficer at istreamfs.com  Mon Mar 20 18:08:35 2023
From: JOfficer at istreamfs.com (Joey Officer)
Date: Mon, 20 Mar 2023 18:08:35 +0000
Subject: [squid-users] [EXTERNAL] FreeBSD 12 thousands connections
In-Reply-To: <CAK2yrTYKKmwbwgBsAsWep=XwY-SSH4eO-WZwV=Qe6f2KBeAdXw@mail.gmail.com>
References: <CAK2yrTYKKmwbwgBsAsWep=XwY-SSH4eO-WZwV=Qe6f2KBeAdXw@mail.gmail.com>
Message-ID: <CH2PR19MB34964943F07627283CE0CBC3CD809@CH2PR19MB3496.namprd19.prod.outlook.com>

Will the users require authentication?  Depending on what authentication is active, you'd probably want to increase the minimum amount of auth helpers to satisfy the requests.

That said, you really haven't given enough information about your specific use.

-----Original Message-----
From: squid-users <squid-users-bounces at lists.squid-cache.org> On Behalf Of Periko Support
Sent: Monday, March 20, 2023 12:38 PM
To: squid-users at lists.squid-cache.org
Subject: [EXTERNAL][squid-users] FreeBSD 12 thousands connections

CAUTION: This email originated from outside of the organization. Do not click links or open attachments unless you recognize the sender and know the content is safe.

Hello guys.

I 'm going to run a squid-proxy for around 3000 users simultaneously.

The server is a Supermicro Intel 8 cores with 64GB RAM, SSD disk, I will not enable caching.

The switches are 1GB HP.

Any recommendations for this deployment that could help tuning my FreeBSD 12.3 box to take into consideration?

Thanks all for your time!!!
_______________________________________________
squid-users mailing list
squid-users at lists.squid-cache.org
http://lists.squid-cache.org/listinfo/squid-users


From pheriko.support at gmail.com  Mon Mar 20 18:11:51 2023
From: pheriko.support at gmail.com (Periko Support)
Date: Mon, 20 Mar 2023 11:11:51 -0700
Subject: [squid-users] FreeBSD 12 thousands connections
In-Reply-To: <4PgMxf43fyzZ5R@baobab.bilink.it>
References: <CAK2yrTYKKmwbwgBsAsWep=XwY-SSH4eO-WZwV=Qe6f2KBeAdXw@mail.gmail.com>
 <4PgMxf43fyzZ5R@baobab.bilink.it>
Message-ID: <CAK2yrTY3T-ruC+_FZGPOhAxG2M_0NS9SHgfbW0ZY5QRK5ZHBmg@mail.gmail.com>

Yes, the latest FreeBSD 12.x.

On Mon, Mar 20, 2023 at 11:02?AM Luciano Mannucci
<luciano at vespaperitivo.it> wrote:
>
> On Mon, 20 Mar 2023 10:38:02 -0700
> Periko Support <pheriko.support at gmail.com> wrote:
>
> > Any recommendations for this deployment that could help tuning my
> > FreeBSD 12.3 box to take into consideration?
> Well, 12.3 is EOL.
> You should consider upgrading at least to 12.4...
>
> Luciano.
> --
>  /"\                         /Via A. Salaino, 7 - 20144 Milano (Italy)
>  \ /  ASCII RIBBON CAMPAIGN / PHONE : +39 02485781 FAX: +39 0248028247
>   X   AGAINST HTML MAIL    /  E-MAIL: posthamster at sublink.sublink.ORG
>  / \  AND POSTINGS        /   WWW: http://www.lesassaie.IT/
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users


From pheriko.support at gmail.com  Mon Mar 20 18:22:34 2023
From: pheriko.support at gmail.com (Periko Support)
Date: Mon, 20 Mar 2023 11:22:34 -0700
Subject: [squid-users] [EXTERNAL] FreeBSD 12 thousands connections
In-Reply-To: <CH2PR19MB34964943F07627283CE0CBC3CD809@CH2PR19MB3496.namprd19.prod.outlook.com>
References: <CAK2yrTYKKmwbwgBsAsWep=XwY-SSH4eO-WZwV=Qe6f2KBeAdXw@mail.gmail.com>
 <CH2PR19MB34964943F07627283CE0CBC3CD809@CH2PR19MB3496.namprd19.prod.outlook.com>
Message-ID: <CAK2yrTYDTeuGwgp2B7BpnoVMiGKmB7pGVhCxC8wGT+N2ykCZ2w@mail.gmail.com>

This will be MITM Transparent Proxy.
No User Auth.
Thanks for your help.

On Mon, Mar 20, 2023 at 11:08?AM Joey Officer <JOfficer at istreamfs.com> wrote:
>
> Will the users require authentication?  Depending on what authentication is active, you'd probably want to increase the minimum amount of auth helpers to satisfy the requests.
>
> That said, you really haven't given enough information about your specific use.
>
> -----Original Message-----
> From: squid-users <squid-users-bounces at lists.squid-cache.org> On Behalf Of Periko Support
> Sent: Monday, March 20, 2023 12:38 PM
> To: squid-users at lists.squid-cache.org
> Subject: [EXTERNAL][squid-users] FreeBSD 12 thousands connections
>
> CAUTION: This email originated from outside of the organization. Do not click links or open attachments unless you recognize the sender and know the content is safe.
>
> Hello guys.
>
> I 'm going to run a squid-proxy for around 3000 users simultaneously.
>
> The server is a Supermicro Intel 8 cores with 64GB RAM, SSD disk, I will not enable caching.
>
> The switches are 1GB HP.
>
> Any recommendations for this deployment that could help tuning my FreeBSD 12.3 box to take into consideration?
>
> Thanks all for your time!!!
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users


From ngtech1ltd at gmail.com  Tue Mar 21 22:08:21 2023
From: ngtech1ltd at gmail.com (ngtech1ltd at gmail.com)
Date: Wed, 22 Mar 2023 00:08:21 +0200
Subject: [squid-users] [EXTERNAL] FreeBSD 12 thousands connections
In-Reply-To: <CAK2yrTYDTeuGwgp2B7BpnoVMiGKmB7pGVhCxC8wGT+N2ykCZ2w@mail.gmail.com>
References: <CAK2yrTYKKmwbwgBsAsWep=XwY-SSH4eO-WZwV=Qe6f2KBeAdXw@mail.gmail.com>
 <CH2PR19MB34964943F07627283CE0CBC3CD809@CH2PR19MB3496.namprd19.prod.outlook.com>
 <CAK2yrTYDTeuGwgp2B7BpnoVMiGKmB7pGVhCxC8wGT+N2ykCZ2w@mail.gmail.com>
Message-ID: <000001d95c41$a6f2a610$f4d7f230$@gmail.com>

Hey,

I know that the choice was made to use FreeBSD 12...
But I can suggest to use Linux and not FreeeBSD.
I have not tested this for a very long time but the last time I checked Linux was handling network traffic better then FreeBSD.
I also believe that if you would have any issues, you would be able to get better support on a Linux rather than FreeBSD.

Also, it is really important to know if you will be intercepting traffic in a TPROXY or NAT mode.
And the most important thing is to know that you will be facing a testing and integration period.
You might expect your 3k clients to use only 12k connections max but it's plausible to assume that it will
be much more when there would be load on the network.
Assuming a client will use Firefox, it has a pool of 6 connections per server and 900 maximum connections for the browser.
If you will take a simple website like yahoo or any other modern site you will face multiple servers for the same page..
which means that the connections per client will be more than double 4.

So, my recommendation is to take a Linux system either Debian, Ubuntu, CentOS, Alma, Oracle, Other
and use the machine only as a Router to see the number of connections you have on the network on peak hours.
If you do have another device on the network that is capable of providing the statistics for web (ports 80 and 443)
connections feel free to use that to make sure that your capacity planning is accurate.

Yours,
Elezer

----
Eliezer Croitoru
NgTech, Tech Support
Mobile: +972-5-28704261
Email: ngtech1ltd at gmail.com
Web: https://ngtech.co.il/
My-Tube: https://tube.ngtech.co.il/

-----Original Message-----
From: squid-users <squid-users-bounces at lists.squid-cache.org> On Behalf Of Periko Support
Sent: Monday, 20 March 2023 20:23
Cc: squid-users at lists.squid-cache.org
Subject: Re: [squid-users] [EXTERNAL] FreeBSD 12 thousands connections

This will be MITM Transparent Proxy.
No User Auth.
Thanks for your help.

On Mon, Mar 20, 2023 at 11:08?AM Joey Officer <JOfficer at istreamfs.com> wrote:
>
> Will the users require authentication?  Depending on what authentication is active, you'd probably want to increase the minimum amount of auth helpers to satisfy the requests.
>
> That said, you really haven't given enough information about your specific use.
>
> -----Original Message-----
> From: squid-users <squid-users-bounces at lists.squid-cache.org> On Behalf Of Periko Support
> Sent: Monday, March 20, 2023 12:38 PM
> To: squid-users at lists.squid-cache.org
> Subject: [EXTERNAL][squid-users] FreeBSD 12 thousands connections
>
> CAUTION: This email originated from outside of the organization. Do not click links or open attachments unless you recognize the sender and know the content is safe.
>
> Hello guys.
>
> I 'm going to run a squid-proxy for around 3000 users simultaneously.
>
> The server is a Supermicro Intel 8 cores with 64GB RAM, SSD disk, I will not enable caching.
>
> The switches are 1GB HP.
>
> Any recommendations for this deployment that could help tuning my FreeBSD 12.3 box to take into consideration?
>
> Thanks all for your time!!!
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users
_______________________________________________
squid-users mailing list
squid-users at lists.squid-cache.org
http://lists.squid-cache.org/listinfo/squid-users



From frizquierdo87 at gmail.com  Fri Mar 24 01:34:40 2023
From: frizquierdo87 at gmail.com (Francisco)
Date: Thu, 23 Mar 2023 21:34:40 -0400
Subject: [squid-users] squid 5.7 Bad request from parent cache after squid
 -k reconfigure
Message-ID: <CAJXDObbwMZBcE0w1JV91-a-3b+vgSxgfJG_WfTrPLAFxJhtM6Q@mail.gmail.com>

Hi, (first Iapologize for my English) I have a local squid proxy in forward
mode, with parent cache. I'm trying calc and restrict authenticated users
that reach the assigned cuote on certains domains and sites, and for that I
store the access log into database that match determinates ACL. Every one
minute run an script that calc http_size for every user from database
(leaving out logs records derived from TCP_HIT_, zero size, NONE, etc,
etc), and those users that get her assigned limit, I put them into a file
(that point to an access deny_rule), and make squid -k reconfigure.
All process described works ok, the users are denied but, when users try to
visit all others sites that are not taked in account to overcuote the
users, they get TCP_MISS/400 from parent cache (or NONE_NONE_ABORTED,
TCP_NEGATIVE_HIT, etc), and when user refresh the requested url, the
resource load again. Looking the parent response I look that url is
incorrect because it is missing the scheme and the host, for example: for
an url like http://www.certaindomain.com/page/section-algo/bla-bla-bla, the
TCP_MISS/400 (bad request from parent cache) result
in: /page/section-algo/bla-bla-bla
Any help with that?? where is my mistake?? Thank you

squid 5.7 over debian 11 (from Debian sid repository but until now it work
ok in others aspects).
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230323/9e60bbc2/attachment.htm>

From hamilton.coutinho at gmail.com  Fri Mar 24 02:28:28 2023
From: hamilton.coutinho at gmail.com (Hamilton Coutinho)
Date: Thu, 23 Mar 2023 19:28:28 -0700
Subject: [squid-users] Squid use all memory ram
In-Reply-To: <CAL5gn0VWzntX-1SVZ0O_8qE=DTC_WycKRbrOaSdqGJ5J90TZGg@mail.gmail.com>
References: <CAL5gn0WmNXX5ikV-4yuEKKsOBhxFyBwag+d5p9DRGG9PE+BL6g@mail.gmail.com>
 <CAL34ibmo7p51ZEUhW=JOQp8YAH72bZMrjh4RwhJ-JHb4F8XZkg@mail.gmail.com>
 <CAL5gn0VWzntX-1SVZ0O_8qE=DTC_WycKRbrOaSdqGJ5J90TZGg@mail.gmail.com>
Message-ID: <CAL34ib=p+oCMWHqRk=KbrRjz9wG63p1-vi4Lvvgq3nDQXcaz7Q@mail.gmail.com>

We are still chasing this one down but made a major breakthrough. The leak
is related to squid in intercept mode + SSL decryption + origin with
invalid certs. In our case, the majority of the cases were related to
Windows Update and Windows Defender domains, so a stopgap solution is to
bypass decryption for these sites (eg, .update.microsoft.com). If you do,
don't use dstdomain ACL, as the domain is not available at the time of the
checking. Use something like ssl::server_name[_regex].

Hope this helps!

On Fri, Jan 27, 2023 at 2:28?PM Gustavo Carvalho <gustavocarv4872 at gmail.com>
wrote:

> Hi Hamilton, thanks for helping!
>
> I wish I could provide this log while squid is crashing, but there
> have been no incidents since wednesday. From what I've heard, the RAM
> on that server's VM has been increased to 32GB.
>
> Anyway, here is the squidclient mgr:mem log output. I hope it can be
> helpful.
>
> On Thu, Jan 26, 2023 at 5:43 PM Hamilton Coutinho
> <hamilton.coutinho at gmail.com> wrote:
> >
> > Hi Gustavo,
> >
> > I'm seeing the same thing. I could narrow down (but can't say with 100%
> confidence) to the code that does certificate verification when configured
> for SSL decryption. What is the output of squidclient mgr:mem for you? Do
> you see unexplainably high counts for in-use objects like HttpRequest,
> PeekingPeerConnector, Comm::Connection, Security::ErrorDetail?
> >
> >
> > On Thu, Jan 26, 2023 at 12:31 PM Gustavo Carvalho <
> gustavocarv4872 at gmail.com> wrote:
> >>
> >> Hi,
> >>
> >> I have Squid 5.6 on a FreeBSD 13.1 server with 16GB RAM
> >>
> >> I noticed that squid starts to consume a lot of ram until it starts to
> >> consume swap space. When this happens, browsing becomes extremely
> >> slow.
> >>
> >> This is happening at least once a week when I have to restart squid to
> >> get it back to normal.
> >>
> >> Any ideas?
> >>
> >> ############# Wed Jan 25 08:30:00 -03 2023 #############
> >>
> >> HTTP/1.1 200 OK
> >> Server: squid
> >> Mime-Version: 1.0
> >> Date: Wed, 25 Jan 2023 11:30:00 GMT
> >> Content-Type: text/plain;charset=utf-8
> >> Expires: Wed, 25 Jan 2023 11:30:00 GMT
> >> Last-Modified: Wed, 25 Jan 2023 11:30:00 GMT
> >> X-Cache: MISS from xxxx.xxxx.xxxx
> >> X-Cache-Lookup: MISS from xxxx.xxxx.xxxx:3128
> >> Via: 1.1 xxxx.xxxx.xxxx (squid)
> >> Connection: close
> >>
> >> Squid Object Cache: Version 5.6
> >> Build Info:
> >> Service Name: squid
> >> Start Time: Thu, 19 Jan 2023 20:25:17 GMT
> >> Current Time: Wed, 25 Jan 2023 11:30:00 GMT
> >> Connection information for squid:
> >>      Number of clients accessing cache: 224
> >>      Number of HTTP requests received: 7541590
> >>      Number of ICP messages received: 0
> >>      Number of ICP messages sent: 0
> >>      Number of queued ICP replies: 0
> >>      Number of HTCP messages received: 0
> >>      Number of HTCP messages sent: 0
> >>      Request failure ratio: 0.00
> >>      Average HTTP requests per minute since start: 930.5
> >>      Average ICP messages per minute since start: 0.0
> >>      Select loop called: 78733524 times, 6.176 ms avg
> >> Cache information for squid:
> >>      Hits as % of all requests: 5min: 8.4%, 60min: 12.1%
> >>      Hits as % of bytes sent: 5min: 21.6%, 60min: 14.1%
> >>      Memory hits as % of hit requests: 5min: 90.8%, 60min: 75.9%
> >>      Disk hits as % of hit requests: 5min: 4.0%, 60min: 19.7%
> >>      Storage Swap size: 2829956 KB
> >>      Storage Swap capacity: 90.0% used, 10.0% free
> >>      Storage Mem size: 16172 KB
> >>      Storage Mem capacity: 98.7% used,  1.3% free
> >>      Mean Object Size: 28.95 KB
> >>      Requests given to unlinkd: 186982
> >> Median Service Times (seconds)  5 min    60 min:
> >> HTTP Requests (All):   0.00562  0.01847
> >>      Cache Misses:          0.15048  0.23230
> >>      Cache Hits:            0.00000  0.00000
> >>      Near Hits:             0.14252  0.13498
> >>      Not-Modified Replies:  0.00865  0.03066
> >>      DNS Lookups:           0.00000  0.00372
> >>      ICP Queries:           0.00000  0.00000
> >> Resource usage for squid:
> >>      UP Time: 486282.612 seconds
> >>      CPU Time: 65555.712 seconds
> >>      CPU Usage: 13.48%
> >>      CPU Usage, 5 minute avg: 26.89%
> >>      CPU Usage, 60 minute avg: 68.00%
> >>      Maximum Resident Size: 37896960 KB
> >>      Page faults with physical i/o: 10843
> >> Memory accounted for:
> >>      Total accounted:       -1459461 KB
> >>      memPoolAlloc calls:     11408
> >>      memPoolFree calls:  1888969689
> >> File descriptor usage for squid:
> >>      Maximum number of file descriptors:   4096
> >>      Largest file desc currently in use:   2149
> >>      Number of file desc currently in use:  679
> >>      Files queued for open:                   0
> >>      Available number of file descriptors: 3417
> >>      Reserved number of file descriptors:   100
> >>      Store Disk files open:                   0
> >> Internal Data Structures:
> >>      97906 StoreEntries
> >>      3002 StoreEntries with MemObjects
> >>      2838 Hot Object Cache Items
> >>      97742 on-disk objects
> >>
> >> ------ pfctl -si ------
> >>
> >> Status: Enabled for 25 days 22:58:24          Debug: Urgent
> >>
> >> State Table                          Total             Rate
> >>   current entries                     8085
> >>   searches                      6650475717         2965.4/s
> >>   inserts                        133521957           59.5/s
> >>   removals                       133552376           59.5/s
> >> Counters
> >>   match                          605960865          270.2/s
> >>   bad-offset                             0            0.0/s
> >>   fragment                               1            0.0/s
> >>   short                                 54            0.0/s
> >>   normalize                            659            0.0/s
> >>   memory                                 0            0.0/s
> >>   bad-timestamp                          0            0.0/s
> >>   congestion                             0            0.0/s
> >>   ip-option                              0            0.0/s
> >>   proto-cksum                            0            0.0/s
> >>   state-mismatch                    104674            0.0/s
> >>   state-insert                       38501            0.0/s
> >>   state-limit                            0            0.0/s
> >>   src-limit                              0            0.0/s
> >>   synproxy                               0            0.0/s
> >>   map-failed                             0            0.0/s
> >>
> >> ------ sysctl -a | grep swap  ------
> >>
> >> swap_pager: out of swap space
> >> swp_pager_getswapspace(32): failed
> >> swap_pager: out of swap space
> >> swp_pager_getswapspace(31): failed
> >> swap_pager: out of swap space
> >> swp_pager_getswapspace(1): failed
> >> 1 PART da0p2 2147483648 512 i 2 o 544768 ty freebsd-swap xs GPT xt
> >> 516e7cb5-6ecf-11d6-8ff8-00022d09712b
> >> 0 MD md1 94371840 512 u 1 s 512 f 0 fs 0 l 94371840 t swap label
> >> 0 MD md0 62914560 512 u 0 s 512 f 0 fs 0 l 62914560 t swap label
> >> z0xfffff80003ec5800 [shape=box,label="SWAP\nswap\nr#3"];
> >>       <name>swap</name>
> >>     <type>swap</type>
> >>     <type>swap</type>
> >>     <type>freebsd-swap</type>
> >> vm.swap_enabled: 1
> >> vm.domain.0.stats.unswappable: 2044
> >> vm.swap_idle_threshold2: 10
> >> vm.swap_idle_threshold1: 2
> >> vm.swap_idle_enabled: 0
> >> vm.disable_swapspace_pageouts: 0
> >> vm.stats.vm.v_swappgsout: 3154299
> >> vm.stats.vm.v_swappgsin: 510404
> >> vm.stats.vm.v_swapout: 174446
> >> vm.stats.vm.v_swapin: 62590
> >> vm.stats.swap.free_completed: 54375
> >> vm.stats.swap.free_deferred: 56992
> >> vm.nswapdev: 1
> >> vm.swap_fragmentation:
> >> vm.swap_async_max: 4
> >> vm.swap_maxpages: 32572800
> >> vm.swap_total: 2147483648
> >> vm.swap_reserved: 384676114432
> >>
> >> ------ /usr/sbin/swapinfo -h  ------
> >>
> >> Device              Size     Used    Avail Capacity
> >> /dev/da0p2          2.0G     2.0G     8.0K   100%
> >>
> >>
> >> ############# squid.conf #############
> >>
> >> http_port 3128 ssl-bump generate-host-certificates=on
> >> dynamic_cert_mem_cache_size=20MB cert=/xxxx/conf/certs/ca.crt
> >> key=/xxxx/conf/certs/ca.key
> >> http_port 3129 intercept
> >> https_port 3130 intercept ssl-bump generate-host-certificates=on
> >> dynamic_cert_mem_cache_size=20MB cert=/xxxx/conf/certs/ca.crt
> >> key=/xxxx/conf/certs/ca.key
> >> visible_hostname xxxx.xxxx.xxxx
> >> max_filedescriptors 4096
> >> maximum_object_size 4096 KB
> >> minimum_object_size 0 KB
> >> maximum_object_size_in_memory 256 KB
> >> fqdncache_size 1024
> >> cache_mgr xxxx at xxxx
> >> dns_nameservers 127.0.0.1
> >> cache_replacement_policy                heap LFUDA
> >> memory_replacement_policy               heap GDSF
> >> cache_mem 16 MB
> >> cache_dir               ufs /xxxx/chroot/osproxy/cache 3072 32 256
> >> forwarded_for on
> >> memory_pools off
> >> logformat xxxx %ts|%6tr|%>a|%Ss|%03>Hs|%<st|%rm|%un|%mt|%ea|%ru
> >> logfile_rotate 0
> >> httpd_suppress_version_string on
> >> strip_query_terms off
> >> _______________________________________________
> >> squid-users mailing list
> >> squid-users at lists.squid-cache.org
> >> http://lists.squid-cache.org/listinfo/squid-users
> >
> >
> >
> > --
> > Hamilton
> > _______________________________________________
> > squid-users mailing list
> > squid-users at lists.squid-cache.org
> > http://lists.squid-cache.org/listinfo/squid-users
>


-- 
Hamilton
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230323/6cd7f60e/attachment.htm>

From squid3 at treenet.co.nz  Sun Mar 26 16:05:02 2023
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Mon, 27 Mar 2023 05:05:02 +1300
Subject: [squid-users] squid 5.7 Bad request from parent cache after
 squid -k reconfigure
In-Reply-To: <CAJXDObbwMZBcE0w1JV91-a-3b+vgSxgfJG_WfTrPLAFxJhtM6Q@mail.gmail.com>
References: <CAJXDObbwMZBcE0w1JV91-a-3b+vgSxgfJG_WfTrPLAFxJhtM6Q@mail.gmail.com>
Message-ID: <bfd2a571-02d1-2cff-690c-59caf55a0338@treenet.co.nz>

On 24/03/2023 2:34 pm, Francisco wrote:
> Hi, (first Iapologize for my English) I have a local squid proxy in 
> forward mode, with parent cache. I'm trying calc and restrict 
> authenticated users that reach the assigned cuote on certains domains 
> and sites, and for that I store the access log into database that 
> match determinates ACL.

> Every one minute run an script that calc http_size for every user from 
> database (leaving out logs records derived from TCP_HIT_, zero size, 
> NONE, etc, etc), and those users that get her assigned limit, I put 
> them into a file (that point to an access deny_rule), and make squid 
> -k reconfigure.

Constantly reconfiguring Squid has a large number of side effects such 
as the one you noticed. Avoiding that is a good idea.

I recommend having a table in the database with the details about 
whether a user is allowed (or not). The ext_sql_session_acl helper can 
check that table to allow/deny users.
 ?<http://www.squid-cache.org/Versions/v4/manuals/ext_sql_session_acl.html>


HTH
Amos


From frizquierdo87 at gmail.com  Mon Mar 27 22:09:10 2023
From: frizquierdo87 at gmail.com (Francisco)
Date: Mon, 27 Mar 2023 18:09:10 -0400
Subject: [squid-users] squid-users Digest, Vol 103, Issue 21
In-Reply-To: <mailman.5.1679918401.530362.squid-users@lists.squid-cache.org>
References: <mailman.5.1679918401.530362.squid-users@lists.squid-cache.org>
Message-ID: <CAJXDObaQz4X2g=Y5Uh3U6NPmoafA-RygPWMvfED6bEYNszf_uA@mail.gmail.com>

Sorry, I don't understand how to combine *ext_sql_session_acl* with
anothers acl of type dstdomain for example, becasue I need calc user's
cuote only for an certains sites (domains, and sites).


El lun, 27 mar 2023 a las 8:00, <squid-users-request at lists.squid-cache.org>
escribi?:

> Send squid-users mailing list submissions to
>         squid-users at lists.squid-cache.org
>
> To subscribe or unsubscribe via the World Wide Web, visit
>         http://lists.squid-cache.org/listinfo/squid-users
> or, via email, send a message with subject or body 'help' to
>         squid-users-request at lists.squid-cache.org
>
> You can reach the person managing the list at
>         squid-users-owner at lists.squid-cache.org
>
> When replying, please edit your Subject line so it is more specific
> than "Re: Contents of squid-users digest..."
>
>
> Today's Topics:
>
>    1. Re: squid 5.7 Bad request from parent cache after squid -k
>       reconfigure (Amos Jeffries)
>
>
> ----------------------------------------------------------------------
>
> Message: 1
> Date: Mon, 27 Mar 2023 05:05:02 +1300
> From: Amos Jeffries <squid3 at treenet.co.nz>
> To: squid-users at lists.squid-cache.org
> Subject: Re: [squid-users] squid 5.7 Bad request from parent cache
>         after squid -k reconfigure
> Message-ID: <bfd2a571-02d1-2cff-690c-59caf55a0338 at treenet.co.nz>
> Content-Type: text/plain; charset=UTF-8; format=flowed
>
> On 24/03/2023 2:34 pm, Francisco wrote:
> > Hi, (first Iapologize for my English) I have a local squid proxy in
> > forward mode, with parent cache. I'm trying calc and restrict
> > authenticated users that reach the assigned cuote on certains domains
> > and sites, and for that I store the access log into database that
> > match determinates ACL.
>
> > Every one minute run an script that calc http_size for every user from
> > database (leaving out logs records derived from TCP_HIT_, zero size,
> > NONE, etc, etc), and those users that get her assigned limit, I put
> > them into a file (that point to an access deny_rule), and make squid
> > -k reconfigure.
>
> Constantly reconfiguring Squid has a large number of side effects such
> as the one you noticed. Avoiding that is a good idea.
>
> I recommend having a table in the database with the details about
> whether a user is allowed (or not). The ext_sql_session_acl helper can
> check that table to allow/deny users.
>  ?<http://www.squid-cache.org/Versions/v4/manuals/ext_sql_session_acl.html
> >
>
>
> HTH
> Amos
>
>
> ------------------------------
>
> Subject: Digest Footer
>
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users
>
>
> ------------------------------
>
> End of squid-users Digest, Vol 103, Issue 21
> ********************************************
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230327/48f4c47d/attachment.htm>

From frizquierdo87 at gmail.com  Tue Mar 28 15:46:29 2023
From: frizquierdo87 at gmail.com (Francisco)
Date: Tue, 28 Mar 2023 11:46:29 -0400
Subject: [squid-users] squid-users Digest, Vol 103, Issue 22
In-Reply-To: <mailman.3.1680004801.2225941.squid-users@lists.squid-cache.org>
References: <mailman.3.1680004801.2225941.squid-users@lists.squid-cache.org>
Message-ID: <CAJXDOba8SokfbZWeG-GidyLb6-r-hJYG__qJCCF6iQ2zQJUE0g@mail.gmail.com>

In my previous email I was missing part of the text when I sent it, I
deleted it by mistake.
This is what I have so far:

I try to make the following config:
external_acl_type CHECKOVERCUOTE ttl=5 negative_ttl=5 children-max=10
children-startup=5 %ACL /usr/lib/squid/ext_sql_session_acl --dsn
"DBI:mysql:database=squidmgr" --user squidmgr --password squidmgr --table
"proxy_usuario" uidcol "id" --usercol "identificador" --cond "overcuote=1"
--persist
acl OVERCUOTE external CHECKOVERCUOTE

http_access allow CONNECT SSL_ports !dominio_cuba usuarios_internet
macs_red_local red_local !OVERCUOTE

--cond "overcuote=1" is the field in database that it's set to 1 when user
calc overcuote.

if i try ext_sql_session_acl from terminal, i see:
ERR message="unknow UID ' '"



El mar, 28 mar 2023 a las 8:00, <squid-users-request at lists.squid-cache.org>
escribi?:

> Send squid-users mailing list submissions to
>         squid-users at lists.squid-cache.org
>
> To subscribe or unsubscribe via the World Wide Web, visit
>         http://lists.squid-cache.org/listinfo/squid-users
> or, via email, send a message with subject or body 'help' to
>         squid-users-request at lists.squid-cache.org
>
> You can reach the person managing the list at
>         squid-users-owner at lists.squid-cache.org
>
> When replying, please edit your Subject line so it is more specific
> than "Re: Contents of squid-users digest..."
>
>
> Today's Topics:
>
>    1. Re: squid-users Digest, Vol 103, Issue 21 (Francisco)
>
>
> ----------------------------------------------------------------------
>
> Message: 1
> Date: Mon, 27 Mar 2023 18:09:10 -0400
> From: Francisco <frizquierdo87 at gmail.com>
> To: squid-users at lists.squid-cache.org
> Subject: Re: [squid-users] squid-users Digest, Vol 103, Issue 21
> Message-ID:
>         <CAJXDObaQz4X2g=
> Y5Uh3U6NPmoafA-RygPWMvfED6bEYNszf_uA at mail.gmail.com>
> Content-Type: text/plain; charset="utf-8"
>
> Sorry, I don't understand how to combine *ext_sql_session_acl* with
> anothers acl of type dstdomain for example, becasue I need calc user's
> cuote only for an certains sites (domains, and sites).
>
>
> El lun, 27 mar 2023 a las 8:00, <squid-users-request at lists.squid-cache.org
> >
> escribi?:
>
> > Send squid-users mailing list submissions to
> >         squid-users at lists.squid-cache.org
> >
> > To subscribe or unsubscribe via the World Wide Web, visit
> >         http://lists.squid-cache.org/listinfo/squid-users
> > or, via email, send a message with subject or body 'help' to
> >         squid-users-request at lists.squid-cache.org
> >
> > You can reach the person managing the list at
> >         squid-users-owner at lists.squid-cache.org
> >
> > When replying, please edit your Subject line so it is more specific
> > than "Re: Contents of squid-users digest..."
> >
> >
> > Today's Topics:
> >
> >    1. Re: squid 5.7 Bad request from parent cache after squid -k
> >       reconfigure (Amos Jeffries)
> >
> >
> > ----------------------------------------------------------------------
> >
> > Message: 1
> > Date: Mon, 27 Mar 2023 05:05:02 +1300
> > From: Amos Jeffries <squid3 at treenet.co.nz>
> > To: squid-users at lists.squid-cache.org
> > Subject: Re: [squid-users] squid 5.7 Bad request from parent cache
> >         after squid -k reconfigure
> > Message-ID: <bfd2a571-02d1-2cff-690c-59caf55a0338 at treenet.co.nz>
> > Content-Type: text/plain; charset=UTF-8; format=flowed
> >
> > On 24/03/2023 2:34 pm, Francisco wrote:
> > > Hi, (first Iapologize for my English) I have a local squid proxy in
> > > forward mode, with parent cache. I'm trying calc and restrict
> > > authenticated users that reach the assigned cuote on certains domains
> > > and sites, and for that I store the access log into database that
> > > match determinates ACL.
> >
> > > Every one minute run an script that calc http_size for every user from
> > > database (leaving out logs records derived from TCP_HIT_, zero size,
> > > NONE, etc, etc), and those users that get her assigned limit, I put
> > > them into a file (that point to an access deny_rule), and make squid
> > > -k reconfigure.
> >
> > Constantly reconfiguring Squid has a large number of side effects such
> > as the one you noticed. Avoiding that is a good idea.
> >
> > I recommend having a table in the database with the details about
> > whether a user is allowed (or not). The ext_sql_session_acl helper can
> > check that table to allow/deny users.
> >  ?<
> http://www.squid-cache.org/Versions/v4/manuals/ext_sql_session_acl.html
> > >
> >
> >
> > HTH
> > Amos
> >
> >
> > ------------------------------
> >
> > Subject: Digest Footer
> >
> > _______________________________________________
> > squid-users mailing list
> > squid-users at lists.squid-cache.org
> > http://lists.squid-cache.org/listinfo/squid-users
> >
> >
> > ------------------------------
> >
> > End of squid-users Digest, Vol 103, Issue 21
> > ********************************************
> >
> -------------- next part --------------
> An HTML attachment was scrubbed...
> URL: <
> http://lists.squid-cache.org/pipermail/squid-users/attachments/20230327/48f4c47d/attachment-0001.htm
> >
>
> ------------------------------
>
> Subject: Digest Footer
>
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users
>
>
> ------------------------------
>
> End of squid-users Digest, Vol 103, Issue 22
> ********************************************
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230328/fd60a036/attachment.htm>

From wbx at openadk.org  Thu Mar 30 11:58:00 2023
From: wbx at openadk.org (Waldemar Brodkorb)
Date: Thu, 30 Mar 2023 13:58:00 +0200
Subject: [squid-users] logging: TCP connection to x.x.x.x/3128 failed
Message-ID: <ZCV5SBq85hDNEyzv@waldemar-brodkorb.de>

Hi Squid Community,

we recently updated one of our stage 1 proxies to Ubuntu 22.04 with
Squid 5.8. The setup is like so:
clients <-> loadbalancer <-> stage 1 proxies <-> stage 2 proxies <-> internet

Now the cache.log on the stage 1 proxy is polluted with a lot of
messages like: TCP connection to x.x.x.x/3128 failed

The message appear when a client tries to connect to a website which
does not resolve via DNS. The parent stage 2 proxy sends then a
50x error and the stage 1 proxy logs messages like above for every
of the six stage 2 proxies.

How can we suppress these messages or can they be fixed to what is
really happening?

Thanks in advance for any advice.

best regards
 Waldemar


From frizquierdo87 at gmail.com  Thu Mar 30 13:37:15 2023
From: frizquierdo87 at gmail.com (Francisco)
Date: Thu, 30 Mar 2023 09:37:15 -0400
Subject: [squid-users] squid-users Digest, Vol 103, Issue 23
In-Reply-To: <mailman.5.1680091201.3911479.squid-users@lists.squid-cache.org>
References: <mailman.5.1680091201.3911479.squid-users@lists.squid-cache.org>
Message-ID: <CAJXDObb7uFq7YBxqNcOW+wC2scDkOC4xe1ZCnS0VkoJFiG95_w@mail.gmail.com>

I got the external acl setup to work, it had some bugs but I notice
something that maybe through configuration I can fix.

It's a configuration
external_acl_type CHECKOVERCUOTE concurrency=100 ttl=3 negative_ttl=10
children-max=50 children-startup=10 children-idle=5  %LOGIN
/usr/lib/squid/ext_sql_session_acl --dsn "DBI:mysql:database=squidmgr"
--user squidmgr --password squ1dmgr --table "proxy_usuario" --uidcol
"identificador" --usercol "identificador" --cond "overcuote = 1" --debug
acl OVERCUOTE external CHECKOVERCUOTE

It generate: SELECT identificador AS 'user', '' AS 'tag' FROM proxy_usuario
WHERE (identificador = ?) AND overcuote =1
UID queried: 'frizquierdo - ' # when user identifier authenticated on squid
is 'frizquierdo'

The user identifier generated by the ext_sql_session_acl query is made up
of the user identifier +space+ hyphen +space, for example (for
'frizquierdo' identifier, 'frizquierdo - ' is generated), so in the
database it would have to be the user identifier stored in that format.
Is there a directive that guarantees that the parameter is not created that
way?

El mi?, 29 mar 2023 a las 8:00, <squid-users-request at lists.squid-cache.org>
escribi?:

> Send squid-users mailing list submissions to
>         squid-users at lists.squid-cache.org
>
> To subscribe or unsubscribe via the World Wide Web, visit
>         http://lists.squid-cache.org/listinfo/squid-users
> or, via email, send a message with subject or body 'help' to
>         squid-users-request at lists.squid-cache.org
>
> You can reach the person managing the list at
>         squid-users-owner at lists.squid-cache.org
>
> When replying, please edit your Subject line so it is more specific
> than "Re: Contents of squid-users digest..."
>
>
> Today's Topics:
>
>    1. Re: squid-users Digest, Vol 103, Issue 22 (Francisco)
>
>
> ----------------------------------------------------------------------
>
> Message: 1
> Date: Tue, 28 Mar 2023 11:46:29 -0400
> From: Francisco <frizquierdo87 at gmail.com>
> To: squid-users at lists.squid-cache.org
> Subject: Re: [squid-users] squid-users Digest, Vol 103, Issue 22
> Message-ID:
>         <
> CAJXDOba8SokfbZWeG-GidyLb6-r-hJYG__qJCCF6iQ2zQJUE0g at mail.gmail.com>
> Content-Type: text/plain; charset="utf-8"
>
> In my previous email I was missing part of the text when I sent it, I
> deleted it by mistake.
> This is what I have so far:
>
> I try to make the following config:
> external_acl_type CHECKOVERCUOTE ttl=5 negative_ttl=5 children-max=10
> children-startup=5 %ACL /usr/lib/squid/ext_sql_session_acl --dsn
> "DBI:mysql:database=squidmgr" --user squidmgr --password squidmgr --table
> "proxy_usuario" uidcol "id" --usercol "identificador" --cond "overcuote=1"
> --persist
> acl OVERCUOTE external CHECKOVERCUOTE
>
> http_access allow CONNECT SSL_ports !dominio_cuba usuarios_internet
> macs_red_local red_local !OVERCUOTE
>
> --cond "overcuote=1" is the field in database that it's set to 1 when user
> calc overcuote.
>
> if i try ext_sql_session_acl from terminal, i see:
> ERR message="unknow UID ' '"
>
>
>
> El mar, 28 mar 2023 a las 8:00, <squid-users-request at lists.squid-cache.org
> >
> escribi?:
>
> > Send squid-users mailing list submissions to
> >         squid-users at lists.squid-cache.org
> >
> > To subscribe or unsubscribe via the World Wide Web, visit
> >         http://lists.squid-cache.org/listinfo/squid-users
> > or, via email, send a message with subject or body 'help' to
> >         squid-users-request at lists.squid-cache.org
> >
> > You can reach the person managing the list at
> >         squid-users-owner at lists.squid-cache.org
> >
> > When replying, please edit your Subject line so it is more specific
> > than "Re: Contents of squid-users digest..."
> >
> >
> > Today's Topics:
> >
> >    1. Re: squid-users Digest, Vol 103, Issue 21 (Francisco)
> >
> >
> > ----------------------------------------------------------------------
> >
> > Message: 1
> > Date: Mon, 27 Mar 2023 18:09:10 -0400
> > From: Francisco <frizquierdo87 at gmail.com>
> > To: squid-users at lists.squid-cache.org
> > Subject: Re: [squid-users] squid-users Digest, Vol 103, Issue 21
> > Message-ID:
> >         <CAJXDObaQz4X2g=
> > Y5Uh3U6NPmoafA-RygPWMvfED6bEYNszf_uA at mail.gmail.com>
> > Content-Type: text/plain; charset="utf-8"
> >
> > Sorry, I don't understand how to combine *ext_sql_session_acl* with
> > anothers acl of type dstdomain for example, becasue I need calc user's
> > cuote only for an certains sites (domains, and sites).
> >
> >
> > El lun, 27 mar 2023 a las 8:00, <
> squid-users-request at lists.squid-cache.org
> > >
> > escribi?:
> >
> > > Send squid-users mailing list submissions to
> > >         squid-users at lists.squid-cache.org
> > >
> > > To subscribe or unsubscribe via the World Wide Web, visit
> > >         http://lists.squid-cache.org/listinfo/squid-users
> > > or, via email, send a message with subject or body 'help' to
> > >         squid-users-request at lists.squid-cache.org
> > >
> > > You can reach the person managing the list at
> > >         squid-users-owner at lists.squid-cache.org
> > >
> > > When replying, please edit your Subject line so it is more specific
> > > than "Re: Contents of squid-users digest..."
> > >
> > >
> > > Today's Topics:
> > >
> > >    1. Re: squid 5.7 Bad request from parent cache after squid -k
> > >       reconfigure (Amos Jeffries)
> > >
> > >
> > > ----------------------------------------------------------------------
> > >
> > > Message: 1
> > > Date: Mon, 27 Mar 2023 05:05:02 +1300
> > > From: Amos Jeffries <squid3 at treenet.co.nz>
> > > To: squid-users at lists.squid-cache.org
> > > Subject: Re: [squid-users] squid 5.7 Bad request from parent cache
> > >         after squid -k reconfigure
> > > Message-ID: <bfd2a571-02d1-2cff-690c-59caf55a0338 at treenet.co.nz>
> > > Content-Type: text/plain; charset=UTF-8; format=flowed
> > >
> > > On 24/03/2023 2:34 pm, Francisco wrote:
> > > > Hi, (first Iapologize for my English) I have a local squid proxy in
> > > > forward mode, with parent cache. I'm trying calc and restrict
> > > > authenticated users that reach the assigned cuote on certains domains
> > > > and sites, and for that I store the access log into database that
> > > > match determinates ACL.
> > >
> > > > Every one minute run an script that calc http_size for every user
> from
> > > > database (leaving out logs records derived from TCP_HIT_, zero size,
> > > > NONE, etc, etc), and those users that get her assigned limit, I put
> > > > them into a file (that point to an access deny_rule), and make squid
> > > > -k reconfigure.
> > >
> > > Constantly reconfiguring Squid has a large number of side effects such
> > > as the one you noticed. Avoiding that is a good idea.
> > >
> > > I recommend having a table in the database with the details about
> > > whether a user is allowed (or not). The ext_sql_session_acl helper can
> > > check that table to allow/deny users.
> > >  ?<
> > http://www.squid-cache.org/Versions/v4/manuals/ext_sql_session_acl.html
> > > >
> > >
> > >
> > > HTH
> > > Amos
> > >
> > >
> > > ------------------------------
> > >
> > > Subject: Digest Footer
> > >
> > > _______________________________________________
> > > squid-users mailing list
> > > squid-users at lists.squid-cache.org
> > > http://lists.squid-cache.org/listinfo/squid-users
> > >
> > >
> > > ------------------------------
> > >
> > > End of squid-users Digest, Vol 103, Issue 21
> > > ********************************************
> > >
> > -------------- next part --------------
> > An HTML attachment was scrubbed...
> > URL: <
> >
> http://lists.squid-cache.org/pipermail/squid-users/attachments/20230327/48f4c47d/attachment-0001.htm
> > >
> >
> > ------------------------------
> >
> > Subject: Digest Footer
> >
> > _______________________________________________
> > squid-users mailing list
> > squid-users at lists.squid-cache.org
> > http://lists.squid-cache.org/listinfo/squid-users
> >
> >
> > ------------------------------
> >
> > End of squid-users Digest, Vol 103, Issue 22
> > ********************************************
> >
> -------------- next part --------------
> An HTML attachment was scrubbed...
> URL: <
> http://lists.squid-cache.org/pipermail/squid-users/attachments/20230328/fd60a036/attachment-0001.htm
> >
>
> ------------------------------
>
> Subject: Digest Footer
>
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users
>
>
> ------------------------------
>
> End of squid-users Digest, Vol 103, Issue 23
> ********************************************
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230330/cab03651/attachment.htm>

