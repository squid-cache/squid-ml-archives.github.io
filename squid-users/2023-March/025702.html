<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Understanding maximum outgoing HTTP CONNECT requests?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Understanding%20maximum%20outgoing%20HTTP%20CONNECT%0A%20requests%3F&In-Reply-To=%3Cd4c003c4-e4df-07e7-3349-a8ba638e8ad8%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="025684.html">
   <LINK REL="Next"  HREF="025685.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Understanding maximum outgoing HTTP CONNECT requests?</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Understanding%20maximum%20outgoing%20HTTP%20CONNECT%0A%20requests%3F&In-Reply-To=%3Cd4c003c4-e4df-07e7-3349-a8ba638e8ad8%40treenet.co.nz%3E"
       TITLE="[squid-users] Understanding maximum outgoing HTTP CONNECT requests?">squid3 at treenet.co.nz
       </A><BR>
    <I>Sun Mar 12 22:00:44 UTC 2023</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="025684.html">[squid-users] Understanding maximum outgoing HTTP CONNECT requests?
</A></li>
        <LI>Next message (by thread): <A HREF="025685.html">[squid-users] Can't store log in mysql 8.0 database (Amos Jeffries)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25702">[ date ]</a>
              <a href="thread.html#25702">[ thread ]</a>
              <a href="subject.html#25702">[ subject ]</a>
              <a href="author.html#25702">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 5/03/2023 1:42 am, divan.whelk.0u wrote:
&gt;<i>   
</I>&gt;<i> Thank you for the prompt reply!
</I>&gt;<i>
</I>&gt;&gt;<i> - Squid can be configured to receive on up to 64 ports.
</I>&gt;&gt;<i>    Thus dst-port on **inbound** is 2^6.
</I>&gt;&gt;<i> outbound =  N * 2^6 * 2^128 * 2^16 = N * 2^150
</I>&gt;<i> Would that be 2^6 dst-port on outbound, rather than inbound (ignoring Alt-Svc)? Or am misunderstand the theoretical limit formulae after?
</I>
Oops. No the 2^6 should be on the inbound formula, and outbound have 
2^16 in that place.
Net effect is the same though one is 2^150 and the other 2^160.


&gt;&gt;<i> Thus total theoretical limit of simultaneous connections Squid can be juggling is  N * 2^151.
</I>&gt;<i> So, for example a single box HTTP CONNECT proxy might be listening on one IPv4 address and one IPv6 address, which would be making the outbound connections (and opening the TCP tunnel) and only able to make outbound connections to either port 80 or 443 (2^16 for each respective port, ignoring Alt-Svc).
</I>&gt;<i>
</I>&gt;<i> Whereas for incoming, listening on dst-port (3128) (2^16 incoming), with a theoretical limit of 2^32 IPv4 addresses or 2^128 IPv6 addresses (or do you use 2^128 including IPv4)?
</I>
Ah, yes. I also assumed a typical hybrid or dual stack machine where 
IPv4 is mapped as part of the IPv6 2^128 range.

&gt;<i>
</I>&gt;&gt;<i> Reality can be significantly different for any given installation, but is imposed by configuration choices and thus can be altered as needed.
</I>&gt;<i> Understood, thanks! I think I&#8217;ve got a good idea now, with the clarifications.
</I>&gt;<i>
</I>&gt;<i> Alex
</I>&gt;<i>
</I>&gt;&gt;<i> On 17 Feb 2023, at 20:18, Amos Jeffries &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt; wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> On 18/02/2023 12:14 am, divan.whelk.0u wrote:
</I>&gt;&gt;&gt;<i> Hi there!
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> I&#8217;m trying to understand what would the &#8220;theoretical&#8221; maximum amount of outgoing connections with squid setup as a HTTP CONNECT forward proxy would be (hardware permitting)?
</I>&gt;&gt;<i> As you likely know, each TCP/IP connection uses a 4-tuple identifier {src-IP, src-port, dst-IP, dst-port}.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> So at face value there is a protocol imposed cap of (2^128 * 2^16 * 2^128 * 2^16) = 2^288 connections.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Being theoretical we have:
</I>&gt;&gt;<i>      * ignored reserved IP ranges,
</I>&gt;&gt;<i>      * ignored OS-specific ephemeral port reservations,
</I>&gt;&gt;<i>      * assumed IPv6 availability, and
</I>&gt;&gt;<i>      * assumed no access restrictions in Squid, network routing, nor firewall.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The factors to consider are:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>   - Squid machine can be assigned multiple IP's.
</I>&gt;&gt;<i>      Thus src-IP on outbound and dst-IP on inbound are that N.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>   - Squid can be configured to receive on up to 64 ports.
</I>&gt;&gt;<i>     Thus dst-port on inbound is 2^6.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>   - DNS can provide any number of IPs for any given server name.
</I>&gt;&gt;<i>      Thus outbound dst-IP can be any 2^128 value.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>   - modern websites use use Alt-Svc to spread across ports.
</I>&gt;&gt;<i>      Thus outbound dst-port can be any 2^16 value.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> So for theoretical limit the math is:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>   inbound =    2^128 * 2^16 * N * 2^16  = N * 2^160
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>   outbound =  N * 2^6 * 2^128 * 2^16 = N * 2^150
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Inbound and outbound are normally independent, but CONNECT is a special case where they are pinned 1:1.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Thus total theoretical limit of simultaneous connections Squid can be juggling is  N * 2^151.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Reality can be significantly different for any given installation, but is imposed by configuration choices and thus can be altered as needed.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>  From the [squid-users] About bottlenecks (Max number of connections, etc.) thread, I saw mention of the following:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> * The limit on number of connections any Squid can have attached is only limited by your configured FD limits and available server RAM. Squid uses ~64 KB per network socket for traffic state - which equates to around 2 GB of RAM just for I/O buffers at 20,000 concurrent client connections.
</I>&gt;&gt;&gt;<i> I assume the same would not apply on outgoing connections, and that there would be a limit of 65,536 connections to a single IP, port pair? For example, if we had 1 million users making requests via HTTP CONNECT, only 65K of them would be able to access the same website at any one time?
</I>&gt;&gt;<i> IIRC that quoted thread was discussing a Squid with more normal multiple-destination case hitting FD limits.  The 64K port limitation you refer to is a special case contingent on the &quot;single destination with single IP:port&quot; criteria - which itself is rarely true for a popular website. It assumes configuration restriction imposing that criteria somehow.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Cheers
</I>&gt;&gt;<i> Amos
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;<i> squid-users mailing list
</I>&gt;&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="025684.html">[squid-users] Understanding maximum outgoing HTTP CONNECT requests?
</A></li>
	<LI>Next message (by thread): <A HREF="025685.html">[squid-users] Can't store log in mysql 8.0 database (Amos Jeffries)
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25702">[ date ]</a>
              <a href="thread.html#25702">[ thread ]</a>
              <a href="subject.html#25702">[ subject ]</a>
              <a href="author.html#25702">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
