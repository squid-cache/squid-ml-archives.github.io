<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Access based on auth and referer
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Access%20based%20on%20auth%20and%20referer&In-Reply-To=%3C15bb2e2b-d689-88b9-e2da-d6f628569890%40unimi.it%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="025689.html">
   <LINK REL="Next"  HREF="025690.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Access based on auth and referer</H1>
    <B>Dott. Matteo Savatteri</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Access%20based%20on%20auth%20and%20referer&In-Reply-To=%3C15bb2e2b-d689-88b9-e2da-d6f628569890%40unimi.it%3E"
       TITLE="[squid-users] Access based on auth and referer">matteo.savatteri at unimi.it
       </A><BR>
    <I>Mon Mar 13 07:55:57 UTC 2023</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="025689.html">[squid-users] Access based on auth and referer
</A></li>
        <LI>Next message (by thread): <A HREF="025690.html">[squid-users] client-&gt;Squid: TCP [RST] and [RST,ACK]
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25705">[ date ]</a>
              <a href="thread.html#25705">[ thread ]</a>
              <a href="subject.html#25705">[ subject ]</a>
              <a href="author.html#25705">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Amos, list,

please, can you help me to solve the issue described below?

Or, if not possible at all, to find an alternative solution.

Thank you for your patience and your help.

Cheers,

Matteo

On 3/6/23 09:25, Dott. Matteo Savatteri wrote:
&gt;<i> Hi Amos,
</I>&gt;<i>
</I>&gt;<i> thank you for your answer.
</I>&gt;<i>
</I>&gt;<i> Unfortunately, the config you suggested does not seem to work: using 
</I>&gt;<i> that the proxy ask for password for every sites.
</I>&gt;<i>
</I>&gt;<i> I think this is because CONNECT requests naturally does not present 
</I>&gt;<i> the referer header. The special referer header in only present in 
</I>&gt;<i> subsequent requests, those that get ssl-bumped.
</I>&gt;<i>
</I>&gt;<i> This is an example CONNECT request found in logs:
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> CONNECT pixel.sitescout.com:443 HTTP/1.1
</I>&gt;<i> Host: pixel.sitescout.com:443
</I>&gt;<i> Proxy-Connection: keep-alive
</I>&gt;<i> User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) 
</I>&gt;<i> AppleWebKit/537.36 (KHTML, like Gecko) Chrome/108.0.0.0 Safari/537.36 
</I>&gt;<i> Edg/108.0.1462.76
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> How can I solve this? Is even possible to mix up auth based and 
</I>&gt;<i> referer based access?
</I>&gt;<i>
</I>&gt;<i> Thank you for your patience and your kind help,
</I>&gt;<i>
</I>&gt;<i> Matteo
</I>&gt;<i>
</I>&gt;<i> On 3/6/23 07:34, Amos Jeffries wrote:
</I>&gt;&gt;<i> On 5/03/2023 10:44 pm, Dott. Matteo Savatteri wrote:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Hello fellow Squid users,
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> we use Squid 3.5 at my company and we want to give access to all 
</I>&gt;&gt;&gt;<i> sites to authenticated users. If a user is not authenticated we need 
</I>&gt;&gt;&gt;<i> to allow only HTTP/S requests that present a referer header matching 
</I>&gt;&gt;&gt;<i> a regex. Is this even possible?
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> I have tried a combination of proxy_auth and referer_regex ACLs with 
</I>&gt;&gt;&gt;<i> no results. sslbump is working.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Try these rules:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &#160; # initial security protection
</I>&gt;&gt;<i> &#160; http_access deny !Safe_ports
</I>&gt;&gt;<i> &#160; http_access deny CONNECT !SSL_ports
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &#160; # forbid access to cache manager from non-localhost
</I>&gt;&gt;<i> &#160; http_access deny manager !localhost
</I>&gt;&gt;<i> &#160; # leave the below commented to require a login for cache manager 
</I>&gt;&gt;<i> access
</I>&gt;&gt;<i> &#160; # http_access allow manager
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &#160; # forbid unauthenticated, except when providing the special Referer 
</I>&gt;&gt;<i> header
</I>&gt;&gt;<i> &#160; http_access deny !myreferer !password
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &#160; # users not denied are allowed
</I>&gt;&gt;<i> &#160; http_access allow all
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Cheers
</I>&gt;&gt;<i> Amos
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;<i> squid-users mailing list
</I>&gt;&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i>
</I>-- 
Dott. Matteo Savatteri

Responsabile Ufficio Piattaforme Tecnologiche
Direzione Servizio Bibliotecario di Ateneo
Universit&#224; degli Studi di Milano

Indirizzo: Via Santa Sofia, 9 20122 MILANO (MI)
Tel. ufficio: 02503 12227
Email: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">Matteo.Savatteri at unimi.it</A>


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="025689.html">[squid-users] Access based on auth and referer
</A></li>
	<LI>Next message (by thread): <A HREF="025690.html">[squid-users] client-&gt;Squid: TCP [RST] and [RST,ACK]
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25705">[ date ]</a>
              <a href="thread.html#25705">[ thread ]</a>
              <a href="subject.html#25705">[ subject ]</a>
              <a href="author.html#25705">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
