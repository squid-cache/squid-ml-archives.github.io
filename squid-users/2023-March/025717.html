<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid use all memory ram
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20use%20all%20memory%20ram&In-Reply-To=%3CCAL34ib%3Dp%2BoCMWHqRk%3DKbrRjz9wG63p1-vi4Lvvgq3nDQXcaz7Q%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="025718.html">
   <LINK REL="Next"  HREF="025719.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid use all memory ram</H1>
    <B>Hamilton Coutinho</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20use%20all%20memory%20ram&In-Reply-To=%3CCAL34ib%3Dp%2BoCMWHqRk%3DKbrRjz9wG63p1-vi4Lvvgq3nDQXcaz7Q%40mail.gmail.com%3E"
       TITLE="[squid-users] Squid use all memory ram">hamilton.coutinho at gmail.com
       </A><BR>
    <I>Fri Mar 24 02:28:28 UTC 2023</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="025718.html">[squid-users] squid 5.7 Bad request from parent cache after squid -k reconfigure
</A></li>
        <LI>Next message (by thread): <A HREF="025719.html">[squid-users] squid-users Digest, Vol 103, Issue 21
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25717">[ date ]</a>
              <a href="thread.html#25717">[ thread ]</a>
              <a href="subject.html#25717">[ subject ]</a>
              <a href="author.html#25717">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>We are still chasing this one down but made a major breakthrough. The leak
is related to squid in intercept mode + SSL decryption + origin with
invalid certs. In our case, the majority of the cases were related to
Windows Update and Windows Defender domains, so a stopgap solution is to
bypass decryption for these sites (eg, .update.microsoft.com). If you do,
don't use dstdomain ACL, as the domain is not available at the time of the
checking. Use something like ssl::server_name[_regex].

Hope this helps!

On Fri, Jan 27, 2023 at 2:28&#8239;PM Gustavo Carvalho &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">gustavocarv4872 at gmail.com</A>&gt;
wrote:

&gt;<i> Hi Hamilton, thanks for helping!
</I>&gt;<i>
</I>&gt;<i> I wish I could provide this log while squid is crashing, but there
</I>&gt;<i> have been no incidents since wednesday. From what I've heard, the RAM
</I>&gt;<i> on that server's VM has been increased to 32GB.
</I>&gt;<i>
</I>&gt;<i> Anyway, here is the squidclient mgr:mem log output. I hope it can be
</I>&gt;<i> helpful.
</I>&gt;<i>
</I>&gt;<i> On Thu, Jan 26, 2023 at 5:43 PM Hamilton Coutinho
</I>&gt;<i> &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">hamilton.coutinho at gmail.com</A>&gt; wrote:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Hi Gustavo,
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I'm seeing the same thing. I could narrow down (but can't say with 100%
</I>&gt;<i> confidence) to the code that does certificate verification when configured
</I>&gt;<i> for SSL decryption. What is the output of squidclient mgr:mem for you? Do
</I>&gt;<i> you see unexplainably high counts for in-use objects like HttpRequest,
</I>&gt;<i> PeekingPeerConnector, Comm::Connection, Security::ErrorDetail?
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; On Thu, Jan 26, 2023 at 12:31 PM Gustavo Carvalho &lt;
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">gustavocarv4872 at gmail.com</A>&gt; wrote:
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; Hi,
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; I have Squid 5.6 on a FreeBSD 13.1 server with 16GB RAM
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; I noticed that squid starts to consume a lot of ram until it starts to
</I>&gt;<i> &gt;&gt; consume swap space. When this happens, browsing becomes extremely
</I>&gt;<i> &gt;&gt; slow.
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; This is happening at least once a week when I have to restart squid to
</I>&gt;<i> &gt;&gt; get it back to normal.
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; Any ideas?
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; ############# Wed Jan 25 08:30:00 -03 2023 #############
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; HTTP/1.1 200 OK
</I>&gt;<i> &gt;&gt; Server: squid
</I>&gt;<i> &gt;&gt; Mime-Version: 1.0
</I>&gt;<i> &gt;&gt; Date: Wed, 25 Jan 2023 11:30:00 GMT
</I>&gt;<i> &gt;&gt; Content-Type: text/plain;charset=utf-8
</I>&gt;<i> &gt;&gt; Expires: Wed, 25 Jan 2023 11:30:00 GMT
</I>&gt;<i> &gt;&gt; Last-Modified: Wed, 25 Jan 2023 11:30:00 GMT
</I>&gt;<i> &gt;&gt; X-Cache: MISS from xxxx.xxxx.xxxx
</I>&gt;<i> &gt;&gt; X-Cache-Lookup: MISS from xxxx.xxxx.xxxx:3128
</I>&gt;<i> &gt;&gt; Via: 1.1 xxxx.xxxx.xxxx (squid)
</I>&gt;<i> &gt;&gt; Connection: close
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; Squid Object Cache: Version 5.6
</I>&gt;<i> &gt;&gt; Build Info:
</I>&gt;<i> &gt;&gt; Service Name: squid
</I>&gt;<i> &gt;&gt; Start Time: Thu, 19 Jan 2023 20:25:17 GMT
</I>&gt;<i> &gt;&gt; Current Time: Wed, 25 Jan 2023 11:30:00 GMT
</I>&gt;<i> &gt;&gt; Connection information for squid:
</I>&gt;<i> &gt;&gt;      Number of clients accessing cache: 224
</I>&gt;<i> &gt;&gt;      Number of HTTP requests received: 7541590
</I>&gt;<i> &gt;&gt;      Number of ICP messages received: 0
</I>&gt;<i> &gt;&gt;      Number of ICP messages sent: 0
</I>&gt;<i> &gt;&gt;      Number of queued ICP replies: 0
</I>&gt;<i> &gt;&gt;      Number of HTCP messages received: 0
</I>&gt;<i> &gt;&gt;      Number of HTCP messages sent: 0
</I>&gt;<i> &gt;&gt;      Request failure ratio: 0.00
</I>&gt;<i> &gt;&gt;      Average HTTP requests per minute since start: 930.5
</I>&gt;<i> &gt;&gt;      Average ICP messages per minute since start: 0.0
</I>&gt;<i> &gt;&gt;      Select loop called: 78733524 times, 6.176 ms avg
</I>&gt;<i> &gt;&gt; Cache information for squid:
</I>&gt;<i> &gt;&gt;      Hits as % of all requests: 5min: 8.4%, 60min: 12.1%
</I>&gt;<i> &gt;&gt;      Hits as % of bytes sent: 5min: 21.6%, 60min: 14.1%
</I>&gt;<i> &gt;&gt;      Memory hits as % of hit requests: 5min: 90.8%, 60min: 75.9%
</I>&gt;<i> &gt;&gt;      Disk hits as % of hit requests: 5min: 4.0%, 60min: 19.7%
</I>&gt;<i> &gt;&gt;      Storage Swap size: 2829956 KB
</I>&gt;<i> &gt;&gt;      Storage Swap capacity: 90.0% used, 10.0% free
</I>&gt;<i> &gt;&gt;      Storage Mem size: 16172 KB
</I>&gt;<i> &gt;&gt;      Storage Mem capacity: 98.7% used,  1.3% free
</I>&gt;<i> &gt;&gt;      Mean Object Size: 28.95 KB
</I>&gt;<i> &gt;&gt;      Requests given to unlinkd: 186982
</I>&gt;<i> &gt;&gt; Median Service Times (seconds)  5 min    60 min:
</I>&gt;<i> &gt;&gt; HTTP Requests (All):   0.00562  0.01847
</I>&gt;<i> &gt;&gt;      Cache Misses:          0.15048  0.23230
</I>&gt;<i> &gt;&gt;      Cache Hits:            0.00000  0.00000
</I>&gt;<i> &gt;&gt;      Near Hits:             0.14252  0.13498
</I>&gt;<i> &gt;&gt;      Not-Modified Replies:  0.00865  0.03066
</I>&gt;<i> &gt;&gt;      DNS Lookups:           0.00000  0.00372
</I>&gt;<i> &gt;&gt;      ICP Queries:           0.00000  0.00000
</I>&gt;<i> &gt;&gt; Resource usage for squid:
</I>&gt;<i> &gt;&gt;      UP Time: 486282.612 seconds
</I>&gt;<i> &gt;&gt;      CPU Time: 65555.712 seconds
</I>&gt;<i> &gt;&gt;      CPU Usage: 13.48%
</I>&gt;<i> &gt;&gt;      CPU Usage, 5 minute avg: 26.89%
</I>&gt;<i> &gt;&gt;      CPU Usage, 60 minute avg: 68.00%
</I>&gt;<i> &gt;&gt;      Maximum Resident Size: 37896960 KB
</I>&gt;<i> &gt;&gt;      Page faults with physical i/o: 10843
</I>&gt;<i> &gt;&gt; Memory accounted for:
</I>&gt;<i> &gt;&gt;      Total accounted:       -1459461 KB
</I>&gt;<i> &gt;&gt;      memPoolAlloc calls:     11408
</I>&gt;<i> &gt;&gt;      memPoolFree calls:  1888969689
</I>&gt;<i> &gt;&gt; File descriptor usage for squid:
</I>&gt;<i> &gt;&gt;      Maximum number of file descriptors:   4096
</I>&gt;<i> &gt;&gt;      Largest file desc currently in use:   2149
</I>&gt;<i> &gt;&gt;      Number of file desc currently in use:  679
</I>&gt;<i> &gt;&gt;      Files queued for open:                   0
</I>&gt;<i> &gt;&gt;      Available number of file descriptors: 3417
</I>&gt;<i> &gt;&gt;      Reserved number of file descriptors:   100
</I>&gt;<i> &gt;&gt;      Store Disk files open:                   0
</I>&gt;<i> &gt;&gt; Internal Data Structures:
</I>&gt;<i> &gt;&gt;      97906 StoreEntries
</I>&gt;<i> &gt;&gt;      3002 StoreEntries with MemObjects
</I>&gt;<i> &gt;&gt;      2838 Hot Object Cache Items
</I>&gt;<i> &gt;&gt;      97742 on-disk objects
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; ------ pfctl -si ------
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; Status: Enabled for 25 days 22:58:24          Debug: Urgent
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; State Table                          Total             Rate
</I>&gt;<i> &gt;&gt;   current entries                     8085
</I>&gt;<i> &gt;&gt;   searches                      6650475717         2965.4/s
</I>&gt;<i> &gt;&gt;   inserts                        133521957           59.5/s
</I>&gt;<i> &gt;&gt;   removals                       133552376           59.5/s
</I>&gt;<i> &gt;&gt; Counters
</I>&gt;<i> &gt;&gt;   match                          605960865          270.2/s
</I>&gt;<i> &gt;&gt;   bad-offset                             0            0.0/s
</I>&gt;<i> &gt;&gt;   fragment                               1            0.0/s
</I>&gt;<i> &gt;&gt;   short                                 54            0.0/s
</I>&gt;<i> &gt;&gt;   normalize                            659            0.0/s
</I>&gt;<i> &gt;&gt;   memory                                 0            0.0/s
</I>&gt;<i> &gt;&gt;   bad-timestamp                          0            0.0/s
</I>&gt;<i> &gt;&gt;   congestion                             0            0.0/s
</I>&gt;<i> &gt;&gt;   ip-option                              0            0.0/s
</I>&gt;<i> &gt;&gt;   proto-cksum                            0            0.0/s
</I>&gt;<i> &gt;&gt;   state-mismatch                    104674            0.0/s
</I>&gt;<i> &gt;&gt;   state-insert                       38501            0.0/s
</I>&gt;<i> &gt;&gt;   state-limit                            0            0.0/s
</I>&gt;<i> &gt;&gt;   src-limit                              0            0.0/s
</I>&gt;<i> &gt;&gt;   synproxy                               0            0.0/s
</I>&gt;<i> &gt;&gt;   map-failed                             0            0.0/s
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; ------ sysctl -a | grep swap  ------
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; swap_pager: out of swap space
</I>&gt;<i> &gt;&gt; swp_pager_getswapspace(32): failed
</I>&gt;<i> &gt;&gt; swap_pager: out of swap space
</I>&gt;<i> &gt;&gt; swp_pager_getswapspace(31): failed
</I>&gt;<i> &gt;&gt; swap_pager: out of swap space
</I>&gt;<i> &gt;&gt; swp_pager_getswapspace(1): failed
</I>&gt;<i> &gt;&gt; 1 PART da0p2 2147483648 512 i 2 o 544768 ty freebsd-swap xs GPT xt
</I>&gt;<i> &gt;&gt; 516e7cb5-6ecf-11d6-8ff8-00022d09712b
</I>&gt;<i> &gt;&gt; 0 MD md1 94371840 512 u 1 s 512 f 0 fs 0 l 94371840 t swap label
</I>&gt;<i> &gt;&gt; 0 MD md0 62914560 512 u 0 s 512 f 0 fs 0 l 62914560 t swap label
</I>&gt;<i> &gt;&gt; z0xfffff80003ec5800 [shape=box,label=&quot;SWAP\nswap\nr#3&quot;];
</I>&gt;<i> &gt;&gt;       &lt;name&gt;swap&lt;/name&gt;
</I>&gt;<i> &gt;&gt;     &lt;type&gt;swap&lt;/type&gt;
</I>&gt;<i> &gt;&gt;     &lt;type&gt;swap&lt;/type&gt;
</I>&gt;<i> &gt;&gt;     &lt;type&gt;freebsd-swap&lt;/type&gt;
</I>&gt;<i> &gt;&gt; vm.swap_enabled: 1
</I>&gt;<i> &gt;&gt; vm.domain.0.stats.unswappable: 2044
</I>&gt;<i> &gt;&gt; vm.swap_idle_threshold2: 10
</I>&gt;<i> &gt;&gt; vm.swap_idle_threshold1: 2
</I>&gt;<i> &gt;&gt; vm.swap_idle_enabled: 0
</I>&gt;<i> &gt;&gt; vm.disable_swapspace_pageouts: 0
</I>&gt;<i> &gt;&gt; vm.stats.vm.v_swappgsout: 3154299
</I>&gt;<i> &gt;&gt; vm.stats.vm.v_swappgsin: 510404
</I>&gt;<i> &gt;&gt; vm.stats.vm.v_swapout: 174446
</I>&gt;<i> &gt;&gt; vm.stats.vm.v_swapin: 62590
</I>&gt;<i> &gt;&gt; vm.stats.swap.free_completed: 54375
</I>&gt;<i> &gt;&gt; vm.stats.swap.free_deferred: 56992
</I>&gt;<i> &gt;&gt; vm.nswapdev: 1
</I>&gt;<i> &gt;&gt; vm.swap_fragmentation:
</I>&gt;<i> &gt;&gt; vm.swap_async_max: 4
</I>&gt;<i> &gt;&gt; vm.swap_maxpages: 32572800
</I>&gt;<i> &gt;&gt; vm.swap_total: 2147483648
</I>&gt;<i> &gt;&gt; vm.swap_reserved: 384676114432
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; ------ /usr/sbin/swapinfo -h  ------
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; Device              Size     Used    Avail Capacity
</I>&gt;<i> &gt;&gt; /dev/da0p2          2.0G     2.0G     8.0K   100%
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; ############# squid.conf #############
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; http_port 3128 ssl-bump generate-host-certificates=on
</I>&gt;<i> &gt;&gt; dynamic_cert_mem_cache_size=20MB cert=/xxxx/conf/certs/ca.crt
</I>&gt;<i> &gt;&gt; key=/xxxx/conf/certs/ca.key
</I>&gt;<i> &gt;&gt; http_port 3129 intercept
</I>&gt;<i> &gt;&gt; https_port 3130 intercept ssl-bump generate-host-certificates=on
</I>&gt;<i> &gt;&gt; dynamic_cert_mem_cache_size=20MB cert=/xxxx/conf/certs/ca.crt
</I>&gt;<i> &gt;&gt; key=/xxxx/conf/certs/ca.key
</I>&gt;<i> &gt;&gt; visible_hostname xxxx.xxxx.xxxx
</I>&gt;<i> &gt;&gt; max_filedescriptors 4096
</I>&gt;<i> &gt;&gt; maximum_object_size 4096 KB
</I>&gt;<i> &gt;&gt; minimum_object_size 0 KB
</I>&gt;<i> &gt;&gt; maximum_object_size_in_memory 256 KB
</I>&gt;<i> &gt;&gt; fqdncache_size 1024
</I>&gt;<i> &gt;&gt; cache_mgr <A HREF="https://lists.squid-cache.org/listinfo/squid-users">xxxx at xxxx</A>
</I>&gt;<i> &gt;&gt; dns_nameservers 127.0.0.1
</I>&gt;<i> &gt;&gt; cache_replacement_policy                heap LFUDA
</I>&gt;<i> &gt;&gt; memory_replacement_policy               heap GDSF
</I>&gt;<i> &gt;&gt; cache_mem 16 MB
</I>&gt;<i> &gt;&gt; cache_dir               ufs /xxxx/chroot/osproxy/cache 3072 32 256
</I>&gt;<i> &gt;&gt; forwarded_for on
</I>&gt;<i> &gt;&gt; memory_pools off
</I>&gt;<i> &gt;&gt; logformat xxxx %ts|%6tr|%&gt;a|%Ss|%03&gt;Hs|%&lt;st|%rm|%un|%mt|%ea|%ru
</I>&gt;<i> &gt;&gt; logfile_rotate 0
</I>&gt;<i> &gt;&gt; httpd_suppress_version_string on
</I>&gt;<i> &gt;&gt; strip_query_terms off
</I>&gt;<i> &gt;&gt; _______________________________________________
</I>&gt;<i> &gt;&gt; squid-users mailing list
</I>&gt;<i> &gt;&gt; <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> &gt;&gt; <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; --
</I>&gt;<i> &gt; Hamilton
</I>&gt;<i> &gt; _______________________________________________
</I>&gt;<i> &gt; squid-users mailing list
</I>&gt;<i> &gt; <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> &gt; <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i>
</I>

-- 
Hamilton
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20230323/6cd7f60e/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20230323/6cd7f60e/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="025718.html">[squid-users] squid 5.7 Bad request from parent cache after squid -k reconfigure
</A></li>
	<LI>Next message (by thread): <A HREF="025719.html">[squid-users] squid-users Digest, Vol 103, Issue 21
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25717">[ date ]</a>
              <a href="thread.html#25717">[ thread ]</a>
              <a href="subject.html#25717">[ subject ]</a>
              <a href="author.html#25717">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
