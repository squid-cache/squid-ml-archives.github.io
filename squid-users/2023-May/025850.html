<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Proxy server to support a large number of simultaneous requests
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Proxy%20server%20to%20support%20a%20large%20number%20of%0A%20simultaneous%20requests&In-Reply-To=%3C4f506ba3-c1aa-feab-8cbd-8b86861364c9%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="025849.html">
   <LINK REL="Next"  HREF="025852.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Proxy server to support a large number of simultaneous requests</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Proxy%20server%20to%20support%20a%20large%20number%20of%0A%20simultaneous%20requests&In-Reply-To=%3C4f506ba3-c1aa-feab-8cbd-8b86861364c9%40measurement-factory.com%3E"
       TITLE="[squid-users] Proxy server to support a large number of simultaneous requests">rousskov at measurement-factory.com
       </A><BR>
    <I>Mon May 29 20:16:35 UTC 2023</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="025849.html">[squid-users] Proxy server to support a large number of simultaneous requests
</A></li>
        <LI>Next message (by thread): <A HREF="025852.html">[squid-users] Proxy server to support a large number of simultaneous requests
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25850">[ date ]</a>
              <a href="thread.html#25850">[ thread ]</a>
              <a href="subject.html#25850">[ subject ]</a>
              <a href="author.html#25850">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 5/29/23 10:43, Andrey K wrote:

&gt;<i> We need to configure a dedicated proxy server to provide caching of 
</I>&gt;<i> online video broadcasts in order to reduce the load on the uplink proxy.
</I>&gt;<i> Hundreds of users will access the same video-chunks simultaneously.
</I>&gt;<i> 
</I>&gt;<i> I developed a simple configuration for the test purposes (it is shown 
</I>&gt;<i> below).
</I>&gt;<i> The *collapsed_forwarding*&#160;option is on.
</I>
Do you get close to 100% hit ratio if clients access these URLs 
sequentially rather than concurrently? If not, then focus on that 
problem before you open the collapsed forwarding Pandora box.

What is your Squid version? Older Squids have more collapsed forwarding 
bugs than newer ones. I recommend testing with Squid v6 or master/v7, at 
least to confirm that the problem is still present in the latest 
official code.

How much RAM does your server have? You are using default 256MB memory 
cache (cache_mem). If you have spare memory, make your memory cache much 
larger: A rock cache_dir cannot (yet) share the response _while_ the 
response is being written to disk, so relying on cache_dir too much will 
decrease your hit ratio, especially in a collapsed forwarding environment.

Is your Squid built with --enable-delay-pools? If yes, TCP_MISS does not 
necessarily mean a cache miss (an old Squid bug), even if you do not use 
any delay pools.

Since you are trying to cache objects lager than 512KB, see 
maximum_object_size_in_memory.

Consider making your test much longer (more sequential requests per 
client/curl worker), to see whether the cache becomes &quot;stable&quot; after one 
of the first transactions manages to fully cache the response. This may 
not help with older Squids, but might help with newer ones. However, you 
should not test using real origin servers (that you do not control)!


&gt;<i> Could you clarify if this behavior of my squid is 
</I>&gt;<i> a bug/misconfiguration, or if I'm running into server performance
</I>&gt;<i> limitations (squid is running on a VM with 22 cores)?
</I>
Most likely, reduction of hit ratio with increase of concurrency is 
_not_ a performance limitation.


HTH,

Alex.


&gt;<i> I selected a couple of cacheable resources in the internet for testing:
</I>&gt;<i>  &#160;- small size (~400 KB): 
</I>&gt;<i> <A HREF="https://ia800406.us.archive.org/13/items/romeo-y-julieta-texto-completo/Romeo%20y%20Julieta%20-%20William%20Shakespeare.pdf">https://ia800406.us.archive.org/13/items/romeo-y-julieta-texto-completo/Romeo%20y%20Julieta%20-%20William%20Shakespeare.pdf</A> &lt;<A HREF="https://ia800406.us.archive.org/13/items/romeo-y-julieta-texto-completo/Romeo%20y%20Julieta%20-%20William%20Shakespeare.pdf">https://ia800406.us.archive.org/13/items/romeo-y-julieta-texto-completo/Romeo%20y%20Julieta%20-%20William%20Shakespeare.pdf</A>&gt;
</I>&gt;<i>  &#160;- large (~8 MB): 
</I>&gt;<i> <A HREF="https://ia600601.us.archive.org/10/items/Linux-Journal-2015-01/Linux-Journal-2015-01.pdf">https://ia600601.us.archive.org/10/items/Linux-Journal-2015-01/Linux-Journal-2015-01.pdf</A> &lt;<A HREF="https://ia600601.us.archive.org/10/items/Linux-Journal-2015-01/Linux-Journal-2015-01.pdf">https://ia600601.us.archive.org/10/items/Linux-Journal-2015-01/Linux-Journal-2015-01.pdf</A>&gt;
</I>&gt;<i> To test simultaneous connections I am forking curl using a simple script 
</I>&gt;<i> (it is also shown below).
</I>&gt;<i> 
</I>&gt;<i> When I run a test (500 curl threads to 
</I>&gt;<i> <A HREF="https://ia800406.us.archive.org/13/items/romeo-y-julieta-texto-completo/Romeo%20y%20Julieta%20-%20William%20Shakespeare.pdf">https://ia800406.us.archive.org/13/items/romeo-y-julieta-texto-completo/Romeo%20y%20Julieta%20-%20William%20Shakespeare.pdf</A> &lt;<A HREF="https://ia800406.us.archive.org/13/items/romeo-y-julieta-texto-completo/Romeo%20y%20Julieta%20-%20William%20Shakespeare.pdf">https://ia800406.us.archive.org/13/items/romeo-y-julieta-texto-completo/Romeo%20y%20Julieta%20-%20William%20Shakespeare.pdf</A>&gt;) I see lots of&#160;TCP_MISS/200 with&#160;FIRSTUP_PARENT/parent_proxy records in the logs.
</I>&gt;<i> 
</I>&gt;<i> A simple analysis shows&#160;a low percentage of cache hits:
</I>&gt;<i> cat /var/log/squid.user/access.log| grep '2023-05-29 14' | grep pdf &#160;| 
</I>&gt;<i> awk '{print $5&quot; &quot; $10}' | sort | uniq -c
</I>&gt;<i>  &#160; &#160; &#160;24 TCP_CF_MISS/200/- HIER_NONE/-
</I>&gt;<i>  &#160; &#160; 457 TCP_MISS/200/200 FIRSTUP_PARENT/parent_proxy
</I>&gt;<i>  &#160; &#160; &#160;10 TCP_MISS/200/- HIER_NONE/-
</I>&gt;<i>  &#160; &#160; &#160; 9 TCP_SWAPFAIL_MISS/200/200 FIRSTUP_PARENT/parent_proxy
</I>&gt;<i> 
</I>&gt;<i> So the Hit ratio is about (500-457-9)*100/500=6.8%
</I>&gt;<i> 
</I>&gt;<i> Almost the same situation we see when run 200 threads:
</I>&gt;<i> cat /var/log/squid.user/access.log| grep '2023-05-29 15:45' | grep pdf 
</I>&gt;<i>  &#160;| awk '{print $5&quot; &quot; $10}' | sort | uniq -c
</I>&gt;<i>  &#160; &#160; &#160; 4 TCP_CF_MISS/200/- HIER_NONE/-
</I>&gt;<i>  &#160; &#160; 140 TCP_MISS/200/200 FIRSTUP_PARENT/parent_proxy
</I>&gt;<i>  &#160; &#160; &#160;40 TCP_MISS/200/- HIER_NONE/-
</I>&gt;<i>  &#160; &#160; &#160;16 TCP_SWAPFAIL_MISS/200/200 FIRSTUP_PARENT/parent_proxy
</I>&gt;<i> 
</I>&gt;<i> This time the Hit ratio is about (200-140-16)*100/500=21%
</I>&gt;<i> 
</I>&gt;<i> With 50 threads the Hit ratio is 90%:
</I>&gt;<i> cat /var/log/squid.user/access.log| grep '2023-05-29 15:50' | grep pdf 
</I>&gt;<i>  &#160;| awk '{print $5&quot; &quot; $10}' | sort | uniq -c
</I>&gt;<i>  &#160; &#160; &#160;27 TCP_CF_MISS/200/- HIER_NONE/-
</I>&gt;<i>  &#160; &#160; &#160; 1 TCP_MISS/200/200 FIRSTUP_PARENT/parent_proxy
</I>&gt;<i>  &#160; &#160; &#160;18 TCP_MISS/200/- HIER_NONE/-
</I>&gt;<i>  &#160; &#160; &#160; 4 TCP_SWAPFAIL_MISS/200/200 FIRSTUP_PARENT/parent_proxy
</I>&gt;<i> 
</I>&gt;<i> I thought that it should always be near 99% - only the first request to 
</I>&gt;<i> an URL should be forwarded to the parent proxy and all subsequent 
</I>&gt;<i> requests should be served from the cache.
</I>&gt;<i> 
</I>&gt;<i> The situation is even worse with downloading a large file:
</I>&gt;<i> 500 threads (0.4%):
</I>&gt;<i> cat /var/log/squid.user/access.log| grep '2023-05-29 17:2' | grep pdf &#160;| 
</I>&gt;<i> awk '{print $5&quot; &quot; $10}' | sort | uniq -c
</I>&gt;<i>  &#160; &#160; &#160;10 TCP_CF_MISS/200/200 FIRSTUP_PARENT/parent_proxy
</I>&gt;<i>  &#160; &#160; &#160; 2 TCP_CF_MISS/200/- HIER_NONE/-
</I>&gt;<i>  &#160; &#160; 488 TCP_MISS/200/200 FIRSTUP_PARENT/parent_proxy
</I>&gt;<i> 
</I>&gt;<i> 200 threads (3%):
</I>&gt;<i> cat /var/log/squid.user/access.log| grep '2023-05-29 17:3' | grep pdf &#160;| 
</I>&gt;<i> awk '{print $5&quot; &quot; $10}' | sort | uniq -c
</I>&gt;<i>  &#160; &#160; &#160; 9 TCP_CF_MISS/200/200 FIRSTUP_PARENT/parent_proxy
</I>&gt;<i>  &#160; &#160; &#160; 6 TCP_CF_MISS/200/- HIER_NONE/-
</I>&gt;<i>  &#160; &#160; 180 TCP_MISS/200/200 FIRSTUP_PARENT/parent_proxy
</I>&gt;<i>  &#160; &#160; &#160; 5 TCP_SWAPFAIL_MISS/200/200 FIRSTUP_PARENT/parent_proxy
</I>&gt;<i> 
</I>&gt;<i> 50 threads (98%):
</I>&gt;<i> cat /var/log/squid.user/access.log| grep '2023-05-29 17:36' | grep pdf 
</I>&gt;<i>  &#160;| awk '{print $5&quot; &quot; $10}' | sort | uniq -c
</I>&gt;<i>  &#160; &#160; &#160;25 TCP_CF_HIT/200/- HIER_NONE/-
</I>&gt;<i>  &#160; &#160; &#160;12 TCP_CF_MISS/200/- HIER_NONE/-
</I>&gt;<i>  &#160; &#160; &#160;12 TCP_HIT/200/- HIER_NONE/-
</I>&gt;<i>  &#160; &#160; &#160; 1 TCP_MISS/200/200 FIRSTUP_PARENT/parent_proxy
</I>&gt;<i> 
</I>&gt;<i> Could you clarify if this behavior of my squid is a 
</I>&gt;<i> bug/misconfiguration, or if I'm running into server performance 
</I>&gt;<i> limitations (squid is running on a VM with 22 cores)?
</I>&gt;<i> 
</I>&gt;<i> Kind regards,
</I>&gt;<i>  &#160; &#160; &#160;Ankor
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> *squid.conf:*
</I>&gt;<i> workers 21
</I>&gt;<i> 
</I>&gt;<i> sslcrtd_program /data/squid.user/usr/lib/squid/security_file_certgen -s 
</I>&gt;<i> /data/squid.user/var/lib/squid/ssl_db -M 20MB
</I>&gt;<i> sslcrtd_children 21
</I>&gt;<i> 
</I>&gt;<i> logformat extended-squid %{%Y-%m-%d %H:%M:%S}tl| %6tr %&gt;a 
</I>&gt;<i> %Ss/%03&gt;Hs/%&lt;Hs %&lt;st %rm %ru %un %Sh/%&lt;A %mt %ea
</I>&gt;<i> 
</I>&gt;<i> logfile_rotate 0
</I>&gt;<i> access_log daemon:/var/log/squid.user/access.log 
</I>&gt;<i> logformat=extended-squid on-error=drop
</I>&gt;<i> 
</I>&gt;<i> cache_peer parent_proxy &#160;parent 3128 0
</I>&gt;<i> never_direct allow all
</I>&gt;<i> 
</I>&gt;<i> cachemgr_passwd pass config
</I>&gt;<i> 
</I>&gt;<i> acl PURGE method PURGE
</I>&gt;<i> http_access allow PURGE
</I>&gt;<i> 
</I>&gt;<i> http_access allow all
</I>&gt;<i> 
</I>&gt;<i> http_port 3131 ssl-bump generate-host-certificates=on 
</I>&gt;<i> dynamic_cert_mem_cache_size=20MB 
</I>&gt;<i> tls-cert=/etc/squid.user/sslbump/bump.crt 
</I>&gt;<i> tls-key=/etc/squid.user/sslbump/bump.key
</I>&gt;<i> sslproxy_cert_error allow all
</I>&gt;<i> 
</I>&gt;<i> acl step1 at_step SslBump1
</I>&gt;<i> acl step2 at_step SslBump2
</I>&gt;<i> acl step3 at_step SslBump3
</I>&gt;<i> 
</I>&gt;<i> ssl_bump peek step1
</I>&gt;<i> ssl_bump bump step2
</I>&gt;<i> ssl_bump bump step3
</I>&gt;<i> 
</I>&gt;<i> cache_dir rock /data/squid.user/cache 20000 max-size=12000000
</I>&gt;<i> cache_swap_low 85
</I>&gt;<i> cache_swap_high 90
</I>&gt;<i> 
</I>&gt;<i> *collapsed_forwarding on*
</I>&gt;<i> 
</I>&gt;<i> pinger_enable off
</I>&gt;<i> max_filedesc 8192
</I>&gt;<i> shutdown_lifetime 5 seconds
</I>&gt;<i> netdb_filename none
</I>&gt;<i> log_icp_queries off
</I>&gt;<i> client_request_buffer_max_size 100 MB
</I>&gt;<i> 
</I>&gt;<i> via off
</I>&gt;<i> forwarded_for delete
</I>&gt;<i> 
</I>&gt;<i> coredump_dir /data/squid.user/var/cache/squid
</I>&gt;<i> 
</I>&gt;<i> *curl_forker.sh:*
</I>&gt;<i> #!/bin/sh
</I>&gt;<i> N=100
</I>&gt;<i> URL=<A HREF="https://ia600601.us.archive.org/10/items/Linux-Journal-2015-01/Linux-Journal-2015-01.pdf">https://ia600601.us.archive.org/10/items/Linux-Journal-2015-01/Linux-Journal-2015-01.pdf</A> &lt;<A HREF="https://ia600601.us.archive.org/10/items/Linux-Journal-2015-01/Linux-Journal-2015-01.pdf">https://ia600601.us.archive.org/10/items/Linux-Journal-2015-01/Linux-Journal-2015-01.pdf</A>&gt;
</I>&gt;<i> 
</I>&gt;<i> if [[ &#160;-n $1 &amp;&amp; &#160;$1 =~ help$ &#160;]];
</I>&gt;<i> then
</I>&gt;<i>  &#160; &#160;echo &quot;Usage: $0 [&lt;cnt&gt;] [&lt;url&gt;]&quot;
</I>&gt;<i>  &#160; &#160;echo
</I>&gt;<i>  &#160; &#160;echo &quot;Example: $0 10 
</I>&gt;<i> <A HREF="https://ia600601.us.archive.org/10/items/Linux-Journal-2015-01/Linux-Journal-2015-01.pdf">https://ia600601.us.archive.org/10/items/Linux-Journal-2015-01/Linux-Journal-2015-01.pdf</A> &lt;<A HREF="https://ia600601.us.archive.org/10/items/Linux-Journal-2015-01/Linux-Journal-2015-01.pdf">https://ia600601.us.archive.org/10/items/Linux-Journal-2015-01/Linux-Journal-2015-01.pdf</A>&gt;&quot;;
</I>&gt;<i>  &#160; &#160;echo
</I>&gt;<i>  &#160; &#160;exit;
</I>&gt;<i> fi
</I>&gt;<i> 
</I>&gt;<i> while [[ $# -gt 0 ]]
</I>&gt;<i> do
</I>&gt;<i>  &#160; if [[ $1 =~ ^[0-9]+$ ]]
</I>&gt;<i>  &#160; then
</I>&gt;<i>  &#160; &#160; &#160;N=$1
</I>&gt;<i>  &#160; else
</I>&gt;<i>  &#160; &#160; &#160;URL=$1
</I>&gt;<i>  &#160; fi
</I>&gt;<i>  &#160; shift
</I>&gt;<i> done
</I>&gt;<i> 
</I>&gt;<i> echo $URL
</I>&gt;<i> echo $N threads
</I>&gt;<i> 
</I>&gt;<i> for i in `seq $N`
</I>&gt;<i> do
</I>&gt;<i>  &#160; nohup curl --tlsv1.2 -k &#160; --proxy 0001vsg01:3131 &#160;-v $URL &#160;&gt;/dev/null 
</I>&gt;<i>  &#160;2&gt;&amp;1 &amp;
</I>&gt;<i> done
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="025849.html">[squid-users] Proxy server to support a large number of simultaneous requests
</A></li>
	<LI>Next message (by thread): <A HREF="025852.html">[squid-users] Proxy server to support a large number of simultaneous requests
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25850">[ date ]</a>
              <a href="thread.html#25850">[ thread ]</a>
              <a href="subject.html#25850">[ subject ]</a>
              <a href="author.html#25850">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
