<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] host_verify_check behaviour in intercept mode for domain behind Loadbalancer ( multiple IPs )
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20host_verify_check%20behaviour%20in%20intercept%20mode%20for%0A%20domain%20behind%20Loadbalancer%20%28%20multiple%20IPs%20%29&In-Reply-To=%3CCALpWAcqK0VzXvJ5J8606hy70MJc944jt22H%3DTo5S%3DkFXkPAAYg%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="025839.html">
   <LINK REL="Next"  HREF="025840.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] host_verify_check behaviour in intercept mode for domain behind Loadbalancer ( multiple IPs )</H1>
    <B>sachin gupta</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20host_verify_check%20behaviour%20in%20intercept%20mode%20for%0A%20domain%20behind%20Loadbalancer%20%28%20multiple%20IPs%20%29&In-Reply-To=%3CCALpWAcqK0VzXvJ5J8606hy70MJc944jt22H%3DTo5S%3DkFXkPAAYg%40mail.gmail.com%3E"
       TITLE="[squid-users] host_verify_check behaviour in intercept mode for domain behind Loadbalancer ( multiple IPs )">sachin1.g at gmail.com
       </A><BR>
    <I>Tue May 30 11:22:23 UTC 2023</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="025839.html">[squid-users] host_verify_check behaviour in intercept mode for domain behind Loadbalancer ( multiple IPs )
</A></li>
        <LI>Next message (by thread): <A HREF="025840.html">[squid-users] cache_peer round robin
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25851">[ date ]</a>
              <a href="thread.html#25851">[ thread ]</a>
              <a href="subject.html#25851">[ subject ]</a>
              <a href="author.html#25851">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi

I am sorry to come back late on it. I had applied patch and my previous
logs were overwritten. Reproduced it today with amazon url (
monitoring.us-west-2.amazonaws.com:443 )


&gt;&gt;<i> Please clarify &quot;things&quot; and &quot;did not work&quot;.
</I>
We are getting 409. For example this if or one on amazon url cache.log
output

2023/05/30 10:38:04.703 kid5| 78,8| dns_internal.cc(1126)
idnsCallbackAllCallersWithNewAnswer: last 1 records

2023/05/30 10:38:04.703 kid5| 1,5| CodeContext.cc(60) Entering: master203

2023/05/30 10:38:04.703 kid5| 78,6| dns_internal.cc(1104)
idnsCallbackOneWithAnswer: last 1 records for 0x556b994c6f68

2023/05/30 10:38:04.704 kid5| 14,3| ipcache.cc(477) ipcacheParse: 1 answers
for monitoring.us-west-2.amazonaws.com

2023/05/30 10:38:04.704 kid5| 14,7| ipcache.cc(985) have:  no 52.94.176.210
in [no cached IPs]

2023/05/30 10:38:04.704 kid5| 14,7| ipcache.cc(985) have:  no 52.94.176.210
in [no cached IPs]

2023/05/30 10:38:04.704 kid5| 14,3| ipcache.cc(532) addGood:
monitoring.us-west-2.amazonaws.com #1 52.94.176.210

2023/05/30 10:38:04.704 kid5| 14,7| ipcache.cc(250) forwardIp: 52.94.176.210

2023/05/30 10:38:04.704 kid5| 14,3| ipcache.cc(576) ipcacheHandleReply:
done with monitoring.us-west-2.amazonaws.com: 52.94.176.210 #1/1-0

2023/05/30 10:38:04.704 kid5| 14,7| ipcache.cc(231) finalCallback:
0x556b994c6f88 lookup_wait=1

2023/05/30 10:38:04.704 kid5| 78,7| HttpRequest.cc(595) recordLookup:
0x556b994c6570 lookup_wait=1

2023/05/30 10:38:04.704 kid5| 14,7| ipcache.cc(985) have:  no
52.94.184.173:443 in 52.94.176.210 #1/1-0

2023/05/30 10:38:04.704 kid5| 85,3| client_side_request.cc(538)
hostHeaderIpVerify: FAIL: validate IP 52.94.184.173:443 possible from Host:

2023/05/30 10:38:04.704 kid5| SECURITY ALERT: Host header forgery detected
on conn616 local=52.94.184.173:443 remote=10.32.79.33:58260 FD 28 flags=17
(local IP does not match any domain IP)

    current master transaction: master203

2023/05/30 10:38:04.704 kid5| SECURITY ALERT: on URL:
monitoring.us-west-2.amazonaws.com:443

    current master transaction: master203

2023/05/30 10:38:04.704 kid5| 20,3| store.cc(769) storeCreatePureEntry:
storeCreateEntry: 'monitoring.us-west-2.amazonaws.com:443'

2023/05/30 10:38:04.704 kid5| 20,5| store.cc(349) StoreEntry: StoreEntry
constructed, this=0x556b994f0200

2023/05/30 10:38:04.704 kid5| 19,9| stmem.cc(376) mem_hdr: 0x556b994ef648
hi: 0

2023/05/30 10:38:04.704 kid5| 20,3| MemObject.cc(100) MemObject: MemObject
constructed, this=0x556b994ef620

2023/05/30 10:38:04.704 kid5| 55,7| HttpHeader.cc(155) HttpHeader: init-ing
hdr: 0x556b994ef788 owner: 3

2023/05/30 10:38:04.704 kid5| 55,9| HttpHeader.cc(829) getList:
0x556b994ef788 joining for id Connection[12]

2023/05/30 10:38:04.704 kid5| 55,9| HttpHeader.cc(829) getList:
0x556b994ef788 joining for id Proxy-Connection[50]

2023/05/30 10:38:04.704 kid5| 55,9| HttpHeader.cc(1009) has: 0x556b994ef788
lookup for Expires[27]

2023/05/30 10:38:04.704 kid5| 88,3| MemObject.cc(83) setUris:
0x556b994ef620 storeId: monitoring.us-west-2.amazonaws.com:443

2023/05/30 10:38:04.704 kid5| 20,3| store.cc(443) lock: storeCreateEntry
locked key [null_store_key] e:=V/0x556b994f0200*1

2023/05/30 10:38:04.704 kid5| 20,3| store.cc(569) setPrivateKey: 01
e:=V/0x556b994f0200*1

2023/05/30 10:38:04.704 kid5| 20,3| store.cc(421) hashInsert:
StoreEntry::hashInsert: Inserting Entry e:=XIV/0x556b994f0200*1 key
'0C000000000000003400000005000000'

2023/05/30 10:38:04.704 kid5| 4,4| errorpage.cc(717) errorAppendEntry:
storing ERR_CONFLICT_HOST in e:=XIV/0x556b994f0200*1

2023/05/30 10:38:04.704 kid5| 55,7| HttpHeader.cc(155) HttpHeader: init-ing
hdr: 0x556b994ef8b8 owner: 3

2023/05/30 10:38:04.704 kid5| 55,9| HttpHeader.cc(829) getList:
0x556b994ef8b8 joining for id Connection[12]

2023/05/30 10:38:04.704 kid5| 55,9| HttpHeader.cc(829) getList:
0x556b994ef8b8 joining for id Proxy-Connection[50]

2023/05/30 10:38:04.704 kid5| 55,9| HttpHeader.cc(1009) has: 0x556b994ef8b8
lookup for Expires[27]

2023/05/30 10:38:04.704 kid5| 55,9| HttpHeader.cc(829) getList:
0x556b994c6588 joining for id Accept-Language[3]

2023/05/30 10:38:04.704 kid5| 4,2| errorpage.cc(1386) buildBody: No
existing error page language negotiated for ERR_CONFLICT_HOST. Using
default error file.


Regards
Sachin


On Tue, May 16, 2023 at 7:33&#8239;PM Amos Jeffries &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt; wrote:

&gt;<i> On 16/05/2023 6:52 pm, sachin gupta wrote:
</I>&gt;<i> &gt; Hi
</I>&gt;<i> &gt; We recently shifted to squid 5.9 and started seeing errors in
</I>&gt;<i> &gt; Transparent mode SECURITY ALERT: Host header forgery detected on
</I>&gt;<i> &gt; conn3615903 local=44.242.184.237:443 &lt;<A HREF="http://44.242.184.237:443">http://44.242.184.237:443</A>&gt;
</I>&gt;<i> &gt; remote=10.109.176.240:8990 &lt;<A HREF="http://10.109.176.240:8990">http://10.109.176.240:8990</A>&gt; FD 28029
</I>&gt;<i> &gt; flags=17 (local IP does not match any domain IP)
</I>&gt;<i>
</I>&gt;<i> This is not a error, it is a alert to what is going on. The client
</I>&gt;<i> 10.109.176.240 is trying to connect to 44.242.184.237 requesting a
</I>&gt;<i> domain which DNS says is **not** hosted there.
</I>&gt;<i>
</I>&gt;<i> What happens next depends on what Squid is able to do given the
</I>&gt;<i> transaction type.
</I>&gt;<i> Some are rejected as unable to continue, some are allowed to complete
</I>&gt;<i> under restricted handling.
</I>&gt;<i>
</I>&gt;<i> &gt; Previously we were using
</I>&gt;<i> &gt; <A HREF="https://github.com/NethServer/dev/issues/5348.">https://github.com/NethServer/dev/issues/5348.</A> In addition we are
</I>&gt;<i> &gt; using client_dst_passthru off. When building 5.9, the patch was not
</I>&gt;<i> &gt; applied cleanly and we wanted to check if things worked without this
</I>&gt;<i> &gt; patch. They did not work.
</I>&gt;<i>
</I>&gt;<i> Please clarify &quot;things&quot; and &quot;did not work&quot;.
</I>&gt;<i>
</I>&gt;<i> &gt; I did check the forum responses
</I>&gt;<i> &gt; <A HREF="https://wiki.squid-cache.org/KnowledgeBase/HostHeaderForgery.">https://wiki.squid-cache.org/KnowledgeBase/HostHeaderForgery.</A> and
</I>&gt;<i> &gt; <A HREF="https://docs.diladele.com/faq/squid/host_header_forgery.html.">https://docs.diladele.com/faq/squid/host_header_forgery.html.</A> We
</I>&gt;<i> &gt; already support explicit proxy but that is not always an option. We
</I>&gt;<i> &gt; can create another patch to circumvent issues like ***. But I wanted
</I>&gt;<i> &gt; to know if there is a plan to make this check optional or there is
</I>&gt;<i> &gt; some way we can workaround this problem without changing the code.
</I>&gt;<i> &gt; Without this support, how can intercept mode work for any website
</I>&gt;<i> &gt; which is behind a loadbalancer with multiple IPs.
</I>&gt;<i>
</I>&gt;<i> More recent version of Squid allow some more CONNECT traffic cases be
</I>&gt;<i> handled instead of rejected.
</I>&gt;<i> There are also some ideas on further improvements, but those are a long
</I>&gt;<i> way off.
</I>&gt;<i>
</I>&gt;<i> Cheers
</I>&gt;<i> Amos
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20230530/95d4ce92/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20230530/95d4ce92/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="025839.html">[squid-users] host_verify_check behaviour in intercept mode for domain behind Loadbalancer ( multiple IPs )
</A></li>
	<LI>Next message (by thread): <A HREF="025840.html">[squid-users] cache_peer round robin
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#25851">[ date ]</a>
              <a href="thread.html#25851">[ thread ]</a>
              <a href="subject.html#25851">[ subject ]</a>
              <a href="author.html#25851">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
