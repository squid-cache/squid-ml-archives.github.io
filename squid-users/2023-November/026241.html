<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Get IP of denied request
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Get%20IP%20of%20denied%20request&In-Reply-To=%3C9eebab85-2b64-4ec6-b656-16fabc4ac0f8%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   
   <LINK REL="Next"  HREF="026242.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Get IP of denied request</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Get%20IP%20of%20denied%20request&In-Reply-To=%3C9eebab85-2b64-4ec6-b656-16fabc4ac0f8%40measurement-factory.com%3E"
       TITLE="[squid-users] Get IP of denied request">rousskov at measurement-factory.com
       </A><BR>
    <I>Wed Nov  1 20:39:20 UTC 2023</I>
    <P><UL>
        
        <LI>Next message (by thread): <A HREF="026242.html">[squid-users] Cache NTLM Authenticaion
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26241">[ date ]</a>
              <a href="thread.html#26241">[ thread ]</a>
              <a href="subject.html#26241">[ subject ]</a>
              <a href="author.html#26241">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 2023-10-30 13:08, <A HREF="https://lists.squid-cache.org/listinfo/squid-users">magri at web.de</A> wrote:
&gt;<i> Am 27.10.23 um 16:22 schrieb Alex Rousskov:
</I>&gt;&gt;<i> 1. Enhance Squid to resolve transaction destination address once (on
</I>&gt;&gt;<i> first use/need). Remember/reuse resolved IP addresses. Log them via some
</I>&gt;&gt;<i> new %resolved_dst and %dst_resolution_detail codes.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> This improvement will help address a few use cases unrelated to this
</I>&gt;&gt;<i> discussion, but it will _not_ tell you which of the resolved addresses
</I>&gt;&gt;<i> actually matched which ACL. You will be able to guess in many cases, but
</I>&gt;&gt;<i> there will be exceptions.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> 2. Add a Squid feature where an evaluated ACL can be configured to
</I>&gt;&gt;<i> annotate the transaction with the information about that evaluation.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> To start with, we can support annotations for _matched_ dst ACLs. For
</I>&gt;&gt;<i> example:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &#160;&#160;&#160;&#160; # When matches, sets the following master transaction annotations:
</I>&gt;&gt;<i> &#160;&#160;&#160;&#160; # * badDestination_input: used destination address (IP or name)
</I>&gt;&gt;<i> &#160;&#160;&#160;&#160; # * badDestination_match: the matched destination IP
</I>&gt;&gt;<i> &#160;&#160;&#160;&#160; # * badDestination_value: the matched ACL parameter value
</I>&gt;&gt;<i> &#160;&#160;&#160;&#160; # * badDestination_ips: resolved destination IP(s)
</I>&gt;&gt;<i> &#160;&#160;&#160;&#160; # * badDestination_errors: DNS resolution and other error(s)
</I>&gt;&gt;<i> &#160;&#160;&#160;&#160; # * badDestination_matches: number of matches (this transaction)
</I>&gt;&gt;<i> &#160;&#160;&#160;&#160; # * badDestination_evals: number of evaluations (this transaction)
</I>&gt;&gt;<i> &#160;&#160;&#160;&#160; acl badDestination dst --on-match=annotate 127.0.0.0/24 10.0.0.1
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> If the same ACL matches more than once, the last(?) match wins, but the
</I>&gt;&gt;<i> aclfoo_matches annotation can be used to detect these cases. The
</I>&gt;&gt;<i> aclfoo_evals annotation can be used to detect whether this ACL was
</I>&gt;&gt;<i> &quot;reached&quot; at all.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> If really needed, we can support turning individual annotations on and
</I>&gt;&gt;<i> off, but I doubt that complexity is worth associated performance
</I>&gt;&gt;<i> savings. After all, most ACLs will only match once per transaction
</I>&gt;&gt;<i> lifetime (for correctly written configurations). Access.log will be
</I>&gt;&gt;<i> configured to only log annotations of interest to the admin, of course.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The above approach can be extended to provide ACL debugging aid:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &#160;&#160;&#160;&#160; # Dumps every mismatch information to cache.log at level 1
</I>&gt;&gt;<i> &#160;&#160;&#160;&#160; acl goodDestination dst --on-mismatch=log 127.0.0.0/24
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &#160;&#160;&#160;&#160; # Dumps every evaluation information to cache.log at level 1
</I>&gt;&gt;<i> &#160;&#160;&#160;&#160; acl redDestination dst --on-eval=log 127.0.0.0/24
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> 3. Add a Squid feature where Squid (optionally) maintains an internal
</I>&gt;&gt;<i> database of recent ACL evaluation history and makes that information
</I>&gt;&gt;<i> accessible via cache manager queries like &quot;which ACLs matched
</I>&gt;&gt;<i> transaction X?&quot; (where X is logged %master_xaction ID).
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The three sketched options are not mutually exclusive, of course. All
</I>&gt;&gt;<i> require non-trivial code changes.
</I>


&gt;<i> Let me first ask some questions for clarification:
</I>&gt;<i> - Does squid cache all ips from dns responses with multiple ips or only
</I>&gt;<i> the one it uses for the request?
</I>
All.


&gt;<i> - If it caches more than one ip - does squid use more than one of these
</I>&gt;<i> ips (e.g. as fallback or round robin) inside a single transaction or for
</I>&gt;<i> multiple transactions?
</I>
A single transaction will go through several single-name IPs after 
certain transaction failures, but not all failures are treated the same.

Multiple transactions may use multiple single-name IPs due to 
round-robin rotation of cached IPs and other factors.


&gt;<i> Supposing squid uses only a single dst ip inside a single transaction,
</I>&gt;<i> your first option would be sufficient for our purpose!
</I>
In my first option, logged %resolved_dst (and the corresponding master 
transaction metadata) may contain multiple IPs (i.e. all resolved ones). 
AFAICT, if any one of those IPs match a &quot;dst&quot; ACL address, then that 
&quot;dst&quot; ACL should match, even if the transaction does not actually use 
the matched address: The &quot;dst&quot; ACL matches based on request-target info, 
not the _use_ of that info.

One of the difficulties here is to decide whether a transaction should 
wait for both IPv4 and IPv6 addresses to be resolved:

If a transaction proceeds with one family of addresses, then there will 
be no delays associated with waiting for the second one. However, in 
that case, Squid may declare a &quot;dst&quot; ACL mismatch even though there 
would have been a match if we waited for the second DNS answer! It feels 
like for correctness sake, we must wait if a &quot;dst&quot; ACL needs checking or 
a similar decision has to be made...


&gt;<i> Resolving the ip only once and storing it inside the transaction would
</I>&gt;<i> also avoid ambiguous cases where different ips could theoretically be
</I>&gt;<i> used in different acls or worse in acls and the real connection.
</I>
Yes, that is one of the positive side effects of that option.


&gt;<i> It could also improve the performance of acl evaluation because after
</I>&gt;<i> the resolution of the dst ip all following dst acls would be evaluated
</I>&gt;<i> fast(?).
</I>
A speedup is possible in some corner cases, but, in most cases, there 
will be no difference in this area because &quot;all following dst ACLs&quot; 
should &quot;immediately&quot; use _cached_ IP(s) in the current code AFAICT.


&gt;<i> Your second option sounds really nice for debugging purposes but IMHO
</I>&gt;<i> these annotations should be optional because even if the performance
</I>&gt;<i> penalty may(?) be neglectable they increase the size of the transaction
</I>&gt;<i> object and this could accumulate if many acls are in use.
</I>&gt;<i> Hence I would propose this as optional extension to the first option.
</I>
Yes, the second feature is optional (and orthogonal): If one does not 
add &quot;--on-match=annotate&quot; to a &quot;dst&quot; ACL declaration, then they do not 
get those annotations (and their overheads).


&gt;<i> Your third option seems not feasible for us, because the delay between a
</I>&gt;<i> failed request and reporting of the failure often takes more than a day.
</I>&gt;<i> The needed history would be quite excessive (with over 80 million
</I>&gt;<i> requests a day).
</I>
Agreed.

Alex.



&gt;&gt;&gt;&gt;&gt;<i> Is there any way to get the ip logged that was used in the dst-acl
</I>&gt;&gt;&gt;&gt;&gt;<i> aside
</I>&gt;&gt;&gt;&gt;&gt;<i> from debug logging? Maybe through some annotation mechanism?
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> Squid version is 6.2, as 6.4 crashes with assertion errors here, too.
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> thanks,
</I>&gt;&gt;&gt;&gt;&gt;<i> Martin
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;<i> squid-users mailing list
</I>&gt;&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">https://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">https://lists.squid-cache.org/listinfo/squid-users</A>
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	
	<LI>Next message (by thread): <A HREF="026242.html">[squid-users] Cache NTLM Authenticaion
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26241">[ date ]</a>
              <a href="thread.html#26241">[ thread ]</a>
              <a href="subject.html#26241">[ subject ]</a>
              <a href="author.html#26241">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
