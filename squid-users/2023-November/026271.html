<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] 6.x gives frequent connection to peer failed - spurious?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%206.x%20gives%20frequent%20connection%20to%20peer%20failed%20-%0A%20spurious%3F&In-Reply-To=%3Cfc40c8a1-e988-40c9-82db-bd70426f6c99%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="026266.html">
   <LINK REL="Next"  HREF="026274.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] 6.x gives frequent connection to peer failed - spurious?</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%206.x%20gives%20frequent%20connection%20to%20peer%20failed%20-%0A%20spurious%3F&In-Reply-To=%3Cfc40c8a1-e988-40c9-82db-bd70426f6c99%40measurement-factory.com%3E"
       TITLE="[squid-users] 6.x gives frequent connection to peer failed - spurious?">rousskov at measurement-factory.com
       </A><BR>
    <I>Wed Nov 15 21:55:54 UTC 2023</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="026266.html">[squid-users] 6.x gives frequent connection to peer failed - spurious?
</A></li>
        <LI>Next message (by thread): <A HREF="026274.html">[squid-users] 6.x gives frequent connection to peer failed - spurious?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26271">[ date ]</a>
              <a href="thread.html#26271">[ thread ]</a>
              <a href="subject.html#26271">[ subject ]</a>
              <a href="author.html#26271">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 2023-11-10 05:46, Stephen Borrill wrote:

&gt;<i> With 6.x (currently 6.5) there are very frequent (every 10 seconds or 
</I>&gt;<i> so) messages like:
</I>&gt;<i> 2023/11/10 10:25:43 kid1| ERROR: Connection to 127.0.0.1:8123 failed
</I>

 &gt; why is this logged as a connection failure

The current error wording is too assuming and, in your case, evidently 
misleading. The phrase &quot;Connection to X failed&quot; should be changed to 
something more general like &quot;Cannot contact cache_peer X&quot; or &quot;Cannot 
communicate with cache_peer X&quot;.

CachePeer::countFailure() patches welcome.


 &gt; do I need to worry about it beyond it filing up the logs needlessly?

In short, &quot;yes&quot;.

I cannot accurately assess your specific needs, but, in most 
environments, one should indeed worry that their cache_peer server names 
cannot be reliably resolved because failed resolution attempts waste 
Squid resources and increase transaction response time. Moreover, if 
these failures are frequent enough (relative to peer usage attempts), 
the affected cache_peer will be marked as DEAD (as you have mentioned):

 &gt; 2023/11/09 08:55:22 kid1| Detected DEAD Parent: 127.0.0.1:8123


HTH,

Alex.



&gt;<i> 
</I>&gt;<i> With 4.x there were no such messages.
</I>&gt;<i> 
</I>&gt;<i> By comparing to the peer squid logs, these seems to tally with DNS 
</I>&gt;<i> failures:
</I>&gt;<i> peer_select.cc(479) resolveSelected: PeerSelector1688 found all 0 
</I>&gt;<i> destinations for bugzilla.tucasi.com:443
</I>&gt;<i> 
</I>&gt;<i> Full ALL,2 log at the time of the reported connection failure:
</I>&gt;<i> 
</I>&gt;<i> 2023/11/10 10:25:43.162 kid1| 5,2| TcpAcceptor.cc(214) doAccept: New 
</I>&gt;<i> connection on FD 17
</I>&gt;<i> 2023/11/10 10:25:43.162 kid1| 5,2| TcpAcceptor.cc(316) acceptNext: 
</I>&gt;<i> connection on conn3 local=127.0.0.1:8123 remote=[::] FD 17 flags=9
</I>&gt;<i> 2023/11/10 10:25:43.162 kid1| 11,2| client_side.cc(1332) 
</I>&gt;<i> parseHttpRequest: HTTP Client conn13206 local=127.0.0.1:8123 
</I>&gt;<i> remote=127.0.0.1:57843 FD 147 flags=1
</I>&gt;<i> 2023/11/10 10:25:43.162 kid1| 11,2| client_side.cc(1336) 
</I>&gt;<i> parseHttpRequest: HTTP Client REQUEST:
</I>&gt;<i> 2023/11/10 10:25:43.162 kid1| 85,2| client_side_request.cc(707) 
</I>&gt;<i> clientAccessCheckDone: The request CONNECT bugzilla.tucasi.com:443 is 
</I>&gt;<i> ALLOWED; last ACL checked: localhost
</I>&gt;<i> 2023/11/10 10:25:43.162 kid1| 85,2| client_side_request.cc(683) 
</I>&gt;<i> clientAccessCheck2: No adapted_http_access configuration. default: ALLOW
</I>&gt;<i> 2023/11/10 10:25:43.162 kid1| 85,2| client_side_request.cc(707) 
</I>&gt;<i> clientAccessCheckDone: The request CONNECT bugzilla.tucasi.com:443 is 
</I>&gt;<i> ALLOWED; last ACL checked: localhost
</I>&gt;<i> 2023/11/10 10:25:43.162 kid1| 44,2| peer_select.cc(460) resolveSelected: 
</I>&gt;<i> Find IP destination for: bugzilla.tucasi.com:443' via bugzilla.tucasi.com
</I>&gt;<i> 2023/11/10 10:25:43.163 kid1| 44,2| peer_select.cc(479) resolveSelected: 
</I>&gt;<i> PeerSelector1526 found all 0 destinations for bugzilla.tucasi.com:443
</I>&gt;<i> 2023/11/10 10:25:43.163 kid1| 44,2| peer_select.cc(480) resolveSelected: 
</I>&gt;<i>  &#160; always_direct = ALLOWED
</I>&gt;<i> 2023/11/10 10:25:43.163 kid1| 44,2| peer_select.cc(481) resolveSelected: 
</I>&gt;<i>  &#160;&#160; never_direct = DENIED
</I>&gt;<i> 2023/11/10 10:25:43.163 kid1| 44,2| peer_select.cc(482) resolveSelected: 
</I>&gt;<i>  &#160;&#160;&#160;&#160;&#160;&#160; timedout = 0
</I>&gt;<i> 2023/11/10 10:25:43.163 kid1| 4,2| errorpage.cc(1397) buildBody: No 
</I>&gt;<i> existing error page language negotiated for ERR_DNS_FAIL. Using default 
</I>&gt;<i> error file.
</I>&gt;<i> 2023/11/10 10:25:43.163 kid1| 33,2| client_side.cc(617) swanSong: 
</I>&gt;<i> conn13206 local=127.0.0.1:8123 remote=127.0.0.1:57843 flags=1
</I>&gt;<i> 
</I>&gt;<i> If my analysis is correct why is this logged as a connection failure and 
</I>&gt;<i> do I need to worry about it beyond it filing up the logs needlessly?
</I>&gt;<i> 
</I>&gt;<i> My concern is that this could lead to the parent being incorrectly 
</I>&gt;<i> declared DEAD thus impacting other traffic:
</I>&gt;<i> 
</I>&gt;<i> 2023/11/09 08:55:22 kid1| Detected DEAD Parent: 127.0.0.1:8123
</I>&gt;<i>  &#160;&#160;&#160; current master transaction: master4581234
</I>&gt;<i> 
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="026266.html">[squid-users] 6.x gives frequent connection to peer failed - spurious?
</A></li>
	<LI>Next message (by thread): <A HREF="026274.html">[squid-users] 6.x gives frequent connection to peer failed - spurious?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26271">[ date ]</a>
              <a href="thread.html#26271">[ thread ]</a>
              <a href="subject.html#26271">[ subject ]</a>
              <a href="author.html#26271">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
