<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Transparent HTTPS Squid proxy does not work!
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Transparent%20HTTPS%20Squid%20proxy%20does%20not%20work%21&In-Reply-To=%3Cd3ac9ced-5528-495d-a050-383678650b74%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="026205.html">
   <LINK REL="Next"  HREF="026209.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Transparent HTTPS Squid proxy does not work!</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Transparent%20HTTPS%20Squid%20proxy%20does%20not%20work%21&In-Reply-To=%3Cd3ac9ced-5528-495d-a050-383678650b74%40treenet.co.nz%3E"
       TITLE="[squid-users] Transparent HTTPS Squid proxy does not work!">squid3 at treenet.co.nz
       </A><BR>
    <I>Mon Oct 16 19:35:20 UTC 2023</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="026205.html">[squid-users] Transparent HTTPS Squid proxy does not work!
</A></li>
        <LI>Next message (by thread): <A HREF="026209.html">[squid-users] external IP from DB
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26206">[ date ]</a>
              <a href="thread.html#26206">[ thread ]</a>
              <a href="subject.html#26206">[ subject ]</a>
              <a href="author.html#26206">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>
I think your problem is the NAT table rules. You are missing some 
critical exceptions to let squid make the outbound tunnels.


On 17/10/23 07:51, Bud Miljkovic wrote:
&gt;<i> Let me try one more time.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Here is my system configuration:
</I>&gt;<i> 
</I>&gt;<i> {HW-Box} --&gt; Local Server{ (eth0[port 444]) -----+
</I>&gt;<i>                                                                          
</I>&gt;<i>  &#160; &#160;&#160; |
</I>&gt;<i>  &#160; &#160; &#160; &#160; &#160; +-----------------------------------------------------+
</I>&gt;<i>  &#160; &#160; &#160; &#160; &#160; |
</I>&gt;<i>  &#160; &#160; &#160; &#160; &#160; |
</I>&gt;<i>  &#160; &#160; &#160; &#160; &#160; +-----&gt; ([3129] Transparent Squid proxy) ---&gt; (eth1[port443]) 
</I>&gt;<i> }--+
</I>&gt;<i>                                                                          
</I>&gt;<i>  &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;&#160; &#160; &#160; &#160; &#160;&#160; |
</I>&gt;<i>                                      
</I>&gt;<i>  &#160;+------------------------------------------------------- ---+
</I>&gt;<i>  &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;|
</I>&gt;<i>  &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;+-&gt;--{ INTERNET Server }
</I>&gt;<i> 
</I>&gt;<i> The setup and the problem:
</I>&gt;<i>  &#160; &#160;- The HW box tries to establish an HTTPS transparent connection with 
</I>&gt;<i> a server located within Internet.
</I>&gt;<i> 
</I>
Drop the word &quot;transparent&quot; from this thinking. It is a connection.


&gt;<i>  &#160; &#160;- It uses the Local Server and send its request via eth0 interface.
</I>&gt;<i> 
</I>&gt;<i>  &#160; &#160;- The request is Pre-routed from eth0, port 443, to the Transparent 
</I>&gt;<i> Squid proxy (v3.5.25), listening at port 3129.
</I>&gt;<i> 
</I>
Correction. NAT'ed, not &quot;routed&quot;.  The distinction is important and 
impacts which type of configuration will work and which will guarantee 
errors.

  * NAT is only working when performed on the machine running Squid.

  * &quot;routed&quot; can be done from a remote machine to the Squid machine. But 
does need additional NAT or TPROXY on the Squid machine.


&gt;<i>  &#160; &#160;- For testing purposes, the Squid proxy is configured to pass only 
</I>&gt;<i> the HTTPS traffic transparently via the eth1 interface, using sing the 
</I>&gt;<i> `tcp_outgoing_address &lt;ip_addr&gt;` directive.&#160; Please see the 
</I>&gt;<i> squid-ota.conf file content below.
</I>

To be clear FTR; Squid *cannot* guarantee a particular interface. Only 
the OS can decide that.

Your Squid is setting the TCP src-IP on outbound packets as a *Hint* 
(albeit a strong one) for the OS to use in its routing choices.


&gt;<i> 
</I>&gt;<i>  &#160; &#160;- While testing, I am monitoring the eth1 output via tcpdump and I 
</I>&gt;<i> get the following:
</I>&gt;<i> 
</I>&gt;<i>  &#160; &#160; &#160;# tcpdump -i eth1 port 443 -n -X -q -w tcp_dump_24
</I>&gt;<i>  &#160; &#160; &#160; &#160;tcpdump: listening on eth1, link-type EN10MB (Ethernet), capture 
</I>&gt;<i> size 262144 bytes
</I>&gt;<i>  &#160; &#160; &#160; &#160;0 packets captured
</I>&gt;<i>  &#160; &#160; &#160; &#160;1 packet received by filter
</I>&gt;<i>  &#160; &#160; &#160; &#160;0 packets dropped by kernel
</I>&gt;<i>  &#160; &#160; &#160; &#160;3 packets dropped by interface
</I>&gt;<i> 
</I>&gt;<i>  &#160; &#160;- But nothing is detected!?
</I>&gt;<i> 
</I>
Nod.

FWIW, I have had mixed success with tcpdump when NAT and MASQUERADE are 
happening on the machine. It plugs in at the lowest layer somewhere 
around the point packets are actually going to/from the network. So 
packets with internal temporary values in them may not show up in the dump.

When NAT, MASQUERADE and routing are manipulating things the iptables 
packet counters seem to be a lot more reliable indicator of what traffic 
is (not) going through, even if the dump shows less than expected.



&gt;<i>  &#160; &#160;- From the above it appears that there is no eth1 output at port 443?
</I>&gt;<i> 
</I>
Possibly. Maybe.


&gt;<i> I have included the printouts of the `iptables -nvL` and `iptables -nvL 
</I>&gt;<i> -t nat` commands.
</I>&gt;<i> 
</I>&gt;<i> Can someone tell me what I have done wrong here and perhaps suggest a 
</I>&gt;<i> solution?
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Cheers,
</I>&gt;<i> Bud
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> =========================
</I>&gt;<i> Squid configuration file:
</I>&gt;<i> 
</I>&gt;<i> # 1) Visible hostname
</I>&gt;<i> visible_hostname ctct-r2
</I>&gt;<i> 
</I>&gt;<i> # 2) Initialize SSL database first
</I>&gt;<i> sslcrtd_program /usr/libexec/ssl_crtd -s /var/lib/ssl_db -M 4MB
</I>&gt;<i> 
</I>&gt;<i> # 3) Listen to incoming HTTP traffic
</I>&gt;<i> http_port 3128
</I>&gt;<i> 
</I>&gt;<i> # 4) Block all HTTP traffic
</I>&gt;<i> http_access deny all
</I>

Ah, This will block the CONNECT tunnels.

&quot;CONNECT&quot; is an HTTP request method. This (4) rule will both reject the 
CONNECT tunnel being handled, and/or will prevent the &quot;splice&quot; action 
from being allowed to pass it through Squid in its form as a &quot;CONNECT&quot; 
message.


Please keep the basic security rules (http_access deny ...) provided in 
the default squid.conf for your version. You can see them at 
&lt;<A HREF="https://wiki.squid-cache.org/Releases/Squid-3.5#squid-35-default-config">https://wiki.squid-cache.org/Releases/Squid-3.5#squid-35-default-config</A>&gt;

The rules you have for your local policy should go after the line 
&quot;INSERT YOUR OWN RULE(S) HERE&quot;.

  You may remove the existing &quot;http_access allow ...&quot; lines as needed if 
you do not want them to happen.


&gt;<i> 
</I>&gt;<i> # 5) Listen for incoming HTTPS traffic and intercept it
</I>&gt;<i> https_port 3129 intercept ssl-bump cert=/etc/squid/ssl_cert/myCA.pem 
</I>&gt;<i> generate-host-certificates=on dynamic_cert_mem_cache_size=4MB
</I>&gt;<i> 
</I>&gt;<i> # 6) Pass the SSL (HTTPS) traffic trasparently throught
</I>&gt;<i> ssl_bump splice all
</I>&gt;<i> 
</I>&gt;<i> # Do not use caching
</I>&gt;<i> # cache_dir ufs /var/volatile/log/squid/logs 100 16 256
</I>&gt;<i> 
</I>&gt;<i> # 7) Send out all HTTPS traffic to destination server via given IP address
</I>&gt;<i> tcp_outgoing_address 10.3.19.92
</I>&gt;<i> 
</I>
Again this is not limited to one protocol (HTTPS). **All** TCP outgoing 
packets from your Squid will use this regardless of their protocol.



&gt;<i> =====================================================
</I>&gt;<i> iptables -nvL -t nat
</I>&gt;<i> 
</I>&gt;<i> Chain PREROUTING (policy ACCEPT 1234K packets, 306M bytes)
</I>&gt;<i>  &#160;pkts bytes target &#160; &#160; prot opt in &#160; &#160; out &#160; &#160; source               
</I>&gt;<i> destination
</I>&gt;<i>  &#160; &#160;96 &#160;5760 REDIRECT &#160; tcp &#160;-- &#160;eth0 &#160; * 0.0.0.0/0 
</I>&gt;<i> 0.0.0.0/0 &#160; &#160; &#160; &#160; &#160; &#160;tcp dpt:443 redir ports 3129
</I>&gt;<i> 13943 &#160;837K REDIRECT &#160; tcp &#160;-- &#160;eth0 &#160; * 0.0.0.0/0 
</I>&gt;<i> 0.0.0.0/0 &#160; &#160; &#160; &#160; &#160; &#160;tcp dpt:80 redir ports 3128
</I>&gt;<i> 
</I>
Per &lt;<A HREF="https://wiki.squid-cache.org/ConfigExamples/Intercept/LinuxRedirect">https://wiki.squid-cache.org/ConfigExamples/Intercept/LinuxRedirect</A>&gt;

This table should contain an ACCEPT for Squid outbound connections 
before the REDIRECT. Like so:


   iptables -t nat -A PREROUTING -s $SQUIDIP -p tcp --dport 80 -j ACCEPT
   iptables -t nat -A PREROUTING -s $SQUIDIP -p tcp --dport 443 -j ACCEPT

   iptables -t nat -A PREROUTING -p tcp --dport 80 -j REDIRECT ...
   iptables -t nat -A PREROUTING -p tcp --dport 443 -j REDIRECT ...


You do not list the &quot;mangle&quot; table. But check that you have the rule 
there protecting the port as well:

   iptables -t mangle -A PREROUTING -p tcp --dport $SQUIDPORT -j DROP



HTH
Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="026205.html">[squid-users] Transparent HTTPS Squid proxy does not work!
</A></li>
	<LI>Next message (by thread): <A HREF="026209.html">[squid-users] external IP from DB
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26206">[ date ]</a>
              <a href="thread.html#26206">[ thread ]</a>
              <a href="subject.html#26206">[ subject ]</a>
              <a href="author.html#26206">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
