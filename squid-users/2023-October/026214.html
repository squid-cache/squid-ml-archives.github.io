<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Spliced domains tunnel connect is very slow
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Spliced%20domains%20tunnel%20connect%20is%20very%20slow&In-Reply-To=%3Cbdddff9c-bcc5-4805-b614-747bfd2dcbc3%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="026211.html">
   <LINK REL="Next"  HREF="026215.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Spliced domains tunnel connect is very slow</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Spliced%20domains%20tunnel%20connect%20is%20very%20slow&In-Reply-To=%3Cbdddff9c-bcc5-4805-b614-747bfd2dcbc3%40treenet.co.nz%3E"
       TITLE="[squid-users] Spliced domains tunnel connect is very slow">squid3 at treenet.co.nz
       </A><BR>
    <I>Fri Oct 20 03:27:00 UTC 2023</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="026211.html">[squid-users] Spliced domains tunnel connect is very slow
</A></li>
        <LI>Next message (by thread): <A HREF="026215.html">[squid-users] Spliced domains tunnel connect is very slow
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26214">[ date ]</a>
              <a href="thread.html#26214">[ thread ]</a>
              <a href="subject.html#26214">[ subject ]</a>
              <a href="author.html#26214">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 19/10/23 01:21, Ben Goz wrote:
&gt;<i> By the help of God.
</I>&gt;<i> 
</I>&gt;<i> Hi,
</I>&gt;<i> I saw in my access log a traces that shows that spliced URLs tunneling 
</I>&gt;<i> is very slowly:
</I>
Please clarify what you mean by &quot;slow&quot; ?

  How have you determined speed ?
  What speed are you expecting / would you call non-slow ?



FYI, Several things to be aware of:

  1) CONNECT tunnel is not a simple thing with a constant &quot;speed&quot; of 
transfer. It represents and entire set of tunneled messages (or other 
opaque data) over indefinite timespan. Each of those messages has its 
own &quot;speed&quot; of transfer, with possible empty periods of 0 bytes 
transferred between.

  2) the SSL-Bump procedure may pause a CONNECT tunnel during TLS 
handshake and/or validation process to asynchronously fetch missing 
certificate details, and/or validate other data with ACLs, etc.
   Each of these subsidiary transactions may add indefinite effects on 
timing of the 'bumped' CONNECT tunnel.

  3) modern networking systems utilize &quot;Happy Eyeballs&quot; algorithms 
wherein they may open multiple TCP connections to various (or same) 
services in parallel and only utilize the fastest to connect. This can 
result in CONNECT tunnel being initiated and unused - either closed 
immediately or left open waiting activity for long periods.


So, as you should be able to see the log snippet shows some details 
about tunnels duration of use, you cannot tell &quot;speed&quot; from these logs.


For example:
&gt;<i> 
</I>&gt;<i> 18/Oct/2023:15:18:50 +0300 240841 192.168.3.98 TCP_TUNNEL/200 6225 
</I>&gt;<i> CONNECT beacons2.gvt2.com:443 &lt;<A HREF="http://beacons2.gvt2.com:443">http://beacons2.gvt2.com:443</A>&gt; - 
</I>&gt;<i> HIER_DIRECT/172.217.0.67 &lt;<A HREF="http://172.217.0.67">http://172.217.0.67</A>&gt; - beacons2.gvt2.com 
</I>&gt;<i> &lt;<A HREF="http://beacons2.gvt2.com">http://beacons2.gvt2.com</A>&gt; - splice -
</I>

Tunnel was _open_ for 240 seconds. 6225 bytes transferred.

Those bytes may have been transferred in the first 1 milliseconds of the 
tunnel being open. Then Squid leaving it open waiting for further uses 
which never came.

... &quot;slow&quot; at 1.4 GB/sec.

  ... or it could have been &quot;slow&quot; at 10 bytes/sec the whole time. One 
cannot tell.


&gt;<i> 18/Oct/2023:15:18:50 +0300 &#160; &#160;680 192.168.3.173 TCP_TUNNEL/500 4977 
</I>&gt;<i> CONNECT mobile.events.data.microsoft.com:443 
</I>&gt;<i> &lt;<A HREF="http://mobile.events.data.microsoft.com:443">http://mobile.events.data.microsoft.com:443</A>&gt; - HIER_DIRECT/13.89.178.26 
</I>&gt;<i> &lt;<A HREF="http://13.89.178.26">http://13.89.178.26</A>&gt; - mobile.events.data.microsoft.com 
</I>&gt;<i> &lt;<A HREF="http://mobile.events.data.microsoft.com">http://mobile.events.data.microsoft.com</A>&gt; - splice -
</I>
This tunnel was never open at all. It was *rejected*.
&quot;speed&quot; in that case was 3 KB/sec.


&gt;<i> 18/Oct/2023:15:18:51 +0300 127307 192.168.3.97 TCP_TUNNEL/500 3101 
</I>&gt;<i> CONNECT array612.prod.do.dsp.mp.microsoft.com:443 
</I>&gt;<i> &lt;<A HREF="http://array612.prod.do.dsp.mp.microsoft.com:443">http://array612.prod.do.dsp.mp.microsoft.com:443</A>&gt; - 
</I>&gt;<i> HIER_DIRECT/20.54.24.148 &lt;<A HREF="http://20.54.24.148">http://20.54.24.148</A>&gt; - 
</I>&gt;<i> array612.prod.do.dsp.mp.microsoft.com 
</I>&gt;<i> &lt;<A HREF="http://array612.prod.do.dsp.mp.microsoft.com">http://array612.prod.do.dsp.mp.microsoft.com</A>&gt; - splice -
</I>
Tunnel was _open_ for 127 seconds. 3101 bytes transferred.

Those bytes may have been transferred in the first 1 milliseconds of the 
tunnel being open. Then Squid leaving it open waiting for further uses 
which never came.

  ... &quot;slow&quot; at 376 MB/sec.

  ... or it could have been &quot;slow&quot; at 25 bytes/sec the whole time. One 
cannot tell.



&gt;<i> This is my squid configurations:
</I>&gt;<i> 
</I>&gt;<i> acl NoSSLInterceptRegexp_always ssl::server_name --client-requested 
</I>&gt;<i>  &#160;&quot;/usr/local/squid/etc/splice.list&quot;
</I>
&gt;<i> acl alwaysBump ssl::server_name --client-requested 
</I>&gt;<i> storage.googleapis.com &lt;<A HREF="http://storage.googleapis.com">http://storage.googleapis.com</A>&gt; 
</I>&gt;<i> youtubei.googleapis.com &lt;<A HREF="http://youtubei.googleapis.com">http://youtubei.googleapis.com</A>&gt; www.eset.com 
</I>&gt;<i> &lt;<A HREF="http://www.eset.com">http://www.eset.com</A>&gt; eset.com &lt;<A HREF="http://eset.com">http://eset.com</A>&gt; 
</I>&gt;<i> safebrowsing.googleapis.com &lt;<A HREF="http://safebrowsing.googleapis.com">http://safebrowsing.googleapis.com</A>&gt; 
</I>&gt;<i> play.google.com &lt;<A HREF="http://play.google.com">http://play.google.com</A>&gt;
</I>&gt;<i> on_unsupported_protocol tunnel
</I>&gt;<i> acl DiscoverSNIHost at_step SslBump1
</I>&gt;<i> ssl_bump peek DiscoverSNIHost
</I>&gt;<i> ssl_bump bump alwaysBump&#160;&#160; -&#160; Used to bumd certain subdomains before the 
</I>&gt;<i> whole domain is bumped.
</I>&gt;<i> ssl_bump splice NoSSLInterceptRegexp_always
</I>&gt;<i> ssl_bump stare all
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Other CONNECT requests are served noramly.
</I>&gt;<i> Is this issue could be a root cause for the generally slow internet?
</I>&gt;<i> 
</I>&gt;<i> Thanks,
</I>&gt;<i> Ben
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">https://lists.squid-cache.org/listinfo/squid-users</A>
</I>
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="026211.html">[squid-users] Spliced domains tunnel connect is very slow
</A></li>
	<LI>Next message (by thread): <A HREF="026215.html">[squid-users] Spliced domains tunnel connect is very slow
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26214">[ date ]</a>
              <a href="thread.html#26214">[ thread ]</a>
              <a href="subject.html#26214">[ subject ]</a>
              <a href="author.html#26214">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
