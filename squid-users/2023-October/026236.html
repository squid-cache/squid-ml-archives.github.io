<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Get IP of denied request
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Get%20IP%20of%20denied%20request&In-Reply-To=%3Ce3d70ac4-a680-4de8-bfd9-4e6fd0698fa2%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="026235.html">
   <LINK REL="Next"  HREF="026237.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Get IP of denied request</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Get%20IP%20of%20denied%20request&In-Reply-To=%3Ce3d70ac4-a680-4de8-bfd9-4e6fd0698fa2%40measurement-factory.com%3E"
       TITLE="[squid-users] Get IP of denied request">rousskov at measurement-factory.com
       </A><BR>
    <I>Fri Oct 27 14:22:44 UTC 2023</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="026235.html">[squid-users] Get IP of denied request
</A></li>
        <LI>Next message (by thread): <A HREF="026237.html">[squid-users] Get IP of denied request
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26236">[ date ]</a>
              <a href="thread.html#26236">[ thread ]</a>
              <a href="subject.html#26236">[ subject ]</a>
              <a href="author.html#26236">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 2023-10-27 07:14, <A HREF="https://lists.squid-cache.org/listinfo/squid-users">magri at web.de</A> wrote:
&gt;<i> Am 26.10.23 um 21:11 schrieb Alex Rousskov:
</I>&gt;&gt;<i> On 2023-10-26 08:37, <A HREF="https://lists.squid-cache.org/listinfo/squid-users">magri at web.de</A> wrote:
</I>&gt;&gt;&gt;<i> TL;DR: is there a way to get/log the resolved ip of a denied request?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> TLDR: Bugs notwithstanding, use %&lt;a.
</I>
&gt;<i> %&lt;a doesn't work :-(
</I>
Sorry, my first response was wrong: As you have correctly explained, %&lt;a 
is the destination address of the used next hop connection while dst ACL 
uses an address derived from the request-target. The two addresses do 
not have to match and, more importantly, it is wrong to expect a dst ACL 
to update/store that &quot;used next hop address&quot; information when the ACL 
itself does not open or reuse a connection to that address.


&gt;&gt;<i> &#160;&#160;&#160;&#160; acl matchDst1 dst 127.0.0.1
</I>&gt;&gt;<i> &#160;&#160;&#160;&#160; acl markDst1 note matched=127.0.0.1
</I>&gt;&gt;<i> &#160;&#160;&#160;&#160; http_access deny matchDst1 markDst1
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &#160;&#160;&#160;&#160; acl matchDst2 dst 127.0.0.2
</I>&gt;&gt;<i> &#160;&#160;&#160;&#160; acl markDst2 note matched=127.0.0.2
</I>&gt;&gt;<i> &#160;&#160;&#160;&#160; http_access deny matchDst2 markDst2
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &#160;&#160;&#160;&#160; logformat myFormat ... matched_dst=%note{matched}
</I>&gt;&gt;<i> &#160;&#160;&#160;&#160; access_log ...
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> For long dst lists, the above approach will require scripting the
</I>&gt;&gt;<i> generation of the corresponding squid.conf portions or include files, of
</I>&gt;&gt;<i> course.
</I>
&gt;<i> I don't think this scales to blacklists with 6-digit count sizes 
</I>
I think that depends on the definition of &quot;to scale&quot;.


&gt;<i> and it also doesn't work for blacklisted networks :-(
</I>
Agreed. This approach can only log which dst ACL data matched, and that 
data may be different from the IP.


&gt;<i> I hoped there would be a way to get the ip as some kind of variable like
</I>&gt;<i> the header fields in logformat.
</I>
Yes, I know. I was just documenting an existing workaround for cases 
where it is usable.


&gt;<i> Any ideas?
</I>
I have three:

1. Enhance Squid to resolve transaction destination address once (on 
first use/need). Remember/reuse resolved IP addresses. Log them via some 
new %resolved_dst and %dst_resolution_detail codes.

This improvement will help address a few use cases unrelated to this 
discussion, but it will _not_ tell you which of the resolved addresses 
actually matched which ACL. You will be able to guess in many cases, but 
there will be exceptions.


2. Add a Squid feature where an evaluated ACL can be configured to 
annotate the transaction with the information about that evaluation.

To start with, we can support annotations for _matched_ dst ACLs. For 
example:

     # When matches, sets the following master transaction annotations:
     # * badDestination_input: used destination address (IP or name)
     # * badDestination_match: the matched destination IP
     # * badDestination_value: the matched ACL parameter value
     # * badDestination_ips: resolved destination IP(s)
     # * badDestination_errors: DNS resolution and other error(s)
     # * badDestination_matches: number of matches (this transaction)
     # * badDestination_evals: number of evaluations (this transaction)
     acl badDestination dst --on-match=annotate 127.0.0.0/24 10.0.0.1

If the same ACL matches more than once, the last(?) match wins, but the 
aclfoo_matches annotation can be used to detect these cases. The 
aclfoo_evals annotation can be used to detect whether this ACL was 
&quot;reached&quot; at all.

If really needed, we can support turning individual annotations on and 
off, but I doubt that complexity is worth associated performance 
savings. After all, most ACLs will only match once per transaction 
lifetime (for correctly written configurations). Access.log will be 
configured to only log annotations of interest to the admin, of course.


The above approach can be extended to provide ACL debugging aid:

     # Dumps every mismatch information to cache.log at level 1
     acl goodDestination dst --on-mismatch=log 127.0.0.0/24

     # Dumps every evaluation information to cache.log at level 1
     acl redDestination dst --on-eval=log 127.0.0.0/24


3. Add a Squid feature where Squid (optionally) maintains an internal 
database of recent ACL evaluation history and makes that information 
accessible via cache manager queries like &quot;which ACLs matched 
transaction X?&quot; (where X is logged %master_xaction ID).


The three sketched options are not mutually exclusive, of course. All 
require non-trivial code changes.

Would any of the above options address your needs? Any preferences or 
spec adjustments?



Thank you,

Alex.


&gt;&gt;&gt;<i> Is there any way to get the ip logged that was used in the dst-acl aside
</I>&gt;&gt;&gt;<i> from debug logging? Maybe through some annotation mechanism?
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Squid version is 6.2, as 6.4 crashes with assertion errors here, too.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> thanks,
</I>&gt;&gt;&gt;<i> Martin
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="026235.html">[squid-users] Get IP of denied request
</A></li>
	<LI>Next message (by thread): <A HREF="026237.html">[squid-users] Get IP of denied request
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26236">[ date ]</a>
              <a href="thread.html#26236">[ thread ]</a>
              <a href="subject.html#26236">[ subject ]</a>
              <a href="author.html#26236">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
