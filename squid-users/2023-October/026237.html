<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Get IP of denied request
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Get%20IP%20of%20denied%20request&In-Reply-To=%3Cc5df1856-0750-4259-9dd9-c01ccf90cc30%40web.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="026236.html">
   <LINK REL="Next"  HREF="026231.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Get IP of denied request</H1>
    <B>magri at web.de</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Get%20IP%20of%20denied%20request&In-Reply-To=%3Cc5df1856-0750-4259-9dd9-c01ccf90cc30%40web.de%3E"
       TITLE="[squid-users] Get IP of denied request">magri at web.de
       </A><BR>
    <I>Mon Oct 30 17:08:17 UTC 2023</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="026236.html">[squid-users] Get IP of denied request
</A></li>
        <LI>Next message (by thread): <A HREF="026231.html">[squid-users] fallback from kerberos sso to basic auth
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26237">[ date ]</a>
              <a href="thread.html#26237">[ thread ]</a>
              <a href="subject.html#26237">[ subject ]</a>
              <a href="author.html#26237">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>

Am 27.10.23 um 16:22 schrieb Alex Rousskov:
&gt;<i> On 2023-10-27 07:14, <A HREF="https://lists.squid-cache.org/listinfo/squid-users">magri at web.de</A> wrote:
</I>&gt;&gt;<i> Am 26.10.23 um 21:11 schrieb Alex Rousskov:
</I>&gt;&gt;&gt;<i> On 2023-10-26 08:37, <A HREF="https://lists.squid-cache.org/listinfo/squid-users">magri at web.de</A> wrote:
</I>&gt;&gt;&gt;&gt;<i> TL;DR: is there a way to get/log the resolved ip of a denied request?
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> TLDR: Bugs notwithstanding, use %&lt;a.
</I>&gt;<i>
</I>&gt;&gt;<i> %&lt;a doesn't work :-(
</I>&gt;<i>
</I>&gt;<i> Sorry, my first response was wrong: As you have correctly explained, %&lt;a
</I>&gt;<i> is the destination address of the used next hop connection while dst ACL
</I>&gt;<i> uses an address derived from the request-target. The two addresses do
</I>&gt;<i> not have to match and, more importantly, it is wrong to expect a dst ACL
</I>&gt;<i> to update/store that &quot;used next hop address&quot; information when the ACL
</I>&gt;<i> itself does not open or reuse a connection to that address.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;&gt;<i> &#160;&#160;&#160;&#160; acl matchDst1 dst 127.0.0.1
</I>&gt;&gt;&gt;<i> &#160;&#160;&#160;&#160; acl markDst1 note matched=127.0.0.1
</I>&gt;&gt;&gt;<i> &#160;&#160;&#160;&#160; http_access deny matchDst1 markDst1
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> &#160;&#160;&#160;&#160; acl matchDst2 dst 127.0.0.2
</I>&gt;&gt;&gt;<i> &#160;&#160;&#160;&#160; acl markDst2 note matched=127.0.0.2
</I>&gt;&gt;&gt;<i> &#160;&#160;&#160;&#160; http_access deny matchDst2 markDst2
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> &#160;&#160;&#160;&#160; logformat myFormat ... matched_dst=%note{matched}
</I>&gt;&gt;&gt;<i> &#160;&#160;&#160;&#160; access_log ...
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> For long dst lists, the above approach will require scripting the
</I>&gt;&gt;&gt;<i> generation of the corresponding squid.conf portions or include files, of
</I>&gt;&gt;&gt;<i> course.
</I>&gt;<i>
</I>&gt;&gt;<i> I don't think this scales to blacklists with 6-digit count sizes
</I>&gt;<i>
</I>&gt;<i> I think that depends on the definition of &quot;to scale&quot;.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> and it also doesn't work for blacklisted networks :-(
</I>&gt;<i>
</I>&gt;<i> Agreed. This approach can only log which dst ACL data matched, and that
</I>&gt;<i> data may be different from the IP.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> I hoped there would be a way to get the ip as some kind of variable like
</I>&gt;&gt;<i> the header fields in logformat.
</I>&gt;<i>
</I>&gt;<i> Yes, I know. I was just documenting an existing workaround for cases
</I>&gt;<i> where it is usable.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> Any ideas?
</I>&gt;<i>
</I>&gt;<i> I have three:
</I>&gt;<i>
</I>&gt;<i> 1. Enhance Squid to resolve transaction destination address once (on
</I>&gt;<i> first use/need). Remember/reuse resolved IP addresses. Log them via some
</I>&gt;<i> new %resolved_dst and %dst_resolution_detail codes.
</I>&gt;<i>
</I>&gt;<i> This improvement will help address a few use cases unrelated to this
</I>&gt;<i> discussion, but it will _not_ tell you which of the resolved addresses
</I>&gt;<i> actually matched which ACL. You will be able to guess in many cases, but
</I>&gt;<i> there will be exceptions.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> 2. Add a Squid feature where an evaluated ACL can be configured to
</I>&gt;<i> annotate the transaction with the information about that evaluation.
</I>&gt;<i>
</I>&gt;<i> To start with, we can support annotations for _matched_ dst ACLs. For
</I>&gt;<i> example:
</I>&gt;<i>
</I>&gt;<i>  &#160;&#160;&#160; # When matches, sets the following master transaction annotations:
</I>&gt;<i>  &#160;&#160;&#160; # * badDestination_input: used destination address (IP or name)
</I>&gt;<i>  &#160;&#160;&#160; # * badDestination_match: the matched destination IP
</I>&gt;<i>  &#160;&#160;&#160; # * badDestination_value: the matched ACL parameter value
</I>&gt;<i>  &#160;&#160;&#160; # * badDestination_ips: resolved destination IP(s)
</I>&gt;<i>  &#160;&#160;&#160; # * badDestination_errors: DNS resolution and other error(s)
</I>&gt;<i>  &#160;&#160;&#160; # * badDestination_matches: number of matches (this transaction)
</I>&gt;<i>  &#160;&#160;&#160; # * badDestination_evals: number of evaluations (this transaction)
</I>&gt;<i>  &#160;&#160;&#160; acl badDestination dst --on-match=annotate 127.0.0.0/24 10.0.0.1
</I>&gt;<i>
</I>&gt;<i> If the same ACL matches more than once, the last(?) match wins, but the
</I>&gt;<i> aclfoo_matches annotation can be used to detect these cases. The
</I>&gt;<i> aclfoo_evals annotation can be used to detect whether this ACL was
</I>&gt;<i> &quot;reached&quot; at all.
</I>&gt;<i>
</I>&gt;<i> If really needed, we can support turning individual annotations on and
</I>&gt;<i> off, but I doubt that complexity is worth associated performance
</I>&gt;<i> savings. After all, most ACLs will only match once per transaction
</I>&gt;<i> lifetime (for correctly written configurations). Access.log will be
</I>&gt;<i> configured to only log annotations of interest to the admin, of course.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> The above approach can be extended to provide ACL debugging aid:
</I>&gt;<i>
</I>&gt;<i>  &#160;&#160;&#160; # Dumps every mismatch information to cache.log at level 1
</I>&gt;<i>  &#160;&#160;&#160; acl goodDestination dst --on-mismatch=log 127.0.0.0/24
</I>&gt;<i>
</I>&gt;<i>  &#160;&#160;&#160; # Dumps every evaluation information to cache.log at level 1
</I>&gt;<i>  &#160;&#160;&#160; acl redDestination dst --on-eval=log 127.0.0.0/24
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> 3. Add a Squid feature where Squid (optionally) maintains an internal
</I>&gt;<i> database of recent ACL evaluation history and makes that information
</I>&gt;<i> accessible via cache manager queries like &quot;which ACLs matched
</I>&gt;<i> transaction X?&quot; (where X is logged %master_xaction ID).
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> The three sketched options are not mutually exclusive, of course. All
</I>&gt;<i> require non-trivial code changes.
</I>&gt;<i>
</I>&gt;<i> Would any of the above options address your needs? Any preferences or
</I>&gt;<i> spec adjustments?
</I>
Very nice and detailed options!

Let me first ask some questions for clarification:
- Does squid cache all ips from dns responses with multiple ips or only
the one it uses for the request?
- If it caches more than one ip - does squid use more than one of these
ips (e.g. as fallback or round robin) inside a single transaction or for
multiple transactions?

Supposing squid uses only a single dst ip inside a single transaction,
your first option would be sufficient for our purpose!

Resolving the ip only once and storing it inside the transaction would
also avoid ambiguous cases where different ips could theoretically be
used in different acls or worse in acls and the real connection.
It could also improve the performance of acl evaluation because after
the resolution of the dst ip all following dst acls would be evaluated
fast(?).

Before the introduction of annotations we hat to use some acls twice
(for http_access and dedicated logs for this acl) but that's not
necessary anymore. We still have several dst acls that could benefit
from storing the once resolved dst ip.

Your second option sounds really nice for debugging purposes but IMHO
these annotations should be optional because even if the performance
penalty may(?) be neglectable they increase the size of the transaction
object and this could accumulate if many acls are in use.
Hence I would propose this as optional extension to the first option.

Your third option seems not feasible for us, because the delay between a
failed request and reporting of the failure often takes more than a day.
The needed history would be quite excessive (with over 80 million
requests a day).

Thank you,
Martin

&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Thank you,
</I>&gt;<i>
</I>&gt;<i> Alex.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> Is there any way to get the ip logged that was used in the dst-acl
</I>&gt;&gt;&gt;&gt;<i> aside
</I>&gt;&gt;&gt;&gt;<i> from debug logging? Maybe through some annotation mechanism?
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> Squid version is 6.2, as 6.4 crashes with assertion errors here, too.
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> thanks,
</I>&gt;&gt;&gt;&gt;<i> Martin
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">https://lists.squid-cache.org/listinfo/squid-users</A>
</I>
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="026236.html">[squid-users] Get IP of denied request
</A></li>
	<LI>Next message (by thread): <A HREF="026231.html">[squid-users] fallback from kerberos sso to basic auth
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26237">[ date ]</a>
              <a href="thread.html#26237">[ thread ]</a>
              <a href="subject.html#26237">[ subject ]</a>
              <a href="author.html#26237">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
