<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Disable IPV6 for certain destinations only?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Disable%20IPV6%20for%20certain%20destinations%20only%3F&In-Reply-To=%3Cc27710ea-6055-44c1-b10c-6868fb6d862b%40borrill.org.uk%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="026234.html">
   <LINK REL="Next"  HREF="026240.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Disable IPV6 for certain destinations only?</H1>
    <B>Stephen Borrill</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Disable%20IPV6%20for%20certain%20destinations%20only%3F&In-Reply-To=%3Cc27710ea-6055-44c1-b10c-6868fb6d862b%40borrill.org.uk%3E"
       TITLE="[squid-users] Disable IPV6 for certain destinations only?">squid at borrill.org.uk
       </A><BR>
    <I>Tue Oct 31 13:08:29 UTC 2023</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="026234.html">[squid-users] Cache NTLM Authenticaion
</A></li>
        <LI>Next message (by thread): <A HREF="026240.html">[squid-users] Disable IPV6 for certain destinations only?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26239">[ date ]</a>
              <a href="thread.html#26239">[ thread ]</a>
              <a href="subject.html#26239">[ subject ]</a>
              <a href="author.html#26239">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 18th April 2023 Alex Rousskov wrote:
&gt;<i> On 4/18/23 03:38, Ralf Hildebrandt wrote:
</I>&gt;<i> 
</I>&gt;&gt;<i> We're using squid-6, currently v4 only. The use case for us is mostly
</I>&gt;&gt;<i> our users using our proxy to retrieve full text publications of
</I>&gt;&gt;<i> several thousand medical journals... via IPv4.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> The publishers &quot;know&quot; our IPv4 range for the proxies and allow us to
</I>&gt;&gt;<i> download freely. What they don't (yet) know is our ipv6 range.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> Thus arises the need to &quot;fall back&quot; to ipv4 in the unlikely case some
</I>&gt;&gt;<i> publisher already has ipv6, we connect via ipv6 and suddenly are not
</I>&gt;&gt;<i> allowed to download the publications.
</I>&gt;&gt;<i> 
</I>&gt;&gt;<i> Is there an acl for that kind of need?
</I>&gt;<i> 
</I>&gt;<i> I will rephrase your question to avoid the distraction of &quot;acl&quot;:
</I>&gt;<i> 
</I>&gt;<i>    How can I configure Squid to try IPv4 if IPv6 fails?
</I>&gt;<i> 
</I>&gt;<i> The answer depends on how IPv6 fails:
</I>&gt;<i> 
</I>&gt;<i> 1. If IPv6 fails at DNS resolution time (i.e. the DNS resolver does not 
</I>&gt;<i> respond with a usable address to a AAAA query), then Squid will 
</I>&gt;<i> automatically use IPv4 (i.e. the DNS resolver address in an A response). 
</I>&gt;<i> There is nothing to configure.
</I>&gt;<i> 
</I>&gt;<i> 2. If IPv6 fails at TCP connection establishment time, then Squid will 
</I>&gt;<i> automatically use an IPv4 connection. There is nothing to configure 
</I>&gt;<i> (although there are a few Happy Eyeballs configuration options that you 
</I>&gt;<i> can tune).
</I>&gt;<i> 
</I>&gt;<i> 3. If IPv6 fails at TLS connection establishment time, then, IIRC, #2 
</I>&gt;<i> applies unless SslBump is involved. Squid will not retry failed TLS 
</I>&gt;<i> connections that are subject to SslBump IIRC.
</I>&gt;<i> 
</I>&gt;<i> 4. If IPv6 fails at HTTP request time, then Squid will retry in _some_ 
</I>&gt;<i> cases. See [1] for a long list of conditions; you are probably mostly 
</I>&gt;<i> interested in the last four or five bullets, but keep in mind that the 
</I>&gt;<i> list is of cases where Squid does _not_ re-forward the failed request.
</I>&gt;<i> 
</I>&gt;<i> [1] 
</I>&gt;<i> <A HREF="https://wiki.squid-cache.org/SquidFaq/InnerWorkings#when-does-squid-re-forward-a-client-request">https://wiki.squid-cache.org/SquidFaq/InnerWorkings#when-does-squid-re-forward-a-client-request</A>
</I>&gt;<i> 
</I>&gt;<i> You can also replace your DNS resolver with a custom one (that drops 
</I>&gt;<i> AAAA answers) or, as Adam has suggested, with hard-coded IPv4-only 
</I>&gt;<i> /etc/hosts entries.
</I>
On a machine with no IPv6 connection to the Internet and bearing in mind 2 and 3 above,
what is going on in the following situation? The host is being resolved to IPv6,
the connection is failing with (presumably) no route to host and the client's connection is rejected
with a 503 error:


peer_select.cc(373) checkAlwaysDirectDone: ALLOWED
peer_select.cc(379) checkAlwaysDirectDone: direct = DIRECT_YES (always_direct allow)
peer_select.cc(612) selectMore: CONNECT forcesafesearch.google.com
peer_select.cc(1102) addSelection: adding HIER_DIRECT#forcesafesearch.google.com
peer_select.cc(460) resolveSelected: Find IP destination for: forcesafesearch.google.com:443' via forcesafesearch.google.com
Address.cc(389) lookupHostIP: Given Non-IP 'forcesafesearch.google.com': hostname or servname not provided or not known
peer_select.cc(1174) handlePath: PeerSelector33640 found conn271011 local=[::] remote=[2001:4860:4802:32::78]:443 HIER_DIRECT flags=1, destination #1 for forcesafesearch.google.com:443
peer_select.cc(1180) handlePath:   always_direct = ALLOWED
peer_select.cc(1181) handlePath:    never_direct = DENIED
peer_select.cc(1182) handlePath:        timedout = 0
peer_select.cc(479) resolveSelected: PeerSelector33640 found all 1 destinations for forcesafesearch.google.com:443
peer_select.cc(480) resolveSelected:   always_direct = ALLOWED
peer_select.cc(481) resolveSelected:    never_direct = DENIED
peer_select.cc(482) resolveSelected:        timedout = 0
client_side.cc(1953) clientParseRequests: Not parsing new requests, as this request may need the connection
FwdState.cc(1568) GetMarkingsToServer: from [::] tos 0 netfilter mark 0
ConnOpener.cc(42) ConnOpener: will connect to conn271013 local=[::] remote=[2001:4860:4802:32::78]:443 HIER_DIRECT flags=1 with 60 timeout
comm.cc(372) comm_openex: comm_openex: Attempt open socket for: [::]
comm.cc(414) comm_openex: comm_openex: Opened socket conn271014 local=[::] remote=[::] FD 1218 flags=1 : family=24, type=1, protocol=6
fd.cc(168) fd_open: fd_open() FD 1218 forcesafesearch.google.com
ConnOpener.cc(312) createFd: conn271013 local=[::] remote=[2001:4860:4802:32::78]:443 HIER_DIRECT flags=1 will timeout in 60
comm.cc(844) _comm_close: start closing FD 1218 by ConnOpener.cc:232
comm.cc(580) commUnsetFdTimeout: Remove timeout for FD 1218
HappyConnOpener.cc(522) sendFailure: conn271013 local=[::] remote=[2001:4860:4802:32::78]:443 HIER_DIRECT flags=1 @0
fd.cc(93) fd_close: fd_close FD 1218 forcesafesearch.google.com
tunnel.cc(1364) sendError: aborting transaction for HappyConnOpener gave up
errorpage.cc(751) errorSend: conn271010 local=127.0.0.1:8123 remote=127.0.0.1:56146 FD 1217 flags=1, err=ERR_CONNECT_FAIL

-- 
Stephen


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="026234.html">[squid-users] Cache NTLM Authenticaion
</A></li>
	<LI>Next message (by thread): <A HREF="026240.html">[squid-users] Disable IPV6 for certain destinations only?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26239">[ date ]</a>
              <a href="thread.html#26239">[ thread ]</a>
              <a href="subject.html#26239">[ subject ]</a>
              <a href="author.html#26239">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
