<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Disable IPV6 for certain destinations only?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Disable%20IPV6%20for%20certain%20destinations%20only%3F&In-Reply-To=%3Cba25f62e-9e9b-4afc-ad0d-d96383462e75%40borrill.org.uk%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="026239.html">
   
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Disable IPV6 for certain destinations only?</H1>
    <B>Stephen Borrill</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Disable%20IPV6%20for%20certain%20destinations%20only%3F&In-Reply-To=%3Cba25f62e-9e9b-4afc-ad0d-d96383462e75%40borrill.org.uk%3E"
       TITLE="[squid-users] Disable IPV6 for certain destinations only?">squid at borrill.org.uk
       </A><BR>
    <I>Tue Oct 31 13:28:03 UTC 2023</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="026239.html">[squid-users] Disable IPV6 for certain destinations only?
</A></li>
        
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26240">[ date ]</a>
              <a href="thread.html#26240">[ thread ]</a>
              <a href="subject.html#26240">[ subject ]</a>
              <a href="author.html#26240">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 31/10/2023 13:08, Stephen Borrill wrote:
&gt;<i> On 18th April 2023 Alex Rousskov wrote:
</I>&gt;&gt;<i> On 4/18/23 03:38, Ralf Hildebrandt wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> We're using squid-6, currently v4 only. The use case for us is mostly
</I>&gt;&gt;&gt;<i> our users using our proxy to retrieve full text publications of
</I>&gt;&gt;&gt;<i> several thousand medical journals... via IPv4.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> The publishers &quot;know&quot; our IPv4 range for the proxies and allow us to
</I>&gt;&gt;&gt;<i> download freely. What they don't (yet) know is our ipv6 range.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Thus arises the need to &quot;fall back&quot; to ipv4 in the unlikely case some
</I>&gt;&gt;&gt;<i> publisher already has ipv6, we connect via ipv6 and suddenly are not
</I>&gt;&gt;&gt;<i> allowed to download the publications.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Is there an acl for that kind of need?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I will rephrase your question to avoid the distraction of &quot;acl&quot;:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &#160;&#160; How can I configure Squid to try IPv4 if IPv6 fails?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The answer depends on how IPv6 fails:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> 1. If IPv6 fails at DNS resolution time (i.e. the DNS resolver does not respond with a usable address to a AAAA query), then Squid will automatically use IPv4 (i.e. the DNS resolver address in an A response). There is nothing to configure.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> 2. If IPv6 fails at TCP connection establishment time, then Squid will automatically use an IPv4 connection. There is nothing to configure (although there are a few Happy Eyeballs configuration options that you can tune).
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> 3. If IPv6 fails at TLS connection establishment time, then, IIRC, #2 applies unless SslBump is involved. Squid will not retry failed TLS connections that are subject to SslBump IIRC.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> 4. If IPv6 fails at HTTP request time, then Squid will retry in _some_ cases. See [1] for a long list of conditions; you are probably mostly interested in the last four or five bullets, but keep in mind that the list is of cases where Squid does _not_ re-forward the failed request.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> [1] <A HREF="https://wiki.squid-cache.org/SquidFaq/InnerWorkings#when-does-squid-re-forward-a-client-request">https://wiki.squid-cache.org/SquidFaq/InnerWorkings#when-does-squid-re-forward-a-client-request</A>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> You can also replace your DNS resolver with a custom one (that drops AAAA answers) or, as Adam has suggested, with hard-coded IPv4-only /etc/hosts entries.
</I>&gt;<i> 
</I>&gt;<i> On a machine with no IPv6 connection to the Internet and bearing in mind 2 and 3 above,
</I>&gt;<i> what is going on in the following situation? The host is being resolved to IPv6,
</I>&gt;<i> the connection is failing with (presumably) no route to host and the client's connection is rejected
</I>&gt;<i> with a 503 error:
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> peer_select.cc(373) checkAlwaysDirectDone: ALLOWED
</I>&gt;<i> peer_select.cc(379) checkAlwaysDirectDone: direct = DIRECT_YES (always_direct allow)
</I>&gt;<i> peer_select.cc(612) selectMore: CONNECT forcesafesearch.google.com
</I>&gt;<i> peer_select.cc(1102) addSelection: adding HIER_DIRECT#forcesafesearch.google.com
</I>&gt;<i> peer_select.cc(460) resolveSelected: Find IP destination for: forcesafesearch.google.com:443' via forcesafesearch.google.com
</I>&gt;<i> Address.cc(389) lookupHostIP: Given Non-IP 'forcesafesearch.google.com': hostname or servname not provided or not known
</I>&gt;<i> peer_select.cc(1174) handlePath: PeerSelector33640 found conn271011 local=[::] remote=[2001:4860:4802:32::78]:443 HIER_DIRECT flags=1, destination #1 for forcesafesearch.google.com:443
</I>&gt;<i> peer_select.cc(1180) handlePath:&#160;&#160; always_direct = ALLOWED
</I>&gt;<i> peer_select.cc(1181) handlePath:&#160;&#160;&#160; never_direct = DENIED
</I>&gt;<i> peer_select.cc(1182) handlePath:&#160;&#160;&#160;&#160;&#160;&#160;&#160; timedout = 0
</I>&gt;<i> peer_select.cc(479) resolveSelected: PeerSelector33640 found all 1 destinations for forcesafesearch.google.com:443
</I>&gt;<i> peer_select.cc(480) resolveSelected:&#160;&#160; always_direct = ALLOWED
</I>&gt;<i> peer_select.cc(481) resolveSelected:&#160;&#160;&#160; never_direct = DENIED
</I>&gt;<i> peer_select.cc(482) resolveSelected:&#160;&#160;&#160;&#160;&#160;&#160;&#160; timedout = 0
</I>&gt;<i> client_side.cc(1953) clientParseRequests: Not parsing new requests, as this request may need the connection
</I>&gt;<i> FwdState.cc(1568) GetMarkingsToServer: from [::] tos 0 netfilter mark 0
</I>&gt;<i> ConnOpener.cc(42) ConnOpener: will connect to conn271013 local=[::] remote=[2001:4860:4802:32::78]:443 HIER_DIRECT flags=1 with 60 timeout
</I>&gt;<i> comm.cc(372) comm_openex: comm_openex: Attempt open socket for: [::]
</I>&gt;<i> comm.cc(414) comm_openex: comm_openex: Opened socket conn271014 local=[::] remote=[::] FD 1218 flags=1 : family=24, type=1, protocol=6
</I>&gt;<i> fd.cc(168) fd_open: fd_open() FD 1218 forcesafesearch.google.com
</I>&gt;<i> ConnOpener.cc(312) createFd: conn271013 local=[::] remote=[2001:4860:4802:32::78]:443 HIER_DIRECT flags=1 will timeout in 60
</I>&gt;<i> comm.cc(844) _comm_close: start closing FD 1218 by ConnOpener.cc:232
</I>&gt;<i> comm.cc(580) commUnsetFdTimeout: Remove timeout for FD 1218
</I>&gt;<i> HappyConnOpener.cc(522) sendFailure: conn271013 local=[::] remote=[2001:4860:4802:32::78]:443 HIER_DIRECT flags=1 @0
</I>&gt;<i> fd.cc(93) fd_close: fd_close FD 1218 forcesafesearch.google.com
</I>&gt;<i> tunnel.cc(1364) sendError: aborting transaction for HappyConnOpener gave up
</I>&gt;<i> errorpage.cc(751) errorSend: conn271010 local=127.0.0.1:8123 remote=127.0.0.1:56146 FD 1217 flags=1, err=ERR_CONNECT_FAIL
</I>
After restarting (not reloading), I get the following and it will work for while before stopping again:

peer_select.cc(1174) handlePath: PeerSelector1666 found conn12948 local=0.0.0.0 remote=216.239.38.120:443 HIER_DIRECT flags=1, destination #1 for forcesafesearch.google.com:443
peer_select.cc(1180) handlePath:   always_direct = ALLOWED
peer_select.cc(1181) handlePath:    never_direct = DENIED
peer_select.cc(1182) handlePath:        timedout = 0
peer_select.cc(1174) handlePath: PeerSelector1666 found conn12949 local=[::] remote=[2001:4860:4802:32::78]:443 HIER_DIRECT flags=1, destination #2 for forcesafesearch.google.com:443
peer_select.cc(1180) handlePath:   always_direct = ALLOWED
peer_select.cc(1181) handlePath:    never_direct = DENIED
peer_select.cc(1182) handlePath:        timedout = 0
peer_select.cc(479) resolveSelected: PeerSelector1666 found all 2 destinations for forcesafesearch.google.com:443

This is a newly occurring problem after upgrade from 4.x to 6.3.

-- 
Stephen


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="026239.html">[squid-users] Disable IPV6 for certain destinations only?
</A></li>
	
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26240">[ date ]</a>
              <a href="thread.html#26240">[ thread ]</a>
              <a href="subject.html#26240">[ subject ]</a>
              <a href="author.html#26240">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
