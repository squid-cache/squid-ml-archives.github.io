From ben.goz87 at gmail.com  Sun Sep  3 13:39:25 2023
From: ben.goz87 at gmail.com (Ben Goz)
Date: Sun, 3 Sep 2023 16:39:25 +0300
Subject: [squid-users] ICAP reply pipe is full
Message-ID: <CADAqQfx7idwOJTPCONgTAy-gyArOF0xdi6=o1rACQTLnnWaXTA@mail.gmail.com>

Spam detection software, running on the system "master.squid-cache.org",
has identified this incoming email as possible spam.  The original
message has been attached to this so you can view it or label
similar future email.  If you have any questions, see
the administrator of that system for details.

Content preview:  ??"?? Hi, I'm working with squid that sends http/s traffic
   to a custom c-icap filter. I see a lot of ICAP reply debug messages in Squid's
   cache log. kid1| 93,3| ModXact.cc(556) readMore: not reading because ICAP
   reply pipe is full 

Content analysis details:   (105.0 points, 5.0 required)

 pts rule name              description
---- ---------------------- --------------------------------------------------
 105 SQUID_ML_SPAM_SUBJECT_KEYWORDS No description available.
 0.2 FREEMAIL_ENVFROM_END_DIGIT Envelope-from freemail username ends
                            in digit
                            [ben.goz87[at]gmail.com]
 0.0 FREEMAIL_FROM          Sender email is commonly abused enduser mail
                            provider
                            [ben.goz87[at]gmail.com]
 0.0 HTML_MESSAGE           BODY: HTML included in message
-0.1 DKIM_VALID_EF          Message has a valid DKIM or DK signature from
                            envelope-from domain
 0.1 DKIM_SIGNED            Message has a DKIM or DK signature, not necessarily
                            valid
-0.1 DKIM_VALID_AU          Message has a valid DKIM or DK signature from
                            author's domain
-0.1 DKIM_VALID             Message has at least one valid DKIM or DK signature
-0.0 T_SCC_BODY_TEXT_LINE   No description available.
 0.0 UNPARSEABLE_RELAY      Informational: message has unparseable relay
                            lines

The original message was not completely plain text, and may be unsafe to
open with some email clients; in particular, it may contain a virus,
or confirm that your address can receive spam.  If you wish to view
it, it may be safer to save it to a file and open it with an editor.

-------------- next part --------------
An embedded message was scrubbed...
From: Ben Goz <ben.goz87 at gmail.com>
Subject: ICAP reply pipe is full
Date: Sun, 3 Sep 2023 16:39:25 +0300
Size: 4266
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230903/98c0e23f/attachment.eml>

From hack3rcon at yahoo.com  Sat Sep  9 13:09:19 2023
From: hack3rcon at yahoo.com (Jason Long)
Date: Sat, 9 Sep 2023 13:09:19 +0000 (UTC)
Subject: [squid-users] Squid-cache authentication is not working
References: <488889840.3864943.1694264959281.ref@mail.yahoo.com>
Message-ID: <488889840.3864943.1694264959281@mail.yahoo.com>

Hello,
I installed the Squid-cache on Debian 12, then I installed the Apache utils:

$ sudo apt install apache2-utils

After it, I did the following steps:

$ sudo touch /etc/squid/passwd
$ sudo chown proxy /etc/squid/passwd

Then:

$ sudo htpasswd /etc/squid/passwd jason

After it, I opened the "/etc/squid/squid.conf" file and add the following lines to it:

auth_param basic program /usr/lib/squid/basic_ncsa_auth /etc/squid/passwd
auth_param basic children 5
auth_param basic realm Squid Basic Authentication
auth_param basic credentialsttl 2 hours
acl auth_users proxy_auth REQUIRED
http_access allow auth_users
http_access deny all


Finally:
$ sudo systemctl restart squid

But, on the client machine, I can visit any website without the username and password.
Which part of the configuration is wrong?

Thank you.


From rousskov at measurement-factory.com  Sat Sep  9 14:25:56 2023
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Sat, 9 Sep 2023 10:25:56 -0400
Subject: [squid-users] Squid-cache authentication is not working
In-Reply-To: <488889840.3864943.1694264959281@mail.yahoo.com>
References: <488889840.3864943.1694264959281.ref@mail.yahoo.com>
 <488889840.3864943.1694264959281@mail.yahoo.com>
Message-ID: <0db5ad2c-71f9-4e3b-ac89-35c4ea421580@measurement-factory.com>

On 2023-09-09 09:09, Jason Long wrote:
> Hello,
> I installed the Squid-cache on Debian 12, then I installed the Apache utils:
> 
> $ sudo apt install apache2-utils
> 
> After it, I did the following steps:
> 
> $ sudo touch /etc/squid/passwd
> $ sudo chown proxy /etc/squid/passwd
> 
> Then:
> 
> $ sudo htpasswd /etc/squid/passwd jason
> 
> After it, I opened the "/etc/squid/squid.conf" file and add the following lines to it:
> 
> auth_param basic program /usr/lib/squid/basic_ncsa_auth /etc/squid/passwd
> auth_param basic children 5
> auth_param basic realm Squid Basic Authentication
> auth_param basic credentialsttl 2 hours
> acl auth_users proxy_auth REQUIRED
> http_access allow auth_users
> http_access deny all
> 
> 
> Finally:
> $ sudo systemctl restart squid
> 
> But, on the client machine, I can visit any website without the username and password.
> Which part of the configuration is wrong?


Many things could go wrong, but I would start from the beginning: 
Perhaps the client (browser) is not configured to use the proxy? Do you 
see client transactions reflected in Squid access.log? Anything in Squid 
cache.log?

HTH,

Alex.




From hack3rcon at yahoo.com  Sat Sep  9 19:09:59 2023
From: hack3rcon at yahoo.com (Jason Long)
Date: Sat, 9 Sep 2023 19:09:59 +0000 (UTC)
Subject: [squid-users] Squid-cache authentication is not working
In-Reply-To: <0db5ad2c-71f9-4e3b-ac89-35c4ea421580@measurement-factory.com>
References: <488889840.3864943.1694264959281.ref@mail.yahoo.com>
 <488889840.3864943.1694264959281@mail.yahoo.com>
 <0db5ad2c-71f9-4e3b-ac89-35c4ea421580@measurement-factory.com>
Message-ID: <1219940758.3926528.1694286599979@mail.yahoo.com>

Hi Alex,Thank you so much for your reply.My Squid-cache server IP is "192.168.1.2".I use Mozilla Firefox and set the proxy to "192.168.1.2:3128".What information do you need to tell you?

Sent from Yahoo Mail on Android 
 
  On Sat, Sep 9, 2023 at 5:56 PM, Alex Rousskov<rousskov at measurement-factory.com> wrote:   On 2023-09-09 09:09, Jason Long wrote:
> Hello,
> I installed the Squid-cache on Debian 12, then I installed the Apache utils:
> 
> $ sudo apt install apache2-utils
> 
> After it, I did the following steps:
> 
> $ sudo touch /etc/squid/passwd
> $ sudo chown proxy /etc/squid/passwd
> 
> Then:
> 
> $ sudo htpasswd /etc/squid/passwd jason
> 
> After it, I opened the "/etc/squid/squid.conf" file and add the following lines to it:
> 
> auth_param basic program /usr/lib/squid/basic_ncsa_auth /etc/squid/passwd
> auth_param basic children 5
> auth_param basic realm Squid Basic Authentication
> auth_param basic credentialsttl 2 hours
> acl auth_users proxy_auth REQUIRED
> http_access allow auth_users
> http_access deny all
> 
> 
> Finally:
> $ sudo systemctl restart squid
> 
> But, on the client machine, I can visit any website without the username and password.
> Which part of the configuration is wrong?


Many things could go wrong, but I would start from the beginning: 
Perhaps the client (browser) is not configured to use the proxy? Do you 
see client transactions reflected in Squid access.log? Anything in Squid 
cache.log?

HTH,

Alex.


_______________________________________________
squid-users mailing list
squid-users at lists.squid-cache.org
https://lists.squid-cache.org/listinfo/squid-users
  
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230909/7acaf90a/attachment.htm>

From rousskov at measurement-factory.com  Sat Sep  9 22:27:29 2023
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Sat, 9 Sep 2023 18:27:29 -0400
Subject: [squid-users] Squid-cache authentication is not working
In-Reply-To: <1219940758.3926528.1694286599979@mail.yahoo.com>
References: <488889840.3864943.1694264959281.ref@mail.yahoo.com>
 <488889840.3864943.1694264959281@mail.yahoo.com>
 <0db5ad2c-71f9-4e3b-ac89-35c4ea421580@measurement-factory.com>
 <1219940758.3926528.1694286599979@mail.yahoo.com>
Message-ID: <b7e0cc63-c412-4743-81f8-eb289b477b06@measurement-factory.com>

On 2023-09-09 15:09, Jason Long wrote:

> My Squid-cache server IP is "192.168.1.2".
> I use Mozilla Firefox and set the proxy to "192.168.1.2:3128".
> What information do you need to tell you?

Do you see Firefox requests/transactions reflected in Squid access.log?

Anything in Squid cache.log?

Sorry, I do not know where those logs are on your machine. Typical 
locations include /var/log/ and /usr/local/squid/var/logs

Another thing to check is whether the http_access rules you have added 
are in the right place. If you simply appended those rules to the 
default Squid configuration file, then they will not work (because 
http_access rules above them will be used instead). Default squid.conf 
marks the place where you should insert custom http_access rules: Look 
for an "INSERT YOUR OWN RULE(S) HERE" comment.

You can check this second theory by removing "http_access allow 
auth_users" and leaving just the "http_access deny all" rule that you 
have added earlier. If everything still works, then either Squid does 
not receive these requests at all (i.e. the first theory) or your access 
rules are too low (i.e. this second theory).


HTH,

Alex.


>     On Sat, Sep 9, 2023 at 5:56 PM, Alex Rousskov
>     <rousskov at measurement-factory.com> wrote:
>     On 2023-09-09 09:09, Jason Long wrote:
> 
>      > Hello,
>      > I installed the Squid-cache on Debian 12, then I installed the
>     Apache utils:
>      >
>      > $ sudo apt install apache2-utils
>      >
>      > After it, I did the following steps:
>      >
>      > $ sudo touch /etc/squid/passwd
>      > $ sudo chown proxy /etc/squid/passwd
>      >
>      > Then:
>      >
>      > $ sudo htpasswd /etc/squid/passwd jason
>      >
>      > After it, I opened the "/etc/squid/squid.conf" file and add the
>     following lines to it:
>      >
>      > auth_param basic program /usr/lib/squid/basic_ncsa_auth
>     /etc/squid/passwd
>      > auth_param basic children 5
>      > auth_param basic realm Squid Basic Authentication
>      > auth_param basic credentialsttl 2 hours
>      > acl auth_users proxy_auth REQUIRED
>      > http_access allow auth_users
>      > http_access deny all
>      >
>      >
>      > Finally:
>      > $ sudo systemctl restart squid
>      >
>      > But, on the client machine, I can visit any website without the
>     username and password.
>      > Which part of the configuration is wrong?
> 
> 
> 
>     Many things could go wrong, but I would start from the beginning:
>     Perhaps the client (browser) is not configured to use the proxy? Do you
>     see client transactions reflected in Squid access.log? Anything in
>     Squid
>     cache.log?
> 
>     HTH,
> 
>     Alex.
> 
> 
>     _______________________________________________
>     squid-users mailing list
>     squid-users at lists.squid-cache.org
>     <mailto:squid-users at lists.squid-cache.org>
>     https://lists.squid-cache.org/listinfo/squid-users
>     <https://lists.squid-cache.org/listinfo/squid-users>
> 



From rousskov at measurement-factory.com  Sat Sep  9 22:31:32 2023
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Sat, 9 Sep 2023 18:31:32 -0400
Subject: [squid-users] Squid-cache authentication is not working
In-Reply-To: <b7e0cc63-c412-4743-81f8-eb289b477b06@measurement-factory.com>
References: <488889840.3864943.1694264959281.ref@mail.yahoo.com>
 <488889840.3864943.1694264959281@mail.yahoo.com>
 <0db5ad2c-71f9-4e3b-ac89-35c4ea421580@measurement-factory.com>
 <1219940758.3926528.1694286599979@mail.yahoo.com>
 <b7e0cc63-c412-4743-81f8-eb289b477b06@measurement-factory.com>
Message-ID: <84d580c9-9069-4b1d-9bcf-27e8c011f0cf@measurement-factory.com>

On 2023-09-09 18:27, Alex Rousskov wrote:
> On 2023-09-09 15:09, Jason Long wrote:
> 
>> My Squid-cache server IP is "192.168.1.2".
>> I use Mozilla Firefox and set the proxy to "192.168.1.2:3128".
>> What information do you need to tell you?
> 
> Do you see Firefox requests/transactions reflected in Squid access.log?
> 
> Anything in Squid cache.log?
> 
> Sorry, I do not know where those logs are on your machine. Typical 
> locations include /var/log/ and /usr/local/squid/var/logs
> 
> Another thing to check is whether the http_access rules you have added 
> are in the right place. If you simply appended those rules to the 
> default Squid configuration file, then they will not work (because 
> http_access rules above them will be used instead). Default squid.conf 
> marks the place where you should insert custom http_access rules: Look 
> for an "INSERT YOUR OWN RULE(S) HERE" comment.
> 
> You can check this second theory by removing "http_access allow 
> auth_users" and leaving just the "http_access deny all" rule that you 
> have added earlier. If everything still works, then either Squid does 
> not receive these requests at all (i.e. the first theory) or your access 
> rules are too low (i.e. this second theory).

... or the attempt to reconfigure Squid did not have an effect (e.g., 
your Squid is not using the configuration file you are editing). There 
are other possible problems/explanations as well. I did not mean to 
imply that these theories are the only possible ones.

Alex.


>> ??? On Sat, Sep 9, 2023 at 5:56 PM, Alex Rousskov
>> ??? <rousskov at measurement-factory.com> wrote:
>> ??? On 2023-09-09 09:09, Jason Long wrote:
>>
>> ???? > Hello,
>> ???? > I installed the Squid-cache on Debian 12, then I installed the
>> ??? Apache utils:
>> ???? >
>> ???? > $ sudo apt install apache2-utils
>> ???? >
>> ???? > After it, I did the following steps:
>> ???? >
>> ???? > $ sudo touch /etc/squid/passwd
>> ???? > $ sudo chown proxy /etc/squid/passwd
>> ???? >
>> ???? > Then:
>> ???? >
>> ???? > $ sudo htpasswd /etc/squid/passwd jason
>> ???? >
>> ???? > After it, I opened the "/etc/squid/squid.conf" file and add the
>> ??? following lines to it:
>> ???? >
>> ???? > auth_param basic program /usr/lib/squid/basic_ncsa_auth
>> ??? /etc/squid/passwd
>> ???? > auth_param basic children 5
>> ???? > auth_param basic realm Squid Basic Authentication
>> ???? > auth_param basic credentialsttl 2 hours
>> ???? > acl auth_users proxy_auth REQUIRED
>> ???? > http_access allow auth_users
>> ???? > http_access deny all
>> ???? >
>> ???? >
>> ???? > Finally:
>> ???? > $ sudo systemctl restart squid
>> ???? >
>> ???? > But, on the client machine, I can visit any website without the
>> ??? username and password.
>> ???? > Which part of the configuration is wrong?
>>
>>
>>
>> ??? Many things could go wrong, but I would start from the beginning:
>> ??? Perhaps the client (browser) is not configured to use the proxy? 
>> Do you
>> ??? see client transactions reflected in Squid access.log? Anything in
>> ??? Squid
>> ??? cache.log?
>>
>> ??? HTH,
>>
>> ??? Alex.
>>
>>
>> ??? _______________________________________________
>> ??? squid-users mailing list
>> ??? squid-users at lists.squid-cache.org
>> ??? <mailto:squid-users at lists.squid-cache.org>
>> ??? https://lists.squid-cache.org/listinfo/squid-users
>> ??? <https://lists.squid-cache.org/listinfo/squid-users>
>>
> 
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> https://lists.squid-cache.org/listinfo/squid-users



From rousskov at measurement-factory.com  Sat Sep  9 22:48:46 2023
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Sat, 9 Sep 2023 18:48:46 -0400
Subject: [squid-users] ICAP reply pipe is full
In-Reply-To: <CADAqQfx7idwOJTPCONgTAy-gyArOF0xdi6=o1rACQTLnnWaXTA@mail.gmail.com>
References: <CADAqQfx7idwOJTPCONgTAy-gyArOF0xdi6=o1rACQTLnnWaXTA@mail.gmail.com>
Message-ID: <a93ed546-1f3c-4675-bafc-fd2b2e2b426c@measurement-factory.com>

On 2023-09-03 09:39, Ben Goz wrote:

> I'm working with squid that sends http/s traffic to a custom c-icap filter.
> I see a lot of ICAP reply debug messages in Squid's cache log.
> 
> kid1| 93,3| ModXact.cc(556) readMore: not reading because ICAP reply pipe is full
> 
> What are the implications of this message?

It implies several things, including that you are looking at debugging 
output meant for Squid developers, not Squid administrators (and this 
mailing list) :-).


> How can I find out what is the root cause of this message?

A Squid developer would start by looking at the corresponding code 
(src/adaptation/icap/ModXact.cc line 556). You can ask here (like you 
are doing), but, IMO, you should not. I recommend focusing on (or 
starting with) the high-level problem you are trying to solve rather 
than a low-level debugging message.


> Can I increase the ICAP reply pipe in Squid's configuration?

You cannot -- the pipe buffer will not grow beyond 64KB, a hard-coded 
limit (BodyPipe::MaxCapacity). However, bugs notwithstanding, the pipe 
may be full not because it is too small, but because the adapted HTTP 
message body consumer on the other side of this pipe (i.e. Squid, Squid 
client, origin server, or cache_peer) cannot consume ICAP response bytes 
fast enough.


HTH,

Alex.



From hack3rcon at yahoo.com  Sun Sep 10 05:54:20 2023
From: hack3rcon at yahoo.com (Jason Long)
Date: Sun, 10 Sep 2023 05:54:20 +0000 (UTC)
Subject: [squid-users] Squid-cache authentication is not working
In-Reply-To: <b7e0cc63-c412-4743-81f8-eb289b477b06@measurement-factory.com>
References: <488889840.3864943.1694264959281.ref@mail.yahoo.com>
 <488889840.3864943.1694264959281@mail.yahoo.com>
 <0db5ad2c-71f9-4e3b-ac89-35c4ea421580@measurement-factory.com>
 <1219940758.3926528.1694286599979@mail.yahoo.com>
 <b7e0cc63-c412-4743-81f8-eb289b477b06@measurement-factory.com>
Message-ID: <859124378.3984982.1694325260684@mail.yahoo.com>

Hello,
Thanks again.
You right, I must move the following lines after the authentication lines:

http_access allow localnet
http_access allow localhost
http_access deny all

It worked.



On Sunday, September 10, 2023 at 01:57:32 AM GMT+3:30, Alex Rousskov <rousskov at measurement-factory.com> wrote: 



On 2023-09-09 15:09, Jason Long wrote:

> My Squid-cache server IP is "192.168.1.2".
> I use Mozilla Firefox and set the proxy to "192.168.1.2:3128".
> What information do you need to tell you?

Do you see Firefox requests/transactions reflected in Squid access.log?

Anything in Squid cache.log?

Sorry, I do not know where those logs are on your machine. Typical 
locations include /var/log/ and /usr/local/squid/var/logs

Another thing to check is whether the http_access rules you have added 
are in the right place. If you simply appended those rules to the 
default Squid configuration file, then they will not work (because 
http_access rules above them will be used instead). Default squid.conf 
marks the place where you should insert custom http_access rules: Look 
for an "INSERT YOUR OWN RULE(S) HERE" comment.

You can check this second theory by removing "http_access allow 
auth_users" and leaving just the "http_access deny all" rule that you 
have added earlier. If everything still works, then either Squid does 
not receive these requests at all (i.e. the first theory) or your access 
rules are too low (i.e. this second theory).


HTH,

Alex.


>? ? On Sat, Sep 9, 2023 at 5:56 PM, Alex Rousskov
>? ? <rousskov at measurement-factory.com> wrote:
>? ? On 2023-09-09 09:09, Jason Long wrote:
> 
>? ? ? > Hello,
>? ? ? > I installed the Squid-cache on Debian 12, then I installed the
>? ? Apache utils:
>? ? ? >
>? ? ? > $ sudo apt install apache2-utils
>? ? ? >
>? ? ? > After it, I did the following steps:
>? ? ? >
>? ? ? > $ sudo touch /etc/squid/passwd
>? ? ? > $ sudo chown proxy /etc/squid/passwd
>? ? ? >
>? ? ? > Then:
>? ? ? >
>? ? ? > $ sudo htpasswd /etc/squid/passwd jason
>? ? ? >
>? ? ? > After it, I opened the "/etc/squid/squid.conf" file and add the
>? ? following lines to it:
>? ? ? >
>? ? ? > auth_param basic program /usr/lib/squid/basic_ncsa_auth
>? ? /etc/squid/passwd
>? ? ? > auth_param basic children 5
>? ? ? > auth_param basic realm Squid Basic Authentication
>? ? ? > auth_param basic credentialsttl 2 hours
>? ? ? > acl auth_users proxy_auth REQUIRED
>? ? ? > http_access allow auth_users
>? ? ? > http_access deny all
>? ? ? >
>? ? ? >
>? ? ? > Finally:
>? ? ? > $ sudo systemctl restart squid
>? ? ? >
>? ? ? > But, on the client machine, I can visit any website without the
>? ? username and password.
>? ? ? > Which part of the configuration is wrong?
> 
> 
> 
>? ? Many things could go wrong, but I would start from the beginning:
>? ? Perhaps the client (browser) is not configured to use the proxy? Do you
>? ? see client transactions reflected in Squid access.log? Anything in
>? ? Squid
>? ? cache.log?
> 
>? ? HTH,
> 
>? ? Alex.
> 
> 
>? ? _______________________________________________
>? ? squid-users mailing list
>? ? squid-users at lists.squid-cache.org
>? ? <mailto:squid-users at lists.squid-cache.org>

>? ? https://lists.squid-cache.org/listinfo/squid-users
>? ? <https://lists.squid-cache.org/listinfo/squid-users>
> 



From hack3rcon at yahoo.com  Sun Sep 10 19:56:07 2023
From: hack3rcon at yahoo.com (Jason Long)
Date: Sun, 10 Sep 2023 19:56:07 +0000 (UTC)
Subject: [squid-users] Does Squid-cache support SOCKS5 protocol?
References: <703054379.4053762.1694375767925.ref@mail.yahoo.com>
Message-ID: <703054379.4053762.1694375767925@mail.yahoo.com>

Hello,Can I use Squid-cache to set up a SOCKS5 proxy server?

Thank you?
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230910/662cb0f9/attachment.htm>

From gkinkie at gmail.com  Sun Sep 10 21:31:41 2023
From: gkinkie at gmail.com (Francesco Chemolli)
Date: Sun, 10 Sep 2023 23:31:41 +0200
Subject: [squid-users] Does Squid-cache support SOCKS5 protocol?
In-Reply-To: <703054379.4053762.1694375767925@mail.yahoo.com>
References: <703054379.4053762.1694375767925.ref@mail.yahoo.com>
 <703054379.4053762.1694375767925@mail.yahoo.com>
Message-ID: <CA+Y8hcPSUQys_px3ESZ8vpfHmEB-i6zZAY+S_BRiNFAU4ofoZg@mail.gmail.com>

Hi,
  no, you can't. Squid can be a socks5 client, but not a socks5 server.

On Sun, Sep 10, 2023 at 9:56?PM Jason Long <hack3rcon at yahoo.com> wrote:

> Hello,
> Can I use Squid-cache to set up a SOCKS5 proxy server?
>
> Thank you
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> https://lists.squid-cache.org/listinfo/squid-users
>


-- 
    Francesco
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230910/6e2706bf/attachment.htm>

From ngtech1ltd at gmail.com  Mon Sep 11 08:16:04 2023
From: ngtech1ltd at gmail.com (ngtech1ltd at gmail.com)
Date: Mon, 11 Sep 2023 11:16:04 +0300
Subject: [squid-users] Squid 6.2 with WCCP
In-Reply-To: <60aa4884-6bd5-481b-9995-52636dda4d1f@treenet.co.nz>
References: <LO0P265MB5503918F5857C242D659CF91F01EA@LO0P265MB5503.GBRP265.PROD.OUTLOOK.COM>
 <a41412c6-936e-c6f1-d2fd-a204e71c1dc8@measurement-factory.com>
 <60aa4884-6bd5-481b-9995-52636dda4d1f@treenet.co.nz>
Message-ID: <000401d9e488$359ce460$a0d6ad20$@gmail.com>

Hey,

What is required for testing the wccp code?
I can try to get a Cisco device for a basic testing.
Is there a specific bug report we can follow on this issue or maybe we should follow on the PR?

Eliezer

-----Original Message-----
From: squid-users <squid-users-bounces at lists.squid-cache.org> On Behalf Of Amos Jeffries
Sent: Tuesday, August 22, 2023 15:16
To: squid-users at lists.squid-cache.org
Subject: Re: [squid-users] Squid 6.2 with WCCP

On 22/08/23 01:34, Alex Rousskov wrote:
> On 8/21/23 05:06, Callum Haywood wrote:
>> 
>> Does anyone understand what is causing these errors? Are there any 
>> known issues or patches in progress?
> 
> A few years ago, several serious problems were discovered in WCCP code, 
> including security vulnerabilities:
> 
> https://github.com/squid-cache/squid/security/advisories/GHSA-rgf3-9v3p-qp82
> 
> Some of the WCCP bugs were fixed without testing; developers fixing 
> those bugs could not easily test WCCP. Some of the old WCCP bugs 
> remained and some of the new fixes were buggy.
> 
> Today, WCCP code remains problematic. If your customers rely on WCCP, 
> consider investing into revamping that neglected and buggy feature.
> 

This PR <https://github.com/squid-cache/squid/pull/970> has some 
progress towards a fix of those. See the latest comment (currently Sept 
2022) for issues that still need to be resolved before that PR is ready 
for merge attempt.

The major issue remains the ability to test.

HTH
Amos
_______________________________________________
squid-users mailing list
squid-users at lists.squid-cache.org
http://lists.squid-cache.org/listinfo/squid-users



From hack3rcon at yahoo.com  Mon Sep 11 09:23:13 2023
From: hack3rcon at yahoo.com (Jason Long)
Date: Mon, 11 Sep 2023 09:23:13 +0000 (UTC)
Subject: [squid-users] Does Squid-cache support SOCKS5 protocol?
In-Reply-To: <CA+Y8hcPSUQys_px3ESZ8vpfHmEB-i6zZAY+S_BRiNFAU4ofoZg@mail.gmail.com>
References: <703054379.4053762.1694375767925.ref@mail.yahoo.com>
 <703054379.4053762.1694375767925@mail.yahoo.com>
 <CA+Y8hcPSUQys_px3ESZ8vpfHmEB-i6zZAY+S_BRiNFAU4ofoZg@mail.gmail.com>
Message-ID: <1544256240.4163967.1694424193191@mail.yahoo.com>

Hello,
Thank you so much for your reply.
Does the Squid-cache?team have any plans to add this feature?




On Monday, September 11, 2023 at 01:01:55 AM GMT+3:30, Francesco Chemolli <gkinkie at gmail.com> wrote: 


Hi,
? no, you can't. Squid can be a socks5 client, but not a socks5 server.

On Sun, Sep 10, 2023 at 9:56?PM Jason Long <hack3rcon at yahoo.com> wrote:
> Hello,
> Can I use Squid-cache to set up a SOCKS5 proxy server?
> 
> Thank you?
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> https://lists.squid-cache.org/listinfo/squid-users
> 


-- 
? ? Francesco



From uhlar at fantomas.sk  Mon Sep 11 10:20:16 2023
From: uhlar at fantomas.sk (Matus UHLAR - fantomas)
Date: Mon, 11 Sep 2023 12:20:16 +0200
Subject: [squid-users] Does Squid-cache support SOCKS5 protocol?
In-Reply-To: <1544256240.4163967.1694424193191@mail.yahoo.com>
References: <703054379.4053762.1694375767925.ref@mail.yahoo.com>
 <703054379.4053762.1694375767925@mail.yahoo.com>
 <CA+Y8hcPSUQys_px3ESZ8vpfHmEB-i6zZAY+S_BRiNFAU4ofoZg@mail.gmail.com>
 <1544256240.4163967.1694424193191@mail.yahoo.com>
Message-ID: <ZP7p4H7ylVk9/hWb@fantomas.sk>

>On Sun, Sep 10, 2023 at 9:56?PM Jason Long <hack3rcon at yahoo.com> wrote:
>> Can I use Squid-cache to set up a SOCKS5 proxy server?

>On Monday, September 11, 2023 at 01:01:55 AM GMT+3:30, Francesco Chemolli <gkinkie at gmail.com> wrote:
>? no, you can't. Squid can be a socks5 client, but not a socks5 server.

On 11.09.23 09:23, Jason Long wrote:
>Thank you so much for your reply.
>Does the Squid-cache?team have any plans to add this feature?

There is project to support is but it needs testing and programmer's work:

https://wiki.squid-cache.org/Features/Socks

-- 
Matus UHLAR - fantomas, uhlar at fantomas.sk ; http://www.fantomas.sk/
Warning: I wish NOT to receive e-mail advertising to this address.
Varovanie: na tuto adresu chcem NEDOSTAVAT akukolvek reklamnu postu.
On the other hand, you have different fingers.


From gkinkie at gmail.com  Mon Sep 11 12:43:53 2023
From: gkinkie at gmail.com (Francesco Chemolli)
Date: Mon, 11 Sep 2023 14:43:53 +0200
Subject: [squid-users] Does Squid-cache support SOCKS5 protocol?
In-Reply-To: <1544256240.4163967.1694424193191@mail.yahoo.com>
References: <703054379.4053762.1694375767925.ref@mail.yahoo.com>
 <703054379.4053762.1694375767925@mail.yahoo.com>
 <CA+Y8hcPSUQys_px3ESZ8vpfHmEB-i6zZAY+S_BRiNFAU4ofoZg@mail.gmail.com>
 <1544256240.4163967.1694424193191@mail.yahoo.com>
Message-ID: <CA+Y8hcPS9DQw=gdnR5oiFCYzugt=378eCTBQyDjK_omYaXtROA@mail.gmail.com>

Hi Jason,
  as far as I'm aware, none of the active developers is interested in
adding it as a feature.
But as with any free/open source software, all that is needed is that
someone contribute the code :)


On Mon, Sep 11, 2023 at 11:23?AM Jason Long <hack3rcon at yahoo.com> wrote:

> Hello,
> Thank you so much for your reply.
> Does the Squid-cache team have any plans to add this feature?
>
>
>
>
> On Monday, September 11, 2023 at 01:01:55 AM GMT+3:30, Francesco Chemolli <
> gkinkie at gmail.com> wrote:
>
>
> Hi,
>   no, you can't. Squid can be a socks5 client, but not a socks5 server.
>
> On Sun, Sep 10, 2023 at 9:56?PM Jason Long <hack3rcon at yahoo.com> wrote:
> > Hello,
> > Can I use Squid-cache to set up a SOCKS5 proxy server?
> >
> > Thank you
> > _______________________________________________
> > squid-users mailing list
> > squid-users at lists.squid-cache.org
> > https://lists.squid-cache.org/listinfo/squid-users
> >
>
>
> --
>     Francesco
>
>

-- 
    Francesco
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230911/887bd9bd/attachment.htm>

From gtaylor at tnetconsulting.net  Mon Sep 11 23:29:16 2023
From: gtaylor at tnetconsulting.net (Grant Taylor)
Date: Mon, 11 Sep 2023 18:29:16 -0500
Subject: [squid-users] Does Squid-cache support SOCKS5 protocol?
In-Reply-To: <1544256240.4163967.1694424193191@mail.yahoo.com>
References: <703054379.4053762.1694375767925.ref@mail.yahoo.com>
 <703054379.4053762.1694375767925@mail.yahoo.com>
 <CA+Y8hcPSUQys_px3ESZ8vpfHmEB-i6zZAY+S_BRiNFAU4ofoZg@mail.gmail.com>
 <1544256240.4163967.1694424193191@mail.yahoo.com>
Message-ID: <95a13ec1-a141-a227-410f-08edc8c7e6a3@tnetconsulting.net>

On 9/11/23 4:23?AM, Jason Long wrote:
> Does the Squid-cache?team have any plans to add this feature?

Is there a particular reason that you want to see Squid add support as a 
SOCKS server verses using a different existing SOCKS server?  E.g. Dante 
SOCKS server?

Dante is quite capable and can do a LOT of things.



-- 
Grant. . . .
unix || die



From squid3 at treenet.co.nz  Tue Sep 12 05:20:02 2023
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Tue, 12 Sep 2023 17:20:02 +1200
Subject: [squid-users] Squid 6.2 with WCCP
In-Reply-To: <000401d9e488$359ce460$a0d6ad20$@gmail.com>
References: <LO0P265MB5503918F5857C242D659CF91F01EA@LO0P265MB5503.GBRP265.PROD.OUTLOOK.COM>
 <a41412c6-936e-c6f1-d2fd-a204e71c1dc8@measurement-factory.com>
 <60aa4884-6bd5-481b-9995-52636dda4d1f@treenet.co.nz>
 <000401d9e488$359ce460$a0d6ad20$@gmail.com>
Message-ID: <9c8e62a1-eab0-4c27-bb60-ec0df25f0223@treenet.co.nz>

On 11/09/23 20:16, ngtech1ltd wrote:
> Hey,
> 
> What is required for testing the wccp code?


At minimum a Router or Switch with WCCPv2, plus separate machines for 
client and proxy.

Ideally;
  * at least two router/switch to test the changed code handling 
multiple routers.
  * ability to test both Mask and GRE assignment methods.
  * ability to test a mix of the capability and security settings in WCCPv2.


> I can try to get a Cisco device for a basic testing.
> Is there a specific bug report we can follow on this issue or maybe we should follow on the PR?
> 

Test results in the PR please.

Cheers
Amos


> Eliezer
> 
> -----Original Message-----
> From: Amos Jeffries
> Sent: Tuesday, August 22, 2023 15:16
> 
> On 22/08/23 01:34, Alex Rousskov wrote:
>> On 8/21/23 05:06, Callum Haywood wrote:
>>>
>>> Does anyone understand what is causing these errors? Are there any
>>> known issues or patches in progress?
>>
>> A few years ago, several serious problems were discovered in WCCP code,
>> including security vulnerabilities:
>>
>> https://github.com/squid-cache/squid/security/advisories/GHSA-rgf3-9v3p-qp82
>>
>> Some of the WCCP bugs were fixed without testing; developers fixing
>> those bugs could not easily test WCCP. Some of the old WCCP bugs
>> remained and some of the new fixes were buggy.
>>
>> Today, WCCP code remains problematic. If your customers rely on WCCP,
>> consider investing into revamping that neglected and buggy feature.
>>
> 
> This PR <https://github.com/squid-cache/squid/pull/970> has some
> progress towards a fix of those. See the latest comment (currently Sept
> 2022) for issues that still need to be resolved before that PR is ready
> for merge attempt.
> 
> The major issue remains the ability to test.
> 
> HTH
> Amos
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> http://lists.squid-cache.org/listinfo/squid-users
> 
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> https://lists.squid-cache.org/listinfo/squid-users


From uhlar at fantomas.sk  Tue Sep 12 06:37:47 2023
From: uhlar at fantomas.sk (Matus UHLAR - fantomas)
Date: Tue, 12 Sep 2023 08:37:47 +0200
Subject: [squid-users] Does Squid-cache support SOCKS5 protocol?
In-Reply-To: <95a13ec1-a141-a227-410f-08edc8c7e6a3@tnetconsulting.net>
References: <703054379.4053762.1694375767925.ref@mail.yahoo.com>
 <703054379.4053762.1694375767925@mail.yahoo.com>
 <CA+Y8hcPSUQys_px3ESZ8vpfHmEB-i6zZAY+S_BRiNFAU4ofoZg@mail.gmail.com>
 <1544256240.4163967.1694424193191@mail.yahoo.com>
 <95a13ec1-a141-a227-410f-08edc8c7e6a3@tnetconsulting.net>
Message-ID: <ZQAHO+4+Tt9dGwSw@fantomas.sk>

>On 9/11/23 4:23?AM, Jason Long wrote:
>>Does the Squid-cache?team have any plans to add this feature?

On 11.09.23 18:29, Grant Taylor wrote:
>Is there a particular reason that you want to see Squid add support as 
>a SOCKS server verses using a different existing SOCKS server?  E.g. 
>Dante SOCKS server?
>
>Dante is quite capable and can do a LOT of things.

To be frank, having configuration, logging and ACL's on one place made me 
also think to use SQUID for SOCKS in the past.

But for SOCKS I use Dante because of that.

-- 
Matus UHLAR - fantomas, uhlar at fantomas.sk ; http://www.fantomas.sk/
Warning: I wish NOT to receive e-mail advertising to this address.
Varovanie: na tuto adresu chcem NEDOSTAVAT akukolvek reklamnu postu.
There's a long-standing bug relating to the x86 architecture that
allows you to install Windows.   -- Matthew D. Fuller


From hack3rcon at yahoo.com  Tue Sep 12 10:07:25 2023
From: hack3rcon at yahoo.com (Jason Long)
Date: Tue, 12 Sep 2023 10:07:25 +0000 (UTC)
Subject: [squid-users] Does Squid-cache support SOCKS5 protocol?
In-Reply-To: <ZQAHO+4+Tt9dGwSw@fantomas.sk>
References: <703054379.4053762.1694375767925.ref@mail.yahoo.com>
 <703054379.4053762.1694375767925@mail.yahoo.com>
 <CA+Y8hcPSUQys_px3ESZ8vpfHmEB-i6zZAY+S_BRiNFAU4ofoZg@mail.gmail.com>
 <1544256240.4163967.1694424193191@mail.yahoo.com>
 <95a13ec1-a141-a227-410f-08edc8c7e6a3@tnetconsulting.net>
 <ZQAHO+4+Tt9dGwSw@fantomas.sk>
Message-ID: <1048420643.134580.1694513245943@mail.yahoo.com>

Hello,
Thank you so much for your reply.
Dante (https://www.inet.no/dante/)? How does it performance?
Can it also act as an HTTP server?






On Tuesday, September 12, 2023 at 10:08:01 AM GMT+3:30, Matus UHLAR - fantomas <uhlar at fantomas.sk> wrote: 


>On 9/11/23 4:23?AM, Jason Long wrote:
>>Does the Squid-cache?team have any plans to add this feature?

On 11.09.23 18:29, Grant Taylor wrote:
>Is there a particular reason that you want to see Squid add support as 
>a SOCKS server verses using a different existing SOCKS server?? E.g. 
>Dante SOCKS server?
>
>Dante is quite capable and can do a LOT of things.

To be frank, having configuration, logging and ACL's on one place made me 
also think to use SQUID for SOCKS in the past.

But for SOCKS I use Dante because of that.

-- 
Matus UHLAR - fantomas, uhlar at fantomas.sk ; http://www.fantomas.sk/
Warning: I wish NOT to receive e-mail advertising to this address.
Varovanie: na tuto adresu chcem NEDOSTAVAT akukolvek reklamnu postu.
There's a long-standing bug relating to the x86 architecture that
allows you to install Windows.? -- Matthew D. Fuller
_______________________________________________
squid-users mailing list
squid-users at lists.squid-cache.org
https://lists.squid-cache.org/listinfo/squid-users


From uhlar at fantomas.sk  Tue Sep 12 12:51:22 2023
From: uhlar at fantomas.sk (Matus UHLAR - fantomas)
Date: Tue, 12 Sep 2023 14:51:22 +0200
Subject: [squid-users] Does Squid-cache support SOCKS5 protocol?
In-Reply-To: <1048420643.134580.1694513245943@mail.yahoo.com>
References: <703054379.4053762.1694375767925.ref@mail.yahoo.com>
 <703054379.4053762.1694375767925@mail.yahoo.com>
 <CA+Y8hcPSUQys_px3ESZ8vpfHmEB-i6zZAY+S_BRiNFAU4ofoZg@mail.gmail.com>
 <1544256240.4163967.1694424193191@mail.yahoo.com>
 <95a13ec1-a141-a227-410f-08edc8c7e6a3@tnetconsulting.net>
 <ZQAHO+4+Tt9dGwSw@fantomas.sk>
 <1048420643.134580.1694513245943@mail.yahoo.com>
Message-ID: <ZQBeyk6AszroVWIz@fantomas.sk>

n 12.09.23 10:07, Jason Long wrote:
>Thank you so much for your reply.
>Dante (https://www.inet.no/dante/)? How does it performance?

yes, that one. performance is fine.

>Can it also act as an HTTP server?

No. It's strictly SOCKS server.


-- 
Matus UHLAR - fantomas, uhlar at fantomas.sk ; http://www.fantomas.sk/
Warning: I wish NOT to receive e-mail advertising to this address.
Varovanie: na tuto adresu chcem NEDOSTAVAT akukolvek reklamnu postu.
LSD will make your ECS screen display 16.7 million colors


From technik at kjj.cz  Tue Sep 12 14:21:09 2023
From: technik at kjj.cz (=?UTF-8?B?TG91xI1hbnNrw70gTHVrw6HFoQ==?=)
Date: Tue, 12 Sep 2023 16:21:09 +0200
Subject: [squid-users] Squid BUG: assurance failed:
 tok.skip(WellKnownUrlPathPrefix())
Message-ID: <37e6b005-6d0a-b50f-19c2-a524320dccb5@kjj.cz>

Hello, today I was going to compile a new version of my beloved squid 
proxy (v6.3 or 6.3-20230903-ra9c06aa6a) just to be welcomed by non 
working older configmgr.cgi and [debian package installed] squidclient 
(v4.6). After replacing squidclient with (compiled with squid) version 
6.3 it's still not working, giving me accesss denied page.

My cache.log contains these bug info lines:

023/09/12 16:07:03 kid3| ERROR: Squid BUG: assurance failed: 
tok.skip(WellKnownUrlPathPrefix())
 ??? exception location: cache_manager.cc(193) ParseUrl
 ??? current master transaction: master469155
2023/09/12 16:07:03 kid3| ERROR: Squid BUG: assurance failed: 
tok.skip(WellKnownUrlPathPrefix())
 ??? exception location: cache_manager.cc(193) ParseUrl
 ??? current master transaction: master469155

In the file src/cache_manager.cc there is this

const SBuf &
CacheManager::WellKnownUrlPathPrefix()
{
 ??? static const SBuf prefix("/squid-internal-mgr/");
 ??? return prefix;
}

and on the line 193 is this assure (after tok tokenizer)

 ?Parser::Tokenizer tok(uri.path());

 ??? Assure(tok.skip(WellKnownUrlPathPrefix()));

Is there something wrong with my config I should change after 6.2 to 6.3 
upgrade? I have some classic http_access manager allow ... and 
http_access manager deny lines. No definition what [acl] manager means.

I have found some mentions here 
https://github.com/squid-cache/squid/blob/master/ChangeLog and somewhere 
inside the commit / review git hub section for squid. But nothing says 
what to do make it work right. Besides this it seems squid as a proxy 
works fine...

Thanks

Lukas





From rousskov at measurement-factory.com  Tue Sep 12 14:48:00 2023
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Tue, 12 Sep 2023 10:48:00 -0400
Subject: [squid-users] Squid BUG: assurance failed:
 tok.skip(WellKnownUrlPathPrefix())
In-Reply-To: <37e6b005-6d0a-b50f-19c2-a524320dccb5@kjj.cz>
References: <37e6b005-6d0a-b50f-19c2-a524320dccb5@kjj.cz>
Message-ID: <d42a6203-ca8d-4964-b3da-16f9479e17e9@measurement-factory.com>

On 2023-09-12 10:21, Lou?ansk? Luk?? wrote:
> today I was going to compile a new version of my beloved squid 
> proxy (v6.3 or 6.3-20230903-ra9c06aa6a)

FWIW, "was going to compile" part does not make it clear (to me) whether 
you did actually compile/test v6.3.


> just to be welcomed by non 
> working older configmgr.cgi and [debian package installed] squidclient 
> (v4.6). After replacing squidclient with (compiled with squid) version 
> 6.3 it's still not working, giving me accesss denied page.
> 
> My cache.log contains these bug info lines:
> 
> 023/09/12 16:07:03 kid3| ERROR: Squid BUG: assurance failed: 
> tok.skip(WellKnownUrlPathPrefix())
>  ??? exception location: cache_manager.cc(193) ParseUrl


If the above output is from Squid v6.3, then you may have found a v6.3 
problem that we do not know about. Please share the HTTP request that 
triggers the above output.

Otherwise, please try to upgrade to Squid v6.3 because its commit 
6695897 is meant to fix a v6.1 bug with the above symptoms.


Thank you,

Alex.


>  ??? current master transaction: master469155
> 2023/09/12 16:07:03 kid3| ERROR: Squid BUG: assurance failed: 
> tok.skip(WellKnownUrlPathPrefix())
>  ??? exception location: cache_manager.cc(193) ParseUrl
>  ??? current master transaction: master469155
> 
> In the file src/cache_manager.cc there is this
> 
> const SBuf &
> CacheManager::WellKnownUrlPathPrefix()
> {
>  ??? static const SBuf prefix("/squid-internal-mgr/");
>  ??? return prefix;
> }
> 
> and on the line 193 is this assure (after tok tokenizer)
> 
>  ?Parser::Tokenizer tok(uri.path());
> 
>  ??? Assure(tok.skip(WellKnownUrlPathPrefix()));
> 
> Is there something wrong with my config I should change after 6.2 to 6.3 
> upgrade? I have some classic http_access manager allow ... and 
> http_access manager deny lines. No definition what [acl] manager means.
> 
> I have found some mentions here 
> https://github.com/squid-cache/squid/blob/master/ChangeLog and somewhere 
> inside the commit / review git hub section for squid. But nothing says 
> what to do make it work right. Besides this it seems squid as a proxy 
> works fine...
> 
> Thanks
> 
> Lukas
> 
> 
> 
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> https://lists.squid-cache.org/listinfo/squid-users



From Loucansky.Lukas at kjj.cz  Tue Sep 12 16:23:18 2023
From: Loucansky.Lukas at kjj.cz (=?iso-8859-2?B?TG916GFuc2v9IEx1a+G5?=)
Date: Tue, 12 Sep 2023 18:23:18 +0200
Subject: [squid-users] Squid BUG: assurance failed:
 tok.skip(WellKnownUrlPathPrefix())
References: <37e6b005-6d0a-b50f-19c2-a524320dccb5@kjj.cz>
 <d42a6203-ca8d-4964-b3da-16f9479e17e9@measurement-factory.com>
Message-ID: <72DD5D5CF661B5459DC08A060BF26B53C45E63@kjj-server.KJJ.local>

Hello Alex - here is the output of squid -v command:

squid -v
Squid Cache: Version 6.3-20230903-ra9c06aa6a
Service Name: squid
no IPV6

This binary uses OpenSSL 1.1.1n  15 Mar 2022. For legal restrictions on distribution see https://www.openssl.org/source/license.html

configure options:  '--build=x86_64-linux-gnu' '--prefix=/usr' '--includedir=/include' '--mandir=/share/man' '--infodir=/share/info' '--sysconfdir=/etc' '--localstatedir=/var' '--libexecdir=/lib/squid5' '--disable-maintainer-mode' '--disable-silent-rules' '--datadir=/usr/share/squid5' '--sysconfdir=/etc/squid5' '--mandir=/usr/share/man' '--enable-build-info=no IPV6' '--enable-inline' '--enable-arp-acl' '--disable-wccp' '--disable-wccp2' '--disable-htcp--disable-arch-native' '--disable-ipv6' '--enable-optimizations' '--enable-storeio=ufs,aufs,diskd,rock' '--enable-removal-policies=lru,heap' '--enable-delay-pools' '--enable-cache-digests' '--enable-icap-client' '--enable-follow-x-forwarded-for' '--enable-auth-basic=DB,fake,getpwnam,LDAP,NCSA,NIS,PAM,POP3,RADIUS,SASL,SMB' '--enable-auth-digest=file,LDAP' '--enable-auth-negotiate=kerberos,wrapper' '--enable-auth-ntlm=fake,SMB_LM' '--enable-external-acl-helpers=file_userip,kerberos_ldap_group,LDAP_group,session,SQL_session,time_quota,unix_group,wbinfo_group' '--enable-url-rewrite-helpers=fake' '--enable-security-cert-validators=fake' '--enable-storeid-rewrite-helpers=file' '--enable-eui' '--enable-esi' '--enable-icmp' '--enable-zph-qos' '--enable-ecap' '--enable-snmp' '--disable-ident-lookups' '--disable-translation' '--with-swapdir=/var/spool/squid5' '--with-logdir=/var/log/squid5' '--with-pidfile=/var/run/squid5.pid' '--with-large-files' '--with-default-user=proxy' '--with-openssl' '--with-filedescriptors=8192' '--enable-ssl-crtd' '--enable-security-cert-generators' '--enable-security-cert-validators' '--enable-linux-netfilter' '--enable-stacktraces' 'PKG_CONFIG_PATH=:/usr/local/lib/pkgconfig:/usr/lib64/pkgconfig:/usr/share/pkgconfig' 'CFLAGS=-g -O2 -m64 -fPIE -fstack-protector-strong -Wformat -Werror=format-security -Wall' 'LDFLAGS=-fPIE -pie -Wl,-z,relro -Wl,-z,now' 'CPPFLAGS=-D_FORTIFY_SOURCE=2' 'CXXFLAGS=-g -O2 -m64 -fPIE -fstack-protector-strong -Wformat -Werror=format-security' 'build_alias=x86_64-linux-gnu'

Please note two things - I was using 5.x branch for some time (ie. squid5 prefix) and lately did upgrade to 6.x as the developers said 5.x is EOL/not maintained, I do not have native ipv6 so I had some tun6to4 tunel to closed broker - so now I do not have ipv6 connectivity. So I decided to set --disable-ipv6 for now.

I have gcc
 gcc -v
Using built-in specs.
COLLECT_GCC=gcc
COLLECT_LTO_WRAPPER=/usr/lib/gcc/x86_64-linux-gnu/8/lto-wrapper
OFFLOAD_TARGET_NAMES=nvptx-none
OFFLOAD_TARGET_DEFAULT=1
Target: x86_64-linux-gnu
Configured with: ../src/configure -v --with-pkgversion='Debian 8.3.0-6' --with-bugurl=file:///usr/share/doc/gcc-8/README.Bugs --enable-languages=c,ada,c++,go,brig,d,fortran,objc,obj-c++ --prefix=/usr --with-gcc-major-version-only --program-suffix=-8 --program-prefix=x86_64-linux-gnu- --enable-shared --enable-linker-build-id --libexecdir=/usr/lib --without-included-gettext --enable-threads=posix --libdir=/usr/lib --enable-nls --enable-bootstrap --enable-clocale=gnu --enable-libstdcxx-debug --enable-libstdcxx-time=yes --with-default-libstdcxx-abi=new --enable-gnu-unique-object --disable-vtable-verify --enable-libmpx --enable-plugin --enable-default-pie --with-system-zlib --with-target-system-zlib --enable-objc-gc=auto --enable-multiarch --disable-werror --with-arch-32=i686 --with-abi=m64 --with-multilib-list=m32,m64,mx32 --enable-multilib --with-tune=generic --enable-offload-targets=nvptx-none --without-cuda-driver --enable-checking=release --build=x86_64-linux-gnu --host=x86_64-linux-gnu --target=x86_64-linux-gnu
Thread model: posix
gcc version 8.3.0 (Debian 8.3.0-6)

with Debian 10 x64

LL


-----P?vodn? zpr?va-----
Od: squid-users za u?ivatele Alex Rousskov
Odesl?no: ?t 12.9.2023 16:48
Komu: squid-users at lists.squid-cache.org
P?edm?t: Re: [squid-users] Squid BUG: assurance failed: tok.skip(WellKnownUrlPathPrefix())
 
On 2023-09-12 10:21, Lou?ansk? Luk?? wrote:
> today I was going to compile a new version of my beloved squid 
> proxy (v6.3 or 6.3-20230903-ra9c06aa6a)

FWIW, "was going to compile" part does not make it clear (to me) whether 
you did actually compile/test v6.3.


> just to be welcomed by non 
> working older configmgr.cgi and [debian package installed] squidclient 
> (v4.6). After replacing squidclient with (compiled with squid) version 
> 6.3 it's still not working, giving me accesss denied page.
> 
> My cache.log contains these bug info lines:
> 
> 023/09/12 16:07:03 kid3| ERROR: Squid BUG: assurance failed: 
> tok.skip(WellKnownUrlPathPrefix())
>  ??? exception location: cache_manager.cc(193) ParseUrl


If the above output is from Squid v6.3, then you may have found a v6.3 
problem that we do not know about. Please share the HTTP request that 
triggers the above output.

Otherwise, please try to upgrade to Squid v6.3 because its commit 
6695897 is meant to fix a v6.1 bug with the above symptoms.


Thank you,

Alex.


>  ??? current master transaction: master469155
> 2023/09/12 16:07:03 kid3| ERROR: Squid BUG: assurance failed: 
> tok.skip(WellKnownUrlPathPrefix())
>  ??? exception location: cache_manager.cc(193) ParseUrl
>  ??? current master transaction: master469155
> 
> In the file src/cache_manager.cc there is this
> 
> const SBuf &
> CacheManager::WellKnownUrlPathPrefix()
> {
>  ??? static const SBuf prefix("/squid-internal-mgr/");
>  ??? return prefix;
> }
> 
> and on the line 193 is this assure (after tok tokenizer)
> 
>  ?Parser::Tokenizer tok(uri.path());
> 
>  ??? Assure(tok.skip(WellKnownUrlPathPrefix()));
> 
> Is there something wrong with my config I should change after 6.2 to 6.3 
> upgrade? I have some classic http_access manager allow ... and 
> http_access manager deny lines. No definition what [acl] manager means.
> 
> I have found some mentions here 
> https://github.com/squid-cache/squid/blob/master/ChangeLog and somewhere 
> inside the commit / review git hub section for squid. But nothing says 
> what to do make it work right. Besides this it seems squid as a proxy 
> works fine...
> 
> Thanks
> 
> Lukas
> 
> 
> 
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> https://lists.squid-cache.org/listinfo/squid-users

_______________________________________________
squid-users mailing list
squid-users at lists.squid-cache.org
https://lists.squid-cache.org/listinfo/squid-users


-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230912/da449f18/attachment.htm>

From Loucansky.Lukas at kjj.cz  Tue Sep 12 17:06:12 2023
From: Loucansky.Lukas at kjj.cz (=?iso-8859-2?B?TG916GFuc2v9IEx1a+G5?=)
Date: Tue, 12 Sep 2023 19:06:12 +0200
Subject: [squid-users] Squid BUG: assurance failed:
 tok.skip(WellKnownUrlPathPrefix())
References: <37e6b005-6d0a-b50f-19c2-a524320dccb5@kjj.cz>
 <d42a6203-ca8d-4964-b3da-16f9479e17e9@measurement-factory.com>
 <72DD5D5CF661B5459DC08A060BF26B53C45E63@kjj-server.KJJ.local>
Message-ID: <72DD5D5CF661B5459DC08A060BF26B53C45E64@kjj-server.KJJ.local>

Is this anyhow interesting?

2023/09/12 18:47:04.267 kid4| 24,8| SBuf.cc(30) SBuf: SBuf15514952 created
2023/09/12 18:47:04.267 kid4| 24,8| SBuf.cc(30) SBuf: SBuf15514953 created
2023/09/12 18:47:04.267 kid4| 24,8| SBuf.cc(30) SBuf: SBuf15514954 created
2023/09/12 18:47:04.267 kid4| 24,7| SBuf.cc(85) assign: assigning SBuf15514952 from SBuf15514912
2023/09/12 18:47:04.267 kid4| 24,8| SBuf.cc(38) SBuf: SBuf15514955 created from id SBuf15514915
2023/09/12 18:47:04.267 kid4| 24,8| SBuf.cc(445) startsWith: SBuf15514955 startsWith SBuf125812, caseSensitive: 0
2023/09/12 18:47:04.267 kid4| 24,8| SBuf.cc(447) startsWith: no, too short
2023/09/12 18:47:04.267 kid4| 24,8| Tokenizer.cc(185) skip: no match, not skipping '/squid-internal-mgr/'
2023/09/12 18:47:04 kid4| ERROR: Squid BUG: assurance failed: tok.skip(WellKnownUrlPathPrefix())
2023/09/12 18:47:04.268 kid4| 24,8| SBuf.cc(70) ~SBuf: SBuf15514955 destructed


BTW debug 24,9 makes pretty big log files... :-)

L

-----P?vodn? zpr?va-----
Od: squid-users za u?ivatele Lou?ansk? Luk??
Odesl?no: ?t 12.9.2023 18:23
Komu: squid-users at lists.squid-cache.org
P?edm?t: Re: [squid-users] Squid BUG: assurance failed: tok.skip(WellKnownUrlPathPrefix())
 
Hello Alex - here is the output of squid -v command:

squid -v
Squid Cache: Version 6.3-20230903-ra9c06aa6a
Service Name: squid
no IPV6

This binary uses OpenSSL 1.1.1n  15 Mar 2022. For legal restrictions on distribution see https://www.openssl.org/source/license.html

configure options:  '--build=x86_64-linux-gnu' '--prefix=/usr' '--includedir=/include' '--mandir=/share/man' '--infodir=/share/info' '--sysconfdir=/etc' '--localstatedir=/var' '--libexecdir=/lib/squid5' '--disable-maintainer-mode' '--disable-silent-rules' '--datadir=/usr/share/squid5' '--sysconfdir=/etc/squid5' '--mandir=/usr/share/man' '--enable-build-info=no IPV6' '--enable-inline' '--enable-arp-acl' '--disable-wccp' '--disable-wccp2' '--disable-htcp--disable-arch-native' '--disable-ipv6' '--enable-optimizations' '--enable-storeio=ufs,aufs,diskd,rock' '--enable-removal-policies=lru,heap' '--enable-delay-pools' '--enable-cache-digests' '--enable-icap-client' '--enable-follow-x-forwarded-for' '--enable-auth-basic=DB,fake,getpwnam,LDAP,NCSA,NIS,PAM,POP3,RADIUS,SASL,SMB' '--enable-auth-digest=file,LDAP' '--enable-auth-negotiate=kerberos,wrapper' '--enable-auth-ntlm=fake,SMB_LM' '--enable-external-acl-helpers=file_userip,kerberos_ldap_group,LDAP_group,session,SQL_session,time_quota,unix_group,wbinfo_group' '--enable-url-rewrite-helpers=fake' '--enable-security-cert-validators=fake' '--enable-storeid-rewrite-helpers=file' '--enable-eui' '--enable-esi' '--enable-icmp' '--enable-zph-qos' '--enable-ecap' '--enable-snmp' '--disable-ident-lookups' '--disable-translation' '--with-swapdir=/var/spool/squid5' '--with-logdir=/var/log/squid5' '--with-pidfile=/var/run/squid5.pid' '--with-large-files' '--with-default-user=proxy' '--with-openssl' '--with-filedescriptors=8192' '--enable-ssl-crtd' '--enable-security-cert-generators' '--enable-security-cert-validators' '--enable-linux-netfilter' '--enable-stacktraces' 'PKG_CONFIG_PATH=:/usr/local/lib/pkgconfig:/usr/lib64/pkgconfig:/usr/share/pkgconfig' 'CFLAGS=-g -O2 -m64 -fPIE -fstack-protector-strong -Wformat -Werror=format-security -Wall' 'LDFLAGS=-fPIE -pie -Wl,-z,relro -Wl,-z,now' 'CPPFLAGS=-D_FORTIFY_SOURCE=2' 'CXXFLAGS=-g -O2 -m64 -fPIE -fstack-protector-strong -Wformat -Werror=format-security' 'build_alias=x86_64-linux-gnu'

Please note two things - I was using 5.x branch for some time (ie. squid5 prefix) and lately did upgrade to 6.x as the developers said 5.x is EOL/not maintained, I do not have native ipv6 so I had some tun6to4 tunel to closed broker - so now I do not have ipv6 connectivity. So I decided to set --disable-ipv6 for now.

I have gcc
 gcc -v
Using built-in specs.
COLLECT_GCC=gcc
COLLECT_LTO_WRAPPER=/usr/lib/gcc/x86_64-linux-gnu/8/lto-wrapper
OFFLOAD_TARGET_NAMES=nvptx-none
OFFLOAD_TARGET_DEFAULT=1
Target: x86_64-linux-gnu
Configured with: ../src/configure -v --with-pkgversion='Debian 8.3.0-6' --with-bugurl=file:///usr/share/doc/gcc-8/README.Bugs --enable-languages=c,ada,c++,go,brig,d,fortran,objc,obj-c++ --prefix=/usr --with-gcc-major-version-only --program-suffix=-8 --program-prefix=x86_64-linux-gnu- --enable-shared --enable-linker-build-id --libexecdir=/usr/lib --without-included-gettext --enable-threads=posix --libdir=/usr/lib --enable-nls --enable-bootstrap --enable-clocale=gnu --enable-libstdcxx-debug --enable-libstdcxx-time=yes --with-default-libstdcxx-abi=new --enable-gnu-unique-object --disable-vtable-verify --enable-libmpx --enable-plugin --enable-default-pie --with-system-zlib --with-target-system-zlib --enable-objc-gc=auto --enable-multiarch --disable-werror --with-arch-32=i686 --with-abi=m64 --with-multilib-list=m32,m64,mx32 --enable-multilib --with-tune=generic --enable-offload-targets=nvptx-none --without-cuda-driver --enable-checking=release --build=x86_64-linux-gnu --host=x86_64-linux-gnu --target=x86_64-linux-gnu
Thread model: posix
gcc version 8.3.0 (Debian 8.3.0-6)

with Debian 10 x64

LL


-----P?vodn? zpr?va-----
Od: squid-users za u?ivatele Alex Rousskov
Odesl?no: ?t 12.9.2023 16:48
Komu: squid-users at lists.squid-cache.org
P?edm?t: Re: [squid-users] Squid BUG: assurance failed: tok.skip(WellKnownUrlPathPrefix())
 
On 2023-09-12 10:21, Lou?ansk? Luk?? wrote:
> today I was going to compile a new version of my beloved squid 
> proxy (v6.3 or 6.3-20230903-ra9c06aa6a)

FWIW, "was going to compile" part does not make it clear (to me) whether 
you did actually compile/test v6.3.


> just to be welcomed by non 
> working older configmgr.cgi and [debian package installed] squidclient 
> (v4.6). After replacing squidclient with (compiled with squid) version 
> 6.3 it's still not working, giving me accesss denied page.
> 
> My cache.log contains these bug info lines:
> 
> 023/09/12 16:07:03 kid3| ERROR: Squid BUG: assurance failed: 
> tok.skip(WellKnownUrlPathPrefix())
>  ??? exception location: cache_manager.cc(193) ParseUrl


If the above output is from Squid v6.3, then you may have found a v6.3 
problem that we do not know about. Please share the HTTP request that 
triggers the above output.

Otherwise, please try to upgrade to Squid v6.3 because its commit 
6695897 is meant to fix a v6.1 bug with the above symptoms.


Thank you,

Alex.


>  ??? current master transaction: master469155
> 2023/09/12 16:07:03 kid3| ERROR: Squid BUG: assurance failed: 
> tok.skip(WellKnownUrlPathPrefix())
>  ??? exception location: cache_manager.cc(193) ParseUrl
>  ??? current master transaction: master469155
> 
> In the file src/cache_manager.cc there is this
> 
> const SBuf &
> CacheManager::WellKnownUrlPathPrefix()
> {
>  ??? static const SBuf prefix("/squid-internal-mgr/");
>  ??? return prefix;
> }
> 
> and on the line 193 is this assure (after tok tokenizer)
> 
>  ?Parser::Tokenizer tok(uri.path());
> 
>  ??? Assure(tok.skip(WellKnownUrlPathPrefix()));
> 
> Is there something wrong with my config I should change after 6.2 to 6.3 
> upgrade? I have some classic http_access manager allow ... and 
> http_access manager deny lines. No definition what [acl] manager means.
> 
> I have found some mentions here 
> https://github.com/squid-cache/squid/blob/master/ChangeLog and somewhere 
> inside the commit / review git hub section for squid. But nothing says 
> what to do make it work right. Besides this it seems squid as a proxy 
> works fine...
> 
> Thanks
> 
> Lukas
> 
> 
> 
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> https://lists.squid-cache.org/listinfo/squid-users

_______________________________________________
squid-users mailing list
squid-users at lists.squid-cache.org
https://lists.squid-cache.org/listinfo/squid-users




-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230912/2985ad5f/attachment.htm>

From rousskov at measurement-factory.com  Tue Sep 12 17:28:05 2023
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Tue, 12 Sep 2023 13:28:05 -0400
Subject: [squid-users] Squid BUG: assurance failed:
 tok.skip(WellKnownUrlPathPrefix())
In-Reply-To: <72DD5D5CF661B5459DC08A060BF26B53C45E64@kjj-server.KJJ.local>
References: <37e6b005-6d0a-b50f-19c2-a524320dccb5@kjj.cz>
 <d42a6203-ca8d-4964-b3da-16f9479e17e9@measurement-factory.com>
 <72DD5D5CF661B5459DC08A060BF26B53C45E63@kjj-server.KJJ.local>
 <72DD5D5CF661B5459DC08A060BF26B53C45E64@kjj-server.KJJ.local>
Message-ID: <eb8e4a57-aafd-407d-be7b-20bfb2088bab@measurement-factory.com>

On 2023-09-12 13:06, Lou?ansk? Luk?? wrote:
> Is this anyhow interesting?

Not really, IMO -- the problem happens earlier. I can confirm that you 
are running v6.3-based code. Let's call that progress :-).

Can you share the a _pointer_ to a compressed ALL,9 cache.log file while 
reproducing the problem using a single transaction?

https://wiki.squid-cache.org/SquidFaq/BugReporting#debugging-a-single-transaction

Alex.

> 
> 2023/09/12 18:47:04.267 kid4| 24,8| SBuf.cc(30) SBuf: SBuf15514952 created
> 2023/09/12 18:47:04.267 kid4| 24,8| SBuf.cc(30) SBuf: SBuf15514953 created
> 2023/09/12 18:47:04.267 kid4| 24,8| SBuf.cc(30) SBuf: SBuf15514954 created
> 2023/09/12 18:47:04.267 kid4| 24,7| SBuf.cc(85) assign: assigning 
> SBuf15514952 from SBuf15514912
> 2023/09/12 18:47:04.267 kid4| 24,8| SBuf.cc(38) SBuf: SBuf15514955 
> created from id SBuf15514915
> 2023/09/12 18:47:04.267 kid4| 24,8| SBuf.cc(445) startsWith: 
> SBuf15514955 startsWith SBuf125812, caseSensitive: 0
> 2023/09/12 18:47:04.267 kid4| 24,8| SBuf.cc(447) startsWith: no, too short
> 2023/09/12 18:47:04.267 kid4| 24,8| Tokenizer.cc(185) skip: no match, 
> not skipping '/squid-internal-mgr/'
> 2023/09/12 18:47:04 kid4| ERROR: Squid BUG: assurance failed: 
> tok.skip(WellKnownUrlPathPrefix())
> 2023/09/12 18:47:04.268 kid4| 24,8| SBuf.cc(70) ~SBuf: SBuf15514955 
> destructed
> 
> 
> BTW debug 24,9 makes pretty big log files... :-)
> 
> L
> 
> -----P?vodn? zpr?va-----
> Od: squid-users za u?ivatele Lou?ansk? Luk??
> Odesl?no: ?t 12.9.2023 18:23
> Komu: squid-users at lists.squid-cache.org
> P?edm?t: Re: [squid-users] Squid BUG: assurance failed: 
> tok.skip(WellKnownUrlPathPrefix())
> 
> Hello Alex - here is the output of squid -v command:
> 
> squid -v
> Squid Cache: Version 6.3-20230903-ra9c06aa6a
> Service Name: squid
> no IPV6
> 
> This binary uses OpenSSL 1.1.1n? 15 Mar 2022. For legal restrictions on 
> distribution see https://www.openssl.org/source/license.html 
> <https://www.openssl.org/source/license.html>
> 
> configure options:? '--build=x86_64-linux-gnu' '--prefix=/usr' 
> '--includedir=/include' '--mandir=/share/man' '--infodir=/share/info' 
> '--sysconfdir=/etc' '--localstatedir=/var' '--libexecdir=/lib/squid5' 
> '--disable-maintainer-mode' '--disable-silent-rules' 
> '--datadir=/usr/share/squid5' '--sysconfdir=/etc/squid5' 
> '--mandir=/usr/share/man' '--enable-build-info=no IPV6' 
> '--enable-inline' '--enable-arp-acl' '--disable-wccp' '--disable-wccp2' 
> '--disable-htcp--disable-arch-native' '--disable-ipv6' 
> '--enable-optimizations' '--enable-storeio=ufs,aufs,diskd,rock' 
> '--enable-removal-policies=lru,heap' '--enable-delay-pools' 
> '--enable-cache-digests' '--enable-icap-client' 
> '--enable-follow-x-forwarded-for' 
> '--enable-auth-basic=DB,fake,getpwnam,LDAP,NCSA,NIS,PAM,POP3,RADIUS,SASL,SMB' '--enable-auth-digest=file,LDAP' '--enable-auth-negotiate=kerberos,wrapper' '--enable-auth-ntlm=fake,SMB_LM' '--enable-external-acl-helpers=file_userip,kerberos_ldap_group,LDAP_group,session,SQL_session,time_quota,unix_group,wbinfo_group' '--enable-url-rewrite-helpers=fake' '--enable-security-cert-validators=fake' '--enable-storeid-rewrite-helpers=file' '--enable-eui' '--enable-esi' '--enable-icmp' '--enable-zph-qos' '--enable-ecap' '--enable-snmp' '--disable-ident-lookups' '--disable-translation' '--with-swapdir=/var/spool/squid5' '--with-logdir=/var/log/squid5' '--with-pidfile=/var/run/squid5.pid' '--with-large-files' '--with-default-user=proxy' '--with-openssl' '--with-filedescriptors=8192' '--enable-ssl-crtd' '--enable-security-cert-generators' '--enable-security-cert-validators' '--enable-linux-netfilter' '--enable-stacktraces' 'PKG_CONFIG_PATH=:/usr/local/lib/pkgconfig:/usr/lib64/pkgconfig:/usr/share/pkgconfig' 'CFLAGS=-g -O2 -m64 -fPIE -fstack-protector-strong -Wformat -Werror=format-security -Wall' 'LDFLAGS=-fPIE -pie -Wl,-z,relro -Wl,-z,now' 'CPPFLAGS=-D_FORTIFY_SOURCE=2' 'CXXFLAGS=-g -O2 -m64 -fPIE -fstack-protector-strong -Wformat -Werror=format-security' 'build_alias=x86_64-linux-gnu'
> 
> Please note two things - I was using 5.x branch for some time (ie. 
> squid5 prefix) and lately did upgrade to 6.x as the developers said 5.x 
> is EOL/not maintained, I do not have native ipv6 so I had some tun6to4 
> tunel to closed broker - so now I do not have ipv6 connectivity. So I 
> decided to set --disable-ipv6 for now.
> 
> I have gcc
>  ?gcc -v
> Using built-in specs.
> COLLECT_GCC=gcc
> COLLECT_LTO_WRAPPER=/usr/lib/gcc/x86_64-linux-gnu/8/lto-wrapper
> OFFLOAD_TARGET_NAMES=nvptx-none
> OFFLOAD_TARGET_DEFAULT=1
> Target: x86_64-linux-gnu
> Configured with: ../src/configure -v --with-pkgversion='Debian 8.3.0-6' 
> --with-bugurl=file:///usr/share/doc/gcc-8/README.Bugs 
> <file:///usr/share/doc/gcc-8/README.Bugs> 
> --enable-languages=c,ada,c++,go,brig,d,fortran,objc,obj-c++ 
> --prefix=/usr --with-gcc-major-version-only --program-suffix=-8 
> --program-prefix=x86_64-linux-gnu- --enable-shared 
> --enable-linker-build-id --libexecdir=/usr/lib 
> --without-included-gettext --enable-threads=posix --libdir=/usr/lib 
> --enable-nls --enable-bootstrap --enable-clocale=gnu 
> --enable-libstdcxx-debug --enable-libstdcxx-time=yes 
> --with-default-libstdcxx-abi=new --enable-gnu-unique-object 
> --disable-vtable-verify --enable-libmpx --enable-plugin 
> --enable-default-pie --with-system-zlib --with-target-system-zlib 
> --enable-objc-gc=auto --enable-multiarch --disable-werror 
> --with-arch-32=i686 --with-abi=m64 --with-multilib-list=m32,m64,mx32 
> --enable-multilib --with-tune=generic 
> --enable-offload-targets=nvptx-none --without-cuda-driver 
> --enable-checking=release --build=x86_64-linux-gnu 
> --host=x86_64-linux-gnu --target=x86_64-linux-gnu
> Thread model: posix
> gcc version 8.3.0 (Debian 8.3.0-6)
> 
> with Debian 10 x64
> 
> LL
> 
> 
> -----P?vodn? zpr?va-----
> Od: squid-users za u?ivatele Alex Rousskov
> Odesl?no: ?t 12.9.2023 16:48
> Komu: squid-users at lists.squid-cache.org
> P?edm?t: Re: [squid-users] Squid BUG: assurance failed: 
> tok.skip(WellKnownUrlPathPrefix())
> 
> On 2023-09-12 10:21, Lou?ansk? Luk?? wrote:
>  > today I was going to compile a new version of my beloved squid
>  > proxy (v6.3 or 6.3-20230903-ra9c06aa6a)
> 
> FWIW, "was going to compile" part does not make it clear (to me) whether
> you did actually compile/test v6.3.
> 
> 
>  > just to be welcomed by non
>  > working older configmgr.cgi and [debian package installed] squidclient
>  > (v4.6). After replacing squidclient with (compiled with squid) version
>  > 6.3 it's still not working, giving me accesss denied page.
>  >
>  > My cache.log contains these bug info lines:
>  >
>  > 023/09/12 16:07:03 kid3| ERROR: Squid BUG: assurance failed:
>  > tok.skip(WellKnownUrlPathPrefix())
>  >? ??? exception location: cache_manager.cc(193) ParseUrl
> 
> 
> If the above output is from Squid v6.3, then you may have found a v6.3
> problem that we do not know about. Please share the HTTP request that
> triggers the above output.
> 
> Otherwise, please try to upgrade to Squid v6.3 because its commit
> 6695897 is meant to fix a v6.1 bug with the above symptoms.
> 
> 
> Thank you,
> 
> Alex.
> 
> 
>  >? ??? current master transaction: master469155
>  > 2023/09/12 16:07:03 kid3| ERROR: Squid BUG: assurance failed:
>  > tok.skip(WellKnownUrlPathPrefix())
>  >? ??? exception location: cache_manager.cc(193) ParseUrl
>  >? ??? current master transaction: master469155
>  >
>  > In the file src/cache_manager.cc there is this
>  >
>  > const SBuf &
>  > CacheManager::WellKnownUrlPathPrefix()
>  > {
>  >? ??? static const SBuf prefix("/squid-internal-mgr/");
>  >? ??? return prefix;
>  > }
>  >
>  > and on the line 193 is this assure (after tok tokenizer)
>  >
>  >? ?Parser::Tokenizer tok(uri.path());
>  >
>  >? ??? Assure(tok.skip(WellKnownUrlPathPrefix()));
>  >
>  > Is there something wrong with my config I should change after 6.2 to 6.3
>  > upgrade? I have some classic http_access manager allow ... and
>  > http_access manager deny lines. No definition what [acl] manager means.
>  >
>  > I have found some mentions here
>  > https://github.com/squid-cache/squid/blob/master/ChangeLog 
> <https://github.com/squid-cache/squid/blob/master/ChangeLog> and somewhere
>  > inside the commit / review git hub section for squid. But nothing says
>  > what to do make it work right. Besides this it seems squid as a proxy
>  > works fine...
>  >
>  > Thanks
>  >
>  > Lukas
>  >
>  >
>  >
>  > _______________________________________________
>  > squid-users mailing list
>  > squid-users at lists.squid-cache.org
>  > https://lists.squid-cache.org/listinfo/squid-users 
> <https://lists.squid-cache.org/listinfo/squid-users>
> 
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> https://lists.squid-cache.org/listinfo/squid-users 
> <https://lists.squid-cache.org/listinfo/squid-users>
> 
> 
> 
> 
> 
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> https://lists.squid-cache.org/listinfo/squid-users


From Loucansky.Lukas at kjj.cz  Tue Sep 12 19:50:42 2023
From: Loucansky.Lukas at kjj.cz (=?iso-8859-2?B?TG916GFuc2v9IEx1a+G5?=)
Date: Tue, 12 Sep 2023 21:50:42 +0200
Subject: [squid-users] Squid BUG: assurance failed:
 tok.skip(WellKnownUrlPathPrefix())
References: <37e6b005-6d0a-b50f-19c2-a524320dccb5@kjj.cz>
 <d42a6203-ca8d-4964-b3da-16f9479e17e9@measurement-factory.com>
 <72DD5D5CF661B5459DC08A060BF26B53C45E63@kjj-server.KJJ.local>
 <72DD5D5CF661B5459DC08A060BF26B53C45E64@kjj-server.KJJ.local>
 <eb8e4a57-aafd-407d-be7b-20bfb2088bab@measurement-factory.com>
Message-ID: <72DD5D5CF661B5459DC08A060BF26B53C45E66@kjj-server.KJJ.local>


Well there seems to be some recurring pattern of behaviour:

grep tok.skip cache.log


2023/09/12 19:12:03 kid4| ERROR: Squid BUG: assurance failed: tok.skip(WellKnownUrlPathPrefix())
2023/09/12 19:12:03 kid3| ERROR: Squid BUG: assurance failed: tok.skip(WellKnownUrlPathPrefix())
2023/09/12 19:12:03 kid4| ERROR: Squid BUG: assurance failed: tok.skip(WellKnownUrlPathPrefix())
2023/09/12 19:12:03 kid4| ERROR: Squid BUG: assurance failed: tok.skip(WellKnownUrlPathPrefix())
2023/09/12 19:12:04 kid4| ERROR: Squid BUG: assurance failed: tok.skip(WellKnownUrlPathPrefix())

2023/09/12 19:17:03 kid4| ERROR: Squid BUG: assurance failed: tok.skip(WellKnownUrlPathPrefix())
2023/09/12 19:17:03 kid4| ERROR: Squid BUG: assurance failed: tok.skip(WellKnownUrlPathPrefix())
2023/09/12 19:17:04 kid4| ERROR: Squid BUG: assurance failed: tok.skip(WellKnownUrlPathPrefix())
2023/09/12 19:17:04 kid3| ERROR: Squid BUG: assurance failed: tok.skip(WellKnownUrlPathPrefix())
2023/09/12 19:17:04 kid4| ERROR: Squid BUG: assurance failed: tok.skip(WellKnownUrlPathPrefix())

2023/09/12 19:22:04 kid3| ERROR: Squid BUG: assurance failed: tok.skip(WellKnownUrlPathPrefix())
2023/09/12 19:22:04 kid2| ERROR: Squid BUG: assurance failed: tok.skip(WellKnownUrlPathPrefix())
2023/09/12 19:22:04 kid3| ERROR: Squid BUG: assurance failed: tok.skip(WellKnownUrlPathPrefix())
2023/09/12 19:22:04 kid3| ERROR: Squid BUG: assurance failed: tok.skip(WellKnownUrlPathPrefix())
2023/09/12 19:22:04 kid4| ERROR: Squid BUG: assurance failed: tok.skip(WellKnownUrlPathPrefix())

2023/09/12 19:27:04 kid4| ERROR: Squid BUG: assurance failed: tok.skip(WellKnownUrlPathPrefix())
2023/09/12 19:27:04 kid4| ERROR: Squid BUG: assurance failed: tok.skip(WellKnownUrlPathPrefix())
2023/09/12 19:27:04 kid4| ERROR: Squid BUG: assurance failed: tok.skip(WellKnownUrlPathPrefix())
2023/09/12 19:27:04 kid3| ERROR: Squid BUG: assurance failed: tok.skip(WellKnownUrlPathPrefix())
2023/09/12 19:27:04 kid3| ERROR: Squid BUG: assurance failed: tok.skip(WellKnownUrlPathPrefix())

2023/09/12 19:32:04 kid2| ERROR: Squid BUG: assurance failed: tok.skip(WellKnownUrlPathPrefix())
2023/09/12 19:32:04 kid3| ERROR: Squid BUG: assurance failed: tok.skip(WellKnownUrlPathPrefix())
2023/09/12 19:32:04 kid4| ERROR: Squid BUG: assurance failed: tok.skip(WellKnownUrlPathPrefix())
2023/09/12 19:32:04 kid2| ERROR: Squid BUG: assurance failed: tok.skip(WellKnownUrlPathPrefix())
2023/09/12 19:32:04 kid3| ERROR: Squid BUG: assurance failed: tok.skip(WellKnownUrlPathPrefix())

2023/09/12 19:37:03 kid2| ERROR: Squid BUG: assurance failed: tok.skip(WellKnownUrlPathPrefix())
2023/09/12 19:37:03 kid4| ERROR: Squid BUG: assurance failed: tok.skip(WellKnownUrlPathPrefix())
2023/09/12 19:37:03 kid4| ERROR: Squid BUG: assurance failed: tok.skip(WellKnownUrlPathPrefix())
2023/09/12 19:37:03 kid4| ERROR: Squid BUG: assurance failed: tok.skip(WellKnownUrlPathPrefix())
2023/09/12 19:37:03 kid3| ERROR: Squid BUG: assurance failed: tok.skip(WellKnownUrlPathPrefix())

2023/09/12 19:42:03 kid4| ERROR: Squid BUG: assurance failed: tok.skip(WellKnownUrlPathPrefix())
2023/09/12 19:42:03 kid4| ERROR: Squid BUG: assurance failed: tok.skip(WellKnownUrlPathPrefix())
2023/09/12 19:42:03 kid4| ERROR: Squid BUG: assurance failed: tok.skip(WellKnownUrlPathPrefix())
2023/09/12 19:42:03 kid4| ERROR: Squid BUG: assurance failed: tok.skip(WellKnownUrlPathPrefix())
2023/09/12 19:42:03 kid2| ERROR: Squid BUG: assurance failed: tok.skip(WellKnownUrlPathPrefix())

2023/09/12 19:47:04 kid3| ERROR: Squid BUG: assurance failed: tok.skip(WellKnownUrlPathPrefix())
2023/09/12 19:47:04 kid3| ERROR: Squid BUG: assurance failed: tok.skip(WellKnownUrlPathPrefix())
2023/09/12 19:47:04 kid3| ERROR: Squid BUG: assurance failed: tok.skip(WellKnownUrlPathPrefix())
2023/09/12 19:47:04 kid2| ERROR: Squid BUG: assurance failed: tok.skip(WellKnownUrlPathPrefix())
2023/09/12 19:47:04 kid3| ERROR: Squid BUG: assurance failed: tok.skip(WellKnownUrlPathPrefix())

2023/09/12 19:52:04 kid3| ERROR: Squid BUG: assurance failed: tok.skip(WellKnownUrlPathPrefix())
2023/09/12 19:52:04 kid3| ERROR: Squid BUG: assurance failed: tok.skip(WellKnownUrlPathPrefix())
2023/09/12 19:52:04 kid4| ERROR: Squid BUG: assurance failed: tok.skip(WellKnownUrlPathPrefix())
2023/09/12 19:52:04 kid4| ERROR: Squid BUG: assurance failed: tok.skip(WellKnownUrlPathPrefix())
2023/09/12 19:52:04 kid4| ERROR: Squid BUG: assurance failed: tok.skip(WellKnownUrlPathPrefix())

and the same 5 lines at these times:
2023/09/12 19:57:03 kid3| ERROR: Squid BUG: assurance failed: tok.skip(WellKnownUrlPathPrefix())
2023/09/12 20:02:03 kid4| ERROR: Squid BUG: assurance failed: tok.skip(WellKnownUrlPathPrefix())
2023/09/12 20:07:03 kid4| ERROR: Squid BUG: assurance failed: tok.skip(WellKnownUrlPathPrefix())
2023/09/12 20:12:03 kid2| ERROR: Squid BUG: assurance failed: tok.skip(WellKnownUrlPathPrefix())
2023/09/12 20:17:03 kid2| ERROR: Squid BUG: assurance failed: tok.skip(WellKnownUrlPathPrefix())
2023/09/12 20:22:03 kid1| ERROR: Squid BUG: assurance failed: tok.skip(WellKnownUrlPathPrefix())
2023/09/12 20:27:04 kid4| ERROR: Squid BUG: assurance failed: tok.skip(WellKnownUrlPathPrefix())
2023/09/12 20:32:03 kid3| ERROR: Squid BUG: assurance failed: tok.skip(WellKnownUrlPathPrefix())
2023/09/12 20:37:04 kid3| ERROR: Squid BUG: assurance failed: tok.skip(WellKnownUrlPathPrefix())
2023/09/12 20:42:03 kid2| ERROR: Squid BUG: assurance failed: tok.skip(WellKnownUrlPathPrefix())
2023/09/12 20:47:03 kid3| ERROR: Squid BUG: assurance failed: tok.skip(WellKnownUrlPathPrefix())
2023/09/12 20:52:04 kid4| ERROR: Squid BUG: assurance failed: tok.skip(WellKnownUrlPathPrefix())
2023/09/12 20:57:03 kid3| ERROR: Squid BUG: assurance failed: tok.skip(WellKnownUrlPathPrefix())

So we can see it's occurring every 5mins at the same time, every time 5 occurrences. I suppose this is caused by my mrtg script calling squidclient exactly 5 times (to get number of used fd, max currently use fd, mean object size and number of store entries + store entries in memory). 

So, put this aside as the script (running on another computer) uses older squidclient.  I call it like this:
squidclient -h squid_ip -p squid_port -vv mgr:info

Request:
GET cache_object://squid_ip/info HTTP/1.0
Host: squid_ip
User-Agent: squidclient/4.6
Accept: */*
Connection: close

Sending HTTP request ...
done.
HTTP/1.1 404 Not Found
Server: squid
Mime-Version: 1.0
Date: Tue, 12 Sep 2023 19:09:41 GMT
Content-Type: text/html;charset=utf-8
Content-Length: 13057
X-Squid-Error: ERR_INVALID_URL 0
Cache-Status: proxy;detail=no-cache
Via: 1.1 proxy (squid)
Connection: close

This is obviously calling for url cache_object://squid_ip/info which I think is obsolete. Now I went with the new squidclient:

./squidclient -h squid_ip -p squid_port -vv mgr:info

Request:
GET http://squid_ip:squid_port/squid-internal-mgr/info HTTP/1.0
Host: 10.50.1.5:3127
User-Agent: squidclient/6.3
Accept: */*
Connection: close

But it seems squid is then trying to open it's visible_hostname:squid_port/squid-internal-mgr/ and due my DNS setting it is its WAN IP - so it's connecting to its outside IP with its outside IP which is not in the http_access manager allow list (now it is and the newer squidclient works). So maybe I should just start with my DNS and then I will take a look how to implement the new cachemgr.cgi into my old setup...

L




LL


-----P?vodn? zpr?va-----
Od: squid-users za u?ivatele Alex Rousskov
Odesl?no: ?t 12.9.2023 19:28
Komu: squid-users at lists.squid-cache.org
P?edm?t: Re: [squid-users] Squid BUG: assurance failed: tok.skip(WellKnownUrlPathPrefix())
 
On 2023-09-12 13:06, Lou?ansk? Luk?? wrote:
> Is this anyhow interesting?

Not really, IMO -- the problem happens earlier. I can confirm that you 
are running v6.3-based code. Let's call that progress :-).

Can you share the a _pointer_ to a compressed ALL,9 cache.log file while 
reproducing the problem using a single transaction?

https://wiki.squid-cache.org/SquidFaq/BugReporting#debugging-a-single-transaction

Alex.

> 
> 2023/09/12 18:47:04.267 kid4| 24,8| SBuf.cc(30) SBuf: SBuf15514952 created
> 2023/09/12 18:47:04.267 kid4| 24,8| SBuf.cc(30) SBuf: SBuf15514953 created
> 2023/09/12 18:47:04.267 kid4| 24,8| SBuf.cc(30) SBuf: SBuf15514954 created
> 2023/09/12 18:47:04.267 kid4| 24,7| SBuf.cc(85) assign: assigning 
> SBuf15514952 from SBuf15514912
> 2023/09/12 18:47:04.267 kid4| 24,8| SBuf.cc(38) SBuf: SBuf15514955 
> created from id SBuf15514915
> 2023/09/12 18:47:04.267 kid4| 24,8| SBuf.cc(445) startsWith: 
> SBuf15514955 startsWith SBuf125812, caseSensitive: 0
> 2023/09/12 18:47:04.267 kid4| 24,8| SBuf.cc(447) startsWith: no, too short
> 2023/09/12 18:47:04.267 kid4| 24,8| Tokenizer.cc(185) skip: no match, 
> not skipping '/squid-internal-mgr/'
> 2023/09/12 18:47:04 kid4| ERROR: Squid BUG: assurance failed: 
> tok.skip(WellKnownUrlPathPrefix())
> 2023/09/12 18:47:04.268 kid4| 24,8| SBuf.cc(70) ~SBuf: SBuf15514955 
> destructed
> 
> 
> BTW debug 24,9 makes pretty big log files... :-)
> 
> L
> 
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230912/1d1dc2a9/attachment.htm>

From squid at iotti.biz  Wed Sep 13 16:47:02 2023
From: squid at iotti.biz (squid at iotti.biz)
Date: Wed, 13 Sep 2023 18:47:02 +0200
Subject: [squid-users] ssl-bump strange behaviour with incomplete config
Message-ID: <002d01d9e661$ec5b4180$c511c480$@iotti.biz>

Hi all

I was trying to configure the ssl-bump feature. I forgot to allow the
initial CONNECT (or the fake CONNECT, in case of intercepting proxy). This
led me to some strange results which I'd like to point out. I am using
CentOS 8 with squid 6.13 recompiled from the Fedora RPM.
First case, forward proxy. The configuration is:

debug_options 83,8
logformat timereadable %tl %6tr %>a %Ss/%03Hs %<st %rm %ru %un %Sh/%<A %mt
logformat timereadableWithMilli %{%FT%T}tl.%03tu%{%z}tl %6tr %>a %Ss/%03Hs
%<st %rm %ru %un %Sh/%<A %mt
access_log daemon:/var/log/squid/access.log timereadableWithMilli

acl localnet src 0.0.0.1-0.255.255.255  # RFC 1122 "this" network (LAN)
acl localnet src 10.0.0.0/8             # RFC 1918 local private network
(LAN)
acl localnet src 100.64.0.0/10          # RFC 6598 shared address space
(CGN)
acl localnet src 169.254.0.0/16         # RFC 3927 link-local (directly
plugged) machines
acl localnet src 172.16.0.0/12          # RFC 1918 local private network
(LAN)
acl localnet src 192.168.0.0/16         # RFC 1918 local private network
(LAN)
acl localnet src fc00::/7               # RFC 4193 local private network
range
acl localnet src fe80::/10              # RFC 4291 link-local (directly
plugged) machines

acl SSL_ports port 443
acl Safe_ports port 80          # http
acl Safe_ports port 21          # ftp
acl Safe_ports port 443         # https
acl Safe_ports port 70          # gopher
acl Safe_ports port 210         # wais
acl Safe_ports port 1025-65535  # unregistered ports
acl Safe_ports port 280         # http-mgmt
acl Safe_ports port 488         # gss-http
acl Safe_ports port 591         # filemaker
acl Safe_ports port 777         # multiling http

http_access deny !Safe_ports
http_access deny CONNECT !SSL_ports
http_access allow localhost manager
http_access deny manager
http_access allow localhost
http_access deny to_localhost
http_access deny to_linklocal
http_access deny all

http_port 3130 ssl-bump generate-host-certificates=on
dynamic_cert_mem_cache_size=6MB cert=/etc/squid/ssl_cert/myCA.pem
ssl_bump peek all
ssl_bump splice all

coredump_dir /var/spool/squid
refresh_pattern ^ftp:           1440    20%     10080
refresh_pattern -i (/cgi-bin/|\?) 0     0%      0
refresh_pattern .               0       20%     4320


I'm only peeking as long as possible, and then splice at step3. Or at least,
this is what I was trying to do. My browser is explicitly configured to use
Squid on port 3130.

I got the regular Squid access denied screen (and this is right, since the
CONNECT is not allowed) but in access.log I find:

2023-09-13T17:12:52.855+0200     12 192.168.1.179 TCP_DENIED/200 0 CONNECT
www.nytimes.com:443 - HIER_NONE/- -
2023-09-13T17:12:52.855+0200      0 192.168.1.179 NONE_NONE/403 3952 GET
https://www.nytimes.com/ - HIER_NONE/- text/html

See the second GET. It seems that Squid here is kind-of bumping, instead of
splicing, since it did read what should be the encrypted request. 
Also the TCP_DENIED/200 is not clear to me: shouldn't it be TCP_DENIED/403?
I checked with tcpdump, and the CONNECT is really allowed with 200 code, a
client hello and server hello are exchanged, than the connections is closed
after some transaction.

I started debugging the ssl-bump thing with debug_options 83,8 and in
cache.log I see:

2023/09/13 17:14:00.283 kid1| 83,7| LogTags.cc(57) update: TAG_NONE to
TCP_DENIED
2023/09/13 17:14:00.283 kid1| 83,3| client_side_request.cc(1501)
sslBumpNeed: sslBump required: bump
2023/09/13 17:14:00.283 kid1| 83,3| client_side_request.cc(1501)
sslBumpNeed: sslBump required: client-first

Why " sslBump required: bump" and not splice? Even "worse", why does it do
client-first then? Is it right it defaults to this if the CONNECT is
refused?
Then in cache.log I see a lot of messages where it seems that Squid is
talking TLS with the client, probably sending the access denied page. 

If I simply add in the config
acl lux src 192.168.1.179
http_access allow lux

then it works, with 
2023-09-13T17:28:21.877+0200 108353 192.168.1.179 TCP_TUNNEL/200 4853
CONNECT vp.nyt.com:443 - HIER_DIRECT/vp.nyt.com -
2023-09-13T17:28:21.878+0200 108441 192.168.1.179 TCP_TUNNEL/200 7894
CONNECT mwcm.nytimes.com:443 - HIER_DIRECT/mwcm.nytimes.com -
2023-09-13T17:28:21.879+0200 110154 192.168.1.179 TCP_TUNNEL/200 6337
CONNECT a.nytimes.com:443 - HIER_DIRECT/a.nytimes.com -
2023-09-13T17:28:21.879+0200 111702 192.168.1.179 TCP_TUNNEL/200 514229
CONNECT g1.nyt.com:443 - HIER_DIRECT/g1.nyt.com -
2023-09-13T17:28:21.880+0200 111702 192.168.1.179 TCP_TUNNEL/200 648915
CONNECT static01.nyt.com:443 - HIER_DIRECT/static01.nyt.com -
2023-09-13T17:28:21.880+0200 111890 192.168.1.179 TCP_TUNNEL/200 10986
CONNECT samizdat-graphql.nytimes.com:443 -
HIER_DIRECT/samizdat-graphql.nytimes.com -
2023-09-13T17:28:21.881+0200 112017 192.168.1.179 TCP_TUNNEL/200 72448
CONNECT static01.nytimes.com:443 - HIER_DIRECT/static01.nytimes.com -
2023-09-13T17:28:21.881+0200 112018 192.168.1.179 TCP_TUNNEL/200 286645
CONNECT static01.nytimes.com:443 - HIER_DIRECT/static01.nytimes.com -
2023-09-13T17:28:21.882+0200 112043 192.168.1.179 TCP_TUNNEL/200 15345
CONNECT g1.nyt.com:443 - HIER_DIRECT/g1.nyt.com -
2023-09-13T17:28:21.883+0200 112333 192.168.1.179 TCP_TUNNEL/200 2390864
CONNECT www.nytimes.com:443 - HIER_DIRECT/www.nytimes.com -

And in cache.log, no more client-first mentions:
2023/09/13 17:26:33.523 kid1| 83,3| client_side_request.cc(1748) doCallouts:
Doing clientInterpretRequestHeaders()
2023/09/13 17:26:33.523 kid1| 83,3| client_side_request.cc(1501)
sslBumpNeed: sslBump required: peek
2023/09/13 17:26:33.523 kid1| 83,3| client_side_request.cc(1842) doCallouts:
calling processRequest()


I also tried with an interception proxy (transparent proxy) config. The
results are similar but not identical:
I added to the original config (the one which prohibits the CONNECT):
http_port 3128

and changed port 3130 so:
https_port 3130 intercept ssl-bump generate-host-certificates=on
dynamic_cert_mem_cache_size=6MB cert=/etc/squid/ssl_cert/myCA.pem

Now I get:
2023-09-13T17:52:17.109+0200      6 192.168.1.179 TCP_DENIED/000 0 CONNECT
151.101.241.164:443 - HIER_NONE/- -
2023-09-13T17:52:17.109+0200      0 192.168.1.179 NONE_NONE/403 3732 GET
https://www. nytimes.com/ - HIER_NONE/- text/html

TCP_DENIED/000 is more clear than TCP_DENIED/200. But the GET, making me
think to some bumping code, is still there.

In cache.log, I find:

2023/09/13 17:53:06.539 kid1| 83,7| LogTags.cc(57) update: TAG_NONE to
TCP_DENIED
2023/09/13 17:53:06.539 kid1| 83,3| client_side_request.cc(1501)
sslBumpNeed: sslBump required: peek
2023/09/13 17:53:06.539 kid1| 83,3| client_side_request.cc(1501)
sslBumpNeed: sslBump required: client-first

So this time, it is doing peek first (and this is ok with the config), but
then it recurs to client-first, which could be the reason why the encrypted
HTTPS traffic is decoded and the HTTP GET is shown.

Is this whole behavior correct? Anyway, when I white-list the CONNECT,
everything seems to work right.

Thank you, 
Luigi



From rousskov at measurement-factory.com  Wed Sep 13 17:12:44 2023
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Wed, 13 Sep 2023 13:12:44 -0400
Subject: [squid-users] ssl-bump strange behaviour with incomplete config
In-Reply-To: <002d01d9e661$ec5b4180$c511c480$@iotti.biz>
References: <002d01d9e661$ec5b4180$c511c480$@iotti.biz>
Message-ID: <8ce2efb2-0ddf-49a7-bcbc-b3dade623048@measurement-factory.com>

On 2023-09-13 12:47, squid at iotti.biz wrote:

> I'm only peeking as long as possible, and then splice at step3.
> 
> I got the regular Squid access denied screen (and this is right, since the
> CONNECT is not allowed) but in access.log I find:
> 
> 2023-09-13T17:12:52.855+0200     12 192.168.1.179 TCP_DENIED/200 0 CONNECT
> www.nytimes.com:443 - HIER_NONE/- -
> 2023-09-13T17:12:52.855+0200      0 192.168.1.179 NONE_NONE/403 3952 GET
> https://www.nytimes.com/ - HIER_NONE/- text/html
> 
> See the second GET. It seems that Squid here is kind-of bumping

Yes, if Squid encounters an error during SslBump processing steps, it 
will try to bump the TLS client connection (if it has not been bumped 
already) to (later) deliver an HTTP response describing that error to 
the user agent.

Squid bumps the TLS client connection and then waits for and responds to 
the first request after CONNECT because popular browsers do not show 
CONNECT responses to users, including CONNECT responses containing Squid 
access denied errors. In other words, without bumping, the browser would 
not show that "Squid access denied screen" that you consider "right".

This SslBump error-handling behavior works well in some use cases and 
breaks some other use cases. I expect it to become configurable at some 
point.


HTH,

Alex.


, instead of
> splicing, since it did read what should be the encrypted request.
> Also the TCP_DENIED/200 is not clear to me: shouldn't it be TCP_DENIED/403?
> I checked with tcpdump, and the CONNECT is really allowed with 200 code, a
> client hello and server hello are exchanged, than the connections is closed
> after some transaction.
> 
> I started debugging the ssl-bump thing with debug_options 83,8 and in
> cache.log I see:
> 
> 2023/09/13 17:14:00.283 kid1| 83,7| LogTags.cc(57) update: TAG_NONE to
> TCP_DENIED
> 2023/09/13 17:14:00.283 kid1| 83,3| client_side_request.cc(1501)
> sslBumpNeed: sslBump required: bump
> 2023/09/13 17:14:00.283 kid1| 83,3| client_side_request.cc(1501)
> sslBumpNeed: sslBump required: client-first
> 
> Why " sslBump required: bump" and not splice? Even "worse", why does it do
> client-first then? Is it right it defaults to this if the CONNECT is
> refused?
> Then in cache.log I see a lot of messages where it seems that Squid is
> talking TLS with the client, probably sending the access denied page.
> 
> If I simply add in the config
> acl lux src 192.168.1.179
> http_access allow lux
> 
> then it works, with
> 2023-09-13T17:28:21.877+0200 108353 192.168.1.179 TCP_TUNNEL/200 4853
> CONNECT vp.nyt.com:443 - HIER_DIRECT/vp.nyt.com -
> 2023-09-13T17:28:21.878+0200 108441 192.168.1.179 TCP_TUNNEL/200 7894
> CONNECT mwcm.nytimes.com:443 - HIER_DIRECT/mwcm.nytimes.com -
> 2023-09-13T17:28:21.879+0200 110154 192.168.1.179 TCP_TUNNEL/200 6337
> CONNECT a.nytimes.com:443 - HIER_DIRECT/a.nytimes.com -
> 2023-09-13T17:28:21.879+0200 111702 192.168.1.179 TCP_TUNNEL/200 514229
> CONNECT g1.nyt.com:443 - HIER_DIRECT/g1.nyt.com -
> 2023-09-13T17:28:21.880+0200 111702 192.168.1.179 TCP_TUNNEL/200 648915
> CONNECT static01.nyt.com:443 - HIER_DIRECT/static01.nyt.com -
> 2023-09-13T17:28:21.880+0200 111890 192.168.1.179 TCP_TUNNEL/200 10986
> CONNECT samizdat-graphql.nytimes.com:443 -
> HIER_DIRECT/samizdat-graphql.nytimes.com -
> 2023-09-13T17:28:21.881+0200 112017 192.168.1.179 TCP_TUNNEL/200 72448
> CONNECT static01.nytimes.com:443 - HIER_DIRECT/static01.nytimes.com -
> 2023-09-13T17:28:21.881+0200 112018 192.168.1.179 TCP_TUNNEL/200 286645
> CONNECT static01.nytimes.com:443 - HIER_DIRECT/static01.nytimes.com -
> 2023-09-13T17:28:21.882+0200 112043 192.168.1.179 TCP_TUNNEL/200 15345
> CONNECT g1.nyt.com:443 - HIER_DIRECT/g1.nyt.com -
> 2023-09-13T17:28:21.883+0200 112333 192.168.1.179 TCP_TUNNEL/200 2390864
> CONNECT www.nytimes.com:443 - HIER_DIRECT/www.nytimes.com -
> 
> And in cache.log, no more client-first mentions:
> 2023/09/13 17:26:33.523 kid1| 83,3| client_side_request.cc(1748) doCallouts:
> Doing clientInterpretRequestHeaders()
> 2023/09/13 17:26:33.523 kid1| 83,3| client_side_request.cc(1501)
> sslBumpNeed: sslBump required: peek
> 2023/09/13 17:26:33.523 kid1| 83,3| client_side_request.cc(1842) doCallouts:
> calling processRequest()
> 
> 
> I also tried with an interception proxy (transparent proxy) config. The
> results are similar but not identical:
> I added to the original config (the one which prohibits the CONNECT):
> http_port 3128
> 
> and changed port 3130 so:
> https_port 3130 intercept ssl-bump generate-host-certificates=on
> dynamic_cert_mem_cache_size=6MB cert=/etc/squid/ssl_cert/myCA.pem
> 
> Now I get:
> 2023-09-13T17:52:17.109+0200      6 192.168.1.179 TCP_DENIED/000 0 CONNECT
> 151.101.241.164:443 - HIER_NONE/- -
> 2023-09-13T17:52:17.109+0200      0 192.168.1.179 NONE_NONE/403 3732 GET
> https://www. nytimes.com/ - HIER_NONE/- text/html
> 
> TCP_DENIED/000 is more clear than TCP_DENIED/200. But the GET, making me
> think to some bumping code, is still there.
> 
> In cache.log, I find:
> 
> 2023/09/13 17:53:06.539 kid1| 83,7| LogTags.cc(57) update: TAG_NONE to
> TCP_DENIED
> 2023/09/13 17:53:06.539 kid1| 83,3| client_side_request.cc(1501)
> sslBumpNeed: sslBump required: peek
> 2023/09/13 17:53:06.539 kid1| 83,3| client_side_request.cc(1501)
> sslBumpNeed: sslBump required: client-first
> 
> So this time, it is doing peek first (and this is ok with the config), but
> then it recurs to client-first, which could be the reason why the encrypted
> HTTPS traffic is decoded and the HTTP GET is shown.
> 
> Is this whole behavior correct? Anyway, when I white-list the CONNECT,
> everything seems to work right.
> 
> Thank you,
> Luigi
> 
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> https://lists.squid-cache.org/listinfo/squid-users



From rousskov at measurement-factory.com  Wed Sep 13 18:53:07 2023
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Wed, 13 Sep 2023 14:53:07 -0400
Subject: [squid-users] Squid BUG: assurance failed:
 tok.skip(WellKnownUrlPathPrefix())
In-Reply-To: <72DD5D5CF661B5459DC08A060BF26B53C45E66@kjj-server.KJJ.local>
References: <37e6b005-6d0a-b50f-19c2-a524320dccb5@kjj.cz>
 <d42a6203-ca8d-4964-b3da-16f9479e17e9@measurement-factory.com>
 <72DD5D5CF661B5459DC08A060BF26B53C45E63@kjj-server.KJJ.local>
 <72DD5D5CF661B5459DC08A060BF26B53C45E64@kjj-server.KJJ.local>
 <eb8e4a57-aafd-407d-be7b-20bfb2088bab@measurement-factory.com>
 <72DD5D5CF661B5459DC08A060BF26B53C45E66@kjj-server.KJJ.local>
Message-ID: <5ff5690a-17b2-43c5-8b76-57b5cefdecf7@measurement-factory.com>

On 2023-09-12 15:50, Lou?ansk? Luk?? wrote:

> 2023/09/12 19:12:03 kid4| ERROR: Squid BUG: assurance failed: 
> tok.skip(WellKnownUrlPathPrefix())

> Request:
> GET cache_object://squid_ip/info HTTP/1.0
> Host: squid_ip
> User-Agent: squidclient/4.6
> Accept: */*
> Connection: close

Thank you for sharing this detail. I can now reproduce this problem.

You are suffering from a bug in Squid v6.3 commit 6695897 (which was 
incorrectly attributed to me). Until that bug is addressed, cache 
manager requests using the deprecated cache_object scheme (e.g., those 
emitted by older squidclients) will trigger the above 
WellKnownUrlPathPrefix assertion in Squid v6.3.

I have attached a patch that fixes this v6.3 bug in my tests.


> Sending HTTP request ...
> done.
> HTTP/1.1 404 Not Found
> Server: squid
> Mime-Version: 1.0
> Date: Tue, 12 Sep 2023 19:09:41 GMT
> Content-Type: text/html;charset=utf-8
> Content-Length: 13057
> X-Squid-Error: ERR_INVALID_URL 0
> Cache-Status: proxy;detail=no-cache
> Via: 1.1 proxy (squid)
> Connection: close
> 
> This is obviously calling for url cache_object://squid_ip/info which I 
> think is obsolete. Now I went with the new squidclient:
> 
> ./squidclient -h squid_ip -p squid_port -vv mgr:info
> 
> Request:
> GET http://squid_ip:squid_port/squid-internal-mgr/info HTTP/1.0
> Host: 10.50.1.5:3127
> User-Agent: squidclient/6.3
> Accept: */*
> Connection: close

> But it seems squid is then trying to open it's 
> visible_hostname:squid_port/squid-internal-mgr/ and due my DNS setting 
> it is its WAN IP - so it's connecting to its outside IP with its outside 
> IP which is not in the http_access manager allow list (now it is and the 
> newer squidclient works).

You are in Squid Bug 5283 territory here:
https://bugs.squid-cache.org/show_bug.cgi?id=5283

In a Linux test environment, I can work around those "outside IP" 
problems by adding "-l 127.0.0.1" option to squidclient, forcing 
squidclient to connect to Squid from the loopback address. IIRC, that 
"-l" trick does not work in environments that do not support 
from-localhost connections to "outside IPs" on the same box (e.g., Windows).


HTH,

Alex.



> -----P?vodn? zpr?va-----
> Od: squid-users za u?ivatele Alex Rousskov
> Odesl?no: ?t 12.9.2023 19:28
> Komu: squid-users at lists.squid-cache.org
> P?edm?t: Re: [squid-users] Squid BUG: assurance failed: 
> tok.skip(WellKnownUrlPathPrefix())
> 
> On 2023-09-12 13:06, Lou?ansk? Luk?? wrote:
>  > Is this anyhow interesting?
> 
> Not really, IMO -- the problem happens earlier. I can confirm that you
> are running v6.3-based code. Let's call that progress :-).
> 
> Can you share the a _pointer_ to a compressed ALL,9 cache.log file while
> reproducing the problem using a single transaction?
> 
> https://wiki.squid-cache.org/SquidFaq/BugReporting#debugging-a-single-transaction <https://wiki.squid-cache.org/SquidFaq/BugReporting#debugging-a-single-transaction>
> 
> Alex.
> 
>  >
>  > 2023/09/12 18:47:04.267 kid4| 24,8| SBuf.cc(30) SBuf: SBuf15514952 
> created
>  > 2023/09/12 18:47:04.267 kid4| 24,8| SBuf.cc(30) SBuf: SBuf15514953 
> created
>  > 2023/09/12 18:47:04.267 kid4| 24,8| SBuf.cc(30) SBuf: SBuf15514954 
> created
>  > 2023/09/12 18:47:04.267 kid4| 24,7| SBuf.cc(85) assign: assigning
>  > SBuf15514952 from SBuf15514912
>  > 2023/09/12 18:47:04.267 kid4| 24,8| SBuf.cc(38) SBuf: SBuf15514955
>  > created from id SBuf15514915
>  > 2023/09/12 18:47:04.267 kid4| 24,8| SBuf.cc(445) startsWith:
>  > SBuf15514955 startsWith SBuf125812, caseSensitive: 0
>  > 2023/09/12 18:47:04.267 kid4| 24,8| SBuf.cc(447) startsWith: no, too 
> short
>  > 2023/09/12 18:47:04.267 kid4| 24,8| Tokenizer.cc(185) skip: no match,
>  > not skipping '/squid-internal-mgr/'
>  > 2023/09/12 18:47:04 kid4| ERROR: Squid BUG: assurance failed:
>  > tok.skip(WellKnownUrlPathPrefix())
>  > 2023/09/12 18:47:04.268 kid4| 24,8| SBuf.cc(70) ~SBuf: SBuf15514955
>  > destructed
>  >
>  >
>  > BTW debug 24,9 makes pretty big log files... :-)
>  >
>  > L
>  >
> 
> 
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> https://lists.squid-cache.org/listinfo/squid-users
-------------- next part --------------
Restore support for legacy cache_object cache manager requests

Squid v6.3 commit 6695897 (i.e. a backport of master/v7 commit 3c383cc)
accidentally removed support of legacy cache_object URLs (that master/v7
does not support) from Squid v6. This fix restores that support in v6.

diff --git a/src/cache_manager.cc b/src/cache_manager.cc
index bb70216..dbb99d9 100644
--- a/src/cache_manager.cc
+++ b/src/cache_manager.cc
@@ -189,9 +189,9 @@ Mgr::Command::Pointer
 CacheManager::ParseUrl(const AnyP::Uri &uri)
 {
     Parser::Tokenizer tok(uri.path());
 
-    Assure(tok.skip(WellKnownUrlPathPrefix()));
+    Assure(tok.skip(WellKnownUrlPathPrefix()) || tok.skip('/'));
 
     Mgr::Command::Pointer cmd = new Mgr::Command();
     cmd->params.httpUri = SBufToString(uri.absolute());
 

From Loucansky.Lukas at kjj.cz  Thu Sep 14 10:40:52 2023
From: Loucansky.Lukas at kjj.cz (=?iso-8859-2?B?TG916GFuc2v9IEx1a+G5?=)
Date: Thu, 14 Sep 2023 12:40:52 +0200
Subject: [squid-users] Squid BUG: assurance failed:
 tok.skip(WellKnownUrlPathPrefix())
References: <37e6b005-6d0a-b50f-19c2-a524320dccb5@kjj.cz>
 <d42a6203-ca8d-4964-b3da-16f9479e17e9@measurement-factory.com>
 <72DD5D5CF661B5459DC08A060BF26B53C45E63@kjj-server.KJJ.local>
 <72DD5D5CF661B5459DC08A060BF26B53C45E64@kjj-server.KJJ.local>
 <eb8e4a57-aafd-407d-be7b-20bfb2088bab@measurement-factory.com>
 <72DD5D5CF661B5459DC08A060BF26B53C45E66@kjj-server.KJJ.local>
 <5ff5690a-17b2-43c5-8b76-57b5cefdecf7@measurement-factory.com>
Message-ID: <72DD5D5CF661B5459DC08A060BF26B53C45E67@kjj-server.KJJ.local>

Wow - Alex now even the old cachemgr.cgi works :-] client v4.6 also works

But - could someone (or you) clarify the next one for me? I've read some questions about the "new" cachemgr.cgi and the MGR_INDEX template. Without this file the only output which the cmgr.cgi produces is "Internal Error: Missing Template MGR_INDEX". But if I put content from MGR_INDEX from https://github.com/yadij/cachemgr.js/ it gives me (Apache/2.4.38 Debian)

[Wed Sep 13 05:57:57.902368 2023] [cgid:error] [pid 22501:tid 140478824113920] [client 192.168.xx.xx:24201] End of script output before headers: cachemgr.cgi, referer: http://squid_IP/cgi-bin/cachemgr.cgi
assertion failed: MemBuf.cc:211: "sz >= 0"

(line 211 is in the function MemBuf::Append)

But if I put only some text in the MGR_INDEX file (something like <p>Test bla bla</p>) it renders 

Cache Manager menu for localhost:
Test bla bla

Generated Thu, 14 Sep 2023 10:16:11 GMT, by cachemgr.cgi/6.3-20230903-ra9c06aa6a at proxy

Have not found any info about substitutions (eq. like in the ERR files) or something. I thought if there is no MGR_INDEX file cachemgr.cgi should work as the old one - and MGR_INDEX is only used while I need some customization or my own design/functions.


Besides that I have found out that every time I shutdown squid with start-stop-daemon it coredumps. Frankly - I do not have capacity to go through these.

ep 14 11:55:13 proxy squid[23984]: Squid Parent: squid-4 process 23990 exited due to signal 6 with status 0
Sep 14 11:55:15 proxy squid[23984]: Squid Parent: squid-1 process 23993 exited due to signal 6 with status 0
Sep 14 11:55:47 proxy squid[23984]: Squid Parent: squid-3 process 23991 exited due to signal 6 with status 0
Sep 14 11:55:48 proxy squid[23984]: Squid Parent: squid-2 process 23992 exited due to signal 6 with status 0
Sep 14 11:56:18 proxy systemd-coredump[3679]: Process 23990 (squid) of user 13 dumped core.#012#012Stack trace of thread 23990:
#012#0  0x00007f35c21ab8eb __GI_raise (libc.so.6)
#012#1  0x00007f35c2196535 __GI_abort (libc.so.6)
#012#2  0x000055c7eca80694 xassert (squid)
#012#3  0x000055c7ecb23c7c _ZN5Store4RootEv (squid)
#012#4  0x000055c7ec8805af _ZN10StoreEntry16destroyMemObjectEv (squid)
#012#5  0x000055c7ec8811f6 _Z17destroyStoreEntryPv (squid)
#012#6  0x000055c7ecb2d3eb hashFreeItems (squid)
#012#7  0x000055c7ecb1fe4a _ZN5Store10ControllerD1Ev (squid)
#012#8  0x000055c7ecb1fec9 _ZN5Store10ControllerD0Ev (squid)
#012#9  0x00007f35c21adebc __run_exit_handlers (libc.so.6)
#012#10 0x00007f35c21adfea __GI_exit (libc.so.6)
#012#11 0x000055c7ec847ce3 SquidShutdown (squid)
#012#12 0x000055c7ec6f0cf1 SquidMainSafe (squid)
#012#13 0x00007f35c219809b __libc_start_main (libc.so.6)
#012#14 0x000055c7ec6fa71a _start (squid)
Sep 14 11:56:18 proxy systemd-coredump[3681]: Process 23993 (squid) of user 13 dumped core.
#012#012Stack trace of thread 23993:
#012#0  0x00007f169c64c8eb __GI_raise (libc.so.6)#012#1  0x00007f169c637535 __GI_abort (libc.so.6)
#012#2  0x0000557ee57ab694 xassert (squid)
#012#3  0x0000557ee584ec7c _ZN5Store4RootEv (squid)
#012#4  0x0000557ee55ab5af _ZN10StoreEntry16destroyMemObjectEv (squid)
#012#5  0x0000557ee55ac1f6 _Z17destroyStoreEntryPv (squid)
#012#6  0x0000557ee58583eb hashFreeItems (squid)
#012#7  0x0000557ee584ae4a _ZN5Store10ControllerD1Ev (squid)
#012#8  0x0000557ee584aec9 _ZN5Store10ControllerD0Ev (squid)
#012#9  0x00007f169c64eebc __run_exit_handlers (libc.so.6)
#012#10 0x00007f169c64efea __GI_exit (libc.so.6)#012#11 0x0000557ee5572ce3 SquidShutdown (squid)
#012#12 0x0000557ee541bcf1 SquidMainSafe (squid)
#012#13 0x00007f169c63909b __libc_start_main (libc.so.6)#012#14 0x0000557ee542571a _start (squid)
Sep 14 11:56:18 proxy systemd[1]: systemd-coredump at 60-3678-0.service: Succeeded.
Sep 14 11:56:18 proxy systemd[1]: systemd-coredump at 61-3680-0.service: Succeeded.
Sep 14 11:56:42 proxy systemd-coredump[3688]: Process 23992 (squid) of user 13 dumped core.
#012#012Stack trace of thread 23992:#012
#0  0x00007fa6a64568eb __GI_raise (libc.so.6
#012#1  0x00007fa6a6441535 __GI_abort (libc.so.6)
#012#2  0x000055bde67df694 xassert (squid)
#012#3  0x000055bde6882c7c _ZN5Store4RootEv (squid)
#012#4  0x000055bde65df5af _ZN10StoreEntry16destroyMemObjectEv (squid)
#012#5  0x000055bde65e01f6 _Z17destroyStoreEntryPv (squid)
#012#6  0x000055bde688c3eb hashFreeItems (squid)
#012#7  0x000055bde687ee4a _ZN5Store10ControllerD1Ev (squid)
#012#8  0x000055bde687eec9 _ZN5Store10ControllerD0Ev (squid)
#012#9  0x00007fa6a6458ebc __run_exit_handlers (libc.so.6)
#012#10 0x00007fa6a6458fea __GI_exit (libc.so.6)
#012#11 0x000055bde65a6ce3 SquidShutdown (squid)
#012#12 0x000055bde644fcf1 SquidMainSafe (squid)
#012#13 0x00007fa6a644309b __libc_start_main (libc.so.6)
#012#14 0x000055bde645971a _start (squid)
Sep 14 11:56:43 proxy systemd[1]: systemd-coredump at 62-3685-0.service: Succeeded.
Sep 14 11:56:56 proxy systemd-coredump[3677]: Process 23991 (squid) of user 13 dumped core.
#012#012Stack trace of thread 23991:
#012#0  0x00007fbe358dd8eb __GI_raise (libc.so.6)
#012#1  0x00007fbe358c8535 __GI_abort (libc.so.6)
#012#2  0x00005642b5ae8694 xassert (squid)
#012#3  0x00005642b5b8bc7c _ZN5Store4RootEv (squid)
#012#4  0x00005642b58e85af _ZN10StoreEntry16destroyMemObjectEv (squid)
#012#5  0x00005642b58e91f6 _Z17destroyStoreEntryPv (squid)
#012#6  0x00005642b5b953eb hashFreeItems (squid)
#012#7  0x00005642b5b87e4a _ZN5Store10ControllerD1Ev (squid)
#012#8  0x00005642b5b87ec9 _ZN5Store10ControllerD0Ev (squid)
#012#9  0x00007fbe358dfebc __run_exit_handlers (libc.so.6)
#012#10 0x00007fbe358dffea __GI_exit (libc.so.6)
#012#11 0x00005642b58afce3 SquidShutdown (squid)
#012#12 0x00005642b5758cf1 SquidMainSafe (squid)
#012#13 0x00007fbe358ca09b __libc_start_main (libc.so.6)
#012#14 0x00005642b576271a _start (squid)
Sep 14 11:56:57 proxy systemd[1]: systemd-coredump at 59-3676-0.service: Succeeded.


Maybe something with my (rock) storage closing?
THX
LL


-----P?vodn? zpr?va-----
Od: squid-users za u?ivatele Alex Rousskov
Odesl?no: st 13.9.2023 20:53
Komu: squid-users at lists.squid-cache.org
P?edm?t: Re: [squid-users] Squid BUG: assurance failed: tok.skip(WellKnownUrlPathPrefix())
 
On 2023-09-12 15:50, Lou?ansk? Luk?? wrote:

> 2023/09/12 19:12:03 kid4| ERROR: Squid BUG: assurance failed: 
> tok.skip(WellKnownUrlPathPrefix())

> Request:
> GET cache_object://squid_ip/info HTTP/1.0
> Host: squid_ip
> User-Agent: squidclient/4.6
> Accept: */*
> Connection: close

Thank you for sharing this detail. I can now reproduce this problem.

You are suffering from a bug in Squid v6.3 commit 6695897 (which was 
incorrectly attributed to me). Until that bug is addressed, cache 
manager requests using the deprecated cache_object scheme (e.g., those 
emitted by older squidclients) will trigger the above 
WellKnownUrlPathPrefix assertion in Squid v6.3.

I have attached a patch that fixes this v6.3 bug in my tests.


> Sending HTTP request ...
> done.
> HTTP/1.1 404 Not Found
> Server: squid
> Mime-Version: 1.0
> Date: Tue, 12 Sep 2023 19:09:41 GMT
> Content-Type: text/html;charset=utf-8
> Content-Length: 13057
> X-Squid-Error: ERR_INVALID_URL 0
> Cache-Status: proxy;detail=no-cache
> Via: 1.1 proxy (squid)
> Connection: close
> 
> This is obviously calling for url cache_object://squid_ip/info which I 
> think is obsolete. Now I went with the new squidclient:
> 
> ./squidclient -h squid_ip -p squid_port -vv mgr:info
> 
> Request:
> GET http://squid_ip:squid_port/squid-internal-mgr/info HTTP/1.0
> Host: 10.50.1.5:3127
> User-Agent: squidclient/6.3
> Accept: */*
> Connection: close

> But it seems squid is then trying to open it's 
> visible_hostname:squid_port/squid-internal-mgr/ and due my DNS setting 
> it is its WAN IP - so it's connecting to its outside IP with its outside 
> IP which is not in the http_access manager allow list (now it is and the 
> newer squidclient works).

You are in Squid Bug 5283 territory here:
https://bugs.squid-cache.org/show_bug.cgi?id=5283

In a Linux test environment, I can work around those "outside IP" 
problems by adding "-l 127.0.0.1" option to squidclient, forcing 
squidclient to connect to Squid from the loopback address. IIRC, that 
"-l" trick does not work in environments that do not support 
from-localhost connections to "outside IPs" on the same box (e.g., Windows).


HTH,

Alex.



> -----P?vodn? zpr?va-----
> Od: squid-users za u?ivatele Alex Rousskov
> Odesl?no: ?t 12.9.2023 19:28
> Komu: squid-users at lists.squid-cache.org
> P?edm?t: Re: [squid-users] Squid BUG: assurance failed: 
> tok.skip(WellKnownUrlPathPrefix())
> 
> On 2023-09-12 13:06, Lou?ansk? Luk?? wrote:
>  > Is this anyhow interesting?
> 
> Not really, IMO -- the problem happens earlier. I can confirm that you
> are running v6.3-based code. Let's call that progress :-).
> 
> Can you share the a _pointer_ to a compressed ALL,9 cache.log file while
> reproducing the problem using a single transaction?
> 
> https://wiki.squid-cache.org/SquidFaq/BugReporting#debugging-a-single-transaction <https://wiki.squid-cache.org/SquidFaq/BugReporting#debugging-a-single-transaction>
> 
> Alex.
> 
>  >
>  > 2023/09/12 18:47:04.267 kid4| 24,8| SBuf.cc(30) SBuf: SBuf15514952 
> created
>  > 2023/09/12 18:47:04.267 kid4| 24,8| SBuf.cc(30) SBuf: SBuf15514953 
> created
>  > 2023/09/12 18:47:04.267 kid4| 24,8| SBuf.cc(30) SBuf: SBuf15514954 
> created
>  > 2023/09/12 18:47:04.267 kid4| 24,7| SBuf.cc(85) assign: assigning
>  > SBuf15514952 from SBuf15514912
>  > 2023/09/12 18:47:04.267 kid4| 24,8| SBuf.cc(38) SBuf: SBuf15514955
>  > created from id SBuf15514915
>  > 2023/09/12 18:47:04.267 kid4| 24,8| SBuf.cc(445) startsWith:
>  > SBuf15514955 startsWith SBuf125812, caseSensitive: 0
>  > 2023/09/12 18:47:04.267 kid4| 24,8| SBuf.cc(447) startsWith: no, too 
> short
>  > 2023/09/12 18:47:04.267 kid4| 24,8| Tokenizer.cc(185) skip: no match,
>  > not skipping '/squid-internal-mgr/'
>  > 2023/09/12 18:47:04 kid4| ERROR: Squid BUG: assurance failed:
>  > tok.skip(WellKnownUrlPathPrefix())
>  > 2023/09/12 18:47:04.268 kid4| 24,8| SBuf.cc(70) ~SBuf: SBuf15514955
>  > destructed
>  >
>  >
>  > BTW debug 24,9 makes pretty big log files... :-)
>  >
>  > L
>  >
> 
> 
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> https://lists.squid-cache.org/listinfo/squid-users


-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230914/1b9bed63/attachment.htm>

From flashdown at data-core.org  Thu Sep 14 11:02:54 2023
From: flashdown at data-core.org (Flashdown)
Date: Thu, 14 Sep 2023 13:02:54 +0200
Subject: [squid-users] Squid 5.6 and 5.9 keep crashing due to signal 6 with
 status 0
Message-ID: <662260091314b912460378340ce231a7@data-core.org>

Hello together,

yesterday an unexpected issue occured for the first time on only one of 
my squid servers, while having more than 20 of them.

The issue is that out of a sudden squid just dies with such messages 
visible in the systemctl status output for squid:

Sep 14 08:55:06 vm-myproxy squid[79100]: Squid Parent: squid-2 process 
80675 exited due to signal 6 with status 0
Sep 14 08:55:06 vm-myproxy squid[79100]: Squid Parent: squid-2 process 
80675 will not be restarted for 3600 seconds due to repeated, frequent 
failures

I tried a snapshot of april of this server and have the same results, so 
I can assure there where no changes done. We also tried a restore from 
backup as well as deploying a new server. All result in the same. Then I 
have upgraded squid last night from 5.6 on Debian 11 to 5.9 and it 
worked for the night, today the same issue happened in the morning and 
keeped happening until I found a timely coincidence with a client 
request each time the proxy dies in the access.log which looks exactly 
like these:

1694674498.411      9 **CENSORED_internal_client_IP** TCP_DENIED/407 
4129 CONNECT [ff00::]:443 - HIER_NONE/- text/html
1694674498.464      1 **CENSORED_internal_client_IP** TCP_DENIED/407 
4129 CONNECT [ff00::]:443 - HIER_NONE/- text/html
1694674499.556      7 **CENSORED_internal_client_IP** TCP_DENIED/407 
4129 CONNECT [ff00::]:443 - HIER_NONE/- text/html

So my next idea was to block all the requests of this client using 
iptables, just out of curiosity and since then squid seems to keep 
beeing up and running correctly. So does anybody know a bug that would 
match here or did I step into something new/unknown?

The client desktop PC (Windows 10) causing these requests is currently 
disconnected from the network and shutdown for further analysis and 
tests.

Our Squid is configured to require kerberos authentication and IPv6 is 
disabled via sysctl config "net.ipv6.conf.all.disable_ipv6=1" as 
currently only IPv4 is available and because ipv4_first config option of 
squid was deprecated some while ago.

The cache.log is attached to this mail.

Any idea/help is highly appreciated. Thank you!

-- 
Best regards,
Flashdown

This email and any files transmitted with it are confidential and
intended solely for the use of the individual or entity to whom they
are addressed. If you have received this email in error please notify
the system manager. This message contains confidential information and
is intended only for the individual named. If you are not the named
addressee you should not disseminate, distribute or copy this e-mail.
Please notify the sender immediately by e-mail if you have received
this e-mail by mistake and delete this e-mail from your system. If you
are not the intended recipient you are notified that disclosing,
copying, distributing or taking any action in reliance on the contents
of this information is strictly prohibited.
-------------- next part --------------
An embedded and charset-unspecified text was scrubbed...
Name: cache.log.txt
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230914/693377a8/attachment.txt>

From rousskov at measurement-factory.com  Thu Sep 14 14:11:52 2023
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Thu, 14 Sep 2023 10:11:52 -0400
Subject: [squid-users] Squid 5.6 and 5.9 keep crashing due to signal 6
 with status 0
In-Reply-To: <662260091314b912460378340ce231a7@data-core.org>
References: <662260091314b912460378340ce231a7@data-core.org>
Message-ID: <72c1fbc2-f4a0-4e14-b8ea-430e4bc16ea9@measurement-factory.com>

On 2023-09-14 07:02, Flashdown wrote:

> Sep 14 08:55:06 vm-myproxy squid[79100]: Squid Parent: squid-2 process 
> 80675 exited due to signal 6 with status 0

> 1694674498.411????? 9 **CENSORED_internal_client_IP** TCP_DENIED/407 
> 4129 CONNECT [ff00::]:443 - HIER_NONE/- text/html

> IPv6 is disabled via sysctl config "net.ipv6.conf.all.disable_ipv6=1"


Your Squid is most likely suffering (among other v5 bugs) from Squid Bug 
5154: https://bugs.squid-cache.org/show_bug.cgi?id=5154

To confirm, enable core dumps and look for a gdb backtrace sequence 
similar to the one posted in the above bug report:

* in __assert_fail
* in Ip::Address::getAddrInfo(addrinfo*&, int) const
* in comm_openex(int, int, Ip::Address&, int, char const*)

The best known way to prevent bug 5154 is to enable IPv6 support. If 
that is not feasible in your environment, then please keep reading.


Squid bug 5154 has an unofficial but, IMO, correct fix at PR 1421:
https://github.com/squid-cache/squid/pull/1421

The above fix is not trivial and has side effects: For Squids that 
cannot handle IPv6 (e.g., because IPv6 support was disabled at 
./configure time or is unavailable in the deployment environment), the 
fix will, in part, reject requests with IPv6 addresses in URLs. This 
rejection may negatively affect Squids that were "worked OK" by 
forwarding such traffic to IPv4 ICAP servers and cache_peers (at least).

PR 1421 changes cannot be applied to Squid v5 "as is"; they have to be 
backported. I do not have a backporting patch for virgin Squid v5.


HTH,

Alex.



From rousskov at measurement-factory.com  Thu Sep 14 21:55:11 2023
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Thu, 14 Sep 2023 17:55:11 -0400
Subject: [squid-users] Squid BUG: assurance failed:
 tok.skip(WellKnownUrlPathPrefix())
In-Reply-To: <72DD5D5CF661B5459DC08A060BF26B53C45E67@kjj-server.KJJ.local>
References: <37e6b005-6d0a-b50f-19c2-a524320dccb5@kjj.cz>
 <d42a6203-ca8d-4964-b3da-16f9479e17e9@measurement-factory.com>
 <72DD5D5CF661B5459DC08A060BF26B53C45E63@kjj-server.KJJ.local>
 <72DD5D5CF661B5459DC08A060BF26B53C45E64@kjj-server.KJJ.local>
 <eb8e4a57-aafd-407d-be7b-20bfb2088bab@measurement-factory.com>
 <72DD5D5CF661B5459DC08A060BF26B53C45E66@kjj-server.KJJ.local>
 <5ff5690a-17b2-43c5-8b76-57b5cefdecf7@measurement-factory.com>
 <72DD5D5CF661B5459DC08A060BF26B53C45E67@kjj-server.KJJ.local>
Message-ID: <af6dbe4b-20e6-4427-bbe2-e47991cfb4cd@measurement-factory.com>

On 2023-09-14 06:40, Lou?ansk? Luk?? wrote:

> But - could someone (or you) clarify the next one for me? I've read some 
> questions about the "new" cachemgr.cgi and the MGR_INDEX template. 

Sorry, I cannot help with cachemgr.cgi without heroic efforts. IMHO, 
Squid Project should remove cachemgr.cgi feature instead of supporting 
it. I hope that somebody else will help you with it.


> Besides that I have found out that every time I shutdown squid with 
> start-stop-daemon it coredumps.

> user 13 dumped core.#012#012Stack trace of thread 23990:
> #012#2? 0x000055c7eca80694 xassert (squid)
> #012#3? 0x000055c7ecb23c7c _ZN5Store4RootEv (squid)
> #012#4? 0x000055c7ec8805af _ZN10StoreEntry16destroyMemObjectEv (squid)
> #012#5? 0x000055c7ec8811f6 _Z17destroyStoreEntryPv (squid)
> #012#6? 0x000055c7ecb2d3eb hashFreeItems (squid)
> #012#7? 0x000055c7ecb1fe4a _ZN5Store10ControllerD1Ev (squid)
> #012#8? 0x000055c7ecb1fec9 _ZN5Store10ControllerD0Ev (squid)
> #012#9? 0x00007f35c21adebc __run_exit_handlers (libc.so.6)
> #012#10 0x00007f35c21adfea __GI_exit (libc.so.6)
> #012#11 0x000055c7ec847ce3 SquidShutdown (squid)

Yes, "TheRoot" assertions after shutdown (during "automatic" at-exit 
cleanup) is a known bug. Recent shutdown improvements make this 
particular assertion more likely, unfortunately. More difficult work is 
needed to fully solve the underlying problem. We will solve it.

Meanwhile, please try the attached patch with an untested workaround. 
Does it help in your environment?


Thank you,

Alex.


> -----P?vodn? zpr?va-----
> Od: squid-users za u?ivatele Alex Rousskov
> Odesl?no: st 13.9.2023 20:53
> Komu: squid-users at lists.squid-cache.org
> P?edm?t: Re: [squid-users] Squid BUG: assurance failed: 
> tok.skip(WellKnownUrlPathPrefix())
> 
> On 2023-09-12 15:50, Lou?ansk? Luk?? wrote:
> 
>  > 2023/09/12 19:12:03 kid4| ERROR: Squid BUG: assurance failed:
>  > tok.skip(WellKnownUrlPathPrefix())
> 
>  > Request:
>  > GET cache_object://squid_ip/info HTTP/1.0
>  > Host: squid_ip
>  > User-Agent: squidclient/4.6
>  > Accept: */*
>  > Connection: close
> 
> Thank you for sharing this detail. I can now reproduce this problem.
> 
> You are suffering from a bug in Squid v6.3 commit 6695897 (which was
> incorrectly attributed to me). Until that bug is addressed, cache
> manager requests using the deprecated cache_object scheme (e.g., those
> emitted by older squidclients) will trigger the above
> WellKnownUrlPathPrefix assertion in Squid v6.3.
> 
> I have attached a patch that fixes this v6.3 bug in my tests.
> 
> 
>  > Sending HTTP request ...
>  > done.
>  > HTTP/1.1 404 Not Found
>  > Server: squid
>  > Mime-Version: 1.0
>  > Date: Tue, 12 Sep 2023 19:09:41 GMT
>  > Content-Type: text/html;charset=utf-8
>  > Content-Length: 13057
>  > X-Squid-Error: ERR_INVALID_URL 0
>  > Cache-Status: proxy;detail=no-cache
>  > Via: 1.1 proxy (squid)
>  > Connection: close
>  >
>  > This is obviously calling for url cache_object://squid_ip/info which I
>  > think is obsolete. Now I went with the new squidclient:
>  >
>  > ./squidclient -h squid_ip -p squid_port -vv mgr:info
>  >
>  > Request:
>  > GET http://squid_ip:squid_port/squid-internal-mgr/info 
> <http://squid_ip:squid_port/squid-internal-mgr/info> HTTP/1.0
>  > Host: 10.50.1.5:3127
>  > User-Agent: squidclient/6.3
>  > Accept: */*
>  > Connection: close
> 
>  > But it seems squid is then trying to open it's
>  > visible_hostname:squid_port/squid-internal-mgr/ and due my DNS setting
>  > it is its WAN IP - so it's connecting to its outside IP with its outside
>  > IP which is not in the http_access manager allow list (now it is and the
>  > newer squidclient works).
> 
> You are in Squid Bug 5283 territory here:
> https://bugs.squid-cache.org/show_bug.cgi?id=5283 
> <https://bugs.squid-cache.org/show_bug.cgi?id=5283>
> 
> In a Linux test environment, I can work around those "outside IP"
> problems by adding "-l 127.0.0.1" option to squidclient, forcing
> squidclient to connect to Squid from the loopback address. IIRC, that
> "-l" trick does not work in environments that do not support
> from-localhost connections to "outside IPs" on the same box (e.g., Windows).
> 
> 
> HTH,
> 
> Alex.
> 
> 
> 
>  > -----P?vodn? zpr?va-----
>  > Od: squid-users za u?ivatele Alex Rousskov
>  > Odesl?no: ?t 12.9.2023 19:28
>  > Komu: squid-users at lists.squid-cache.org
>  > P?edm?t: Re: [squid-users] Squid BUG: assurance failed:
>  > tok.skip(WellKnownUrlPathPrefix())
>  >
>  > On 2023-09-12 13:06, Lou?ansk? Luk?? wrote:
>  >? > Is this anyhow interesting?
>  >
>  > Not really, IMO -- the problem happens earlier. I can confirm that you
>  > are running v6.3-based code. Let's call that progress :-).
>  >
>  > Can you share the a _pointer_ to a compressed ALL,9 cache.log file while
>  > reproducing the problem using a single transaction?
>  >
>  > 
> https://wiki.squid-cache.org/SquidFaq/BugReporting#debugging-a-single-transaction <https://wiki.squid-cache.org/SquidFaq/BugReporting#debugging-a-single-transaction> <https://wiki.squid-cache.org/SquidFaq/BugReporting#debugging-a-single-transaction <https://wiki.squid-cache.org/SquidFaq/BugReporting#debugging-a-single-transaction>>
>  >
>  > Alex.
>  >
>  >? >
>  >? > 2023/09/12 18:47:04.267 kid4| 24,8| SBuf.cc(30) SBuf: SBuf15514952
>  > created
>  >? > 2023/09/12 18:47:04.267 kid4| 24,8| SBuf.cc(30) SBuf: SBuf15514953
>  > created
>  >? > 2023/09/12 18:47:04.267 kid4| 24,8| SBuf.cc(30) SBuf: SBuf15514954
>  > created
>  >? > 2023/09/12 18:47:04.267 kid4| 24,7| SBuf.cc(85) assign: assigning
>  >? > SBuf15514952 from SBuf15514912
>  >? > 2023/09/12 18:47:04.267 kid4| 24,8| SBuf.cc(38) SBuf: SBuf15514955
>  >? > created from id SBuf15514915
>  >? > 2023/09/12 18:47:04.267 kid4| 24,8| SBuf.cc(445) startsWith:
>  >? > SBuf15514955 startsWith SBuf125812, caseSensitive: 0
>  >? > 2023/09/12 18:47:04.267 kid4| 24,8| SBuf.cc(447) startsWith: no, too
>  > short
>  >? > 2023/09/12 18:47:04.267 kid4| 24,8| Tokenizer.cc(185) skip: no match,
>  >? > not skipping '/squid-internal-mgr/'
>  >? > 2023/09/12 18:47:04 kid4| ERROR: Squid BUG: assurance failed:
>  >? > tok.skip(WellKnownUrlPathPrefix())
>  >? > 2023/09/12 18:47:04.268 kid4| 24,8| SBuf.cc(70) ~SBuf: SBuf15514955
>  >? > destructed
>  >? >
>  >? >
>  >? > BTW debug 24,9 makes pretty big log files... :-)
>  >? >
>  >? > L
>  >? >
>  >
>  >
>  > _______________________________________________
>  > squid-users mailing list
>  > squid-users at lists.squid-cache.org
>  > https://lists.squid-cache.org/listinfo/squid-users 
> <https://lists.squid-cache.org/listinfo/squid-users>
> 
> 
> 
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> https://lists.squid-cache.org/listinfo/squid-users
-------------- next part --------------
commit 381f130
Author: Alex Rousskov <rousskov at measurement-factory.com>
Date:   Thu Sep 14 17:50:10 2023 -0400

    Work around "TheRoot" assertions after shutdown
    
    Deleting complex objects like Stores and StoreEntries after main() is
    wrong. We probably want to delete (safely, before the end of main())
    those StoreEntries that are no longer in use. We do want to delete
    Stores before main() is over (but still leave TheRoot in a minimally
    functioning state instead of deleted!). This hack does none of that.

diff --git a/src/store/Controller.cc b/src/store/Controller.cc
index 66147a6..caa9757 100644
--- a/src/store/Controller.cc
+++ b/src/store/Controller.cc
@@ -47,10 +47,12 @@ Store::Controller::~Controller()
     delete transients;
     delete swapDir;
 
     if (store_table) {
-        hashFreeItems(store_table, destroyStoreEntry);
-        hashFreeMemory(store_table);
+        // XXX: Cannot destroy MemObjects that still have locks on entries in
+        // stores deleted above!
+        // hashFreeItems(store_table, destroyStoreEntry);
+        // hashFreeMemory(store_table);
         store_table = nullptr;
     }
 }
 

From squid3 at treenet.co.nz  Fri Sep 15 01:46:09 2023
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Fri, 15 Sep 2023 13:46:09 +1200
Subject: [squid-users] Squid BUG: assurance failed:
 tok.skip(WellKnownUrlPathPrefix())
In-Reply-To: <af6dbe4b-20e6-4427-bbe2-e47991cfb4cd@measurement-factory.com>
References: <37e6b005-6d0a-b50f-19c2-a524320dccb5@kjj.cz>
 <d42a6203-ca8d-4964-b3da-16f9479e17e9@measurement-factory.com>
 <72DD5D5CF661B5459DC08A060BF26B53C45E63@kjj-server.KJJ.local>
 <72DD5D5CF661B5459DC08A060BF26B53C45E64@kjj-server.KJJ.local>
 <eb8e4a57-aafd-407d-be7b-20bfb2088bab@measurement-factory.com>
 <72DD5D5CF661B5459DC08A060BF26B53C45E66@kjj-server.KJJ.local>
 <5ff5690a-17b2-43c5-8b76-57b5cefdecf7@measurement-factory.com>
 <72DD5D5CF661B5459DC08A060BF26B53C45E67@kjj-server.KJJ.local>
 <af6dbe4b-20e6-4427-bbe2-e47991cfb4cd@measurement-factory.com>
Message-ID: <0a50ab81-93ff-4605-844c-05fae5b18ace@treenet.co.nz>

On 15/09/23 09:55, Alex Rousskov wrote:
> On 2023-09-14 06:40, Lou?ansk? Luk?? wrote:
> 
>> But - could someone (or you) clarify the next one for me? I've read 
>> some questions about the "new" cachemgr.cgi and the MGR_INDEX template. 
> 
> Sorry, I cannot help with cachemgr.cgi without heroic efforts. IMHO, 
> Squid Project should remove cachemgr.cgi feature instead of supporting 
> it. I hope that somebody else will help you with it.
> 

FYI, the cachemgr.cgi provided by current Squid tries to auto-detect the 
existence of a working MGR_INDEX and simply provides a URL to that 
instead of doing the "old" CGI interface things.

The reasons to use it are:
  1) when managing very outdated Squid versions, or
  2) managing Squid which have not yet had a tool providing MGR_INDEX 
installed yet.


The recent changes to squidclient "mgr:" support and the cache_object:// 
  URL scheme have had a few issues. I am currently setting up a test 
environment to analyze and re-document the new/current situation. 
Hopefully some detailed info can be added to the wiki in the coming days.


HTH
Amos


From Loucansky.Lukas at kjj.cz  Fri Sep 15 06:23:54 2023
From: Loucansky.Lukas at kjj.cz (=?iso-8859-2?B?TG916GFuc2v9IEx1a+G5?=)
Date: Fri, 15 Sep 2023 08:23:54 +0200
Subject: [squid-users] Squid BUG: assurance failed:
 tok.skip(WellKnownUrlPathPrefix())
References: <37e6b005-6d0a-b50f-19c2-a524320dccb5@kjj.cz>
 <d42a6203-ca8d-4964-b3da-16f9479e17e9@measurement-factory.com>
 <72DD5D5CF661B5459DC08A060BF26B53C45E63@kjj-server.KJJ.local>
 <72DD5D5CF661B5459DC08A060BF26B53C45E64@kjj-server.KJJ.local>
 <eb8e4a57-aafd-407d-be7b-20bfb2088bab@measurement-factory.com>
 <72DD5D5CF661B5459DC08A060BF26B53C45E66@kjj-server.KJJ.local>
 <5ff5690a-17b2-43c5-8b76-57b5cefdecf7@measurement-factory.com>
 <72DD5D5CF661B5459DC08A060BF26B53C45E67@kjj-server.KJJ.local>
 <af6dbe4b-20e6-4427-bbe2-e47991cfb4cd@measurement-factory.com>
 <0a50ab81-93ff-4605-844c-05fae5b18ace@treenet.co.nz>
Message-ID: <72DD5D5CF661B5459DC08A060BF26B53C45E68@kjj-server.KJJ.local>

Ok - thanks for your reply. But this does not clarify it fully. You said cachemgr.cgi auto-detects the existence of MGR_INDEX template. But what is it supposed to do if none is found? Just displaying the message about missing MGR_INDEX? Or doing the old style "Cache Manager menu"? I have applied Alex's  patch to re-enable cache_object URI and now it obviously works - both cache_object and squid-internal-mgr. I mean - squidclient from debian packages (v4.6) works and the one compiled with squid v6.3 works too. Because of my old network NOC system a use a very old cachemgr (in fact version index.cgi/3.1.16) to ask the current v6.3 squid for its data and now it works too. 
But as I said previously - the current cachemgr.cgi displays "Internal Error: Missing Template MGR_INDEX" without MGR_INDEX file and the content of the MGR_INDEX file while it is present. As I found out - it does not like files with content with some tags or javascript references etc. Have not ruled it out - but the MGR_INDEX file provided in the https://github.com/yadij/cachemgr.js/  project just makes the mentioned assert fail in the membuf.cc.

Note - I do not like the fact it's looking for the MGR_INDEX file upon start or reconfigure - as it makes the changes more stressful while I have to call reconfigure on the working squid.

LL


-----P?vodn? zpr?va-----
Od: squid-users za u?ivatele Amos Jeffries
Odesl?no: p? 15.9.2023 03:46
Komu: squid-users at lists.squid-cache.org
P?edm?t: Re: [squid-users] Squid BUG: assurance failed: tok.skip(WellKnownUrlPathPrefix())
 
On 15/09/23 09:55, Alex Rousskov wrote:
> On 2023-09-14 06:40, Lou?ansk? Luk?? wrote:
> 
>> But - could someone (or you) clarify the next one for me? I've read 
>> some questions about the "new" cachemgr.cgi and the MGR_INDEX template. 
> 
> Sorry, I cannot help with cachemgr.cgi without heroic efforts. IMHO, 
> Squid Project should remove cachemgr.cgi feature instead of supporting 
> it. I hope that somebody else will help you with it.
> 

FYI, the cachemgr.cgi provided by current Squid tries to auto-detect the 
existence of a working MGR_INDEX and simply provides a URL to that 
instead of doing the "old" CGI interface things.

The reasons to use it are:
  1) when managing very outdated Squid versions, or
  2) managing Squid which have not yet had a tool providing MGR_INDEX 
installed yet.


The recent changes to squidclient "mgr:" support and the cache_object:// 
  URL scheme have had a few issues. I am currently setting up a test 
environment to analyze and re-document the new/current situation. 
Hopefully some detailed info can be added to the wiki in the coming days.


HTH
Amos
_______________________________________________
squid-users mailing list
squid-users at lists.squid-cache.org
https://lists.squid-cache.org/listinfo/squid-users


-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230915/85ce49f4/attachment.htm>

From squid3 at treenet.co.nz  Sat Sep 16 12:23:36 2023
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Sun, 17 Sep 2023 00:23:36 +1200
Subject: [squid-users] Squid BUG: assurance failed:
 tok.skip(WellKnownUrlPathPrefix())
In-Reply-To: <72DD5D5CF661B5459DC08A060BF26B53C45E68@kjj-server.KJJ.local>
References: <37e6b005-6d0a-b50f-19c2-a524320dccb5@kjj.cz>
 <d42a6203-ca8d-4964-b3da-16f9479e17e9@measurement-factory.com>
 <72DD5D5CF661B5459DC08A060BF26B53C45E63@kjj-server.KJJ.local>
 <72DD5D5CF661B5459DC08A060BF26B53C45E64@kjj-server.KJJ.local>
 <eb8e4a57-aafd-407d-be7b-20bfb2088bab@measurement-factory.com>
 <72DD5D5CF661B5459DC08A060BF26B53C45E66@kjj-server.KJJ.local>
 <5ff5690a-17b2-43c5-8b76-57b5cefdecf7@measurement-factory.com>
 <72DD5D5CF661B5459DC08A060BF26B53C45E67@kjj-server.KJJ.local>
 <af6dbe4b-20e6-4427-bbe2-e47991cfb4cd@measurement-factory.com>
 <0a50ab81-93ff-4605-844c-05fae5b18ace@treenet.co.nz>
 <72DD5D5CF661B5459DC08A060BF26B53C45E68@kjj-server.KJJ.local>
Message-ID: <9348d0a3-e383-4108-9c61-0182a75bb119@treenet.co.nz>

On 15/09/23 18:23, Lou?ansk? Luk?? wrote:
> Ok - thanks for your reply. But this does not clarify it fully. You said 
> cachemgr.cgi auto-detects the existence of MGR_INDEX template. But what 
> is it supposed to do if none is found? Just displaying the message about 
> missing MGR_INDEX? Or doing the old style "Cache Manager menu"? I have 
> applied Alex's? patch to re-enable cache_object URI and now it obviously 
> works - both cache_object and squid-internal-mgr. I mean - squidclient 
> from debian packages (v4.6) works and the one compiled with squid v6.3 
> works too. Because of my old network NOC system a use a very old 
> cachemgr (in fact version index.cgi/3.1.16) to ask the current v6.3 
> squid for its data and now it works too.

Ah, very old, the behaviour I described was for cachemgr.cgi v3.2.0.10 
and later.

The 3.1 version can only display the old style "Cache Manager menu" 
regardless of what the Squid server supports.

That also means it will not work with any Squid v7 or later proxies 
where the cache_object protocol has been dropped entirely.

My testing today found bug 5300, bug 5301 and few other annoyances in 
the v4+ CGI tool. So right now I am not recommending an upgrade, but it 
will be worth it once they are fixed.


HTH
Amos


From gkinkie at gmail.com  Sun Sep 17 14:55:32 2023
From: gkinkie at gmail.com (Francesco Chemolli)
Date: Sun, 17 Sep 2023 16:55:32 +0200
Subject: [squid-users] 6.2: Unsupported or unexpected from-helper
 annotation with a name reserved for Squid use
In-Reply-To: <CA+Y8hcOwENoGeAAFgRTDikePJ2EakkaH0n-_fdZ6c8eQp=Jq=w@mail.gmail.com>
References: <16ea56f0-2e7a-fe67-cf20-63924b049368@articatech.com>
 <CA+Y8hcMm2awUed15XXuTmkZAx+z2TAZz-X5NZYZP0k_3Qu7KVA@mail.gmail.com>
 <c00a816c-8e8a-d123-bf20-ebf138f949ba@articatech.com>
 <CA+Y8hcOwENoGeAAFgRTDikePJ2EakkaH0n-_fdZ6c8eQp=Jq=w@mail.gmail.com>
Message-ID: <CA+Y8hcMHL3qxRUnXXDoyfmoA=iCa-R5KC5LQaOk6hVUb0=7_rQ@mail.gmail.com>

Hi David,
  PR 1481 <https://github.com/squid-cache/squid/pull/1481> should address
your problem, it needs to be reviewed,
merged to trunk, and backported to v6 so don't hold your breath,
but it should be just a matter of time.
Once done, you will also have to add a configuration line to your
squid.conf (manual
<http://www.squid-cache.org/Doc/config/cache_log_message/>)

On Mon, Aug 28, 2023 at 10:59?PM Francesco Chemolli <gkinkie at gmail.com>
wrote:

> That's a good question; not right now, unless you're willing to patch the
> squid sources.
> In that case, just remove the debugs() statement in lines 200-203 of file
> src/helper/Reply.cc .
>
>
>
> On Mon, Aug 28, 2023 at 9:52?PM David Touzeau <david at articatech.com>
> wrote:
>
>> Thanks You
>>
>> As these changes affect many things for us ( use tags for statistics /
>> elasticsearchs) and it seems, this behavior is just a warning (seems squid
>> still work as expected like note acls)
>>
>> Is there a way to remove these warnings because they increase I/O and
>> cache.log dramatically.
>>
>> regards
>>
>> On 28/08/2023 22:46, Francesco Chemolli wrote:
>>
>> Hi David,
>>    you should use
>> itchart_=PASS
>>
>> The trailing underscore signals Squid that this is a custom header.
>>
>> On Mon, Aug 28, 2023 at 3:54?PM David Touzeau <david at articatech.com>
>> wrote:
>>
>>>
>>> Hi
>>>
>>> Since 6.2 ( aka migrating from 5.8 )
>>>
>>> Squid claim about token sent by external_acl_helper
>>>
>>> the external acl helper send
>>> "OK itchart=PASS user=dtouzeau category=143 category-name=Trackers
>>> clog=cinfo:143-Trackers;"
>>>
>>> squid claim
>>> 2023/08/28 16:47:02 kid1| WARNING: Unsupported or unexpected from-helper
>>> annotation with a name reserved for Squid use: itchart=PASS
>>>     advice: If this is a custom annotation, rename it to add a trailing
>>> underscore: itchart_
>>>     current master transaction: master278
>>> 2023/08/28 16:47:02 kid1| WARNING: Unsupported or unexpected from-helper
>>> annotation with a name reserved for Squid use: category=143
>>>     advice: If this is a custom annotation, rename it to add a trailing
>>> underscore: category_
>>>     current master transaction: master278
>>> 2023/08/28 16:47:02 kid1| WARNING: Unsupported or unexpected from-helper
>>> annotation with a name reserved for Squid use: category-name=Trackers
>>>     advice: If this is a custom annotation, rename it to add a trailing
>>> underscore: category-name_
>>>     current master transaction: master278
>>> 2023/08/28 16:47:02 kid1| WARNING: Unsupported or unexpected from-helper
>>> annotation with a name reserved for Squid use: clog=cinfo:143-Trackers;
>>>     advice: If this is a custom annotation, rename it to add a trailing
>>> underscore: clog_
>>>     current master transaction: master278
>>> 2023/08/28 16:47:02 kid1| WARNING: Unsupported or unexpected from-helper
>>> annotation with a name reserved for Squid use: itchart=PASS
>>>     advice: If this is a custom annotation, rename it to add a trailing
>>> underscore: itchart_
>>>     current master transaction: master278
>>>
>>> Did the helper instead of "itchart=PASS" must send
>>>
>>> "itchart_=PASS"
>>> or
>>> "itchart_PASS"
>>>
>>> ?
>>>
>>>
>>>
>>>
>>> --
>>> David Touzeau - Artica Tech France
>>> Development team, level 3 support
>>> ----------------------------------
>>> P: +33 6 58 44 69 46
>>> www: https://wiki.articatech.com
>>> www: http://articatech.net
>>>
>>> _______________________________________________
>>> squid-users mailing list
>>> squid-users at lists.squid-cache.org
>>> https://lists.squid-cache.org/listinfo/squid-users
>>>
>>
>>
>> --
>>     Francesco
>>
>>
>> --
>> David Touzeau - Artica Tech France
>> Development team, level 3 support
>> ----------------------------------
>> P: +33 6 58 44 69 46
>> www: https://wiki.articatech.com
>> www: http://articatech.net
>>
>>
>
> --
>     Francesco
>


-- 
    Francesco
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230917/baa507f7/attachment.htm>

From david at articatech.com  Mon Sep 18 15:58:41 2023
From: david at articatech.com (David Touzeau)
Date: Mon, 18 Sep 2023 17:58:41 +0200
Subject: [squid-users] 6.2: Unsupported or unexpected from-helper
 annotation with a name reserved for Squid use
In-Reply-To: <CA+Y8hcMHL3qxRUnXXDoyfmoA=iCa-R5KC5LQaOk6hVUb0=7_rQ@mail.gmail.com>
References: <16ea56f0-2e7a-fe67-cf20-63924b049368@articatech.com>
 <CA+Y8hcMm2awUed15XXuTmkZAx+z2TAZz-X5NZYZP0k_3Qu7KVA@mail.gmail.com>
 <c00a816c-8e8a-d123-bf20-ebf138f949ba@articatech.com>
 <CA+Y8hcOwENoGeAAFgRTDikePJ2EakkaH0n-_fdZ6c8eQp=Jq=w@mail.gmail.com>
 <CA+Y8hcMHL3qxRUnXXDoyfmoA=iCa-R5KC5LQaOk6hVUb0=7_rQ@mail.gmail.com>
Message-ID: <a2e033f0-3cce-0c78-38cd-7c36ddcd0390@articatech.com>

Many thanks Francesco !!


On 17/09/2023 16:55, Francesco Chemolli wrote:
> Hi David,
> PR 1481 <https://github.com/squid-cache/squid/pull/1481>?should 
> address your problem, it needs to be reviewed,
> merged to trunk, and backported to v6 so don't hold your breath,
> but it should be just a matter of time.
> Once done, you will also have to add a configuration line to your 
> squid.conf (manual 
> <http://www.squid-cache.org/Doc/config/cache_log_message/>)
>
> On Mon, Aug 28, 2023 at 10:59?PM Francesco Chemolli 
> <gkinkie at gmail.com> wrote:
>
>     That's a good question; not right now, unless you're willing to
>     patch the squid sources.
>     In that case, just remove the debugs() statement in lines 200-203
>     of file src/helper/Reply.cc .
>
>
>
>     On Mon, Aug 28, 2023 at 9:52?PM David Touzeau
>     <david at articatech.com> wrote:
>
>         Thanks You
>
>         As these changes affect many things for us ( use tags for
>         statistics / elasticsearchs) and it seems, this behavior is
>         just a warning (seems squid still work as expected like note acls)
>
>         Is there a way to remove these warnings because they increase
>         I/O and cache.log dramatically.
>
>         regards
>
>         On 28/08/2023 22:46, Francesco Chemolli wrote:
>>         Hi David,
>>         ? ?you should use
>>         itchart_=PASS
>>
>>         The trailing underscore signals Squid that this is a custom
>>         header.
>>
>>         On Mon, Aug 28, 2023 at 3:54?PM David Touzeau
>>         <david at articatech.com> wrote:
>>
>>
>>             Hi
>>
>>             Since 6.2 ( aka migrating from 5.8 )
>>
>>             Squid claim about token sent by external_acl_helper
>>
>>             the external acl helper send
>>             "OK itchart=PASS user=dtouzeau category=143
>>             category-name=Trackers clog=cinfo:143-Trackers;"
>>
>>             squid claim
>>             2023/08/28 16:47:02 kid1| WARNING: Unsupported or
>>             unexpected from-helper annotation with a name reserved
>>             for Squid use: itchart=PASS
>>             ??? advice: If this is a custom annotation, rename it to
>>             add a trailing underscore: itchart_
>>             ??? current master transaction: master278
>>             2023/08/28 16:47:02 kid1| WARNING: Unsupported or
>>             unexpected from-helper annotation with a name reserved
>>             for Squid use: category=143
>>             ??? advice: If this is a custom annotation, rename it to
>>             add a trailing underscore: category_
>>             ??? current master transaction: master278
>>             2023/08/28 16:47:02 kid1| WARNING: Unsupported or
>>             unexpected from-helper annotation with a name reserved
>>             for Squid use: category-name=Trackers
>>             ??? advice: If this is a custom annotation, rename it to
>>             add a trailing underscore: category-name_
>>             ??? current master transaction: master278
>>             2023/08/28 16:47:02 kid1| WARNING: Unsupported or
>>             unexpected from-helper annotation with a name reserved
>>             for Squid use: clog=cinfo:143-Trackers;
>>             ??? advice: If this is a custom annotation, rename it to
>>             add a trailing underscore: clog_
>>             ??? current master transaction: master278
>>             2023/08/28 16:47:02 kid1| WARNING: Unsupported or
>>             unexpected from-helper annotation with a name reserved
>>             for Squid use: itchart=PASS
>>             ??? advice: If this is a custom annotation, rename it to
>>             add a trailing underscore: itchart_
>>             ??? current master transaction: master278
>>
>>             Did the helper instead of "itchart=PASS" must send
>>
>>             "itchart_=PASS"
>>             or
>>             "itchart_PASS"
>>
>>             ?
>>
>>
>>
>>
>>             -- 
>>             David Touzeau - Artica Tech France
>>             Development team, level 3 support
>>             ----------------------------------
>>             P: +33 6 58 44 69 46
>>             www:https://wiki.articatech.com
>>             www:http://articatech.net  
>>
>>             _______________________________________________
>>             squid-users mailing list
>>             squid-users at lists.squid-cache.org
>>             https://lists.squid-cache.org/listinfo/squid-users
>>
>>
>>
>>         -- 
>>         ? ? Francesco
>
>         -- 
>         David Touzeau - Artica Tech France
>         Development team, level 3 support
>         ----------------------------------
>         P: +33 6 58 44 69 46
>         www:https://wiki.articatech.com
>         www:http://articatech.net  
>
>
>
>     -- 
>     ? ? Francesco
>
>
>
> -- 
> ? ? Francesco

-- 
David Touzeau - Artica Tech France
Development team, level 3 support
----------------------------------
P: +33 6 58 44 69 46
www:https://wiki.articatech.com
www:http://articatech.net  
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230918/a05eb87d/attachment.htm>

From ankor2023 at gmail.com  Tue Sep 19 14:27:50 2023
From: ankor2023 at gmail.com (Andrey K)
Date: Tue, 19 Sep 2023 17:27:50 +0300
Subject: [squid-users] Squid 5.6 and 5.9 keep crashing due to signal 6
 with status 0
In-Reply-To: <72c1fbc2-f4a0-4e14-b8ea-430e4bc16ea9@measurement-factory.com>
References: <662260091314b912460378340ce231a7@data-core.org>
 <72c1fbc2-f4a0-4e14-b8ea-430e4bc16ea9@measurement-factory.com>
Message-ID: <CADJd0Y3x_sucVCWZ=zP1bFckw6W=-pyyW1tNwVky77dahtynpg@mail.gmail.com>

Hello,

I had the same crushes. A network dump showed me that crushes occurred when
clients tried to access IPv6 http-resources.
I blocked these requests at the beginning of the proxy policy.
The following configuration seems to be a workaround for me:

acl urldst_ipv6 url_regex ^http://\[
http_access deny urldst_ipv6


I don't know if this workaround is also suitable for https-resources. May
be it should be rewritten like this:

acl urldst_ipv6_https url_regex ^\[
http_access deny urldst_ipv6_https


Kind regards,
       Ankor.

??, 14 ????. 2023??. ? 17:12, Alex Rousskov <
rousskov at measurement-factory.com>:

> On 2023-09-14 07:02, Flashdown wrote:
>
> > Sep 14 08:55:06 vm-myproxy squid[79100]: Squid Parent: squid-2 process
> > 80675 exited due to signal 6 with status 0
>
> > 1694674498.411      9 **CENSORED_internal_client_IP** TCP_DENIED/407
> > 4129 CONNECT [ff00::]:443 - HIER_NONE/- text/html
>
> > IPv6 is disabled via sysctl config "net.ipv6.conf.all.disable_ipv6=1"
>
>
> Your Squid is most likely suffering (among other v5 bugs) from Squid Bug
> 5154: https://bugs.squid-cache.org/show_bug.cgi?id=5154
>
> To confirm, enable core dumps and look for a gdb backtrace sequence
> similar to the one posted in the above bug report:
>
> * in __assert_fail
> * in Ip::Address::getAddrInfo(addrinfo*&, int) const
> * in comm_openex(int, int, Ip::Address&, int, char const*)
>
> The best known way to prevent bug 5154 is to enable IPv6 support. If
> that is not feasible in your environment, then please keep reading.
>
>
> Squid bug 5154 has an unofficial but, IMO, correct fix at PR 1421:
> https://github.com/squid-cache/squid/pull/1421
>
> The above fix is not trivial and has side effects: For Squids that
> cannot handle IPv6 (e.g., because IPv6 support was disabled at
> ./configure time or is unavailable in the deployment environment), the
> fix will, in part, reject requests with IPv6 addresses in URLs. This
> rejection may negatively affect Squids that were "worked OK" by
> forwarding such traffic to IPv4 ICAP servers and cache_peers (at least).
>
> PR 1421 changes cannot be applied to Squid v5 "as is"; they have to be
> backported. I do not have a backporting patch for virgin Squid v5.
>
>
> HTH,
>
> Alex.
>
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> https://lists.squid-cache.org/listinfo/squid-users
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230919/d89aeb74/attachment.htm>

From flashdown at data-core.org  Tue Sep 19 16:04:06 2023
From: flashdown at data-core.org (Flashdown)
Date: Tue, 19 Sep 2023 18:04:06 +0200
Subject: [squid-users] Squid 5.6 and 5.9 keep crashing due to signal 6
 with status 0
In-Reply-To: <72c1fbc2-f4a0-4e14-b8ea-430e4bc16ea9@measurement-factory.com>
References: <662260091314b912460378340ce231a7@data-core.org>
 <72c1fbc2-f4a0-4e14-b8ea-430e4bc16ea9@measurement-factory.com>
Message-ID: <19f432a6b1ca0356882341ce62d5a676@data-core.org>

Thank you Alex for confirming this and all the hints given.

I have taken another path to fix this. I have configured the dns 
forwarders that squid is configured to use, to not give out any AAAA 
responses. After that I have enabled IPv6 on this box to completly avoid 
this bug. Thank you!

---
Best regards,
Flashdown

Am 2023-09-14 16:11, schrieb Alex Rousskov:
> On 2023-09-14 07:02, Flashdown wrote:
> 
>> Sep 14 08:55:06 vm-myproxy squid[79100]: Squid Parent: squid-2 process 
>> 80675 exited due to signal 6 with status 0
> 
>> 1694674498.411????? 9 **CENSORED_internal_client_IP** TCP_DENIED/407 
>> 4129 CONNECT [ff00::]:443 - HIER_NONE/- text/html
> 
>> IPv6 is disabled via sysctl config "net.ipv6.conf.all.disable_ipv6=1"
> 
> 
> Your Squid is most likely suffering (among other v5 bugs) from Squid
> Bug 5154: https://bugs.squid-cache.org/show_bug.cgi?id=5154
> 
> To confirm, enable core dumps and look for a gdb backtrace sequence
> similar to the one posted in the above bug report:
> 
> * in __assert_fail
> * in Ip::Address::getAddrInfo(addrinfo*&, int) const
> * in comm_openex(int, int, Ip::Address&, int, char const*)
> 
> The best known way to prevent bug 5154 is to enable IPv6 support. If
> that is not feasible in your environment, then please keep reading.
> 
> 
> Squid bug 5154 has an unofficial but, IMO, correct fix at PR 1421:
> https://github.com/squid-cache/squid/pull/1421
> 
> The above fix is not trivial and has side effects: For Squids that
> cannot handle IPv6 (e.g., because IPv6 support was disabled at
> ./configure time or is unavailable in the deployment environment), the
> fix will, in part, reject requests with IPv6 addresses in URLs. This
> rejection may negatively affect Squids that were "worked OK" by
> forwarding such traffic to IPv4 ICAP servers and cache_peers (at
> least).
> 
> PR 1421 changes cannot be applied to Squid v5 "as is"; they have to be
> backported. I do not have a backporting patch for virgin Squid v5.
> 
> 
> HTH,
> 
> Alex.
> 
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> https://lists.squid-cache.org/listinfo/squid-users


From ankor2023 at gmail.com  Wed Sep 20 06:02:16 2023
From: ankor2023 at gmail.com (Andrey K)
Date: Wed, 20 Sep 2023 09:02:16 +0300
Subject: [squid-users] Squid 5.6 and 5.9 keep crashing due to signal 6
 with status 0
In-Reply-To: <19f432a6b1ca0356882341ce62d5a676@data-core.org>
References: <662260091314b912460378340ce231a7@data-core.org>
 <72c1fbc2-f4a0-4e14-b8ea-430e4bc16ea9@measurement-factory.com>
 <19f432a6b1ca0356882341ce62d5a676@data-core.org>
Message-ID: <CADJd0Y1fbQupLqk36oWf5a5SnaYkELPmD7rZHqxyxEgfPGErJQ@mail.gmail.com>

Hello, Flashdown,

As you can see in your access.log, your client tried to connect not to a
DNS hostname but directly to IPv6 address:

1694674498.411      9 **CENSORED_internal_client_IP** TCP_DENIED/407

4129 CONNECT *[ff00::]:443* - HIER_NONE/- text/html
So, I suppose that your DNS configuration changes will not eliminate the
client requests to *[ff00::]:443*
But I believe that enabling IPv6 will prevent your squid crushes.

Kind regards,
     Ankor.

??, 19 ????. 2023??. ? 19:04, Flashdown <flashdown at data-core.org>:

> Thank you Alex for confirming this and all the hints given.
>
> I have taken another path to fix this. I have configured the dns
> forwarders that squid is configured to use, to not give out any AAAA
> responses. After that I have enabled IPv6 on this box to completly avoid
> this bug. Thank you!
>
> ---
> Best regards,
> Flashdown
>
> Am 2023-09-14 16:11, schrieb Alex Rousskov:
> > On 2023-09-14 07:02, Flashdown wrote:
> >
> >> Sep 14 08:55:06 vm-myproxy squid[79100]: Squid Parent: squid-2 process
> >> 80675 exited due to signal 6 with status 0
> >
> >> 1694674498.411      9 **CENSORED_internal_client_IP** TCP_DENIED/407
> >> 4129 CONNECT [ff00::]:443 - HIER_NONE/- text/html
> >
> >> IPv6 is disabled via sysctl config "net.ipv6.conf.all.disable_ipv6=1"
> >
> >
> > Your Squid is most likely suffering (among other v5 bugs) from Squid
> > Bug 5154: https://bugs.squid-cache.org/show_bug.cgi?id=5154
> >
> > To confirm, enable core dumps and look for a gdb backtrace sequence
> > similar to the one posted in the above bug report:
> >
> > * in __assert_fail
> > * in Ip::Address::getAddrInfo(addrinfo*&, int) const
> > * in comm_openex(int, int, Ip::Address&, int, char const*)
> >
> > The best known way to prevent bug 5154 is to enable IPv6 support. If
> > that is not feasible in your environment, then please keep reading.
> >
> >
> > Squid bug 5154 has an unofficial but, IMO, correct fix at PR 1421:
> > https://github.com/squid-cache/squid/pull/1421
> >
> > The above fix is not trivial and has side effects: For Squids that
> > cannot handle IPv6 (e.g., because IPv6 support was disabled at
> > ./configure time or is unavailable in the deployment environment), the
> > fix will, in part, reject requests with IPv6 addresses in URLs. This
> > rejection may negatively affect Squids that were "worked OK" by
> > forwarding such traffic to IPv4 ICAP servers and cache_peers (at
> > least).
> >
> > PR 1421 changes cannot be applied to Squid v5 "as is"; they have to be
> > backported. I do not have a backporting patch for virgin Squid v5.
> >
> >
> > HTH,
> >
> > Alex.
> >
> > _______________________________________________
> > squid-users mailing list
> > squid-users at lists.squid-cache.org
> > https://lists.squid-cache.org/listinfo/squid-users
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> https://lists.squid-cache.org/listinfo/squid-users
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230920/1f168aa0/attachment.htm>

From ngtech1ltd at gmail.com  Wed Sep 20 06:49:45 2023
From: ngtech1ltd at gmail.com (ngtech1ltd at gmail.com)
Date: Wed, 20 Sep 2023 09:49:45 +0300
Subject: [squid-users] Squid 6.3 RPMs Release
Message-ID: <!&!AAAAAAAAAAAYAAAAAAAAAG15AYh8TcJOh7jZfP/beGvCgAAAEAAAAMHbTLyAEmFCqhxe2A/Ni7YBAAAAAA==@gmail.com>

Hey List,

I have updated the squid-latest repo at:
https://github.com/elico/squid-latest

It's now parses the www.squid-cache.org sources page instead of using some ftp mirrors to get the latest version of squid.
This update is since the squid FTP mirrors I have used are no longer up-to-date since 5.9.

If you need to programmatically "know" the latest current version of squid-cache you can use the next json file:
https://raw.githubusercontent.com/elico/squid-latest/main/latest.json

The NgTech Squid-Cache repository base url is at:
https://www.ngtech.co.il/repo/

and not like mentioned in the wiki docs with the domain "ngtech.co.il".
(I will need to fix it later in the git and also maybe in couple other places)

And for all the SSL-BUMP users, there was a nice talk at Defcon 31:
DEF CON 31 - certmitm Automatic Exploitation of TLS Certificate Validation Vulns - Aapo Oksman

https://www.youtube.com/watch?v=w_l2q_Gyqfo

which I wanted to respond with couple words.

There is some wrong assumption that all data connections should be encrypted and there is a movement that tries to push the industry
to a place which requires vendors a very huge over head in their software maintenance and distribution chains.
There is plenty of data which should not be encrypted and is wrongfully encrypted both on the wires and also on different storage mechanisms.
I must state that I am not a security specialist but the world really hasn't changed for the last 5-6 k years.
There are many different ways to rob and do bad things to others and this is a fundamental and general flaw in education and morality.

if you have enough knowledge, power and couple other features and resources you would be able to forcefully access places you are not allowed into.

I believe that education will not improve most animals and predators and this is compared to me believing that a second chance should be 
granted however not to everyone.

My basic lesson from my teachers and parents is that you must act in specific directions in life if you want to get somewhere.
As much as it's nice to some degree to watch some of the Defcon "shows" I believe we first must understand that there are humans 
behind some mistakes and we should respect them before talking wrongfully about them.

To some degree obscurity is not a replacement for security however when you learn a bit from humanity past about theft
and other forms of crime you should be able to learn to respect the weaknesses of other humans.

To the memory of my late brother Yonatan, I have worked on a public digital edition of a book named:
"Vaccination Register For the Purity of The Hebrew Language"
Or in Hebrew:
???? ??????? ????? ?????? ???????

It's a Hebrew written book and I doubt that any translation would be good enough to pass the content of the book.
I even doubt that reading the book in Hebrew would be enough to pass most of the content.

This is a link to the book digital edition which also has an audio recording of each part in it:
https://www.ngtech.co.il/%D7%A4%D7%A0%D7%A7%D7%A1-%D7%97%D7%99%D7%A1%D7%95%D7%A0%D7%99%D7%9D/

I know that some would ask: What is the relationship to the Squid-Cache project and this book?

I would like to say that the Squid-Cache Users list which I am a member for many years is one of the unique mailing lists around the world. 
Many security companies and IT experts are actively blocking the Squid-Cache domains and files since it's considered a "bad software".

However, over the years I have learned so many things from the Squid-Cache project and all of it's resources, users and developers and I would like
to add a specific unique addition to this mailing list at this time.

In these time of the year in the Hebrew religious we are standing between two days:
Rosh Hashana, the day that the year starts and the yearly court day of god.
And 
Yom Kipur, the day which God forgive us on anything we might have done and is not between us and other humans.

In these days every year I am asking myself a very tough question:
Was I OK this year? Maybe I did something wrong to others?

And this is where I would like to say thanks for the Squid-Cache Users list and to also ask for forgiveness.
Not because I know I did something wrong but the opposite, I don't know whether I did something to others so I must first ask for one.

The: Event, Meaning, Emotion, Reaction model in psychology which is used in CBT(Cognitive behavioral therapy) gives some insights when looking
into some events in our life and I would like to just say that a simple "Yours" in the of an Email can change the whole meaning of the written words.

My late father tough me, and I must quote him: "If you see someone that you love and he has something in his beard, tell him about it."
(Sometimes with the addition that a father of a friend told me to say so clears out the doubts about the sentence)

So, Thanks for everyone in the Squid-Cache project and with hope for a very blessed and happy new year.

Yours,
Eliezer Croitoru



From linfengfeiye at qq.com  Wed Sep 20 08:17:33 2023
From: linfengfeiye at qq.com (=?gb18030?B?bGluZmVuZ2ZlaXll?=)
Date: Wed, 20 Sep 2023 16:17:33 +0800
Subject: [squid-users] ssl-bump peek and select pinned destination failed
Message-ID: <tencent_B25E502EC2B53C92B0D7582BFB0F2327DD08@qq.com>

Hi, what does "PeerSelector186 found pinned, destination" that appears in the Squid log mean?


The log is as follows?
####################################
2023/09/20 15:49:57.086 kid1| 28,3| Checklist.cc(62) markFinished: 0x30798c8 answer ALLOWED for match
2023/09/20 15:49:57.086 kid1| 28,3| Checklist.cc(162) checkCallback: ACLChecklist::checkCallback: 0x30798c8 answer=ALLOWED
2023/09/20 15:49:57.086 kid1| 44,3| peer_select.cc(373) checkAlwaysDirectDone: ALLOWED
2023/09/20 15:49:57.086 kid1| 44,3| peer_select.cc(379) checkAlwaysDirectDone: direct = DIRECT_YES (always_direct allow)
2023/09/20 15:49:57.086 kid1| 44,7| peer_select.cc(1153) interestedInitiator: PeerSelector186
2023/09/20 15:49:57.086 kid1| 44,3| peer_select.cc(612) selectMore: GET my.local.web
2023/09/20 15:49:57.086 kid1| 44,3| peer_select.cc(1102) addSelection: adding PINNED#my.local.web
2023/09/20 15:49:57.086 kid1| 44,3| peer_select.cc(1102) addSelection: adding HIER_DIRECT#my.local.web
2023/09/20 15:49:57.086 kid1| 44,7| peer_select.cc(1153) interestedInitiator: PeerSelector186
2023/09/20 15:49:57.086 kid1| 24,7| SBuf.cc(202) append: from c-string to id SBuf79918
2023/09/20 15:49:57.086 kid1| 24,7| SBuf.cc(160) rawSpace: reserving 71 for SBuf79918
2023/09/20 15:49:57.086 kid1| 24,7| SBuf.cc(859) reAlloc: SBuf79918 new store capacity: 128
2023/09/20 15:49:57.086 kid1| 44,2| peer_select.cc(1176) handlePath: PeerSelector186 found pinned, destination #1 for https://my.local.web

#########################################################################################


The destination address https://my.local.web in this log is returned by URL-Rewrite, rewrite-url=https://my.local.web, which is a local web service of mine.But it failed directly after peer_select. I think this should be related to ssl-bump. My decryption configuration is roughly as follows.


The strange thing is that as long as I comment these two lines,


#acl step1 at_step SslBump1
#ssl_bump peek step1 all


&nbsp;the pinned destination disappears and the access is successful,why?


I think this might be a squid bug?





##follows is ssl-bump config################


http_port 3126 intercept
https_port 3129 intercept ssl-bump generate-host-certificates=on options=NO_SSLv3 tls-min-version=1.2 dynamic_cert_mem_cache_size=4MB tls-cert=/os/usr/local/proxy/etc/cert.pem

http_port 3128 ssl-bump generate-host-certificates=on options=NO_SSLv3 tls-min-version=1.2 dynamic_cert_mem_cache_size=4MB tls-cert=/usr/local/proxy/etc/cert.pem
acl step1 at_step SslBump1
sslcrtd_program /os/usr/local/proxy/libexec/security_file_certgen -s /usr/local/proxy/var/lib/ssl_db -M 4MB
sslcrtd_children 5
ssl_bump peek step1 all
ssl_bump splice white_list
ssl_bump bump bump_domain
ssl_bump bump all
http_access allow all
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230920/1179f098/attachment.htm>

From rousskov at measurement-factory.com  Wed Sep 20 16:57:13 2023
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Wed, 20 Sep 2023 12:57:13 -0400
Subject: [squid-users] ssl-bump peek and select pinned destination failed
In-Reply-To: <tencent_B25E502EC2B53C92B0D7582BFB0F2327DD08@qq.com>
References: <tencent_B25E502EC2B53C92B0D7582BFB0F2327DD08@qq.com>
Message-ID: <d8b578c9-f35c-4d92-9ebe-499ee988258c@measurement-factory.com>

On 2023-09-20 04:17, linfengfeiye wrote:
> Hi, what does "PeerSelector186 found pinned, destination" that appears 
> in the Squid log mean?

Please note that Squid debugging logs (cache.log at level 3 and above) 
are for developer use. This mailing list is not. In triage, I recommend 
focusing on access.log, non-debugging cache.log, and other admin-focused 
resources while leaving debug log analysis to Squid developers.


Roughly speaking, the logging message you are asking about means that 
Squid code tasked with selecting where to forward the request found a 
previously opened Squid-to-server connection that was assigned (i.e., 
"pinned") to the client-to-Squid connection on which that request was 
received. In most cases, that connection will be used for that request.

In SslBump context, a Squid-to-server TCP connection gets pinned to the 
corresponding client-to-Squid TCP connection because that 
Squid-to-server TLS connection uses TLS settings specific to that client 
and vice versa. Pinning minimizes surprises/changes for TLS clients that 
are not expected to be bumped. It also creates various problems.


> The destination address https://my.local.web in this log is returned by 
> URL-Rewrite, rewrite-url=https://my.local.web, which is a local web 
> service of mine.But it failed directly after peer_select. I think this 
> should be related to ssl-bump.

AFAICT, without significant Squid code adjustments, one cannot rewrite 
destinations of bumped requests because rewritten requests will still be 
assigned the old pinned Squid-to-server connections despite request 
destination changes.


> My decryption configuration is roughly as 
> follows.
> 
> The strange thing is that as long as I comment these two lines,
> 
> #acl step1 at_step SslBump1
> #ssl_bump peek step1 all
> 
>  ?the pinned destination disappears and the access is successful,why?

Roughly speaking, without SslBump (and certain other special cases), 
there is no need to pin connections and there is no URL rewriting (for 
encrypted requests).


HTH,

Alex.



> ##follows is ssl-bump config################
> 
> http_port 3126 intercept
> https_port 3129 intercept ssl-bump generate-host-certificates=on 
> options=NO_SSLv3 tls-min-version=1.2 dynamic_cert_mem_cache_size=4MB 
> tls-cert=/os/usr/local/proxy/etc/cert.pem
> http_port 3128 ssl-bump generate-host-certificates=on options=NO_SSLv3 
> tls-min-version=1.2 dynamic_cert_mem_cache_size=4MB 
> tls-cert=/usr/local/proxy/etc/cert.pem
> acl step1 at_step SslBump1
> sslcrtd_program /os/usr/local/proxy/libexec/security_file_certgen -s 
> /usr/local/proxy/var/lib/ssl_db -M 4MB
> sslcrtd_children 5
> ssl_bump peek step1 all
> ssl_bump splice white_list
> ssl_bump bump bump_domain
> ssl_bump bump all
> http_access allow all
> 
> 
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> https://lists.squid-cache.org/listinfo/squid-users



From bud_miljkovic at trimble.com  Thu Sep 21 03:22:56 2023
From: bud_miljkovic at trimble.com (Bud Miljkovic)
Date: Thu, 21 Sep 2023 15:22:56 +1200
Subject: [squid-users] Rebuilding Squid 3.5.25 with the `--with-openssl`
 option generates compilation error
Message-ID: <CAPO8noLtk3qaV4Gqi5e3R16mp5S1K_XQqLm7ug3roSEn2Qn0=Q@mail.gmail.com>

Hello there,

Using the *Squid 3.5.25* version from the Open Embedded *pyro* repository,
I enabled the `*--with-openssl*` build option by adding the
*squid_%.bbappend* file, please the attachment below.

Then using *docker*, I tried to rebuild *squid* package but now I get the
following compilation error - please see the *squid_rebuild.log* file below.

Could someone provide some clues about what the problem is?

Regards,
Buda

-- 
Budimir Miljkovi? BSc E | He
Senior Development Engineer
Civil Construction Field Systems
Trimble

11-17 Birmingham Drive, Christchurch, Canterbury, 8024
New Zealand
+64 3 963-5550 Direct
+64 21 419-024 Mobile

www.trimble.com

This email may contain confidential information that is intended only for
the listed recipient(s) of this email. Any unauthorized review, use,
disclosure or distribution is prohibited. If you believe you have received
this email in error, please immediately delete this email and any
attachments, and inform me via reply email.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230921/4cf92a6f/attachment.htm>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: squid_%.bbappend
Type: application/octet-stream
Size: 168 bytes
Desc: not available
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230921/4cf92a6f/attachment.obj>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: squid_rebuild.log
Type: text/x-log
Size: 29774 bytes
Desc: not available
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230921/4cf92a6f/attachment.bin>

From uhlar at fantomas.sk  Thu Sep 21 13:15:32 2023
From: uhlar at fantomas.sk (Matus UHLAR - fantomas)
Date: Thu, 21 Sep 2023 15:15:32 +0200
Subject: [squid-users] access_log UDP format
Message-ID: <ZQxB9HtMevzG8V37@fantomas.sk>

Hello,

I'm curious if the udp:// logging is syslog-compatible.

Do I just need to congigure proper logformat?

Does anyone have experience with this?

Thanks
-- 
Matus UHLAR - fantomas, uhlar at fantomas.sk ; http://www.fantomas.sk/
Warning: I wish NOT to receive e-mail advertising to this address.
Varovanie: na tuto adresu chcem NEDOSTAVAT akukolvek reklamnu postu.
Boost your system's speed by 500% - DEL C:\WINDOWS$\*.*


From rousskov at measurement-factory.com  Thu Sep 21 18:22:10 2023
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Thu, 21 Sep 2023 14:22:10 -0400
Subject: [squid-users] Rebuilding Squid 3.5.25 with the `--with-openssl`
 option generates compilation error
In-Reply-To: <CAPO8noLtk3qaV4Gqi5e3R16mp5S1K_XQqLm7ug3roSEn2Qn0=Q@mail.gmail.com>
References: <CAPO8noLtk3qaV4Gqi5e3R16mp5S1K_XQqLm7ug3roSEn2Qn0=Q@mail.gmail.com>
Message-ID: <027b2665-8119-4a9e-8315-4e07a9ea9f63@measurement-factory.com>

On 2023-09-20 23:22, Bud Miljkovic wrote:

> Using the *Squid 3.5.25* version from the Open Embedded *pyro* 
> repository, I enabled the `*--with-openssl*` build option by adding the 
> *squid_%.bbappend* file, please the attachment below.
> 
> Then using *docker*, I tried to rebuild *squid* package but now I get 
> the following compilation error - please see the *squid_rebuild.log* 
> file below.

> squid-3.5.25/src/ssl/gadgets.h:229:7: error: 'Ssl::CertificateProperties' declared with greater visibility than the type of its field 'Ssl::CertificateProperties::mimicCert' [-Werror=attributes]


FWIW, I have not seen -Wattributes warnings before and cannot quickly 
figure out what they really mean in your context. There is nothing 
particularly alarming in that Squid code AFAICT.

If you have to use unsupported and buggy Squid v3, consider building it 
with --disable-strict-error-checking. Otherwise, consider switching to 
Squid v6 that more folks may be interested in helping you with.


HTH,

Alex.



From hack3rcon at yahoo.com  Thu Sep 21 18:59:26 2023
From: hack3rcon at yahoo.com (Jason Long)
Date: Thu, 21 Sep 2023 18:59:26 +0000 (UTC)
Subject: [squid-users] A few things about Squid-cache
References: <1079445466.2710439.1695322766273.ref@mail.yahoo.com>
Message-ID: <1079445466.2710439.1695322766273@mail.yahoo.com>

Hello,I have some questions:1- What tips should be considered to keep Squid-cache safe?

2-?How strong is Squid-cache? How many users can use it at the same time?
3-?Can Squid-cache?also play the role of a firewall? Something like the Microsoft ForeFront TMG Replacement or the Kemp LoadMaster.

Thank you.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230921/f795f845/attachment.htm>

From gkinkie at gmail.com  Fri Sep 22 20:56:03 2023
From: gkinkie at gmail.com (Francesco Chemolli)
Date: Fri, 22 Sep 2023 21:56:03 +0100
Subject: [squid-users] A few things about Squid-cache
In-Reply-To: <1079445466.2710439.1695322766273@mail.yahoo.com>
References: <1079445466.2710439.1695322766273.ref@mail.yahoo.com>
 <1079445466.2710439.1695322766273@mail.yahoo.com>
Message-ID: <CA+Y8hcPXqVzdK1rBQnzwJOAxhbFkJO2xweKMTUhmf4yg6Agsng@mail.gmail.com>

Hi Jason!

Squid is a complex piece of software, which is deployed in a vast number of
scenarios, some are simpler and some are intensely adversarial and trickier.
Securing squid is similar to any other public-facing complex service; it's
unfortunately not something that can be explained with a few tips.

Regarding how many users Squid can support at the same time, it really
depends, mostly on the hardware, services configuration, and user
behaviour. On modern hardware, Squid can generally support many users, in
the order of several thousands

Squid is not a firewall, on most modern Unix-like operating systems,
including Linux, FreeBSD, and OpenBSD, that role can be fulfilled by the
underlying operating system

On Thu, Sep 21, 2023 at 7:59?PM Jason Long <hack3rcon at yahoo.com> wrote:

> Hello,
> I have some questions:
> 1- What tips should be considered to keep Squid-cache safe?
>
> 2- How strong is Squid-cache? How many users can use it at the same time?
>
> 3- Can Squid-cache also play the role of a firewall? Something like the
> Microsoft ForeFront TMG Replacement or the Kemp LoadMaster.
>
>
> Thank you.
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> https://lists.squid-cache.org/listinfo/squid-users
>


-- 
    Francesco
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230922/c7e170d0/attachment.htm>

From linfengfeiye at qq.com  Sat Sep 23 00:18:24 2023
From: linfengfeiye at qq.com (=?gb18030?B?bGluZmVuZ2ZlaXll?=)
Date: Sat, 23 Sep 2023 08:18:24 +0800
Subject: [squid-users] =?gb18030?b?u9i4tKO6ICBzc2wtYnVtcCBwZWVrIGFuZCBz?=
 =?gb18030?q?elect_pinned_destination_failed?=
In-Reply-To: <d8b578c9-f35c-4d92-9ebe-499ee988258c@measurement-factory.com>
References: <tencent_B25E502EC2B53C92B0D7582BFB0F2327DD08@qq.com>
 <d8b578c9-f35c-4d92-9ebe-499ee988258c@measurement-factory.com>
Message-ID: <tencent_D892FBBA7DC5E3A1FFE4C02BD725AE164505@qq.com>

Thank you for your detailed answer.  As you said, Squid does not support rewrite-url after ssl-bumped. but I don't understand why it is designed this way. If I want to modify the ssl-bumped returned content, not through 302,307 http redirect url?  can I use ecap or other methods to achieve it?



------------------&nbsp;????&nbsp;------------------
???: "Alex Rousskov"<rousskov at measurement-factory.com&gt;; 
????: 2023?9?21?(???) ??0:57
???: "squid-users"<squid-users at lists.squid-cache.org&gt;; 
??: Re: [squid-users] ssl-bump peek and select pinned destination failed



On 2023-09-20 04:17, linfengfeiye wrote:
&gt; Hi, what does "PeerSelector186 found pinned, destination" that appears 
&gt; in the Squid log mean?

Please note that Squid debugging logs (cache.log at level 3 and above) 
are for developer use. This mailing list is not. In triage, I recommend 
focusing on access.log, non-debugging cache.log, and other admin-focused 
resources while leaving debug log analysis to Squid developers.


Roughly speaking, the logging message you are asking about means that 
Squid code tasked with selecting where to forward the request found a 
previously opened Squid-to-server connection that was assigned (i.e., 
"pinned") to the client-to-Squid connection on which that request was 
received. In most cases, that connection will be used for that request.

In SslBump context, a Squid-to-server TCP connection gets pinned to the 
corresponding client-to-Squid TCP connection because that 
Squid-to-server TLS connection uses TLS settings specific to that client 
and vice versa. Pinning minimizes surprises/changes for TLS clients that 
are not expected to be bumped. It also creates various problems.


&gt; The destination address https://my.local.web in this log is returned by 
&gt; URL-Rewrite, rewrite-url=https://my.local.web, which is a local web 
&gt; service of mine.But it failed directly after peer_select. I think this 
&gt; should be related to ssl-bump.

AFAICT, without significant Squid code adjustments, one cannot rewrite 
destinations of bumped requests because rewritten requests will still be 
assigned the old pinned Squid-to-server connections despite request 
destination changes.


&gt; My decryption configuration is roughly as 
&gt; follows.
&gt; 
&gt; The strange thing is that as long as I comment these two lines,
&gt; 
&gt; #acl step1 at_step SslBump1
&gt; #ssl_bump peek step1 all
&gt; 
&gt;&nbsp; &nbsp;the pinned destination disappears and the access is successful,why?

Roughly speaking, without SslBump (and certain other special cases), 
there is no need to pin connections and there is no URL rewriting (for 
encrypted requests).


HTH,

Alex.



&gt; ##follows is ssl-bump config################
&gt; 
&gt; http_port 3126 intercept
&gt; https_port 3129 intercept ssl-bump generate-host-certificates=on 
&gt; options=NO_SSLv3 tls-min-version=1.2 dynamic_cert_mem_cache_size=4MB 
&gt; tls-cert=/os/usr/local/proxy/etc/cert.pem
&gt; http_port 3128 ssl-bump generate-host-certificates=on options=NO_SSLv3 
&gt; tls-min-version=1.2 dynamic_cert_mem_cache_size=4MB 
&gt; tls-cert=/usr/local/proxy/etc/cert.pem
&gt; acl step1 at_step SslBump1
&gt; sslcrtd_program /os/usr/local/proxy/libexec/security_file_certgen -s 
&gt; /usr/local/proxy/var/lib/ssl_db -M 4MB
&gt; sslcrtd_children 5
&gt; ssl_bump peek step1 all
&gt; ssl_bump splice white_list
&gt; ssl_bump bump bump_domain
&gt; ssl_bump bump all
&gt; http_access allow all
&gt; 
&gt; 
&gt; _______________________________________________
&gt; squid-users mailing list
&gt; squid-users at lists.squid-cache.org
&gt; https://lists.squid-cache.org/listinfo/squid-users

_______________________________________________
squid-users mailing list
squid-users at lists.squid-cache.org
https://lists.squid-cache.org/listinfo/squid-users
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230923/c5544a90/attachment.htm>

From hack3rcon at yahoo.com  Sun Sep 24 18:49:06 2023
From: hack3rcon at yahoo.com (Jason Long)
Date: Sun, 24 Sep 2023 18:49:06 +0000 (UTC)
Subject: [squid-users] A few things about Squid-cache
In-Reply-To: <CA+Y8hcPXqVzdK1rBQnzwJOAxhbFkJO2xweKMTUhmf4yg6Agsng@mail.gmail.com>
References: <1079445466.2710439.1695322766273.ref@mail.yahoo.com>
 <1079445466.2710439.1695322766273@mail.yahoo.com>
 <CA+Y8hcPXqVzdK1rBQnzwJOAxhbFkJO2xweKMTUhmf4yg6Agsng@mail.gmail.com>
Message-ID: <575071616.3138479.1695581346718@mail.yahoo.com>

Hello,Thank you so much for your reply.1- Regarding security, what parameters should be changed or added in the configuration file?

 2- How to configure Squid-cache?service for 1000 clients?


 
  On Sat, Sep 23, 2023 at 12:26 AM, Francesco Chemolli<gkinkie at gmail.com> wrote:   Hi Jason!
Squid is a complex piece of software, which is deployed in a vast number of scenarios, some are simpler and some are intensely adversarial and trickier.Securing squid is similar to any other public-facing complex service; it's unfortunately not something?that can be explained with a few tips.
Regarding how many users Squid can support at the same time, it really depends, mostly on the hardware, services configuration, and user behaviour. On modern hardware, Squid can generally support many users, in the order of several thousands
Squid is not a firewall, on most modern Unix-like operating systems, including Linux, FreeBSD, and OpenBSD, that role can be fulfilled by the underlying operating system
On Thu, Sep 21, 2023 at 7:59?PM Jason Long <hack3rcon at yahoo.com> wrote:

Hello,I have some questions:1- What tips should be considered to keep Squid-cache safe?

2-?How strong is Squid-cache? How many users can use it at the same time?
3-?Can Squid-cache?also play the role of a firewall? Something like the Microsoft ForeFront TMG Replacement or the Kemp LoadMaster.

Thank you._______________________________________________
squid-users mailing list
squid-users at lists.squid-cache.org
https://lists.squid-cache.org/listinfo/squid-users



-- 
? ? Francesco  
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230924/2ef15d28/attachment.htm>

From squid3 at treenet.co.nz  Mon Sep 25 04:51:45 2023
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Mon, 25 Sep 2023 17:51:45 +1300
Subject: [squid-users] A few things about Squid-cache
In-Reply-To: <575071616.3138479.1695581346718@mail.yahoo.com>
References: <1079445466.2710439.1695322766273.ref@mail.yahoo.com>
 <1079445466.2710439.1695322766273@mail.yahoo.com>
 <CA+Y8hcPXqVzdK1rBQnzwJOAxhbFkJO2xweKMTUhmf4yg6Agsng@mail.gmail.com>
 <575071616.3138479.1695581346718@mail.yahoo.com>
Message-ID: <8ffe5581-d731-4f43-be7f-72c00e5a7a9e@treenet.co.nz>

On 25/09/23 07:49, Jason Long wrote:
> Hello,
> Thank you so much for your reply.
> 1- Regarding security, what parameters should be changed or added in the 
> configuration file?
> 

First steps with a new Squid install are to check in squid.conf for the 
"acl localnet" lines and adjust so it lists your LAN ranges. The common 
ones are listed there by default.

Then look for the "http_access" directive. That is the primary means of 
telling Squid what the network policy needs are.


> 2- How to configure Squid-cache?service for 1000 clients?
> 

Apart from the above (1) answer, Squid does not care about number of 
clients it will serve as many as your machine can handle. Until the 
hardware overloads the CPU, RAM or disks capacity limits.


For good advise we will need details...

  Forward or Reverse proxy installation?
  LAN or WAN clients?

  What policies do you need to comply with regarding client use of the 
proxy, or access to any special websites?


Cheers
Amos


From nikhildeshpande18 at gmail.com  Mon Sep 25 09:31:05 2023
From: nikhildeshpande18 at gmail.com (nikhil deshpande)
Date: Mon, 25 Sep 2023 15:01:05 +0530
Subject: [squid-users] Seeking Help with SSL Bump Configuration for
 ECDSA Ciphers in Squid
In-Reply-To: <CAOh+pGTUY0c8vVRa=OfQ0v812gc=yNVcBxyE-J6CUEw-aTT-xA@mail.gmail.com>
References: <CAOh+pGTUY0c8vVRa=OfQ0v812gc=yNVcBxyE-J6CUEw-aTT-xA@mail.gmail.com>
Message-ID: <CALO-o=xTe18tuGww-gsr-vAVKMJqRai1ZvNR-hRqaToWXp1NGQ@mail.gmail.com>

Hi team,

Any update on this?

Regards,
Nikhil

On Thu, Sep 14, 2023 at 6:05?PM Shyam varun <shyam3898 at gmail.com> wrote:

> Dear Squid Mailing List Community,
>
> I hope this email finds you well. I am currently working on configuring
> SSL bump in Squid proxy server to support ECDSA ciphers, and I am seeking
> assistance with a particular issue I've encountered.
>
> To provide some context:
>
> - *Squid Version:* Squid 5.2
> - *OpenSSL Version*: OpenSSL 1.1.1l
> - *OS:* Alpine Linux v3.16
> -
> *Squid Configuration: *
>
> * sslproxy_cert_error allow all*
>
> * sslcrtd_program /usr/lib/squid/security_file_certgen -s /var/lib/ssl_db
> -M 4MB*
>
>
> * http_port 3129 ssl-bump generate-host-certificates=on
> dynamic_cert_mem_cache_size=4MB cert=/opt/ssl/intermediate_certificate.pem
> key=/opt/ssl/intermediate_key.pem options=SINGLE_DH_USE,SINGLE_ECDH_USE
> tls-dh=/opt/dhparam.pem*
>
>
> * tls_outgoing_options min-version=1.1  options=NO_SSLv3*
>
>
> * acl step1 at_step SslBump1*
>
> * ssl_bump peek step1*
>
> * ssl_bump bump all*
>
>
> The goal of my configuration is to enable SSL bump for ECDSA ciphers,
> specifically the "ECDHE-ECDSA-AES256-GCM-SHA384" and
> "ECDHE-ECDSA-AES128-GCM-SHA256" cipher suites. However, I've run into
> challenges and issues while trying to achieve this.
>
> *Things I tried:*
>
>    1. I created an ECDSA-based certificate chain using OpenSSL.
>    2. I configured the ECDSA-based certificate certs in squid as shown in
>    above snippet but still not able to make it work.
>
>
> I've thoroughly reviewed the Squid documentation and online resources, but
> I haven't been able to resolve these issues on my own.
>
> I would greatly appreciate any guidance, insights, or assistance from the
> Squid community regarding the proper configuration for SSL bump with ECDSA
> ciphers. If you have successfully configured Squid to support ECDSA ciphers
> or if you have expertise in this area, your input would be invaluable.
>
> Thank you in advance for your time and support. I look forward to your
> responses and insights.
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230925/9e18cf96/attachment.htm>

From denis.roy at gmail.com  Mon Sep 25 16:35:36 2023
From: denis.roy at gmail.com (Denis Roy)
Date: Mon, 25 Sep 2023 12:35:36 -0400
Subject: [squid-users] Transparent deployment VS web services behind DNS
 load balancing
Message-ID: <CAEw7rkzDoT3kp60fT3pfvYhV-LxRJGNoJ10SeHim66KmqZWsYQ@mail.gmail.com>

My installation is fairly simple: I run Squid 5.8 in transparent mode, on a
pF based firewall (FreeBDS 14.0) .

I intercept both HTTP 80, and HTTPS 443. Splicing the exceptions I have in
a whitelist, bumping everything else. Simple.

This is a relatively recent deployment, and it has been working well as far
as web browser experience is concerned. Nonetheless, I have observed a
certain amount of 409s sharing similarities (more on that later). Rest
assured, I have made 100% certain my clients and Squid use the same
resolver (Unbound), installed on the same box with a fairly basic
configuration.

When I observe the 409s I am getting, they all share the same similarities:
the original client request was from an application or OS related task,
 using  DNS records with very low TTL. 5 minutes or less, often 2 minutes.
I could easily identify the vast majority of these domains as being load
balanced with DNS solutions like Azure Traffic Manager, and Akamai DNS.

Now, this make sense: a thread on the client may essentially intiate a long
running task that will last a couple of minutes (more than the TTL), during
which it may actually establish a few connections without calling the
gethostbyname function, resulting in squid detecting a forgery attempt
since it will be unable to validate the dst IP match the intended
destination domain. Essentially, creating "false positives'', and dropping
legitimate traffic.

I have searched a lot, and the only reliable way to completely solve this
issue in a transparent deployment has been to implement a number of IP
lists for such services (Azure Cloud, Azure Front Door, AWS, Akamai and
such), bypassing squid completely based on the destination IP address.

I'd be interested to hear what other approaches there might be. Some
package maintainers have chosen to drop the header check altogether (
https://github.com/NethServer/dev/issues/5348 ).  I believe a better
approach could be to just validate that the SNI of the TLS Client Hello
match the certificate obtained from the remote web server, perform the
usual certificate validation (is it trusted, valid, etc), and not rely so
much on the DNS check which can be expected to fail at times given how DNS
load balancing is ubiquitous with native cloud solutions and large CDNs.
But implementing this change would require serious development, which I am
completely unable to take care of.

Hence, what others have been doing? I want my web security gateway to
remain transparent, and not implement PAC files.

Thank you.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230925/91deb407/attachment.htm>

From rousskov at measurement-factory.com  Mon Sep 25 18:30:01 2023
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Mon, 25 Sep 2023 14:30:01 -0400
Subject: [squid-users] Seeking Help with SSL Bump Configuration for
 ECDSA Ciphers in Squid
In-Reply-To: <CALO-o=xTe18tuGww-gsr-vAVKMJqRai1ZvNR-hRqaToWXp1NGQ@mail.gmail.com>
References: <CAOh+pGTUY0c8vVRa=OfQ0v812gc=yNVcBxyE-J6CUEw-aTT-xA@mail.gmail.com>
 <CALO-o=xTe18tuGww-gsr-vAVKMJqRai1ZvNR-hRqaToWXp1NGQ@mail.gmail.com>
Message-ID: <26ab01c2-39b5-430a-a199-3186008024d4@measurement-factory.com>

On 2023-09-25 05:31, nikhil deshpande wrote:

> Any update on this?

This is not really an "update" because this mailing list has not 
received or has not posted the original email quoted below:
https://lists.squid-cache.org/pipermail/squid-users/2023-September/thread.html


> On Thu, Sep 14, 2023 at 6:05?PM Shyam varun <shyam3898 at gmail.com 
> <mailto:shyam3898 at gmail.com>> wrote:
> 
>     Dear Squid Mailing List Community,
> 
>     I hope this email finds you well. I am currently working on
>     configuring SSL bump in Squid proxy server to support ECDSA ciphers,
>     and I am seeking assistance with a particular issue I've encountered.
> 
>     To provide some context:
> 
>     - *Squid Version:* Squid 5.2

Please note that Squid v5 is not officially supported by the Squid 
Project. Please consider upgrading to Squid v6.


>     - *OpenSSL Version*: OpenSSL 1.1.1l
>     - *OS:* Alpine Linux v3.16
>     - *_Squid Configuration: _
>     *
> 
>             */sslproxy_cert_error allow all/*
> 
>             */sslcrtd_program /usr/lib/squid/security_file_certgen -s
>             /var/lib/ssl_db -M 4MB/*
> 
>     */
>     /*
> 
>             */http_port 3129 ssl-bump generate-host-certificates=on
>             dynamic_cert_mem_cache_size=4MB
>             cert=/opt/ssl/intermediate_certificate.pem
>             key=/opt/ssl/intermediate_key.pem
>             options=SINGLE_DH_USE,SINGLE_ECDH_USE tls-dh=/opt/dhparam.pem/*
> 
>     */
>     /*
> 
>             */tls_outgoing_options min-version=1.1 ?options=NO_SSLv3/*
> 
>     */
>     /*
> 
>             */acl step1 at_step SslBump1/*
> 
>             */ssl_bump peek step1/*
> 
>             */ssl_bump bump all/*
> 
> 
>     The goal of my configuration is to enable SSL bump for ECDSA
>     ciphers, specifically the "ECDHE-ECDSA-AES256-GCM-SHA384" and
>     "ECDHE-ECDSA-AES128-GCM-SHA256" cipher suites. However, I've run
>     into challenges and issues while trying to achieve this.

Are you trying to bump TLS client connections when and only when the TLS 
client is offering to use one of those ciphers in its ClientHello 
message? Or do you want Squid to use one of those ciphers when bumping 
all TLS client connections? Or something else? Please clarify.

If Squid logs ERRORs or WARNINGs to cache.log at startup, especially 
messages that are seemingly related to TLS and http_port configuration, 
please share them.


FWIW, to restrict Squid use of ciphers on accepted TLS client 
connections, use the http_port (or https_port) "cipher" option. For 
example,

     https_port 3129 ssl-bump ... \
         cipher=DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384

If you tried that, and it did not work, please detail what did not work. 
Providing a pointer to raw TLS ClientHello/ServerHello messages (in 
libpcap format that Wireshark can grok) exchanged by the TLS client and 
Squid may be helpful. These packets should show ciphers offered by TLS 
client and ciphers offered by Squid.

Providing a pointer to compressed Squid cache.log with debug_options set 
to ALL,9 collected while reproducing the issue using a dedicated 
transaction may also help: 
https://wiki.squid-cache.org/SquidFaq/BugReporting#debugging-a-single-transaction


Thank you,

Alex.



>     *Things I tried:*
> 
>      1. I created an ECDSA-based certificate chain using OpenSSL.
>      2. I configured the ECDSA-based certificate certs in squid as shown
>         in above snippet but still not able to make it work.
> 
> 
>     I've thoroughly reviewed the Squid documentation and online
>     resources, but I haven't been able to resolve these issues on my own.
> 
>     I would greatly appreciate any guidance, insights, or assistance
>     from the Squid community regarding the proper configuration for SSL
>     bump with ECDSA ciphers. If you have successfully configured Squid
>     to support ECDSA ciphers or if you have expertise in this area, your
>     input would be invaluable.
> 
>     Thank you in advance for your time and support. I look forward to
>     your responses and insights.
> 
> 
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> https://lists.squid-cache.org/listinfo/squid-users



From squid3 at treenet.co.nz  Mon Sep 25 23:20:54 2023
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Tue, 26 Sep 2023 12:20:54 +1300
Subject: [squid-users] access_log UDP format
In-Reply-To: <ZQxB9HtMevzG8V37@fantomas.sk>
References: <ZQxB9HtMevzG8V37@fantomas.sk>
Message-ID: <1e7fbb94-980e-4142-a635-aaa5f01861a6@treenet.co.nz>

On 22/09/23 01:15, Matus UHLAR - fantomas wrote:
> Hello,
> 
> I'm curious if the udp:// logging is syslog-compatible.
> 
> Do I just need to congigure proper logformat?
> 

The Squid "udp" logging module sends your log lines as opaque UDP packet 
payload to the named UDP server:port.

The Squid "syslog" logging module frames that data into the binary 
syslog protocol.


HTH
Amos


From uhlar at fantomas.sk  Tue Sep 26 11:39:39 2023
From: uhlar at fantomas.sk (Matus UHLAR - fantomas)
Date: Tue, 26 Sep 2023 13:39:39 +0200
Subject: [squid-users] bug 4906 issue
Message-ID: <ZRLC+7lLL6G+xl0P@fantomas.sk>

Hello,

I have just encountered bug 4906 with squid-4.13 (Debian 11)

I could upgrade system fo Debian 12 with squid-5.7 but this issue doesn't 
seem to be resolved in it, at least:
http://www.squid-cache.org/Versions/v5/changesets/

does not mention that.

....when we're at it, seems that release notes for 5.9 have invalid links:
http://www.squid-cache.org/Versions/v5/squid-5.9-RELEASENOTES.html#ss1.2


Can anyone confirm if this problem persists?


I could try to test patch provided in that bugreport:
https://patch-diff.githubusercontent.com/raw/measurement-factory/squid/pull/20.patch
...but I find trying such complicated patch too risky.


I would like to avoid the "has request" ACL to ba able to see problems that 
come from other hosts than the load balancer.
  

-- 
Matus UHLAR - fantomas, uhlar at fantomas.sk ; http://www.fantomas.sk/
Warning: I wish NOT to receive e-mail advertising to this address.
Varovanie: na tuto adresu chcem NEDOSTAVAT akukolvek reklamnu postu.
Christian Science Programming: "Let God Debug It!".


From uhlar at fantomas.sk  Tue Sep 26 11:46:02 2023
From: uhlar at fantomas.sk (Matus UHLAR - fantomas)
Date: Tue, 26 Sep 2023 13:46:02 +0200
Subject: [squid-users] access_log UDP format
In-Reply-To: <1e7fbb94-980e-4142-a635-aaa5f01861a6@treenet.co.nz>
References: <ZQxB9HtMevzG8V37@fantomas.sk>
 <1e7fbb94-980e-4142-a635-aaa5f01861a6@treenet.co.nz>
Message-ID: <ZRLEeqP6+/fZNWuZ@fantomas.sk>

>On 22/09/23 01:15, Matus UHLAR - fantomas wrote:
>>I'm curious if the udp:// logging is syslog-compatible.
>>
>>Do I just need to congigure proper logformat?

On 26.09.23 12:20, Amos Jeffries wrote:
>The Squid "udp" logging module sends your log lines as opaque UDP 
>packet payload to the named UDP server:port.
>
>The Squid "syslog" logging module frames that data into the binary 
>syslog protocol.

so, IIUC, the difference between feeding to syslog daemon (which would 
further forward it over network), and sending directly over UDP is that the 
latter does not have syslog protocol features like UTF8 encoding?


-- 
Matus UHLAR - fantomas, uhlar at fantomas.sk ; http://www.fantomas.sk/
Warning: I wish NOT to receive e-mail advertising to this address.
Varovanie: na tuto adresu chcem NEDOSTAVAT akukolvek reklamnu postu.
2B|!2B, that's a question!


From rousskov at measurement-factory.com  Tue Sep 26 14:09:15 2023
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Tue, 26 Sep 2023 10:09:15 -0400
Subject: [squid-users] bug 4906 issue
In-Reply-To: <ZRLC+7lLL6G+xl0P@fantomas.sk>
References: <ZRLC+7lLL6G+xl0P@fantomas.sk>
Message-ID: <3ccbd5a3-fb92-4d75-9cef-f5831687c9db@measurement-factory.com>

On 2023-09-26 07:39, Matus UHLAR - fantomas wrote:

> I have just encountered bug 4906 with squid-4.13 (Debian 11)
> 
> I could upgrade system fo Debian 12 with squid-5.7 but this issue 
> doesn't seem to be resolved in it, at least:
> http://www.squid-cache.org/Versions/v5/changesets/
> 
> does not mention that.

We have not (knowingly) fixed bug 4906 yet. Moreover, there are many 
other places in Squid code that would result in problems similar to 
those reported in bug 4906. A comprehensive unofficial fix that 
addresses the root cause got stuck in my unofficial review queue since 
December 2019.


> I could try to test patch provided in that bugreport:
> https://patch-diff.githubusercontent.com/raw/measurement-factory/squid/pull/20.patch
> ...but I find trying such complicated patch too risky.

You can also try a small old unofficial v4.3 workaround patch attached 
to this email. I do not know whether it will apply to and work with 
4.13. If you are lucky, this workaround will address the immediate 
problem in your environment.


HTH,

Alex.
-------------- next part --------------
Fix src ACL when access logging TCP probes

TCP probe transactions lack HttpRequest object, which is used when
checking ACLs before logging. For this reason, src ACL did not work. To
fix this, we need to supply ACLFilledChecklist with available address
information.

diff --git a/src/client_side.cc b/src/client_side.cc
index d61e278..368c607 100644
--- a/src/client_side.cc
+++ b/src/client_side.cc
@@ -407,91 +407,98 @@ ClientHttpRequest::logRequest()
 
     tvSub(al->cache.trTime, al->cache.start_time, current_time);
 
     if (request)
         prepareLogWithRequestDetails(request, al);
 
 #if USE_OPENSSL && 0
 
     /* This is broken. Fails if the connection has been closed. Needs
      * to snarf the ssl details some place earlier..
      */
     if (getConn() != NULL)
         al->cache.ssluser = sslGetUserEmail(fd_table[getConn()->fd].ssl);
 
 #endif
 
     /* Add notes (if we have a request to annotate) */
     if (request) {
         // The al->notes and request->notes must point to the same object.
         (void)SyncNotes(*al, *request);
         for (auto i = Config.notes.begin(); i != Config.notes.end(); ++i) {
             if (const char *value = (*i)->match(request, al->reply, NULL)) {
                 NotePairs &notes = SyncNotes(*al, *request);
                 notes.add((*i)->key.termedBuf(), value);
                 debugs(33, 3, (*i)->key.termedBuf() << " " << value);
             }
         }
     }
 
     ACLFilledChecklist checklist(NULL, request, NULL);
+    const auto clientConn = getConn() ? getConn()->clientConnection : nullptr;
+    if (!request && clientConn) {
+        // because could not obtain them from request
+        checklist.src_addr = clientConn->remote;
+        checklist.my_addr = clientConn->local;
+    }
+
     if (al->reply) {
         checklist.reply = al->reply;
         HTTPMSGLOCK(checklist.reply);
     }
 
     if (request) {
         HTTPMSGUNLOCK(al->adapted_request);
         al->adapted_request = request;
         HTTPMSGLOCK(al->adapted_request);
     }
     // no need checklist.syncAle(): already synced
     checklist.al = al;
     accessLogLog(al, &checklist);
 
     bool updatePerformanceCounters = true;
     if (Config.accessList.stats_collection) {
         ACLFilledChecklist statsCheck(Config.accessList.stats_collection, request, NULL);
         statsCheck.al = al;
         if (al->reply) {
             statsCheck.reply = al->reply;
             HTTPMSGLOCK(statsCheck.reply);
         }
         updatePerformanceCounters = statsCheck.fastCheck().allowed();
     }
 
     if (updatePerformanceCounters) {
         if (request)
             updateCounters();
 
-        if (getConn() != NULL && getConn()->clientConnection != NULL)
-            clientdbUpdate(getConn()->clientConnection->remote, logType, AnyP::PROTO_HTTP, out.size);
+        if (clientConn)
+            clientdbUpdate(clientConn->remote, logType, AnyP::PROTO_HTTP, out.size);
     }
 }
 
 void
 ClientHttpRequest::freeResources()
 {
     safe_free(uri);
     safe_free(redirect.location);
     range_iter.boundary.clean();
     clearRequest();
 
     if (client_stream.tail)
         clientStreamAbort((clientStreamNode *)client_stream.tail->data, this);
 }
 
 void
 httpRequestFree(void *data)
 {
     ClientHttpRequest *http = (ClientHttpRequest *)data;
     assert(http != NULL);
     delete http;
 }
 
 /* This is a handler normally called by comm_close() */
 void ConnStateData::connStateClosed(const CommCloseCbParams &)
 {
     deleteThis("ConnStateData::connStateClosed");
 }
 
 #if USE_AUTH

From uhlar at fantomas.sk  Tue Sep 26 15:29:53 2023
From: uhlar at fantomas.sk (Matus UHLAR - fantomas)
Date: Tue, 26 Sep 2023 17:29:53 +0200
Subject: [squid-users] bug 4906 issue
In-Reply-To: <3ccbd5a3-fb92-4d75-9cef-f5831687c9db@measurement-factory.com>
References: <ZRLC+7lLL6G+xl0P@fantomas.sk>
 <3ccbd5a3-fb92-4d75-9cef-f5831687c9db@measurement-factory.com>
Message-ID: <ZRL48XKKu3ZIaOXo@fantomas.sk>

>On 2023-09-26 07:39, Matus UHLAR - fantomas wrote:
>>I have just encountered bug 4906 with squid-4.13 (Debian 11)
>>
>>I could upgrade system fo Debian 12 with squid-5.7 but this issue 
>>doesn't seem to be resolved in it, at least:
>>http://www.squid-cache.org/Versions/v5/changesets/
>>
>>does not mention that.

On 26.09.23 10:09, Alex Rousskov wrote:
>We have not (knowingly) fixed bug 4906 yet. Moreover, there are many 
>other places in Squid code that would result in problems similar to 
>those reported in bug 4906. A comprehensive unofficial fix that 
>addresses the root cause got stuck in my unofficial review queue since 
>December 2019.
[...]
>You can also try a small old unofficial v4.3 workaround patch attached 
>to this email. I do not know whether it will apply to and work with 
>4.13. If you are lucky, this workaround will address the immediate 
>problem in your environment.

Thank you,

the patch itself did not apply cleanly, but only because one difference 
between code.  Modified patch has one line different, and it's not in 
patched code:


-             if (const char *value = (*i)->match(request, al->reply, al)) {
+             if (const char *value = (*i)->match(request, al->reply, NULL)) {


I have compiled the core and seems that the line

acl mon src 10.a.b.c # FGT load balancer check

access_log syslog:local0.info squid !mon

ignores logging requests from 10.a.b.c properly

-- 
Matus UHLAR - fantomas, uhlar at fantomas.sk ; http://www.fantomas.sk/
Warning: I wish NOT to receive e-mail advertising to this address.
Varovanie: na tuto adresu chcem NEDOSTAVAT akukolvek reklamnu postu.
They that can give up essential liberty to obtain a little temporary
safety deserve neither liberty nor safety. -- Benjamin Franklin, 1759


From squid3 at treenet.co.nz  Wed Sep 27 02:10:11 2023
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Wed, 27 Sep 2023 15:10:11 +1300
Subject: [squid-users] Transparent deployment VS web services behind DNS
 load balancing
In-Reply-To: <CAEw7rkzDoT3kp60fT3pfvYhV-LxRJGNoJ10SeHim66KmqZWsYQ@mail.gmail.com>
References: <CAEw7rkzDoT3kp60fT3pfvYhV-LxRJGNoJ10SeHim66KmqZWsYQ@mail.gmail.com>
Message-ID: <918dbf49-b822-49c3-bef7-f41b554bfba8@treenet.co.nz>

On 26/09/23 05:35, Denis Roy wrote:
> My installation is fairly simple: I run Squid 5.8 in transparent mode, 
> on a pF based firewall (FreeBDS 14.0) .
> 
> I intercept both HTTP 80, and HTTPS 443. Splicing the exceptions I have 
> in a whitelist, bumping everything else. Simple.
> 
> This is a relatively recent deployment, and it has been working well as 
> far as web browser experience is concerned. Nonetheless, I have observed 
> a certain amount of 409s sharing similarities (more on that later). Rest 
> assured, I have made 100% certain my clients and Squid use the same 
> resolver (Unbound), installed on the same box with a fairly basic 
> configuration.
> 
> When I observe the 409s I am getting, they all share the same 
> similarities: the original client request was from an application or OS 
> related task, ?using ?DNS records with very low TTL. 5 minutes or less, 
> often 2 minutes.? I could easily identify the vast majority of these 
> domains as being load balanced with DNS solutions like Azure Traffic 
> Manager, and Akamai DNS.
> 
> Now, this make sense: a thread on the client may essentially intiate a 
> long running task that will last a couple of minutes (more than the 
> TTL), during which it may actually establish a few connections without 
> calling the gethostbyname function, resulting in squid detecting a 
> forgery attempt since it will be unable to validate the dst IP match the 
> intended destination domain. Essentially, creating "false positives'', 
> and dropping legitimate traffic.
> 

Aye, pretty good summary of the current issue.


> I have searched a lot, and the only reliable way to completely solve 
> this issue in a transparent deployment has been to implement a number of 
> IP lists for such services (Azure Cloud, Azure Front Door, AWS, Akamai 
> and such), bypassing squid completely based on the destination IP address.
> 
> I'd be interested to hear what other approaches there might be. Some 
> package maintainers have chosen to drop the header check altogether ( 
> https://github.com/NethServer/dev/issues/5348 
> <https://github.com/NethServer/dev/issues/5348> ).


Nod. Thus opening everyone using that package to CVE-2009-0801 effects. 
This is a high risk action that IMO should be an explicit choice by 
admin to do, not a package distributor.


>? I believe a better 
> approach could be to just validate that the SNI of the TLS Client Hello 
> match the certificate obtained from the remote web server, perform the 
> usual certificate validation (is it trusted, valid, etc), and not rely 
> so much on the DNS check

That is just swapping the client-presented Host header for 
client-presented SNI, and remotely-supplied DNS lookup for 
remotely-supplied certificate lookup. All the security considerations 
problems of CVE-2009-0801 open up again, but at the TLS trust layer 
instead of the HTTP(S) trust layer.

> which can be expected to fail at times given 
> how DNS load balancing is ubiquitous with native cloud solutions and 
> large CDNs.? But implementing this change would require serious 
> development, which I am completely unable to take care of.

Indeed.

Alternatively the design I have been trying to work towards slowly is 
verifying that all requests on the long-lived connection only go to the 
same origin/server IP. Once trust of that IP has been validated we 
should not have to re-verify every request against new DNS data, just 
against the past history of of the connection.

This approach though is also a lot of development.

HTH
Amos


From squid3 at treenet.co.nz  Wed Sep 27 06:40:53 2023
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Wed, 27 Sep 2023 06:40:53 -0000
Subject: [squid-users] [squid-announce] SQUID-2020:13 Denial of Service in
 gopher gateway
Message-ID: <007ce345-d427-4244-bb34-42f8623f5b87@treenet.co.nz>

__________________________________________________________________

   Squid Proxy Cache Security Update Advisory SQUID-2020:13
__________________________________________________________________

Advisory ID:       | SQUID-2020:13
Date:              | September 06, 2023
Summary:           | Denial of Service in gopher gateway
Affected versions: | Squid 2.x -> 2.7.STABLE9
                    | Squid 3.x -> 3.5.28
                    | Squid 4.x -> 4.14
                    | Squid 5.x -> 5.6
Fixed in version:  | Squid 6.0.1
__________________________________________________________________

Problem Description:

  Due to a buffer overflow bug Squid is vulnerable to a Denial of Service
  attack against Squid's gopher gateway.

__________________________________________________________________

Severity:

  This problem allows a remote gopher: server to trigger a buffer
  overflow by delivering large gopher protocol responses.
  On most operating systems with memory protection this will
  halt Squid service immediately, causing a denial of service to
  all Squid clients.

  The gopher protocol is always available and enabled in Squid
  prior to Squid 6.0.1

  Responses triggering this bug are possible to be received from
  any gopher server, even those without malicious intent.


CVSS Score of 7.5
<https://nvd.nist.gov/vuln-metrics/cvss/v3-calculator?vector=AV:N/AC:L/PR:N/UI:N/S:U/C:N/I:N/A:H&version=3.1>

__________________________________________________________________

Updated Packages:

  The gopher support has been removed in Squid version 6.0.1

  If you are using a prepackaged version of Squid then please refer
  to the package vendor for availability information on updated
  packages.

__________________________________________________________________

Determining if your version is vulnerable:

  All Squid-2.x up to and including 2.7.STABLE9 are vulnerable.

  All Squid-3.x up to and including 3.5.28 are vulnerable.

  All Squid-4.x up to and including 4.14 are vulnerable.

  All Squid-5.x up to and including 5.6 are vulnerable.

__________________________________________________________________

Workaround:

  * Reject all gopher URL requests

   acl gopher proto gopher
   http_access deny gopher

  Note: removing the gopher port 70 from the Safe_ports ACL
        is not sufficient to avoid this vulnerability.
__________________________________________________________________

Contact details for the Squid project:

  For installation / upgrade support on binary packaged versions
  of Squid: Your first point of contact should be your binary
  package vendor.

  If you install and build Squid from the original Squid sources
  then the <squid-users at lists.squid-cache.org> mailing list is your
  primary support point. For subscription details see
  <http://www.squid-cache.org/Support/mailing-lists.html>.

  For reporting of non-security bugs in the latest STABLE release
  the squid bugzilla database should be used
  <https://bugs.squid-cache.org/>.

  For reporting of security sensitive bugs send an email to the
  <squid-bugs at lists.squid-cache.org> mailing list. It's a closed
  list (though anyone can post) and security related bug reports
  are treated in confidence until the impact has been established.

__________________________________________________________________

Credits:

  This vulnerability was discovered by Marco Grassi.

__________________________________________________________________

Revision history:

  2019-06-15 13:32:50 UTC Initial Report
__________________________________________________________________
END
_______________________________________________
squid-announce mailing list
squid-announce at lists.squid-cache.org
https://lists.squid-cache.org/listinfo/squid-announce


From squid3 at treenet.co.nz  Wed Sep 27 02:31:34 2023
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Wed, 27 Sep 2023 15:31:34 +1300
Subject: [squid-users] [squid-announce] SQUID-2021:8 Denial of Service in
 Gopher gateway
Message-ID: <9cb8c8e6-e473-4062-8595-e684d92c61a4@treenet.co.nz>

__________________________________________________________________

   Squid Proxy Cache Security Update Advisory SQUID-2021:8
__________________________________________________________________

Advisory ID:       | SQUID-2021:8
Date:              | September 27, 2023
Summary:           | Denial of Service in Gopher gateway
Affected versions: | Squid 2.x -> 2.7.STABLE9
                    | Squid 3.x -> 3.5.28
                    | Squid 4.x -> 4.16
                    | Squid 5.x -> 5.9
Fixed in version:  | Squid 6.0.1
__________________________________________________________________

Problem Description:

  Due to a NULL pointer de-reference bug Squid is vulnerable to
  a Denial of Service attack against Squid's Gopher gateway.

__________________________________________________________________

Severity:

  The gopher protocol is always available and enabled in Squid
  prior to Squid 6.0.1

  Responses triggering this bug are possible to be received from
  any gopher server, even those without malicious intent.

  CVSS Score of 7.5
<https://nvd.nist.gov/vuln-metrics/cvss/v3-calculator?vector=AV:N/AC:L/PR:N/UI:N/S:U/C:N/I:N/A:H&version=3.1>

__________________________________________________________________

Updated Packages:

    The gopher support has been removed in Squid version 6.0.1

  If you are using a prepackaged version of Squid then please refer
  to the package vendor for availability information on updated
  packages.

__________________________________________________________________

Determining if your version is vulnerable:

  All Squid-2.x up to and including 2.7.STABLE9 are vulnerable.

  All Squid-3.x up to and including 3.5.28 are vulnerable.

  All Squid-4.x up to and including 4.16 are vulnerable.

  All Squid-5.x up to and including 5.9 are vulnerable.

__________________________________________________________________

Workaround:

* Reject all gopher URL requests

   acl gopher proto gopher
   http_access deny gopher

  Note: removing the gopher port 70 from the Safe_ports ACL
        is not sufficient to avoid this vulnerability.
__________________________________________________________________

Contact details for the Squid project:

  For installation / upgrade support on binary packaged versions
  of Squid: Your first point of contact should be your binary
  package vendor.

  If you install and build Squid from the original Squid sources
  then the <squid-users at lists.squid-cache.org> mailing list is your
  primary support point. For subscription details see
  <http://www.squid-cache.org/Support/mailing-lists.html>.

  For reporting of non-security bugs in the latest STABLE release
  the squid bugzilla database should be used
  <https://bugs.squid-cache.org/>.

  For reporting of security sensitive bugs send an email to the
  <squid-bugs at lists.squid-cache.org> mailing list. It's a closed
  list (though anyone can post) and security related bug reports
  are treated in confidence until the impact has been established.

__________________________________________________________________

Credits:

  This vulnerability was discovered by Joshua Rogers of Opera
  Software.

__________________________________________________________________

Revision history:

  2021-02-20 08:37:38 UTC Initial Report
__________________________________________________________________
END
_______________________________________________
squid-announce mailing list
squid-announce at lists.squid-cache.org
https://lists.squid-cache.org/listinfo/squid-announce


From nikhildeshpande18 at gmail.com  Wed Sep 27 12:22:57 2023
From: nikhildeshpande18 at gmail.com (nikhil deshpande)
Date: Wed, 27 Sep 2023 17:52:57 +0530
Subject: [squid-users] squid-users Digest, Vol 109, Issue 19
In-Reply-To: <mailman.3.1695643202.1139032.squid-users@lists.squid-cache.org>
References: <mailman.3.1695643202.1139032.squid-users@lists.squid-cache.org>
Message-ID: <CALO-o=x6bpei3Q8zuVW1upgCFAQ0ExpQhc2AW8NjQSiF77whTg@mail.gmail.com>

Hi Team,

[Question]: Are you trying to bump TLS client connections when and
only when the TLS
client is offering to use one of those ciphers in its ClientHello
message? Or do you want Squid to use one of those ciphers when bumping
all TLS client connections? Or something else? Please clarify.

[Answer]: In our case client is offering these two
ciphers(*ECDHE-ECDSA-AES256-GCM-SHA384 &
**ECDHE-ECDSA-AES128-GCM-SHA256*) in Client Hello but squid is failing
to complete handshake with client while performing SSL-Bump.

We have attached logs and network capture.

[Question]: FWIW, to restrict Squid use of ciphers on accepted TLS client

connections, use the http_port (or https_port) "cipher" option. For
example,

     https_port 3129 ssl-bump ... \
         cipher=DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384

[Answer]: We dont want to restrict to use this specific ciphers only.
We wanted that Squid should use strong ciphers.

One more point I wanted to add here is that this issue is getting
reproduced with latest squid also.


On Mon, Sep 25, 2023 at 5:30?PM <squid-users-request at lists.squid-cache.org>
wrote:

> Send squid-users mailing list submissions to
>         squid-users at lists.squid-cache.org
>
> To subscribe or unsubscribe via the World Wide Web, visit
>         https://lists.squid-cache.org/listinfo/squid-users
> or, via email, send a message with subject or body 'help' to
>         squid-users-request at lists.squid-cache.org
>
> You can reach the person managing the list at
>         squid-users-owner at lists.squid-cache.org
>
> When replying, please edit your Subject line so it is more specific
> than "Re: Contents of squid-users digest..."
>
>
> Today's Topics:
>
>    1. Re: A few things about Squid-cache (Jason Long)
>    2. Re: A few things about Squid-cache (Amos Jeffries)
>    3. Re: Seeking Help with SSL Bump Configuration for ECDSA
>       Ciphers in Squid (nikhil deshpande)
>
>
> ----------------------------------------------------------------------
>
> Message: 1
> Date: Sun, 24 Sep 2023 18:49:06 +0000 (UTC)
> From: Jason Long <hack3rcon at yahoo.com>
> To: gkinkie at gmail.com
> Cc: Squid Users <squid-users at lists.squid-cache.org>
> Subject: Re: [squid-users] A few things about Squid-cache
> Message-ID: <575071616.3138479.1695581346718 at mail.yahoo.com>
> Content-Type: text/plain; charset="utf-8"
>
> Hello,Thank you so much for your reply.1- Regarding security, what
> parameters should be changed or added in the configuration file?
>
>  2- How to configure Squid-cache?service for 1000 clients?
>
>
>
>   On Sat, Sep 23, 2023 at 12:26 AM, Francesco Chemolli<gkinkie at gmail.com>
> wrote:   Hi Jason!
> Squid is a complex piece of software, which is deployed in a vast number
> of scenarios, some are simpler and some are intensely adversarial and
> trickier.Securing squid is similar to any other public-facing complex
> service; it's unfortunately not something?that can be explained with a few
> tips.
> Regarding how many users Squid can support at the same time, it really
> depends, mostly on the hardware, services configuration, and user
> behaviour. On modern hardware, Squid can generally support many users, in
> the order of several thousands
> Squid is not a firewall, on most modern Unix-like operating systems,
> including Linux, FreeBSD, and OpenBSD, that role can be fulfilled by the
> underlying operating system
> On Thu, Sep 21, 2023 at 7:59?PM Jason Long <hack3rcon at yahoo.com> wrote:
>
> Hello,I have some questions:1- What tips should be considered to keep
> Squid-cache safe?
>
> 2-?How strong is Squid-cache? How many users can use it at the same time?
> 3-?Can Squid-cache?also play the role of a firewall? Something like the
> Microsoft ForeFront TMG Replacement or the Kemp LoadMaster.
>
> Thank you._______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> https://lists.squid-cache.org/listinfo/squid-users
>
>
>
> --
> ? ? Francesco
> -------------- next part --------------
> An HTML attachment was scrubbed...
> URL: <
> http://lists.squid-cache.org/pipermail/squid-users/attachments/20230924/2ef15d28/attachment-0001.htm
> >
>
> ------------------------------
>
> Message: 2
> Date: Mon, 25 Sep 2023 17:51:45 +1300
> From: Amos Jeffries <squid3 at treenet.co.nz>
> To: squid-users at lists.squid-cache.org
> Subject: Re: [squid-users] A few things about Squid-cache
> Message-ID: <8ffe5581-d731-4f43-be7f-72c00e5a7a9e at treenet.co.nz>
> Content-Type: text/plain; charset=UTF-8; format=flowed
>
> On 25/09/23 07:49, Jason Long wrote:
> > Hello,
> > Thank you so much for your reply.
> > 1- Regarding security, what parameters should be changed or added in the
> > configuration file?
> >
>
> First steps with a new Squid install are to check in squid.conf for the
> "acl localnet" lines and adjust so it lists your LAN ranges. The common
> ones are listed there by default.
>
> Then look for the "http_access" directive. That is the primary means of
> telling Squid what the network policy needs are.
>
>
> > 2- How to configure Squid-cache?service for 1000 clients?
> >
>
> Apart from the above (1) answer, Squid does not care about number of
> clients it will serve as many as your machine can handle. Until the
> hardware overloads the CPU, RAM or disks capacity limits.
>
>
> For good advise we will need details...
>
>   Forward or Reverse proxy installation?
>   LAN or WAN clients?
>
>   What policies do you need to comply with regarding client use of the
> proxy, or access to any special websites?
>
>
> Cheers
> Amos
>
>
> ------------------------------
>
> Message: 3
> Date: Mon, 25 Sep 2023 15:01:05 +0530
> From: nikhil deshpande <nikhildeshpande18 at gmail.com>
> To: Shyam varun <shyam3898 at gmail.com>
> Cc: squid-users at lists.squid-cache.org, jrose at qualys.com
> Subject: Re: [squid-users] Seeking Help with SSL Bump Configuration
>         for ECDSA Ciphers in Squid
> Message-ID:
>         <CALO-o=
> xTe18tuGww-gsr-vAVKMJqRai1ZvNR-hRqaToWXp1NGQ at mail.gmail.com>
> Content-Type: text/plain; charset="utf-8"
>
> Hi team,
>
> Any update on this?
>
> Regards,
> Nikhil
>
> On Thu, Sep 14, 2023 at 6:05?PM Shyam varun <shyam3898 at gmail.com> wrote:
>
> > Dear Squid Mailing List Community,
> >
> > I hope this email finds you well. I am currently working on configuring
> > SSL bump in Squid proxy server to support ECDSA ciphers, and I am seeking
> > assistance with a particular issue I've encountered.
> >
> > To provide some context:
> >
> > - *Squid Version:* Squid 5.2
> > - *OpenSSL Version*: OpenSSL 1.1.1l
> > - *OS:* Alpine Linux v3.16
> > -
> > *Squid Configuration: *
> >
> > * sslproxy_cert_error allow all*
> >
> > * sslcrtd_program /usr/lib/squid/security_file_certgen -s /var/lib/ssl_db
> > -M 4MB*
> >
> >
> > * http_port 3129 ssl-bump generate-host-certificates=on
> > dynamic_cert_mem_cache_size=4MB
> cert=/opt/ssl/intermediate_certificate.pem
> > key=/opt/ssl/intermediate_key.pem options=SINGLE_DH_USE,SINGLE_ECDH_USE
> > tls-dh=/opt/dhparam.pem*
> >
> >
> > * tls_outgoing_options min-version=1.1  options=NO_SSLv3*
> >
> >
> > * acl step1 at_step SslBump1*
> >
> > * ssl_bump peek step1*
> >
> > * ssl_bump bump all*
> >
> >
> > The goal of my configuration is to enable SSL bump for ECDSA ciphers,
> > specifically the "ECDHE-ECDSA-AES256-GCM-SHA384" and
> > "ECDHE-ECDSA-AES128-GCM-SHA256" cipher suites. However, I've run into
> > challenges and issues while trying to achieve this.
> >
> > *Things I tried:*
> >
> >    1. I created an ECDSA-based certificate chain using OpenSSL.
> >    2. I configured the ECDSA-based certificate certs in squid as shown in
> >    above snippet but still not able to make it work.
> >
> >
> > I've thoroughly reviewed the Squid documentation and online resources,
> but
> > I haven't been able to resolve these issues on my own.
> >
> > I would greatly appreciate any guidance, insights, or assistance from the
> > Squid community regarding the proper configuration for SSL bump with
> ECDSA
> > ciphers. If you have successfully configured Squid to support ECDSA
> ciphers
> > or if you have expertise in this area, your input would be invaluable.
> >
> > Thank you in advance for your time and support. I look forward to your
> > responses and insights.
> >
> -------------- next part --------------
> An HTML attachment was scrubbed...
> URL: <
> http://lists.squid-cache.org/pipermail/squid-users/attachments/20230925/9e18cf96/attachment-0001.htm
> >
>
> ------------------------------
>
> Subject: Digest Footer
>
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> https://lists.squid-cache.org/listinfo/squid-users
>
>
> ------------------------------
>
> End of squid-users Digest, Vol 109, Issue 19
> ********************************************
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230927/04095cdc/attachment.htm>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: squid-pcap-and-cache-log.zip
Type: application/x-zip-compressed
Size: 58034 bytes
Desc: not available
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230927/04095cdc/attachment.bin>

From marko.cupac at mimar.rs  Wed Sep 27 13:30:20 2023
From: marko.cupac at mimar.rs (Marko =?UTF-8?B?Q3VwYcSH?=)
Date: Wed, 27 Sep 2023 15:30:20 +0200
Subject: [squid-users] TCP_TUNNEL/500 internal server error bandwidth impact
Message-ID: <20230927153020.42e0b6ac@sanri>

Hi,

I have successfully been running AD-authenticated, ssl-bumped (for a
few sites of our own, the rest is spliced) squid proxy server for more
than a decade, where for such success I am greatly thankful to all the
people who develop squid and who helped me on this list numerous times.

Lately I am experiencing bandwidth saturation of links I care for, and
- of course - a big chunk of it is taken by web traffic that passes
through squid proxy. I fired up calamaris to see what is going on,
and I found out that - if report is correct - more than a third of
daily data consumed by squid on behalf of its clients, goes for
"500 (Internal Server Error)":

# TCP Response code distribution
status-code                                     request      %    Byte       %  
---------------------------------------------- --------- ------ -------- ------ 
000 (Used mostly with UDP traffic)                168404   3.86       0M   0.00 
200 (OK)                                         2083756  47.82   78277M  54.66 
204 (No Content)                                      57   0.00       0M   0.00 
206 (Partial Content)                              22234   0.51    7373M   5.15 
301 (Moved Permanently)                              467   0.01       0M   0.00 
302 (Moved Temporarily)                              442   0.01       0M   0.00 
303 (See Other)                                        1   0.00       0M   0.00 
304 (Not Modified)                                 16639   0.38       7M   0.00 
308 (Resume Incomplete)                                1   0.00       0M   0.00 
400 (Bad Request)                                     12   0.00       0M   0.00 
403 (Forbidden)                                   139524   3.20     782M   0.55 
404 (Not Found)                                      588   0.01       1M   0.00 
407 (Proxy Authentication Required)              1593023  36.56    6275M   4.38 
500 (Internal Server Error)                       321292   7.37   50439M  35.22 
502 (Bad Gateway)                                   6269   0.14      44M   0.03 
503 (Service Unavailable)                           4850   0.11       0M   0.00 
---------------------------------------------- --------- ------ -------- ------ 
Sum                                              4357559 100.00  143198M 100.00

I came to conclusion that this comes from lines with TCP_TUNNEL/500 in
access.log, similar to:

1695680000.912  69973 10.X.X.X TCP_TUNNEL/500 8503669 CONNECT ipv4-c002-beg001-oriontelekom-isp.1.oca.nflxvideo.net:443 some.gal HIER_DIRECT/93.93.192.146 -
1695679277.395 876830 10.X.X.X TCP_TUNNEL/500 105991027 CONNECT rostov1.nebula.to:443 some.guy HIER_DIRECT/37.48.76.251 -
1695710735.004    271 10.X.X.X TCP_TUNNEL/500 10076 CONNECT nav.smartscreen.microsoft.com:443 some.guy HIER_DIRECT/51.104.176.40 -
1695710735.117  35652 10.X.X.X TCP_TUNNEL/500 6696 CONNECT g.live.com:443 some.gal HIER_DIRECT/68.219.88.225 -
1695710735.228 126910 10.X.X.X TCP_TUNNEL/500 6831 CONNECT enterprise-eudb.activity.windows.com:443 some.otherguy HIER_DIRECT/40.118.94.234 -
1695710735.343    218 10.X.X.X TCP_TUNNEL/500 7854 CONNECT smartscreen.microsoft.com:443 some.othergal HIER_DIRECT/51.104.176.40 -
1695710735.668 125756 10.X.X.X TCP_TUNNEL/500 997 CONNECT teams.microsoft.com:443 - HIER_DIRECT/52.123.129.14 -

Are these really remote server errors? If so, why do they consume so
much traffic? Is there anything I can do to prevent it, like reseting
those sessions early and avoiding downloading all that data?

Thank you in advance.

-- 
Before enlightenment - chop wood, draw water.
After  enlightenment - chop wood, draw water.

Marko Cupa?
https://www.mimar.rs/


From dma_k at mail.ru  Wed Sep 27 15:08:20 2023
From: dma_k at mail.ru (Dmitry Katsubo)
Date: Wed, 27 Sep 2023 17:08:20 +0200
Subject: [squid-users] SIGABRT (coredump) in
 Ip::Address::getAddrInfo(addrinfo*&, int)
Message-ID: <e88e095d-9faf-c287-15e2-4ae2ac119337@mail.ru>

Dear squid community,

After upgrading Squid from v4.13-10+deb11u2 (bullseye) to v5.7-2 (bookworm) I started to get about 5 core dumps per day like below.

How can I find out the root of the problem and eliminate it? Thanks in advance!

# coredumpctl gdb -1 --no-pager
           PID: 357187 (squid)
           UID: 13 (proxy)
           GID: 13 (proxy)
        Signal: 6 (ABRT)
     Timestamp: Wed 2023-09-27 11:27:08 CEST (5h 16min ago)
  Command Line: $'(squid-1)' --kid squid-1 --foreground -sYC
    Executable: /usr/sbin/squid
 Control Group: /system.slice/squid.service
          Unit: squid.service
         Slice: system.slice
       Storage: /var/lib/systemd/coredump/core.squid.13.f7e894167d564f788825cae8827bd2df.357187.1695806828000000.zst (present)
  Size on Disk: 2.5M
       Message: Process 357187 (squid) of user 13 dumped core.

                Module libsystemd.so.0 from deb systemd-252.12-1~deb12u1.amd64
                Stack trace of thread 357187:
                #0  0x00007f752b2a9d3c n/a (libc.so.6 + 0x8ad3c)
                #1  0x00007f752b25af32 raise (libc.so.6 + 0x3bf32)
                #2  0x00007f752b245472 abort (libc.so.6 + 0x26472)
                #3  0x00007f752b245395 n/a (libc.so.6 + 0x26395)
                #4  0x00007f752b253e32 __assert_fail (libc.so.6 + 0x34e32)
                #5  0x00005576cf7c0ee4 _ZNK2Ip7Address11getAddrInfoERP8addrinfoi (squid + 0x466ee4)
                #6  0x00005576cf7bc3c5 _Z11comm_openexiiRN2Ip7AddressEiPKc (squid + 0x4623c5)
                #7  0x00005576cf80fdfe _ZN4Comm10ConnOpener8createFdEv (squid + 0x4b5dfe)
                #8  0x00005576cf8109c1 _ZN4Comm10ConnOpener5startEv (squid + 0x4b69c1)
                #9  0x00005576cf7ab09c _ZN9JobDialerI8AsyncJobE4dialER9AsyncCall (squid + 0x45109c)
                #10 0x00005576cf7a779f _ZN14AsyncCallQueue8fireNextEv (squid + 0x44d79f)
                #11 0x00005576cf7a7b52 _ZN14AsyncCallQueue4fireEv (squid + 0x44db52)
                #12 0x00005576cf55f689 _ZN9EventLoop7runOnceEv (squid + 0x205689)
                #13 0x00005576cf55f778 _ZN9EventLoop3runEv (squid + 0x205778)
                #14 0x00005576cf665a50 _Z9SquidMainiPPc (squid + 0x30ba50)
                #15 0x00005576cf4fdae1 main (squid + 0x1a3ae1)
                #16 0x00007f752b2461ca n/a (libc.so.6 + 0x271ca)
                #17 0x00007f752b246285 __libc_start_main (libc.so.6 + 0x27285)
                #18 0x00005576cf505cc1 _start (squid + 0x1abcc1)
                ELF object binary architecture: AMD x86-64

GNU gdb (Debian 13.1-3) 13.1
Reading symbols from /usr/sbin/squid...
(No debugging symbols found in /usr/sbin/squid)
[New LWP 357187]
[Thread debugging using libthread_db enabled]
Using host libthread_db library "/lib/x86_64-linux-gnu/libthread_db.so.1".
Core was generated by `(squid-1) --kid squid-1 --foreground -sYC'.
Program terminated with signal SIGABRT, Aborted.
(gdb) bt
#0  0x00007f752b2a9d3c in ?? () from /lib/x86_64-linux-gnu/libc.so.6
#1  0x00007f752b25af32 in raise () from /lib/x86_64-linux-gnu/libc.so.6
#2  0x00007f752b245472 in abort () from /lib/x86_64-linux-gnu/libc.so.6
#3  0x00007f752b245395 in ?? () from /lib/x86_64-linux-gnu/libc.so.6
#4  0x00007f752b253e32 in __assert_fail () from /lib/x86_64-linux-gnu/libc.so.6
#5  0x00005576cf7c0ee4 in Ip::Address::getAddrInfo(addrinfo*&, int) const ()
#6  0x00005576cf7bc3c5 in comm_openex(int, int, Ip::Address&, int, char const*) ()
#7  0x00005576cf80fdfe in Comm::ConnOpener::createFd() ()
#8  0x00005576cf8109c1 in Comm::ConnOpener::start() ()
#9  0x00005576cf7ab09c in JobDialer<AsyncJob>::dial(AsyncCall&) ()
#10 0x00005576cf7a779f in AsyncCallQueue::fireNext() ()
#11 0x00005576cf7a7b52 in AsyncCallQueue::fire() ()
#12 0x00005576cf55f689 in EventLoop::runOnce() ()
#13 0x00005576cf55f778 in EventLoop::run() ()
#14 0x00005576cf665a50 in SquidMain(int, char**) ()
#15 0x00005576cf4fdae1 in main ()
(gdb) exit

-- 
With best regards,
Dmitry


From rousskov at measurement-factory.com  Wed Sep 27 17:15:16 2023
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Wed, 27 Sep 2023 13:15:16 -0400
Subject: [squid-users] SIGABRT (coredump) in
 Ip::Address::getAddrInfo(addrinfo*&, int)
In-Reply-To: <e88e095d-9faf-c287-15e2-4ae2ac119337@mail.ru>
References: <e88e095d-9faf-c287-15e2-4ae2ac119337@mail.ru>
Message-ID: <f8dc78b4-9e6a-4aed-be04-48c0dac40ac8@measurement-factory.com>

On 2023-09-27 11:08, Dmitry Katsubo wrote:

> After upgrading Squid from v4.13-10+deb11u2 (bullseye) to v5.7-2
> (bookworm) I started to get about 5 core dumps per day like below.

> How can I find out the root of the problem and eliminate it?


Your Squid is most likely suffering (among other v5 bugs) from Squid Bug
5154: https://bugs.squid-cache.org/show_bug.cgi?id=5154

There is currently no fix for that bug (that I can recommend without 
serious caveats). There has been significant progress towards a fix, but 
it may have stalled at https://github.com/squid-cache/squid/pull/1421

The best known way to prevent bug 5154 is to enable IPv6 support, but 
that is not feasible in many environments.

Another Squid admin has reported success with an unofficial (and 
probably incomplete) workaround at 
https://lists.squid-cache.org/pipermail/squid-users/2023-September/026103.html


HTH,

Alex.


> 
> # coredumpctl gdb -1 --no-pager
>             PID: 357187 (squid)
>             UID: 13 (proxy)
>             GID: 13 (proxy)
>          Signal: 6 (ABRT)
>       Timestamp: Wed 2023-09-27 11:27:08 CEST (5h 16min ago)
>    Command Line: $'(squid-1)' --kid squid-1 --foreground -sYC
>      Executable: /usr/sbin/squid
>   Control Group: /system.slice/squid.service
>            Unit: squid.service
>           Slice: system.slice
>         Storage: /var/lib/systemd/coredump/core.squid.13.f7e894167d564f788825cae8827bd2df.357187.1695806828000000.zst (present)
>    Size on Disk: 2.5M
>         Message: Process 357187 (squid) of user 13 dumped core.
> 
>                  Module libsystemd.so.0 from deb systemd-252.12-1~deb12u1.amd64
>                  Stack trace of thread 357187:
>                  #0  0x00007f752b2a9d3c n/a (libc.so.6 + 0x8ad3c)
>                  #1  0x00007f752b25af32 raise (libc.so.6 + 0x3bf32)
>                  #2  0x00007f752b245472 abort (libc.so.6 + 0x26472)
>                  #3  0x00007f752b245395 n/a (libc.so.6 + 0x26395)
>                  #4  0x00007f752b253e32 __assert_fail (libc.so.6 + 0x34e32)
>                  #5  0x00005576cf7c0ee4 _ZNK2Ip7Address11getAddrInfoERP8addrinfoi (squid + 0x466ee4)
>                  #6  0x00005576cf7bc3c5 _Z11comm_openexiiRN2Ip7AddressEiPKc (squid + 0x4623c5)
>                  #7  0x00005576cf80fdfe _ZN4Comm10ConnOpener8createFdEv (squid + 0x4b5dfe)
>                  #8  0x00005576cf8109c1 _ZN4Comm10ConnOpener5startEv (squid + 0x4b69c1)
>                  #9  0x00005576cf7ab09c _ZN9JobDialerI8AsyncJobE4dialER9AsyncCall (squid + 0x45109c)
>                  #10 0x00005576cf7a779f _ZN14AsyncCallQueue8fireNextEv (squid + 0x44d79f)
>                  #11 0x00005576cf7a7b52 _ZN14AsyncCallQueue4fireEv (squid + 0x44db52)
>                  #12 0x00005576cf55f689 _ZN9EventLoop7runOnceEv (squid + 0x205689)
>                  #13 0x00005576cf55f778 _ZN9EventLoop3runEv (squid + 0x205778)
>                  #14 0x00005576cf665a50 _Z9SquidMainiPPc (squid + 0x30ba50)
>                  #15 0x00005576cf4fdae1 main (squid + 0x1a3ae1)
>                  #16 0x00007f752b2461ca n/a (libc.so.6 + 0x271ca)
>                  #17 0x00007f752b246285 __libc_start_main (libc.so.6 + 0x27285)
>                  #18 0x00005576cf505cc1 _start (squid + 0x1abcc1)
>                  ELF object binary architecture: AMD x86-64
> 
> GNU gdb (Debian 13.1-3) 13.1
> Reading symbols from /usr/sbin/squid...
> (No debugging symbols found in /usr/sbin/squid)
> [New LWP 357187]
> [Thread debugging using libthread_db enabled]
> Using host libthread_db library "/lib/x86_64-linux-gnu/libthread_db.so.1".
> Core was generated by `(squid-1) --kid squid-1 --foreground -sYC'.
> Program terminated with signal SIGABRT, Aborted.
> (gdb) bt
> #0  0x00007f752b2a9d3c in ?? () from /lib/x86_64-linux-gnu/libc.so.6
> #1  0x00007f752b25af32 in raise () from /lib/x86_64-linux-gnu/libc.so.6
> #2  0x00007f752b245472 in abort () from /lib/x86_64-linux-gnu/libc.so.6
> #3  0x00007f752b245395 in ?? () from /lib/x86_64-linux-gnu/libc.so.6
> #4  0x00007f752b253e32 in __assert_fail () from /lib/x86_64-linux-gnu/libc.so.6
> #5  0x00005576cf7c0ee4 in Ip::Address::getAddrInfo(addrinfo*&, int) const ()
> #6  0x00005576cf7bc3c5 in comm_openex(int, int, Ip::Address&, int, char const*) ()
> #7  0x00005576cf80fdfe in Comm::ConnOpener::createFd() ()
> #8  0x00005576cf8109c1 in Comm::ConnOpener::start() ()
> #9  0x00005576cf7ab09c in JobDialer<AsyncJob>::dial(AsyncCall&) ()
> #10 0x00005576cf7a779f in AsyncCallQueue::fireNext() ()
> #11 0x00005576cf7a7b52 in AsyncCallQueue::fire() ()
> #12 0x00005576cf55f689 in EventLoop::runOnce() ()
> #13 0x00005576cf55f778 in EventLoop::run() ()
> #14 0x00005576cf665a50 in SquidMain(int, char**) ()
> #15 0x00005576cf4fdae1 in main ()
> (gdb) exit
> 



From rousskov at measurement-factory.com  Wed Sep 27 17:39:50 2023
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Wed, 27 Sep 2023 13:39:50 -0400
Subject: [squid-users] TCP_TUNNEL/500 internal server error bandwidth
 impact
In-Reply-To: <20230927153020.42e0b6ac@sanri>
References: <20230927153020.42e0b6ac@sanri>
Message-ID: <69ddb89f-27cb-458e-8154-dbf1aed33e2f@measurement-factory.com>

On 2023-09-27 09:30, Marko Cupa? wrote:

> 1695680000.912  69973 10.X.X.X TCP_TUNNEL/500 8503669 CONNECT ipv4-c002-beg001-oriontelekom-isp.1.oca.nflxvideo.net:443 some.gal HIER_DIRECT/93.93.192.146 -
> 1695679277.395 876830 10.X.X.X TCP_TUNNEL/500 105991027 CONNECT rostov1.nebula.to:443 some.guy HIER_DIRECT/37.48.76.251 -
> 1695710735.004    271 10.X.X.X TCP_TUNNEL/500 10076 CONNECT nav.smartscreen.microsoft.com:443 some.guy HIER_DIRECT/51.104.176.40 -
> 1695710735.117  35652 10.X.X.X TCP_TUNNEL/500 6696 CONNECT g.live.com:443 some.gal HIER_DIRECT/68.219.88.225 -
> 1695710735.228 126910 10.X.X.X TCP_TUNNEL/500 6831 CONNECT enterprise-eudb.activity.windows.com:443 some.otherguy HIER_DIRECT/40.118.94.234 -
> 1695710735.343    218 10.X.X.X TCP_TUNNEL/500 7854 CONNECT smartscreen.microsoft.com:443 some.othergal HIER_DIRECT/51.104.176.40 -
> 1695710735.668 125756 10.X.X.X TCP_TUNNEL/500 997 CONNECT teams.microsoft.com:443 - HIER_DIRECT/52.123.129.14 -
> 
> Are these really remote server errors?

Most likely, your Squid is suffering from Squid bug #5274:
https://bugs.squid-cache.org/show_bug.cgi?id=5274

If it is suffering from that bug, then the answer to your question is 
most likely "no" -- most of these TCP_TUNNEL/500 entries, especially 
those that last for a long time and transfer a lot of bytes, probably 
correspond to regular tunneled/spliced TLS connections rather than 
server errors.


HTH,

Alex.



From bud_miljkovic at trimble.com  Wed Sep 27 18:55:15 2023
From: bud_miljkovic at trimble.com (Bud Miljkovic)
Date: Thu, 28 Sep 2023 07:55:15 +1300
Subject: [squid-users] How to Initialize SSL database for Squid 3.5.25
Message-ID: <CAPO8noK_0PhzfKqwn7v7PbgHZrLHafNF292AkzSsmysAVS_iUQ@mail.gmail.com>

I have created the `myCA.pem` and `myCA.der` files in my Linux open
embedded `pyro` distribution.

How should I then configure Squid for SSL Intercept?


Any clue is appreciated.

Buda




www.trimble.com

This email may contain confidential information that is intended only for
the listed recipient(s) of this email. Any unauthorized review, use,
disclosure or distribution is prohibited. If you believe you have received
this email in error, please immediately delete this email and any
attachments, and inform me via reply email.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230928/14143017/attachment.htm>

From dma_k at mail.ru  Wed Sep 27 19:43:17 2023
From: dma_k at mail.ru (Dmitry Katsubo)
Date: Wed, 27 Sep 2023 21:43:17 +0200
Subject: [squid-users] SIGABRT (coredump) in
 Ip::Address::getAddrInfo(addrinfo*&, int)
In-Reply-To: <f8dc78b4-9e6a-4aed-be04-48c0dac40ac8@measurement-factory.com>
References: <e88e095d-9faf-c287-15e2-4ae2ac119337@mail.ru>
 <f8dc78b4-9e6a-4aed-be04-48c0dac40ac8@measurement-factory.com>
Message-ID: <8df1661b-4709-5a9d-21d6-a7d811e86b70@mail.ru>

On 2023-09-27 19:15, Alex Rousskov wrote:
> On 2023-09-27 11:08, Dmitry Katsubo wrote:
>
>> After upgrading Squid from v4.13-10+deb11u2 (bullseye) to v5.7-2
>> (bookworm) I started to get about 5 core dumps per day like below, provided .
>> How can I find out the root of the problem and eliminate it?
>
>
> Your Squid is most likely suffering (among other v5 bugs) from Squid Bug
> 5154: https://bugs.squid-cache.org/show_bug.cgi?id=5154
>
> There is currently no fix for that bug (that I can recommend without serious caveats). There has been significant progress towards a fix, but it may have stalled at
> https://github.com/squid-cache/squid/pull/1421
>
> The best known way to prevent bug 5154 is to enable IPv6 support, but that is not feasible in many environments.
>
> Another Squid admin has reported success with an unofficial (and probably incomplete) workaround at https://lists.squid-cache.org/pipermail/squid-users/2023-September/026103.html
Thanks for this information Alex,

Debain sid has v6.1-2, which I believe is also affected, hence no reason to try it ?

After reading the bug#5154 description I see that the issue is because of disabled IPv6, in my case, via sysctl:

net.ipv6.conf.default.disable_ipv6=1
net.ipv6.conf.all.disable_ipv6=1

I believe re-enabling IPV6 should help the issue? I have checked why I have disabled it ... and it turned out that was an advise to fix the following error message in /var/log/squid/cache.log:

SendEcho ERROR: sending to ICMPv6 packet to [2606:4700:e0::ac40:6225]: (101) Network is unreachable

? Boomerang has returned.

>
>>
>> # coredumpctl gdb -1 --no-pager
>> ??????????? PID: 357187 (squid)
>> ??????????? UID: 13 (proxy)
>> ??????????? GID: 13 (proxy)
>> ???????? Signal: 6 (ABRT)
>> ????? Timestamp: Wed 2023-09-27 11:27:08 CEST (5h 16min ago)
>> ?? Command Line: $'(squid-1)' --kid squid-1 --foreground -sYC
>> ???? Executable: /usr/sbin/squid
>> ? Control Group: /system.slice/squid.service
>> ?????????? Unit: squid.service
>> ????????? Slice: system.slice
>> ??????? Storage: /var/lib/systemd/coredump/core.squid.13.f7e894167d564f788825cae8827bd2df.357187.1695806828000000.zst (present)
>> ?? Size on Disk: 2.5M
>> ??????? Message: Process 357187 (squid) of user 13 dumped core.
>>
>> ???????????????? Module libsystemd.so.0 from deb systemd-252.12-1~deb12u1.amd64
>> ???????????????? Stack trace of thread 357187:
>> ???????????????? #0? 0x00007f752b2a9d3c n/a (libc.so.6 + 0x8ad3c)
>> ???????????????? #1? 0x00007f752b25af32 raise (libc.so.6 + 0x3bf32)
>> ???????????????? #2? 0x00007f752b245472 abort (libc.so.6 + 0x26472)
>> ???????????????? #3? 0x00007f752b245395 n/a (libc.so.6 + 0x26395)
>> ???????????????? #4? 0x00007f752b253e32 __assert_fail (libc.so.6 + 0x34e32)
>> ???????????????? #5? 0x00005576cf7c0ee4 _ZNK2Ip7Address11getAddrInfoERP8addrinfoi (squid + 0x466ee4)
>> ???????????????? #6? 0x00005576cf7bc3c5 _Z11comm_openexiiRN2Ip7AddressEiPKc (squid + 0x4623c5)
>> ???????????????? #7? 0x00005576cf80fdfe _ZN4Comm10ConnOpener8createFdEv (squid + 0x4b5dfe)
>> ???????????????? #8? 0x00005576cf8109c1 _ZN4Comm10ConnOpener5startEv (squid + 0x4b69c1)
>> ???????????????? #9? 0x00005576cf7ab09c _ZN9JobDialerI8AsyncJobE4dialER9AsyncCall (squid + 0x45109c)
>> ???????????????? #10 0x00005576cf7a779f _ZN14AsyncCallQueue8fireNextEv (squid + 0x44d79f)
>> ???????????????? #11 0x00005576cf7a7b52 _ZN14AsyncCallQueue4fireEv (squid + 0x44db52)
>> ???????????????? #12 0x00005576cf55f689 _ZN9EventLoop7runOnceEv (squid + 0x205689)
>> ???????????????? #13 0x00005576cf55f778 _ZN9EventLoop3runEv (squid + 0x205778)
>> ???????????????? #14 0x00005576cf665a50 _Z9SquidMainiPPc (squid + 0x30ba50)
>> ???????????????? #15 0x00005576cf4fdae1 main (squid + 0x1a3ae1)
>> ???????????????? #16 0x00007f752b2461ca n/a (libc.so.6 + 0x271ca)
>> ???????????????? #17 0x00007f752b246285 __libc_start_main (libc.so.6 + 0x27285)
>> ???????????????? #18 0x00005576cf505cc1 _start (squid + 0x1abcc1)
>> ???????????????? ELF object binary architecture: AMD x86-64
>>
>> GNU gdb (Debian 13.1-3) 13.1
>> Reading symbols from /usr/sbin/squid...
>> (No debugging symbols found in /usr/sbin/squid)
>> [New LWP 357187]
>> [Thread debugging using libthread_db enabled]
>> Using host libthread_db library "/lib/x86_64-linux-gnu/libthread_db.so.1".
>> Core was generated by `(squid-1) --kid squid-1 --foreground -sYC'.
>> Program terminated with signal SIGABRT, Aborted.
>> (gdb) bt
>> #0? 0x00007f752b2a9d3c in ?? () from /lib/x86_64-linux-gnu/libc.so.6
>> #1? 0x00007f752b25af32 in raise () from /lib/x86_64-linux-gnu/libc.so.6
>> #2? 0x00007f752b245472 in abort () from /lib/x86_64-linux-gnu/libc.so.6
>> #3? 0x00007f752b245395 in ?? () from /lib/x86_64-linux-gnu/libc.so.6
>> #4? 0x00007f752b253e32 in __assert_fail () from /lib/x86_64-linux-gnu/libc.so.6
>> #5? 0x00005576cf7c0ee4 in Ip::Address::getAddrInfo (this=this at entry=0x5576d2407a98, dst=@0x7ffea5b87f90: 0x5576d2a8af00, force=force at entry=0) at ./src/ip/Address.cc:663
>> #6? 0x00005576cf7bc3c5 in comm_openex (sock_type=sock_type at entry=1, proto=proto at entry=6, addr=..., flags=1, note=0x5576d2ab0cd0 "[2a03:2880:f273:c8:face:b00c:0:167]") at ./src/comm.cc:347
>> #7? 0x00005576cf80fdfe in Comm::ConnOpener::createFd (this=this at entry=0x5576d2a86bc8) at ./src/comm/ConnOpener.cc:288
>> #8? 0x00005576cf8109c1 in Comm::ConnOpener::start (this=0x5576d2a86bc8) at ./src/comm/ConnOpener.cc:261
>> #9? 0x00005576cf7ab09c in JobDialer<AsyncJob>::dial (this=0x5576d1e16558, call=...) at ../../src/base/AsyncJobCalls.h:175
>> #10 0x00005576cf7a779f in AsyncCallQueue::fireNext (this=this at entry=0x5576d1abbae0) at ./src/base/AsyncCallQueue.cc:60
>> #11 0x00005576cf7a7b52 in AsyncCallQueue::fire (this=0x5576d1abbae0) at ./src/base/AsyncCallQueue.cc:43
>> #12 0x00005576cf55f689 in EventLoop::dispatchCalls (this=0x7ffea5b885a0) at ./src/EventLoop.cc:144
>> #13 EventLoop::runOnce (this=this at entry=0x7ffea5b885a0) at ./src/EventLoop.cc:121
>> #14 0x00005576cf55f778 in EventLoop::run (this=this at entry=0x7ffea5b885a0) at ./src/EventLoop.cc:83
>> #15 0x00005576cf665a50 in SquidMain (argc=argc at entry=5, argv=argv at entry=0x7ffea5b88888) at ./src/main.cc:1719
>> #16 0x00005576cf4fdae1 in SquidMainSafe (argv=0x7ffea5b88888, argc=5) at ./src/main.cc:1406
>> #17 main (argc=5, argv=0x7ffea5b88888) at ./src/main.cc:1394
>>


From fgiorgetti at gmail.com  Wed Sep 27 19:48:35 2023
From: fgiorgetti at gmail.com (Fernando Giorgetti)
Date: Wed, 27 Sep 2023 16:48:35 -0300
Subject: [squid-users] TLS passthrough
Message-ID: <CADxZ=iVSpT0VYTZS0ZhnnQNP_1mg+PZNzGmWc9cR3mYnos1p_g@mail.gmail.com>

Hello,

I would like to know if it is possible to set up Squid to perform
TLS passthrough to a given backend, relaying TLS encrypted
traffic to the backend, similarly to what HAProxy does below?

https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough

I have tried a few different configurations using reverse proxy,
or peek and splice, but I could not make it work without providing
a valid HTTP request or a CONNECT request.

Thank you,
Fernando
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230927/9ba5d802/attachment.htm>

From Ralf.Hildebrandt at charite.de  Wed Sep 27 20:45:03 2023
From: Ralf.Hildebrandt at charite.de (Ralf Hildebrandt)
Date: Wed, 27 Sep 2023 22:45:03 +0200
Subject: [squid-users] no more cache_object://127.0.0.1/counters URL in 6.3?
Message-ID: <ZRSUT1cLeo3YTM5w@charite.de>

We're relying on 

/usr/bin/squidclient -h 127.0.0.1 -p 8080 cache_object://127.0.0.1/counters

for monitoring purposes and 6.3 reports an error when accessing that
resource:

2023/09/27 22:42:57| ERROR: Squid BUG: assurance failed: tok.skip(WellKnownUrlPathPrefix())
    exception location: cache_manager.cc(193) ParseUrl
    current master transaction: master59170

-- 
Ralf Hildebrandt
Charit? - Universit?tsmedizin Berlin
Gesch?ftsbereich IT | Abteilung Netz | Netzwerk-Administration
Invalidenstra?e 120/121 | D-10115 Berlin

Tel. +49 30 450 570 155
ralf.hildebrandt at charite.de
https://www.charite.de


From Ralf.Hildebrandt at charite.de  Wed Sep 27 20:49:59 2023
From: Ralf.Hildebrandt at charite.de (Ralf Hildebrandt)
Date: Wed, 27 Sep 2023 22:49:59 +0200
Subject: [squid-users] [ext] no more cache_object://127.0.0.1/counters
 URL in 6.3?
In-Reply-To: <ZRSUT1cLeo3YTM5w@charite.de>
References: <ZRSUT1cLeo3YTM5w@charite.de>
Message-ID: <ZRSVd0JuuUXev4ho@charite.de>

* Ralf Hildebrandt <Ralf.Hildebrandt at charite.de>:
> We're relying on 
> 
> /usr/bin/squidclient -h 127.0.0.1 -p 8080 cache_object://127.0.0.1/counters
> 
> for monitoring purposes and 6.3 reports an error when accessing that
> resource:
> 
> 2023/09/27 22:42:57| ERROR: Squid BUG: assurance failed: tok.skip(WellKnownUrlPathPrefix())
>     exception location: cache_manager.cc(193) ParseUrl
>     current master transaction: master59170

Found this
- Bug 4572: squidclient: Remove deprecated cache_object:// support

Ok, but this has been replaced by what?

-- 
Ralf Hildebrandt
Charit? - Universit?tsmedizin Berlin
Gesch?ftsbereich IT | Abteilung Netz | Netzwerk-Administration
Invalidenstra?e 120/121 | D-10115 Berlin

Tel. +49 30 450 570 155
ralf.hildebrandt at charite.de
https://www.charite.de


From rousskov at measurement-factory.com  Wed Sep 27 21:39:16 2023
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Wed, 27 Sep 2023 17:39:16 -0400
Subject: [squid-users] Seeking Help with SSL Bump Configuration,
 for ECDSA Ciphers in Squid
In-Reply-To: <CALO-o=x6bpei3Q8zuVW1upgCFAQ0ExpQhc2AW8NjQSiF77whTg@mail.gmail.com>
References: <mailman.3.1695643202.1139032.squid-users@lists.squid-cache.org>
 <CALO-o=x6bpei3Q8zuVW1upgCFAQ0ExpQhc2AW8NjQSiF77whTg@mail.gmail.com>
Message-ID: <ebd77b31-d10f-4508-8541-e2131a4877d9@measurement-factory.com>

On 2023-09-27 08:22, nikhil deshpande wrote:

> [Question]: Are you trying to bump TLS client connections when and only when the TLS
> client is offering to use one of those ciphers in its ClientHello
> message? Or do you want Squid to use one of those ciphers when bumping
> all TLS client connections? Or something else? Please clarify.
> 
> [Answer]:In our case client is offering these two 
> ciphers (ECDHE-ECDSA-AES256-GCM-SHA384 & 
> ECDHE-ECDSA-AES128-GCM-SHA256) in Client Hello but squid is failing 
> to complete handshake with client while performing SSL-Bump.
> 
> We have attached logs and network capture.


Thank you for sharing that information!

If I start "openssl s_server" configured with the certificate generated 
by Squid (as extracted from your debugging log), then that server 
rejects an "openssl s_client" TLS ClientHello offering the two TLS v1.2 
ciphers you have mentioned above. The server error in this case is "no 
shared cipher".

If I remove the cipher restriction from the client, the test connection 
succeeds. The negotiated cipher in this case is not one of the two:
ECDHE-RSA-AES256-GCM-SHA384

This is not my area of expertise, but I believe that the certificate 
generated by Squid (and mimicking true origin server certificate 
properties) is not compatible with ciphers supported by the client: The 
ciphers want ECDSA certificate authentication algorithm, but the 
generated certificate uses RSA authentication. The two sides cannot 
communicate because they do not share an authentication algorithm.

     Public Key Algorithm: rsaEncryption


BTW, I get similar results when s_client talks to the true origin server 
in question _without_ restricting s_client ciphers: Successful TLS with 
ECDHE-RSA-AES256-GCM-SHA384 cipher.

If I do restrict s_client ciphers when talking to true origin server, 
then the test transaction also succeeds, but the server returns a 
different certificate and a different cipher is negotiated:
ECDHE-ECDSA-AES256-GCM-SHA384. In this case, the certificate says:

     Public Key Algorithm: id-ecPublicKey

These true origin server experiments support my explanation above.


Why does the origin server send Squid a certificate that the client does 
not support? I believe that happens because Squid _adds_ client cipher 
to Squid-generated ClientHello: Your packet capture does show the two 
client ciphers in from-Squid ClientHello, but that ClientHello has 29 
other ciphers as well! The origin server then picks a different cipher 
offered by Squid and sends a matching server certificate (the one the 
client cannot support).


Going forward, I see two possible options, both requiring non-trivial 
Squid source code modifications:


1. Stop adding OpenSSL ciphers to mimicked ClientHello

I speculate that if Squid were to exactly mimic client cipher offerings 
in its ClientHello sent to the origin server (instead of adding 
client-supported ciphers to OpenSSL-supported ones), then the origin 
server would have returned a different certificate, Squid would have 
mimicked that, and the client-Squid TLS connection would have succeeded.

I do not know whether there are cases where mimicking the client ciphers 
exactly would prevent Squid from successfully bumping the connection.

I do not know how easy it would be for Squid to stop OpenSSL from adding 
all supported ciphers.


2. Mimic origin certificate to be compatible with client ciphers.

For example, when the two algorithms differ, instead of mimicking the 
certificate authentication algorithm in the origin server certificate, 
use the algorithm compatible with client-offered ciphers.

Doing so will allow Squid to bump more connections, and even increase 
security guarantees in some cases (where the algorithm used by the 
server is weaker than what client and Squid can support), but may also 
weaken security guarantees in some cases (in opposite cases).


Others on this mailing list may suggest better alternatives.


https://wiki.squid-cache.org/SquidFaq/AboutSquid#how-to-add-a-new-squid-feature-enhance-of-fix-something



> [Question]: FWIW, to restrict Squid use of ciphers on accepted TLS client 
> connections, use the http_port (or https_port) "cipher" option.
> 
> [Answer]: We dontwant to restrict to usethisspecific ciphers only. We
> wanted that Squid should use strong ciphers.

Squid cannot use strong ciphers with the client (_and_ bump the 
connection). If you want Squid to always use strong ciphers with the 
server, but still bump the weaker client connection, then you need a 
combination of two things (at least) AFAICT:

* Option 2 above (Mimic origin certificate to be client-compatible)
* tls_outgoing_options that prohibit weak ciphers (already supported?)


> One more point I wanted to add here is that this issue is getting 
> reproduced with latest squid also.

Yes, the problem you are facing affects all moderns Squids AFAICT.


Please respond to the _individual_ mailing list message on your thread, 
not the digest with all the messages.


Thank you,

Alex.

>     Message: 3
>     Date: Mon, 25 Sep 2023 15:01:05 +0530
>     From: nikhil deshpande <nikhildeshpande18 at gmail.com
>     <mailto:nikhildeshpande18 at gmail.com>>
>     To: Shyam varun <shyam3898 at gmail.com <mailto:shyam3898 at gmail.com>>
>     Cc: squid-users at lists.squid-cache.org
>     <mailto:squid-users at lists.squid-cache.org>, jrose at qualys.com
>     <mailto:jrose at qualys.com>
>     Subject: Re: [squid-users] Seeking Help with SSL Bump Configuration
>      ? ? ? ? for ECDSA Ciphers in Squid
>     Message-ID:
>             
>     <CALO-o=xTe18tuGww-gsr-vAVKMJqRai1ZvNR-hRqaToWXp1NGQ at mail.gmail.com
>     <mailto:xTe18tuGww-gsr-vAVKMJqRai1ZvNR-hRqaToWXp1NGQ at mail.gmail.com>>
>     Content-Type: text/plain; charset="utf-8"
> 
>     Hi team,
> 
>     Any update on this?
> 
>     Regards,
>     Nikhil
> 
>     On Thu, Sep 14, 2023 at 6:05?PM Shyam varun <shyam3898 at gmail.com
>     <mailto:shyam3898 at gmail.com>> wrote:
> 
>      > Dear Squid Mailing List Community,
>      >
>      > I hope this email finds you well. I am currently working on
>     configuring
>      > SSL bump in Squid proxy server to support ECDSA ciphers, and I am
>     seeking
>      > assistance with a particular issue I've encountered.
>      >
>      > To provide some context:
>      >
>      > - *Squid Version:* Squid 5.2
>      > - *OpenSSL Version*: OpenSSL 1.1.1l
>      > - *OS:* Alpine Linux v3.16
>      > -
>      > *Squid Configuration: *
>      >
>      > * sslproxy_cert_error allow all*
>      >
>      > * sslcrtd_program /usr/lib/squid/security_file_certgen -s
>     /var/lib/ssl_db
>      > -M 4MB*
>      >
>      >
>      > * http_port 3129 ssl-bump generate-host-certificates=on
>      > dynamic_cert_mem_cache_size=4MB
>     cert=/opt/ssl/intermediate_certificate.pem
>      > key=/opt/ssl/intermediate_key.pem
>     options=SINGLE_DH_USE,SINGLE_ECDH_USE
>      > tls-dh=/opt/dhparam.pem*
>      >
>      >
>      > * tls_outgoing_options min-version=1.1? options=NO_SSLv3*
>      >
>      >
>      > * acl step1 at_step SslBump1*
>      >
>      > * ssl_bump peek step1*
>      >
>      > * ssl_bump bump all*
>      >
>      >
>      > The goal of my configuration is to enable SSL bump for ECDSA ciphers,
>      > specifically the "ECDHE-ECDSA-AES256-GCM-SHA384" and
>      > "ECDHE-ECDSA-AES128-GCM-SHA256" cipher suites. However, I've run into
>      > challenges and issues while trying to achieve this.
>      >
>      > *Things I tried:*
>      >
>      >? ? 1. I created an ECDSA-based certificate chain using OpenSSL.
>      >? ? 2. I configured the ECDSA-based certificate certs in squid as
>     shown in
>      >? ? above snippet but still not able to make it work.
>      >
>      >
>      > I've thoroughly reviewed the Squid documentation and online
>     resources, but
>      > I haven't been able to resolve these issues on my own.
>      >
>      > I would greatly appreciate any guidance, insights, or assistance
>     from the
>      > Squid community regarding the proper configuration for SSL bump
>     with ECDSA
>      > ciphers. If you have successfully configured Squid to support
>     ECDSA ciphers
>      > or if you have expertise in this area, your input would be
>     invaluable.
>      >
>      > Thank you in advance for your time and support. I look forward to
>     your
>      > responses and insights.
>      >
> 
>     End of squid-users Digest, Vol 109, Issue 19
>     ********************************************



From rousskov at measurement-factory.com  Wed Sep 27 21:49:09 2023
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Wed, 27 Sep 2023 17:49:09 -0400
Subject: [squid-users] SIGABRT (coredump) in
 Ip::Address::getAddrInfo(addrinfo*&, int)
In-Reply-To: <8df1661b-4709-5a9d-21d6-a7d811e86b70@mail.ru>
References: <e88e095d-9faf-c287-15e2-4ae2ac119337@mail.ru>
 <f8dc78b4-9e6a-4aed-be04-48c0dac40ac8@measurement-factory.com>
 <8df1661b-4709-5a9d-21d6-a7d811e86b70@mail.ru>
Message-ID: <4f419f27-e518-42ea-b069-54635f8696cc@measurement-factory.com>

On 2023-09-27 15:43, Dmitry Katsubo wrote:
> On 2023-09-27 19:15, Alex Rousskov wrote:
>> On 2023-09-27 11:08, Dmitry Katsubo wrote:
>>
>>> After upgrading Squid from v4.13-10+deb11u2 (bullseye) to v5.7-2
>>> (bookworm) I started to get about 5 core dumps per day like below, provided .
>>> How can I find out the root of the problem and eliminate it?
>>
>>
>> Your Squid is most likely suffering (among other v5 bugs) from Squid Bug
>> 5154: https://bugs.squid-cache.org/show_bug.cgi?id=5154
>>
>> There is currently no fix for that bug (that I can recommend without serious caveats). There has been significant progress towards a fix, but it may have stalled at
>> https://github.com/squid-cache/squid/pull/1421
>>
>> The best known way to prevent bug 5154 is to enable IPv6 support, but that is not feasible in many environments.
>>
>> Another Squid admin has reported success with an unofficial (and probably incomplete) workaround at https://lists.squid-cache.org/pipermail/squid-users/2023-September/026103.html


> Debain sid has v6.1-2, which I believe is also affected, hence no reason to try it ?

Your call. I believe Squid v6 has fixed several bugs that are still 
present in v5.


> After reading the bug#5154 description I see that the issue is because of disabled IPv6, in my case, via sysctl:
> 
> net.ipv6.conf.default.disable_ipv6=1
> net.ipv6.conf.all.disable_ipv6=1
> 
> I believe re-enabling IPV6 should help the issue? 

If Squid successfully detects IPv6 support, then bug 5154 crashes should 
go away. If Squid does not, it should log a message to cache.log that 
starts with "WARNING: BCP 177 violation"


> I have checked why I have disabled it ... and it turned out that was an advise to fix the following error message in /var/log/squid/cache.log:
> 
> SendEcho ERROR: sending to ICMPv6 packet to [2606:4700:e0::ac40:6225]: (101) Network is unreachable
> 
> ? Boomerang has returned.

I have not studied that ICMP problem, but it might have a solution that 
does not involve disabling IPv6 support. The latter, as it turns out, 
opens a rather large Pandora box!


HTH,

Alex.


>>> # coredumpctl gdb -1 --no-pager
>>>  ??????????? PID: 357187 (squid)
>>>  ??????????? UID: 13 (proxy)
>>>  ??????????? GID: 13 (proxy)
>>>  ???????? Signal: 6 (ABRT)
>>>  ????? Timestamp: Wed 2023-09-27 11:27:08 CEST (5h 16min ago)
>>>  ?? Command Line: $'(squid-1)' --kid squid-1 --foreground -sYC
>>>  ???? Executable: /usr/sbin/squid
>>>  ? Control Group: /system.slice/squid.service
>>>  ?????????? Unit: squid.service
>>>  ????????? Slice: system.slice
>>>  ??????? Storage: /var/lib/systemd/coredump/core.squid.13.f7e894167d564f788825cae8827bd2df.357187.1695806828000000.zst (present)
>>>  ?? Size on Disk: 2.5M
>>>  ??????? Message: Process 357187 (squid) of user 13 dumped core.
>>>
>>>  ???????????????? Module libsystemd.so.0 from deb systemd-252.12-1~deb12u1.amd64
>>>  ???????????????? Stack trace of thread 357187:
>>>  ???????????????? #0? 0x00007f752b2a9d3c n/a (libc.so.6 + 0x8ad3c)
>>>  ???????????????? #1? 0x00007f752b25af32 raise (libc.so.6 + 0x3bf32)
>>>  ???????????????? #2? 0x00007f752b245472 abort (libc.so.6 + 0x26472)
>>>  ???????????????? #3? 0x00007f752b245395 n/a (libc.so.6 + 0x26395)
>>>  ???????????????? #4? 0x00007f752b253e32 __assert_fail (libc.so.6 + 0x34e32)
>>>  ???????????????? #5? 0x00005576cf7c0ee4 _ZNK2Ip7Address11getAddrInfoERP8addrinfoi (squid + 0x466ee4)
>>>  ???????????????? #6? 0x00005576cf7bc3c5 _Z11comm_openexiiRN2Ip7AddressEiPKc (squid + 0x4623c5)
>>>  ???????????????? #7? 0x00005576cf80fdfe _ZN4Comm10ConnOpener8createFdEv (squid + 0x4b5dfe)
>>>  ???????????????? #8? 0x00005576cf8109c1 _ZN4Comm10ConnOpener5startEv (squid + 0x4b69c1)
>>>  ???????????????? #9? 0x00005576cf7ab09c _ZN9JobDialerI8AsyncJobE4dialER9AsyncCall (squid + 0x45109c)
>>>  ???????????????? #10 0x00005576cf7a779f _ZN14AsyncCallQueue8fireNextEv (squid + 0x44d79f)
>>>  ???????????????? #11 0x00005576cf7a7b52 _ZN14AsyncCallQueue4fireEv (squid + 0x44db52)
>>>  ???????????????? #12 0x00005576cf55f689 _ZN9EventLoop7runOnceEv (squid + 0x205689)
>>>  ???????????????? #13 0x00005576cf55f778 _ZN9EventLoop3runEv (squid + 0x205778)
>>>  ???????????????? #14 0x00005576cf665a50 _Z9SquidMainiPPc (squid + 0x30ba50)
>>>  ???????????????? #15 0x00005576cf4fdae1 main (squid + 0x1a3ae1)
>>>  ???????????????? #16 0x00007f752b2461ca n/a (libc.so.6 + 0x271ca)
>>>  ???????????????? #17 0x00007f752b246285 __libc_start_main (libc.so.6 + 0x27285)
>>>  ???????????????? #18 0x00005576cf505cc1 _start (squid + 0x1abcc1)
>>>  ???????????????? ELF object binary architecture: AMD x86-64
>>>
>>> GNU gdb (Debian 13.1-3) 13.1
>>> Reading symbols from /usr/sbin/squid...
>>> (No debugging symbols found in /usr/sbin/squid)
>>> [New LWP 357187]
>>> [Thread debugging using libthread_db enabled]
>>> Using host libthread_db library "/lib/x86_64-linux-gnu/libthread_db.so.1".
>>> Core was generated by `(squid-1) --kid squid-1 --foreground -sYC'.
>>> Program terminated with signal SIGABRT, Aborted.
>>> (gdb) bt
>>> #0? 0x00007f752b2a9d3c in ?? () from /lib/x86_64-linux-gnu/libc.so.6
>>> #1? 0x00007f752b25af32 in raise () from /lib/x86_64-linux-gnu/libc.so.6
>>> #2? 0x00007f752b245472 in abort () from /lib/x86_64-linux-gnu/libc.so.6
>>> #3? 0x00007f752b245395 in ?? () from /lib/x86_64-linux-gnu/libc.so.6
>>> #4? 0x00007f752b253e32 in __assert_fail () from /lib/x86_64-linux-gnu/libc.so.6
>>> #5? 0x00005576cf7c0ee4 in Ip::Address::getAddrInfo (this=this at entry=0x5576d2407a98, dst=@0x7ffea5b87f90: 0x5576d2a8af00, force=force at entry=0) at ./src/ip/Address.cc:663
>>> #6? 0x00005576cf7bc3c5 in comm_openex (sock_type=sock_type at entry=1, proto=proto at entry=6, addr=..., flags=1, note=0x5576d2ab0cd0 "[2a03:2880:f273:c8:face:b00c:0:167]") at ./src/comm.cc:347
>>> #7? 0x00005576cf80fdfe in Comm::ConnOpener::createFd (this=this at entry=0x5576d2a86bc8) at ./src/comm/ConnOpener.cc:288
>>> #8? 0x00005576cf8109c1 in Comm::ConnOpener::start (this=0x5576d2a86bc8) at ./src/comm/ConnOpener.cc:261
>>> #9? 0x00005576cf7ab09c in JobDialer<AsyncJob>::dial (this=0x5576d1e16558, call=...) at ../../src/base/AsyncJobCalls.h:175
>>> #10 0x00005576cf7a779f in AsyncCallQueue::fireNext (this=this at entry=0x5576d1abbae0) at ./src/base/AsyncCallQueue.cc:60
>>> #11 0x00005576cf7a7b52 in AsyncCallQueue::fire (this=0x5576d1abbae0) at ./src/base/AsyncCallQueue.cc:43
>>> #12 0x00005576cf55f689 in EventLoop::dispatchCalls (this=0x7ffea5b885a0) at ./src/EventLoop.cc:144
>>> #13 EventLoop::runOnce (this=this at entry=0x7ffea5b885a0) at ./src/EventLoop.cc:121
>>> #14 0x00005576cf55f778 in EventLoop::run (this=this at entry=0x7ffea5b885a0) at ./src/EventLoop.cc:83
>>> #15 0x00005576cf665a50 in SquidMain (argc=argc at entry=5, argv=argv at entry=0x7ffea5b88888) at ./src/main.cc:1719
>>> #16 0x00005576cf4fdae1 in SquidMainSafe (argv=0x7ffea5b88888, argc=5) at ./src/main.cc:1406
>>> #17 main (argc=5, argv=0x7ffea5b88888) at ./src/main.cc:1394
>>>



From rousskov at measurement-factory.com  Wed Sep 27 22:26:05 2023
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Wed, 27 Sep 2023 18:26:05 -0400
Subject: [squid-users] [ext] no more cache_object://127.0.0.1/counters
 URL in 6.3?
In-Reply-To: <ZRSVd0JuuUXev4ho@charite.de>
References: <ZRSUT1cLeo3YTM5w@charite.de> <ZRSVd0JuuUXev4ho@charite.de>
Message-ID: <70c4012f-6890-453c-abeb-9ef71b1ac3f7@measurement-factory.com>

On 2023-09-27 16:49, Ralf Hildebrandt wrote:
> * Ralf Hildebrandt <Ralf.Hildebrandt at charite.de>:
>> We're relying on
>>
>> /usr/bin/squidclient -h 127.0.0.1 -p 8080 cache_object://127.0.0.1/counters
>>
>> for monitoring purposes and 6.3 reports an error when accessing that
>> resource:
>>
>> 2023/09/27 22:42:57| ERROR: Squid BUG: assurance failed: tok.skip(WellKnownUrlPathPrefix())
>>      exception location: cache_manager.cc(193) ParseUrl
>>      current master transaction: master59170

That bug has been fixed in master/v7. For details, including confusing 
v6.3 status and a v6.3 patch, please see the beginning of 
https://lists.squid-cache.org/pipermail/squid-users/2023-September/026093.html


> Found this
> - Bug 4572: squidclient: Remove deprecated cache_object:// support
> 
> Ok, but this has been replaced by what?


Short answer: Use `squidclient ... mgr:counters`

Long answer: For a long time, squidclient has supported two cache 
manager protocols (or two URI schemes): Deprecated cache_object and 
regular http (with a well-known URL path prefix). It now relies on the 
latter exclusively.

The "mgr:foo" shorthand used to expand to cache_object://host/foo
It now expands to http://host/squid-internal-mgr/foo
You are welcome to use the latter explicitly if you prefer.


HTH,

Alex.



From bud_miljkovic at trimble.com  Thu Sep 28 04:52:07 2023
From: bud_miljkovic at trimble.com (Bud Miljkovic)
Date: Thu, 28 Sep 2023 17:52:07 +1300
Subject: [squid-users] No valid signing SSL certificate configured for
 HTTPS_port
Message-ID: <CAPO8no+6a85GiO9eQK=9q6jdbcZoCcdHSz7zBRF2oCQYAVOWDw@mail.gmail.com>

Would you know anything about this Squid problem?
Given the squid-ota.conf file:
```
# An ACL named 'whitelist'
acl whitelist dstdomain '/etc/squid/whitelist.ota'

# Allow whitelisted URLs through
http_access allow whitelist

# Block the rest
http_access deny all

# Intercept tranparent HTTPS traffic
https_port 3129 intercept ssl-bump ssl_bump splice all

# Send out HTTPS trafic to destination server
tcp_outgoing_address 10.3.16.51

# Add certificate
https_port 3129 intercept ssl-bump \
   cert=/etc/squid/ssl_cert/myCA.pem \
   generate-host-certificates=on dynamic_cert_mem_cache_size=4MB

sslcrtd_program /usr/local/squid/libexec/ssl_crtd -s /var/lib/ssl_db -M 4MB

#Visible hostname
visible_hostname ctct-r2
```
When the `squid.service` is started the following output is printed:

```
Sep 28 16:17:04 ctct-r2 systemd[1]: Started Squid Proxy Server (OTA Mode).
Sep 28 16:17:04 ctct-r2 squid[1059]: No valid signing SSL certificate
configured for HTTPS_port [::]:3129
Sep 28 16:17:04 ctct-r2 squid[1059]: FATAL: No valid signing SSL
certificate configured for HTTPS_port [::]:3129
Sep 28 16:17:04 ctct-r2 squid[1059]: Squid Cache (Version 3.5.25):
Terminated abnormally.
Sep 28 16:17:04 ctct-r2 squid[1059]: CPU Usage: 0.040 seconds = 0.030 user
+ 0.010 sys
Sep 28 16:17:04 ctct-r2 squid[1059]: Maximum Resident Size: 38656 KB
```
Any lead is greatly appreciated.

Buda



-- 
Budimir Miljkovi? BSc E | He
Senior Development Engineer
Civil Construction Field Systems
Trimble

11-17 Birmingham Drive, Christchurch, Canterbury, 8024
New Zealand
+64 3 963-5550 Direct
+64 21 419-024 Mobile

www.trimble.com

This email may contain confidential information that is intended only for
the listed recipient(s) of this email. Any unauthorized review, use,
disclosure or distribution is prohibited. If you believe you have received
this email in error, please immediately delete this email and any
attachments, and inform me via reply email.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230928/247a8810/attachment.htm>

From uhlar at fantomas.sk  Thu Sep 28 06:41:25 2023
From: uhlar at fantomas.sk (Matus UHLAR - fantomas)
Date: Thu, 28 Sep 2023 08:41:25 +0200
Subject: [squid-users] TLS passthrough
In-Reply-To: <CADxZ=iVSpT0VYTZS0ZhnnQNP_1mg+PZNzGmWc9cR3mYnos1p_g@mail.gmail.com>
References: <CADxZ=iVSpT0VYTZS0ZhnnQNP_1mg+PZNzGmWc9cR3mYnos1p_g@mail.gmail.com>
Message-ID: <ZRUgFYjFwpnK8hdO@fantomas.sk>

On 27.09.23 16:48, Fernando Giorgetti wrote:
>I would like to know if it is possible to set up Squid to perform
>TLS passthrough to a given backend, relaying TLS encrypted
>traffic to the backend, similarly to what HAProxy does below?
>
>https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough
>
>I have tried a few different configurations using reverse proxy,
>or peek and splice, but I could not make it work without providing
>a valid HTTP request or a CONNECT request.

what's the difference between TCP redirect and this?

-- 
Matus UHLAR - fantomas, uhlar at fantomas.sk ; http://www.fantomas.sk/
Warning: I wish NOT to receive e-mail advertising to this address.
Varovanie: na tuto adresu chcem NEDOSTAVAT akukolvek reklamnu postu.
Depression is merely anger without enthusiasm.


From uhlar at fantomas.sk  Thu Sep 28 07:01:44 2023
From: uhlar at fantomas.sk (Matus UHLAR - fantomas)
Date: Thu, 28 Sep 2023 09:01:44 +0200
Subject: [squid-users] SIGABRT (coredump) in
 Ip::Address::getAddrInfo(addrinfo*&, int)
In-Reply-To: <f8dc78b4-9e6a-4aed-be04-48c0dac40ac8@measurement-factory.com>
References: <e88e095d-9faf-c287-15e2-4ae2ac119337@mail.ru>
 <f8dc78b4-9e6a-4aed-be04-48c0dac40ac8@measurement-factory.com>
Message-ID: <ZRUk2KvHO6Zx4kdJ@fantomas.sk>

>On 2023-09-27 11:08, Dmitry Katsubo wrote:
>
>>After upgrading Squid from v4.13-10+deb11u2 (bullseye) to v5.7-2
>>(bookworm) I started to get about 5 core dumps per day like below.
>
>>How can I find out the root of the problem and eliminate it?


On 27.09.23 13:15, Alex Rousskov wrote:
>Your Squid is most likely suffering (among other v5 bugs) from Squid Bug
>5154: https://bugs.squid-cache.org/show_bug.cgi?id=5154
>
>There is currently no fix for that bug (that I can recommend without 
>serious caveats). There has been significant progress towards a fix, 
>but it may have stalled at 
>https://github.com/squid-cache/squid/pull/1421
>
>The best known way to prevent bug 5154 is to enable IPv6 support, but 
>that is not feasible in many environments.
>
>Another Squid admin has reported success with an unofficial (and 
>probably incomplete) workaround at https://lists.squid-cache.org/pipermail/squid-users/2023-September/026103.html

from the mail:

acl urldst_ipv6 url_regex ^http://\[
http_access deny urldst_ipv6

I believe it should be replaced by dstdom_regex.

-- 
Matus UHLAR - fantomas, uhlar at fantomas.sk ; http://www.fantomas.sk/
Warning: I wish NOT to receive e-mail advertising to this address.
Varovanie: na tuto adresu chcem NEDOSTAVAT akukolvek reklamnu postu.
Quantum mechanics: The dreams stuff is made of.


From Ralf.Hildebrandt at charite.de  Thu Sep 28 07:11:29 2023
From: Ralf.Hildebrandt at charite.de (Ralf Hildebrandt)
Date: Thu, 28 Sep 2023 09:11:29 +0200
Subject: [squid-users] [ext] no more cache_object://127.0.0.1/counters
 URL in 6.3?
In-Reply-To: <70c4012f-6890-453c-abeb-9ef71b1ac3f7@measurement-factory.com>
References: <ZRSUT1cLeo3YTM5w@charite.de> <ZRSVd0JuuUXev4ho@charite.de>
 <70c4012f-6890-453c-abeb-9ef71b1ac3f7@measurement-factory.com>
Message-ID: <ZRUnIZd5VYIedQUQ@charite.de>

* Alex Rousskov <rousskov at measurement-factory.com>:

> > > 2023/09/27 22:42:57| ERROR: Squid BUG: assurance failed: tok.skip(WellKnownUrlPathPrefix())
> > >      exception location: cache_manager.cc(193) ParseUrl
> > >      current master transaction: master59170
> 
> That bug has been fixed in master/v7. For details, including confusing v6.3
> status and a v6.3 patch, please see the beginning of https://lists.squid-cache.org/pipermail/squid-users/2023-September/026093.html

...

> Short answer: Use `squidclient ... mgr:counters`

Ah, much better. Now I'm getting access denied, which is way better.
 
> Long answer: For a long time, squidclient has supported two cache manager
> protocols (or two URI schemes): Deprecated cache_object and regular http
> (with a well-known URL path prefix). It now relies on the latter
> exclusively.

Good. I figured as much, but wasn't able to find the "new style"
 
> The "mgr:foo" shorthand used to expand to cache_object://host/foo
> It now expands to http://host/squid-internal-mgr/foo
> You are welcome to use the latter explicitly if you prefer.

Indeed, I'm now using curl with the URL http://host/squid-internal-mgr/foo


-- 
Ralf Hildebrandt
Charit? - Universit?tsmedizin Berlin
Gesch?ftsbereich IT | Abteilung Netz | Netzwerk-Administration
Invalidenstra?e 120/121 | D-10115 Berlin

Tel. +49 30 450 570 155
ralf.hildebrandt at charite.de
https://www.charite.de


From fgiorgetti at gmail.com  Thu Sep 28 13:06:33 2023
From: fgiorgetti at gmail.com (Fernando Giorgetti)
Date: Thu, 28 Sep 2023 10:06:33 -0300
Subject: [squid-users] TLS passthrough
In-Reply-To: <ZRUgFYjFwpnK8hdO@fantomas.sk>
References: <CADxZ=iVSpT0VYTZS0ZhnnQNP_1mg+PZNzGmWc9cR3mYnos1p_g@mail.gmail.com>
 <ZRUgFYjFwpnK8hdO@fantomas.sk>
Message-ID: <CADxZ=iWnO0mUnUhC6cNV48wH5ET_kChZi=rgCy--9zDbwWgqwg@mail.gmail.com>

Hi Matus, do you mean something like a DNAT (iptables) rule?
If so, I would say, it should work as well.

But this is an environment I do not control, and I have been told to try
using an existing squid installation to proxy non-http/TLS data through.

I appreciate any guidance or recommendation.

Thank you,
Fernando

On Thu, Sep 28, 2023 at 3:41?AM Matus UHLAR - fantomas <uhlar at fantomas.sk>
wrote:

> On 27.09.23 16:48, Fernando Giorgetti wrote:
> >I would like to know if it is possible to set up Squid to perform
> >TLS passthrough to a given backend, relaying TLS encrypted
> >traffic to the backend, similarly to what HAProxy does below?
> >
> >
> https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough
> >
> >I have tried a few different configurations using reverse proxy,
> >or peek and splice, but I could not make it work without providing
> >a valid HTTP request or a CONNECT request.
>
> what's the difference between TCP redirect and this?
>
> --
> Matus UHLAR - fantomas, uhlar at fantomas.sk ; http://www.fantomas.sk/
> Warning: I wish NOT to receive e-mail advertising to this address.
> Varovanie: na tuto adresu chcem NEDOSTAVAT akukolvek reklamnu postu.
> Depression is merely anger without enthusiasm.
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> https://lists.squid-cache.org/listinfo/squid-users
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230928/7a74ca3e/attachment.htm>

From uhlar at fantomas.sk  Thu Sep 28 13:36:05 2023
From: uhlar at fantomas.sk (Matus UHLAR - fantomas)
Date: Thu, 28 Sep 2023 15:36:05 +0200
Subject: [squid-users] TLS passthrough
In-Reply-To: <CADxZ=iWnO0mUnUhC6cNV48wH5ET_kChZi=rgCy--9zDbwWgqwg@mail.gmail.com>
References: <CADxZ=iVSpT0VYTZS0ZhnnQNP_1mg+PZNzGmWc9cR3mYnos1p_g@mail.gmail.com>
 <ZRUgFYjFwpnK8hdO@fantomas.sk>
 <CADxZ=iWnO0mUnUhC6cNV48wH5ET_kChZi=rgCy--9zDbwWgqwg@mail.gmail.com>
Message-ID: <ZRWBRVUOALhjvAKa@fantomas.sk>

On 28.09.23 10:06, Fernando Giorgetti wrote:
>Hi Matus, do you mean something like a DNAT (iptables) rule?

that was my question.

>If so, I would say, it should work as well.

If you want simply redirect incoming connections to another IP/port, port 
redirector should work just like DNAT.

>But this is an environment I do not control, and I have been told to try
>using an existing squid installation to proxy non-http/TLS data through.
>
>I appreciate any guidance or recommendation.

SQUID however does not have this functionality, packages like 
redir, rinetd, or xinetd do have it.


>On Thu, Sep 28, 2023 at 3:41?AM Matus UHLAR - fantomas <uhlar at fantomas.sk>
>wrote:
>
>> On 27.09.23 16:48, Fernando Giorgetti wrote:
>> >I would like to know if it is possible to set up Squid to perform
>> >TLS passthrough to a given backend, relaying TLS encrypted
>> >traffic to the backend, similarly to what HAProxy does below?
>> >
>> >
>> https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough
>> >
>> >I have tried a few different configurations using reverse proxy,
>> >or peek and splice, but I could not make it work without providing
>> >a valid HTTP request or a CONNECT request.
>>
>> what's the difference between TCP redirect and this?


-- 
Matus UHLAR - fantomas, uhlar at fantomas.sk ; http://www.fantomas.sk/
Warning: I wish NOT to receive e-mail advertising to this address.
Varovanie: na tuto adresu chcem NEDOSTAVAT akukolvek reklamnu postu.
Windows found: (R)emove, (E)rase, (D)elete


From rousskov at measurement-factory.com  Thu Sep 28 14:51:06 2023
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Thu, 28 Sep 2023 10:51:06 -0400
Subject: [squid-users] TLS passthrough
In-Reply-To: <CADxZ=iWnO0mUnUhC6cNV48wH5ET_kChZi=rgCy--9zDbwWgqwg@mail.gmail.com>
References: <CADxZ=iVSpT0VYTZS0ZhnnQNP_1mg+PZNzGmWc9cR3mYnos1p_g@mail.gmail.com>
 <ZRUgFYjFwpnK8hdO@fantomas.sk>
 <CADxZ=iWnO0mUnUhC6cNV48wH5ET_kChZi=rgCy--9zDbwWgqwg@mail.gmail.com>
Message-ID: <42994367-b30d-443b-b88c-8df94a5632ff@measurement-factory.com>

On 2023-09-28 09:06, Fernando Giorgetti wrote:
> Hi Matus, do you mean something like a DNAT (iptables) rule?
> If so, I would say, it should work as well.
> 
> But this is an environment I do not control, and I have been told to try
> using an existing squid installation to proxy non-http/TLS data through.
> 
> I appreciate any guidance or recommendation.


Bugs notwithstanding, Squid can blindly tunnel intercepted (at TCP port 
X) TCP traffic to its intended destination:

     https_port X intercept ssl-bump ...
     ssl_bump splice all


Without interception, then Squid can only tunnel stuff inside HTTP 
CONNECT tunnels (for HTTP CONNECT requests received at TCP port Y):

     http_port Y ssl-bump ...
     ssl_bump splice all


In both cases, Squid does not care about the protocols that tunneled 
traffic is using. It could be HTTP, HTTPS, TLS, or anything else on top 
of TCP.

Your ACLs may differ from "all" in the above sketches, of course, but if 
traffic is not TLS, then you want an "ssl_bump splice" rule that matches 
during SslBump step1. A rule with an "all" ACLs is the simplest example 
of that.


HTH,

Alex.
P.S. I am getting an "Internal Server Error" when following the haproxy 
link in the original question, so I cannot map what that page says to 
the configurations above.


> On Thu, Sep 28, 2023 at 3:41?AM Matus UHLAR - fantomas wrote:
> 
>     On 27.09.23 16:48, Fernando Giorgetti wrote:
>      >I would like to know if it is possible to set up Squid to perform
>      >TLS passthrough to a given backend, relaying TLS encrypted
>      >traffic to the backend, similarly to what HAProxy does below?
>      >
>      >https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough <https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough>
>      >
>      >I have tried a few different configurations using reverse proxy,
>      >or peek and splice, but I could not make it work without providing
>      >a valid HTTP request or a CONNECT request.
> 
>     what's the difference between TCP redirect and this?
> 
>     -- 
>     Matus UHLAR - fantomas, uhlar at fantomas.sk <mailto:uhlar at fantomas.sk>
>     ; http://www.fantomas.sk/ <http://www.fantomas.sk/>
>     Warning: I wish NOT to receive e-mail advertising to this address.
>     Varovanie: na tuto adresu chcem NEDOSTAVAT akukolvek reklamnu postu.
>     Depression is merely anger without enthusiasm.
>     _______________________________________________
>     squid-users mailing list
>     squid-users at lists.squid-cache.org
>     <mailto:squid-users at lists.squid-cache.org>
>     https://lists.squid-cache.org/listinfo/squid-users
>     <https://lists.squid-cache.org/listinfo/squid-users>
> 
> 
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> https://lists.squid-cache.org/listinfo/squid-users



From rousskov at measurement-factory.com  Thu Sep 28 14:58:52 2023
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Thu, 28 Sep 2023 10:58:52 -0400
Subject: [squid-users] No valid signing SSL certificate configured for
 HTTPS_port
In-Reply-To: <CAPO8no+6a85GiO9eQK=9q6jdbcZoCcdHSz7zBRF2oCQYAVOWDw@mail.gmail.com>
References: <CAPO8no+6a85GiO9eQK=9q6jdbcZoCcdHSz7zBRF2oCQYAVOWDw@mail.gmail.com>
Message-ID: <25889ddc-fb00-465c-bfe7-adbe5793511a@measurement-factory.com>

On 2023-09-28 00:52, Bud Miljkovic wrote:

> # Intercept tranparent HTTPS traffic
> https_port 3129 intercept ssl-bump ssl_bump splice all

This should be refactored into two lines:

     https_port 3129 intercept ssl-bump ...
     ssl_bump splice all

After that, replace "..." above with cert=... and, optionally, other 
ssl-bump parameters from your other "https_port 3129" line below.


> # Add certificate
> https_port 3129 intercept ssl-bump ...

Remove these lines: The https_port directive does not support "adding" 
options to previously configured port. Use a single https_port directive 
per port. Same for http_port, of course.


HTH,

Alex.


> https_port 3129 intercept ssl-bump \
>  ?? cert=/etc/squid/ssl_cert/myCA.pem \
>  ?? generate-host-certificates=on dynamic_cert_mem_cache_size=4MB
> 
> sslcrtd_program /usr/local/squid/libexec/ssl_crtd -s /var/lib/ssl_db -M 4MB
> 
> #Visible hostname
> visible_hostname ctct-r2
> ```
> When the `squid.service` is started the following output is printed:
> 
> ```
> Sep 28 16:17:04 ctct-r2 systemd[1]: Started Squid Proxy Server (OTA Mode).
> Sep 28 16:17:04 ctct-r2 squid[1059]: No valid signing SSL certificate 
> configured for HTTPS_port [::]:3129
> Sep 28 16:17:04 ctct-r2 squid[1059]: FATAL: No valid signing SSL 
> certificate configured for HTTPS_port [::]:3129
> Sep 28 16:17:04 ctct-r2 squid[1059]: Squid Cache (Version 3.5.25): 
> Terminated abnormally.
> Sep 28 16:17:04 ctct-r2 squid[1059]: CPU Usage: 0.040 seconds = 0.030 
> user + 0.010 sys
> Sep 28 16:17:04 ctct-r2 squid[1059]: Maximum Resident Size: 38656 KB
> ```
> Any lead is greatly appreciated.
> 
> Buda
> 
> 
> 
> -- 
> Budimir Miljkovi? BSc E | He
> Senior Development Engineer
> Civil Construction Field Systems
> Trimble
> 
> 11-17 Birmingham Drive, Christchurch, Canterbury, 8024
> New Zealand
> +64 3 963-5550 Direct
> +64 21 419-024 Mobile
> 
> www.trimble.com <http://www.trimble.com>
> 
> This email may contain confidential information that is intended only 
> for the listed recipient(s) of this email. Any unauthorized review, use, 
> disclosure or distribution is prohibited. If you believe you have 
> received this email in error, please immediately delete this email and 
> any attachments, and inform me via reply email.
> 
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> https://lists.squid-cache.org/listinfo/squid-users



From fgiorgetti at gmail.com  Thu Sep 28 15:31:56 2023
From: fgiorgetti at gmail.com (Fernando Giorgetti)
Date: Thu, 28 Sep 2023 12:31:56 -0300
Subject: [squid-users] TLS passthrough
In-Reply-To: <42994367-b30d-443b-b88c-8df94a5632ff@measurement-factory.com>
References: <CADxZ=iVSpT0VYTZS0ZhnnQNP_1mg+PZNzGmWc9cR3mYnos1p_g@mail.gmail.com>
 <ZRUgFYjFwpnK8hdO@fantomas.sk>
 <CADxZ=iWnO0mUnUhC6cNV48wH5ET_kChZi=rgCy--9zDbwWgqwg@mail.gmail.com>
 <42994367-b30d-443b-b88c-8df94a5632ff@measurement-factory.com>
Message-ID: <CADxZ=iX=0fpqyv9L8koUPuCCDuA3j8iEqdizqLPcFsgBSQuEJw@mail.gmail.com>

Hello Alex, thanks for your reply.

And what should I do to let Squid use the SNI defined by the TLS client?

Thanks again,
Fernando

On Thu, Sep 28, 2023 at 11:51?AM Alex Rousskov <
rousskov at measurement-factory.com> wrote:

> On 2023-09-28 09:06, Fernando Giorgetti wrote:
> > Hi Matus, do you mean something like a DNAT (iptables) rule?
> > If so, I would say, it should work as well.
> >
> > But this is an environment I do not control, and I have been told to try
> > using an existing squid installation to proxy non-http/TLS data through.
> >
> > I appreciate any guidance or recommendation.
>
>
> Bugs notwithstanding, Squid can blindly tunnel intercepted (at TCP port
> X) TCP traffic to its intended destination:
>
>      https_port X intercept ssl-bump ...
>      ssl_bump splice all
>
>
> Without interception, then Squid can only tunnel stuff inside HTTP
> CONNECT tunnels (for HTTP CONNECT requests received at TCP port Y):
>
>      http_port Y ssl-bump ...
>      ssl_bump splice all
>
>
> In both cases, Squid does not care about the protocols that tunneled
> traffic is using. It could be HTTP, HTTPS, TLS, or anything else on top
> of TCP.
>
> Your ACLs may differ from "all" in the above sketches, of course, but if
> traffic is not TLS, then you want an "ssl_bump splice" rule that matches
> during SslBump step1. A rule with an "all" ACLs is the simplest example
> of that.
>
>
> HTH,
>
> Alex.
> P.S. I am getting an "Internal Server Error" when following the haproxy
> link in the original question, so I cannot map what that page says to
> the configurations above.
>
>
> > On Thu, Sep 28, 2023 at 3:41?AM Matus UHLAR - fantomas wrote:
> >
> >     On 27.09.23 16:48, Fernando Giorgetti wrote:
> >      >I would like to know if it is possible to set up Squid to perform
> >      >TLS passthrough to a given backend, relaying TLS encrypted
> >      >traffic to the backend, similarly to what HAProxy does below?
> >      >
> >      >
> https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough
> <
> https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough
> >
> >      >
> >      >I have tried a few different configurations using reverse proxy,
> >      >or peek and splice, but I could not make it work without providing
> >      >a valid HTTP request or a CONNECT request.
> >
> >     what's the difference between TCP redirect and this?
> >
> >     --
> >     Matus UHLAR - fantomas, uhlar at fantomas.sk <mailto:uhlar at fantomas.sk>
> >     ; http://www.fantomas.sk/ <http://www.fantomas.sk/>
> >     Warning: I wish NOT to receive e-mail advertising to this address.
> >     Varovanie: na tuto adresu chcem NEDOSTAVAT akukolvek reklamnu postu.
> >     Depression is merely anger without enthusiasm.
> >     _______________________________________________
> >     squid-users mailing list
> >     squid-users at lists.squid-cache.org
> >     <mailto:squid-users at lists.squid-cache.org>
> >     https://lists.squid-cache.org/listinfo/squid-users
> >     <https://lists.squid-cache.org/listinfo/squid-users>
> >
> >
> > _______________________________________________
> > squid-users mailing list
> > squid-users at lists.squid-cache.org
> > https://lists.squid-cache.org/listinfo/squid-users
>
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> https://lists.squid-cache.org/listinfo/squid-users
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230928/b12a5768/attachment.htm>

From rousskov at measurement-factory.com  Thu Sep 28 16:02:52 2023
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Thu, 28 Sep 2023 12:02:52 -0400
Subject: [squid-users] TLS passthrough
In-Reply-To: <CADxZ=iX=0fpqyv9L8koUPuCCDuA3j8iEqdizqLPcFsgBSQuEJw@mail.gmail.com>
References: <CADxZ=iVSpT0VYTZS0ZhnnQNP_1mg+PZNzGmWc9cR3mYnos1p_g@mail.gmail.com>
 <ZRUgFYjFwpnK8hdO@fantomas.sk>
 <CADxZ=iWnO0mUnUhC6cNV48wH5ET_kChZi=rgCy--9zDbwWgqwg@mail.gmail.com>
 <42994367-b30d-443b-b88c-8df94a5632ff@measurement-factory.com>
 <CADxZ=iX=0fpqyv9L8koUPuCCDuA3j8iEqdizqLPcFsgBSQuEJw@mail.gmail.com>
Message-ID: <e1c49be1-597a-47e7-96e3-5f036d3024a5@measurement-factory.com>

On 2023-09-28 11:31, Fernando Giorgetti wrote:

> And what should?I do to let Squid use the SNI defined by the TLS client?

What do you want Squid to use that SNI for?

Alex.


> On Thu, Sep 28, 2023 at 11:51?AM Alex Rousskov wrote:
> 
>     On 2023-09-28 09:06, Fernando Giorgetti wrote:
>      > Hi Matus, do you mean something like a DNAT (iptables) rule?
>      > If so, I would say, it should work as well.
>      >
>      > But this is an environment I do not control, and I have been told
>     to try
>      > using an existing squid installation to proxy non-http/TLS data
>     through.
>      >
>      > I appreciate any guidance or recommendation.
> 
> 
>     Bugs notwithstanding, Squid can blindly tunnel intercepted (at TCP port
>     X) TCP traffic to its intended destination:
> 
>      ? ? ?https_port X intercept ssl-bump ...
>      ? ? ?ssl_bump splice all
> 
> 
>     Without interception, then Squid can only tunnel stuff inside HTTP
>     CONNECT tunnels (for HTTP CONNECT requests received at TCP port Y):
> 
>      ? ? ?http_port Y ssl-bump ...
>      ? ? ?ssl_bump splice all
> 
> 
>     In both cases, Squid does not care about the protocols that tunneled
>     traffic is using. It could be HTTP, HTTPS, TLS, or anything else on top
>     of TCP.
> 
>     Your ACLs may differ from "all" in the above sketches, of course,
>     but if
>     traffic is not TLS, then you want an "ssl_bump splice" rule that
>     matches
>     during SslBump step1. A rule with an "all" ACLs is the simplest example
>     of that.
> 
> 
>     HTH,
> 
>     Alex.
>     P.S. I am getting an "Internal Server Error" when following the haproxy
>     link in the original question, so I cannot map what that page says to
>     the configurations above.
> 
> 
>      > On Thu, Sep 28, 2023 at 3:41?AM Matus UHLAR - fantomas wrote:
>      >
>      >? ? ?On 27.09.23 16:48, Fernando Giorgetti wrote:
>      >? ? ? >I would like to know if it is possible to set up Squid to
>     perform
>      >? ? ? >TLS passthrough to a given backend, relaying TLS encrypted
>      >? ? ? >traffic to the backend, similarly to what HAProxy does below?
>      >? ? ? >
>      >     
>      >https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough <https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough> <https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough <https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough>>
>      >? ? ? >
>      >? ? ? >I have tried a few different configurations using reverse
>     proxy,
>      >? ? ? >or peek and splice, but I could not make it work without
>     providing
>      >? ? ? >a valid HTTP request or a CONNECT request.
>      >
>      >? ? ?what's the difference between TCP redirect and this?
>      >
>      >? ? ?--
>      >? ? ?Matus UHLAR - fantomas, uhlar at fantomas.sk
>     <mailto:uhlar at fantomas.sk> <mailto:uhlar at fantomas.sk
>     <mailto:uhlar at fantomas.sk>>
>      >? ? ?; http://www.fantomas.sk/ <http://www.fantomas.sk/>
>     <http://www.fantomas.sk/ <http://www.fantomas.sk/>>
>      >? ? ?Warning: I wish NOT to receive e-mail advertising to this
>     address.
>      >? ? ?Varovanie: na tuto adresu chcem NEDOSTAVAT akukolvek reklamnu
>     postu.
>      >? ? ?Depression is merely anger without enthusiasm.
>      >? ? ?_______________________________________________
>      >? ? ?squid-users mailing list
>      > squid-users at lists.squid-cache.org
>     <mailto:squid-users at lists.squid-cache.org>
>      >? ? ?<mailto:squid-users at lists.squid-cache.org
>     <mailto:squid-users at lists.squid-cache.org>>
>      > https://lists.squid-cache.org/listinfo/squid-users
>     <https://lists.squid-cache.org/listinfo/squid-users>
>      >? ? ?<https://lists.squid-cache.org/listinfo/squid-users
>     <https://lists.squid-cache.org/listinfo/squid-users>>
>      >
>      >
>      > _______________________________________________
>      > squid-users mailing list
>      > squid-users at lists.squid-cache.org
>     <mailto:squid-users at lists.squid-cache.org>
>      > https://lists.squid-cache.org/listinfo/squid-users
>     <https://lists.squid-cache.org/listinfo/squid-users>
> 
>     _______________________________________________
>     squid-users mailing list
>     squid-users at lists.squid-cache.org
>     <mailto:squid-users at lists.squid-cache.org>
>     https://lists.squid-cache.org/listinfo/squid-users
>     <https://lists.squid-cache.org/listinfo/squid-users>
> 



From fgiorgetti at gmail.com  Thu Sep 28 19:23:27 2023
From: fgiorgetti at gmail.com (Fernando Giorgetti)
Date: Thu, 28 Sep 2023 16:23:27 -0300
Subject: [squid-users] TLS passthrough
In-Reply-To: <e1c49be1-597a-47e7-96e3-5f036d3024a5@measurement-factory.com>
References: <CADxZ=iVSpT0VYTZS0ZhnnQNP_1mg+PZNzGmWc9cR3mYnos1p_g@mail.gmail.com>
 <ZRUgFYjFwpnK8hdO@fantomas.sk>
 <CADxZ=iWnO0mUnUhC6cNV48wH5ET_kChZi=rgCy--9zDbwWgqwg@mail.gmail.com>
 <42994367-b30d-443b-b88c-8df94a5632ff@measurement-factory.com>
 <CADxZ=iX=0fpqyv9L8koUPuCCDuA3j8iEqdizqLPcFsgBSQuEJw@mail.gmail.com>
 <e1c49be1-597a-47e7-96e3-5f036d3024a5@measurement-factory.com>
Message-ID: <CADxZ=iV2sfFOYXWC=gRa_d53M2GK6WjXt_P+aNK6cFCUoSdpig@mail.gmail.com>

Actually with the suggested blind passthrough, Squid would not handle the
TLS termination.
So without a reverse proxy (accel mode), how will Squid know what the
target is?

On Thu, Sep 28, 2023 at 1:02?PM Alex Rousskov <
rousskov at measurement-factory.com> wrote:

> On 2023-09-28 11:31, Fernando Giorgetti wrote:
>
> > And what should I do to let Squid use the SNI defined by the TLS client?
>
> What do you want Squid to use that SNI for?
>
> Alex.
>
>
> > On Thu, Sep 28, 2023 at 11:51?AM Alex Rousskov wrote:
> >
> >     On 2023-09-28 09:06, Fernando Giorgetti wrote:
> >      > Hi Matus, do you mean something like a DNAT (iptables) rule?
> >      > If so, I would say, it should work as well.
> >      >
> >      > But this is an environment I do not control, and I have been told
> >     to try
> >      > using an existing squid installation to proxy non-http/TLS data
> >     through.
> >      >
> >      > I appreciate any guidance or recommendation.
> >
> >
> >     Bugs notwithstanding, Squid can blindly tunnel intercepted (at TCP
> port
> >     X) TCP traffic to its intended destination:
> >
> >           https_port X intercept ssl-bump ...
> >           ssl_bump splice all
> >
> >
> >     Without interception, then Squid can only tunnel stuff inside HTTP
> >     CONNECT tunnels (for HTTP CONNECT requests received at TCP port Y):
> >
> >           http_port Y ssl-bump ...
> >           ssl_bump splice all
> >
> >
> >     In both cases, Squid does not care about the protocols that tunneled
> >     traffic is using. It could be HTTP, HTTPS, TLS, or anything else on
> top
> >     of TCP.
> >
> >     Your ACLs may differ from "all" in the above sketches, of course,
> >     but if
> >     traffic is not TLS, then you want an "ssl_bump splice" rule that
> >     matches
> >     during SslBump step1. A rule with an "all" ACLs is the simplest
> example
> >     of that.
> >
> >
> >     HTH,
> >
> >     Alex.
> >     P.S. I am getting an "Internal Server Error" when following the
> haproxy
> >     link in the original question, so I cannot map what that page says to
> >     the configurations above.
> >
> >
> >      > On Thu, Sep 28, 2023 at 3:41?AM Matus UHLAR - fantomas wrote:
> >      >
> >      >     On 27.09.23 16:48, Fernando Giorgetti wrote:
> >      >      >I would like to know if it is possible to set up Squid to
> >     perform
> >      >      >TLS passthrough to a given backend, relaying TLS encrypted
> >      >      >traffic to the backend, similarly to what HAProxy does
> below?
> >      >      >
> >      >
> >      >
> https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough
> <
> https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough>
> <
> https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough
> <
> https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough
> >>
> >      >      >
> >      >      >I have tried a few different configurations using reverse
> >     proxy,
> >      >      >or peek and splice, but I could not make it work without
> >     providing
> >      >      >a valid HTTP request or a CONNECT request.
> >      >
> >      >     what's the difference between TCP redirect and this?
> >      >
> >      >     --
> >      >     Matus UHLAR - fantomas, uhlar at fantomas.sk
> >     <mailto:uhlar at fantomas.sk> <mailto:uhlar at fantomas.sk
> >     <mailto:uhlar at fantomas.sk>>
> >      >     ; http://www.fantomas.sk/ <http://www.fantomas.sk/>
> >     <http://www.fantomas.sk/ <http://www.fantomas.sk/>>
> >      >     Warning: I wish NOT to receive e-mail advertising to this
> >     address.
> >      >     Varovanie: na tuto adresu chcem NEDOSTAVAT akukolvek reklamnu
> >     postu.
> >      >     Depression is merely anger without enthusiasm.
> >      >     _______________________________________________
> >      >     squid-users mailing list
> >      > squid-users at lists.squid-cache.org
> >     <mailto:squid-users at lists.squid-cache.org>
> >      >     <mailto:squid-users at lists.squid-cache.org
> >     <mailto:squid-users at lists.squid-cache.org>>
> >      > https://lists.squid-cache.org/listinfo/squid-users
> >     <https://lists.squid-cache.org/listinfo/squid-users>
> >      >     <https://lists.squid-cache.org/listinfo/squid-users
> >     <https://lists.squid-cache.org/listinfo/squid-users>>
> >      >
> >      >
> >      > _______________________________________________
> >      > squid-users mailing list
> >      > squid-users at lists.squid-cache.org
> >     <mailto:squid-users at lists.squid-cache.org>
> >      > https://lists.squid-cache.org/listinfo/squid-users
> >     <https://lists.squid-cache.org/listinfo/squid-users>
> >
> >     _______________________________________________
> >     squid-users mailing list
> >     squid-users at lists.squid-cache.org
> >     <mailto:squid-users at lists.squid-cache.org>
> >     https://lists.squid-cache.org/listinfo/squid-users
> >     <https://lists.squid-cache.org/listinfo/squid-users>
> >
>
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230928/c41c5485/attachment.htm>

From rousskov at measurement-factory.com  Thu Sep 28 22:23:05 2023
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Thu, 28 Sep 2023 18:23:05 -0400
Subject: [squid-users] TLS passthrough
In-Reply-To: <CADxZ=iV2sfFOYXWC=gRa_d53M2GK6WjXt_P+aNK6cFCUoSdpig@mail.gmail.com>
References: <CADxZ=iVSpT0VYTZS0ZhnnQNP_1mg+PZNzGmWc9cR3mYnos1p_g@mail.gmail.com>
 <ZRUgFYjFwpnK8hdO@fantomas.sk>
 <CADxZ=iWnO0mUnUhC6cNV48wH5ET_kChZi=rgCy--9zDbwWgqwg@mail.gmail.com>
 <42994367-b30d-443b-b88c-8df94a5632ff@measurement-factory.com>
 <CADxZ=iX=0fpqyv9L8koUPuCCDuA3j8iEqdizqLPcFsgBSQuEJw@mail.gmail.com>
 <e1c49be1-597a-47e7-96e3-5f036d3024a5@measurement-factory.com>
 <CADxZ=iV2sfFOYXWC=gRa_d53M2GK6WjXt_P+aNK6cFCUoSdpig@mail.gmail.com>
Message-ID: <4d494271-f038-4209-b99a-bf8e08cbc42c@measurement-factory.com>

On 2023-09-28 15:23, Fernando Giorgetti wrote:

> Actually with the suggested blind passthrough, Squid would not handle 
> the TLS termination.

Correct.


> how will Squid know what the target is?

In many cases, Squid can learn SNI by peeking at TLS ClientHello, 
without terminating TLS. Bugs notwithstanding, none of the configuration 
sketches I shared previously will do that though.


HTH,

Alex.



> On Thu, Sep 28, 2023 at 1:02?PM Alex Rousskov wrote:
> 
>     On 2023-09-28 11:31, Fernando Giorgetti wrote:
> 
>      > And what should?I do to let Squid use the SNI defined by the TLS
>     client?
> 
>     What do you want Squid to use that SNI for?
> 
>     Alex.
> 
> 
>      > On Thu, Sep 28, 2023 at 11:51?AM Alex Rousskov wrote:
>      >
>      >? ? ?On 2023-09-28 09:06, Fernando Giorgetti wrote:
>      >? ? ? > Hi Matus, do you mean something like a DNAT (iptables) rule?
>      >? ? ? > If so, I would say, it should work as well.
>      >? ? ? >
>      >? ? ? > But this is an environment I do not control, and I have
>     been told
>      >? ? ?to try
>      >? ? ? > using an existing squid installation to proxy non-http/TLS
>     data
>      >? ? ?through.
>      >? ? ? >
>      >? ? ? > I appreciate any guidance or recommendation.
>      >
>      >
>      >? ? ?Bugs notwithstanding, Squid can blindly tunnel intercepted
>     (at TCP port
>      >? ? ?X) TCP traffic to its intended destination:
>      >
>      >? ? ? ? ? ?https_port X intercept ssl-bump ...
>      >? ? ? ? ? ?ssl_bump splice all
>      >
>      >
>      >? ? ?Without interception, then Squid can only tunnel stuff inside
>     HTTP
>      >? ? ?CONNECT tunnels (for HTTP CONNECT requests received at TCP
>     port Y):
>      >
>      >? ? ? ? ? ?http_port Y ssl-bump ...
>      >? ? ? ? ? ?ssl_bump splice all
>      >
>      >
>      >? ? ?In both cases, Squid does not care about the protocols that
>     tunneled
>      >? ? ?traffic is using. It could be HTTP, HTTPS, TLS, or anything
>     else on top
>      >? ? ?of TCP.
>      >
>      >? ? ?Your ACLs may differ from "all" in the above sketches, of course,
>      >? ? ?but if
>      >? ? ?traffic is not TLS, then you want an "ssl_bump splice" rule that
>      >? ? ?matches
>      >? ? ?during SslBump step1. A rule with an "all" ACLs is the
>     simplest example
>      >? ? ?of that.
>      >
>      >
>      >? ? ?HTH,
>      >
>      >? ? ?Alex.
>      >? ? ?P.S. I am getting an "Internal Server Error" when following
>     the haproxy
>      >? ? ?link in the original question, so I cannot map what that page
>     says to
>      >? ? ?the configurations above.
>      >
>      >
>      >? ? ? > On Thu, Sep 28, 2023 at 3:41?AM Matus UHLAR - fantomas wrote:
>      >? ? ? >
>      >? ? ? >? ? ?On 27.09.23 16:48, Fernando Giorgetti wrote:
>      >? ? ? >? ? ? >I would like to know if it is possible to set up
>     Squid to
>      >? ? ?perform
>      >? ? ? >? ? ? >TLS passthrough to a given backend, relaying TLS
>     encrypted
>      >? ? ? >? ? ? >traffic to the backend, similarly to what HAProxy
>     does below?
>      >? ? ? >? ? ? >
>      >? ? ? >
>      >     
>      >https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough <https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough> <https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough <https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough>> <https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough <https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough> <https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough <https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough>>>
>      >? ? ? >? ? ? >
>      >? ? ? >? ? ? >I have tried a few different configurations using
>     reverse
>      >? ? ?proxy,
>      >? ? ? >? ? ? >or peek and splice, but I could not make it work without
>      >? ? ?providing
>      >? ? ? >? ? ? >a valid HTTP request or a CONNECT request.
>      >? ? ? >
>      >? ? ? >? ? ?what's the difference between TCP redirect and this?
>      >? ? ? >
>      >? ? ? >? ? ?--
>      >? ? ? >? ? ?Matus UHLAR - fantomas, uhlar at fantomas.sk
>     <mailto:uhlar at fantomas.sk>
>      >? ? ?<mailto:uhlar at fantomas.sk <mailto:uhlar at fantomas.sk>>
>     <mailto:uhlar at fantomas.sk <mailto:uhlar at fantomas.sk>
>      >? ? ?<mailto:uhlar at fantomas.sk <mailto:uhlar at fantomas.sk>>>
>      >? ? ? >? ? ?; http://www.fantomas.sk/ <http://www.fantomas.sk/>
>     <http://www.fantomas.sk/ <http://www.fantomas.sk/>>
>      >? ? ?<http://www.fantomas.sk/ <http://www.fantomas.sk/>
>     <http://www.fantomas.sk/ <http://www.fantomas.sk/>>>
>      >? ? ? >? ? ?Warning: I wish NOT to receive e-mail advertising to this
>      >? ? ?address.
>      >? ? ? >? ? ?Varovanie: na tuto adresu chcem NEDOSTAVAT akukolvek
>     reklamnu
>      >? ? ?postu.
>      >? ? ? >? ? ?Depression is merely anger without enthusiasm.
>      >? ? ? >? ? ?_______________________________________________
>      >? ? ? >? ? ?squid-users mailing list
>      >? ? ? > squid-users at lists.squid-cache.org
>     <mailto:squid-users at lists.squid-cache.org>
>      >? ? ?<mailto:squid-users at lists.squid-cache.org
>     <mailto:squid-users at lists.squid-cache.org>>
>      >? ? ? >? ? ?<mailto:squid-users at lists.squid-cache.org
>     <mailto:squid-users at lists.squid-cache.org>
>      >? ? ?<mailto:squid-users at lists.squid-cache.org
>     <mailto:squid-users at lists.squid-cache.org>>>
>      >? ? ? > https://lists.squid-cache.org/listinfo/squid-users
>     <https://lists.squid-cache.org/listinfo/squid-users>
>      >? ? ?<https://lists.squid-cache.org/listinfo/squid-users
>     <https://lists.squid-cache.org/listinfo/squid-users>>
>      >? ? ? >? ? ?<https://lists.squid-cache.org/listinfo/squid-users
>     <https://lists.squid-cache.org/listinfo/squid-users>
>      >? ? ?<https://lists.squid-cache.org/listinfo/squid-users
>     <https://lists.squid-cache.org/listinfo/squid-users>>>
>      >? ? ? >
>      >? ? ? >
>      >? ? ? > _______________________________________________
>      >? ? ? > squid-users mailing list
>      >? ? ? > squid-users at lists.squid-cache.org
>     <mailto:squid-users at lists.squid-cache.org>
>      >? ? ?<mailto:squid-users at lists.squid-cache.org
>     <mailto:squid-users at lists.squid-cache.org>>
>      >? ? ? > https://lists.squid-cache.org/listinfo/squid-users
>     <https://lists.squid-cache.org/listinfo/squid-users>
>      >? ? ?<https://lists.squid-cache.org/listinfo/squid-users
>     <https://lists.squid-cache.org/listinfo/squid-users>>
>      >
>      >? ? ?_______________________________________________
>      >? ? ?squid-users mailing list
>      > squid-users at lists.squid-cache.org
>     <mailto:squid-users at lists.squid-cache.org>
>      >? ? ?<mailto:squid-users at lists.squid-cache.org
>     <mailto:squid-users at lists.squid-cache.org>>
>      > https://lists.squid-cache.org/listinfo/squid-users
>     <https://lists.squid-cache.org/listinfo/squid-users>
>      >? ? ?<https://lists.squid-cache.org/listinfo/squid-users
>     <https://lists.squid-cache.org/listinfo/squid-users>>
>      >
> 



From fgiorgetti at gmail.com  Fri Sep 29 00:35:04 2023
From: fgiorgetti at gmail.com (Fernando Giorgetti)
Date: Thu, 28 Sep 2023 21:35:04 -0300
Subject: [squid-users] TLS passthrough
In-Reply-To: <4d494271-f038-4209-b99a-bf8e08cbc42c@measurement-factory.com>
References: <CADxZ=iVSpT0VYTZS0ZhnnQNP_1mg+PZNzGmWc9cR3mYnos1p_g@mail.gmail.com>
 <ZRUgFYjFwpnK8hdO@fantomas.sk>
 <CADxZ=iWnO0mUnUhC6cNV48wH5ET_kChZi=rgCy--9zDbwWgqwg@mail.gmail.com>
 <42994367-b30d-443b-b88c-8df94a5632ff@measurement-factory.com>
 <CADxZ=iX=0fpqyv9L8koUPuCCDuA3j8iEqdizqLPcFsgBSQuEJw@mail.gmail.com>
 <e1c49be1-597a-47e7-96e3-5f036d3024a5@measurement-factory.com>
 <CADxZ=iV2sfFOYXWC=gRa_d53M2GK6WjXt_P+aNK6cFCUoSdpig@mail.gmail.com>
 <4d494271-f038-4209-b99a-bf8e08cbc42c@measurement-factory.com>
Message-ID: <CADxZ=iXBfUBS3WHf66QW94=8bKX0r-8i1QtWJNrpAZ6Z4Cm_2g@mail.gmail.com>

>
> Bugs notwithstanding, none of the configuration
> sketches I shared previously will do that though.


Do you have any recommendations on how I could have it done?
When my tls client tries to reach the target through Squid, using
a "ssl_bump splice", it seems like squid is trying to reach itself in a
loop.

I have also tried including a peek first, but no luck.

Thanks again for all suggestions.

On Thu, Sep 28, 2023 at 7:23?PM Alex Rousskov <
rousskov at measurement-factory.com> wrote:

> On 2023-09-28 15:23, Fernando Giorgetti wrote:
>
> > Actually with the suggested blind passthrough, Squid would not handle
> > the TLS termination.
>
> Correct.
>
>
> > how will Squid know what the target is?
>
> In many cases, Squid can learn SNI by peeking at TLS ClientHello,
> without terminating TLS. Bugs notwithstanding, none of the configuration
> sketches I shared previously will do that though.
>
>
> HTH,
>
> Alex.
>
>
>
> > On Thu, Sep 28, 2023 at 1:02?PM Alex Rousskov wrote:
> >
> >     On 2023-09-28 11:31, Fernando Giorgetti wrote:
> >
> >      > And what should I do to let Squid use the SNI defined by the TLS
> >     client?
> >
> >     What do you want Squid to use that SNI for?
> >
> >     Alex.
> >
> >
> >      > On Thu, Sep 28, 2023 at 11:51?AM Alex Rousskov wrote:
> >      >
> >      >     On 2023-09-28 09:06, Fernando Giorgetti wrote:
> >      >      > Hi Matus, do you mean something like a DNAT (iptables)
> rule?
> >      >      > If so, I would say, it should work as well.
> >      >      >
> >      >      > But this is an environment I do not control, and I have
> >     been told
> >      >     to try
> >      >      > using an existing squid installation to proxy non-http/TLS
> >     data
> >      >     through.
> >      >      >
> >      >      > I appreciate any guidance or recommendation.
> >      >
> >      >
> >      >     Bugs notwithstanding, Squid can blindly tunnel intercepted
> >     (at TCP port
> >      >     X) TCP traffic to its intended destination:
> >      >
> >      >           https_port X intercept ssl-bump ...
> >      >           ssl_bump splice all
> >      >
> >      >
> >      >     Without interception, then Squid can only tunnel stuff inside
> >     HTTP
> >      >     CONNECT tunnels (for HTTP CONNECT requests received at TCP
> >     port Y):
> >      >
> >      >           http_port Y ssl-bump ...
> >      >           ssl_bump splice all
> >      >
> >      >
> >      >     In both cases, Squid does not care about the protocols that
> >     tunneled
> >      >     traffic is using. It could be HTTP, HTTPS, TLS, or anything
> >     else on top
> >      >     of TCP.
> >      >
> >      >     Your ACLs may differ from "all" in the above sketches, of
> course,
> >      >     but if
> >      >     traffic is not TLS, then you want an "ssl_bump splice" rule
> that
> >      >     matches
> >      >     during SslBump step1. A rule with an "all" ACLs is the
> >     simplest example
> >      >     of that.
> >      >
> >      >
> >      >     HTH,
> >      >
> >      >     Alex.
> >      >     P.S. I am getting an "Internal Server Error" when following
> >     the haproxy
> >      >     link in the original question, so I cannot map what that page
> >     says to
> >      >     the configurations above.
> >      >
> >      >
> >      >      > On Thu, Sep 28, 2023 at 3:41?AM Matus UHLAR - fantomas
> wrote:
> >      >      >
> >      >      >     On 27.09.23 16:48, Fernando Giorgetti wrote:
> >      >      >      >I would like to know if it is possible to set up
> >     Squid to
> >      >     perform
> >      >      >      >TLS passthrough to a given backend, relaying TLS
> >     encrypted
> >      >      >      >traffic to the backend, similarly to what HAProxy
> >     does below?
> >      >      >      >
> >      >      >
> >      >
> >      >
> https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough
> <
> https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough>
> <
> https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough
> <
> https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough>>
> <
> https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough
> <
> https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough>
> <
> https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough
> <
> https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough
> >>>
> >      >      >      >
> >      >      >      >I have tried a few different configurations using
> >     reverse
> >      >     proxy,
> >      >      >      >or peek and splice, but I could not make it work
> without
> >      >     providing
> >      >      >      >a valid HTTP request or a CONNECT request.
> >      >      >
> >      >      >     what's the difference between TCP redirect and this?
> >      >      >
> >      >      >     --
> >      >      >     Matus UHLAR - fantomas, uhlar at fantomas.sk
> >     <mailto:uhlar at fantomas.sk>
> >      >     <mailto:uhlar at fantomas.sk <mailto:uhlar at fantomas.sk>>
> >     <mailto:uhlar at fantomas.sk <mailto:uhlar at fantomas.sk>
> >      >     <mailto:uhlar at fantomas.sk <mailto:uhlar at fantomas.sk>>>
> >      >      >     ; http://www.fantomas.sk/ <http://www.fantomas.sk/>
> >     <http://www.fantomas.sk/ <http://www.fantomas.sk/>>
> >      >     <http://www.fantomas.sk/ <http://www.fantomas.sk/>
> >     <http://www.fantomas.sk/ <http://www.fantomas.sk/>>>
> >      >      >     Warning: I wish NOT to receive e-mail advertising to
> this
> >      >     address.
> >      >      >     Varovanie: na tuto adresu chcem NEDOSTAVAT akukolvek
> >     reklamnu
> >      >     postu.
> >      >      >     Depression is merely anger without enthusiasm.
> >      >      >     _______________________________________________
> >      >      >     squid-users mailing list
> >      >      > squid-users at lists.squid-cache.org
> >     <mailto:squid-users at lists.squid-cache.org>
> >      >     <mailto:squid-users at lists.squid-cache.org
> >     <mailto:squid-users at lists.squid-cache.org>>
> >      >      >     <mailto:squid-users at lists.squid-cache.org
> >     <mailto:squid-users at lists.squid-cache.org>
> >      >     <mailto:squid-users at lists.squid-cache.org
> >     <mailto:squid-users at lists.squid-cache.org>>>
> >      >      > https://lists.squid-cache.org/listinfo/squid-users
> >     <https://lists.squid-cache.org/listinfo/squid-users>
> >      >     <https://lists.squid-cache.org/listinfo/squid-users
> >     <https://lists.squid-cache.org/listinfo/squid-users>>
> >      >      >     <https://lists.squid-cache.org/listinfo/squid-users
> >     <https://lists.squid-cache.org/listinfo/squid-users>
> >      >     <https://lists.squid-cache.org/listinfo/squid-users
> >     <https://lists.squid-cache.org/listinfo/squid-users>>>
> >      >      >
> >      >      >
> >      >      > _______________________________________________
> >      >      > squid-users mailing list
> >      >      > squid-users at lists.squid-cache.org
> >     <mailto:squid-users at lists.squid-cache.org>
> >      >     <mailto:squid-users at lists.squid-cache.org
> >     <mailto:squid-users at lists.squid-cache.org>>
> >      >      > https://lists.squid-cache.org/listinfo/squid-users
> >     <https://lists.squid-cache.org/listinfo/squid-users>
> >      >     <https://lists.squid-cache.org/listinfo/squid-users
> >     <https://lists.squid-cache.org/listinfo/squid-users>>
> >      >
> >      >     _______________________________________________
> >      >     squid-users mailing list
> >      > squid-users at lists.squid-cache.org
> >     <mailto:squid-users at lists.squid-cache.org>
> >      >     <mailto:squid-users at lists.squid-cache.org
> >     <mailto:squid-users at lists.squid-cache.org>>
> >      > https://lists.squid-cache.org/listinfo/squid-users
> >     <https://lists.squid-cache.org/listinfo/squid-users>
> >      >     <https://lists.squid-cache.org/listinfo/squid-users
> >     <https://lists.squid-cache.org/listinfo/squid-users>>
> >      >
> >
>
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230928/8f946900/attachment.htm>

From rousskov at measurement-factory.com  Fri Sep 29 02:39:16 2023
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Thu, 28 Sep 2023 22:39:16 -0400
Subject: [squid-users] TLS passthrough
In-Reply-To: <CADxZ=iXBfUBS3WHf66QW94=8bKX0r-8i1QtWJNrpAZ6Z4Cm_2g@mail.gmail.com>
References: <CADxZ=iVSpT0VYTZS0ZhnnQNP_1mg+PZNzGmWc9cR3mYnos1p_g@mail.gmail.com>
 <ZRUgFYjFwpnK8hdO@fantomas.sk>
 <CADxZ=iWnO0mUnUhC6cNV48wH5ET_kChZi=rgCy--9zDbwWgqwg@mail.gmail.com>
 <42994367-b30d-443b-b88c-8df94a5632ff@measurement-factory.com>
 <CADxZ=iX=0fpqyv9L8koUPuCCDuA3j8iEqdizqLPcFsgBSQuEJw@mail.gmail.com>
 <e1c49be1-597a-47e7-96e3-5f036d3024a5@measurement-factory.com>
 <CADxZ=iV2sfFOYXWC=gRa_d53M2GK6WjXt_P+aNK6cFCUoSdpig@mail.gmail.com>
 <4d494271-f038-4209-b99a-bf8e08cbc42c@measurement-factory.com>
 <CADxZ=iXBfUBS3WHf66QW94=8bKX0r-8i1QtWJNrpAZ6Z4Cm_2g@mail.gmail.com>
Message-ID: <00c74d5d-7b8f-470e-aa63-1e87d7224f57@measurement-factory.com>

On 2023-09-28 20:35, Fernando Giorgetti wrote:

> Do you have any recommendations on how I could have it done?

I am unable to confirm whether Squid can do what you want or provide 
configuration recommendations because I do not yet know how your Squid 
will receive traffic (e.g., an intercepting proxy or an explicit forward 
HTTP proxy), what traffic Squid will receive (e.g., TLS, plain HTTP, 
something else), and what you want Squid to do with that traffic.

To make progress, I recommend describing the above details (for one 
typical use case?) and then answering any followup questions.


Cheers,

Alex.


> When my tls client tries to reach the target through?Squid, using
> a "ssl_bump splice", it seems like squid is trying to reach itself in a 
> loop.
> 
> I have also tried including a peek first, but no luck.
> 
> Thanks again for all suggestions.
> 
> On Thu, Sep 28, 2023 at 7:23?PM Alex Rousskov wrote:
> 
>     On 2023-09-28 15:23, Fernando Giorgetti wrote:
> 
>      > Actually with the suggested blind passthrough, Squid would not
>     handle
>      > the TLS termination.
> 
>     Correct.
> 
> 
>      > how will Squid know what the target is?
> 
>     In many cases, Squid can learn SNI by peeking at TLS ClientHello,
>     without terminating TLS. Bugs notwithstanding, none of the
>     configuration
>     sketches I shared previously will do that though.
> 
> 
>     HTH,
> 
>     Alex.
> 
> 
> 
>      > On Thu, Sep 28, 2023 at 1:02?PM Alex Rousskov wrote:
>      >
>      >? ? ?On 2023-09-28 11:31, Fernando Giorgetti wrote:
>      >
>      >? ? ? > And what should?I do to let Squid use the SNI defined by
>     the TLS
>      >? ? ?client?
>      >
>      >? ? ?What do you want Squid to use that SNI for?
>      >
>      >? ? ?Alex.
>      >
>      >
>      >? ? ? > On Thu, Sep 28, 2023 at 11:51?AM Alex Rousskov wrote:
>      >? ? ? >
>      >? ? ? >? ? ?On 2023-09-28 09:06, Fernando Giorgetti wrote:
>      >? ? ? >? ? ? > Hi Matus, do you mean something like a DNAT
>     (iptables) rule?
>      >? ? ? >? ? ? > If so, I would say, it should work as well.
>      >? ? ? >? ? ? >
>      >? ? ? >? ? ? > But this is an environment I do not control, and I have
>      >? ? ?been told
>      >? ? ? >? ? ?to try
>      >? ? ? >? ? ? > using an existing squid installation to proxy
>     non-http/TLS
>      >? ? ?data
>      >? ? ? >? ? ?through.
>      >? ? ? >? ? ? >
>      >? ? ? >? ? ? > I appreciate any guidance or recommendation.
>      >? ? ? >
>      >? ? ? >
>      >? ? ? >? ? ?Bugs notwithstanding, Squid can blindly tunnel intercepted
>      >? ? ?(at TCP port
>      >? ? ? >? ? ?X) TCP traffic to its intended destination:
>      >? ? ? >
>      >? ? ? >? ? ? ? ? ?https_port X intercept ssl-bump ...
>      >? ? ? >? ? ? ? ? ?ssl_bump splice all
>      >? ? ? >
>      >? ? ? >
>      >? ? ? >? ? ?Without interception, then Squid can only tunnel stuff
>     inside
>      >? ? ?HTTP
>      >? ? ? >? ? ?CONNECT tunnels (for HTTP CONNECT requests received at TCP
>      >? ? ?port Y):
>      >? ? ? >
>      >? ? ? >? ? ? ? ? ?http_port Y ssl-bump ...
>      >? ? ? >? ? ? ? ? ?ssl_bump splice all
>      >? ? ? >
>      >? ? ? >
>      >? ? ? >? ? ?In both cases, Squid does not care about the protocols
>     that
>      >? ? ?tunneled
>      >? ? ? >? ? ?traffic is using. It could be HTTP, HTTPS, TLS, or
>     anything
>      >? ? ?else on top
>      >? ? ? >? ? ?of TCP.
>      >? ? ? >
>      >? ? ? >? ? ?Your ACLs may differ from "all" in the above sketches,
>     of course,
>      >? ? ? >? ? ?but if
>      >? ? ? >? ? ?traffic is not TLS, then you want an "ssl_bump splice"
>     rule that
>      >? ? ? >? ? ?matches
>      >? ? ? >? ? ?during SslBump step1. A rule with an "all" ACLs is the
>      >? ? ?simplest example
>      >? ? ? >? ? ?of that.
>      >? ? ? >
>      >? ? ? >
>      >? ? ? >? ? ?HTH,
>      >? ? ? >
>      >? ? ? >? ? ?Alex.
>      >? ? ? >? ? ?P.S. I am getting an "Internal Server Error" when
>     following
>      >? ? ?the haproxy
>      >? ? ? >? ? ?link in the original question, so I cannot map what
>     that page
>      >? ? ?says to
>      >? ? ? >? ? ?the configurations above.
>      >? ? ? >
>      >? ? ? >
>      >? ? ? >? ? ? > On Thu, Sep 28, 2023 at 3:41?AM Matus UHLAR -
>     fantomas wrote:
>      >? ? ? >? ? ? >
>      >? ? ? >? ? ? >? ? ?On 27.09.23 16:48, Fernando Giorgetti wrote:
>      >? ? ? >? ? ? >? ? ? >I would like to know if it is possible to set up
>      >? ? ?Squid to
>      >? ? ? >? ? ?perform
>      >? ? ? >? ? ? >? ? ? >TLS passthrough to a given backend, relaying TLS
>      >? ? ?encrypted
>      >? ? ? >? ? ? >? ? ? >traffic to the backend, similarly to what HAProxy
>      >? ? ?does below?
>      >? ? ? >? ? ? >? ? ? >
>      >? ? ? >? ? ? >
>      >? ? ? >
>      >     
>      >https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough <https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough> <https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough <https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough>> <https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough <https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough> <https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough <https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough>>> <https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough <https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough> <https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough <https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough>> <https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough <https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough> <https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough <https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough>>>>
>      >? ? ? >? ? ? >? ? ? >
>      >? ? ? >? ? ? >? ? ? >I have tried a few different configurations using
>      >? ? ?reverse
>      >? ? ? >? ? ?proxy,
>      >? ? ? >? ? ? >? ? ? >or peek and splice, but I could not make it
>     work without
>      >? ? ? >? ? ?providing
>      >? ? ? >? ? ? >? ? ? >a valid HTTP request or a CONNECT request.
>      >? ? ? >? ? ? >
>      >? ? ? >? ? ? >? ? ?what's the difference between TCP redirect and
>     this?
>      >? ? ? >? ? ? >
>      >? ? ? >? ? ? >? ? ?--
>      >? ? ? >? ? ? >? ? ?Matus UHLAR - fantomas, uhlar at fantomas.sk
>     <mailto:uhlar at fantomas.sk>
>      >? ? ?<mailto:uhlar at fantomas.sk <mailto:uhlar at fantomas.sk>>
>      >? ? ? >? ? ?<mailto:uhlar at fantomas.sk <mailto:uhlar at fantomas.sk>
>     <mailto:uhlar at fantomas.sk <mailto:uhlar at fantomas.sk>>>
>      >? ? ?<mailto:uhlar at fantomas.sk <mailto:uhlar at fantomas.sk>
>     <mailto:uhlar at fantomas.sk <mailto:uhlar at fantomas.sk>>
>      >? ? ? >? ? ?<mailto:uhlar at fantomas.sk <mailto:uhlar at fantomas.sk>
>     <mailto:uhlar at fantomas.sk <mailto:uhlar at fantomas.sk>>>>
>      >? ? ? >? ? ? >? ? ?; http://www.fantomas.sk/
>     <http://www.fantomas.sk/> <http://www.fantomas.sk/
>     <http://www.fantomas.sk/>>
>      >? ? ?<http://www.fantomas.sk/ <http://www.fantomas.sk/>
>     <http://www.fantomas.sk/ <http://www.fantomas.sk/>>>
>      >? ? ? >? ? ?<http://www.fantomas.sk/ <http://www.fantomas.sk/>
>     <http://www.fantomas.sk/ <http://www.fantomas.sk/>>
>      >? ? ?<http://www.fantomas.sk/ <http://www.fantomas.sk/>
>     <http://www.fantomas.sk/ <http://www.fantomas.sk/>>>>
>      >? ? ? >? ? ? >? ? ?Warning: I wish NOT to receive e-mail
>     advertising to this
>      >? ? ? >? ? ?address.
>      >? ? ? >? ? ? >? ? ?Varovanie: na tuto adresu chcem NEDOSTAVAT
>     akukolvek
>      >? ? ?reklamnu
>      >? ? ? >? ? ?postu.
>      >? ? ? >? ? ? >? ? ?Depression is merely anger without enthusiasm.
>      >? ? ? >? ? ? >? ? ?_______________________________________________



From bud_miljkovic at trimble.com  Fri Sep 29 03:12:26 2023
From: bud_miljkovic at trimble.com (Bud Miljkovic)
Date: Fri, 29 Sep 2023 16:12:26 +1300
Subject: [squid-users] Squid quits while starting?!
Message-ID: <CAPO8no+ozZxmnJTJi_iRDvf5+J_NMCs4ZWfZfMttS2ouN=CWFw@mail.gmail.com>

I am trying to run Squid on the `open-embedded` pyro distro on my target.

Here is the `squid-ota.conf` file which is during the squid start:
```
#Visible hostname
visible_hostname ctct-r2

# An ACL named 'whitelist'
acl whitelist dstdomain '/etc/squid/whitelist.ota'

# Allow whitelisted URLs through
http_access allow whitelist

# Listen for incoming HTTP traffic
http_port 3128

# Block the rest
http_access deny all

# Intercept transparent HTTPS traffic
https_port 3129 intercept ssl-bump cert=/etc/squid/ssl_cert/myCA.pem
generate-host-certificates=on dynamic_cert_mem_cache_size=4MB
ssl_bump splice all
sslcrtd_program /usr/libexec/ssl_crtd -s /var/lib/ssl_db -M 4MB

cache_dir ufs /var/volatile/log/squid/logs 100 16 256

# Send out HTTPS traffic to destination server
tcp_outgoing_address 10.3.16.51
```.

And here is the log after I start squid:
```
root at abc-r2:/# /usr/sbin/squid -f /etc/squid/squid-ota.conf -NCd1
2023/09/29 15:02:52| Current Directory is /
2023/09/29 15:02:52| Starting Squid Cache version 3.5.25 for
arm-poky-linux-gnueabi...
2023/09/29 15:02:52| Service Name: squid
2023/09/29 15:02:52| Process ID 2806
2023/09/29 15:02:52| Process Roles: master worker
2023/09/29 15:02:52| With 1024 file descriptors available
2023/09/29 15:02:52| Initializing IP Cache...
2023/09/29 15:02:52| DNS Socket created at [::], FD 8
2023/09/29 15:02:52| DNS Socket created at 0.0.0.0, FD 9
2023/09/29 15:02:52| Adding nameserver 127.0.0.1 from /etc/resolv.conf
2023/09/29 15:02:52| helperOpenServers: Starting 5/32 'ssl_crtd' processes
2023/09/29 15:02:52| Logfile: opening log daemon:/var/log/squid/access.log
2023/09/29 15:02:52| Logfile Daemon: opening log /var/log/squid/access.log
2023/09/29 15:02:52| Unlinkd pipe opened on FD 26
2023/09/29 15:02:52| Store logging disabled
2023/09/29 15:02:52| Swap maxSize 102400 + 262144 KB, estimated 28041
objects
2023/09/29 15:02:52| Target number of buckets: 1402
2023/09/29 15:02:52| Using 8192 Store buckets
2023/09/29 15:02:52| Max Mem  size: 262144 KB
2023/09/29 15:02:52| Max Swap size: 102400 KB
2023/09/29 15:02:52| Rebuilding storage in /var/volatile/log/squid/logs (no
log)
2023/09/29 15:02:52| Using Least Load store dir selection
2023/09/29 15:02:52| Current Directory is /
2023/09/29 15:02:52| Finished loading MIME types and icons.
2023/09/29 15:02:52| HTCP Disabled.
2023/09/29 15:02:52| Squid plugin modules loaded: 0
2023/09/29 15:02:52| Adaptation support is off.
2023/09/29 15:02:52| Accepting HTTP Socket connections at local=[::]:3128
remote=[::] FD 28 flags=9
2023/09/29 15:02:52| Accepting NAT intercepted SSL bumped HTTPS Socket
connections at local=[::]:3129 remote=[::] FD 29 flags=41
2023/09/29 15:02:52| WARNING: ssl_crtd #Hlpr1 exited
2023/09/29 15:02:52| Too few ssl_crtd processes are running (need 1/32)
2023/09/29 15:02:52| Closing HTTP port [::]:3128
2023/09/29 15:02:52| Closing HTTPS port [::]:3129
FATAL: The ssl_crtd helpers are crashing too rapidly, need help!
```

Can you suggest what is going on here?

Buda
-- 
Budimir Miljkovi? BSc E | He
Senior Development Engineer
Civil Construction Field Systems
Trimble

11-17 Birmingham Drive, Christchurch, Canterbury, 8024
New Zealand
+64 3 963-5550 Direct
+64 21 419-024 Mobile

www.trimble.com

This email may contain confidential information that is intended only for
the listed recipient(s) of this email. Any unauthorized review, use,
disclosure or distribution is prohibited. If you believe you have received
this email in error, please immediately delete this email and any
attachments, and inform me via reply email.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230929/1f4c8da1/attachment.htm>

From Ralf.Hildebrandt at charite.de  Fri Sep 29 06:38:39 2023
From: Ralf.Hildebrandt at charite.de (Ralf Hildebrandt)
Date: Fri, 29 Sep 2023 08:38:39 +0200
Subject: [squid-users] [ext]  Squid quits while starting?!
In-Reply-To: <CAPO8no+ozZxmnJTJi_iRDvf5+J_NMCs4ZWfZfMttS2ouN=CWFw@mail.gmail.com>
References: <CAPO8no+ozZxmnJTJi_iRDvf5+J_NMCs4ZWfZfMttS2ouN=CWFw@mail.gmail.com>
Message-ID: <ZRZw7xSSPo0J4/Sa@charite.de>

* Bud Miljkovic <bud_miljkovic at trimble.com>:


> # Intercept transparent HTTPS traffic
> https_port 3129 intercept ssl-bump cert=/etc/squid/ssl_cert/myCA.pem
> generate-host-certificates=on dynamic_cert_mem_cache_size=4MB
> ssl_bump splice all
> sslcrtd_program /usr/libexec/ssl_crtd -s /var/lib/ssl_db -M 4MB

^ I think the portion above is relevant for this error

> 2023/09/29 15:02:52| helperOpenServers: Starting 5/32 'ssl_crtd' processes
...
> 2023/09/29 15:02:52| Accepting NAT intercepted SSL bumped HTTPS Socket connections at local=[::]:3129 remote=[::] FD 29 flags=41
> 2023/09/29 15:02:52| WARNING: ssl_crtd #Hlpr1 exited
> 2023/09/29 15:02:52| Too few ssl_crtd processes are running (need 1/32)
> 2023/09/29 15:02:52| Closing HTTP port [::]:3128
> 2023/09/29 15:02:52| Closing HTTPS port [::]:3129
> FATAL: The ssl_crtd helpers are crashing too rapidly, need help!

I assume the "sslcrtd_program" (set to "/usr/libexec/ssl_crtd -s /var/lib/ssl_db -M 4MB")
is indeed not starting up (or crashing immediately after).

* What does "dmesg" report?
* What happens if you invoke "/usr/libexec/ssl_crtd -s /var/lib/ssl_db -M 4MB"
  by hand (as the squid user, I guess)


Also read
https://squid-users.squid-cache.narkive.com/w0JgcN24/need-assistance-debugging-squid-error-ssl-ctrd-helpers-crashing-too-quickly

which seems to imply that you need to initialize the DB first:
/usr/libexec/ssl_crtd -c -s /var/lib/ssl_db

-- 
Ralf Hildebrandt
Charit? - Universit?tsmedizin Berlin
Gesch?ftsbereich IT | Abteilung Netz | Netzwerk-Administration
Invalidenstra?e 120/121 | D-10115 Berlin

Tel. +49 30 450 570 155
ralf.hildebrandt at charite.de
https://www.charite.de


From fgiorgetti at gmail.com  Fri Sep 29 13:17:27 2023
From: fgiorgetti at gmail.com (Fernando Giorgetti)
Date: Fri, 29 Sep 2023 10:17:27 -0300
Subject: [squid-users] TLS passthrough
In-Reply-To: <00c74d5d-7b8f-470e-aa63-1e87d7224f57@measurement-factory.com>
References: <CADxZ=iVSpT0VYTZS0ZhnnQNP_1mg+PZNzGmWc9cR3mYnos1p_g@mail.gmail.com>
 <ZRUgFYjFwpnK8hdO@fantomas.sk>
 <CADxZ=iWnO0mUnUhC6cNV48wH5ET_kChZi=rgCy--9zDbwWgqwg@mail.gmail.com>
 <42994367-b30d-443b-b88c-8df94a5632ff@measurement-factory.com>
 <CADxZ=iX=0fpqyv9L8koUPuCCDuA3j8iEqdizqLPcFsgBSQuEJw@mail.gmail.com>
 <e1c49be1-597a-47e7-96e3-5f036d3024a5@measurement-factory.com>
 <CADxZ=iV2sfFOYXWC=gRa_d53M2GK6WjXt_P+aNK6cFCUoSdpig@mail.gmail.com>
 <4d494271-f038-4209-b99a-bf8e08cbc42c@measurement-factory.com>
 <CADxZ=iXBfUBS3WHf66QW94=8bKX0r-8i1QtWJNrpAZ6Z4Cm_2g@mail.gmail.com>
 <00c74d5d-7b8f-470e-aa63-1e87d7224f57@measurement-factory.com>
Message-ID: <CADxZ=iVq79jruOgXA6TBw0guVSzeN=mZwLF33LVyCd1e2UTBJQ@mail.gmail.com>

Hello Alex,

First of all, thanks for your attention and time.

Actually I am evaluating if Squid can be used to proxy Non-HTTP/TLS
data, as we have a restricted environment where Squid is currently the
only way to get out to the internet.

The idea is that the client application will open a connection to a given
hostname and port (setting the SNI in the TLS options), considering that
the given hostname/port is the actual backend they're trying to reach.

We can either try to use a fake hostname (defined in the /etc/hosts of the
tls client machine) which would actually point to Squid's IP or eventually
redirect traffic to the real destination into Squid using a DNAT rule.

But overall, it will be a 1:1 relationship, meaning, the https_port on Squid
would be used exclusively to this purpose of proxying from a given source
to a given destination.

That is why I was considering a reverse-proxy, but I had no luck with it
(actually
I was able to proxy HTTP/HTTPS, but not non-http).

Thank you again,
Fernando

On Thu, Sep 28, 2023 at 11:39?PM Alex Rousskov <
rousskov at measurement-factory.com> wrote:

> On 2023-09-28 20:35, Fernando Giorgetti wrote:
>
> > Do you have any recommendations on how I could have it done?
>
> I am unable to confirm whether Squid can do what you want or provide
> configuration recommendations because I do not yet know how your Squid
> will receive traffic (e.g., an intercepting proxy or an explicit forward
> HTTP proxy), what traffic Squid will receive (e.g., TLS, plain HTTP,
> something else), and what you want Squid to do with that traffic.
>
> To make progress, I recommend describing the above details (for one
> typical use case?) and then answering any followup questions.
>
>
> Cheers,
>
> Alex.
>
>
> > When my tls client tries to reach the target through Squid, using
> > a "ssl_bump splice", it seems like squid is trying to reach itself in a
> > loop.
> >
> > I have also tried including a peek first, but no luck.
> >
> > Thanks again for all suggestions.
> >
> > On Thu, Sep 28, 2023 at 7:23?PM Alex Rousskov wrote:
> >
> >     On 2023-09-28 15:23, Fernando Giorgetti wrote:
> >
> >      > Actually with the suggested blind passthrough, Squid would not
> >     handle
> >      > the TLS termination.
> >
> >     Correct.
> >
> >
> >      > how will Squid know what the target is?
> >
> >     In many cases, Squid can learn SNI by peeking at TLS ClientHello,
> >     without terminating TLS. Bugs notwithstanding, none of the
> >     configuration
> >     sketches I shared previously will do that though.
> >
> >
> >     HTH,
> >
> >     Alex.
> >
> >
> >
> >      > On Thu, Sep 28, 2023 at 1:02?PM Alex Rousskov wrote:
> >      >
> >      >     On 2023-09-28 11:31, Fernando Giorgetti wrote:
> >      >
> >      >      > And what should I do to let Squid use the SNI defined by
> >     the TLS
> >      >     client?
> >      >
> >      >     What do you want Squid to use that SNI for?
> >      >
> >      >     Alex.
> >      >
> >      >
> >      >      > On Thu, Sep 28, 2023 at 11:51?AM Alex Rousskov wrote:
> >      >      >
> >      >      >     On 2023-09-28 09:06, Fernando Giorgetti wrote:
> >      >      >      > Hi Matus, do you mean something like a DNAT
> >     (iptables) rule?
> >      >      >      > If so, I would say, it should work as well.
> >      >      >      >
> >      >      >      > But this is an environment I do not control, and I
> have
> >      >     been told
> >      >      >     to try
> >      >      >      > using an existing squid installation to proxy
> >     non-http/TLS
> >      >     data
> >      >      >     through.
> >      >      >      >
> >      >      >      > I appreciate any guidance or recommendation.
> >      >      >
> >      >      >
> >      >      >     Bugs notwithstanding, Squid can blindly tunnel
> intercepted
> >      >     (at TCP port
> >      >      >     X) TCP traffic to its intended destination:
> >      >      >
> >      >      >           https_port X intercept ssl-bump ...
> >      >      >           ssl_bump splice all
> >      >      >
> >      >      >
> >      >      >     Without interception, then Squid can only tunnel stuff
> >     inside
> >      >     HTTP
> >      >      >     CONNECT tunnels (for HTTP CONNECT requests received at
> TCP
> >      >     port Y):
> >      >      >
> >      >      >           http_port Y ssl-bump ...
> >      >      >           ssl_bump splice all
> >      >      >
> >      >      >
> >      >      >     In both cases, Squid does not care about the protocols
> >     that
> >      >     tunneled
> >      >      >     traffic is using. It could be HTTP, HTTPS, TLS, or
> >     anything
> >      >     else on top
> >      >      >     of TCP.
> >      >      >
> >      >      >     Your ACLs may differ from "all" in the above sketches,
> >     of course,
> >      >      >     but if
> >      >      >     traffic is not TLS, then you want an "ssl_bump splice"
> >     rule that
> >      >      >     matches
> >      >      >     during SslBump step1. A rule with an "all" ACLs is the
> >      >     simplest example
> >      >      >     of that.
> >      >      >
> >      >      >
> >      >      >     HTH,
> >      >      >
> >      >      >     Alex.
> >      >      >     P.S. I am getting an "Internal Server Error" when
> >     following
> >      >     the haproxy
> >      >      >     link in the original question, so I cannot map what
> >     that page
> >      >     says to
> >      >      >     the configurations above.
> >      >      >
> >      >      >
> >      >      >      > On Thu, Sep 28, 2023 at 3:41?AM Matus UHLAR -
> >     fantomas wrote:
> >      >      >      >
> >      >      >      >     On 27.09.23 16:48, Fernando Giorgetti wrote:
> >      >      >      >      >I would like to know if it is possible to set
> up
> >      >     Squid to
> >      >      >     perform
> >      >      >      >      >TLS passthrough to a given backend, relaying
> TLS
> >      >     encrypted
> >      >      >      >      >traffic to the backend, similarly to what
> HAProxy
> >      >     does below?
> >      >      >      >      >
> >      >      >      >
> >      >      >
> >      >
> >      >
> https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough
> <
> https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough>
> <
> https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough
> <
> https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough>>
> <
> https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough
> <
> https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough>
> <
> https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough
> <
> https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough>>>
> <
> https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough
> <
> https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough>
> <
> https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough
> <
> https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough>>
> <
> https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough
> <
> https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough>
> <
> https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough
> <
> https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough
> >>>>
> >      >      >      >      >
> >      >      >      >      >I have tried a few different configurations
> using
> >      >     reverse
> >      >      >     proxy,
> >      >      >      >      >or peek and splice, but I could not make it
> >     work without
> >      >      >     providing
> >      >      >      >      >a valid HTTP request or a CONNECT request.
> >      >      >      >
> >      >      >      >     what's the difference between TCP redirect and
> >     this?
> >      >      >      >
> >      >      >      >     --
> >      >      >      >     Matus UHLAR - fantomas, uhlar at fantomas.sk
> >     <mailto:uhlar at fantomas.sk>
> >      >     <mailto:uhlar at fantomas.sk <mailto:uhlar at fantomas.sk>>
> >      >      >     <mailto:uhlar at fantomas.sk <mailto:uhlar at fantomas.sk>
> >     <mailto:uhlar at fantomas.sk <mailto:uhlar at fantomas.sk>>>
> >      >     <mailto:uhlar at fantomas.sk <mailto:uhlar at fantomas.sk>
> >     <mailto:uhlar at fantomas.sk <mailto:uhlar at fantomas.sk>>
> >      >      >     <mailto:uhlar at fantomas.sk <mailto:uhlar at fantomas.sk>
> >     <mailto:uhlar at fantomas.sk <mailto:uhlar at fantomas.sk>>>>
> >      >      >      >     ; http://www.fantomas.sk/
> >     <http://www.fantomas.sk/> <http://www.fantomas.sk/
> >     <http://www.fantomas.sk/>>
> >      >     <http://www.fantomas.sk/ <http://www.fantomas.sk/>
> >     <http://www.fantomas.sk/ <http://www.fantomas.sk/>>>
> >      >      >     <http://www.fantomas.sk/ <http://www.fantomas.sk/>
> >     <http://www.fantomas.sk/ <http://www.fantomas.sk/>>
> >      >     <http://www.fantomas.sk/ <http://www.fantomas.sk/>
> >     <http://www.fantomas.sk/ <http://www.fantomas.sk/>>>>
> >      >      >      >     Warning: I wish NOT to receive e-mail
> >     advertising to this
> >      >      >     address.
> >      >      >      >     Varovanie: na tuto adresu chcem NEDOSTAVAT
> >     akukolvek
> >      >     reklamnu
> >      >      >     postu.
> >      >      >      >     Depression is merely anger without enthusiasm.
> >      >      >      >     _______________________________________________
>
>
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230929/27f629c4/attachment.htm>

From rousskov at measurement-factory.com  Fri Sep 29 14:35:09 2023
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Fri, 29 Sep 2023 10:35:09 -0400
Subject: [squid-users] TLS passthrough
In-Reply-To: <CADxZ=iVq79jruOgXA6TBw0guVSzeN=mZwLF33LVyCd1e2UTBJQ@mail.gmail.com>
References: <CADxZ=iVSpT0VYTZS0ZhnnQNP_1mg+PZNzGmWc9cR3mYnos1p_g@mail.gmail.com>
 <ZRUgFYjFwpnK8hdO@fantomas.sk>
 <CADxZ=iWnO0mUnUhC6cNV48wH5ET_kChZi=rgCy--9zDbwWgqwg@mail.gmail.com>
 <42994367-b30d-443b-b88c-8df94a5632ff@measurement-factory.com>
 <CADxZ=iX=0fpqyv9L8koUPuCCDuA3j8iEqdizqLPcFsgBSQuEJw@mail.gmail.com>
 <e1c49be1-597a-47e7-96e3-5f036d3024a5@measurement-factory.com>
 <CADxZ=iV2sfFOYXWC=gRa_d53M2GK6WjXt_P+aNK6cFCUoSdpig@mail.gmail.com>
 <4d494271-f038-4209-b99a-bf8e08cbc42c@measurement-factory.com>
 <CADxZ=iXBfUBS3WHf66QW94=8bKX0r-8i1QtWJNrpAZ6Z4Cm_2g@mail.gmail.com>
 <00c74d5d-7b8f-470e-aa63-1e87d7224f57@measurement-factory.com>
 <CADxZ=iVq79jruOgXA6TBw0guVSzeN=mZwLF33LVyCd1e2UTBJQ@mail.gmail.com>
Message-ID: <6b73642d-0148-4c1e-a822-3d88a3f02cb7@measurement-factory.com>

On 2023-09-29 09:17, Fernando Giorgetti wrote:

> Actually I am evaluating if Squid can be used to proxy Non-HTTP/TLS
> data, as we have a restricted environment where Squid is currently the
> only way to get out to the internet.

Yes, Squid can tunnel non-HTTP data, including TLS data.


> The idea is that the client application will open a connection to a given
> hostname and port (setting?the SNI in the TLS options), considering that
> the given hostname/port is the actual backend they're trying to reach.

Do you control the client application? If yes, then perhaps it can be 
adjusted to support HTTP proxies? In other words, the client will send a 
plain text HTTP CONNECT request to Squid and, upon receiving a 200 
(Connection Established) response headers, will start using TLS with the 
origin server. In this case, you do not need interception.


> We can either try to use a fake hostname (defined in the /etc/hosts of the
> tls client machine) which would actually point to Squid's IP 

AFAICT, faking the IP address will not work without Squid source code 
modifications because a non-intercepting Squid https_port will want to 
terminate TLS -- such a port does not support blindly tunneling traffic.


> or eventually
> redirect traffic to the real destination into Squid using a DNAT rule.

I am not a DNAT expert, but this sounds like interception to me. Bugs 
notwithstanding, Squid supports blind tunneling of intercepted TCP 
connections (to their intended destination):

     https_port X intercept ssl-bump ...
     ssl_bump splice all

On a successful tunneling path, the above configuration does not care 
whether the intercepted traffic is TLS and will not peek at TLS SNI, but 
nothing in your requirements necessitates SNI knowledge AFAICT.

If Squid fails to establish a TCP connection to the intended destination 
of the intercepted connection, then the situation becomes more complex: 
Squid (with the above configuration) assumes that the client is speaking 
TLS. Squid will attempt to bump the TLS client connection and send a 
Squid-generated HTTP error response to the client. AFAIK, this bumping 
and error sending attempt cannot be prevented in this case without Squid 
source code modifications: Squid used to be able to terminate a 
client-Squid connection instead of sending a Squid-generated HTTP error 
response (by replacing the corresponding Squid error page contents with 
a word "reset"). However, that feature was accidentally(?) dropped in 
2002 commit 76cdc28 AFAICT.


HTH,

Alex.


> But overall, it will be a 1:1 relationship, meaning, the https_port on Squid
> would be used exclusively to this purpose of proxying from a given source
> to a given destination.
> 
> That is why I was considering a reverse-proxy, but I had no luck with it 
> (actually
> I was able to proxy HTTP/HTTPS, but not non-http).
> 
> Thank you again,
> Fernando
> 
> On Thu, Sep 28, 2023 at 11:39?PM Alex Rousskov 
> <rousskov at measurement-factory.com 
> <mailto:rousskov at measurement-factory.com>> wrote:
> 
>     On 2023-09-28 20:35, Fernando Giorgetti wrote:
> 
>      > Do you have any recommendations on how I could have it done?
> 
>     I am unable to confirm whether Squid can do what you want or provide
>     configuration recommendations because I do not yet know how your Squid
>     will receive traffic (e.g., an intercepting proxy or an explicit
>     forward
>     HTTP proxy), what traffic Squid will receive (e.g., TLS, plain HTTP,
>     something else), and what you want Squid to do with that traffic.
> 
>     To make progress, I recommend describing the above details (for one
>     typical use case?) and then answering any followup questions.
> 
> 
>     Cheers,
> 
>     Alex.
> 
> 
>      > When my tls client tries to reach the target through?Squid, using
>      > a "ssl_bump splice", it seems like squid is trying to reach
>     itself in a
>      > loop.
>      >
>      > I have also tried including a peek first, but no luck.
>      >
>      > Thanks again for all suggestions.
>      >
>      > On Thu, Sep 28, 2023 at 7:23?PM Alex Rousskov wrote:
>      >
>      >? ? ?On 2023-09-28 15:23, Fernando Giorgetti wrote:
>      >
>      >? ? ? > Actually with the suggested blind passthrough, Squid would not
>      >? ? ?handle
>      >? ? ? > the TLS termination.
>      >
>      >? ? ?Correct.
>      >
>      >
>      >? ? ? > how will Squid know what the target is?
>      >
>      >? ? ?In many cases, Squid can learn SNI by peeking at TLS ClientHello,
>      >? ? ?without terminating TLS. Bugs notwithstanding, none of the
>      >? ? ?configuration
>      >? ? ?sketches I shared previously will do that though.
>      >
>      >
>      >? ? ?HTH,
>      >
>      >? ? ?Alex.
>      >
>      >
>      >
>      >? ? ? > On Thu, Sep 28, 2023 at 1:02?PM Alex Rousskov wrote:
>      >? ? ? >
>      >? ? ? >? ? ?On 2023-09-28 11:31, Fernando Giorgetti wrote:
>      >? ? ? >
>      >? ? ? >? ? ? > And what should?I do to let Squid use the SNI
>     defined by
>      >? ? ?the TLS
>      >? ? ? >? ? ?client?
>      >? ? ? >
>      >? ? ? >? ? ?What do you want Squid to use that SNI for?
>      >? ? ? >
>      >? ? ? >? ? ?Alex.
>      >? ? ? >
>      >? ? ? >
>      >? ? ? >? ? ? > On Thu, Sep 28, 2023 at 11:51?AM Alex Rousskov wrote:
>      >? ? ? >? ? ? >
>      >? ? ? >? ? ? >? ? ?On 2023-09-28 09:06, Fernando Giorgetti wrote:
>      >? ? ? >? ? ? >? ? ? > Hi Matus, do you mean something like a DNAT
>      >? ? ?(iptables) rule?
>      >? ? ? >? ? ? >? ? ? > If so, I would say, it should work as well.
>      >? ? ? >? ? ? >? ? ? >
>      >? ? ? >? ? ? >? ? ? > But this is an environment I do not control,
>     and I have
>      >? ? ? >? ? ?been told
>      >? ? ? >? ? ? >? ? ?to try
>      >? ? ? >? ? ? >? ? ? > using an existing squid installation to proxy
>      >? ? ?non-http/TLS
>      >? ? ? >? ? ?data
>      >? ? ? >? ? ? >? ? ?through.
>      >? ? ? >? ? ? >? ? ? >
>      >? ? ? >? ? ? >? ? ? > I appreciate any guidance or recommendation.
>      >? ? ? >? ? ? >
>      >? ? ? >? ? ? >
>      >? ? ? >? ? ? >? ? ?Bugs notwithstanding, Squid can blindly tunnel
>     intercepted
>      >? ? ? >? ? ?(at TCP port
>      >? ? ? >? ? ? >? ? ?X) TCP traffic to its intended destination:
>      >? ? ? >? ? ? >
>      >? ? ? >? ? ? >? ? ? ? ? ?https_port X intercept ssl-bump ...
>      >? ? ? >? ? ? >? ? ? ? ? ?ssl_bump splice all
>      >? ? ? >? ? ? >
>      >? ? ? >? ? ? >
>      >? ? ? >? ? ? >? ? ?Without interception, then Squid can only
>     tunnel stuff
>      >? ? ?inside
>      >? ? ? >? ? ?HTTP
>      >? ? ? >? ? ? >? ? ?CONNECT tunnels (for HTTP CONNECT requests
>     received at TCP
>      >? ? ? >? ? ?port Y):
>      >? ? ? >? ? ? >
>      >? ? ? >? ? ? >? ? ? ? ? ?http_port Y ssl-bump ...
>      >? ? ? >? ? ? >? ? ? ? ? ?ssl_bump splice all
>      >? ? ? >? ? ? >
>      >? ? ? >? ? ? >
>      >? ? ? >? ? ? >? ? ?In both cases, Squid does not care about the
>     protocols
>      >? ? ?that
>      >? ? ? >? ? ?tunneled
>      >? ? ? >? ? ? >? ? ?traffic is using. It could be HTTP, HTTPS, TLS, or
>      >? ? ?anything
>      >? ? ? >? ? ?else on top
>      >? ? ? >? ? ? >? ? ?of TCP.
>      >? ? ? >? ? ? >
>      >? ? ? >? ? ? >? ? ?Your ACLs may differ from "all" in the above
>     sketches,
>      >? ? ?of course,
>      >? ? ? >? ? ? >? ? ?but if
>      >? ? ? >? ? ? >? ? ?traffic is not TLS, then you want an "ssl_bump
>     splice"
>      >? ? ?rule that
>      >? ? ? >? ? ? >? ? ?matches
>      >? ? ? >? ? ? >? ? ?during SslBump step1. A rule with an "all" ACLs
>     is the
>      >? ? ? >? ? ?simplest example
>      >? ? ? >? ? ? >? ? ?of that.
>      >? ? ? >? ? ? >
>      >? ? ? >? ? ? >
>      >? ? ? >? ? ? >? ? ?HTH,
>      >? ? ? >? ? ? >
>      >? ? ? >? ? ? >? ? ?Alex.
>      >? ? ? >? ? ? >? ? ?P.S. I am getting an "Internal Server Error" when
>      >? ? ?following
>      >? ? ? >? ? ?the haproxy
>      >? ? ? >? ? ? >? ? ?link in the original question, so I cannot map what
>      >? ? ?that page
>      >? ? ? >? ? ?says to
>      >? ? ? >? ? ? >? ? ?the configurations above.
>      >? ? ? >? ? ? >
>      >? ? ? >? ? ? >
>      >? ? ? >? ? ? >? ? ? > On Thu, Sep 28, 2023 at 3:41?AM Matus UHLAR -
>      >? ? ?fantomas wrote:
>      >? ? ? >? ? ? >? ? ? >
>      >? ? ? >? ? ? >? ? ? >? ? ?On 27.09.23 16:48, Fernando Giorgetti wrote:
>      >? ? ? >? ? ? >? ? ? >? ? ? >I would like to know if it is possible
>     to set up
>      >? ? ? >? ? ?Squid to
>      >? ? ? >? ? ? >? ? ?perform
>      >? ? ? >? ? ? >? ? ? >? ? ? >TLS passthrough to a given backend,
>     relaying TLS
>      >? ? ? >? ? ?encrypted
>      >? ? ? >? ? ? >? ? ? >? ? ? >traffic to the backend, similarly to
>     what HAProxy
>      >? ? ? >? ? ?does below?
>      >? ? ? >? ? ? >? ? ? >? ? ? >
>      >? ? ? >? ? ? >? ? ? >
>      >? ? ? >? ? ? >
>      >? ? ? >
>      >     
>      >https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough <https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough> <https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough <https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough>> <https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough <https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough> <https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough <https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough>>> <https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough <https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough> <https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough <https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough>> <https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough <https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough> <https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough <https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough>>>> <https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough <https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough> <https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough <https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough>> <https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough <https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough> <https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough <https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough>>> <https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough <https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough> <https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough <https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough>> <https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough <https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough> <https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough <https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough>>>>>
>      >? ? ? >? ? ? >? ? ? >? ? ? >
>      >? ? ? >? ? ? >? ? ? >? ? ? >I have tried a few different
>     configurations using
>      >? ? ? >? ? ?reverse
>      >? ? ? >? ? ? >? ? ?proxy,
>      >? ? ? >? ? ? >? ? ? >? ? ? >or peek and splice, but I could not
>     make it
>      >? ? ?work without
>      >? ? ? >? ? ? >? ? ?providing
>      >? ? ? >? ? ? >? ? ? >? ? ? >a valid HTTP request or a CONNECT request.
>      >? ? ? >? ? ? >? ? ? >
>      >? ? ? >? ? ? >? ? ? >? ? ?what's the difference between TCP
>     redirect and
>      >? ? ?this?
>      >? ? ? >? ? ? >? ? ? >
>      >? ? ? >? ? ? >? ? ? >? ? ?--
>      >? ? ? >? ? ? >? ? ? >? ? ?Matus UHLAR - fantomas,
>     uhlar at fantomas.sk <mailto:uhlar at fantomas.sk>
>      >? ? ?<mailto:uhlar at fantomas.sk <mailto:uhlar at fantomas.sk>>
>      >? ? ? >? ? ?<mailto:uhlar at fantomas.sk <mailto:uhlar at fantomas.sk>
>     <mailto:uhlar at fantomas.sk <mailto:uhlar at fantomas.sk>>>
>      >? ? ? >? ? ? >? ? ?<mailto:uhlar at fantomas.sk
>     <mailto:uhlar at fantomas.sk> <mailto:uhlar at fantomas.sk
>     <mailto:uhlar at fantomas.sk>>
>      >? ? ?<mailto:uhlar at fantomas.sk <mailto:uhlar at fantomas.sk>
>     <mailto:uhlar at fantomas.sk <mailto:uhlar at fantomas.sk>>>>
>      >? ? ? >? ? ?<mailto:uhlar at fantomas.sk <mailto:uhlar at fantomas.sk>
>     <mailto:uhlar at fantomas.sk <mailto:uhlar at fantomas.sk>>
>      >? ? ?<mailto:uhlar at fantomas.sk <mailto:uhlar at fantomas.sk>
>     <mailto:uhlar at fantomas.sk <mailto:uhlar at fantomas.sk>>>
>      >? ? ? >? ? ? >? ? ?<mailto:uhlar at fantomas.sk
>     <mailto:uhlar at fantomas.sk> <mailto:uhlar at fantomas.sk
>     <mailto:uhlar at fantomas.sk>>
>      >? ? ?<mailto:uhlar at fantomas.sk <mailto:uhlar at fantomas.sk>
>     <mailto:uhlar at fantomas.sk <mailto:uhlar at fantomas.sk>>>>>
>      >? ? ? >? ? ? >? ? ? >? ? ?; http://www.fantomas.sk/
>     <http://www.fantomas.sk/>
>      >? ? ?<http://www.fantomas.sk/ <http://www.fantomas.sk/>>
>     <http://www.fantomas.sk/ <http://www.fantomas.sk/>
>      >? ? ?<http://www.fantomas.sk/ <http://www.fantomas.sk/>>>
>      >? ? ? >? ? ?<http://www.fantomas.sk/ <http://www.fantomas.sk/>
>     <http://www.fantomas.sk/ <http://www.fantomas.sk/>>
>      >? ? ?<http://www.fantomas.sk/ <http://www.fantomas.sk/>
>     <http://www.fantomas.sk/ <http://www.fantomas.sk/>>>>
>      >? ? ? >? ? ? >? ? ?<http://www.fantomas.sk/
>     <http://www.fantomas.sk/> <http://www.fantomas.sk/
>     <http://www.fantomas.sk/>>
>      >? ? ?<http://www.fantomas.sk/ <http://www.fantomas.sk/>
>     <http://www.fantomas.sk/ <http://www.fantomas.sk/>>>
>      >? ? ? >? ? ?<http://www.fantomas.sk/ <http://www.fantomas.sk/>
>     <http://www.fantomas.sk/ <http://www.fantomas.sk/>>
>      >? ? ?<http://www.fantomas.sk/ <http://www.fantomas.sk/>
>     <http://www.fantomas.sk/ <http://www.fantomas.sk/>>>>>
>      >? ? ? >? ? ? >? ? ? >? ? ?Warning: I wish NOT to receive e-mail
>      >? ? ?advertising to this
>      >? ? ? >? ? ? >? ? ?address.
>      >? ? ? >? ? ? >? ? ? >? ? ?Varovanie: na tuto adresu chcem NEDOSTAVAT
>      >? ? ?akukolvek
>      >? ? ? >? ? ?reklamnu
>      >? ? ? >? ? ? >? ? ?postu.
>      >? ? ? >? ? ? >? ? ? >? ? ?Depression is merely anger without
>     enthusiasm.
>      >? ? ? >? ? ? >? ? ? >   
>      ?_______________________________________________
> 
> 


From fgiorgetti at gmail.com  Fri Sep 29 14:55:22 2023
From: fgiorgetti at gmail.com (Fernando Giorgetti)
Date: Fri, 29 Sep 2023 11:55:22 -0300
Subject: [squid-users] TLS passthrough
In-Reply-To: <6b73642d-0148-4c1e-a822-3d88a3f02cb7@measurement-factory.com>
References: <CADxZ=iVSpT0VYTZS0ZhnnQNP_1mg+PZNzGmWc9cR3mYnos1p_g@mail.gmail.com>
 <ZRUgFYjFwpnK8hdO@fantomas.sk>
 <CADxZ=iWnO0mUnUhC6cNV48wH5ET_kChZi=rgCy--9zDbwWgqwg@mail.gmail.com>
 <42994367-b30d-443b-b88c-8df94a5632ff@measurement-factory.com>
 <CADxZ=iX=0fpqyv9L8koUPuCCDuA3j8iEqdizqLPcFsgBSQuEJw@mail.gmail.com>
 <e1c49be1-597a-47e7-96e3-5f036d3024a5@measurement-factory.com>
 <CADxZ=iV2sfFOYXWC=gRa_d53M2GK6WjXt_P+aNK6cFCUoSdpig@mail.gmail.com>
 <4d494271-f038-4209-b99a-bf8e08cbc42c@measurement-factory.com>
 <CADxZ=iXBfUBS3WHf66QW94=8bKX0r-8i1QtWJNrpAZ6Z4Cm_2g@mail.gmail.com>
 <00c74d5d-7b8f-470e-aa63-1e87d7224f57@measurement-factory.com>
 <CADxZ=iVq79jruOgXA6TBw0guVSzeN=mZwLF33LVyCd1e2UTBJQ@mail.gmail.com>
 <6b73642d-0148-4c1e-a822-3d88a3f02cb7@measurement-factory.com>
Message-ID: <CADxZ=iWxMA3avGOtYsAqg8K1_ti7asfAev=Htb3+_xicChYgtw@mail.gmail.com>

>
> Do you control the client application? If yes, then perhaps it can be
> adjusted to support HTTP proxies? In other words, the client will send a
> plain text HTTP CONNECT request to Squid and, upon receiving a 200
> (Connection Established) response headers, will start using TLS with the
> origin server. In this case, you do not need interception.


Nope, the client application is also used to communicate with other apps in
other environments. The SNI has to be used as the client/server apps perform
mutual TLS authentication.

In other words, the client will send a
> plain text HTTP CONNECT request to Squid and, upon receiving a 200
> (Connection Established) response headers, will start using TLS with the
> origin server. In this case, you do not need interception.


In order to evaluate if we can use Squid for this purpose, I have also
created a
basic TLS client/server app to validate what is happening. Basically my TLS
client
tries to connect directly to Squid IP/Port and I am indicating the SNI so
that the
TLS handshake passes.

Using a reverse I was able to make it reach the TLS server after faking a
CONNECT
request. But without a fake CONNECT or a valid HTTP request it failed.

When I tried to make it work using a forward proxy with intercept and
ssl_bump, I
could not make Squid peek at the SNI and tunnel the request to the correct
destination.

Fernando

On Fri, Sep 29, 2023 at 11:35?AM Alex Rousskov <
rousskov at measurement-factory.com> wrote:

> On 2023-09-29 09:17, Fernando Giorgetti wrote:
>
> > Actually I am evaluating if Squid can be used to proxy Non-HTTP/TLS
> > data, as we have a restricted environment where Squid is currently the
> > only way to get out to the internet.
>
> Yes, Squid can tunnel non-HTTP data, including TLS data.
>
>
> > The idea is that the client application will open a connection to a given
> > hostname and port (setting the SNI in the TLS options), considering that
> > the given hostname/port is the actual backend they're trying to reach.
>
> Do you control the client application? If yes, then perhaps it can be
> adjusted to support HTTP proxies? In other words, the client will send a
> plain text HTTP CONNECT request to Squid and, upon receiving a 200
> (Connection Established) response headers, will start using TLS with the
> origin server. In this case, you do not need interception.
>
>
> > We can either try to use a fake hostname (defined in the /etc/hosts of
> the
> > tls client machine) which would actually point to Squid's IP
>
> AFAICT, faking the IP address will not work without Squid source code
> modifications because a non-intercepting Squid https_port will want to
> terminate TLS -- such a port does not support blindly tunneling traffic.
>
>
> > or eventually
> > redirect traffic to the real destination into Squid using a DNAT rule.
>
> I am not a DNAT expert, but this sounds like interception to me. Bugs
> notwithstanding, Squid supports blind tunneling of intercepted TCP
> connections (to their intended destination):
>
>      https_port X intercept ssl-bump ...
>      ssl_bump splice all
>
> On a successful tunneling path, the above configuration does not care
> whether the intercepted traffic is TLS and will not peek at TLS SNI, but
> nothing in your requirements necessitates SNI knowledge AFAICT.
>
> If Squid fails to establish a TCP connection to the intended destination
> of the intercepted connection, then the situation becomes more complex:
> Squid (with the above configuration) assumes that the client is speaking
> TLS. Squid will attempt to bump the TLS client connection and send a
> Squid-generated HTTP error response to the client. AFAIK, this bumping
> and error sending attempt cannot be prevented in this case without Squid
> source code modifications: Squid used to be able to terminate a
> client-Squid connection instead of sending a Squid-generated HTTP error
> response (by replacing the corresponding Squid error page contents with
> a word "reset"). However, that feature was accidentally(?) dropped in
> 2002 commit 76cdc28 AFAICT.
>
>
> HTH,
>
> Alex.
>
>
> > But overall, it will be a 1:1 relationship, meaning, the https_port on
> Squid
> > would be used exclusively to this purpose of proxying from a given source
> > to a given destination.
> >
> > That is why I was considering a reverse-proxy, but I had no luck with it
> > (actually
> > I was able to proxy HTTP/HTTPS, but not non-http).
> >
> > Thank you again,
> > Fernando
> >
> > On Thu, Sep 28, 2023 at 11:39?PM Alex Rousskov
> > <rousskov at measurement-factory.com
> > <mailto:rousskov at measurement-factory.com>> wrote:
> >
> >     On 2023-09-28 20:35, Fernando Giorgetti wrote:
> >
> >      > Do you have any recommendations on how I could have it done?
> >
> >     I am unable to confirm whether Squid can do what you want or provide
> >     configuration recommendations because I do not yet know how your
> Squid
> >     will receive traffic (e.g., an intercepting proxy or an explicit
> >     forward
> >     HTTP proxy), what traffic Squid will receive (e.g., TLS, plain HTTP,
> >     something else), and what you want Squid to do with that traffic.
> >
> >     To make progress, I recommend describing the above details (for one
> >     typical use case?) and then answering any followup questions.
> >
> >
> >     Cheers,
> >
> >     Alex.
> >
> >
> >      > When my tls client tries to reach the target through Squid, using
> >      > a "ssl_bump splice", it seems like squid is trying to reach
> >     itself in a
> >      > loop.
> >      >
> >      > I have also tried including a peek first, but no luck.
> >      >
> >      > Thanks again for all suggestions.
> >      >
> >      > On Thu, Sep 28, 2023 at 7:23?PM Alex Rousskov wrote:
> >      >
> >      >     On 2023-09-28 15:23, Fernando Giorgetti wrote:
> >      >
> >      >      > Actually with the suggested blind passthrough, Squid would
> not
> >      >     handle
> >      >      > the TLS termination.
> >      >
> >      >     Correct.
> >      >
> >      >
> >      >      > how will Squid know what the target is?
> >      >
> >      >     In many cases, Squid can learn SNI by peeking at TLS
> ClientHello,
> >      >     without terminating TLS. Bugs notwithstanding, none of the
> >      >     configuration
> >      >     sketches I shared previously will do that though.
> >      >
> >      >
> >      >     HTH,
> >      >
> >      >     Alex.
> >      >
> >      >
> >      >
> >      >      > On Thu, Sep 28, 2023 at 1:02?PM Alex Rousskov wrote:
> >      >      >
> >      >      >     On 2023-09-28 11:31, Fernando Giorgetti wrote:
> >      >      >
> >      >      >      > And what should I do to let Squid use the SNI
> >     defined by
> >      >     the TLS
> >      >      >     client?
> >      >      >
> >      >      >     What do you want Squid to use that SNI for?
> >      >      >
> >      >      >     Alex.
> >      >      >
> >      >      >
> >      >      >      > On Thu, Sep 28, 2023 at 11:51?AM Alex Rousskov
> wrote:
> >      >      >      >
> >      >      >      >     On 2023-09-28 09:06, Fernando Giorgetti wrote:
> >      >      >      >      > Hi Matus, do you mean something like a DNAT
> >      >     (iptables) rule?
> >      >      >      >      > If so, I would say, it should work as well.
> >      >      >      >      >
> >      >      >      >      > But this is an environment I do not control,
> >     and I have
> >      >      >     been told
> >      >      >      >     to try
> >      >      >      >      > using an existing squid installation to proxy
> >      >     non-http/TLS
> >      >      >     data
> >      >      >      >     through.
> >      >      >      >      >
> >      >      >      >      > I appreciate any guidance or recommendation.
> >      >      >      >
> >      >      >      >
> >      >      >      >     Bugs notwithstanding, Squid can blindly tunnel
> >     intercepted
> >      >      >     (at TCP port
> >      >      >      >     X) TCP traffic to its intended destination:
> >      >      >      >
> >      >      >      >           https_port X intercept ssl-bump ...
> >      >      >      >           ssl_bump splice all
> >      >      >      >
> >      >      >      >
> >      >      >      >     Without interception, then Squid can only
> >     tunnel stuff
> >      >     inside
> >      >      >     HTTP
> >      >      >      >     CONNECT tunnels (for HTTP CONNECT requests
> >     received at TCP
> >      >      >     port Y):
> >      >      >      >
> >      >      >      >           http_port Y ssl-bump ...
> >      >      >      >           ssl_bump splice all
> >      >      >      >
> >      >      >      >
> >      >      >      >     In both cases, Squid does not care about the
> >     protocols
> >      >     that
> >      >      >     tunneled
> >      >      >      >     traffic is using. It could be HTTP, HTTPS, TLS,
> or
> >      >     anything
> >      >      >     else on top
> >      >      >      >     of TCP.
> >      >      >      >
> >      >      >      >     Your ACLs may differ from "all" in the above
> >     sketches,
> >      >     of course,
> >      >      >      >     but if
> >      >      >      >     traffic is not TLS, then you want an "ssl_bump
> >     splice"
> >      >     rule that
> >      >      >      >     matches
> >      >      >      >     during SslBump step1. A rule with an "all" ACLs
> >     is the
> >      >      >     simplest example
> >      >      >      >     of that.
> >      >      >      >
> >      >      >      >
> >      >      >      >     HTH,
> >      >      >      >
> >      >      >      >     Alex.
> >      >      >      >     P.S. I am getting an "Internal Server Error"
> when
> >      >     following
> >      >      >     the haproxy
> >      >      >      >     link in the original question, so I cannot map
> what
> >      >     that page
> >      >      >     says to
> >      >      >      >     the configurations above.
> >      >      >      >
> >      >      >      >
> >      >      >      >      > On Thu, Sep 28, 2023 at 3:41?AM Matus UHLAR -
> >      >     fantomas wrote:
> >      >      >      >      >
> >      >      >      >      >     On 27.09.23 16:48, Fernando Giorgetti
> wrote:
> >      >      >      >      >      >I would like to know if it is possible
> >     to set up
> >      >      >     Squid to
> >      >      >      >     perform
> >      >      >      >      >      >TLS passthrough to a given backend,
> >     relaying TLS
> >      >      >     encrypted
> >      >      >      >      >      >traffic to the backend, similarly to
> >     what HAProxy
> >      >      >     does below?
> >      >      >      >      >      >
> >      >      >      >      >
> >      >      >      >
> >      >      >
> >      >
> >      >
> https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough
> <
> https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough>
> <
> https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough
> <
> https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough>>
> <
> https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough
> <
> https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough>
> <
> https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough
> <
> https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough>>>
> <
> https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough
> <
> https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough>
> <
> https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough
> <
> https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough>>
> <
> https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough
> <
> https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough>
> <
> https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough
> <
> https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough>>>>
> <
> https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough
> <
> https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough>
> <
> https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough
> <
> https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough>>
> <
> https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough
> <
> https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough>
> <
> https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough
> <
> https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough>>>
> <
> https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough
> <
> https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough>
> <
> https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough
> <
> https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough>>
> <
> https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough
> <
> https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough>
> <
> https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough
> <
> https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough
> >>>>>
> >      >      >      >      >      >
> >      >      >      >      >      >I have tried a few different
> >     configurations using
> >      >      >     reverse
> >      >      >      >     proxy,
> >      >      >      >      >      >or peek and splice, but I could not
> >     make it
> >      >     work without
> >      >      >      >     providing
> >      >      >      >      >      >a valid HTTP request or a CONNECT
> request.
> >      >      >      >      >
> >      >      >      >      >     what's the difference between TCP
> >     redirect and
> >      >     this?
> >      >      >      >      >
> >      >      >      >      >     --
> >      >      >      >      >     Matus UHLAR - fantomas,
> >     uhlar at fantomas.sk <mailto:uhlar at fantomas.sk>
> >      >     <mailto:uhlar at fantomas.sk <mailto:uhlar at fantomas.sk>>
> >      >      >     <mailto:uhlar at fantomas.sk <mailto:uhlar at fantomas.sk>
> >     <mailto:uhlar at fantomas.sk <mailto:uhlar at fantomas.sk>>>
> >      >      >      >     <mailto:uhlar at fantomas.sk
> >     <mailto:uhlar at fantomas.sk> <mailto:uhlar at fantomas.sk
> >     <mailto:uhlar at fantomas.sk>>
> >      >     <mailto:uhlar at fantomas.sk <mailto:uhlar at fantomas.sk>
> >     <mailto:uhlar at fantomas.sk <mailto:uhlar at fantomas.sk>>>>
> >      >      >     <mailto:uhlar at fantomas.sk <mailto:uhlar at fantomas.sk>
> >     <mailto:uhlar at fantomas.sk <mailto:uhlar at fantomas.sk>>
> >      >     <mailto:uhlar at fantomas.sk <mailto:uhlar at fantomas.sk>
> >     <mailto:uhlar at fantomas.sk <mailto:uhlar at fantomas.sk>>>
> >      >      >      >     <mailto:uhlar at fantomas.sk
> >     <mailto:uhlar at fantomas.sk> <mailto:uhlar at fantomas.sk
> >     <mailto:uhlar at fantomas.sk>>
> >      >     <mailto:uhlar at fantomas.sk <mailto:uhlar at fantomas.sk>
> >     <mailto:uhlar at fantomas.sk <mailto:uhlar at fantomas.sk>>>>>
> >      >      >      >      >     ; http://www.fantomas.sk/
> >     <http://www.fantomas.sk/>
> >      >     <http://www.fantomas.sk/ <http://www.fantomas.sk/>>
> >     <http://www.fantomas.sk/ <http://www.fantomas.sk/>
> >      >     <http://www.fantomas.sk/ <http://www.fantomas.sk/>>>
> >      >      >     <http://www.fantomas.sk/ <http://www.fantomas.sk/>
> >     <http://www.fantomas.sk/ <http://www.fantomas.sk/>>
> >      >     <http://www.fantomas.sk/ <http://www.fantomas.sk/>
> >     <http://www.fantomas.sk/ <http://www.fantomas.sk/>>>>
> >      >      >      >     <http://www.fantomas.sk/
> >     <http://www.fantomas.sk/> <http://www.fantomas.sk/
> >     <http://www.fantomas.sk/>>
> >      >     <http://www.fantomas.sk/ <http://www.fantomas.sk/>
> >     <http://www.fantomas.sk/ <http://www.fantomas.sk/>>>
> >      >      >     <http://www.fantomas.sk/ <http://www.fantomas.sk/>
> >     <http://www.fantomas.sk/ <http://www.fantomas.sk/>>
> >      >     <http://www.fantomas.sk/ <http://www.fantomas.sk/>
> >     <http://www.fantomas.sk/ <http://www.fantomas.sk/>>>>>
> >      >      >      >      >     Warning: I wish NOT to receive e-mail
> >      >     advertising to this
> >      >      >      >     address.
> >      >      >      >      >     Varovanie: na tuto adresu chcem
> NEDOSTAVAT
> >      >     akukolvek
> >      >      >     reklamnu
> >      >      >      >     postu.
> >      >      >      >      >     Depression is merely anger without
> >     enthusiasm.
> >      >      >      >      >
> >       _______________________________________________
> >
> >
>
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230929/08764da8/attachment.htm>

From rousskov at measurement-factory.com  Fri Sep 29 15:53:10 2023
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Fri, 29 Sep 2023 11:53:10 -0400
Subject: [squid-users] TLS passthrough
In-Reply-To: <CADxZ=iWxMA3avGOtYsAqg8K1_ti7asfAev=Htb3+_xicChYgtw@mail.gmail.com>
References: <CADxZ=iVSpT0VYTZS0ZhnnQNP_1mg+PZNzGmWc9cR3mYnos1p_g@mail.gmail.com>
 <ZRUgFYjFwpnK8hdO@fantomas.sk>
 <CADxZ=iWnO0mUnUhC6cNV48wH5ET_kChZi=rgCy--9zDbwWgqwg@mail.gmail.com>
 <42994367-b30d-443b-b88c-8df94a5632ff@measurement-factory.com>
 <CADxZ=iX=0fpqyv9L8koUPuCCDuA3j8iEqdizqLPcFsgBSQuEJw@mail.gmail.com>
 <e1c49be1-597a-47e7-96e3-5f036d3024a5@measurement-factory.com>
 <CADxZ=iV2sfFOYXWC=gRa_d53M2GK6WjXt_P+aNK6cFCUoSdpig@mail.gmail.com>
 <4d494271-f038-4209-b99a-bf8e08cbc42c@measurement-factory.com>
 <CADxZ=iXBfUBS3WHf66QW94=8bKX0r-8i1QtWJNrpAZ6Z4Cm_2g@mail.gmail.com>
 <00c74d5d-7b8f-470e-aa63-1e87d7224f57@measurement-factory.com>
 <CADxZ=iVq79jruOgXA6TBw0guVSzeN=mZwLF33LVyCd1e2UTBJQ@mail.gmail.com>
 <6b73642d-0148-4c1e-a822-3d88a3f02cb7@measurement-factory.com>
 <CADxZ=iWxMA3avGOtYsAqg8K1_ti7asfAev=Htb3+_xicChYgtw@mail.gmail.com>
Message-ID: <38e0a961-318d-4b05-99d3-e824480712a1@measurement-factory.com>

On 2023-09-29 10:55, Fernando Giorgetti wrote:
>     Do you control the client application? If yes, then perhaps it can be
>     adjusted to support HTTP proxies? In other words, the client will send a
>     plain text HTTP CONNECT request to Squid and, upon receiving a 200
>     (Connection Established) response headers, will start using TLS with the
>     origin server. In this case, you do not need interception.


> Nope, the client application is also used to communicate with other apps in
> other environments. 

FWIW, "used with other apps" does not imply or explain the "nope, we do 
not control the application" answer IMHO.


> The SNI has to be used as the client/server apps perform
> mutual TLS authentication.

To avoid a misunderstanding, nothing I have said precludes the use of 
TLS SNI by the client application. Thus, I am not sure why you are 
saying the above.


> In order to evaluate if we can use Squid for this purpose, I have
> also created a basic TLS client/server app to validate what is
> happening. Basically my TLS client tries to connect directly to Squid
> IP/Port and I am indicating the SNI so that the TLS handshake
> passes.

FWIW, a scenario where the client application establishes a TLS 
connection with Squid https_port (configured as a reverse HTTPS proxy) 
will not work for your use case AFAICT. I am not sure why you are 
testing this. It has not been suggested on this mailing list.

BTW, you can use ("curl" or even "openssl s_client") and "openssl 
s_server" for basic tests. I recommend using well-known test programs 
(instead of custom apps) because doing so makes it easier for mailing 
list readers to understand what your test clients and servers are doing 
(and to reproduce your setup).


> When I tried to make it work using a forward proxy with intercept and
> ssl_bump, I could not make Squid peek at the SNI and tunnel the
> request to the correct destination.

Please note that "forward proxy with intercept" is an oxymoron -- the 
two port modes (i.e. explicit "intercept" and default forward proxying) 
are mutually exclusive.

If you do not want to or cannot modify/configure the client application 
to use Squid as a forward HTTP proxy (as I detailed earlier; see the 
paragraph still quoted at the beginning of this message), then your 
other choice is interception (as I detailed earlier; see the "Squid 
supports blind tunneling of intercepted TCP connections" discussion in 
the previous exchange).

When Squid https_port gets an intercepted client TCP connection, Squid 
does not need SNI to know where to forward that TCP connection. Squid 
opens a TCP connection to the IP address where the client TCP connection 
was going (or trying to go) before it was intercepted. That intended 
destination IP address is delivered to Squid by the OS, as a part of 
interception mechanism/setup. TLS and SNI are not involved in this process.

If you have not tested an interception scenario, please do. If you have, 
please share your interception configuration, Squid configuration, and 
any relevant error/problem information.


HTH,

Alex.


> On Fri, Sep 29, 2023 at 11:35?AM Alex Rousskov wrote:
> 
>     On 2023-09-29 09:17, Fernando Giorgetti wrote:
> 
>      > Actually I am evaluating if Squid can be used to proxy Non-HTTP/TLS
>      > data, as we have a restricted environment where Squid is
>     currently the
>      > only way to get out to the internet.
> 
>     Yes, Squid can tunnel non-HTTP data, including TLS data.
> 
> 
>      > The idea is that the client application will open a connection to
>     a given
>      > hostname and port (setting?the SNI in the TLS options),
>     considering that
>      > the given hostname/port is the actual backend they're trying to
>     reach.
> 
>     Do you control the client application? If yes, then perhaps it can be
>     adjusted to support HTTP proxies? In other words, the client will
>     send a
>     plain text HTTP CONNECT request to Squid and, upon receiving a 200
>     (Connection Established) response headers, will start using TLS with
>     the
>     origin server. In this case, you do not need interception.
> 
> 
>      > We can either try to use a fake hostname (defined in the
>     /etc/hosts of the
>      > tls client machine) which would actually point to Squid's IP
> 
>     AFAICT, faking the IP address will not work without Squid source code
>     modifications because a non-intercepting Squid https_port will want to
>     terminate TLS -- such a port does not support blindly tunneling traffic.
> 
> 
>      > or eventually
>      > redirect traffic to the real destination into Squid using a DNAT
>     rule.
> 
>     I am not a DNAT expert, but this sounds like interception to me. Bugs
>     notwithstanding, Squid supports blind tunneling of intercepted TCP
>     connections (to their intended destination):
> 
>      ? ? ?https_port X intercept ssl-bump ...
>      ? ? ?ssl_bump splice all
> 
>     On a successful tunneling path, the above configuration does not care
>     whether the intercepted traffic is TLS and will not peek at TLS SNI,
>     but
>     nothing in your requirements necessitates SNI knowledge AFAICT.
> 
>     If Squid fails to establish a TCP connection to the intended
>     destination
>     of the intercepted connection, then the situation becomes more complex:
>     Squid (with the above configuration) assumes that the client is
>     speaking
>     TLS. Squid will attempt to bump the TLS client connection and send a
>     Squid-generated HTTP error response to the client. AFAIK, this bumping
>     and error sending attempt cannot be prevented in this case without
>     Squid
>     source code modifications: Squid used to be able to terminate a
>     client-Squid connection instead of sending a Squid-generated HTTP error
>     response (by replacing the corresponding Squid error page contents with
>     a word "reset"). However, that feature was accidentally(?) dropped in
>     2002 commit 76cdc28 AFAICT.
> 
> 
>     HTH,
> 
>     Alex.
> 
> 
>      > But overall, it will be a 1:1 relationship, meaning, the
>     https_port on Squid
>      > would be used exclusively to this purpose of proxying from a
>     given source
>      > to a given destination.
>      >
>      > That is why I was considering a reverse-proxy, but I had no luck
>     with it
>      > (actually
>      > I was able to proxy HTTP/HTTPS, but not non-http).
>      >
>      > Thank you again,
>      > Fernando
>      >
>      > On Thu, Sep 28, 2023 at 11:39?PM Alex Rousskov
>      > <rousskov at measurement-factory.com
>     <mailto:rousskov at measurement-factory.com>
>      > <mailto:rousskov at measurement-factory.com
>     <mailto:rousskov at measurement-factory.com>>> wrote:
>      >
>      >? ? ?On 2023-09-28 20:35, Fernando Giorgetti wrote:
>      >
>      >? ? ? > Do you have any recommendations on how I could have it done?
>      >
>      >? ? ?I am unable to confirm whether Squid can do what you want or
>     provide
>      >? ? ?configuration recommendations because I do not yet know how
>     your Squid
>      >? ? ?will receive traffic (e.g., an intercepting proxy or an explicit
>      >? ? ?forward
>      >? ? ?HTTP proxy), what traffic Squid will receive (e.g., TLS,
>     plain HTTP,
>      >? ? ?something else), and what you want Squid to do with that traffic.
>      >
>      >? ? ?To make progress, I recommend describing the above details
>     (for one
>      >? ? ?typical use case?) and then answering any followup questions.
>      >
>      >
>      >? ? ?Cheers,
>      >
>      >? ? ?Alex.
>      >
>      >
>      >? ? ? > When my tls client tries to reach the target
>     through?Squid, using
>      >? ? ? > a "ssl_bump splice", it seems like squid is trying to reach
>      >? ? ?itself in a
>      >? ? ? > loop.
>      >? ? ? >
>      >? ? ? > I have also tried including a peek first, but no luck.
>      >? ? ? >
>      >? ? ? > Thanks again for all suggestions.
>      >? ? ? >
>      >? ? ? > On Thu, Sep 28, 2023 at 7:23?PM Alex Rousskov wrote:
>      >? ? ? >
>      >? ? ? >? ? ?On 2023-09-28 15:23, Fernando Giorgetti wrote:
>      >? ? ? >
>      >? ? ? >? ? ? > Actually with the suggested blind passthrough,
>     Squid would not
>      >? ? ? >? ? ?handle
>      >? ? ? >? ? ? > the TLS termination.
>      >? ? ? >
>      >? ? ? >? ? ?Correct.
>      >? ? ? >
>      >? ? ? >
>      >? ? ? >? ? ? > how will Squid know what the target is?
>      >? ? ? >
>      >? ? ? >? ? ?In many cases, Squid can learn SNI by peeking at TLS
>     ClientHello,
>      >? ? ? >? ? ?without terminating TLS. Bugs notwithstanding, none of the
>      >? ? ? >? ? ?configuration
>      >? ? ? >? ? ?sketches I shared previously will do that though.
>      >? ? ? >
>      >? ? ? >
>      >? ? ? >? ? ?HTH,
>      >? ? ? >
>      >? ? ? >? ? ?Alex.
>      >? ? ? >
>      >? ? ? >
>      >? ? ? >
>      >? ? ? >? ? ? > On Thu, Sep 28, 2023 at 1:02?PM Alex Rousskov wrote:
>      >? ? ? >? ? ? >
>      >? ? ? >? ? ? >? ? ?On 2023-09-28 11:31, Fernando Giorgetti wrote:
>      >? ? ? >? ? ? >
>      >? ? ? >? ? ? >? ? ? > And what should?I do to let Squid use the SNI
>      >? ? ?defined by
>      >? ? ? >? ? ?the TLS
>      >? ? ? >? ? ? >? ? ?client?
>      >? ? ? >? ? ? >
>      >? ? ? >? ? ? >? ? ?What do you want Squid to use that SNI for?
>      >? ? ? >? ? ? >
>      >? ? ? >? ? ? >? ? ?Alex.
>      >? ? ? >? ? ? >
>      >? ? ? >? ? ? >
>      >? ? ? >? ? ? >? ? ? > On Thu, Sep 28, 2023 at 11:51?AM Alex
>     Rousskov wrote:
>      >? ? ? >? ? ? >? ? ? >
>      >? ? ? >? ? ? >? ? ? >? ? ?On 2023-09-28 09:06, Fernando Giorgetti
>     wrote:
>      >? ? ? >? ? ? >? ? ? >? ? ? > Hi Matus, do you mean something like
>     a DNAT
>      >? ? ? >? ? ?(iptables) rule?
>      >? ? ? >? ? ? >? ? ? >? ? ? > If so, I would say, it should work as
>     well.
>      >? ? ? >? ? ? >? ? ? >? ? ? >
>      >? ? ? >? ? ? >? ? ? >? ? ? > But this is an environment I do not
>     control,
>      >? ? ?and I have
>      >? ? ? >? ? ? >? ? ?been told
>      >? ? ? >? ? ? >? ? ? >? ? ?to try
>      >? ? ? >? ? ? >? ? ? >? ? ? > using an existing squid installation
>     to proxy
>      >? ? ? >? ? ?non-http/TLS
>      >? ? ? >? ? ? >? ? ?data
>      >? ? ? >? ? ? >? ? ? >? ? ?through.
>      >? ? ? >? ? ? >? ? ? >? ? ? >
>      >? ? ? >? ? ? >? ? ? >? ? ? > I appreciate any guidance or
>     recommendation.
>      >? ? ? >? ? ? >? ? ? >
>      >? ? ? >? ? ? >? ? ? >
>      >? ? ? >? ? ? >? ? ? >? ? ?Bugs notwithstanding, Squid can blindly
>     tunnel
>      >? ? ?intercepted
>      >? ? ? >? ? ? >? ? ?(at TCP port
>      >? ? ? >? ? ? >? ? ? >? ? ?X) TCP traffic to its intended destination:
>      >? ? ? >? ? ? >? ? ? >
>      >? ? ? >? ? ? >? ? ? >? ? ? ? ? ?https_port X intercept ssl-bump ...
>      >? ? ? >? ? ? >? ? ? >? ? ? ? ? ?ssl_bump splice all
>      >? ? ? >? ? ? >? ? ? >
>      >? ? ? >? ? ? >? ? ? >
>      >? ? ? >? ? ? >? ? ? >? ? ?Without interception, then Squid can only
>      >? ? ?tunnel stuff
>      >? ? ? >? ? ?inside
>      >? ? ? >? ? ? >? ? ?HTTP
>      >? ? ? >? ? ? >? ? ? >? ? ?CONNECT tunnels (for HTTP CONNECT requests
>      >? ? ?received at TCP
>      >? ? ? >? ? ? >? ? ?port Y):
>      >? ? ? >? ? ? >? ? ? >
>      >? ? ? >? ? ? >? ? ? >? ? ? ? ? ?http_port Y ssl-bump ...
>      >? ? ? >? ? ? >? ? ? >? ? ? ? ? ?ssl_bump splice all
>      >? ? ? >? ? ? >? ? ? >
>      >? ? ? >? ? ? >? ? ? >
>      >? ? ? >? ? ? >? ? ? >? ? ?In both cases, Squid does not care about the
>      >? ? ?protocols
>      >? ? ? >? ? ?that
>      >? ? ? >? ? ? >? ? ?tunneled
>      >? ? ? >? ? ? >? ? ? >? ? ?traffic is using. It could be HTTP,
>     HTTPS, TLS, or
>      >? ? ? >? ? ?anything
>      >? ? ? >? ? ? >? ? ?else on top
>      >? ? ? >? ? ? >? ? ? >? ? ?of TCP.
>      >? ? ? >? ? ? >? ? ? >
>      >? ? ? >? ? ? >? ? ? >? ? ?Your ACLs may differ from "all" in the above
>      >? ? ?sketches,
>      >? ? ? >? ? ?of course,
>      >? ? ? >? ? ? >? ? ? >? ? ?but if
>      >? ? ? >? ? ? >? ? ? >? ? ?traffic is not TLS, then you want an
>     "ssl_bump
>      >? ? ?splice"
>      >? ? ? >? ? ?rule that
>      >? ? ? >? ? ? >? ? ? >? ? ?matches
>      >? ? ? >? ? ? >? ? ? >? ? ?during SslBump step1. A rule with an
>     "all" ACLs
>      >? ? ?is the
>      >? ? ? >? ? ? >? ? ?simplest example
>      >? ? ? >? ? ? >? ? ? >? ? ?of that.
>      >? ? ? >? ? ? >? ? ? >
>      >? ? ? >? ? ? >? ? ? >
>      >? ? ? >? ? ? >? ? ? >? ? ?HTH,
>      >? ? ? >? ? ? >? ? ? >
>      >? ? ? >? ? ? >? ? ? >? ? ?Alex.
>      >? ? ? >? ? ? >? ? ? >? ? ?P.S. I am getting an "Internal Server
>     Error" when
>      >? ? ? >? ? ?following
>      >? ? ? >? ? ? >? ? ?the haproxy
>      >? ? ? >? ? ? >? ? ? >? ? ?link in the original question, so I
>     cannot map what
>      >? ? ? >? ? ?that page
>      >? ? ? >? ? ? >? ? ?says to
>      >? ? ? >? ? ? >? ? ? >? ? ?the configurations above.
>      >? ? ? >? ? ? >? ? ? >
>      >? ? ? >? ? ? >? ? ? >
>      >? ? ? >? ? ? >? ? ? >? ? ? > On Thu, Sep 28, 2023 at 3:41?AM Matus
>     UHLAR -
>      >? ? ? >? ? ?fantomas wrote:
>      >? ? ? >? ? ? >? ? ? >? ? ? >
>      >? ? ? >? ? ? >? ? ? >? ? ? >? ? ?On 27.09.23 16:48, Fernando
>     Giorgetti wrote:
>      >? ? ? >? ? ? >? ? ? >? ? ? >? ? ? >I would like to know if it is
>     possible
>      >? ? ?to set up
>      >? ? ? >? ? ? >? ? ?Squid to
>      >? ? ? >? ? ? >? ? ? >? ? ?perform
>      >? ? ? >? ? ? >? ? ? >? ? ? >? ? ? >TLS passthrough to a given backend,
>      >? ? ?relaying TLS
>      >? ? ? >? ? ? >? ? ?encrypted
>      >? ? ? >? ? ? >? ? ? >? ? ? >? ? ? >traffic to the backend,
>     similarly to
>      >? ? ?what HAProxy
>      >? ? ? >? ? ? >? ? ?does below?
>      >? ? ? >? ? ? >? ? ? >? ? ? >? ? ? >
>      >? ? ? >? ? ? >? ? ? >? ? ? >
>      >? ? ? >? ? ? >? ? ? >
>      >? ? ? >? ? ? >
>      >? ? ? >
>      >     
>      >https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough
>      >? ? ? >? ? ? >? ? ? >? ? ? >? ? ? >
>      >? ? ? >? ? ? >? ? ? >? ? ? >? ? ? >I have tried a few different
>      >? ? ?configurations using
>      >? ? ? >? ? ? >? ? ?reverse
>      >? ? ? >? ? ? >? ? ? >? ? ?proxy,
>      >? ? ? >? ? ? >? ? ? >? ? ? >? ? ? >or peek and splice, but I could not
>      >? ? ?make it
>      >? ? ? >? ? ?work without
>      >? ? ? >? ? ? >? ? ? >? ? ?providing
>      >? ? ? >? ? ? >? ? ? >? ? ? >? ? ? >a valid HTTP request or a
>     CONNECT request.
>      >? ? ? >? ? ? >? ? ? >? ? ? >
>      >? ? ? >? ? ? >? ? ? >? ? ? >? ? ?what's the difference between TCP
>      >? ? ?redirect and
>      >? ? ? >? ? ?this?
>      >? ? ? >? ? ? >? ? ? >? ? ? >
>      >? ? ? >? ? ? >? ? ? >? ? ? >? ? ?--
>      >? ? ? >? ? ? >? ? ? >? ? ? >? ? ?Depression is merely anger without
>      >? ? ?enthusiasm.



From fgiorgetti at gmail.com  Fri Sep 29 17:55:12 2023
From: fgiorgetti at gmail.com (Fernando Giorgetti)
Date: Fri, 29 Sep 2023 14:55:12 -0300
Subject: [squid-users] TLS passthrough
In-Reply-To: <38e0a961-318d-4b05-99d3-e824480712a1@measurement-factory.com>
References: <CADxZ=iVSpT0VYTZS0ZhnnQNP_1mg+PZNzGmWc9cR3mYnos1p_g@mail.gmail.com>
 <ZRUgFYjFwpnK8hdO@fantomas.sk>
 <CADxZ=iWnO0mUnUhC6cNV48wH5ET_kChZi=rgCy--9zDbwWgqwg@mail.gmail.com>
 <42994367-b30d-443b-b88c-8df94a5632ff@measurement-factory.com>
 <CADxZ=iX=0fpqyv9L8koUPuCCDuA3j8iEqdizqLPcFsgBSQuEJw@mail.gmail.com>
 <e1c49be1-597a-47e7-96e3-5f036d3024a5@measurement-factory.com>
 <CADxZ=iV2sfFOYXWC=gRa_d53M2GK6WjXt_P+aNK6cFCUoSdpig@mail.gmail.com>
 <4d494271-f038-4209-b99a-bf8e08cbc42c@measurement-factory.com>
 <CADxZ=iXBfUBS3WHf66QW94=8bKX0r-8i1QtWJNrpAZ6Z4Cm_2g@mail.gmail.com>
 <00c74d5d-7b8f-470e-aa63-1e87d7224f57@measurement-factory.com>
 <CADxZ=iVq79jruOgXA6TBw0guVSzeN=mZwLF33LVyCd1e2UTBJQ@mail.gmail.com>
 <6b73642d-0148-4c1e-a822-3d88a3f02cb7@measurement-factory.com>
 <CADxZ=iWxMA3avGOtYsAqg8K1_ti7asfAev=Htb3+_xicChYgtw@mail.gmail.com>
 <38e0a961-318d-4b05-99d3-e824480712a1@measurement-factory.com>
Message-ID: <CADxZ=iWJ_g8KQ1wYoah-EcLXuAx1MgXqJhCFoJ8xfg3t6GZmug@mail.gmail.com>

Alex,

Sorry for my misconceptions in my previous email.

The "intercept" scenario demonstrated here
https://wiki.squid-cache.org/ConfigExamples/Intercept/AtSource
makes sense to me, as we are just redirecting internal traffic into Squid,
so the original destination IP is preserved.

I was able to make it work and that TLS app (which I have no control at
all),
worked just fine. The only constraint is that it requires that both the
client and
Squid ran on the same machine, but at least it worked perfectly.

Here is my squid.conf (just in case someone eventually has a similar issue):

acl CONNECT method CONNECT
acl mytlsserverip dst 10.0.0.10
http_access allow CONNECT mytlsserverip

http_port 3128

https_port 127.0.0.1:3129 intercept ssl-bump \
  tls-cert=/tmp/certs/squid.pem \
  tls-key=/tmp/certs/squid.key \
  generate-host-certificates=off

ssl_bump splice all


And here are the firewall rules I have used:

iptables -t nat -I OUTPUT -p tcp -d 10.0.0.10 --dport 55671 -j DNAT
--to-destination 127.0.0.1:3129
iptables -t nat -I OUTPUT --match owner --uid-owner squid  -p tcp -d
10.0.0.10 --dport 55671 -j ACCEPT

I appreciate all the guidance and discussion Matus and Alex.

Thank you,
Fernando

On Fri, Sep 29, 2023 at 12:53?PM Alex Rousskov <
rousskov at measurement-factory.com> wrote:

> On 2023-09-29 10:55, Fernando Giorgetti wrote:
> >     Do you control the client application? If yes, then perhaps it can be
> >     adjusted to support HTTP proxies? In other words, the client will
> send a
> >     plain text HTTP CONNECT request to Squid and, upon receiving a 200
> >     (Connection Established) response headers, will start using TLS with
> the
> >     origin server. In this case, you do not need interception.
>
>
> > Nope, the client application is also used to communicate with other apps
> in
> > other environments.
>
> FWIW, "used with other apps" does not imply or explain the "nope, we do
> not control the application" answer IMHO.
>
>
> > The SNI has to be used as the client/server apps perform
> > mutual TLS authentication.
>
> To avoid a misunderstanding, nothing I have said precludes the use of
> TLS SNI by the client application. Thus, I am not sure why you are
> saying the above.
>
>
> > In order to evaluate if we can use Squid for this purpose, I have
> > also created a basic TLS client/server app to validate what is
> > happening. Basically my TLS client tries to connect directly to Squid
> > IP/Port and I am indicating the SNI so that the TLS handshake
> > passes.
>
> FWIW, a scenario where the client application establishes a TLS
> connection with Squid https_port (configured as a reverse HTTPS proxy)
> will not work for your use case AFAICT. I am not sure why you are
> testing this. It has not been suggested on this mailing list.
>
> BTW, you can use ("curl" or even "openssl s_client") and "openssl
> s_server" for basic tests. I recommend using well-known test programs
> (instead of custom apps) because doing so makes it easier for mailing
> list readers to understand what your test clients and servers are doing
> (and to reproduce your setup).
>
>
> > When I tried to make it work using a forward proxy with intercept and
> > ssl_bump, I could not make Squid peek at the SNI and tunnel the
> > request to the correct destination.
>
> Please note that "forward proxy with intercept" is an oxymoron -- the
> two port modes (i.e. explicit "intercept" and default forward proxying)
> are mutually exclusive.
>
> If you do not want to or cannot modify/configure the client application
> to use Squid as a forward HTTP proxy (as I detailed earlier; see the
> paragraph still quoted at the beginning of this message), then your
> other choice is interception (as I detailed earlier; see the "Squid
> supports blind tunneling of intercepted TCP connections" discussion in
> the previous exchange).
>
> When Squid https_port gets an intercepted client TCP connection, Squid
> does not need SNI to know where to forward that TCP connection. Squid
> opens a TCP connection to the IP address where the client TCP connection
> was going (or trying to go) before it was intercepted. That intended
> destination IP address is delivered to Squid by the OS, as a part of
> interception mechanism/setup. TLS and SNI are not involved in this process.
>
> If you have not tested an interception scenario, please do. If you have,
> please share your interception configuration, Squid configuration, and
> any relevant error/problem information.
>
>
> HTH,
>
> Alex.
>
>
> > On Fri, Sep 29, 2023 at 11:35?AM Alex Rousskov wrote:
> >
> >     On 2023-09-29 09:17, Fernando Giorgetti wrote:
> >
> >      > Actually I am evaluating if Squid can be used to proxy
> Non-HTTP/TLS
> >      > data, as we have a restricted environment where Squid is
> >     currently the
> >      > only way to get out to the internet.
> >
> >     Yes, Squid can tunnel non-HTTP data, including TLS data.
> >
> >
> >      > The idea is that the client application will open a connection to
> >     a given
> >      > hostname and port (setting the SNI in the TLS options),
> >     considering that
> >      > the given hostname/port is the actual backend they're trying to
> >     reach.
> >
> >     Do you control the client application? If yes, then perhaps it can be
> >     adjusted to support HTTP proxies? In other words, the client will
> >     send a
> >     plain text HTTP CONNECT request to Squid and, upon receiving a 200
> >     (Connection Established) response headers, will start using TLS with
> >     the
> >     origin server. In this case, you do not need interception.
> >
> >
> >      > We can either try to use a fake hostname (defined in the
> >     /etc/hosts of the
> >      > tls client machine) which would actually point to Squid's IP
> >
> >     AFAICT, faking the IP address will not work without Squid source code
> >     modifications because a non-intercepting Squid https_port will want
> to
> >     terminate TLS -- such a port does not support blindly tunneling
> traffic.
> >
> >
> >      > or eventually
> >      > redirect traffic to the real destination into Squid using a DNAT
> >     rule.
> >
> >     I am not a DNAT expert, but this sounds like interception to me. Bugs
> >     notwithstanding, Squid supports blind tunneling of intercepted TCP
> >     connections (to their intended destination):
> >
> >           https_port X intercept ssl-bump ...
> >           ssl_bump splice all
> >
> >     On a successful tunneling path, the above configuration does not care
> >     whether the intercepted traffic is TLS and will not peek at TLS SNI,
> >     but
> >     nothing in your requirements necessitates SNI knowledge AFAICT.
> >
> >     If Squid fails to establish a TCP connection to the intended
> >     destination
> >     of the intercepted connection, then the situation becomes more
> complex:
> >     Squid (with the above configuration) assumes that the client is
> >     speaking
> >     TLS. Squid will attempt to bump the TLS client connection and send a
> >     Squid-generated HTTP error response to the client. AFAIK, this
> bumping
> >     and error sending attempt cannot be prevented in this case without
> >     Squid
> >     source code modifications: Squid used to be able to terminate a
> >     client-Squid connection instead of sending a Squid-generated HTTP
> error
> >     response (by replacing the corresponding Squid error page contents
> with
> >     a word "reset"). However, that feature was accidentally(?) dropped in
> >     2002 commit 76cdc28 AFAICT.
> >
> >
> >     HTH,
> >
> >     Alex.
> >
> >
> >      > But overall, it will be a 1:1 relationship, meaning, the
> >     https_port on Squid
> >      > would be used exclusively to this purpose of proxying from a
> >     given source
> >      > to a given destination.
> >      >
> >      > That is why I was considering a reverse-proxy, but I had no luck
> >     with it
> >      > (actually
> >      > I was able to proxy HTTP/HTTPS, but not non-http).
> >      >
> >      > Thank you again,
> >      > Fernando
> >      >
> >      > On Thu, Sep 28, 2023 at 11:39?PM Alex Rousskov
> >      > <rousskov at measurement-factory.com
> >     <mailto:rousskov at measurement-factory.com>
> >      > <mailto:rousskov at measurement-factory.com
> >     <mailto:rousskov at measurement-factory.com>>> wrote:
> >      >
> >      >     On 2023-09-28 20:35, Fernando Giorgetti wrote:
> >      >
> >      >      > Do you have any recommendations on how I could have it
> done?
> >      >
> >      >     I am unable to confirm whether Squid can do what you want or
> >     provide
> >      >     configuration recommendations because I do not yet know how
> >     your Squid
> >      >     will receive traffic (e.g., an intercepting proxy or an
> explicit
> >      >     forward
> >      >     HTTP proxy), what traffic Squid will receive (e.g., TLS,
> >     plain HTTP,
> >      >     something else), and what you want Squid to do with that
> traffic.
> >      >
> >      >     To make progress, I recommend describing the above details
> >     (for one
> >      >     typical use case?) and then answering any followup questions.
> >      >
> >      >
> >      >     Cheers,
> >      >
> >      >     Alex.
> >      >
> >      >
> >      >      > When my tls client tries to reach the target
> >     through Squid, using
> >      >      > a "ssl_bump splice", it seems like squid is trying to reach
> >      >     itself in a
> >      >      > loop.
> >      >      >
> >      >      > I have also tried including a peek first, but no luck.
> >      >      >
> >      >      > Thanks again for all suggestions.
> >      >      >
> >      >      > On Thu, Sep 28, 2023 at 7:23?PM Alex Rousskov wrote:
> >      >      >
> >      >      >     On 2023-09-28 15:23, Fernando Giorgetti wrote:
> >      >      >
> >      >      >      > Actually with the suggested blind passthrough,
> >     Squid would not
> >      >      >     handle
> >      >      >      > the TLS termination.
> >      >      >
> >      >      >     Correct.
> >      >      >
> >      >      >
> >      >      >      > how will Squid know what the target is?
> >      >      >
> >      >      >     In many cases, Squid can learn SNI by peeking at TLS
> >     ClientHello,
> >      >      >     without terminating TLS. Bugs notwithstanding, none of
> the
> >      >      >     configuration
> >      >      >     sketches I shared previously will do that though.
> >      >      >
> >      >      >
> >      >      >     HTH,
> >      >      >
> >      >      >     Alex.
> >      >      >
> >      >      >
> >      >      >
> >      >      >      > On Thu, Sep 28, 2023 at 1:02?PM Alex Rousskov wrote:
> >      >      >      >
> >      >      >      >     On 2023-09-28 11:31, Fernando Giorgetti wrote:
> >      >      >      >
> >      >      >      >      > And what should I do to let Squid use the SNI
> >      >     defined by
> >      >      >     the TLS
> >      >      >      >     client?
> >      >      >      >
> >      >      >      >     What do you want Squid to use that SNI for?
> >      >      >      >
> >      >      >      >     Alex.
> >      >      >      >
> >      >      >      >
> >      >      >      >      > On Thu, Sep 28, 2023 at 11:51?AM Alex
> >     Rousskov wrote:
> >      >      >      >      >
> >      >      >      >      >     On 2023-09-28 09:06, Fernando Giorgetti
> >     wrote:
> >      >      >      >      >      > Hi Matus, do you mean something like
> >     a DNAT
> >      >      >     (iptables) rule?
> >      >      >      >      >      > If so, I would say, it should work as
> >     well.
> >      >      >      >      >      >
> >      >      >      >      >      > But this is an environment I do not
> >     control,
> >      >     and I have
> >      >      >      >     been told
> >      >      >      >      >     to try
> >      >      >      >      >      > using an existing squid installation
> >     to proxy
> >      >      >     non-http/TLS
> >      >      >      >     data
> >      >      >      >      >     through.
> >      >      >      >      >      >
> >      >      >      >      >      > I appreciate any guidance or
> >     recommendation.
> >      >      >      >      >
> >      >      >      >      >
> >      >      >      >      >     Bugs notwithstanding, Squid can blindly
> >     tunnel
> >      >     intercepted
> >      >      >      >     (at TCP port
> >      >      >      >      >     X) TCP traffic to its intended
> destination:
> >      >      >      >      >
> >      >      >      >      >           https_port X intercept ssl-bump ...
> >      >      >      >      >           ssl_bump splice all
> >      >      >      >      >
> >      >      >      >      >
> >      >      >      >      >     Without interception, then Squid can only
> >      >     tunnel stuff
> >      >      >     inside
> >      >      >      >     HTTP
> >      >      >      >      >     CONNECT tunnels (for HTTP CONNECT
> requests
> >      >     received at TCP
> >      >      >      >     port Y):
> >      >      >      >      >
> >      >      >      >      >           http_port Y ssl-bump ...
> >      >      >      >      >           ssl_bump splice all
> >      >      >      >      >
> >      >      >      >      >
> >      >      >      >      >     In both cases, Squid does not care about
> the
> >      >     protocols
> >      >      >     that
> >      >      >      >     tunneled
> >      >      >      >      >     traffic is using. It could be HTTP,
> >     HTTPS, TLS, or
> >      >      >     anything
> >      >      >      >     else on top
> >      >      >      >      >     of TCP.
> >      >      >      >      >
> >      >      >      >      >     Your ACLs may differ from "all" in the
> above
> >      >     sketches,
> >      >      >     of course,
> >      >      >      >      >     but if
> >      >      >      >      >     traffic is not TLS, then you want an
> >     "ssl_bump
> >      >     splice"
> >      >      >     rule that
> >      >      >      >      >     matches
> >      >      >      >      >     during SslBump step1. A rule with an
> >     "all" ACLs
> >      >     is the
> >      >      >      >     simplest example
> >      >      >      >      >     of that.
> >      >      >      >      >
> >      >      >      >      >
> >      >      >      >      >     HTH,
> >      >      >      >      >
> >      >      >      >      >     Alex.
> >      >      >      >      >     P.S. I am getting an "Internal Server
> >     Error" when
> >      >      >     following
> >      >      >      >     the haproxy
> >      >      >      >      >     link in the original question, so I
> >     cannot map what
> >      >      >     that page
> >      >      >      >     says to
> >      >      >      >      >     the configurations above.
> >      >      >      >      >
> >      >      >      >      >
> >      >      >      >      >      > On Thu, Sep 28, 2023 at 3:41?AM Matus
> >     UHLAR -
> >      >      >     fantomas wrote:
> >      >      >      >      >      >
> >      >      >      >      >      >     On 27.09.23 16:48, Fernando
> >     Giorgetti wrote:
> >      >      >      >      >      >      >I would like to know if it is
> >     possible
> >      >     to set up
> >      >      >      >     Squid to
> >      >      >      >      >     perform
> >      >      >      >      >      >      >TLS passthrough to a given
> backend,
> >      >     relaying TLS
> >      >      >      >     encrypted
> >      >      >      >      >      >      >traffic to the backend,
> >     similarly to
> >      >     what HAProxy
> >      >      >      >     does below?
> >      >      >      >      >      >      >
> >      >      >      >      >      >
> >      >      >      >      >
> >      >      >      >
> >      >      >
> >      >
> >      >
> https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough
> >      >      >      >      >      >      >
> >      >      >      >      >      >      >I have tried a few different
> >      >     configurations using
> >      >      >      >     reverse
> >      >      >      >      >     proxy,
> >      >      >      >      >      >      >or peek and splice, but I could
> not
> >      >     make it
> >      >      >     work without
> >      >      >      >      >     providing
> >      >      >      >      >      >      >a valid HTTP request or a
> >     CONNECT request.
> >      >      >      >      >      >
> >      >      >      >      >      >     what's the difference between TCP
> >      >     redirect and
> >      >      >     this?
> >      >      >      >      >      >
> >      >      >      >      >      >     --
> >      >      >      >      >      >     Depression is merely anger without
> >      >     enthusiasm.
>
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230929/a992f2c0/attachment.htm>

From rousskov at measurement-factory.com  Fri Sep 29 21:13:18 2023
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Fri, 29 Sep 2023 17:13:18 -0400
Subject: [squid-users] TLS passthrough
In-Reply-To: <CADxZ=iWJ_g8KQ1wYoah-EcLXuAx1MgXqJhCFoJ8xfg3t6GZmug@mail.gmail.com>
References: <CADxZ=iVSpT0VYTZS0ZhnnQNP_1mg+PZNzGmWc9cR3mYnos1p_g@mail.gmail.com>
 <ZRUgFYjFwpnK8hdO@fantomas.sk>
 <CADxZ=iWnO0mUnUhC6cNV48wH5ET_kChZi=rgCy--9zDbwWgqwg@mail.gmail.com>
 <42994367-b30d-443b-b88c-8df94a5632ff@measurement-factory.com>
 <CADxZ=iX=0fpqyv9L8koUPuCCDuA3j8iEqdizqLPcFsgBSQuEJw@mail.gmail.com>
 <e1c49be1-597a-47e7-96e3-5f036d3024a5@measurement-factory.com>
 <CADxZ=iV2sfFOYXWC=gRa_d53M2GK6WjXt_P+aNK6cFCUoSdpig@mail.gmail.com>
 <4d494271-f038-4209-b99a-bf8e08cbc42c@measurement-factory.com>
 <CADxZ=iXBfUBS3WHf66QW94=8bKX0r-8i1QtWJNrpAZ6Z4Cm_2g@mail.gmail.com>
 <00c74d5d-7b8f-470e-aa63-1e87d7224f57@measurement-factory.com>
 <CADxZ=iVq79jruOgXA6TBw0guVSzeN=mZwLF33LVyCd1e2UTBJQ@mail.gmail.com>
 <6b73642d-0148-4c1e-a822-3d88a3f02cb7@measurement-factory.com>
 <CADxZ=iWxMA3avGOtYsAqg8K1_ti7asfAev=Htb3+_xicChYgtw@mail.gmail.com>
 <38e0a961-318d-4b05-99d3-e824480712a1@measurement-factory.com>
 <CADxZ=iWJ_g8KQ1wYoah-EcLXuAx1MgXqJhCFoJ8xfg3t6GZmug@mail.gmail.com>
Message-ID: <13dfcdf2-b207-49ae-8b1e-9b30d25ead10@measurement-factory.com>

On 2023-09-29 13:55, Fernando Giorgetti wrote:

> The "intercept" scenario demonstrated here 
> https://wiki.squid-cache.org/ConfigExamples/Intercept/AtSource 
> makes sense to me, as we are just redirecting internal traffic into Squid,
> so the original destination IP is preserved.

> I was able to make it work and that TLS app worked just fine. The
> only constraint is that it requires that both the client and Squid
> ran on the same machine, but at least it worked perfectly.

I am very glad you are making progress. FWIW, there are also ways to 
intercept traffic from applications that do not run on the same machine 
as Squid. This is not my area of expertise, but others on the list can 
guide you if you need that kind of setup.


> Here is my squid.conf (just in case someone eventually has a similar
> issue):

Thank you!

Alex.



> acl CONNECT method CONNECT
> acl mytlsserverip dst 10.0.0.10
> http_access allow CONNECT mytlsserverip
> 
> http_port 3128
> 
> https_port 127.0.0.1:3129 intercept ssl-bump \
>  ? tls-cert=/tmp/certs/squid.pem \
>  ? tls-key=/tmp/certs/squid.key \
>  ? generate-host-certificates=off
> 
> ssl_bump splice all
> 
> 
> And here are the firewall rules I have used:
> 
> iptables -t nat -I OUTPUT -p tcp -d 10.0.0.10 --dport 55671 -j DNAT 
> --to-destination 127.0.0.1:3129 <http://127.0.0.1:3129>
> iptables -t nat -I OUTPUT --match owner --uid-owner squid ?-p tcp -d 
> 10.0.0.10 --dport 55671 -j ACCEPT
> 
> I appreciate all the guidance and discussion Matus and Alex.
> 
> Thank you,
> Fernando
> 
> On Fri, Sep 29, 2023 at 12:53?PM Alex Rousskov 
> <rousskov at measurement-factory.com 
> <mailto:rousskov at measurement-factory.com>> wrote:
> 
>     On 2023-09-29 10:55, Fernando Giorgetti wrote:
>      >? ? ?Do you control the client application? If yes, then perhaps
>     it can be
>      >? ? ?adjusted to support HTTP proxies? In other words, the client
>     will send a
>      >? ? ?plain text HTTP CONNECT request to Squid and, upon receiving
>     a 200
>      >? ? ?(Connection Established) response headers, will start using
>     TLS with the
>      >? ? ?origin server. In this case, you do not need interception.
> 
> 
>      > Nope, the client application is also used to communicate with
>     other apps in
>      > other environments.
> 
>     FWIW, "used with other apps" does not imply or explain the "nope, we do
>     not control the application" answer IMHO.
> 
> 
>      > The SNI has to be used as the client/server apps perform
>      > mutual TLS authentication.
> 
>     To avoid a misunderstanding, nothing I have said precludes the use of
>     TLS SNI by the client application. Thus, I am not sure why you are
>     saying the above.
> 
> 
>      > In order to evaluate if we can use Squid for this purpose, I have
>      > also created a basic TLS client/server app to validate what is
>      > happening. Basically my TLS client tries to connect directly to Squid
>      > IP/Port and I am indicating the SNI so that the TLS handshake
>      > passes.
> 
>     FWIW, a scenario where the client application establishes a TLS
>     connection with Squid https_port (configured as a reverse HTTPS proxy)
>     will not work for your use case AFAICT. I am not sure why you are
>     testing this. It has not been suggested on this mailing list.
> 
>     BTW, you can use ("curl" or even "openssl s_client") and "openssl
>     s_server" for basic tests. I recommend using well-known test programs
>     (instead of custom apps) because doing so makes it easier for mailing
>     list readers to understand what your test clients and servers are doing
>     (and to reproduce your setup).
> 
> 
>      > When I tried to make it work using a forward proxy with intercept and
>      > ssl_bump, I could not make Squid peek at the SNI and tunnel the
>      > request to the correct destination.
> 
>     Please note that "forward proxy with intercept" is an oxymoron -- the
>     two port modes (i.e. explicit "intercept" and default forward proxying)
>     are mutually exclusive.
> 
>     If you do not want to or cannot modify/configure the client application
>     to use Squid as a forward HTTP proxy (as I detailed earlier; see the
>     paragraph still quoted at the beginning of this message), then your
>     other choice is interception (as I detailed earlier; see the "Squid
>     supports blind tunneling of intercepted TCP connections" discussion in
>     the previous exchange).
> 
>     When Squid https_port gets an intercepted client TCP connection, Squid
>     does not need SNI to know where to forward that TCP connection. Squid
>     opens a TCP connection to the IP address where the client TCP
>     connection
>     was going (or trying to go) before it was intercepted. That intended
>     destination IP address is delivered to Squid by the OS, as a part of
>     interception mechanism/setup. TLS and SNI are not involved in this
>     process.
> 
>     If you have not tested an interception scenario, please do. If you
>     have,
>     please share your interception configuration, Squid configuration, and
>     any relevant error/problem information.
> 
> 
>     HTH,
> 
>     Alex.
> 
> 
>      > On Fri, Sep 29, 2023 at 11:35?AM Alex Rousskov wrote:
>      >
>      >? ? ?On 2023-09-29 09:17, Fernando Giorgetti wrote:
>      >
>      >? ? ? > Actually I am evaluating if Squid can be used to proxy
>     Non-HTTP/TLS
>      >? ? ? > data, as we have a restricted environment where Squid is
>      >? ? ?currently the
>      >? ? ? > only way to get out to the internet.
>      >
>      >? ? ?Yes, Squid can tunnel non-HTTP data, including TLS data.
>      >
>      >
>      >? ? ? > The idea is that the client application will open a
>     connection to
>      >? ? ?a given
>      >? ? ? > hostname and port (setting?the SNI in the TLS options),
>      >? ? ?considering that
>      >? ? ? > the given hostname/port is the actual backend they're
>     trying to
>      >? ? ?reach.
>      >
>      >? ? ?Do you control the client application? If yes, then perhaps
>     it can be
>      >? ? ?adjusted to support HTTP proxies? In other words, the client will
>      >? ? ?send a
>      >? ? ?plain text HTTP CONNECT request to Squid and, upon receiving
>     a 200
>      >? ? ?(Connection Established) response headers, will start using
>     TLS with
>      >? ? ?the
>      >? ? ?origin server. In this case, you do not need interception.
>      >
>      >
>      >? ? ? > We can either try to use a fake hostname (defined in the
>      >? ? ?/etc/hosts of the
>      >? ? ? > tls client machine) which would actually point to Squid's IP
>      >
>      >? ? ?AFAICT, faking the IP address will not work without Squid
>     source code
>      >? ? ?modifications because a non-intercepting Squid https_port
>     will want to
>      >? ? ?terminate TLS -- such a port does not support blindly
>     tunneling traffic.
>      >
>      >
>      >? ? ? > or eventually
>      >? ? ? > redirect traffic to the real destination into Squid using
>     a DNAT
>      >? ? ?rule.
>      >
>      >? ? ?I am not a DNAT expert, but this sounds like interception to
>     me. Bugs
>      >? ? ?notwithstanding, Squid supports blind tunneling of
>     intercepted TCP
>      >? ? ?connections (to their intended destination):
>      >
>      >? ? ? ? ? ?https_port X intercept ssl-bump ...
>      >? ? ? ? ? ?ssl_bump splice all
>      >
>      >? ? ?On a successful tunneling path, the above configuration does
>     not care
>      >? ? ?whether the intercepted traffic is TLS and will not peek at
>     TLS SNI,
>      >? ? ?but
>      >? ? ?nothing in your requirements necessitates SNI knowledge AFAICT.
>      >
>      >? ? ?If Squid fails to establish a TCP connection to the intended
>      >? ? ?destination
>      >? ? ?of the intercepted connection, then the situation becomes
>     more complex:
>      >? ? ?Squid (with the above configuration) assumes that the client is
>      >? ? ?speaking
>      >? ? ?TLS. Squid will attempt to bump the TLS client connection and
>     send a
>      >? ? ?Squid-generated HTTP error response to the client. AFAIK,
>     this bumping
>      >? ? ?and error sending attempt cannot be prevented in this case
>     without
>      >? ? ?Squid
>      >? ? ?source code modifications: Squid used to be able to terminate a
>      >? ? ?client-Squid connection instead of sending a Squid-generated
>     HTTP error
>      >? ? ?response (by replacing the corresponding Squid error page
>     contents with
>      >? ? ?a word "reset"). However, that feature was accidentally(?)
>     dropped in
>      >? ? ?2002 commit 76cdc28 AFAICT.
>      >
>      >
>      >? ? ?HTH,
>      >
>      >? ? ?Alex.
>      >
>      >
>      >? ? ? > But overall, it will be a 1:1 relationship, meaning, the
>      >? ? ?https_port on Squid
>      >? ? ? > would be used exclusively to this purpose of proxying from a
>      >? ? ?given source
>      >? ? ? > to a given destination.
>      >? ? ? >
>      >? ? ? > That is why I was considering a reverse-proxy, but I had
>     no luck
>      >? ? ?with it
>      >? ? ? > (actually
>      >? ? ? > I was able to proxy HTTP/HTTPS, but not non-http).
>      >? ? ? >
>      >? ? ? > Thank you again,
>      >? ? ? > Fernando
>      >? ? ? >
>      >? ? ? > On Thu, Sep 28, 2023 at 11:39?PM Alex Rousskov
>      >? ? ? > <rousskov at measurement-factory.com
>     <mailto:rousskov at measurement-factory.com>
>      >? ? ?<mailto:rousskov at measurement-factory.com
>     <mailto:rousskov at measurement-factory.com>>
>      >? ? ? > <mailto:rousskov at measurement-factory.com
>     <mailto:rousskov at measurement-factory.com>
>      >? ? ?<mailto:rousskov at measurement-factory.com
>     <mailto:rousskov at measurement-factory.com>>>> wrote:
>      >? ? ? >
>      >? ? ? >? ? ?On 2023-09-28 20:35, Fernando Giorgetti wrote:
>      >? ? ? >
>      >? ? ? >? ? ? > Do you have any recommendations on how I could have
>     it done?
>      >? ? ? >
>      >? ? ? >? ? ?I am unable to confirm whether Squid can do what you
>     want or
>      >? ? ?provide
>      >? ? ? >? ? ?configuration recommendations because I do not yet
>     know how
>      >? ? ?your Squid
>      >? ? ? >? ? ?will receive traffic (e.g., an intercepting proxy or
>     an explicit
>      >? ? ? >? ? ?forward
>      >? ? ? >? ? ?HTTP proxy), what traffic Squid will receive (e.g., TLS,
>      >? ? ?plain HTTP,
>      >? ? ? >? ? ?something else), and what you want Squid to do with
>     that traffic.
>      >? ? ? >
>      >? ? ? >? ? ?To make progress, I recommend describing the above details
>      >? ? ?(for one
>      >? ? ? >? ? ?typical use case?) and then answering any followup
>     questions.
>      >? ? ? >
>      >? ? ? >
>      >? ? ? >? ? ?Cheers,
>      >? ? ? >
>      >? ? ? >? ? ?Alex.
>      >? ? ? >
>      >? ? ? >
>      >? ? ? >? ? ? > When my tls client tries to reach the target
>      >? ? ?through?Squid, using
>      >? ? ? >? ? ? > a "ssl_bump splice", it seems like squid is trying
>     to reach
>      >? ? ? >? ? ?itself in a
>      >? ? ? >? ? ? > loop.
>      >? ? ? >? ? ? >
>      >? ? ? >? ? ? > I have also tried including a peek first, but no luck.
>      >? ? ? >? ? ? >
>      >? ? ? >? ? ? > Thanks again for all suggestions.
>      >? ? ? >? ? ? >
>      >? ? ? >? ? ? > On Thu, Sep 28, 2023 at 7:23?PM Alex Rousskov wrote:
>      >? ? ? >? ? ? >
>      >? ? ? >? ? ? >? ? ?On 2023-09-28 15:23, Fernando Giorgetti wrote:
>      >? ? ? >? ? ? >
>      >? ? ? >? ? ? >? ? ? > Actually with the suggested blind passthrough,
>      >? ? ?Squid would not
>      >? ? ? >? ? ? >? ? ?handle
>      >? ? ? >? ? ? >? ? ? > the TLS termination.
>      >? ? ? >? ? ? >
>      >? ? ? >? ? ? >? ? ?Correct.
>      >? ? ? >? ? ? >
>      >? ? ? >? ? ? >
>      >? ? ? >? ? ? >? ? ? > how will Squid know what the target is?
>      >? ? ? >? ? ? >
>      >? ? ? >? ? ? >? ? ?In many cases, Squid can learn SNI by peeking
>     at TLS
>      >? ? ?ClientHello,
>      >? ? ? >? ? ? >? ? ?without terminating TLS. Bugs notwithstanding,
>     none of the
>      >? ? ? >? ? ? >? ? ?configuration
>      >? ? ? >? ? ? >? ? ?sketches I shared previously will do that though.
>      >? ? ? >? ? ? >
>      >? ? ? >? ? ? >
>      >? ? ? >? ? ? >? ? ?HTH,
>      >? ? ? >? ? ? >
>      >? ? ? >? ? ? >? ? ?Alex.
>      >? ? ? >? ? ? >
>      >? ? ? >? ? ? >
>      >? ? ? >? ? ? >
>      >? ? ? >? ? ? >? ? ? > On Thu, Sep 28, 2023 at 1:02?PM Alex
>     Rousskov wrote:
>      >? ? ? >? ? ? >? ? ? >
>      >? ? ? >? ? ? >? ? ? >? ? ?On 2023-09-28 11:31, Fernando Giorgetti
>     wrote:
>      >? ? ? >? ? ? >? ? ? >
>      >? ? ? >? ? ? >? ? ? >? ? ? > And what should?I do to let Squid use
>     the SNI
>      >? ? ? >? ? ?defined by
>      >? ? ? >? ? ? >? ? ?the TLS
>      >? ? ? >? ? ? >? ? ? >? ? ?client?
>      >? ? ? >? ? ? >? ? ? >
>      >? ? ? >? ? ? >? ? ? >? ? ?What do you want Squid to use that SNI for?
>      >? ? ? >? ? ? >? ? ? >
>      >? ? ? >? ? ? >? ? ? >? ? ?Alex.
>      >? ? ? >? ? ? >? ? ? >
>      >? ? ? >? ? ? >? ? ? >
>      >? ? ? >? ? ? >? ? ? >? ? ? > On Thu, Sep 28, 2023 at 11:51?AM Alex
>      >? ? ?Rousskov wrote:
>      >? ? ? >? ? ? >? ? ? >? ? ? >
>      >? ? ? >? ? ? >? ? ? >? ? ? >? ? ?On 2023-09-28 09:06, Fernando
>     Giorgetti
>      >? ? ?wrote:
>      >? ? ? >? ? ? >? ? ? >? ? ? >? ? ? > Hi Matus, do you mean
>     something like
>      >? ? ?a DNAT
>      >? ? ? >? ? ? >? ? ?(iptables) rule?
>      >? ? ? >? ? ? >? ? ? >? ? ? >? ? ? > If so, I would say, it should
>     work as
>      >? ? ?well.
>      >? ? ? >? ? ? >? ? ? >? ? ? >? ? ? >
>      >? ? ? >? ? ? >? ? ? >? ? ? >? ? ? > But this is an environment I
>     do not
>      >? ? ?control,
>      >? ? ? >? ? ?and I have
>      >? ? ? >? ? ? >? ? ? >? ? ?been told
>      >? ? ? >? ? ? >? ? ? >? ? ? >? ? ?to try
>      >? ? ? >? ? ? >? ? ? >? ? ? >? ? ? > using an existing squid
>     installation
>      >? ? ?to proxy
>      >? ? ? >? ? ? >? ? ?non-http/TLS
>      >? ? ? >? ? ? >? ? ? >? ? ?data
>      >? ? ? >? ? ? >? ? ? >? ? ? >? ? ?through.
>      >? ? ? >? ? ? >? ? ? >? ? ? >? ? ? >
>      >? ? ? >? ? ? >? ? ? >? ? ? >? ? ? > I appreciate any guidance or
>      >? ? ?recommendation.
>      >? ? ? >? ? ? >? ? ? >? ? ? >
>      >? ? ? >? ? ? >? ? ? >? ? ? >
>      >? ? ? >? ? ? >? ? ? >? ? ? >? ? ?Bugs notwithstanding, Squid can
>     blindly
>      >? ? ?tunnel
>      >? ? ? >? ? ?intercepted
>      >? ? ? >? ? ? >? ? ? >? ? ?(at TCP port
>      >? ? ? >? ? ? >? ? ? >? ? ? >? ? ?X) TCP traffic to its intended
>     destination:
>      >? ? ? >? ? ? >? ? ? >? ? ? >
>      >? ? ? >? ? ? >? ? ? >? ? ? >? ? ? ? ? ?https_port X intercept
>     ssl-bump ...
>      >? ? ? >? ? ? >? ? ? >? ? ? >? ? ? ? ? ?ssl_bump splice all
>      >? ? ? >? ? ? >? ? ? >? ? ? >
>      >? ? ? >? ? ? >? ? ? >? ? ? >
>      >? ? ? >? ? ? >? ? ? >? ? ? >? ? ?Without interception, then Squid
>     can only
>      >? ? ? >? ? ?tunnel stuff
>      >? ? ? >? ? ? >? ? ?inside
>      >? ? ? >? ? ? >? ? ? >? ? ?HTTP
>      >? ? ? >? ? ? >? ? ? >? ? ? >? ? ?CONNECT tunnels (for HTTP CONNECT
>     requests
>      >? ? ? >? ? ?received at TCP
>      >? ? ? >? ? ? >? ? ? >? ? ?port Y):
>      >? ? ? >? ? ? >? ? ? >? ? ? >
>      >? ? ? >? ? ? >? ? ? >? ? ? >? ? ? ? ? ?http_port Y ssl-bump ...
>      >? ? ? >? ? ? >? ? ? >? ? ? >? ? ? ? ? ?ssl_bump splice all
>      >? ? ? >? ? ? >? ? ? >? ? ? >
>      >? ? ? >? ? ? >? ? ? >? ? ? >
>      >? ? ? >? ? ? >? ? ? >? ? ? >? ? ?In both cases, Squid does not
>     care about the
>      >? ? ? >? ? ?protocols
>      >? ? ? >? ? ? >? ? ?that
>      >? ? ? >? ? ? >? ? ? >? ? ?tunneled
>      >? ? ? >? ? ? >? ? ? >? ? ? >? ? ?traffic is using. It could be HTTP,
>      >? ? ?HTTPS, TLS, or
>      >? ? ? >? ? ? >? ? ?anything
>      >? ? ? >? ? ? >? ? ? >? ? ?else on top
>      >? ? ? >? ? ? >? ? ? >? ? ? >? ? ?of TCP.
>      >? ? ? >? ? ? >? ? ? >? ? ? >
>      >? ? ? >? ? ? >? ? ? >? ? ? >? ? ?Your ACLs may differ from "all"
>     in the above
>      >? ? ? >? ? ?sketches,
>      >? ? ? >? ? ? >? ? ?of course,
>      >? ? ? >? ? ? >? ? ? >? ? ? >? ? ?but if
>      >? ? ? >? ? ? >? ? ? >? ? ? >? ? ?traffic is not TLS, then you want an
>      >? ? ?"ssl_bump
>      >? ? ? >? ? ?splice"
>      >? ? ? >? ? ? >? ? ?rule that
>      >? ? ? >? ? ? >? ? ? >? ? ? >? ? ?matches
>      >? ? ? >? ? ? >? ? ? >? ? ? >? ? ?during SslBump step1. A rule with an
>      >? ? ?"all" ACLs
>      >? ? ? >? ? ?is the
>      >? ? ? >? ? ? >? ? ? >? ? ?simplest example
>      >? ? ? >? ? ? >? ? ? >? ? ? >? ? ?of that.
>      >? ? ? >? ? ? >? ? ? >? ? ? >
>      >? ? ? >? ? ? >? ? ? >? ? ? >
>      >? ? ? >? ? ? >? ? ? >? ? ? >? ? ?HTH,
>      >? ? ? >? ? ? >? ? ? >? ? ? >
>      >? ? ? >? ? ? >? ? ? >? ? ? >? ? ?Alex.
>      >? ? ? >? ? ? >? ? ? >? ? ? >? ? ?P.S. I am getting an "Internal Server
>      >? ? ?Error" when
>      >? ? ? >? ? ? >? ? ?following
>      >? ? ? >? ? ? >? ? ? >? ? ?the haproxy
>      >? ? ? >? ? ? >? ? ? >? ? ? >? ? ?link in the original question, so I
>      >? ? ?cannot map what
>      >? ? ? >? ? ? >? ? ?that page
>      >? ? ? >? ? ? >? ? ? >? ? ?says to
>      >? ? ? >? ? ? >? ? ? >? ? ? >? ? ?the configurations above.
>      >? ? ? >? ? ? >? ? ? >? ? ? >
>      >? ? ? >? ? ? >? ? ? >? ? ? >
>      >? ? ? >? ? ? >? ? ? >? ? ? >? ? ? > On Thu, Sep 28, 2023 at
>     3:41?AM Matus
>      >? ? ?UHLAR -
>      >? ? ? >? ? ? >? ? ?fantomas wrote:
>      >? ? ? >? ? ? >? ? ? >? ? ? >? ? ? >
>      >? ? ? >? ? ? >? ? ? >? ? ? >? ? ? >? ? ?On 27.09.23 16:48, Fernando
>      >? ? ?Giorgetti wrote:
>      >? ? ? >? ? ? >? ? ? >? ? ? >? ? ? >? ? ? >I would like to know if
>     it is
>      >? ? ?possible
>      >? ? ? >? ? ?to set up
>      >? ? ? >? ? ? >? ? ? >? ? ?Squid to
>      >? ? ? >? ? ? >? ? ? >? ? ? >? ? ?perform
>      >? ? ? >? ? ? >? ? ? >? ? ? >? ? ? >? ? ? >TLS passthrough to a
>     given backend,
>      >? ? ? >? ? ?relaying TLS
>      >? ? ? >? ? ? >? ? ? >? ? ?encrypted
>      >? ? ? >? ? ? >? ? ? >? ? ? >? ? ? >? ? ? >traffic to the backend,
>      >? ? ?similarly to
>      >? ? ? >? ? ?what HAProxy
>      >? ? ? >? ? ? >? ? ? >? ? ?does below?
>      >? ? ? >? ? ? >? ? ? >? ? ? >? ? ? >? ? ? >
>      >? ? ? >? ? ? >? ? ? >? ? ? >? ? ? >
>      >? ? ? >? ? ? >? ? ? >? ? ? >
>      >? ? ? >? ? ? >? ? ? >
>      >? ? ? >? ? ? >
>      >? ? ? >
>      >     
>      >https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough <https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough>
>      >? ? ? >? ? ? >? ? ? >? ? ? >? ? ? >? ? ? >
>      >? ? ? >? ? ? >? ? ? >? ? ? >? ? ? >? ? ? >I have tried a few different
>      >? ? ? >? ? ?configurations using
>      >? ? ? >? ? ? >? ? ? >? ? ?reverse
>      >? ? ? >? ? ? >? ? ? >? ? ? >? ? ?proxy,
>      >? ? ? >? ? ? >? ? ? >? ? ? >? ? ? >? ? ? >or peek and splice, but
>     I could not
>      >? ? ? >? ? ?make it
>      >? ? ? >? ? ? >? ? ?work without
>      >? ? ? >? ? ? >? ? ? >? ? ? >? ? ?providing
>      >? ? ? >? ? ? >? ? ? >? ? ? >? ? ? >? ? ? >a valid HTTP request or a
>      >? ? ?CONNECT request.
>      >? ? ? >? ? ? >? ? ? >? ? ? >? ? ? >
>      >? ? ? >? ? ? >? ? ? >? ? ? >? ? ? >? ? ?what's the difference
>     between TCP
>      >? ? ? >? ? ?redirect and
>      >? ? ? >? ? ? >? ? ?this?
>      >? ? ? >? ? ? >? ? ? >? ? ? >? ? ? >
>      >? ? ? >? ? ? >? ? ? >? ? ? >? ? ? >? ? ?--
>      >? ? ? >? ? ? >? ? ? >? ? ? >? ? ? >? ? ?Depression is merely anger
>     without
>      >? ? ? >? ? ?enthusiasm.
> 



From fgiorgetti at gmail.com  Fri Sep 29 22:06:56 2023
From: fgiorgetti at gmail.com (Fernando Giorgetti)
Date: Fri, 29 Sep 2023 19:06:56 -0300
Subject: [squid-users] TLS passthrough
In-Reply-To: <13dfcdf2-b207-49ae-8b1e-9b30d25ead10@measurement-factory.com>
References: <CADxZ=iVSpT0VYTZS0ZhnnQNP_1mg+PZNzGmWc9cR3mYnos1p_g@mail.gmail.com>
 <ZRUgFYjFwpnK8hdO@fantomas.sk>
 <CADxZ=iWnO0mUnUhC6cNV48wH5ET_kChZi=rgCy--9zDbwWgqwg@mail.gmail.com>
 <42994367-b30d-443b-b88c-8df94a5632ff@measurement-factory.com>
 <CADxZ=iX=0fpqyv9L8koUPuCCDuA3j8iEqdizqLPcFsgBSQuEJw@mail.gmail.com>
 <e1c49be1-597a-47e7-96e3-5f036d3024a5@measurement-factory.com>
 <CADxZ=iV2sfFOYXWC=gRa_d53M2GK6WjXt_P+aNK6cFCUoSdpig@mail.gmail.com>
 <4d494271-f038-4209-b99a-bf8e08cbc42c@measurement-factory.com>
 <CADxZ=iXBfUBS3WHf66QW94=8bKX0r-8i1QtWJNrpAZ6Z4Cm_2g@mail.gmail.com>
 <00c74d5d-7b8f-470e-aa63-1e87d7224f57@measurement-factory.com>
 <CADxZ=iVq79jruOgXA6TBw0guVSzeN=mZwLF33LVyCd1e2UTBJQ@mail.gmail.com>
 <6b73642d-0148-4c1e-a822-3d88a3f02cb7@measurement-factory.com>
 <CADxZ=iWxMA3avGOtYsAqg8K1_ti7asfAev=Htb3+_xicChYgtw@mail.gmail.com>
 <38e0a961-318d-4b05-99d3-e824480712a1@measurement-factory.com>
 <CADxZ=iWJ_g8KQ1wYoah-EcLXuAx1MgXqJhCFoJ8xfg3t6GZmug@mail.gmail.com>
 <13dfcdf2-b207-49ae-8b1e-9b30d25ead10@measurement-factory.com>
Message-ID: <CADxZ=iVv0FLTTKNng0fQ961SU7UeOUrdHbk9-P1ixDeEUX-=mA@mail.gmail.com>

If someone has already done that, with the client running in a different
machine, I would love to know how.

In case Squid runs on the same machine used as a network gateway to the
client machine, I suppose the config would be similar, but if it's not
running on the same machine used as the gateway, then it would be nice to
see how.

Thanks

Em sex., 29 de set. de 2023 18:13, Alex Rousskov <
rousskov at measurement-factory.com> escreveu:

> On 2023-09-29 13:55, Fernando Giorgetti wrote:
>
> > The "intercept" scenario demonstrated here
> > https://wiki.squid-cache.org/ConfigExamples/Intercept/AtSource
> > makes sense to me, as we are just redirecting internal traffic into
> Squid,
> > so the original destination IP is preserved.
>
> > I was able to make it work and that TLS app worked just fine. The
> > only constraint is that it requires that both the client and Squid
> > ran on the same machine, but at least it worked perfectly.
>
> I am very glad you are making progress. FWIW, there are also ways to
> intercept traffic from applications that do not run on the same machine
> as Squid. This is not my area of expertise, but others on the list can
> guide you if you need that kind of setup.
>
>
> > Here is my squid.conf (just in case someone eventually has a similar
> > issue):
>
> Thank you!
>
> Alex.
>
>
>
> > acl CONNECT method CONNECT
> > acl mytlsserverip dst 10.0.0.10
> > http_access allow CONNECT mytlsserverip
> >
> > http_port 3128
> >
> > https_port 127.0.0.1:3129 intercept ssl-bump \
> >    tls-cert=/tmp/certs/squid.pem \
> >    tls-key=/tmp/certs/squid.key \
> >    generate-host-certificates=off
> >
> > ssl_bump splice all
> >
> >
> > And here are the firewall rules I have used:
> >
> > iptables -t nat -I OUTPUT -p tcp -d 10.0.0.10 --dport 55671 -j DNAT
> > --to-destination 127.0.0.1:3129 <http://127.0.0.1:3129>
> > iptables -t nat -I OUTPUT --match owner --uid-owner squid  -p tcp -d
> > 10.0.0.10 --dport 55671 -j ACCEPT
> >
> > I appreciate all the guidance and discussion Matus and Alex.
> >
> > Thank you,
> > Fernando
> >
> > On Fri, Sep 29, 2023 at 12:53?PM Alex Rousskov
> > <rousskov at measurement-factory.com
> > <mailto:rousskov at measurement-factory.com>> wrote:
> >
> >     On 2023-09-29 10:55, Fernando Giorgetti wrote:
> >      >     Do you control the client application? If yes, then perhaps
> >     it can be
> >      >     adjusted to support HTTP proxies? In other words, the client
> >     will send a
> >      >     plain text HTTP CONNECT request to Squid and, upon receiving
> >     a 200
> >      >     (Connection Established) response headers, will start using
> >     TLS with the
> >      >     origin server. In this case, you do not need interception.
> >
> >
> >      > Nope, the client application is also used to communicate with
> >     other apps in
> >      > other environments.
> >
> >     FWIW, "used with other apps" does not imply or explain the "nope, we
> do
> >     not control the application" answer IMHO.
> >
> >
> >      > The SNI has to be used as the client/server apps perform
> >      > mutual TLS authentication.
> >
> >     To avoid a misunderstanding, nothing I have said precludes the use of
> >     TLS SNI by the client application. Thus, I am not sure why you are
> >     saying the above.
> >
> >
> >      > In order to evaluate if we can use Squid for this purpose, I have
> >      > also created a basic TLS client/server app to validate what is
> >      > happening. Basically my TLS client tries to connect directly to
> Squid
> >      > IP/Port and I am indicating the SNI so that the TLS handshake
> >      > passes.
> >
> >     FWIW, a scenario where the client application establishes a TLS
> >     connection with Squid https_port (configured as a reverse HTTPS
> proxy)
> >     will not work for your use case AFAICT. I am not sure why you are
> >     testing this. It has not been suggested on this mailing list.
> >
> >     BTW, you can use ("curl" or even "openssl s_client") and "openssl
> >     s_server" for basic tests. I recommend using well-known test programs
> >     (instead of custom apps) because doing so makes it easier for mailing
> >     list readers to understand what your test clients and servers are
> doing
> >     (and to reproduce your setup).
> >
> >
> >      > When I tried to make it work using a forward proxy with intercept
> and
> >      > ssl_bump, I could not make Squid peek at the SNI and tunnel the
> >      > request to the correct destination.
> >
> >     Please note that "forward proxy with intercept" is an oxymoron -- the
> >     two port modes (i.e. explicit "intercept" and default forward
> proxying)
> >     are mutually exclusive.
> >
> >     If you do not want to or cannot modify/configure the client
> application
> >     to use Squid as a forward HTTP proxy (as I detailed earlier; see the
> >     paragraph still quoted at the beginning of this message), then your
> >     other choice is interception (as I detailed earlier; see the "Squid
> >     supports blind tunneling of intercepted TCP connections" discussion
> in
> >     the previous exchange).
> >
> >     When Squid https_port gets an intercepted client TCP connection,
> Squid
> >     does not need SNI to know where to forward that TCP connection. Squid
> >     opens a TCP connection to the IP address where the client TCP
> >     connection
> >     was going (or trying to go) before it was intercepted. That intended
> >     destination IP address is delivered to Squid by the OS, as a part of
> >     interception mechanism/setup. TLS and SNI are not involved in this
> >     process.
> >
> >     If you have not tested an interception scenario, please do. If you
> >     have,
> >     please share your interception configuration, Squid configuration,
> and
> >     any relevant error/problem information.
> >
> >
> >     HTH,
> >
> >     Alex.
> >
> >
> >      > On Fri, Sep 29, 2023 at 11:35?AM Alex Rousskov wrote:
> >      >
> >      >     On 2023-09-29 09:17, Fernando Giorgetti wrote:
> >      >
> >      >      > Actually I am evaluating if Squid can be used to proxy
> >     Non-HTTP/TLS
> >      >      > data, as we have a restricted environment where Squid is
> >      >     currently the
> >      >      > only way to get out to the internet.
> >      >
> >      >     Yes, Squid can tunnel non-HTTP data, including TLS data.
> >      >
> >      >
> >      >      > The idea is that the client application will open a
> >     connection to
> >      >     a given
> >      >      > hostname and port (setting the SNI in the TLS options),
> >      >     considering that
> >      >      > the given hostname/port is the actual backend they're
> >     trying to
> >      >     reach.
> >      >
> >      >     Do you control the client application? If yes, then perhaps
> >     it can be
> >      >     adjusted to support HTTP proxies? In other words, the client
> will
> >      >     send a
> >      >     plain text HTTP CONNECT request to Squid and, upon receiving
> >     a 200
> >      >     (Connection Established) response headers, will start using
> >     TLS with
> >      >     the
> >      >     origin server. In this case, you do not need interception.
> >      >
> >      >
> >      >      > We can either try to use a fake hostname (defined in the
> >      >     /etc/hosts of the
> >      >      > tls client machine) which would actually point to Squid's
> IP
> >      >
> >      >     AFAICT, faking the IP address will not work without Squid
> >     source code
> >      >     modifications because a non-intercepting Squid https_port
> >     will want to
> >      >     terminate TLS -- such a port does not support blindly
> >     tunneling traffic.
> >      >
> >      >
> >      >      > or eventually
> >      >      > redirect traffic to the real destination into Squid using
> >     a DNAT
> >      >     rule.
> >      >
> >      >     I am not a DNAT expert, but this sounds like interception to
> >     me. Bugs
> >      >     notwithstanding, Squid supports blind tunneling of
> >     intercepted TCP
> >      >     connections (to their intended destination):
> >      >
> >      >           https_port X intercept ssl-bump ...
> >      >           ssl_bump splice all
> >      >
> >      >     On a successful tunneling path, the above configuration does
> >     not care
> >      >     whether the intercepted traffic is TLS and will not peek at
> >     TLS SNI,
> >      >     but
> >      >     nothing in your requirements necessitates SNI knowledge
> AFAICT.
> >      >
> >      >     If Squid fails to establish a TCP connection to the intended
> >      >     destination
> >      >     of the intercepted connection, then the situation becomes
> >     more complex:
> >      >     Squid (with the above configuration) assumes that the client
> is
> >      >     speaking
> >      >     TLS. Squid will attempt to bump the TLS client connection and
> >     send a
> >      >     Squid-generated HTTP error response to the client. AFAIK,
> >     this bumping
> >      >     and error sending attempt cannot be prevented in this case
> >     without
> >      >     Squid
> >      >     source code modifications: Squid used to be able to terminate
> a
> >      >     client-Squid connection instead of sending a Squid-generated
> >     HTTP error
> >      >     response (by replacing the corresponding Squid error page
> >     contents with
> >      >     a word "reset"). However, that feature was accidentally(?)
> >     dropped in
> >      >     2002 commit 76cdc28 AFAICT.
> >      >
> >      >
> >      >     HTH,
> >      >
> >      >     Alex.
> >      >
> >      >
> >      >      > But overall, it will be a 1:1 relationship, meaning, the
> >      >     https_port on Squid
> >      >      > would be used exclusively to this purpose of proxying from
> a
> >      >     given source
> >      >      > to a given destination.
> >      >      >
> >      >      > That is why I was considering a reverse-proxy, but I had
> >     no luck
> >      >     with it
> >      >      > (actually
> >      >      > I was able to proxy HTTP/HTTPS, but not non-http).
> >      >      >
> >      >      > Thank you again,
> >      >      > Fernando
> >      >      >
> >      >      > On Thu, Sep 28, 2023 at 11:39?PM Alex Rousskov
> >      >      > <rousskov at measurement-factory.com
> >     <mailto:rousskov at measurement-factory.com>
> >      >     <mailto:rousskov at measurement-factory.com
> >     <mailto:rousskov at measurement-factory.com>>
> >      >      > <mailto:rousskov at measurement-factory.com
> >     <mailto:rousskov at measurement-factory.com>
> >      >     <mailto:rousskov at measurement-factory.com
> >     <mailto:rousskov at measurement-factory.com>>>> wrote:
> >      >      >
> >      >      >     On 2023-09-28 20:35, Fernando Giorgetti wrote:
> >      >      >
> >      >      >      > Do you have any recommendations on how I could have
> >     it done?
> >      >      >
> >      >      >     I am unable to confirm whether Squid can do what you
> >     want or
> >      >     provide
> >      >      >     configuration recommendations because I do not yet
> >     know how
> >      >     your Squid
> >      >      >     will receive traffic (e.g., an intercepting proxy or
> >     an explicit
> >      >      >     forward
> >      >      >     HTTP proxy), what traffic Squid will receive (e.g.,
> TLS,
> >      >     plain HTTP,
> >      >      >     something else), and what you want Squid to do with
> >     that traffic.
> >      >      >
> >      >      >     To make progress, I recommend describing the above
> details
> >      >     (for one
> >      >      >     typical use case?) and then answering any followup
> >     questions.
> >      >      >
> >      >      >
> >      >      >     Cheers,
> >      >      >
> >      >      >     Alex.
> >      >      >
> >      >      >
> >      >      >      > When my tls client tries to reach the target
> >      >     through Squid, using
> >      >      >      > a "ssl_bump splice", it seems like squid is trying
> >     to reach
> >      >      >     itself in a
> >      >      >      > loop.
> >      >      >      >
> >      >      >      > I have also tried including a peek first, but no
> luck.
> >      >      >      >
> >      >      >      > Thanks again for all suggestions.
> >      >      >      >
> >      >      >      > On Thu, Sep 28, 2023 at 7:23?PM Alex Rousskov wrote:
> >      >      >      >
> >      >      >      >     On 2023-09-28 15:23, Fernando Giorgetti wrote:
> >      >      >      >
> >      >      >      >      > Actually with the suggested blind
> passthrough,
> >      >     Squid would not
> >      >      >      >     handle
> >      >      >      >      > the TLS termination.
> >      >      >      >
> >      >      >      >     Correct.
> >      >      >      >
> >      >      >      >
> >      >      >      >      > how will Squid know what the target is?
> >      >      >      >
> >      >      >      >     In many cases, Squid can learn SNI by peeking
> >     at TLS
> >      >     ClientHello,
> >      >      >      >     without terminating TLS. Bugs notwithstanding,
> >     none of the
> >      >      >      >     configuration
> >      >      >      >     sketches I shared previously will do that
> though.
> >      >      >      >
> >      >      >      >
> >      >      >      >     HTH,
> >      >      >      >
> >      >      >      >     Alex.
> >      >      >      >
> >      >      >      >
> >      >      >      >
> >      >      >      >      > On Thu, Sep 28, 2023 at 1:02?PM Alex
> >     Rousskov wrote:
> >      >      >      >      >
> >      >      >      >      >     On 2023-09-28 11:31, Fernando Giorgetti
> >     wrote:
> >      >      >      >      >
> >      >      >      >      >      > And what should I do to let Squid use
> >     the SNI
> >      >      >     defined by
> >      >      >      >     the TLS
> >      >      >      >      >     client?
> >      >      >      >      >
> >      >      >      >      >     What do you want Squid to use that SNI
> for?
> >      >      >      >      >
> >      >      >      >      >     Alex.
> >      >      >      >      >
> >      >      >      >      >
> >      >      >      >      >      > On Thu, Sep 28, 2023 at 11:51?AM Alex
> >      >     Rousskov wrote:
> >      >      >      >      >      >
> >      >      >      >      >      >     On 2023-09-28 09:06, Fernando
> >     Giorgetti
> >      >     wrote:
> >      >      >      >      >      >      > Hi Matus, do you mean
> >     something like
> >      >     a DNAT
> >      >      >      >     (iptables) rule?
> >      >      >      >      >      >      > If so, I would say, it should
> >     work as
> >      >     well.
> >      >      >      >      >      >      >
> >      >      >      >      >      >      > But this is an environment I
> >     do not
> >      >     control,
> >      >      >     and I have
> >      >      >      >      >     been told
> >      >      >      >      >      >     to try
> >      >      >      >      >      >      > using an existing squid
> >     installation
> >      >     to proxy
> >      >      >      >     non-http/TLS
> >      >      >      >      >     data
> >      >      >      >      >      >     through.
> >      >      >      >      >      >      >
> >      >      >      >      >      >      > I appreciate any guidance or
> >      >     recommendation.
> >      >      >      >      >      >
> >      >      >      >      >      >
> >      >      >      >      >      >     Bugs notwithstanding, Squid can
> >     blindly
> >      >     tunnel
> >      >      >     intercepted
> >      >      >      >      >     (at TCP port
> >      >      >      >      >      >     X) TCP traffic to its intended
> >     destination:
> >      >      >      >      >      >
> >      >      >      >      >      >           https_port X intercept
> >     ssl-bump ...
> >      >      >      >      >      >           ssl_bump splice all
> >      >      >      >      >      >
> >      >      >      >      >      >
> >      >      >      >      >      >     Without interception, then Squid
> >     can only
> >      >      >     tunnel stuff
> >      >      >      >     inside
> >      >      >      >      >     HTTP
> >      >      >      >      >      >     CONNECT tunnels (for HTTP CONNECT
> >     requests
> >      >      >     received at TCP
> >      >      >      >      >     port Y):
> >      >      >      >      >      >
> >      >      >      >      >      >           http_port Y ssl-bump ...
> >      >      >      >      >      >           ssl_bump splice all
> >      >      >      >      >      >
> >      >      >      >      >      >
> >      >      >      >      >      >     In both cases, Squid does not
> >     care about the
> >      >      >     protocols
> >      >      >      >     that
> >      >      >      >      >     tunneled
> >      >      >      >      >      >     traffic is using. It could be
> HTTP,
> >      >     HTTPS, TLS, or
> >      >      >      >     anything
> >      >      >      >      >     else on top
> >      >      >      >      >      >     of TCP.
> >      >      >      >      >      >
> >      >      >      >      >      >     Your ACLs may differ from "all"
> >     in the above
> >      >      >     sketches,
> >      >      >      >     of course,
> >      >      >      >      >      >     but if
> >      >      >      >      >      >     traffic is not TLS, then you want
> an
> >      >     "ssl_bump
> >      >      >     splice"
> >      >      >      >     rule that
> >      >      >      >      >      >     matches
> >      >      >      >      >      >     during SslBump step1. A rule with
> an
> >      >     "all" ACLs
> >      >      >     is the
> >      >      >      >      >     simplest example
> >      >      >      >      >      >     of that.
> >      >      >      >      >      >
> >      >      >      >      >      >
> >      >      >      >      >      >     HTH,
> >      >      >      >      >      >
> >      >      >      >      >      >     Alex.
> >      >      >      >      >      >     P.S. I am getting an "Internal
> Server
> >      >     Error" when
> >      >      >      >     following
> >      >      >      >      >     the haproxy
> >      >      >      >      >      >     link in the original question, so
> I
> >      >     cannot map what
> >      >      >      >     that page
> >      >      >      >      >     says to
> >      >      >      >      >      >     the configurations above.
> >      >      >      >      >      >
> >      >      >      >      >      >
> >      >      >      >      >      >      > On Thu, Sep 28, 2023 at
> >     3:41?AM Matus
> >      >     UHLAR -
> >      >      >      >     fantomas wrote:
> >      >      >      >      >      >      >
> >      >      >      >      >      >      >     On 27.09.23 16:48, Fernando
> >      >     Giorgetti wrote:
> >      >      >      >      >      >      >      >I would like to know if
> >     it is
> >      >     possible
> >      >      >     to set up
> >      >      >      >      >     Squid to
> >      >      >      >      >      >     perform
> >      >      >      >      >      >      >      >TLS passthrough to a
> >     given backend,
> >      >      >     relaying TLS
> >      >      >      >      >     encrypted
> >      >      >      >      >      >      >      >traffic to the backend,
> >      >     similarly to
> >      >      >     what HAProxy
> >      >      >      >      >     does below?
> >      >      >      >      >      >      >      >
> >      >      >      >      >      >      >
> >      >      >      >      >      >
> >      >      >      >      >
> >      >      >      >
> >      >      >
> >      >
> >      >
> https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough
> <
> https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough
> >
> >      >      >      >      >      >      >      >
> >      >      >      >      >      >      >      >I have tried a few
> different
> >      >      >     configurations using
> >      >      >      >      >     reverse
> >      >      >      >      >      >     proxy,
> >      >      >      >      >      >      >      >or peek and splice, but
> >     I could not
> >      >      >     make it
> >      >      >      >     work without
> >      >      >      >      >      >     providing
> >      >      >      >      >      >      >      >a valid HTTP request or a
> >      >     CONNECT request.
> >      >      >      >      >      >      >
> >      >      >      >      >      >      >     what's the difference
> >     between TCP
> >      >      >     redirect and
> >      >      >      >     this?
> >      >      >      >      >      >      >
> >      >      >      >      >      >      >     --
> >      >      >      >      >      >      >     Depression is merely anger
> >     without
> >      >      >     enthusiasm.
> >
>
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230929/76b35cff/attachment.htm>

From bud_miljkovic at trimble.com  Sat Sep 30 02:58:02 2023
From: bud_miljkovic at trimble.com (Bud Miljkovic)
Date: Sat, 30 Sep 2023 15:58:02 +1300
Subject: [squid-users] [ext] Squid quits while starting?!
Message-ID: <CAPO8noJ9R8Tf3z1yp4gR3ameZOWO69F==Hgq9mtx3uP_k0aB6Q@mail.gmail.com>

Ralf.Hildebrandt wrote to *Bud Miljkovic* <bud_miljkovic at trimble.com>:

> # Intercept transparent HTTPS traffic
> https_port 3129 intercept ssl-bump cert=/etc/squid/ssl_cert/myCA.pem
> generate-host-certificates=on dynamic_cert_mem_cache_size=4MB
> ssl_bump splice all
> sslcrtd_program /usr/libexec/ssl_crtd -s /var/lib/ssl_db -M 4MB

^ I think the portion above is relevant for this error

> 2023/09/29 15:02:52| helperOpenServers: Starting 5/32 'ssl_crtd' processes
...
> 2023/09/29 15:02:52| Accepting NAT intercepted SSL bumped HTTPS Socket
connections at local=[::]:3129 remote=[::] FD 29 flags=41
> 2023/09/29 15:02:52| WARNING: ssl_crtd #Hlpr1 exited
> 2023/09/29 15:02:52| Too few ssl_crtd processes are running (need 1/32)
> 2023/09/29 15:02:52| Closing HTTP port [::]:3128
> 2023/09/29 15:02:52| Closing HTTPS port [::]:3129
> FATAL: The ssl_crtd helpers are crashing too rapidly, need help!

I assume the "sslcrtd_program" (set to "/usr/libexec/ssl_crtd -s
/var/lib/ssl_db -M 4MB")
is indeed not starting up (or crashing immediately after).

* What does "dmesg" report? *>>> **Could not get anything relevant!*

* What happens if you invoke "/usr/libexec/ssl_crtd -s /var/lib/ssl_db -M
4MB"
  by hand (as the squid user, I guess)
*>>> *(1) Executing manually:
r2:/# /usr/libexec/ssl_crtd -s /var/lib/ssl_db -M 4MB
/usr/libexec/ssl_crtd: Uninitialized SSL certificate database directory:
/var/lib/ssl_db. To initialize, run "ssl_crtd -c -s /var/lib/ssl_db".
*Where:*
r2:/# ls -l /usr/libexec/ssl_crtd
-rwxr-xr-x    1 root     root         63884 Sep 27 23:06
/usr/libexec/ssl_crtd


*I do not quite get "To initialize, run "ssl_crtd -c -s /var/lib/ssl_db":?*

*I am executing all this manually as the root user.*
*When I do:*
r2:/# cd /usr/libexec/
r2:/usr/libexec# ls -l ssl_crtd
-rwxr-xr-x    1 root     root         63884 Sep 27 23:06 ssl_crtd
*However, when I try to run this:*
r2:/usr/libexec# ssl_crtd -c -s /var/lib/ssl_db
-sh: ssl_crtd: command not found  *>>>* *?!*

*I.e. ssl_crtd is not executable from its directory and it is owned by the
root*
*This is very confusing to me?!*

*Also, with another level of debugging it can be seen that:*
```
........
2023/09/30 14:16:31.899| Initializing https_port [::]:3129 SSL context
2023/09/30 14:16:31.899| Using certificate in /etc/squid/ssl_cert/myCA.pem
2023/09/30 14:16:31.905| 83,5| 25/src/ssl/support.cc(1962)
readSslX509CertificatesChain: Certificate is self-signed, will not be
chained
2023/09/30 14:16:31.962| 83,5| 25/src/ssl/support.cc(1628) contextMethod:
Using SSLv2/SSLv3.
2023/09/30 14:16:31.964| 83,9| 25/src/ssl/support.cc(903)
configureSslContext: Setting RSA key generation callback.
2023/09/30 14:16:31.965| 83,9| 25/src/ssl/support.cc(916)
configureSslContext: Setting CA certificate locations.
2023/09/30 14:16:31.966| 83,9| 25/src/ssl/support.cc(965)
configureSslContext: Not requiring any client certificates
2023/09/30 14:16:31.967| 21,3| src/tools.cc(543) leave_suid: leave_suid:
PID 3917 called
2023/09/30 14:16:31.968| 21,3| src/tools.cc(565) leave_suid: leave_suid:
PID 3917 giving up root, becoming 'squid'  <<<< *CHANGE OF USER NAME to
SQUID*
2023/09/30 14:16:31.970| 0,9| src/debug.cc(408) parseOptions: command-line
-X overrides: ALL,1
2023/09/30 14:16:31.983| Current Directory is /
2023/09/30 14:16:31.985| Starting Squid Cache version 3.5.25 for
arm-poky-linux-gnueabi...
2023/09/30 14:16:31.985| Service Name: squid
2023/09/30 14:16:31.985| Process ID 3917
2023/09/30 14:16:31.985| Process Roles: master worker
2023/09/30 14:16:31.985| With 1024 file descriptors available

2023/09/30 14:16:31.985| Initializing IP Cache...
2023/09/30 14:16:31.993| DNS Socket created at [::], FD 8
2023/09/30 14:16:31.994| DNS Socket created at 0.0.0.0, FD 9
2023/09/30 14:16:31.995| Adding nameserver 127.0.0.1 from /etc/resolv.conf
2023/09/30 14:16:31.997| helperOpenServers: Starting 5/32 'ssl_crtd'
processes
2023/09/30 14:16:32.175| Logfile: opening log
daemon:/var/log/squid/access.log
2023/09/30 14:16:32.176| Logfile Daemon: opening log
/var/log/squid/access.log
2023/09/30 14:16:32.457| Unlinkd pipe opened on FD 26
2023/09/30 14:16:32.470| Store logging disabled
2023/09/30 14:16:32.471| Swap maxSize 102400 + 262144 KB, estimated 28041
objects
2023/09/30 14:16:32.471| Target number of buckets: 1402
2023/09/30 14:16:32.471| Using 8192 Store buckets
2023/09/30 14:16:32.471| Max Mem  size: 262144 KB
2023/09/30 14:16:32.471| Max Swap size: 102400 KB
2023/09/30 14:16:32.477| Rebuilding storage in /var/volatile/log/squid/logs
(no log)
2023/09/30 14:16:32.478| Using Least Load store dir selection
2023/09/30 14:16:32.480| Current Directory is /
2023/09/30 14:16:33.121| Finished loading MIME types and icons.
2023/09/30 14:16:33.126| HTCP Disabled.
2023/09/30 14:16:33.131| Squid plugin modules loaded: 0
2023/09/30 14:16:33.132| Adaptation support is off.
2023/09/30 14:16:33.136| Accepting HTTP Socket connections at
local=[::]:3128 remote=[::] FD 28 flags=9
2023/09/30 14:16:33.138| Accepting NAT intercepted SSL bumped HTTPS Socket
connections at local=[::]:3129 remote=[::] FD 29 flags=41

2023/09/30 14:16:33.197| WARNING: ssl_crtd #Hlpr1 exited
2023/09/30 14:16:33.197| Too few ssl_crtd processes are running (need 1/32)
2023/09/30 14:16:33.197| Closing HTTP port [::]:3128
2023/09/30 14:16:33.201| Closing HTTPS port [::]:3129
FATAL: The ssl_crtd helpers are crashing too rapidly, need help!


*Can you shed some light on all this?*

*Buda*

11-17 Birmingham Drive, Christchurch, Canterbury, 8024
New Zealand
+64 3 963-5550 Direct
+64 21 419-024 Mobile

www.trimble.com



-- 
Budimir Miljkovi? BSc E | He
Senior Development Engineer
Civil Construction Field Systems
Trimble

11-17 Birmingham Drive, Christchurch, Canterbury, 8024
New Zealand
+64 3 963-5550 Direct
+64 21 419-024 Mobile

www.trimble.com

This email may contain confidential information that is intended only for
the listed recipient(s) of this email. Any unauthorized review, use,
disclosure or distribution is prohibited. If you believe you have received
this email in error, please immediately delete this email and any
attachments, and inform me via reply email.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230930/e92d8d72/attachment.htm>

From Ralf.Hildebrandt at charite.de  Sat Sep 30 06:28:25 2023
From: Ralf.Hildebrandt at charite.de (Ralf Hildebrandt)
Date: Sat, 30 Sep 2023 08:28:25 +0200
Subject: [squid-users] [ext] Squid quits while starting?!
In-Reply-To: <CAPO8noJ9R8Tf3z1yp4gR3ameZOWO69F==Hgq9mtx3uP_k0aB6Q@mail.gmail.com>
References: <CAPO8noJ9R8Tf3z1yp4gR3ameZOWO69F==Hgq9mtx3uP_k0aB6Q@mail.gmail.com>
Message-ID: <ZRfACbyYspQxpqlp@charite.de>

* Bud Miljkovic <bud_miljkovic at trimble.com>:

> r2:/# /usr/libexec/ssl_crtd -s /var/lib/ssl_db -M 4MB
> /usr/libexec/ssl_crtd: Uninitialized SSL certificate database directory:
> /var/lib/ssl_db. To initialize, run "ssl_crtd -c -s /var/lib/ssl_db".

So run /usr/libexec/ssl_crtd -c -s /var/lib/ssl_db

> *However, when I try to run this:*
> r2:/usr/libexec# ssl_crtd -c -s /var/lib/ssl_db
> -sh: ssl_crtd: command not found  *>>>* *?!*
> 
> *I.e. ssl_crtd is not executable from its directory and it is owned by the
> root*

The search path doesn't include ".", so simply use 
./ssl_crtd -c -s /var/lib/ssl_db
instead.



-- 
Ralf Hildebrandt
Charit? - Universit?tsmedizin Berlin
Gesch?ftsbereich IT | Abteilung Netz | Netzwerk-Administration
Invalidenstra?e 120/121 | D-10115 Berlin

Tel. +49 30 450 570 155
ralf.hildebrandt at charite.de
https://www.charite.de


From rafael.akchurin at diladele.com  Sat Sep 30 08:02:13 2023
From: rafael.akchurin at diladele.com (Rafael Akchurin)
Date: Sat, 30 Sep 2023 08:02:13 +0000
Subject: [squid-users] TLS passthrough
In-Reply-To: <CADxZ=iVv0FLTTKNng0fQ961SU7UeOUrdHbk9-P1ixDeEUX-=mA@mail.gmail.com>
References: <CADxZ=iVSpT0VYTZS0ZhnnQNP_1mg+PZNzGmWc9cR3mYnos1p_g@mail.gmail.com>
 <ZRUgFYjFwpnK8hdO@fantomas.sk>
 <CADxZ=iWnO0mUnUhC6cNV48wH5ET_kChZi=rgCy--9zDbwWgqwg@mail.gmail.com>
 <42994367-b30d-443b-b88c-8df94a5632ff@measurement-factory.com>
 <CADxZ=iX=0fpqyv9L8koUPuCCDuA3j8iEqdizqLPcFsgBSQuEJw@mail.gmail.com>
 <e1c49be1-597a-47e7-96e3-5f036d3024a5@measurement-factory.com>
 <CADxZ=iV2sfFOYXWC=gRa_d53M2GK6WjXt_P+aNK6cFCUoSdpig@mail.gmail.com>
 <4d494271-f038-4209-b99a-bf8e08cbc42c@measurement-factory.com>
 <CADxZ=iXBfUBS3WHf66QW94=8bKX0r-8i1QtWJNrpAZ6Z4Cm_2g@mail.gmail.com>
 <00c74d5d-7b8f-470e-aa63-1e87d7224f57@measurement-factory.com>
 <CADxZ=iVq79jruOgXA6TBw0guVSzeN=mZwLF33LVyCd1e2UTBJQ@mail.gmail.com>
 <6b73642d-0148-4c1e-a822-3d88a3f02cb7@measurement-factory.com>
 <CADxZ=iWxMA3avGOtYsAqg8K1_ti7asfAev=Htb3+_xicChYgtw@mail.gmail.com>
 <38e0a961-318d-4b05-99d3-e824480712a1@measurement-factory.com>
 <CADxZ=iWJ_g8KQ1wYoah-EcLXuAx1MgXqJhCFoJ8xfg3t6GZmug@mail.gmail.com>
 <13dfcdf2-b207-49ae-8b1e-9b30d25ead10@measurement-factory.com>
 <CADxZ=iVv0FLTTKNng0fQ961SU7UeOUrdHbk9-P1ixDeEUX-=mA@mail.gmail.com>
Message-ID: <AM8PR04MB7745D655F390EB4F9D0DF7ED8FC7A@AM8PR04MB7745.eurprd04.prod.outlook.com>

Helo Fendando,

One way to do that is to use policy-based-routing on your gateway.

This can be easily done with for example Microtik (see https://docs.diladele.com/tutorials/mikrotik_transparent_squid/index.html)
But also with native say Debian (we only have somewhat outdated tutorial with Debian 10/Ubuntu 20 at  https://docs.diladele.com/tutorials/policy_based_routing_squid/index.html).

Hope this will help.
Best regards,
Rafael

From: squid-users <squid-users-bounces at lists.squid-cache.org> On Behalf Of Fernando Giorgetti
Sent: Saturday, September 30, 2023 12:07 AM
To: Alex Rousskov <rousskov at measurement-factory.com>
Cc: squid-users at lists.squid-cache.org
Subject: Re: [squid-users] TLS passthrough

If someone has already done that, with the client running in a different machine, I would love to know how.

In case Squid runs on the same machine used as a network gateway to the client machine, I suppose the config would be similar, but if it's not running on the same machine used as the gateway, then it would be nice to see how.

Thanks

Em sex., 29 de set. de 2023 18:13, Alex Rousskov <rousskov at measurement-factory.com<mailto:rousskov at measurement-factory.com>> escreveu:
On 2023-09-29 13:55, Fernando Giorgetti wrote:

> The "intercept" scenario demonstrated here
> https://wiki.squid-cache.org/ConfigExamples/Intercept/AtSource
> makes sense to me, as we are just redirecting internal traffic into Squid,
> so the original destination IP is preserved.

> I was able to make it work and that TLS app worked just fine. The
> only constraint is that it requires that both the client and Squid
> ran on the same machine, but at least it worked perfectly.

I am very glad you are making progress. FWIW, there are also ways to
intercept traffic from applications that do not run on the same machine
as Squid. This is not my area of expertise, but others on the list can
guide you if you need that kind of setup.


> Here is my squid.conf (just in case someone eventually has a similar
> issue):

Thank you!

Alex.



> acl CONNECT method CONNECT
> acl mytlsserverip dst 10.0.0.10
> http_access allow CONNECT mytlsserverip
>
> http_port 3128
>
> https_port 127.0.0.1:3129<http://127.0.0.1:3129> intercept ssl-bump \
>    tls-cert=/tmp/certs/squid.pem \
>    tls-key=/tmp/certs/squid.key \
>    generate-host-certificates=off
>
> ssl_bump splice all
>
>
> And here are the firewall rules I have used:
>
> iptables -t nat -I OUTPUT -p tcp -d 10.0.0.10 --dport 55671 -j DNAT
> --to-destination 127.0.0.1:3129<http://127.0.0.1:3129> <http://127.0.0.1:3129>
> iptables -t nat -I OUTPUT --match owner --uid-owner squid  -p tcp -d
> 10.0.0.10 --dport 55671 -j ACCEPT
>
> I appreciate all the guidance and discussion Matus and Alex.
>
> Thank you,
> Fernando
>
> On Fri, Sep 29, 2023 at 12:53?PM Alex Rousskov
> <rousskov at measurement-factory.com<mailto:rousskov at measurement-factory.com>
> <mailto:rousskov at measurement-factory.com<mailto:rousskov at measurement-factory.com>>> wrote:
>
>     On 2023-09-29 10:55, Fernando Giorgetti wrote:
>      >     Do you control the client application? If yes, then perhaps
>     it can be
>      >     adjusted to support HTTP proxies? In other words, the client
>     will send a
>      >     plain text HTTP CONNECT request to Squid and, upon receiving
>     a 200
>      >     (Connection Established) response headers, will start using
>     TLS with the
>      >     origin server. In this case, you do not need interception.
>
>
>      > Nope, the client application is also used to communicate with
>     other apps in
>      > other environments.
>
>     FWIW, "used with other apps" does not imply or explain the "nope, we do
>     not control the application" answer IMHO.
>
>
>      > The SNI has to be used as the client/server apps perform
>      > mutual TLS authentication.
>
>     To avoid a misunderstanding, nothing I have said precludes the use of
>     TLS SNI by the client application. Thus, I am not sure why you are
>     saying the above.
>
>
>      > In order to evaluate if we can use Squid for this purpose, I have
>      > also created a basic TLS client/server app to validate what is
>      > happening. Basically my TLS client tries to connect directly to Squid
>      > IP/Port and I am indicating the SNI so that the TLS handshake
>      > passes.
>
>     FWIW, a scenario where the client application establishes a TLS
>     connection with Squid https_port (configured as a reverse HTTPS proxy)
>     will not work for your use case AFAICT. I am not sure why you are
>     testing this. It has not been suggested on this mailing list.
>
>     BTW, you can use ("curl" or even "openssl s_client") and "openssl
>     s_server" for basic tests. I recommend using well-known test programs
>     (instead of custom apps) because doing so makes it easier for mailing
>     list readers to understand what your test clients and servers are doing
>     (and to reproduce your setup).
>
>
>      > When I tried to make it work using a forward proxy with intercept and
>      > ssl_bump, I could not make Squid peek at the SNI and tunnel the
>      > request to the correct destination.
>
>     Please note that "forward proxy with intercept" is an oxymoron -- the
>     two port modes (i.e. explicit "intercept" and default forward proxying)
>     are mutually exclusive.
>
>     If you do not want to or cannot modify/configure the client application
>     to use Squid as a forward HTTP proxy (as I detailed earlier; see the
>     paragraph still quoted at the beginning of this message), then your
>     other choice is interception (as I detailed earlier; see the "Squid
>     supports blind tunneling of intercepted TCP connections" discussion in
>     the previous exchange).
>
>     When Squid https_port gets an intercepted client TCP connection, Squid
>     does not need SNI to know where to forward that TCP connection. Squid
>     opens a TCP connection to the IP address where the client TCP
>     connection
>     was going (or trying to go) before it was intercepted. That intended
>     destination IP address is delivered to Squid by the OS, as a part of
>     interception mechanism/setup. TLS and SNI are not involved in this
>     process.
>
>     If you have not tested an interception scenario, please do. If you
>     have,
>     please share your interception configuration, Squid configuration, and
>     any relevant error/problem information.
>
>
>     HTH,
>
>     Alex.
>
>
>      > On Fri, Sep 29, 2023 at 11:35?AM Alex Rousskov wrote:
>      >
>      >     On 2023-09-29 09:17, Fernando Giorgetti wrote:
>      >
>      >      > Actually I am evaluating if Squid can be used to proxy
>     Non-HTTP/TLS
>      >      > data, as we have a restricted environment where Squid is
>      >     currently the
>      >      > only way to get out to the internet.
>      >
>      >     Yes, Squid can tunnel non-HTTP data, including TLS data.
>      >
>      >
>      >      > The idea is that the client application will open a
>     connection to
>      >     a given
>      >      > hostname and port (setting the SNI in the TLS options),
>      >     considering that
>      >      > the given hostname/port is the actual backend they're
>     trying to
>      >     reach.
>      >
>      >     Do you control the client application? If yes, then perhaps
>     it can be
>      >     adjusted to support HTTP proxies? In other words, the client will
>      >     send a
>      >     plain text HTTP CONNECT request to Squid and, upon receiving
>     a 200
>      >     (Connection Established) response headers, will start using
>     TLS with
>      >     the
>      >     origin server. In this case, you do not need interception.
>      >
>      >
>      >      > We can either try to use a fake hostname (defined in the
>      >     /etc/hosts of the
>      >      > tls client machine) which would actually point to Squid's IP
>      >
>      >     AFAICT, faking the IP address will not work without Squid
>     source code
>      >     modifications because a non-intercepting Squid https_port
>     will want to
>      >     terminate TLS -- such a port does not support blindly
>     tunneling traffic.
>      >
>      >
>      >      > or eventually
>      >      > redirect traffic to the real destination into Squid using
>     a DNAT
>      >     rule.
>      >
>      >     I am not a DNAT expert, but this sounds like interception to
>     me. Bugs
>      >     notwithstanding, Squid supports blind tunneling of
>     intercepted TCP
>      >     connections (to their intended destination):
>      >
>      >           https_port X intercept ssl-bump ...
>      >           ssl_bump splice all
>      >
>      >     On a successful tunneling path, the above configuration does
>     not care
>      >     whether the intercepted traffic is TLS and will not peek at
>     TLS SNI,
>      >     but
>      >     nothing in your requirements necessitates SNI knowledge AFAICT.
>      >
>      >     If Squid fails to establish a TCP connection to the intended
>      >     destination
>      >     of the intercepted connection, then the situation becomes
>     more complex:
>      >     Squid (with the above configuration) assumes that the client is
>      >     speaking
>      >     TLS. Squid will attempt to bump the TLS client connection and
>     send a
>      >     Squid-generated HTTP error response to the client. AFAIK,
>     this bumping
>      >     and error sending attempt cannot be prevented in this case
>     without
>      >     Squid
>      >     source code modifications: Squid used to be able to terminate a
>      >     client-Squid connection instead of sending a Squid-generated
>     HTTP error
>      >     response (by replacing the corresponding Squid error page
>     contents with
>      >     a word "reset"). However, that feature was accidentally(?)
>     dropped in
>      >     2002 commit 76cdc28 AFAICT.
>      >
>      >
>      >     HTH,
>      >
>      >     Alex.
>      >
>      >
>      >      > But overall, it will be a 1:1 relationship, meaning, the
>      >     https_port on Squid
>      >      > would be used exclusively to this purpose of proxying from a
>      >     given source
>      >      > to a given destination.
>      >      >
>      >      > That is why I was considering a reverse-proxy, but I had
>     no luck
>      >     with it
>      >      > (actually
>      >      > I was able to proxy HTTP/HTTPS, but not non-http).
>      >      >
>      >      > Thank you again,
>      >      > Fernando
>      >      >
>      >      > On Thu, Sep 28, 2023 at 11:39?PM Alex Rousskov
>      >      > <rousskov at measurement-factory.com<mailto:rousskov at measurement-factory.com>
>     <mailto:rousskov at measurement-factory.com<mailto:rousskov at measurement-factory.com>>
>      >     <mailto:rousskov at measurement-factory.com<mailto:rousskov at measurement-factory.com>
>     <mailto:rousskov at measurement-factory.com<mailto:rousskov at measurement-factory.com>>>
>      >      > <mailto:rousskov at measurement-factory.com<mailto:rousskov at measurement-factory.com>
>     <mailto:rousskov at measurement-factory.com<mailto:rousskov at measurement-factory.com>>
>      >     <mailto:rousskov at measurement-factory.com<mailto:rousskov at measurement-factory.com>
>     <mailto:rousskov at measurement-factory.com<mailto:rousskov at measurement-factory.com>>>>> wrote:
>      >      >
>      >      >     On 2023-09-28 20:35, Fernando Giorgetti wrote:
>      >      >
>      >      >      > Do you have any recommendations on how I could have
>     it done?
>      >      >
>      >      >     I am unable to confirm whether Squid can do what you
>     want or
>      >     provide
>      >      >     configuration recommendations because I do not yet
>     know how
>      >     your Squid
>      >      >     will receive traffic (e.g., an intercepting proxy or
>     an explicit
>      >      >     forward
>      >      >     HTTP proxy), what traffic Squid will receive (e.g., TLS,
>      >     plain HTTP,
>      >      >     something else), and what you want Squid to do with
>     that traffic.
>      >      >
>      >      >     To make progress, I recommend describing the above details
>      >     (for one
>      >      >     typical use case?) and then answering any followup
>     questions.
>      >      >
>      >      >
>      >      >     Cheers,
>      >      >
>      >      >     Alex.
>      >      >
>      >      >
>      >      >      > When my tls client tries to reach the target
>      >     through Squid, using
>      >      >      > a "ssl_bump splice", it seems like squid is trying
>     to reach
>      >      >     itself in a
>      >      >      > loop.
>      >      >      >
>      >      >      > I have also tried including a peek first, but no luck.
>      >      >      >
>      >      >      > Thanks again for all suggestions.
>      >      >      >
>      >      >      > On Thu, Sep 28, 2023 at 7:23?PM Alex Rousskov wrote:
>      >      >      >
>      >      >      >     On 2023-09-28 15:23, Fernando Giorgetti wrote:
>      >      >      >
>      >      >      >      > Actually with the suggested blind passthrough,
>      >     Squid would not
>      >      >      >     handle
>      >      >      >      > the TLS termination.
>      >      >      >
>      >      >      >     Correct.
>      >      >      >
>      >      >      >
>      >      >      >      > how will Squid know what the target is?
>      >      >      >
>      >      >      >     In many cases, Squid can learn SNI by peeking
>     at TLS
>      >     ClientHello,
>      >      >      >     without terminating TLS. Bugs notwithstanding,
>     none of the
>      >      >      >     configuration
>      >      >      >     sketches I shared previously will do that though.
>      >      >      >
>      >      >      >
>      >      >      >     HTH,
>      >      >      >
>      >      >      >     Alex.
>      >      >      >
>      >      >      >
>      >      >      >
>      >      >      >      > On Thu, Sep 28, 2023 at 1:02?PM Alex
>     Rousskov wrote:
>      >      >      >      >
>      >      >      >      >     On 2023-09-28 11:31, Fernando Giorgetti
>     wrote:
>      >      >      >      >
>      >      >      >      >      > And what should I do to let Squid use
>     the SNI
>      >      >     defined by
>      >      >      >     the TLS
>      >      >      >      >     client?
>      >      >      >      >
>      >      >      >      >     What do you want Squid to use that SNI for?
>      >      >      >      >
>      >      >      >      >     Alex.
>      >      >      >      >
>      >      >      >      >
>      >      >      >      >      > On Thu, Sep 28, 2023 at 11:51?AM Alex
>      >     Rousskov wrote:
>      >      >      >      >      >
>      >      >      >      >      >     On 2023-09-28 09:06, Fernando
>     Giorgetti
>      >     wrote:
>      >      >      >      >      >      > Hi Matus, do you mean
>     something like
>      >     a DNAT
>      >      >      >     (iptables) rule?
>      >      >      >      >      >      > If so, I would say, it should
>     work as
>      >     well.
>      >      >      >      >      >      >
>      >      >      >      >      >      > But this is an environment I
>     do not
>      >     control,
>      >      >     and I have
>      >      >      >      >     been told
>      >      >      >      >      >     to try
>      >      >      >      >      >      > using an existing squid
>     installation
>      >     to proxy
>      >      >      >     non-http/TLS
>      >      >      >      >     data
>      >      >      >      >      >     through.
>      >      >      >      >      >      >
>      >      >      >      >      >      > I appreciate any guidance or
>      >     recommendation.
>      >      >      >      >      >
>      >      >      >      >      >
>      >      >      >      >      >     Bugs notwithstanding, Squid can
>     blindly
>      >     tunnel
>      >      >     intercepted
>      >      >      >      >     (at TCP port
>      >      >      >      >      >     X) TCP traffic to its intended
>     destination:
>      >      >      >      >      >
>      >      >      >      >      >           https_port X intercept
>     ssl-bump ...
>      >      >      >      >      >           ssl_bump splice all
>      >      >      >      >      >
>      >      >      >      >      >
>      >      >      >      >      >     Without interception, then Squid
>     can only
>      >      >     tunnel stuff
>      >      >      >     inside
>      >      >      >      >     HTTP
>      >      >      >      >      >     CONNECT tunnels (for HTTP CONNECT
>     requests
>      >      >     received at TCP
>      >      >      >      >     port Y):
>      >      >      >      >      >
>      >      >      >      >      >           http_port Y ssl-bump ...
>      >      >      >      >      >           ssl_bump splice all
>      >      >      >      >      >
>      >      >      >      >      >
>      >      >      >      >      >     In both cases, Squid does not
>     care about the
>      >      >     protocols
>      >      >      >     that
>      >      >      >      >     tunneled
>      >      >      >      >      >     traffic is using. It could be HTTP,
>      >     HTTPS, TLS, or
>      >      >      >     anything
>      >      >      >      >     else on top
>      >      >      >      >      >     of TCP.
>      >      >      >      >      >
>      >      >      >      >      >     Your ACLs may differ from "all"
>     in the above
>      >      >     sketches,
>      >      >      >     of course,
>      >      >      >      >      >     but if
>      >      >      >      >      >     traffic is not TLS, then you want an
>      >     "ssl_bump
>      >      >     splice"
>      >      >      >     rule that
>      >      >      >      >      >     matches
>      >      >      >      >      >     during SslBump step1. A rule with an
>      >     "all" ACLs
>      >      >     is the
>      >      >      >      >     simplest example
>      >      >      >      >      >     of that.
>      >      >      >      >      >
>      >      >      >      >      >
>      >      >      >      >      >     HTH,
>      >      >      >      >      >
>      >      >      >      >      >     Alex.
>      >      >      >      >      >     P.S. I am getting an "Internal Server
>      >     Error" when
>      >      >      >     following
>      >      >      >      >     the haproxy
>      >      >      >      >      >     link in the original question, so I
>      >     cannot map what
>      >      >      >     that page
>      >      >      >      >     says to
>      >      >      >      >      >     the configurations above.
>      >      >      >      >      >
>      >      >      >      >      >
>      >      >      >      >      >      > On Thu, Sep 28, 2023 at
>     3:41?AM Matus
>      >     UHLAR -
>      >      >      >     fantomas wrote:
>      >      >      >      >      >      >
>      >      >      >      >      >      >     On 27.09.23 16:48, Fernando
>      >     Giorgetti wrote:
>      >      >      >      >      >      >      >I would like to know if
>     it is
>      >     possible
>      >      >     to set up
>      >      >      >      >     Squid to
>      >      >      >      >      >     perform
>      >      >      >      >      >      >      >TLS passthrough to a
>     given backend,
>      >      >     relaying TLS
>      >      >      >      >     encrypted
>      >      >      >      >      >      >      >traffic to the backend,
>      >     similarly to
>      >      >     what HAProxy
>      >      >      >      >     does below?
>      >      >      >      >      >      >      >
>      >      >      >      >      >      >
>      >      >      >      >      >
>      >      >      >      >
>      >      >      >
>      >      >
>      >
>      >https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough <https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough>
>      >      >      >      >      >      >      >
>      >      >      >      >      >      >      >I have tried a few different
>      >      >     configurations using
>      >      >      >      >     reverse
>      >      >      >      >      >     proxy,
>      >      >      >      >      >      >      >or peek and splice, but
>     I could not
>      >      >     make it
>      >      >      >     work without
>      >      >      >      >      >     providing
>      >      >      >      >      >      >      >a valid HTTP request or a
>      >     CONNECT request.
>      >      >      >      >      >      >
>      >      >      >      >      >      >     what's the difference
>     between TCP
>      >      >     redirect and
>      >      >      >     this?
>      >      >      >      >      >      >
>      >      >      >      >      >      >     --
>      >      >      >      >      >      >     Depression is merely anger
>     without
>      >      >     enthusiasm.
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20230930/c2051ecd/attachment.htm>

From squid3 at treenet.co.nz  Sat Sep 30 08:18:12 2023
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Sat, 30 Sep 2023 21:18:12 +1300
Subject: [squid-users] TLS passthrough
In-Reply-To: <CADxZ=iVv0FLTTKNng0fQ961SU7UeOUrdHbk9-P1ixDeEUX-=mA@mail.gmail.com>
References: <CADxZ=iVSpT0VYTZS0ZhnnQNP_1mg+PZNzGmWc9cR3mYnos1p_g@mail.gmail.com>
 <CADxZ=iX=0fpqyv9L8koUPuCCDuA3j8iEqdizqLPcFsgBSQuEJw@mail.gmail.com>
 <e1c49be1-597a-47e7-96e3-5f036d3024a5@measurement-factory.com>
 <CADxZ=iV2sfFOYXWC=gRa_d53M2GK6WjXt_P+aNK6cFCUoSdpig@mail.gmail.com>
 <4d494271-f038-4209-b99a-bf8e08cbc42c@measurement-factory.com>
 <CADxZ=iXBfUBS3WHf66QW94=8bKX0r-8i1QtWJNrpAZ6Z4Cm_2g@mail.gmail.com>
 <00c74d5d-7b8f-470e-aa63-1e87d7224f57@measurement-factory.com>
 <CADxZ=iVq79jruOgXA6TBw0guVSzeN=mZwLF33LVyCd1e2UTBJQ@mail.gmail.com>
 <6b73642d-0148-4c1e-a822-3d88a3f02cb7@measurement-factory.com>
 <CADxZ=iWxMA3avGOtYsAqg8K1_ti7asfAev=Htb3+_xicChYgtw@mail.gmail.com>
 <38e0a961-318d-4b05-99d3-e824480712a1@measurement-factory.com>
 <CADxZ=iWJ_g8KQ1wYoah-EcLXuAx1MgXqJhCFoJ8xfg3t6GZmug@mail.gmail.com>
 <13dfcdf2-b207-49ae-8b1e-9b30d25ead10@measurement-factory.com>
 <CADxZ=iVv0FLTTKNng0fQ961SU7UeOUrdHbk9-P1ixDeEUX-=mA@mail.gmail.com>
Message-ID: <dd47accd-50c6-4515-9f89-a430de327308@treenet.co.nz>

On 30/09/23 11:06, Fernando Giorgetti wrote:
> If someone has already done that, with the client running in a different 
> machine, I would love to know how.


There are several ways;

  1) run Squid on the gateway router for your network, or

  2) place Squid in a DMZ between the LAN gateway and WAN gateway.

  3) setup a custom route+gateway for port 80 and 443 LAN traffic as the 
Squid machine. Excluding traffic from that machine itself.


> 
> In case Squid runs on the same machine used as a network gateway to the 
> client machine, I suppose the config would be similar, but if it's not 
> running on the same machine used as the gateway, then it would be nice 
> to see how.
> 

That would be (1). See 
<https://wiki.squid-cache.org/ConfigExamples/Intercept/LinuxDnat> for 
how to configure the gateway router running Squid.

The configuration difference between the at-source (aka, on client 
machine) you are/were using is just some iptables rules.


HTH
Amos


