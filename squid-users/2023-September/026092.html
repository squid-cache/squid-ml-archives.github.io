<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] ssl-bump strange behaviour with incomplete config
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20ssl-bump%20strange%20behaviour%20with%20incomplete%20config&In-Reply-To=%3C8ce2efb2-0ddf-49a7-bcbc-b3dade623048%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="026091.html">
   <LINK REL="Next"  HREF="026095.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] ssl-bump strange behaviour with incomplete config</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20ssl-bump%20strange%20behaviour%20with%20incomplete%20config&In-Reply-To=%3C8ce2efb2-0ddf-49a7-bcbc-b3dade623048%40measurement-factory.com%3E"
       TITLE="[squid-users] ssl-bump strange behaviour with incomplete config">rousskov at measurement-factory.com
       </A><BR>
    <I>Wed Sep 13 17:12:44 UTC 2023</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="026091.html">[squid-users] ssl-bump strange behaviour with incomplete config
</A></li>
        <LI>Next message (by thread): <A HREF="026095.html">[squid-users] Squid 5.6 and 5.9 keep crashing due to signal 6 with status 0
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26092">[ date ]</a>
              <a href="thread.html#26092">[ thread ]</a>
              <a href="subject.html#26092">[ subject ]</a>
              <a href="author.html#26092">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 2023-09-13 12:47, <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid at iotti.biz</A> wrote:

&gt;<i> I'm only peeking as long as possible, and then splice at step3.
</I>&gt;<i> 
</I>&gt;<i> I got the regular Squid access denied screen (and this is right, since the
</I>&gt;<i> CONNECT is not allowed) but in access.log I find:
</I>&gt;<i> 
</I>&gt;<i> 2023-09-13T17:12:52.855+0200     12 192.168.1.179 TCP_DENIED/200 0 CONNECT
</I>&gt;<i> www.nytimes.com:443 - HIER_NONE/- -
</I>&gt;<i> 2023-09-13T17:12:52.855+0200      0 192.168.1.179 NONE_NONE/403 3952 GET
</I>&gt;<i> <A HREF="https://www.nytimes.com/">https://www.nytimes.com/</A> - HIER_NONE/- text/html
</I>&gt;<i> 
</I>&gt;<i> See the second GET. It seems that Squid here is kind-of bumping
</I>
Yes, if Squid encounters an error during SslBump processing steps, it 
will try to bump the TLS client connection (if it has not been bumped 
already) to (later) deliver an HTTP response describing that error to 
the user agent.

Squid bumps the TLS client connection and then waits for and responds to 
the first request after CONNECT because popular browsers do not show 
CONNECT responses to users, including CONNECT responses containing Squid 
access denied errors. In other words, without bumping, the browser would 
not show that &quot;Squid access denied screen&quot; that you consider &quot;right&quot;.

This SslBump error-handling behavior works well in some use cases and 
breaks some other use cases. I expect it to become configurable at some 
point.


HTH,

Alex.


, instead of
&gt;<i> splicing, since it did read what should be the encrypted request.
</I>&gt;<i> Also the TCP_DENIED/200 is not clear to me: shouldn't it be TCP_DENIED/403?
</I>&gt;<i> I checked with tcpdump, and the CONNECT is really allowed with 200 code, a
</I>&gt;<i> client hello and server hello are exchanged, than the connections is closed
</I>&gt;<i> after some transaction.
</I>&gt;<i> 
</I>&gt;<i> I started debugging the ssl-bump thing with debug_options 83,8 and in
</I>&gt;<i> cache.log I see:
</I>&gt;<i> 
</I>&gt;<i> 2023/09/13 17:14:00.283 kid1| 83,7| LogTags.cc(57) update: TAG_NONE to
</I>&gt;<i> TCP_DENIED
</I>&gt;<i> 2023/09/13 17:14:00.283 kid1| 83,3| client_side_request.cc(1501)
</I>&gt;<i> sslBumpNeed: sslBump required: bump
</I>&gt;<i> 2023/09/13 17:14:00.283 kid1| 83,3| client_side_request.cc(1501)
</I>&gt;<i> sslBumpNeed: sslBump required: client-first
</I>&gt;<i> 
</I>&gt;<i> Why &quot; sslBump required: bump&quot; and not splice? Even &quot;worse&quot;, why does it do
</I>&gt;<i> client-first then? Is it right it defaults to this if the CONNECT is
</I>&gt;<i> refused?
</I>&gt;<i> Then in cache.log I see a lot of messages where it seems that Squid is
</I>&gt;<i> talking TLS with the client, probably sending the access denied page.
</I>&gt;<i> 
</I>&gt;<i> If I simply add in the config
</I>&gt;<i> acl lux src 192.168.1.179
</I>&gt;<i> http_access allow lux
</I>&gt;<i> 
</I>&gt;<i> then it works, with
</I>&gt;<i> 2023-09-13T17:28:21.877+0200 108353 192.168.1.179 TCP_TUNNEL/200 4853
</I>&gt;<i> CONNECT vp.nyt.com:443 - HIER_DIRECT/vp.nyt.com -
</I>&gt;<i> 2023-09-13T17:28:21.878+0200 108441 192.168.1.179 TCP_TUNNEL/200 7894
</I>&gt;<i> CONNECT mwcm.nytimes.com:443 - HIER_DIRECT/mwcm.nytimes.com -
</I>&gt;<i> 2023-09-13T17:28:21.879+0200 110154 192.168.1.179 TCP_TUNNEL/200 6337
</I>&gt;<i> CONNECT a.nytimes.com:443 - HIER_DIRECT/a.nytimes.com -
</I>&gt;<i> 2023-09-13T17:28:21.879+0200 111702 192.168.1.179 TCP_TUNNEL/200 514229
</I>&gt;<i> CONNECT g1.nyt.com:443 - HIER_DIRECT/g1.nyt.com -
</I>&gt;<i> 2023-09-13T17:28:21.880+0200 111702 192.168.1.179 TCP_TUNNEL/200 648915
</I>&gt;<i> CONNECT static01.nyt.com:443 - HIER_DIRECT/static01.nyt.com -
</I>&gt;<i> 2023-09-13T17:28:21.880+0200 111890 192.168.1.179 TCP_TUNNEL/200 10986
</I>&gt;<i> CONNECT samizdat-graphql.nytimes.com:443 -
</I>&gt;<i> HIER_DIRECT/samizdat-graphql.nytimes.com -
</I>&gt;<i> 2023-09-13T17:28:21.881+0200 112017 192.168.1.179 TCP_TUNNEL/200 72448
</I>&gt;<i> CONNECT static01.nytimes.com:443 - HIER_DIRECT/static01.nytimes.com -
</I>&gt;<i> 2023-09-13T17:28:21.881+0200 112018 192.168.1.179 TCP_TUNNEL/200 286645
</I>&gt;<i> CONNECT static01.nytimes.com:443 - HIER_DIRECT/static01.nytimes.com -
</I>&gt;<i> 2023-09-13T17:28:21.882+0200 112043 192.168.1.179 TCP_TUNNEL/200 15345
</I>&gt;<i> CONNECT g1.nyt.com:443 - HIER_DIRECT/g1.nyt.com -
</I>&gt;<i> 2023-09-13T17:28:21.883+0200 112333 192.168.1.179 TCP_TUNNEL/200 2390864
</I>&gt;<i> CONNECT www.nytimes.com:443 - HIER_DIRECT/www.nytimes.com -
</I>&gt;<i> 
</I>&gt;<i> And in cache.log, no more client-first mentions:
</I>&gt;<i> 2023/09/13 17:26:33.523 kid1| 83,3| client_side_request.cc(1748) doCallouts:
</I>&gt;<i> Doing clientInterpretRequestHeaders()
</I>&gt;<i> 2023/09/13 17:26:33.523 kid1| 83,3| client_side_request.cc(1501)
</I>&gt;<i> sslBumpNeed: sslBump required: peek
</I>&gt;<i> 2023/09/13 17:26:33.523 kid1| 83,3| client_side_request.cc(1842) doCallouts:
</I>&gt;<i> calling processRequest()
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> I also tried with an interception proxy (transparent proxy) config. The
</I>&gt;<i> results are similar but not identical:
</I>&gt;<i> I added to the original config (the one which prohibits the CONNECT):
</I>&gt;<i> http_port 3128
</I>&gt;<i> 
</I>&gt;<i> and changed port 3130 so:
</I>&gt;<i> https_port 3130 intercept ssl-bump generate-host-certificates=on
</I>&gt;<i> dynamic_cert_mem_cache_size=6MB cert=/etc/squid/ssl_cert/myCA.pem
</I>&gt;<i> 
</I>&gt;<i> Now I get:
</I>&gt;<i> 2023-09-13T17:52:17.109+0200      6 192.168.1.179 TCP_DENIED/000 0 CONNECT
</I>&gt;<i> 151.101.241.164:443 - HIER_NONE/- -
</I>&gt;<i> 2023-09-13T17:52:17.109+0200      0 192.168.1.179 NONE_NONE/403 3732 GET
</I>&gt;<i> <A HREF="https://www.">https://www.</A> nytimes.com/ - HIER_NONE/- text/html
</I>&gt;<i> 
</I>&gt;<i> TCP_DENIED/000 is more clear than TCP_DENIED/200. But the GET, making me
</I>&gt;<i> think to some bumping code, is still there.
</I>&gt;<i> 
</I>&gt;<i> In cache.log, I find:
</I>&gt;<i> 
</I>&gt;<i> 2023/09/13 17:53:06.539 kid1| 83,7| LogTags.cc(57) update: TAG_NONE to
</I>&gt;<i> TCP_DENIED
</I>&gt;<i> 2023/09/13 17:53:06.539 kid1| 83,3| client_side_request.cc(1501)
</I>&gt;<i> sslBumpNeed: sslBump required: peek
</I>&gt;<i> 2023/09/13 17:53:06.539 kid1| 83,3| client_side_request.cc(1501)
</I>&gt;<i> sslBumpNeed: sslBump required: client-first
</I>&gt;<i> 
</I>&gt;<i> So this time, it is doing peek first (and this is ok with the config), but
</I>&gt;<i> then it recurs to client-first, which could be the reason why the encrypted
</I>&gt;<i> HTTPS traffic is decoded and the HTTP GET is shown.
</I>&gt;<i> 
</I>&gt;<i> Is this whole behavior correct? Anyway, when I white-list the CONNECT,
</I>&gt;<i> everything seems to work right.
</I>&gt;<i> 
</I>&gt;<i> Thank you,
</I>&gt;<i> Luigi
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">https://lists.squid-cache.org/listinfo/squid-users</A>
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="026091.html">[squid-users] ssl-bump strange behaviour with incomplete config
</A></li>
	<LI>Next message (by thread): <A HREF="026095.html">[squid-users] Squid 5.6 and 5.9 keep crashing due to signal 6 with status 0
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26092">[ date ]</a>
              <a href="thread.html#26092">[ thread ]</a>
              <a href="subject.html#26092">[ subject ]</a>
              <a href="author.html#26092">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
