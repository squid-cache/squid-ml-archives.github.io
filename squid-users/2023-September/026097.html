<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid BUG: assurance failed: tok.skip(WellKnownUrlPathPrefix())
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20BUG%3A%20assurance%20failed%3A%0A%20tok.skip%28WellKnownUrlPathPrefix%28%29%29&In-Reply-To=%3Caf6dbe4b-20e6-4427-bbe2-e47991cfb4cd%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="026094.html">
   <LINK REL="Next"  HREF="026098.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid BUG: assurance failed: tok.skip(WellKnownUrlPathPrefix())</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20BUG%3A%20assurance%20failed%3A%0A%20tok.skip%28WellKnownUrlPathPrefix%28%29%29&In-Reply-To=%3Caf6dbe4b-20e6-4427-bbe2-e47991cfb4cd%40measurement-factory.com%3E"
       TITLE="[squid-users] Squid BUG: assurance failed: tok.skip(WellKnownUrlPathPrefix())">rousskov at measurement-factory.com
       </A><BR>
    <I>Thu Sep 14 21:55:11 UTC 2023</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="026094.html">[squid-users] Squid BUG: assurance failed: tok.skip(WellKnownUrlPathPrefix())
</A></li>
        <LI>Next message (by thread): <A HREF="026098.html">[squid-users] Squid BUG: assurance failed: tok.skip(WellKnownUrlPathPrefix())
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26097">[ date ]</a>
              <a href="thread.html#26097">[ thread ]</a>
              <a href="subject.html#26097">[ subject ]</a>
              <a href="author.html#26097">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 2023-09-14 06:40, Lou&#269;ansk&#253; Luk&#225;&#353; wrote:

&gt;<i> But - could someone (or you) clarify the next one for me? I've read some 
</I>&gt;<i> questions about the &quot;new&quot; cachemgr.cgi and the MGR_INDEX template. 
</I>
Sorry, I cannot help with cachemgr.cgi without heroic efforts. IMHO, 
Squid Project should remove cachemgr.cgi feature instead of supporting 
it. I hope that somebody else will help you with it.


&gt;<i> Besides that I have found out that every time I shutdown squid with 
</I>&gt;<i> start-stop-daemon it coredumps.
</I>
&gt;<i> user 13 dumped core.#012#012Stack trace of thread 23990:
</I>&gt;<i> #012#2&#160; 0x000055c7eca80694 xassert (squid)
</I>&gt;<i> #012#3&#160; 0x000055c7ecb23c7c _ZN5Store4RootEv (squid)
</I>&gt;<i> #012#4&#160; 0x000055c7ec8805af _ZN10StoreEntry16destroyMemObjectEv (squid)
</I>&gt;<i> #012#5&#160; 0x000055c7ec8811f6 _Z17destroyStoreEntryPv (squid)
</I>&gt;<i> #012#6&#160; 0x000055c7ecb2d3eb hashFreeItems (squid)
</I>&gt;<i> #012#7&#160; 0x000055c7ecb1fe4a _ZN5Store10ControllerD1Ev (squid)
</I>&gt;<i> #012#8&#160; 0x000055c7ecb1fec9 _ZN5Store10ControllerD0Ev (squid)
</I>&gt;<i> #012#9&#160; 0x00007f35c21adebc __run_exit_handlers (libc.so.6)
</I>&gt;<i> #012#10 0x00007f35c21adfea __GI_exit (libc.so.6)
</I>&gt;<i> #012#11 0x000055c7ec847ce3 SquidShutdown (squid)
</I>
Yes, &quot;TheRoot&quot; assertions after shutdown (during &quot;automatic&quot; at-exit 
cleanup) is a known bug. Recent shutdown improvements make this 
particular assertion more likely, unfortunately. More difficult work is 
needed to fully solve the underlying problem. We will solve it.

Meanwhile, please try the attached patch with an untested workaround. 
Does it help in your environment?


Thank you,

Alex.


&gt;<i> -----P&#367;vodn&#237; zpr&#225;va-----
</I>&gt;<i> Od: squid-users za u&#382;ivatele Alex Rousskov
</I>&gt;<i> Odesl&#225;no: st 13.9.2023 20:53
</I>&gt;<i> Komu: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> P&#345;edm&#283;t: Re: [squid-users] Squid BUG: assurance failed: 
</I>&gt;<i> tok.skip(WellKnownUrlPathPrefix())
</I>&gt;<i> 
</I>&gt;<i> On 2023-09-12 15:50, Lou&#269;ansk&#253; Luk&#225;&#353; wrote:
</I>&gt;<i> 
</I>&gt;<i>  &gt; 2023/09/12 19:12:03 kid4| ERROR: Squid BUG: assurance failed:
</I>&gt;<i>  &gt; tok.skip(WellKnownUrlPathPrefix())
</I>&gt;<i> 
</I>&gt;<i>  &gt; Request:
</I>&gt;<i>  &gt; GET cache_<A HREF="object://squid_ip/info">object://squid_ip/info</A> HTTP/1.0
</I>&gt;<i>  &gt; Host: squid_ip
</I>&gt;<i>  &gt; User-Agent: squidclient/4.6
</I>&gt;<i>  &gt; Accept: */*
</I>&gt;<i>  &gt; Connection: close
</I>&gt;<i> 
</I>&gt;<i> Thank you for sharing this detail. I can now reproduce this problem.
</I>&gt;<i> 
</I>&gt;<i> You are suffering from a bug in Squid v6.3 commit 6695897 (which was
</I>&gt;<i> incorrectly attributed to me). Until that bug is addressed, cache
</I>&gt;<i> manager requests using the deprecated cache_object scheme (e.g., those
</I>&gt;<i> emitted by older squidclients) will trigger the above
</I>&gt;<i> WellKnownUrlPathPrefix assertion in Squid v6.3.
</I>&gt;<i> 
</I>&gt;<i> I have attached a patch that fixes this v6.3 bug in my tests.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i>  &gt; Sending HTTP request ...
</I>&gt;<i>  &gt; done.
</I>&gt;<i>  &gt; HTTP/1.1 404 Not Found
</I>&gt;<i>  &gt; Server: squid
</I>&gt;<i>  &gt; Mime-Version: 1.0
</I>&gt;<i>  &gt; Date: Tue, 12 Sep 2023 19:09:41 GMT
</I>&gt;<i>  &gt; Content-Type: text/html;charset=utf-8
</I>&gt;<i>  &gt; Content-Length: 13057
</I>&gt;<i>  &gt; X-Squid-Error: ERR_INVALID_URL 0
</I>&gt;<i>  &gt; Cache-Status: proxy;detail=no-cache
</I>&gt;<i>  &gt; Via: 1.1 proxy (squid)
</I>&gt;<i>  &gt; Connection: close
</I>&gt;<i>  &gt;
</I>&gt;<i>  &gt; This is obviously calling for url cache_<A HREF="object://squid_ip/info">object://squid_ip/info</A> which I
</I>&gt;<i>  &gt; think is obsolete. Now I went with the new squidclient:
</I>&gt;<i>  &gt;
</I>&gt;<i>  &gt; ./squidclient -h squid_ip -p squid_port -vv mgr:info
</I>&gt;<i>  &gt;
</I>&gt;<i>  &gt; Request:
</I>&gt;<i>  &gt; GET <A HREF="http://squid_ip:squid_port/squid-internal-mgr/info">http://squid_ip:squid_port/squid-internal-mgr/info</A> 
</I>&gt;<i> &lt;<A HREF="http://squid_ip:squid_port/squid-internal-mgr/info">http://squid_ip:squid_port/squid-internal-mgr/info</A>&gt; HTTP/1.0
</I>&gt;<i>  &gt; Host: 10.50.1.5:3127
</I>&gt;<i>  &gt; User-Agent: squidclient/6.3
</I>&gt;<i>  &gt; Accept: */*
</I>&gt;<i>  &gt; Connection: close
</I>&gt;<i> 
</I>&gt;<i>  &gt; But it seems squid is then trying to open it's
</I>&gt;<i>  &gt; visible_hostname:squid_port/squid-internal-mgr/ and due my DNS setting
</I>&gt;<i>  &gt; it is its WAN IP - so it's connecting to its outside IP with its outside
</I>&gt;<i>  &gt; IP which is not in the http_access manager allow list (now it is and the
</I>&gt;<i>  &gt; newer squidclient works).
</I>&gt;<i> 
</I>&gt;<i> You are in Squid Bug 5283 territory here:
</I>&gt;<i> <A HREF="https://bugs.squid-cache.org/show_bug.cgi?id=5283">https://bugs.squid-cache.org/show_bug.cgi?id=5283</A> 
</I>&gt;<i> &lt;<A HREF="https://bugs.squid-cache.org/show_bug.cgi?id=5283">https://bugs.squid-cache.org/show_bug.cgi?id=5283</A>&gt;
</I>&gt;<i> 
</I>&gt;<i> In a Linux test environment, I can work around those &quot;outside IP&quot;
</I>&gt;<i> problems by adding &quot;-l 127.0.0.1&quot; option to squidclient, forcing
</I>&gt;<i> squidclient to connect to Squid from the loopback address. IIRC, that
</I>&gt;<i> &quot;-l&quot; trick does not work in environments that do not support
</I>&gt;<i> from-localhost connections to &quot;outside IPs&quot; on the same box (e.g., Windows).
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> HTH,
</I>&gt;<i> 
</I>&gt;<i> Alex.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i>  &gt; -----P&#367;vodn&#237; zpr&#225;va-----
</I>&gt;<i>  &gt; Od: squid-users za u&#382;ivatele Alex Rousskov
</I>&gt;<i>  &gt; Odesl&#225;no: &#250;t 12.9.2023 19:28
</I>&gt;<i>  &gt; Komu: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i>  &gt; P&#345;edm&#283;t: Re: [squid-users] Squid BUG: assurance failed:
</I>&gt;<i>  &gt; tok.skip(WellKnownUrlPathPrefix())
</I>&gt;<i>  &gt;
</I>&gt;<i>  &gt; On 2023-09-12 13:06, Lou&#269;ansk&#253; Luk&#225;&#353; wrote:
</I>&gt;<i>  &gt;&#160; &gt; Is this anyhow interesting?
</I>&gt;<i>  &gt;
</I>&gt;<i>  &gt; Not really, IMO -- the problem happens earlier. I can confirm that you
</I>&gt;<i>  &gt; are running v6.3-based code. Let's call that progress :-).
</I>&gt;<i>  &gt;
</I>&gt;<i>  &gt; Can you share the a _pointer_ to a compressed ALL,9 cache.log file while
</I>&gt;<i>  &gt; reproducing the problem using a single transaction?
</I>&gt;<i>  &gt;
</I>&gt;<i>  &gt; 
</I>&gt;<i> <A HREF="https://wiki.squid-cache.org/SquidFaq/BugReporting#debugging-a-single-transaction">https://wiki.squid-cache.org/SquidFaq/BugReporting#debugging-a-single-transaction</A> &lt;<A HREF="https://wiki.squid-cache.org/SquidFaq/BugReporting#debugging-a-single-transaction">https://wiki.squid-cache.org/SquidFaq/BugReporting#debugging-a-single-transaction</A>&gt; &lt;<A HREF="https://wiki.squid-cache.org/SquidFaq/BugReporting#debugging-a-single-transaction">https://wiki.squid-cache.org/SquidFaq/BugReporting#debugging-a-single-transaction</A> &lt;<A HREF="https://wiki.squid-cache.org/SquidFaq/BugReporting#debugging-a-single-transaction">https://wiki.squid-cache.org/SquidFaq/BugReporting#debugging-a-single-transaction</A>&gt;&gt;
</I>&gt;<i>  &gt;
</I>&gt;<i>  &gt; Alex.
</I>&gt;<i>  &gt;
</I>&gt;<i>  &gt;&#160; &gt;
</I>&gt;<i>  &gt;&#160; &gt; 2023/09/12 18:47:04.267 kid4| 24,8| SBuf.cc(30) SBuf: SBuf15514952
</I>&gt;<i>  &gt; created
</I>&gt;<i>  &gt;&#160; &gt; 2023/09/12 18:47:04.267 kid4| 24,8| SBuf.cc(30) SBuf: SBuf15514953
</I>&gt;<i>  &gt; created
</I>&gt;<i>  &gt;&#160; &gt; 2023/09/12 18:47:04.267 kid4| 24,8| SBuf.cc(30) SBuf: SBuf15514954
</I>&gt;<i>  &gt; created
</I>&gt;<i>  &gt;&#160; &gt; 2023/09/12 18:47:04.267 kid4| 24,7| SBuf.cc(85) assign: assigning
</I>&gt;<i>  &gt;&#160; &gt; SBuf15514952 from SBuf15514912
</I>&gt;<i>  &gt;&#160; &gt; 2023/09/12 18:47:04.267 kid4| 24,8| SBuf.cc(38) SBuf: SBuf15514955
</I>&gt;<i>  &gt;&#160; &gt; created from id SBuf15514915
</I>&gt;<i>  &gt;&#160; &gt; 2023/09/12 18:47:04.267 kid4| 24,8| SBuf.cc(445) startsWith:
</I>&gt;<i>  &gt;&#160; &gt; SBuf15514955 startsWith SBuf125812, caseSensitive: 0
</I>&gt;<i>  &gt;&#160; &gt; 2023/09/12 18:47:04.267 kid4| 24,8| SBuf.cc(447) startsWith: no, too
</I>&gt;<i>  &gt; short
</I>&gt;<i>  &gt;&#160; &gt; 2023/09/12 18:47:04.267 kid4| 24,8| Tokenizer.cc(185) skip: no match,
</I>&gt;<i>  &gt;&#160; &gt; not skipping '/squid-internal-mgr/'
</I>&gt;<i>  &gt;&#160; &gt; 2023/09/12 18:47:04 kid4| ERROR: Squid BUG: assurance failed:
</I>&gt;<i>  &gt;&#160; &gt; tok.skip(WellKnownUrlPathPrefix())
</I>&gt;<i>  &gt;&#160; &gt; 2023/09/12 18:47:04.268 kid4| 24,8| SBuf.cc(70) ~SBuf: SBuf15514955
</I>&gt;<i>  &gt;&#160; &gt; destructed
</I>&gt;<i>  &gt;&#160; &gt;
</I>&gt;<i>  &gt;&#160; &gt;
</I>&gt;<i>  &gt;&#160; &gt; BTW debug 24,9 makes pretty big log files... :-)
</I>&gt;<i>  &gt;&#160; &gt;
</I>&gt;<i>  &gt;&#160; &gt; L
</I>&gt;<i>  &gt;&#160; &gt;
</I>&gt;<i>  &gt;
</I>&gt;<i>  &gt;
</I>&gt;<i>  &gt; _______________________________________________
</I>&gt;<i>  &gt; squid-users mailing list
</I>&gt;<i>  &gt; <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i>  &gt; <A HREF="https://lists.squid-cache.org/listinfo/squid-users">https://lists.squid-cache.org/listinfo/squid-users</A> 
</I>&gt;<i> &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">https://lists.squid-cache.org/listinfo/squid-users</A>&gt;
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">https://lists.squid-cache.org/listinfo/squid-users</A>
</I>-------------- next part --------------
commit 381f130
Author: Alex Rousskov &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt;
Date:   Thu Sep 14 17:50:10 2023 -0400

    Work around &quot;TheRoot&quot; assertions after shutdown
    
    Deleting complex objects like Stores and StoreEntries after main() is
    wrong. We probably want to delete (safely, before the end of main())
    those StoreEntries that are no longer in use. We do want to delete
    Stores before main() is over (but still leave TheRoot in a minimally
    functioning state instead of deleted!). This hack does none of that.

diff --git a/src/store/Controller.cc b/src/store/Controller.cc
index 66147a6..caa9757 100644
--- a/src/store/Controller.cc
+++ b/src/store/Controller.cc
@@ -47,10 +47,12 @@ Store::Controller::~Controller()
     delete transients;
     delete swapDir;
 
     if (store_table) {
-        hashFreeItems(store_table, destroyStoreEntry);
-        hashFreeMemory(store_table);
+        // XXX: Cannot destroy MemObjects that still have locks on entries in
+        // stores deleted above!
+        // hashFreeItems(store_table, destroyStoreEntry);
+        // hashFreeMemory(store_table);
         store_table = nullptr;
     }
 }
 
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="026094.html">[squid-users] Squid BUG: assurance failed: tok.skip(WellKnownUrlPathPrefix())
</A></li>
	<LI>Next message (by thread): <A HREF="026098.html">[squid-users] Squid BUG: assurance failed: tok.skip(WellKnownUrlPathPrefix())
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26097">[ date ]</a>
              <a href="thread.html#26097">[ thread ]</a>
              <a href="subject.html#26097">[ subject ]</a>
              <a href="author.html#26097">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
