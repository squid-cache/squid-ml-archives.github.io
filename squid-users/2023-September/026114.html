<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] &#22238;&#22797;&#65306;  ssl-bump peek and select pinned destination failed
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20%3D%3Fgb18030%3Fb%3Fu9i4tKO6ICBzc2wtYnVtcCBwZWVrIGFuZCBz%3F%3D%0A%20%3D%3Fgb18030%3Fq%3Felect_pinned_destination_failed%3F%3D&In-Reply-To=%3Ctencent_D892FBBA7DC5E3A1FFE4C02BD725AE164505%40qq.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="026108.html">
   <LINK REL="Next"  HREF="026109.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] &#22238;&#22797;&#65306;  ssl-bump peek and select pinned destination failed</H1>
    <B>linfengfeiye</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20%3D%3Fgb18030%3Fb%3Fu9i4tKO6ICBzc2wtYnVtcCBwZWVrIGFuZCBz%3F%3D%0A%20%3D%3Fgb18030%3Fq%3Felect_pinned_destination_failed%3F%3D&In-Reply-To=%3Ctencent_D892FBBA7DC5E3A1FFE4C02BD725AE164505%40qq.com%3E"
       TITLE="[squid-users] &#22238;&#22797;&#65306;  ssl-bump peek and select pinned destination failed">linfengfeiye at qq.com
       </A><BR>
    <I>Sat Sep 23 00:18:24 UTC 2023</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="026108.html">[squid-users] ssl-bump peek and select pinned destination failed
</A></li>
        <LI>Next message (by thread): <A HREF="026109.html">[squid-users] Rebuilding Squid 3.5.25 with the `--with-openssl` option generates compilation error
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26114">[ date ]</a>
              <a href="thread.html#26114">[ thread ]</a>
              <a href="subject.html#26114">[ subject ]</a>
              <a href="author.html#26114">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Thank you for your detailed answer.  As you said, Squid does not support rewrite-url after ssl-bumped. but I don't understand why it is designed this way. If I want to modify the ssl-bumped returned content, not through 302,307 http redirect url?  can I use ecap or other methods to achieve it?



------------------&nbsp;&#21407;&#22987;&#37038;&#20214;&nbsp;------------------
&#21457;&#20214;&#20154;: &quot;Alex Rousskov&quot;&lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt;; 
&#21457;&#36865;&#26102;&#38388;: 2023&#24180;9&#26376;21&#26085;(&#26143;&#26399;&#22235;) &#20940;&#26216;0:57
&#25910;&#20214;&#20154;: &quot;squid-users&quot;&lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>&gt;; 
&#20027;&#39064;: Re: [squid-users] ssl-bump peek and select pinned destination failed



On 2023-09-20 04:17, linfengfeiye wrote:
&gt;<i> Hi, what does &quot;PeerSelector186 found pinned, destination&quot; that appears 
</I>&gt;<i> in the Squid log mean?
</I>
Please note that Squid debugging logs (cache.log at level 3 and above) 
are for developer use. This mailing list is not. In triage, I recommend 
focusing on access.log, non-debugging cache.log, and other admin-focused 
resources while leaving debug log analysis to Squid developers.


Roughly speaking, the logging message you are asking about means that 
Squid code tasked with selecting where to forward the request found a 
previously opened Squid-to-server connection that was assigned (i.e., 
&quot;pinned&quot;) to the client-to-Squid connection on which that request was 
received. In most cases, that connection will be used for that request.

In SslBump context, a Squid-to-server TCP connection gets pinned to the 
corresponding client-to-Squid TCP connection because that 
Squid-to-server TLS connection uses TLS settings specific to that client 
and vice versa. Pinning minimizes surprises/changes for TLS clients that 
are not expected to be bumped. It also creates various problems.


&gt;<i> The destination address <A HREF="https://my.local.web">https://my.local.web</A> in this log is returned by 
</I>&gt;<i> URL-Rewrite, rewrite-url=<A HREF="https://my.local.web,">https://my.local.web,</A> which is a local web 
</I>&gt;<i> service of mine.But it failed directly after peer_select. I think this 
</I>&gt;<i> should be related to ssl-bump.
</I>
AFAICT, without significant Squid code adjustments, one cannot rewrite 
destinations of bumped requests because rewritten requests will still be 
assigned the old pinned Squid-to-server connections despite request 
destination changes.


&gt;<i> My decryption configuration is roughly as 
</I>&gt;<i> follows.
</I>&gt;<i> 
</I>&gt;<i> The strange thing is that as long as I comment these two lines,
</I>&gt;<i> 
</I>&gt;<i> #acl step1 at_step SslBump1
</I>&gt;<i> #ssl_bump peek step1 all
</I>&gt;<i> 
</I>&gt;<i>&nbsp; &nbsp;the pinned destination disappears and the access is successful,why?
</I>
Roughly speaking, without SslBump (and certain other special cases), 
there is no need to pin connections and there is no URL rewriting (for 
encrypted requests).


HTH,

Alex.



&gt;<i> ##follows is ssl-bump config################
</I>&gt;<i> 
</I>&gt;<i> http_port 3126 intercept
</I>&gt;<i> https_port 3129 intercept ssl-bump generate-host-certificates=on 
</I>&gt;<i> options=NO_SSLv3 tls-min-version=1.2 dynamic_cert_mem_cache_size=4MB 
</I>&gt;<i> tls-cert=/os/usr/local/proxy/etc/cert.pem
</I>&gt;<i> http_port 3128 ssl-bump generate-host-certificates=on options=NO_SSLv3 
</I>&gt;<i> tls-min-version=1.2 dynamic_cert_mem_cache_size=4MB 
</I>&gt;<i> tls-cert=/usr/local/proxy/etc/cert.pem
</I>&gt;<i> acl step1 at_step SslBump1
</I>&gt;<i> sslcrtd_program /os/usr/local/proxy/libexec/security_file_certgen -s 
</I>&gt;<i> /usr/local/proxy/var/lib/ssl_db -M 4MB
</I>&gt;<i> sslcrtd_children 5
</I>&gt;<i> ssl_bump peek step1 all
</I>&gt;<i> ssl_bump splice white_list
</I>&gt;<i> ssl_bump bump bump_domain
</I>&gt;<i> ssl_bump bump all
</I>&gt;<i> http_access allow all
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">https://lists.squid-cache.org/listinfo/squid-users</A>
</I>
_______________________________________________
squid-users mailing list
<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
<A HREF="https://lists.squid-cache.org/listinfo/squid-users">https://lists.squid-cache.org/listinfo/squid-users</A>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20230923/c5544a90/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20230923/c5544a90/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="026108.html">[squid-users] ssl-bump peek and select pinned destination failed
</A></li>
	<LI>Next message (by thread): <A HREF="026109.html">[squid-users] Rebuilding Squid 3.5.25 with the `--with-openssl` option generates compilation error
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26114">[ date ]</a>
              <a href="thread.html#26114">[ thread ]</a>
              <a href="subject.html#26114">[ subject ]</a>
              <a href="author.html#26114">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
