<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Transparent deployment VS web services behind DNS load balancing
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Transparent%20deployment%20VS%20web%20services%20behind%20DNS%0A%20load%20balancing&In-Reply-To=%3CCAEw7rkzDoT3kp60fT3pfvYhV-LxRJGNoJ10SeHim66KmqZWsYQ%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="026119.html">
   <LINK REL="Next"  HREF="026125.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Transparent deployment VS web services behind DNS load balancing</H1>
    <B>Denis Roy</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Transparent%20deployment%20VS%20web%20services%20behind%20DNS%0A%20load%20balancing&In-Reply-To=%3CCAEw7rkzDoT3kp60fT3pfvYhV-LxRJGNoJ10SeHim66KmqZWsYQ%40mail.gmail.com%3E"
       TITLE="[squid-users] Transparent deployment VS web services behind DNS load balancing">denis.roy at gmail.com
       </A><BR>
    <I>Mon Sep 25 16:35:36 UTC 2023</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="026119.html">[squid-users] Seeking Help with SSL Bump Configuration for ECDSA Ciphers in Squid
</A></li>
        <LI>Next message (by thread): <A HREF="026125.html">[squid-users] Transparent deployment VS web services behind DNS load balancing
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26118">[ date ]</a>
              <a href="thread.html#26118">[ thread ]</a>
              <a href="subject.html#26118">[ subject ]</a>
              <a href="author.html#26118">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>My installation is fairly simple: I run Squid 5.8 in transparent mode, on a
pF based firewall (FreeBDS 14.0) .

I intercept both HTTP 80, and HTTPS 443. Splicing the exceptions I have in
a whitelist, bumping everything else. Simple.

This is a relatively recent deployment, and it has been working well as far
as web browser experience is concerned. Nonetheless, I have observed a
certain amount of 409s sharing similarities (more on that later). Rest
assured, I have made 100% certain my clients and Squid use the same
resolver (Unbound), installed on the same box with a fairly basic
configuration.

When I observe the 409s I am getting, they all share the same similarities:
the original client request was from an application or OS related task,
 using  DNS records with very low TTL. 5 minutes or less, often 2 minutes.
I could easily identify the vast majority of these domains as being load
balanced with DNS solutions like Azure Traffic Manager, and Akamai DNS.

Now, this make sense: a thread on the client may essentially intiate a long
running task that will last a couple of minutes (more than the TTL), during
which it may actually establish a few connections without calling the
gethostbyname function, resulting in squid detecting a forgery attempt
since it will be unable to validate the dst IP match the intended
destination domain. Essentially, creating &quot;false positives'', and dropping
legitimate traffic.

I have searched a lot, and the only reliable way to completely solve this
issue in a transparent deployment has been to implement a number of IP
lists for such services (Azure Cloud, Azure Front Door, AWS, Akamai and
such), bypassing squid completely based on the destination IP address.

I'd be interested to hear what other approaches there might be. Some
package maintainers have chosen to drop the header check altogether (
<A HREF="https://github.com/NethServer/dev/issues/5348">https://github.com/NethServer/dev/issues/5348</A> ).  I believe a better
approach could be to just validate that the SNI of the TLS Client Hello
match the certificate obtained from the remote web server, perform the
usual certificate validation (is it trusted, valid, etc), and not rely so
much on the DNS check which can be expected to fail at times given how DNS
load balancing is ubiquitous with native cloud solutions and large CDNs.
But implementing this change would require serious development, which I am
completely unable to take care of.

Hence, what others have been doing? I want my web security gateway to
remain transparent, and not implement PAC files.

Thank you.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20230925/91deb407/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20230925/91deb407/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="026119.html">[squid-users] Seeking Help with SSL Bump Configuration for ECDSA Ciphers in Squid
</A></li>
	<LI>Next message (by thread): <A HREF="026125.html">[squid-users] Transparent deployment VS web services behind DNS load balancing
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26118">[ date ]</a>
              <a href="thread.html#26118">[ thread ]</a>
              <a href="subject.html#26118">[ subject ]</a>
              <a href="author.html#26118">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
