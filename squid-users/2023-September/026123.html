<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] bug 4906 issue
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20bug%204906%20issue&In-Reply-To=%3C3ccbd5a3-fb92-4d75-9cef-f5831687c9db%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="026121.html">
   <LINK REL="Next"  HREF="026124.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] bug 4906 issue</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20bug%204906%20issue&In-Reply-To=%3C3ccbd5a3-fb92-4d75-9cef-f5831687c9db%40measurement-factory.com%3E"
       TITLE="[squid-users] bug 4906 issue">rousskov at measurement-factory.com
       </A><BR>
    <I>Tue Sep 26 14:09:15 UTC 2023</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="026121.html">[squid-users] bug 4906 issue
</A></li>
        <LI>Next message (by thread): <A HREF="026124.html">[squid-users] bug 4906 issue
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26123">[ date ]</a>
              <a href="thread.html#26123">[ thread ]</a>
              <a href="subject.html#26123">[ subject ]</a>
              <a href="author.html#26123">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 2023-09-26 07:39, Matus UHLAR - fantomas wrote:

&gt;<i> I have just encountered bug 4906 with squid-4.13 (Debian 11)
</I>&gt;<i> 
</I>&gt;<i> I could upgrade system fo Debian 12 with squid-5.7 but this issue 
</I>&gt;<i> doesn't seem to be resolved in it, at least:
</I>&gt;<i> <A HREF="http://www.squid-cache.org/Versions/v5/changesets/">http://www.squid-cache.org/Versions/v5/changesets/</A>
</I>&gt;<i> 
</I>&gt;<i> does not mention that.
</I>
We have not (knowingly) fixed bug 4906 yet. Moreover, there are many 
other places in Squid code that would result in problems similar to 
those reported in bug 4906. A comprehensive unofficial fix that 
addresses the root cause got stuck in my unofficial review queue since 
December 2019.


&gt;<i> I could try to test patch provided in that bugreport:
</I>&gt;<i> <A HREF="https://patch-diff.githubusercontent.com/raw/measurement-factory/squid/pull/20.patch">https://patch-diff.githubusercontent.com/raw/measurement-factory/squid/pull/20.patch</A>
</I>&gt;<i> ...but I find trying such complicated patch too risky.
</I>
You can also try a small old unofficial v4.3 workaround patch attached 
to this email. I do not know whether it will apply to and work with 
4.13. If you are lucky, this workaround will address the immediate 
problem in your environment.


HTH,

Alex.
-------------- next part --------------
Fix src ACL when access logging TCP probes

TCP probe transactions lack HttpRequest object, which is used when
checking ACLs before logging. For this reason, src ACL did not work. To
fix this, we need to supply ACLFilledChecklist with available address
information.

diff --git a/src/client_side.cc b/src/client_side.cc
index d61e278..368c607 100644
--- a/src/client_side.cc
+++ b/src/client_side.cc
@@ -407,91 +407,98 @@ ClientHttpRequest::logRequest()
 
     tvSub(al-&gt;cache.trTime, al-&gt;cache.start_time, current_time);
 
     if (request)
         prepareLogWithRequestDetails(request, al);
 
 #if USE_OPENSSL &amp;&amp; 0
 
     /* This is broken. Fails if the connection has been closed. Needs
      * to snarf the ssl details some place earlier..
      */
     if (getConn() != NULL)
         al-&gt;cache.ssluser = sslGetUserEmail(fd_table[getConn()-&gt;fd].ssl);
 
 #endif
 
     /* Add notes (if we have a request to annotate) */
     if (request) {
         // The al-&gt;notes and request-&gt;notes must point to the same object.
         (void)SyncNotes(*al, *request);
         for (auto i = Config.notes.begin(); i != Config.notes.end(); ++i) {
             if (const char *value = (*i)-&gt;match(request, al-&gt;reply, NULL)) {
                 NotePairs &amp;notes = SyncNotes(*al, *request);
                 notes.add((*i)-&gt;key.termedBuf(), value);
                 debugs(33, 3, (*i)-&gt;key.termedBuf() &lt;&lt; &quot; &quot; &lt;&lt; value);
             }
         }
     }
 
     ACLFilledChecklist checklist(NULL, request, NULL);
+    const auto clientConn = getConn() ? getConn()-&gt;clientConnection : nullptr;
+    if (!request &amp;&amp; clientConn) {
+        // because could not obtain them from request
+        checklist.src_addr = clientConn-&gt;remote;
+        checklist.my_addr = clientConn-&gt;local;
+    }
+
     if (al-&gt;reply) {
         checklist.reply = al-&gt;reply;
         HTTPMSGLOCK(checklist.reply);
     }
 
     if (request) {
         HTTPMSGUNLOCK(al-&gt;adapted_request);
         al-&gt;adapted_request = request;
         HTTPMSGLOCK(al-&gt;adapted_request);
     }
     // no need checklist.syncAle(): already synced
     checklist.al = al;
     accessLogLog(al, &amp;checklist);
 
     bool updatePerformanceCounters = true;
     if (Config.accessList.stats_collection) {
         ACLFilledChecklist statsCheck(Config.accessList.stats_collection, request, NULL);
         statsCheck.al = al;
         if (al-&gt;reply) {
             statsCheck.reply = al-&gt;reply;
             HTTPMSGLOCK(statsCheck.reply);
         }
         updatePerformanceCounters = statsCheck.fastCheck().allowed();
     }
 
     if (updatePerformanceCounters) {
         if (request)
             updateCounters();
 
-        if (getConn() != NULL &amp;&amp; getConn()-&gt;clientConnection != NULL)
-            clientdbUpdate(getConn()-&gt;clientConnection-&gt;remote, logType, AnyP::PROTO_HTTP, out.size);
+        if (clientConn)
+            clientdbUpdate(clientConn-&gt;remote, logType, AnyP::PROTO_HTTP, out.size);
     }
 }
 
 void
 ClientHttpRequest::freeResources()
 {
     safe_free(uri);
     safe_free(redirect.location);
     range_iter.boundary.clean();
     clearRequest();
 
     if (client_stream.tail)
         clientStreamAbort((clientStreamNode *)client_stream.tail-&gt;data, this);
 }
 
 void
 httpRequestFree(void *data)
 {
     ClientHttpRequest *http = (ClientHttpRequest *)data;
     assert(http != NULL);
     delete http;
 }
 
 /* This is a handler normally called by comm_close() */
 void ConnStateData::connStateClosed(const CommCloseCbParams &amp;)
 {
     deleteThis(&quot;ConnStateData::connStateClosed&quot;);
 }
 
 #if USE_AUTH
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="026121.html">[squid-users] bug 4906 issue
</A></li>
	<LI>Next message (by thread): <A HREF="026124.html">[squid-users] bug 4906 issue
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26123">[ date ]</a>
              <a href="thread.html#26123">[ thread ]</a>
              <a href="subject.html#26123">[ subject ]</a>
              <a href="author.html#26123">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
