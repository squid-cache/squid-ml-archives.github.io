<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Transparent deployment VS web services behind DNS load balancing
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Transparent%20deployment%20VS%20web%20services%20behind%20DNS%0A%20load%20balancing&In-Reply-To=%3C918dbf49-b822-49c3-bef7-f41b554bfba8%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="026118.html">
   <LINK REL="Next"  HREF="026121.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Transparent deployment VS web services behind DNS load balancing</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Transparent%20deployment%20VS%20web%20services%20behind%20DNS%0A%20load%20balancing&In-Reply-To=%3C918dbf49-b822-49c3-bef7-f41b554bfba8%40treenet.co.nz%3E"
       TITLE="[squid-users] Transparent deployment VS web services behind DNS load balancing">squid3 at treenet.co.nz
       </A><BR>
    <I>Wed Sep 27 02:10:11 UTC 2023</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="026118.html">[squid-users] Transparent deployment VS web services behind DNS load balancing
</A></li>
        <LI>Next message (by thread): <A HREF="026121.html">[squid-users] bug 4906 issue
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26125">[ date ]</a>
              <a href="thread.html#26125">[ thread ]</a>
              <a href="subject.html#26125">[ subject ]</a>
              <a href="author.html#26125">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 26/09/23 05:35, Denis Roy wrote:
&gt;<i> My installation is fairly simple: I run Squid 5.8 in transparent mode, 
</I>&gt;<i> on a pF based firewall (FreeBDS 14.0) .
</I>&gt;<i> 
</I>&gt;<i> I intercept both HTTP 80, and HTTPS 443. Splicing the exceptions I have 
</I>&gt;<i> in a whitelist, bumping everything else. Simple.
</I>&gt;<i> 
</I>&gt;<i> This is a relatively recent deployment, and it has been working well as 
</I>&gt;<i> far as web browser experience is concerned. Nonetheless, I have observed 
</I>&gt;<i> a certain amount of 409s sharing similarities (more on that later). Rest 
</I>&gt;<i> assured, I have made 100% certain my clients and Squid use the same 
</I>&gt;<i> resolver (Unbound), installed on the same box with a fairly basic 
</I>&gt;<i> configuration.
</I>&gt;<i> 
</I>&gt;<i> When I observe the 409s I am getting, they all share the same 
</I>&gt;<i> similarities: the original client request was from an application or OS 
</I>&gt;<i> related task, &#160;using &#160;DNS records with very low TTL. 5 minutes or less, 
</I>&gt;<i> often 2 minutes.&#160; I could easily identify the vast majority of these 
</I>&gt;<i> domains as being load balanced with DNS solutions like Azure Traffic 
</I>&gt;<i> Manager, and Akamai DNS.
</I>&gt;<i> 
</I>&gt;<i> Now, this make sense: a thread on the client may essentially intiate a 
</I>&gt;<i> long running task that will last a couple of minutes (more than the 
</I>&gt;<i> TTL), during which it may actually establish a few connections without 
</I>&gt;<i> calling the gethostbyname function, resulting in squid detecting a 
</I>&gt;<i> forgery attempt since it will be unable to validate the dst IP match the 
</I>&gt;<i> intended destination domain. Essentially, creating &quot;false positives'', 
</I>&gt;<i> and dropping legitimate traffic.
</I>&gt;<i> 
</I>
Aye, pretty good summary of the current issue.


&gt;<i> I have searched a lot, and the only reliable way to completely solve 
</I>&gt;<i> this issue in a transparent deployment has been to implement a number of 
</I>&gt;<i> IP lists for such services (Azure Cloud, Azure Front Door, AWS, Akamai 
</I>&gt;<i> and such), bypassing squid completely based on the destination IP address.
</I>&gt;<i> 
</I>&gt;<i> I'd be interested to hear what other approaches there might be. Some 
</I>&gt;<i> package maintainers have chosen to drop the header check altogether ( 
</I>&gt;<i> <A HREF="https://github.com/NethServer/dev/issues/5348">https://github.com/NethServer/dev/issues/5348</A> 
</I>&gt;<i> &lt;<A HREF="https://github.com/NethServer/dev/issues/5348">https://github.com/NethServer/dev/issues/5348</A>&gt; ).
</I>

Nod. Thus opening everyone using that package to CVE-2009-0801 effects. 
This is a high risk action that IMO should be an explicit choice by 
admin to do, not a package distributor.


&gt;<i>&#160; I believe a better 
</I>&gt;<i> approach could be to just validate that the SNI of the TLS Client Hello 
</I>&gt;<i> match the certificate obtained from the remote web server, perform the 
</I>&gt;<i> usual certificate validation (is it trusted, valid, etc), and not rely 
</I>&gt;<i> so much on the DNS check
</I>
That is just swapping the client-presented Host header for 
client-presented SNI, and remotely-supplied DNS lookup for 
remotely-supplied certificate lookup. All the security considerations 
problems of CVE-2009-0801 open up again, but at the TLS trust layer 
instead of the HTTP(S) trust layer.

&gt;<i> which can be expected to fail at times given 
</I>&gt;<i> how DNS load balancing is ubiquitous with native cloud solutions and 
</I>&gt;<i> large CDNs.&#160; But implementing this change would require serious 
</I>&gt;<i> development, which I am completely unable to take care of.
</I>
Indeed.

Alternatively the design I have been trying to work towards slowly is 
verifying that all requests on the long-lived connection only go to the 
same origin/server IP. Once trust of that IP has been validated we 
should not have to re-verify every request against new DNS data, just 
against the past history of of the connection.

This approach though is also a lot of development.

HTH
Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="026118.html">[squid-users] Transparent deployment VS web services behind DNS load balancing
</A></li>
	<LI>Next message (by thread): <A HREF="026121.html">[squid-users] bug 4906 issue
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26125">[ date ]</a>
              <a href="thread.html#26125">[ thread ]</a>
              <a href="subject.html#26125">[ subject ]</a>
              <a href="author.html#26125">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
