<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Seeking Help with SSL Bump Configuration, for ECDSA Ciphers in Squid
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Seeking%20Help%20with%20SSL%20Bump%20Configuration%2C%0A%20for%20ECDSA%20Ciphers%20in%20Squid&In-Reply-To=%3Cebd77b31-d10f-4508-8541-e2131a4877d9%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="026128.html">
   <LINK REL="Next"  HREF="026129.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Seeking Help with SSL Bump Configuration, for ECDSA Ciphers in Squid</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Seeking%20Help%20with%20SSL%20Bump%20Configuration%2C%0A%20for%20ECDSA%20Ciphers%20in%20Squid&In-Reply-To=%3Cebd77b31-d10f-4508-8541-e2131a4877d9%40measurement-factory.com%3E"
       TITLE="[squid-users] Seeking Help with SSL Bump Configuration, for ECDSA Ciphers in Squid">rousskov at measurement-factory.com
       </A><BR>
    <I>Wed Sep 27 21:39:16 UTC 2023</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="026128.html">[squid-users] squid-users Digest, Vol 109, Issue 19
</A></li>
        <LI>Next message (by thread): <A HREF="026129.html">[squid-users] TCP_TUNNEL/500 internal server error bandwidth impact
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26138">[ date ]</a>
              <a href="thread.html#26138">[ thread ]</a>
              <a href="subject.html#26138">[ subject ]</a>
              <a href="author.html#26138">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 2023-09-27 08:22, nikhil deshpande wrote:

&gt;<i> [Question]: Are you trying to bump TLS client connections when and only when the TLS
</I>&gt;<i> client is offering to use one of those ciphers in its ClientHello
</I>&gt;<i> message? Or do you want Squid to use one of those ciphers when bumping
</I>&gt;<i> all TLS client connections? Or something else? Please clarify.
</I>&gt;<i> 
</I>&gt;<i> [Answer]:In our case client is offering these two 
</I>&gt;<i> ciphers (ECDHE-ECDSA-AES256-GCM-SHA384 &amp; 
</I>&gt;<i> ECDHE-ECDSA-AES128-GCM-SHA256) in Client Hello but squid is failing 
</I>&gt;<i> to complete handshake with client while performing SSL-Bump.
</I>&gt;<i> 
</I>&gt;<i> We have attached logs and network capture.
</I>

Thank you for sharing that information!

If I start &quot;openssl s_server&quot; configured with the certificate generated 
by Squid (as extracted from your debugging log), then that server 
rejects an &quot;openssl s_client&quot; TLS ClientHello offering the two TLS v1.2 
ciphers you have mentioned above. The server error in this case is &quot;no 
shared cipher&quot;.

If I remove the cipher restriction from the client, the test connection 
succeeds. The negotiated cipher in this case is not one of the two:
ECDHE-RSA-AES256-GCM-SHA384

This is not my area of expertise, but I believe that the certificate 
generated by Squid (and mimicking true origin server certificate 
properties) is not compatible with ciphers supported by the client: The 
ciphers want ECDSA certificate authentication algorithm, but the 
generated certificate uses RSA authentication. The two sides cannot 
communicate because they do not share an authentication algorithm.

     Public Key Algorithm: rsaEncryption


BTW, I get similar results when s_client talks to the true origin server 
in question _without_ restricting s_client ciphers: Successful TLS with 
ECDHE-RSA-AES256-GCM-SHA384 cipher.

If I do restrict s_client ciphers when talking to true origin server, 
then the test transaction also succeeds, but the server returns a 
different certificate and a different cipher is negotiated:
ECDHE-ECDSA-AES256-GCM-SHA384. In this case, the certificate says:

     Public Key Algorithm: id-ecPublicKey

These true origin server experiments support my explanation above.


Why does the origin server send Squid a certificate that the client does 
not support? I believe that happens because Squid _adds_ client cipher 
to Squid-generated ClientHello: Your packet capture does show the two 
client ciphers in from-Squid ClientHello, but that ClientHello has 29 
other ciphers as well! The origin server then picks a different cipher 
offered by Squid and sends a matching server certificate (the one the 
client cannot support).


Going forward, I see two possible options, both requiring non-trivial 
Squid source code modifications:


1. Stop adding OpenSSL ciphers to mimicked ClientHello

I speculate that if Squid were to exactly mimic client cipher offerings 
in its ClientHello sent to the origin server (instead of adding 
client-supported ciphers to OpenSSL-supported ones), then the origin 
server would have returned a different certificate, Squid would have 
mimicked that, and the client-Squid TLS connection would have succeeded.

I do not know whether there are cases where mimicking the client ciphers 
exactly would prevent Squid from successfully bumping the connection.

I do not know how easy it would be for Squid to stop OpenSSL from adding 
all supported ciphers.


2. Mimic origin certificate to be compatible with client ciphers.

For example, when the two algorithms differ, instead of mimicking the 
certificate authentication algorithm in the origin server certificate, 
use the algorithm compatible with client-offered ciphers.

Doing so will allow Squid to bump more connections, and even increase 
security guarantees in some cases (where the algorithm used by the 
server is weaker than what client and Squid can support), but may also 
weaken security guarantees in some cases (in opposite cases).


Others on this mailing list may suggest better alternatives.


<A HREF="https://wiki.squid-cache.org/SquidFaq/AboutSquid#how-to-add-a-new-squid-feature-enhance-of-fix-something">https://wiki.squid-cache.org/SquidFaq/AboutSquid#how-to-add-a-new-squid-feature-enhance-of-fix-something</A>



&gt;<i> [Question]: FWIW, to restrict Squid use of ciphers on accepted TLS client 
</I>&gt;<i> connections, use the http_port (or https_port) &quot;cipher&quot; option.
</I>&gt;<i> 
</I>&gt;<i> [Answer]: We dontwant to restrict to usethisspecific ciphers only. We
</I>&gt;<i> wanted that Squid should use strong ciphers.
</I>
Squid cannot use strong ciphers with the client (_and_ bump the 
connection). If you want Squid to always use strong ciphers with the 
server, but still bump the weaker client connection, then you need a 
combination of two things (at least) AFAICT:

* Option 2 above (Mimic origin certificate to be client-compatible)
* tls_outgoing_options that prohibit weak ciphers (already supported?)


&gt;<i> One more point I wanted to add here is that this issue is getting 
</I>&gt;<i> reproduced with latest squid also.
</I>
Yes, the problem you are facing affects all moderns Squids AFAICT.


Please respond to the _individual_ mailing list message on your thread, 
not the digest with all the messages.


Thank you,

Alex.

&gt;<i>     Message: 3
</I>&gt;<i>     Date: Mon, 25 Sep 2023 15:01:05 +0530
</I>&gt;<i>     From: nikhil deshpande &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">nikhildeshpande18 at gmail.com</A>
</I>&gt;<i>     &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">nikhildeshpande18 at gmail.com</A>&gt;&gt;
</I>&gt;<i>     To: Shyam varun &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">shyam3898 at gmail.com</A> &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">shyam3898 at gmail.com</A>&gt;&gt;
</I>&gt;<i>     Cc: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i>     &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>&gt;, <A HREF="https://lists.squid-cache.org/listinfo/squid-users">jrose at qualys.com</A>
</I>&gt;<i>     &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">jrose at qualys.com</A>&gt;
</I>&gt;<i>     Subject: Re: [squid-users] Seeking Help with SSL Bump Configuration
</I>&gt;<i>      &#160; &#160; &#160; &#160; for ECDSA Ciphers in Squid
</I>&gt;<i>     Message-ID:
</I>&gt;<i>             
</I>&gt;<i>     &lt;CALO-o=<A HREF="https://lists.squid-cache.org/listinfo/squid-users">xTe18tuGww-gsr-vAVKMJqRai1ZvNR-hRqaToWXp1NGQ at mail.gmail.com</A>
</I>&gt;<i>     &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">xTe18tuGww-gsr-vAVKMJqRai1ZvNR-hRqaToWXp1NGQ at mail.gmail.com</A>&gt;&gt;
</I>&gt;<i>     Content-Type: text/plain; charset=&quot;utf-8&quot;
</I>&gt;<i> 
</I>&gt;<i>     Hi team,
</I>&gt;<i> 
</I>&gt;<i>     Any update on this?
</I>&gt;<i> 
</I>&gt;<i>     Regards,
</I>&gt;<i>     Nikhil
</I>&gt;<i> 
</I>&gt;<i>     On Thu, Sep 14, 2023 at 6:05?PM Shyam varun &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">shyam3898 at gmail.com</A>
</I>&gt;<i>     &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">shyam3898 at gmail.com</A>&gt;&gt; wrote:
</I>&gt;<i> 
</I>&gt;<i>      &gt; Dear Squid Mailing List Community,
</I>&gt;<i>      &gt;
</I>&gt;<i>      &gt; I hope this email finds you well. I am currently working on
</I>&gt;<i>     configuring
</I>&gt;<i>      &gt; SSL bump in Squid proxy server to support ECDSA ciphers, and I am
</I>&gt;<i>     seeking
</I>&gt;<i>      &gt; assistance with a particular issue I've encountered.
</I>&gt;<i>      &gt;
</I>&gt;<i>      &gt; To provide some context:
</I>&gt;<i>      &gt;
</I>&gt;<i>      &gt; - *Squid Version:* Squid 5.2
</I>&gt;<i>      &gt; - *OpenSSL Version*: OpenSSL 1.1.1l
</I>&gt;<i>      &gt; - *OS:* Alpine Linux v3.16
</I>&gt;<i>      &gt; -
</I>&gt;<i>      &gt; *Squid Configuration: *
</I>&gt;<i>      &gt;
</I>&gt;<i>      &gt; * sslproxy_cert_error allow all*
</I>&gt;<i>      &gt;
</I>&gt;<i>      &gt; * sslcrtd_program /usr/lib/squid/security_file_certgen -s
</I>&gt;<i>     /var/lib/ssl_db
</I>&gt;<i>      &gt; -M 4MB*
</I>&gt;<i>      &gt;
</I>&gt;<i>      &gt;
</I>&gt;<i>      &gt; * http_port 3129 ssl-bump generate-host-certificates=on
</I>&gt;<i>      &gt; dynamic_cert_mem_cache_size=4MB
</I>&gt;<i>     cert=/opt/ssl/intermediate_certificate.pem
</I>&gt;<i>      &gt; key=/opt/ssl/intermediate_key.pem
</I>&gt;<i>     options=SINGLE_DH_USE,SINGLE_ECDH_USE
</I>&gt;<i>      &gt; tls-dh=/opt/dhparam.pem*
</I>&gt;<i>      &gt;
</I>&gt;<i>      &gt;
</I>&gt;<i>      &gt; * tls_outgoing_options min-version=1.1&#160; options=NO_SSLv3*
</I>&gt;<i>      &gt;
</I>&gt;<i>      &gt;
</I>&gt;<i>      &gt; * acl step1 at_step SslBump1*
</I>&gt;<i>      &gt;
</I>&gt;<i>      &gt; * ssl_bump peek step1*
</I>&gt;<i>      &gt;
</I>&gt;<i>      &gt; * ssl_bump bump all*
</I>&gt;<i>      &gt;
</I>&gt;<i>      &gt;
</I>&gt;<i>      &gt; The goal of my configuration is to enable SSL bump for ECDSA ciphers,
</I>&gt;<i>      &gt; specifically the &quot;ECDHE-ECDSA-AES256-GCM-SHA384&quot; and
</I>&gt;<i>      &gt; &quot;ECDHE-ECDSA-AES128-GCM-SHA256&quot; cipher suites. However, I've run into
</I>&gt;<i>      &gt; challenges and issues while trying to achieve this.
</I>&gt;<i>      &gt;
</I>&gt;<i>      &gt; *Things I tried:*
</I>&gt;<i>      &gt;
</I>&gt;<i>      &gt;&#160; &#160; 1. I created an ECDSA-based certificate chain using OpenSSL.
</I>&gt;<i>      &gt;&#160; &#160; 2. I configured the ECDSA-based certificate certs in squid as
</I>&gt;<i>     shown in
</I>&gt;<i>      &gt;&#160; &#160; above snippet but still not able to make it work.
</I>&gt;<i>      &gt;
</I>&gt;<i>      &gt;
</I>&gt;<i>      &gt; I've thoroughly reviewed the Squid documentation and online
</I>&gt;<i>     resources, but
</I>&gt;<i>      &gt; I haven't been able to resolve these issues on my own.
</I>&gt;<i>      &gt;
</I>&gt;<i>      &gt; I would greatly appreciate any guidance, insights, or assistance
</I>&gt;<i>     from the
</I>&gt;<i>      &gt; Squid community regarding the proper configuration for SSL bump
</I>&gt;<i>     with ECDSA
</I>&gt;<i>      &gt; ciphers. If you have successfully configured Squid to support
</I>&gt;<i>     ECDSA ciphers
</I>&gt;<i>      &gt; or if you have expertise in this area, your input would be
</I>&gt;<i>     invaluable.
</I>&gt;<i>      &gt;
</I>&gt;<i>      &gt; Thank you in advance for your time and support. I look forward to
</I>&gt;<i>     your
</I>&gt;<i>      &gt; responses and insights.
</I>&gt;<i>      &gt;
</I>&gt;<i> 
</I>&gt;<i>     End of squid-users Digest, Vol 109, Issue 19
</I>&gt;<i>     ********************************************
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="026128.html">[squid-users] squid-users Digest, Vol 109, Issue 19
</A></li>
	<LI>Next message (by thread): <A HREF="026129.html">[squid-users] TCP_TUNNEL/500 internal server error bandwidth impact
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26138">[ date ]</a>
              <a href="thread.html#26138">[ thread ]</a>
              <a href="subject.html#26138">[ subject ]</a>
              <a href="author.html#26138">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
