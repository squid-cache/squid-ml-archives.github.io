<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] TLS passthrough
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20TLS%20passthrough&In-Reply-To=%3C38e0a961-318d-4b05-99d3-e824480712a1%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="026159.html">
   <LINK REL="Next"  HREF="026161.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] TLS passthrough</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20TLS%20passthrough&In-Reply-To=%3C38e0a961-318d-4b05-99d3-e824480712a1%40measurement-factory.com%3E"
       TITLE="[squid-users] TLS passthrough">rousskov at measurement-factory.com
       </A><BR>
    <I>Fri Sep 29 15:53:10 UTC 2023</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="026159.html">[squid-users] TLS passthrough
</A></li>
        <LI>Next message (by thread): <A HREF="026161.html">[squid-users] TLS passthrough
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26160">[ date ]</a>
              <a href="thread.html#26160">[ thread ]</a>
              <a href="subject.html#26160">[ subject ]</a>
              <a href="author.html#26160">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 2023-09-29 10:55, Fernando Giorgetti wrote:
&gt;<i>     Do you control the client application? If yes, then perhaps it can be
</I>&gt;<i>     adjusted to support HTTP proxies? In other words, the client will send a
</I>&gt;<i>     plain text HTTP CONNECT request to Squid and, upon receiving a 200
</I>&gt;<i>     (Connection Established) response headers, will start using TLS with the
</I>&gt;<i>     origin server. In this case, you do not need interception.
</I>

&gt;<i> Nope, the client application is also used to communicate with other apps in
</I>&gt;<i> other environments. 
</I>
FWIW, &quot;used with other apps&quot; does not imply or explain the &quot;nope, we do 
not control the application&quot; answer IMHO.


&gt;<i> The SNI has to be used as the client/server apps perform
</I>&gt;<i> mutual TLS authentication.
</I>
To avoid a misunderstanding, nothing I have said precludes the use of 
TLS SNI by the client application. Thus, I am not sure why you are 
saying the above.


&gt;<i> In order to evaluate if we can use Squid for this purpose, I have
</I>&gt;<i> also created a basic TLS client/server app to validate what is
</I>&gt;<i> happening. Basically my TLS client tries to connect directly to Squid
</I>&gt;<i> IP/Port and I am indicating the SNI so that the TLS handshake
</I>&gt;<i> passes.
</I>
FWIW, a scenario where the client application establishes a TLS 
connection with Squid https_port (configured as a reverse HTTPS proxy) 
will not work for your use case AFAICT. I am not sure why you are 
testing this. It has not been suggested on this mailing list.

BTW, you can use (&quot;curl&quot; or even &quot;openssl s_client&quot;) and &quot;openssl 
s_server&quot; for basic tests. I recommend using well-known test programs 
(instead of custom apps) because doing so makes it easier for mailing 
list readers to understand what your test clients and servers are doing 
(and to reproduce your setup).


&gt;<i> When I tried to make it work using a forward proxy with intercept and
</I>&gt;<i> ssl_bump, I could not make Squid peek at the SNI and tunnel the
</I>&gt;<i> request to the correct destination.
</I>
Please note that &quot;forward proxy with intercept&quot; is an oxymoron -- the 
two port modes (i.e. explicit &quot;intercept&quot; and default forward proxying) 
are mutually exclusive.

If you do not want to or cannot modify/configure the client application 
to use Squid as a forward HTTP proxy (as I detailed earlier; see the 
paragraph still quoted at the beginning of this message), then your 
other choice is interception (as I detailed earlier; see the &quot;Squid 
supports blind tunneling of intercepted TCP connections&quot; discussion in 
the previous exchange).

When Squid https_port gets an intercepted client TCP connection, Squid 
does not need SNI to know where to forward that TCP connection. Squid 
opens a TCP connection to the IP address where the client TCP connection 
was going (or trying to go) before it was intercepted. That intended 
destination IP address is delivered to Squid by the OS, as a part of 
interception mechanism/setup. TLS and SNI are not involved in this process.

If you have not tested an interception scenario, please do. If you have, 
please share your interception configuration, Squid configuration, and 
any relevant error/problem information.


HTH,

Alex.


&gt;<i> On Fri, Sep 29, 2023 at 11:35&#8239;AM Alex Rousskov wrote:
</I>&gt;<i> 
</I>&gt;<i>     On 2023-09-29 09:17, Fernando Giorgetti wrote:
</I>&gt;<i> 
</I>&gt;<i>      &gt; Actually I am evaluating if Squid can be used to proxy Non-HTTP/TLS
</I>&gt;<i>      &gt; data, as we have a restricted environment where Squid is
</I>&gt;<i>     currently the
</I>&gt;<i>      &gt; only way to get out to the internet.
</I>&gt;<i> 
</I>&gt;<i>     Yes, Squid can tunnel non-HTTP data, including TLS data.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i>      &gt; The idea is that the client application will open a connection to
</I>&gt;<i>     a given
</I>&gt;<i>      &gt; hostname and port (setting&#160;the SNI in the TLS options),
</I>&gt;<i>     considering that
</I>&gt;<i>      &gt; the given hostname/port is the actual backend they're trying to
</I>&gt;<i>     reach.
</I>&gt;<i> 
</I>&gt;<i>     Do you control the client application? If yes, then perhaps it can be
</I>&gt;<i>     adjusted to support HTTP proxies? In other words, the client will
</I>&gt;<i>     send a
</I>&gt;<i>     plain text HTTP CONNECT request to Squid and, upon receiving a 200
</I>&gt;<i>     (Connection Established) response headers, will start using TLS with
</I>&gt;<i>     the
</I>&gt;<i>     origin server. In this case, you do not need interception.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i>      &gt; We can either try to use a fake hostname (defined in the
</I>&gt;<i>     /etc/hosts of the
</I>&gt;<i>      &gt; tls client machine) which would actually point to Squid's IP
</I>&gt;<i> 
</I>&gt;<i>     AFAICT, faking the IP address will not work without Squid source code
</I>&gt;<i>     modifications because a non-intercepting Squid https_port will want to
</I>&gt;<i>     terminate TLS -- such a port does not support blindly tunneling traffic.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i>      &gt; or eventually
</I>&gt;<i>      &gt; redirect traffic to the real destination into Squid using a DNAT
</I>&gt;<i>     rule.
</I>&gt;<i> 
</I>&gt;<i>     I am not a DNAT expert, but this sounds like interception to me. Bugs
</I>&gt;<i>     notwithstanding, Squid supports blind tunneling of intercepted TCP
</I>&gt;<i>     connections (to their intended destination):
</I>&gt;<i> 
</I>&gt;<i>      &#160; &#160; &#160;https_port X intercept ssl-bump ...
</I>&gt;<i>      &#160; &#160; &#160;ssl_bump splice all
</I>&gt;<i> 
</I>&gt;<i>     On a successful tunneling path, the above configuration does not care
</I>&gt;<i>     whether the intercepted traffic is TLS and will not peek at TLS SNI,
</I>&gt;<i>     but
</I>&gt;<i>     nothing in your requirements necessitates SNI knowledge AFAICT.
</I>&gt;<i> 
</I>&gt;<i>     If Squid fails to establish a TCP connection to the intended
</I>&gt;<i>     destination
</I>&gt;<i>     of the intercepted connection, then the situation becomes more complex:
</I>&gt;<i>     Squid (with the above configuration) assumes that the client is
</I>&gt;<i>     speaking
</I>&gt;<i>     TLS. Squid will attempt to bump the TLS client connection and send a
</I>&gt;<i>     Squid-generated HTTP error response to the client. AFAIK, this bumping
</I>&gt;<i>     and error sending attempt cannot be prevented in this case without
</I>&gt;<i>     Squid
</I>&gt;<i>     source code modifications: Squid used to be able to terminate a
</I>&gt;<i>     client-Squid connection instead of sending a Squid-generated HTTP error
</I>&gt;<i>     response (by replacing the corresponding Squid error page contents with
</I>&gt;<i>     a word &quot;reset&quot;). However, that feature was accidentally(?) dropped in
</I>&gt;<i>     2002 commit 76cdc28 AFAICT.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i>     HTH,
</I>&gt;<i> 
</I>&gt;<i>     Alex.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i>      &gt; But overall, it will be a 1:1 relationship, meaning, the
</I>&gt;<i>     https_port on Squid
</I>&gt;<i>      &gt; would be used exclusively to this purpose of proxying from a
</I>&gt;<i>     given source
</I>&gt;<i>      &gt; to a given destination.
</I>&gt;<i>      &gt;
</I>&gt;<i>      &gt; That is why I was considering a reverse-proxy, but I had no luck
</I>&gt;<i>     with it
</I>&gt;<i>      &gt; (actually
</I>&gt;<i>      &gt; I was able to proxy HTTP/HTTPS, but not non-http).
</I>&gt;<i>      &gt;
</I>&gt;<i>      &gt; Thank you again,
</I>&gt;<i>      &gt; Fernando
</I>&gt;<i>      &gt;
</I>&gt;<i>      &gt; On Thu, Sep 28, 2023 at 11:39&#8239;PM Alex Rousskov
</I>&gt;<i>      &gt; &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>
</I>&gt;<i>     &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt;
</I>&gt;<i>      &gt; &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>
</I>&gt;<i>     &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt;&gt;&gt; wrote:
</I>&gt;<i>      &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160;On 2023-09-28 20:35, Fernando Giorgetti wrote:
</I>&gt;<i>      &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt; Do you have any recommendations on how I could have it done?
</I>&gt;<i>      &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160;I am unable to confirm whether Squid can do what you want or
</I>&gt;<i>     provide
</I>&gt;<i>      &gt;&#160; &#160; &#160;configuration recommendations because I do not yet know how
</I>&gt;<i>     your Squid
</I>&gt;<i>      &gt;&#160; &#160; &#160;will receive traffic (e.g., an intercepting proxy or an explicit
</I>&gt;<i>      &gt;&#160; &#160; &#160;forward
</I>&gt;<i>      &gt;&#160; &#160; &#160;HTTP proxy), what traffic Squid will receive (e.g., TLS,
</I>&gt;<i>     plain HTTP,
</I>&gt;<i>      &gt;&#160; &#160; &#160;something else), and what you want Squid to do with that traffic.
</I>&gt;<i>      &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160;To make progress, I recommend describing the above details
</I>&gt;<i>     (for one
</I>&gt;<i>      &gt;&#160; &#160; &#160;typical use case?) and then answering any followup questions.
</I>&gt;<i>      &gt;
</I>&gt;<i>      &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160;Cheers,
</I>&gt;<i>      &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160;Alex.
</I>&gt;<i>      &gt;
</I>&gt;<i>      &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt; When my tls client tries to reach the target
</I>&gt;<i>     through&#160;Squid, using
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt; a &quot;ssl_bump splice&quot;, it seems like squid is trying to reach
</I>&gt;<i>      &gt;&#160; &#160; &#160;itself in a
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt; loop.
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt; I have also tried including a peek first, but no luck.
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt; Thanks again for all suggestions.
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt; On Thu, Sep 28, 2023 at 7:23&#8239;PM Alex Rousskov wrote:
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160;On 2023-09-28 15:23, Fernando Giorgetti wrote:
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt; Actually with the suggested blind passthrough,
</I>&gt;<i>     Squid would not
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160;handle
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt; the TLS termination.
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160;Correct.
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt; how will Squid know what the target is?
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160;In many cases, Squid can learn SNI by peeking at TLS
</I>&gt;<i>     ClientHello,
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160;without terminating TLS. Bugs notwithstanding, none of the
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160;configuration
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160;sketches I shared previously will do that though.
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160;HTH,
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160;Alex.
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt; On Thu, Sep 28, 2023 at 1:02&#8239;PM Alex Rousskov wrote:
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160;On 2023-09-28 11:31, Fernando Giorgetti wrote:
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt; And what should&#160;I do to let Squid use the SNI
</I>&gt;<i>      &gt;&#160; &#160; &#160;defined by
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160;the TLS
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160;client?
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160;What do you want Squid to use that SNI for?
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160;Alex.
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt; On Thu, Sep 28, 2023 at 11:51&#8239;AM Alex
</I>&gt;<i>     Rousskov wrote:
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160;On 2023-09-28 09:06, Fernando Giorgetti
</I>&gt;<i>     wrote:
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt; Hi Matus, do you mean something like
</I>&gt;<i>     a DNAT
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160;(iptables) rule?
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt; If so, I would say, it should work as
</I>&gt;<i>     well.
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt; But this is an environment I do not
</I>&gt;<i>     control,
</I>&gt;<i>      &gt;&#160; &#160; &#160;and I have
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160;been told
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160;to try
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt; using an existing squid installation
</I>&gt;<i>     to proxy
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160;non-http/TLS
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160;data
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160;through.
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt; I appreciate any guidance or
</I>&gt;<i>     recommendation.
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160;Bugs notwithstanding, Squid can blindly
</I>&gt;<i>     tunnel
</I>&gt;<i>      &gt;&#160; &#160; &#160;intercepted
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160;(at TCP port
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160;X) TCP traffic to its intended destination:
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &#160; &#160; &#160;https_port X intercept ssl-bump ...
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &#160; &#160; &#160;ssl_bump splice all
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160;Without interception, then Squid can only
</I>&gt;<i>      &gt;&#160; &#160; &#160;tunnel stuff
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160;inside
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160;HTTP
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160;CONNECT tunnels (for HTTP CONNECT requests
</I>&gt;<i>      &gt;&#160; &#160; &#160;received at TCP
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160;port Y):
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &#160; &#160; &#160;http_port Y ssl-bump ...
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &#160; &#160; &#160;ssl_bump splice all
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160;In both cases, Squid does not care about the
</I>&gt;<i>      &gt;&#160; &#160; &#160;protocols
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160;that
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160;tunneled
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160;traffic is using. It could be HTTP,
</I>&gt;<i>     HTTPS, TLS, or
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160;anything
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160;else on top
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160;of TCP.
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160;Your ACLs may differ from &quot;all&quot; in the above
</I>&gt;<i>      &gt;&#160; &#160; &#160;sketches,
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160;of course,
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160;but if
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160;traffic is not TLS, then you want an
</I>&gt;<i>     &quot;ssl_bump
</I>&gt;<i>      &gt;&#160; &#160; &#160;splice&quot;
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160;rule that
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160;matches
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160;during SslBump step1. A rule with an
</I>&gt;<i>     &quot;all&quot; ACLs
</I>&gt;<i>      &gt;&#160; &#160; &#160;is the
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160;simplest example
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160;of that.
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160;HTH,
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160;Alex.
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160;P.S. I am getting an &quot;Internal Server
</I>&gt;<i>     Error&quot; when
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160;following
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160;the haproxy
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160;link in the original question, so I
</I>&gt;<i>     cannot map what
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160;that page
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160;says to
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160;the configurations above.
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt; On Thu, Sep 28, 2023 at 3:41&#8239;AM Matus
</I>&gt;<i>     UHLAR -
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160;fantomas wrote:
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160;On 27.09.23 16:48, Fernando
</I>&gt;<i>     Giorgetti wrote:
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;I would like to know if it is
</I>&gt;<i>     possible
</I>&gt;<i>      &gt;&#160; &#160; &#160;to set up
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160;Squid to
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160;perform
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;TLS passthrough to a given backend,
</I>&gt;<i>      &gt;&#160; &#160; &#160;relaying TLS
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160;encrypted
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;traffic to the backend,
</I>&gt;<i>     similarly to
</I>&gt;<i>      &gt;&#160; &#160; &#160;what HAProxy
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160;does below?
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;
</I>&gt;<i>      &gt;     
</I>&gt;<i>      &gt;<A HREF="https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough">https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough</A>
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;I have tried a few different
</I>&gt;<i>      &gt;&#160; &#160; &#160;configurations using
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160;reverse
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160;proxy,
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;or peek and splice, but I could not
</I>&gt;<i>      &gt;&#160; &#160; &#160;make it
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160;work without
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160;providing
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;a valid HTTP request or a
</I>&gt;<i>     CONNECT request.
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160;what's the difference between TCP
</I>&gt;<i>      &gt;&#160; &#160; &#160;redirect and
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160;this?
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160;--
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160; &gt;&#160; &#160; &#160;Depression is merely anger without
</I>&gt;<i>      &gt;&#160; &#160; &#160;enthusiasm.
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="026159.html">[squid-users] TLS passthrough
</A></li>
	<LI>Next message (by thread): <A HREF="026161.html">[squid-users] TLS passthrough
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26160">[ date ]</a>
              <a href="thread.html#26160">[ thread ]</a>
              <a href="subject.html#26160">[ subject ]</a>
              <a href="author.html#26160">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
