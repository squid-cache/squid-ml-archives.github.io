<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] TLS passthrough
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20TLS%20passthrough&In-Reply-To=%3CCADxZ%3DiWJ_g8KQ1wYoah-EcLXuAx1MgXqJhCFoJ8xfg3t6GZmug%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="026160.html">
   <LINK REL="Next"  HREF="026162.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] TLS passthrough</H1>
    <B>Fernando Giorgetti</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20TLS%20passthrough&In-Reply-To=%3CCADxZ%3DiWJ_g8KQ1wYoah-EcLXuAx1MgXqJhCFoJ8xfg3t6GZmug%40mail.gmail.com%3E"
       TITLE="[squid-users] TLS passthrough">fgiorgetti at gmail.com
       </A><BR>
    <I>Fri Sep 29 17:55:12 UTC 2023</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="026160.html">[squid-users] TLS passthrough
</A></li>
        <LI>Next message (by thread): <A HREF="026162.html">[squid-users] TLS passthrough
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26161">[ date ]</a>
              <a href="thread.html#26161">[ thread ]</a>
              <a href="subject.html#26161">[ subject ]</a>
              <a href="author.html#26161">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Alex,

Sorry for my misconceptions in my previous email.

The &quot;intercept&quot; scenario demonstrated here
<A HREF="https://wiki.squid-cache.org/ConfigExamples/Intercept/AtSource">https://wiki.squid-cache.org/ConfigExamples/Intercept/AtSource</A>
makes sense to me, as we are just redirecting internal traffic into Squid,
so the original destination IP is preserved.

I was able to make it work and that TLS app (which I have no control at
all),
worked just fine. The only constraint is that it requires that both the
client and
Squid ran on the same machine, but at least it worked perfectly.

Here is my squid.conf (just in case someone eventually has a similar issue):

acl CONNECT method CONNECT
acl mytlsserverip dst 10.0.0.10
http_access allow CONNECT mytlsserverip

http_port 3128

https_port 127.0.0.1:3129 intercept ssl-bump \
  tls-cert=/tmp/certs/squid.pem \
  tls-key=/tmp/certs/squid.key \
  generate-host-certificates=off

ssl_bump splice all


And here are the firewall rules I have used:

iptables -t nat -I OUTPUT -p tcp -d 10.0.0.10 --dport 55671 -j DNAT
--to-destination 127.0.0.1:3129
iptables -t nat -I OUTPUT --match owner --uid-owner squid  -p tcp -d
10.0.0.10 --dport 55671 -j ACCEPT

I appreciate all the guidance and discussion Matus and Alex.

Thank you,
Fernando

On Fri, Sep 29, 2023 at 12:53&#8239;PM Alex Rousskov &lt;
<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt; wrote:

&gt;<i> On 2023-09-29 10:55, Fernando Giorgetti wrote:
</I>&gt;<i> &gt;     Do you control the client application? If yes, then perhaps it can be
</I>&gt;<i> &gt;     adjusted to support HTTP proxies? In other words, the client will
</I>&gt;<i> send a
</I>&gt;<i> &gt;     plain text HTTP CONNECT request to Squid and, upon receiving a 200
</I>&gt;<i> &gt;     (Connection Established) response headers, will start using TLS with
</I>&gt;<i> the
</I>&gt;<i> &gt;     origin server. In this case, you do not need interception.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; Nope, the client application is also used to communicate with other apps
</I>&gt;<i> in
</I>&gt;<i> &gt; other environments.
</I>&gt;<i>
</I>&gt;<i> FWIW, &quot;used with other apps&quot; does not imply or explain the &quot;nope, we do
</I>&gt;<i> not control the application&quot; answer IMHO.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; The SNI has to be used as the client/server apps perform
</I>&gt;<i> &gt; mutual TLS authentication.
</I>&gt;<i>
</I>&gt;<i> To avoid a misunderstanding, nothing I have said precludes the use of
</I>&gt;<i> TLS SNI by the client application. Thus, I am not sure why you are
</I>&gt;<i> saying the above.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; In order to evaluate if we can use Squid for this purpose, I have
</I>&gt;<i> &gt; also created a basic TLS client/server app to validate what is
</I>&gt;<i> &gt; happening. Basically my TLS client tries to connect directly to Squid
</I>&gt;<i> &gt; IP/Port and I am indicating the SNI so that the TLS handshake
</I>&gt;<i> &gt; passes.
</I>&gt;<i>
</I>&gt;<i> FWIW, a scenario where the client application establishes a TLS
</I>&gt;<i> connection with Squid https_port (configured as a reverse HTTPS proxy)
</I>&gt;<i> will not work for your use case AFAICT. I am not sure why you are
</I>&gt;<i> testing this. It has not been suggested on this mailing list.
</I>&gt;<i>
</I>&gt;<i> BTW, you can use (&quot;curl&quot; or even &quot;openssl s_client&quot;) and &quot;openssl
</I>&gt;<i> s_server&quot; for basic tests. I recommend using well-known test programs
</I>&gt;<i> (instead of custom apps) because doing so makes it easier for mailing
</I>&gt;<i> list readers to understand what your test clients and servers are doing
</I>&gt;<i> (and to reproduce your setup).
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; When I tried to make it work using a forward proxy with intercept and
</I>&gt;<i> &gt; ssl_bump, I could not make Squid peek at the SNI and tunnel the
</I>&gt;<i> &gt; request to the correct destination.
</I>&gt;<i>
</I>&gt;<i> Please note that &quot;forward proxy with intercept&quot; is an oxymoron -- the
</I>&gt;<i> two port modes (i.e. explicit &quot;intercept&quot; and default forward proxying)
</I>&gt;<i> are mutually exclusive.
</I>&gt;<i>
</I>&gt;<i> If you do not want to or cannot modify/configure the client application
</I>&gt;<i> to use Squid as a forward HTTP proxy (as I detailed earlier; see the
</I>&gt;<i> paragraph still quoted at the beginning of this message), then your
</I>&gt;<i> other choice is interception (as I detailed earlier; see the &quot;Squid
</I>&gt;<i> supports blind tunneling of intercepted TCP connections&quot; discussion in
</I>&gt;<i> the previous exchange).
</I>&gt;<i>
</I>&gt;<i> When Squid https_port gets an intercepted client TCP connection, Squid
</I>&gt;<i> does not need SNI to know where to forward that TCP connection. Squid
</I>&gt;<i> opens a TCP connection to the IP address where the client TCP connection
</I>&gt;<i> was going (or trying to go) before it was intercepted. That intended
</I>&gt;<i> destination IP address is delivered to Squid by the OS, as a part of
</I>&gt;<i> interception mechanism/setup. TLS and SNI are not involved in this process.
</I>&gt;<i>
</I>&gt;<i> If you have not tested an interception scenario, please do. If you have,
</I>&gt;<i> please share your interception configuration, Squid configuration, and
</I>&gt;<i> any relevant error/problem information.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> HTH,
</I>&gt;<i>
</I>&gt;<i> Alex.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; On Fri, Sep 29, 2023 at 11:35&#8239;AM Alex Rousskov wrote:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     On 2023-09-29 09:17, Fernando Giorgetti wrote:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;      &gt; Actually I am evaluating if Squid can be used to proxy
</I>&gt;<i> Non-HTTP/TLS
</I>&gt;<i> &gt;      &gt; data, as we have a restricted environment where Squid is
</I>&gt;<i> &gt;     currently the
</I>&gt;<i> &gt;      &gt; only way to get out to the internet.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     Yes, Squid can tunnel non-HTTP data, including TLS data.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;      &gt; The idea is that the client application will open a connection to
</I>&gt;<i> &gt;     a given
</I>&gt;<i> &gt;      &gt; hostname and port (setting the SNI in the TLS options),
</I>&gt;<i> &gt;     considering that
</I>&gt;<i> &gt;      &gt; the given hostname/port is the actual backend they're trying to
</I>&gt;<i> &gt;     reach.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     Do you control the client application? If yes, then perhaps it can be
</I>&gt;<i> &gt;     adjusted to support HTTP proxies? In other words, the client will
</I>&gt;<i> &gt;     send a
</I>&gt;<i> &gt;     plain text HTTP CONNECT request to Squid and, upon receiving a 200
</I>&gt;<i> &gt;     (Connection Established) response headers, will start using TLS with
</I>&gt;<i> &gt;     the
</I>&gt;<i> &gt;     origin server. In this case, you do not need interception.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;      &gt; We can either try to use a fake hostname (defined in the
</I>&gt;<i> &gt;     /etc/hosts of the
</I>&gt;<i> &gt;      &gt; tls client machine) which would actually point to Squid's IP
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     AFAICT, faking the IP address will not work without Squid source code
</I>&gt;<i> &gt;     modifications because a non-intercepting Squid https_port will want
</I>&gt;<i> to
</I>&gt;<i> &gt;     terminate TLS -- such a port does not support blindly tunneling
</I>&gt;<i> traffic.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;      &gt; or eventually
</I>&gt;<i> &gt;      &gt; redirect traffic to the real destination into Squid using a DNAT
</I>&gt;<i> &gt;     rule.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     I am not a DNAT expert, but this sounds like interception to me. Bugs
</I>&gt;<i> &gt;     notwithstanding, Squid supports blind tunneling of intercepted TCP
</I>&gt;<i> &gt;     connections (to their intended destination):
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;           https_port X intercept ssl-bump ...
</I>&gt;<i> &gt;           ssl_bump splice all
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     On a successful tunneling path, the above configuration does not care
</I>&gt;<i> &gt;     whether the intercepted traffic is TLS and will not peek at TLS SNI,
</I>&gt;<i> &gt;     but
</I>&gt;<i> &gt;     nothing in your requirements necessitates SNI knowledge AFAICT.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     If Squid fails to establish a TCP connection to the intended
</I>&gt;<i> &gt;     destination
</I>&gt;<i> &gt;     of the intercepted connection, then the situation becomes more
</I>&gt;<i> complex:
</I>&gt;<i> &gt;     Squid (with the above configuration) assumes that the client is
</I>&gt;<i> &gt;     speaking
</I>&gt;<i> &gt;     TLS. Squid will attempt to bump the TLS client connection and send a
</I>&gt;<i> &gt;     Squid-generated HTTP error response to the client. AFAIK, this
</I>&gt;<i> bumping
</I>&gt;<i> &gt;     and error sending attempt cannot be prevented in this case without
</I>&gt;<i> &gt;     Squid
</I>&gt;<i> &gt;     source code modifications: Squid used to be able to terminate a
</I>&gt;<i> &gt;     client-Squid connection instead of sending a Squid-generated HTTP
</I>&gt;<i> error
</I>&gt;<i> &gt;     response (by replacing the corresponding Squid error page contents
</I>&gt;<i> with
</I>&gt;<i> &gt;     a word &quot;reset&quot;). However, that feature was accidentally(?) dropped in
</I>&gt;<i> &gt;     2002 commit 76cdc28 AFAICT.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     HTH,
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     Alex.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;      &gt; But overall, it will be a 1:1 relationship, meaning, the
</I>&gt;<i> &gt;     https_port on Squid
</I>&gt;<i> &gt;      &gt; would be used exclusively to this purpose of proxying from a
</I>&gt;<i> &gt;     given source
</I>&gt;<i> &gt;      &gt; to a given destination.
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt; That is why I was considering a reverse-proxy, but I had no luck
</I>&gt;<i> &gt;     with it
</I>&gt;<i> &gt;      &gt; (actually
</I>&gt;<i> &gt;      &gt; I was able to proxy HTTP/HTTPS, but not non-http).
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt; Thank you again,
</I>&gt;<i> &gt;      &gt; Fernando
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt; On Thu, Sep 28, 2023 at 11:39&#8239;PM Alex Rousskov
</I>&gt;<i> &gt;      &gt; &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>
</I>&gt;<i> &gt;     &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt;
</I>&gt;<i> &gt;      &gt; &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>
</I>&gt;<i> &gt;     &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt;&gt;&gt; wrote:
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt;     On 2023-09-28 20:35, Fernando Giorgetti wrote:
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt; Do you have any recommendations on how I could have it
</I>&gt;<i> done?
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt;     I am unable to confirm whether Squid can do what you want or
</I>&gt;<i> &gt;     provide
</I>&gt;<i> &gt;      &gt;     configuration recommendations because I do not yet know how
</I>&gt;<i> &gt;     your Squid
</I>&gt;<i> &gt;      &gt;     will receive traffic (e.g., an intercepting proxy or an
</I>&gt;<i> explicit
</I>&gt;<i> &gt;      &gt;     forward
</I>&gt;<i> &gt;      &gt;     HTTP proxy), what traffic Squid will receive (e.g., TLS,
</I>&gt;<i> &gt;     plain HTTP,
</I>&gt;<i> &gt;      &gt;     something else), and what you want Squid to do with that
</I>&gt;<i> traffic.
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt;     To make progress, I recommend describing the above details
</I>&gt;<i> &gt;     (for one
</I>&gt;<i> &gt;      &gt;     typical use case?) and then answering any followup questions.
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt;     Cheers,
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt;     Alex.
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt; When my tls client tries to reach the target
</I>&gt;<i> &gt;     through Squid, using
</I>&gt;<i> &gt;      &gt;      &gt; a &quot;ssl_bump splice&quot;, it seems like squid is trying to reach
</I>&gt;<i> &gt;      &gt;     itself in a
</I>&gt;<i> &gt;      &gt;      &gt; loop.
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt; I have also tried including a peek first, but no luck.
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt; Thanks again for all suggestions.
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt; On Thu, Sep 28, 2023 at 7:23&#8239;PM Alex Rousskov wrote:
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;     On 2023-09-28 15:23, Fernando Giorgetti wrote:
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;      &gt; Actually with the suggested blind passthrough,
</I>&gt;<i> &gt;     Squid would not
</I>&gt;<i> &gt;      &gt;      &gt;     handle
</I>&gt;<i> &gt;      &gt;      &gt;      &gt; the TLS termination.
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;     Correct.
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;      &gt; how will Squid know what the target is?
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;     In many cases, Squid can learn SNI by peeking at TLS
</I>&gt;<i> &gt;     ClientHello,
</I>&gt;<i> &gt;      &gt;      &gt;     without terminating TLS. Bugs notwithstanding, none of
</I>&gt;<i> the
</I>&gt;<i> &gt;      &gt;      &gt;     configuration
</I>&gt;<i> &gt;      &gt;      &gt;     sketches I shared previously will do that though.
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;     HTH,
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;     Alex.
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;      &gt; On Thu, Sep 28, 2023 at 1:02&#8239;PM Alex Rousskov wrote:
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;     On 2023-09-28 11:31, Fernando Giorgetti wrote:
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt; And what should I do to let Squid use the SNI
</I>&gt;<i> &gt;      &gt;     defined by
</I>&gt;<i> &gt;      &gt;      &gt;     the TLS
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;     client?
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;     What do you want Squid to use that SNI for?
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;     Alex.
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt; On Thu, Sep 28, 2023 at 11:51&#8239;AM Alex
</I>&gt;<i> &gt;     Rousskov wrote:
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;     On 2023-09-28 09:06, Fernando Giorgetti
</I>&gt;<i> &gt;     wrote:
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;      &gt; Hi Matus, do you mean something like
</I>&gt;<i> &gt;     a DNAT
</I>&gt;<i> &gt;      &gt;      &gt;     (iptables) rule?
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;      &gt; If so, I would say, it should work as
</I>&gt;<i> &gt;     well.
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;      &gt; But this is an environment I do not
</I>&gt;<i> &gt;     control,
</I>&gt;<i> &gt;      &gt;     and I have
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;     been told
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;     to try
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;      &gt; using an existing squid installation
</I>&gt;<i> &gt;     to proxy
</I>&gt;<i> &gt;      &gt;      &gt;     non-http/TLS
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;     data
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;     through.
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;      &gt; I appreciate any guidance or
</I>&gt;<i> &gt;     recommendation.
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;     Bugs notwithstanding, Squid can blindly
</I>&gt;<i> &gt;     tunnel
</I>&gt;<i> &gt;      &gt;     intercepted
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;     (at TCP port
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;     X) TCP traffic to its intended
</I>&gt;<i> destination:
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;           https_port X intercept ssl-bump ...
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;           ssl_bump splice all
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;     Without interception, then Squid can only
</I>&gt;<i> &gt;      &gt;     tunnel stuff
</I>&gt;<i> &gt;      &gt;      &gt;     inside
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;     HTTP
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;     CONNECT tunnels (for HTTP CONNECT
</I>&gt;<i> requests
</I>&gt;<i> &gt;      &gt;     received at TCP
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;     port Y):
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;           http_port Y ssl-bump ...
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;           ssl_bump splice all
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;     In both cases, Squid does not care about
</I>&gt;<i> the
</I>&gt;<i> &gt;      &gt;     protocols
</I>&gt;<i> &gt;      &gt;      &gt;     that
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;     tunneled
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;     traffic is using. It could be HTTP,
</I>&gt;<i> &gt;     HTTPS, TLS, or
</I>&gt;<i> &gt;      &gt;      &gt;     anything
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;     else on top
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;     of TCP.
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;     Your ACLs may differ from &quot;all&quot; in the
</I>&gt;<i> above
</I>&gt;<i> &gt;      &gt;     sketches,
</I>&gt;<i> &gt;      &gt;      &gt;     of course,
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;     but if
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;     traffic is not TLS, then you want an
</I>&gt;<i> &gt;     &quot;ssl_bump
</I>&gt;<i> &gt;      &gt;     splice&quot;
</I>&gt;<i> &gt;      &gt;      &gt;     rule that
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;     matches
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;     during SslBump step1. A rule with an
</I>&gt;<i> &gt;     &quot;all&quot; ACLs
</I>&gt;<i> &gt;      &gt;     is the
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;     simplest example
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;     of that.
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;     HTH,
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;     Alex.
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;     P.S. I am getting an &quot;Internal Server
</I>&gt;<i> &gt;     Error&quot; when
</I>&gt;<i> &gt;      &gt;      &gt;     following
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;     the haproxy
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;     link in the original question, so I
</I>&gt;<i> &gt;     cannot map what
</I>&gt;<i> &gt;      &gt;      &gt;     that page
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;     says to
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;     the configurations above.
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;      &gt; On Thu, Sep 28, 2023 at 3:41&#8239;AM Matus
</I>&gt;<i> &gt;     UHLAR -
</I>&gt;<i> &gt;      &gt;      &gt;     fantomas wrote:
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;      &gt;     On 27.09.23 16:48, Fernando
</I>&gt;<i> &gt;     Giorgetti wrote:
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;      &gt;      &gt;I would like to know if it is
</I>&gt;<i> &gt;     possible
</I>&gt;<i> &gt;      &gt;     to set up
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;     Squid to
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;     perform
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;      &gt;      &gt;TLS passthrough to a given
</I>&gt;<i> backend,
</I>&gt;<i> &gt;      &gt;     relaying TLS
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;     encrypted
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;      &gt;      &gt;traffic to the backend,
</I>&gt;<i> &gt;     similarly to
</I>&gt;<i> &gt;      &gt;     what HAProxy
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;     does below?
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> <A HREF="https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough">https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough</A>
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;      &gt;      &gt;I have tried a few different
</I>&gt;<i> &gt;      &gt;     configurations using
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;     reverse
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;     proxy,
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;      &gt;      &gt;or peek and splice, but I could
</I>&gt;<i> not
</I>&gt;<i> &gt;      &gt;     make it
</I>&gt;<i> &gt;      &gt;      &gt;     work without
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;     providing
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;      &gt;      &gt;a valid HTTP request or a
</I>&gt;<i> &gt;     CONNECT request.
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;      &gt;     what's the difference between TCP
</I>&gt;<i> &gt;      &gt;     redirect and
</I>&gt;<i> &gt;      &gt;      &gt;     this?
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;      &gt;     --
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;      &gt;     Depression is merely anger without
</I>&gt;<i> &gt;      &gt;     enthusiasm.
</I>&gt;<i>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20230929/a992f2c0/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20230929/a992f2c0/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="026160.html">[squid-users] TLS passthrough
</A></li>
	<LI>Next message (by thread): <A HREF="026162.html">[squid-users] TLS passthrough
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26161">[ date ]</a>
              <a href="thread.html#26161">[ thread ]</a>
              <a href="subject.html#26161">[ subject ]</a>
              <a href="author.html#26161">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
