<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] TLS passthrough
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20TLS%20passthrough&In-Reply-To=%3CCADxZ%3DiVv0FLTTKNng0fQ961SU7UeOUrdHbk9-P1ixDeEUX-%3DmA%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="026162.html">
   <LINK REL="Next"  HREF="026166.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] TLS passthrough</H1>
    <B>Fernando Giorgetti</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20TLS%20passthrough&In-Reply-To=%3CCADxZ%3DiVv0FLTTKNng0fQ961SU7UeOUrdHbk9-P1ixDeEUX-%3DmA%40mail.gmail.com%3E"
       TITLE="[squid-users] TLS passthrough">fgiorgetti at gmail.com
       </A><BR>
    <I>Fri Sep 29 22:06:56 UTC 2023</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="026162.html">[squid-users] TLS passthrough
</A></li>
        <LI>Next message (by thread): <A HREF="026166.html">[squid-users] TLS passthrough
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26163">[ date ]</a>
              <a href="thread.html#26163">[ thread ]</a>
              <a href="subject.html#26163">[ subject ]</a>
              <a href="author.html#26163">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>If someone has already done that, with the client running in a different
machine, I would love to know how.

In case Squid runs on the same machine used as a network gateway to the
client machine, I suppose the config would be similar, but if it's not
running on the same machine used as the gateway, then it would be nice to
see how.

Thanks

Em sex., 29 de set. de 2023 18:13, Alex Rousskov &lt;
<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt; escreveu:

&gt;<i> On 2023-09-29 13:55, Fernando Giorgetti wrote:
</I>&gt;<i>
</I>&gt;<i> &gt; The &quot;intercept&quot; scenario demonstrated here
</I>&gt;<i> &gt; <A HREF="https://wiki.squid-cache.org/ConfigExamples/Intercept/AtSource">https://wiki.squid-cache.org/ConfigExamples/Intercept/AtSource</A>
</I>&gt;<i> &gt; makes sense to me, as we are just redirecting internal traffic into
</I>&gt;<i> Squid,
</I>&gt;<i> &gt; so the original destination IP is preserved.
</I>&gt;<i>
</I>&gt;<i> &gt; I was able to make it work and that TLS app worked just fine. The
</I>&gt;<i> &gt; only constraint is that it requires that both the client and Squid
</I>&gt;<i> &gt; ran on the same machine, but at least it worked perfectly.
</I>&gt;<i>
</I>&gt;<i> I am very glad you are making progress. FWIW, there are also ways to
</I>&gt;<i> intercept traffic from applications that do not run on the same machine
</I>&gt;<i> as Squid. This is not my area of expertise, but others on the list can
</I>&gt;<i> guide you if you need that kind of setup.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; Here is my squid.conf (just in case someone eventually has a similar
</I>&gt;<i> &gt; issue):
</I>&gt;<i>
</I>&gt;<i> Thank you!
</I>&gt;<i>
</I>&gt;<i> Alex.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; acl CONNECT method CONNECT
</I>&gt;<i> &gt; acl mytlsserverip dst 10.0.0.10
</I>&gt;<i> &gt; http_access allow CONNECT mytlsserverip
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; http_port 3128
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; https_port 127.0.0.1:3129 intercept ssl-bump \
</I>&gt;<i> &gt;    tls-cert=/tmp/certs/squid.pem \
</I>&gt;<i> &gt;    tls-key=/tmp/certs/squid.key \
</I>&gt;<i> &gt;    generate-host-certificates=off
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; ssl_bump splice all
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; And here are the firewall rules I have used:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; iptables -t nat -I OUTPUT -p tcp -d 10.0.0.10 --dport 55671 -j DNAT
</I>&gt;<i> &gt; --to-destination 127.0.0.1:3129 &lt;<A HREF="http://127.0.0.1:3129">http://127.0.0.1:3129</A>&gt;
</I>&gt;<i> &gt; iptables -t nat -I OUTPUT --match owner --uid-owner squid  -p tcp -d
</I>&gt;<i> &gt; 10.0.0.10 --dport 55671 -j ACCEPT
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I appreciate all the guidance and discussion Matus and Alex.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Thank you,
</I>&gt;<i> &gt; Fernando
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; On Fri, Sep 29, 2023 at 12:53&#8239;PM Alex Rousskov
</I>&gt;<i> &gt; &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>
</I>&gt;<i> &gt; &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt;&gt; wrote:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     On 2023-09-29 10:55, Fernando Giorgetti wrote:
</I>&gt;<i> &gt;      &gt;     Do you control the client application? If yes, then perhaps
</I>&gt;<i> &gt;     it can be
</I>&gt;<i> &gt;      &gt;     adjusted to support HTTP proxies? In other words, the client
</I>&gt;<i> &gt;     will send a
</I>&gt;<i> &gt;      &gt;     plain text HTTP CONNECT request to Squid and, upon receiving
</I>&gt;<i> &gt;     a 200
</I>&gt;<i> &gt;      &gt;     (Connection Established) response headers, will start using
</I>&gt;<i> &gt;     TLS with the
</I>&gt;<i> &gt;      &gt;     origin server. In this case, you do not need interception.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;      &gt; Nope, the client application is also used to communicate with
</I>&gt;<i> &gt;     other apps in
</I>&gt;<i> &gt;      &gt; other environments.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     FWIW, &quot;used with other apps&quot; does not imply or explain the &quot;nope, we
</I>&gt;<i> do
</I>&gt;<i> &gt;     not control the application&quot; answer IMHO.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;      &gt; The SNI has to be used as the client/server apps perform
</I>&gt;<i> &gt;      &gt; mutual TLS authentication.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     To avoid a misunderstanding, nothing I have said precludes the use of
</I>&gt;<i> &gt;     TLS SNI by the client application. Thus, I am not sure why you are
</I>&gt;<i> &gt;     saying the above.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;      &gt; In order to evaluate if we can use Squid for this purpose, I have
</I>&gt;<i> &gt;      &gt; also created a basic TLS client/server app to validate what is
</I>&gt;<i> &gt;      &gt; happening. Basically my TLS client tries to connect directly to
</I>&gt;<i> Squid
</I>&gt;<i> &gt;      &gt; IP/Port and I am indicating the SNI so that the TLS handshake
</I>&gt;<i> &gt;      &gt; passes.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     FWIW, a scenario where the client application establishes a TLS
</I>&gt;<i> &gt;     connection with Squid https_port (configured as a reverse HTTPS
</I>&gt;<i> proxy)
</I>&gt;<i> &gt;     will not work for your use case AFAICT. I am not sure why you are
</I>&gt;<i> &gt;     testing this. It has not been suggested on this mailing list.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     BTW, you can use (&quot;curl&quot; or even &quot;openssl s_client&quot;) and &quot;openssl
</I>&gt;<i> &gt;     s_server&quot; for basic tests. I recommend using well-known test programs
</I>&gt;<i> &gt;     (instead of custom apps) because doing so makes it easier for mailing
</I>&gt;<i> &gt;     list readers to understand what your test clients and servers are
</I>&gt;<i> doing
</I>&gt;<i> &gt;     (and to reproduce your setup).
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;      &gt; When I tried to make it work using a forward proxy with intercept
</I>&gt;<i> and
</I>&gt;<i> &gt;      &gt; ssl_bump, I could not make Squid peek at the SNI and tunnel the
</I>&gt;<i> &gt;      &gt; request to the correct destination.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     Please note that &quot;forward proxy with intercept&quot; is an oxymoron -- the
</I>&gt;<i> &gt;     two port modes (i.e. explicit &quot;intercept&quot; and default forward
</I>&gt;<i> proxying)
</I>&gt;<i> &gt;     are mutually exclusive.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     If you do not want to or cannot modify/configure the client
</I>&gt;<i> application
</I>&gt;<i> &gt;     to use Squid as a forward HTTP proxy (as I detailed earlier; see the
</I>&gt;<i> &gt;     paragraph still quoted at the beginning of this message), then your
</I>&gt;<i> &gt;     other choice is interception (as I detailed earlier; see the &quot;Squid
</I>&gt;<i> &gt;     supports blind tunneling of intercepted TCP connections&quot; discussion
</I>&gt;<i> in
</I>&gt;<i> &gt;     the previous exchange).
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     When Squid https_port gets an intercepted client TCP connection,
</I>&gt;<i> Squid
</I>&gt;<i> &gt;     does not need SNI to know where to forward that TCP connection. Squid
</I>&gt;<i> &gt;     opens a TCP connection to the IP address where the client TCP
</I>&gt;<i> &gt;     connection
</I>&gt;<i> &gt;     was going (or trying to go) before it was intercepted. That intended
</I>&gt;<i> &gt;     destination IP address is delivered to Squid by the OS, as a part of
</I>&gt;<i> &gt;     interception mechanism/setup. TLS and SNI are not involved in this
</I>&gt;<i> &gt;     process.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     If you have not tested an interception scenario, please do. If you
</I>&gt;<i> &gt;     have,
</I>&gt;<i> &gt;     please share your interception configuration, Squid configuration,
</I>&gt;<i> and
</I>&gt;<i> &gt;     any relevant error/problem information.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     HTH,
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;     Alex.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;      &gt; On Fri, Sep 29, 2023 at 11:35&#8239;AM Alex Rousskov wrote:
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt;     On 2023-09-29 09:17, Fernando Giorgetti wrote:
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt; Actually I am evaluating if Squid can be used to proxy
</I>&gt;<i> &gt;     Non-HTTP/TLS
</I>&gt;<i> &gt;      &gt;      &gt; data, as we have a restricted environment where Squid is
</I>&gt;<i> &gt;      &gt;     currently the
</I>&gt;<i> &gt;      &gt;      &gt; only way to get out to the internet.
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt;     Yes, Squid can tunnel non-HTTP data, including TLS data.
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt; The idea is that the client application will open a
</I>&gt;<i> &gt;     connection to
</I>&gt;<i> &gt;      &gt;     a given
</I>&gt;<i> &gt;      &gt;      &gt; hostname and port (setting the SNI in the TLS options),
</I>&gt;<i> &gt;      &gt;     considering that
</I>&gt;<i> &gt;      &gt;      &gt; the given hostname/port is the actual backend they're
</I>&gt;<i> &gt;     trying to
</I>&gt;<i> &gt;      &gt;     reach.
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt;     Do you control the client application? If yes, then perhaps
</I>&gt;<i> &gt;     it can be
</I>&gt;<i> &gt;      &gt;     adjusted to support HTTP proxies? In other words, the client
</I>&gt;<i> will
</I>&gt;<i> &gt;      &gt;     send a
</I>&gt;<i> &gt;      &gt;     plain text HTTP CONNECT request to Squid and, upon receiving
</I>&gt;<i> &gt;     a 200
</I>&gt;<i> &gt;      &gt;     (Connection Established) response headers, will start using
</I>&gt;<i> &gt;     TLS with
</I>&gt;<i> &gt;      &gt;     the
</I>&gt;<i> &gt;      &gt;     origin server. In this case, you do not need interception.
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt; We can either try to use a fake hostname (defined in the
</I>&gt;<i> &gt;      &gt;     /etc/hosts of the
</I>&gt;<i> &gt;      &gt;      &gt; tls client machine) which would actually point to Squid's
</I>&gt;<i> IP
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt;     AFAICT, faking the IP address will not work without Squid
</I>&gt;<i> &gt;     source code
</I>&gt;<i> &gt;      &gt;     modifications because a non-intercepting Squid https_port
</I>&gt;<i> &gt;     will want to
</I>&gt;<i> &gt;      &gt;     terminate TLS -- such a port does not support blindly
</I>&gt;<i> &gt;     tunneling traffic.
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt; or eventually
</I>&gt;<i> &gt;      &gt;      &gt; redirect traffic to the real destination into Squid using
</I>&gt;<i> &gt;     a DNAT
</I>&gt;<i> &gt;      &gt;     rule.
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt;     I am not a DNAT expert, but this sounds like interception to
</I>&gt;<i> &gt;     me. Bugs
</I>&gt;<i> &gt;      &gt;     notwithstanding, Squid supports blind tunneling of
</I>&gt;<i> &gt;     intercepted TCP
</I>&gt;<i> &gt;      &gt;     connections (to their intended destination):
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt;           https_port X intercept ssl-bump ...
</I>&gt;<i> &gt;      &gt;           ssl_bump splice all
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt;     On a successful tunneling path, the above configuration does
</I>&gt;<i> &gt;     not care
</I>&gt;<i> &gt;      &gt;     whether the intercepted traffic is TLS and will not peek at
</I>&gt;<i> &gt;     TLS SNI,
</I>&gt;<i> &gt;      &gt;     but
</I>&gt;<i> &gt;      &gt;     nothing in your requirements necessitates SNI knowledge
</I>&gt;<i> AFAICT.
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt;     If Squid fails to establish a TCP connection to the intended
</I>&gt;<i> &gt;      &gt;     destination
</I>&gt;<i> &gt;      &gt;     of the intercepted connection, then the situation becomes
</I>&gt;<i> &gt;     more complex:
</I>&gt;<i> &gt;      &gt;     Squid (with the above configuration) assumes that the client
</I>&gt;<i> is
</I>&gt;<i> &gt;      &gt;     speaking
</I>&gt;<i> &gt;      &gt;     TLS. Squid will attempt to bump the TLS client connection and
</I>&gt;<i> &gt;     send a
</I>&gt;<i> &gt;      &gt;     Squid-generated HTTP error response to the client. AFAIK,
</I>&gt;<i> &gt;     this bumping
</I>&gt;<i> &gt;      &gt;     and error sending attempt cannot be prevented in this case
</I>&gt;<i> &gt;     without
</I>&gt;<i> &gt;      &gt;     Squid
</I>&gt;<i> &gt;      &gt;     source code modifications: Squid used to be able to terminate
</I>&gt;<i> a
</I>&gt;<i> &gt;      &gt;     client-Squid connection instead of sending a Squid-generated
</I>&gt;<i> &gt;     HTTP error
</I>&gt;<i> &gt;      &gt;     response (by replacing the corresponding Squid error page
</I>&gt;<i> &gt;     contents with
</I>&gt;<i> &gt;      &gt;     a word &quot;reset&quot;). However, that feature was accidentally(?)
</I>&gt;<i> &gt;     dropped in
</I>&gt;<i> &gt;      &gt;     2002 commit 76cdc28 AFAICT.
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt;     HTH,
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt;     Alex.
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt; But overall, it will be a 1:1 relationship, meaning, the
</I>&gt;<i> &gt;      &gt;     https_port on Squid
</I>&gt;<i> &gt;      &gt;      &gt; would be used exclusively to this purpose of proxying from
</I>&gt;<i> a
</I>&gt;<i> &gt;      &gt;     given source
</I>&gt;<i> &gt;      &gt;      &gt; to a given destination.
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt; That is why I was considering a reverse-proxy, but I had
</I>&gt;<i> &gt;     no luck
</I>&gt;<i> &gt;      &gt;     with it
</I>&gt;<i> &gt;      &gt;      &gt; (actually
</I>&gt;<i> &gt;      &gt;      &gt; I was able to proxy HTTP/HTTPS, but not non-http).
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt; Thank you again,
</I>&gt;<i> &gt;      &gt;      &gt; Fernando
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt; On Thu, Sep 28, 2023 at 11:39&#8239;PM Alex Rousskov
</I>&gt;<i> &gt;      &gt;      &gt; &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>
</I>&gt;<i> &gt;     &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt;
</I>&gt;<i> &gt;      &gt;     &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>
</I>&gt;<i> &gt;     &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt;&gt;
</I>&gt;<i> &gt;      &gt;      &gt; &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>
</I>&gt;<i> &gt;     &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt;
</I>&gt;<i> &gt;      &gt;     &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>
</I>&gt;<i> &gt;     &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt;&gt;&gt;&gt; wrote:
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;     On 2023-09-28 20:35, Fernando Giorgetti wrote:
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;      &gt; Do you have any recommendations on how I could have
</I>&gt;<i> &gt;     it done?
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;     I am unable to confirm whether Squid can do what you
</I>&gt;<i> &gt;     want or
</I>&gt;<i> &gt;      &gt;     provide
</I>&gt;<i> &gt;      &gt;      &gt;     configuration recommendations because I do not yet
</I>&gt;<i> &gt;     know how
</I>&gt;<i> &gt;      &gt;     your Squid
</I>&gt;<i> &gt;      &gt;      &gt;     will receive traffic (e.g., an intercepting proxy or
</I>&gt;<i> &gt;     an explicit
</I>&gt;<i> &gt;      &gt;      &gt;     forward
</I>&gt;<i> &gt;      &gt;      &gt;     HTTP proxy), what traffic Squid will receive (e.g.,
</I>&gt;<i> TLS,
</I>&gt;<i> &gt;      &gt;     plain HTTP,
</I>&gt;<i> &gt;      &gt;      &gt;     something else), and what you want Squid to do with
</I>&gt;<i> &gt;     that traffic.
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;     To make progress, I recommend describing the above
</I>&gt;<i> details
</I>&gt;<i> &gt;      &gt;     (for one
</I>&gt;<i> &gt;      &gt;      &gt;     typical use case?) and then answering any followup
</I>&gt;<i> &gt;     questions.
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;     Cheers,
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;     Alex.
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;      &gt; When my tls client tries to reach the target
</I>&gt;<i> &gt;      &gt;     through Squid, using
</I>&gt;<i> &gt;      &gt;      &gt;      &gt; a &quot;ssl_bump splice&quot;, it seems like squid is trying
</I>&gt;<i> &gt;     to reach
</I>&gt;<i> &gt;      &gt;      &gt;     itself in a
</I>&gt;<i> &gt;      &gt;      &gt;      &gt; loop.
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;      &gt; I have also tried including a peek first, but no
</I>&gt;<i> luck.
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;      &gt; Thanks again for all suggestions.
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;      &gt; On Thu, Sep 28, 2023 at 7:23&#8239;PM Alex Rousskov wrote:
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;     On 2023-09-28 15:23, Fernando Giorgetti wrote:
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt; Actually with the suggested blind
</I>&gt;<i> passthrough,
</I>&gt;<i> &gt;      &gt;     Squid would not
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;     handle
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt; the TLS termination.
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;     Correct.
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt; how will Squid know what the target is?
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;     In many cases, Squid can learn SNI by peeking
</I>&gt;<i> &gt;     at TLS
</I>&gt;<i> &gt;      &gt;     ClientHello,
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;     without terminating TLS. Bugs notwithstanding,
</I>&gt;<i> &gt;     none of the
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;     configuration
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;     sketches I shared previously will do that
</I>&gt;<i> though.
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;     HTH,
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;     Alex.
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt; On Thu, Sep 28, 2023 at 1:02&#8239;PM Alex
</I>&gt;<i> &gt;     Rousskov wrote:
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;     On 2023-09-28 11:31, Fernando Giorgetti
</I>&gt;<i> &gt;     wrote:
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;      &gt; And what should I do to let Squid use
</I>&gt;<i> &gt;     the SNI
</I>&gt;<i> &gt;      &gt;      &gt;     defined by
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;     the TLS
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;     client?
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;     What do you want Squid to use that SNI
</I>&gt;<i> for?
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;     Alex.
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;      &gt; On Thu, Sep 28, 2023 at 11:51&#8239;AM Alex
</I>&gt;<i> &gt;      &gt;     Rousskov wrote:
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;      &gt;     On 2023-09-28 09:06, Fernando
</I>&gt;<i> &gt;     Giorgetti
</I>&gt;<i> &gt;      &gt;     wrote:
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;      &gt;      &gt; Hi Matus, do you mean
</I>&gt;<i> &gt;     something like
</I>&gt;<i> &gt;      &gt;     a DNAT
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;     (iptables) rule?
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;      &gt;      &gt; If so, I would say, it should
</I>&gt;<i> &gt;     work as
</I>&gt;<i> &gt;      &gt;     well.
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;      &gt;      &gt; But this is an environment I
</I>&gt;<i> &gt;     do not
</I>&gt;<i> &gt;      &gt;     control,
</I>&gt;<i> &gt;      &gt;      &gt;     and I have
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;     been told
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;      &gt;     to try
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;      &gt;      &gt; using an existing squid
</I>&gt;<i> &gt;     installation
</I>&gt;<i> &gt;      &gt;     to proxy
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;     non-http/TLS
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;     data
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;      &gt;     through.
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;      &gt;      &gt; I appreciate any guidance or
</I>&gt;<i> &gt;      &gt;     recommendation.
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;      &gt;     Bugs notwithstanding, Squid can
</I>&gt;<i> &gt;     blindly
</I>&gt;<i> &gt;      &gt;     tunnel
</I>&gt;<i> &gt;      &gt;      &gt;     intercepted
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;     (at TCP port
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;      &gt;     X) TCP traffic to its intended
</I>&gt;<i> &gt;     destination:
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;      &gt;           https_port X intercept
</I>&gt;<i> &gt;     ssl-bump ...
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;      &gt;           ssl_bump splice all
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;      &gt;     Without interception, then Squid
</I>&gt;<i> &gt;     can only
</I>&gt;<i> &gt;      &gt;      &gt;     tunnel stuff
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;     inside
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;     HTTP
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;      &gt;     CONNECT tunnels (for HTTP CONNECT
</I>&gt;<i> &gt;     requests
</I>&gt;<i> &gt;      &gt;      &gt;     received at TCP
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;     port Y):
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;      &gt;           http_port Y ssl-bump ...
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;      &gt;           ssl_bump splice all
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;      &gt;     In both cases, Squid does not
</I>&gt;<i> &gt;     care about the
</I>&gt;<i> &gt;      &gt;      &gt;     protocols
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;     that
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;     tunneled
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;      &gt;     traffic is using. It could be
</I>&gt;<i> HTTP,
</I>&gt;<i> &gt;      &gt;     HTTPS, TLS, or
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;     anything
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;     else on top
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;      &gt;     of TCP.
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;      &gt;     Your ACLs may differ from &quot;all&quot;
</I>&gt;<i> &gt;     in the above
</I>&gt;<i> &gt;      &gt;      &gt;     sketches,
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;     of course,
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;      &gt;     but if
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;      &gt;     traffic is not TLS, then you want
</I>&gt;<i> an
</I>&gt;<i> &gt;      &gt;     &quot;ssl_bump
</I>&gt;<i> &gt;      &gt;      &gt;     splice&quot;
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;     rule that
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;      &gt;     matches
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;      &gt;     during SslBump step1. A rule with
</I>&gt;<i> an
</I>&gt;<i> &gt;      &gt;     &quot;all&quot; ACLs
</I>&gt;<i> &gt;      &gt;      &gt;     is the
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;     simplest example
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;      &gt;     of that.
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;      &gt;     HTH,
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;      &gt;     Alex.
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;      &gt;     P.S. I am getting an &quot;Internal
</I>&gt;<i> Server
</I>&gt;<i> &gt;      &gt;     Error&quot; when
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;     following
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;     the haproxy
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;      &gt;     link in the original question, so
</I>&gt;<i> I
</I>&gt;<i> &gt;      &gt;     cannot map what
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;     that page
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;     says to
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;      &gt;     the configurations above.
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;      &gt;      &gt; On Thu, Sep 28, 2023 at
</I>&gt;<i> &gt;     3:41&#8239;AM Matus
</I>&gt;<i> &gt;      &gt;     UHLAR -
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;     fantomas wrote:
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;      &gt;      &gt;     On 27.09.23 16:48, Fernando
</I>&gt;<i> &gt;      &gt;     Giorgetti wrote:
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;      &gt;      &gt;      &gt;I would like to know if
</I>&gt;<i> &gt;     it is
</I>&gt;<i> &gt;      &gt;     possible
</I>&gt;<i> &gt;      &gt;      &gt;     to set up
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;     Squid to
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;      &gt;     perform
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;      &gt;      &gt;      &gt;TLS passthrough to a
</I>&gt;<i> &gt;     given backend,
</I>&gt;<i> &gt;      &gt;      &gt;     relaying TLS
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;     encrypted
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;      &gt;      &gt;      &gt;traffic to the backend,
</I>&gt;<i> &gt;      &gt;     similarly to
</I>&gt;<i> &gt;      &gt;      &gt;     what HAProxy
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;     does below?
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;      &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> &gt;      &gt;
</I>&gt;<i> <A HREF="https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough">https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough</A>
</I>&gt;<i> &lt;
</I>&gt;<i> <A HREF="https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough">https://www.haproxy.com/documentation/aloha/latest/security/tls/encryption-strategies/#tls-passthrough</A>
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;      &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;      &gt;      &gt;      &gt;I have tried a few
</I>&gt;<i> different
</I>&gt;<i> &gt;      &gt;      &gt;     configurations using
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;     reverse
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;      &gt;     proxy,
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;      &gt;      &gt;      &gt;or peek and splice, but
</I>&gt;<i> &gt;     I could not
</I>&gt;<i> &gt;      &gt;      &gt;     make it
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;     work without
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;      &gt;     providing
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;      &gt;      &gt;      &gt;a valid HTTP request or a
</I>&gt;<i> &gt;      &gt;     CONNECT request.
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;      &gt;      &gt;     what's the difference
</I>&gt;<i> &gt;     between TCP
</I>&gt;<i> &gt;      &gt;      &gt;     redirect and
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;     this?
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;      &gt;      &gt;
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;      &gt;      &gt;     --
</I>&gt;<i> &gt;      &gt;      &gt;      &gt;      &gt;      &gt;      &gt;     Depression is merely anger
</I>&gt;<i> &gt;     without
</I>&gt;<i> &gt;      &gt;      &gt;     enthusiasm.
</I>&gt;<i> &gt;
</I>&gt;<i>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20230929/76b35cff/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20230929/76b35cff/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="026162.html">[squid-users] TLS passthrough
</A></li>
	<LI>Next message (by thread): <A HREF="026166.html">[squid-users] TLS passthrough
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26163">[ date ]</a>
              <a href="thread.html#26163">[ thread ]</a>
              <a href="subject.html#26163">[ subject ]</a>
              <a href="author.html#26163">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
