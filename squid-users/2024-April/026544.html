<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Chrome auto-HTTPS-upgrade - not falling to http
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Chrome%20auto-HTTPS-upgrade%20-%20not%20falling%20to%20http&In-Reply-To=%3C82ae59b8-c835-4715-a836-418e8d44d33f%40kjj.cz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="026549.html">
   <LINK REL="Next"  HREF="026545.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Chrome auto-HTTPS-upgrade - not falling to http</H1>
    <B>Lou&#269;ansk&#253; Luk&#225;&#353;</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Chrome%20auto-HTTPS-upgrade%20-%20not%20falling%20to%20http&In-Reply-To=%3C82ae59b8-c835-4715-a836-418e8d44d33f%40kjj.cz%3E"
       TITLE="[squid-users] Chrome auto-HTTPS-upgrade - not falling to http">technik at kjj.cz
       </A><BR>
    <I>Wed Apr  3 06:14:42 UTC 2024</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="026549.html">[squid-users] BWS after chunk-size
</A></li>
        <LI>Next message (by thread): <A HREF="026545.html">[squid-users] Chrome auto-HTTPS-upgrade - not falling to http
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26544">[ date ]</a>
              <a href="thread.html#26544">[ thread ]</a>
              <a href="subject.html#26544">[ subject ]</a>
              <a href="author.html#26544">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello,

this has recently started me up more then let it go. For a while chrome 
is upgrading in-page links to https. It is supposed to work something 
like 
<A HREF="https://www.bleepingcomputer.com/news/google/google-chrome-now-auto-upgrades-to-secure-connections-for-all-users/">https://www.bleepingcomputer.com/news/google/google-chrome-now-auto-upgrades-to-secure-connections-for-all-users/</A>

But there is a catch for me - my squid returns something like:

(104) Connection reset by peer (TLS code: 
SQUID_TLS_ERR_CONNECT+TLS_IO_ERR=5+errno=104)
Failed to establish a secure connection: [No Error]

or

[No Error] (TLS code: 
SQUID_TLS_ERR_CONNECT+TLS_LIB_ERR=1408F10B+TLS_IO_ERR=1)
Failed to establish a secure connection: error:1408F10B:SSL 
routines:ssl3_get_record:wrong version number

to the user - via error page

Log file:

1712122364.809&#160;&#160; 1172 10.0.0.1 NONE_NONE_ABORTED/000 0 CONNECT 
46.255.231.158:443 - HIER_NONE/- - SNI redir.netcentrum.cz BumpMode peek 
- - - ServerNegoTLS - ServerRecTLS - ServerRecVer - ServerNegCiph - 
Error: ERR_SECURE_CONNECT_FAIL | 
SQUID_TLS_ERR_CONNECT+TLS_IO_ERR=5+errno=104
1712122366.296&#160;&#160;&#160;&#160; 23 10.0.0.1 NONE_NONE_ABORTED/000 0 CONNECT 
46.255.231.158:443 - HIER_NONE/- - SNI redir.netcentrum.cz BumpMode peek 
- - - ServerNegoTLS - ServerRecTLS - ServerRecVer - ServerNegCiph - 
Error: ERR_SECURE_CONNECT_FAIL | 
SQUID_TLS_ERR_CONNECT+TLS_IO_ERR=5+errno=104
1712122366.293&#160;&#160;&#160;&#160; 21 10.0.0.1 NONE_NONE_ABORTED/000 0 CONNECT 
46.255.231.158:443 - HIER_NONE/- - SNI redir.netcentrum.cz BumpMode peek 
- - - ServerNegoTLS - ServerRecTLS - ServerRecVer - ServerNegCiph - 
Error: ERR_SECURE_CONNECT_FAIL | 
SQUID_TLS_ERR_CONNECT+TLS_IO_ERR=5+errno=104
1712122367.111&#160;&#160;&#160;&#160; 20 10.0.0.1 NONE_NONE_ABORTED/000 0 CONNECT 
46.255.231.158:443 - HIER_NONE/- - SNI redir.netcentrum.cz BumpMode peek 
- - - ServerNegoTLS - ServerRecTLS - ServerRecVer - ServerNegCiph - 
Error: ERR_SECURE_CONNECT_FAIL | 
SQUID_TLS_ERR_CONNECT+TLS_IO_ERR=5+errno=104
1712122367.114&#160;&#160;&#160;&#160; 21 10.0.0.1 NONE_NONE_ABORTED/000 0 CONNECT 
46.255.231.158:443 - HIER_NONE/- - SNI redir.netcentrum.cz BumpMode peek 
- - - ServerNegoTLS - ServerRecTLS - ServerRecVer - ServerNegCiph - 
Error: ERR_SECURE_CONNECT_FAIL | 
SQUID_TLS_ERR_CONNECT+TLS_IO_ERR=5+errno=104

In fact - this seems to be http only sites like - 
<A HREF="https://www.ssllabs.com/ssltest/analyze.html?d=www.jarovnet.org">https://www.ssllabs.com/ssltest/analyze.html?d=www.jarovnet.org</A> or 
<A HREF="https://www.ssllabs.com/ssltest/analyze.html?d=redir.netcentrum.cz&amp;s=46.255.231.158&amp;latest.">https://www.ssllabs.com/ssltest/analyze.html?d=redir.netcentrum.cz&amp;s=46.255.231.158&amp;latest.</A> 
See this snapshot from centrum web mail page source code &quot;V&#237;ce informac&#237; 
o tomto zapezpe&#269;en&#237; naleznete v &lt;a 
href=&quot;<A HREF="http://napoveda.centrum.cz/index.php?/Knowledgebase/Article/View/18/1/">http://napoveda.centrum.cz/index.php?/Knowledgebase/Article/View/18/1/</A>&quot; 
&quot;

So - what is supposed to be happening is chrome should fallback to http 
if there is a problem with https - i think the most obvious reason to 
fall back would be no output at all. So I think my effort should target 
the situation when squid says&#160; ERR_SECURE_CONNECT_FAIL | 
SQUID_TLS_ERR_CONNECT+TLS_IO_ERR=5+errno=104 and to remain silent to the 
client.

Is there a way to do it - ie. do not show error page for not able to 
connect to server at all? I'd like every other problems (ie. 
bad/selfsigned/not matched certificate etc.) pushed to the client's 
eyes. I have implemented 
<A HREF="https://www.squid-cache.org/Doc/config/on_unsupported_protocol/">https://www.squid-cache.org/Doc/config/on_unsupported_protocol/</A> like in 
the example - but it is for an accepted TCP connections. I'd like to 
handle SSL errors - such as not being able to connect at all. - could it 
be done with <A HREF="https://www.squid-cache.org/Doc/config/sslproxy_cert_error/?">https://www.squid-cache.org/Doc/config/sslproxy_cert_error/?</A>

LL

-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20240403/5b47ea4a/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20240403/5b47ea4a/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="026549.html">[squid-users] BWS after chunk-size
</A></li>
	<LI>Next message (by thread): <A HREF="026545.html">[squid-users] Chrome auto-HTTPS-upgrade - not falling to http
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26544">[ date ]</a>
              <a href="thread.html#26544">[ thread ]</a>
              <a href="subject.html#26544">[ subject ]</a>
              <a href="author.html#26544">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
