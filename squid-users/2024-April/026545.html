<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Chrome auto-HTTPS-upgrade - not falling to http
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Chrome%20auto-HTTPS-upgrade%20-%20not%20falling%20to%20http&In-Reply-To=%3Ce774283f-ad56-4872-a402-78a75c207a26%40kjj.cz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="026544.html">
   <LINK REL="Next"  HREF="026547.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Chrome auto-HTTPS-upgrade - not falling to http</H1>
    <B>Lou&#269;ansk&#253; Luk&#225;&#353;</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Chrome%20auto-HTTPS-upgrade%20-%20not%20falling%20to%20http&In-Reply-To=%3Ce774283f-ad56-4872-a402-78a75c207a26%40kjj.cz%3E"
       TITLE="[squid-users] Chrome auto-HTTPS-upgrade - not falling to http">technik at kjj.cz
       </A><BR>
    <I>Wed Apr  3 07:59:03 UTC 2024</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="026544.html">[squid-users] Chrome auto-HTTPS-upgrade - not falling to http
</A></li>
        <LI>Next message (by thread): <A HREF="026547.html">[squid-users] Chrome auto-HTTPS-upgrade - not falling to http
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26545">[ date ]</a>
              <a href="thread.html#26545">[ thread ]</a>
              <a href="subject.html#26545">[ subject ]</a>
              <a href="author.html#26545">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>My effort so far:


acl SquidTLSErrorConnect ssl_error SQUID_TLS_ERR_CONNECT

##############################
#unsupported protocol definice
##############################
# define what Squid errors indicate receiving non-HTTP traffic:
acl foreignProtocol squid_error ERR_PROTOCOL_UNKNOWN ERR_TOO_BIG

# define what Squid errors indicate receiving nothing:
acl serverTalksFirstProtocol squid_error ERR_REQUEST_START_TIMEOUT

acl SquidSecureConnectFail squid_error ERR_SECURE_CONNECT_FAIL

# tunnel everything that does not look like HTTP:
on_unsupported_protocol tunnel foreignProtocol

# tunnel if we think the client waits for the server to talk first:
on_unsupported_protocol tunnel serverTalksFirstProtocol

#tunnel all for connection errors
on_unsupported_protocol tunnel SquidTLSErrorConnect
on_unsupported_protocol tunnel SquidSecureConnectFail


# in all other error cases, just send an HTTP &quot;error page&quot; response:
on_unsupported_protocol respond all

This is how it changed the behaviour (checked only with 
redir.netcentrum.cz so far)


1712126917.823&#160;&#160;&#160;&#160;&#160; 0 10.0.0.1 NONE_NONE/503 13605 GET 
<A HREF="https://redir.netcentrum.cz/favicon.ico">https://redir.netcentrum.cz/favicon.ico</A> - HIER_NONE/- text/html 
redir.netcentrum.cz
1712126918.842&#160;&#160;&#160;&#160; 23 10.0.0.1 NONE_NONE_ABORTED/000 0 CONNECT 
46.255.231.158:443 - HIER_NONE/- - redir.netcentrum.cz
1712126918.881&#160;&#160;&#160;&#160;&#160; 0 10.0.0.1 NONE_NONE/503 13605 GET 
<A HREF="https://redir.netcentrum.cz/favicon.ico">https://redir.netcentrum.cz/favicon.ico</A> - HIER_NONE/- text/html 
redir.netcentrum.cz
1712126919.116&#160;&#160;&#160;&#160; 21 10.0.0.1 NONE_NONE_ABORTED/000 0 CONNECT 
46.255.231.158:443 - HIER_NONE/- - redir.netcentrum.cz
1712126919.156&#160;&#160;&#160;&#160;&#160; 0 10.0.0.1 NONE_NONE/503 13605 GET 
<A HREF="https://redir.netcentrum.cz/favicon.ico">https://redir.netcentrum.cz/favicon.ico</A> - HIER_NONE/- text/html 
redir.netcentrum.cz
1712126918.839&#160;&#160;&#160;&#160; 19 10.0.0.1 NONE_NONE_ABORTED/000 0 CONNECT 
46.255.231.158:443 - HIER_NONE/- - redir.netcentrum.cz
1712126918.845&#160;&#160;&#160;&#160;&#160; 0 10.0.0.1 NONE_NONE/503 13605 GET 
<A HREF="https://redir.netcentrum.cz/?">https://redir.netcentrum.cz/?</A> - HIER_NONE/- text/html redir.netcentrum.cz
1712126919.113&#160;&#160;&#160;&#160; 19 10.0.0.1 NONE_NONE_ABORTED/000 0 CONNECT 
46.255.231.158:443 - HIER_NONE/- - redir.netcentrum.cz
1712126919.119&#160;&#160;&#160;&#160;&#160; 0 10.0.0.1 NONE_NONE/503 13605 GET 
<A HREF="https://redir.netcentrum.cz/?">https://redir.netcentrum.cz/?</A> - HIER_NONE/- text/html redir.netcentrum.cz
1712127729.466&#160;&#160;&#160;&#160; 66 10.0.0.1 TCP_MISS/200 719 GET 
<A HREF="http://redir.netcentrum.cz/?">http://redir.netcentrum.cz/?</A> - ORIGINAL_DST/46.255.231.158 text/html -
1712127729.516&#160;&#160;&#160;&#160;&#160; 9 10.0.0.1 TCP_MISS/403 424 GET 
<A HREF="http://redir.netcentrum.cz/favicon.ico">http://redir.netcentrum.cz/favicon.ico</A> - ORIGINAL_DST/46.255.231.158 
text/plain -
1712127768.494&#160;&#160;&#160;&#160;&#160; 8 10.0.0.1 TCP_MISS/200 794 GET 
<A HREF="http://redir.netcentrum.cz/?">http://redir.netcentrum.cz/?</A> - ORIGINAL_DST/46.255.231.158 text/html -
1712127768.544&#160;&#160;&#160;&#160;&#160; 7 10.0.0.1 TCP_MISS/403 424 GET 
<A HREF="http://redir.netcentrum.cz/favicon.ico">http://redir.netcentrum.cz/favicon.ico</A> - ORIGINAL_DST/46.255.231.158 
text/plain -
1712127833.348&#160;&#160;&#160;&#160;&#160; 9 10.0.0.1 TCP_MISS/200 794 GET 
<A HREF="http://redir.netcentrum.cz/?">http://redir.netcentrum.cz/?</A> - ORIGINAL_DST/46.255.231.158 text/html -
1712127833.486&#160;&#160;&#160;&#160; 15 10.0.0.1 TCP_MISS/403 424 GET 
<A HREF="http://redir.netcentrum.cz/favicon.ico">http://redir.netcentrum.cz/favicon.ico</A> - ORIGINAL_DST/46.255.231.158 
text/plain -
1712129450.601&#160;&#160;&#160;&#160; 27 10.0.0.1 TCP_MISS/200 851 GET 
<A HREF="http://redir.netcentrum.cz/?">http://redir.netcentrum.cz/?</A> - ORIGINAL_DST/46.255.231.158 text/html -
1712129450.688&#160;&#160;&#160;&#160;&#160; 8 10.0.0.1 TCP_MISS/403 424 GET 
<A HREF="http://redir.netcentrum.cz/favicon.ico">http://redir.netcentrum.cz/favicon.ico</A> - ORIGINAL_DST/46.255.231.158 
text/plain -
1712130278.514&#160;&#160;&#160;&#160; 54 10.0.0.1 TCP_MISS/200 795 GET 
<A HREF="http://redir.netcentrum.cz/?">http://redir.netcentrum.cz/?</A> - ORIGINAL_DST/46.255.231.158 text/html -
1712130278.565&#160;&#160;&#160;&#160;&#160; 9 10.0.0.1 TCP_MISS/403 422 GET 
<A HREF="http://redir.netcentrum.cz/favicon.ico">http://redir.netcentrum.cz/favicon.ico</A> - ORIGINAL_DST/46.255.231.158 
text/plain -
1712130282.165&#160;&#160;&#160;&#160;&#160; 9 10.0.0.1 TCP_MISS/200 815 GET 
<A HREF="http://redir.netcentrum.cz/?">http://redir.netcentrum.cz/?</A> - ORIGINAL_DST/46.255.231.158 text/html -
1712130282.222&#160;&#160;&#160;&#160;&#160; 8 10.0.0.1 TCP_MISS/403 424 GET 
<A HREF="http://redir.netcentrum.cz/favicon.ico">http://redir.netcentrum.cz/favicon.ico</A> - ORIGINAL_DST/46.255.231.158 
text/plain -

I can see clear change from GET https to GET http only. I have to check 
what else does not work and why. (for example many users complained 
about heureka.cz subdomains not openning right with https.) I have to 
say - there many less competent admins in the wild with selfsigned or 
unmatched certificates on their websites, thinking they did the homework 
right. It is tough to explaing to my users that the error page they are 
getting is not a result of a faulty local gear - nor an attempt of the 
admin to spy on them or to block some sites etc.

LL

Dne 03.04.2024 v 8:14 Lou&#269;ansk&#253; Luk&#225;&#353; napsal(a):
&gt;<i>
</I>&gt;<i> Hello,
</I>&gt;<i>
</I>&gt;<i> this has recently started me up more then let it go. For a while 
</I>&gt;<i> chrome is upgrading in-page links to https. It is supposed to work 
</I>&gt;<i> something like 
</I>&gt;<i> <A HREF="https://www.bleepingcomputer.com/news/google/google-chrome-now-auto-upgrades-to-secure-connections-fo">https://www.bleepingcomputer.com/news/google/google-chrome-now-auto-upgrades-to-secure-connections-fo</A> 
</I>&gt;<i> r-all-users/
</I>&gt;<i>
</I>&gt;<i> But there is a catch for me - my squid returns something like:
</I>&gt;<i>
</I>&gt;<i> (104) Connection reset by peer (TLS code: 
</I>&gt;<i> SQUID_TLS_ERR_CONNECT+TLS_IO_ERR=5+errno=104)
</I>&gt;<i> Failed to establish a secure connection: [No Error]
</I>&gt;<i>
</I>&gt;<i> or
</I>&gt;<i>
</I>&gt;<i> [No Error] (TLS code: 
</I>&gt;<i> SQUID_TLS_ERR_CONNECT+TLS_LIB_ERR=1408F10B+TLS_IO_ERR=1)
</I>&gt;<i> Failed to establish a secure connection: error:1408F10B:SSL 
</I>&gt;<i> routines:ssl3_get_record:wrong version number
</I>&gt;<i>
</I>&gt;<i> to the user - via error page
</I>&gt;<i>
</I>&gt;<i> Log file:
</I>&gt;<i>
</I>&gt;<i> 1712122364.809&#160;&#160; 1172 10.0.0.1 NONE_NONE_ABORTED/000 0 CONNECT 
</I>&gt;<i> 46.255.231.158:443 - HIER_NONE/- - SNI redir.netcentrum.cz BumpMode 
</I>&gt;<i> peek - - - ServerNegoTLS - ServerRecTLS - ServerRecVer - ServerNegCiph 
</I>&gt;<i> - Error: ERR_SECURE_CONNECT_FAIL | 
</I>&gt;<i> SQUID_TLS_ERR_CONNECT+TLS_IO_ERR=5+errno=104
</I>&gt;<i> 1712122366.296&#160;&#160;&#160;&#160; 23 10.0.0.1 NONE_NONE_ABORTED/000 0 CONNECT 
</I>&gt;<i> 46.255.231.158:443 - HIER_NONE/- - SNI redir.netcentrum.cz BumpMode 
</I>&gt;<i> peek - - - ServerNegoTLS - ServerRecTLS - ServerRecVer - ServerNegCiph 
</I>&gt;<i> - Error: ERR_SECURE_CONNECT_FAIL | 
</I>&gt;<i> SQUID_TLS_ERR_CONNECT+TLS_IO_ERR=5+errno=104
</I>&gt;<i> 1712122366.293&#160;&#160;&#160;&#160; 21 10.0.0.1 NONE_NONE_ABORTED/000 0 CONNECT 
</I>&gt;<i> 46.255.231.158:443 - HIER_NONE/- - SNI redir.netcentrum.cz BumpMode 
</I>&gt;<i> peek - - - ServerNegoTLS - ServerRecTLS - ServerRecVer - ServerNegCiph 
</I>&gt;<i> - Error: ERR_SECURE_CONNECT_FAIL | 
</I>&gt;<i> SQUID_TLS_ERR_CONNECT+TLS_IO_ERR=5+errno=104
</I>&gt;<i> 1712122367.111&#160;&#160;&#160;&#160; 20 10.0.0.1 NONE_NONE_ABORTED/000 0 CONNECT 
</I>&gt;<i> 46.255.231.158:443 - HIER_NONE/- - SNI redir.netcentrum.cz BumpMode 
</I>&gt;<i> peek - - - ServerNegoTLS - ServerRecTLS - ServerRecVer - ServerNegCiph 
</I>&gt;<i> - Error: ERR_SECURE_CONNECT_FAIL | 
</I>&gt;<i> SQUID_TLS_ERR_CONNECT+TLS_IO_ERR=5+errno=104
</I>&gt;<i> 1712122367.114&#160;&#160;&#160;&#160; 21 10.0.0.1 NONE_NONE_ABORTED/000 0 CONNECT 
</I>&gt;<i> 46.255.231.158:443 - HIER_NONE/- - SNI redir.netcentrum.cz BumpMode 
</I>&gt;<i> peek - - - ServerNegoTLS - ServerRecTLS - ServerRecVer - ServerNegCiph 
</I>&gt;<i> - Error: ERR_SECURE_CONNECT_FAIL | 
</I>&gt;<i> SQUID_TLS_ERR_CONNECT+TLS_IO_ERR=5+errno=104
</I>&gt;<i>
</I>&gt;<i> In fact - this seems to be http only sites like - 
</I>&gt;<i> <A HREF="https://www.ssllabs.com/ssltest/analyze.html?d=www.jarovnet.org">https://www.ssllabs.com/ssltest/analyze.html?d=www.jarovnet.org</A> or 
</I>&gt;<i> <A HREF="https://www.ssllabs.com/ssltest/analyze.html?d=redir.netcentrum.cz&amp;s=46.255.231.158&amp;latest.">https://www.ssllabs.com/ssltest/analyze.html?d=redir.netcentrum.cz&amp;s=46.255.231.158&amp;latest.</A> 
</I>&gt;<i> See this snapshot from centrum web mail page source code &quot;V&#237;ce 
</I>&gt;<i> informac&#237; o tomto zapezpe&#269;en&#237; naleznete v &lt;a 
</I>&gt;<i> href=&quot;<A HREF="http://napoveda.centrum.cz/index.php?/Knowledgebase/Article/View/18/1/">http://napoveda.centrum.cz/index.php?/Knowledgebase/Article/View/18/1/</A>&quot; 
</I>&gt;<i> &quot;
</I>&gt;<i>
</I>&gt;<i> So - what is supposed to be happening is chrome should fallback to 
</I>&gt;<i> http if there is a problem with https - i think the most obvious 
</I>&gt;<i> reason to fall back would be no output at all. So I think my effort 
</I>&gt;<i> should target the situation when squid says&#160; ERR_SECURE_CONNECT_FAIL | 
</I>&gt;<i> SQUID_TLS_ERR_CONNECT+TLS_IO_ERR=5+errno=104 and to remain silent to 
</I>&gt;<i> the client.
</I>&gt;<i>
</I>&gt;<i> Is there a way to do it - ie. do not show error page for not able to 
</I>&gt;<i> connect to server at all? I'd like every other problems (ie. 
</I>&gt;<i> bad/selfsigned/not matched certificate etc.) pushed to the client's 
</I>&gt;<i> eyes. I have implemented 
</I>&gt;<i> <A HREF="https://www.squid-cache.org/Doc/config/on_unsupported_protocol/">https://www.squid-cache.org/Doc/config/on_unsupported_protocol/</A> like 
</I>&gt;<i> in the example - but it is for an accepted TCP connections. I'd like 
</I>&gt;<i> to handle SSL errors - such as not being able to connect at all. - 
</I>&gt;<i> could it be done with 
</I>&gt;<i> <A HREF="https://www.squid-cache.org/Doc/config/sslproxy_cert_error/?">https://www.squid-cache.org/Doc/config/sslproxy_cert_error/?</A>
</I>&gt;<i>
</I>&gt;<i> LL
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">https://lists.squid-cache.org/listinfo/squid-users</A>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20240403/2250e3e4/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20240403/2250e3e4/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="026544.html">[squid-users] Chrome auto-HTTPS-upgrade - not falling to http
</A></li>
	<LI>Next message (by thread): <A HREF="026547.html">[squid-users] Chrome auto-HTTPS-upgrade - not falling to http
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26545">[ date ]</a>
              <a href="thread.html#26545">[ thread ]</a>
              <a href="subject.html#26545">[ subject ]</a>
              <a href="author.html#26545">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
