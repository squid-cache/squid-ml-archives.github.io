<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Chrome auto-HTTPS-upgrade - not falling to http
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Chrome%20auto-HTTPS-upgrade%20-%20not%20falling%20to%20http&In-Reply-To=%3C9ea93946-f050-471a-862b-b7cd39c0a92f%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="026554.html">
   <LINK REL="Next"  HREF="026551.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Chrome auto-HTTPS-upgrade - not falling to http</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Chrome%20auto-HTTPS-upgrade%20-%20not%20falling%20to%20http&In-Reply-To=%3C9ea93946-f050-471a-862b-b7cd39c0a92f%40measurement-factory.com%3E"
       TITLE="[squid-users] Chrome auto-HTTPS-upgrade - not falling to http">rousskov at measurement-factory.com
       </A><BR>
    <I>Fri Apr  5 17:56:20 UTC 2024</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="026554.html">[squid-users] Chrome auto-HTTPS-upgrade - not falling to http
</A></li>
        <LI>Next message (by thread): <A HREF="026551.html">[squid-users] Chrome auto-HTTPS-upgrade - not falling to http
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26555">[ date ]</a>
              <a href="thread.html#26555">[ thread ]</a>
              <a href="subject.html#26555">[ subject ]</a>
              <a href="author.html#26555">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 2024-04-05 08:16, Lou&#269;ansk&#253; Luk&#225;&#353; wrote:

&gt;<i> Build Info: GIT V6.8 commit 4bee0c8
</I>&gt;<i> 
</I>&gt;<i> Could you please somehow elaborate how this seems to be working?
</I>&gt;<i> 
</I>&gt;<i> acl SquidSecureConnectFail squid_error ERR_SECURE_CONNECT_FAIL
</I>&gt;<i> acl SquidTLSErrorConnect ssl_error SQUID_TLS_ERR_CONNECT
</I>&gt;<i> 
</I>&gt;<i> #tunnel all for connection errors
</I>&gt;<i> on_unsupported_protocol tunnel SquidTLSErrorConnect
</I>&gt;<i> on_unsupported_protocol tunnel SquidSecureConnectFail
</I>
Assuming the above rules have the desired effect, I speculate that, in 
your particular test cases (where these rules have the desired effect), 
the tested non-https origin servers result in those two Squid TLS 
errors, those errors happen where on_unsupported_protocol still applies, 
and the selected &quot;tunnel&quot; action tickles the right Chrome behavior. I 
also speculate that not all non-https origin servers exhibit similar 
behavior because other errors were alleged to (also) matter during PR 
#1668 work (e.g., ERR_ZERO_SIZE_OBJECT).

Sorry, I currently do not have enough free time to verify any of the 
above assumptions and speculations. Some of them do surprise me, but 
that does not mean they have to be wrong/false.


&gt;<i> Is it a good or bad attempt? As I put redir.netcentrum.cz as an example 
</I>&gt;<i> in my first post - now it seems to just request TCP_MISS/200 815 GET 
</I>&gt;<i> <A HREF="http://redir.netcentrum.cz/?">http://redir.netcentrum.cz/?</A> - ORIGINAL_DST/46.255.231.158 text/html -.
</I>
If there is no corresponding TLS connection attempt (through Squid) 
before that, then Chrome has changed its behavior in your tests (or your 
network has stopped delivering that attempt to Squid if your Squid is 
intercepting Chrome TLS connections rather than receiving plain CONNECT 
requests from Chrome). Without such an attempt, you are not really 
testing what this thread calls &quot;Chrome auto-HTTPS-upgrade&quot;...


&gt;<i> I do not think my chrome just decided this site is http only and call it 
</I>&gt;<i> like this forever. I just did not see more SSL errors till yesterday . I 
</I>&gt;<i> do not say I haven't seen any (during some fairly short period) - such 
</I>&gt;<i> as SSL version errors, TLS inappropiate fallbacks, broken certs, no 
</I>&gt;<i> common ciphers etc. - but now I could not find a site that does not work 
</I>&gt;<i> (for me) - I have to ask my users.
</I>
Same &quot;If there is no...&quot; comment applies.


&gt;<i> Anyway - squid seemed to have slight 
</I>&gt;<i> problems downloading intermediate certificates - to work properly - so I 
</I>&gt;<i> had to create a collection of several ones for myself (and some root 
</I>&gt;<i> certificates too - for example from MS WU site etc.) - but this could be 
</I>&gt;<i> just trouble with my Debian underlaying distro. (BTW I've alerady 
</I>&gt;<i> implemented transaction_initiator certificate-fetching acl and have 
</I>&gt;<i> http_access line for it)
</I>
This sounds like a completely separate issue. If you are suspecting that 
Squid should get certain intermediate certificates but does not, check 
Bugzilla, and, if there is no corresponding bug report, file a new one.


HTH,

Alex.


&gt;<i> Dne 03.04.2024 v 17:05 Alex Rousskov napsal(a):
</I>&gt;&gt;<i> On 2024-04-03 02:14, Lou&#269;ansk&#253; Luk&#225;&#353; wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> this has recently started me up more then let it go. For a while
</I>&gt;&gt;&gt;<i> chrome is upgrading in-page links to https.
</I>&gt;&gt;<i> Just to add two more pieces of related information to this thread:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Some Squid admins report that their v6-based code does not suffer from 
</I>&gt;&gt;<i> this issue while their v5-based code does. I have not verified those 
</I>&gt;&gt;<i> reports, but there may be more to the story here. What Squid version 
</I>&gt;&gt;<i> are _you_ using?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> One way to track progress with this annoying and complex issue is to 
</I>&gt;&gt;<i> follow the following pull request. The current code cannot be 
</I>&gt;&gt;<i> officially merged as is, and I would not recommend using it in 
</I>&gt;&gt;<i> production (because of low-level bugs that will probably crash Squid 
</I>&gt;&gt;<i> in some cases), but testing it in the lab and providing feedback to 
</I>&gt;&gt;<i> authors may be useful:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> <A HREF="https://github.com/squid-cache/squid/pull/1668">https://github.com/squid-cache/squid/pull/1668</A>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> HTH,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Alex.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;<i> squid-users mailing list
</I>&gt;&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">https://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">https://lists.squid-cache.org/listinfo/squid-users</A>
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="026554.html">[squid-users] Chrome auto-HTTPS-upgrade - not falling to http
</A></li>
	<LI>Next message (by thread): <A HREF="026551.html">[squid-users] Chrome auto-HTTPS-upgrade - not falling to http
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26555">[ date ]</a>
              <a href="thread.html#26555">[ thread ]</a>
              <a href="subject.html#26555">[ subject ]</a>
              <a href="author.html#26555">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
