<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid Cache 6.9 on Ubuntu 22.04.3 LTS. Not caching large files to disk.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20Cache%206.9%20on%20Ubuntu%2022.04.3%20LTS.%20Not%0A%20caching%20large%20files%20to%20disk.&In-Reply-To=%3CF980FFE1-D933-485F-969F-386DE5ECDF0C%40gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="026587.html">
   <LINK REL="Next"  HREF="026589.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid Cache 6.9 on Ubuntu 22.04.3 LTS. Not caching large files to disk.</H1>
    <B>Jonathan Lee</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20Cache%206.9%20on%20Ubuntu%2022.04.3%20LTS.%20Not%0A%20caching%20large%20files%20to%20disk.&In-Reply-To=%3CF980FFE1-D933-485F-969F-386DE5ECDF0C%40gmail.com%3E"
       TITLE="[squid-users] Squid Cache 6.9 on Ubuntu 22.04.3 LTS. Not caching large files to disk.">jonathanlee571 at gmail.com
       </A><BR>
    <I>Fri Apr 12 19:33:16 UTC 2024</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="026587.html">[squid-users] Squid Cache 6.9 on Ubuntu 22.04.3 LTS. Not caching large files to disk.
</A></li>
        <LI>Next message (by thread): <A HREF="026589.html">[squid-users] Install-Problems under WSL2 / Unbuntu 22.04 LTS with squid v6.9
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26588">[ date ]</a>
              <a href="thread.html#26588">[ thread ]</a>
              <a href="subject.html#26588">[ subject ]</a>
              <a href="author.html#26588">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>You need to install certificates as well as on your clients. I don&#8217;t normally catch ISO. I only catch updates regarding windows. I have issues where I have to reserve the updates rather than download them over and over again it saves on bandwidth and costs. I wish you the best of luck, however you do need certificates for the ability to catch HTTPS. without certificates, it will not function so you must own the devices as well for this function. Windows is a different story as the updates come over just HTTPtherefore they can be caught without intercepting. I hope that helps if you&#8217;re using a transparent proxy.
Sent from my iPhone

&gt;<i> On Apr 12, 2024, at 09:30, PinPin Poola &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">pinpinpoola at hotmail.com</A>&gt; wrote:
</I>&gt;<i> 
</I>&gt;<i> &#65279;
</I>&gt;<i> Hi Jonathan,
</I>&gt;<i> 
</I>&gt;<i> No, I didn't have a refresh_pattern for .ISO/etc, so thank you. BTW, what are the &quot;43800 100% 129600&quot; values?
</I>&gt;<i> 
</I>&gt;<i> I realised that I had not actually configured &quot;SSL Bump&quot; in that last /etc/squid/squid.conf file I posted, as the access.log showed my https connections as being tunnelled. &#128577;
</I>&gt;<i> 
</I>&gt;<i> I have tried to enable SSL Bump as best I understand how to and my squid.conf now looks like:
</I>&gt;<i> 
</I>&gt;<i> acl localnet src 0.0.0.1-0.255.255.255  # RFC 1122 &quot;this&quot; network (LAN)
</I>&gt;<i> acl localnet src 10.0.0.0/8             # RFC 1918 local private network (LAN)
</I>&gt;<i> acl localnet src 100.64.0.0/10          # RFC 6598 shared address space (CGN)
</I>&gt;<i> acl localnet src 169.254.0.0/16         # RFC 3927 link-local (directly plugged) machines
</I>&gt;<i> acl localnet src 172.16.0.0/12          # RFC 1918 local private network (LAN)
</I>&gt;<i> acl localnet src 192.168.0.0/16         # RFC 1918 local private network (LAN)
</I>&gt;<i> acl SSL_ports port 443
</I>&gt;<i> acl Safe_ports port 80          # http
</I>&gt;<i> acl Safe_ports port 21          # ftp
</I>&gt;<i> acl Safe_ports port 443         # https
</I>&gt;<i> acl Safe_ports port 70          # gopher
</I>&gt;<i> acl Safe_ports port 210         # wais
</I>&gt;<i> acl Safe_ports port 1025-65535  # unregistered ports
</I>&gt;<i> acl Safe_ports port 280         # http-mgmt
</I>&gt;<i> acl Safe_ports port 488         # gss-http
</I>&gt;<i> acl Safe_ports port 591         # filemaker
</I>&gt;<i> acl Safe_ports port 777         # multiling http
</I>&gt;<i> http_access deny !Safe_ports
</I>&gt;<i> http_access deny CONNECT !SSL_ports
</I>&gt;<i> http_access allow localhost manager
</I>&gt;<i> http_access deny manager
</I>&gt;<i> http_access allow localhost
</I>&gt;<i> http_access allow localnet
</I>&gt;<i> http_access deny to_localhost
</I>&gt;<i> http_access deny to_linklocal
</I>&gt;<i> include /etc/squid/conf.d/*.conf
</I>&gt;<i> http_access deny all
</I>&gt;<i> http_port 3128 ssl-bump generate-host-certificates=on dynamic_cert_mem_cache_size=4MB cert=/etc/squid/ssl_cert/myCA.pem
</I>&gt;<i> sslcrtd_program /usr/lib/squid/security_file_certgen -s /var/lib/ssl_db -M 4MB
</I>&gt;<i> ssl_bump peek all
</I>&gt;<i> ssl_bump splice all
</I>&gt;<i> coredump_dir /var/spool/squid
</I>&gt;<i> refresh_pattern ^ftp:           1440    20%     10080
</I>&gt;<i> refresh_pattern -i (/cgi-bin/|\?) 0     0%      0
</I>&gt;<i> refresh_pattern .               0       20%     4320
</I>&gt;<i> refresh_pattern -i \.(rar|jar|gz|tgz|tar|bz2|iso)(\?|$)&#8194;&#8194;&#8194;&#8194;&#8194;43800 100% 129600
</I>&gt;<i> shutdown_lifetime 10 seconds
</I>&gt;<i> maximum_object_size 35 GB
</I>&gt;<i> cache_mem 256 MB
</I>&gt;<i> maximum_object_size_in_memory 512 KB
</I>&gt;<i> cache_replacement_policy heap LFUDA
</I>&gt;<i> range_offset_limit -1
</I>&gt;<i> quick_abort_min -1 KB
</I>&gt;<i> cache_dir aufs /var/spool/squid 150000 16 256 min-size=1048576
</I>&gt;<i> 
</I>&gt;<i> I read in one blog that the cache_dir had to be listed after maximum_object_size so I moved it. 
</I>&gt;<i> 
</I>&gt;<i> I also reduced the cache_dir / min-size value from 1 GB to 1 MB for testing and switched to a smaller .ISO file as I was getting bored wating for the big one to download repeatedly.
</I>&gt;<i> 
</I>&gt;<i> So now:
</I>&gt;<i> 
</I>&gt;<i> 1) A https download works, but is still tunnelled as mentioned above:
</I>&gt;<i> 
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at client1</A> [ /tmp ]# wget -e https_proxy=10.40.1.250:3128 --ca-certificate ~/myCA.pem <A HREF="https://releases.ubuntu.com/18.04.6/ubuntu-18.04.6-live-server-amd64.iso">https://releases.ubuntu.com/18.04.6/ubuntu-18.04.6-live-server-amd64.iso</A>
</I>&gt;<i> --2024-04-12 15:42:44--  <A HREF="https://releases.ubuntu.com/18.04.6/ubuntu-18.04.6-live-server-amd64.iso">https://releases.ubuntu.com/18.04.6/ubuntu-18.04.6-live-server-amd64.iso</A>
</I>&gt;<i> Connecting to 10.40.1.250:3128... connected.
</I>&gt;<i> Proxy request sent, awaiting response... 200 OK
</I>&gt;<i> Length: 1016070144 (969M) [application/x-iso9660-image]
</I>&gt;<i> Saving to: &#8216;ubuntu-18.04.6-live-server-amd64.iso&#8217;
</I>&gt;<i> 
</I>&gt;<i> ubuntu-18.04.6-live-server-amd64.iso            100%[=======================================================================================================&gt;] 969.00M  20.0MB/s    in 53s
</I>&gt;<i> 
</I>&gt;<i> 2024-04-12 15:43:37 (18.4 MB/s) - &#8216;ubuntu-18.04.6-live-server-amd64.iso&#8217; saved [1016070144/1016070144]
</I>&gt;<i> 
</I>&gt;<i> and the access.log entry looks like this:
</I>&gt;<i> 
</I>&gt;<i> 1712936617.285  52629 10.40.1.2 TCP_TUNNEL/200 1017438604 CONNECT releases.ubuntu.com:443 - HIER_DIRECT/185.125.190.40 -
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 2) A new http download works and is cached to disk now:
</I>&gt;<i> 
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at client1</A> [ /tmp ]# wget -e http_proxy=10.40.1.250:3128 <A HREF="http://releases.ubuntu.com/18.04.6/ubuntu-18.04.6-live-server-amd64.iso">http://releases.ubuntu.com/18.04.6/ubuntu-18.04.6-live-server-amd64.iso</A>
</I>&gt;<i> --2024-04-12 15:44:15--  <A HREF="http://releases.ubuntu.com/18.04.6/ubuntu-18.04.6-live-server-amd64.iso">http://releases.ubuntu.com/18.04.6/ubuntu-18.04.6-live-server-amd64.iso</A>
</I>&gt;<i> Connecting to 10.40.1.250:3128... connected.
</I>&gt;<i> Proxy request sent, awaiting response... 200 OK
</I>&gt;<i> Length: 1016070144 (969M) [application/x-iso9660-image]
</I>&gt;<i> Saving to: &#8216;ubuntu-18.04.6-live-server-amd64.iso.1&#8217;
</I>&gt;<i> 
</I>&gt;<i> ubuntu-18.04.6-live-server-amd64.iso.1          100%[=======================================================================================================&gt;] 969.00M  16.0MB/s    in 52s
</I>&gt;<i> 
</I>&gt;<i> 2024-04-12 15:45:07 (18.6 MB/s) - &#8216;ubuntu-18.04.6-live-server-amd64.iso.1&#8217; saved [1016070144/1016070144]
</I>&gt;<i> 
</I>&gt;<i> and the access.log entry looks like this:
</I>&gt;<i> 
</I>&gt;<i> 1712936707.689  52198 10.40.1.2 TCP_MISS/200 1016070508 GET <A HREF="http://releases.ubuntu.com/18.04.6/ubuntu-18.04.6-live-server-amd64.iso">http://releases.ubuntu.com/18.04.6/ubuntu-18.04.6-live-server-amd64.iso</A> - HIER_DIRECT/185.125.190.40 application/x-iso9660-image
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 3) A subsequent http download of the same file does pull it from cache:
</I>&gt;<i> 
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at client1</A> [ /tmp ]# wget -e http_proxy=10.40.1.250:3128 <A HREF="http://releases.ubuntu.com/18.04.6/ubuntu-18.04.6-live-server-amd64.iso">http://releases.ubuntu.com/18.04.6/ubuntu-18.04.6-live-server-amd64.iso</A>
</I>&gt;<i> --2024-04-12 15:45:23--  <A HREF="http://releases.ubuntu.com/18.04.6/ubuntu-18.04.6-live-server-amd64.iso">http://releases.ubuntu.com/18.04.6/ubuntu-18.04.6-live-server-amd64.iso</A>
</I>&gt;<i> Connecting to 10.40.1.250:3128... connected.
</I>&gt;<i> Proxy request sent, awaiting response... 200 OK
</I>&gt;<i> Length: 1016070144 (969M) [application/x-iso9660-image]
</I>&gt;<i> Saving to: &#8216;ubuntu-18.04.6-live-server-amd64.iso.2&#8217;
</I>&gt;<i> 
</I>&gt;<i> ubuntu-18.04.6-live-server-amd64.iso.2          100%[=======================================================================================================&gt;] 969.00M  30.4MB/s    in 36s
</I>&gt;<i> 
</I>&gt;<i> 2024-04-12 15:45:58 (27.0 MB/s) - &#8216;ubuntu-18.04.6-live-server-amd64.iso.2&#8217; saved [1016070144/1016070144]
</I>&gt;<i> 
</I>&gt;<i> and the access.log entry looks like this:
</I>&gt;<i> 
</I>&gt;<i> 1712936758.943  35825 10.40.1.2 TCP_HIT/200 1016070518 GET <A HREF="http://releases.ubuntu.com/18.04.6/ubuntu-18.04.6-live-server-amd64.iso">http://releases.ubuntu.com/18.04.6/ubuntu-18.04.6-live-server-amd64.iso</A> - HIER_NONE/- application/x-iso9660-image
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> I am making progress, I just need to understand where I am going wrong with SSL Bump for https connections. Why it is still tunnelling? If I fix that I think it will cache/pull from cache the https downloads too. #fingerscrossed
</I>&gt;<i> 
</I>&gt;<i> Any suggestions or decent web blogs/etc on how to configure it?
</I>&gt;<i> 
</I>&gt;<i> Have a great weekend,
</I>&gt;<i> 
</I>&gt;<i> Many Thanks
</I>&gt;<i> Pin
</I>&gt;<i> 
</I>&gt;<i> From: Jonathan Lee &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">jonathanlee571 at gmail.com</A>&gt;
</I>&gt;<i> Sent: 12 April 2024 15:10
</I>&gt;<i> To: PinPin Poola &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">pinpinpoola at hotmail.com</A>&gt;
</I>&gt;<i> Cc: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A> &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>&gt;
</I>&gt;<i> Subject: Re: [squid-users] Squid Cache 6.9 on Ubuntu 22.04.3 LTS. Not caching large files to disk.
</I>&gt;<i>  
</I>&gt;<i> Do you have a refresh pattern for .ISO to do this. The defaults for the cache does not cache .ISO files, you have to add a custom refresh pattern for it
</I>&gt;<i> 
</I>&gt;<i> Something like this 
</I>&gt;<i> 
</I>&gt;<i> refresh_pattern -i \.(rar|jar|gz|tgz|tar|bz2|iso)(\?|$)                         43800 100% 129600        # RAR | JAR | GZ | TGZ | TAR | BZ2 | ISO
</I>&gt;<i> 
</I>&gt;<i> ~~~~~
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20240412/40d09edd/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20240412/40d09edd/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="026587.html">[squid-users] Squid Cache 6.9 on Ubuntu 22.04.3 LTS. Not caching large files to disk.
</A></li>
	<LI>Next message (by thread): <A HREF="026589.html">[squid-users] Install-Problems under WSL2 / Unbuntu 22.04 LTS with squid v6.9
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26588">[ date ]</a>
              <a href="thread.html#26588">[ thread ]</a>
              <a href="subject.html#26588">[ subject ]</a>
              <a href="author.html#26588">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
