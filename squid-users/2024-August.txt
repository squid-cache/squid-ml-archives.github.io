From squid3 at treenet.co.nz  Thu Aug  1 00:39:09 2024
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Thu, 1 Aug 2024 12:39:09 +1200
Subject: [squid-users] Squid with PV6 Tunnel Broker
In-Reply-To: <E0BC4731-E579-45D2-9A75-A8FD4B383715@gmail.com>
References: <4bafee6a-8046-4d8d-b0f0-86d338022528@treenet.co.nz>
 <E0BC4731-E579-45D2-9A75-A8FD4B383715@gmail.com>
Message-ID: <0b7b4f9b-2174-4b51-8057-6928b56a9637@treenet.co.nz>

On 31/07/24 18:05, Jonathan Lee wrote:
> The error it shows when I activate IPv6 only mode not dual stack is
> 

There is no "IPv6 only mode" in Squid. What do you mean?


> Error: no forward proxy ports configured
> 

In the config you showed earlier all of your IPv6 listening ports use 
the "intercept" flag.

Please try with this much simplified configuration for listening ports:

  # Receive forward-proxy and cache manager traffic
  http_port 3128 ssl-bump \
     generate-host-certificates=on dynamic_cert_mem_cache_size=20MB \
     tls-cert=/usr/local/etc/squid/serverkey.pem \
     tls-dh=prime256v1:/etc/dh-parameters.2048 \
     options=NO_SSLv3

  # Receive intercepted port 80 traffic
  http_port 3127 intercept ssl-bump \
     generate-host-certificates=on dynamic_cert_mem_cache_size=20MB \
     tls-cert=/usr/local/etc/squid/serverkey.pem \
     tls-dh=prime256v1:/etc/dh-parameters.2048 \
     options=NO_SSLv3

  # Receive intercepted port 443 traffic
  https_port 3129 intercept ssl-bump \
     generate-host-certificates=on dynamic_cert_mem_cache_size=20MB \
     tls-cert=/usr/local/etc/squid/serverkey.pem \
     tls-dh=prime256v1:/etc/dh-parameters.2048 \
     options=NO_SSLv3


There are other changes you will need to make the SSL-Bump and access 
controls fully work. But this is all you should need to at least get 
Squid accepting TCP and TLS connections.

The two "intercept" port numbers above are arbitrary. Just make sure 
that your NAT rules are passing port 80 and port 443 to the right one.
  IIRC, your IPv6 NAT rule may need changing.


Cheers
Amos


From jonathanlee571 at gmail.com  Thu Aug  1 19:30:00 2024
From: jonathanlee571 at gmail.com (Jonathan Lee)
Date: Thu, 1 Aug 2024 12:30:00 -0700
Subject: [squid-users] squidclient -h 127.0.0.1 -p 3128 mgr:info shows
 access denined
In-Reply-To: <CA+Y8hcMS0gHUx8nUBcY6pvRCvvU3=XrZmNDk9kuadCenf8JWhA@mail.gmail.com>
References: <20a104fa-ee36-499e-ad8b-5c23446d4bbe@treenet.co.nz>
 <D6BA04C0-56A8-4E6F-B7E7-0364DC642E1C@gmail.com>
 <77A9F8B9-14D5-4414-8660-04585EF5E0D3@gmail.com>
 <c68f0650-e14c-4cef-ae1c-9e55b3c55a28@treenet.co.nz>
 <922D08E6-BDC7-42C2-9A54-AAF06ABCE780@gmail.com>
 <EA649532-7655-40CF-BDF3-EFA4F8078EEC@gmail.com>
 <d18f0034-1f3b-4b51-9927-06aa5e7f01ca@measurement-factory.com>
 <CADJd0Y1h4wviABtDXQpCc2w1C7YQ0n9EKEh79=KYKQDFWLWtpA@mail.gmail.com>
 <781872AE-13EB-421F-BCB7-9B1E10E65BE4@gmail.com>
 <46154037-39EA-4F75-9DE5-1D538FEEFAD7@gmail.com>
 <CA+Y8hcMS0gHUx8nUBcY6pvRCvvU3=XrZmNDk9kuadCenf8JWhA@mail.gmail.com>
Message-ID: <7248A189-C8F6-4B5D-AFDF-6E994C3EF099@gmail.com>


          client << " requesting '" <<
           actionName << "'" );

    // special case: /squid-internal-mgr/ index page
    // special case: an index page
    if (!strcmp(cmd->profile->name, "index")) {
        ErrorState err(MGR_INDEX, Http::scOkay, request, ale);
        err.url = xstrdup(entry->url());

it shows squid-internal-mgr was removed and replaced with ?an"?.

> On Jul 24, 2024, at 14:29, Francesco Chemolli <gkinkie at gmail.com> wrote:
> 
> Hi Jonathan,
>  could you try:
> curl -u anything:redacted http://localhost:3128/squid-internal-mgr/menu
> 
> ?
> 
> On Mon, Jul 22, 2024 at 8:52?PM Jonathan Lee <jonathanlee571 at gmail.com> wrote:
>> 
>> Also I have tested
>> 
>> curl 127.0.0.1:3128/squid-internal-mgr -u :redacted
>> curl localhost:3128/squid-internal-mgr -u :redacted
>> curl hostname_here:3128/squid-internal-mgr -u :redacted (per bug notes use hostname in place of localhost)
>> 
>> and testing with no password same commands lock up the system with no response and if I do them outside of the host with a web browser I get the errors below seen they are new..
>> 
>> HTTP/1.1 Expect: feature is being asked from an HTTP/1.0 software.
>> 
>> 
>> 
>> 
>> 
>> On Jul 22, 2024, at 09:01, Jonathan Lee <jonathanlee571 at gmail.com> wrote:
>> 
>> Thanks for the info
>> 
>> I tried it and this also failed. Dang
>> 
>> Shell Output - curl localhost:3128/squid-internal-mgr/info -u :redacted
>> 
>>  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
>>                                 Dload  Upload   Total   Spent    Left  Speed
>> 
>>  0     0    0     0    0     0      0      0 --:--:-- --:--:-- --:--:--     0
>> 100  3773  100  3773    0     0  90756      0 --:--:-- --:--:-- --:--:-- 94325
>> <!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
>> <html><head>
>> <meta type="copyright" content="Copyright (C) 1996-2023 The Squid Software Foundation and contributors">
>> <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
>> <title>ERROR: The requested URL could not be retrieved</title>
>> <style type="text/css"><!--
>> /*
>> * Copyright (C) 1996-2023 The Squid Software Foundation and contributors
>> *
>> * Squid software is distributed under GPLv2+ license and includes
>> * contributions from numerous individuals and organizations.
>> * Please see the COPYING and CONTRIBUTORS files for details.
>> */
>> 
>> /*
>> Stylesheet for Squid Error pages
>> Adapted from design by Free CSS Templates
>> http://www.freecsstemplates.org
>> Released for free under a Creative Commons Attribution 2.5 License
>> */
>> 
>> However I get a new error when attempting to connect over a web browser
>> 
>> ERROR
>> 
>> The requested URL could not be retrieved
>> 
>> ________________________________
>> 
>> Invalid Request error was encountered while trying to process the request:
>> 
>> GET /squid-internal-mgr HTTP/1.1
>> Host: lee_family.home.arpa:3128
>> Upgrade-Insecure-Requests: 1
>> Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
>> User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.5 Safari/605.1.15
>> Accept-Language: en-US,en;q=0.9
>> Accept-Encoding: gzip, deflate
>> Connection: keep-alive
>> DNT: 1
>> 
>> Some possible problems are:
>> 
>> Request is too large.
>> 
>> Content-Length missing for POST or PUT requests.
>> 
>> Illegal character in hostname; underscores are not allowed.
>> 
>> HTTP/1.1 Expect: feature is being asked from an HTTP/1.0 software.
>> 
>> Your cache administrator is
>> 
>> 
>> 
>> On Jul 22, 2024, at 04:42, Andrey K <ankor2023 at gmail.com> wrote:
>> 
>> Hello, Jonathan,
>> 
>>> curl http://localhost:3128/squid-internal-mgr/info
>> 
>>> Where would I place the password?
>> 
>> I use the following configuration:
>> http_access allow localhost  manager
>> cachemgr_passwd redacted config
>> 
>> The command to read the current running config is:
>> curl localhost:3128/squid-internal-mgr/config -u :redacted
>> 
>> 
>> Kind regards,
>>      Ankor.
>> 
>> 
>> 
>> 
>> ??, 18 ???. 2024??. ? 17:07, Alex Rousskov <rousskov at measurement-factory.com>:
>>> 
>>> On 2024-07-18 00:55, Jonathan Lee wrote:
>>> 
>>>> curl http://localhost:3128/squid-internal-mgr/info
>>>> 
>>>> Where would I place the password?
>>> 
>>> See "man curl" or online manual pages for curl. They will point you to
>>> two relevant options: --user and --proxy-user. AFAICT, your particular
>>> cache manager requests are sent _to_ the proxy (as if it were an origin
>>> server) rather than _through_ the proxy. Thus, you should use --user.
>>> 
>>> As I keep saying on this thread, due to Squid complications related to
>>> Bug 5283, specifying seemingly correct client parameters may not be
>>> enough to convince Squid to accept the cache manager request. I
>>> recommend the following procedure:
>>> 
>>> 1. List the corresponding http_port directive first, before any other
>>> http_port, https_port, and ftp_port directives. Do not use interception
>>> of any kind for this cache manager port.
>>> 
>>> 2. Use curl with absolute squid-internal-mgr URLs with http scheme (like
>>> you show above). Do _not_ use "curl --proxy" or similar. Do not use
>>> https scheme.
>>> 
>>> 3. In that absolute mgr URL, use the host name that matches
>>> visible_hostname in squid.conf. If you do not have visible_hostname in
>>> squid.conf, add it. This is not required, but, due to Squid bugs, it is
>>> often much easier to get this to work with visible_hostname than without it.
>>> 
>>> 4. Make (passwordless) mgr:info use case working first, before trying to
>>> get password-protected pages working.
>>> 
>>> 5. When you do specify a username and a password, remember that you are
>>> sending this request to an (equivalent of) a service running on an
>>> origin server, _not_ a proxy (hence --user rather than --proxy-user).
>>> 
>>> 
>>> If you cannot figure it out despite carefully going through the above
>>> steps, share (privately if needed) a pointer to compressed ALL,9
>>> cache.log while reproducing the problem with throw-away credentials on
>>> an idle Squid with a single curl request. Mention which step you got
>>> stuck on.
>>> 
>>> 
>>> HTH,
>>> 
>>> Alex.
>>> 
>>> _______________________________________________
>>> squid-users mailing list
>>> squid-users at lists.squid-cache.org
>>> https://lists.squid-cache.org/listinfo/squid-users
>> 
>> _______________________________________________
>> squid-users mailing list
>> squid-users at lists.squid-cache.org
>> https://lists.squid-cache.org/listinfo/squid-users
>> 
>> 
>> 
>> _______________________________________________
>> squid-users mailing list
>> squid-users at lists.squid-cache.org
>> https://lists.squid-cache.org/listinfo/squid-users
> 
> 
> 
> -- 
>    Francesco
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> https://lists.squid-cache.org/listinfo/squid-users

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20240801/c18ef22d/attachment.htm>

From jonathanlee571 at gmail.com  Thu Aug  1 20:14:28 2024
From: jonathanlee571 at gmail.com (Jonathan Lee)
Date: Thu, 1 Aug 2024 13:14:28 -0700
Subject: [squid-users] squidclient -h 127.0.0.1 -p 3128 mgr:info shows
 access denined
In-Reply-To: <7248A189-C8F6-4B5D-AFDF-6E994C3EF099@gmail.com>
References: <20a104fa-ee36-499e-ad8b-5c23446d4bbe@treenet.co.nz>
 <D6BA04C0-56A8-4E6F-B7E7-0364DC642E1C@gmail.com>
 <77A9F8B9-14D5-4414-8660-04585EF5E0D3@gmail.com>
 <c68f0650-e14c-4cef-ae1c-9e55b3c55a28@treenet.co.nz>
 <922D08E6-BDC7-42C2-9A54-AAF06ABCE780@gmail.com>
 <EA649532-7655-40CF-BDF3-EFA4F8078EEC@gmail.com>
 <d18f0034-1f3b-4b51-9927-06aa5e7f01ca@measurement-factory.com>
 <CADJd0Y1h4wviABtDXQpCc2w1C7YQ0n9EKEh79=KYKQDFWLWtpA@mail.gmail.com>
 <781872AE-13EB-421F-BCB7-9B1E10E65BE4@gmail.com>
 <46154037-39EA-4F75-9DE5-1D538FEEFAD7@gmail.com>
 <CA+Y8hcMS0gHUx8nUBcY6pvRCvvU3=XrZmNDk9kuadCenf8JWhA@mail.gmail.com>
 <7248A189-C8F6-4B5D-AFDF-6E994C3EF099@gmail.com>
Message-ID: <3E0B3A1C-FE5A-4875-B6DA-48D34387FC17@gmail.com>

The directive
cachemgr_passwd
does not allow the ability to add a username right?



> On Aug 1, 2024, at 12:30, Jonathan Lee <jonathanlee571 at gmail.com> wrote:
> 
>           client << " requesting '" <<
>            actionName << "'" );
> 
>     // special case: /squid-internal-mgr/ index page
>     // special case: an index page
>     if (!strcmp(cmd->profile->name, "index")) {
>         ErrorState err(MGR_INDEX, Http::scOkay, request, ale);
>         err.url = xstrdup(entry->url());
> 
> it shows squid-internal-mgr was removed and replaced with ?an"?.
> 
>> On Jul 24, 2024, at 14:29, Francesco Chemolli <gkinkie at gmail.com> wrote:
>> 
>> Hi Jonathan,
>>  could you try:
>> curl -u anything:redacted http://localhost:3128/squid-internal-mgr/menu
>> 
>> ?
>> 
>> On Mon, Jul 22, 2024 at 8:52?PM Jonathan Lee <jonathanlee571 at gmail.com> wrote:
>>> 
>>> Also I have tested
>>> 
>>> curl 127.0.0.1:3128/squid-internal-mgr -u :redacted
>>> curl localhost:3128/squid-internal-mgr -u :redacted
>>> curl hostname_here:3128/squid-internal-mgr -u :redacted (per bug notes use hostname in place of localhost)
>>> 
>>> and testing with no password same commands lock up the system with no response and if I do them outside of the host with a web browser I get the errors below seen they are new..
>>> 
>>> HTTP/1.1 Expect: feature is being asked from an HTTP/1.0 software.
>>> 
>>> 
>>> 
>>> 
>>> 
>>> On Jul 22, 2024, at 09:01, Jonathan Lee <jonathanlee571 at gmail.com> wrote:
>>> 
>>> Thanks for the info
>>> 
>>> I tried it and this also failed. Dang
>>> 
>>> Shell Output - curl localhost:3128/squid-internal-mgr/info -u :redacted
>>> 
>>>  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
>>>                                 Dload  Upload   Total   Spent    Left  Speed
>>> 
>>>  0     0    0     0    0     0      0      0 --:--:-- --:--:-- --:--:--     0
>>> 100  3773  100  3773    0     0  90756      0 --:--:-- --:--:-- --:--:-- 94325
>>> <!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
>>> <html><head>
>>> <meta type="copyright" content="Copyright (C) 1996-2023 The Squid Software Foundation and contributors">
>>> <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
>>> <title>ERROR: The requested URL could not be retrieved</title>
>>> <style type="text/css"><!--
>>> /*
>>> * Copyright (C) 1996-2023 The Squid Software Foundation and contributors
>>> *
>>> * Squid software is distributed under GPLv2+ license and includes
>>> * contributions from numerous individuals and organizations.
>>> * Please see the COPYING and CONTRIBUTORS files for details.
>>> */
>>> 
>>> /*
>>> Stylesheet for Squid Error pages
>>> Adapted from design by Free CSS Templates
>>> http://www.freecsstemplates.org
>>> Released for free under a Creative Commons Attribution 2.5 License
>>> */
>>> 
>>> However I get a new error when attempting to connect over a web browser
>>> 
>>> ERROR
>>> 
>>> The requested URL could not be retrieved
>>> 
>>> ________________________________
>>> 
>>> Invalid Request error was encountered while trying to process the request:
>>> 
>>> GET /squid-internal-mgr HTTP/1.1
>>> Host: lee_family.home.arpa:3128
>>> Upgrade-Insecure-Requests: 1
>>> Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
>>> User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.5 Safari/605.1.15
>>> Accept-Language: en-US,en;q=0.9
>>> Accept-Encoding: gzip, deflate
>>> Connection: keep-alive
>>> DNT: 1
>>> 
>>> Some possible problems are:
>>> 
>>> Request is too large.
>>> 
>>> Content-Length missing for POST or PUT requests.
>>> 
>>> Illegal character in hostname; underscores are not allowed.
>>> 
>>> HTTP/1.1 Expect: feature is being asked from an HTTP/1.0 software.
>>> 
>>> Your cache administrator is
>>> 
>>> 
>>> 
>>> On Jul 22, 2024, at 04:42, Andrey K <ankor2023 at gmail.com> wrote:
>>> 
>>> Hello, Jonathan,
>>> 
>>>> curl http://localhost:3128/squid-internal-mgr/info
>>> 
>>>> Where would I place the password?
>>> 
>>> I use the following configuration:
>>> http_access allow localhost  manager
>>> cachemgr_passwd redacted config
>>> 
>>> The command to read the current running config is:
>>> curl localhost:3128/squid-internal-mgr/config -u :redacted
>>> 
>>> 
>>> Kind regards,
>>>      Ankor.
>>> 
>>> 
>>> 
>>> 
>>> ??, 18 ???. 2024??. ? 17:07, Alex Rousskov <rousskov at measurement-factory.com>:
>>>> 
>>>> On 2024-07-18 00:55, Jonathan Lee wrote:
>>>> 
>>>>> curl http://localhost:3128/squid-internal-mgr/info
>>>>> 
>>>>> Where would I place the password?
>>>> 
>>>> See "man curl" or online manual pages for curl. They will point you to
>>>> two relevant options: --user and --proxy-user. AFAICT, your particular
>>>> cache manager requests are sent _to_ the proxy (as if it were an origin
>>>> server) rather than _through_ the proxy. Thus, you should use --user.
>>>> 
>>>> As I keep saying on this thread, due to Squid complications related to
>>>> Bug 5283, specifying seemingly correct client parameters may not be
>>>> enough to convince Squid to accept the cache manager request. I
>>>> recommend the following procedure:
>>>> 
>>>> 1. List the corresponding http_port directive first, before any other
>>>> http_port, https_port, and ftp_port directives. Do not use interception
>>>> of any kind for this cache manager port.
>>>> 
>>>> 2. Use curl with absolute squid-internal-mgr URLs with http scheme (like
>>>> you show above). Do _not_ use "curl --proxy" or similar. Do not use
>>>> https scheme.
>>>> 
>>>> 3. In that absolute mgr URL, use the host name that matches
>>>> visible_hostname in squid.conf. If you do not have visible_hostname in
>>>> squid.conf, add it. This is not required, but, due to Squid bugs, it is
>>>> often much easier to get this to work with visible_hostname than without it.
>>>> 
>>>> 4. Make (passwordless) mgr:info use case working first, before trying to
>>>> get password-protected pages working.
>>>> 
>>>> 5. When you do specify a username and a password, remember that you are
>>>> sending this request to an (equivalent of) a service running on an
>>>> origin server, _not_ a proxy (hence --user rather than --proxy-user).
>>>> 
>>>> 
>>>> If you cannot figure it out despite carefully going through the above
>>>> steps, share (privately if needed) a pointer to compressed ALL,9
>>>> cache.log while reproducing the problem with throw-away credentials on
>>>> an idle Squid with a single curl request. Mention which step you got
>>>> stuck on.
>>>> 
>>>> 
>>>> HTH,
>>>> 
>>>> Alex.
>>>> 
>>>> _______________________________________________
>>>> squid-users mailing list
>>>> squid-users at lists.squid-cache.org
>>>> https://lists.squid-cache.org/listinfo/squid-users
>>> 
>>> _______________________________________________
>>> squid-users mailing list
>>> squid-users at lists.squid-cache.org
>>> https://lists.squid-cache.org/listinfo/squid-users
>>> 
>>> 
>>> 
>>> _______________________________________________
>>> squid-users mailing list
>>> squid-users at lists.squid-cache.org
>>> https://lists.squid-cache.org/listinfo/squid-users
>> 
>> 
>> 
>> -- 
>>    Francesco
>> _______________________________________________
>> squid-users mailing list
>> squid-users at lists.squid-cache.org
>> https://lists.squid-cache.org/listinfo/squid-users
> 

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20240801/9b5478b6/attachment.htm>

From jonathanlee571 at gmail.com  Thu Aug  1 20:08:42 2024
From: jonathanlee571 at gmail.com (Jonathan Lee)
Date: Thu, 1 Aug 2024 13:08:42 -0700
Subject: [squid-users] squidclient -h 127.0.0.1 -p 3128 mgr:info shows
 access denined
In-Reply-To: <CA+Y8hcMS0gHUx8nUBcY6pvRCvvU3=XrZmNDk9kuadCenf8JWhA@mail.gmail.com>
References: <20a104fa-ee36-499e-ad8b-5c23446d4bbe@treenet.co.nz>
 <D6BA04C0-56A8-4E6F-B7E7-0364DC642E1C@gmail.com>
 <77A9F8B9-14D5-4414-8660-04585EF5E0D3@gmail.com>
 <c68f0650-e14c-4cef-ae1c-9e55b3c55a28@treenet.co.nz>
 <922D08E6-BDC7-42C2-9A54-AAF06ABCE780@gmail.com>
 <EA649532-7655-40CF-BDF3-EFA4F8078EEC@gmail.com>
 <d18f0034-1f3b-4b51-9927-06aa5e7f01ca@measurement-factory.com>
 <CADJd0Y1h4wviABtDXQpCc2w1C7YQ0n9EKEh79=KYKQDFWLWtpA@mail.gmail.com>
 <781872AE-13EB-421F-BCB7-9B1E10E65BE4@gmail.com>
 <46154037-39EA-4F75-9DE5-1D538FEEFAD7@gmail.com>
 <CA+Y8hcMS0gHUx8nUBcY6pvRCvvU3=XrZmNDk9kuadCenf8JWhA@mail.gmail.com>
Message-ID: <1AC51759-2C17-40DD-BBB4-257E1455CB6C@gmail.com>

https://github.com/squid-cache/squid/commit/a4e35bd8ffe51cda83e63faab79bda5a838c7e1a
Seems to want a valid username 

https://github.com/squid-cache/squid/commit/3c383cc371e7ad69c533e629c6997f325aa3752d
Has squid-internal-mgr special case change to an
    // special case: /squid-internal-mgr/ index page
    // special case: an index page
    if (!strcmp(cmd->profile->name, "index")) {
        ErrorState err(MGR_INDEX, Http::scOkay, request, ale);
        err.url = xstrdup(entry->url());


I can not get status to show for anything 

> On Jul 24, 2024, at 14:29, Francesco Chemolli <gkinkie at gmail.com> wrote:
> 
> Hi Jonathan,
>  could you try:
> curl -u anything:redacted http://localhost:3128/squid-internal-mgr/menu
> 
> ?
> 
> On Mon, Jul 22, 2024 at 8:52?PM Jonathan Lee <jonathanlee571 at gmail.com> wrote:
>> 
>> Also I have tested
>> 
>> curl 127.0.0.1:3128/squid-internal-mgr -u :redacted
>> curl localhost:3128/squid-internal-mgr -u :redacted
>> curl hostname_here:3128/squid-internal-mgr -u :redacted (per bug notes use hostname in place of localhost)
>> 
>> and testing with no password same commands lock up the system with no response and if I do them outside of the host with a web browser I get the errors below seen they are new..
>> 
>> HTTP/1.1 Expect: feature is being asked from an HTTP/1.0 software.
>> 
>> 
>> 
>> 
>> 
>> On Jul 22, 2024, at 09:01, Jonathan Lee <jonathanlee571 at gmail.com> wrote:
>> 
>> Thanks for the info
>> 
>> I tried it and this also failed. Dang
>> 
>> Shell Output - curl localhost:3128/squid-internal-mgr/info -u :redacted
>> 
>>  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
>>                                 Dload  Upload   Total   Spent    Left  Speed
>> 
>>  0     0    0     0    0     0      0      0 --:--:-- --:--:-- --:--:--     0
>> 100  3773  100  3773    0     0  90756      0 --:--:-- --:--:-- --:--:-- 94325
>> <!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
>> <html><head>
>> <meta type="copyright" content="Copyright (C) 1996-2023 The Squid Software Foundation and contributors">
>> <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
>> <title>ERROR: The requested URL could not be retrieved</title>
>> <style type="text/css"><!--
>> /*
>> * Copyright (C) 1996-2023 The Squid Software Foundation and contributors
>> *
>> * Squid software is distributed under GPLv2+ license and includes
>> * contributions from numerous individuals and organizations.
>> * Please see the COPYING and CONTRIBUTORS files for details.
>> */
>> 
>> /*
>> Stylesheet for Squid Error pages
>> Adapted from design by Free CSS Templates
>> http://www.freecsstemplates.org
>> Released for free under a Creative Commons Attribution 2.5 License
>> */
>> 
>> However I get a new error when attempting to connect over a web browser
>> 
>> ERROR
>> 
>> The requested URL could not be retrieved
>> 
>> ________________________________
>> 
>> Invalid Request error was encountered while trying to process the request:
>> 
>> GET /squid-internal-mgr HTTP/1.1
>> Host: lee_family.home.arpa:3128
>> Upgrade-Insecure-Requests: 1
>> Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
>> User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.5 Safari/605.1.15
>> Accept-Language: en-US,en;q=0.9
>> Accept-Encoding: gzip, deflate
>> Connection: keep-alive
>> DNT: 1
>> 
>> Some possible problems are:
>> 
>> Request is too large.
>> 
>> Content-Length missing for POST or PUT requests.
>> 
>> Illegal character in hostname; underscores are not allowed.
>> 
>> HTTP/1.1 Expect: feature is being asked from an HTTP/1.0 software.
>> 
>> Your cache administrator is
>> 
>> 
>> 
>> On Jul 22, 2024, at 04:42, Andrey K <ankor2023 at gmail.com> wrote:
>> 
>> Hello, Jonathan,
>> 
>>> curl http://localhost:3128/squid-internal-mgr/info
>> 
>>> Where would I place the password?
>> 
>> I use the following configuration:
>> http_access allow localhost  manager
>> cachemgr_passwd redacted config
>> 
>> The command to read the current running config is:
>> curl localhost:3128/squid-internal-mgr/config -u :redacted
>> 
>> 
>> Kind regards,
>>      Ankor.
>> 
>> 
>> 
>> 
>> ??, 18 ???. 2024??. ? 17:07, Alex Rousskov <rousskov at measurement-factory.com>:
>>> 
>>> On 2024-07-18 00:55, Jonathan Lee wrote:
>>> 
>>>> curl http://localhost:3128/squid-internal-mgr/info
>>>> 
>>>> Where would I place the password?
>>> 
>>> See "man curl" or online manual pages for curl. They will point you to
>>> two relevant options: --user and --proxy-user. AFAICT, your particular
>>> cache manager requests are sent _to_ the proxy (as if it were an origin
>>> server) rather than _through_ the proxy. Thus, you should use --user.
>>> 
>>> As I keep saying on this thread, due to Squid complications related to
>>> Bug 5283, specifying seemingly correct client parameters may not be
>>> enough to convince Squid to accept the cache manager request. I
>>> recommend the following procedure:
>>> 
>>> 1. List the corresponding http_port directive first, before any other
>>> http_port, https_port, and ftp_port directives. Do not use interception
>>> of any kind for this cache manager port.
>>> 
>>> 2. Use curl with absolute squid-internal-mgr URLs with http scheme (like
>>> you show above). Do _not_ use "curl --proxy" or similar. Do not use
>>> https scheme.
>>> 
>>> 3. In that absolute mgr URL, use the host name that matches
>>> visible_hostname in squid.conf. If you do not have visible_hostname in
>>> squid.conf, add it. This is not required, but, due to Squid bugs, it is
>>> often much easier to get this to work with visible_hostname than without it.
>>> 
>>> 4. Make (passwordless) mgr:info use case working first, before trying to
>>> get password-protected pages working.
>>> 
>>> 5. When you do specify a username and a password, remember that you are
>>> sending this request to an (equivalent of) a service running on an
>>> origin server, _not_ a proxy (hence --user rather than --proxy-user).
>>> 
>>> 
>>> If you cannot figure it out despite carefully going through the above
>>> steps, share (privately if needed) a pointer to compressed ALL,9
>>> cache.log while reproducing the problem with throw-away credentials on
>>> an idle Squid with a single curl request. Mention which step you got
>>> stuck on.
>>> 
>>> 
>>> HTH,
>>> 
>>> Alex.
>>> 
>>> _______________________________________________
>>> squid-users mailing list
>>> squid-users at lists.squid-cache.org
>>> https://lists.squid-cache.org/listinfo/squid-users
>> 
>> _______________________________________________
>> squid-users mailing list
>> squid-users at lists.squid-cache.org
>> https://lists.squid-cache.org/listinfo/squid-users
>> 
>> 
>> 
>> _______________________________________________
>> squid-users mailing list
>> squid-users at lists.squid-cache.org
>> https://lists.squid-cache.org/listinfo/squid-users
> 
> 
> 
> -- 
>    Francesco
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> https://lists.squid-cache.org/listinfo/squid-users

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20240801/941a91a7/attachment.htm>

From uhlar at fantomas.sk  Mon Aug  5 13:01:50 2024
From: uhlar at fantomas.sk (Matus UHLAR - fantomas)
Date: Mon, 5 Aug 2024 15:01:50 +0200
Subject: [squid-users] Parse DNS for IPv4 and IPv6
In-Reply-To: <1E4F8E23-FE93-4474-B4F7-2A941DD75109@gmail.com>
References: <FFDEC81D-ECFB-49B7-A784-55B886C7ACC9@gmail.com>
 <1E4F8E23-FE93-4474-B4F7-2A941DD75109@gmail.com>
Message-ID: <ZrDNPkCnVEtqP_8j@fantomas.sk>

On 31.07.24 13:17, Jonathan Lee wrote:
>I forgot to mention this is over a he tunnel broker gif interface with IPv4 only isp

I asked for log messages (from acess.log) or possibly errors from cache.log


>> On Jul 31, 2024, at 12:03, Jonathan Lee <jonathanlee571 at gmail.com> wrote:
>>
>> ?I show HTTP/1.1 409 conflict when it try to reply from the firewall back to the client.
>>
>> I do not know if you need a pcap file
>>
>> <Capture.PNG>
>> <packetcapture-mvneta1.4084-20240731114904.pcap>
>>
>>
>>> On Jul 31, 2024, at 03:35, Matus UHLAR - fantomas <uhlar at fantomas.sk> wrote:
>>>
>>>> On 30.07.24 12:55, Jonathan Lee wrote:
>>>> Hello fellow squid users can you please help?
>>>
>>>> I have noticed that I get 409 errors with IPv6 only clients this leads me to believe that it?s DNS related.
>>>
>>> why do you think that?
>>>
>>>> My firewall has both IPV4 and IPV6 DNS.  I wonder if when an IPV6 only client is trying to access the proxy it defaults to IPv4 dns.
>>>
>>> Sice, the connection between client and squid is separate from connection between squid and server, it should be perfectly okay to have ipv6 on one and ipv4 on another.
>>>
>>>> How can one manually set the system to utilize specified DNS for ACL use within subnets?  The system works as long as clients are double stacked.
>>>
>>> Can we see example of those errors in log files?

-- 
Matus UHLAR - fantomas, uhlar at fantomas.sk ; http://www.fantomas.sk/
Warning: I wish NOT to receive e-mail advertising to this address.
Varovanie: na tuto adresu chcem NEDOSTAVAT akukolvek reklamnu postu.
I drive way too fast to worry about cholesterol.


From uhlar at fantomas.sk  Mon Aug  5 13:08:07 2024
From: uhlar at fantomas.sk (Matus UHLAR - fantomas)
Date: Mon, 5 Aug 2024 15:08:07 +0200
Subject: [squid-users] squidclient -h 127.0.0.1 -p 3128 mgr:info shows
 access denined
In-Reply-To: <3E0B3A1C-FE5A-4875-B6DA-48D34387FC17@gmail.com>
References: <c68f0650-e14c-4cef-ae1c-9e55b3c55a28@treenet.co.nz>
 <922D08E6-BDC7-42C2-9A54-AAF06ABCE780@gmail.com>
 <EA649532-7655-40CF-BDF3-EFA4F8078EEC@gmail.com>
 <d18f0034-1f3b-4b51-9927-06aa5e7f01ca@measurement-factory.com>
 <CADJd0Y1h4wviABtDXQpCc2w1C7YQ0n9EKEh79=KYKQDFWLWtpA@mail.gmail.com>
 <781872AE-13EB-421F-BCB7-9B1E10E65BE4@gmail.com>
 <46154037-39EA-4F75-9DE5-1D538FEEFAD7@gmail.com>
 <CA+Y8hcMS0gHUx8nUBcY6pvRCvvU3=XrZmNDk9kuadCenf8JWhA@mail.gmail.com>
 <7248A189-C8F6-4B5D-AFDF-6E994C3EF099@gmail.com>
 <3E0B3A1C-FE5A-4875-B6DA-48D34387FC17@gmail.com>
Message-ID: <ZrDOtymiM_UXsPO5@fantomas.sk>

On 01.08.24 13:14, Jonathan Lee wrote:
>cachemgr_passwd
>does not allow the ability to add a username right?

This has been answered multiple times, but perhaps logs in the flood of 
mail:

You can use any username because it is ignored.

Please, check your config once more.

Is it possible that you (indirectly) deny access to cache manager before you allow 
it, thus it's always refused?

Don't you have line that denies access from the machine you try to access 
before config lines like these?

# grep \^http_access /etc/squid/squid.conf

http_access deny !Safe_ports
http_access deny CONNECT !SSL_ports
http_access allow localhost manager
http_access allow manager <machine>
http_access deny manager
http_access deny to_localhost
http_access allow <...>
http_access deny all


-- 
Matus UHLAR - fantomas, uhlar at fantomas.sk ; http://www.fantomas.sk/
Warning: I wish NOT to receive e-mail advertising to this address.
Varovanie: na tuto adresu chcem NEDOSTAVAT akukolvek reklamnu postu.
Spam = (S)tupid (P)eople's (A)dvertising (M)ethod


From taku0919.taku at gmail.com  Wed Aug  7 00:59:10 2024
From: taku0919.taku at gmail.com (=?UTF-8?B?44Gr44Gw?=)
Date: Wed, 7 Aug 2024 09:59:10 +0900
Subject: [squid-users] Questions about Squid configuration
Message-ID: <CAK0+96e5Wpq3LpE4pf8k38nUpsmg+nyyocbOmnXS6=fqR+3C0g@mail.gmail.com>

Dear Squid Community

Nice to meet you. I am a newbie who just recently started using Squid.
I have a question about Squid configuration.
If there is any missing information or clarification, please let me know...

?Questions
When using Squid transparently, is it possible to control the
whitelist of the domain to connect to and inspect the Host field in
the request header together?
According to the verification results, the Host field can be inspected
by "host_verify_strict on" in squid-transparent.conf, but it seems
that the whitelist is not controlled.

?Requirements
?Proxy shall be transparently configured to accommodate clients that
cannot configure proxy settings.
?Communication is possible only with authorized domains using the
whitelist method.
?Whitelists are managed by domain, not IP address.
?Check the Host field in the request header and reject communication
if the value is invalid.
?If the actual destination IP is different from the result of name
resolution of the FQDN specified by SNI, communication is denied.

?Environment
server?AWS EC2
platform?Amazon Linux
Squid Cache?Version 4.15

?Configuration Details
?squid-transparent.conf?Excerpts?
#Whitelist
acl whitelist dstdomain "/etc/squid/whitelist"
acl whitelist dstdomain "/etc/squid/whitelist_transparent"
acl whitelist_https dstdomain "/etc/squid/whitelist_https"
acl whitelist_transparent_https dstdomain
"/etc/squid/whitelist_transparent_https"

proxy_protocol_access allow localnet
proxy_protocol_access deny all
http_access allow localnet whitelist
http_access deny localnet whitelist_https !https_port
http_access deny localnet whitelist_transparent_https !https_port

# Handling HTTP requests
http_port 3129 intercept
# Handling HTTPS requests
https_port 3130 intercept tcpkeepalive=60,30,3 ssl-bump
generate-host-certificates=on dynamic_cert_mem_cache_size=20MB
tls-cert=/etc/squid/ssl/squid.crt tls-key=/etc/squid/ssl/squid.key
cipher=HIGH:MEDIUM:!LOW:!RC4:!SEED:!IDEA:!3DES:!MD5:!EXP:!PSK:!DSS
options=NO_TLSv1,NO_SSLv3,SINGLE_DH_USE,SINGLE_ECDH_USE
tls-dh=prime256v1:/etc/squid/ssl/bump_dhparam.pem
# Start up for squid process
http_port 3131
http_access allow https_port
acl allowed_https_sites ssl::server_name "/etc/squid/whitelist"
acl allowed_https_sites ssl::server_name "/etc/squid/whitelist_transparent"
acl allowed_https_sites ssl::server_name "/etc/squid/whitelist_https"
acl allowed_https_sites ssl::server_name
"/etc/squid/whitelist_transparent_https"

http_access deny all

# strict setting
host_verify_strict on

# SSL_BUMP
sslcrtd_program /usr/lib64/squid/security_file_certgen -s
/var/lib/squid/ssl_db -M 20MB
acl step1 at_step SslBump1
acl step2 at_step SslBump2
acl step3 at_step SslBump3

ssl_bump bump all


?/etc/squid/whitelist
.pypi.org


?Verification of Settings
I ran the curl command from each of the client environments that use Squid.
1. if SNI, Destination IP, and HeaderHost are correct, the user should
be able to connect to pypi.org
Command:
date;curl https://pypi.org/ -v --cacert squid_2.crt -k
Result: OK

2. rejection of communication to pypi.org if SNI is correct but
destination IP and HeaderHost are incorrect
Command:
date;curl https://pypi.org/ --resolve pypi.org:443:182.22.24.252 -H
"Host: www.yahoo.co.jp"  -v --cacert squid_2.crt -k
Result: OK (409 Conflict is returned)

3. rejection of communication to pypi.org if SNI and destination IP
are correct and HeaderHost is incorrect
Command:
date;curl https://pypi.org/ -H "Host: www.yahoo.co.jp" -v --cacert
squid_2.crt -k
Result: OK (409 Confilic returned)

4. rejection of communication to pypi.org if SNI and HeaderHost are
correct but destination IP is incorrect
Command:
date;curl https://pypi.org/ --resolve pypi.org:443:182.22.24.252 -v
--cacert squid_2.crt -k
Result: OK (409 Confilic returned)

5. if SNI, destination IP, and HeaderHost are all invalid (yahoo.co.jp
not registered in whitelist), communication will be rejected
Command:
date;curl https://yahoo.co.jp/ -v --cacert squid_2.crt -k
Result: NG (301 Moved Permanently is returned, but it appears that the
communication is reaching yahoo.co.jp)


From uhlar at fantomas.sk  Wed Aug  7 17:05:26 2024
From: uhlar at fantomas.sk (Matus UHLAR - fantomas)
Date: Wed, 7 Aug 2024 19:05:26 +0200
Subject: [squid-users] squid 5.7 FTP upload fails
Message-ID: <ZrOpVqKIJZ3aww_Q@fantomas.sk>

Hello,

after we upgraded squid 4.13 to squid 5.7 (debian 11 to 12)
our user reported that attempring to uploading bigger files fails.

I was able to reproduce this behaviour:

# time curl --no-progress-meter -x 10.X.Y.Z:port -T gnome-cards-data_3.22.23-1_all.deb -u "anonymous:proxy1 at example.com" ftp://example.net/incoming/
curl: (56) Recv failure: Connection reset by peer

real    0m1.041s
user    0m0.008s
sys     0m0.008s

-rw-r----- 1 ftpd ftpd 1468896 Aug  7 18:21 gnome-cards-data_3.22.23-1_all.deb

# time curl --no-progress-meter -x 10.X.Y.Z:port -T gnome-cards-data_3.22.23-1_all.deb -u "anonymous:proxy1 at example.com" ftp://example.net/incoming/
curl: (56) Recv failure: Connection reset by peer

real    0m1.044s
user    0m0.008s
sys     0m0.008s

-rw-r----- 1 ftpd ftpd 1768488 Aug  7 18:21 gnome-cards-data_3.22.23-1_all.deb

Using squid 4.13 (same network, debian 11 server) works. 


1723047707.274   1031 10.X.Y.W TCP_MISS_ABORTED/000 0 PUT ftp://anonymous:proxy1%40example.com at example.net/incoming/gnome-cards-data_3.22.23-1_all.deb - HIER_DIRECT/192.0.2.1 - "curl/7.74.0"


I tried verbose curl output did not help:

# time curl -v --no-progress-meter -x 10.X.Y.Z:port -T gnome-cards-data_3.22.23-1_all.deb -u "anonymous:proxy1 at example.com" ftp://example.net/incoming/
*   Trying 10.X.Y.Z:port...
* Connected to 10.X.Y.Z (10.X.Y.Z) port port (#0)
* Server auth using Basic with user 'anonymous'
> PUT ftp://anonymous:proxy1%40example.com at example.net/incoming/gnome-cards-data_3.22.23-1_all.deb HTTP/1.1
> Host: example.net:21
> Authorization: Basic YW5vbnltb3VzOnByb3h5MUB2c3pwLnNr
> User-Agent: curl/7.74.0
> Accept: */*
> Proxy-Connection: Keep-Alive
> Content-Length: 10526800
> Expect: 100-continue
>
* Done waiting for 100-continue
} [65536 bytes data]
* Recv failure: Connection reset by peer
* Closing connection 0
curl: (56) Recv failure: Connection reset by peer

real    0m1.043s
user    0m0.004s
sys     0m0.012s



I have tried to extend the 100-continue timeout for curl, no change.
(approximately same file sizes, same error only after 10 seconds)

configuring "force_request_body_continuation allow all" did not help,
the error occured immediately:

# time curl -v --no-progress-meter -x 10.X.Y.Z:port -T gnome-cards-data_3.22.23-1_all.deb -u "anonymous:proxy1 at example.com" ftp://example.net/incoming/
*   Trying 10.X.Y.Z:port...
* Connected to 10.X.Y.Z (10.X.Y.Z) port port (#0)
* Server auth using Basic with user 'anonymous'
> PUT ftp://anonymous:proxy1%40example.com at example.net/incoming/gnome-cards-data_3.22.23-1_all.deb HTTP/1.1
> Host: example.net:21
> Authorization: Basic YW5vbnltb3VzOnByb3h5MUB2c3pwLnNr
> User-Agent: curl/7.74.0
> Accept: */*
> Proxy-Connection: Keep-Alive
> Content-Length: 10526800
> Expect: 100-continue
>
* Mark bundle as not supporting multiuse
< HTTP/1.1 100 Continue
< Connection: keep-alive
} [65536 bytes data]
* Send failure: Broken pipe
* Closing connection 0
curl: (55) Send failure: Broken pipe

real    0m0.152s
user    0m0.005s
sys     0m0.009s

1723050086.883    139 10.X.Y.W TCP_MISS_ABORTED/100 0 PUT ftp://anonymous:proxy1%40example.com at example.net/incoming/gnome-cards-data_3.22.23-1_all.deb - HIER_DIRECT/192.0.2.1 - "curl/7.74.0"

Any idea what can be wrong?
CURL 8.8.0 from debian backports did not help as well.

-- 
Matus UHLAR - fantomas, uhlar at fantomas.sk ; http://www.fantomas.sk/
Warning: I wish NOT to receive e-mail advertising to this address.
Varovanie: na tuto adresu chcem NEDOSTAVAT akukolvek reklamnu postu.
Save the whales. Collect the whole set.


From rousskov at measurement-factory.com  Wed Aug  7 18:31:09 2024
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Wed, 7 Aug 2024 14:31:09 -0400
Subject: [squid-users] squid 5.7 FTP upload fails
In-Reply-To: <ZrOpVqKIJZ3aww_Q@fantomas.sk>
References: <ZrOpVqKIJZ3aww_Q@fantomas.sk>
Message-ID: <81aabaf4-2951-45e9-99f5-cf8e2d0a69d3@measurement-factory.com>

On 2024-08-07 13:05, Matus UHLAR - fantomas wrote:

> after we upgraded squid 4.13 to squid 5.7 (debian 11 to 12)
> our user reported that attempring to uploading bigger files fails.

Thank you for sharing access.log records. Any relevant messages in 
cache.log?

There were a few bug fixes related to FTP and uploads, but I do not see 
some of them in (unsupported) v5. Does your test work with Squid v6+?

Alex.


> I was able to reproduce this behaviour:
> 
> # time curl --no-progress-meter -x 10.X.Y.Z:port -T 
> gnome-cards-data_3.22.23-1_all.deb -u "anonymous:proxy1 at example.com" 
> ftp://example.net/incoming/
> curl: (56) Recv failure: Connection reset by peer
> 
> real??? 0m1.041s
> user??? 0m0.008s
> sys???? 0m0.008s
> 
> -rw-r----- 1 ftpd ftpd 1468896 Aug? 7 18:21 
> gnome-cards-data_3.22.23-1_all.deb
> 
> # time curl --no-progress-meter -x 10.X.Y.Z:port -T 
> gnome-cards-data_3.22.23-1_all.deb -u "anonymous:proxy1 at example.com" 
> ftp://example.net/incoming/
> curl: (56) Recv failure: Connection reset by peer
> 
> real??? 0m1.044s
> user??? 0m0.008s
> sys???? 0m0.008s
> 
> -rw-r----- 1 ftpd ftpd 1768488 Aug? 7 18:21 
> gnome-cards-data_3.22.23-1_all.deb
> 
> Using squid 4.13 (same network, debian 11 server) works.
> 
> 1723047707.274?? 1031 10.X.Y.W TCP_MISS_ABORTED/000 0 PUT 
> ftp://anonymous:proxy1%40example.com at example.net/incoming/gnome-cards-data_3.22.23-1_all.deb - HIER_DIRECT/192.0.2.1 - "curl/7.74.0"
> 
> 
> I tried verbose curl output did not help:
> 
> # time curl -v --no-progress-meter -x 10.X.Y.Z:port -T 
> gnome-cards-data_3.22.23-1_all.deb -u "anonymous:proxy1 at example.com" 
> ftp://example.net/incoming/
> *?? Trying 10.X.Y.Z:port...
> * Connected to 10.X.Y.Z (10.X.Y.Z) port port (#0)
> * Server auth using Basic with user 'anonymous'
>> PUT 
>> ftp://anonymous:proxy1%40example.com at example.net/incoming/gnome-cards-data_3.22.23-1_all.deb HTTP/1.1
>> Host: example.net:21
>> Authorization: Basic YW5vbnltb3VzOnByb3h5MUB2c3pwLnNr
>> User-Agent: curl/7.74.0
>> Accept: */*
>> Proxy-Connection: Keep-Alive
>> Content-Length: 10526800
>> Expect: 100-continue
>>
> * Done waiting for 100-continue
> } [65536 bytes data]
> * Recv failure: Connection reset by peer
> * Closing connection 0
> curl: (56) Recv failure: Connection reset by peer
> 
> real??? 0m1.043s
> user??? 0m0.004s
> sys???? 0m0.012s
> 
> 
> 
> I have tried to extend the 100-continue timeout for curl, no change.
> (approximately same file sizes, same error only after 10 seconds)
> 
> configuring "force_request_body_continuation allow all" did not help,
> the error occured immediately:
> 
> # time curl -v --no-progress-meter -x 10.X.Y.Z:port -T 
> gnome-cards-data_3.22.23-1_all.deb -u "anonymous:proxy1 at example.com" 
> ftp://example.net/incoming/
> *?? Trying 10.X.Y.Z:port...
> * Connected to 10.X.Y.Z (10.X.Y.Z) port port (#0)
> * Server auth using Basic with user 'anonymous'
>> PUT 
>> ftp://anonymous:proxy1%40example.com at example.net/incoming/gnome-cards-data_3.22.23-1_all.deb HTTP/1.1
>> Host: example.net:21
>> Authorization: Basic YW5vbnltb3VzOnByb3h5MUB2c3pwLnNr
>> User-Agent: curl/7.74.0
>> Accept: */*
>> Proxy-Connection: Keep-Alive
>> Content-Length: 10526800
>> Expect: 100-continue
>>
> * Mark bundle as not supporting multiuse
> < HTTP/1.1 100 Continue
> < Connection: keep-alive
> } [65536 bytes data]
> * Send failure: Broken pipe
> * Closing connection 0
> curl: (55) Send failure: Broken pipe
> 
> real??? 0m0.152s
> user??? 0m0.005s
> sys???? 0m0.009s
> 
> 1723050086.883??? 139 10.X.Y.W TCP_MISS_ABORTED/100 0 PUT 
> ftp://anonymous:proxy1%40example.com at example.net/incoming/gnome-cards-data_3.22.23-1_all.deb - HIER_DIRECT/192.0.2.1 - "curl/7.74.0"
> 
> Any idea what can be wrong?
> CURL 8.8.0 from debian backports did not help as well.
> 



From uhlar at fantomas.sk  Thu Aug  8 10:19:51 2024
From: uhlar at fantomas.sk (Matus UHLAR - fantomas)
Date: Thu, 8 Aug 2024 12:19:51 +0200
Subject: [squid-users] squid 5.7 FTP upload fails
In-Reply-To: <81aabaf4-2951-45e9-99f5-cf8e2d0a69d3@measurement-factory.com>
References: <ZrOpVqKIJZ3aww_Q@fantomas.sk>
 <81aabaf4-2951-45e9-99f5-cf8e2d0a69d3@measurement-factory.com>
Message-ID: <ZrSbx_Q6VQAfdH66@fantomas.sk>

>On 2024-08-07 13:05, Matus UHLAR - fantomas wrote:
>>after we upgraded squid 4.13 to squid 5.7 (debian 11 to 12)
>>our user reported that attempring to uploading bigger files fails.

On 07.08.24 14:31, Alex Rousskov wrote:
>Thank you for sharing access.log records. Any relevant messages in 
>cache.log?

No. Perhaps configuring proper debug_options, but which?

>There were a few bug fixes related to FTP and uploads, but I do not 
>see some of them in (unsupported) v5. Does your test work with Squid 
>v6+?

I tried with squid 6.10 (manually backported from debian unstable).
The same behaviour.

>># time curl -v --no-progress-meter -x 10.X.Y.Z:port -T 
>>gnome-cards-data_3.22.23-1_all.deb -u "anonymous:proxy1 at example.com" 
>>ftp://example.net/incoming/
>>*?? Trying 10.X.Y.Z:port...
>>* Connected to 10.X.Y.Z (10.X.Y.Z) port port (#0)
>>* Server auth using Basic with user 'anonymous'
>>>PUT ftp://anonymous:proxy1%40example.com at example.net/incoming/gnome-cards-data_3.22.23-1_all.deb 
>>>HTTP/1.1
>>>Host: example.net:21
>>>Authorization: Basic YW5vbnltb3VzOnByb3h5MUB2c3pwLnNr
>>>User-Agent: curl/7.74.0
>>>Accept: */*
>>>Proxy-Connection: Keep-Alive
>>>Content-Length: 10526800
>>>Expect: 100-continue
>>>
>>* Done waiting for 100-continue
>>} [65536 bytes data]
>>* Recv failure: Connection reset by peer
>>* Closing connection 0
>>curl: (56) Recv failure: Connection reset by peer
>>
>>real??? 0m1.043s
>>user??? 0m0.004s
>>sys???? 0m0.012s

-- 
Matus UHLAR - fantomas, uhlar at fantomas.sk ; http://www.fantomas.sk/
Warning: I wish NOT to receive e-mail advertising to this address.
Varovanie: na tuto adresu chcem NEDOSTAVAT akukolvek reklamnu postu.
The early bird may get the worm, but the second mouse gets the cheese.


From rousskov at measurement-factory.com  Thu Aug  8 12:15:37 2024
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Thu, 8 Aug 2024 08:15:37 -0400
Subject: [squid-users] squid 5.7 FTP upload fails
In-Reply-To: <ZrSbx_Q6VQAfdH66@fantomas.sk>
References: <ZrOpVqKIJZ3aww_Q@fantomas.sk>
 <81aabaf4-2951-45e9-99f5-cf8e2d0a69d3@measurement-factory.com>
 <ZrSbx_Q6VQAfdH66@fantomas.sk>
Message-ID: <2db0d2c5-cb6e-4b0b-a6f1-221b6d5a6e5b@measurement-factory.com>

On 2024-08-08 06:19, Matus UHLAR - fantomas wrote:
>> On 2024-08-07 13:05, Matus UHLAR - fantomas wrote:
>>> after we upgraded squid 4.13 to squid 5.7 (debian 11 to 12)
>>> our user reported that attempring to uploading bigger files fails.
> 
> On 07.08.24 14:31, Alex Rousskov wrote:
>> Thank you for sharing access.log records. Any relevant messages in 
>> cache.log?
> 
> No. 

Thank you for answering all of my questions.


> Perhaps configuring proper debug_options, but which?

Yes, we should escalate triage to debugging log analysis. I am willing 
to study your ALL,9 cache.log collected from Squid v6 while reproducing 
the problem using a single transaction (or as few transactions as 
possible). Please share a pointer to compressed cache.log file 
(privately of needed). You probably do not need them, but there are a 
few relevant hints at 
https://wiki.squid-cache.org/SquidFaq/BugReporting#debugging-a-single-transaction


Thank you,

Alex.


>> There were a few bug fixes related to FTP and uploads, but I do not 
>> see some of them in (unsupported) v5. Does your test work with Squid v6+?
> 
> I tried with squid 6.10 (manually backported from debian unstable).
> The same behaviour.
> 
>>> # time curl -v --no-progress-meter -x 10.X.Y.Z:port -T 
>>> gnome-cards-data_3.22.23-1_all.deb -u "anonymous:proxy1 at example.com" 
>>> ftp://example.net/incoming/
>>> *?? Trying 10.X.Y.Z:port...
>>> * Connected to 10.X.Y.Z (10.X.Y.Z) port port (#0)
>>> * Server auth using Basic with user 'anonymous'
>>>> PUT 
>>>> ftp://anonymous:proxy1%40example.com at example.net/incoming/gnome-cards-data_3.22.23-1_all.deb HTTP/1.1
>>>> Host: example.net:21
>>>> Authorization: Basic YW5vbnltb3VzOnByb3h5MUB2c3pwLnNr
>>>> User-Agent: curl/7.74.0
>>>> Accept: */*
>>>> Proxy-Connection: Keep-Alive
>>>> Content-Length: 10526800
>>>> Expect: 100-continue
>>>>
>>> * Done waiting for 100-continue
>>> } [65536 bytes data]
>>> * Recv failure: Connection reset by peer
>>> * Closing connection 0
>>> curl: (56) Recv failure: Connection reset by peer
>>>
>>> real??? 0m1.043s
>>> user??? 0m0.004s
>>> sys???? 0m0.012s
> 



From rousskov at measurement-factory.com  Thu Aug  8 12:32:55 2024
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Thu, 8 Aug 2024 08:32:55 -0400
Subject: [squid-users] Questions about Squid configuration
In-Reply-To: <CAK0+96e5Wpq3LpE4pf8k38nUpsmg+nyyocbOmnXS6=fqR+3C0g@mail.gmail.com>
References: <CAK0+96e5Wpq3LpE4pf8k38nUpsmg+nyyocbOmnXS6=fqR+3C0g@mail.gmail.com>
Message-ID: <add1024b-da05-46ba-9574-fd8048ec4fa1@measurement-factory.com>

On 2024-08-06 20:59, ?? wrote:

> When using Squid transparently, is it possible to control the
> whitelist of the domain to connect to and inspect the Host field in
> the request header together?

Short answer: Yes.


> According to the verification results, the Host field can be inspected
> by "host_verify_strict on" in squid-transparent.conf, but it seems
> that the whitelist is not controlled.

AFAICT, the configuration you have shared allows all banned[1] traffic 
to/through https_port. For the problematic test case #5:

All these http_access rules do _not_ match:

> http_access allow localnet whitelist
> http_access deny localnet whitelist_https !https_port
> http_access deny localnet whitelist_transparent_https !https_port


And then this next rule matches and allows traffic through:

> http_access allow https_port


This last http_access rule is not reached:

> http_access deny all


N.B. The above analysis assumes that your https_port ACL is explicitly 
defined in your squid.conf to match all traffic received at https_port. 
If you do not have such an ACL defined, then you need to fix that 
problem as well. I recommend naming ACLs differently from directive 
names (e.g., "toHttpsPort" rather than "https_port").


Please note that Squid v4 is not supported by the Squid Project and is 
very buggy. I recommend using Squid v6 or later.


HTH,

Alex.
[1] Here, "banned" means "_not_ matching whitelist ACL".


> ?Configuration Details
> ?squid-transparent.conf?Excerpts?
> #Whitelist
> acl whitelist dstdomain "/etc/squid/whitelist"
> acl whitelist dstdomain "/etc/squid/whitelist_transparent"
> acl whitelist_https dstdomain "/etc/squid/whitelist_https"
> acl whitelist_transparent_https dstdomain
> "/etc/squid/whitelist_transparent_https"
> 
> proxy_protocol_access allow localnet
> proxy_protocol_access deny all
> http_access allow localnet whitelist
> http_access deny localnet whitelist_https !https_port
> http_access deny localnet whitelist_transparent_https !https_port
> 
> # Handling HTTP requests
> http_port 3129 intercept
> # Handling HTTPS requests
> https_port 3130 intercept tcpkeepalive=60,30,3 ssl-bump
> generate-host-certificates=on dynamic_cert_mem_cache_size=20MB
> tls-cert=/etc/squid/ssl/squid.crt tls-key=/etc/squid/ssl/squid.key
> cipher=HIGH:MEDIUM:!LOW:!RC4:!SEED:!IDEA:!3DES:!MD5:!EXP:!PSK:!DSS
> options=NO_TLSv1,NO_SSLv3,SINGLE_DH_USE,SINGLE_ECDH_USE
> tls-dh=prime256v1:/etc/squid/ssl/bump_dhparam.pem
> # Start up for squid process
> http_port 3131
> http_access allow https_port
> acl allowed_https_sites ssl::server_name "/etc/squid/whitelist"
> acl allowed_https_sites ssl::server_name "/etc/squid/whitelist_transparent"
> acl allowed_https_sites ssl::server_name "/etc/squid/whitelist_https"
> acl allowed_https_sites ssl::server_name
> "/etc/squid/whitelist_transparent_https"
> 
> http_access deny all
> 
> # strict setting
> host_verify_strict on
> 
> # SSL_BUMP
> sslcrtd_program /usr/lib64/squid/security_file_certgen -s
> /var/lib/squid/ssl_db -M 20MB
> acl step1 at_step SslBump1
> acl step2 at_step SslBump2
> acl step3 at_step SslBump3
> 
> ssl_bump bump all


> ?Verification of Settings
> I ran the curl command from each of the client environments that use Squid.
> 1. if SNI, Destination IP, and HeaderHost are correct, the user should
> be able to connect to pypi.org
> Command:
> date;curl https://pypi.org/ -v --cacert squid_2.crt -k
> Result: OK
> 
> 2. rejection of communication to pypi.org if SNI is correct but
> destination IP and HeaderHost are incorrect
> Command:
> date;curl https://pypi.org/ --resolve pypi.org:443:182.22.24.252 -H
> "Host: www.yahoo.co.jp"  -v --cacert squid_2.crt -k
> Result: OK (409 Conflict is returned)
> 
> 3. rejection of communication to pypi.org if SNI and destination IP
> are correct and HeaderHost is incorrect
> Command:
> date;curl https://pypi.org/ -H "Host: www.yahoo.co.jp" -v --cacert
> squid_2.crt -k
> Result: OK (409 Confilic returned)
> 
> 4. rejection of communication to pypi.org if SNI and HeaderHost are
> correct but destination IP is incorrect
> Command:
> date;curl https://pypi.org/ --resolve pypi.org:443:182.22.24.252 -v
> --cacert squid_2.crt -k
> Result: OK (409 Confilic returned)
> 
> 5. if SNI, destination IP, and HeaderHost are all invalid (yahoo.co.jp
> not registered in whitelist), communication will be rejected
> Command:
> date;curl https://yahoo.co.jp/ -v --cacert squid_2.crt -k
> Result: NG (301 Moved Permanently is returned, but it appears that the
> communication is reaching yahoo.co.jp)






From uhlar at fantomas.sk  Thu Aug  8 14:53:39 2024
From: uhlar at fantomas.sk (Matus UHLAR - fantomas)
Date: Thu, 8 Aug 2024 16:53:39 +0200
Subject: [squid-users] squid 5.7 FTP upload fails
In-Reply-To: <2db0d2c5-cb6e-4b0b-a6f1-221b6d5a6e5b@measurement-factory.com>
References: <ZrOpVqKIJZ3aww_Q@fantomas.sk>
 <81aabaf4-2951-45e9-99f5-cf8e2d0a69d3@measurement-factory.com>
 <ZrSbx_Q6VQAfdH66@fantomas.sk>
 <2db0d2c5-cb6e-4b0b-a6f1-221b6d5a6e5b@measurement-factory.com>
Message-ID: <ZrTb84bGqYN24GoY@fantomas.sk>

>On 2024-08-08 06:19, Matus UHLAR - fantomas wrote:
>>Perhaps configuring proper debug_options, but which?

On 08.08.24 08:15, Alex Rousskov wrote:
>Yes, we should escalate triage to debugging log analysis. I am willing 
>to study your ALL,9 cache.log collected from Squid v6 while 
>reproducing the problem using a single transaction (or as few 
>transactions as possible). Please share a pointer to compressed 
>cache.log file (privately of needed). You probably do not need them, 
>but there are a few relevant hints at https://wiki.squid-cache.org/SquidFaq/BugReporting#debugging-a-single-transaction
>
>
>Thank you,

well, you are helping me...

The bad news is that "debug_options ALL,9" caused test upload to succeed
(multiple attempts). After commenting it out it fails again.

and that was single transaction.

I founbd out that with:

debug_options 33,9

- mostly succeeds, sometimes crashes.

however the "* We are completely uploaded and fine" message is new here
(but doesn't appear all the time)

I also tried 9,9 without success.


Could errors like this be caused by something like lacking fflush() on socket?



# curl -v --no-progress-meter -x 192.168.A.B:3128 -T cruft.out.gz -u "anonymous:dummy at example.net" ftp://example.net/incoming/
*   Trying 192.168.A.B:3128...
* Connected to 192.168.A.B (192.168.A.B) port 3128 (#0)
* Server auth using Basic with user 'anonymous'
> PUT ftp://anonymous:dummy%40example.net at example.net/incoming/cruft.out.gz HTTP/1.1
> Host: example.net:21
> Authorization: Basic YW5vbnltb3VzOmR1bW15QGV4YW1wbGUubmV0
> User-Agent: curl/7.88.1
> Accept: */*
> Proxy-Connection: Keep-Alive
> Content-Length: 10438601
> Expect: 100-continue
>
* Done waiting for 100-continue
} [65536 bytes data]
* We are completely uploaded and fine
* Recv failure: Connection reset by peer
* Closing connection 0
curl: (56) Recv failure: Connection reset by peer




-- 
Matus UHLAR - fantomas, uhlar at fantomas.sk ; http://www.fantomas.sk/
Warning: I wish NOT to receive e-mail advertising to this address.
Varovanie: na tuto adresu chcem NEDOSTAVAT akukolvek reklamnu postu.
Despite the cost of living, have you noticed how popular it remains?


From rousskov at measurement-factory.com  Thu Aug  8 17:13:59 2024
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Thu, 8 Aug 2024 13:13:59 -0400
Subject: [squid-users] squid 5.7 FTP upload fails
In-Reply-To: <ZrTb84bGqYN24GoY@fantomas.sk>
References: <ZrOpVqKIJZ3aww_Q@fantomas.sk>
 <81aabaf4-2951-45e9-99f5-cf8e2d0a69d3@measurement-factory.com>
 <ZrSbx_Q6VQAfdH66@fantomas.sk>
 <2db0d2c5-cb6e-4b0b-a6f1-221b6d5a6e5b@measurement-factory.com>
 <ZrTb84bGqYN24GoY@fantomas.sk>
Message-ID: <b3a43edb-4161-4142-8140-cf369524ccb5@measurement-factory.com>

On 2024-08-08 10:53, Matus UHLAR - fantomas wrote:
>> On 2024-08-08 06:19, Matus UHLAR - fantomas wrote:
>>> Perhaps configuring proper debug_options, but which?
> 
> On 08.08.24 08:15, Alex Rousskov wrote:
>> Yes, we should escalate triage to debugging log analysis. I am willing 
>> to study your ALL,9 cache.log collected from Squid v6 while 
>> reproducing the problem using a single transaction (or as few 
>> transactions as possible). Please share a pointer to compressed 
>> cache.log file (privately of needed). You probably do not need them, 
>> but there are a few relevant hints at 
>> https://wiki.squid-cache.org/SquidFaq/BugReporting#debugging-a-single-transaction

> The bad news is that "debug_options ALL,9" caused test upload to succeed
> (multiple attempts). After commenting it out it fails again.

You are probably dealing with a race condition of some kind, but I would 
prefer not to speculate about the nature of this bug at this time.

Please try "ALL,3 33,5 9,5". Slowly decrease "5"s until you can 
reproduce. Share the log from that test.

Please note that we do not need to have a reliable test at this point. 
We only need a single test run that reproduces the problem (with enough 
debugging enabled). Once we know more about the bug, we may be able to 
either fix it or adjust debugging instructions to ease reproduction...


> however the "* We are completely uploaded and fine" message is new here
> (but doesn't appear all the time)

Ideally, we want debugging cache.log from a failed test without that 
message, but we can start with a test that does have one if that is the 
only one you can produce right now.

Cheers,

Alex.


> I also tried 9,9 without success.
> 
> 
> Could errors like this be caused by something like lacking fflush() on 
> socket?
> 
> 
> 
> # curl -v --no-progress-meter -x 192.168.A.B:3128 -T cruft.out.gz -u 
> "anonymous:dummy at example.net" ftp://example.net/incoming/
> *?? Trying 192.168.A.B:3128...
> * Connected to 192.168.A.B (192.168.A.B) port 3128 (#0)
> * Server auth using Basic with user 'anonymous'
>> PUT 
>> ftp://anonymous:dummy%40example.net at example.net/incoming/cruft.out.gz 
>> HTTP/1.1
>> Host: example.net:21
>> Authorization: Basic YW5vbnltb3VzOmR1bW15QGV4YW1wbGUubmV0
>> User-Agent: curl/7.88.1
>> Accept: */*
>> Proxy-Connection: Keep-Alive
>> Content-Length: 10438601
>> Expect: 100-continue
>>
> * Done waiting for 100-continue
> } [65536 bytes data]
> * We are completely uploaded and fine
> * Recv failure: Connection reset by peer
> * Closing connection 0
> curl: (56) Recv failure: Connection reset by peer
> 
> 
> 
> 



From uhlar at fantomas.sk  Fri Aug  9 13:03:22 2024
From: uhlar at fantomas.sk (Matus UHLAR - fantomas)
Date: Fri, 9 Aug 2024 15:03:22 +0200
Subject: [squid-users] squid 5.7 FTP upload fails
In-Reply-To: <b3a43edb-4161-4142-8140-cf369524ccb5@measurement-factory.com>
References: <ZrOpVqKIJZ3aww_Q@fantomas.sk>
 <81aabaf4-2951-45e9-99f5-cf8e2d0a69d3@measurement-factory.com>
 <ZrSbx_Q6VQAfdH66@fantomas.sk>
 <2db0d2c5-cb6e-4b0b-a6f1-221b6d5a6e5b@measurement-factory.com>
 <ZrTb84bGqYN24GoY@fantomas.sk>
 <b3a43edb-4161-4142-8140-cf369524ccb5@measurement-factory.com>
Message-ID: <ZrYTmos7dTVP_spx@fantomas.sk>

>On 2024-08-08 10:53, Matus UHLAR - fantomas wrote:
>>The bad news is that "debug_options ALL,9" caused test upload to succeed
>>(multiple attempts). After commenting it out it fails again.

On 08.08.24 13:13, Alex Rousskov wrote:
>You are probably dealing with a race condition of some kind, but I 
>would prefer not to speculate about the nature of this bug at this 
>time.
>
>Please try "ALL,3 33,5 9,5". Slowly decrease "5"s until you can 
>reproduce. Share the log from that test.
>
>Please note that we do not need to have a reliable test at this point. 
>We only need a single test run that reproduces the problem (with 
>enough debugging enabled). Once we know more about the bug, we may be 
>able to either fix it or adjust debugging instructions to ease 
>reproduction...
>
>
>>however the "* We are completely uploaded and fine" message is new here
>>(but doesn't appear all the time)
>
>Ideally, we want debugging cache.log from a failed test without that 
>message, but we can start with a test that does have one if that is 
>the only one you can produce right now.

FTR, I sent the info privately, but we can continue discussing/solving it 
here.

-- 
Matus UHLAR - fantomas, uhlar at fantomas.sk ; http://www.fantomas.sk/
Warning: I wish NOT to receive e-mail advertising to this address.
Varovanie: na tuto adresu chcem NEDOSTAVAT akukolvek reklamnu postu.
Atheism is a non-prophet organization.


From rousskov at measurement-factory.com  Fri Aug  9 13:51:29 2024
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Fri, 9 Aug 2024 09:51:29 -0400
Subject: [squid-users] squid 5.7 FTP upload fails
In-Reply-To: <ZrYTmos7dTVP_spx@fantomas.sk>
References: <ZrOpVqKIJZ3aww_Q@fantomas.sk>
 <81aabaf4-2951-45e9-99f5-cf8e2d0a69d3@measurement-factory.com>
 <ZrSbx_Q6VQAfdH66@fantomas.sk>
 <2db0d2c5-cb6e-4b0b-a6f1-221b6d5a6e5b@measurement-factory.com>
 <ZrTb84bGqYN24GoY@fantomas.sk>
 <b3a43edb-4161-4142-8140-cf369524ccb5@measurement-factory.com>
 <ZrYTmos7dTVP_spx@fantomas.sk>
Message-ID: <0ebd735b-1655-4cfe-8a83-53e871bd3330@measurement-factory.com>

On 2024-08-09 09:03, Matus UHLAR - fantomas wrote:

> FTR, I sent the info privately, but we can continue discussing/solving 
> it here.

> maybeMakeSpaceAvailable: request buffer full: client_request_buffer_max_size=524288
> ReadNow: ... size 0, retval 0, errno 0
> terminateAll: 1/1 after ERR_CLIENT_GONE/WITH_CLIENT

AFAICT, you are suffering from a Squid bug that goes back to 2015 commit 
4d1376d7 (that was fixing Squid bug 4206) or even earlier code. Red 
flags were raised back in 2015, but nobody followed through. We need to 
refactor Server::maybeMakeSpaceAvailable()-related code to fix this bug.

FWIW, we did similar work for Squid-to-peer communication in commit 
cc8b26f9 and commit 50c5af88. Similar principles should apply to 
client-Squid communication. Unfortunately, I do not have enough free 
time to volunteer to fix this client-Squid bug now.

At the expense of using more memory for some upload cases, you may be 
able to work around the bug in some (but not all!) cases by making 
client_request_buffer_max_size sufficiently large. For example, setting 
client_request_buffer_max_size to 16 megabytes may allow you to pass the 
test case you have privately shared.


HTH,

Alex.



From uhlar at fantomas.sk  Fri Aug  9 16:59:17 2024
From: uhlar at fantomas.sk (Matus UHLAR - fantomas)
Date: Fri, 9 Aug 2024 18:59:17 +0200
Subject: [squid-users] squid 5.7 FTP upload fails
In-Reply-To: <0ebd735b-1655-4cfe-8a83-53e871bd3330@measurement-factory.com>
References: <ZrOpVqKIJZ3aww_Q@fantomas.sk>
 <81aabaf4-2951-45e9-99f5-cf8e2d0a69d3@measurement-factory.com>
 <ZrSbx_Q6VQAfdH66@fantomas.sk>
 <2db0d2c5-cb6e-4b0b-a6f1-221b6d5a6e5b@measurement-factory.com>
 <ZrTb84bGqYN24GoY@fantomas.sk>
 <b3a43edb-4161-4142-8140-cf369524ccb5@measurement-factory.com>
 <ZrYTmos7dTVP_spx@fantomas.sk>
 <0ebd735b-1655-4cfe-8a83-53e871bd3330@measurement-factory.com>
Message-ID: <ZrZK5XhFNJdek_Qv@fantomas.sk>

>On 2024-08-09 09:03, Matus UHLAR - fantomas wrote:
>
>>FTR, I sent the info privately, but we can continue 
>>discussing/solving it here.
>
>>maybeMakeSpaceAvailable: request buffer full: client_request_buffer_max_size=524288
>>ReadNow: ... size 0, retval 0, errno 0
>>terminateAll: 1/1 after ERR_CLIENT_GONE/WITH_CLIENT

On 09.08.24 09:51, Alex Rousskov wrote:
>AFAICT, you are suffering from a Squid bug that goes back to 2015 
>commit 4d1376d7 (that was fixing Squid bug 4206) or even earlier code. 
>Red flags were raised back in 2015, but nobody followed through. We 
>need to refactor Server::maybeMakeSpaceAvailable()-related code to fix 
>this bug.
>
>FWIW, we did similar work for Squid-to-peer communication in commit 
>cc8b26f9 and commit 50c5af88. Similar principles should apply to 
>client-Squid communication. Unfortunately, I do not have enough free 
>time to volunteer to fix this client-Squid bug now.
>
>At the expense of using more memory for some upload cases, you may be 
>able to work around the bug in some (but not all!) cases by making 
>client_request_buffer_max_size sufficiently large. For example, 
>setting client_request_buffer_max_size to 16 megabytes may allow you 
>to pass the test case you have privately shared.

Thanks for info.

I have tried rising client_request_buffer_max_size to 11MB and file uploaded 
correctly, so your guess is apparently correct.

I will try logging PUT/POST sizes just to see what should be the correct 
value for now.

Further I'll analyze so I'll  be able to guess how will it affect squid 
cache.


-- 
Matus UHLAR - fantomas, uhlar at fantomas.sk ; http://www.fantomas.sk/
Warning: I wish NOT to receive e-mail advertising to this address.
Varovanie: na tuto adresu chcem NEDOSTAVAT akukolvek reklamnu postu.
Depression is merely anger without enthusiasm.


From uhlar at fantomas.sk  Mon Aug 12 09:27:41 2024
From: uhlar at fantomas.sk (Matus UHLAR - fantomas)
Date: Mon, 12 Aug 2024 11:27:41 +0200
Subject: [squid-users] squid 5.7 FTP upload fails
In-Reply-To: <0ebd735b-1655-4cfe-8a83-53e871bd3330@measurement-factory.com>
References: <ZrOpVqKIJZ3aww_Q@fantomas.sk>
 <81aabaf4-2951-45e9-99f5-cf8e2d0a69d3@measurement-factory.com>
 <ZrSbx_Q6VQAfdH66@fantomas.sk>
 <2db0d2c5-cb6e-4b0b-a6f1-221b6d5a6e5b@measurement-factory.com>
 <ZrTb84bGqYN24GoY@fantomas.sk>
 <b3a43edb-4161-4142-8140-cf369524ccb5@measurement-factory.com>
 <ZrYTmos7dTVP_spx@fantomas.sk>
 <0ebd735b-1655-4cfe-8a83-53e871bd3330@measurement-factory.com>
Message-ID: <ZrnVjRs52kM3YVqy@fantomas.sk>

On 09.08.24 09:51, Alex Rousskov wrote:
>On 2024-08-09 09:03, Matus UHLAR - fantomas wrote:
>
>>FTR, I sent the info privately, but we can continue 
>>discussing/solving it here.
>
>>maybeMakeSpaceAvailable: request buffer full: client_request_buffer_max_size=524288
>>ReadNow: ... size 0, retval 0, errno 0
>>terminateAll: 1/1 after ERR_CLIENT_GONE/WITH_CLIENT
>
>AFAICT, you are suffering from a Squid bug that goes back to 2015 
>commit 4d1376d7 (that was fixing Squid bug 4206) or even earlier code. 
>Red flags were raised back in 2015, but nobody followed through. We 
>need to refactor Server::maybeMakeSpaceAvailable()-related code to fix 
>this bug.
>
>FWIW, we did similar work for Squid-to-peer communication in commit 
>cc8b26f9 and commit 50c5af88. Similar principles should apply to 
>client-Squid communication. Unfortunately, I do not have enough free 
>time to volunteer to fix this client-Squid bug now.
>
>At the expense of using more memory for some upload cases, you may be 
>able to work around the bug in some (but not all!) cases by making 
>client_request_buffer_max_size sufficiently large. For example, 
>setting client_request_buffer_max_size to 16 megabytes may allow you 
>to pass the test case you have privately shared.


I have submitted bug 5405 so it's documented:

https://bugs.squid-cache.org/show_bug.cgi?id=5405

-- 
Matus UHLAR - fantomas, uhlar at fantomas.sk ; http://www.fantomas.sk/
Warning: I wish NOT to receive e-mail advertising to this address.
Varovanie: na tuto adresu chcem NEDOSTAVAT akukolvek reklamnu postu.
I feel like I'm diagonally parked in a parallel universe.


From uhlar at fantomas.sk  Tue Aug 13 13:53:55 2024
From: uhlar at fantomas.sk (Matus UHLAR - fantomas)
Date: Tue, 13 Aug 2024 15:53:55 +0200
Subject: [squid-users] squid 5.7 FTP upload fails
In-Reply-To: <ZrnVjRs52kM3YVqy@fantomas.sk>
References: <ZrOpVqKIJZ3aww_Q@fantomas.sk>
 <81aabaf4-2951-45e9-99f5-cf8e2d0a69d3@measurement-factory.com>
 <ZrSbx_Q6VQAfdH66@fantomas.sk>
 <2db0d2c5-cb6e-4b0b-a6f1-221b6d5a6e5b@measurement-factory.com>
 <ZrTb84bGqYN24GoY@fantomas.sk>
 <b3a43edb-4161-4142-8140-cf369524ccb5@measurement-factory.com>
 <ZrYTmos7dTVP_spx@fantomas.sk>
 <0ebd735b-1655-4cfe-8a83-53e871bd3330@measurement-factory.com>
 <ZrnVjRs52kM3YVqy@fantomas.sk>
Message-ID: <ZrtlczC_w6p9z5G-@fantomas.sk>

>>On 2024-08-09 09:03, Matus UHLAR - fantomas wrote:
>>>FTR, I sent the info privately, but we can continue 
>>>discussing/solving it here.
>>
>>>maybeMakeSpaceAvailable: request buffer full: client_request_buffer_max_size=524288
>>>ReadNow: ... size 0, retval 0, errno 0
>>>terminateAll: 1/1 after ERR_CLIENT_GONE/WITH_CLIENT

>On 09.08.24 09:51, Alex Rousskov wrote:
>>AFAICT, you are suffering from a Squid bug that goes back to 2015 
>>commit 4d1376d7 (that was fixing Squid bug 4206) or even earlier 
>>code. Red flags were raised back in 2015, but nobody followed 
>>through. We need to refactor 
>>Server::maybeMakeSpaceAvailable()-related code to fix this bug.
>>
>>FWIW, we did similar work for Squid-to-peer communication in commit 
>>cc8b26f9 and commit 50c5af88. Similar principles should apply to 
>>client-Squid communication. Unfortunately, I do not have enough free 
>>time to volunteer to fix this client-Squid bug now.
>>
>>At the expense of using more memory for some upload cases, you may 
>>be able to work around the bug in some (but not all!) cases by 
>>making client_request_buffer_max_size sufficiently large. For 
>>example, setting client_request_buffer_max_size to 16 megabytes may 
>>allow you to pass the test case you have privately shared.

On 12.08.24 11:27, Matus UHLAR - fantomas wrote:
>I have submitted bug 5405 so it's documented:
>
>https://bugs.squid-cache.org/show_bug.cgi?id=5405

Does this bug apply for POST requests as well?

Because the biggest PUT is about 4MB so far, but I've seen POST requests 
nearly 54MB big.



-- 
Matus UHLAR - fantomas, uhlar at fantomas.sk ; http://www.fantomas.sk/
Warning: I wish NOT to receive e-mail advertising to this address.
Varovanie: na tuto adresu chcem NEDOSTAVAT akukolvek reklamnu postu.
Micro$oft random number generator: 0, 0, 0, 4.33e+67, 0, 0, 0...


From rousskov at measurement-factory.com  Tue Aug 13 14:21:43 2024
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Tue, 13 Aug 2024 10:21:43 -0400
Subject: [squid-users] squid 5.7 FTP upload fails
In-Reply-To: <ZrtlczC_w6p9z5G-@fantomas.sk>
References: <ZrOpVqKIJZ3aww_Q@fantomas.sk>
 <81aabaf4-2951-45e9-99f5-cf8e2d0a69d3@measurement-factory.com>
 <ZrSbx_Q6VQAfdH66@fantomas.sk>
 <2db0d2c5-cb6e-4b0b-a6f1-221b6d5a6e5b@measurement-factory.com>
 <ZrTb84bGqYN24GoY@fantomas.sk>
 <b3a43edb-4161-4142-8140-cf369524ccb5@measurement-factory.com>
 <ZrYTmos7dTVP_spx@fantomas.sk>
 <0ebd735b-1655-4cfe-8a83-53e871bd3330@measurement-factory.com>
 <ZrnVjRs52kM3YVqy@fantomas.sk> <ZrtlczC_w6p9z5G-@fantomas.sk>
Message-ID: <f8a43247-6260-4b6d-b701-9d2e35c84c05@measurement-factory.com>

On 2024-08-13 09:53, Matus UHLAR - fantomas wrote:
>>> On 2024-08-09 09:03, Matus UHLAR - fantomas wrote:
>>>> FTR, I sent the info privately, but we can continue 
>>>> discussing/solving it here.
>>>
>>>> maybeMakeSpaceAvailable: request buffer full: 
>>>> client_request_buffer_max_size=524288
>>>> ReadNow: ... size 0, retval 0, errno 0
>>>> terminateAll: 1/1 after ERR_CLIENT_GONE/WITH_CLIENT
> 
>> On 09.08.24 09:51, Alex Rousskov wrote:
>>> AFAICT, you are suffering from a Squid bug that goes back to 2015 
>>> commit 4d1376d7 (that was fixing Squid bug 4206) or even earlier 
>>> code. Red flags were raised back in 2015, but nobody followed 
>>> through. We need to refactor 
>>> Server::maybeMakeSpaceAvailable()-related code to fix this bug.
>>>
>>> FWIW, we did similar work for Squid-to-peer communication in commit 
>>> cc8b26f9 and commit 50c5af88. Similar principles should apply to 
>>> client-Squid communication. Unfortunately, I do not have enough free 
>>> time to volunteer to fix this client-Squid bug now.
>>>
>>> At the expense of using more memory for some upload cases, you may be 
>>> able to work around the bug in some (but not all!) cases by making 
>>> client_request_buffer_max_size sufficiently large. For example, 
>>> setting client_request_buffer_max_size to 16 megabytes may allow you 
>>> to pass the test case you have privately shared.
> 
> On 12.08.24 11:27, Matus UHLAR - fantomas wrote:
>> I have submitted bug 5405 so it's documented:
>>
>> https://bugs.squid-cache.org/show_bug.cgi?id=5405
> 
> Does this bug apply for POST requests as well?

I speculate that the answer is "yes": IIRC, the underlying bug may 
affect any request with a large-enough body in _combination_ with other 
events/factors that affect buffered data consumption. I have not 
checked, but one of those factors could be, for example, the receiving 
port protocol (i.e. ftp_port and FTP in your test case) and/or REQMOD 
adaptation. I speculate that those "other" events rarely happen in a 
typical Squid installation (explaining why most large requests do not 
get stuck), but can be reproduced under controlled conditions with 
http_port POSTs.


HTH,

Alex.

> Because the biggest PUT is about 4MB so far, but I've seen POST requests 
> nearly 54MB big.



From matt.groves at gmail.com  Wed Aug 14 06:29:18 2024
From: matt.groves at gmail.com (Matt Groves)
Date: Wed, 14 Aug 2024 08:29:18 +0200
Subject: [squid-users] Adding tcp_outgoing_address to the squid log
Message-ID: <CAM0qVx-LFcSU-8+Q2g+uf3vMPSe1=t6b2Yci1kgCO3sNbQ0N3Q@mail.gmail.com>

Hello,

I can't see anywhere that this is discussed. Is there any way to add the
outgoing address to the log?

Thanks,

Matt
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20240814/c3f051b8/attachment.htm>

From uhlar at fantomas.sk  Wed Aug 14 07:34:18 2024
From: uhlar at fantomas.sk (Matus UHLAR - fantomas)
Date: Wed, 14 Aug 2024 09:34:18 +0200
Subject: [squid-users] Adding tcp_outgoing_address to the squid log
In-Reply-To: <CAM0qVx-LFcSU-8+Q2g+uf3vMPSe1=t6b2Yci1kgCO3sNbQ0N3Q@mail.gmail.com>
References: <CAM0qVx-LFcSU-8+Q2g+uf3vMPSe1=t6b2Yci1kgCO3sNbQ0N3Q@mail.gmail.com>
Message-ID: <Zrxd-nQiws4CattG@fantomas.sk>

On 14.08.24 08:29, Matt Groves wrote:
>I can't see anywhere that this is discussed. Is there any way to add the
>outgoing address to the log?

Perhaps %<la should do that

http://www.squid-cache.org/Doc/config/logformat/

	<la	Local IP address of the last server or peer connection


-- 
Matus UHLAR - fantomas, uhlar at fantomas.sk ; http://www.fantomas.sk/
Warning: I wish NOT to receive e-mail advertising to this address.
Varovanie: na tuto adresu chcem NEDOSTAVAT akukolvek reklamnu postu.
My mind is like a steel trap - rusty and illegal in 37 states.


From matt.groves at gmail.com  Wed Aug 14 07:41:49 2024
From: matt.groves at gmail.com (Matt Groves)
Date: Wed, 14 Aug 2024 09:41:49 +0200
Subject: [squid-users] Adding tcp_outgoing_address to the squid log
In-Reply-To: <Zrxd-nQiws4CattG@fantomas.sk>
References: <CAM0qVx-LFcSU-8+Q2g+uf3vMPSe1=t6b2Yci1kgCO3sNbQ0N3Q@mail.gmail.com>
 <Zrxd-nQiws4CattG@fantomas.sk>
Message-ID: <CAM0qVx-zba31FDHwsyxNZKFahB0+tCg_H3U4YqyuCWWs0TFUwA@mail.gmail.com>

On Wed, 14 Aug 2024 at 09:34, Matus UHLAR - fantomas <uhlar at fantomas.sk>
wrote:

>
> Perhaps %<la should do that
>
> http://www.squid-cache.org/Doc/config/logformat/
>
>         <la     Local IP address of the last server or peer connection
>
> Yes, thank you - this works!
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20240814/71917dec/attachment.htm>

From ngtech1ltd at gmail.com  Sun Aug 18 02:23:09 2024
From: ngtech1ltd at gmail.com (NgTech LTD)
Date: Sun, 18 Aug 2024 05:23:09 +0300
Subject: [squid-users] Threat feed like utility
Message-ID: <CABA8h=TyTes3u=n5SEYn0+18EciK63DagY+3gyOvFigy_zrWew@mail.gmail.com>

I am testing couple options and I wanted to try and see what tool provides
a "threat feed" like for url filtering for Squid.

The available tools for url filtering are SquidGuard (which is ancient) and
ufdbguard.
There are also other tools out there which are not open source.
In FortiGate devices they have Threat feeds which can be either wildcard
which is dstdomain like and also full urls and ip addresses, couple types
of feeds.

In squid world I would call it an ACL feed which can be used in the context
of a real ACL or an external software.

An example feed can be seen at:
NgTech-LTD/youtube-urls-feed - youtube-urls-feed - Gitea: Git with a cup of
tea <https://git.ngtech.co.il/NgTech-LTD/youtube-urls-feed>

Usually youtube doing a nice (not the best) job with content filtering but
there are also other reasons like age rating systems.
We can generate a rating feed per age in a DB and then create a profile
which will include the allowed material for the specific age.
A profile can be built based on couple categories which are basically URL
patterns and Domains.

I am working on a technical video which will explain how SquidGuard
programatically does it work internally and with this anyone can build his
own external helper freely in any language and with any DB he likes.
There are other aspects which ufdbguard implements but regarding URL
filtering the systems are pretty simple to implement.
There is a 50k urls per sec check rate but it's pretty easy to say compared
to technically understand what it means and this needs to be demystified to
my opinion.
There are technical specs for queries and requests per seconds and these
have a limit.
Currently I have a 64GB Ram for the DB and it seems to perform well but
cannot reach 3k Queries per sec..


----
Eliezer Croitoru
Tech Support
Mobile: +972-5-28704261
Email: ngtech1ltd at gmail.com
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20240818/cd8d6dab/attachment.htm>

From ngtech1ltd at gmail.com  Mon Aug 19 07:47:55 2024
From: ngtech1ltd at gmail.com (NgTech LTD)
Date: Mon, 19 Aug 2024 10:47:55 +0300
Subject: [squid-users] Squid 6.10 on Fedora 40 cannot intercept and bump SSL
 Traffic
Message-ID: <CABA8h=TSSsneVN5qvtaxsHfdknSd58ucZ9Vxg=Vxe5YWCsaAAA@mail.gmail.com>

I am testing Squid 6.10 on Fedora 40 (their package).
And it seems that Squid is unable to bump clients (ESNI/ECH)?

I had couple iterations of pek stare and bump and I am not sure what is the
reason for that:
shutdown_lifetime 3 seconds
external_acl_type whitelist-lookup-helper ipv4 ttl=10 children-max=10
children-startup=2 \
        children-idle=2 concurrency=10 %URI %SRC
/usr/local/bin/squid-conf-url-lookup.rb
acl whitelist-lookup external  whitelist-lookup-helper
acl ytmethods method POST GET
acl localnet src 0.0.0.1-0.255.255.255  # RFC 1122 "this" network (LAN)
acl localnet src 10.0.0.0/8             # RFC 1918 local private network
(LAN)
acl localnet src 100.64.0.0/10          # RFC 6598 shared address space
(CGN)
acl localnet src 169.254.0.0/16         # RFC 3927 link-local (directly
plugged) machines
acl localnet src 172.16.0.0/12          # RFC 1918 local private network
(LAN)
acl localnet src 192.168.0.0/16         # RFC 1918 local private network
(LAN)
acl localnet src fc00::/7               # RFC 4193 local private network
range
acl localnet src fe80::/10              # RFC 4291 link-local (directly
plugged) machines
acl SSL_ports port 443
acl Safe_ports port 80          # http
acl Safe_ports port 21          # ftp
acl Safe_ports port 443         # https
acl Safe_ports port 70          # gopher
acl Safe_ports port 210         # wais
acl Safe_ports port 1025-65535  # unregistered ports
acl Safe_ports port 280         # http-mgmt
acl Safe_ports port 488         # gss-http
acl Safe_ports port 591         # filemaker
acl Safe_ports port 777         # multiling http
http_access deny !Safe_ports
http_access deny CONNECT !SSL_ports
http_access allow localhost manager
http_access deny manager
http_access allow localhost
http_access deny to_localhost
http_access deny to_linklocal
acl tubedoms dstdomain .ytimg.com .youtube.com .youtu.be
http_access allow ytmethods localnet tubedoms whitelist-lookup
http_access allow localnet
http_access deny all
http_port 3128
http_port 13128 ssl-bump tls-cert=/etc/squid/ssl/cert.pem
tls-key=/etc/squid/ssl/key.pem \
        generate-host-certificates=on dynamic_cert_mem_cache_size=4MB
http_port 23128 tproxy ssl-bump tls-cert=/etc/squid/ssl/cert.pem
tls-key=/etc/squid/ssl/key.pem \
        generate-host-certificates=on dynamic_cert_mem_cache_size=4MB
http_port 33128 intercept ssl-bump tls-cert=/etc/squid/ssl/cert.pem
tls-key=/etc/squid/ssl/key.pem \
        generate-host-certificates=on dynamic_cert_mem_cache_size=4MB
sslcrtd_program /usr/lib64/squid/security_file_certgen -s
/var/spool/squid/ssl_db -M 4MB
sslcrtd_children 5
acl foreignProtocol squid_error ERR_PROTOCOL_UNKNOWN ERR_TOO_BIG
acl serverTalksFirstProtocol squid_error ERR_REQUEST_START_TIMEOUT
on_unsupported_protocol tunnel foreignProtocol
on_unsupported_protocol tunnel serverTalksFirstProtocol
on_unsupported_protocol respond all
acl monitoredSites ssl::server_name .youtube.com .ytimg.com
acl monitoredSitesRegex ssl::server_name_regex \.youtube\.com \.ytimg\.com
acl serverIsBank ssl::server_name .visa.com
acl step1 at_step SslBump1
acl step2 at_step SslBump2
acl step3 at_step SslBump3
ssl_bump bump all
strip_query_terms off
coredump_dir /var/spool/squid
refresh_pattern ^ftp:           1440    20%     10080
refresh_pattern -i (/cgi-bin/|\?) 0     0%      0
refresh_pattern .               0       20%     4320
logformat ssl_custom_format %ts.%03tu %6tr %>a %Ss/%03>Hs %<st %rm %ru %[un
%Sh/%<a %mt %ssl::>sni
access_log daemon:/var/log/squid/access.log ssl_custom_format
##EOF

access.log from before:
1724028804.797    486 192.168.78.15 TCP_TUNNEL/200 17764 CONNECT
40.126.31.73:443 - ORIGINAL_DST/40.126.31.73 - -
1724028805.413      0 192.168.78.15 NONE_NONE/000 0 - error:invalid-request
- HIER_NONE/- - -
1724028806.028      0 192.168.78.15 NONE_NONE/000 0 - error:invalid-request
- HIER_NONE/- - -
1724028806.028      0 192.168.78.15 NONE_NONE/000 0 - error:invalid-request
- HIER_NONE/- - -
1724028806.029      0 192.168.78.15 NONE_NONE/000 0 - error:invalid-request
- HIER_NONE/- - -
1724028806.030      0 192.168.78.15 NONE_NONE/000 0 - error:invalid-request
- HIER_NONE/- - -
1724028806.085     57 192.168.78.15 TCP_TUNNEL/200 4513 CONNECT
104.18.72.113:443 - ORIGINAL_DST/104.18.72.113 - -
1724028806.086     56 192.168.78.15 TCP_TUNNEL/200 4513 CONNECT
104.18.72.113:443 - ORIGINAL_DST/104.18.72.113 - -
1724028806.086     56 192.168.78.15 TCP_TUNNEL/200 4512 CONNECT
104.18.72.113:443 - ORIGINAL_DST/104.18.72.113 - -
1724028806.208      0 192.168.78.15 NONE_NONE/000 0 - error:invalid-request
- HIER_NONE/- - -
1724028806.213      0 192.168.78.15 NONE_NONE/000 0 - error:invalid-request
- HIER_NONE/- - -
1724028806.338      0 192.168.78.15 NONE_NONE/000 0 - error:invalid-request
- HIER_NONE/- - -
1724028806.469      0 192.168.78.15 NONE_NONE/000 0 - error:invalid-request
- HIER_NONE/- - -
1724028806.596      0 192.168.78.15 NONE_NONE/000 0 - error:invalid-request
- HIER_NONE/- - -
1724028807.006      0 192.168.78.15 NONE_NONE/000 0 - error:invalid-request
- HIER_NONE/- - -
1724028807.262      0 192.168.78.15 NONE_NONE/000 0 - error:invalid-request
- HIER_NONE/- - -
1724028808.922   5037 192.168.78.15 TCP_TUNNEL/200 6096 CONNECT
13.107.246.60:443 - ORIGINAL_DST/13.107.246.60 - -
1724028812.906   8336 192.168.78.15 TCP_TUNNEL/200 1071500 CONNECT
104.126.37.171:443 - ORIGINAL_DST/104.126.37.171 - -
1724028819.209 247893 192.168.78.15 TCP_TUNNEL/200 4023 CONNECT
142.250.186.34:443 - ORIGINAL_DST/142.250.186.34 - -
1724028820.097 250033 192.168.78.15 TCP_TUNNEL/200 549611 CONNECT
142.250.184.246:443 - ORIGINAL_DST/142.250.184.246 - -
1724028820.154 246850 192.168.78.15 TCP_TUNNEL/200 15119 CONNECT
216.58.206.65:443 - ORIGINAL_DST/216.58.206.65 - -
1724028820.164 246856 192.168.78.15 TCP_TUNNEL/200 3037 CONNECT
142.250.181.227:443 - ORIGINAL_DST/142.250.181.227 - -
1724028820.203 246893 192.168.78.15 TCP_TUNNEL/200 3031 CONNECT
172.217.16.196:443 - ORIGINAL_DST/172.217.16.196 - -
1724028822.656 271833 192.168.78.15 TCP_TUNNEL/200 387583 CONNECT
142.250.185.238:443 - ORIGINAL_DST/142.250.185.238 - -
1724028830.336      0 192.168.78.15 NONE_NONE/000 0 - error:invalid-request
- HIER_NONE/- - -
1724028830.781    444 192.168.78.15 TCP_TUNNEL/200 18505 CONNECT
40.126.31.73:443 - ORIGINAL_DST/40.126.31.73 - -
1724028841.781 155018 192.168.78.15 TCP_TUNNEL/200 15960 CONNECT
13.107.6.158:443 - ORIGINAL_DST/13.107.6.158 - -
1724028849.443      0 192.168.78.15 NONE_NONE/000 0 - error:invalid-request
- HIER_NONE/- - -
1724028849.698      0 192.168.78.15 NONE_NONE/000 0 - error:invalid-request
- HIER_NONE/- - -
1724028865.261      0 192.168.78.15 NONE_NONE/000 0 - error:invalid-request
- HIER_NONE/- - -
1724028865.779    517 192.168.78.15 TCP_TUNNEL/200 18557 CONNECT
40.126.31.73:443 - ORIGINAL_DST/40.126.31.73 - -
1724028870.718 109994 192.168.78.15 TCP_TUNNEL/200 6972 CONNECT
20.42.65.94:443 - ORIGINAL_DST/20.42.65.94 - -
1724028871.179  64583 192.168.78.15 TCP_TUNNEL/200 1903 CONNECT
104.18.10.207:443 - ORIGINAL_DST/104.18.10.207 - -
1724028871.179  63917 192.168.78.15 TCP_TUNNEL/200 2430 CONNECT
142.250.186.99:443 - ORIGINAL_DST/142.250.186.99 - -
1724028871.179  64709 192.168.78.15 TCP_TUNNEL/200 2439 CONNECT
142.250.185.170:443 - ORIGINAL_DST/142.250.185.170 - -
1724028871.308      0 192.168.78.15 NONE_NONE/000 0 - error:invalid-request
- HIER_NONE/- - -
1724028871.731    422 192.168.78.15 TCP_TUNNEL/200 17789 CONNECT
40.126.31.73:443 - ORIGINAL_DST/40.126.31.73 - -
1724028872.486      0 192.168.78.15 NONE_NONE/000 0 - error:invalid-request
- HIER_NONE/- - -
1724028873.477      0 192.168.78.15 NONE_NONE/000 0 - error:invalid-request
- HIER_NONE/- - -
1724028873.745      0 192.168.78.15 NONE_NONE/000 0 - error:invalid-request
- HIER_NONE/- - -
1724028873.902    424 192.168.78.15 TCP_TUNNEL/200 18520 CONNECT
40.126.31.73:443 - ORIGINAL_DST/40.126.31.73 - -
1724028877.056      0 192.168.78.15 NONE_NONE/000 0 - error:invalid-request
- HIER_NONE/- - -
1724028877.060      0 192.168.78.15 NONE_NONE/000 0 - error:invalid-request
- HIER_NONE/- - -
1724028877.060      0 192.168.78.15 NONE_NONE/000 0 - error:invalid-request
- HIER_NONE/- - -
1724028877.060      0 192.168.78.15 NONE_NONE/000 0 - error:invalid-request
- HIER_NONE/- - -
1724028877.430 312389 192.168.78.15 TCP_TUNNEL/200 7884 CONNECT
142.250.186.78:443 - ORIGINAL_DST/142.250.186.78 - -
1724028878.800      0 192.168.78.15 NONE_NONE/000 0 - error:invalid-request
- HIER_NONE/- - -
1724028878.920      0 192.168.78.15 NONE_NONE/000 0 - error:invalid-request
- HIER_NONE/- - -
1724028879.072      0 192.168.78.15 NONE_NONE/000 0 - error:invalid-request
- HIER_NONE/- - -
1724028880.808   7062 192.168.78.15 TCP_TUNNEL/200 836391 CONNECT
104.126.37.145:443 - ORIGINAL_DST/104.126.37.145 - -
1724028882.468  33024 192.168.78.15 TCP_TUNNEL/200 1488697 CONNECT
49.12.59.2:443 - ORIGINAL_DST/49.12.59.2 - -
1724028883.728   6671 192.168.78.15 TCP_TUNNEL/200 69351 CONNECT
52.216.185.251:443 - ORIGINAL_DST/52.216.185.251 - -
1724028883.789   6728 192.168.78.15 TCP_TUNNEL/200 69216 CONNECT
52.216.185.251:443 - ORIGINAL_DST/52.216.185.251 - -
1724028883.797   6736 192.168.78.15 TCP_TUNNEL/200 104657 CONNECT
52.216.185.251:443 - ORIGINAL_DST/52.216.185.251 - -
1724028883.845   6784 192.168.78.15 TCP_TUNNEL/200 80277 CONNECT
52.216.185.251:443 - ORIGINAL_DST/52.216.185.251 - -
1724028884.460 170355 192.168.78.15 TCP_TUNNEL/200 44690 CONNECT
185.199.108.153:443 - ORIGINAL_DST/185.199.108.153 - -
1724028889.845 120370 192.168.78.15 TCP_TUNNEL/200 5868 CONNECT
104.126.37.161:443 - ORIGINAL_DST/104.126.37.161 - -
1724028890.011 122862 192.168.78.15 TCP_TUNNEL/200 136726 CONNECT
23.37.37.211:443 - ORIGINAL_DST/23.37.37.211 - -
1724028890.297 120381 192.168.78.15 TCP_TUNNEL/200 9176 CONNECT
2.18.140.238:443 - ORIGINAL_DST/2.18.140.238 - -
1724028891.212      0 192.168.78.15 NONE_NONE/000 0 - error:invalid-request
- HIER_NONE/- - -
1724028891.365    152 192.168.78.15 TCP_TUNNEL/200 2359 CONNECT
142.250.185.138:443 - ORIGINAL_DST/142.250.185.138 - -
1724028893.885  90253 192.168.78.15 TCP_TUNNEL/200 6374 CONNECT
13.107.246.60:443 - ORIGINAL_DST/13.107.246.60 - -
1724028900.169      0 192.168.78.15 NONE_NONE/000 0 - error:invalid-request
- HIER_NONE/- - -
1724028934.465 900262 192.168.78.15 TCP_TUNNEL/200 5530 CONNECT
52.123.243.197:443 - ORIGINAL_DST/52.123.243.197 - -
1724028960.494  60324 192.168.78.15 TCP_TUNNEL/503 0 CONNECT
172.217.16.206:443 - ORIGINAL_DST/172.217.16.206 - -
1724028960.494      0 192.168.78.15 NONE_NONE/000 0 -
error:transaction-end-before-headers - HIER_NONE/- - -

Thanks for any help,


----
Eliezer Croitoru
Tech Support
Mobile: +972-5-28704261
Email: ngtech1ltd at gmail.com
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20240819/261054d8/attachment.htm>

From guyt at silverfort.com  Mon Aug 19 11:37:14 2024
From: guyt at silverfort.com (Guy Tzudkevitz)
Date: Mon, 19 Aug 2024 11:37:14 +0000
Subject: [squid-users] SQUID 6.10 vulnerabilities
In-Reply-To: <GV2PR02MB8578E076D9F90F225A95FF5FB28C2@GV2PR02MB8578.eurprd02.prod.outlook.com>
References: <GV2PR02MB857836C6DB79C3B31F3BAA03B28C2@GV2PR02MB8578.eurprd02.prod.outlook.com>
 <GV2PR02MB8578E076D9F90F225A95FF5FB28C2@GV2PR02MB8578.eurprd02.prod.outlook.com>
Message-ID: <GV2PR02MB8578B40A468F066BC11A0511B28C2@GV2PR02MB8578.eurprd02.prod.outlook.com>


Hi

I'm running Squid on Ubuntu 22.04
I ran a vulnerability scan on this server and got a result from the vendor that this version is vulnerable. See. Is there any way to fix it?

Vulnerability Details
Name
Squid Multiple 0-Day Vulnerabilities (Oct 2023)
Found On
X.X.X.X
Insight

The following flaws have been reported in 2021 to the vendor and seems to be not fixed yet: - Use-After-Free in TRACE Requests - X-Forwarded-For Stack Overflow - Chunked Encoding Stack Overflow - Use-After-Free in Cache Manager Errors - Memory Leak in HTTP Response Parsing - Memory Leak in ESI Error Processing - 1-Byte Buffer OverRead in RFC 1123 date/time Handling GHSA-8w9r-p88v-mmx9 - One-Byte Buffer OverRead in HTTP Request Header Parsing - strlen(NULL) Crash Using Digest Authentication GHSA-254c-93q9-cp53 - Assertion in ESI Header Handling - Gopher Assertion Crash - Whois Assertion Crash - RFC 2141 / 2169 (URN) Assertion Crash - Assertion in Negotiate/NTLM Authentication Using Pipeline Prefetching - Assertion on IPv6 Host Requests with --disable-ipv6 - Assertion Crash on Unexpected 'HTTP/1.1 100 Continue' Response Header - Pipeline Prefetch Assertion With Double 'Expect:100-continue' Request Headers - Pipeline Prefetch Assertion With Invalid Headers - Assertion Crash in Deferred Requests - Assertion in Digest Authentication - FTP Authentication Crash - Assertion Crash In HTTP Response Headers Handling - Implicit Assertion in Stream Handling - Use-After-Free in ESI 'Try' (and 'Choose') Processing - Use-After-Free in ESI Expression Evaluation - Buffer Underflow in ESI GHSA-wgvf-q977-9xjg - Assertion in Squid 'Helper' Process Creator GHSA-xggx-9329-3c27 - Assertion Due to 0 ESI 'when' Checking GHSA-4g88-277m-q89r - Assertion Using ESI's When Directive GHSA-4g88-277m-q89r - Assertion in ESI Variable Assignment (String) - Assertion in ESI Variable Assignment - Null Pointer Dereference In ESI's esi:include and esi:when Note: Various GHSA advisories have been provided by the security researcher but are not published / available yet.




-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20240819/a5bd75ff/attachment.htm>

From rousskov at measurement-factory.com  Mon Aug 19 12:20:56 2024
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Mon, 19 Aug 2024 08:20:56 -0400
Subject: [squid-users] Squid 6.10 on Fedora 40 cannot intercept and bump
 SSL Traffic
In-Reply-To: <CABA8h=TSSsneVN5qvtaxsHfdknSd58ucZ9Vxg=Vxe5YWCsaAAA@mail.gmail.com>
References: <CABA8h=TSSsneVN5qvtaxsHfdknSd58ucZ9Vxg=Vxe5YWCsaAAA@mail.gmail.com>
Message-ID: <6b375023-33d6-4812-8850-0a24cb562d2e@measurement-factory.com>

On 2024-08-19 03:47, NgTech LTD wrote:
> I am testing Squid 6.10 on Fedora 40 (their package).
> And it seems that Squid is unable?to bump clients (ESNI/ECH)?
> 
> I had couple iterations of pek stare and bump and I am not sure what is 
> the reason for that:

What do you use as a client? Judging by the number of 
error:invalid-request entries in your access.log, that client may not be 
speaking HTTP/1 inside those CONNECT tunnels.

Does everything work for non-intercept ports?

Does everything work in a basic curl or wget test?

Does everything work when you remove "ssl-bump" and related options from 
intercepting http_port 33128?

Does everything work when you use "ssl_bump splice all" instead of your 
current ssl_bump rule?

Does everything work when you use "ssl_bump peek all" instead of your 
current ssl_bump rule?

Alex.


> shutdown_lifetime 3 seconds
> external_acl_type whitelist-lookup-helper ipv4 ttl=10 children-max=10 
> children-startup=2 \
>  ? ? ? ? children-idle=2 concurrency=10 %URI %SRC 
> /usr/local/bin/squid-conf-url-lookup.rb
> acl whitelist-lookup external ?whitelist-lookup-helper
> acl ytmethods method POST GET
> acl localnet src 0.0.0.1-0.255.255.255 ?# RFC 1122 "this" network (LAN)
> acl localnet src 10.0.0.0/8 <http://10.0.0.0/8> ? ? ? ? ? ? # RFC 1918 
> local private network (LAN)
> acl localnet src 100.64.0.0/10 <http://100.64.0.0/10> ? ? ? ? ?# RFC 
> 6598 shared address space (CGN)
> acl localnet src 169.254.0.0/16 <http://169.254.0.0/16> ? ? ? ? # RFC 
> 3927 link-local (directly plugged) machines
> acl localnet src 172.16.0.0/12 <http://172.16.0.0/12> ? ? ? ? ?# RFC 
> 1918 local private network (LAN)
> acl localnet src 192.168.0.0/16 <http://192.168.0.0/16> ? ? ? ? # RFC 
> 1918 local private network (LAN)
> acl localnet src fc00::/7 ? ? ? ? ? ? ? # RFC 4193 local private network 
> range
> acl localnet src fe80::/10 ? ? ? ? ? ? ?# RFC 4291 link-local (directly 
> plugged) machines
> acl SSL_ports port 443
> acl Safe_ports port 80 ? ? ? ? ?# http
> acl Safe_ports port 21 ? ? ? ? ?# ftp
> acl Safe_ports port 443 ? ? ? ? # https
> acl Safe_ports port 70 ? ? ? ? ?# gopher
> acl Safe_ports port 210 ? ? ? ? # wais
> acl Safe_ports port 1025-65535 ?# unregistered ports
> acl Safe_ports port 280 ? ? ? ? # http-mgmt
> acl Safe_ports port 488 ? ? ? ? # gss-http
> acl Safe_ports port 591 ? ? ? ? # filemaker
> acl Safe_ports port 777 ? ? ? ? # multiling http
> http_access deny !Safe_ports
> http_access deny CONNECT !SSL_ports
> http_access allow localhost manager
> http_access deny manager
> http_access allow localhost
> http_access deny to_localhost
> http_access deny to_linklocal
> acl tubedoms dstdomain .ytimg.com <http://ytimg.com> .youtube.com 
> <http://youtube.com> .youtu.be <http://youtu.be>
> http_access allow ytmethods localnet tubedoms whitelist-lookup
> http_access allow localnet
> http_access deny all
> http_port 3128
> http_port 13128 ssl-bump tls-cert=/etc/squid/ssl/cert.pem 
> tls-key=/etc/squid/ssl/key.pem \
>  ? ? ? ? generate-host-certificates=on dynamic_cert_mem_cache_size=4MB
> http_port 23128 tproxy ssl-bump tls-cert=/etc/squid/ssl/cert.pem 
> tls-key=/etc/squid/ssl/key.pem \
>  ? ? ? ? generate-host-certificates=on dynamic_cert_mem_cache_size=4MB
> http_port 33128 intercept ssl-bump tls-cert=/etc/squid/ssl/cert.pem 
> tls-key=/etc/squid/ssl/key.pem \
>  ? ? ? ? generate-host-certificates=on dynamic_cert_mem_cache_size=4MB
> sslcrtd_program /usr/lib64/squid/security_file_certgen -s 
> /var/spool/squid/ssl_db -M 4MB
> sslcrtd_children 5
> acl foreignProtocol squid_error ERR_PROTOCOL_UNKNOWN ERR_TOO_BIG
> acl serverTalksFirstProtocol squid_error ERR_REQUEST_START_TIMEOUT
> on_unsupported_protocol tunnel foreignProtocol
> on_unsupported_protocol tunnel serverTalksFirstProtocol
> on_unsupported_protocol respond all
> acl monitoredSites ssl::server_name .youtube.com <http://youtube.com> 
> .ytimg.com <http://ytimg.com>
> acl monitoredSitesRegex ssl::server_name_regex \.youtube\.com \.ytimg\.com
> acl serverIsBank ssl::server_name .visa.com <http://visa.com>
> acl step1 at_step SslBump1
> acl step2 at_step SslBump2
> acl step3 at_step SslBump3
> ssl_bump bump all
> strip_query_terms off
> coredump_dir /var/spool/squid
> refresh_pattern ^ftp: ? ? ? ? ? 1440 ? ?20% ? ? 10080
> refresh_pattern -i (/cgi-bin/|\?) 0 ? ? 0% ? ? ?0
> refresh_pattern . ? ? ? ? ? ? ? 0 ? ? ? 20% ? ? 4320
> logformat ssl_custom_format %ts.%03tu %6tr %>a %Ss/%03>Hs %<st %rm %ru 
> %[un %Sh/%<a %mt %ssl::>sni
> access_log daemon:/var/log/squid/access.log ssl_custom_format
> ##EOF
> 
> access.log from before:
> 1724028804.797 ? ?486 192.168.78.15 TCP_TUNNEL/200 17764 CONNECT 
> 40.126.31.73:443 <http://40.126.31.73:443> - ORIGINAL_DST/40.126.31.73 
> <http://40.126.31.73> - -
> 1724028805.413 ? ? ?0 192.168.78.15 NONE_NONE/000 0 - 
> error:invalid-request - HIER_NONE/- - -
> 1724028806.028 ? ? ?0 192.168.78.15 NONE_NONE/000 0 - 
> error:invalid-request - HIER_NONE/- - -
> 1724028806.028 ? ? ?0 192.168.78.15 NONE_NONE/000 0 - 
> error:invalid-request - HIER_NONE/- - -
> 1724028806.029 ? ? ?0 192.168.78.15 NONE_NONE/000 0 - 
> error:invalid-request - HIER_NONE/- - -
> 1724028806.030 ? ? ?0 192.168.78.15 NONE_NONE/000 0 - 
> error:invalid-request - HIER_NONE/- - -
> 1724028806.085 ? ? 57 192.168.78.15 TCP_TUNNEL/200 4513 CONNECT 
> 104.18.72.113:443 <http://104.18.72.113:443> - 
> ORIGINAL_DST/104.18.72.113 <http://104.18.72.113> - -
> 1724028806.086 ? ? 56 192.168.78.15 TCP_TUNNEL/200 4513 CONNECT 
> 104.18.72.113:443 <http://104.18.72.113:443> - 
> ORIGINAL_DST/104.18.72.113 <http://104.18.72.113> - -
> 1724028806.086 ? ? 56 192.168.78.15 TCP_TUNNEL/200 4512 CONNECT 
> 104.18.72.113:443 <http://104.18.72.113:443> - 
> ORIGINAL_DST/104.18.72.113 <http://104.18.72.113> - -
> 1724028806.208 ? ? ?0 192.168.78.15 NONE_NONE/000 0 - 
> error:invalid-request - HIER_NONE/- - -
> 1724028806.213 ? ? ?0 192.168.78.15 NONE_NONE/000 0 - 
> error:invalid-request - HIER_NONE/- - -
> 1724028806.338 ? ? ?0 192.168.78.15 NONE_NONE/000 0 - 
> error:invalid-request - HIER_NONE/- - -
> 1724028806.469 ? ? ?0 192.168.78.15 NONE_NONE/000 0 - 
> error:invalid-request - HIER_NONE/- - -
> 1724028806.596 ? ? ?0 192.168.78.15 NONE_NONE/000 0 - 
> error:invalid-request - HIER_NONE/- - -
> 1724028807.006 ? ? ?0 192.168.78.15 NONE_NONE/000 0 - 
> error:invalid-request - HIER_NONE/- - -
> 1724028807.262 ? ? ?0 192.168.78.15 NONE_NONE/000 0 - 
> error:invalid-request - HIER_NONE/- - -
> 1724028808.922 ? 5037 192.168.78.15 TCP_TUNNEL/200 6096 CONNECT 
> 13.107.246.60:443 <http://13.107.246.60:443> - 
> ORIGINAL_DST/13.107.246.60 <http://13.107.246.60> - -
> 1724028812.906 ? 8336 192.168.78.15 TCP_TUNNEL/200 1071500 CONNECT 
> 104.126.37.171:443 <http://104.126.37.171:443> - 
> ORIGINAL_DST/104.126.37.171 <http://104.126.37.171> - -
> 1724028819.209 247893 192.168.78.15 TCP_TUNNEL/200 4023 CONNECT 
> 142.250.186.34:443 <http://142.250.186.34:443> - 
> ORIGINAL_DST/142.250.186.34 <http://142.250.186.34> - -
> 1724028820.097 250033 192.168.78.15 TCP_TUNNEL/200 549611 CONNECT 
> 142.250.184.246:443 <http://142.250.184.246:443> - 
> ORIGINAL_DST/142.250.184.246 <http://142.250.184.246> - -
> 1724028820.154 246850 192.168.78.15 TCP_TUNNEL/200 15119 CONNECT 
> 216.58.206.65:443 <http://216.58.206.65:443> - 
> ORIGINAL_DST/216.58.206.65 <http://216.58.206.65> - -
> 1724028820.164 246856 192.168.78.15 TCP_TUNNEL/200 3037 CONNECT 
> 142.250.181.227:443 <http://142.250.181.227:443> - 
> ORIGINAL_DST/142.250.181.227 <http://142.250.181.227> - -
> 1724028820.203 246893 192.168.78.15 TCP_TUNNEL/200 3031 CONNECT 
> 172.217.16.196:443 <http://172.217.16.196:443> - 
> ORIGINAL_DST/172.217.16.196 <http://172.217.16.196> - -
> 1724028822.656 271833 192.168.78.15 TCP_TUNNEL/200 387583 CONNECT 
> 142.250.185.238:443 <http://142.250.185.238:443> - 
> ORIGINAL_DST/142.250.185.238 <http://142.250.185.238> - -
> 1724028830.336 ? ? ?0 192.168.78.15 NONE_NONE/000 0 - 
> error:invalid-request - HIER_NONE/- - -
> 1724028830.781 ? ?444 192.168.78.15 TCP_TUNNEL/200 18505 CONNECT 
> 40.126.31.73:443 <http://40.126.31.73:443> - ORIGINAL_DST/40.126.31.73 
> <http://40.126.31.73> - -
> 1724028841.781 155018 192.168.78.15 TCP_TUNNEL/200 15960 CONNECT 
> 13.107.6.158:443 <http://13.107.6.158:443> - ORIGINAL_DST/13.107.6.158 
> <http://13.107.6.158> - -
> 1724028849.443 ? ? ?0 192.168.78.15 NONE_NONE/000 0 - 
> error:invalid-request - HIER_NONE/- - -
> 1724028849.698 ? ? ?0 192.168.78.15 NONE_NONE/000 0 - 
> error:invalid-request - HIER_NONE/- - -
> 1724028865.261 ? ? ?0 192.168.78.15 NONE_NONE/000 0 - 
> error:invalid-request - HIER_NONE/- - -
> 1724028865.779 ? ?517 192.168.78.15 TCP_TUNNEL/200 18557 CONNECT 
> 40.126.31.73:443 <http://40.126.31.73:443> - ORIGINAL_DST/40.126.31.73 
> <http://40.126.31.73> - -
> 1724028870.718 109994 192.168.78.15 TCP_TUNNEL/200 6972 CONNECT 
> 20.42.65.94:443 <http://20.42.65.94:443> - ORIGINAL_DST/20.42.65.94 
> <http://20.42.65.94> - -
> 1724028871.179 ?64583 192.168.78.15 TCP_TUNNEL/200 1903 CONNECT 
> 104.18.10.207:443 <http://104.18.10.207:443> - 
> ORIGINAL_DST/104.18.10.207 <http://104.18.10.207> - -
> 1724028871.179 ?63917 192.168.78.15 TCP_TUNNEL/200 2430 CONNECT 
> 142.250.186.99:443 <http://142.250.186.99:443> - 
> ORIGINAL_DST/142.250.186.99 <http://142.250.186.99> - -
> 1724028871.179 ?64709 192.168.78.15 TCP_TUNNEL/200 2439 CONNECT 
> 142.250.185.170:443 <http://142.250.185.170:443> - 
> ORIGINAL_DST/142.250.185.170 <http://142.250.185.170> - -
> 1724028871.308 ? ? ?0 192.168.78.15 NONE_NONE/000 0 - 
> error:invalid-request - HIER_NONE/- - -
> 1724028871.731 ? ?422 192.168.78.15 TCP_TUNNEL/200 17789 CONNECT 
> 40.126.31.73:443 <http://40.126.31.73:443> - ORIGINAL_DST/40.126.31.73 
> <http://40.126.31.73> - -
> 1724028872.486 ? ? ?0 192.168.78.15 NONE_NONE/000 0 - 
> error:invalid-request - HIER_NONE/- - -
> 1724028873.477 ? ? ?0 192.168.78.15 NONE_NONE/000 0 - 
> error:invalid-request - HIER_NONE/- - -
> 1724028873.745 ? ? ?0 192.168.78.15 NONE_NONE/000 0 - 
> error:invalid-request - HIER_NONE/- - -
> 1724028873.902 ? ?424 192.168.78.15 TCP_TUNNEL/200 18520 CONNECT 
> 40.126.31.73:443 <http://40.126.31.73:443> - ORIGINAL_DST/40.126.31.73 
> <http://40.126.31.73> - -
> 1724028877.056 ? ? ?0 192.168.78.15 NONE_NONE/000 0 - 
> error:invalid-request - HIER_NONE/- - -
> 1724028877.060 ? ? ?0 192.168.78.15 NONE_NONE/000 0 - 
> error:invalid-request - HIER_NONE/- - -
> 1724028877.060 ? ? ?0 192.168.78.15 NONE_NONE/000 0 - 
> error:invalid-request - HIER_NONE/- - -
> 1724028877.060 ? ? ?0 192.168.78.15 NONE_NONE/000 0 - 
> error:invalid-request - HIER_NONE/- - -
> 1724028877.430 312389 192.168.78.15 TCP_TUNNEL/200 7884 CONNECT 
> 142.250.186.78:443 <http://142.250.186.78:443> - 
> ORIGINAL_DST/142.250.186.78 <http://142.250.186.78> - -
> 1724028878.800 ? ? ?0 192.168.78.15 NONE_NONE/000 0 - 
> error:invalid-request - HIER_NONE/- - -
> 1724028878.920 ? ? ?0 192.168.78.15 NONE_NONE/000 0 - 
> error:invalid-request - HIER_NONE/- - -
> 1724028879.072 ? ? ?0 192.168.78.15 NONE_NONE/000 0 - 
> error:invalid-request - HIER_NONE/- - -
> 1724028880.808 ? 7062 192.168.78.15 TCP_TUNNEL/200 836391 CONNECT 
> 104.126.37.145:443 <http://104.126.37.145:443> - 
> ORIGINAL_DST/104.126.37.145 <http://104.126.37.145> - -
> 1724028882.468 ?33024 192.168.78.15 TCP_TUNNEL/200 1488697 CONNECT 
> 49.12.59.2:443 <http://49.12.59.2:443> - ORIGINAL_DST/49.12.59.2 
> <http://49.12.59.2> - -
> 1724028883.728 ? 6671 192.168.78.15 TCP_TUNNEL/200 69351 CONNECT 
> 52.216.185.251:443 <http://52.216.185.251:443> - 
> ORIGINAL_DST/52.216.185.251 <http://52.216.185.251> - -
> 1724028883.789 ? 6728 192.168.78.15 TCP_TUNNEL/200 69216 CONNECT 
> 52.216.185.251:443 <http://52.216.185.251:443> - 
> ORIGINAL_DST/52.216.185.251 <http://52.216.185.251> - -
> 1724028883.797 ? 6736 192.168.78.15 TCP_TUNNEL/200 104657 CONNECT 
> 52.216.185.251:443 <http://52.216.185.251:443> - 
> ORIGINAL_DST/52.216.185.251 <http://52.216.185.251> - -
> 1724028883.845 ? 6784 192.168.78.15 TCP_TUNNEL/200 80277 CONNECT 
> 52.216.185.251:443 <http://52.216.185.251:443> - 
> ORIGINAL_DST/52.216.185.251 <http://52.216.185.251> - -
> 1724028884.460 170355 192.168.78.15 TCP_TUNNEL/200 44690 CONNECT 
> 185.199.108.153:443 <http://185.199.108.153:443> - 
> ORIGINAL_DST/185.199.108.153 <http://185.199.108.153> - -
> 1724028889.845 120370 192.168.78.15 TCP_TUNNEL/200 5868 CONNECT 
> 104.126.37.161:443 <http://104.126.37.161:443> - 
> ORIGINAL_DST/104.126.37.161 <http://104.126.37.161> - -
> 1724028890.011 122862 192.168.78.15 TCP_TUNNEL/200 136726 CONNECT 
> 23.37.37.211:443 <http://23.37.37.211:443> - ORIGINAL_DST/23.37.37.211 
> <http://23.37.37.211> - -
> 1724028890.297 120381 192.168.78.15 TCP_TUNNEL/200 9176 CONNECT 
> 2.18.140.238:443 <http://2.18.140.238:443> - ORIGINAL_DST/2.18.140.238 
> <http://2.18.140.238> - -
> 1724028891.212 ? ? ?0 192.168.78.15 NONE_NONE/000 0 - 
> error:invalid-request - HIER_NONE/- - -
> 1724028891.365 ? ?152 192.168.78.15 TCP_TUNNEL/200 2359 CONNECT 
> 142.250.185.138:443 <http://142.250.185.138:443> - 
> ORIGINAL_DST/142.250.185.138 <http://142.250.185.138> - -
> 1724028893.885 ?90253 192.168.78.15 TCP_TUNNEL/200 6374 CONNECT 
> 13.107.246.60:443 <http://13.107.246.60:443> - 
> ORIGINAL_DST/13.107.246.60 <http://13.107.246.60> - -
> 1724028900.169 ? ? ?0 192.168.78.15 NONE_NONE/000 0 - 
> error:invalid-request - HIER_NONE/- - -
> 1724028934.465 900262 192.168.78.15 TCP_TUNNEL/200 5530 CONNECT 
> 52.123.243.197:443 <http://52.123.243.197:443> - 
> ORIGINAL_DST/52.123.243.197 <http://52.123.243.197> - -
> 1724028960.494 ?60324 192.168.78.15 TCP_TUNNEL/503 0 CONNECT 
> 172.217.16.206:443 <http://172.217.16.206:443> - 
> ORIGINAL_DST/172.217.16.206 <http://172.217.16.206> - -
> 1724028960.494 ? ? ?0 192.168.78.15 NONE_NONE/000 0 - 
> error:transaction-end-before-headers - HIER_NONE/- - -
> 
> Thanks for any help,
> 
> 
> ----
> Eliezer Croitoru
> Tech Support
> Mobile: +972-5-28704261
> Email: ngtech1ltd at gmail.com <mailto:ngtech1ltd at gmail.com>
> 
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> https://lists.squid-cache.org/listinfo/squid-users



From rousskov at measurement-factory.com  Mon Aug 19 13:07:07 2024
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Mon, 19 Aug 2024 09:07:07 -0400
Subject: [squid-users] SQUID 6.10 vulnerabilities
In-Reply-To: <GV2PR02MB8578B40A468F066BC11A0511B28C2@GV2PR02MB8578.eurprd02.prod.outlook.com>
References: <GV2PR02MB857836C6DB79C3B31F3BAA03B28C2@GV2PR02MB8578.eurprd02.prod.outlook.com>
 <GV2PR02MB8578E076D9F90F225A95FF5FB28C2@GV2PR02MB8578.eurprd02.prod.outlook.com>
 <GV2PR02MB8578B40A468F066BC11A0511B28C2@GV2PR02MB8578.eurprd02.prod.outlook.com>
Message-ID: <0db86f71-707b-4df1-a551-9795a1b8a9ca@measurement-factory.com>

On 2024-08-19 07:37, Guy Tzudkevitz wrote:

> I'm running Squid on Ubuntu 22.04
> 
> I ran a vulnerability scan on this server and got a result from the 
> vendor that this version is vulnerable. See. Is there any way to fix it?

There is, but we cannot fix that scanner. Please contact the vendor that 
provided you with that scanner. As far as Squid is concerned:

* Squid v6.10 is not vulnerable to some of the vulnerabilities listed 
below. For example, Squid v6.10 is not vulnerable to "X-Forwarded-For 
Stack Overflow" and "Chunked Encoding Stack Overflow". I only checked a 
few, so I cannot give you an exact count of misleading "insight" entries 
in the dump of vulnerability names you have shared.

* No reasonable Squid build/configuration is vulnerable to most of the 
vulnerabilities listed below. For example, reasonable Squid builds 
should not enable (or, in older Squid versions, should explicitly 
disable) ESI support at ./configure time; reasonable Squid 
configurations should not enable pipeline_prefetch. Just these two 
(default in Squid v6.10!) precautions would address 15+ vulnerabilities.

* Certain Squid builds/configurations are still vulnerable to a few of 
those reported vulnerabilities because nobody volunteered Squid changes 
to address them. In most cases (e.g., ESI and pipeline_prefetch), nobody 
who can develop (or pay for) a quality fix is affected by those 
vulnerabilities. I do not know whether those vulnerabilities affect 
_your_ Squid installations. If they do, please see
https://wiki.squid-cache.org/SquidFaq/AboutSquid#how-to-add-a-new-squid-feature-enhance-of-fix-something

* IMO, Squid Project has screwed up its official response to the 
surprise publication of those vulnerabilities in 2023: AFAIK, there is 
still no concise summary of vulnerabilities remaining in the latest 
supported Squid release and their corresponding workarounds (if any). 
There is some useful info at the URL below, but it is incomplete and 
converting that info to such a summary requires significant effort:
https://github.com/squid-cache/squid/security/advisories/


HTH,

Alex.


> Vulnerability Details
> Name
> Squid Multiple 0-Day Vulnerabilities (Oct 2023)
> Found On
> X.X.X.X
> Insight
> 
> 
> The following flaws have been reported in 2021 to the vendor and seems 
> to be not fixed yet: - Use-After-Free in TRACE Requests - 
> X-Forwarded-For Stack Overflow - Chunked Encoding Stack Overflow - 
> Use-After-Free in Cache Manager Errors - Memory Leak in HTTP Response 
> Parsing - Memory Leak in ESI Error Processing - 1-Byte Buffer OverRead 
> in RFC 1123 date/time Handling GHSA-8w9r-p88v-mmx9 - One-Byte Buffer 
> OverRead in HTTP Request Header Parsing - strlen(NULL) Crash Using 
> Digest Authentication GHSA-254c-93q9-cp53 - Assertion in ESI Header 
> Handling - Gopher Assertion Crash - Whois Assertion Crash - RFC 2141 / 
> 2169 (URN) Assertion Crash - Assertion in Negotiate/NTLM Authentication 
> Using Pipeline Prefetching - Assertion on IPv6 Host Requests with 
> --disable-ipv6 - Assertion Crash on Unexpected 'HTTP/1.1 100 Continue' 
> Response Header - Pipeline Prefetch Assertion With Double 
> 'Expect:100-continue' Request Headers - Pipeline Prefetch Assertion With 
> Invalid Headers - Assertion Crash in Deferred Requests - Assertion in 
> Digest Authentication - FTP Authentication Crash - Assertion Crash In 
> HTTP Response Headers Handling - Implicit Assertion in Stream Handling - 
> Use-After-Free in ESI 'Try' (and 'Choose') Processing - Use-After-Free 
> in ESI Expression Evaluation - Buffer Underflow in ESI 
> GHSA-wgvf-q977-9xjg - Assertion in Squid 'Helper' Process Creator 
> GHSA-xggx-9329-3c27 - Assertion Due to 0 ESI 'when' Checking 
> GHSA-4g88-277m-q89r - Assertion Using ESI's When Directive 
> GHSA-4g88-277m-q89r - Assertion in ESI Variable Assignment (String) - 
> Assertion in ESI Variable Assignment - Null Pointer Dereference In ESI's 
> esi:include and esi:when Note: Various GHSA advisories have been 
> provided by the security researcher but are not published / available yet.
> 
> 
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> https://lists.squid-cache.org/listinfo/squid-users



From Josh.Piana at hexcel.com  Mon Aug 19 15:16:14 2024
From: Josh.Piana at hexcel.com (Piana, Josh)
Date: Mon, 19 Aug 2024 15:16:14 +0000
Subject: [squid-users] Squid.conf Issues
Message-ID: <43696754c7d5443cba762cc72233e302@hexcel.com>

Good morning Squid Support,

I've been setting up a replacement Squid proxy server.

After setting up the backend using realmD, sssd, with Kerberos authentication, I tested with a Windows "squidaduser" account. I can verify the user accounts connection to the proxy, and it is passing traffic. The issue is, it's not being blocked by ANY of the acl's we have in place. I was hoping to reach out to help me identify the issue with the squid.conf file. This is my assumption to be the issue but I am pretty new at using Linux and completely unfamiliar with setting up a web proxy.

Environment:
Squid Cache: Version 5.5
RHEL 9.4 on a HyperV VM
Linux Client Proxy in a Windows AD environment


Below I will post the config and attempt to edit out any relevant company/personal information:

##############################################################################
# General
##############################################################################

max_filedesc 4096
cache_mgr ARCITAdmin at hexcel.com
cache_effective_user squid
cache_effective_group squid
shutdown_lifetime 5 seconds

##############################################################################
# Logging
##############################################################################

# this makes the logs readable to humans
logformat custom %tl.%03tu %>a %Ss/%03>Hs %<st %rm %ru %[un %Sh/%<a %mt
access_log daemon:/var/log/squid/access.log custom


logfile_rotate 10
debug_options ALL,1
buffered_logs off
cache_log /var/log/squid/general
cache_access_log /var/log/squid/access.log
cache_store_log none
log_mime_hdrs off
strip_query_terms off

##############################################################################
# Network - General/misc
##############################################################################

# our HTTP proxy port
http_port 10.46.11.69:8080
# loopback management
http_port 127.0.0.1:3128

icp_port 0
forwarded_for off

##############################################################################
# Network timeout settings
##############################################################################

connect_timeout 30 seconds
peer_connect_timeout 20 seconds
read_timeout 2 minutes
request_timeout 2 minutes
persistent_request_timeout 30 seconds

##############################################################################
# Configuration of the local cache itself
##############################################################################

cache_dir ufs /var/spool/squid/ 10000 16 256
coredump_dir /var/spool/squid/
cache_replacement_policy heap LFUDA
memory_replacement_policy lru
cache_mem 256 MB
maximum_object_size 32 MB
maximum_object_size_in_memory 512 KB
quick_abort_min 16 KB
quick_abort_max 1 MB
quick_abort_pct 90
range_offset_limit 64 KB

##############################################################################
# Cache control
##############################################################################

acl no_cache_url url_regex -i "/etc/squid/no_cache_url"
cache deny no_cache_url

##############################################################################
# Authentication
##############################################################################

auth_param negotiate program /usr/lib64/squid/negotiate_kerberos_auth -k /etc/squid/HTTP.keytab -s HTTP/<domain>.ad.<domain>.com at AD.<domain>.COM
auth_param negotiate children 10
auth_param negotiate keep_alive on
acl kerb-auth proxy_auth REQUIRED
http_access allow kerb-auth

##############################################################################
# Access control - shared/common ACL definitions
##############################################################################

# acl all src all
acl src_self src 127.0.0.0/8
acl src_self src 10.46.11.69
acl dst_self dst 127.0.0.0/8
acl dst_self dst 10.46.11.69
acl from_arc src 10.46.0.0/15
acl local_dst_addr dst 10.0.0.0/8
acl local_dst_addr dst bldg3.<domain>.com
acl local_dst_addr dst bldg5.<domain>.com
acl local_dst_dom dstdomain <domain>
acl proto_FTP proto FTP
acl proto_HTTP proto HTTP
acl localnet src 10.46.49.0/24
acl localnet src 10.47.49.0/24

acl http_ports port 80
acl http_ports port 81
acl http_ports port 8001
acl http_ports port 8080

acl Ssl_ports port 443
acl Ssl_ports port 9571
acl SSL_ports port 443
acl Safe_ports port 80
acl Safe_ports port 21
acl Safe_ports port 443

acl ssh_ports port 22
acl ftp_ports port 21
http_access deny !Safe_ports
acl method_CONNECT method CONNECT
dsacl methods_std method GET HEAD POST PUT DELETE
acl methods_std method TRACE OPTIONS

##############################################################################
# Access control - maintenance
##############################################################################

acl purge method PURGE
http_access allow purge src_self
http_access deny purge
acl cache_manager proto cache_object
cachemgr_passwd disabled shutdown offline_toggle
cachemgr_passwd none all
http_access allow cache_manager src_self
http_access deny cache_manager

#############################################################################
# Access control - general proxy
##############################################################################

http_access deny dst_self
http_access deny src_self
http_access deny !from_arc
http_access       allow local_dst_dom
http_reply_access           allow local_dst_dom
http_access       allow local_dst_addr
http_reply_access           allow local_dst_addr
acl authless_src src "/etc/squid/authless_src"
http_access       allow authless_src
http_reply_access           allow authless_src
acl authless_dst dstdomain "/etc/squid/authless_dst"
http_access       allow authless_dst
http_reply_access           allow authless_dst
acl bad_domains_preauth dstdomain "/etc/squid/bad_domains_preauth"
http_access deny bad_domains_preauth

acl block_user proxy_auth_regex -i "/etc/squid/block_user"
http_access deny block_user
acl bad_exception_urls url_regex -i "/etc/squid/bad_exception_urls"
acl exec_files url_regex -i "/etc/squid/exec_files"
acl exec_users proxy_auth_regex -i "/etc/squid/exec_users"
http_access deny !bad_exception_urls !exec_users exec_files
deny_info ERR_BLOCK_TYPE exec_files
acl mmedia_users proxy_auth_regex -i "/etc/squid/mmedia_users"
acl mmedia_sites dstdomain "/etc/squid/mmedia_sites"
http_access       allow methods_std    proto_HTTP http_ports mmedia_sites mmedia_users
http_reply_access allow methods_std    proto_HTTP http_ports mmedia_sites mmedia_users
http_access       allow method_CONNECT            ssl_ports  mmedia_sites mmedia_users
http_reply_access allow method_CONNECT            ssl_ports  mmedia_sites mmedia_users

acl bad_domains dstdomain "/etc/squid/bad_domains"
http_access deny !bad_exception_urls bad_domains
deny_info ERR_BLOCK_DST         bad_domains
acl bad_domains_regex dstdom_regex -i "/etc/squid/bad_domains_regex"
http_access deny !bad_exception_urls bad_domains_regex
deny_info ERR_BLOCK_DST         bad_domains_regex
acl bad_urls url_regex -i "/etc/squid/bad_urls"
http_access deny !bad_exception_urls bad_urls
deny_info ERR_BLOCK_DST         bad_urls
acl bad_files urlpath_regex -i "/etc/squid/bad_files"
http_access deny !bad_exception_urls bad_files
deny_info ERR_BLOCK_TYPE bad_files
acl bad_types rep_mime_type -i "/etc/squid/bad_types"
http_reply_access deny bad_types !bad_exception_urls
deny_info ERR_BLOCK_TYPE bad_types

acl fsoguest_user proxy_auth_regex -i fsoguest
acl fsoguest_dst dstdomain .opm.gov
acl fsoguest_dst dstdomain .google-analytics.com
acl fsoguest_dst dstdomain pki.google.com
acl fsoguest_dst dstdomain ajax.googleapis.com
acl fsoguest_dst dstdomain fonts.googleapis.com
acl fsoguest_dst dstdomain html5shiv.googlecode.com
acl fsoguest_dst dstdomain fonts.gstatic.com
acl fsoguest_dst dstdomain clients1.google.com
acl fsoguest_dst dstdomain ajax.microsoft.com
acl fsoguest_dst dstdomain ajax.aspnetcdn.com
acl fsoguest_dst dstdomain .geotrust.com
acl fsoguest_dst dstdomain .akamaihd.net
acl fsoguest_dst dstdomain symcd.com
http_access allow methods_std proto_HTTP http_ports fsoguest_dst fsoguest_user
http_access allow method_CONNECT         ssl_ports  fsoguest_dst fsoguest_user
http_access deny fsoguest_user

http_access allow http_ports proto_HTTP methods_std
http_access allow method_CONNECT ssl_ports
http_access deny method_CONNECT

http_access allow ftp_ports proto_FTP
http_access deny all
http_reply_access allow all

##############################################################################
# END OF FILE
##############################################################################
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20240819/8c2231b8/attachment.htm>

From rousskov at measurement-factory.com  Mon Aug 19 16:11:32 2024
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Mon, 19 Aug 2024 12:11:32 -0400
Subject: [squid-users] Squid.conf Issues
In-Reply-To: <43696754c7d5443cba762cc72233e302@hexcel.com>
References: <43696754c7d5443cba762cc72233e302@hexcel.com>
Message-ID: <a09b6033-485c-492d-bfab-67fadbb3e310@measurement-factory.com>

On 2024-08-19 11:16, Piana, Josh wrote:

> After setting up the backend using realmD, sssd, with Kerberos 
> authentication, I tested with a Windows ?squidaduser? account. I can 
> verify the user accounts connection to the proxy, and it is passing 
> traffic. The issue is, it?s not being blocked by ANY of the acl?s we 
> have in place. I was hoping to reach out to help me identify the issue 
> with the squid.conf file. This is my assumption to be the issue but I am 
> pretty new at using Linux and completely unfamiliar with setting up a 
> web proxy.

In most cases, when Squid does not block, it allows. Squid allows when 
an "http_access allow" rule matches. Now look at _all_ of your 
http_access rules and ask yourself: Which "http_access allow" rule 
matches in my test case?

I do not know enough about your test logic, so I can only speculate that 
the answer to that question is "It is the very first http_access rule!":

     http_access allow kerb-auth

In other words, your configuration allows all authenticated clients. In 
other words, it does not block any authenticated clients. Is that what 
you want?


HTH,

Alex.



> Environment:
> 
> Squid Cache: Version 5.5
> 
> RHEL 9.4 on a HyperV VM
> 
> Linux Client Proxy in a Windows AD environment
> 
> Below I will post the config and attempt to edit out any relevant 
> company/personal information:
> 
> ##############################################################################
> 
> # General
> 
> ##############################################################################
> 
> max_filedesc 4096
> 
> cache_mgr ARCITAdmin at hexcel.com
> 
> cache_effective_user squid
> 
> cache_effective_group squid
> 
> shutdown_lifetime 5 seconds
> 
> ##############################################################################
> 
> # Logging
> 
> ##############################################################################
> 
> # this makes the logs readable to humans
> 
> logformat custom %tl.%03tu %>a %Ss/%03>Hs %<st %rm %ru %[un %Sh/%<a %mt
> 
> access_log daemon:/var/log/squid/access.log custom
> 
> logfile_rotate 10
> 
> debug_options ALL,1
> 
> buffered_logs off
> 
> cache_log /var/log/squid/general
> 
> cache_access_log /var/log/squid/access.log
> 
> cache_store_log none
> 
> log_mime_hdrs off
> 
> strip_query_terms off
> 
> ##############################################################################
> 
> # Network - General/misc
> 
> ##############################################################################
> 
> # our HTTP proxy port
> 
> http_port 10.46.11.69:8080
> 
> # loopback management
> 
> http_port 127.0.0.1:3128
> 
> icp_port 0
> 
> forwarded_for off
> 
> ##############################################################################
> 
> # Network timeout settings
> 
> ##############################################################################
> 
> connect_timeout 30 seconds
> 
> peer_connect_timeout 20 seconds
> 
> read_timeout 2 minutes
> 
> request_timeout 2 minutes
> 
> persistent_request_timeout 30 seconds
> 
> ##############################################################################
> 
> # Configuration of the local cache itself
> 
> ##############################################################################
> 
> cache_dir ufs /var/spool/squid/ 10000 16 256
> 
> coredump_dir /var/spool/squid/
> 
> cache_replacement_policy heap LFUDA
> 
> memory_replacement_policy lru
> 
> cache_mem 256 MB
> 
> maximum_object_size 32 MB
> 
> maximum_object_size_in_memory 512 KB
> 
> quick_abort_min 16 KB
> 
> quick_abort_max 1 MB
> 
> quick_abort_pct 90
> 
> range_offset_limit 64 KB
> 
> ##############################################################################
> 
> # Cache control
> 
> ##############################################################################
> 
> acl no_cache_url url_regex -i "/etc/squid/no_cache_url"
> 
> cache deny no_cache_url
> 
> ##############################################################################
> 
> # Authentication
> 
> ##############################################################################
> 
> auth_param negotiate program /usr/lib64/squid/negotiate_kerberos_auth -k 
> /etc/squid/HTTP.keytab -s HTTP/<domain>.ad.<domain>.com at AD.<domain>.COM
> 
> auth_param negotiate children 10
> 
> auth_param negotiate keep_alive on
> 
> acl kerb-auth proxy_auth REQUIRED
> 
> http_access allow kerb-auth
> 
> ##############################################################################
> 
> # Access control - shared/common ACL definitions
> 
> ##############################################################################
> 
> # acl all src all
> 
> acl src_self src 127.0.0.0/8
> 
> acl src_self src 10.46.11.69
> 
> acl dst_self dst 127.0.0.0/8
> 
> acl dst_self dst 10.46.11.69
> 
> acl from_arc src 10.46.0.0/15
> 
> acl local_dst_addr dst 10.0.0.0/8
> 
> acl local_dst_addr dst bldg3.<domain>.com
> 
> acl local_dst_addr dst bldg5.<domain>.com
> 
> acl local_dst_dom dstdomain <domain>
> 
> acl proto_FTP proto FTP
> 
> acl proto_HTTP proto HTTP
> 
> acl localnet src 10.46.49.0/24
> 
> acl localnet src 10.47.49.0/24
> 
> acl http_ports port 80
> 
> acl http_ports port 81
> 
> acl http_ports port 8001
> 
> acl http_ports port 8080
> 
> acl Ssl_ports port 443
> 
> acl Ssl_ports port 9571
> 
> acl SSL_ports port 443
> 
> acl Safe_ports port 80
> 
> acl Safe_ports port 21
> 
> acl Safe_ports port 443
> 
> acl ssh_ports port 22
> 
> acl ftp_ports port 21
> 
> http_access deny !Safe_ports
> 
> acl method_CONNECT method CONNECT
> 
> dsacl methods_std method GET HEAD POST PUT DELETE
> 
> acl methods_std method TRACE OPTIONS
> 
> ##############################################################################
> 
> # Access control - maintenance
> 
> ##############################################################################
> 
> acl purge method PURGE
> 
> http_access allow purge src_self
> 
> http_access deny purge
> 
> acl cache_manager proto cache_object
> 
> cachemgr_passwd disabled shutdown offline_toggle
> 
> cachemgr_passwd none all
> 
> http_access allow cache_manager src_self
> 
> http_access deny cache_manager
> 
> #############################################################################
> 
> # Access control - general proxy
> 
> ##############################################################################
> 
> http_access deny dst_self
> 
> http_access deny src_self
> 
> http_access deny !from_arc
> 
> http_access?????? allow local_dst_dom
> 
> http_reply_access ????????? allow local_dst_dom
> 
> http_access?????? allow local_dst_addr
> 
> http_reply_access ????????? allow local_dst_addr
> 
> acl authless_src src "/etc/squid/authless_src"
> 
> http_access?????? allow authless_src
> 
> http_reply_access ????????? allow authless_src
> 
> acl authless_dst dstdomain "/etc/squid/authless_dst"
> 
> http_access?????? allow authless_dst
> 
> http_reply_access ????????? allow authless_dst
> 
> acl bad_domains_preauth dstdomain "/etc/squid/bad_domains_preauth"
> 
> http_access deny bad_domains_preauth
> 
> acl block_user proxy_auth_regex -i "/etc/squid/block_user"
> 
> http_access deny block_user
> 
> acl bad_exception_urls url_regex -i "/etc/squid/bad_exception_urls"
> 
> acl exec_files url_regex -i "/etc/squid/exec_files"
> 
> acl exec_users proxy_auth_regex -i "/etc/squid/exec_users"
> 
> http_access deny !bad_exception_urls !exec_users exec_files
> 
> deny_info ERR_BLOCK_TYPE exec_files
> 
> acl mmedia_users proxy_auth_regex -i "/etc/squid/mmedia_users"
> 
> acl mmedia_sites dstdomain "/etc/squid/mmedia_sites"
> 
> http_access?????? allow methods_std??? proto_HTTP http_ports 
> mmedia_sites mmedia_users
> 
> http_reply_access allow methods_std??? proto_HTTP http_ports 
> mmedia_sites mmedia_users
> 
> http_access?????? allow method_CONNECT??????????? ssl_ports  
> mmedia_sites mmedia_users
> 
> http_reply_access allow method_CONNECT??????????? ssl_ports  
> mmedia_sites mmedia_users
> 
> acl bad_domains dstdomain "/etc/squid/bad_domains"
> 
> http_access deny !bad_exception_urls bad_domains
> 
> deny_info ERR_BLOCK_DST???????? bad_domains
> 
> acl bad_domains_regex dstdom_regex -i "/etc/squid/bad_domains_regex"
> 
> http_access deny !bad_exception_urls bad_domains_regex
> 
> deny_info ERR_BLOCK_DST???????? bad_domains_regex
> 
> acl bad_urls url_regex -i "/etc/squid/bad_urls"
> 
> http_access deny !bad_exception_urls bad_urls
> 
> deny_info ERR_BLOCK_DST???????? bad_urls
> 
> acl bad_files urlpath_regex -i "/etc/squid/bad_files"
> 
> http_access deny !bad_exception_urls bad_files
> 
> deny_info ERR_BLOCK_TYPE bad_files
> 
> acl bad_types rep_mime_type -i "/etc/squid/bad_types"
> 
> http_reply_access deny bad_types !bad_exception_urls
> 
> deny_info ERR_BLOCK_TYPE bad_types
> 
> acl fsoguest_user proxy_auth_regex -i fsoguest
> 
> acl fsoguest_dst dstdomain .opm.gov
> 
> acl fsoguest_dst dstdomain .google-analytics.com
> 
> acl fsoguest_dst dstdomain pki.google.com
> 
> acl fsoguest_dst dstdomain ajax.googleapis.com
> 
> acl fsoguest_dst dstdomain fonts.googleapis.com
> 
> acl fsoguest_dst dstdomain html5shiv.googlecode.com
> 
> acl fsoguest_dst dstdomain fonts.gstatic.com
> 
> acl fsoguest_dst dstdomain clients1.google.com
> 
> acl fsoguest_dst dstdomain ajax.microsoft.com
> 
> acl fsoguest_dst dstdomain ajax.aspnetcdn.com
> 
> acl fsoguest_dst dstdomain .geotrust.com
> 
> acl fsoguest_dst dstdomain .akamaihd.net
> 
> acl fsoguest_dst dstdomain symcd.com
> 
> http_access allow methods_std proto_HTTP http_ports fsoguest_dst 
> fsoguest_user
> 
> http_access allow method_CONNECT???????? ssl_ports? fsoguest_dst 
> fsoguest_user
> 
> http_access deny fsoguest_user
> 
> http_access allow http_ports proto_HTTP methods_std
> 
> http_access allow method_CONNECT ssl_ports
> 
> http_access deny method_CONNECT
> 
> http_access allow ftp_ports proto_FTP
> 
> http_access deny all
> 
> http_reply_access allow all
> 
> ##############################################################################
> 
> # END OF FILE
> 
> ##############################################################################
> 
> 
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> https://lists.squid-cache.org/listinfo/squid-users



From Josh.Piana at hexcel.com  Mon Aug 19 17:48:38 2024
From: Josh.Piana at hexcel.com (Piana, Josh)
Date: Mon, 19 Aug 2024 17:48:38 +0000
Subject: [squid-users] Squid.conf Issues
In-Reply-To: <a09b6033-485c-492d-bfab-67fadbb3e310@measurement-factory.com>
References: <43696754c7d5443cba762cc72233e302@hexcel.com>
 <a09b6033-485c-492d-bfab-67fadbb3e310@measurement-factory.com>
Message-ID: <7a2b553f248540ec86a12e805560eeff@hexcel.com>

Alex, 

You make an extremely valid point! I added "http_access allow kerb-auth" as part of the generic authentication settings. 

We still want authenticated users to access but we want the rules and ACL's prior to that to catch them first. I apologize, I'm quite new with Linux. Should I move that parameter to near the end of the config file or remove it all together?


-----Original Message-----
From: squid-users <squid-users-bounces at lists.squid-cache.org> On Behalf Of Alex Rousskov
Sent: Monday, August 19, 2024 12:12 PM
To: squid-users at lists.squid-cache.org
Subject: Re: [squid-users] Squid.conf Issues

Caution: This email originated from outside of Hexcel. Do not click links or open attachments unless you recognize the sender and know the content is safe.


On 2024-08-19 11:16, Piana, Josh wrote:

> After setting up the backend using realmD, sssd, with Kerberos 
> authentication, I tested with a Windows ?squidaduser? account. I can 
> verify the user accounts connection to the proxy, and it is passing 
> traffic. The issue is, it?s not being blocked by ANY of the acl?s we 
> have in place. I was hoping to reach out to help me identify the issue 
> with the squid.conf file. This is my assumption to be the issue but I 
> am pretty new at using Linux and completely unfamiliar with setting up 
> a web proxy.

In most cases, when Squid does not block, it allows. Squid allows when an "http_access allow" rule matches. Now look at _all_ of your http_access rules and ask yourself: Which "http_access allow" rule matches in my test case?

I do not know enough about your test logic, so I can only speculate that the answer to that question is "It is the very first http_access rule!":

     http_access allow kerb-auth

In other words, your configuration allows all authenticated clients. In other words, it does not block any authenticated clients. Is that what you want?


HTH,

Alex.



> Environment:
>
> Squid Cache: Version 5.5
>
> RHEL 9.4 on a HyperV VM
>
> Linux Client Proxy in a Windows AD environment
>
> Below I will post the config and attempt to edit out any relevant 
> company/personal information:
>
> ######################################################################
> ########
>
> # General
>
> ######################################################################
> ########
>
> max_filedesc 4096
>
> cache_mgr ARCITAdmin at hexcel.com
>
> cache_effective_user squid
>
> cache_effective_group squid
>
> shutdown_lifetime 5 seconds
>
> ######################################################################
> ########
>
> # Logging
>
> ######################################################################
> ########
>
> # this makes the logs readable to humans
>
> logformat custom %tl.%03tu %>a %Ss/%03>Hs %<st %rm %ru %[un %Sh/%<a 
> %mt
>
> access_log daemon:/var/log/squid/access.log custom
>
> logfile_rotate 10
>
> debug_options ALL,1
>
> buffered_logs off
>
> cache_log /var/log/squid/general
>
> cache_access_log /var/log/squid/access.log
>
> cache_store_log none
>
> log_mime_hdrs off
>
> strip_query_terms off
>
> ######################################################################
> ########
>
> # Network - General/misc
>
> ######################################################################
> ########
>
> # our HTTP proxy port
>
> http_port 10.46.11.69:8080
>
> # loopback management
>
> http_port 127.0.0.1:3128
>
> icp_port 0
>
> forwarded_for off
>
> ######################################################################
> ########
>
> # Network timeout settings
>
> ######################################################################
> ########
>
> connect_timeout 30 seconds
>
> peer_connect_timeout 20 seconds
>
> read_timeout 2 minutes
>
> request_timeout 2 minutes
>
> persistent_request_timeout 30 seconds
>
> ######################################################################
> ########
>
> # Configuration of the local cache itself
>
> ######################################################################
> ########
>
> cache_dir ufs /var/spool/squid/ 10000 16 256
>
> coredump_dir /var/spool/squid/
>
> cache_replacement_policy heap LFUDA
>
> memory_replacement_policy lru
>
> cache_mem 256 MB
>
> maximum_object_size 32 MB
>
> maximum_object_size_in_memory 512 KB
>
> quick_abort_min 16 KB
>
> quick_abort_max 1 MB
>
> quick_abort_pct 90
>
> range_offset_limit 64 KB
>
> ######################################################################
> ########
>
> # Cache control
>
> ######################################################################
> ########
>
> acl no_cache_url url_regex -i "/etc/squid/no_cache_url"
>
> cache deny no_cache_url
>
> ######################################################################
> ########
>
> # Authentication
>
> ######################################################################
> ########
>
> auth_param negotiate program /usr/lib64/squid/negotiate_kerberos_auth 
> -k /etc/squid/HTTP.keytab -s 
> HTTP/<domain>.ad.<domain>.com at AD.<domain>.COM
>
> auth_param negotiate children 10
>
> auth_param negotiate keep_alive on
>
> acl kerb-auth proxy_auth REQUIRED
>
> http_access allow kerb-auth
>
> ######################################################################
> ########
>
> # Access control - shared/common ACL definitions
>
> ######################################################################
> ########
>
> # acl all src all
>
> acl src_self src 127.0.0.0/8
>
> acl src_self src 10.46.11.69
>
> acl dst_self dst 127.0.0.0/8
>
> acl dst_self dst 10.46.11.69
>
> acl from_arc src 10.46.0.0/15
>
> acl local_dst_addr dst 10.0.0.0/8
>
> acl local_dst_addr dst bldg3.<domain>.com
>
> acl local_dst_addr dst bldg5.<domain>.com
>
> acl local_dst_dom dstdomain <domain>
>
> acl proto_FTP proto FTP
>
> acl proto_HTTP proto HTTP
>
> acl localnet src 10.46.49.0/24
>
> acl localnet src 10.47.49.0/24
>
> acl http_ports port 80
>
> acl http_ports port 81
>
> acl http_ports port 8001
>
> acl http_ports port 8080
>
> acl Ssl_ports port 443
>
> acl Ssl_ports port 9571
>
> acl SSL_ports port 443
>
> acl Safe_ports port 80
>
> acl Safe_ports port 21
>
> acl Safe_ports port 443
>
> acl ssh_ports port 22
>
> acl ftp_ports port 21
>
> http_access deny !Safe_ports
>
> acl method_CONNECT method CONNECT
>
> dsacl methods_std method GET HEAD POST PUT DELETE
>
> acl methods_std method TRACE OPTIONS
>
> ######################################################################
> ########
>
> # Access control - maintenance
>
> ######################################################################
> ########
>
> acl purge method PURGE
>
> http_access allow purge src_self
>
> http_access deny purge
>
> acl cache_manager proto cache_object
>
> cachemgr_passwd disabled shutdown offline_toggle
>
> cachemgr_passwd none all
>
> http_access allow cache_manager src_self
>
> http_access deny cache_manager
>
> ######################################################################
> #######
>
> # Access control - general proxy
>
> ######################################################################
> ########
>
> http_access deny dst_self
>
> http_access deny src_self
>
> http_access deny !from_arc
>
> http_access       allow local_dst_dom
>
> http_reply_access           allow local_dst_dom
>
> http_access       allow local_dst_addr
>
> http_reply_access           allow local_dst_addr
>
> acl authless_src src "/etc/squid/authless_src"
>
> http_access       allow authless_src
>
> http_reply_access           allow authless_src
>
> acl authless_dst dstdomain "/etc/squid/authless_dst"
>
> http_access       allow authless_dst
>
> http_reply_access           allow authless_dst
>
> acl bad_domains_preauth dstdomain "/etc/squid/bad_domains_preauth"
>
> http_access deny bad_domains_preauth
>
> acl block_user proxy_auth_regex -i "/etc/squid/block_user"
>
> http_access deny block_user
>
> acl bad_exception_urls url_regex -i "/etc/squid/bad_exception_urls"
>
> acl exec_files url_regex -i "/etc/squid/exec_files"
>
> acl exec_users proxy_auth_regex -i "/etc/squid/exec_users"
>
> http_access deny !bad_exception_urls !exec_users exec_files
>
> deny_info ERR_BLOCK_TYPE exec_files
>
> acl mmedia_users proxy_auth_regex -i "/etc/squid/mmedia_users"
>
> acl mmedia_sites dstdomain "/etc/squid/mmedia_sites"
>
> http_access       allow methods_std    proto_HTTP http_ports
> mmedia_sites mmedia_users
>
> http_reply_access allow methods_std    proto_HTTP http_ports
> mmedia_sites mmedia_users
>
> http_access       allow method_CONNECT            ssl_ports
> mmedia_sites mmedia_users
>
> http_reply_access allow method_CONNECT            ssl_ports
> mmedia_sites mmedia_users
>
> acl bad_domains dstdomain "/etc/squid/bad_domains"
>
> http_access deny !bad_exception_urls bad_domains
>
> deny_info ERR_BLOCK_DST         bad_domains
>
> acl bad_domains_regex dstdom_regex -i "/etc/squid/bad_domains_regex"
>
> http_access deny !bad_exception_urls bad_domains_regex
>
> deny_info ERR_BLOCK_DST         bad_domains_regex
>
> acl bad_urls url_regex -i "/etc/squid/bad_urls"
>
> http_access deny !bad_exception_urls bad_urls
>
> deny_info ERR_BLOCK_DST         bad_urls
>
> acl bad_files urlpath_regex -i "/etc/squid/bad_files"
>
> http_access deny !bad_exception_urls bad_files
>
> deny_info ERR_BLOCK_TYPE bad_files
>
> acl bad_types rep_mime_type -i "/etc/squid/bad_types"
>
> http_reply_access deny bad_types !bad_exception_urls
>
> deny_info ERR_BLOCK_TYPE bad_types
>
> acl fsoguest_user proxy_auth_regex -i fsoguest
>
> acl fsoguest_dst dstdomain .opm.gov
>
> acl fsoguest_dst dstdomain .google-analytics.com
>
> acl fsoguest_dst dstdomain pki.google.com
>
> acl fsoguest_dst dstdomain ajax.googleapis.com
>
> acl fsoguest_dst dstdomain fonts.googleapis.com
>
> acl fsoguest_dst dstdomain html5shiv.googlecode.com
>
> acl fsoguest_dst dstdomain fonts.gstatic.com
>
> acl fsoguest_dst dstdomain clients1.google.com
>
> acl fsoguest_dst dstdomain ajax.microsoft.com
>
> acl fsoguest_dst dstdomain ajax.aspnetcdn.com
>
> acl fsoguest_dst dstdomain .geotrust.com
>
> acl fsoguest_dst dstdomain .akamaihd.net
>
> acl fsoguest_dst dstdomain symcd.com
>
> http_access allow methods_std proto_HTTP http_ports fsoguest_dst 
> fsoguest_user
>
> http_access allow method_CONNECT         ssl_ports  fsoguest_dst
> fsoguest_user
>
> http_access deny fsoguest_user
>
> http_access allow http_ports proto_HTTP methods_std
>
> http_access allow method_CONNECT ssl_ports
>
> http_access deny method_CONNECT
>
> http_access allow ftp_ports proto_FTP
>
> http_access deny all
>
> http_reply_access allow all
>
> ######################################################################
> ########
>
> # END OF FILE
>
> ######################################################################
> ########
>
>
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> https://list/
> s.squid-cache.org%2Flistinfo%2Fsquid-users&data=05%7C02%7Cjosh.piana%4
> 0hexcel.com%7C5d5a04837ae140f50c6908dcc0699c20%7C4248050df19546d5ac9c0
> c7c52b04cae%7C0%7C0%7C638596807060587199%7CUnknown%7CTWFpbGZsb3d8eyJWI
> joiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C0%7C%7
> C%7C&sdata=pFmtS4HPHBRLFvcthpxiXT8mgF7mmpsGfQYF1wlivJo%3D&reserved=0

_______________________________________________
squid-users mailing list
squid-users at lists.squid-cache.org
https://lists.squid-cache.org/listinfo/squid-users

From ngtech1ltd at gmail.com  Mon Aug 19 19:27:08 2024
From: ngtech1ltd at gmail.com (ngtech1ltd at gmail.com)
Date: Mon, 19 Aug 2024 22:27:08 +0300
Subject: [squid-users] Squid 6.10 on Fedora 40 cannot intercept and bump
 SSL Traffic
In-Reply-To: <4a57096d-1218-4090-b62a-67d1a18173a7@measurement-factory.com>
References: <CABA8h=TSSsneVN5qvtaxsHfdknSd58ucZ9Vxg=Vxe5YWCsaAAA@mail.gmail.com>
 <6b375023-33d6-4812-8850-0a24cb562d2e@measurement-factory.com>
 <CABA8h=SJp88t3aj1cr-4LK-mqik6QL9nG_X2xumZ_mPwCoybxg@mail.gmail.com>
 <4a57096d-1218-4090-b62a-67d1a18173a7@measurement-factory.com>
Message-ID: <000001daf26d$d620c5c0$82625140$@gmail.com>

Hey Alex,

Sorry for the confusion,
And  we are back in the Squid-Users.

I have tested this issue with Windows 11 as a client in an intercept and TPROXY mode.
I can try to test it using another client such as linux or windows 10 but I assume that the issue is the same.
I sniffed some packets on the proxy to see what might be wrong and I see that there is a SNI so I am not sure how to look at the issue.
I was thinking that maybe it's something with the OpenSSL version (3.x.x) on Fedora but then I installed both 5.9 and 6.10 on Almalinux 8 and the result is the same.

I will describe my setup which might give some background.
I have a very big lab...
In the front of the Internet connection there are couple NGFW devices and RouterOS.
Mikrotik RouterOS is the edge and all the others are used with PBR accordingly.
The proxy sits in a deferent segment on the network and I have tried couple methods to intercept the traffic with squid.
The only one which works with Squid and the existing equipment and do not cause some weird loop is ethernet level tunnel ie not:
* GRE
* IPIP
And couple others.

The only ones which works fine are:
* EoIP (Mikrotik which is based on GRE0
* VxLAN

There are two methods to intercept the traffic:
* PBR+DNAT on the squid box
* PBR+TPROXY on the squid box

Since the intercept method terminates the connection and creates a new one with the ip of the proxy it's very simple to even use gre and ipip.
But, with tproxy to allow the traffic being identified currently as a packet which is not still in the routing stack we the linux OS need to tag it somehow.
To do that the default "Salt" for the packet hash in the routing stack is the source and destination mac address.
Due to this the only methods which are allowing to use tproxy are the above mentioned tunnels. (Maybe I will post a video on it later on with a demo)

The Mikrotik RouterOS device re-routes the traffic from the LAN interface into the VxLAN interface directly to the proxy machine which has a
static or dynamic route to the LAN subnet via the other side of the VxLAN tunnel which is the edge RouterOS device.
I want to gather a set of configurations and tests for this configurations to verify what might cause this issue and if possible to resolve it.
For me it seems that if my FortiGate and CheckPoint devices are able to intercept the traffic and "Bump" it, there is no reason why squid should 
be able to do that the same way.

I will later on send you a private link to the pcaps in a zip file so you would be able to inspect this issue in the network level and to see if there is
some details which can help us understand what cause this specific issue.

I want to say that bumping works fine on non-intercepted connections and that I have tested the interception with the two available methods ie:
* DNAT Redirect
* Tproxy

Thanks,
Eliezer Croitoru

-----Original Message-----
From: Alex Rousskov <rousskov at measurement-factory.com> 
Sent: Monday, August 19, 2024 7:18 PM
To: NgTech LTD <ngtech1ltd at gmail.com>
Subject: Re: [squid-users] Squid 6.10 on Fedora 40 cannot intercept and bump SSL Traffic

Eliezer, please move this thread back to squid-users mailing list 
instead of emailing me personally. When you do so, please clarify 
whether all 12 access.log records correspond to this single curl request 
(if not, please only share access.log record(s) that do correspond). --Alex.

On 2024-08-19 12:03, NgTech LTD wrote:
> This is the output of curl on windows 11 desktop:
> C:\Users\USER>curl https://www.youtube.com/ -k -v -o 1.txt
>    % Total    % Received % Xferd  Average Speed   Time    Time     Time 
>   Current
>                                   Dload  Upload   Total   Spent    Left 
>   Speed
>    0     0    0     0    0     0      0      0 --:--:-- --:--:-- 
> --:--:--     0* Host www.youtube.com:443 <http://www.youtube.com:443> 
> was resolved.
> * IPv6: 2a00:1450:4001:800::200e, 2a00:1450:4001:80e::200e, 
> 2a00:1450:4001:81c::200e, 2a00:1450:4001:809::200e
> * IPv4: 142.250.185.78, 142.250.185.110, 142.250.185.142, 
> 142.250.186.174, 142.250.185.174, 142.250.184.238, 142.250.185.238, 
> 142.250.185.206, 142.250.181.238, 142.250.186.46, 142.250.186.78, 
> 172.217.16.142, 216.58.212.174, 216.58.206.46, 172.217.23.110, 
> 216.58.212.142
> *   Trying 142.250.185.78:443...
> * Connected to www.youtube.com <http://www.youtube.com> (142.250.185.78) 
> port 443
> * schannel: disabled automatic use of client certificate
> * ALPN: curl offers http/1.1
> * ALPN: server accepted http/1.1
> * using HTTP/1.x
>  > GET / HTTP/1.1
>  > Host: www.youtube.com <http://www.youtube.com>
>  > User-Agent: curl/8.8.0
>  > Accept: */*
>  >
> * Request completely sent off
> * schannel: remote party requests renegotiation
> * schannel: renegotiating SSL/TLS connection
> * schannel: SSL/TLS connection renegotiated
> * schannel: failed to decrypt data, need more data
> < HTTP/1.1 200 OK
> < Content-Type: text/html; charset=utf-8
> < X-Content-Type-Options: nosniff
> < Cache-Control: no-cache, no-store, max-age=0, must-revalidate
> < Pragma: no-cache
> < Expires: Mon, 01 Jan 1990 00:00:00 GMT
> < Date: Mon, 19 Aug 2024 16:02:23 GMT
> < X-Frame-Options: SAMEORIGIN
> < Strict-Transport-Security: max-age=31536000
> < Origin-Trial: 
> AmhMBR6zCLzDDxpW+HfpP67BqwIknWnyMOXOQGfzYswFmJe+fgaI6XZgAzcxOrzNtP7hEDsOo1jdjFnVr2IdxQ4AAAB4eyJvcmlnaW4iOiJodHRwczovL3lvdXR1YmUuY29tOjQ0MyIsImZlYXR1cmUiOiJXZWJWaWV3WFJlcXVlc3RlZFdpdGhEZXByZWNhdGlvbiIsImV4cGlyeSI6MTc1ODA2NzE5OSwiaXNTdWJkb21haW4iOnRydWV9
> < Cross-Origin-Opener-Policy: same-origin-allow-popups; 
> report-to="youtube_main"
> < Report-To: 
> {"group":"youtube_main","max_age":2592000,"endpoints":[{"url":"https://csp.withgoogle.com/csp/report-to/youtube_main <https://csp.withgoogle.com/csp/report-to/youtube_main>"}]}
> < Content-Security-Policy: require-trusted-types-for 'script'
> < Permissions-Policy: ch-ua-arch=*, ch-ua-bitness=*, 
> ch-ua-full-version=*, ch-ua-full-version-list=*, ch-ua-model=*, 
> ch-ua-wow64=*, ch-ua-form-factors=*, ch-ua-platform=*, 
> ch-ua-platform-version=*
> < P3P: CP="This is not a P3P policy! See 
> http://support.google.com/accounts/answer/151657?hl=en 
> <http://support.google.com/accounts/answer/151657?hl=en> for more info."
> < Server: ESF
> < X-XSS-Protection: 0
> < Set-Cookie: GPS=1; Domain=.youtube.com <http://youtube.com>; 
> Expires=Mon, 19-Aug-2024 16:32:23 GMT; Path=/; Secure; HttpOnly
> < Set-Cookie: YSC=XYs_jViLkFw; Domain=.youtube.com <http://youtube.com>; 
> Path=/; Secure; HttpOnly; SameSite=none
> < Set-Cookie: VISITOR_INFO1_LIVE=csMabhlNyrI; Domain=.youtube.com 
> <http://youtube.com>; Expires=Sat, 15-Feb-2025 16:02:23 GMT; Path=/; 
> Secure; HttpOnly; SameSite=none
> < Set-Cookie: VISITOR_PRIVACY_METADATA=CgJJTBIEGgAgVw%3D%3D; 
> Domain=.youtube.com <http://youtube.com>; Expires=Sat, 15-Feb-2025 
> 16:02:23 GMT; Path=/; Secure; HttpOnly; SameSite=none
> < Alt-Svc: h3=":443"; ma=2592000,h3-29=":443"; ma=2592000
> < Accept-Ranges: none
> < Vary: Accept-Encoding
> < Transfer-Encoding: chunked
> <
> { [3674 bytes data]
> * schannel: failed to decrypt data, need more data
> { [8008 bytes data]
> * schannel: failed to decrypt data, need more data
> { [6880 bytes data]
> * schannel: failed to decrypt data, need more data
> { [2752 bytes data]
> * schannel: failed to decrypt data, need more data
> { [5504 bytes data]
> * schannel: failed to decrypt data, need more data
> { [2462 bytes data]
> * schannel: failed to decrypt data, need more data
> { [4128 bytes data]
> * schannel: failed to decrypt data, need more data
> { [2752 bytes data]
> * schannel: failed to decrypt data, need more data
> { [2752 bytes data]
> * schannel: failed to decrypt data, need more data
> { [4128 bytes data]
> * schannel: failed to decrypt data, need more data
> { [2752 bytes data]
> * schannel: failed to decrypt data, need more data
> { [5504 bytes data]
> * schannel: failed to decrypt data, need more data
> { [5504 bytes data]
> * schannel: failed to decrypt data, need more data
> { [4128 bytes data]
> * schannel: failed to decrypt data, need more data
> { [5242 bytes data]
> * schannel: failed to decrypt data, need more data
> { [2752 bytes data]
> * schannel: failed to decrypt data, need more data
> { [2752 bytes data]
> * schannel: failed to decrypt data, need more data
> { [6922 bytes data]
> * schannel: failed to decrypt data, need more data
> { [2752 bytes data]
> * schannel: failed to decrypt data, need more data
> { [6880 bytes data]
> * schannel: failed to decrypt data, need more data
> { [20378 bytes data]
> * schannel: failed to decrypt data, need more data
> { [6880 bytes data]
> * schannel: failed to decrypt data, need more data
> { [5504 bytes data]
> * schannel: failed to decrypt data, need more data
> { [5504 bytes data]
> * schannel: failed to decrypt data, need more data
> { [3839 bytes data]
> * schannel: failed to decrypt data, need more data
> { [6880 bytes data]
> * schannel: failed to decrypt data, need more data
> { [9632 bytes data]
> * schannel: failed to decrypt data, need more data
> { [6880 bytes data]
> * schannel: failed to decrypt data, need more data
> { [2752 bytes data]
> * schannel: failed to decrypt data, need more data
> { [7994 bytes data]
> 100  193k    0  193k    0     0   293k      0 --:--:-- --:--:-- --:--:-- 
>   294k* schannel: failed to decrypt data, need more data
> { [28937 bytes data]
> * schannel: failed to decrypt data, need more data
> { [8414 bytes data]
> * schannel: failed to decrypt data, need more data
> { [9632 bytes data]
> * schannel: failed to decrypt data, need more data
> { [5504 bytes data]
> * schannel: failed to decrypt data, need more data
> { [5504 bytes data]
> * schannel: failed to decrypt data, need more data
> { [7852 bytes data]
> * schannel: failed to decrypt data, need more data
> { [5504 bytes data]
> * schannel: failed to decrypt data, need more data
> { [17888 bytes data]
> * schannel: failed to decrypt data, need more data
> { [19016 bytes data]
> * schannel: failed to decrypt data, need more data
> { [15136 bytes data]
> * schannel: failed to decrypt data, need more data
> { [10760 bytes data]
> * schannel: failed to decrypt data, need more data
> { [6880 bytes data]
> * schannel: failed to decrypt data, need more data
> { [34152 bytes data]
> * schannel: failed to decrypt data, need more data
> { [28648 bytes data]
> * schannel: failed to decrypt data, need more data
> { [33026 bytes data]
> * schannel: failed to decrypt data, need more data
> { [14888 bytes data]
> * schannel: failed to decrypt data, need more data
> { [24768 bytes data]
> * schannel: failed to decrypt data, need more data
> { [12136 bytes data]
> 100  498k    0  498k    0     0   665k      0 --:--:-- --:--:-- --:--:-- 
>   669k
> * Connection #0 to host www.youtube.com <http://www.youtube.com> left intact
> 
> And the access.log:
> 1724083303.298      0 192.168.78.15 NONE_NONE/000 0 - 
> error:invalid-request - HIER_NONE/- - -
> 1724083303.888    589 192.168.78.15 TCP_TUNNEL/200 529157 CONNECT 
> 142.250.185.78:443 <http://142.250.185.78:443> - 
> ORIGINAL_DST/142.250.185.78 <http://142.250.185.78> - -
> 1724083307.305      0 192.168.78.15 NONE_NONE/000 0 - 
> error:invalid-request - HIER_NONE/- - -
> 1724083307.908    603 192.168.78.15 TCP_TUNNEL/200 530241 CONNECT 
> 142.250.185.78:443 <http://142.250.185.78:443> - 
> ORIGINAL_DST/142.250.185.78 <http://142.250.185.78> - -
> 1724083311.615      0 192.168.78.15 NONE_NONE/000 0 - 
> error:invalid-request - HIER_NONE/- - -
> 1724083312.255    640 192.168.78.15 TCP_TUNNEL/200 528465 CONNECT 
> 142.250.185.78:443 <http://142.250.185.78:443> - 
> ORIGINAL_DST/142.250.185.78 <http://142.250.185.78> - -
> 1724083316.666      0 192.168.78.15 NONE_NONE/000 0 - 
> error:invalid-request - HIER_NONE/- - -
> 1724083317.315    649 192.168.78.15 TCP_TUNNEL/200 529617 CONNECT 
> 142.250.185.78:443 <http://142.250.185.78:443> - 
> ORIGINAL_DST/142.250.185.78 <http://142.250.185.78> - -
> 1724083342.731      0 192.168.78.15 NONE_NONE/000 0 - 
> error:invalid-request - HIER_NONE/- - -
> 1724083343.377    645 192.168.78.15 TCP_TUNNEL/200 528377 CONNECT 
> 142.250.185.78:443 <http://142.250.185.78:443> - 
> ORIGINAL_DST/142.250.185.78 <http://142.250.185.78> - -
> 1724083378.565      0 192.168.78.15 NONE_NONE/000 0 - 
> error:invalid-request - HIER_NONE/- - -
> 1724083378.801      0 192.168.78.15 NONE_NONE/000 0 - 
> error:invalid-request - HIER_NONE/- - -
> 
> 
> ----
> Eliezer Croitoru
> Tech Support
> Mobile: +972-5-28704261
> Email: ngtech1ltd at gmail.com <mailto:ngtech1ltd at gmail.com>
> 
> 
> On Mon, Aug 19, 2024 at 3:21?PM Alex Rousskov 
> <rousskov at measurement-factory.com 
> <mailto:rousskov at measurement-factory.com>> wrote:
> 
>     On 2024-08-19 03:47, NgTech LTD wrote:
>      > I am testing Squid 6.10 on Fedora 40 (their package).
>      > And it seems that Squid is unable to bump clients (ESNI/ECH)?
>      >
>      > I had couple iterations of pek stare and bump and I am not sure
>     what is
>      > the reason for that:
> 
>     What do you use as a client? Judging by the number of
>     error:invalid-request entries in your access.log, that client may
>     not be
>     speaking HTTP/1 inside those CONNECT tunnels.
> 
>     Does everything work for non-intercept ports?
> 
>     Does everything work in a basic curl or wget test?
> 
>     Does everything work when you remove "ssl-bump" and related options
>     from
>     intercepting http_port 33128?
> 
>     Does everything work when you use "ssl_bump splice all" instead of your
>     current ssl_bump rule?
> 
>     Does everything work when you use "ssl_bump peek all" instead of your
>     current ssl_bump rule?
> 
>     Alex.
> 
> 
>      > shutdown_lifetime 3 seconds
>      > external_acl_type whitelist-lookup-helper ipv4 ttl=10
>     children-max=10
>      > children-startup=2 \
>      >          children-idle=2 concurrency=10 %URI %SRC
>      > /usr/local/bin/squid-conf-url-lookup.rb
>      > acl whitelist-lookup external  whitelist-lookup-helper
>      > acl ytmethods method POST GET
>      > acl localnet src 0.0.0.1-0.255.255.255  # RFC 1122 "this" network
>     (LAN)
>      > acl localnet src 10.0.0.0/8 <http://10.0.0.0/8>
>     <http://10.0.0.0/8 <http://10.0.0.0/8>>             # RFC 1918
>      > local private network (LAN)
>      > acl localnet src 100.64.0.0/10 <http://100.64.0.0/10>
>     <http://100.64.0.0/10 <http://100.64.0.0/10>>          # RFC
>      > 6598 shared address space (CGN)
>      > acl localnet src 169.254.0.0/16 <http://169.254.0.0/16>
>     <http://169.254.0.0/16 <http://169.254.0.0/16>>         # RFC
>      > 3927 link-local (directly plugged) machines
>      > acl localnet src 172.16.0.0/12 <http://172.16.0.0/12>
>     <http://172.16.0.0/12 <http://172.16.0.0/12>>          # RFC
>      > 1918 local private network (LAN)
>      > acl localnet src 192.168.0.0/16 <http://192.168.0.0/16>
>     <http://192.168.0.0/16 <http://192.168.0.0/16>>         # RFC
>      > 1918 local private network (LAN)
>      > acl localnet src fc00::/7               # RFC 4193 local private
>     network
>      > range
>      > acl localnet src fe80::/10              # RFC 4291 link-local
>     (directly
>      > plugged) machines
>      > acl SSL_ports port 443
>      > acl Safe_ports port 80          # http
>      > acl Safe_ports port 21          # ftp
>      > acl Safe_ports port 443         # https
>      > acl Safe_ports port 70          # gopher
>      > acl Safe_ports port 210         # wais
>      > acl Safe_ports port 1025-65535  # unregistered ports
>      > acl Safe_ports port 280         # http-mgmt
>      > acl Safe_ports port 488         # gss-http
>      > acl Safe_ports port 591         # filemaker
>      > acl Safe_ports port 777         # multiling http
>      > http_access deny !Safe_ports
>      > http_access deny CONNECT !SSL_ports
>      > http_access allow localhost manager
>      > http_access deny manager
>      > http_access allow localhost
>      > http_access deny to_localhost
>      > http_access deny to_linklocal
>      > acl tubedoms dstdomain .ytimg.com <http://ytimg.com>
>     <http://ytimg.com <http://ytimg.com>> .youtube.com <http://youtube.com>
>      > <http://youtube.com <http://youtube.com>> .youtu.be
>     <http://youtu.be> <http://youtu.be <http://youtu.be>>
>      > http_access allow ytmethods localnet tubedoms whitelist-lookup
>      > http_access allow localnet
>      > http_access deny all
>      > http_port 3128
>      > http_port 13128 ssl-bump tls-cert=/etc/squid/ssl/cert.pem
>      > tls-key=/etc/squid/ssl/key.pem \
>      >          generate-host-certificates=on
>     dynamic_cert_mem_cache_size=4MB
>      > http_port 23128 tproxy ssl-bump tls-cert=/etc/squid/ssl/cert.pem
>      > tls-key=/etc/squid/ssl/key.pem \
>      >          generate-host-certificates=on
>     dynamic_cert_mem_cache_size=4MB
>      > http_port 33128 intercept ssl-bump tls-cert=/etc/squid/ssl/cert.pem
>      > tls-key=/etc/squid/ssl/key.pem \
>      >          generate-host-certificates=on
>     dynamic_cert_mem_cache_size=4MB
>      > sslcrtd_program /usr/lib64/squid/security_file_certgen -s
>      > /var/spool/squid/ssl_db -M 4MB
>      > sslcrtd_children 5
>      > acl foreignProtocol squid_error ERR_PROTOCOL_UNKNOWN ERR_TOO_BIG
>      > acl serverTalksFirstProtocol squid_error ERR_REQUEST_START_TIMEOUT
>      > on_unsupported_protocol tunnel foreignProtocol
>      > on_unsupported_protocol tunnel serverTalksFirstProtocol
>      > on_unsupported_protocol respond all
>      > acl monitoredSites ssl::server_name .youtube.com
>     <http://youtube.com> <http://youtube.com <http://youtube.com>>
>      > .ytimg.com <http://ytimg.com> <http://ytimg.com <http://ytimg.com>>
>      > acl monitoredSitesRegex ssl::server_name_regex \.youtube\.com
>     \.ytimg\.com
>      > acl serverIsBank ssl::server_name .visa.com <http://visa.com>
>     <http://visa.com <http://visa.com>>
>      > acl step1 at_step SslBump1
>      > acl step2 at_step SslBump2
>      > acl step3 at_step SslBump3
>      > ssl_bump bump all
>      > strip_query_terms off
>      > coredump_dir /var/spool/squid
>      > refresh_pattern ^ftp:           1440    20%     10080
>      > refresh_pattern -i (/cgi-bin/|\?) 0     0%      0
>      > refresh_pattern .               0       20%     4320
>      > logformat ssl_custom_format %ts.%03tu %6tr %>a %Ss/%03>Hs %<st
>     %rm %ru
>      > %[un %Sh/%<a %mt %ssl::>sni
>      > access_log daemon:/var/log/squid/access.log ssl_custom_format
>      > ##EOF
>      >
>      > access.log from before:
>      > 1724028804.797    486 192.168.78.15 TCP_TUNNEL/200 17764 CONNECT
>      > 40.126.31.73:443 <http://40.126.31.73:443>
>     <http://40.126.31.73:443 <http://40.126.31.73:443>> -
>     ORIGINAL_DST/40.126.31.73 <http://40.126.31.73>
>      > <http://40.126.31.73 <http://40.126.31.73>> - -
>      > 1724028805.413      0 192.168.78.15 NONE_NONE/000 0 -
>      > error:invalid-request - HIER_NONE/- - -
>      > 1724028806.028      0 192.168.78.15 NONE_NONE/000 0 -
>      > error:invalid-request - HIER_NONE/- - -
>      > 1724028806.028      0 192.168.78.15 NONE_NONE/000 0 -
>      > error:invalid-request - HIER_NONE/- - -
>      > 1724028806.029      0 192.168.78.15 NONE_NONE/000 0 -
>      > error:invalid-request - HIER_NONE/- - -
>      > 1724028806.030      0 192.168.78.15 NONE_NONE/000 0 -
>      > error:invalid-request - HIER_NONE/- - -
>      > 1724028806.085     57 192.168.78.15 TCP_TUNNEL/200 4513 CONNECT
>      > 104.18.72.113:443 <http://104.18.72.113:443>
>     <http://104.18.72.113:443 <http://104.18.72.113:443>> -
>      > ORIGINAL_DST/104.18.72.113 <http://104.18.72.113>
>     <http://104.18.72.113 <http://104.18.72.113>> - -
>      > 1724028806.086     56 192.168.78.15 TCP_TUNNEL/200 4513 CONNECT
>      > 104.18.72.113:443 <http://104.18.72.113:443>
>     <http://104.18.72.113:443 <http://104.18.72.113:443>> -
>      > ORIGINAL_DST/104.18.72.113 <http://104.18.72.113>
>     <http://104.18.72.113 <http://104.18.72.113>> - -
>      > 1724028806.086     56 192.168.78.15 TCP_TUNNEL/200 4512 CONNECT
>      > 104.18.72.113:443 <http://104.18.72.113:443>
>     <http://104.18.72.113:443 <http://104.18.72.113:443>> -
>      > ORIGINAL_DST/104.18.72.113 <http://104.18.72.113>
>     <http://104.18.72.113 <http://104.18.72.113>> - -
>      > 1724028806.208      0 192.168.78.15 NONE_NONE/000 0 -
>      > error:invalid-request - HIER_NONE/- - -
>      > 1724028806.213      0 192.168.78.15 NONE_NONE/000 0 -
>      > error:invalid-request - HIER_NONE/- - -
>      > 1724028806.338      0 192.168.78.15 NONE_NONE/000 0 -
>      > error:invalid-request - HIER_NONE/- - -
>      > 1724028806.469      0 192.168.78.15 NONE_NONE/000 0 -
>      > error:invalid-request - HIER_NONE/- - -
>      > 1724028806.596      0 192.168.78.15 NONE_NONE/000 0 -
>      > error:invalid-request - HIER_NONE/- - -
>      > 1724028807.006      0 192.168.78.15 NONE_NONE/000 0 -
>      > error:invalid-request - HIER_NONE/- - -
>      > 1724028807.262      0 192.168.78.15 NONE_NONE/000 0 -
>      > error:invalid-request - HIER_NONE/- - -
>      > 1724028808.922   5037 192.168.78.15 TCP_TUNNEL/200 6096 CONNECT
>      > 13.107.246.60:443 <http://13.107.246.60:443>
>     <http://13.107.246.60:443 <http://13.107.246.60:443>> -
>      > ORIGINAL_DST/13.107.246.60 <http://13.107.246.60>
>     <http://13.107.246.60 <http://13.107.246.60>> - -
>      > 1724028812.906   8336 192.168.78.15 TCP_TUNNEL/200 1071500 CONNECT
>      > 104.126.37.171:443 <http://104.126.37.171:443>
>     <http://104.126.37.171:443 <http://104.126.37.171:443>> -
>      > ORIGINAL_DST/104.126.37.171 <http://104.126.37.171>
>     <http://104.126.37.171 <http://104.126.37.171>> - -
>      > 1724028819.209 247893 192.168.78.15 TCP_TUNNEL/200 4023 CONNECT
>      > 142.250.186.34:443 <http://142.250.186.34:443>
>     <http://142.250.186.34:443 <http://142.250.186.34:443>> -
>      > ORIGINAL_DST/142.250.186.34 <http://142.250.186.34>
>     <http://142.250.186.34 <http://142.250.186.34>> - -
>      > 1724028820.097 250033 192.168.78.15 TCP_TUNNEL/200 549611 CONNECT
>      > 142.250.184.246:443 <http://142.250.184.246:443>
>     <http://142.250.184.246:443 <http://142.250.184.246:443>> -
>      > ORIGINAL_DST/142.250.184.246 <http://142.250.184.246>
>     <http://142.250.184.246 <http://142.250.184.246>> - -
>      > 1724028820.154 246850 192.168.78.15 TCP_TUNNEL/200 15119 CONNECT
>      > 216.58.206.65:443 <http://216.58.206.65:443>
>     <http://216.58.206.65:443 <http://216.58.206.65:443>> -
>      > ORIGINAL_DST/216.58.206.65 <http://216.58.206.65>
>     <http://216.58.206.65 <http://216.58.206.65>> - -
>      > 1724028820.164 246856 192.168.78.15 TCP_TUNNEL/200 3037 CONNECT
>      > 142.250.181.227:443 <http://142.250.181.227:443>
>     <http://142.250.181.227:443 <http://142.250.181.227:443>> -
>      > ORIGINAL_DST/142.250.181.227 <http://142.250.181.227>
>     <http://142.250.181.227 <http://142.250.181.227>> - -
>      > 1724028820.203 246893 192.168.78.15 TCP_TUNNEL/200 3031 CONNECT
>      > 172.217.16.196:443 <http://172.217.16.196:443>
>     <http://172.217.16.196:443 <http://172.217.16.196:443>> -
>      > ORIGINAL_DST/172.217.16.196 <http://172.217.16.196>
>     <http://172.217.16.196 <http://172.217.16.196>> - -
>      > 1724028822.656 271833 192.168.78.15 TCP_TUNNEL/200 387583 CONNECT
>      > 142.250.185.238:443 <http://142.250.185.238:443>
>     <http://142.250.185.238:443 <http://142.250.185.238:443>> -
>      > ORIGINAL_DST/142.250.185.238 <http://142.250.185.238>
>     <http://142.250.185.238 <http://142.250.185.238>> - -
>      > 1724028830.336      0 192.168.78.15 NONE_NONE/000 0 -
>      > error:invalid-request - HIER_NONE/- - -
>      > 1724028830.781    444 192.168.78.15 TCP_TUNNEL/200 18505 CONNECT
>      > 40.126.31.73:443 <http://40.126.31.73:443>
>     <http://40.126.31.73:443 <http://40.126.31.73:443>> -
>     ORIGINAL_DST/40.126.31.73 <http://40.126.31.73>
>      > <http://40.126.31.73 <http://40.126.31.73>> - -
>      > 1724028841.781 155018 192.168.78.15 TCP_TUNNEL/200 15960 CONNECT
>      > 13.107.6.158:443 <http://13.107.6.158:443>
>     <http://13.107.6.158:443 <http://13.107.6.158:443>> -
>     ORIGINAL_DST/13.107.6.158 <http://13.107.6.158>
>      > <http://13.107.6.158 <http://13.107.6.158>> - -
>      > 1724028849.443      0 192.168.78.15 NONE_NONE/000 0 -
>      > error:invalid-request - HIER_NONE/- - -
>      > 1724028849.698      0 192.168.78.15 NONE_NONE/000 0 -
>      > error:invalid-request - HIER_NONE/- - -
>      > 1724028865.261      0 192.168.78.15 NONE_NONE/000 0 -
>      > error:invalid-request - HIER_NONE/- - -
>      > 1724028865.779    517 192.168.78.15 TCP_TUNNEL/200 18557 CONNECT
>      > 40.126.31.73:443 <http://40.126.31.73:443>
>     <http://40.126.31.73:443 <http://40.126.31.73:443>> -
>     ORIGINAL_DST/40.126.31.73 <http://40.126.31.73>
>      > <http://40.126.31.73 <http://40.126.31.73>> - -
>      > 1724028870.718 109994 192.168.78.15 TCP_TUNNEL/200 6972 CONNECT
>      > 20.42.65.94:443 <http://20.42.65.94:443> <http://20.42.65.94:443
>     <http://20.42.65.94:443>> - ORIGINAL_DST/20.42.65.94
>     <http://20.42.65.94>
>      > <http://20.42.65.94 <http://20.42.65.94>> - -
>      > 1724028871.179  64583 192.168.78.15 TCP_TUNNEL/200 1903 CONNECT
>      > 104.18.10.207:443 <http://104.18.10.207:443>
>     <http://104.18.10.207:443 <http://104.18.10.207:443>> -
>      > ORIGINAL_DST/104.18.10.207 <http://104.18.10.207>
>     <http://104.18.10.207 <http://104.18.10.207>> - -
>      > 1724028871.179  63917 192.168.78.15 TCP_TUNNEL/200 2430 CONNECT
>      > 142.250.186.99:443 <http://142.250.186.99:443>
>     <http://142.250.186.99:443 <http://142.250.186.99:443>> -
>      > ORIGINAL_DST/142.250.186.99 <http://142.250.186.99>
>     <http://142.250.186.99 <http://142.250.186.99>> - -
>      > 1724028871.179  64709 192.168.78.15 TCP_TUNNEL/200 2439 CONNECT
>      > 142.250.185.170:443 <http://142.250.185.170:443>
>     <http://142.250.185.170:443 <http://142.250.185.170:443>> -
>      > ORIGINAL_DST/142.250.185.170 <http://142.250.185.170>
>     <http://142.250.185.170 <http://142.250.185.170>> - -
>      > 1724028871.308      0 192.168.78.15 NONE_NONE/000 0 -
>      > error:invalid-request - HIER_NONE/- - -
>      > 1724028871.731    422 192.168.78.15 TCP_TUNNEL/200 17789 CONNECT
>      > 40.126.31.73:443 <http://40.126.31.73:443>
>     <http://40.126.31.73:443 <http://40.126.31.73:443>> -
>     ORIGINAL_DST/40.126.31.73 <http://40.126.31.73>
>      > <http://40.126.31.73 <http://40.126.31.73>> - -
>      > 1724028872.486      0 192.168.78.15 NONE_NONE/000 0 -
>      > error:invalid-request - HIER_NONE/- - -
>      > 1724028873.477      0 192.168.78.15 NONE_NONE/000 0 -
>      > error:invalid-request - HIER_NONE/- - -
>      > 1724028873.745      0 192.168.78.15 NONE_NONE/000 0 -
>      > error:invalid-request - HIER_NONE/- - -
>      > 1724028873.902    424 192.168.78.15 TCP_TUNNEL/200 18520 CONNECT
>      > 40.126.31.73:443 <http://40.126.31.73:443>
>     <http://40.126.31.73:443 <http://40.126.31.73:443>> -
>     ORIGINAL_DST/40.126.31.73 <http://40.126.31.73>
>      > <http://40.126.31.73 <http://40.126.31.73>> - -
>      > 1724028877.056      0 192.168.78.15 NONE_NONE/000 0 -
>      > error:invalid-request - HIER_NONE/- - -
>      > 1724028877.060      0 192.168.78.15 NONE_NONE/000 0 -
>      > error:invalid-request - HIER_NONE/- - -
>      > 1724028877.060      0 192.168.78.15 NONE_NONE/000 0 -
>      > error:invalid-request - HIER_NONE/- - -
>      > 1724028877.060      0 192.168.78.15 NONE_NONE/000 0 -
>      > error:invalid-request - HIER_NONE/- - -
>      > 1724028877.430 312389 192.168.78.15 TCP_TUNNEL/200 7884 CONNECT
>      > 142.250.186.78:443 <http://142.250.186.78:443>
>     <http://142.250.186.78:443 <http://142.250.186.78:443>> -
>      > ORIGINAL_DST/142.250.186.78 <http://142.250.186.78>
>     <http://142.250.186.78 <http://142.250.186.78>> - -
>      > 1724028878.800      0 192.168.78.15 NONE_NONE/000 0 -
>      > error:invalid-request - HIER_NONE/- - -
>      > 1724028878.920      0 192.168.78.15 NONE_NONE/000 0 -
>      > error:invalid-request - HIER_NONE/- - -
>      > 1724028879.072      0 192.168.78.15 NONE_NONE/000 0 -
>      > error:invalid-request - HIER_NONE/- - -
>      > 1724028880.808   7062 192.168.78.15 TCP_TUNNEL/200 836391 CONNECT
>      > 104.126.37.145:443 <http://104.126.37.145:443>
>     <http://104.126.37.145:443 <http://104.126.37.145:443>> -
>      > ORIGINAL_DST/104.126.37.145 <http://104.126.37.145>
>     <http://104.126.37.145 <http://104.126.37.145>> - -
>      > 1724028882.468  33024 192.168.78.15 TCP_TUNNEL/200 1488697 CONNECT
>      > 49.12.59.2:443 <http://49.12.59.2:443> <http://49.12.59.2:443
>     <http://49.12.59.2:443>> - ORIGINAL_DST/49.12.59.2 <http://49.12.59.2>
>      > <http://49.12.59.2 <http://49.12.59.2>> - -
>      > 1724028883.728   6671 192.168.78.15 TCP_TUNNEL/200 69351 CONNECT
>      > 52.216.185.251:443 <http://52.216.185.251:443>
>     <http://52.216.185.251:443 <http://52.216.185.251:443>> -
>      > ORIGINAL_DST/52.216.185.251 <http://52.216.185.251>
>     <http://52.216.185.251 <http://52.216.185.251>> - -
>      > 1724028883.789   6728 192.168.78.15 TCP_TUNNEL/200 69216 CONNECT
>      > 52.216.185.251:443 <http://52.216.185.251:443>
>     <http://52.216.185.251:443 <http://52.216.185.251:443>> -
>      > ORIGINAL_DST/52.216.185.251 <http://52.216.185.251>
>     <http://52.216.185.251 <http://52.216.185.251>> - -
>      > 1724028883.797   6736 192.168.78.15 TCP_TUNNEL/200 104657 CONNECT
>      > 52.216.185.251:443 <http://52.216.185.251:443>
>     <http://52.216.185.251:443 <http://52.216.185.251:443>> -
>      > ORIGINAL_DST/52.216.185.251 <http://52.216.185.251>
>     <http://52.216.185.251 <http://52.216.185.251>> - -
>      > 1724028883.845   6784 192.168.78.15 TCP_TUNNEL/200 80277 CONNECT
>      > 52.216.185.251:443 <http://52.216.185.251:443>
>     <http://52.216.185.251:443 <http://52.216.185.251:443>> -
>      > ORIGINAL_DST/52.216.185.251 <http://52.216.185.251>
>     <http://52.216.185.251 <http://52.216.185.251>> - -
>      > 1724028884.460 170355 192.168.78.15 TCP_TUNNEL/200 44690 CONNECT
>      > 185.199.108.153:443 <http://185.199.108.153:443>
>     <http://185.199.108.153:443 <http://185.199.108.153:443>> -
>      > ORIGINAL_DST/185.199.108.153 <http://185.199.108.153>
>     <http://185.199.108.153 <http://185.199.108.153>> - -
>      > 1724028889.845 120370 192.168.78.15 TCP_TUNNEL/200 5868 CONNECT
>      > 104.126.37.161:443 <http://104.126.37.161:443>
>     <http://104.126.37.161:443 <http://104.126.37.161:443>> -
>      > ORIGINAL_DST/104.126.37.161 <http://104.126.37.161>
>     <http://104.126.37.161 <http://104.126.37.161>> - -
>      > 1724028890.011 122862 192.168.78.15 TCP_TUNNEL/200 136726 CONNECT
>      > 23.37.37.211:443 <http://23.37.37.211:443>
>     <http://23.37.37.211:443 <http://23.37.37.211:443>> -
>     ORIGINAL_DST/23.37.37.211 <http://23.37.37.211>
>      > <http://23.37.37.211 <http://23.37.37.211>> - -
>      > 1724028890.297 120381 192.168.78.15 TCP_TUNNEL/200 9176 CONNECT
>      > 2.18.140.238:443 <http://2.18.140.238:443>
>     <http://2.18.140.238:443 <http://2.18.140.238:443>> -
>     ORIGINAL_DST/2.18.140.238 <http://2.18.140.238>
>      > <http://2.18.140.238 <http://2.18.140.238>> - -
>      > 1724028891.212      0 192.168.78.15 NONE_NONE/000 0 -
>      > error:invalid-request - HIER_NONE/- - -
>      > 1724028891.365    152 192.168.78.15 TCP_TUNNEL/200 2359 CONNECT
>      > 142.250.185.138:443 <http://142.250.185.138:443>
>     <http://142.250.185.138:443 <http://142.250.185.138:443>> -
>      > ORIGINAL_DST/142.250.185.138 <http://142.250.185.138>
>     <http://142.250.185.138 <http://142.250.185.138>> - -
>      > 1724028893.885  90253 192.168.78.15 TCP_TUNNEL/200 6374 CONNECT
>      > 13.107.246.60:443 <http://13.107.246.60:443>
>     <http://13.107.246.60:443 <http://13.107.246.60:443>> -
>      > ORIGINAL_DST/13.107.246.60 <http://13.107.246.60>
>     <http://13.107.246.60 <http://13.107.246.60>> - -
>      > 1724028900.169      0 192.168.78.15 NONE_NONE/000 0 -
>      > error:invalid-request - HIER_NONE/- - -
>      > 1724028934.465 900262 192.168.78.15 TCP_TUNNEL/200 5530 CONNECT
>      > 52.123.243.197:443 <http://52.123.243.197:443>
>     <http://52.123.243.197:443 <http://52.123.243.197:443>> -
>      > ORIGINAL_DST/52.123.243.197 <http://52.123.243.197>
>     <http://52.123.243.197 <http://52.123.243.197>> - -
>      > 1724028960.494  60324 192.168.78.15 TCP_TUNNEL/503 0 CONNECT
>      > 172.217.16.206:443 <http://172.217.16.206:443>
>     <http://172.217.16.206:443 <http://172.217.16.206:443>> -
>      > ORIGINAL_DST/172.217.16.206 <http://172.217.16.206>
>     <http://172.217.16.206 <http://172.217.16.206>> - -
>      > 1724028960.494      0 192.168.78.15 NONE_NONE/000 0 -
>      > error:transaction-end-before-headers - HIER_NONE/- - -
>      >
>      > Thanks for any help,
>      >
>      >
>      > ----
>      > Eliezer Croitoru
>      > Tech Support
>      > Mobile: +972-5-28704261
>      > Email: ngtech1ltd at gmail.com <mailto:ngtech1ltd at gmail.com>
>     <mailto:ngtech1ltd at gmail.com <mailto:ngtech1ltd at gmail.com>> 




From rousskov at measurement-factory.com  Mon Aug 19 19:59:13 2024
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Mon, 19 Aug 2024 15:59:13 -0400
Subject: [squid-users] Squid 6.10 on Fedora 40 cannot intercept and bump
 SSL Traffic
In-Reply-To: <000001daf26d$d620c5c0$82625140$@gmail.com>
References: <CABA8h=TSSsneVN5qvtaxsHfdknSd58ucZ9Vxg=Vxe5YWCsaAAA@mail.gmail.com>
 <6b375023-33d6-4812-8850-0a24cb562d2e@measurement-factory.com>
 <CABA8h=SJp88t3aj1cr-4LK-mqik6QL9nG_X2xumZ_mPwCoybxg@mail.gmail.com>
 <4a57096d-1218-4090-b62a-67d1a18173a7@measurement-factory.com>
 <000001daf26d$d620c5c0$82625140$@gmail.com>
Message-ID: <af9608b6-5388-4d78-8e96-eea3267b6bc7@measurement-factory.com>

On 2024-08-19 15:27, ngtech1ltd at gmail.com wrote:

> I see that there is a SNI so I am not sure how to look at the issue.

FWIW, as the next step, I still recommend answering the remaining open 
questions. Everything else makes a facinating read but is less likely to 
help us make progress (and may obscure/hide actual answers and test 
results). I will restate those remaining questions for your convenience:

* Do all those 12 access.log records correspond to a single curl 
request? If not, please only share access.log record(s) that do correspond.

2. Does everything work for non-intercept ports? Use the same curl test 
you have shared below, but specify proxy address for curl to use.

4. Does everything work when you remove "ssl-bump" and related options 
from intercepting http_port 33128 (and use that intercepted port in the 
same curl test)?

5. Does everything work when you use "ssl_bump splice all" instead of 
your current ssl_bump rule? Same curl parameters as in Q4.

6. Does everything work when you use "ssl_bump peek all" instead of your 
current ssl_bump rule? Same curl parameters as in Q4.


While going through the above list, top to bottom, if you find a test 
that does _not_ work, pause: There is no need to proceed with other, 
more complicated tests if an earlier simpler/basic test fails.


HTH,

Alex.


> I was thinking that maybe it's something with the OpenSSL version (3.x.x) on Fedora but then I installed both 5.9 and 6.10 on Almalinux 8 and the result is the same.
> 
> I will describe my setup which might give some background.
> I have a very big lab...
> In the front of the Internet connection there are couple NGFW devices and RouterOS.
> Mikrotik RouterOS is the edge and all the others are used with PBR accordingly.
> The proxy sits in a deferent segment on the network and I have tried couple methods to intercept the traffic with squid.
> The only one which works with Squid and the existing equipment and do not cause some weird loop is ethernet level tunnel ie not:
> * GRE
> * IPIP
> And couple others.
> 
> The only ones which works fine are:
> * EoIP (Mikrotik which is based on GRE0
> * VxLAN
> 
> There are two methods to intercept the traffic:
> * PBR+DNAT on the squid box
> * PBR+TPROXY on the squid box
> 
> Since the intercept method terminates the connection and creates a new one with the ip of the proxy it's very simple to even use gre and ipip.
> But, with tproxy to allow the traffic being identified currently as a packet which is not still in the routing stack we the linux OS need to tag it somehow.
> To do that the default "Salt" for the packet hash in the routing stack is the source and destination mac address.
> Due to this the only methods which are allowing to use tproxy are the above mentioned tunnels. (Maybe I will post a video on it later on with a demo)
> 
> The Mikrotik RouterOS device re-routes the traffic from the LAN interface into the VxLAN interface directly to the proxy machine which has a
> static or dynamic route to the LAN subnet via the other side of the VxLAN tunnel which is the edge RouterOS device.
> I want to gather a set of configurations and tests for this configurations to verify what might cause this issue and if possible to resolve it.
> For me it seems that if my FortiGate and CheckPoint devices are able to intercept the traffic and "Bump" it, there is no reason why squid should
> be able to do that the same way.
> 
> I will later on send you a private link to the pcaps in a zip file so you would be able to inspect this issue in the network level and to see if there is
> some details which can help us understand what cause this specific issue.
> 
> I want to say that bumping works fine on non-intercepted connections and that I have tested the interception with the two available methods ie:
> * DNAT Redirect
> * Tproxy
> 
> Thanks,
> Eliezer Croitoru
> 
> -----Original Message-----
> From: Alex Rousskov <rousskov at measurement-factory.com>
> Sent: Monday, August 19, 2024 7:18 PM
> To: NgTech LTD <ngtech1ltd at gmail.com>
> Subject: Re: [squid-users] Squid 6.10 on Fedora 40 cannot intercept and bump SSL Traffic
> 
> Eliezer, please move this thread back to squid-users mailing list
> instead of emailing me personally. When you do so, please clarify
> whether all 12 access.log records correspond to this single curl request
> (if not, please only share access.log record(s) that do correspond). --Alex.
> 
> On 2024-08-19 12:03, NgTech LTD wrote:
>> This is the output of curl on windows 11 desktop:
>> C:\Users\USER>curl https://www.youtube.com/ -k -v -o 1.txt
>>     % Total    % Received % Xferd  Average Speed   Time    Time     Time
>>    Current
>>                                    Dload  Upload   Total   Spent    Left
>>    Speed
>>     0     0    0     0    0     0      0      0 --:--:-- --:--:--
>> --:--:--     0* Host www.youtube.com:443 <http://www.youtube.com:443>
>> was resolved.
>> * IPv6: 2a00:1450:4001:800::200e, 2a00:1450:4001:80e::200e,
>> 2a00:1450:4001:81c::200e, 2a00:1450:4001:809::200e
>> * IPv4: 142.250.185.78, 142.250.185.110, 142.250.185.142,
>> 142.250.186.174, 142.250.185.174, 142.250.184.238, 142.250.185.238,
>> 142.250.185.206, 142.250.181.238, 142.250.186.46, 142.250.186.78,
>> 172.217.16.142, 216.58.212.174, 216.58.206.46, 172.217.23.110,
>> 216.58.212.142
>> *   Trying 142.250.185.78:443...
>> * Connected to www.youtube.com <http://www.youtube.com> (142.250.185.78)
>> port 443
>> * schannel: disabled automatic use of client certificate
>> * ALPN: curl offers http/1.1
>> * ALPN: server accepted http/1.1
>> * using HTTP/1.x
>>   > GET / HTTP/1.1
>>   > Host: www.youtube.com <http://www.youtube.com>
>>   > User-Agent: curl/8.8.0
>>   > Accept: */*
>>   >
>> * Request completely sent off
>> * schannel: remote party requests renegotiation
>> * schannel: renegotiating SSL/TLS connection
>> * schannel: SSL/TLS connection renegotiated
>> * schannel: failed to decrypt data, need more data
>> < HTTP/1.1 200 OK
>> < Content-Type: text/html; charset=utf-8
>> < X-Content-Type-Options: nosniff
>> < Cache-Control: no-cache, no-store, max-age=0, must-revalidate
>> < Pragma: no-cache
>> < Expires: Mon, 01 Jan 1990 00:00:00 GMT
>> < Date: Mon, 19 Aug 2024 16:02:23 GMT
>> < X-Frame-Options: SAMEORIGIN
>> < Strict-Transport-Security: max-age=31536000
>> < Origin-Trial:
>> AmhMBR6zCLzDDxpW+HfpP67BqwIknWnyMOXOQGfzYswFmJe+fgaI6XZgAzcxOrzNtP7hEDsOo1jdjFnVr2IdxQ4AAAB4eyJvcmlnaW4iOiJodHRwczovL3lvdXR1YmUuY29tOjQ0MyIsImZlYXR1cmUiOiJXZWJWaWV3WFJlcXVlc3RlZFdpdGhEZXByZWNhdGlvbiIsImV4cGlyeSI6MTc1ODA2NzE5OSwiaXNTdWJkb21haW4iOnRydWV9
>> < Cross-Origin-Opener-Policy: same-origin-allow-popups;
>> report-to="youtube_main"
>> < Report-To:
>> {"group":"youtube_main","max_age":2592000,"endpoints":[{"url":"https://csp.withgoogle.com/csp/report-to/youtube_main <https://csp.withgoogle.com/csp/report-to/youtube_main>"}]}
>> < Content-Security-Policy: require-trusted-types-for 'script'
>> < Permissions-Policy: ch-ua-arch=*, ch-ua-bitness=*,
>> ch-ua-full-version=*, ch-ua-full-version-list=*, ch-ua-model=*,
>> ch-ua-wow64=*, ch-ua-form-factors=*, ch-ua-platform=*,
>> ch-ua-platform-version=*
>> < P3P: CP="This is not a P3P policy! See
>> http://support.google.com/accounts/answer/151657?hl=en
>> <http://support.google.com/accounts/answer/151657?hl=en> for more info."
>> < Server: ESF
>> < X-XSS-Protection: 0
>> < Set-Cookie: GPS=1; Domain=.youtube.com <http://youtube.com>;
>> Expires=Mon, 19-Aug-2024 16:32:23 GMT; Path=/; Secure; HttpOnly
>> < Set-Cookie: YSC=XYs_jViLkFw; Domain=.youtube.com <http://youtube.com>;
>> Path=/; Secure; HttpOnly; SameSite=none
>> < Set-Cookie: VISITOR_INFO1_LIVE=csMabhlNyrI; Domain=.youtube.com
>> <http://youtube.com>; Expires=Sat, 15-Feb-2025 16:02:23 GMT; Path=/;
>> Secure; HttpOnly; SameSite=none
>> < Set-Cookie: VISITOR_PRIVACY_METADATA=CgJJTBIEGgAgVw%3D%3D;
>> Domain=.youtube.com <http://youtube.com>; Expires=Sat, 15-Feb-2025
>> 16:02:23 GMT; Path=/; Secure; HttpOnly; SameSite=none
>> < Alt-Svc: h3=":443"; ma=2592000,h3-29=":443"; ma=2592000
>> < Accept-Ranges: none
>> < Vary: Accept-Encoding
>> < Transfer-Encoding: chunked
>> <
>> { [3674 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [8008 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [6880 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [2752 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [5504 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [2462 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [4128 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [2752 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [2752 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [4128 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [2752 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [5504 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [5504 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [4128 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [5242 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [2752 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [2752 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [6922 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [2752 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [6880 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [20378 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [6880 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [5504 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [5504 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [3839 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [6880 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [9632 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [6880 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [2752 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [7994 bytes data]
>> 100  193k    0  193k    0     0   293k      0 --:--:-- --:--:-- --:--:--
>>    294k* schannel: failed to decrypt data, need more data
>> { [28937 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [8414 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [9632 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [5504 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [5504 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [7852 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [5504 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [17888 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [19016 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [15136 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [10760 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [6880 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [34152 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [28648 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [33026 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [14888 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [24768 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [12136 bytes data]
>> 100  498k    0  498k    0     0   665k      0 --:--:-- --:--:-- --:--:--
>>    669k
>> * Connection #0 to host www.youtube.com <http://www.youtube.com> left intact
>>
>> And the access.log:
>> 1724083303.298      0 192.168.78.15 NONE_NONE/000 0 -
>> error:invalid-request - HIER_NONE/- - -
>> 1724083303.888    589 192.168.78.15 TCP_TUNNEL/200 529157 CONNECT
>> 142.250.185.78:443 <http://142.250.185.78:443> -
>> ORIGINAL_DST/142.250.185.78 <http://142.250.185.78> - -
>> 1724083307.305      0 192.168.78.15 NONE_NONE/000 0 -
>> error:invalid-request - HIER_NONE/- - -
>> 1724083307.908    603 192.168.78.15 TCP_TUNNEL/200 530241 CONNECT
>> 142.250.185.78:443 <http://142.250.185.78:443> -
>> ORIGINAL_DST/142.250.185.78 <http://142.250.185.78> - -
>> 1724083311.615      0 192.168.78.15 NONE_NONE/000 0 -
>> error:invalid-request - HIER_NONE/- - -
>> 1724083312.255    640 192.168.78.15 TCP_TUNNEL/200 528465 CONNECT
>> 142.250.185.78:443 <http://142.250.185.78:443> -
>> ORIGINAL_DST/142.250.185.78 <http://142.250.185.78> - -
>> 1724083316.666      0 192.168.78.15 NONE_NONE/000 0 -
>> error:invalid-request - HIER_NONE/- - -
>> 1724083317.315    649 192.168.78.15 TCP_TUNNEL/200 529617 CONNECT
>> 142.250.185.78:443 <http://142.250.185.78:443> -
>> ORIGINAL_DST/142.250.185.78 <http://142.250.185.78> - -
>> 1724083342.731      0 192.168.78.15 NONE_NONE/000 0 -
>> error:invalid-request - HIER_NONE/- - -
>> 1724083343.377    645 192.168.78.15 TCP_TUNNEL/200 528377 CONNECT
>> 142.250.185.78:443 <http://142.250.185.78:443> -
>> ORIGINAL_DST/142.250.185.78 <http://142.250.185.78> - -
>> 1724083378.565      0 192.168.78.15 NONE_NONE/000 0 -
>> error:invalid-request - HIER_NONE/- - -
>> 1724083378.801      0 192.168.78.15 NONE_NONE/000 0 -
>> error:invalid-request - HIER_NONE/- - -
>>
>>
>> ----
>> Eliezer Croitoru
>> Tech Support
>> Mobile: +972-5-28704261
>> Email: ngtech1ltd at gmail.com <mailto:ngtech1ltd at gmail.com>
>>
>>
>> On Mon, Aug 19, 2024 at 3:21?PM Alex Rousskov
>> <rousskov at measurement-factory.com
>> <mailto:rousskov at measurement-factory.com>> wrote:
>>
>>      On 2024-08-19 03:47, NgTech LTD wrote:
>>       > I am testing Squid 6.10 on Fedora 40 (their package).
>>       > And it seems that Squid is unable to bump clients (ESNI/ECH)?
>>       >
>>       > I had couple iterations of pek stare and bump and I am not sure
>>      what is
>>       > the reason for that:
>>
>>      What do you use as a client? Judging by the number of
>>      error:invalid-request entries in your access.log, that client may
>>      not be
>>      speaking HTTP/1 inside those CONNECT tunnels.
>>
>>      Does everything work for non-intercept ports?
>>
>>      Does everything work in a basic curl or wget test?
>>
>>      Does everything work when you remove "ssl-bump" and related options
>>      from
>>      intercepting http_port 33128?
>>
>>      Does everything work when you use "ssl_bump splice all" instead of your
>>      current ssl_bump rule?
>>
>>      Does everything work when you use "ssl_bump peek all" instead of your
>>      current ssl_bump rule?
>>
>>      Alex.
>>
>>
>>       > shutdown_lifetime 3 seconds
>>       > external_acl_type whitelist-lookup-helper ipv4 ttl=10
>>      children-max=10
>>       > children-startup=2 \
>>       >          children-idle=2 concurrency=10 %URI %SRC
>>       > /usr/local/bin/squid-conf-url-lookup.rb
>>       > acl whitelist-lookup external  whitelist-lookup-helper
>>       > acl ytmethods method POST GET
>>       > acl localnet src 0.0.0.1-0.255.255.255  # RFC 1122 "this" network
>>      (LAN)
>>       > acl localnet src 10.0.0.0/8 <http://10.0.0.0/8>
>>      <http://10.0.0.0/8 <http://10.0.0.0/8>>             # RFC 1918
>>       > local private network (LAN)
>>       > acl localnet src 100.64.0.0/10 <http://100.64.0.0/10>
>>      <http://100.64.0.0/10 <http://100.64.0.0/10>>          # RFC
>>       > 6598 shared address space (CGN)
>>       > acl localnet src 169.254.0.0/16 <http://169.254.0.0/16>
>>      <http://169.254.0.0/16 <http://169.254.0.0/16>>         # RFC
>>       > 3927 link-local (directly plugged) machines
>>       > acl localnet src 172.16.0.0/12 <http://172.16.0.0/12>
>>      <http://172.16.0.0/12 <http://172.16.0.0/12>>          # RFC
>>       > 1918 local private network (LAN)
>>       > acl localnet src 192.168.0.0/16 <http://192.168.0.0/16>
>>      <http://192.168.0.0/16 <http://192.168.0.0/16>>         # RFC
>>       > 1918 local private network (LAN)
>>       > acl localnet src fc00::/7               # RFC 4193 local private
>>      network
>>       > range
>>       > acl localnet src fe80::/10              # RFC 4291 link-local
>>      (directly
>>       > plugged) machines
>>       > acl SSL_ports port 443
>>       > acl Safe_ports port 80          # http
>>       > acl Safe_ports port 21          # ftp
>>       > acl Safe_ports port 443         # https
>>       > acl Safe_ports port 70          # gopher
>>       > acl Safe_ports port 210         # wais
>>       > acl Safe_ports port 1025-65535  # unregistered ports
>>       > acl Safe_ports port 280         # http-mgmt
>>       > acl Safe_ports port 488         # gss-http
>>       > acl Safe_ports port 591         # filemaker
>>       > acl Safe_ports port 777         # multiling http
>>       > http_access deny !Safe_ports
>>       > http_access deny CONNECT !SSL_ports
>>       > http_access allow localhost manager
>>       > http_access deny manager
>>       > http_access allow localhost
>>       > http_access deny to_localhost
>>       > http_access deny to_linklocal
>>       > acl tubedoms dstdomain .ytimg.com <http://ytimg.com>
>>      <http://ytimg.com <http://ytimg.com>> .youtube.com <http://youtube.com>
>>       > <http://youtube.com <http://youtube.com>> .youtu.be
>>      <http://youtu.be> <http://youtu.be <http://youtu.be>>
>>       > http_access allow ytmethods localnet tubedoms whitelist-lookup
>>       > http_access allow localnet
>>       > http_access deny all
>>       > http_port 3128
>>       > http_port 13128 ssl-bump tls-cert=/etc/squid/ssl/cert.pem
>>       > tls-key=/etc/squid/ssl/key.pem \
>>       >          generate-host-certificates=on
>>      dynamic_cert_mem_cache_size=4MB
>>       > http_port 23128 tproxy ssl-bump tls-cert=/etc/squid/ssl/cert.pem
>>       > tls-key=/etc/squid/ssl/key.pem \
>>       >          generate-host-certificates=on
>>      dynamic_cert_mem_cache_size=4MB
>>       > http_port 33128 intercept ssl-bump tls-cert=/etc/squid/ssl/cert.pem
>>       > tls-key=/etc/squid/ssl/key.pem \
>>       >          generate-host-certificates=on
>>      dynamic_cert_mem_cache_size=4MB
>>       > sslcrtd_program /usr/lib64/squid/security_file_certgen -s
>>       > /var/spool/squid/ssl_db -M 4MB
>>       > sslcrtd_children 5
>>       > acl foreignProtocol squid_error ERR_PROTOCOL_UNKNOWN ERR_TOO_BIG
>>       > acl serverTalksFirstProtocol squid_error ERR_REQUEST_START_TIMEOUT
>>       > on_unsupported_protocol tunnel foreignProtocol
>>       > on_unsupported_protocol tunnel serverTalksFirstProtocol
>>       > on_unsupported_protocol respond all
>>       > acl monitoredSites ssl::server_name .youtube.com
>>      <http://youtube.com> <http://youtube.com <http://youtube.com>>
>>       > .ytimg.com <http://ytimg.com> <http://ytimg.com <http://ytimg.com>>
>>       > acl monitoredSitesRegex ssl::server_name_regex \.youtube\.com
>>      \.ytimg\.com
>>       > acl serverIsBank ssl::server_name .visa.com <http://visa.com>
>>      <http://visa.com <http://visa.com>>
>>       > acl step1 at_step SslBump1
>>       > acl step2 at_step SslBump2
>>       > acl step3 at_step SslBump3
>>       > ssl_bump bump all
>>       > strip_query_terms off
>>       > coredump_dir /var/spool/squid
>>       > refresh_pattern ^ftp:           1440    20%     10080
>>       > refresh_pattern -i (/cgi-bin/|\?) 0     0%      0
>>       > refresh_pattern .               0       20%     4320
>>       > logformat ssl_custom_format %ts.%03tu %6tr %>a %Ss/%03>Hs %<st
>>      %rm %ru
>>       > %[un %Sh/%<a %mt %ssl::>sni
>>       > access_log daemon:/var/log/squid/access.log ssl_custom_format
>>       > ##EOF
>>       >
>>       > access.log from before:
>>       > 1724028804.797    486 192.168.78.15 TCP_TUNNEL/200 17764 CONNECT
>>       > 40.126.31.73:443 <http://40.126.31.73:443>
>>      <http://40.126.31.73:443 <http://40.126.31.73:443>> -
>>      ORIGINAL_DST/40.126.31.73 <http://40.126.31.73>
>>       > <http://40.126.31.73 <http://40.126.31.73>> - -
>>       > 1724028805.413      0 192.168.78.15 NONE_NONE/000 0 -
>>       > error:invalid-request - HIER_NONE/- - -
>>       > 1724028806.028      0 192.168.78.15 NONE_NONE/000 0 -
>>       > error:invalid-request - HIER_NONE/- - -
>>       > 1724028806.028      0 192.168.78.15 NONE_NONE/000 0 -
>>       > error:invalid-request - HIER_NONE/- - -
>>       > 1724028806.029      0 192.168.78.15 NONE_NONE/000 0 -
>>       > error:invalid-request - HIER_NONE/- - -
>>       > 1724028806.030      0 192.168.78.15 NONE_NONE/000 0 -
>>       > error:invalid-request - HIER_NONE/- - -
>>       > 1724028806.085     57 192.168.78.15 TCP_TUNNEL/200 4513 CONNECT
>>       > 104.18.72.113:443 <http://104.18.72.113:443>
>>      <http://104.18.72.113:443 <http://104.18.72.113:443>> -
>>       > ORIGINAL_DST/104.18.72.113 <http://104.18.72.113>
>>      <http://104.18.72.113 <http://104.18.72.113>> - -
>>       > 1724028806.086     56 192.168.78.15 TCP_TUNNEL/200 4513 CONNECT
>>       > 104.18.72.113:443 <http://104.18.72.113:443>
>>      <http://104.18.72.113:443 <http://104.18.72.113:443>> -
>>       > ORIGINAL_DST/104.18.72.113 <http://104.18.72.113>
>>      <http://104.18.72.113 <http://104.18.72.113>> - -
>>       > 1724028806.086     56 192.168.78.15 TCP_TUNNEL/200 4512 CONNECT
>>       > 104.18.72.113:443 <http://104.18.72.113:443>
>>      <http://104.18.72.113:443 <http://104.18.72.113:443>> -
>>       > ORIGINAL_DST/104.18.72.113 <http://104.18.72.113>
>>      <http://104.18.72.113 <http://104.18.72.113>> - -
>>       > 1724028806.208      0 192.168.78.15 NONE_NONE/000 0 -
>>       > error:invalid-request - HIER_NONE/- - -
>>       > 1724028806.213      0 192.168.78.15 NONE_NONE/000 0 -
>>       > error:invalid-request - HIER_NONE/- - -
>>       > 1724028806.338      0 192.168.78.15 NONE_NONE/000 0 -
>>       > error:invalid-request - HIER_NONE/- - -
>>       > 1724028806.469      0 192.168.78.15 NONE_NONE/000 0 -
>>       > error:invalid-request - HIER_NONE/- - -
>>       > 1724028806.596      0 192.168.78.15 NONE_NONE/000 0 -
>>       > error:invalid-request - HIER_NONE/- - -
>>       > 1724028807.006      0 192.168.78.15 NONE_NONE/000 0 -
>>       > error:invalid-request - HIER_NONE/- - -
>>       > 1724028807.262      0 192.168.78.15 NONE_NONE/000 0 -
>>       > error:invalid-request - HIER_NONE/- - -
>>       > 1724028808.922   5037 192.168.78.15 TCP_TUNNEL/200 6096 CONNECT
>>       > 13.107.246.60:443 <http://13.107.246.60:443>
>>      <http://13.107.246.60:443 <http://13.107.246.60:443>> -
>>       > ORIGINAL_DST/13.107.246.60 <http://13.107.246.60>
>>      <http://13.107.246.60 <http://13.107.246.60>> - -
>>       > 1724028812.906   8336 192.168.78.15 TCP_TUNNEL/200 1071500 CONNECT
>>       > 104.126.37.171:443 <http://104.126.37.171:443>
>>      <http://104.126.37.171:443 <http://104.126.37.171:443>> -
>>       > ORIGINAL_DST/104.126.37.171 <http://104.126.37.171>
>>      <http://104.126.37.171 <http://104.126.37.171>> - -
>>       > 1724028819.209 247893 192.168.78.15 TCP_TUNNEL/200 4023 CONNECT
>>       > 142.250.186.34:443 <http://142.250.186.34:443>
>>      <http://142.250.186.34:443 <http://142.250.186.34:443>> -
>>       > ORIGINAL_DST/142.250.186.34 <http://142.250.186.34>
>>      <http://142.250.186.34 <http://142.250.186.34>> - -
>>       > 1724028820.097 250033 192.168.78.15 TCP_TUNNEL/200 549611 CONNECT
>>       > 142.250.184.246:443 <http://142.250.184.246:443>
>>      <http://142.250.184.246:443 <http://142.250.184.246:443>> -
>>       > ORIGINAL_DST/142.250.184.246 <http://142.250.184.246>
>>      <http://142.250.184.246 <http://142.250.184.246>> - -
>>       > 1724028820.154 246850 192.168.78.15 TCP_TUNNEL/200 15119 CONNECT
>>       > 216.58.206.65:443 <http://216.58.206.65:443>
>>      <http://216.58.206.65:443 <http://216.58.206.65:443>> -
>>       > ORIGINAL_DST/216.58.206.65 <http://216.58.206.65>
>>      <http://216.58.206.65 <http://216.58.206.65>> - -
>>       > 1724028820.164 246856 192.168.78.15 TCP_TUNNEL/200 3037 CONNECT
>>       > 142.250.181.227:443 <http://142.250.181.227:443>
>>      <http://142.250.181.227:443 <http://142.250.181.227:443>> -
>>       > ORIGINAL_DST/142.250.181.227 <http://142.250.181.227>
>>      <http://142.250.181.227 <http://142.250.181.227>> - -
>>       > 1724028820.203 246893 192.168.78.15 TCP_TUNNEL/200 3031 CONNECT
>>       > 172.217.16.196:443 <http://172.217.16.196:443>
>>      <http://172.217.16.196:443 <http://172.217.16.196:443>> -
>>       > ORIGINAL_DST/172.217.16.196 <http://172.217.16.196>
>>      <http://172.217.16.196 <http://172.217.16.196>> - -
>>       > 1724028822.656 271833 192.168.78.15 TCP_TUNNEL/200 387583 CONNECT
>>       > 142.250.185.238:443 <http://142.250.185.238:443>
>>      <http://142.250.185.238:443 <http://142.250.185.238:443>> -
>>       > ORIGINAL_DST/142.250.185.238 <http://142.250.185.238>
>>      <http://142.250.185.238 <http://142.250.185.238>> - -
>>       > 1724028830.336      0 192.168.78.15 NONE_NONE/000 0 -
>>       > error:invalid-request - HIER_NONE/- - -
>>       > 1724028830.781    444 192.168.78.15 TCP_TUNNEL/200 18505 CONNECT
>>       > 40.126.31.73:443 <http://40.126.31.73:443>
>>      <http://40.126.31.73:443 <http://40.126.31.73:443>> -
>>      ORIGINAL_DST/40.126.31.73 <http://40.126.31.73>
>>       > <http://40.126.31.73 <http://40.126.31.73>> - -
>>       > 1724028841.781 155018 192.168.78.15 TCP_TUNNEL/200 15960 CONNECT
>>       > 13.107.6.158:443 <http://13.107.6.158:443>
>>      <http://13.107.6.158:443 <http://13.107.6.158:443>> -
>>      ORIGINAL_DST/13.107.6.158 <http://13.107.6.158>
>>       > <http://13.107.6.158 <http://13.107.6.158>> - -
>>       > 1724028849.443      0 192.168.78.15 NONE_NONE/000 0 -
>>       > error:invalid-request - HIER_NONE/- - -
>>       > 1724028849.698      0 192.168.78.15 NONE_NONE/000 0 -
>>       > error:invalid-request - HIER_NONE/- - -
>>       > 1724028865.261      0 192.168.78.15 NONE_NONE/000 0 -
>>       > error:invalid-request - HIER_NONE/- - -
>>       > 1724028865.779    517 192.168.78.15 TCP_TUNNEL/200 18557 CONNECT
>>       > 40.126.31.73:443 <http://40.126.31.73:443>
>>      <http://40.126.31.73:443 <http://40.126.31.73:443>> -
>>      ORIGINAL_DST/40.126.31.73 <http://40.126.31.73>
>>       > <http://40.126.31.73 <http://40.126.31.73>> - -
>>       > 1724028870.718 109994 192.168.78.15 TCP_TUNNEL/200 6972 CONNECT
>>       > 20.42.65.94:443 <http://20.42.65.94:443> <http://20.42.65.94:443
>>      <http://20.42.65.94:443>> - ORIGINAL_DST/20.42.65.94
>>      <http://20.42.65.94>
>>       > <http://20.42.65.94 <http://20.42.65.94>> - -
>>       > 1724028871.179  64583 192.168.78.15 TCP_TUNNEL/200 1903 CONNECT
>>       > 104.18.10.207:443 <http://104.18.10.207:443>
>>      <http://104.18.10.207:443 <http://104.18.10.207:443>> -
>>       > ORIGINAL_DST/104.18.10.207 <http://104.18.10.207>
>>      <http://104.18.10.207 <http://104.18.10.207>> - -
>>       > 1724028871.179  63917 192.168.78.15 TCP_TUNNEL/200 2430 CONNECT
>>       > 142.250.186.99:443 <http://142.250.186.99:443>
>>      <http://142.250.186.99:443 <http://142.250.186.99:443>> -
>>       > ORIGINAL_DST/142.250.186.99 <http://142.250.186.99>
>>      <http://142.250.186.99 <http://142.250.186.99>> - -
>>       > 1724028871.179  64709 192.168.78.15 TCP_TUNNEL/200 2439 CONNECT
>>       > 142.250.185.170:443 <http://142.250.185.170:443>
>>      <http://142.250.185.170:443 <http://142.250.185.170:443>> -
>>       > ORIGINAL_DST/142.250.185.170 <http://142.250.185.170>
>>      <http://142.250.185.170 <http://142.250.185.170>> - -
>>       > 1724028871.308      0 192.168.78.15 NONE_NONE/000 0 -
>>       > error:invalid-request - HIER_NONE/- - -
>>       > 1724028871.731    422 192.168.78.15 TCP_TUNNEL/200 17789 CONNECT
>>       > 40.126.31.73:443 <http://40.126.31.73:443>
>>      <http://40.126.31.73:443 <http://40.126.31.73:443>> -
>>      ORIGINAL_DST/40.126.31.73 <http://40.126.31.73>
>>       > <http://40.126.31.73 <http://40.126.31.73>> - -
>>       > 1724028872.486      0 192.168.78.15 NONE_NONE/000 0 -
>>       > error:invalid-request - HIER_NONE/- - -
>>       > 1724028873.477      0 192.168.78.15 NONE_NONE/000 0 -
>>       > error:invalid-request - HIER_NONE/- - -
>>       > 1724028873.745      0 192.168.78.15 NONE_NONE/000 0 -
>>       > error:invalid-request - HIER_NONE/- - -
>>       > 1724028873.902    424 192.168.78.15 TCP_TUNNEL/200 18520 CONNECT
>>       > 40.126.31.73:443 <http://40.126.31.73:443>
>>      <http://40.126.31.73:443 <http://40.126.31.73:443>> -
>>      ORIGINAL_DST/40.126.31.73 <http://40.126.31.73>
>>       > <http://40.126.31.73 <http://40.126.31.73>> - -
>>       > 1724028877.056      0 192.168.78.15 NONE_NONE/000 0 -
>>       > error:invalid-request - HIER_NONE/- - -
>>       > 1724028877.060      0 192.168.78.15 NONE_NONE/000 0 -
>>       > error:invalid-request - HIER_NONE/- - -
>>       > 1724028877.060      0 192.168.78.15 NONE_NONE/000 0 -
>>       > error:invalid-request - HIER_NONE/- - -
>>       > 1724028877.060      0 192.168.78.15 NONE_NONE/000 0 -
>>       > error:invalid-request - HIER_NONE/- - -
>>       > 1724028877.430 312389 192.168.78.15 TCP_TUNNEL/200 7884 CONNECT
>>       > 142.250.186.78:443 <http://142.250.186.78:443>
>>      <http://142.250.186.78:443 <http://142.250.186.78:443>> -
>>       > ORIGINAL_DST/142.250.186.78 <http://142.250.186.78>
>>      <http://142.250.186.78 <http://142.250.186.78>> - -
>>       > 1724028878.800      0 192.168.78.15 NONE_NONE/000 0 -
>>       > error:invalid-request - HIER_NONE/- - -
>>       > 1724028878.920      0 192.168.78.15 NONE_NONE/000 0 -
>>       > error:invalid-request - HIER_NONE/- - -
>>       > 1724028879.072      0 192.168.78.15 NONE_NONE/000 0 -
>>       > error:invalid-request - HIER_NONE/- - -
>>       > 1724028880.808   7062 192.168.78.15 TCP_TUNNEL/200 836391 CONNECT
>>       > 104.126.37.145:443 <http://104.126.37.145:443>
>>      <http://104.126.37.145:443 <http://104.126.37.145:443>> -
>>       > ORIGINAL_DST/104.126.37.145 <http://104.126.37.145>
>>      <http://104.126.37.145 <http://104.126.37.145>> - -
>>       > 1724028882.468  33024 192.168.78.15 TCP_TUNNEL/200 1488697 CONNECT
>>       > 49.12.59.2:443 <http://49.12.59.2:443> <http://49.12.59.2:443
>>      <http://49.12.59.2:443>> - ORIGINAL_DST/49.12.59.2 <http://49.12.59.2>
>>       > <http://49.12.59.2 <http://49.12.59.2>> - -
>>       > 1724028883.728   6671 192.168.78.15 TCP_TUNNEL/200 69351 CONNECT
>>       > 52.216.185.251:443 <http://52.216.185.251:443>
>>      <http://52.216.185.251:443 <http://52.216.185.251:443>> -
>>       > ORIGINAL_DST/52.216.185.251 <http://52.216.185.251>
>>      <http://52.216.185.251 <http://52.216.185.251>> - -
>>       > 1724028883.789   6728 192.168.78.15 TCP_TUNNEL/200 69216 CONNECT
>>       > 52.216.185.251:443 <http://52.216.185.251:443>
>>      <http://52.216.185.251:443 <http://52.216.185.251:443>> -
>>       > ORIGINAL_DST/52.216.185.251 <http://52.216.185.251>
>>      <http://52.216.185.251 <http://52.216.185.251>> - -
>>       > 1724028883.797   6736 192.168.78.15 TCP_TUNNEL/200 104657 CONNECT
>>       > 52.216.185.251:443 <http://52.216.185.251:443>
>>      <http://52.216.185.251:443 <http://52.216.185.251:443>> -
>>       > ORIGINAL_DST/52.216.185.251 <http://52.216.185.251>
>>      <http://52.216.185.251 <http://52.216.185.251>> - -
>>       > 1724028883.845   6784 192.168.78.15 TCP_TUNNEL/200 80277 CONNECT
>>       > 52.216.185.251:443 <http://52.216.185.251:443>
>>      <http://52.216.185.251:443 <http://52.216.185.251:443>> -
>>       > ORIGINAL_DST/52.216.185.251 <http://52.216.185.251>
>>      <http://52.216.185.251 <http://52.216.185.251>> - -
>>       > 1724028884.460 170355 192.168.78.15 TCP_TUNNEL/200 44690 CONNECT
>>       > 185.199.108.153:443 <http://185.199.108.153:443>
>>      <http://185.199.108.153:443 <http://185.199.108.153:443>> -
>>       > ORIGINAL_DST/185.199.108.153 <http://185.199.108.153>
>>      <http://185.199.108.153 <http://185.199.108.153>> - -
>>       > 1724028889.845 120370 192.168.78.15 TCP_TUNNEL/200 5868 CONNECT
>>       > 104.126.37.161:443 <http://104.126.37.161:443>
>>      <http://104.126.37.161:443 <http://104.126.37.161:443>> -
>>       > ORIGINAL_DST/104.126.37.161 <http://104.126.37.161>
>>      <http://104.126.37.161 <http://104.126.37.161>> - -
>>       > 1724028890.011 122862 192.168.78.15 TCP_TUNNEL/200 136726 CONNECT
>>       > 23.37.37.211:443 <http://23.37.37.211:443>
>>      <http://23.37.37.211:443 <http://23.37.37.211:443>> -
>>      ORIGINAL_DST/23.37.37.211 <http://23.37.37.211>
>>       > <http://23.37.37.211 <http://23.37.37.211>> - -
>>       > 1724028890.297 120381 192.168.78.15 TCP_TUNNEL/200 9176 CONNECT
>>       > 2.18.140.238:443 <http://2.18.140.238:443>
>>      <http://2.18.140.238:443 <http://2.18.140.238:443>> -
>>      ORIGINAL_DST/2.18.140.238 <http://2.18.140.238>
>>       > <http://2.18.140.238 <http://2.18.140.238>> - -
>>       > 1724028891.212      0 192.168.78.15 NONE_NONE/000 0 -
>>       > error:invalid-request - HIER_NONE/- - -
>>       > 1724028891.365    152 192.168.78.15 TCP_TUNNEL/200 2359 CONNECT
>>       > 142.250.185.138:443 <http://142.250.185.138:443>
>>      <http://142.250.185.138:443 <http://142.250.185.138:443>> -
>>       > ORIGINAL_DST/142.250.185.138 <http://142.250.185.138>
>>      <http://142.250.185.138 <http://142.250.185.138>> - -
>>       > 1724028893.885  90253 192.168.78.15 TCP_TUNNEL/200 6374 CONNECT
>>       > 13.107.246.60:443 <http://13.107.246.60:443>
>>      <http://13.107.246.60:443 <http://13.107.246.60:443>> -
>>       > ORIGINAL_DST/13.107.246.60 <http://13.107.246.60>
>>      <http://13.107.246.60 <http://13.107.246.60>> - -
>>       > 1724028900.169      0 192.168.78.15 NONE_NONE/000 0 -
>>       > error:invalid-request - HIER_NONE/- - -
>>       > 1724028934.465 900262 192.168.78.15 TCP_TUNNEL/200 5530 CONNECT
>>       > 52.123.243.197:443 <http://52.123.243.197:443>
>>      <http://52.123.243.197:443 <http://52.123.243.197:443>> -
>>       > ORIGINAL_DST/52.123.243.197 <http://52.123.243.197>
>>      <http://52.123.243.197 <http://52.123.243.197>> - -
>>       > 1724028960.494  60324 192.168.78.15 TCP_TUNNEL/503 0 CONNECT
>>       > 172.217.16.206:443 <http://172.217.16.206:443>
>>      <http://172.217.16.206:443 <http://172.217.16.206:443>> -
>>       > ORIGINAL_DST/172.217.16.206 <http://172.217.16.206>
>>      <http://172.217.16.206 <http://172.217.16.206>> - -
>>       > 1724028960.494      0 192.168.78.15 NONE_NONE/000 0 -
>>       > error:transaction-end-before-headers - HIER_NONE/- - -
>>       >
>>       > Thanks for any help,
>>       >
>>       >
>>       > ----
>>       > Eliezer Croitoru
>>       > Tech Support
>>       > Mobile: +972-5-28704261
>>       > Email: ngtech1ltd at gmail.com <mailto:ngtech1ltd at gmail.com>
>>      <mailto:ngtech1ltd at gmail.com <mailto:ngtech1ltd at gmail.com>>
> 
> 
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> https://lists.squid-cache.org/listinfo/squid-users



From rousskov at measurement-factory.com  Mon Aug 19 20:15:06 2024
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Mon, 19 Aug 2024 16:15:06 -0400
Subject: [squid-users] Squid.conf Issues
In-Reply-To: <7a2b553f248540ec86a12e805560eeff@hexcel.com>
References: <43696754c7d5443cba762cc72233e302@hexcel.com>
 <a09b6033-485c-492d-bfab-67fadbb3e310@measurement-factory.com>
 <7a2b553f248540ec86a12e805560eeff@hexcel.com>
Message-ID: <28b45bea-3b42-4ba2-9b24-d741432971c4@measurement-factory.com>

On 2024-08-19 13:48, Piana, Josh wrote:

> I added "http_access allow kerb-auth" as part of the generic
> authentication settings.
> 
> We still want authenticated users to access but we want the rules and
> ACL's prior to that to catch them first.

If you want http_access rule X to be checked before http_access rule Y, 
you have to list X above Y in squid.conf: Squid checks all http_access 
directives one by one, top to bottom. At the first match, Squid applies 
the matched action ("allow" or "deny") and does not check any 
other/lower http_access rules.


> I apologize, I'm quite new with Linux. Should I move that parameter
> to near the end of the config file or remove it all together?

FWIW, these access controls are not Linux-specific. I cannot tell you 
what http_access order is correct because I do not know what "We want 
authenticated users to access but we want to catch them first" means to 
you in terms of actual access rules. There are many ways to interpret 
that phrase...

In general, rules that do not depend on whether a user is authenticated 
should go above the rules that do depend (or require) authentication. 
This principle avoids needless authentication of potentially malicious 
requests. FWIW, squid.conf.default has http_access order template that 
work for most use cases; you may want to start with that template rather 
than starting from scratch.

For example, if an "allow authless_dst" rule is meant to apply to both 
already-authenticated and not-yet-authenticated requests, then it 
probably should go above the "allow kerb-auth" rule (which triggers 
authentication), but there are many other ways these two rules may 
interact. I cannot tell which order matches your access policies/desires.


HTH,

Alex.


> -----Original Message-----
> From: squid-users <squid-users-bounces at lists.squid-cache.org> On Behalf Of Alex Rousskov
> Sent: Monday, August 19, 2024 12:12 PM
> To: squid-users at lists.squid-cache.org
> Subject: Re: [squid-users] Squid.conf Issues
> 
> Caution: This email originated from outside of Hexcel. Do not click links or open attachments unless you recognize the sender and know the content is safe.
> 
> 
> On 2024-08-19 11:16, Piana, Josh wrote:
> 
>> After setting up the backend using realmD, sssd, with Kerberos
>> authentication, I tested with a Windows ?squidaduser? account. I can
>> verify the user accounts connection to the proxy, and it is passing
>> traffic. The issue is, it?s not being blocked by ANY of the acl?s we
>> have in place. I was hoping to reach out to help me identify the issue
>> with the squid.conf file. This is my assumption to be the issue but I
>> am pretty new at using Linux and completely unfamiliar with setting up
>> a web proxy.
> 
> In most cases, when Squid does not block, it allows. Squid allows when an "http_access allow" rule matches. Now look at _all_ of your http_access rules and ask yourself: Which "http_access allow" rule matches in my test case?
> 
> I do not know enough about your test logic, so I can only speculate that the answer to that question is "It is the very first http_access rule!":
> 
>       http_access allow kerb-auth
> 
> In other words, your configuration allows all authenticated clients. In other words, it does not block any authenticated clients. Is that what you want?
> 
> 
> HTH,
> 
> Alex.
> 
> 
> 
>> Environment:
>>
>> Squid Cache: Version 5.5
>>
>> RHEL 9.4 on a HyperV VM
>>
>> Linux Client Proxy in a Windows AD environment
>>
>> Below I will post the config and attempt to edit out any relevant
>> company/personal information:
>>
>> ######################################################################
>> ########
>>
>> # General
>>
>> ######################################################################
>> ########
>>
>> max_filedesc 4096
>>
>> cache_mgr ARCITAdmin at hexcel.com
>>
>> cache_effective_user squid
>>
>> cache_effective_group squid
>>
>> shutdown_lifetime 5 seconds
>>
>> ######################################################################
>> ########
>>
>> # Logging
>>
>> ######################################################################
>> ########
>>
>> # this makes the logs readable to humans
>>
>> logformat custom %tl.%03tu %>a %Ss/%03>Hs %<st %rm %ru %[un %Sh/%<a
>> %mt
>>
>> access_log daemon:/var/log/squid/access.log custom
>>
>> logfile_rotate 10
>>
>> debug_options ALL,1
>>
>> buffered_logs off
>>
>> cache_log /var/log/squid/general
>>
>> cache_access_log /var/log/squid/access.log
>>
>> cache_store_log none
>>
>> log_mime_hdrs off
>>
>> strip_query_terms off
>>
>> ######################################################################
>> ########
>>
>> # Network - General/misc
>>
>> ######################################################################
>> ########
>>
>> # our HTTP proxy port
>>
>> http_port 10.46.11.69:8080
>>
>> # loopback management
>>
>> http_port 127.0.0.1:3128
>>
>> icp_port 0
>>
>> forwarded_for off
>>
>> ######################################################################
>> ########
>>
>> # Network timeout settings
>>
>> ######################################################################
>> ########
>>
>> connect_timeout 30 seconds
>>
>> peer_connect_timeout 20 seconds
>>
>> read_timeout 2 minutes
>>
>> request_timeout 2 minutes
>>
>> persistent_request_timeout 30 seconds
>>
>> ######################################################################
>> ########
>>
>> # Configuration of the local cache itself
>>
>> ######################################################################
>> ########
>>
>> cache_dir ufs /var/spool/squid/ 10000 16 256
>>
>> coredump_dir /var/spool/squid/
>>
>> cache_replacement_policy heap LFUDA
>>
>> memory_replacement_policy lru
>>
>> cache_mem 256 MB
>>
>> maximum_object_size 32 MB
>>
>> maximum_object_size_in_memory 512 KB
>>
>> quick_abort_min 16 KB
>>
>> quick_abort_max 1 MB
>>
>> quick_abort_pct 90
>>
>> range_offset_limit 64 KB
>>
>> ######################################################################
>> ########
>>
>> # Cache control
>>
>> ######################################################################
>> ########
>>
>> acl no_cache_url url_regex -i "/etc/squid/no_cache_url"
>>
>> cache deny no_cache_url
>>
>> ######################################################################
>> ########
>>
>> # Authentication
>>
>> ######################################################################
>> ########
>>
>> auth_param negotiate program /usr/lib64/squid/negotiate_kerberos_auth
>> -k /etc/squid/HTTP.keytab -s
>> HTTP/<domain>.ad.<domain>.com at AD.<domain>.COM
>>
>> auth_param negotiate children 10
>>
>> auth_param negotiate keep_alive on
>>
>> acl kerb-auth proxy_auth REQUIRED
>>
>> http_access allow kerb-auth
>>
>> ######################################################################
>> ########
>>
>> # Access control - shared/common ACL definitions
>>
>> ######################################################################
>> ########
>>
>> # acl all src all
>>
>> acl src_self src 127.0.0.0/8
>>
>> acl src_self src 10.46.11.69
>>
>> acl dst_self dst 127.0.0.0/8
>>
>> acl dst_self dst 10.46.11.69
>>
>> acl from_arc src 10.46.0.0/15
>>
>> acl local_dst_addr dst 10.0.0.0/8
>>
>> acl local_dst_addr dst bldg3.<domain>.com
>>
>> acl local_dst_addr dst bldg5.<domain>.com
>>
>> acl local_dst_dom dstdomain <domain>
>>
>> acl proto_FTP proto FTP
>>
>> acl proto_HTTP proto HTTP
>>
>> acl localnet src 10.46.49.0/24
>>
>> acl localnet src 10.47.49.0/24
>>
>> acl http_ports port 80
>>
>> acl http_ports port 81
>>
>> acl http_ports port 8001
>>
>> acl http_ports port 8080
>>
>> acl Ssl_ports port 443
>>
>> acl Ssl_ports port 9571
>>
>> acl SSL_ports port 443
>>
>> acl Safe_ports port 80
>>
>> acl Safe_ports port 21
>>
>> acl Safe_ports port 443
>>
>> acl ssh_ports port 22
>>
>> acl ftp_ports port 21
>>
>> http_access deny !Safe_ports
>>
>> acl method_CONNECT method CONNECT
>>
>> dsacl methods_std method GET HEAD POST PUT DELETE
>>
>> acl methods_std method TRACE OPTIONS
>>
>> ######################################################################
>> ########
>>
>> # Access control - maintenance
>>
>> ######################################################################
>> ########
>>
>> acl purge method PURGE
>>
>> http_access allow purge src_self
>>
>> http_access deny purge
>>
>> acl cache_manager proto cache_object
>>
>> cachemgr_passwd disabled shutdown offline_toggle
>>
>> cachemgr_passwd none all
>>
>> http_access allow cache_manager src_self
>>
>> http_access deny cache_manager
>>
>> ######################################################################
>> #######
>>
>> # Access control - general proxy
>>
>> ######################################################################
>> ########
>>
>> http_access deny dst_self
>>
>> http_access deny src_self
>>
>> http_access deny !from_arc
>>
>> http_access       allow local_dst_dom
>>
>> http_reply_access           allow local_dst_dom
>>
>> http_access       allow local_dst_addr
>>
>> http_reply_access           allow local_dst_addr
>>
>> acl authless_src src "/etc/squid/authless_src"
>>
>> http_access       allow authless_src
>>
>> http_reply_access           allow authless_src
>>
>> acl authless_dst dstdomain "/etc/squid/authless_dst"
>>
>> http_access       allow authless_dst
>>
>> http_reply_access           allow authless_dst
>>
>> acl bad_domains_preauth dstdomain "/etc/squid/bad_domains_preauth"
>>
>> http_access deny bad_domains_preauth
>>
>> acl block_user proxy_auth_regex -i "/etc/squid/block_user"
>>
>> http_access deny block_user
>>
>> acl bad_exception_urls url_regex -i "/etc/squid/bad_exception_urls"
>>
>> acl exec_files url_regex -i "/etc/squid/exec_files"
>>
>> acl exec_users proxy_auth_regex -i "/etc/squid/exec_users"
>>
>> http_access deny !bad_exception_urls !exec_users exec_files
>>
>> deny_info ERR_BLOCK_TYPE exec_files
>>
>> acl mmedia_users proxy_auth_regex -i "/etc/squid/mmedia_users"
>>
>> acl mmedia_sites dstdomain "/etc/squid/mmedia_sites"
>>
>> http_access       allow methods_std    proto_HTTP http_ports
>> mmedia_sites mmedia_users
>>
>> http_reply_access allow methods_std    proto_HTTP http_ports
>> mmedia_sites mmedia_users
>>
>> http_access       allow method_CONNECT            ssl_ports
>> mmedia_sites mmedia_users
>>
>> http_reply_access allow method_CONNECT            ssl_ports
>> mmedia_sites mmedia_users
>>
>> acl bad_domains dstdomain "/etc/squid/bad_domains"
>>
>> http_access deny !bad_exception_urls bad_domains
>>
>> deny_info ERR_BLOCK_DST         bad_domains
>>
>> acl bad_domains_regex dstdom_regex -i "/etc/squid/bad_domains_regex"
>>
>> http_access deny !bad_exception_urls bad_domains_regex
>>
>> deny_info ERR_BLOCK_DST         bad_domains_regex
>>
>> acl bad_urls url_regex -i "/etc/squid/bad_urls"
>>
>> http_access deny !bad_exception_urls bad_urls
>>
>> deny_info ERR_BLOCK_DST         bad_urls
>>
>> acl bad_files urlpath_regex -i "/etc/squid/bad_files"
>>
>> http_access deny !bad_exception_urls bad_files
>>
>> deny_info ERR_BLOCK_TYPE bad_files
>>
>> acl bad_types rep_mime_type -i "/etc/squid/bad_types"
>>
>> http_reply_access deny bad_types !bad_exception_urls
>>
>> deny_info ERR_BLOCK_TYPE bad_types
>>
>> acl fsoguest_user proxy_auth_regex -i fsoguest
>>
>> acl fsoguest_dst dstdomain .opm.gov
>>
>> acl fsoguest_dst dstdomain .google-analytics.com
>>
>> acl fsoguest_dst dstdomain pki.google.com
>>
>> acl fsoguest_dst dstdomain ajax.googleapis.com
>>
>> acl fsoguest_dst dstdomain fonts.googleapis.com
>>
>> acl fsoguest_dst dstdomain html5shiv.googlecode.com
>>
>> acl fsoguest_dst dstdomain fonts.gstatic.com
>>
>> acl fsoguest_dst dstdomain clients1.google.com
>>
>> acl fsoguest_dst dstdomain ajax.microsoft.com
>>
>> acl fsoguest_dst dstdomain ajax.aspnetcdn.com
>>
>> acl fsoguest_dst dstdomain .geotrust.com
>>
>> acl fsoguest_dst dstdomain .akamaihd.net
>>
>> acl fsoguest_dst dstdomain symcd.com
>>
>> http_access allow methods_std proto_HTTP http_ports fsoguest_dst
>> fsoguest_user
>>
>> http_access allow method_CONNECT         ssl_ports  fsoguest_dst
>> fsoguest_user
>>
>> http_access deny fsoguest_user
>>
>> http_access allow http_ports proto_HTTP methods_std
>>
>> http_access allow method_CONNECT ssl_ports
>>
>> http_access deny method_CONNECT
>>
>> http_access allow ftp_ports proto_FTP
>>
>> http_access deny all
>>
>> http_reply_access allow all
>>
>> ######################################################################
>> ########
>>
>> # END OF FILE
>>
>> ######################################################################
>> ########
>>
>>
>> _______________________________________________
>> squid-users mailing list
>> squid-users at lists.squid-cache.org
>> https://list/
>> s.squid-cache.org%2Flistinfo%2Fsquid-users&data=05%7C02%7Cjosh.piana%4
>> 0hexcel.com%7C5d5a04837ae140f50c6908dcc0699c20%7C4248050df19546d5ac9c0
>> c7c52b04cae%7C0%7C0%7C638596807060587199%7CUnknown%7CTWFpbGZsb3d8eyJWI
>> joiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C0%7C%7
>> C%7C&sdata=pFmtS4HPHBRLFvcthpxiXT8mgF7mmpsGfQYF1wlivJo%3D&reserved=0
> 
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> https://lists.squid-cache.org/listinfo/squid-users
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> https://lists.squid-cache.org/listinfo/squid-users



From Josh.Piana at hexcel.com  Mon Aug 19 20:45:14 2024
From: Josh.Piana at hexcel.com (Piana, Josh)
Date: Mon, 19 Aug 2024 20:45:14 +0000
Subject: [squid-users] Squid.conf Issues
In-Reply-To: <28b45bea-3b42-4ba2-9b24-d741432971c4@measurement-factory.com>
References: <43696754c7d5443cba762cc72233e302@hexcel.com>
 <a09b6033-485c-492d-bfab-67fadbb3e310@measurement-factory.com>
 <7a2b553f248540ec86a12e805560eeff@hexcel.com>
 <28b45bea-3b42-4ba2-9b24-d741432971c4@measurement-factory.com>
Message-ID: <2fa88bd4f6e1496b9173e347b27e5b59@hexcel.com>

Alex, 

It was indeed the placement of " http_access allow kerb-auth". I've moved it down to just above the deny all rule, but after all the ACL's. After this it was working as expected. 

Thank you, 
Josh

-----Original Message-----
From: squid-users <squid-users-bounces at lists.squid-cache.org> On Behalf Of Alex Rousskov
Sent: Monday, August 19, 2024 4:15 PM
To: squid-users at lists.squid-cache.org
Subject: Re: [squid-users] Squid.conf Issues

Caution: This email originated from outside of Hexcel. Do not click links or open attachments unless you recognize the sender and know the content is safe.


On 2024-08-19 13:48, Piana, Josh wrote:

> I added "http_access allow kerb-auth" as part of the generic 
> authentication settings.
>
> We still want authenticated users to access but we want the rules and 
> ACL's prior to that to catch them first.

If you want http_access rule X to be checked before http_access rule Y, you have to list X above Y in squid.conf: Squid checks all http_access directives one by one, top to bottom. At the first match, Squid applies the matched action ("allow" or "deny") and does not check any other/lower http_access rules.


> I apologize, I'm quite new with Linux. Should I move that parameter to 
> near the end of the config file or remove it all together?

FWIW, these access controls are not Linux-specific. I cannot tell you what http_access order is correct because I do not know what "We want authenticated users to access but we want to catch them first" means to you in terms of actual access rules. There are many ways to interpret that phrase...

In general, rules that do not depend on whether a user is authenticated should go above the rules that do depend (or require) authentication.
This principle avoids needless authentication of potentially malicious requests. FWIW, squid.conf.default has http_access order template that work for most use cases; you may want to start with that template rather than starting from scratch.

For example, if an "allow authless_dst" rule is meant to apply to both already-authenticated and not-yet-authenticated requests, then it probably should go above the "allow kerb-auth" rule (which triggers authentication), but there are many other ways these two rules may interact. I cannot tell which order matches your access policies/desires.


HTH,

Alex.


> -----Original Message-----
> From: squid-users <squid-users-bounces at lists.squid-cache.org> On 
> Behalf Of Alex Rousskov
> Sent: Monday, August 19, 2024 12:12 PM
> To: squid-users at lists.squid-cache.org
> Subject: Re: [squid-users] Squid.conf Issues
>
> Caution: This email originated from outside of Hexcel. Do not click links or open attachments unless you recognize the sender and know the content is safe.
>
>
> On 2024-08-19 11:16, Piana, Josh wrote:
>
>> After setting up the backend using realmD, sssd, with Kerberos 
>> authentication, I tested with a Windows ?squidaduser? account. I can 
>> verify the user accounts connection to the proxy, and it is passing 
>> traffic. The issue is, it?s not being blocked by ANY of the acl?s we 
>> have in place. I was hoping to reach out to help me identify the 
>> issue with the squid.conf file. This is my assumption to be the issue 
>> but I am pretty new at using Linux and completely unfamiliar with 
>> setting up a web proxy.
>
> In most cases, when Squid does not block, it allows. Squid allows when an "http_access allow" rule matches. Now look at _all_ of your http_access rules and ask yourself: Which "http_access allow" rule matches in my test case?
>
> I do not know enough about your test logic, so I can only speculate that the answer to that question is "It is the very first http_access rule!":
>
>       http_access allow kerb-auth
>
> In other words, your configuration allows all authenticated clients. In other words, it does not block any authenticated clients. Is that what you want?
>
>
> HTH,
>
> Alex.
>
>
>
>> Environment:
>>
>> Squid Cache: Version 5.5
>>
>> RHEL 9.4 on a HyperV VM
>>
>> Linux Client Proxy in a Windows AD environment
>>
>> Below I will post the config and attempt to edit out any relevant 
>> company/personal information:
>>
>> #####################################################################
>> #
>> ########
>>
>> # General
>>
>> #####################################################################
>> #
>> ########
>>
>> max_filedesc 4096
>>
>> cache_mgr ARCITAdmin at hexcel.com
>>
>> cache_effective_user squid
>>
>> cache_effective_group squid
>>
>> shutdown_lifetime 5 seconds
>>
>> #####################################################################
>> #
>> ########
>>
>> # Logging
>>
>> #####################################################################
>> #
>> ########
>>
>> # this makes the logs readable to humans
>>
>> logformat custom %tl.%03tu %>a %Ss/%03>Hs %<st %rm %ru %[un %Sh/%<a 
>> %mt
>>
>> access_log daemon:/var/log/squid/access.log custom
>>
>> logfile_rotate 10
>>
>> debug_options ALL,1
>>
>> buffered_logs off
>>
>> cache_log /var/log/squid/general
>>
>> cache_access_log /var/log/squid/access.log
>>
>> cache_store_log none
>>
>> log_mime_hdrs off
>>
>> strip_query_terms off
>>
>> #####################################################################
>> #
>> ########
>>
>> # Network - General/misc
>>
>> #####################################################################
>> #
>> ########
>>
>> # our HTTP proxy port
>>
>> http_port 10.46.11.69:8080
>>
>> # loopback management
>>
>> http_port 127.0.0.1:3128
>>
>> icp_port 0
>>
>> forwarded_for off
>>
>> #####################################################################
>> #
>> ########
>>
>> # Network timeout settings
>>
>> #####################################################################
>> #
>> ########
>>
>> connect_timeout 30 seconds
>>
>> peer_connect_timeout 20 seconds
>>
>> read_timeout 2 minutes
>>
>> request_timeout 2 minutes
>>
>> persistent_request_timeout 30 seconds
>>
>> #####################################################################
>> #
>> ########
>>
>> # Configuration of the local cache itself
>>
>> #####################################################################
>> #
>> ########
>>
>> cache_dir ufs /var/spool/squid/ 10000 16 256
>>
>> coredump_dir /var/spool/squid/
>>
>> cache_replacement_policy heap LFUDA
>>
>> memory_replacement_policy lru
>>
>> cache_mem 256 MB
>>
>> maximum_object_size 32 MB
>>
>> maximum_object_size_in_memory 512 KB
>>
>> quick_abort_min 16 KB
>>
>> quick_abort_max 1 MB
>>
>> quick_abort_pct 90
>>
>> range_offset_limit 64 KB
>>
>> #####################################################################
>> #
>> ########
>>
>> # Cache control
>>
>> #####################################################################
>> #
>> ########
>>
>> acl no_cache_url url_regex -i "/etc/squid/no_cache_url"
>>
>> cache deny no_cache_url
>>
>> #####################################################################
>> #
>> ########
>>
>> # Authentication
>>
>> #####################################################################
>> #
>> ########
>>
>> auth_param negotiate program /usr/lib64/squid/negotiate_kerberos_auth
>> -k /etc/squid/HTTP.keytab -s
>> HTTP/<domain>.ad.<domain>.com at AD.<domain>.COM
>>
>> auth_param negotiate children 10
>>
>> auth_param negotiate keep_alive on
>>
>> acl kerb-auth proxy_auth REQUIRED
>>
>> http_access allow kerb-auth
>>
>> #####################################################################
>> #
>> ########
>>
>> # Access control - shared/common ACL definitions
>>
>> #####################################################################
>> #
>> ########
>>
>> # acl all src all
>>
>> acl src_self src 127.0.0.0/8
>>
>> acl src_self src 10.46.11.69
>>
>> acl dst_self dst 127.0.0.0/8
>>
>> acl dst_self dst 10.46.11.69
>>
>> acl from_arc src 10.46.0.0/15
>>
>> acl local_dst_addr dst 10.0.0.0/8
>>
>> acl local_dst_addr dst bldg3.<domain>.com
>>
>> acl local_dst_addr dst bldg5.<domain>.com
>>
>> acl local_dst_dom dstdomain <domain>
>>
>> acl proto_FTP proto FTP
>>
>> acl proto_HTTP proto HTTP
>>
>> acl localnet src 10.46.49.0/24
>>
>> acl localnet src 10.47.49.0/24
>>
>> acl http_ports port 80
>>
>> acl http_ports port 81
>>
>> acl http_ports port 8001
>>
>> acl http_ports port 8080
>>
>> acl Ssl_ports port 443
>>
>> acl Ssl_ports port 9571
>>
>> acl SSL_ports port 443
>>
>> acl Safe_ports port 80
>>
>> acl Safe_ports port 21
>>
>> acl Safe_ports port 443
>>
>> acl ssh_ports port 22
>>
>> acl ftp_ports port 21
>>
>> http_access deny !Safe_ports
>>
>> acl method_CONNECT method CONNECT
>>
>> dsacl methods_std method GET HEAD POST PUT DELETE
>>
>> acl methods_std method TRACE OPTIONS
>>
>> #####################################################################
>> #
>> ########
>>
>> # Access control - maintenance
>>
>> #####################################################################
>> #
>> ########
>>
>> acl purge method PURGE
>>
>> http_access allow purge src_self
>>
>> http_access deny purge
>>
>> acl cache_manager proto cache_object
>>
>> cachemgr_passwd disabled shutdown offline_toggle
>>
>> cachemgr_passwd none all
>>
>> http_access allow cache_manager src_self
>>
>> http_access deny cache_manager
>>
>> #####################################################################
>> #
>> #######
>>
>> # Access control - general proxy
>>
>> #####################################################################
>> #
>> ########
>>
>> http_access deny dst_self
>>
>> http_access deny src_self
>>
>> http_access deny !from_arc
>>
>> http_access       allow local_dst_dom
>>
>> http_reply_access           allow local_dst_dom
>>
>> http_access       allow local_dst_addr
>>
>> http_reply_access           allow local_dst_addr
>>
>> acl authless_src src "/etc/squid/authless_src"
>>
>> http_access       allow authless_src
>>
>> http_reply_access           allow authless_src
>>
>> acl authless_dst dstdomain "/etc/squid/authless_dst"
>>
>> http_access       allow authless_dst
>>
>> http_reply_access           allow authless_dst
>>
>> acl bad_domains_preauth dstdomain "/etc/squid/bad_domains_preauth"
>>
>> http_access deny bad_domains_preauth
>>
>> acl block_user proxy_auth_regex -i "/etc/squid/block_user"
>>
>> http_access deny block_user
>>
>> acl bad_exception_urls url_regex -i "/etc/squid/bad_exception_urls"
>>
>> acl exec_files url_regex -i "/etc/squid/exec_files"
>>
>> acl exec_users proxy_auth_regex -i "/etc/squid/exec_users"
>>
>> http_access deny !bad_exception_urls !exec_users exec_files
>>
>> deny_info ERR_BLOCK_TYPE exec_files
>>
>> acl mmedia_users proxy_auth_regex -i "/etc/squid/mmedia_users"
>>
>> acl mmedia_sites dstdomain "/etc/squid/mmedia_sites"
>>
>> http_access       allow methods_std    proto_HTTP http_ports
>> mmedia_sites mmedia_users
>>
>> http_reply_access allow methods_std    proto_HTTP http_ports
>> mmedia_sites mmedia_users
>>
>> http_access       allow method_CONNECT            ssl_ports
>> mmedia_sites mmedia_users
>>
>> http_reply_access allow method_CONNECT            ssl_ports
>> mmedia_sites mmedia_users
>>
>> acl bad_domains dstdomain "/etc/squid/bad_domains"
>>
>> http_access deny !bad_exception_urls bad_domains
>>
>> deny_info ERR_BLOCK_DST         bad_domains
>>
>> acl bad_domains_regex dstdom_regex -i "/etc/squid/bad_domains_regex"
>>
>> http_access deny !bad_exception_urls bad_domains_regex
>>
>> deny_info ERR_BLOCK_DST         bad_domains_regex
>>
>> acl bad_urls url_regex -i "/etc/squid/bad_urls"
>>
>> http_access deny !bad_exception_urls bad_urls
>>
>> deny_info ERR_BLOCK_DST         bad_urls
>>
>> acl bad_files urlpath_regex -i "/etc/squid/bad_files"
>>
>> http_access deny !bad_exception_urls bad_files
>>
>> deny_info ERR_BLOCK_TYPE bad_files
>>
>> acl bad_types rep_mime_type -i "/etc/squid/bad_types"
>>
>> http_reply_access deny bad_types !bad_exception_urls
>>
>> deny_info ERR_BLOCK_TYPE bad_types
>>
>> acl fsoguest_user proxy_auth_regex -i fsoguest
>>
>> acl fsoguest_dst dstdomain .opm.gov
>>
>> acl fsoguest_dst dstdomain .google-analytics.com
>>
>> acl fsoguest_dst dstdomain pki.google.com
>>
>> acl fsoguest_dst dstdomain ajax.googleapis.com
>>
>> acl fsoguest_dst dstdomain fonts.googleapis.com
>>
>> acl fsoguest_dst dstdomain html5shiv.googlecode.com
>>
>> acl fsoguest_dst dstdomain fonts.gstatic.com
>>
>> acl fsoguest_dst dstdomain clients1.google.com
>>
>> acl fsoguest_dst dstdomain ajax.microsoft.com
>>
>> acl fsoguest_dst dstdomain ajax.aspnetcdn.com
>>
>> acl fsoguest_dst dstdomain .geotrust.com
>>
>> acl fsoguest_dst dstdomain .akamaihd.net
>>
>> acl fsoguest_dst dstdomain symcd.com
>>
>> http_access allow methods_std proto_HTTP http_ports fsoguest_dst 
>> fsoguest_user
>>
>> http_access allow method_CONNECT         ssl_ports  fsoguest_dst
>> fsoguest_user
>>
>> http_access deny fsoguest_user
>>
>> http_access allow http_ports proto_HTTP methods_std
>>
>> http_access allow method_CONNECT ssl_ports
>>
>> http_access deny method_CONNECT
>>
>> http_access allow ftp_ports proto_FTP
>>
>> http_access deny all
>>
>> http_reply_access allow all
>>
>> #####################################################################
>> #
>> ########
>>
>> # END OF FILE
>>
>> #####################################################################
>> #
>> ########
>>
>>
>> _______________________________________________
>> squid-users mailing list
>> squid-users at lists.squid-cache.org
>> https://list/
>> s.squid-cache.org%2Flistinfo%2Fsquid-users&data=05%7C02%7Cjosh.piana%
>> 4
>> 0hexcel.com%7C5d5a04837ae140f50c6908dcc0699c20%7C4248050df19546d5ac9c
>> 0 
>> c7c52b04cae%7C0%7C0%7C638596807060587199%7CUnknown%7CTWFpbGZsb3d8eyJW
>> I
>> joiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C0%7C%
>> 7
>> C%7C&sdata=pFmtS4HPHBRLFvcthpxiXT8mgF7mmpsGfQYF1wlivJo%3D&reserved=0
>
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> https://list/
> s.squid-cache.org%2Flistinfo%2Fsquid-users&data=05%7C02%7Cjosh.piana%4
> 0hexcel.com%7Cf609a83cb929479a8a4d08dcc08ba229%7C4248050df19546d5ac9c0
> c7c52b04cae%7C0%7C0%7C638596953174507496%7CUnknown%7CTWFpbGZsb3d8eyJWI
> joiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C0%7C%7
> C%7C&sdata=jfBJtQkdxuk4JPoERwUO4%2FGRRGu1KtvJqj032AAR330%3D&reserved=0
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> https://list/
> s.squid-cache.org%2Flistinfo%2Fsquid-users&data=05%7C02%7Cjosh.piana%4
> 0hexcel.com%7Cf609a83cb929479a8a4d08dcc08ba229%7C4248050df19546d5ac9c0
> c7c52b04cae%7C0%7C0%7C638596953174507496%7CUnknown%7CTWFpbGZsb3d8eyJWI
> joiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C0%7C%7
> C%7C&sdata=jfBJtQkdxuk4JPoERwUO4%2FGRRGu1KtvJqj032AAR330%3D&reserved=0

_______________________________________________
squid-users mailing list
squid-users at lists.squid-cache.org
https://lists.squid-cache.org/listinfo/squid-users

From ngtech1ltd at gmail.com  Mon Aug 19 23:39:53 2024
From: ngtech1ltd at gmail.com (ngtech1ltd at gmail.com)
Date: Tue, 20 Aug 2024 02:39:53 +0300
Subject: [squid-users] Squid 6.10 on Fedora 40 cannot intercept and bump
 SSL Traffic
In-Reply-To: <af9608b6-5388-4d78-8e96-eea3267b6bc7@measurement-factory.com>
References: <CABA8h=TSSsneVN5qvtaxsHfdknSd58ucZ9Vxg=Vxe5YWCsaAAA@mail.gmail.com>
 <6b375023-33d6-4812-8850-0a24cb562d2e@measurement-factory.com>
 <CABA8h=SJp88t3aj1cr-4LK-mqik6QL9nG_X2xumZ_mPwCoybxg@mail.gmail.com>
 <4a57096d-1218-4090-b62a-67d1a18173a7@measurement-factory.com>
 <000001daf26d$d620c5c0$82625140$@gmail.com>
 <af9608b6-5388-4d78-8e96-eea3267b6bc7@measurement-factory.com>
Message-ID: <000401daf291$24fed0b0$6efc7210$@gmail.com>

Attached a gist with all the technical details (the email was too long)

https://gist.githubusercontent.com/elico/bc5189e74aacf1f902f767fc1902d3a4/raw/afe876f5d46d2789d48b41dab7a73c7a6fd40be1/sslbump-issue-5.9.txt


----
Eliezer Croitoru
Tech Support
Mobile: +972-5-28704261
Email: ngtech1ltd at gmail.com

-----Original Message-----
From: squid-users <squid-users-bounces at lists.squid-cache.org> On Behalf Of Alex Rousskov
Sent: Monday, August 19, 2024 10:59 PM
To: squid-users at lists.squid-cache.org
Subject: Re: [squid-users] Squid 6.10 on Fedora 40 cannot intercept and bump SSL Traffic

<SNIP>



From nikhildeshpande18 at gmail.com  Tue Aug 20 10:27:41 2024
From: nikhildeshpande18 at gmail.com (nikhil deshpande)
Date: Tue, 20 Aug 2024 15:57:41 +0530
Subject: [squid-users] How to add extra header in response in squid
Message-ID: <CALO-o=wYPA5BxkfMgpSGUdQ2tTVG_vgj8zHy6Ek6WgEVWDnQ8Q@mail.gmail.com>

Hi tea,

We are using squid as proxy. We have two open ports in squid.

Port 1 is transparent proxy with configuration like below
http_port 127.0.0.1:12121

Port 2 is cache proxy which cache all GET calls  with configuration like
below

http_port 127.0.0.1:12122 ssl-bump
generate-host-certificates=on dynamic_cert_mem_cache_size=4MB
cert=/CAGS/ssl/appliance.chain


I want to add a response header in my response which we give from squid. We
are using below directive for the same

reply_header_add header_name header_value

It seems the below configuration is working fine with port # 2 (cache port)
however it does not work for port #1 (tunnel proxy). Can someone tell how
can I add custom response header for my all open ports?

Regards,
Nikhil
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20240820/9181ce2e/attachment.htm>

From ngtech1ltd at gmail.com  Tue Aug 20 10:35:04 2024
From: ngtech1ltd at gmail.com (ngtech1ltd at gmail.com)
Date: Tue, 20 Aug 2024 13:35:04 +0300
Subject: [squid-users] Squid 6.10 on Fedora 40 cannot intercept and bump
 SSL Traffic
In-Reply-To: <6b375023-33d6-4812-8850-0a24cb562d2e@measurement-factory.com>
References: <CABA8h=TSSsneVN5qvtaxsHfdknSd58ucZ9Vxg=Vxe5YWCsaAAA@mail.gmail.com>
 <6b375023-33d6-4812-8850-0a24cb562d2e@measurement-factory.com>
Message-ID: <002e01daf2ec$aba5bba0$02f132e0$@gmail.com>

Attached a link for the pcap file that might shed some light on the issue from a technical perspective:
https://cloud.hisstory.org.il/apps/maps/s/Mw8Cb8QLYto83rK

Eliezer



From rousskov at measurement-factory.com  Tue Aug 20 13:56:44 2024
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Tue, 20 Aug 2024 09:56:44 -0400
Subject: [squid-users] How to add extra header in response in squid
In-Reply-To: <CALO-o=wYPA5BxkfMgpSGUdQ2tTVG_vgj8zHy6Ek6WgEVWDnQ8Q@mail.gmail.com>
References: <CALO-o=wYPA5BxkfMgpSGUdQ2tTVG_vgj8zHy6Ek6WgEVWDnQ8Q@mail.gmail.com>
Message-ID: <b3d92aca-bf32-430e-b76c-298a61d41e16@measurement-factory.com>

On 2024-08-20 06:27, nikhil deshpande wrote:

> We have two open ports in squid.
> 
> Port 1 is transparent proxy with configuration like below
> http_port 127.0.0.1:12121

I assume you are using one of the interception modes (i.e. either 
"intercept" or "tproxy") in the above port configuration.


> Port 2 is cache proxy which cache all GET calls? with configuration?like 
> below
> 
> http_port 127.0.0.1:12122 ssl-bump ...


> I want to add a response header in my response which we give from squid. 
> We are using below directive for the same
> 
> reply_header_add header_name header_value
> 
> It seems the below configuration is working fine with port # 2 (cache 
> port) however?it does not work for port #1 (tunnel proxy). Can someone 
> tell how can I add custom response?header for my all open ports?


Squid should apply reply_header_add to all[1] final HTTP responses and 
HTTP 1xx control messages (that Squid sees/sends), regardless of the 
port the corresponding HTTP requests were received on.

[1] The only known exception is CONNECT responses. Quality pull requests 
adding reply_header_add support for Squid-generated CONNECT responses 
are welcome. An _interception_ http_port usually does not get CONNECT 
requests, so I assume you are not dealing with this exception in your tests.

If your Squid responds to an HTTP GET request without honoring 
reply_header_add, it is a Squid bug. If you are using Squid v6 or later, 
_and_ can demonstrate that Squid actually handles the GET transaction in 
question, then please report that bug to Squid Bugzilla.


HTH,

Alex.



From rousskov at measurement-factory.com  Tue Aug 20 19:40:41 2024
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Tue, 20 Aug 2024 15:40:41 -0400
Subject: [squid-users] Squid 6.10 on Fedora 40 cannot intercept and bump
 SSL Traffic
In-Reply-To: <002e01daf2ec$aba5bba0$02f132e0$@gmail.com>
References: <CABA8h=TSSsneVN5qvtaxsHfdknSd58ucZ9Vxg=Vxe5YWCsaAAA@mail.gmail.com>
 <6b375023-33d6-4812-8850-0a24cb562d2e@measurement-factory.com>
 <002e01daf2ec$aba5bba0$02f132e0$@gmail.com>
Message-ID: <0e8449d2-c1f2-40e2-836b-261beaf9ade9@measurement-factory.com>

On 2024-08-20 06:35, ngtech1ltd at gmail.com wrote:

> Attached a link for the pcap file that might shed some light on the
> issue from a technical perspective

That link does not work for me: Nothing is shown but a page with generic 
background and a "get your own free account" signature at the bottom; no 
download starts. Same result after creating an account with nextcloud.

Please feel free to send another link off list if needed.

Alex.



From rousskov at measurement-factory.com  Tue Aug 20 19:57:20 2024
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Tue, 20 Aug 2024 15:57:20 -0400
Subject: [squid-users] Squid 6.10 on Fedora 40 cannot intercept and bump
 SSL Traffic
In-Reply-To: <CABA8h=Rj=qkw5YrNNtD1Kc1rw0Pu_07Lti00H4bTL87pVtMcRw@mail.gmail.com>
References: <CABA8h=TSSsneVN5qvtaxsHfdknSd58ucZ9Vxg=Vxe5YWCsaAAA@mail.gmail.com>
 <6b375023-33d6-4812-8850-0a24cb562d2e@measurement-factory.com>
 <CABA8h=SJp88t3aj1cr-4LK-mqik6QL9nG_X2xumZ_mPwCoybxg@mail.gmail.com>
 <4a57096d-1218-4090-b62a-67d1a18173a7@measurement-factory.com>
 <000001daf26d$d620c5c0$82625140$@gmail.com>
 <af9608b6-5388-4d78-8e96-eea3267b6bc7@measurement-factory.com>
 <CABA8h=Rj=qkw5YrNNtD1Kc1rw0Pu_07Lti00H4bTL87pVtMcRw@mail.gmail.com>
Message-ID: <fa2016f4-276a-4bf0-94a8-79db1273d9b9@measurement-factory.com>

On 2024-08-19 19:32, NgTech LTD wrote:

 > curl -v -k https://www.youtube.com/

> 1724109013.783 ? ? ?0 192.168.78.252 NONE_NONE/000 0 - 
> error:invalid-request - HIER_NONE/- - -

OK, let's focus on this curl interception test. It feels like your Squid 
is receiving some bytes it cannot fully grok. We should figure out what 
those bytes are. Please share (privately if needed) a pointer to 
compressed ALL,9 cache.log snippet collected while reproducing this 
single test. There are some relevant hints at
https://wiki.squid-cache.org/SquidFaq/BugReporting#debugging-a-single-transaction

If you can also share the corresponding client-to-Squid connection 
packet capture (collected on the Squid side, at least), please do that 
as well.


N.B. The other tests confirm that your Squid can "bump clients", 
invalidating one of the assertions at the beginning of this email 
thread. The problem appears to be specific to the interception part of 
the test rather than basic SslBump operation.


Cheers,

Alex.


> 1724109015.407 ? 1623 192.168.78.252 TCP_TUNNEL/200 534674 - 
> 142.250.185.110:443 <http://142.250.185.110:443> - 
> ORIGINAL_DST/142.250.185.110 <http://142.250.185.110> - -
> 
> PS C:\Users\eliez> curl -v -k https://www.youtube.com/ 
> <https://www.youtube.com/> ?-o 1.txt
>  ? % Total ? ?% Received % Xferd ?Average Speed ? Time ? ?Time ? ? Time 
>  ?Current
>  ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ?Dload ?Upload ? Total ? Spent ? ?Left 
>  ?Speed
>  ? 0 ? ? 0 ? ?0 ? ? 0 ? ?0 ? ? 0 ? ? ?0 ? ? ?0 --:--:-- --:--:-- 
> --:--:-- ? ? 0* Host www.youtube.com:443 <http://www.youtube.com:443> 
> was resolved.
> * IPv6: 2a00:1450:4001:80b::200e, 2a00:1450:4001:828::200e, 
> 2a00:1450:4001:803::200e, 2a00:1450:4001:830::200e
> * IPv4: 142.250.185.110, 216.58.206.78, 142.250.186.142, 216.58.206.46, 
> 172.217.18.110, 142.250.185.142, 142.250.186.174, 142.250.184.206, 
> 142.250.185.174, 142.250.184.238, 172.217.18.14, 142.250.186.110, 
> 172.217.16.206, 172.217.23.110, 216.58.212.142, 142.250.185.78
> * ? Trying [2a00:1450:4001:80b::200e]:443...
> * ? Trying 142.250.185.110:443...
> * Connected to www.youtube.com <http://www.youtube.com> 
> (142.250.185.110) port 443
> * schannel: disabled automatic use of client certificate
> * ALPN: curl offers http/1.1
> * ALPN: server accepted http/1.1
> * using HTTP/1.x
>  > GET / HTTP/1.1
>  > Host: www.youtube.com <http://www.youtube.com>
>  > User-Agent: curl/8.8.0
>  > Accept: */*
>  >
> * Request completely sent off
> * schannel: remote party requests renegotiation
> * schannel: renegotiating SSL/TLS connection
> * schannel: SSL/TLS connection renegotiated
> < HTTP/1.1 200 OK
> < Content-Type: text/html; charset=utf-8
> < X-Content-Type-Options: nosniff
> < Cache-Control: no-cache, no-store, max-age=0, must-revalidate
> < Pragma: no-cache
> < Expires: Mon, 01 Jan 1990 00:00:00 GMT
> < Date: Mon, 19 Aug 2024 23:10:13 GMT
> < Strict-Transport-Security: max-age=31536000
> < X-Frame-Options: SAMEORIGIN
> < Permissions-Policy: ch-ua-arch=*, ch-ua-bitness=*, 
> ch-ua-full-version=*, ch-ua-full-version-list=*, ch-ua-model=*, 
> ch-ua-wow64=*, ch-ua-form-factors=*, ch-ua-platform=*, 
> ch-ua-platform-version=*
> < Content-Security-Policy: require-trusted-types-for 'script'
> < Origin-Trial: 
> AmhMBR6zCLzDDxpW+HfpP67BqwIknWnyMOXOQGfzYswFmJe+fgaI6XZgAzcxOrzNtP7hEDsOo1jdjFnVr2IdxQ4AAAB4eyJvcmlnaW4iOiJodHRwczovL3lvdXR1YmUuY29tOjQ0MyIsImZlYXR1cmUiOiJXZWJWaWV3WFJlcXVlc3RlZFdpdGhEZXByZWNhdGlvbiIsImV4cGlyeSI6MTc1ODA2NzE5OSwiaXNTdWJkb21haW4iOnRydWV9
> < Report-To: 
> {"group":"youtube_main","max_age":2592000,"endpoints":[{"url":"https://csp.withgoogle.com/csp/report-to/youtube_main <https://csp.withgoogle.com/csp/report-to/youtube_main>"}]}
> < Cross-Origin-Opener-Policy: same-origin-allow-popups; 
> report-to="youtube_main"
> < P3P: CP="This is not a P3P policy! See 
> http://support.google.com/accounts/answer/151657?hl=en 
> <http://support.google.com/accounts/answer/151657?hl=en> for more info."
> < Server: ESF
> < X-XSS-Protection: 0
> < Set-Cookie: GPS=1; Domain=.youtube.com <http://youtube.com>; 
> Expires=Mon, 19-Aug-2024 23:40:13 GMT; Path=/; Secure; HttpOnly
> < Set-Cookie: YSC=FASh7dosPqA; Domain=.youtube.com <http://youtube.com>; 
> Path=/; Secure; HttpOnly; SameSite=none
> < Set-Cookie: VISITOR_INFO1_LIVE=B6cXjIhTk2Q; Domain=.youtube.com 
> <http://youtube.com>; Expires=Sat, 15-Feb-2025 23:10:13 GMT; Path=/; 
> Secure; HttpOnly; SameSite=none
> < Set-Cookie: VISITOR_PRIVACY_METADATA=CgJJTBIEGgAgJw%3D%3D; 
> Domain=.youtube.com <http://youtube.com>; Expires=Sat, 15-Feb-2025 
> 23:10:13 GMT; Path=/; Secure; HttpOnly; SameSite=none
> < Alt-Svc: h3=":443"; ma=2592000,h3-29=":443"; ma=2592000
> < Accept-Ranges: none
> < Vary: Accept-Encoding
> < Transfer-Encoding: chunked
> <
> { [9490 bytes data]
> * schannel: failed to decrypt data, need more data
> { [16240 bytes data]
> * schannel: failed to decrypt data, need more data
> { [4134 bytes data]
> * schannel: failed to decrypt data, need more data
> { [9646 bytes data]
> * schannel: failed to decrypt data, need more data
> { [16215 bytes data]
> * schannel: failed to decrypt data, need more data
> { [1378 bytes data]
> * schannel: failed to decrypt data, need more data
> { [2756 bytes data]
> * schannel: failed to decrypt data, need more data
> { [5512 bytes data]
> * schannel: failed to decrypt data, need more data
> { [2756 bytes data]
> * schannel: failed to decrypt data, need more data
> { [2756 bytes data]
> * schannel: failed to decrypt data, need more data
> { [2756 bytes data]
> * schannel: failed to decrypt data, need more data
> { [3824 bytes data]
> * schannel: failed to decrypt data, need more data
> { [2756 bytes data]
> * schannel: failed to decrypt data, need more data
> { [2756 bytes data]
> * schannel: failed to decrypt data, need more data
> { [5537 bytes data]
> * schannel: failed to decrypt data, need more data
> { [2756 bytes data]
> * schannel: failed to decrypt data, need more data
> { [4134 bytes data]
> * schannel: failed to decrypt data, need more data
> { [1378 bytes data]
> * schannel: failed to decrypt data, need more data
> { [22048 bytes data]
> * schannel: failed to decrypt data, need more data
> { [35198 bytes data]
> * schannel: failed to decrypt data, need more data
> { [21738 bytes data]
> * schannel: failed to decrypt data, need more data
> { [35854 bytes data]
> * schannel: failed to decrypt data, need more data
> { [25878 bytes data]
> * schannel: failed to decrypt data, need more data
> { [5193 bytes data]
> * schannel: failed to decrypt data, need more data
> { [13805 bytes data]
> * schannel: failed to decrypt data, need more data
> { [5512 bytes data]
> * schannel: failed to decrypt data, need more data
> { [5512 bytes data]
> * schannel: failed to decrypt data, need more data
> { [20374 bytes data]
> * schannel: failed to decrypt data, need more data
> { [1378 bytes data]
> * schannel: failed to decrypt data, need more data
> { [19292 bytes data]
> * schannel: failed to decrypt data, need more data
> { [4134 bytes data]
> * schannel: failed to decrypt data, need more data
> { [21752 bytes data]
> * schannel: failed to decrypt data, need more data
> { [2756 bytes data]
> * schannel: failed to decrypt data, need more data
> { [24508 bytes data]
> * schannel: failed to decrypt data, need more data
> { [13780 bytes data]
> * schannel: failed to decrypt data, need more data
> { [47936 bytes data]
> * schannel: failed to decrypt data, need more data
> { [11024 bytes data]
> * schannel: failed to decrypt data, need more data
> { [53150 bytes data]
> 100 ?504k ? ?0 ?504k ? ?0 ? ? 0 ? 556k ? ? ?0 --:--:-- --:--:-- --:--:-- 
>  ?559k
> * Connection #0 to host www.youtube.com <http://www.youtube.com> left intact
> 
> 
> Now for a direct test with a proxy definition for a port which is not 
> intercept but plain forward proxy:
> 
> 1724109426.755 ? 1638 192.168.78.252 TCP_TUNNEL/200 533406 CONNECT 
> www.youtube.com:443 <http://www.youtube.com:443> - 
> HIER_DIRECT/142.250.184.238 <http://142.250.184.238> - -
> 
> PS C:\Users\eliez> curl -x http://192.168.66.1:3128 
> <http://192.168.66.1:3128> -v -k https://www.youtube.com/ 
> <https://www.youtube.com/> ?-o 1.txt
>  ? % Total ? ?% Received % Xferd ?Average Speed ? Time ? ?Time ? ? Time 
>  ?Current
>  ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ?Dload ?Upload ? Total ? Spent ? ?Left 
>  ?Speed
>  ? 0 ? ? 0 ? ?0 ? ? 0 ? ?0 ? ? 0 ? ? ?0 ? ? ?0 --:--:-- --:--:-- 
> --:--:-- ? ? 0* ? Trying 192.168.66.1:3128...
> * Connected to 192.168.66.1 (192.168.66.1) port 3128
> * CONNECT tunnel: HTTP/1.1 negotiated
> * allocate connect buffer
> * Establish HTTP proxy tunnel to www.youtube.com:443 
> <http://www.youtube.com:443>
>  > CONNECT www.youtube.com:443 <http://www.youtube.com:443> HTTP/1.1
>  > Host: www.youtube.com:443 <http://www.youtube.com:443>
>  > User-Agent: curl/8.8.0
>  > Proxy-Connection: Keep-Alive
>  >
> < HTTP/1.1 200 Connection established
> <
> * CONNECT phase completed
> * CONNECT tunnel established, response 200
> * schannel: disabled automatic use of client certificate
> * ALPN: curl offers http/1.1
> * ALPN: server accepted http/1.1
> * using HTTP/1.x
>  > GET / HTTP/1.1
>  > Host: www.youtube.com <http://www.youtube.com>
>  > User-Agent: curl/8.8.0
>  > Accept: */*
>  >
> * Request completely sent off
> * schannel: remote party requests renegotiation
> * schannel: renegotiating SSL/TLS connection
> * schannel: SSL/TLS connection renegotiated
> < HTTP/1.1 200 OK
> < Content-Type: text/html; charset=utf-8
> < X-Content-Type-Options: nosniff
> < Cache-Control: no-cache, no-store, max-age=0, must-revalidate
> < Pragma: no-cache
> < Expires: Mon, 01 Jan 1990 00:00:00 GMT
> < Date: Mon, 19 Aug 2024 23:17:05 GMT
> < Strict-Transport-Security: max-age=31536000
> < X-Frame-Options: SAMEORIGIN
> < Content-Security-Policy: require-trusted-types-for 'script'
> < Permissions-Policy: ch-ua-arch=*, ch-ua-bitness=*, 
> ch-ua-full-version=*, ch-ua-full-version-list=*, ch-ua-model=*, 
> ch-ua-wow64=*, ch-ua-form-factors=*, ch-ua-platform=*, 
> ch-ua-platform-version=*
> < Report-To: 
> {"group":"youtube_main","max_age":2592000,"endpoints":[{"url":"https://csp.withgoogle.com/csp/report-to/youtube_main <https://csp.withgoogle.com/csp/report-to/youtube_main>"}]}
> < Origin-Trial: 
> AmhMBR6zCLzDDxpW+HfpP67BqwIknWnyMOXOQGfzYswFmJe+fgaI6XZgAzcxOrzNtP7hEDsOo1jdjFnVr2IdxQ4AAAB4eyJvcmlnaW4iOiJodHRwczovL3lvdXR1YmUuY29tOjQ0MyIsImZlYXR1cmUiOiJXZWJWaWV3WFJlcXVlc3RlZFdpdGhEZXByZWNhdGlvbiIsImV4cGlyeSI6MTc1ODA2NzE5OSwiaXNTdWJkb21haW4iOnRydWV9
> < Cross-Origin-Opener-Policy: same-origin-allow-popups; 
> report-to="youtube_main"
> < P3P: CP="This is not a P3P policy! See 
> http://support.google.com/accounts/answer/151657?hl=en 
> <http://support.google.com/accounts/answer/151657?hl=en> for more info."
> < Server: ESF
> < X-XSS-Protection: 0
> < Set-Cookie: GPS=1; Domain=.youtube.com <http://youtube.com>; 
> Expires=Mon, 19-Aug-2024 23:47:05 GMT; Path=/; Secure; HttpOnly
> < Set-Cookie: YSC=OujtWi5Xgqo; Domain=.youtube.com <http://youtube.com>; 
> Path=/; Secure; HttpOnly; SameSite=none
> < Set-Cookie: VISITOR_INFO1_LIVE=PtNdaPPFKOg; Domain=.youtube.com 
> <http://youtube.com>; Expires=Sat, 15-Feb-2025 23:17:05 GMT; Path=/; 
> Secure; HttpOnly; SameSite=none
> < Set-Cookie: VISITOR_PRIVACY_METADATA=CgJJTBIEGgAgTA%3D%3D; 
> Domain=.youtube.com <http://youtube.com>; Expires=Sat, 15-Feb-2025 
> 23:17:05 GMT; Path=/; Secure; HttpOnly; SameSite=none
> < Alt-Svc: h3=":443"; ma=2592000,h3-29=":443"; ma=2592000
> < Accept-Ranges: none
> < Vary: Accept-Encoding
> < Transfer-Encoding: chunked
> <
> { [9490 bytes data]
> 100 16366 ? ?0 16366 ? ?0 ? ? 0 ?32466 ? ? ?0 --:--:-- --:--:-- --:--:-- 
> 32407* schannel: failed to decrypt data, need more data
> { [5216 bytes data]
> * schannel: failed to decrypt data, need more data
> { [2756 bytes data]
> * schannel: failed to decrypt data, need more data
> { [2756 bytes data]
> * schannel: failed to decrypt data, need more data
> { [2756 bytes data]
> * schannel: failed to decrypt data, need more data
> { [4134 bytes data]
> * schannel: failed to decrypt data, need more data
> { [2756 bytes data]
> * schannel: failed to decrypt data, need more data
> { [21729 bytes data]
> * schannel: failed to decrypt data, need more data
> { [18982 bytes data]
> * schannel: failed to decrypt data, need more data
> { [22071 bytes data]
> * schannel: failed to decrypt data, need more data
> { [6890 bytes data]
> * schannel: failed to decrypt data, need more data
> { [14848 bytes data]
> * schannel: failed to decrypt data, need more data
> { [11024 bytes data]
> * schannel: failed to decrypt data, need more data
> { [10706 bytes data]
> * schannel: failed to decrypt data, need more data
> { [15158 bytes data]
> * schannel: failed to decrypt data, need more data
> { [2756 bytes data]
> * schannel: failed to decrypt data, need more data
> { [10714 bytes data]
> * schannel: failed to decrypt data, need more data
> { [15180 bytes data]
> * schannel: failed to decrypt data, need more data
> { [22273 bytes data]
> * schannel: failed to decrypt data, need more data
> { [44653 bytes data]
> * schannel: failed to decrypt data, need more data
> { [22048 bytes data]
> * schannel: failed to decrypt data, need more data
> { [101084 bytes data]
> * schannel: failed to decrypt data, need more data
> { [4134 bytes data]
> * schannel: failed to decrypt data, need more data
> { [80712 bytes data]
> * schannel: failed to decrypt data, need more data
> { [23130 bytes data]
> 100 ?503k ? ?0 ?503k ? ?0 ? ? 0 ? 670k ? ? ?0 --:--:-- --:--:-- --:--:-- 
>  ?670k
> * Connection #0 to host 192.168.66.1 left intact
> 
> 
> For a direct forward proxy to a sslbump?enabled port these are the results:
> 
> 1724109490.260 ? ?217 192.168.78.252 NONE_NONE/200 0 CONNECT 
> www.youtube.com:443 <http://www.youtube.com:443> - 
> HIER_DIRECT/142.250.181.238 <http://142.250.181.238> - www.youtube.com 
> <http://www.youtube.com>
> 1724109490.947 ? ?686 192.168.78.252 TCP_MISS/200 516442 GET 
> https://www.youtube.com/ <https://www.youtube.com/> - 
> HIER_DIRECT/142.250.181.238 <http://142.250.181.238> text/html 
> www.youtube.com <http://www.youtube.com>
> 
> PS C:\Users\eliez> curl -x http://192.168.66.1:13128 
> <http://192.168.66.1:13128> -v -k https://www.youtube.com/ 
> <https://www.youtube.com/> ?-o 1.txt
>  ? % Total ? ?% Received % Xferd ?Average Speed ? Time ? ?Time ? ? Time 
>  ?Current
>  ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ?Dload ?Upload ? Total ? Spent ? ?Left 
>  ?Speed
>  ? 0 ? ? 0 ? ?0 ? ? 0 ? ?0 ? ? 0 ? ? ?0 ? ? ?0 --:--:-- --:--:-- 
> --:--:-- ? ? 0* ? Trying 192.168.66.1:13128...
> * Connected to 192.168.66.1 (192.168.66.1) port 13128
> * CONNECT tunnel: HTTP/1.1 negotiated
> * allocate connect buffer
> * Establish HTTP proxy tunnel to www.youtube.com:443 
> <http://www.youtube.com:443>
>  > CONNECT www.youtube.com:443 <http://www.youtube.com:443> HTTP/1.1
>  > Host: www.youtube.com:443 <http://www.youtube.com:443>
>  > User-Agent: curl/8.8.0
>  > Proxy-Connection: Keep-Alive
>  >
> < HTTP/1.1 200 Connection established
> <
> * CONNECT phase completed
> * CONNECT tunnel established, response 200
> * schannel: disabled automatic use of client certificate
> * ALPN: curl offers http/1.1
> * ALPN: server did not agree on a protocol. Uses default.
> * using HTTP/1.x
>  > GET / HTTP/1.1
>  > Host: www.youtube.com <http://www.youtube.com>
>  > User-Agent: curl/8.8.0
>  > Accept: */*
>  >
> * Request completely sent off
> * schannel: remote party requests renegotiation
> * schannel: renegotiating SSL/TLS connection
> * schannel: SSL/TLS connection renegotiated
> * schannel: remote party requests renegotiation
> * schannel: renegotiating SSL/TLS connection
> * schannel: SSL/TLS connection renegotiated
> < HTTP/1.1 200 OK
> < Content-Type: text/html; charset=utf-8
> < X-Content-Type-Options: nosniff
> < Cache-Control: no-cache, no-store, max-age=0, must-revalidate
> < Pragma: no-cache
> < Expires: Mon, 01 Jan 1990 00:00:00 GMT
> < Date: Mon, 19 Aug 2024 23:18:10 GMT
> < Strict-Transport-Security: max-age=31536000
> < X-Frame-Options: SAMEORIGIN
> < Content-Security-Policy: require-trusted-types-for 'script'
> < Origin-Trial: 
> AmhMBR6zCLzDDxpW+HfpP67BqwIknWnyMOXOQGfzYswFmJe+fgaI6XZgAzcxOrzNtP7hEDsOo1jdjFnVr2IdxQ4AAAB4eyJvcmlnaW4iOiJodHRwczovL3lvdXR1YmUuY29tOjQ0MyIsImZlYXR1cmUiOiJXZWJWaWV3WFJlcXVlc3RlZFdpdGhEZXByZWNhdGlvbiIsImV4cGlyeSI6MTc1ODA2NzE5OSwiaXNTdWJkb21haW4iOnRydWV9
> < Cross-Origin-Opener-Policy: same-origin-allow-popups; 
> report-to="youtube_main"
> < Permissions-Policy: ch-ua-arch=*, ch-ua-bitness=*, 
> ch-ua-full-version=*, ch-ua-full-version-list=*, ch-ua-model=*, 
> ch-ua-wow64=*, ch-ua-form-factors=*, ch-ua-platform=*, 
> ch-ua-platform-version=*
> < Report-To: 
> {"group":"youtube_main","max_age":2592000,"endpoints":[{"url":"https://csp.withgoogle.com/csp/report-to/youtube_main <https://csp.withgoogle.com/csp/report-to/youtube_main>"}]}
> < P3P: CP="This is not a P3P policy! See 
> http://support.google.com/accounts/answer/151657?hl=en 
> <http://support.google.com/accounts/answer/151657?hl=en> for more info."
> < Server: ESF
> < X-XSS-Protection: 0
> < Set-Cookie: GPS=1; Domain=.youtube.com <http://youtube.com>; 
> Expires=Mon, 19-Aug-2024 23:48:10 GMT; Path=/; Secure; HttpOnly
> < Set-Cookie: YSC=6pPz8lVi60s; Domain=.youtube.com <http://youtube.com>; 
> Path=/; Secure; HttpOnly; SameSite=none
> < Set-Cookie: VISITOR_INFO1_LIVE=zD4fzRwONpc; Domain=.youtube.com 
> <http://youtube.com>; Expires=Sat, 15-Feb-2025 23:18:10 GMT; Path=/; 
> Secure; HttpOnly; SameSite=none
> < Set-Cookie: VISITOR_PRIVACY_METADATA=CgJJTBIEGgAgOQ%3D%3D; 
> Domain=.youtube.com <http://youtube.com>; Expires=Sat, 15-Feb-2025 
> 23:18:10 GMT; Path=/; Secure; HttpOnly; SameSite=none
> < Alt-Svc: h3=":443"; ma=2592000,h3-29=":443"; ma=2592000
> < Accept-Ranges: none
> < Vary: Accept-Encoding
> < X-Cache: MISS from 005-NgTech-Home-Proxy-1
> < X-Cache-Lookup: MISS from 005-NgTech-Home-Proxy-1:3128
> < Transfer-Encoding: chunked
> < Via: 1.1 005-NgTech-Home-Proxy-1 (squid/5.9)
> < Connection: keep-alive
> <
> { [7370 bytes data]
> 100 27390 ? ?0 27390 ? ?0 ? ? 0 ?35637 ? ? ?0 --:--:-- --:--:-- --:--:-- 
> 35617* schannel: failed to decrypt data, need more data
> { [2770 bytes data]
> * schannel: failed to decrypt data, need more data
> { [21842 bytes data]
> * schannel: failed to decrypt data, need more data
> { [21834 bytes data]
> * schannel: failed to decrypt data, need more data
> { [10776 bytes data]
> * schannel: failed to decrypt data, need more data
> { [11080 bytes data]
> * schannel: failed to decrypt data, need more data
> { [100491 bytes data]
> 100 ?499k ? ?0 ?499k ? ?0 ? ? 0 ? 488k ? ? ?0 --:--:-- ?0:00:01 --:--:-- 
>  ?489k
> * Connection #0 to host 192.168.66.1 left intact
> 
> Now for the second part which is to play with the ssl_bump options.
> currently the options I am using are:
> ssl_bump peek step1
> ssl_bump bump all
> 
> So now I will try to change them a bit.
> 
> For a direct curl request to the intercept with ssl bump port I get the 
> next logs:
> 
> 
> 
> 2024/08/20 02:23:18 kid1| SECURITY ALERT: Host header forgery detected 
> on conn364 local=192.168.66.1:33128 <http://192.168.66.1:33128> 
> remote=192.168.78.252:40721 <http://192.168.78.252:40721> FD 10 flags=33 
> (intercepted port does not match 443)
>  ? ? current master transaction: master118
> 2024/08/20 02:23:18 kid1| SECURITY ALERT: By user agent: curl/8.8.0
>  ? ? current master transaction: master118
> 2024/08/20 02:23:18 kid1| SECURITY ALERT: on URL: www.youtube.com:443 
> <http://www.youtube.com:443>
>  ? ? current master transaction: master118
> 2024/08/20 02:23:18 kid1| kick abandoning conn364 
> local=192.168.66.1:33128 <http://192.168.66.1:33128> 
> remote=192.168.78.252:40721 <http://192.168.78.252:40721> FD 10 flags=33
>  ? ? connection: conn364 local=192.168.66.1:33128 
> <http://192.168.66.1:33128> remote=192.168.78.252:40721 
> <http://192.168.78.252:40721> FD 10 flags=33
> 
> ==> /var/log/squid/access.log <==
> 1724109798.106 ? ? ?0 192.168.78.252 NONE_NONE/409 4177 CONNECT 
> www.youtube.com:443 <http://www.youtube.com:443> - HIER_NONE/- text/html -
> 
> PS C:\Users\eliez> curl -x http://192.168.66.1:33128 
> <http://192.168.66.1:33128> -v -k https://www.youtube.com/ 
> <https://www.youtube.com/> ?-o 1.txt
>  ? % Total ? ?% Received % Xferd ?Average Speed ? Time ? ?Time ? ? Time 
>  ?Current
>  ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ?Dload ?Upload ? Total ? Spent ? ?Left 
>  ?Speed
>  ? 0 ? ? 0 ? ?0 ? ? 0 ? ?0 ? ? 0 ? ? ?0 ? ? ?0 --:--:-- --:--:-- 
> --:--:-- ? ? 0* ? Trying 192.168.66.1:33128...
> * Connected to 192.168.66.1 (192.168.66.1) port 33128
> * CONNECT tunnel: HTTP/1.1 negotiated
> * allocate connect buffer
> * Establish HTTP proxy tunnel to www.youtube.com:443 
> <http://www.youtube.com:443>
>  > CONNECT www.youtube.com:443 <http://www.youtube.com:443> HTTP/1.1
>  > Host: www.youtube.com:443 <http://www.youtube.com:443>
>  > User-Agent: curl/8.8.0
>  > Proxy-Connection: Keep-Alive
>  >
> < HTTP/1.1 409 Conflict
> < Server: squid/5.9
> < Mime-Version: 1.0
> < Date: Mon, 19 Aug 2024 23:23:18 GMT
> < Content-Type: text/html;charset=utf-8
> < Content-Length: 3765
> < X-Squid-Error: ERR_CONFLICT_HOST 0
> < Vary: Accept-Language
> < Content-Language: en
> < X-Cache: MISS from 005-NgTech-Home-Proxy-1
> < X-Cache-Lookup: NONE from 005-NgTech-Home-Proxy-1:3128
> < Via: 1.1 005-NgTech-Home-Proxy-1 (squid/5.9)
> < Connection: keep-alive
> <
> * CONNECT tunnel failed, response 409
>  ? 0 ? ? 0 ? ?0 ? ? 0 ? ?0 ? ? 0 ? ? ?0 ? ? ?0 --:--:-- --:--:-- 
> --:--:-- ? ? 0
> * Closing connection
> curl: (56) CONNECT tunnel failed, response 409
> 
> With a Splice all the results are:
> Access log:
> 1724109929.178 ? ? ?0 192.168.78.252 NONE_NONE/000 0 - 
> error:invalid-request - HIER_NONE/- - -
> 1724109930.776 ? 1598 192.168.78.252 TCP_TUNNEL/200 531067 - 
> 142.250.185.78:443 <http://142.250.185.78:443> - 
> ORIGINAL_DST/142.250.185.78 <http://142.250.185.78> - -
> 
> PS C:\Users\eliez> curl -v -k https://www.youtube.com/ 
> <https://www.youtube.com/> ?-o 1.txt
>  ? % Total ? ?% Received % Xferd ?Average Speed ? Time ? ?Time ? ? Time 
>  ?Current
>  ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ?Dload ?Upload ? Total ? Spent ? ?Left 
>  ?Speed
>  ? 0 ? ? 0 ? ?0 ? ? 0 ? ?0 ? ? 0 ? ? ?0 ? ? ?0 --:--:-- --:--:-- 
> --:--:-- ? ? 0* Host www.youtube.com:443 <http://www.youtube.com:443> 
> was resolved.
> * IPv6: 2a00:1450:4001:81c::200e, 2a00:1450:4001:809::200e, 
> 2a00:1450:4001:800::200e, 2a00:1450:4001:80e::200e
> * IPv4: 142.250.185.78, 142.250.185.110, 142.250.185.142, 
> 142.250.186.174, 142.250.185.174, 142.250.184.238, 142.250.185.238, 
> 142.250.185.206, 142.250.181.238, 142.250.186.46, 142.250.186.78, 
> 172.217.16.142, 216.58.212.174, 216.58.206.46, 172.217.18.110, 
> 172.217.23.110
> * ? Trying [2a00:1450:4001:81c::200e]:443...
> * ? Trying 142.250.185.78:443...
> * Connected to www.youtube.com <http://www.youtube.com> (142.250.185.78) 
> port 443
> * schannel: disabled automatic use of client certificate
> * ALPN: curl offers http/1.1
> * ALPN: server accepted http/1.1
> * using HTTP/1.x
>  > GET / HTTP/1.1
>  > Host: www.youtube.com <http://www.youtube.com>
>  > User-Agent: curl/8.8.0
>  > Accept: */*
>  >
> * Request completely sent off
> * schannel: remote party requests renegotiation
> * schannel: renegotiating SSL/TLS connection
> * schannel: SSL/TLS connection renegotiated
> * schannel: failed to decrypt data, need more data
> < HTTP/1.1 200 OK
> < Content-Type: text/html; charset=utf-8
> < X-Content-Type-Options: nosniff
> < Cache-Control: no-cache, no-store, max-age=0, must-revalidate
> < Pragma: no-cache
> < Expires: Mon, 01 Jan 1990 00:00:00 GMT
> < Date: Mon, 19 Aug 2024 23:25:29 GMT
> < Strict-Transport-Security: max-age=31536000
> < X-Frame-Options: SAMEORIGIN
> < Permissions-Policy: ch-ua-arch=*, ch-ua-bitness=*, 
> ch-ua-full-version=*, ch-ua-full-version-list=*, ch-ua-model=*, 
> ch-ua-wow64=*, ch-ua-form-factors=*, ch-ua-platform=*, 
> ch-ua-platform-version=*
> < Content-Security-Policy: require-trusted-types-for 'script'
> < Cross-Origin-Opener-Policy: same-origin-allow-popups; 
> report-to="youtube_main"
> < Report-To: 
> {"group":"youtube_main","max_age":2592000,"endpoints":[{"url":"https://csp.withgoogle.com/csp/report-to/youtube_main <https://csp.withgoogle.com/csp/report-to/youtube_main>"}]}
> < Origin-Trial: 
> AmhMBR6zCLzDDxpW+HfpP67BqwIknWnyMOXOQGfzYswFmJe+fgaI6XZgAzcxOrzNtP7hEDsOo1jdjFnVr2IdxQ4AAAB4eyJvcmlnaW4iOiJodHRwczovL3lvdXR1YmUuY29tOjQ0MyIsImZlYXR1cmUiOiJXZWJWaWV3WFJlcXVlc3RlZFdpdGhEZXByZWNhdGlvbiIsImV4cGlyeSI6MTc1ODA2NzE5OSwiaXNTdWJkb21haW4iOnRydWV9
> < P3P: CP="This is not a P3P policy! See 
> http://support.google.com/accounts/answer/151657?hl=en 
> <http://support.google.com/accounts/answer/151657?hl=en> for more info."
> < Server: ESF
> < X-XSS-Protection: 0
> < Set-Cookie: GPS=1; Domain=.youtube.com <http://youtube.com>; 
> Expires=Mon, 19-Aug-2024 23:55:29 GMT; Path=/; Secure; HttpOnly
> < Set-Cookie: YSC=O3fSKdGlL-Q; Domain=.youtube.com <http://youtube.com>; 
> Path=/; Secure; HttpOnly; SameSite=none
> < Set-Cookie: VISITOR_INFO1_LIVE=2PPYvkk_Sbo; Domain=.youtube.com 
> <http://youtube.com>; Expires=Sat, 15-Feb-2025 23:25:29 GMT; Path=/; 
> Secure; HttpOnly; SameSite=none
> < Set-Cookie: VISITOR_PRIVACY_METADATA=CgJJTBIEGgAgGA%3D%3D; 
> Domain=.youtube.com <http://youtube.com>; Expires=Sat, 15-Feb-2025 
> 23:25:29 GMT; Path=/; Secure; HttpOnly; SameSite=none
> < Alt-Svc: h3=":443"; ma=2592000,h3-29=":443"; ma=2592000
> < Accept-Ranges: none
> < Vary: Accept-Encoding
> < Transfer-Encoding: chunked
> <
> { [3674 bytes data]
> 100 24634 ? ?0 24634 ? ?0 ? ? 0 ?31895 ? ? ?0 --:--:-- --:--:-- --:--:-- 
> 32033* schannel: failed to decrypt data, need more data
> { [2460 bytes data]
> * schannel: failed to decrypt data, need more data
> { [2756 bytes data]
> * schannel: failed to decrypt data, need more data
> { [2756 bytes data]
> * schannel: failed to decrypt data, need more data
> { [2756 bytes data]
> * schannel: failed to decrypt data, need more data
> { [2756 bytes data]
> * schannel: failed to decrypt data, need more data
> { [2756 bytes data]
> * schannel: failed to decrypt data, need more data
> { [21728 bytes data]
> * schannel: failed to decrypt data, need more data
> { [16536 bytes data]
> * schannel: failed to decrypt data, need more data
> { [1068 bytes data]
> * schannel: failed to decrypt data, need more data
> { [22072 bytes data]
> * schannel: failed to decrypt data, need more data
> { [4134 bytes data]
> * schannel: failed to decrypt data, need more data
> { [5512 bytes data]
> * schannel: failed to decrypt data, need more data
> { [5512 bytes data]
> * schannel: failed to decrypt data, need more data
> { [9336 bytes data]
> * schannel: failed to decrypt data, need more data
> { [4134 bytes data]
> * schannel: failed to decrypt data, need more data
> { [4134 bytes data]
> * schannel: failed to decrypt data, need more data
> { [8268 bytes data]
> * schannel: failed to decrypt data, need more data
> { [7949 bytes data]
> * schannel: failed to decrypt data, need more data
> { [2756 bytes data]
> * schannel: failed to decrypt data, need more data
> { [11024 bytes data]
> * schannel: failed to decrypt data, need more data
> { [6890 bytes data]
> * schannel: failed to decrypt data, need more data
> { [5512 bytes data]
> * schannel: failed to decrypt data, need more data
> { [2446 bytes data]
> * schannel: failed to decrypt data, need more data
> { [22071 bytes data]
> * schannel: failed to decrypt data, need more data
> { [35526 bytes data]
> * schannel: failed to decrypt data, need more data
> { [18974 bytes data]
> * schannel: failed to decrypt data, need more data
> { [23450 bytes data]
> * schannel: failed to decrypt data, need more data
> { [58662 bytes data]
> * schannel: failed to decrypt data, need more data
> { [21752 bytes data]
> * schannel: failed to decrypt data, need more data
> { [42424 bytes data]
> * schannel: failed to decrypt data, need more data
> { [12402 bytes data]
> * schannel: failed to decrypt data, need more data
> { [42422 bytes data]
> * schannel: failed to decrypt data, need more data
> { [7972 bytes data]
> * schannel: failed to decrypt data, need more data
> { [4134 bytes data]
> 100 ?501k ? ?0 ?501k ? ?0 ? ? 0 ? 496k ? ? ?0 --:--:-- ?0:00:01 --:--:-- 
>  ?498k
> * Connection #0 to host www.youtube.com <http://www.youtube.com> left intact
> 
> I am unsure if to continue but I will test again the next ssl bump rules 
> (maybe I got your instructions wrong):
> ssl_bump peek all
> ssl_bump bump all
> 
> Access.log
> 1724110080.231 ? ? ?0 192.168.78.252 NONE_NONE/000 0 - 
> error:invalid-request - HIER_NONE/- - -
> 1724110081.819 ? 1587 192.168.78.252 TCP_TUNNEL/200 532898 - 
> 142.250.185.78:443 <http://142.250.185.78:443> - 
> ORIGINAL_DST/142.250.185.78 <http://142.250.185.78> - -
> 
> Curl:
> PS C:\Users\eliez> curl -v -k https://www.youtube.com/ 
> <https://www.youtube.com/> ?-o 1.txt
>  ? % Total ? ?% Received % Xferd ?Average Speed ? Time ? ?Time ? ? Time 
>  ?Current
>  ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ?Dload ?Upload ? Total ? Spent ? ?Left 
>  ?Speed
>  ? 0 ? ? 0 ? ?0 ? ? 0 ? ?0 ? ? 0 ? ? ?0 ? ? ?0 --:--:-- --:--:-- 
> --:--:-- ? ? 0* Host www.youtube.com:443 <http://www.youtube.com:443> 
> was resolved.
> * IPv6: 2a00:1450:4001:80e::200e, 2a00:1450:4001:80f::200e, 
> 2a00:1450:4001:810::200e, 2a00:1450:4001:82b::200e
> * IPv4: 142.250.185.78, 142.250.185.110, 142.250.185.142, 
> 142.250.186.174, 142.250.185.174, 142.250.184.238, 142.250.185.238, 
> 142.250.185.206, 142.250.181.238, 142.250.186.46, 142.250.186.78, 
> 172.217.16.142, 216.58.212.174, 216.58.206.46, 172.217.18.110, 
> 172.217.23.110
> * ? Trying [2a00:1450:4001:80e::200e]:443...
> * ? Trying 142.250.185.78:443...
> * Connected to www.youtube.com <http://www.youtube.com> (142.250.185.78) 
> port 443
> * schannel: disabled automatic use of client certificate
> * ALPN: curl offers http/1.1
> * ALPN: server accepted http/1.1
> * using HTTP/1.x
>  > GET / HTTP/1.1
>  > Host: www.youtube.com <http://www.youtube.com>
>  > User-Agent: curl/8.8.0
>  > Accept: */*
>  >
> * Request completely sent off
> * schannel: remote party requests renegotiation
> * schannel: renegotiating SSL/TLS connection
> * schannel: SSL/TLS connection renegotiated
> * schannel: failed to decrypt data, need more data
> < HTTP/1.1 200 OK
> < Content-Type: text/html; charset=utf-8
> < X-Content-Type-Options: nosniff
> < Cache-Control: no-cache, no-store, max-age=0, must-revalidate
> < Pragma: no-cache
> < Expires: Mon, 01 Jan 1990 00:00:00 GMT
> < Date: Mon, 19 Aug 2024 23:28:00 GMT
> < X-Frame-Options: SAMEORIGIN
> < Strict-Transport-Security: max-age=31536000
> < Cross-Origin-Opener-Policy: same-origin-allow-popups; 
> report-to="youtube_main"
> < Content-Security-Policy: require-trusted-types-for 'script'
> < Report-To: 
> {"group":"youtube_main","max_age":2592000,"endpoints":[{"url":"https://csp.withgoogle.com/csp/report-to/youtube_main <https://csp.withgoogle.com/csp/report-to/youtube_main>"}]}
> < Origin-Trial: 
> AmhMBR6zCLzDDxpW+HfpP67BqwIknWnyMOXOQGfzYswFmJe+fgaI6XZgAzcxOrzNtP7hEDsOo1jdjFnVr2IdxQ4AAAB4eyJvcmlnaW4iOiJodHRwczovL3lvdXR1YmUuY29tOjQ0MyIsImZlYXR1cmUiOiJXZWJWaWV3WFJlcXVlc3RlZFdpdGhEZXByZWNhdGlvbiIsImV4cGlyeSI6MTc1ODA2NzE5OSwiaXNTdWJkb21haW4iOnRydWV9
> < Permissions-Policy: ch-ua-arch=*, ch-ua-bitness=*, 
> ch-ua-full-version=*, ch-ua-full-version-list=*, ch-ua-model=*, 
> ch-ua-wow64=*, ch-ua-form-factors=*, ch-ua-platform=*, 
> ch-ua-platform-version=*
> < P3P: CP="This is not a P3P policy! See 
> http://support.google.com/accounts/answer/151657?hl=en 
> <http://support.google.com/accounts/answer/151657?hl=en> for more info."
> < Server: ESF
> < X-XSS-Protection: 0
> < Set-Cookie: GPS=1; Domain=.youtube.com <http://youtube.com>; 
> Expires=Mon, 19-Aug-2024 23:58:00 GMT; Path=/; Secure; HttpOnly
> < Set-Cookie: YSC=zO-uFscIOFo; Domain=.youtube.com <http://youtube.com>; 
> Path=/; Secure; HttpOnly; SameSite=none
> < Set-Cookie: VISITOR_INFO1_LIVE=ewGx6w06928; Domain=.youtube.com 
> <http://youtube.com>; Expires=Sat, 15-Feb-2025 23:28:00 GMT; Path=/; 
> Secure; HttpOnly; SameSite=none
> < Set-Cookie: VISITOR_PRIVACY_METADATA=CgJJTBIEGgAgFA%3D%3D; 
> Domain=.youtube.com <http://youtube.com>; Expires=Sat, 15-Feb-2025 
> 23:28:00 GMT; Path=/; Secure; HttpOnly; SameSite=none
> < Alt-Svc: h3=":443"; ma=2592000,h3-29=":443"; ma=2592000
> < Accept-Ranges: none
> < Vary: Accept-Encoding
> < Transfer-Encoding: chunked
> <
> { [3674 bytes data]
> 100 16366 ? ?0 16366 ? ?0 ? ? 0 ?23561 ? ? ?0 --:--:-- --:--:-- --:--:-- 
> 23684* schannel: failed to decrypt data, need more data
> { [1082 bytes data]
> * schannel: failed to decrypt data, need more data
> { [2756 bytes data]
> * schannel: failed to decrypt data, need more data
> { [2756 bytes data]
> * schannel: failed to decrypt data, need more data
> { [2756 bytes data]
> * schannel: failed to decrypt data, need more data
> { [2756 bytes data]
> * schannel: failed to decrypt data, need more data
> { [2756 bytes data]
> * schannel: failed to decrypt data, need more data
> { [4134 bytes data]
> * schannel: failed to decrypt data, need more data
> { [2436 bytes data]
> * schannel: failed to decrypt data, need more data
> { [2756 bytes data]
> * schannel: failed to decrypt data, need more data
> { [2756 bytes data]
> * schannel: failed to decrypt data, need more data
> { [20670 bytes data]
> * schannel: failed to decrypt data, need more data
> { [25896 bytes data]
> * schannel: failed to decrypt data, need more data
> { [20670 bytes data]
> * schannel: failed to decrypt data, need more data
> { [2756 bytes data]
> * schannel: failed to decrypt data, need more data
> { [6580 bytes data]
> * schannel: failed to decrypt data, need more data
> { [11024 bytes data]
> * schannel: failed to decrypt data, need more data
> { [5193 bytes data]
> * schannel: failed to decrypt data, need more data
> { [5512 bytes data]
> * schannel: failed to decrypt data, need more data
> { [11024 bytes data]
> * schannel: failed to decrypt data, need more data
> { [2756 bytes data]
> * schannel: failed to decrypt data, need more data
> { [9646 bytes data]
> * schannel: failed to decrypt data, need more data
> { [2756 bytes data]
> * schannel: failed to decrypt data, need more data
> { [9336 bytes data]
> * schannel: failed to decrypt data, need more data
> { [2756 bytes data]
> * schannel: failed to decrypt data, need more data
> { [13803 bytes data]
> * schannel: failed to decrypt data, need more data
> { [6890 bytes data]
> * schannel: failed to decrypt data, need more data
> { [21746 bytes data]
> * schannel: failed to decrypt data, need more data
> { [56204 bytes data]
> * schannel: failed to decrypt data, need more data
> { [7972 bytes data]
> * schannel: failed to decrypt data, need more data
> { [6890 bytes data]
> * schannel: failed to decrypt data, need more data
> { [23130 bytes data]
> * schannel: failed to decrypt data, need more data
> { [54824 bytes data]
> * schannel: failed to decrypt data, need more data
> { [23130 bytes data]
> * schannel: failed to decrypt data, need more data
> { [74118 bytes data]
> 100 ?503k ? ?0 ?503k ? ?0 ? ? 0 ? 531k ? ? ?0 --:--:-- --:--:-- --:--:-- 
>  ?533k
> * Connection #0 to host www.youtube.com <http://www.youtube.com> left intact
> 
> This is all the same with both 5.9 and 6.10 as far as I can tell.
> 
> I know it's a lot of logs but it seems like the problem is well understood.
> All the above tests are done using the DNAT REDIRECT method.
> 
> Just take into account that the next are also present in squid.conf
> 
> acl foreignProtocol squid_error ERR_PROTOCOL_UNKNOWN ERR_TOO_BIG
> acl serverTalksFirstProtocol squid_error ERR_REQUEST_START_TIMEOUT
> 
> 
> on_unsupported_protocol tunnel foreignProtocol
> on_unsupported_protocol tunnel serverTalksFirstProtocol
> on_unsupported_protocol respond all
> 
> 
> If you need me to test other things please let me know.
> 
> Eliezer
> 
> ----
> Eliezer Croitoru
> Tech Support
> Mobile: +972-5-28704261
> Email: ngtech1ltd at gmail.com <mailto:ngtech1ltd at gmail.com>
> 
> 
> On Mon, Aug 19, 2024 at 10:59?PM Alex Rousskov 
> <rousskov at measurement-factory.com 
> <mailto:rousskov at measurement-factory.com>> wrote:
> 
>     On 2024-08-19 15:27, ngtech1ltd at gmail.com
>     <mailto:ngtech1ltd at gmail.com> wrote:
> 
>      > I see that there is a SNI so I am not sure how to look at the issue.
> 
>     FWIW, as the next step, I still recommend answering the remaining open
>     questions. Everything else makes a facinating read but is less
>     likely to
>     help us make progress (and may obscure/hide actual answers and test
>     results). I will restate those remaining questions for your convenience:
> 
>     * Do all those 12 access.log records correspond to a single curl
>     request? If not, please only share access.log record(s) that do
>     correspond.
> 
>     2. Does everything work for non-intercept ports? Use the same curl test
>     you have shared below, but specify proxy address for curl to use.
> 
>     4. Does everything work when you remove "ssl-bump" and related options
>     from intercepting http_port 33128 (and use that intercepted port in the
>     same curl test)?
> 
>     5. Does everything work when you use "ssl_bump splice all" instead of
>     your current ssl_bump rule? Same curl parameters as in Q4.
> 
>     6. Does everything work when you use "ssl_bump peek all" instead of
>     your
>     current ssl_bump rule? Same curl parameters as in Q4.
> 
> 
>     While going through the above list, top to bottom, if you find a test
>     that does _not_ work, pause: There is no need to proceed with other,
>     more complicated tests if an earlier simpler/basic test fails.
> 
> 
>     HTH,
> 
>     Alex.
> 
> 
>      > I was thinking that maybe it's something with the OpenSSL version
>     (3.x.x) on Fedora but then I installed both 5.9 and 6.10 on
>     Almalinux 8 and the result is the same.
>      >
>      > I will describe my setup which might give some background.
>      > I have a very big lab...
>      > In the front of the Internet connection there are couple NGFW
>     devices and RouterOS.
>      > Mikrotik RouterOS is the edge and all the others are used with
>     PBR accordingly.
>      > The proxy sits in a deferent segment on the network and I have
>     tried couple methods to intercept the traffic with squid.
>      > The only one which works with Squid and the existing equipment
>     and do not cause some weird loop is ethernet level tunnel ie not:
>      > * GRE
>      > * IPIP
>      > And couple others.
>      >
>      > The only ones which works fine are:
>      > * EoIP (Mikrotik which is based on GRE0
>      > * VxLAN
>      >
>      > There are two methods to intercept the traffic:
>      > * PBR+DNAT on the squid box
>      > * PBR+TPROXY on the squid box
>      >
>      > Since the intercept method terminates the connection and creates
>     a new one with the ip of the proxy it's very simple to even use gre
>     and ipip.
>      > But, with tproxy to allow the traffic being identified currently
>     as a packet which is not still in the routing stack we the linux OS
>     need to tag it somehow.
>      > To do that the default "Salt" for the packet hash in the routing
>     stack is the source and destination mac address.
>      > Due to this the only methods which are allowing to use tproxy are
>     the above mentioned tunnels. (Maybe I will post a video on it later
>     on with a demo)
>      >
>      > The Mikrotik RouterOS device re-routes the traffic from the LAN
>     interface into the VxLAN interface directly to the proxy machine
>     which has a
>      > static or dynamic route to the LAN subnet via the other side of
>     the VxLAN tunnel which is the edge RouterOS device.
>      > I want to gather a set of configurations and tests for this
>     configurations to verify what might cause this issue and if possible
>     to resolve it.
>      > For me it seems that if my FortiGate and CheckPoint devices are
>     able to intercept the traffic and "Bump" it, there is no reason why
>     squid should
>      > be able to do that the same way.
>      >
>      > I will later on send you a private link to the pcaps in a zip
>     file so you would be able to inspect this issue in the network level
>     and to see if there is
>      > some details which can help us understand what cause this
>     specific issue.
>      >
>      > I want to say that bumping works fine on non-intercepted
>     connections and that I have tested the interception with the two
>     available methods ie:
>      > * DNAT Redirect
>      > * Tproxy
>      >
>      > Thanks,
>      > Eliezer Croitoru
>      >
>      > -----Original Message-----
>      > From: Alex Rousskov <rousskov at measurement-factory.com
>     <mailto:rousskov at measurement-factory.com>>
>      > Sent: Monday, August 19, 2024 7:18 PM
>      > To: NgTech LTD <ngtech1ltd at gmail.com <mailto:ngtech1ltd at gmail.com>>
>      > Subject: Re: [squid-users] Squid 6.10 on Fedora 40 cannot
>     intercept and bump SSL Traffic
>      >
>      > Eliezer, please move this thread back to squid-users mailing list
>      > instead of emailing me personally. When you do so, please clarify
>      > whether all 12 access.log records correspond to this single curl
>     request
>      > (if not, please only share access.log record(s) that do
>     correspond). --Alex.
>      >
>      > On 2024-08-19 12:03, NgTech LTD wrote:
>      >> This is the output of curl on windows 11 desktop:
>      >> C:\Users\USER>curl https://www.youtube.com/
>     <https://www.youtube.com/> -k -v -o 1.txt
>      >>? ? ?% Total? ? % Received % Xferd? Average Speed? ?Time? ? Time 
>      ? ?Time
>      >>? ? Current
>      >>? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? Dload? Upload? ?Total 
>      ?Spent? ? Left
>      >>? ? Speed
>      >>? ? ?0? ? ?0? ? 0? ? ?0? ? 0? ? ?0? ? ? 0? ? ? 0 --:--:-- --:--:--
>      >> --:--:--? ? ?0* Host www.youtube.com:443
>     <http://www.youtube.com:443> <http://www.youtube.com:443
>     <http://www.youtube.com:443>>
>      >> was resolved.
>      >> * IPv6: 2a00:1450:4001:800::200e, 2a00:1450:4001:80e::200e,
>      >> 2a00:1450:4001:81c::200e, 2a00:1450:4001:809::200e
>      >> * IPv4: 142.250.185.78, 142.250.185.110, 142.250.185.142,
>      >> 142.250.186.174, 142.250.185.174, 142.250.184.238, 142.250.185.238,
>      >> 142.250.185.206, 142.250.181.238, 142.250.186.46, 142.250.186.78,
>      >> 172.217.16.142, 216.58.212.174, 216.58.206.46, 172.217.23.110,
>      >> 216.58.212.142
>      >> *? ?Trying 142.250.185.78:443...
>      >> * Connected to www.youtube.com <http://www.youtube.com>
>     <http://www.youtube.com <http://www.youtube.com>> (142.250.185.78)
>      >> port 443
>      >> * schannel: disabled automatic use of client certificate
>      >> * ALPN: curl offers http/1.1
>      >> * ALPN: server accepted http/1.1
>      >> * using HTTP/1.x
>      >>? ?> GET / HTTP/1.1
>      >>? ?> Host: www.youtube.com <http://www.youtube.com>
>     <http://www.youtube.com <http://www.youtube.com>>
>      >>? ?> User-Agent: curl/8.8.0
>      >>? ?> Accept: */*
>      >>? ?>
>      >> * Request completely sent off
>      >> * schannel: remote party requests renegotiation
>      >> * schannel: renegotiating SSL/TLS connection
>      >> * schannel: SSL/TLS connection renegotiated
>      >> * schannel: failed to decrypt data, need more data
>      >> < HTTP/1.1 200 OK
>      >> < Content-Type: text/html; charset=utf-8
>      >> < X-Content-Type-Options: nosniff
>      >> < Cache-Control: no-cache, no-store, max-age=0, must-revalidate
>      >> < Pragma: no-cache
>      >> < Expires: Mon, 01 Jan 1990 00:00:00 GMT
>      >> < Date: Mon, 19 Aug 2024 16:02:23 GMT
>      >> < X-Frame-Options: SAMEORIGIN
>      >> < Strict-Transport-Security: max-age=31536000
>      >> < Origin-Trial:
>      >>
>     AmhMBR6zCLzDDxpW+HfpP67BqwIknWnyMOXOQGfzYswFmJe+fgaI6XZgAzcxOrzNtP7hEDsOo1jdjFnVr2IdxQ4AAAB4eyJvcmlnaW4iOiJodHRwczovL3lvdXR1YmUuY29tOjQ0MyIsImZlYXR1cmUiOiJXZWJWaWV3WFJlcXVlc3RlZFdpdGhEZXByZWNhdGlvbiIsImV4cGlyeSI6MTc1ODA2NzE5OSwiaXNTdWJkb21haW4iOnRydWV9
>      >> < Cross-Origin-Opener-Policy: same-origin-allow-popups;
>      >> report-to="youtube_main"
>      >> < Report-To:
>      >>
>     {"group":"youtube_main","max_age":2592000,"endpoints":[{"url":"https://csp.withgoogle.com/csp/report-to/youtube_main <https://csp.withgoogle.com/csp/report-to/youtube_main> <https://csp.withgoogle.com/csp/report-to/youtube_main <https://csp.withgoogle.com/csp/report-to/youtube_main>>"}]}
>      >> < Content-Security-Policy: require-trusted-types-for 'script'
>      >> < Permissions-Policy: ch-ua-arch=*, ch-ua-bitness=*,
>      >> ch-ua-full-version=*, ch-ua-full-version-list=*, ch-ua-model=*,
>      >> ch-ua-wow64=*, ch-ua-form-factors=*, ch-ua-platform=*,
>      >> ch-ua-platform-version=*
>      >> < P3P: CP="This is not a P3P policy! See
>      >> http://support.google.com/accounts/answer/151657?hl=en
>     <http://support.google.com/accounts/answer/151657?hl=en>
>      >> <http://support.google.com/accounts/answer/151657?hl=en
>     <http://support.google.com/accounts/answer/151657?hl=en>> for more
>     info."
>      >> < Server: ESF
>      >> < X-XSS-Protection: 0
>      >> < Set-Cookie: GPS=1; Domain=.youtube.com <http://youtube.com>
>     <http://youtube.com <http://youtube.com>>;
>      >> Expires=Mon, 19-Aug-2024 16:32:23 GMT; Path=/; Secure; HttpOnly
>      >> < Set-Cookie: YSC=XYs_jViLkFw; Domain=.youtube.com
>     <http://youtube.com> <http://youtube.com <http://youtube.com>>;
>      >> Path=/; Secure; HttpOnly; SameSite=none
>      >> < Set-Cookie: VISITOR_INFO1_LIVE=csMabhlNyrI;
>     Domain=.youtube.com <http://youtube.com>
>      >> <http://youtube.com <http://youtube.com>>; Expires=Sat,
>     15-Feb-2025 16:02:23 GMT; Path=/;
>      >> Secure; HttpOnly; SameSite=none
>      >> < Set-Cookie: VISITOR_PRIVACY_METADATA=CgJJTBIEGgAgVw%3D%3D;
>      >> Domain=.youtube.com <http://youtube.com> <http://youtube.com
>     <http://youtube.com>>; Expires=Sat, 15-Feb-2025
>      >> 16:02:23 GMT; Path=/; Secure; HttpOnly; SameSite=none
>      >> < Alt-Svc: h3=":443"; ma=2592000,h3-29=":443"; ma=2592000
>      >> < Accept-Ranges: none
>      >> < Vary: Accept-Encoding
>      >> < Transfer-Encoding: chunked
>      >> <
>      >> { [3674 bytes data]
>      >> * schannel: failed to decrypt data, need more data
>      >> { [8008 bytes data]
>      >> * schannel: failed to decrypt data, need more data
>      >> { [6880 bytes data]
>      >> * schannel: failed to decrypt data, need more data
>      >> { [2752 bytes data]
>      >> * schannel: failed to decrypt data, need more data
>      >> { [5504 bytes data]
>      >> * schannel: failed to decrypt data, need more data
>      >> { [2462 bytes data]
>      >> * schannel: failed to decrypt data, need more data
>      >> { [4128 bytes data]
>      >> * schannel: failed to decrypt data, need more data
>      >> { [2752 bytes data]
>      >> * schannel: failed to decrypt data, need more data
>      >> { [2752 bytes data]
>      >> * schannel: failed to decrypt data, need more data
>      >> { [4128 bytes data]
>      >> * schannel: failed to decrypt data, need more data
>      >> { [2752 bytes data]
>      >> * schannel: failed to decrypt data, need more data
>      >> { [5504 bytes data]
>      >> * schannel: failed to decrypt data, need more data
>      >> { [5504 bytes data]
>      >> * schannel: failed to decrypt data, need more data
>      >> { [4128 bytes data]
>      >> * schannel: failed to decrypt data, need more data
>      >> { [5242 bytes data]
>      >> * schannel: failed to decrypt data, need more data
>      >> { [2752 bytes data]
>      >> * schannel: failed to decrypt data, need more data
>      >> { [2752 bytes data]
>      >> * schannel: failed to decrypt data, need more data
>      >> { [6922 bytes data]
>      >> * schannel: failed to decrypt data, need more data
>      >> { [2752 bytes data]
>      >> * schannel: failed to decrypt data, need more data
>      >> { [6880 bytes data]
>      >> * schannel: failed to decrypt data, need more data
>      >> { [20378 bytes data]
>      >> * schannel: failed to decrypt data, need more data
>      >> { [6880 bytes data]
>      >> * schannel: failed to decrypt data, need more data
>      >> { [5504 bytes data]
>      >> * schannel: failed to decrypt data, need more data
>      >> { [5504 bytes data]
>      >> * schannel: failed to decrypt data, need more data
>      >> { [3839 bytes data]
>      >> * schannel: failed to decrypt data, need more data
>      >> { [6880 bytes data]
>      >> * schannel: failed to decrypt data, need more data
>      >> { [9632 bytes data]
>      >> * schannel: failed to decrypt data, need more data
>      >> { [6880 bytes data]
>      >> * schannel: failed to decrypt data, need more data
>      >> { [2752 bytes data]
>      >> * schannel: failed to decrypt data, need more data
>      >> { [7994 bytes data]
>      >> 100? 193k? ? 0? 193k? ? 0? ? ?0? ?293k? ? ? 0 --:--:-- --:--:--
>     --:--:--
>      >>? ? 294k* schannel: failed to decrypt data, need more data
>      >> { [28937 bytes data]
>      >> * schannel: failed to decrypt data, need more data
>      >> { [8414 bytes data]
>      >> * schannel: failed to decrypt data, need more data
>      >> { [9632 bytes data]
>      >> * schannel: failed to decrypt data, need more data
>      >> { [5504 bytes data]
>      >> * schannel: failed to decrypt data, need more data
>      >> { [5504 bytes data]
>      >> * schannel: failed to decrypt data, need more data
>      >> { [7852 bytes data]
>      >> * schannel: failed to decrypt data, need more data
>      >> { [5504 bytes data]
>      >> * schannel: failed to decrypt data, need more data
>      >> { [17888 bytes data]
>      >> * schannel: failed to decrypt data, need more data
>      >> { [19016 bytes data]
>      >> * schannel: failed to decrypt data, need more data
>      >> { [15136 bytes data]
>      >> * schannel: failed to decrypt data, need more data
>      >> { [10760 bytes data]
>      >> * schannel: failed to decrypt data, need more data
>      >> { [6880 bytes data]
>      >> * schannel: failed to decrypt data, need more data
>      >> { [34152 bytes data]
>      >> * schannel: failed to decrypt data, need more data
>      >> { [28648 bytes data]
>      >> * schannel: failed to decrypt data, need more data
>      >> { [33026 bytes data]
>      >> * schannel: failed to decrypt data, need more data
>      >> { [14888 bytes data]
>      >> * schannel: failed to decrypt data, need more data
>      >> { [24768 bytes data]
>      >> * schannel: failed to decrypt data, need more data
>      >> { [12136 bytes data]
>      >> 100? 498k? ? 0? 498k? ? 0? ? ?0? ?665k? ? ? 0 --:--:-- --:--:--
>     --:--:--
>      >>? ? 669k
>      >> * Connection #0 to host www.youtube.com <http://www.youtube.com>
>     <http://www.youtube.com <http://www.youtube.com>> left intact
>      >>
>      >> And the access.log:
>      >> 1724083303.298? ? ? 0 192.168.78.15 NONE_NONE/000 0 -
>      >> error:invalid-request - HIER_NONE/- - -
>      >> 1724083303.888? ? 589 192.168.78.15 TCP_TUNNEL/200 529157 CONNECT
>      >> 142.250.185.78:443 <http://142.250.185.78:443>
>     <http://142.250.185.78:443 <http://142.250.185.78:443>> -
>      >> ORIGINAL_DST/142.250.185.78 <http://142.250.185.78>
>     <http://142.250.185.78 <http://142.250.185.78>> - -
>      >> 1724083307.305? ? ? 0 192.168.78.15 NONE_NONE/000 0 -
>      >> error:invalid-request - HIER_NONE/- - -
>      >> 1724083307.908? ? 603 192.168.78.15 TCP_TUNNEL/200 530241 CONNECT
>      >> 142.250.185.78:443 <http://142.250.185.78:443>
>     <http://142.250.185.78:443 <http://142.250.185.78:443>> -
>      >> ORIGINAL_DST/142.250.185.78 <http://142.250.185.78>
>     <http://142.250.185.78 <http://142.250.185.78>> - -
>      >> 1724083311.615? ? ? 0 192.168.78.15 NONE_NONE/000 0 -
>      >> error:invalid-request - HIER_NONE/- - -
>      >> 1724083312.255? ? 640 192.168.78.15 TCP_TUNNEL/200 528465 CONNECT
>      >> 142.250.185.78:443 <http://142.250.185.78:443>
>     <http://142.250.185.78:443 <http://142.250.185.78:443>> -
>      >> ORIGINAL_DST/142.250.185.78 <http://142.250.185.78>
>     <http://142.250.185.78 <http://142.250.185.78>> - -
>      >> 1724083316.666? ? ? 0 192.168.78.15 NONE_NONE/000 0 -
>      >> error:invalid-request - HIER_NONE/- - -
>      >> 1724083317.315? ? 649 192.168.78.15 TCP_TUNNEL/200 529617 CONNECT
>      >> 142.250.185.78:443 <http://142.250.185.78:443>
>     <http://142.250.185.78:443 <http://142.250.185.78:443>> -
>      >> ORIGINAL_DST/142.250.185.78 <http://142.250.185.78>
>     <http://142.250.185.78 <http://142.250.185.78>> - -
>      >> 1724083342.731? ? ? 0 192.168.78.15 NONE_NONE/000 0 -
>      >> error:invalid-request - HIER_NONE/- - -
>      >> 1724083343.377? ? 645 192.168.78.15 TCP_TUNNEL/200 528377 CONNECT
>      >> 142.250.185.78:443 <http://142.250.185.78:443>
>     <http://142.250.185.78:443 <http://142.250.185.78:443>> -
>      >> ORIGINAL_DST/142.250.185.78 <http://142.250.185.78>
>     <http://142.250.185.78 <http://142.250.185.78>> - -
>      >> 1724083378.565? ? ? 0 192.168.78.15 NONE_NONE/000 0 -
>      >> error:invalid-request - HIER_NONE/- - -
>      >> 1724083378.801? ? ? 0 192.168.78.15 NONE_NONE/000 0 -
>      >> error:invalid-request - HIER_NONE/- - -
>      >>
>      >>
>      >> ----
>      >> Eliezer Croitoru
>      >> Tech Support
>      >> Mobile: +972-5-28704261
>      >> Email: ngtech1ltd at gmail.com <mailto:ngtech1ltd at gmail.com>
>     <mailto:ngtech1ltd at gmail.com <mailto:ngtech1ltd at gmail.com>>
>      >>
>      >>
>      >> On Mon, Aug 19, 2024 at 3:21?PM Alex Rousskov
>      >> <rousskov at measurement-factory.com
>     <mailto:rousskov at measurement-factory.com>
>      >> <mailto:rousskov at measurement-factory.com
>     <mailto:rousskov at measurement-factory.com>>> wrote:
>      >>
>      >>? ? ? On 2024-08-19 03:47, NgTech LTD wrote:
>      >>? ? ? ?> I am testing Squid 6.10 on Fedora 40 (their package).
>      >>? ? ? ?> And it seems that Squid is unable to bump clients
>     (ESNI/ECH)?
>      >>? ? ? ?>
>      >>? ? ? ?> I had couple iterations of pek stare and bump and I am
>     not sure
>      >>? ? ? what is
>      >>? ? ? ?> the reason for that:
>      >>
>      >>? ? ? What do you use as a client? Judging by the number of
>      >>? ? ? error:invalid-request entries in your access.log, that
>     client may
>      >>? ? ? not be
>      >>? ? ? speaking HTTP/1 inside those CONNECT tunnels.
>      >>
>      >>? ? ? Does everything work for non-intercept ports?
>      >>
>      >>? ? ? Does everything work in a basic curl or wget test?
>      >>
>      >>? ? ? Does everything work when you remove "ssl-bump" and related
>     options
>      >>? ? ? from
>      >>? ? ? intercepting http_port 33128?
>      >>
>      >>? ? ? Does everything work when you use "ssl_bump splice all"
>     instead of your
>      >>? ? ? current ssl_bump rule?
>      >>
>      >>? ? ? Does everything work when you use "ssl_bump peek all"
>     instead of your
>      >>? ? ? current ssl_bump rule?
>      >>
>      >>? ? ? Alex.
>      >>
>      >>
>      >>? ? ? ?> shutdown_lifetime 3 seconds
>      >>? ? ? ?> external_acl_type whitelist-lookup-helper ipv4 ttl=10
>      >>? ? ? children-max=10
>      >>? ? ? ?> children-startup=2 \
>      >>? ? ? ?>? ? ? ? ? children-idle=2 concurrency=10 %URI %SRC
>      >>? ? ? ?> /usr/local/bin/squid-conf-url-lookup.rb
>      >>? ? ? ?> acl whitelist-lookup external? whitelist-lookup-helper
>      >>? ? ? ?> acl ytmethods method POST GET
>      >>? ? ? ?> acl localnet src 0.0.0.1-0.255.255.255? # RFC 1122
>     "this" network
>      >>? ? ? (LAN)
>      >>? ? ? ?> acl localnet src 10.0.0.0/8 <http://10.0.0.0/8>
>     <http://10.0.0.0/8 <http://10.0.0.0/8>>
>      >>? ? ? <http://10.0.0.0/8 <http://10.0.0.0/8> <http://10.0.0.0/8
>     <http://10.0.0.0/8>>>? ? ? ? ? ? ?# RFC 1918
>      >>? ? ? ?> local private network (LAN)
>      >>? ? ? ?> acl localnet src 100.64.0.0/10 <http://100.64.0.0/10>
>     <http://100.64.0.0/10 <http://100.64.0.0/10>>
>      >>? ? ? <http://100.64.0.0/10 <http://100.64.0.0/10>
>     <http://100.64.0.0/10 <http://100.64.0.0/10>>>? ? ? ? ? # RFC
>      >>? ? ? ?> 6598 shared address space (CGN)
>      >>? ? ? ?> acl localnet src 169.254.0.0/16 <http://169.254.0.0/16>
>     <http://169.254.0.0/16 <http://169.254.0.0/16>>
>      >>? ? ? <http://169.254.0.0/16 <http://169.254.0.0/16>
>     <http://169.254.0.0/16 <http://169.254.0.0/16>>>? ? ? ? ?# RFC
>      >>? ? ? ?> 3927 link-local (directly plugged) machines
>      >>? ? ? ?> acl localnet src 172.16.0.0/12 <http://172.16.0.0/12>
>     <http://172.16.0.0/12 <http://172.16.0.0/12>>
>      >>? ? ? <http://172.16.0.0/12 <http://172.16.0.0/12>
>     <http://172.16.0.0/12 <http://172.16.0.0/12>>>? ? ? ? ? # RFC
>      >>? ? ? ?> 1918 local private network (LAN)
>      >>? ? ? ?> acl localnet src 192.168.0.0/16 <http://192.168.0.0/16>
>     <http://192.168.0.0/16 <http://192.168.0.0/16>>
>      >>? ? ? <http://192.168.0.0/16 <http://192.168.0.0/16>
>     <http://192.168.0.0/16 <http://192.168.0.0/16>>>? ? ? ? ?# RFC
>      >>? ? ? ?> 1918 local private network (LAN)
>      >>? ? ? ?> acl localnet src fc00::/7? ? ? ? ? ? ? ?# RFC 4193 local
>     private
>      >>? ? ? network
>      >>? ? ? ?> range
>      >>? ? ? ?> acl localnet src fe80::/10? ? ? ? ? ? ? # RFC 4291
>     link-local
>      >>? ? ? (directly
>      >>? ? ? ?> plugged) machines
>      >>? ? ? ?> acl SSL_ports port 443
>      >>? ? ? ?> acl Safe_ports port 80? ? ? ? ? # http
>      >>? ? ? ?> acl Safe_ports port 21? ? ? ? ? # ftp
>      >>? ? ? ?> acl Safe_ports port 443? ? ? ? ?# https
>      >>? ? ? ?> acl Safe_ports port 70? ? ? ? ? # gopher
>      >>? ? ? ?> acl Safe_ports port 210? ? ? ? ?# wais
>      >>? ? ? ?> acl Safe_ports port 1025-65535? # unregistered ports
>      >>? ? ? ?> acl Safe_ports port 280? ? ? ? ?# http-mgmt
>      >>? ? ? ?> acl Safe_ports port 488? ? ? ? ?# gss-http
>      >>? ? ? ?> acl Safe_ports port 591? ? ? ? ?# filemaker
>      >>? ? ? ?> acl Safe_ports port 777? ? ? ? ?# multiling http
>      >>? ? ? ?> http_access deny !Safe_ports
>      >>? ? ? ?> http_access deny CONNECT !SSL_ports
>      >>? ? ? ?> http_access allow localhost manager
>      >>? ? ? ?> http_access deny manager
>      >>? ? ? ?> http_access allow localhost
>      >>? ? ? ?> http_access deny to_localhost
>      >>? ? ? ?> http_access deny to_linklocal
>      >>? ? ? ?> acl tubedoms dstdomain .ytimg.com <http://ytimg.com>
>     <http://ytimg.com <http://ytimg.com>>
>      >>? ? ? <http://ytimg.com <http://ytimg.com> <http://ytimg.com
>     <http://ytimg.com>>> .youtube.com <http://youtube.com>
>     <http://youtube.com <http://youtube.com>>
>      >>? ? ? ?> <http://youtube.com <http://youtube.com>
>     <http://youtube.com <http://youtube.com>>> .youtu.be <http://youtu.be>
>      >>? ? ? <http://youtu.be <http://youtu.be>> <http://youtu.be
>     <http://youtu.be> <http://youtu.be <http://youtu.be>>>
>      >>? ? ? ?> http_access allow ytmethods localnet tubedoms
>     whitelist-lookup
>      >>? ? ? ?> http_access allow localnet
>      >>? ? ? ?> http_access deny all
>      >>? ? ? ?> http_port 3128
>      >>? ? ? ?> http_port 13128 ssl-bump tls-cert=/etc/squid/ssl/cert.pem
>      >>? ? ? ?> tls-key=/etc/squid/ssl/key.pem \
>      >>? ? ? ?>? ? ? ? ? generate-host-certificates=on
>      >>? ? ? dynamic_cert_mem_cache_size=4MB
>      >>? ? ? ?> http_port 23128 tproxy ssl-bump
>     tls-cert=/etc/squid/ssl/cert.pem
>      >>? ? ? ?> tls-key=/etc/squid/ssl/key.pem \
>      >>? ? ? ?>? ? ? ? ? generate-host-certificates=on
>      >>? ? ? dynamic_cert_mem_cache_size=4MB
>      >>? ? ? ?> http_port 33128 intercept ssl-bump
>     tls-cert=/etc/squid/ssl/cert.pem
>      >>? ? ? ?> tls-key=/etc/squid/ssl/key.pem \
>      >>? ? ? ?>? ? ? ? ? generate-host-certificates=on
>      >>? ? ? dynamic_cert_mem_cache_size=4MB
>      >>? ? ? ?> sslcrtd_program /usr/lib64/squid/security_file_certgen -s
>      >>? ? ? ?> /var/spool/squid/ssl_db -M 4MB
>      >>? ? ? ?> sslcrtd_children 5
>      >>? ? ? ?> acl foreignProtocol squid_error ERR_PROTOCOL_UNKNOWN
>     ERR_TOO_BIG
>      >>? ? ? ?> acl serverTalksFirstProtocol squid_error
>     ERR_REQUEST_START_TIMEOUT
>      >>? ? ? ?> on_unsupported_protocol tunnel foreignProtocol
>      >>? ? ? ?> on_unsupported_protocol tunnel serverTalksFirstProtocol
>      >>? ? ? ?> on_unsupported_protocol respond all
>      >>? ? ? ?> acl monitoredSites ssl::server_name .youtube.com
>     <http://youtube.com>
>      >>? ? ? <http://youtube.com <http://youtube.com>>
>     <http://youtube.com <http://youtube.com> <http://youtube.com
>     <http://youtube.com>>>
>      >>? ? ? ?> .ytimg.com <http://ytimg.com> <http://ytimg.com
>     <http://ytimg.com>> <http://ytimg.com <http://ytimg.com>
>     <http://ytimg.com <http://ytimg.com>>>
>      >>? ? ? ?> acl monitoredSitesRegex ssl::server_name_regex
>     \.youtube\.com
>      >>? ? ? \.ytimg\.com
>      >>? ? ? ?> acl serverIsBank ssl::server_name .visa.com
>     <http://visa.com> <http://visa.com <http://visa.com>>
>      >>? ? ? <http://visa.com <http://visa.com> <http://visa.com
>     <http://visa.com>>>
>      >>? ? ? ?> acl step1 at_step SslBump1
>      >>? ? ? ?> acl step2 at_step SslBump2
>      >>? ? ? ?> acl step3 at_step SslBump3
>      >>? ? ? ?> ssl_bump bump all
>      >>? ? ? ?> strip_query_terms off
>      >>? ? ? ?> coredump_dir /var/spool/squid
>      >>? ? ? ?> refresh_pattern ^ftp:? ? ? ? ? ?1440? ? 20%? ? ?10080
>      >>? ? ? ?> refresh_pattern -i (/cgi-bin/|\?) 0? ? ?0%? ? ? 0
>      >>? ? ? ?> refresh_pattern .? ? ? ? ? ? ? ?0? ? ? ?20%? ? ?4320
>      >>? ? ? ?> logformat ssl_custom_format %ts.%03tu %6tr %>a
>     %Ss/%03>Hs %<st
>      >>? ? ? %rm %ru
>      >>? ? ? ?> %[un %Sh/%<a %mt %ssl::>sni
>      >>? ? ? ?> access_log daemon:/var/log/squid/access.log
>     ssl_custom_format
>      >>? ? ? ?> ##EOF
>      >>? ? ? ?>
>      >>? ? ? ?> access.log from before:
>      >>? ? ? ?> 1724028804.797? ? 486 192.168.78.15 TCP_TUNNEL/200 17764
>     CONNECT
>      >>? ? ? ?> 40.126.31.73:443 <http://40.126.31.73:443>
>     <http://40.126.31.73:443 <http://40.126.31.73:443>>
>      >>? ? ? <http://40.126.31.73:443 <http://40.126.31.73:443>
>     <http://40.126.31.73:443 <http://40.126.31.73:443>>> -
>      >>? ? ? ORIGINAL_DST/40.126.31.73 <http://40.126.31.73>
>     <http://40.126.31.73 <http://40.126.31.73>>
>      >>? ? ? ?> <http://40.126.31.73 <http://40.126.31.73>
>     <http://40.126.31.73 <http://40.126.31.73>>> - -
>      >>? ? ? ?> 1724028805.413? ? ? 0 192.168.78.15 NONE_NONE/000 0 -
>      >>? ? ? ?> error:invalid-request - HIER_NONE/- - -
>      >>? ? ? ?> 1724028806.028? ? ? 0 192.168.78.15 NONE_NONE/000 0 -
>      >>? ? ? ?> error:invalid-request - HIER_NONE/- - -
>      >>? ? ? ?> 1724028806.028? ? ? 0 192.168.78.15 NONE_NONE/000 0 -
>      >>? ? ? ?> error:invalid-request - HIER_NONE/- - -
>      >>? ? ? ?> 1724028806.029? ? ? 0 192.168.78.15 NONE_NONE/000 0 -
>      >>? ? ? ?> error:invalid-request - HIER_NONE/- - -
>      >>? ? ? ?> 1724028806.030? ? ? 0 192.168.78.15 NONE_NONE/000 0 -
>      >>? ? ? ?> error:invalid-request - HIER_NONE/- - -
>      >>? ? ? ?> 1724028806.085? ? ?57 192.168.78.15 TCP_TUNNEL/200 4513
>     CONNECT
>      >>? ? ? ?> 104.18.72.113:443 <http://104.18.72.113:443>
>     <http://104.18.72.113:443 <http://104.18.72.113:443>>
>      >>? ? ? <http://104.18.72.113:443 <http://104.18.72.113:443>
>     <http://104.18.72.113:443 <http://104.18.72.113:443>>> -
>      >>? ? ? ?> ORIGINAL_DST/104.18.72.113 <http://104.18.72.113>
>     <http://104.18.72.113 <http://104.18.72.113>>
>      >>? ? ? <http://104.18.72.113 <http://104.18.72.113>
>     <http://104.18.72.113 <http://104.18.72.113>>> - -
>      >>? ? ? ?> 1724028806.086? ? ?56 192.168.78.15 TCP_TUNNEL/200 4513
>     CONNECT
>      >>? ? ? ?> 104.18.72.113:443 <http://104.18.72.113:443>
>     <http://104.18.72.113:443 <http://104.18.72.113:443>>
>      >>? ? ? <http://104.18.72.113:443 <http://104.18.72.113:443>
>     <http://104.18.72.113:443 <http://104.18.72.113:443>>> -
>      >>? ? ? ?> ORIGINAL_DST/104.18.72.113 <http://104.18.72.113>
>     <http://104.18.72.113 <http://104.18.72.113>>
>      >>? ? ? <http://104.18.72.113 <http://104.18.72.113>
>     <http://104.18.72.113 <http://104.18.72.113>>> - -
>      >>? ? ? ?> 1724028806.086? ? ?56 192.168.78.15 TCP_TUNNEL/200 4512
>     CONNECT
>      >>? ? ? ?> 104.18.72.113:443 <http://104.18.72.113:443>
>     <http://104.18.72.113:443 <http://104.18.72.113:443>>
>      >>? ? ? <http://104.18.72.113:443 <http://104.18.72.113:443>
>     <http://104.18.72.113:443 <http://104.18.72.113:443>>> -
>      >>? ? ? ?> ORIGINAL_DST/104.18.72.113 <http://104.18.72.113>
>     <http://104.18.72.113 <http://104.18.72.113>>
>      >>? ? ? <http://104.18.72.113 <http://104.18.72.113>
>     <http://104.18.72.113 <http://104.18.72.113>>> - -
>      >>? ? ? ?> 1724028806.208? ? ? 0 192.168.78.15 NONE_NONE/000 0 -
>      >>? ? ? ?> error:invalid-request - HIER_NONE/- - -
>      >>? ? ? ?> 1724028806.213? ? ? 0 192.168.78.15 NONE_NONE/000 0 -
>      >>? ? ? ?> error:invalid-request - HIER_NONE/- - -
>      >>? ? ? ?> 1724028806.338? ? ? 0 192.168.78.15 NONE_NONE/000 0 -
>      >>? ? ? ?> error:invalid-request - HIER_NONE/- - -
>      >>? ? ? ?> 1724028806.469? ? ? 0 192.168.78.15 NONE_NONE/000 0 -
>      >>? ? ? ?> error:invalid-request - HIER_NONE/- - -
>      >>? ? ? ?> 1724028806.596? ? ? 0 192.168.78.15 NONE_NONE/000 0 -
>      >>? ? ? ?> error:invalid-request - HIER_NONE/- - -
>      >>? ? ? ?> 1724028807.006? ? ? 0 192.168.78.15 NONE_NONE/000 0 -
>      >>? ? ? ?> error:invalid-request - HIER_NONE/- - -
>      >>? ? ? ?> 1724028807.262? ? ? 0 192.168.78.15 NONE_NONE/000 0 -
>      >>? ? ? ?> error:invalid-request - HIER_NONE/- - -
>      >>? ? ? ?> 1724028808.922? ?5037 192.168.78.15 TCP_TUNNEL/200 6096
>     CONNECT
>      >>? ? ? ?> 13.107.246.60:443 <http://13.107.246.60:443>
>     <http://13.107.246.60:443 <http://13.107.246.60:443>>
>      >>? ? ? <http://13.107.246.60:443 <http://13.107.246.60:443>
>     <http://13.107.246.60:443 <http://13.107.246.60:443>>> -
>      >>? ? ? ?> ORIGINAL_DST/13.107.246.60 <http://13.107.246.60>
>     <http://13.107.246.60 <http://13.107.246.60>>
>      >>? ? ? <http://13.107.246.60 <http://13.107.246.60>
>     <http://13.107.246.60 <http://13.107.246.60>>> - -
>      >>? ? ? ?> 1724028812.906? ?8336 192.168.78.15 TCP_TUNNEL/200
>     1071500 CONNECT
>      >>? ? ? ?> 104.126.37.171:443 <http://104.126.37.171:443>
>     <http://104.126.37.171:443 <http://104.126.37.171:443>>
>      >>? ? ? <http://104.126.37.171:443 <http://104.126.37.171:443>
>     <http://104.126.37.171:443 <http://104.126.37.171:443>>> -
>      >>? ? ? ?> ORIGINAL_DST/104.126.37.171 <http://104.126.37.171>
>     <http://104.126.37.171 <http://104.126.37.171>>
>      >>? ? ? <http://104.126.37.171 <http://104.126.37.171>
>     <http://104.126.37.171 <http://104.126.37.171>>> - -
>      >>? ? ? ?> 1724028819.209 247893 192.168.78.15 TCP_TUNNEL/200 4023
>     CONNECT
>      >>? ? ? ?> 142.250.186.34:443 <http://142.250.186.34:443>
>     <http://142.250.186.34:443 <http://142.250.186.34:443>>
>      >>? ? ? <http://142.250.186.34:443 <http://142.250.186.34:443>
>     <http://142.250.186.34:443 <http://142.250.186.34:443>>> -
>      >>? ? ? ?> ORIGINAL_DST/142.250.186.34 <http://142.250.186.34>
>     <http://142.250.186.34 <http://142.250.186.34>>
>      >>? ? ? <http://142.250.186.34 <http://142.250.186.34>
>     <http://142.250.186.34 <http://142.250.186.34>>> - -
>      >>? ? ? ?> 1724028820.097 250033 192.168.78.15 TCP_TUNNEL/200
>     549611 CONNECT
>      >>? ? ? ?> 142.250.184.246:443 <http://142.250.184.246:443>
>     <http://142.250.184.246:443 <http://142.250.184.246:443>>
>      >>? ? ? <http://142.250.184.246:443 <http://142.250.184.246:443>
>     <http://142.250.184.246:443 <http://142.250.184.246:443>>> -
>      >>? ? ? ?> ORIGINAL_DST/142.250.184.246 <http://142.250.184.246>
>     <http://142.250.184.246 <http://142.250.184.246>>
>      >>? ? ? <http://142.250.184.246 <http://142.250.184.246>
>     <http://142.250.184.246 <http://142.250.184.246>>> - -
>      >>? ? ? ?> 1724028820.154 246850 192.168.78.15 TCP_TUNNEL/200 15119
>     CONNECT
>      >>? ? ? ?> 216.58.206.65:443 <http://216.58.206.65:443>
>     <http://216.58.206.65:443 <http://216.58.206.65:443>>
>      >>? ? ? <http://216.58.206.65:443 <http://216.58.206.65:443>
>     <http://216.58.206.65:443 <http://216.58.206.65:443>>> -
>      >>? ? ? ?> ORIGINAL_DST/216.58.206.65 <http://216.58.206.65>
>     <http://216.58.206.65 <http://216.58.206.65>>
>      >>? ? ? <http://216.58.206.65 <http://216.58.206.65>
>     <http://216.58.206.65 <http://216.58.206.65>>> - -
>      >>? ? ? ?> 1724028820.164 246856 192.168.78.15 TCP_TUNNEL/200 3037
>     CONNECT
>      >>? ? ? ?> 142.250.181.227:443 <http://142.250.181.227:443>
>     <http://142.250.181.227:443 <http://142.250.181.227:443>>
>      >>? ? ? <http://142.250.181.227:443 <http://142.250.181.227:443>
>     <http://142.250.181.227:443 <http://142.250.181.227:443>>> -
>      >>? ? ? ?> ORIGINAL_DST/142.250.181.227 <http://142.250.181.227>
>     <http://142.250.181.227 <http://142.250.181.227>>
>      >>? ? ? <http://142.250.181.227 <http://142.250.181.227>
>     <http://142.250.181.227 <http://142.250.181.227>>> - -
>      >>? ? ? ?> 1724028820.203 246893 192.168.78.15 TCP_TUNNEL/200 3031
>     CONNECT
>      >>? ? ? ?> 172.217.16.196:443 <http://172.217.16.196:443>
>     <http://172.217.16.196:443 <http://172.217.16.196:443>>
>      >>? ? ? <http://172.217.16.196:443 <http://172.217.16.196:443>
>     <http://172.217.16.196:443 <http://172.217.16.196:443>>> -
>      >>? ? ? ?> ORIGINAL_DST/172.217.16.196 <http://172.217.16.196>
>     <http://172.217.16.196 <http://172.217.16.196>>
>      >>? ? ? <http://172.217.16.196 <http://172.217.16.196>
>     <http://172.217.16.196 <http://172.217.16.196>>> - -
>      >>? ? ? ?> 1724028822.656 271833 192.168.78.15 TCP_TUNNEL/200
>     387583 CONNECT
>      >>? ? ? ?> 142.250.185.238:443 <http://142.250.185.238:443>
>     <http://142.250.185.238:443 <http://142.250.185.238:443>>
>      >>? ? ? <http://142.250.185.238:443 <http://142.250.185.238:443>
>     <http://142.250.185.238:443 <http://142.250.185.238:443>>> -
>      >>? ? ? ?> ORIGINAL_DST/142.250.185.238 <http://142.250.185.238>
>     <http://142.250.185.238 <http://142.250.185.238>>
>      >>? ? ? <http://142.250.185.238 <http://142.250.185.238>
>     <http://142.250.185.238 <http://142.250.185.238>>> - -
>      >>? ? ? ?> 1724028830.336? ? ? 0 192.168.78.15 NONE_NONE/000 0 -
>      >>? ? ? ?> error:invalid-request - HIER_NONE/- - -
>      >>? ? ? ?> 1724028830.781? ? 444 192.168.78.15 TCP_TUNNEL/200 18505
>     CONNECT
>      >>? ? ? ?> 40.126.31.73:443 <http://40.126.31.73:443>
>     <http://40.126.31.73:443 <http://40.126.31.73:443>>
>      >>? ? ? <http://40.126.31.73:443 <http://40.126.31.73:443>
>     <http://40.126.31.73:443 <http://40.126.31.73:443>>> -
>      >>? ? ? ORIGINAL_DST/40.126.31.73 <http://40.126.31.73>
>     <http://40.126.31.73 <http://40.126.31.73>>
>      >>? ? ? ?> <http://40.126.31.73 <http://40.126.31.73>
>     <http://40.126.31.73 <http://40.126.31.73>>> - -
>      >>? ? ? ?> 1724028841.781 155018 192.168.78.15 TCP_TUNNEL/200 15960
>     CONNECT
>      >>? ? ? ?> 13.107.6.158:443 <http://13.107.6.158:443>
>     <http://13.107.6.158:443 <http://13.107.6.158:443>>
>      >>? ? ? <http://13.107.6.158:443 <http://13.107.6.158:443>
>     <http://13.107.6.158:443 <http://13.107.6.158:443>>> -
>      >>? ? ? ORIGINAL_DST/13.107.6.158 <http://13.107.6.158>
>     <http://13.107.6.158 <http://13.107.6.158>>
>      >>? ? ? ?> <http://13.107.6.158 <http://13.107.6.158>
>     <http://13.107.6.158 <http://13.107.6.158>>> - -
>      >>? ? ? ?> 1724028849.443? ? ? 0 192.168.78.15 NONE_NONE/000 0 -
>      >>? ? ? ?> error:invalid-request - HIER_NONE/- - -
>      >>? ? ? ?> 1724028849.698? ? ? 0 192.168.78.15 NONE_NONE/000 0 -
>      >>? ? ? ?> error:invalid-request - HIER_NONE/- - -
>      >>? ? ? ?> 1724028865.261? ? ? 0 192.168.78.15 NONE_NONE/000 0 -
>      >>? ? ? ?> error:invalid-request - HIER_NONE/- - -
>      >>? ? ? ?> 1724028865.779? ? 517 192.168.78.15 TCP_TUNNEL/200 18557
>     CONNECT
>      >>? ? ? ?> 40.126.31.73:443 <http://40.126.31.73:443>
>     <http://40.126.31.73:443 <http://40.126.31.73:443>>
>      >>? ? ? <http://40.126.31.73:443 <http://40.126.31.73:443>
>     <http://40.126.31.73:443 <http://40.126.31.73:443>>> -
>      >>? ? ? ORIGINAL_DST/40.126.31.73 <http://40.126.31.73>
>     <http://40.126.31.73 <http://40.126.31.73>>
>      >>? ? ? ?> <http://40.126.31.73 <http://40.126.31.73>
>     <http://40.126.31.73 <http://40.126.31.73>>> - -
>      >>? ? ? ?> 1724028870.718 109994 192.168.78.15 TCP_TUNNEL/200 6972
>     CONNECT
>      >>? ? ? ?> 20.42.65.94:443 <http://20.42.65.94:443>
>     <http://20.42.65.94:443 <http://20.42.65.94:443>>
>     <http://20.42.65.94:443 <http://20.42.65.94:443>
>      >>? ? ? <http://20.42.65.94:443 <http://20.42.65.94:443>>> -
>     ORIGINAL_DST/20.42.65.94 <http://20.42.65.94>
>      >>? ? ? <http://20.42.65.94 <http://20.42.65.94>>
>      >>? ? ? ?> <http://20.42.65.94 <http://20.42.65.94>
>     <http://20.42.65.94 <http://20.42.65.94>>> - -
>      >>? ? ? ?> 1724028871.179? 64583 192.168.78.15 TCP_TUNNEL/200 1903
>     CONNECT
>      >>? ? ? ?> 104.18.10.207:443 <http://104.18.10.207:443>
>     <http://104.18.10.207:443 <http://104.18.10.207:443>>
>      >>? ? ? <http://104.18.10.207:443 <http://104.18.10.207:443>
>     <http://104.18.10.207:443 <http://104.18.10.207:443>>> -
>      >>? ? ? ?> ORIGINAL_DST/104.18.10.207 <http://104.18.10.207>
>     <http://104.18.10.207 <http://104.18.10.207>>
>      >>? ? ? <http://104.18.10.207 <http://104.18.10.207>
>     <http://104.18.10.207 <http://104.18.10.207>>> - -
>      >>? ? ? ?> 1724028871.179? 63917 192.168.78.15 TCP_TUNNEL/200 2430
>     CONNECT
>      >>? ? ? ?> 142.250.186.99:443 <http://142.250.186.99:443>
>     <http://142.250.186.99:443 <http://142.250.186.99:443>>
>      >>? ? ? <http://142.250.186.99:443 <http://142.250.186.99:443>
>     <http://142.250.186.99:443 <http://142.250.186.99:443>>> -
>      >>? ? ? ?> ORIGINAL_DST/142.250.186.99 <http://142.250.186.99>
>     <http://142.250.186.99 <http://142.250.186.99>>
>      >>? ? ? <http://142.250.186.99 <http://142.250.186.99>
>     <http://142.250.186.99 <http://142.250.186.99>>> - -
>      >>? ? ? ?> 1724028871.179? 64709 192.168.78.15 TCP_TUNNEL/200 2439
>     CONNECT
>      >>? ? ? ?> 142.250.185.170:443 <http://142.250.185.170:443>
>     <http://142.250.185.170:443 <http://142.250.185.170:443>>
>      >>? ? ? <http://142.250.185.170:443 <http://142.250.185.170:443>
>     <http://142.250.185.170:443 <http://142.250.185.170:443>>> -
>      >>? ? ? ?> ORIGINAL_DST/142.250.185.170 <http://142.250.185.170>
>     <http://142.250.185.170 <http://142.250.185.170>>
>      >>? ? ? <http://142.250.185.170 <http://142.250.185.170>
>     <http://142.250.185.170 <http://142.250.185.170>>> - -
>      >>? ? ? ?> 1724028871.308? ? ? 0 192.168.78.15 NONE_NONE/000 0 -
>      >>? ? ? ?> error:invalid-request - HIER_NONE/- - -
>      >>? ? ? ?> 1724028871.731? ? 422 192.168.78.15 TCP_TUNNEL/200 17789
>     CONNECT
>      >>? ? ? ?> 40.126.31.73:443 <http://40.126.31.73:443>
>     <http://40.126.31.73:443 <http://40.126.31.73:443>>
>      >>? ? ? <http://40.126.31.73:443 <http://40.126.31.73:443>
>     <http://40.126.31.73:443 <http://40.126.31.73:443>>> -
>      >>? ? ? ORIGINAL_DST/40.126.31.73 <http://40.126.31.73>
>     <http://40.126.31.73 <http://40.126.31.73>>
>      >>? ? ? ?> <http://40.126.31.73 <http://40.126.31.73>
>     <http://40.126.31.73 <http://40.126.31.73>>> - -
>      >>? ? ? ?> 1724028872.486? ? ? 0 192.168.78.15 NONE_NONE/000 0 -
>      >>? ? ? ?> error:invalid-request - HIER_NONE/- - -
>      >>? ? ? ?> 1724028873.477? ? ? 0 192.168.78.15 NONE_NONE/000 0 -
>      >>? ? ? ?> error:invalid-request - HIER_NONE/- - -
>      >>? ? ? ?> 1724028873.745? ? ? 0 192.168.78.15 NONE_NONE/000 0 -
>      >>? ? ? ?> error:invalid-request - HIER_NONE/- - -
>      >>? ? ? ?> 1724028873.902? ? 424 192.168.78.15 TCP_TUNNEL/200 18520
>     CONNECT
>      >>? ? ? ?> 40.126.31.73:443 <http://40.126.31.73:443>
>     <http://40.126.31.73:443 <http://40.126.31.73:443>>
>      >>? ? ? <http://40.126.31.73:443 <http://40.126.31.73:443>
>     <http://40.126.31.73:443 <http://40.126.31.73:443>>> -
>      >>? ? ? ORIGINAL_DST/40.126.31.73 <http://40.126.31.73>
>     <http://40.126.31.73 <http://40.126.31.73>>
>      >>? ? ? ?> <http://40.126.31.73 <http://40.126.31.73>
>     <http://40.126.31.73 <http://40.126.31.73>>> - -
>      >>? ? ? ?> 1724028877.056? ? ? 0 192.168.78.15 NONE_NONE/000 0 -
>      >>? ? ? ?> error:invalid-request - HIER_NONE/- - -
>      >>? ? ? ?> 1724028877.060? ? ? 0 192.168.78.15 NONE_NONE/000 0 -
>      >>? ? ? ?> error:invalid-request - HIER_NONE/- - -
>      >>? ? ? ?> 1724028877.060? ? ? 0 192.168.78.15 NONE_NONE/000 0 -
>      >>? ? ? ?> error:invalid-request - HIER_NONE/- - -
>      >>? ? ? ?> 1724028877.060? ? ? 0 192.168.78.15 NONE_NONE/000 0 -
>      >>? ? ? ?> error:invalid-request - HIER_NONE/- - -
>      >>? ? ? ?> 1724028877.430 312389 192.168.78.15 TCP_TUNNEL/200 7884
>     CONNECT
>      >>? ? ? ?> 142.250.186.78:443 <http://142.250.186.78:443>
>     <http://142.250.186.78:443 <http://142.250.186.78:443>>
>      >>? ? ? <http://142.250.186.78:443 <http://142.250.186.78:443>
>     <http://142.250.186.78:443 <http://142.250.186.78:443>>> -
>      >>? ? ? ?> ORIGINAL_DST/142.250.186.78 <http://142.250.186.78>
>     <http://142.250.186.78 <http://142.250.186.78>>
>      >>? ? ? <http://142.250.186.78 <http://142.250.186.78>
>     <http://142.250.186.78 <http://142.250.186.78>>> - -
>      >>? ? ? ?> 1724028878.800? ? ? 0 192.168.78.15 NONE_NONE/000 0 -
>      >>? ? ? ?> error:invalid-request - HIER_NONE/- - -
>      >>? ? ? ?> 1724028878.920? ? ? 0 192.168.78.15 NONE_NONE/000 0 -
>      >>? ? ? ?> error:invalid-request - HIER_NONE/- - -
>      >>? ? ? ?> 1724028879.072? ? ? 0 192.168.78.15 NONE_NONE/000 0 -
>      >>? ? ? ?> error:invalid-request - HIER_NONE/- - -
>      >>? ? ? ?> 1724028880.808? ?7062 192.168.78.15 TCP_TUNNEL/200
>     836391 CONNECT
>      >>? ? ? ?> 104.126.37.145:443 <http://104.126.37.145:443>
>     <http://104.126.37.145:443 <http://104.126.37.145:443>>
>      >>? ? ? <http://104.126.37.145:443 <http://104.126.37.145:443>
>     <http://104.126.37.145:443 <http://104.126.37.145:443>>> -
>      >>? ? ? ?> ORIGINAL_DST/104.126.37.145 <http://104.126.37.145>
>     <http://104.126.37.145 <http://104.126.37.145>>
>      >>? ? ? <http://104.126.37.145 <http://104.126.37.145>
>     <http://104.126.37.145 <http://104.126.37.145>>> - -
>      >>? ? ? ?> 1724028882.468? 33024 192.168.78.15 TCP_TUNNEL/200
>     1488697 CONNECT
>      >>? ? ? ?> 49.12.59.2:443 <http://49.12.59.2:443>
>     <http://49.12.59.2:443 <http://49.12.59.2:443>>
>     <http://49.12.59.2:443 <http://49.12.59.2:443>
>      >>? ? ? <http://49.12.59.2:443 <http://49.12.59.2:443>>> -
>     ORIGINAL_DST/49.12.59.2 <http://49.12.59.2> <http://49.12.59.2
>     <http://49.12.59.2>>
>      >>? ? ? ?> <http://49.12.59.2 <http://49.12.59.2>
>     <http://49.12.59.2 <http://49.12.59.2>>> - -
>      >>? ? ? ?> 1724028883.728? ?6671 192.168.78.15 TCP_TUNNEL/200 69351
>     CONNECT
>      >>? ? ? ?> 52.216.185.251:443 <http://52.216.185.251:443>
>     <http://52.216.185.251:443 <http://52.216.185.251:443>>
>      >>? ? ? <http://52.216.185.251:443 <http://52.216.185.251:443>
>     <http://52.216.185.251:443 <http://52.216.185.251:443>>> -
>      >>? ? ? ?> ORIGINAL_DST/52.216.185.251 <http://52.216.185.251>
>     <http://52.216.185.251 <http://52.216.185.251>>
>      >>? ? ? <http://52.216.185.251 <http://52.216.185.251>
>     <http://52.216.185.251 <http://52.216.185.251>>> - -
>      >>? ? ? ?> 1724028883.789? ?6728 192.168.78.15 TCP_TUNNEL/200 69216
>     CONNECT
>      >>? ? ? ?> 52.216.185.251:443 <http://52.216.185.251:443>
>     <http://52.216.185.251:443 <http://52.216.185.251:443>>
>      >>? ? ? <http://52.216.185.251:443 <http://52.216.185.251:443>
>     <http://52.216.185.251:443 <http://52.216.185.251:443>>> -
>      >>? ? ? ?> ORIGINAL_DST/52.216.185.251 <http://52.216.185.251>
>     <http://52.216.185.251 <http://52.216.185.251>>
>      >>? ? ? <http://52.216.185.251 <http://52.216.185.251>
>     <http://52.216.185.251 <http://52.216.185.251>>> - -
>      >>? ? ? ?> 1724028883.797? ?6736 192.168.78.15 TCP_TUNNEL/200
>     104657 CONNECT
>      >>? ? ? ?> 52.216.185.251:443 <http://52.216.185.251:443>
>     <http://52.216.185.251:443 <http://52.216.185.251:443>>
>      >>? ? ? <http://52.216.185.251:443 <http://52.216.185.251:443>
>     <http://52.216.185.251:443 <http://52.216.185.251:443>>> -
>      >>? ? ? ?> ORIGINAL_DST/52.216.185.251 <http://52.216.185.251>
>     <http://52.216.185.251 <http://52.216.185.251>>
>      >>? ? ? <http://52.216.185.251 <http://52.216.185.251>
>     <http://52.216.185.251 <http://52.216.185.251>>> - -
>      >>? ? ? ?> 1724028883.845? ?6784 192.168.78.15 TCP_TUNNEL/200 80277
>     CONNECT
>      >>? ? ? ?> 52.216.185.251:443 <http://52.216.185.251:443>
>     <http://52.216.185.251:443 <http://52.216.185.251:443>>
>      >>? ? ? <http://52.216.185.251:443 <http://52.216.185.251:443>
>     <http://52.216.185.251:443 <http://52.216.185.251:443>>> -
>      >>? ? ? ?> ORIGINAL_DST/52.216.185.251 <http://52.216.185.251>
>     <http://52.216.185.251 <http://52.216.185.251>>
>      >>? ? ? <http://52.216.185.251 <http://52.216.185.251>
>     <http://52.216.185.251 <http://52.216.185.251>>> - -
>      >>? ? ? ?> 1724028884.460 170355 192.168.78.15 TCP_TUNNEL/200 44690
>     CONNECT
>      >>? ? ? ?> 185.199.108.153:443 <http://185.199.108.153:443>
>     <http://185.199.108.153:443 <http://185.199.108.153:443>>
>      >>? ? ? <http://185.199.108.153:443 <http://185.199.108.153:443>
>     <http://185.199.108.153:443 <http://185.199.108.153:443>>> -
>      >>? ? ? ?> ORIGINAL_DST/185.199.108.153 <http://185.199.108.153>
>     <http://185.199.108.153 <http://185.199.108.153>>
>      >>? ? ? <http://185.199.108.153 <http://185.199.108.153>
>     <http://185.199.108.153 <http://185.199.108.153>>> - -
>      >>? ? ? ?> 1724028889.845 120370 192.168.78.15 TCP_TUNNEL/200 5868
>     CONNECT
>      >>? ? ? ?> 104.126.37.161:443 <http://104.126.37.161:443>
>     <http://104.126.37.161:443 <http://104.126.37.161:443>>
>      >>? ? ? <http://104.126.37.161:443 <http://104.126.37.161:443>
>     <http://104.126.37.161:443 <http://104.126.37.161:443>>> -
>      >>? ? ? ?> ORIGINAL_DST/104.126.37.161 <http://104.126.37.161>
>     <http://104.126.37.161 <http://104.126.37.161>>
>      >>? ? ? <http://104.126.37.161 <http://104.126.37.161>
>     <http://104.126.37.161 <http://104.126.37.161>>> - -
>      >>? ? ? ?> 1724028890.011 122862 192.168.78.15 TCP_TUNNEL/200
>     136726 CONNECT
>      >>? ? ? ?> 23.37.37.211:443 <http://23.37.37.211:443>
>     <http://23.37.37.211:443 <http://23.37.37.211:443>>
>      >>? ? ? <http://23.37.37.211:443 <http://23.37.37.211:443>
>     <http://23.37.37.211:443 <http://23.37.37.211:443>>> -
>      >>? ? ? ORIGINAL_DST/23.37.37.211 <http://23.37.37.211>
>     <http://23.37.37.211 <http://23.37.37.211>>
>      >>? ? ? ?> <http://23.37.37.211 <http://23.37.37.211>
>     <http://23.37.37.211 <http://23.37.37.211>>> - -
>      >>? ? ? ?> 1724028890.297 120381 192.168.78.15 TCP_TUNNEL/200 9176
>     CONNECT
>      >>? ? ? ?> 2.18.140.238:443 <http://2.18.140.238:443>
>     <http://2.18.140.238:443 <http://2.18.140.238:443>>
>      >>? ? ? <http://2.18.140.238:443 <http://2.18.140.238:443>
>     <http://2.18.140.238:443 <http://2.18.140.238:443>>> -
>      >>? ? ? ORIGINAL_DST/2.18.140.238 <http://2.18.140.238>
>     <http://2.18.140.238 <http://2.18.140.238>>
>      >>? ? ? ?> <http://2.18.140.238 <http://2.18.140.238>
>     <http://2.18.140.238 <http://2.18.140.238>>> - -
>      >>? ? ? ?> 1724028891.212? ? ? 0 192.168.78.15 NONE_NONE/000 0 -
>      >>? ? ? ?> error:invalid-request - HIER_NONE/- - -
>      >>? ? ? ?> 1724028891.365? ? 152 192.168.78.15 TCP_TUNNEL/200 2359
>     CONNECT
>      >>? ? ? ?> 142.250.185.138:443 <http://142.250.185.138:443>
>     <http://142.250.185.138:443 <http://142.250.185.138:443>>
>      >>? ? ? <http://142.250.185.138:443 <http://142.250.185.138:443>
>     <http://142.250.185.138:443 <http://142.250.185.138:443>>> -
>      >>? ? ? ?> ORIGINAL_DST/142.250.185.138 <http://142.250.185.138>
>     <http://142.250.185.138 <http://142.250.185.138>>
>      >>? ? ? <http://142.250.185.138 <http://142.250.185.138>
>     <http://142.250.185.138 <http://142.250.185.138>>> - -
>      >>? ? ? ?> 1724028893.885? 90253 192.168.78.15 TCP_TUNNEL/200 6374
>     CONNECT
>      >>? ? ? ?> 13.107.246.60:443 <http://13.107.246.60:443>
>     <http://13.107.246.60:443 <http://13.107.246.60:443>>
>      >>? ? ? <http://13.107.246.60:443 <http://13.107.246.60:443>
>     <http://13.107.246.60:443 <http://13.107.246.60:443>>> -
>      >>? ? ? ?> ORIGINAL_DST/13.107.246.60 <http://13.107.246.60>
>     <http://13.107.246.60 <http://13.107.246.60>>
>      >>? ? ? <http://13.107.246.60 <http://13.107.246.60>
>     <http://13.107.246.60 <http://13.107.246.60>>> - -
>      >>? ? ? ?> 1724028900.169? ? ? 0 192.168.78.15 NONE_NONE/000 0 -
>      >>? ? ? ?> error:invalid-request - HIER_NONE/- - -
>      >>? ? ? ?> 1724028934.465 900262 192.168.78.15 TCP_TUNNEL/200 5530
>     CONNECT
>      >>? ? ? ?> 52.123.243.197:443 <http://52.123.243.197:443>
>     <http://52.123.243.197:443 <http://52.123.243.197:443>>
>      >>? ? ? <http://52.123.243.197:443 <http://52.123.243.197:443>
>     <http://52.123.243.197:443 <http://52.123.243.197:443>>> -
>      >>? ? ? ?> ORIGINAL_DST/52.123.243.197 <http://52.123.243.197>
>     <http://52.123.243.197 <http://52.123.243.197>>
>      >>? ? ? <http://52.123.243.197 <http://52.123.243.197>
>     <http://52.123.243.197 <http://52.123.243.197>>> - -
>      >>? ? ? ?> 1724028960.494? 60324 192.168.78.15 TCP_TUNNEL/503 0 CONNECT
>      >>? ? ? ?> 172.217.16.206:443 <http://172.217.16.206:443>
>     <http://172.217.16.206:443 <http://172.217.16.206:443>>
>      >>? ? ? <http://172.217.16.206:443 <http://172.217.16.206:443>
>     <http://172.217.16.206:443 <http://172.217.16.206:443>>> -
>      >>? ? ? ?> ORIGINAL_DST/172.217.16.206 <http://172.217.16.206>
>     <http://172.217.16.206 <http://172.217.16.206>>
>      >>? ? ? <http://172.217.16.206 <http://172.217.16.206>
>     <http://172.217.16.206 <http://172.217.16.206>>> - -
>      >>? ? ? ?> 1724028960.494? ? ? 0 192.168.78.15 NONE_NONE/000 0 -
>      >>? ? ? ?> error:transaction-end-before-headers - HIER_NONE/- - -
>      >>? ? ? ?>
>      >>? ? ? ?> Thanks for any help,
>      >>? ? ? ?>
>      >>? ? ? ?>
>      >>? ? ? ?> ----
>      >>? ? ? ?> Eliezer Croitoru
>      >>? ? ? ?> Tech Support
>      >>? ? ? ?> Mobile: +972-5-28704261
>      >>? ? ? ?> Email: ngtech1ltd at gmail.com
>     <mailto:ngtech1ltd at gmail.com> <mailto:ngtech1ltd at gmail.com
>     <mailto:ngtech1ltd at gmail.com>>
>      >>? ? ? <mailto:ngtech1ltd at gmail.com <mailto:ngtech1ltd at gmail.com>
>     <mailto:ngtech1ltd at gmail.com <mailto:ngtech1ltd at gmail.com>>>
>      >
>      >
>      > _______________________________________________
>      > squid-users mailing list
>      > squid-users at lists.squid-cache.org
>     <mailto:squid-users at lists.squid-cache.org>
>      > https://lists.squid-cache.org/listinfo/squid-users
>     <https://lists.squid-cache.org/listinfo/squid-users>
> 
>     _______________________________________________
>     squid-users mailing list
>     squid-users at lists.squid-cache.org
>     <mailto:squid-users at lists.squid-cache.org>
>     https://lists.squid-cache.org/listinfo/squid-users
>     <https://lists.squid-cache.org/listinfo/squid-users>
> 



From david at articatech.com  Wed Aug 21 13:37:45 2024
From: david at articatech.com (David Touzeau)
Date: Wed, 21 Aug 2024 15:37:45 +0200
Subject: [squid-users] squid 6.10 - Debian 12 undefined reference to
 `EVP_MD_type' in ssl-crtd
Message-ID: <ec59941e-522f-4f1c-a8ed-94373581cb26@articatech.com>

Configure:
./configure --prefix=/usr --build=x86_64-linux-gnu --includedir=/include 
--mandir=/share/man --infodir=/share/info --localstatedir=/var 
--libexecdir=/lib/squid3 --disable-maintainer-mode 
--disable-dependency-tracking --datadir=/usr/share/squid3 
--sysconfdir=/etc/squid3 --enable-gnuregex --enable-removal-policy=heap 
--enable-follow-x-forwarded-for --disable-cache-digests 
--enable-http-violations --enable-removal-policies=lru,heap 
--enable-arp-acl --enable-truncate --with-large-files --with-pthreads 
--enable-esi --enable-storeio=aufs,diskd,ufs,rock 
--enable-x-accelerator-vary --with-dl--enable-linux-netfilter 
--with-netfilter-conntrack --enable-wccpv2 --enable-eui --enable-auth 
--enable-auth-basic --enable-snmp --enable-icmp --enable-auth-digest 
--enable-log-daemon-helpers --enable-url-rewrite-helpers 
--enable-auth-ntlm --with-default-user=squid --enable-icap-client 
--disable-cache-digests --enable-poll --enable-epoll 
--enable-async-io=128 --enable-zph-qos --enable-delay-pools 
--enable-http-violations --enable-url-maps --enable-ecap --enable-ssl 
--with-openssl --enable-ssl-crtd --enable-xmalloc-statistics 
--enable-ident-lookups --with-filedescriptors=163840 
--with-aufs-threads=128 --disable-arch-native 
--with-logdir=/var/log/squid --with-pidfile=/var/run/squid/squid.pid 
--with-swapdir=/var/cache/squid


Hi, after the make install got

/bin/bash ../../../../libtool? --tag=CXX?? --mode=link g++ -std=c++17 
-Wall -Wextra -Wimplicit-fallthrough=5 -Wpointer-arith -Wwrite-strings 
-Wcomments -Wshadow -Wmissing-declarations -Woverloaded-virtual -Werror 
-pipe -D_REENTRANT -m64 -I/usr/include/p11-kit-1??? -g -O2? -m64?? -g -o 
security_file_certgen certificate_db.o security_file_certgen.o 
../../../../src/ssl/libsslutil.la ../../../../src/sbuf/libsbuf.la 
../../../../src/debug/libdebug.la ../../../../src/error/liberror.la 
../../../../src/comm/libminimal.la ../../../../src/mem/libminimal.la 
../../../../src/base/libbase.la ../../../../src/time/libtime.la -lssl 
-lcrypto?? -lgnutls?? ../../../../compat/libcompatsquid.la
libtool: link: g++ -std=c++17 -Wall -Wextra -Wimplicit-fallthrough=5 
-Wpointer-arith -Wwrite-strings -Wcomments -Wshadow 
-Wmissing-declarations -Woverloaded-virtual -Werror -pipe -D_REENTRANT 
-m64 -I/usr/include/p11-kit-1 -g -O2 -m64 -g -o security_file_certgen 
certificate_db.o security_file_certgen.o 
../../../../src/ssl/.libs/libsslutil.a 
../../../../src/sbuf/.libs/libsbuf.a 
../../../../src/debug/.libs/libdebug.a 
../../../../src/error/.libs/liberror.a 
../../../../src/comm/.libs/libminimal.a 
../../../../src/mem/.libs/libminimal.a 
../../../../src/base/.libs/libbase.a 
../../../../src/time/.libs/libtime.a -lssl -lcrypto -lgnutls 
../../../../compat/.libs/libcompatsquid.a
/usr/bin/ld: ../../../../src/ssl/.libs/libsslutil.a(crtd_message.o): in 
function `Ssl::CrtdMessage::composeRequest(Ssl::CertificateProperties 
const&)':
/root/squid-6.10/src/ssl/crtd_message.cc:248: undefined reference to 
`EVP_MD_type'

How i can fix it ?

-- 
David Touzeau - Artica Tech France
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20240821/227cb0bb/attachment.htm>

From rousskov at measurement-factory.com  Wed Aug 21 14:02:26 2024
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Wed, 21 Aug 2024 10:02:26 -0400
Subject: [squid-users] squid 6.10 - Debian 12 undefined reference to
 `EVP_MD_type' in ssl-crtd
In-Reply-To: <ec59941e-522f-4f1c-a8ed-94373581cb26@articatech.com>
References: <ec59941e-522f-4f1c-a8ed-94373581cb26@articatech.com>
Message-ID: <d6c3f8fe-1b9e-41c3-8e5a-cd6f5fbeac9d@measurement-factory.com>

On 2024-08-21 09:37, David Touzeau wrote:
> Configure:
> ./configure --prefix=/usr --build=x86_64-linux-gnu --includedir=/include 
> --mandir=/share/man --infodir=/share/info --localstatedir=/var 
> --libexecdir=/lib/squid3 --disable-maintainer-mode 
> --disable-dependency-tracking --datadir=/usr/share/squid3 
> --sysconfdir=/etc/squid3 --enable-gnuregex --enable-removal-policy=heap 
> --enable-follow-x-forwarded-for --disable-cache-digests 
> --enable-http-violations --enable-removal-policies=lru,heap 
> --enable-arp-acl --enable-truncate --with-large-files --with-pthreads 
> --enable-esi --enable-storeio=aufs,diskd,ufs,rock 
> --enable-x-accelerator-vary --with-dl--enable-linux-netfilter 
> --with-netfilter-conntrack --enable-wccpv2 --enable-eui --enable-auth 
> --enable-auth-basic --enable-snmp --enable-icmp --enable-auth-digest 
> --enable-log-daemon-helpers --enable-url-rewrite-helpers 
> --enable-auth-ntlm --with-default-user=squid --enable-icap-client 
> --disable-cache-digests --enable-poll --enable-epoll 
> --enable-async-io=128 --enable-zph-qos --enable-delay-pools 
> --enable-http-violations --enable-url-maps --enable-ecap --enable-ssl 
> --with-openssl --enable-ssl-crtd --enable-xmalloc-statistics 
> --enable-ident-lookups --with-filedescriptors=163840 
> --with-aufs-threads=128 --disable-arch-native 
> --with-logdir=/var/log/squid --with-pidfile=/var/run/squid/squid.pid 
> --with-swapdir=/var/cache/squid
> 
> 
> Hi, after the make install got
> 
> /bin/bash ../../../../libtool? --tag=CXX?? --mode=link g++ -std=c++17 
> -Wall -Wextra -Wimplicit-fallthrough=5 -Wpointer-arith -Wwrite-strings 
> -Wcomments -Wshadow -Wmissing-declarations -Woverloaded-virtual -Werror 
> -pipe -D_REENTRANT -m64 -I/usr/include/p11-kit-1??? -g -O2? -m64?? -g -o 
> security_file_certgen certificate_db.o security_file_certgen.o 
> ../../../../src/ssl/libsslutil.la ../../../../src/sbuf/libsbuf.la 
> ../../../../src/debug/libdebug.la ../../../../src/error/liberror.la 
> ../../../../src/comm/libminimal.la ../../../../src/mem/libminimal.la 
> ../../../../src/base/libbase.la ../../../../src/time/libtime.la -lssl 
> -lcrypto?? -lgnutls?? ../../../../compat/libcompatsquid.la
> libtool: link: g++ -std=c++17 -Wall -Wextra -Wimplicit-fallthrough=5 
> -Wpointer-arith -Wwrite-strings -Wcomments -Wshadow 
> -Wmissing-declarations -Woverloaded-virtual -Werror -pipe -D_REENTRANT 
> -m64 -I/usr/include/p11-kit-1 -g -O2 -m64 -g -o security_file_certgen 
> certificate_db.o security_file_certgen.o 
> ../../../../src/ssl/.libs/libsslutil.a 
> ../../../../src/sbuf/.libs/libsbuf.a 
> ../../../../src/debug/.libs/libdebug.a 
> ../../../../src/error/.libs/liberror.a 
> ../../../../src/comm/.libs/libminimal.a 
> ../../../../src/mem/.libs/libminimal.a 
> ../../../../src/base/.libs/libbase.a 
> ../../../../src/time/.libs/libtime.a -lssl -lcrypto -lgnutls 
> ../../../../compat/.libs/libcompatsquid.a
> /usr/bin/ld: ../../../../src/ssl/.libs/libsslutil.a(crtd_message.o): in 
> function `Ssl::CrtdMessage::composeRequest(Ssl::CertificateProperties 
> const&)':
> /root/squid-6.10/src/ssl/crtd_message.cc:248: undefined reference to 
> `EVP_MD_type'
> 
> How i can fix it ?

It looks like your Squid is being built with both GnuTLS (bad default) 
and OpenSSL (explicitly requested) support enabled at the same time. I 
doubt Squid code handles that combination well.

As a workaround, try adding --without-gnutls to ./configure options.


HTH,

Alex.



From david at articatech.com  Wed Aug 21 16:30:55 2024
From: david at articatech.com (David Touzeau)
Date: Wed, 21 Aug 2024 18:30:55 +0200
Subject: [squid-users] squid 6.10 - Debian 12 undefined reference to
 `EVP_MD_type' in ssl-crtd
In-Reply-To: <d6c3f8fe-1b9e-41c3-8e5a-cd6f5fbeac9d@measurement-factory.com>
References: <ec59941e-522f-4f1c-a8ed-94373581cb26@articatech.com>
 <d6c3f8fe-1b9e-41c3-8e5a-cd6f5fbeac9d@measurement-factory.com>
Message-ID: <f089ac03-3b87-450f-8df5-d93273c1d0f6@articatech.com>

Thanks Alex

It Works by adding --without-gnutls !

Le 21/08/2024 ? 16:02, Alex Rousskov a ?crit?:
> On 2024-08-21 09:37, David Touzeau wrote:
>> Configure:
>> ./configure --prefix=/usr --build=x86_64-linux-gnu 
>> --includedir=/include --mandir=/share/man --infodir=/share/info 
>> --localstatedir=/var --libexecdir=/lib/squid3 
>> --disable-maintainer-mode --disable-dependency-tracking 
>> --datadir=/usr/share/squid3 --sysconfdir=/etc/squid3 
>> --enable-gnuregex --enable-removal-policy=heap 
>> --enable-follow-x-forwarded-for --disable-cache-digests 
>> --enable-http-violations --enable-removal-policies=lru,heap 
>> --enable-arp-acl --enable-truncate --with-large-files --with-pthreads 
>> --enable-esi --enable-storeio=aufs,diskd,ufs,rock 
>> --enable-x-accelerator-vary --with-dl--enable-linux-netfilter 
>> --with-netfilter-conntrack --enable-wccpv2 --enable-eui --enable-auth 
>> --enable-auth-basic --enable-snmp --enable-icmp --enable-auth-digest 
>> --enable-log-daemon-helpers --enable-url-rewrite-helpers 
>> --enable-auth-ntlm --with-default-user=squid --enable-icap-client 
>> --disable-cache-digests --enable-poll --enable-epoll 
>> --enable-async-io=128 --enable-zph-qos --enable-delay-pools 
>> --enable-http-violations --enable-url-maps --enable-ecap --enable-ssl 
>> --with-openssl --enable-ssl-crtd --enable-xmalloc-statistics 
>> --enable-ident-lookups --with-filedescriptors=163840 
>> --with-aufs-threads=128 --disable-arch-native 
>> --with-logdir=/var/log/squid --with-pidfile=/var/run/squid/squid.pid 
>> --with-swapdir=/var/cache/squid
>>
>>
>> Hi, after the make install got
>>
>> /bin/bash ../../../../libtool? --tag=CXX?? --mode=link g++ -std=c++17 
>> -Wall -Wextra -Wimplicit-fallthrough=5 -Wpointer-arith 
>> -Wwrite-strings -Wcomments -Wshadow -Wmissing-declarations 
>> -Woverloaded-virtual -Werror -pipe -D_REENTRANT -m64 
>> -I/usr/include/p11-kit-1??? -g -O2? -m64?? -g -o 
>> security_file_certgen certificate_db.o security_file_certgen.o 
>> ../../../../src/ssl/libsslutil.la ../../../../src/sbuf/libsbuf.la 
>> ../../../../src/debug/libdebug.la ../../../../src/error/liberror.la 
>> ../../../../src/comm/libminimal.la ../../../../src/mem/libminimal.la 
>> ../../../../src/base/libbase.la ../../../../src/time/libtime.la -lssl 
>> -lcrypto?? -lgnutls?? ../../../../compat/libcompatsquid.la
>> libtool: link: g++ -std=c++17 -Wall -Wextra -Wimplicit-fallthrough=5 
>> -Wpointer-arith -Wwrite-strings -Wcomments -Wshadow 
>> -Wmissing-declarations -Woverloaded-virtual -Werror -pipe 
>> -D_REENTRANT -m64 -I/usr/include/p11-kit-1 -g -O2 -m64 -g -o 
>> security_file_certgen certificate_db.o security_file_certgen.o 
>> ../../../../src/ssl/.libs/libsslutil.a 
>> ../../../../src/sbuf/.libs/libsbuf.a 
>> ../../../../src/debug/.libs/libdebug.a 
>> ../../../../src/error/.libs/liberror.a 
>> ../../../../src/comm/.libs/libminimal.a 
>> ../../../../src/mem/.libs/libminimal.a 
>> ../../../../src/base/.libs/libbase.a 
>> ../../../../src/time/.libs/libtime.a -lssl -lcrypto -lgnutls 
>> ../../../../compat/.libs/libcompatsquid.a
>> /usr/bin/ld: ../../../../src/ssl/.libs/libsslutil.a(crtd_message.o): 
>> in function 
>> `Ssl::CrtdMessage::composeRequest(Ssl::CertificateProperties const&)':
>> /root/squid-6.10/src/ssl/crtd_message.cc:248: undefined reference to 
>> `EVP_MD_type'
>>
>> How i can fix it ?
>
> It looks like your Squid is being built with both GnuTLS (bad default) 
> and OpenSSL (explicitly requested) support enabled at the same time. I 
> doubt Squid code handles that combination well.
>
> As a workaround, try adding --without-gnutls to ./configure options.
>
>
> HTH,
>
> Alex.
>
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> https://lists.squid-cache.org/listinfo/squid-users

-- 
David Touzeau - Artica Tech France
Development team, level 3 support
----------------------------------
P: +33 6 58 44 69 46
www:https://wiki.articatech.com
www:http://articatech.net  
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20240821/fbc6449d/attachment.htm>

From squid3 at treenet.co.nz  Thu Aug 22 03:10:45 2024
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Thu, 22 Aug 2024 15:10:45 +1200
Subject: [squid-users] squid 6.10 - Debian 12 undefined reference to
 `EVP_MD_type' in ssl-crtd
In-Reply-To: <ec59941e-522f-4f1c-a8ed-94373581cb26@articatech.com>
References: <ec59941e-522f-4f1c-a8ed-94373581cb26@articatech.com>
Message-ID: <d5e8b20c-b22c-4b53-b0dd-e0a3971e4d88@treenet.co.nz>


Might be worth checking if you still need to custom build.
Debian now provides a "squid-openssl" package.

Amos


On 22/08/24 01:37, David Touzeau wrote:
> Configure:
> ./configure --prefix=/usr --build=x86_64-linux-gnu --includedir=/include 
> --mandir=/share/man --infodir=/share/info --localstatedir=/var -- 
> libexecdir=/lib/squid3 --disable-maintainer-mode --disable-dependency- 
> tracking --datadir=/usr/share/squid3 --sysconfdir=/etc/squid3 --enable- 
> gnuregex --enable-removal-policy=heap --enable-follow-x-forwarded-for -- 
> disable-cache-digests --enable-http-violations --enable-removal- 
> policies=lru,heap --enable-arp-acl --enable-truncate --with-large-files 
> --with-pthreads --enable-esi --enable-storeio=aufs,diskd,ufs,rock -- 
> enable-x-accelerator-vary --with-dl--enable-linux-netfilter --with- 
> netfilter-conntrack --enable-wccpv2 --enable-eui --enable-auth --enable- 
> auth-basic --enable-snmp --enable-icmp --enable-auth-digest --enable- 
> log-daemon-helpers --enable-url-rewrite-helpers --enable-auth-ntlm -- 
> with-default-user=squid --enable-icap-client --disable-cache-digests -- 
> enable-poll --enable-epoll --enable-async-io=128 --enable-zph-qos -- 
> enable-delay-pools --enable-http-violations --enable-url-maps --enable- 
> ecap --enable-ssl --with-openssl --enable-ssl-crtd --enable-xmalloc- 
> statistics --enable-ident-lookups --with-filedescriptors=163840 --with- 
> aufs-threads=128 --disable-arch-native --with-logdir=/var/log/squid -- 
> with-pidfile=/var/run/squid/squid.pid --with-swapdir=/var/cache/squid
> 
> 
> Hi, after the make install got
> 
> /bin/bash ../../../../libtool? --tag=CXX?? --mode=link g++ -std=c++17 - 
> Wall -Wextra -Wimplicit-fallthrough=5 -Wpointer-arith -Wwrite-strings - 
> Wcomments -Wshadow -Wmissing-declarations -Woverloaded-virtual -Werror - 
> pipe -D_REENTRANT -m64 -I/usr/include/p11-kit-1??? -g -O2? -m64?? -g -o 
> security_file_certgen certificate_db.o 
> security_file_certgen.o ../../../../src/ssl/libsslutil.la ../../../../ 
> src/sbuf/libsbuf.la ../../../../src/debug/libdebug.la ../../../../src/ 
> error/liberror.la ../../../../src/comm/libminimal.la ../../../../src/ 
> mem/libminimal.la ../../../../src/base/libbase.la ../../../../src/time/ 
> libtime.la -lssl -lcrypto?? -lgnutls?? ../../../../compat/libcompatsquid.la
> libtool: link: g++ -std=c++17 -Wall -Wextra -Wimplicit-fallthrough=5 - 
> Wpointer-arith -Wwrite-strings -Wcomments -Wshadow -Wmissing- 
> declarations -Woverloaded-virtual -Werror -pipe -D_REENTRANT -m64 -I/ 
> usr/include/p11-kit-1 -g -O2 -m64 -g -o security_file_certgen 
> certificate_db.o security_file_certgen.o ../../../../src/ssl/.libs/ 
> libsslutil.a ../../../../src/sbuf/.libs/libsbuf.a ../../../../src/ 
> debug/.libs/libdebug.a ../../../../src/error/.libs/ 
> liberror.a ../../../../src/comm/.libs/libminimal.a ../../../../src/ 
> mem/.libs/libminimal.a ../../../../src/base/.libs/libbase.a ../../../../ 
> src/time/.libs/libtime.a -lssl -lcrypto -lgnutls ../../../../ 
> compat/.libs/libcompatsquid.a
> /usr/bin/ld: ../../../../src/ssl/.libs/libsslutil.a(crtd_message.o): in 
> function `Ssl::CrtdMessage::composeRequest(Ssl::CertificateProperties 
> const&)':
> /root/squid-6.10/src/ssl/crtd_message.cc:248: undefined reference to 
> `EVP_MD_type'
> 
> How i can fix it ?
> 
> -- 
> David Touzeau - Artica Tech France
> 
> 
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> https://lists.squid-cache.org/listinfo/squid-users



From rousskov at measurement-factory.com  Thu Aug 22 18:20:45 2024
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Thu, 22 Aug 2024 14:20:45 -0400
Subject: [squid-users] Squid 6.10 on Fedora 40 cannot intercept and bump
 SSL Traffic
In-Reply-To: <fa2016f4-276a-4bf0-94a8-79db1273d9b9@measurement-factory.com>
References: <CABA8h=TSSsneVN5qvtaxsHfdknSd58ucZ9Vxg=Vxe5YWCsaAAA@mail.gmail.com>
 <6b375023-33d6-4812-8850-0a24cb562d2e@measurement-factory.com>
 <CABA8h=SJp88t3aj1cr-4LK-mqik6QL9nG_X2xumZ_mPwCoybxg@mail.gmail.com>
 <4a57096d-1218-4090-b62a-67d1a18173a7@measurement-factory.com>
 <000001daf26d$d620c5c0$82625140$@gmail.com>
 <af9608b6-5388-4d78-8e96-eea3267b6bc7@measurement-factory.com>
 <CABA8h=Rj=qkw5YrNNtD1Kc1rw0Pu_07Lti00H4bTL87pVtMcRw@mail.gmail.com>
 <fa2016f4-276a-4bf0-94a8-79db1273d9b9@measurement-factory.com>
Message-ID: <414af43d-0c60-4fdc-8421-3fcac3bf05c7@measurement-factory.com>

On 2024-08-20 15:57, Alex Rousskov wrote:
> On 2024-08-19 19:32, NgTech LTD wrote:
> 
>  > curl -v -k https://www.youtube.com/
> 
>> 1724109013.783 ? ? ?0 192.168.78.252 NONE_NONE/000 0 - 
>> error:invalid-request - HIER_NONE/- - -
> 
> OK, let's focus on this curl interception test. It feels like your Squid 
> is receiving some bytes it cannot fully grok. We should figure out what 
> those bytes are. Please share (privately if needed) a pointer to 
> compressed ALL,9 cache.log snippet collected while reproducing this 
> single test.

Thank you, Eliezer, for sharing the requested logs!

There is a simple explanation for the above error:invalid-request 
access.log record: The test intercepts TLS traffic using plain text 
http_port. It should intercept TLS traffic using https_port instead.


> acl foreignProtocol squid_error ERR_PROTOCOL_UNKNOWN ...
> on_unsupported_protocol tunnel foreignProtocol

When a plain text port is used, Squid correctly declares 
ERR_PROTOCOL_UNKNOWN, triggers on_unsupported_protocol handling, and 
then tunnels intercepted HTTPS bytes, as configured. Judging by the lack 
of curl errors, that blind TCP tunnel works correctly as well.

SslBump is not applied to tunneled "unknown protocol" bytes, of course.


HTH,

Alex.



> N.B. The other tests confirm that your Squid can "bump clients", 
> invalidating one of the assertions at the beginning of this email 
> thread. The problem appears to be specific to the interception part of 
> the test rather than basic SslBump operation.
> 
> 
> Cheers,
> 
> Alex.
> 
> 
>> 1724109015.407 ? 1623 192.168.78.252 TCP_TUNNEL/200 534674 - 
>> 142.250.185.110:443 <http://142.250.185.110:443> - 
>> ORIGINAL_DST/142.250.185.110 <http://142.250.185.110> - -
>>
>> PS C:\Users\eliez> curl -v -k https://www.youtube.com/ 
>> <https://www.youtube.com/> ?-o 1.txt
>> ?? % Total ? ?% Received % Xferd ?Average Speed ? Time ? ?Time     
>> Time ??Current
>> ?? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ?Dload ?Upload ? Total ? Spent   
>> ?Left ??Speed
>> ?? 0 ? ? 0 ? ?0 ? ? 0 ? ?0 ? ? 0 ? ? ?0 ? ? ?0 --:--:-- --:--:-- 
>> --:--:-- ? ? 0* Host www.youtube.com:443 <http://www.youtube.com:443> 
>> was resolved.
>> * IPv6: 2a00:1450:4001:80b::200e, 2a00:1450:4001:828::200e, 
>> 2a00:1450:4001:803::200e, 2a00:1450:4001:830::200e
>> * IPv4: 142.250.185.110, 216.58.206.78, 142.250.186.142, 
>> 216.58.206.46, 172.217.18.110, 142.250.185.142, 142.250.186.174, 
>> 142.250.184.206, 142.250.185.174, 142.250.184.238, 172.217.18.14, 
>> 142.250.186.110, 172.217.16.206, 172.217.23.110, 216.58.212.142, 
>> 142.250.185.78
>> * ? Trying [2a00:1450:4001:80b::200e]:443...
>> * ? Trying 142.250.185.110:443...
>> * Connected to www.youtube.com <http://www.youtube.com> 
>> (142.250.185.110) port 443
>> * schannel: disabled automatic use of client certificate
>> * ALPN: curl offers http/1.1
>> * ALPN: server accepted http/1.1
>> * using HTTP/1.x
>> ?> GET / HTTP/1.1
>> ?> Host: www.youtube.com <http://www.youtube.com>
>> ?> User-Agent: curl/8.8.0
>> ?> Accept: */*
>> ?>
>> * Request completely sent off
>> * schannel: remote party requests renegotiation
>> * schannel: renegotiating SSL/TLS connection
>> * schannel: SSL/TLS connection renegotiated
>> < HTTP/1.1 200 OK
>> < Content-Type: text/html; charset=utf-8
>> < X-Content-Type-Options: nosniff
>> < Cache-Control: no-cache, no-store, max-age=0, must-revalidate
>> < Pragma: no-cache
>> < Expires: Mon, 01 Jan 1990 00:00:00 GMT
>> < Date: Mon, 19 Aug 2024 23:10:13 GMT
>> < Strict-Transport-Security: max-age=31536000
>> < X-Frame-Options: SAMEORIGIN
>> < Permissions-Policy: ch-ua-arch=*, ch-ua-bitness=*, 
>> ch-ua-full-version=*, ch-ua-full-version-list=*, ch-ua-model=*, 
>> ch-ua-wow64=*, ch-ua-form-factors=*, ch-ua-platform=*, 
>> ch-ua-platform-version=*
>> < Content-Security-Policy: require-trusted-types-for 'script'
>> < Origin-Trial: 
>> AmhMBR6zCLzDDxpW+HfpP67BqwIknWnyMOXOQGfzYswFmJe+fgaI6XZgAzcxOrzNtP7hEDsOo1jdjFnVr2IdxQ4AAAB4eyJvcmlnaW4iOiJodHRwczovL3lvdXR1YmUuY29tOjQ0MyIsImZlYXR1cmUiOiJXZWJWaWV3WFJlcXVlc3RlZFdpdGhEZXByZWNhdGlvbiIsImV4cGlyeSI6MTc1ODA2NzE5OSwiaXNTdWJkb21haW4iOnRydWV9
>> < Report-To: 
>> {"group":"youtube_main","max_age":2592000,"endpoints":[{"url":"https://csp.withgoogle.com/csp/report-to/youtube_main <https://csp.withgoogle.com/csp/report-to/youtube_main>"}]}
>> < Cross-Origin-Opener-Policy: same-origin-allow-popups; 
>> report-to="youtube_main"
>> < P3P: CP="This is not a P3P policy! See 
>> http://support.google.com/accounts/answer/151657?hl=en 
>> <http://support.google.com/accounts/answer/151657?hl=en> for more info."
>> < Server: ESF
>> < X-XSS-Protection: 0
>> < Set-Cookie: GPS=1; Domain=.youtube.com <http://youtube.com>; 
>> Expires=Mon, 19-Aug-2024 23:40:13 GMT; Path=/; Secure; HttpOnly
>> < Set-Cookie: YSC=FASh7dosPqA; Domain=.youtube.com 
>> <http://youtube.com>; Path=/; Secure; HttpOnly; SameSite=none
>> < Set-Cookie: VISITOR_INFO1_LIVE=B6cXjIhTk2Q; Domain=.youtube.com 
>> <http://youtube.com>; Expires=Sat, 15-Feb-2025 23:10:13 GMT; Path=/; 
>> Secure; HttpOnly; SameSite=none
>> < Set-Cookie: VISITOR_PRIVACY_METADATA=CgJJTBIEGgAgJw%3D%3D; 
>> Domain=.youtube.com <http://youtube.com>; Expires=Sat, 15-Feb-2025 
>> 23:10:13 GMT; Path=/; Secure; HttpOnly; SameSite=none
>> < Alt-Svc: h3=":443"; ma=2592000,h3-29=":443"; ma=2592000
>> < Accept-Ranges: none
>> < Vary: Accept-Encoding
>> < Transfer-Encoding: chunked
>> <
>> { [9490 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [16240 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [4134 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [9646 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [16215 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [1378 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [2756 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [5512 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [2756 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [2756 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [2756 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [3824 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [2756 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [2756 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [5537 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [2756 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [4134 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [1378 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [22048 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [35198 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [21738 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [35854 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [25878 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [5193 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [13805 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [5512 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [5512 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [20374 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [1378 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [19292 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [4134 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [21752 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [2756 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [24508 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [13780 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [47936 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [11024 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [53150 bytes data]
>> 100 ?504k ? ?0 ?504k ? ?0 ? ? 0 ? 556k ? ? ?0 --:--:-- --:--:-- 
>> --:--:-- ??559k
>> * Connection #0 to host www.youtube.com <http://www.youtube.com> left 
>> intact
>>
>>
>> Now for a direct test with a proxy definition for a port which is not 
>> intercept but plain forward proxy:
>>
>> 1724109426.755 ? 1638 192.168.78.252 TCP_TUNNEL/200 533406 CONNECT 
>> www.youtube.com:443 <http://www.youtube.com:443> - 
>> HIER_DIRECT/142.250.184.238 <http://142.250.184.238> - -
>>
>> PS C:\Users\eliez> curl -x http://192.168.66.1:3128 
>> <http://192.168.66.1:3128> -v -k https://www.youtube.com/ 
>> <https://www.youtube.com/> ?-o 1.txt
>> ?? % Total ? ?% Received % Xferd ?Average Speed ? Time ? ?Time     
>> Time ??Current
>> ?? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ?Dload ?Upload ? Total ? Spent   
>> ?Left ??Speed
>> ?? 0 ? ? 0 ? ?0 ? ? 0 ? ?0 ? ? 0 ? ? ?0 ? ? ?0 --:--:-- --:--:-- 
>> --:--:-- ? ? 0* ? Trying 192.168.66.1:3128...
>> * Connected to 192.168.66.1 (192.168.66.1) port 3128
>> * CONNECT tunnel: HTTP/1.1 negotiated
>> * allocate connect buffer
>> * Establish HTTP proxy tunnel to www.youtube.com:443 
>> <http://www.youtube.com:443>
>> ?> CONNECT www.youtube.com:443 <http://www.youtube.com:443> HTTP/1.1
>> ?> Host: www.youtube.com:443 <http://www.youtube.com:443>
>> ?> User-Agent: curl/8.8.0
>> ?> Proxy-Connection: Keep-Alive
>> ?>
>> < HTTP/1.1 200 Connection established
>> <
>> * CONNECT phase completed
>> * CONNECT tunnel established, response 200
>> * schannel: disabled automatic use of client certificate
>> * ALPN: curl offers http/1.1
>> * ALPN: server accepted http/1.1
>> * using HTTP/1.x
>> ?> GET / HTTP/1.1
>> ?> Host: www.youtube.com <http://www.youtube.com>
>> ?> User-Agent: curl/8.8.0
>> ?> Accept: */*
>> ?>
>> * Request completely sent off
>> * schannel: remote party requests renegotiation
>> * schannel: renegotiating SSL/TLS connection
>> * schannel: SSL/TLS connection renegotiated
>> < HTTP/1.1 200 OK
>> < Content-Type: text/html; charset=utf-8
>> < X-Content-Type-Options: nosniff
>> < Cache-Control: no-cache, no-store, max-age=0, must-revalidate
>> < Pragma: no-cache
>> < Expires: Mon, 01 Jan 1990 00:00:00 GMT
>> < Date: Mon, 19 Aug 2024 23:17:05 GMT
>> < Strict-Transport-Security: max-age=31536000
>> < X-Frame-Options: SAMEORIGIN
>> < Content-Security-Policy: require-trusted-types-for 'script'
>> < Permissions-Policy: ch-ua-arch=*, ch-ua-bitness=*, 
>> ch-ua-full-version=*, ch-ua-full-version-list=*, ch-ua-model=*, 
>> ch-ua-wow64=*, ch-ua-form-factors=*, ch-ua-platform=*, 
>> ch-ua-platform-version=*
>> < Report-To: 
>> {"group":"youtube_main","max_age":2592000,"endpoints":[{"url":"https://csp.withgoogle.com/csp/report-to/youtube_main <https://csp.withgoogle.com/csp/report-to/youtube_main>"}]}
>> < Origin-Trial: 
>> AmhMBR6zCLzDDxpW+HfpP67BqwIknWnyMOXOQGfzYswFmJe+fgaI6XZgAzcxOrzNtP7hEDsOo1jdjFnVr2IdxQ4AAAB4eyJvcmlnaW4iOiJodHRwczovL3lvdXR1YmUuY29tOjQ0MyIsImZlYXR1cmUiOiJXZWJWaWV3WFJlcXVlc3RlZFdpdGhEZXByZWNhdGlvbiIsImV4cGlyeSI6MTc1ODA2NzE5OSwiaXNTdWJkb21haW4iOnRydWV9
>> < Cross-Origin-Opener-Policy: same-origin-allow-popups; 
>> report-to="youtube_main"
>> < P3P: CP="This is not a P3P policy! See 
>> http://support.google.com/accounts/answer/151657?hl=en 
>> <http://support.google.com/accounts/answer/151657?hl=en> for more info."
>> < Server: ESF
>> < X-XSS-Protection: 0
>> < Set-Cookie: GPS=1; Domain=.youtube.com <http://youtube.com>; 
>> Expires=Mon, 19-Aug-2024 23:47:05 GMT; Path=/; Secure; HttpOnly
>> < Set-Cookie: YSC=OujtWi5Xgqo; Domain=.youtube.com 
>> <http://youtube.com>; Path=/; Secure; HttpOnly; SameSite=none
>> < Set-Cookie: VISITOR_INFO1_LIVE=PtNdaPPFKOg; Domain=.youtube.com 
>> <http://youtube.com>; Expires=Sat, 15-Feb-2025 23:17:05 GMT; Path=/; 
>> Secure; HttpOnly; SameSite=none
>> < Set-Cookie: VISITOR_PRIVACY_METADATA=CgJJTBIEGgAgTA%3D%3D; 
>> Domain=.youtube.com <http://youtube.com>; Expires=Sat, 15-Feb-2025 
>> 23:17:05 GMT; Path=/; Secure; HttpOnly; SameSite=none
>> < Alt-Svc: h3=":443"; ma=2592000,h3-29=":443"; ma=2592000
>> < Accept-Ranges: none
>> < Vary: Accept-Encoding
>> < Transfer-Encoding: chunked
>> <
>> { [9490 bytes data]
>> 100 16366 ? ?0 16366 ? ?0 ? ? 0 ?32466 ? ? ?0 --:--:-- --:--:-- 
>> --:--:-- 32407* schannel: failed to decrypt data, need more data
>> { [5216 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [2756 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [2756 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [2756 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [4134 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [2756 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [21729 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [18982 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [22071 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [6890 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [14848 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [11024 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [10706 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [15158 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [2756 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [10714 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [15180 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [22273 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [44653 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [22048 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [101084 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [4134 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [80712 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [23130 bytes data]
>> 100 ?503k ? ?0 ?503k ? ?0 ? ? 0 ? 670k ? ? ?0 --:--:-- --:--:-- 
>> --:--:-- ??670k
>> * Connection #0 to host 192.168.66.1 left intact
>>
>>
>> For a direct forward proxy to a sslbump?enabled port these are the 
>> results:
>>
>> 1724109490.260 ? ?217 192.168.78.252 NONE_NONE/200 0 CONNECT 
>> www.youtube.com:443 <http://www.youtube.com:443> - 
>> HIER_DIRECT/142.250.181.238 <http://142.250.181.238> - www.youtube.com 
>> <http://www.youtube.com>
>> 1724109490.947 ? ?686 192.168.78.252 TCP_MISS/200 516442 GET 
>> https://www.youtube.com/ <https://www.youtube.com/> - 
>> HIER_DIRECT/142.250.181.238 <http://142.250.181.238> text/html 
>> www.youtube.com <http://www.youtube.com>
>>
>> PS C:\Users\eliez> curl -x http://192.168.66.1:13128 
>> <http://192.168.66.1:13128> -v -k https://www.youtube.com/ 
>> <https://www.youtube.com/> ?-o 1.txt
>> ?? % Total ? ?% Received % Xferd ?Average Speed ? Time ? ?Time     
>> Time ??Current
>> ?? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ?Dload ?Upload ? Total ? Spent   
>> ?Left ??Speed
>> ?? 0 ? ? 0 ? ?0 ? ? 0 ? ?0 ? ? 0 ? ? ?0 ? ? ?0 --:--:-- --:--:-- 
>> --:--:-- ? ? 0* ? Trying 192.168.66.1:13128...
>> * Connected to 192.168.66.1 (192.168.66.1) port 13128
>> * CONNECT tunnel: HTTP/1.1 negotiated
>> * allocate connect buffer
>> * Establish HTTP proxy tunnel to www.youtube.com:443 
>> <http://www.youtube.com:443>
>> ?> CONNECT www.youtube.com:443 <http://www.youtube.com:443> HTTP/1.1
>> ?> Host: www.youtube.com:443 <http://www.youtube.com:443>
>> ?> User-Agent: curl/8.8.0
>> ?> Proxy-Connection: Keep-Alive
>> ?>
>> < HTTP/1.1 200 Connection established
>> <
>> * CONNECT phase completed
>> * CONNECT tunnel established, response 200
>> * schannel: disabled automatic use of client certificate
>> * ALPN: curl offers http/1.1
>> * ALPN: server did not agree on a protocol. Uses default.
>> * using HTTP/1.x
>> ?> GET / HTTP/1.1
>> ?> Host: www.youtube.com <http://www.youtube.com>
>> ?> User-Agent: curl/8.8.0
>> ?> Accept: */*
>> ?>
>> * Request completely sent off
>> * schannel: remote party requests renegotiation
>> * schannel: renegotiating SSL/TLS connection
>> * schannel: SSL/TLS connection renegotiated
>> * schannel: remote party requests renegotiation
>> * schannel: renegotiating SSL/TLS connection
>> * schannel: SSL/TLS connection renegotiated
>> < HTTP/1.1 200 OK
>> < Content-Type: text/html; charset=utf-8
>> < X-Content-Type-Options: nosniff
>> < Cache-Control: no-cache, no-store, max-age=0, must-revalidate
>> < Pragma: no-cache
>> < Expires: Mon, 01 Jan 1990 00:00:00 GMT
>> < Date: Mon, 19 Aug 2024 23:18:10 GMT
>> < Strict-Transport-Security: max-age=31536000
>> < X-Frame-Options: SAMEORIGIN
>> < Content-Security-Policy: require-trusted-types-for 'script'
>> < Origin-Trial: 
>> AmhMBR6zCLzDDxpW+HfpP67BqwIknWnyMOXOQGfzYswFmJe+fgaI6XZgAzcxOrzNtP7hEDsOo1jdjFnVr2IdxQ4AAAB4eyJvcmlnaW4iOiJodHRwczovL3lvdXR1YmUuY29tOjQ0MyIsImZlYXR1cmUiOiJXZWJWaWV3WFJlcXVlc3RlZFdpdGhEZXByZWNhdGlvbiIsImV4cGlyeSI6MTc1ODA2NzE5OSwiaXNTdWJkb21haW4iOnRydWV9
>> < Cross-Origin-Opener-Policy: same-origin-allow-popups; 
>> report-to="youtube_main"
>> < Permissions-Policy: ch-ua-arch=*, ch-ua-bitness=*, 
>> ch-ua-full-version=*, ch-ua-full-version-list=*, ch-ua-model=*, 
>> ch-ua-wow64=*, ch-ua-form-factors=*, ch-ua-platform=*, 
>> ch-ua-platform-version=*
>> < Report-To: 
>> {"group":"youtube_main","max_age":2592000,"endpoints":[{"url":"https://csp.withgoogle.com/csp/report-to/youtube_main <https://csp.withgoogle.com/csp/report-to/youtube_main>"}]}
>> < P3P: CP="This is not a P3P policy! See 
>> http://support.google.com/accounts/answer/151657?hl=en 
>> <http://support.google.com/accounts/answer/151657?hl=en> for more info."
>> < Server: ESF
>> < X-XSS-Protection: 0
>> < Set-Cookie: GPS=1; Domain=.youtube.com <http://youtube.com>; 
>> Expires=Mon, 19-Aug-2024 23:48:10 GMT; Path=/; Secure; HttpOnly
>> < Set-Cookie: YSC=6pPz8lVi60s; Domain=.youtube.com 
>> <http://youtube.com>; Path=/; Secure; HttpOnly; SameSite=none
>> < Set-Cookie: VISITOR_INFO1_LIVE=zD4fzRwONpc; Domain=.youtube.com 
>> <http://youtube.com>; Expires=Sat, 15-Feb-2025 23:18:10 GMT; Path=/; 
>> Secure; HttpOnly; SameSite=none
>> < Set-Cookie: VISITOR_PRIVACY_METADATA=CgJJTBIEGgAgOQ%3D%3D; 
>> Domain=.youtube.com <http://youtube.com>; Expires=Sat, 15-Feb-2025 
>> 23:18:10 GMT; Path=/; Secure; HttpOnly; SameSite=none
>> < Alt-Svc: h3=":443"; ma=2592000,h3-29=":443"; ma=2592000
>> < Accept-Ranges: none
>> < Vary: Accept-Encoding
>> < X-Cache: MISS from 005-NgTech-Home-Proxy-1
>> < X-Cache-Lookup: MISS from 005-NgTech-Home-Proxy-1:3128
>> < Transfer-Encoding: chunked
>> < Via: 1.1 005-NgTech-Home-Proxy-1 (squid/5.9)
>> < Connection: keep-alive
>> <
>> { [7370 bytes data]
>> 100 27390 ? ?0 27390 ? ?0 ? ? 0 ?35637 ? ? ?0 --:--:-- --:--:-- 
>> --:--:-- 35617* schannel: failed to decrypt data, need more data
>> { [2770 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [21842 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [21834 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [10776 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [11080 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [100491 bytes data]
>> 100 ?499k ? ?0 ?499k ? ?0 ? ? 0 ? 488k ? ? ?0 --:--:-- ?0:00:01 
>> --:--:-- ??489k
>> * Connection #0 to host 192.168.66.1 left intact
>>
>> Now for the second part which is to play with the ssl_bump options.
>> currently the options I am using are:
>> ssl_bump peek step1
>> ssl_bump bump all
>>
>> So now I will try to change them a bit.
>>
>> For a direct curl request to the intercept with ssl bump port I get 
>> the next logs:
>>
>>
>>
>> 2024/08/20 02:23:18 kid1| SECURITY ALERT: Host header forgery detected 
>> on conn364 local=192.168.66.1:33128 <http://192.168.66.1:33128> 
>> remote=192.168.78.252:40721 <http://192.168.78.252:40721> FD 10 
>> flags=33 (intercepted port does not match 443)
>> ?? ? current master transaction: master118
>> 2024/08/20 02:23:18 kid1| SECURITY ALERT: By user agent: curl/8.8.0
>> ?? ? current master transaction: master118
>> 2024/08/20 02:23:18 kid1| SECURITY ALERT: on URL: www.youtube.com:443 
>> <http://www.youtube.com:443>
>> ?? ? current master transaction: master118
>> 2024/08/20 02:23:18 kid1| kick abandoning conn364 
>> local=192.168.66.1:33128 <http://192.168.66.1:33128> 
>> remote=192.168.78.252:40721 <http://192.168.78.252:40721> FD 10 flags=33
>> ?? ? connection: conn364 local=192.168.66.1:33128 
>> <http://192.168.66.1:33128> remote=192.168.78.252:40721 
>> <http://192.168.78.252:40721> FD 10 flags=33
>>
>> ==> /var/log/squid/access.log <==
>> 1724109798.106 ? ? ?0 192.168.78.252 NONE_NONE/409 4177 CONNECT 
>> www.youtube.com:443 <http://www.youtube.com:443> - HIER_NONE/- 
>> text/html -
>>
>> PS C:\Users\eliez> curl -x http://192.168.66.1:33128 
>> <http://192.168.66.1:33128> -v -k https://www.youtube.com/ 
>> <https://www.youtube.com/> ?-o 1.txt
>> ?? % Total ? ?% Received % Xferd ?Average Speed ? Time ? ?Time     
>> Time ??Current
>> ?? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ?Dload ?Upload ? Total ? Spent   
>> ?Left ??Speed
>> ?? 0 ? ? 0 ? ?0 ? ? 0 ? ?0 ? ? 0 ? ? ?0 ? ? ?0 --:--:-- --:--:-- 
>> --:--:-- ? ? 0* ? Trying 192.168.66.1:33128...
>> * Connected to 192.168.66.1 (192.168.66.1) port 33128
>> * CONNECT tunnel: HTTP/1.1 negotiated
>> * allocate connect buffer
>> * Establish HTTP proxy tunnel to www.youtube.com:443 
>> <http://www.youtube.com:443>
>> ?> CONNECT www.youtube.com:443 <http://www.youtube.com:443> HTTP/1.1
>> ?> Host: www.youtube.com:443 <http://www.youtube.com:443>
>> ?> User-Agent: curl/8.8.0
>> ?> Proxy-Connection: Keep-Alive
>> ?>
>> < HTTP/1.1 409 Conflict
>> < Server: squid/5.9
>> < Mime-Version: 1.0
>> < Date: Mon, 19 Aug 2024 23:23:18 GMT
>> < Content-Type: text/html;charset=utf-8
>> < Content-Length: 3765
>> < X-Squid-Error: ERR_CONFLICT_HOST 0
>> < Vary: Accept-Language
>> < Content-Language: en
>> < X-Cache: MISS from 005-NgTech-Home-Proxy-1
>> < X-Cache-Lookup: NONE from 005-NgTech-Home-Proxy-1:3128
>> < Via: 1.1 005-NgTech-Home-Proxy-1 (squid/5.9)
>> < Connection: keep-alive
>> <
>> * CONNECT tunnel failed, response 409
>> ?? 0 ? ? 0 ? ?0 ? ? 0 ? ?0 ? ? 0 ? ? ?0 ? ? ?0 --:--:-- --:--:-- 
>> --:--:-- ? ? 0
>> * Closing connection
>> curl: (56) CONNECT tunnel failed, response 409
>>
>> With a Splice all the results are:
>> Access log:
>> 1724109929.178 ? ? ?0 192.168.78.252 NONE_NONE/000 0 - 
>> error:invalid-request - HIER_NONE/- - -
>> 1724109930.776 ? 1598 192.168.78.252 TCP_TUNNEL/200 531067 - 
>> 142.250.185.78:443 <http://142.250.185.78:443> - 
>> ORIGINAL_DST/142.250.185.78 <http://142.250.185.78> - -
>>
>> PS C:\Users\eliez> curl -v -k https://www.youtube.com/ 
>> <https://www.youtube.com/> ?-o 1.txt
>> ?? % Total ? ?% Received % Xferd ?Average Speed ? Time ? ?Time     
>> Time ??Current
>> ?? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ?Dload ?Upload ? Total ? Spent   
>> ?Left ??Speed
>> ?? 0 ? ? 0 ? ?0 ? ? 0 ? ?0 ? ? 0 ? ? ?0 ? ? ?0 --:--:-- --:--:-- 
>> --:--:-- ? ? 0* Host www.youtube.com:443 <http://www.youtube.com:443> 
>> was resolved.
>> * IPv6: 2a00:1450:4001:81c::200e, 2a00:1450:4001:809::200e, 
>> 2a00:1450:4001:800::200e, 2a00:1450:4001:80e::200e
>> * IPv4: 142.250.185.78, 142.250.185.110, 142.250.185.142, 
>> 142.250.186.174, 142.250.185.174, 142.250.184.238, 142.250.185.238, 
>> 142.250.185.206, 142.250.181.238, 142.250.186.46, 142.250.186.78, 
>> 172.217.16.142, 216.58.212.174, 216.58.206.46, 172.217.18.110, 
>> 172.217.23.110
>> * ? Trying [2a00:1450:4001:81c::200e]:443...
>> * ? Trying 142.250.185.78:443...
>> * Connected to www.youtube.com <http://www.youtube.com> 
>> (142.250.185.78) port 443
>> * schannel: disabled automatic use of client certificate
>> * ALPN: curl offers http/1.1
>> * ALPN: server accepted http/1.1
>> * using HTTP/1.x
>> ?> GET / HTTP/1.1
>> ?> Host: www.youtube.com <http://www.youtube.com>
>> ?> User-Agent: curl/8.8.0
>> ?> Accept: */*
>> ?>
>> * Request completely sent off
>> * schannel: remote party requests renegotiation
>> * schannel: renegotiating SSL/TLS connection
>> * schannel: SSL/TLS connection renegotiated
>> * schannel: failed to decrypt data, need more data
>> < HTTP/1.1 200 OK
>> < Content-Type: text/html; charset=utf-8
>> < X-Content-Type-Options: nosniff
>> < Cache-Control: no-cache, no-store, max-age=0, must-revalidate
>> < Pragma: no-cache
>> < Expires: Mon, 01 Jan 1990 00:00:00 GMT
>> < Date: Mon, 19 Aug 2024 23:25:29 GMT
>> < Strict-Transport-Security: max-age=31536000
>> < X-Frame-Options: SAMEORIGIN
>> < Permissions-Policy: ch-ua-arch=*, ch-ua-bitness=*, 
>> ch-ua-full-version=*, ch-ua-full-version-list=*, ch-ua-model=*, 
>> ch-ua-wow64=*, ch-ua-form-factors=*, ch-ua-platform=*, 
>> ch-ua-platform-version=*
>> < Content-Security-Policy: require-trusted-types-for 'script'
>> < Cross-Origin-Opener-Policy: same-origin-allow-popups; 
>> report-to="youtube_main"
>> < Report-To: 
>> {"group":"youtube_main","max_age":2592000,"endpoints":[{"url":"https://csp.withgoogle.com/csp/report-to/youtube_main <https://csp.withgoogle.com/csp/report-to/youtube_main>"}]}
>> < Origin-Trial: 
>> AmhMBR6zCLzDDxpW+HfpP67BqwIknWnyMOXOQGfzYswFmJe+fgaI6XZgAzcxOrzNtP7hEDsOo1jdjFnVr2IdxQ4AAAB4eyJvcmlnaW4iOiJodHRwczovL3lvdXR1YmUuY29tOjQ0MyIsImZlYXR1cmUiOiJXZWJWaWV3WFJlcXVlc3RlZFdpdGhEZXByZWNhdGlvbiIsImV4cGlyeSI6MTc1ODA2NzE5OSwiaXNTdWJkb21haW4iOnRydWV9
>> < P3P: CP="This is not a P3P policy! See 
>> http://support.google.com/accounts/answer/151657?hl=en 
>> <http://support.google.com/accounts/answer/151657?hl=en> for more info."
>> < Server: ESF
>> < X-XSS-Protection: 0
>> < Set-Cookie: GPS=1; Domain=.youtube.com <http://youtube.com>; 
>> Expires=Mon, 19-Aug-2024 23:55:29 GMT; Path=/; Secure; HttpOnly
>> < Set-Cookie: YSC=O3fSKdGlL-Q; Domain=.youtube.com 
>> <http://youtube.com>; Path=/; Secure; HttpOnly; SameSite=none
>> < Set-Cookie: VISITOR_INFO1_LIVE=2PPYvkk_Sbo; Domain=.youtube.com 
>> <http://youtube.com>; Expires=Sat, 15-Feb-2025 23:25:29 GMT; Path=/; 
>> Secure; HttpOnly; SameSite=none
>> < Set-Cookie: VISITOR_PRIVACY_METADATA=CgJJTBIEGgAgGA%3D%3D; 
>> Domain=.youtube.com <http://youtube.com>; Expires=Sat, 15-Feb-2025 
>> 23:25:29 GMT; Path=/; Secure; HttpOnly; SameSite=none
>> < Alt-Svc: h3=":443"; ma=2592000,h3-29=":443"; ma=2592000
>> < Accept-Ranges: none
>> < Vary: Accept-Encoding
>> < Transfer-Encoding: chunked
>> <
>> { [3674 bytes data]
>> 100 24634 ? ?0 24634 ? ?0 ? ? 0 ?31895 ? ? ?0 --:--:-- --:--:-- 
>> --:--:-- 32033* schannel: failed to decrypt data, need more data
>> { [2460 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [2756 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [2756 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [2756 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [2756 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [2756 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [21728 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [16536 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [1068 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [22072 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [4134 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [5512 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [5512 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [9336 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [4134 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [4134 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [8268 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [7949 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [2756 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [11024 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [6890 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [5512 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [2446 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [22071 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [35526 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [18974 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [23450 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [58662 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [21752 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [42424 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [12402 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [42422 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [7972 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [4134 bytes data]
>> 100 ?501k ? ?0 ?501k ? ?0 ? ? 0 ? 496k ? ? ?0 --:--:-- ?0:00:01 
>> --:--:-- ??498k
>> * Connection #0 to host www.youtube.com <http://www.youtube.com> left 
>> intact
>>
>> I am unsure if to continue but I will test again the next ssl bump 
>> rules (maybe I got your instructions wrong):
>> ssl_bump peek all
>> ssl_bump bump all
>>
>> Access.log
>> 1724110080.231 ? ? ?0 192.168.78.252 NONE_NONE/000 0 - 
>> error:invalid-request - HIER_NONE/- - -
>> 1724110081.819 ? 1587 192.168.78.252 TCP_TUNNEL/200 532898 - 
>> 142.250.185.78:443 <http://142.250.185.78:443> - 
>> ORIGINAL_DST/142.250.185.78 <http://142.250.185.78> - -
>>
>> Curl:
>> PS C:\Users\eliez> curl -v -k https://www.youtube.com/ 
>> <https://www.youtube.com/> ?-o 1.txt
>> ?? % Total ? ?% Received % Xferd ?Average Speed ? Time ? ?Time     
>> Time ??Current
>> ?? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ?Dload ?Upload ? Total ? Spent   
>> ?Left ??Speed
>> ?? 0 ? ? 0 ? ?0 ? ? 0 ? ?0 ? ? 0 ? ? ?0 ? ? ?0 --:--:-- --:--:-- 
>> --:--:-- ? ? 0* Host www.youtube.com:443 <http://www.youtube.com:443> 
>> was resolved.
>> * IPv6: 2a00:1450:4001:80e::200e, 2a00:1450:4001:80f::200e, 
>> 2a00:1450:4001:810::200e, 2a00:1450:4001:82b::200e
>> * IPv4: 142.250.185.78, 142.250.185.110, 142.250.185.142, 
>> 142.250.186.174, 142.250.185.174, 142.250.184.238, 142.250.185.238, 
>> 142.250.185.206, 142.250.181.238, 142.250.186.46, 142.250.186.78, 
>> 172.217.16.142, 216.58.212.174, 216.58.206.46, 172.217.18.110, 
>> 172.217.23.110
>> * ? Trying [2a00:1450:4001:80e::200e]:443...
>> * ? Trying 142.250.185.78:443...
>> * Connected to www.youtube.com <http://www.youtube.com> 
>> (142.250.185.78) port 443
>> * schannel: disabled automatic use of client certificate
>> * ALPN: curl offers http/1.1
>> * ALPN: server accepted http/1.1
>> * using HTTP/1.x
>> ?> GET / HTTP/1.1
>> ?> Host: www.youtube.com <http://www.youtube.com>
>> ?> User-Agent: curl/8.8.0
>> ?> Accept: */*
>> ?>
>> * Request completely sent off
>> * schannel: remote party requests renegotiation
>> * schannel: renegotiating SSL/TLS connection
>> * schannel: SSL/TLS connection renegotiated
>> * schannel: failed to decrypt data, need more data
>> < HTTP/1.1 200 OK
>> < Content-Type: text/html; charset=utf-8
>> < X-Content-Type-Options: nosniff
>> < Cache-Control: no-cache, no-store, max-age=0, must-revalidate
>> < Pragma: no-cache
>> < Expires: Mon, 01 Jan 1990 00:00:00 GMT
>> < Date: Mon, 19 Aug 2024 23:28:00 GMT
>> < X-Frame-Options: SAMEORIGIN
>> < Strict-Transport-Security: max-age=31536000
>> < Cross-Origin-Opener-Policy: same-origin-allow-popups; 
>> report-to="youtube_main"
>> < Content-Security-Policy: require-trusted-types-for 'script'
>> < Report-To: 
>> {"group":"youtube_main","max_age":2592000,"endpoints":[{"url":"https://csp.withgoogle.com/csp/report-to/youtube_main <https://csp.withgoogle.com/csp/report-to/youtube_main>"}]}
>> < Origin-Trial: 
>> AmhMBR6zCLzDDxpW+HfpP67BqwIknWnyMOXOQGfzYswFmJe+fgaI6XZgAzcxOrzNtP7hEDsOo1jdjFnVr2IdxQ4AAAB4eyJvcmlnaW4iOiJodHRwczovL3lvdXR1YmUuY29tOjQ0MyIsImZlYXR1cmUiOiJXZWJWaWV3WFJlcXVlc3RlZFdpdGhEZXByZWNhdGlvbiIsImV4cGlyeSI6MTc1ODA2NzE5OSwiaXNTdWJkb21haW4iOnRydWV9
>> < Permissions-Policy: ch-ua-arch=*, ch-ua-bitness=*, 
>> ch-ua-full-version=*, ch-ua-full-version-list=*, ch-ua-model=*, 
>> ch-ua-wow64=*, ch-ua-form-factors=*, ch-ua-platform=*, 
>> ch-ua-platform-version=*
>> < P3P: CP="This is not a P3P policy! See 
>> http://support.google.com/accounts/answer/151657?hl=en 
>> <http://support.google.com/accounts/answer/151657?hl=en> for more info."
>> < Server: ESF
>> < X-XSS-Protection: 0
>> < Set-Cookie: GPS=1; Domain=.youtube.com <http://youtube.com>; 
>> Expires=Mon, 19-Aug-2024 23:58:00 GMT; Path=/; Secure; HttpOnly
>> < Set-Cookie: YSC=zO-uFscIOFo; Domain=.youtube.com 
>> <http://youtube.com>; Path=/; Secure; HttpOnly; SameSite=none
>> < Set-Cookie: VISITOR_INFO1_LIVE=ewGx6w06928; Domain=.youtube.com 
>> <http://youtube.com>; Expires=Sat, 15-Feb-2025 23:28:00 GMT; Path=/; 
>> Secure; HttpOnly; SameSite=none
>> < Set-Cookie: VISITOR_PRIVACY_METADATA=CgJJTBIEGgAgFA%3D%3D; 
>> Domain=.youtube.com <http://youtube.com>; Expires=Sat, 15-Feb-2025 
>> 23:28:00 GMT; Path=/; Secure; HttpOnly; SameSite=none
>> < Alt-Svc: h3=":443"; ma=2592000,h3-29=":443"; ma=2592000
>> < Accept-Ranges: none
>> < Vary: Accept-Encoding
>> < Transfer-Encoding: chunked
>> <
>> { [3674 bytes data]
>> 100 16366 ? ?0 16366 ? ?0 ? ? 0 ?23561 ? ? ?0 --:--:-- --:--:-- 
>> --:--:-- 23684* schannel: failed to decrypt data, need more data
>> { [1082 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [2756 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [2756 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [2756 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [2756 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [2756 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [4134 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [2436 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [2756 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [2756 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [20670 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [25896 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [20670 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [2756 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [6580 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [11024 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [5193 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [5512 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [11024 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [2756 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [9646 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [2756 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [9336 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [2756 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [13803 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [6890 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [21746 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [56204 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [7972 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [6890 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [23130 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [54824 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [23130 bytes data]
>> * schannel: failed to decrypt data, need more data
>> { [74118 bytes data]
>> 100 ?503k ? ?0 ?503k ? ?0 ? ? 0 ? 531k ? ? ?0 --:--:-- --:--:-- 
>> --:--:-- ??533k
>> * Connection #0 to host www.youtube.com <http://www.youtube.com> left 
>> intact
>>
>> This is all the same with both 5.9 and 6.10 as far as I can tell.
>>
>> I know it's a lot of logs but it seems like the problem is well 
>> understood.
>> All the above tests are done using the DNAT REDIRECT method.
>>
>> Just take into account that the next are also present in squid.conf
>>
>> acl foreignProtocol squid_error ERR_PROTOCOL_UNKNOWN ERR_TOO_BIG
>> acl serverTalksFirstProtocol squid_error ERR_REQUEST_START_TIMEOUT
>>
>>
>> on_unsupported_protocol tunnel foreignProtocol
>> on_unsupported_protocol tunnel serverTalksFirstProtocol
>> on_unsupported_protocol respond all
>>
>>
>> If you need me to test other things please let me know.
>>
>> Eliezer
>>
>> ----
>> Eliezer Croitoru
>> Tech Support
>> Mobile: +972-5-28704261
>> Email: ngtech1ltd at gmail.com <mailto:ngtech1ltd at gmail.com>
>>
>>
>> On Mon, Aug 19, 2024 at 10:59?PM Alex Rousskov 
>> <rousskov at measurement-factory.com 
>> <mailto:rousskov at measurement-factory.com>> wrote:
>>
>> ??? On 2024-08-19 15:27, ngtech1ltd at gmail.com
>> ??? <mailto:ngtech1ltd at gmail.com> wrote:
>>
>> ???? > I see that there is a SNI so I am not sure how to look at the 
>> issue.
>>
>> ??? FWIW, as the next step, I still recommend answering the remaining 
>> open
>> ??? questions. Everything else makes a facinating read but is less
>> ??? likely to
>> ??? help us make progress (and may obscure/hide actual answers and test
>> ??? results). I will restate those remaining questions for your 
>> convenience:
>>
>> ??? * Do all those 12 access.log records correspond to a single curl
>> ??? request? If not, please only share access.log record(s) that do
>> ??? correspond.
>>
>> ??? 2. Does everything work for non-intercept ports? Use the same curl 
>> test
>> ??? you have shared below, but specify proxy address for curl to use.
>>
>> ??? 4. Does everything work when you remove "ssl-bump" and related 
>> options
>> ??? from intercepting http_port 33128 (and use that intercepted port 
>> in the
>> ??? same curl test)?
>>
>> ??? 5. Does everything work when you use "ssl_bump splice all" instead of
>> ??? your current ssl_bump rule? Same curl parameters as in Q4.
>>
>> ??? 6. Does everything work when you use "ssl_bump peek all" instead of
>> ??? your
>> ??? current ssl_bump rule? Same curl parameters as in Q4.
>>
>>
>> ??? While going through the above list, top to bottom, if you find a test
>> ??? that does _not_ work, pause: There is no need to proceed with other,
>> ??? more complicated tests if an earlier simpler/basic test fails.
>>
>>
>> ??? HTH,
>>
>> ??? Alex.
>>
>>
>> ???? > I was thinking that maybe it's something with the OpenSSL version
>> ??? (3.x.x) on Fedora but then I installed both 5.9 and 6.10 on
>> ??? Almalinux 8 and the result is the same.
>> ???? >
>> ???? > I will describe my setup which might give some background.
>> ???? > I have a very big lab...
>> ???? > In the front of the Internet connection there are couple NGFW
>> ??? devices and RouterOS.
>> ???? > Mikrotik RouterOS is the edge and all the others are used with
>> ??? PBR accordingly.
>> ???? > The proxy sits in a deferent segment on the network and I have
>> ??? tried couple methods to intercept the traffic with squid.
>> ???? > The only one which works with Squid and the existing equipment
>> ??? and do not cause some weird loop is ethernet level tunnel ie not:
>> ???? > * GRE
>> ???? > * IPIP
>> ???? > And couple others.
>> ???? >
>> ???? > The only ones which works fine are:
>> ???? > * EoIP (Mikrotik which is based on GRE0
>> ???? > * VxLAN
>> ???? >
>> ???? > There are two methods to intercept the traffic:
>> ???? > * PBR+DNAT on the squid box
>> ???? > * PBR+TPROXY on the squid box
>> ???? >
>> ???? > Since the intercept method terminates the connection and creates
>> ??? a new one with the ip of the proxy it's very simple to even use gre
>> ??? and ipip.
>> ???? > But, with tproxy to allow the traffic being identified currently
>> ??? as a packet which is not still in the routing stack we the linux OS
>> ??? need to tag it somehow.
>> ???? > To do that the default "Salt" for the packet hash in the routing
>> ??? stack is the source and destination mac address.
>> ???? > Due to this the only methods which are allowing to use tproxy are
>> ??? the above mentioned tunnels. (Maybe I will post a video on it later
>> ??? on with a demo)
>> ???? >
>> ???? > The Mikrotik RouterOS device re-routes the traffic from the LAN
>> ??? interface into the VxLAN interface directly to the proxy machine
>> ??? which has a
>> ???? > static or dynamic route to the LAN subnet via the other side of
>> ??? the VxLAN tunnel which is the edge RouterOS device.
>> ???? > I want to gather a set of configurations and tests for this
>> ??? configurations to verify what might cause this issue and if possible
>> ??? to resolve it.
>> ???? > For me it seems that if my FortiGate and CheckPoint devices are
>> ??? able to intercept the traffic and "Bump" it, there is no reason why
>> ??? squid should
>> ???? > be able to do that the same way.
>> ???? >
>> ???? > I will later on send you a private link to the pcaps in a zip
>> ??? file so you would be able to inspect this issue in the network level
>> ??? and to see if there is
>> ???? > some details which can help us understand what cause this
>> ??? specific issue.
>> ???? >
>> ???? > I want to say that bumping works fine on non-intercepted
>> ??? connections and that I have tested the interception with the two
>> ??? available methods ie:
>> ???? > * DNAT Redirect
>> ???? > * Tproxy
>> ???? >
>> ???? > Thanks,
>> ???? > Eliezer Croitoru
>> ???? >
>> ???? > -----Original Message-----
>> ???? > From: Alex Rousskov <rousskov at measurement-factory.com
>> ??? <mailto:rousskov at measurement-factory.com>>
>> ???? > Sent: Monday, August 19, 2024 7:18 PM
>> ???? > To: NgTech LTD <ngtech1ltd at gmail.com 
>> <mailto:ngtech1ltd at gmail.com>>
>> ???? > Subject: Re: [squid-users] Squid 6.10 on Fedora 40 cannot
>> ??? intercept and bump SSL Traffic
>> ???? >
>> ???? > Eliezer, please move this thread back to squid-users mailing list
>> ???? > instead of emailing me personally. When you do so, please clarify
>> ???? > whether all 12 access.log records correspond to this single curl
>> ??? request
>> ???? > (if not, please only share access.log record(s) that do
>> ??? correspond). --Alex.
>> ???? >
>> ???? > On 2024-08-19 12:03, NgTech LTD wrote:
>> ???? >> This is the output of curl on windows 11 desktop:
>> ???? >> C:\Users\USER>curl https://www.youtube.com/
>> ??? <https://www.youtube.com/> -k -v -o 1.txt
>> ???? >>? ? ?% Total? ? % Received % Xferd? Average Speed? ?Time    
>> Time ???? ? ?Time
>> ???? >>? ? Current
>> ???? >>? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? ? Dload? Upload? ?Total      
>> ?Spent? ? Left
>> ???? >>? ? Speed
>> ???? >>? ? ?0? ? ?0? ? 0? ? ?0? ? 0? ? ?0? ? ? 0? ? ? 0 --:--:-- --:--:--
>> ???? >> --:--:--? ? ?0* Host www.youtube.com:443
>> ??? <http://www.youtube.com:443> <http://www.youtube.com:443
>> ??? <http://www.youtube.com:443>>
>> ???? >> was resolved.
>> ???? >> * IPv6: 2a00:1450:4001:800::200e, 2a00:1450:4001:80e::200e,
>> ???? >> 2a00:1450:4001:81c::200e, 2a00:1450:4001:809::200e
>> ???? >> * IPv4: 142.250.185.78, 142.250.185.110, 142.250.185.142,
>> ???? >> 142.250.186.174, 142.250.185.174, 142.250.184.238, 
>> 142.250.185.238,
>> ???? >> 142.250.185.206, 142.250.181.238, 142.250.186.46, 142.250.186.78,
>> ???? >> 172.217.16.142, 216.58.212.174, 216.58.206.46, 172.217.23.110,
>> ???? >> 216.58.212.142
>> ???? >> *? ?Trying 142.250.185.78:443...
>> ???? >> * Connected to www.youtube.com <http://www.youtube.com>
>> ??? <http://www.youtube.com <http://www.youtube.com>> (142.250.185.78)
>> ???? >> port 443
>> ???? >> * schannel: disabled automatic use of client certificate
>> ???? >> * ALPN: curl offers http/1.1
>> ???? >> * ALPN: server accepted http/1.1
>> ???? >> * using HTTP/1.x
>> ???? >>? ?> GET / HTTP/1.1
>> ???? >>? ?> Host: www.youtube.com <http://www.youtube.com>
>> ??? <http://www.youtube.com <http://www.youtube.com>>
>> ???? >>? ?> User-Agent: curl/8.8.0
>> ???? >>? ?> Accept: */*
>> ???? >>? ?>
>> ???? >> * Request completely sent off
>> ???? >> * schannel: remote party requests renegotiation
>> ???? >> * schannel: renegotiating SSL/TLS connection
>> ???? >> * schannel: SSL/TLS connection renegotiated
>> ???? >> * schannel: failed to decrypt data, need more data
>> ???? >> < HTTP/1.1 200 OK
>> ???? >> < Content-Type: text/html; charset=utf-8
>> ???? >> < X-Content-Type-Options: nosniff
>> ???? >> < Cache-Control: no-cache, no-store, max-age=0, must-revalidate
>> ???? >> < Pragma: no-cache
>> ???? >> < Expires: Mon, 01 Jan 1990 00:00:00 GMT
>> ???? >> < Date: Mon, 19 Aug 2024 16:02:23 GMT
>> ???? >> < X-Frame-Options: SAMEORIGIN
>> ???? >> < Strict-Transport-Security: max-age=31536000
>> ???? >> < Origin-Trial:
>> ???? >>
>>     
>> AmhMBR6zCLzDDxpW+HfpP67BqwIknWnyMOXOQGfzYswFmJe+fgaI6XZgAzcxOrzNtP7hEDsOo1jdjFnVr2IdxQ4AAAB4eyJvcmlnaW4iOiJodHRwczovL3lvdXR1YmUuY29tOjQ0MyIsImZlYXR1cmUiOiJXZWJWaWV3WFJlcXVlc3RlZFdpdGhEZXByZWNhdGlvbiIsImV4cGlyeSI6MTc1ODA2NzE5OSwiaXNTdWJkb21haW4iOnRydWV9
>> ???? >> < Cross-Origin-Opener-Policy: same-origin-allow-popups;
>> ???? >> report-to="youtube_main"
>> ???? >> < Report-To:
>> ???? >>
>>     
>> {"group":"youtube_main","max_age":2592000,"endpoints":[{"url":"https://csp.withgoogle.com/csp/report-to/youtube_main <https://csp.withgoogle.com/csp/report-to/youtube_main> <https://csp.withgoogle.com/csp/report-to/youtube_main <https://csp.withgoogle.com/csp/report-to/youtube_main>>"}]}
>> ???? >> < Content-Security-Policy: require-trusted-types-for 'script'
>> ???? >> < Permissions-Policy: ch-ua-arch=*, ch-ua-bitness=*,
>> ???? >> ch-ua-full-version=*, ch-ua-full-version-list=*, ch-ua-model=*,
>> ???? >> ch-ua-wow64=*, ch-ua-form-factors=*, ch-ua-platform=*,
>> ???? >> ch-ua-platform-version=*
>> ???? >> < P3P: CP="This is not a P3P policy! See
>> ???? >> http://support.google.com/accounts/answer/151657?hl=en
>> ??? <http://support.google.com/accounts/answer/151657?hl=en>
>> ???? >> <http://support.google.com/accounts/answer/151657?hl=en
>> ??? <http://support.google.com/accounts/answer/151657?hl=en>> for more
>> ??? info."
>> ???? >> < Server: ESF
>> ???? >> < X-XSS-Protection: 0
>> ???? >> < Set-Cookie: GPS=1; Domain=.youtube.com <http://youtube.com>
>> ??? <http://youtube.com <http://youtube.com>>;
>> ???? >> Expires=Mon, 19-Aug-2024 16:32:23 GMT; Path=/; Secure; HttpOnly
>> ???? >> < Set-Cookie: YSC=XYs_jViLkFw; Domain=.youtube.com
>> ??? <http://youtube.com> <http://youtube.com <http://youtube.com>>;
>> ???? >> Path=/; Secure; HttpOnly; SameSite=none
>> ???? >> < Set-Cookie: VISITOR_INFO1_LIVE=csMabhlNyrI;
>> ??? Domain=.youtube.com <http://youtube.com>
>> ???? >> <http://youtube.com <http://youtube.com>>; Expires=Sat,
>> ??? 15-Feb-2025 16:02:23 GMT; Path=/;
>> ???? >> Secure; HttpOnly; SameSite=none
>> ???? >> < Set-Cookie: VISITOR_PRIVACY_METADATA=CgJJTBIEGgAgVw%3D%3D;
>> ???? >> Domain=.youtube.com <http://youtube.com> <http://youtube.com
>> ??? <http://youtube.com>>; Expires=Sat, 15-Feb-2025
>> ???? >> 16:02:23 GMT; Path=/; Secure; HttpOnly; SameSite=none
>> ???? >> < Alt-Svc: h3=":443"; ma=2592000,h3-29=":443"; ma=2592000
>> ???? >> < Accept-Ranges: none
>> ???? >> < Vary: Accept-Encoding
>> ???? >> < Transfer-Encoding: chunked
>> ???? >> <
>> ???? >> { [3674 bytes data]
>> ???? >> * schannel: failed to decrypt data, need more data
>> ???? >> { [8008 bytes data]
>> ???? >> * schannel: failed to decrypt data, need more data
>> ???? >> { [6880 bytes data]
>> ???? >> * schannel: failed to decrypt data, need more data
>> ???? >> { [2752 bytes data]
>> ???? >> * schannel: failed to decrypt data, need more data
>> ???? >> { [5504 bytes data]
>> ???? >> * schannel: failed to decrypt data, need more data
>> ???? >> { [2462 bytes data]
>> ???? >> * schannel: failed to decrypt data, need more data
>> ???? >> { [4128 bytes data]
>> ???? >> * schannel: failed to decrypt data, need more data
>> ???? >> { [2752 bytes data]
>> ???? >> * schannel: failed to decrypt data, need more data
>> ???? >> { [2752 bytes data]
>> ???? >> * schannel: failed to decrypt data, need more data
>> ???? >> { [4128 bytes data]
>> ???? >> * schannel: failed to decrypt data, need more data
>> ???? >> { [2752 bytes data]
>> ???? >> * schannel: failed to decrypt data, need more data
>> ???? >> { [5504 bytes data]
>> ???? >> * schannel: failed to decrypt data, need more data
>> ???? >> { [5504 bytes data]
>> ???? >> * schannel: failed to decrypt data, need more data
>> ???? >> { [4128 bytes data]
>> ???? >> * schannel: failed to decrypt data, need more data
>> ???? >> { [5242 bytes data]
>> ???? >> * schannel: failed to decrypt data, need more data
>> ???? >> { [2752 bytes data]
>> ???? >> * schannel: failed to decrypt data, need more data
>> ???? >> { [2752 bytes data]
>> ???? >> * schannel: failed to decrypt data, need more data
>> ???? >> { [6922 bytes data]
>> ???? >> * schannel: failed to decrypt data, need more data
>> ???? >> { [2752 bytes data]
>> ???? >> * schannel: failed to decrypt data, need more data
>> ???? >> { [6880 bytes data]
>> ???? >> * schannel: failed to decrypt data, need more data
>> ???? >> { [20378 bytes data]
>> ???? >> * schannel: failed to decrypt data, need more data
>> ???? >> { [6880 bytes data]
>> ???? >> * schannel: failed to decrypt data, need more data
>> ???? >> { [5504 bytes data]
>> ???? >> * schannel: failed to decrypt data, need more data
>> ???? >> { [5504 bytes data]
>> ???? >> * schannel: failed to decrypt data, need more data
>> ???? >> { [3839 bytes data]
>> ???? >> * schannel: failed to decrypt data, need more data
>> ???? >> { [6880 bytes data]
>> ???? >> * schannel: failed to decrypt data, need more data
>> ???? >> { [9632 bytes data]
>> ???? >> * schannel: failed to decrypt data, need more data
>> ???? >> { [6880 bytes data]
>> ???? >> * schannel: failed to decrypt data, need more data
>> ???? >> { [2752 bytes data]
>> ???? >> * schannel: failed to decrypt data, need more data
>> ???? >> { [7994 bytes data]
>> ???? >> 100? 193k? ? 0? 193k? ? 0? ? ?0? ?293k? ? ? 0 --:--:-- --:--:--
>> ??? --:--:--
>> ???? >>? ? 294k* schannel: failed to decrypt data, need more data
>> ???? >> { [28937 bytes data]
>> ???? >> * schannel: failed to decrypt data, need more data
>> ???? >> { [8414 bytes data]
>> ???? >> * schannel: failed to decrypt data, need more data
>> ???? >> { [9632 bytes data]
>> ???? >> * schannel: failed to decrypt data, need more data
>> ???? >> { [5504 bytes data]
>> ???? >> * schannel: failed to decrypt data, need more data
>> ???? >> { [5504 bytes data]
>> ???? >> * schannel: failed to decrypt data, need more data
>> ???? >> { [7852 bytes data]
>> ???? >> * schannel: failed to decrypt data, need more data
>> ???? >> { [5504 bytes data]
>> ???? >> * schannel: failed to decrypt data, need more data
>> ???? >> { [17888 bytes data]
>> ???? >> * schannel: failed to decrypt data, need more data
>> ???? >> { [19016 bytes data]
>> ???? >> * schannel: failed to decrypt data, need more data
>> ???? >> { [15136 bytes data]
>> ???? >> * schannel: failed to decrypt data, need more data
>> ???? >> { [10760 bytes data]
>> ???? >> * schannel: failed to decrypt data, need more data
>> ???? >> { [6880 bytes data]
>> ???? >> * schannel: failed to decrypt data, need more data
>> ???? >> { [34152 bytes data]
>> ???? >> * schannel: failed to decrypt data, need more data
>> ???? >> { [28648 bytes data]
>> ???? >> * schannel: failed to decrypt data, need more data
>> ???? >> { [33026 bytes data]
>> ???? >> * schannel: failed to decrypt data, need more data
>> ???? >> { [14888 bytes data]
>> ???? >> * schannel: failed to decrypt data, need more data
>> ???? >> { [24768 bytes data]
>> ???? >> * schannel: failed to decrypt data, need more data
>> ???? >> { [12136 bytes data]
>> ???? >> 100? 498k? ? 0? 498k? ? 0? ? ?0? ?665k? ? ? 0 --:--:-- --:--:--
>> ??? --:--:--
>> ???? >>? ? 669k
>> ???? >> * Connection #0 to host www.youtube.com <http://www.youtube.com>
>> ??? <http://www.youtube.com <http://www.youtube.com>> left intact
>> ???? >>
>> ???? >> And the access.log:
>> ???? >> 1724083303.298? ? ? 0 192.168.78.15 NONE_NONE/000 0 -
>> ???? >> error:invalid-request - HIER_NONE/- - -
>> ???? >> 1724083303.888? ? 589 192.168.78.15 TCP_TUNNEL/200 529157 CONNECT
>> ???? >> 142.250.185.78:443 <http://142.250.185.78:443>
>> ??? <http://142.250.185.78:443 <http://142.250.185.78:443>> -
>> ???? >> ORIGINAL_DST/142.250.185.78 <http://142.250.185.78>
>> ??? <http://142.250.185.78 <http://142.250.185.78>> - -
>> ???? >> 1724083307.305? ? ? 0 192.168.78.15 NONE_NONE/000 0 -
>> ???? >> error:invalid-request - HIER_NONE/- - -
>> ???? >> 1724083307.908? ? 603 192.168.78.15 TCP_TUNNEL/200 530241 CONNECT
>> ???? >> 142.250.185.78:443 <http://142.250.185.78:443>
>> ??? <http://142.250.185.78:443 <http://142.250.185.78:443>> -
>> ???? >> ORIGINAL_DST/142.250.185.78 <http://142.250.185.78>
>> ??? <http://142.250.185.78 <http://142.250.185.78>> - -
>> ???? >> 1724083311.615? ? ? 0 192.168.78.15 NONE_NONE/000 0 -
>> ???? >> error:invalid-request - HIER_NONE/- - -
>> ???? >> 1724083312.255? ? 640 192.168.78.15 TCP_TUNNEL/200 528465 CONNECT
>> ???? >> 142.250.185.78:443 <http://142.250.185.78:443>
>> ??? <http://142.250.185.78:443 <http://142.250.185.78:443>> -
>> ???? >> ORIGINAL_DST/142.250.185.78 <http://142.250.185.78>
>> ??? <http://142.250.185.78 <http://142.250.185.78>> - -
>> ???? >> 1724083316.666? ? ? 0 192.168.78.15 NONE_NONE/000 0 -
>> ???? >> error:invalid-request - HIER_NONE/- - -
>> ???? >> 1724083317.315? ? 649 192.168.78.15 TCP_TUNNEL/200 529617 CONNECT
>> ???? >> 142.250.185.78:443 <http://142.250.185.78:443>
>> ??? <http://142.250.185.78:443 <http://142.250.185.78:443>> -
>> ???? >> ORIGINAL_DST/142.250.185.78 <http://142.250.185.78>
>> ??? <http://142.250.185.78 <http://142.250.185.78>> - -
>> ???? >> 1724083342.731? ? ? 0 192.168.78.15 NONE_NONE/000 0 -
>> ???? >> error:invalid-request - HIER_NONE/- - -
>> ???? >> 1724083343.377? ? 645 192.168.78.15 TCP_TUNNEL/200 528377 CONNECT
>> ???? >> 142.250.185.78:443 <http://142.250.185.78:443>
>> ??? <http://142.250.185.78:443 <http://142.250.185.78:443>> -
>> ???? >> ORIGINAL_DST/142.250.185.78 <http://142.250.185.78>
>> ??? <http://142.250.185.78 <http://142.250.185.78>> - -
>> ???? >> 1724083378.565? ? ? 0 192.168.78.15 NONE_NONE/000 0 -
>> ???? >> error:invalid-request - HIER_NONE/- - -
>> ???? >> 1724083378.801? ? ? 0 192.168.78.15 NONE_NONE/000 0 -
>> ???? >> error:invalid-request - HIER_NONE/- - -
>> ???? >>
>> ???? >>
>> ???? >> ----
>> ???? >> Eliezer Croitoru
>> ???? >> Tech Support
>> ???? >> Mobile: +972-5-28704261
>> ???? >> Email: ngtech1ltd at gmail.com <mailto:ngtech1ltd at gmail.com>
>> ??? <mailto:ngtech1ltd at gmail.com <mailto:ngtech1ltd at gmail.com>>
>> ???? >>
>> ???? >>
>> ???? >> On Mon, Aug 19, 2024 at 3:21?PM Alex Rousskov
>> ???? >> <rousskov at measurement-factory.com
>> ??? <mailto:rousskov at measurement-factory.com>
>> ???? >> <mailto:rousskov at measurement-factory.com
>> ??? <mailto:rousskov at measurement-factory.com>>> wrote:
>> ???? >>
>> ???? >>? ? ? On 2024-08-19 03:47, NgTech LTD wrote:
>> ???? >>? ? ? ?> I am testing Squid 6.10 on Fedora 40 (their package).
>> ???? >>? ? ? ?> And it seems that Squid is unable to bump clients
>> ??? (ESNI/ECH)?
>> ???? >>? ? ? ?>
>> ???? >>? ? ? ?> I had couple iterations of pek stare and bump and I am
>> ??? not sure
>> ???? >>? ? ? what is
>> ???? >>? ? ? ?> the reason for that:
>> ???? >>
>> ???? >>? ? ? What do you use as a client? Judging by the number of
>> ???? >>? ? ? error:invalid-request entries in your access.log, that
>> ??? client may
>> ???? >>? ? ? not be
>> ???? >>? ? ? speaking HTTP/1 inside those CONNECT tunnels.
>> ???? >>
>> ???? >>? ? ? Does everything work for non-intercept ports?
>> ???? >>
>> ???? >>? ? ? Does everything work in a basic curl or wget test?
>> ???? >>
>> ???? >>? ? ? Does everything work when you remove "ssl-bump" and related
>> ??? options
>> ???? >>? ? ? from
>> ???? >>? ? ? intercepting http_port 33128?
>> ???? >>
>> ???? >>? ? ? Does everything work when you use "ssl_bump splice all"
>> ??? instead of your
>> ???? >>? ? ? current ssl_bump rule?
>> ???? >>
>> ???? >>? ? ? Does everything work when you use "ssl_bump peek all"
>> ??? instead of your
>> ???? >>? ? ? current ssl_bump rule?
>> ???? >>
>> ???? >>? ? ? Alex.
>> ???? >>
>> ???? >>
>> ???? >>? ? ? ?> shutdown_lifetime 3 seconds
>> ???? >>? ? ? ?> external_acl_type whitelist-lookup-helper ipv4 ttl=10
>> ???? >>? ? ? children-max=10
>> ???? >>? ? ? ?> children-startup=2 \
>> ???? >>? ? ? ?>? ? ? ? ? children-idle=2 concurrency=10 %URI %SRC
>> ???? >>? ? ? ?> /usr/local/bin/squid-conf-url-lookup.rb
>> ???? >>? ? ? ?> acl whitelist-lookup external? whitelist-lookup-helper
>> ???? >>? ? ? ?> acl ytmethods method POST GET
>> ???? >>? ? ? ?> acl localnet src 0.0.0.1-0.255.255.255? # RFC 1122
>> ??? "this" network
>> ???? >>? ? ? (LAN)
>> ???? >>? ? ? ?> acl localnet src 10.0.0.0/8 <http://10.0.0.0/8>
>> ??? <http://10.0.0.0/8 <http://10.0.0.0/8>>
>> ???? >>? ? ? <http://10.0.0.0/8 <http://10.0.0.0/8> <http://10.0.0.0/8
>> ??? <http://10.0.0.0/8>>>? ? ? ? ? ? ?# RFC 1918
>> ???? >>? ? ? ?> local private network (LAN)
>> ???? >>? ? ? ?> acl localnet src 100.64.0.0/10 <http://100.64.0.0/10>
>> ??? <http://100.64.0.0/10 <http://100.64.0.0/10>>
>> ???? >>? ? ? <http://100.64.0.0/10 <http://100.64.0.0/10>
>> ??? <http://100.64.0.0/10 <http://100.64.0.0/10>>>? ? ? ? ? # RFC
>> ???? >>? ? ? ?> 6598 shared address space (CGN)
>> ???? >>? ? ? ?> acl localnet src 169.254.0.0/16 <http://169.254.0.0/16>
>> ??? <http://169.254.0.0/16 <http://169.254.0.0/16>>
>> ???? >>? ? ? <http://169.254.0.0/16 <http://169.254.0.0/16>
>> ??? <http://169.254.0.0/16 <http://169.254.0.0/16>>>? ? ? ? ?# RFC
>> ???? >>? ? ? ?> 3927 link-local (directly plugged) machines
>> ???? >>? ? ? ?> acl localnet src 172.16.0.0/12 <http://172.16.0.0/12>
>> ??? <http://172.16.0.0/12 <http://172.16.0.0/12>>
>> ???? >>? ? ? <http://172.16.0.0/12 <http://172.16.0.0/12>
>> ??? <http://172.16.0.0/12 <http://172.16.0.0/12>>>? ? ? ? ? # RFC
>> ???? >>? ? ? ?> 1918 local private network (LAN)
>> ???? >>? ? ? ?> acl localnet src 192.168.0.0/16 <http://192.168.0.0/16>
>> ??? <http://192.168.0.0/16 <http://192.168.0.0/16>>
>> ???? >>? ? ? <http://192.168.0.0/16 <http://192.168.0.0/16>
>> ??? <http://192.168.0.0/16 <http://192.168.0.0/16>>>? ? ? ? ?# RFC
>> ???? >>? ? ? ?> 1918 local private network (LAN)
>> ???? >>? ? ? ?> acl localnet src fc00::/7? ? ? ? ? ? ? ?# RFC 4193 local
>> ??? private
>> ???? >>? ? ? network
>> ???? >>? ? ? ?> range
>> ???? >>? ? ? ?> acl localnet src fe80::/10? ? ? ? ? ? ? # RFC 4291
>> ??? link-local
>> ???? >>? ? ? (directly
>> ???? >>? ? ? ?> plugged) machines
>> ???? >>? ? ? ?> acl SSL_ports port 443
>> ???? >>? ? ? ?> acl Safe_ports port 80? ? ? ? ? # http
>> ???? >>? ? ? ?> acl Safe_ports port 21? ? ? ? ? # ftp
>> ???? >>? ? ? ?> acl Safe_ports port 443? ? ? ? ?# https
>> ???? >>? ? ? ?> acl Safe_ports port 70? ? ? ? ? # gopher
>> ???? >>? ? ? ?> acl Safe_ports port 210? ? ? ? ?# wais
>> ???? >>? ? ? ?> acl Safe_ports port 1025-65535? # unregistered ports
>> ???? >>? ? ? ?> acl Safe_ports port 280? ? ? ? ?# http-mgmt
>> ???? >>? ? ? ?> acl Safe_ports port 488? ? ? ? ?# gss-http
>> ???? >>? ? ? ?> acl Safe_ports port 591? ? ? ? ?# filemaker
>> ???? >>? ? ? ?> acl Safe_ports port 777? ? ? ? ?# multiling http
>> ???? >>? ? ? ?> http_access deny !Safe_ports
>> ???? >>? ? ? ?> http_access deny CONNECT !SSL_ports
>> ???? >>? ? ? ?> http_access allow localhost manager
>> ???? >>? ? ? ?> http_access deny manager
>> ???? >>? ? ? ?> http_access allow localhost
>> ???? >>? ? ? ?> http_access deny to_localhost
>> ???? >>? ? ? ?> http_access deny to_linklocal
>> ???? >>? ? ? ?> acl tubedoms dstdomain .ytimg.com <http://ytimg.com>
>> ??? <http://ytimg.com <http://ytimg.com>>
>> ???? >>? ? ? <http://ytimg.com <http://ytimg.com> <http://ytimg.com
>> ??? <http://ytimg.com>>> .youtube.com <http://youtube.com>
>> ??? <http://youtube.com <http://youtube.com>>
>> ???? >>? ? ? ?> <http://youtube.com <http://youtube.com>
>> ??? <http://youtube.com <http://youtube.com>>> .youtu.be 
>> <http://youtu.be>
>> ???? >>? ? ? <http://youtu.be <http://youtu.be>> <http://youtu.be
>> ??? <http://youtu.be> <http://youtu.be <http://youtu.be>>>
>> ???? >>? ? ? ?> http_access allow ytmethods localnet tubedoms
>> ??? whitelist-lookup
>> ???? >>? ? ? ?> http_access allow localnet
>> ???? >>? ? ? ?> http_access deny all
>> ???? >>? ? ? ?> http_port 3128
>> ???? >>? ? ? ?> http_port 13128 ssl-bump tls-cert=/etc/squid/ssl/cert.pem
>> ???? >>? ? ? ?> tls-key=/etc/squid/ssl/key.pem \
>> ???? >>? ? ? ?>? ? ? ? ? generate-host-certificates=on
>> ???? >>? ? ? dynamic_cert_mem_cache_size=4MB
>> ???? >>? ? ? ?> http_port 23128 tproxy ssl-bump
>> ??? tls-cert=/etc/squid/ssl/cert.pem
>> ???? >>? ? ? ?> tls-key=/etc/squid/ssl/key.pem \
>> ???? >>? ? ? ?>? ? ? ? ? generate-host-certificates=on
>> ???? >>? ? ? dynamic_cert_mem_cache_size=4MB
>> ???? >>? ? ? ?> http_port 33128 intercept ssl-bump
>> ??? tls-cert=/etc/squid/ssl/cert.pem
>> ???? >>? ? ? ?> tls-key=/etc/squid/ssl/key.pem \
>> ???? >>? ? ? ?>? ? ? ? ? generate-host-certificates=on
>> ???? >>? ? ? dynamic_cert_mem_cache_size=4MB
>> ???? >>? ? ? ?> sslcrtd_program /usr/lib64/squid/security_file_certgen -s
>> ???? >>? ? ? ?> /var/spool/squid/ssl_db -M 4MB
>> ???? >>? ? ? ?> sslcrtd_children 5
>> ???? >>? ? ? ?> acl foreignProtocol squid_error ERR_PROTOCOL_UNKNOWN
>> ??? ERR_TOO_BIG
>> ???? >>? ? ? ?> acl serverTalksFirstProtocol squid_error
>> ??? ERR_REQUEST_START_TIMEOUT
>> ???? >>? ? ? ?> on_unsupported_protocol tunnel foreignProtocol
>> ???? >>? ? ? ?> on_unsupported_protocol tunnel serverTalksFirstProtocol
>> ???? >>? ? ? ?> on_unsupported_protocol respond all
>> ???? >>? ? ? ?> acl monitoredSites ssl::server_name .youtube.com
>> ??? <http://youtube.com>
>> ???? >>? ? ? <http://youtube.com <http://youtube.com>>
>> ??? <http://youtube.com <http://youtube.com> <http://youtube.com
>> ??? <http://youtube.com>>>
>> ???? >>? ? ? ?> .ytimg.com <http://ytimg.com> <http://ytimg.com
>> ??? <http://ytimg.com>> <http://ytimg.com <http://ytimg.com>
>> ??? <http://ytimg.com <http://ytimg.com>>>
>> ???? >>? ? ? ?> acl monitoredSitesRegex ssl::server_name_regex
>> ??? \.youtube\.com
>> ???? >>? ? ? \.ytimg\.com
>> ???? >>? ? ? ?> acl serverIsBank ssl::server_name .visa.com
>> ??? <http://visa.com> <http://visa.com <http://visa.com>>
>> ???? >>? ? ? <http://visa.com <http://visa.com> <http://visa.com
>> ??? <http://visa.com>>>
>> ???? >>? ? ? ?> acl step1 at_step SslBump1
>> ???? >>? ? ? ?> acl step2 at_step SslBump2
>> ???? >>? ? ? ?> acl step3 at_step SslBump3
>> ???? >>? ? ? ?> ssl_bump bump all
>> ???? >>? ? ? ?> strip_query_terms off
>> ???? >>? ? ? ?> coredump_dir /var/spool/squid
>> ???? >>? ? ? ?> refresh_pattern ^ftp:? ? ? ? ? ?1440? ? 20%? ? ?10080
>> ???? >>? ? ? ?> refresh_pattern -i (/cgi-bin/|\?) 0? ? ?0%? ? ? 0
>> ???? >>? ? ? ?> refresh_pattern .? ? ? ? ? ? ? ?0? ? ? ?20%? ? ?4320
>> ???? >>? ? ? ?> logformat ssl_custom_format %ts.%03tu %6tr %>a
>> ??? %Ss/%03>Hs %<st
>> ???? >>? ? ? %rm %ru
>> ???? >>? ? ? ?> %[un %Sh/%<a %mt %ssl::>sni
>> ???? >>? ? ? ?> access_log daemon:/var/log/squid/access.log
>> ??? ssl_custom_format
>> ???? >>? ? ? ?> ##EOF
>> ???? >>? ? ? ?>
>> ???? >>? ? ? ?> access.log from before:
>> ???? >>? ? ? ?> 1724028804.797? ? 486 192.168.78.15 TCP_TUNNEL/200 17764
>> ??? CONNECT
>> ???? >>? ? ? ?> 40.126.31.73:443 <http://40.126.31.73:443>
>> ??? <http://40.126.31.73:443 <http://40.126.31.73:443>>
>> ???? >>? ? ? <http://40.126.31.73:443 <http://40.126.31.73:443>
>> ??? <http://40.126.31.73:443 <http://40.126.31.73:443>>> -
>> ???? >>? ? ? ORIGINAL_DST/40.126.31.73 <http://40.126.31.73>
>> ??? <http://40.126.31.73 <http://40.126.31.73>>
>> ???? >>? ? ? ?> <http://40.126.31.73 <http://40.126.31.73>
>> ??? <http://40.126.31.73 <http://40.126.31.73>>> - -
>> ???? >>? ? ? ?> 1724028805.413? ? ? 0 192.168.78.15 NONE_NONE/000 0 -
>> ???? >>? ? ? ?> error:invalid-request - HIER_NONE/- - -
>> ???? >>? ? ? ?> 1724028806.028? ? ? 0 192.168.78.15 NONE_NONE/000 0 -
>> ???? >>? ? ? ?> error:invalid-request - HIER_NONE/- - -
>> ???? >>? ? ? ?> 1724028806.028? ? ? 0 192.168.78.15 NONE_NONE/000 0 -
>> ???? >>? ? ? ?> error:invalid-request - HIER_NONE/- - -
>> ???? >>? ? ? ?> 1724028806.029? ? ? 0 192.168.78.15 NONE_NONE/000 0 -
>> ???? >>? ? ? ?> error:invalid-request - HIER_NONE/- - -
>> ???? >>? ? ? ?> 1724028806.030? ? ? 0 192.168.78.15 NONE_NONE/000 0 -
>> ???? >>? ? ? ?> error:invalid-request - HIER_NONE/- - -
>> ???? >>? ? ? ?> 1724028806.085? ? ?57 192.168.78.15 TCP_TUNNEL/200 4513
>> ??? CONNECT
>> ???? >>? ? ? ?> 104.18.72.113:443 <http://104.18.72.113:443>
>> ??? <http://104.18.72.113:443 <http://104.18.72.113:443>>
>> ???? >>? ? ? <http://104.18.72.113:443 <http://104.18.72.113:443>
>> ??? <http://104.18.72.113:443 <http://104.18.72.113:443>>> -
>> ???? >>? ? ? ?> ORIGINAL_DST/104.18.72.113 <http://104.18.72.113>
>> ??? <http://104.18.72.113 <http://104.18.72.113>>
>> ???? >>? ? ? <http://104.18.72.113 <http://104.18.72.113>
>> ??? <http://104.18.72.113 <http://104.18.72.113>>> - -
>> ???? >>? ? ? ?> 1724028806.086? ? ?56 192.168.78.15 TCP_TUNNEL/200 4513
>> ??? CONNECT
>> ???? >>? ? ? ?> 104.18.72.113:443 <http://104.18.72.113:443>
>> ??? <http://104.18.72.113:443 <http://104.18.72.113:443>>
>> ???? >>? ? ? <http://104.18.72.113:443 <http://104.18.72.113:443>
>> ??? <http://104.18.72.113:443 <http://104.18.72.113:443>>> -
>> ???? >>? ? ? ?> ORIGINAL_DST/104.18.72.113 <http://104.18.72.113>
>> ??? <http://104.18.72.113 <http://104.18.72.113>>
>> ???? >>? ? ? <http://104.18.72.113 <http://104.18.72.113>
>> ??? <http://104.18.72.113 <http://104.18.72.113>>> - -
>> ???? >>? ? ? ?> 1724028806.086? ? ?56 192.168.78.15 TCP_TUNNEL/200 4512
>> ??? CONNECT
>> ???? >>? ? ? ?> 104.18.72.113:443 <http://104.18.72.113:443>
>> ??? <http://104.18.72.113:443 <http://104.18.72.113:443>>
>> ???? >>? ? ? <http://104.18.72.113:443 <http://104.18.72.113:443>
>> ??? <http://104.18.72.113:443 <http://104.18.72.113:443>>> -
>> ???? >>? ? ? ?> ORIGINAL_DST/104.18.72.113 <http://104.18.72.113>
>> ??? <http://104.18.72.113 <http://104.18.72.113>>
>> ???? >>? ? ? <http://104.18.72.113 <http://104.18.72.113>
>> ??? <http://104.18.72.113 <http://104.18.72.113>>> - -
>> ???? >>? ? ? ?> 1724028806.208? ? ? 0 192.168.78.15 NONE_NONE/000 0 -
>> ???? >>? ? ? ?> error:invalid-request - HIER_NONE/- - -
>> ???? >>? ? ? ?> 1724028806.213? ? ? 0 192.168.78.15 NONE_NONE/000 0 -
>> ???? >>? ? ? ?> error:invalid-request - HIER_NONE/- - -
>> ???? >>? ? ? ?> 1724028806.338? ? ? 0 192.168.78.15 NONE_NONE/000 0 -
>> ???? >>? ? ? ?> error:invalid-request - HIER_NONE/- - -
>> ???? >>? ? ? ?> 1724028806.469? ? ? 0 192.168.78.15 NONE_NONE/000 0 -
>> ???? >>? ? ? ?> error:invalid-request - HIER_NONE/- - -
>> ???? >>? ? ? ?> 1724028806.596? ? ? 0 192.168.78.15 NONE_NONE/000 0 -
>> ???? >>? ? ? ?> error:invalid-request - HIER_NONE/- - -
>> ???? >>? ? ? ?> 1724028807.006? ? ? 0 192.168.78.15 NONE_NONE/000 0 -
>> ???? >>? ? ? ?> error:invalid-request - HIER_NONE/- - -
>> ???? >>? ? ? ?> 1724028807.262? ? ? 0 192.168.78.15 NONE_NONE/000 0 -
>> ???? >>? ? ? ?> error:invalid-request - HIER_NONE/- - -
>> ???? >>? ? ? ?> 1724028808.922? ?5037 192.168.78.15 TCP_TUNNEL/200 6096
>> ??? CONNECT
>> ???? >>? ? ? ?> 13.107.246.60:443 <http://13.107.246.60:443>
>> ??? <http://13.107.246.60:443 <http://13.107.246.60:443>>
>> ???? >>? ? ? <http://13.107.246.60:443 <http://13.107.246.60:443>
>> ??? <http://13.107.246.60:443 <http://13.107.246.60:443>>> -
>> ???? >>? ? ? ?> ORIGINAL_DST/13.107.246.60 <http://13.107.246.60>
>> ??? <http://13.107.246.60 <http://13.107.246.60>>
>> ???? >>? ? ? <http://13.107.246.60 <http://13.107.246.60>
>> ??? <http://13.107.246.60 <http://13.107.246.60>>> - -
>> ???? >>? ? ? ?> 1724028812.906? ?8336 192.168.78.15 TCP_TUNNEL/200
>> ??? 1071500 CONNECT
>> ???? >>? ? ? ?> 104.126.37.171:443 <http://104.126.37.171:443>
>> ??? <http://104.126.37.171:443 <http://104.126.37.171:443>>
>> ???? >>? ? ? <http://104.126.37.171:443 <http://104.126.37.171:443>
>> ??? <http://104.126.37.171:443 <http://104.126.37.171:443>>> -
>> ???? >>? ? ? ?> ORIGINAL_DST/104.126.37.171 <http://104.126.37.171>
>> ??? <http://104.126.37.171 <http://104.126.37.171>>
>> ???? >>? ? ? <http://104.126.37.171 <http://104.126.37.171>
>> ??? <http://104.126.37.171 <http://104.126.37.171>>> - -
>> ???? >>? ? ? ?> 1724028819.209 247893 192.168.78.15 TCP_TUNNEL/200 4023
>> ??? CONNECT
>> ???? >>? ? ? ?> 142.250.186.34:443 <http://142.250.186.34:443>
>> ??? <http://142.250.186.34:443 <http://142.250.186.34:443>>
>> ???? >>? ? ? <http://142.250.186.34:443 <http://142.250.186.34:443>
>> ??? <http://142.250.186.34:443 <http://142.250.186.34:443>>> -
>> ???? >>? ? ? ?> ORIGINAL_DST/142.250.186.34 <http://142.250.186.34>
>> ??? <http://142.250.186.34 <http://142.250.186.34>>
>> ???? >>? ? ? <http://142.250.186.34 <http://142.250.186.34>
>> ??? <http://142.250.186.34 <http://142.250.186.34>>> - -
>> ???? >>? ? ? ?> 1724028820.097 250033 192.168.78.15 TCP_TUNNEL/200
>> ??? 549611 CONNECT
>> ???? >>? ? ? ?> 142.250.184.246:443 <http://142.250.184.246:443>
>> ??? <http://142.250.184.246:443 <http://142.250.184.246:443>>
>> ???? >>? ? ? <http://142.250.184.246:443 <http://142.250.184.246:443>
>> ??? <http://142.250.184.246:443 <http://142.250.184.246:443>>> -
>> ???? >>? ? ? ?> ORIGINAL_DST/142.250.184.246 <http://142.250.184.246>
>> ??? <http://142.250.184.246 <http://142.250.184.246>>
>> ???? >>? ? ? <http://142.250.184.246 <http://142.250.184.246>
>> ??? <http://142.250.184.246 <http://142.250.184.246>>> - -
>> ???? >>? ? ? ?> 1724028820.154 246850 192.168.78.15 TCP_TUNNEL/200 15119
>> ??? CONNECT
>> ???? >>? ? ? ?> 216.58.206.65:443 <http://216.58.206.65:443>
>> ??? <http://216.58.206.65:443 <http://216.58.206.65:443>>
>> ???? >>? ? ? <http://216.58.206.65:443 <http://216.58.206.65:443>
>> ??? <http://216.58.206.65:443 <http://216.58.206.65:443>>> -
>> ???? >>? ? ? ?> ORIGINAL_DST/216.58.206.65 <http://216.58.206.65>
>> ??? <http://216.58.206.65 <http://216.58.206.65>>
>> ???? >>? ? ? <http://216.58.206.65 <http://216.58.206.65>
>> ??? <http://216.58.206.65 <http://216.58.206.65>>> - -
>> ???? >>? ? ? ?> 1724028820.164 246856 192.168.78.15 TCP_TUNNEL/200 3037
>> ??? CONNECT
>> ???? >>? ? ? ?> 142.250.181.227:443 <http://142.250.181.227:443>
>> ??? <http://142.250.181.227:443 <http://142.250.181.227:443>>
>> ???? >>? ? ? <http://142.250.181.227:443 <http://142.250.181.227:443>
>> ??? <http://142.250.181.227:443 <http://142.250.181.227:443>>> -
>> ???? >>? ? ? ?> ORIGINAL_DST/142.250.181.227 <http://142.250.181.227>
>> ??? <http://142.250.181.227 <http://142.250.181.227>>
>> ???? >>? ? ? <http://142.250.181.227 <http://142.250.181.227>
>> ??? <http://142.250.181.227 <http://142.250.181.227>>> - -
>> ???? >>? ? ? ?> 1724028820.203 246893 192.168.78.15 TCP_TUNNEL/200 3031
>> ??? CONNECT
>> ???? >>? ? ? ?> 172.217.16.196:443 <http://172.217.16.196:443>
>> ??? <http://172.217.16.196:443 <http://172.217.16.196:443>>
>> ???? >>? ? ? <http://172.217.16.196:443 <http://172.217.16.196:443>
>> ??? <http://172.217.16.196:443 <http://172.217.16.196:443>>> -
>> ???? >>? ? ? ?> ORIGINAL_DST/172.217.16.196 <http://172.217.16.196>
>> ??? <http://172.217.16.196 <http://172.217.16.196>>
>> ???? >>? ? ? <http://172.217.16.196 <http://172.217.16.196>
>> ??? <http://172.217.16.196 <http://172.217.16.196>>> - -
>> ???? >>? ? ? ?> 1724028822.656 271833 192.168.78.15 TCP_TUNNEL/200
>> ??? 387583 CONNECT
>> ???? >>? ? ? ?> 142.250.185.238:443 <http://142.250.185.238:443>
>> ??? <http://142.250.185.238:443 <http://142.250.185.238:443>>
>> ???? >>? ? ? <http://142.250.185.238:443 <http://142.250.185.238:443>
>> ??? <http://142.250.185.238:443 <http://142.250.185.238:443>>> -
>> ???? >>? ? ? ?> ORIGINAL_DST/142.250.185.238 <http://142.250.185.238>
>> ??? <http://142.250.185.238 <http://142.250.185.238>>
>> ???? >>? ? ? <http://142.250.185.238 <http://142.250.185.238>
>> ??? <http://142.250.185.238 <http://142.250.185.238>>> - -
>> ???? >>? ? ? ?> 1724028830.336? ? ? 0 192.168.78.15 NONE_NONE/000 0 -
>> ???? >>? ? ? ?> error:invalid-request - HIER_NONE/- - -
>> ???? >>? ? ? ?> 1724028830.781? ? 444 192.168.78.15 TCP_TUNNEL/200 18505
>> ??? CONNECT
>> ???? >>? ? ? ?> 40.126.31.73:443 <http://40.126.31.73:443>
>> ??? <http://40.126.31.73:443 <http://40.126.31.73:443>>
>> ???? >>? ? ? <http://40.126.31.73:443 <http://40.126.31.73:443>
>> ??? <http://40.126.31.73:443 <http://40.126.31.73:443>>> -
>> ???? >>? ? ? ORIGINAL_DST/40.126.31.73 <http://40.126.31.73>
>> ??? <http://40.126.31.73 <http://40.126.31.73>>
>> ???? >>? ? ? ?> <http://40.126.31.73 <http://40.126.31.73>
>> ??? <http://40.126.31.73 <http://40.126.31.73>>> - -
>> ???? >>? ? ? ?> 1724028841.781 155018 192.168.78.15 TCP_TUNNEL/200 15960
>> ??? CONNECT
>> ???? >>? ? ? ?> 13.107.6.158:443 <http://13.107.6.158:443>
>> ??? <http://13.107.6.158:443 <http://13.107.6.158:443>>
>> ???? >>? ? ? <http://13.107.6.158:443 <http://13.107.6.158:443>
>> ??? <http://13.107.6.158:443 <http://13.107.6.158:443>>> -
>> ???? >>? ? ? ORIGINAL_DST/13.107.6.158 <http://13.107.6.158>
>> ??? <http://13.107.6.158 <http://13.107.6.158>>
>> ???? >>? ? ? ?> <http://13.107.6.158 <http://13.107.6.158>
>> ??? <http://13.107.6.158 <http://13.107.6.158>>> - -
>> ???? >>? ? ? ?> 1724028849.443? ? ? 0 192.168.78.15 NONE_NONE/000 0 -
>> ???? >>? ? ? ?> error:invalid-request - HIER_NONE/- - -
>> ???? >>? ? ? ?> 1724028849.698? ? ? 0 192.168.78.15 NONE_NONE/000 0 -
>> ???? >>? ? ? ?> error:invalid-request - HIER_NONE/- - -
>> ???? >>? ? ? ?> 1724028865.261? ? ? 0 192.168.78.15 NONE_NONE/000 0 -
>> ???? >>? ? ? ?> error:invalid-request - HIER_NONE/- - -
>> ???? >>? ? ? ?> 1724028865.779? ? 517 192.168.78.15 TCP_TUNNEL/200 18557
>> ??? CONNECT
>> ???? >>? ? ? ?> 40.126.31.73:443 <http://40.126.31.73:443>
>> ??? <http://40.126.31.73:443 <http://40.126.31.73:443>>
>> ???? >>? ? ? <http://40.126.31.73:443 <http://40.126.31.73:443>
>> ??? <http://40.126.31.73:443 <http://40.126.31.73:443>>> -
>> ???? >>? ? ? ORIGINAL_DST/40.126.31.73 <http://40.126.31.73>
>> ??? <http://40.126.31.73 <http://40.126.31.73>>
>> ???? >>? ? ? ?> <http://40.126.31.73 <http://40.126.31.73>
>> ??? <http://40.126.31.73 <http://40.126.31.73>>> - -
>> ???? >>? ? ? ?> 1724028870.718 109994 192.168.78.15 TCP_TUNNEL/200 6972
>> ??? CONNECT
>> ???? >>? ? ? ?> 20.42.65.94:443 <http://20.42.65.94:443>
>> ??? <http://20.42.65.94:443 <http://20.42.65.94:443>>
>> ??? <http://20.42.65.94:443 <http://20.42.65.94:443>
>> ???? >>? ? ? <http://20.42.65.94:443 <http://20.42.65.94:443>>> -
>> ??? ORIGINAL_DST/20.42.65.94 <http://20.42.65.94>
>> ???? >>? ? ? <http://20.42.65.94 <http://20.42.65.94>>
>> ???? >>? ? ? ?> <http://20.42.65.94 <http://20.42.65.94>
>> ??? <http://20.42.65.94 <http://20.42.65.94>>> - -
>> ???? >>? ? ? ?> 1724028871.179? 64583 192.168.78.15 TCP_TUNNEL/200 1903
>> ??? CONNECT
>> ???? >>? ? ? ?> 104.18.10.207:443 <http://104.18.10.207:443>
>> ??? <http://104.18.10.207:443 <http://104.18.10.207:443>>
>> ???? >>? ? ? <http://104.18.10.207:443 <http://104.18.10.207:443>
>> ??? <http://104.18.10.207:443 <http://104.18.10.207:443>>> -
>> ???? >>? ? ? ?> ORIGINAL_DST/104.18.10.207 <http://104.18.10.207>
>> ??? <http://104.18.10.207 <http://104.18.10.207>>
>> ???? >>? ? ? <http://104.18.10.207 <http://104.18.10.207>
>> ??? <http://104.18.10.207 <http://104.18.10.207>>> - -
>> ???? >>? ? ? ?> 1724028871.179? 63917 192.168.78.15 TCP_TUNNEL/200 2430
>> ??? CONNECT
>> ???? >>? ? ? ?> 142.250.186.99:443 <http://142.250.186.99:443>
>> ??? <http://142.250.186.99:443 <http://142.250.186.99:443>>
>> ???? >>? ? ? <http://142.250.186.99:443 <http://142.250.186.99:443>
>> ??? <http://142.250.186.99:443 <http://142.250.186.99:443>>> -
>> ???? >>? ? ? ?> ORIGINAL_DST/142.250.186.99 <http://142.250.186.99>
>> ??? <http://142.250.186.99 <http://142.250.186.99>>
>> ???? >>? ? ? <http://142.250.186.99 <http://142.250.186.99>
>> ??? <http://142.250.186.99 <http://142.250.186.99>>> - -
>> ???? >>? ? ? ?> 1724028871.179? 64709 192.168.78.15 TCP_TUNNEL/200 2439
>> ??? CONNECT
>> ???? >>? ? ? ?> 142.250.185.170:443 <http://142.250.185.170:443>
>> ??? <http://142.250.185.170:443 <http://142.250.185.170:443>>
>> ???? >>? ? ? <http://142.250.185.170:443 <http://142.250.185.170:443>
>> ??? <http://142.250.185.170:443 <http://142.250.185.170:443>>> -
>> ???? >>? ? ? ?> ORIGINAL_DST/142.250.185.170 <http://142.250.185.170>
>> ??? <http://142.250.185.170 <http://142.250.185.170>>
>> ???? >>? ? ? <http://142.250.185.170 <http://142.250.185.170>
>> ??? <http://142.250.185.170 <http://142.250.185.170>>> - -
>> ???? >>? ? ? ?> 1724028871.308? ? ? 0 192.168.78.15 NONE_NONE/000 0 -
>> ???? >>? ? ? ?> error:invalid-request - HIER_NONE/- - -
>> ???? >>? ? ? ?> 1724028871.731? ? 422 192.168.78.15 TCP_TUNNEL/200 17789
>> ??? CONNECT
>> ???? >>? ? ? ?> 40.126.31.73:443 <http://40.126.31.73:443>
>> ??? <http://40.126.31.73:443 <http://40.126.31.73:443>>
>> ???? >>? ? ? <http://40.126.31.73:443 <http://40.126.31.73:443>
>> ??? <http://40.126.31.73:443 <http://40.126.31.73:443>>> -
>> ???? >>? ? ? ORIGINAL_DST/40.126.31.73 <http://40.126.31.73>
>> ??? <http://40.126.31.73 <http://40.126.31.73>>
>> ???? >>? ? ? ?> <http://40.126.31.73 <http://40.126.31.73>
>> ??? <http://40.126.31.73 <http://40.126.31.73>>> - -
>> ???? >>? ? ? ?> 1724028872.486? ? ? 0 192.168.78.15 NONE_NONE/000 0 -
>> ???? >>? ? ? ?> error:invalid-request - HIER_NONE/- - -
>> ???? >>? ? ? ?> 1724028873.477? ? ? 0 192.168.78.15 NONE_NONE/000 0 -
>> ???? >>? ? ? ?> error:invalid-request - HIER_NONE/- - -
>> ???? >>? ? ? ?> 1724028873.745? ? ? 0 192.168.78.15 NONE_NONE/000 0 -
>> ???? >>? ? ? ?> error:invalid-request - HIER_NONE/- - -
>> ???? >>? ? ? ?> 1724028873.902? ? 424 192.168.78.15 TCP_TUNNEL/200 18520
>> ??? CONNECT
>> ???? >>? ? ? ?> 40.126.31.73:443 <http://40.126.31.73:443>
>> ??? <http://40.126.31.73:443 <http://40.126.31.73:443>>
>> ???? >>? ? ? <http://40.126.31.73:443 <http://40.126.31.73:443>
>> ??? <http://40.126.31.73:443 <http://40.126.31.73:443>>> -
>> ???? >>? ? ? ORIGINAL_DST/40.126.31.73 <http://40.126.31.73>
>> ??? <http://40.126.31.73 <http://40.126.31.73>>
>> ???? >>? ? ? ?> <http://40.126.31.73 <http://40.126.31.73>
>> ??? <http://40.126.31.73 <http://40.126.31.73>>> - -
>> ???? >>? ? ? ?> 1724028877.056? ? ? 0 192.168.78.15 NONE_NONE/000 0 -
>> ???? >>? ? ? ?> error:invalid-request - HIER_NONE/- - -
>> ???? >>? ? ? ?> 1724028877.060? ? ? 0 192.168.78.15 NONE_NONE/000 0 -
>> ???? >>? ? ? ?> error:invalid-request - HIER_NONE/- - -
>> ???? >>? ? ? ?> 1724028877.060? ? ? 0 192.168.78.15 NONE_NONE/000 0 -
>> ???? >>? ? ? ?> error:invalid-request - HIER_NONE/- - -
>> ???? >>? ? ? ?> 1724028877.060? ? ? 0 192.168.78.15 NONE_NONE/000 0 -
>> ???? >>? ? ? ?> error:invalid-request - HIER_NONE/- - -
>> ???? >>? ? ? ?> 1724028877.430 312389 192.168.78.15 TCP_TUNNEL/200 7884
>> ??? CONNECT
>> ???? >>? ? ? ?> 142.250.186.78:443 <http://142.250.186.78:443>
>> ??? <http://142.250.186.78:443 <http://142.250.186.78:443>>
>> ???? >>? ? ? <http://142.250.186.78:443 <http://142.250.186.78:443>
>> ??? <http://142.250.186.78:443 <http://142.250.186.78:443>>> -
>> ???? >>? ? ? ?> ORIGINAL_DST/142.250.186.78 <http://142.250.186.78>
>> ??? <http://142.250.186.78 <http://142.250.186.78>>
>> ???? >>? ? ? <http://142.250.186.78 <http://142.250.186.78>
>> ??? <http://142.250.186.78 <http://142.250.186.78>>> - -
>> ???? >>? ? ? ?> 1724028878.800? ? ? 0 192.168.78.15 NONE_NONE/000 0 -
>> ???? >>? ? ? ?> error:invalid-request - HIER_NONE/- - -
>> ???? >>? ? ? ?> 1724028878.920? ? ? 0 192.168.78.15 NONE_NONE/000 0 -
>> ???? >>? ? ? ?> error:invalid-request - HIER_NONE/- - -
>> ???? >>? ? ? ?> 1724028879.072? ? ? 0 192.168.78.15 NONE_NONE/000 0 -
>> ???? >>? ? ? ?> error:invalid-request - HIER_NONE/- - -
>> ???? >>? ? ? ?> 1724028880.808? ?7062 192.168.78.15 TCP_TUNNEL/200
>> ??? 836391 CONNECT
>> ???? >>? ? ? ?> 104.126.37.145:443 <http://104.126.37.145:443>
>> ??? <http://104.126.37.145:443 <http://104.126.37.145:443>>
>> ???? >>? ? ? <http://104.126.37.145:443 <http://104.126.37.145:443>
>> ??? <http://104.126.37.145:443 <http://104.126.37.145:443>>> -
>> ???? >>? ? ? ?> ORIGINAL_DST/104.126.37.145 <http://104.126.37.145>
>> ??? <http://104.126.37.145 <http://104.126.37.145>>
>> ???? >>? ? ? <http://104.126.37.145 <http://104.126.37.145>
>> ??? <http://104.126.37.145 <http://104.126.37.145>>> - -
>> ???? >>? ? ? ?> 1724028882.468? 33024 192.168.78.15 TCP_TUNNEL/200
>> ??? 1488697 CONNECT
>> ???? >>? ? ? ?> 49.12.59.2:443 <http://49.12.59.2:443>
>> ??? <http://49.12.59.2:443 <http://49.12.59.2:443>>
>> ??? <http://49.12.59.2:443 <http://49.12.59.2:443>
>> ???? >>? ? ? <http://49.12.59.2:443 <http://49.12.59.2:443>>> -
>> ??? ORIGINAL_DST/49.12.59.2 <http://49.12.59.2> <http://49.12.59.2
>> ??? <http://49.12.59.2>>
>> ???? >>? ? ? ?> <http://49.12.59.2 <http://49.12.59.2>
>> ??? <http://49.12.59.2 <http://49.12.59.2>>> - -
>> ???? >>? ? ? ?> 1724028883.728? ?6671 192.168.78.15 TCP_TUNNEL/200 69351
>> ??? CONNECT
>> ???? >>? ? ? ?> 52.216.185.251:443 <http://52.216.185.251:443>
>> ??? <http://52.216.185.251:443 <http://52.216.185.251:443>>
>> ???? >>? ? ? <http://52.216.185.251:443 <http://52.216.185.251:443>
>> ??? <http://52.216.185.251:443 <http://52.216.185.251:443>>> -
>> ???? >>? ? ? ?> ORIGINAL_DST/52.216.185.251 <http://52.216.185.251>
>> ??? <http://52.216.185.251 <http://52.216.185.251>>
>> ???? >>? ? ? <http://52.216.185.251 <http://52.216.185.251>
>> ??? <http://52.216.185.251 <http://52.216.185.251>>> - -
>> ???? >>? ? ? ?> 1724028883.789? ?6728 192.168.78.15 TCP_TUNNEL/200 69216
>> ??? CONNECT
>> ???? >>? ? ? ?> 52.216.185.251:443 <http://52.216.185.251:443>
>> ??? <http://52.216.185.251:443 <http://52.216.185.251:443>>
>> ???? >>? ? ? <http://52.216.185.251:443 <http://52.216.185.251:443>
>> ??? <http://52.216.185.251:443 <http://52.216.185.251:443>>> -
>> ???? >>? ? ? ?> ORIGINAL_DST/52.216.185.251 <http://52.216.185.251>
>> ??? <http://52.216.185.251 <http://52.216.185.251>>
>> ???? >>? ? ? <http://52.216.185.251 <http://52.216.185.251>
>> ??? <http://52.216.185.251 <http://52.216.185.251>>> - -
>> ???? >>? ? ? ?> 1724028883.797? ?6736 192.168.78.15 TCP_TUNNEL/200
>> ??? 104657 CONNECT
>> ???? >>? ? ? ?> 52.216.185.251:443 <http://52.216.185.251:443>
>> ??? <http://52.216.185.251:443 <http://52.216.185.251:443>>
>> ???? >>? ? ? <http://52.216.185.251:443 <http://52.216.185.251:443>
>> ??? <http://52.216.185.251:443 <http://52.216.185.251:443>>> -
>> ???? >>? ? ? ?> ORIGINAL_DST/52.216.185.251 <http://52.216.185.251>
>> ??? <http://52.216.185.251 <http://52.216.185.251>>
>> ???? >>? ? ? <http://52.216.185.251 <http://52.216.185.251>
>> ??? <http://52.216.185.251 <http://52.216.185.251>>> - -
>> ???? >>? ? ? ?> 1724028883.845? ?6784 192.168.78.15 TCP_TUNNEL/200 80277
>> ??? CONNECT
>> ???? >>? ? ? ?> 52.216.185.251:443 <http://52.216.185.251:443>
>> ??? <http://52.216.185.251:443 <http://52.216.185.251:443>>
>> ???? >>? ? ? <http://52.216.185.251:443 <http://52.216.185.251:443>
>> ??? <http://52.216.185.251:443 <http://52.216.185.251:443>>> -
>> ???? >>? ? ? ?> ORIGINAL_DST/52.216.185.251 <http://52.216.185.251>
>> ??? <http://52.216.185.251 <http://52.216.185.251>>
>> ???? >>? ? ? <http://52.216.185.251 <http://52.216.185.251>
>> ??? <http://52.216.185.251 <http://52.216.185.251>>> - -
>> ???? >>? ? ? ?> 1724028884.460 170355 192.168.78.15 TCP_TUNNEL/200 44690
>> ??? CONNECT
>> ???? >>? ? ? ?> 185.199.108.153:443 <http://185.199.108.153:443>
>> ??? <http://185.199.108.153:443 <http://185.199.108.153:443>>
>> ???? >>? ? ? <http://185.199.108.153:443 <http://185.199.108.153:443>
>> ??? <http://185.199.108.153:443 <http://185.199.108.153:443>>> -
>> ???? >>? ? ? ?> ORIGINAL_DST/185.199.108.153 <http://185.199.108.153>
>> ??? <http://185.199.108.153 <http://185.199.108.153>>
>> ???? >>? ? ? <http://185.199.108.153 <http://185.199.108.153>
>> ??? <http://185.199.108.153 <http://185.199.108.153>>> - -
>> ???? >>? ? ? ?> 1724028889.845 120370 192.168.78.15 TCP_TUNNEL/200 5868
>> ??? CONNECT
>> ???? >>? ? ? ?> 104.126.37.161:443 <http://104.126.37.161:443>
>> ??? <http://104.126.37.161:443 <http://104.126.37.161:443>>
>> ???? >>? ? ? <http://104.126.37.161:443 <http://104.126.37.161:443>
>> ??? <http://104.126.37.161:443 <http://104.126.37.161:443>>> -
>> ???? >>? ? ? ?> ORIGINAL_DST/104.126.37.161 <http://104.126.37.161>
>> ??? <http://104.126.37.161 <http://104.126.37.161>>
>> ???? >>? ? ? <http://104.126.37.161 <http://104.126.37.161>
>> ??? <http://104.126.37.161 <http://104.126.37.161>>> - -
>> ???? >>? ? ? ?> 1724028890.011 122862 192.168.78.15 TCP_TUNNEL/200
>> ??? 136726 CONNECT
>> ???? >>? ? ? ?> 23.37.37.211:443 <http://23.37.37.211:443>
>> ??? <http://23.37.37.211:443 <http://23.37.37.211:443>>
>> ???? >>? ? ? <http://23.37.37.211:443 <http://23.37.37.211:443>
>> ??? <http://23.37.37.211:443 <http://23.37.37.211:443>>> -
>> ???? >>? ? ? ORIGINAL_DST/23.37.37.211 <http://23.37.37.211>
>> ??? <http://23.37.37.211 <http://23.37.37.211>>
>> ???? >>? ? ? ?> <http://23.37.37.211 <http://23.37.37.211>
>> ??? <http://23.37.37.211 <http://23.37.37.211>>> - -
>> ???? >>? ? ? ?> 1724028890.297 120381 192.168.78.15 TCP_TUNNEL/200 9176
>> ??? CONNECT
>> ???? >>? ? ? ?> 2.18.140.238:443 <http://2.18.140.238:443>
>> ??? <http://2.18.140.238:443 <http://2.18.140.238:443>>
>> ???? >>? ? ? <http://2.18.140.238:443 <http://2.18.140.238:443>
>> ??? <http://2.18.140.238:443 <http://2.18.140.238:443>>> -
>> ???? >>? ? ? ORIGINAL_DST/2.18.140.238 <http://2.18.140.238>
>> ??? <http://2.18.140.238 <http://2.18.140.238>>
>> ???? >>? ? ? ?> <http://2.18.140.238 <http://2.18.140.238>
>> ??? <http://2.18.140.238 <http://2.18.140.238>>> - -
>> ???? >>? ? ? ?> 1724028891.212? ? ? 0 192.168.78.15 NONE_NONE/000 0 -
>> ???? >>? ? ? ?> error:invalid-request - HIER_NONE/- - -
>> ???? >>? ? ? ?> 1724028891.365? ? 152 192.168.78.15 TCP_TUNNEL/200 2359
>> ??? CONNECT
>> ???? >>? ? ? ?> 142.250.185.138:443 <http://142.250.185.138:443>
>> ??? <http://142.250.185.138:443 <http://142.250.185.138:443>>
>> ???? >>? ? ? <http://142.250.185.138:443 <http://142.250.185.138:443>
>> ??? <http://142.250.185.138:443 <http://142.250.185.138:443>>> -
>> ???? >>? ? ? ?> ORIGINAL_DST/142.250.185.138 <http://142.250.185.138>
>> ??? <http://142.250.185.138 <http://142.250.185.138>>
>> ???? >>? ? ? <http://142.250.185.138 <http://142.250.185.138>
>> ??? <http://142.250.185.138 <http://142.250.185.138>>> - -
>> ???? >>? ? ? ?> 1724028893.885? 90253 192.168.78.15 TCP_TUNNEL/200 6374
>> ??? CONNECT
>> ???? >>? ? ? ?> 13.107.246.60:443 <http://13.107.246.60:443>
>> ??? <http://13.107.246.60:443 <http://13.107.246.60:443>>
>> ???? >>? ? ? <http://13.107.246.60:443 <http://13.107.246.60:443>
>> ??? <http://13.107.246.60:443 <http://13.107.246.60:443>>> -
>> ???? >>? ? ? ?> ORIGINAL_DST/13.107.246.60 <http://13.107.246.60>
>> ??? <http://13.107.246.60 <http://13.107.246.60>>
>> ???? >>? ? ? <http://13.107.246.60 <http://13.107.246.60>
>> ??? <http://13.107.246.60 <http://13.107.246.60>>> - -
>> ???? >>? ? ? ?> 1724028900.169? ? ? 0 192.168.78.15 NONE_NONE/000 0 -
>> ???? >>? ? ? ?> error:invalid-request - HIER_NONE/- - -
>> ???? >>? ? ? ?> 1724028934.465 900262 192.168.78.15 TCP_TUNNEL/200 5530
>> ??? CONNECT
>> ???? >>? ? ? ?> 52.123.243.197:443 <http://52.123.243.197:443>
>> ??? <http://52.123.243.197:443 <http://52.123.243.197:443>>
>> ???? >>? ? ? <http://52.123.243.197:443 <http://52.123.243.197:443>
>> ??? <http://52.123.243.197:443 <http://52.123.243.197:443>>> -
>> ???? >>? ? ? ?> ORIGINAL_DST/52.123.243.197 <http://52.123.243.197>
>> ??? <http://52.123.243.197 <http://52.123.243.197>>
>> ???? >>? ? ? <http://52.123.243.197 <http://52.123.243.197>
>> ??? <http://52.123.243.197 <http://52.123.243.197>>> - -
>> ???? >>? ? ? ?> 1724028960.494? 60324 192.168.78.15 TCP_TUNNEL/503 0 
>> CONNECT
>> ???? >>? ? ? ?> 172.217.16.206:443 <http://172.217.16.206:443>
>> ??? <http://172.217.16.206:443 <http://172.217.16.206:443>>
>> ???? >>? ? ? <http://172.217.16.206:443 <http://172.217.16.206:443>
>> ??? <http://172.217.16.206:443 <http://172.217.16.206:443>>> -
>> ???? >>? ? ? ?> ORIGINAL_DST/172.217.16.206 <http://172.217.16.206>
>> ??? <http://172.217.16.206 <http://172.217.16.206>>
>> ???? >>? ? ? <http://172.217.16.206 <http://172.217.16.206>
>> ??? <http://172.217.16.206 <http://172.217.16.206>>> - -
>> ???? >>? ? ? ?> 1724028960.494? ? ? 0 192.168.78.15 NONE_NONE/000 0 -
>> ???? >>? ? ? ?> error:transaction-end-before-headers - HIER_NONE/- - -
>> ???? >>? ? ? ?>
>> ???? >>? ? ? ?> Thanks for any help,
>> ???? >>? ? ? ?>
>> ???? >>? ? ? ?>
>> ???? >>? ? ? ?> ----
>> ???? >>? ? ? ?> Eliezer Croitoru
>> ???? >>? ? ? ?> Tech Support
>> ???? >>? ? ? ?> Mobile: +972-5-28704261
>> ???? >>? ? ? ?> Email: ngtech1ltd at gmail.com
>> ??? <mailto:ngtech1ltd at gmail.com> <mailto:ngtech1ltd at gmail.com
>> ??? <mailto:ngtech1ltd at gmail.com>>
>> ???? >>? ? ? <mailto:ngtech1ltd at gmail.com <mailto:ngtech1ltd at gmail.com>
>> ??? <mailto:ngtech1ltd at gmail.com <mailto:ngtech1ltd at gmail.com>>>
>> ???? >
>> ???? >
>> ???? > _______________________________________________
>> ???? > squid-users mailing list
>> ???? > squid-users at lists.squid-cache.org
>> ??? <mailto:squid-users at lists.squid-cache.org>
>> ???? > https://lists.squid-cache.org/listinfo/squid-users
>> ??? <https://lists.squid-cache.org/listinfo/squid-users>
>>
>> ??? _______________________________________________
>> ??? squid-users mailing list
>> ??? squid-users at lists.squid-cache.org
>> ??? <mailto:squid-users at lists.squid-cache.org>
>> ??? https://lists.squid-cache.org/listinfo/squid-users
>> ??? <https://lists.squid-cache.org/listinfo/squid-users>
>>
> 
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> https://lists.squid-cache.org/listinfo/squid-users



From rousskov at measurement-factory.com  Thu Aug 22 20:00:15 2024
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Thu, 22 Aug 2024 16:00:15 -0400
Subject: [squid-users] Squid 6.10 on Fedora 40 cannot intercept and bump
 SSL Traffic
In-Reply-To: <016e01daf4cb$1ae2a390$50a7eab0$@gmail.com>
References: <CABA8h=TSSsneVN5qvtaxsHfdknSd58ucZ9Vxg=Vxe5YWCsaAAA@mail.gmail.com>
 <6b375023-33d6-4812-8850-0a24cb562d2e@measurement-factory.com>
 <CABA8h=SJp88t3aj1cr-4LK-mqik6QL9nG_X2xumZ_mPwCoybxg@mail.gmail.com>
 <4a57096d-1218-4090-b62a-67d1a18173a7@measurement-factory.com>
 <000001daf26d$d620c5c0$82625140$@gmail.com>
 <af9608b6-5388-4d78-8e96-eea3267b6bc7@measurement-factory.com>
 <CABA8h=Rj=qkw5YrNNtD1Kc1rw0Pu_07Lti00H4bTL87pVtMcRw@mail.gmail.com>
 <fa2016f4-276a-4bf0-94a8-79db1273d9b9@measurement-factory.com>
 <414af43d-0c60-4fdc-8421-3fcac3bf05c7@measurement-factory.com>
 <016e01daf4cb$1ae2a390$50a7eab0$@gmail.com>
Message-ID: <7051af1e-4eb4-40b1-9de2-96fac56f5b37@measurement-factory.com>

On 2024-08-22 15:40, ngtech1ltd at gmail.com wrote:

> I believe there should be something that will indicate it to some
> degree 

Sorry, I do not know what you mean by "it" here.


> since ssl_bump and intercept on the same port should be "impossible"

It is possible. An http_port can apply SslBump to intercepted traffic. 
Same for https_port. However, each port is meant to handle its own kind 
of traffic: http_port is for plain HTTP (including CONNECT tunnels) 
while https_port is for TLS (usually with HTTP inside that TLS).

All of these six configuration sketches are valid for some use cases 
(and different things are expected to happen at each of these ports):

* http_port
* http_port intercept
* http_port ssl-bump
* http_port intercept ssl-bump

* https_port
* https_port intercept ssl-bump


> or that the http_port should be enabled to do ssl
> interception.

http_port does not need to be enabled to do TLS interception.
http_port is pretty much unrelated to TLS interception.
http_port may be configured to do plain HTTP interception.


> Am I wrong about my assumption?

It feels like it, but it could be that your assumptions just need to be 
stated more accurately to become valid.


HTH,

Alex.



> -----Original Message-----
> From: squid-users <squid-users-bounces at lists.squid-cache.org> On Behalf Of Alex Rousskov
> Sent: Thursday, August 22, 2024 9:21 PM
> To: squid-users at lists.squid-cache.org
> Subject: Re: [squid-users] Squid 6.10 on Fedora 40 cannot intercept and bump SSL Traffic
> 
> On 2024-08-20 15:57, Alex Rousskov wrote:
>> On 2024-08-19 19:32, NgTech LTD wrote:
>>
>>   > curl -v -k https://www.youtube.com/
>>
>>> 1724109013.783      0 192.168.78.252 NONE_NONE/000 0 -
>>> error:invalid-request - HIER_NONE/- - -
>>
>> OK, let's focus on this curl interception test. It feels like your
>> Squid is receiving some bytes it cannot fully grok. We should figure
>> out what those bytes are. Please share (privately if needed) a pointer
>> to compressed ALL,9 cache.log snippet collected while reproducing this
>> single test.
> 
> Thank you, Eliezer, for sharing the requested logs!
> 
> There is a simple explanation for the above error:invalid-request access.log record: The test intercepts TLS traffic using plain text http_port. It should intercept TLS traffic using https_port instead.
> 
> 
>> acl foreignProtocol squid_error ERR_PROTOCOL_UNKNOWN ...
>> on_unsupported_protocol tunnel foreignProtocol
> 
> When a plain text port is used, Squid correctly declares ERR_PROTOCOL_UNKNOWN, triggers on_unsupported_protocol handling, and then tunnels intercepted HTTPS bytes, as configured. Judging by the lack of curl errors, that blind TCP tunnel works correctly as well.
> 
> SslBump is not applied to tunneled "unknown protocol" bytes, of course.
> 
> 
> HTH,
> 
> Alex.
> 
> 
> 
>> N.B. The other tests confirm that your Squid can "bump clients",
>> invalidating one of the assertions at the beginning of this email
>> thread. The problem appears to be specific to the interception part of
>> the test rather than basic SslBump operation.
>>
>>
>> Cheers,
>>
>> Alex.
>>
>>
>>> 1724109015.407   1623 192.168.78.252 TCP_TUNNEL/200 534674 -
>>> 142.250.185.110:443 <http://142.250.185.110:443> -
>>> ORIGINAL_DST/142.250.185.110 <http://142.250.185.110> - -
>>>
>>> PS C:\Users\eliez> curl -v -k https://www.youtube.com/
>>> <https://www.youtube.com/>  -o 1.txt
>>>     % Total    % Received % Xferd  Average Speed   Time    Time
>>> Time   Current
>>>                                    Dload  Upload   Total   Spent
>>>   Left   Speed
>>>     0     0    0     0    0     0      0      0 --:--:-- --:--:--
>>> --:--:--     0* Host www.youtube.com:443 <http://www.youtube.com:443>
>>> was resolved.
>>> * IPv6: 2a00:1450:4001:80b::200e, 2a00:1450:4001:828::200e,
>>> 2a00:1450:4001:803::200e, 2a00:1450:4001:830::200e
>>> * IPv4: 142.250.185.110, 216.58.206.78, 142.250.186.142,
>>> 216.58.206.46, 172.217.18.110, 142.250.185.142, 142.250.186.174,
>>> 142.250.184.206, 142.250.185.174, 142.250.184.238, 172.217.18.14,
>>> 142.250.186.110, 172.217.16.206, 172.217.23.110, 216.58.212.142,
>>> 142.250.185.78
>>> *   Trying [2a00:1450:4001:80b::200e]:443...
>>> *   Trying 142.250.185.110:443...
>>> * Connected to www.youtube.com <http://www.youtube.com>
>>> (142.250.185.110) port 443
>>> * schannel: disabled automatic use of client certificate
>>> * ALPN: curl offers http/1.1
>>> * ALPN: server accepted http/1.1
>>> * using HTTP/1.x
>>>   > GET / HTTP/1.1
>>>   > Host: www.youtube.com <http://www.youtube.com>
>>>   > User-Agent: curl/8.8.0
>>>   > Accept: */*
>>>   >
>>> * Request completely sent off
>>> * schannel: remote party requests renegotiation
>>> * schannel: renegotiating SSL/TLS connection
>>> * schannel: SSL/TLS connection renegotiated < HTTP/1.1 200 OK <
>>> Content-Type: text/html; charset=utf-8 < X-Content-Type-Options:
>>> nosniff < Cache-Control: no-cache, no-store, max-age=0,
>>> must-revalidate < Pragma: no-cache < Expires: Mon, 01 Jan 1990
>>> 00:00:00 GMT < Date: Mon, 19 Aug 2024 23:10:13 GMT <
>>> Strict-Transport-Security: max-age=31536000 < X-Frame-Options:
>>> SAMEORIGIN < Permissions-Policy: ch-ua-arch=*, ch-ua-bitness=*,
>>> ch-ua-full-version=*, ch-ua-full-version-list=*, ch-ua-model=*,
>>> ch-ua-wow64=*, ch-ua-form-factors=*, ch-ua-platform=*,
>>> ch-ua-platform-version=*
>>> < Content-Security-Policy: require-trusted-types-for 'script'
>>> < Origin-Trial:
>>> AmhMBR6zCLzDDxpW+HfpP67BqwIknWnyMOXOQGfzYswFmJe+fgaI6XZgAzcxOrzNtP7hE
>>> AmhMBR6zCLzDDxpW+HfpP67BqwIknWnyMOXOQGfzYswFmJe+DsOo1jdjFnVr2IdxQ4AAA
>>> AmhMBR6zCLzDDxpW+HfpP67BqwIknWnyMOXOQGfzYswFmJe+B4eyJvcmlnaW4iOiJodHR
>>> AmhMBR6zCLzDDxpW+HfpP67BqwIknWnyMOXOQGfzYswFmJe+wczovL3lvdXR1YmUuY29t
>>> AmhMBR6zCLzDDxpW+HfpP67BqwIknWnyMOXOQGfzYswFmJe+OjQ0MyIsImZlYXR1cmUiO
>>> AmhMBR6zCLzDDxpW+HfpP67BqwIknWnyMOXOQGfzYswFmJe+iJXZWJWaWV3WFJlcXVlc3
>>> AmhMBR6zCLzDDxpW+HfpP67BqwIknWnyMOXOQGfzYswFmJe+RlZFdpdGhEZXByZWNhdGl
>>> AmhMBR6zCLzDDxpW+HfpP67BqwIknWnyMOXOQGfzYswFmJe+vbiIsImV4cGlyeSI6MTc1
>>> AmhMBR6zCLzDDxpW+HfpP67BqwIknWnyMOXOQGfzYswFmJe+ODA2NzE5OSwiaXNTdWJkb
>>> AmhMBR6zCLzDDxpW+HfpP67BqwIknWnyMOXOQGfzYswFmJe+21haW4iOnRydWV9
>>> < Report-To:
>>> {"group":"youtube_main","max_age":2592000,"endpoints":[{"url":"https:
>>> //csp.withgoogle.com/csp/report-to/youtube_main
>>> <https://csp.withgoogle.com/csp/report-to/youtube_main>"}]}
>>> < Cross-Origin-Opener-Policy: same-origin-allow-popups;
>>> report-to="youtube_main"
>>> < P3P: CP="This is not a P3P policy! See
>>> http://support.google.com/accounts/answer/151657?hl=en
>>> <http://support.google.com/accounts/answer/151657?hl=en> for more info."
>>> < Server: ESF
>>> < X-XSS-Protection: 0
>>> < Set-Cookie: GPS=1; Domain=.youtube.com <http://youtube.com>;
>>> Expires=Mon, 19-Aug-2024 23:40:13 GMT; Path=/; Secure; HttpOnly <
>>> Set-Cookie: YSC=FASh7dosPqA; Domain=.youtube.com
>>> <http://youtube.com>; Path=/; Secure; HttpOnly; SameSite=none <
>>> Set-Cookie: VISITOR_INFO1_LIVE=B6cXjIhTk2Q; Domain=.youtube.com
>>> <http://youtube.com>; Expires=Sat, 15-Feb-2025 23:10:13 GMT; Path=/;
>>> Secure; HttpOnly; SameSite=none < Set-Cookie:
>>> VISITOR_PRIVACY_METADATA=CgJJTBIEGgAgJw%3D%3D;
>>> Domain=.youtube.com <http://youtube.com>; Expires=Sat, 15-Feb-2025
>>> 23:10:13 GMT; Path=/; Secure; HttpOnly; SameSite=none < Alt-Svc:
>>> h3=":443"; ma=2592000,h3-29=":443"; ma=2592000 < Accept-Ranges: none
>>> < Vary: Accept-Encoding < Transfer-Encoding: chunked < { [9490 bytes
>>> data]
>>> * schannel: failed to decrypt data, need more data { [16240 bytes
>>> data]
>>> * schannel: failed to decrypt data, need more data { [4134 bytes
>>> data]
>>> * schannel: failed to decrypt data, need more data { [9646 bytes
>>> data]
>>> * schannel: failed to decrypt data, need more data { [16215 bytes
>>> data]
>>> * schannel: failed to decrypt data, need more data { [1378 bytes
>>> data]
>>> * schannel: failed to decrypt data, need more data { [2756 bytes
>>> data]
>>> * schannel: failed to decrypt data, need more data { [5512 bytes
>>> data]
>>> * schannel: failed to decrypt data, need more data { [2756 bytes
>>> data]
>>> * schannel: failed to decrypt data, need more data { [2756 bytes
>>> data]
>>> * schannel: failed to decrypt data, need more data { [2756 bytes
>>> data]
>>> * schannel: failed to decrypt data, need more data { [3824 bytes
>>> data]
>>> * schannel: failed to decrypt data, need more data { [2756 bytes
>>> data]
>>> * schannel: failed to decrypt data, need more data { [2756 bytes
>>> data]
>>> * schannel: failed to decrypt data, need more data { [5537 bytes
>>> data]
>>> * schannel: failed to decrypt data, need more data { [2756 bytes
>>> data]
>>> * schannel: failed to decrypt data, need more data { [4134 bytes
>>> data]
>>> * schannel: failed to decrypt data, need more data { [1378 bytes
>>> data]
>>> * schannel: failed to decrypt data, need more data { [22048 bytes
>>> data]
>>> * schannel: failed to decrypt data, need more data { [35198 bytes
>>> data]
>>> * schannel: failed to decrypt data, need more data { [21738 bytes
>>> data]
>>> * schannel: failed to decrypt data, need more data { [35854 bytes
>>> data]
>>> * schannel: failed to decrypt data, need more data { [25878 bytes
>>> data]
>>> * schannel: failed to decrypt data, need more data { [5193 bytes
>>> data]
>>> * schannel: failed to decrypt data, need more data { [13805 bytes
>>> data]
>>> * schannel: failed to decrypt data, need more data { [5512 bytes
>>> data]
>>> * schannel: failed to decrypt data, need more data { [5512 bytes
>>> data]
>>> * schannel: failed to decrypt data, need more data { [20374 bytes
>>> data]
>>> * schannel: failed to decrypt data, need more data { [1378 bytes
>>> data]
>>> * schannel: failed to decrypt data, need more data { [19292 bytes
>>> data]
>>> * schannel: failed to decrypt data, need more data { [4134 bytes
>>> data]
>>> * schannel: failed to decrypt data, need more data { [21752 bytes
>>> data]
>>> * schannel: failed to decrypt data, need more data { [2756 bytes
>>> data]
>>> * schannel: failed to decrypt data, need more data { [24508 bytes
>>> data]
>>> * schannel: failed to decrypt data, need more data { [13780 bytes
>>> data]
>>> * schannel: failed to decrypt data, need more data { [47936 bytes
>>> data]
>>> * schannel: failed to decrypt data, need more data { [11024 bytes
>>> data]
>>> * schannel: failed to decrypt data, need more data { [53150 bytes
>>> data]
>>> 100  504k    0  504k    0     0   556k      0 --:--:-- --:--:--
>>> --:--:--   559k
>>> * Connection #0 to host www.youtube.com <http://www.youtube.com> left
>>> intact
>>>
>>>
>>> Now for a direct test with a proxy definition for a port which is not
>>> intercept but plain forward proxy:
>>>
>>> 1724109426.755   1638 192.168.78.252 TCP_TUNNEL/200 533406 CONNECT
>>> www.youtube.com:443 <http://www.youtube.com:443> -
>>> HIER_DIRECT/142.250.184.238 <http://142.250.184.238> - -
>>>
>>> PS C:\Users\eliez> curl -x http://192.168.66.1:3128
>>> <http://192.168.66.1:3128> -v -k https://www.youtube.com/
>>> <https://www.youtube.com/>  -o 1.txt
>>>     % Total    % Received % Xferd  Average Speed   Time    Time
>>> Time   Current
>>>                                    Dload  Upload   Total   Spent
>>>   Left   Speed
>>>     0     0    0     0    0     0      0      0 --:--:-- --:--:--
>>> --:--:--     0*   Trying 192.168.66.1:3128...
>>> * Connected to 192.168.66.1 (192.168.66.1) port 3128
>>> * CONNECT tunnel: HTTP/1.1 negotiated
>>> * allocate connect buffer
>>> * Establish HTTP proxy tunnel to www.youtube.com:443
>>> <http://www.youtube.com:443>
>>>   > CONNECT www.youtube.com:443 <http://www.youtube.com:443> HTTP/1.1
>>>   > Host: www.youtube.com:443 <http://www.youtube.com:443>
>>>   > User-Agent: curl/8.8.0
>>>   > Proxy-Connection: Keep-Alive
>>>   >
>>> < HTTP/1.1 200 Connection established <
>>> * CONNECT phase completed
>>> * CONNECT tunnel established, response 200
>>> * schannel: disabled automatic use of client certificate
>>> * ALPN: curl offers http/1.1
>>> * ALPN: server accepted http/1.1
>>> * using HTTP/1.x
>>>   > GET / HTTP/1.1
>>>   > Host: www.youtube.com <http://www.youtube.com>
>>>   > User-Agent: curl/8.8.0
>>>   > Accept: */*
>>>   >
>>> * Request completely sent off
>>> * schannel: remote party requests renegotiation
>>> * schannel: renegotiating SSL/TLS connection
>>> * schannel: SSL/TLS connection renegotiated < HTTP/1.1 200 OK <
>>> Content-Type: text/html; charset=utf-8 < X-Content-Type-Options:
>>> nosniff < Cache-Control: no-cache, no-store, max-age=0,
>>> must-revalidate < Pragma: no-cache < Expires: Mon, 01 Jan 1990
>>> 00:00:00 GMT < Date: Mon, 19 Aug 2024 23:17:05 GMT <
>>> Strict-Transport-Security: max-age=31536000 < X-Frame-Options:
>>> SAMEORIGIN < Content-Security-Policy: require-trusted-types-for
>>> 'script'
>>> < Permissions-Policy: ch-ua-arch=*, ch-ua-bitness=*,
>>> ch-ua-full-version=*, ch-ua-full-version-list=*, ch-ua-model=*,
>>> ch-ua-wow64=*, ch-ua-form-factors=*, ch-ua-platform=*,
>>> ch-ua-platform-version=*
>>> < Report-To:
>>> {"group":"youtube_main","max_age":2592000,"endpoints":[{"url":"https:
>>> //csp.withgoogle.com/csp/report-to/youtube_main
>>> <https://csp.withgoogle.com/csp/report-to/youtube_main>"}]}
>>> < Origin-Trial:
>>> AmhMBR6zCLzDDxpW+HfpP67BqwIknWnyMOXOQGfzYswFmJe+fgaI6XZgAzcxOrzNtP7hE
>>> AmhMBR6zCLzDDxpW+HfpP67BqwIknWnyMOXOQGfzYswFmJe+DsOo1jdjFnVr2IdxQ4AAA
>>> AmhMBR6zCLzDDxpW+HfpP67BqwIknWnyMOXOQGfzYswFmJe+B4eyJvcmlnaW4iOiJodHR
>>> AmhMBR6zCLzDDxpW+HfpP67BqwIknWnyMOXOQGfzYswFmJe+wczovL3lvdXR1YmUuY29t
>>> AmhMBR6zCLzDDxpW+HfpP67BqwIknWnyMOXOQGfzYswFmJe+OjQ0MyIsImZlYXR1cmUiO
>>> AmhMBR6zCLzDDxpW+HfpP67BqwIknWnyMOXOQGfzYswFmJe+iJXZWJWaWV3WFJlcXVlc3
>>> AmhMBR6zCLzDDxpW+HfpP67BqwIknWnyMOXOQGfzYswFmJe+RlZFdpdGhEZXByZWNhdGl
>>> AmhMBR6zCLzDDxpW+HfpP67BqwIknWnyMOXOQGfzYswFmJe+vbiIsImV4cGlyeSI6MTc1
>>> AmhMBR6zCLzDDxpW+HfpP67BqwIknWnyMOXOQGfzYswFmJe+ODA2NzE5OSwiaXNTdWJkb
>>> AmhMBR6zCLzDDxpW+HfpP67BqwIknWnyMOXOQGfzYswFmJe+21haW4iOnRydWV9
>>> < Cross-Origin-Opener-Policy: same-origin-allow-popups;
>>> report-to="youtube_main"
>>> < P3P: CP="This is not a P3P policy! See
>>> http://support.google.com/accounts/answer/151657?hl=en
>>> <http://support.google.com/accounts/answer/151657?hl=en> for more info."
>>> < Server: ESF
>>> < X-XSS-Protection: 0
>>> < Set-Cookie: GPS=1; Domain=.youtube.com <http://youtube.com>;
>>> Expires=Mon, 19-Aug-2024 23:47:05 GMT; Path=/; Secure; HttpOnly <
>>> Set-Cookie: YSC=OujtWi5Xgqo; Domain=.youtube.com
>>> <http://youtube.com>; Path=/; Secure; HttpOnly; SameSite=none <
>>> Set-Cookie: VISITOR_INFO1_LIVE=PtNdaPPFKOg; Domain=.youtube.com
>>> <http://youtube.com>; Expires=Sat, 15-Feb-2025 23:17:05 GMT; Path=/;
>>> Secure; HttpOnly; SameSite=none < Set-Cookie:
>>> VISITOR_PRIVACY_METADATA=CgJJTBIEGgAgTA%3D%3D;
>>> Domain=.youtube.com <http://youtube.com>; Expires=Sat, 15-Feb-2025
>>> 23:17:05 GMT; Path=/; Secure; HttpOnly; SameSite=none < Alt-Svc:
>>> h3=":443"; ma=2592000,h3-29=":443"; ma=2592000 < Accept-Ranges: none
>>> < Vary: Accept-Encoding < Transfer-Encoding: chunked < { [9490 bytes
>>> data]
>>> 100 16366    0 16366    0     0  32466      0 --:--:-- --:--:--
>>> --:--:-- 32407* schannel: failed to decrypt data, need more data {
>>> [5216 bytes data]
>>> * schannel: failed to decrypt data, need more data { [2756 bytes
>>> data]
>>> * schannel: failed to decrypt data, need more data { [2756 bytes
>>> data]
>>> * schannel: failed to decrypt data, need more data { [2756 bytes
>>> data]
>>> * schannel: failed to decrypt data, need more data { [4134 bytes
>>> data]
>>> * schannel: failed to decrypt data, need more data { [2756 bytes
>>> data]
>>> * schannel: failed to decrypt data, need more data { [21729 bytes
>>> data]
>>> * schannel: failed to decrypt data, need more data { [18982 bytes
>>> data]
>>> * schannel: failed to decrypt data, need more data { [22071 bytes
>>> data]
>>> * schannel: failed to decrypt data, need more data { [6890 bytes
>>> data]
>>> * schannel: failed to decrypt data, need more data { [14848 bytes
>>> data]
>>> * schannel: failed to decrypt data, need more data { [11024 bytes
>>> data]
>>> * schannel: failed to decrypt data, need more data { [10706 bytes
>>> data]
>>> * schannel: failed to decrypt data, need more data { [15158 bytes
>>> data]
>>> * schannel: failed to decrypt data, need more data { [2756 bytes
>>> data]
>>> * schannel: failed to decrypt data, need more data { [10714 bytes
>>> data]
>>> * schannel: failed to decrypt data, need more data { [15180 bytes
>>> data]
>>> * schannel: failed to decrypt data, need more data { [22273 bytes
>>> data]
>>> * schannel: failed to decrypt data, need more data { [44653 bytes
>>> data]
>>> * schannel: failed to decrypt data, need more data { [22048 bytes
>>> data]
>>> * schannel: failed to decrypt data, need more data { [101084 bytes
>>> data]
>>> * schannel: failed to decrypt data, need more data { [4134 bytes
>>> data]
>>> * schannel: failed to decrypt data, need more data { [80712 bytes
>>> data]
>>> * schannel: failed to decrypt data, need more data { [23130 bytes
>>> data]
>>> 100  503k    0  503k    0     0   670k      0 --:--:-- --:--:--
>>> --:--:--   670k
>>> * Connection #0 to host 192.168.66.1 left intact
>>>
>>>
>>> For a direct forward proxy to a sslbump enabled port these are the
>>> results:
>>>
>>> 1724109490.260    217 192.168.78.252 NONE_NONE/200 0 CONNECT
>>> www.youtube.com:443 <http://www.youtube.com:443> -
>>> HIER_DIRECT/142.250.181.238 <http://142.250.181.238> -
>>> www.youtube.com <http://www.youtube.com>
>>> 1724109490.947    686 192.168.78.252 TCP_MISS/200 516442 GET
>>> https://www.youtube.com/ <https://www.youtube.com/> -
>>> HIER_DIRECT/142.250.181.238 <http://142.250.181.238> text/html
>>> www.youtube.com <http://www.youtube.com>
>>>
>>> PS C:\Users\eliez> curl -x http://192.168.66.1:13128
>>> <http://192.168.66.1:13128> -v -k https://www.youtube.com/
>>> <https://www.youtube.com/>  -o 1.txt
>>>     % Total    % Received % Xferd  Average Speed   Time    Time
>>> Time   Current
>>>                                    Dload  Upload   Total   Spent
>>>   Left   Speed
>>>     0     0    0     0    0     0      0      0 --:--:-- --:--:--
>>> --:--:--     0*   Trying 192.168.66.1:13128...
>>> * Connected to 192.168.66.1 (192.168.66.1) port 13128
>>> * CONNECT tunnel: HTTP/1.1 negotiated
>>> * allocate connect buffer
>>> * Establish HTTP proxy tunnel to www.youtube.com:443
>>> <http://www.youtube.com:443>
>>>   > CONNECT www.youtube.com:443 <http://www.youtube.com:443> HTTP/1.1
>>>   > Host: www.youtube.com:443 <http://www.youtube.com:443>
>>>   > User-Agent: curl/8.8.0
>>>   > Proxy-Connection: Keep-Alive
>>>   >
>>> < HTTP/1.1 200 Connection established <
>>> * CONNECT phase completed
>>> * CONNECT tunnel established, response 200
>>> * schannel: disabled automatic use of client certificate
>>> * ALPN: curl offers http/1.1
>>> * ALPN: server did not agree on a protocol. Uses default.
>>> * using HTTP/1.x
>>>   > GET / HTTP/1.1
>>>   > Host: www.youtube.com <http://www.youtube.com>
>>>   > User-Agent: curl/8.8.0
>>>   > Accept: */*
>>>   >
>>> * Request completely sent off
>>> * schannel: remote party requests renegotiation
>>> * schannel: renegotiating SSL/TLS connection
>>> * schannel: SSL/TLS connection renegotiated
>>> * schannel: remote party requests renegotiation
>>> * schannel: renegotiating SSL/TLS connection
>>> * schannel: SSL/TLS connection renegotiated < HTTP/1.1 200 OK <
>>> Content-Type: text/html; charset=utf-8 < X-Content-Type-Options:
>>> nosniff < Cache-Control: no-cache, no-store, max-age=0,
>>> must-revalidate < Pragma: no-cache < Expires: Mon, 01 Jan 1990
>>> 00:00:00 GMT < Date: Mon, 19 Aug 2024 23:18:10 GMT <
>>> Strict-Transport-Security: max-age=31536000 < X-Frame-Options:
>>> SAMEORIGIN < Content-Security-Policy: require-trusted-types-for
>>> 'script'
>>> < Origin-Trial:
>>> AmhMBR6zCLzDDxpW+HfpP67BqwIknWnyMOXOQGfzYswFmJe+fgaI6XZgAzcxOrzNtP7hE
>>> AmhMBR6zCLzDDxpW+HfpP67BqwIknWnyMOXOQGfzYswFmJe+DsOo1jdjFnVr2IdxQ4AAA
>>> AmhMBR6zCLzDDxpW+HfpP67BqwIknWnyMOXOQGfzYswFmJe+B4eyJvcmlnaW4iOiJodHR
>>> AmhMBR6zCLzDDxpW+HfpP67BqwIknWnyMOXOQGfzYswFmJe+wczovL3lvdXR1YmUuY29t
>>> AmhMBR6zCLzDDxpW+HfpP67BqwIknWnyMOXOQGfzYswFmJe+OjQ0MyIsImZlYXR1cmUiO
>>> AmhMBR6zCLzDDxpW+HfpP67BqwIknWnyMOXOQGfzYswFmJe+iJXZWJWaWV3WFJlcXVlc3
>>> AmhMBR6zCLzDDxpW+HfpP67BqwIknWnyMOXOQGfzYswFmJe+RlZFdpdGhEZXByZWNhdGl
>>> AmhMBR6zCLzDDxpW+HfpP67BqwIknWnyMOXOQGfzYswFmJe+vbiIsImV4cGlyeSI6MTc1
>>> AmhMBR6zCLzDDxpW+HfpP67BqwIknWnyMOXOQGfzYswFmJe+ODA2NzE5OSwiaXNTdWJkb
>>> AmhMBR6zCLzDDxpW+HfpP67BqwIknWnyMOXOQGfzYswFmJe+21haW4iOnRydWV9
>>> < Cross-Origin-Opener-Policy: same-origin-allow-popups;
>>> report-to="youtube_main"
>>> < Permissions-Policy: ch-ua-arch=*, ch-ua-bitness=*,
>>> ch-ua-full-version=*, ch-ua-full-version-list=*, ch-ua-model=*,
>>> ch-ua-wow64=*, ch-ua-form-factors=*, ch-ua-platform=*,
>>> ch-ua-platform-version=*
>>> < Report-To:
>>> {"group":"youtube_main","max_age":2592000,"endpoints":[{"url":"https:
>>> //csp.withgoogle.com/csp/report-to/youtube_main
>>> <https://csp.withgoogle.com/csp/report-to/youtube_main>"}]}
>>> < P3P: CP="This is not a P3P policy! See
>>> http://support.google.com/accounts/answer/151657?hl=en
>>> <http://support.google.com/accounts/answer/151657?hl=en> for more info."
>>> < Server: ESF
>>> < X-XSS-Protection: 0
>>> < Set-Cookie: GPS=1; Domain=.youtube.com <http://youtube.com>;
>>> Expires=Mon, 19-Aug-2024 23:48:10 GMT; Path=/; Secure; HttpOnly <
>>> Set-Cookie: YSC=6pPz8lVi60s; Domain=.youtube.com
>>> <http://youtube.com>; Path=/; Secure; HttpOnly; SameSite=none <
>>> Set-Cookie: VISITOR_INFO1_LIVE=zD4fzRwONpc; Domain=.youtube.com
>>> <http://youtube.com>; Expires=Sat, 15-Feb-2025 23:18:10 GMT; Path=/;
>>> Secure; HttpOnly; SameSite=none < Set-Cookie:
>>> VISITOR_PRIVACY_METADATA=CgJJTBIEGgAgOQ%3D%3D;
>>> Domain=.youtube.com <http://youtube.com>; Expires=Sat, 15-Feb-2025
>>> 23:18:10 GMT; Path=/; Secure; HttpOnly; SameSite=none < Alt-Svc:
>>> h3=":443"; ma=2592000,h3-29=":443"; ma=2592000 < Accept-Ranges: none
>>> < Vary: Accept-Encoding < X-Cache: MISS from 005-NgTech-Home-Proxy-1
>>> < X-Cache-Lookup: MISS from 005-NgTech-Home-Proxy-1:3128 <
>>> Transfer-Encoding: chunked < Via: 1.1 005-NgTech-Home-Proxy-1
>>> (squid/5.9) < Connection: keep-alive < { [7370 bytes data]
>>> 100 27390    0 27390    0     0  35637      0 --:--:-- --:--:--
>>> --:--:-- 35617* schannel: failed to decrypt data, need more data {
>>> [2770 bytes data]
>>> * schannel: failed to decrypt data, need more data { [21842 bytes
>>> data]
>>> * schannel: failed to decrypt data, need more data { [21834 bytes
>>> data]
>>> * schannel: failed to decrypt data, need more data { [10776 bytes
>>> data]
>>> * schannel: failed to decrypt data, need more data { [11080 bytes
>>> data]
>>> * schannel: failed to decrypt data, need more data { [100491 bytes
>>> data]
>>> 100  499k    0  499k    0     0   488k      0 --:--:--  0:00:01
>>> --:--:--   489k
>>> * Connection #0 to host 192.168.66.1 left intact
>>>
>>> Now for the second part which is to play with the ssl_bump options.
>>> currently the options I am using are:
>>> ssl_bump peek step1
>>> ssl_bump bump all
>>>
>>> So now I will try to change them a bit.
>>>
>>> For a direct curl request to the intercept with ssl bump port I get
>>> the next logs:
>>>
>>>
>>>
>>> 2024/08/20 02:23:18 kid1| SECURITY ALERT: Host header forgery
>>> detected on conn364 local=192.168.66.1:33128
>>> <http://192.168.66.1:33128>
>>> remote=192.168.78.252:40721 <http://192.168.78.252:40721> FD 10
>>> flags=33 (intercepted port does not match 443)
>>>       current master transaction: master118
>>> 2024/08/20 02:23:18 kid1| SECURITY ALERT: By user agent: curl/8.8.0
>>>       current master transaction: master118
>>> 2024/08/20 02:23:18 kid1| SECURITY ALERT: on URL: www.youtube.com:443
>>> <http://www.youtube.com:443>
>>>       current master transaction: master118
>>> 2024/08/20 02:23:18 kid1| kick abandoning conn364
>>> local=192.168.66.1:33128 <http://192.168.66.1:33128>
>>> remote=192.168.78.252:40721 <http://192.168.78.252:40721> FD 10
>>> flags=33
>>>       connection: conn364 local=192.168.66.1:33128
>>> <http://192.168.66.1:33128> remote=192.168.78.252:40721
>>> <http://192.168.78.252:40721> FD 10 flags=33
>>>
>>> ==> /var/log/squid/access.log <==
>>> 1724109798.106      0 192.168.78.252 NONE_NONE/409 4177 CONNECT
>>> www.youtube.com:443 <http://www.youtube.com:443> - HIER_NONE/-
>>> text/html -
>>>
>>> PS C:\Users\eliez> curl -x http://192.168.66.1:33128
>>> <http://192.168.66.1:33128> -v -k https://www.youtube.com/
>>> <https://www.youtube.com/>  -o 1.txt
>>>     % Total    % Received % Xferd  Average Speed   Time    Time
>>> Time   Current
>>>                                    Dload  Upload   Total   Spent
>>>   Left   Speed
>>>     0     0    0     0    0     0      0      0 --:--:-- --:--:--
>>> --:--:--     0*   Trying 192.168.66.1:33128...
>>> * Connected to 192.168.66.1 (192.168.66.1) port 33128
>>> * CONNECT tunnel: HTTP/1.1 negotiated
>>> * allocate connect buffer
>>> * Establish HTTP proxy tunnel to www.youtube.com:443
>>> <http://www.youtube.com:443>
>>>   > CONNECT www.youtube.com:443 <http://www.youtube.com:443> HTTP/1.1
>>>   > Host: www.youtube.com:443 <http://www.youtube.com:443>
>>>   > User-Agent: curl/8.8.0
>>>   > Proxy-Connection: Keep-Alive
>>>   >
>>> < HTTP/1.1 409 Conflict
>>> < Server: squid/5.9
>>> < Mime-Version: 1.0
>>> < Date: Mon, 19 Aug 2024 23:23:18 GMT < Content-Type:
>>> text/html;charset=utf-8 < Content-Length: 3765 < X-Squid-Error:
>>> ERR_CONFLICT_HOST 0 < Vary: Accept-Language < Content-Language: en <
>>> X-Cache: MISS from 005-NgTech-Home-Proxy-1 < X-Cache-Lookup: NONE
>>> from 005-NgTech-Home-Proxy-1:3128 < Via: 1.1 005-NgTech-Home-Proxy-1
>>> (squid/5.9) < Connection: keep-alive <
>>> * CONNECT tunnel failed, response 409
>>>     0     0    0     0    0     0      0      0 --:--:-- --:--:--
>>> --:--:--     0
>>> * Closing connection
>>> curl: (56) CONNECT tunnel failed, response 409
>>>
>>> With a Splice all the results are:
>>> Access log:
>>> 1724109929.178      0 192.168.78.252 NONE_NONE/000 0 -
>>> error:invalid-request - HIER_NONE/- - -
>>> 1724109930.776   1598 192.168.78.252 TCP_TUNNEL/200 531067 -
>>> 142.250.185.78:443 <http://142.250.185.78:443> -
>>> ORIGINAL_DST/142.250.185.78 <http://142.250.185.78> - -
>>>
>>> PS C:\Users\eliez> curl -v -k https://www.youtube.com/
>>> <https://www.youtube.com/>  -o 1.txt
>>>     % Total    % Received % Xferd  Average Speed   Time    Time
>>> Time   Current
>>>                                    Dload  Upload   Total   Spent
>>>   Left   Speed
>>>     0     0    0     0    0     0      0      0 --:--:-- --:--:--
>>> --:--:--     0* Host www.youtube.com:443 <http://www.youtube.com:443>
>>> was resolved.
>>> * IPv6: 2a00:1450:4001:81c::200e, 2a00:1450:4001:809::200e,
>>> 2a00:1450:4001:800::200e, 2a00:1450:4001:80e::200e
>>> * IPv4: 142.250.185.78, 142.250.185.110, 142.250.185.142,
>>> 142.250.186.174, 142.250.185.174, 142.250.184.238, 142.250.185.238,
>>> 142.250.185.206, 142.250.181.238, 142.250.186.46, 142.250.186.78,
>>> 172.217.16.142, 216.58.212.174, 216.58.206.46, 172.217.18.110,
>>> 172.217.23.110
>>> *   Trying [2a00:1450:4001:81c::200e]:443...
>>> *   Trying 142.250.185.78:443...
>>> * Connected to www.youtube.com <http://www.youtube.com>
>>> (142.250.185.78) port 443
>>> * schannel: disabled automatic use of client certificate
>>> * ALPN: curl offers http/1.1
>>> * ALPN: server accepted http/1.1
>>> * using HTTP/1.x
>>>   > GET / HTTP/1.1
>>>   > Host: www.youtube.com <http://www.youtube.com>
>>>   > User-Agent: curl/8.8.0
>>>   > Accept: */*
>>>   >
>>> * Request completely sent off
>>> * schannel: remote party requests renegotiation
>>> * schannel: renegotiating SSL/TLS connection
>>> * schannel: SSL/TLS connection renegotiated
>>> * schannel: failed to decrypt data, need more data < HTTP/1.1 200 OK
>>> < Content-Type: text/html; charset=utf-8 < X-Content-Type-Options:
>>> nosniff < Cache-Control: no-cache, no-store, max-age=0,
>>> must-revalidate < Pragma: no-cache < Expires: Mon, 01 Jan 1990
>>> 00:00:00 GMT < Date: Mon, 19 Aug 2024 23:25:29 GMT <
>>> Strict-Transport-Security: max-age=31536000 < X-Frame-Options:
>>> SAMEORIGIN < Permissions-Policy: ch-ua-arch=*, ch-ua-bitness=*,
>>> ch-ua-full-version=*, ch-ua-full-version-list=*, ch-ua-model=*,
>>> ch-ua-wow64=*, ch-ua-form-factors=*, ch-ua-platform=*,
>>> ch-ua-platform-version=*
>>> < Content-Security-Policy: require-trusted-types-for 'script'
>>> < Cross-Origin-Opener-Policy: same-origin-allow-popups;
>>> report-to="youtube_main"
>>> < Report-To:
>>> {"group":"youtube_main","max_age":2592000,"endpoints":[{"url":"https:
>>> //csp.withgoogle.com/csp/report-to/youtube_main
>>> <https://csp.withgoogle.com/csp/report-to/youtube_main>"}]}
>>> < Origin-Trial:
>>> AmhMBR6zCLzDDxpW+HfpP67BqwIknWnyMOXOQGfzYswFmJe+fgaI6XZgAzcxOrzNtP7hE
>>> AmhMBR6zCLzDDxpW+HfpP67BqwIknWnyMOXOQGfzYswFmJe+DsOo1jdjFnVr2IdxQ4AAA
>>> AmhMBR6zCLzDDxpW+HfpP67BqwIknWnyMOXOQGfzYswFmJe+B4eyJvcmlnaW4iOiJodHR
>>> AmhMBR6zCLzDDxpW+HfpP67BqwIknWnyMOXOQGfzYswFmJe+wczovL3lvdXR1YmUuY29t
>>> AmhMBR6zCLzDDxpW+HfpP67BqwIknWnyMOXOQGfzYswFmJe+OjQ0MyIsImZlYXR1cmUiO
>>> AmhMBR6zCLzDDxpW+HfpP67BqwIknWnyMOXOQGfzYswFmJe+iJXZWJWaWV3WFJlcXVlc3
>>> AmhMBR6zCLzDDxpW+HfpP67BqwIknWnyMOXOQGfzYswFmJe+RlZFdpdGhEZXByZWNhdGl
>>> AmhMBR6zCLzDDxpW+HfpP67BqwIknWnyMOXOQGfzYswFmJe+vbiIsImV4cGlyeSI6MTc1
>>> AmhMBR6zCLzDDxpW+HfpP67BqwIknWnyMOXOQGfzYswFmJe+ODA2NzE5OSwiaXNTdWJkb
>>> AmhMBR6zCLzDDxpW+HfpP67BqwIknWnyMOXOQGfzYswFmJe+21haW4iOnRydWV9
>>> < P3P: CP="This is not a P3P policy! See
>>> http://support.google.com/accounts/answer/151657?hl=en
>>> <http://support.google.com/accounts/answer/151657?hl=en> for more info."
>>> < Server: ESF
>>> < X-XSS-Protection: 0
>>> < Set-Cookie: GPS=1; Domain=.youtube.com <http://youtube.com>;
>>> Expires=Mon, 19-Aug-2024 23:55:29 GMT; Path=/; Secure; HttpOnly <
>>> Set-Cookie: YSC=O3fSKdGlL-Q; Domain=.youtube.com
>>> <http://youtube.com>; Path=/; Secure; HttpOnly; SameSite=none <
>>> Set-Cookie: VISITOR_INFO1_LIVE=2PPYvkk_Sbo; Domain=.youtube.com
>>> <http://youtube.com>; Expires=Sat, 15-Feb-2025 23:25:29 GMT; Path=/;
>>> Secure; HttpOnly; SameSite=none < Set-Cookie:
>>> VISITOR_PRIVACY_METADATA=CgJJTBIEGgAgGA%3D%3D;
>>> Domain=.youtube.com <http://youtube.com>; Expires=Sat, 15-Feb-2025
>>> 23:25:29 GMT; Path=/; Secure; HttpOnly; SameSite=none < Alt-Svc:
>>> h3=":443"; ma=2592000,h3-29=":443"; ma=2592000 < Accept-Ranges: none
>>> < Vary: Accept-Encoding < Transfer-Encoding: chunked < { [3674 bytes
>>> data]
>>> 100 24634    0 24634    0     0  31895      0 --:--:-- --:--:--
>>> --:--:-- 32033* schannel: failed to decrypt data, need more data {
>>> [2460 bytes data]
>>> * schannel: failed to decrypt data, need more data { [2756 bytes
>>> data]
>>> * schannel: failed to decrypt data, need more data { [2756 bytes
>>> data]
>>> * schannel: failed to decrypt data, need more data { [2756 bytes
>>> data]
>>> * schannel: failed to decrypt data, need more data { [2756 bytes
>>> data]
>>> * schannel: failed to decrypt data, need more data { [2756 bytes
>>> data]
>>> * schannel: failed to decrypt data, need more data { [21728 bytes
>>> data]
>>> * schannel: failed to decrypt data, need more data { [16536 bytes
>>> data]
>>> * schannel: failed to decrypt data, need more data { [1068 bytes
>>> data]
>>> * schannel: failed to decrypt data, need more data { [22072 bytes
>>> data]
>>> * schannel: failed to decrypt data, need more data { [4134 bytes
>>> data]
>>> * schannel: failed to decrypt data, need more data { [5512 bytes
>>> data]
>>> * schannel: failed to decrypt data, need more data { [5512 bytes
>>> data]
>>> * schannel: failed to decrypt data, need more data { [9336 bytes
>>> data]
>>> * schannel: failed to decrypt data, need more data { [4134 bytes
>>> data]
>>> * schannel: failed to decrypt data, need more data { [4134 bytes
>>> data]
>>> * schannel: failed to decrypt data, need more data { [8268 bytes
>>> data]
>>> * schannel: failed to decrypt data, need more data { [7949 bytes
>>> data]
>>> * schannel: failed to decrypt data, need more data { [2756 bytes
>>> data]
>>> * schannel: failed to decrypt data, need more data { [11024 bytes
>>> data]
>>> * schannel: failed to decrypt data, need more data { [6890 bytes
>>> data]
>>> * schannel: failed to decrypt data, need more data { [5512 bytes
>>> data]
>>> * schannel: failed to decrypt data, need more data { [2446 bytes
>>> data]
>>> * schannel: failed to decrypt data, need more data { [22071 bytes
>>> data]
>>> * schannel: failed to decrypt data, need more data { [35526 bytes
>>> data]
>>> * schannel: failed to decrypt data, need more data { [18974 bytes
>>> data]
>>> * schannel: failed to decrypt data, need more data { [23450 bytes
>>> data]
>>> * schannel: failed to decrypt data, need more data { [58662 bytes
>>> data]
>>> * schannel: failed to decrypt data, need more data { [21752 bytes
>>> data]
>>> * schannel: failed to decrypt data, need more data { [42424 bytes
>>> data]
>>> * schannel: failed to decrypt data, need more data { [12402 bytes
>>> data]
>>> * schannel: failed to decrypt data, need more data { [42422 bytes
>>> data]
>>> * schannel: failed to decrypt data, need more data { [7972 bytes
>>> data]
>>> * schannel: failed to decrypt data, need more data { [4134 bytes
>>> data]
>>> 100  501k    0  501k    0     0   496k      0 --:--:--  0:00:01
>>> --:--:--   498k
>>> * Connection #0 to host www.youtube.com <http://www.youtube.com> left
>>> intact
>>>
>>> I am unsure if to continue but I will test again the next ssl bump
>>> rules (maybe I got your instructions wrong):
>>> ssl_bump peek all
>>> ssl_bump bump all
>>>
>>> Access.log
>>> 1724110080.231      0 192.168.78.252 NONE_NONE/000 0 -
>>> error:invalid-request - HIER_NONE/- - -
>>> 1724110081.819   1587 192.168.78.252 TCP_TUNNEL/200 532898 -
>>> 142.250.185.78:443 <http://142.250.185.78:443> -
>>> ORIGINAL_DST/142.250.185.78 <http://142.250.185.78> - -
>>>
>>> Curl:
>>> PS C:\Users\eliez> curl -v -k https://www.youtube.com/
>>> <https://www.youtube.com/>  -o 1.txt
>>>     % Total    % Received % Xferd  Average Speed   Time    Time
>>> Time   Current
>>>                                    Dload  Upload   Total   Spent
>>>   Left   Speed
>>>     0     0    0     0    0     0      0      0 --:--:-- --:--:--
>>> --:--:--     0* Host www.youtube.com:443 <http://www.youtube.com:443>
>>> was resolved.
>>> * IPv6: 2a00:1450:4001:80e::200e, 2a00:1450:4001:80f::200e,
>>> 2a00:1450:4001:810::200e, 2a00:1450:4001:82b::200e
>>> * IPv4: 142.250.185.78, 142.250.185.110, 142.250.185.142,
>>> 142.250.186.174, 142.250.185.174, 142.250.184.238, 142.250.185.238,
>>> 142.250.185.206, 142.250.181.238, 142.250.186.46, 142.250.186.78,
>>> 172.217.16.142, 216.58.212.174, 216.58.206.46, 172.217.18.110,
>>> 172.217.23.110
>>> *   Trying [2a00:1450:4001:80e::200e]:443...
>>> *   Trying 142.250.185.78:443...
>>> * Connected to www.youtube.com <http://www.youtube.com>
>>> (142.250.185.78) port 443
>>> * schannel: disabled automatic use of client certificate
>>> * ALPN: curl offers http/1.1
>>> * ALPN: server accepted http/1.1
>>> * using HTTP/1.x
>>>   > GET / HTTP/1.1
>>>   > Host: www.youtube.com <http://www.youtube.com>
>>>   > User-Agent: curl/8.8.0
>>>   > Accept: */*
>>>   >
>>> * Request completely sent off
>>> * schannel: remote party requests renegotiation
>>> * schannel: renegotiating SSL/TLS connection
>>> * schannel: SSL/TLS connection renegotiated
>>> * schannel: failed to decrypt data, need more data < HTTP/1.1 200 OK
>>> < Content-Type: text/html; charset=utf-8 < X-Content-Type-Options:
>>> nosniff < Cache-Control: no-cache, no-store, max-age=0,
>>> must-revalidate < Pragma: no-cache < Expires: Mon, 01 Jan 1990
>>> 00:00:00 GMT < Date: Mon, 19 Aug 2024 23:28:00 GMT < X-Frame-Options:
>>> SAMEORIGIN < Strict-Transport-Security: max-age=31536000 <
>>> Cross-Origin-Opener-Policy: same-origin-allow-popups;
>>> report-to="youtube_main"
>>> < Content-Security-Policy: require-trusted-types-for 'script'
>>> < Report-To:
>>> {"group":"youtube_main","max_age":2592000,"endpoints":[{"url":"https:
>>> //csp.withgoogle.com/csp/report-to/youtube_main
>>> <https://csp.withgoogle.com/csp/report-to/youtube_main>"}]}
>>> < Origin-Trial:
>>> AmhMBR6zCLzDDxpW+HfpP67BqwIknWnyMOXOQGfzYswFmJe+fgaI6XZgAzcxOrzNtP7hE
>>> AmhMBR6zCLzDDxpW+HfpP67BqwIknWnyMOXOQGfzYswFmJe+DsOo1jdjFnVr2IdxQ4AAA
>>> AmhMBR6zCLzDDxpW+HfpP67BqwIknWnyMOXOQGfzYswFmJe+B4eyJvcmlnaW4iOiJodHR
>>> AmhMBR6zCLzDDxpW+HfpP67BqwIknWnyMOXOQGfzYswFmJe+wczovL3lvdXR1YmUuY29t
>>> AmhMBR6zCLzDDxpW+HfpP67BqwIknWnyMOXOQGfzYswFmJe+OjQ0MyIsImZlYXR1cmUiO
>>> AmhMBR6zCLzDDxpW+HfpP67BqwIknWnyMOXOQGfzYswFmJe+iJXZWJWaWV3WFJlcXVlc3
>>> AmhMBR6zCLzDDxpW+HfpP67BqwIknWnyMOXOQGfzYswFmJe+RlZFdpdGhEZXByZWNhdGl
>>> AmhMBR6zCLzDDxpW+HfpP67BqwIknWnyMOXOQGfzYswFmJe+vbiIsImV4cGlyeSI6MTc1
>>> AmhMBR6zCLzDDxpW+HfpP67BqwIknWnyMOXOQGfzYswFmJe+ODA2NzE5OSwiaXNTdWJkb
>>> AmhMBR6zCLzDDxpW+HfpP67BqwIknWnyMOXOQGfzYswFmJe+21haW4iOnRydWV9
>>> < Permissions-Policy: ch-ua-arch=*, ch-ua-bitness=*,
>>> ch-ua-full-version=*, ch-ua-full-version-list=*, ch-ua-model=*,
>>> ch-ua-wow64=*, ch-ua-form-factors=*, ch-ua-platform=*,
>>> ch-ua-platform-version=*
>>> < P3P: CP="This is not a P3P policy! See
>>> http://support.google.com/accounts/answer/151657?hl=en
>>> <http://support.google.com/accounts/answer/151657?hl=en> for more info."
>>> < Server: ESF
>>> < X-XSS-Protection: 0
>>> < Set-Cookie: GPS=1; Domain=.youtube.com <http://youtube.com>;
>>> Expires=Mon, 19-Aug-2024 23:58:00 GMT; Path=/; Secure; HttpOnly <
>>> Set-Cookie: YSC=zO-uFscIOFo; Domain=.youtube.com
>>> <http://youtube.com>; Path=/; Secure; HttpOnly; SameSite=none <
>>> Set-Cookie: VISITOR_INFO1_LIVE=ewGx6w06928; Domain=.youtube.com
>>> <http://youtube.com>; Expires=Sat, 15-Feb-2025 23:28:00 GMT; Path=/;
>>> Secure; HttpOnly; SameSite=none < Set-Cookie:
>>> VISITOR_PRIVACY_METADATA=CgJJTBIEGgAgFA%3D%3D;
>>> Domain=.youtube.com <http://youtube.com>; Expires=Sat, 15-Feb-2025
>>> 23:28:00 GMT; Path=/; Secure; HttpOnly; SameSite=none < Alt-Svc:
>>> h3=":443"; ma=2592000,h3-29=":443"; ma=2592000 < Accept-Ranges: none
>>> < Vary: Accept-Encoding < Transfer-Encoding: chunked < { [3674 bytes
>>> data]
>>> 100 16366    0 16366    0     0  23561      0 --:--:-- --:--:--
>>> --:--:-- 23684* schannel: failed to decrypt data, need more data {
>>> [1082 bytes data]
>>> * schannel: failed to decrypt data, need more data { [2756 bytes
>>> data]
>>> * schannel: failed to decrypt data, need more data { [2756 bytes
>>> data]
>>> * schannel: failed to decrypt data, need more data { [2756 bytes
>>> data]
>>> * schannel: failed to decrypt data, need more data { [2756 bytes
>>> data]
>>> * schannel: failed to decrypt data, need more data { [2756 bytes
>>> data]
>>> * schannel: failed to decrypt data, need more data { [4134 bytes
>>> data]
>>> * schannel: failed to decrypt data, need more data { [2436 bytes
>>> data]
>>> * schannel: failed to decrypt data, need more data { [2756 bytes
>>> data]
>>> * schannel: failed to decrypt data, need more data { [2756 bytes
>>> data]
>>> * schannel: failed to decrypt data, need more data { [20670 bytes
>>> data]
>>> * schannel: failed to decrypt data, need more data { [25896 bytes
>>> data]
>>> * schannel: failed to decrypt data, need more data { [20670 bytes
>>> data]
>>> * schannel: failed to decrypt data, need more data { [2756 bytes
>>> data]
>>> * schannel: failed to decrypt data, need more data { [6580 bytes
>>> data]
>>> * schannel: failed to decrypt data, need more data { [11024 bytes
>>> data]
>>> * schannel: failed to decrypt data, need more data { [5193 bytes
>>> data]
>>> * schannel: failed to decrypt data, need more data { [5512 bytes
>>> data]
>>> * schannel: failed to decrypt data, need more data { [11024 bytes
>>> data]
>>> * schannel: failed to decrypt data, need more data { [2756 bytes
>>> data]
>>> * schannel: failed to decrypt data, need more data { [9646 bytes
>>> data]
>>> * schannel: failed to decrypt data, need more data { [2756 bytes
>>> data]
>>> * schannel: failed to decrypt data, need more data { [9336 bytes
>>> data]
>>> * schannel: failed to decrypt data, need more data { [2756 bytes
>>> data]
>>> * schannel: failed to decrypt data, need more data { [13803 bytes
>>> data]
>>> * schannel: failed to decrypt data, need more data { [6890 bytes
>>> data]
>>> * schannel: failed to decrypt data, need more data { [21746 bytes
>>> data]
>>> * schannel: failed to decrypt data, need more data { [56204 bytes
>>> data]
>>> * schannel: failed to decrypt data, need more data { [7972 bytes
>>> data]
>>> * schannel: failed to decrypt data, need more data { [6890 bytes
>>> data]
>>> * schannel: failed to decrypt data, need more data { [23130 bytes
>>> data]
>>> * schannel: failed to decrypt data, need more data { [54824 bytes
>>> data]
>>> * schannel: failed to decrypt data, need more data { [23130 bytes
>>> data]
>>> * schannel: failed to decrypt data, need more data { [74118 bytes
>>> data]
>>> 100  503k    0  503k    0     0   531k      0 --:--:-- --:--:--
>>> --:--:--   533k
>>> * Connection #0 to host www.youtube.com <http://www.youtube.com> left
>>> intact
>>>
>>> This is all the same with both 5.9 and 6.10 as far as I can tell.
>>>
>>> I know it's a lot of logs but it seems like the problem is well
>>> understood.
>>> All the above tests are done using the DNAT REDIRECT method.
>>>
>>> Just take into account that the next are also present in squid.conf
>>>
>>> acl foreignProtocol squid_error ERR_PROTOCOL_UNKNOWN ERR_TOO_BIG acl
>>> serverTalksFirstProtocol squid_error ERR_REQUEST_START_TIMEOUT
>>>
>>>
>>> on_unsupported_protocol tunnel foreignProtocol
>>> on_unsupported_protocol tunnel serverTalksFirstProtocol
>>> on_unsupported_protocol respond all
>>>
>>>
>>> If you need me to test other things please let me know.
>>>
>>> Eliezer
>>>
>>> ----
>>> Eliezer Croitoru
>>> Tech Support
>>> Mobile: +972-5-28704261
>>> Email: ngtech1ltd at gmail.com <mailto:ngtech1ltd at gmail.com>
>>>
>>>
>>> On Mon, Aug 19, 2024 at 10:59?PM Alex Rousskov
>>> <rousskov at measurement-factory.com
>>> <mailto:rousskov at measurement-factory.com>> wrote:
>>>
>>>      On 2024-08-19 15:27, ngtech1ltd at gmail.com
>>>      <mailto:ngtech1ltd at gmail.com> wrote:
>>>
>>>       > I see that there is a SNI so I am not sure how to look at the
>>> issue.
>>>
>>>      FWIW, as the next step, I still recommend answering the remaining
>>> open
>>>      questions. Everything else makes a facinating read but is less
>>>      likely to
>>>      help us make progress (and may obscure/hide actual answers and
>>> test
>>>      results). I will restate those remaining questions for your
>>> convenience:
>>>
>>>      * Do all those 12 access.log records correspond to a single curl
>>>      request? If not, please only share access.log record(s) that do
>>>      correspond.
>>>
>>>      2. Does everything work for non-intercept ports? Use the same
>>> curl test
>>>      you have shared below, but specify proxy address for curl to use.
>>>
>>>      4. Does everything work when you remove "ssl-bump" and related
>>> options
>>>      from intercepting http_port 33128 (and use that intercepted port
>>> in the
>>>      same curl test)?
>>>
>>>      5. Does everything work when you use "ssl_bump splice all"
>>> instead of
>>>      your current ssl_bump rule? Same curl parameters as in Q4.
>>>
>>>      6. Does everything work when you use "ssl_bump peek all" instead
>>> of
>>>      your
>>>      current ssl_bump rule? Same curl parameters as in Q4.
>>>
>>>
>>>      While going through the above list, top to bottom, if you find a
>>> test
>>>      that does _not_ work, pause: There is no need to proceed with
>>> other,
>>>      more complicated tests if an earlier simpler/basic test fails.
>>>
>>>
>>>      HTH,
>>>
>>>      Alex.
>>>
>>>
>>>       > I was thinking that maybe it's something with the OpenSSL
>>> version
>>>      (3.x.x) on Fedora but then I installed both 5.9 and 6.10 on
>>>      Almalinux 8 and the result is the same.
>>>       >
>>>       > I will describe my setup which might give some background.
>>>       > I have a very big lab...
>>>       > In the front of the Internet connection there are couple NGFW
>>>      devices and RouterOS.
>>>       > Mikrotik RouterOS is the edge and all the others are used with
>>>      PBR accordingly.
>>>       > The proxy sits in a deferent segment on the network and I have
>>>      tried couple methods to intercept the traffic with squid.
>>>       > The only one which works with Squid and the existing equipment
>>>      and do not cause some weird loop is ethernet level tunnel ie not:
>>>       > * GRE
>>>       > * IPIP
>>>       > And couple others.
>>>       >
>>>       > The only ones which works fine are:
>>>       > * EoIP (Mikrotik which is based on GRE0
>>>       > * VxLAN
>>>       >
>>>       > There are two methods to intercept the traffic:
>>>       > * PBR+DNAT on the squid box
>>>       > * PBR+TPROXY on the squid box
>>>       >
>>>       > Since the intercept method terminates the connection and
>>> creates
>>>      a new one with the ip of the proxy it's very simple to even use
>>> gre
>>>      and ipip.
>>>       > But, with tproxy to allow the traffic being identified
>>> currently
>>>      as a packet which is not still in the routing stack we the linux
>>> OS
>>>      need to tag it somehow.
>>>       > To do that the default "Salt" for the packet hash in the
>>> routing
>>>      stack is the source and destination mac address.
>>>       > Due to this the only methods which are allowing to use tproxy
>>> are
>>>      the above mentioned tunnels. (Maybe I will post a video on it
>>> later
>>>      on with a demo)
>>>       >
>>>       > The Mikrotik RouterOS device re-routes the traffic from the
>>> LAN
>>>      interface into the VxLAN interface directly to the proxy machine
>>>      which has a
>>>       > static or dynamic route to the LAN subnet via the other side
>>> of
>>>      the VxLAN tunnel which is the edge RouterOS device.
>>>       > I want to gather a set of configurations and tests for this
>>>      configurations to verify what might cause this issue and if
>>> possible
>>>      to resolve it.
>>>       > For me it seems that if my FortiGate and CheckPoint devices
>>> are
>>>      able to intercept the traffic and "Bump" it, there is no reason
>>> why
>>>      squid should
>>>       > be able to do that the same way.
>>>       >
>>>       > I will later on send you a private link to the pcaps in a zip
>>>      file so you would be able to inspect this issue in the network
>>> level
>>>      and to see if there is
>>>       > some details which can help us understand what cause this
>>>      specific issue.
>>>       >
>>>       > I want to say that bumping works fine on non-intercepted
>>>      connections and that I have tested the interception with the two
>>>      available methods ie:
>>>       > * DNAT Redirect
>>>       > * Tproxy
>>>       >
>>>       > Thanks,
>>>       > Eliezer Croitoru
>>>       >
>>>       > -----Original Message-----
>>>       > From: Alex Rousskov <rousskov at measurement-factory.com
>>>      <mailto:rousskov at measurement-factory.com>>
>>>       > Sent: Monday, August 19, 2024 7:18 PM
>>>       > To: NgTech LTD <ngtech1ltd at gmail.com
>>> <mailto:ngtech1ltd at gmail.com>>
>>>       > Subject: Re: [squid-users] Squid 6.10 on Fedora 40 cannot
>>>      intercept and bump SSL Traffic
>>>       >
>>>       > Eliezer, please move this thread back to squid-users mailing
>>> list
>>>       > instead of emailing me personally. When you do so, please
>>> clarify
>>>       > whether all 12 access.log records correspond to this single
>>> curl
>>>      request
>>>       > (if not, please only share access.log record(s) that do
>>>      correspond). --Alex.
>>>       >
>>>       > On 2024-08-19 12:03, NgTech LTD wrote:
>>>       >> This is the output of curl on windows 11 desktop:
>>>       >> C:\Users\USER>curl https://www.youtube.com/
>>>      <https://www.youtube.com/> -k -v -o 1.txt
>>>       >>     % Total    % Received % Xferd  Average Speed   Time
>>> Time         Time
>>>       >>    Current
>>>       >>                                    Dload  Upload   Total
>>>   Spent    Left
>>>       >>    Speed
>>>       >>     0     0    0     0    0     0      0      0 --:--:--
>>> --:--:--
>>>       >> --:--:--     0* Host www.youtube.com:443
>>>      <http://www.youtube.com:443> <http://www.youtube.com:443
>>>      <http://www.youtube.com:443>>
>>>       >> was resolved.
>>>       >> * IPv6: 2a00:1450:4001:800::200e, 2a00:1450:4001:80e::200e,
>>>       >> 2a00:1450:4001:81c::200e, 2a00:1450:4001:809::200e
>>>       >> * IPv4: 142.250.185.78, 142.250.185.110, 142.250.185.142,
>>>       >> 142.250.186.174, 142.250.185.174, 142.250.184.238,
>>> 142.250.185.238,
>>>       >> 142.250.185.206, 142.250.181.238, 142.250.186.46,
>>> 142.250.186.78,
>>>       >> 172.217.16.142, 216.58.212.174, 216.58.206.46,
>>> 172.217.23.110,
>>>       >> 216.58.212.142
>>>       >> *   Trying 142.250.185.78:443...
>>>       >> * Connected to www.youtube.com <http://www.youtube.com>
>>>      <http://www.youtube.com <http://www.youtube.com>>
>>> (142.250.185.78)
>>>       >> port 443
>>>       >> * schannel: disabled automatic use of client certificate
>>>       >> * ALPN: curl offers http/1.1
>>>       >> * ALPN: server accepted http/1.1
>>>       >> * using HTTP/1.x
>>>       >>   > GET / HTTP/1.1
>>>       >>   > Host: www.youtube.com <http://www.youtube.com>
>>>      <http://www.youtube.com <http://www.youtube.com>>
>>>       >>   > User-Agent: curl/8.8.0
>>>       >>   > Accept: */*
>>>       >>   >
>>>       >> * Request completely sent off
>>>       >> * schannel: remote party requests renegotiation
>>>       >> * schannel: renegotiating SSL/TLS connection
>>>       >> * schannel: SSL/TLS connection renegotiated
>>>       >> * schannel: failed to decrypt data, need more data
>>>       >> < HTTP/1.1 200 OK
>>>       >> < Content-Type: text/html; charset=utf-8
>>>       >> < X-Content-Type-Options: nosniff
>>>       >> < Cache-Control: no-cache, no-store, max-age=0,
>>> must-revalidate
>>>       >> < Pragma: no-cache
>>>       >> < Expires: Mon, 01 Jan 1990 00:00:00 GMT
>>>       >> < Date: Mon, 19 Aug 2024 16:02:23 GMT
>>>       >> < X-Frame-Options: SAMEORIGIN
>>>       >> < Strict-Transport-Security: max-age=31536000
>>>       >> < Origin-Trial:
>>>       >>
>>>      
>>> AmhMBR6zCLzDDxpW+HfpP67BqwIknWnyMOXOQGfzYswFmJe+fgaI6XZgAzcxOrzNtP7hE
>>> AmhMBR6zCLzDDxpW+HfpP67BqwIknWnyMOXOQGfzYswFmJe+DsOo1jdjFnVr2IdxQ4AAA
>>> AmhMBR6zCLzDDxpW+HfpP67BqwIknWnyMOXOQGfzYswFmJe+B4eyJvcmlnaW4iOiJodHR
>>> AmhMBR6zCLzDDxpW+HfpP67BqwIknWnyMOXOQGfzYswFmJe+wczovL3lvdXR1YmUuY29t
>>> AmhMBR6zCLzDDxpW+HfpP67BqwIknWnyMOXOQGfzYswFmJe+OjQ0MyIsImZlYXR1cmUiO
>>> AmhMBR6zCLzDDxpW+HfpP67BqwIknWnyMOXOQGfzYswFmJe+iJXZWJWaWV3WFJlcXVlc3
>>> AmhMBR6zCLzDDxpW+HfpP67BqwIknWnyMOXOQGfzYswFmJe+RlZFdpdGhEZXByZWNhdGl
>>> AmhMBR6zCLzDDxpW+HfpP67BqwIknWnyMOXOQGfzYswFmJe+vbiIsImV4cGlyeSI6MTc1
>>> AmhMBR6zCLzDDxpW+HfpP67BqwIknWnyMOXOQGfzYswFmJe+ODA2NzE5OSwiaXNTdWJkb
>>> AmhMBR6zCLzDDxpW+HfpP67BqwIknWnyMOXOQGfzYswFmJe+21haW4iOnRydWV9
>>>       >> < Cross-Origin-Opener-Policy: same-origin-allow-popups;
>>>       >> report-to="youtube_main"
>>>       >> < Report-To:
>>>       >>
>>>      
>>> {"group":"youtube_main","max_age":2592000,"endpoints":[{"url":"https:
>>> //csp.withgoogle.com/csp/report-to/youtube_main
>>> <https://csp.withgoogle.com/csp/report-to/youtube_main>
>>> <https://csp.withgoogle.com/csp/report-to/youtube_main
>>> <https://csp.withgoogle.com/csp/report-to/youtube_main>>"}]}
>>>       >> < Content-Security-Policy: require-trusted-types-for 'script'
>>>       >> < Permissions-Policy: ch-ua-arch=*, ch-ua-bitness=*,
>>>       >> ch-ua-full-version=*, ch-ua-full-version-list=*,
>>> ch-ua-model=*,
>>>       >> ch-ua-wow64=*, ch-ua-form-factors=*, ch-ua-platform=*,
>>>       >> ch-ua-platform-version=*
>>>       >> < P3P: CP="This is not a P3P policy! See
>>>       >> http://support.google.com/accounts/answer/151657?hl=en
>>>      <http://support.google.com/accounts/answer/151657?hl=en>
>>>       >> <http://support.google.com/accounts/answer/151657?hl=en
>>>      <http://support.google.com/accounts/answer/151657?hl=en>> for
>>> more
>>>      info."
>>>       >> < Server: ESF
>>>       >> < X-XSS-Protection: 0
>>>       >> < Set-Cookie: GPS=1; Domain=.youtube.com <http://youtube.com>
>>>      <http://youtube.com <http://youtube.com>>;
>>>       >> Expires=Mon, 19-Aug-2024 16:32:23 GMT; Path=/; Secure;
>>> HttpOnly
>>>       >> < Set-Cookie: YSC=XYs_jViLkFw; Domain=.youtube.com
>>>      <http://youtube.com> <http://youtube.com <http://youtube.com>>;
>>>       >> Path=/; Secure; HttpOnly; SameSite=none
>>>       >> < Set-Cookie: VISITOR_INFO1_LIVE=csMabhlNyrI;
>>>      Domain=.youtube.com <http://youtube.com>
>>>       >> <http://youtube.com <http://youtube.com>>; Expires=Sat,
>>>      15-Feb-2025 16:02:23 GMT; Path=/;
>>>       >> Secure; HttpOnly; SameSite=none
>>>       >> < Set-Cookie: VISITOR_PRIVACY_METADATA=CgJJTBIEGgAgVw%3D%3D;
>>>       >> Domain=.youtube.com <http://youtube.com> <http://youtube.com
>>>      <http://youtube.com>>; Expires=Sat, 15-Feb-2025
>>>       >> 16:02:23 GMT; Path=/; Secure; HttpOnly; SameSite=none
>>>       >> < Alt-Svc: h3=":443"; ma=2592000,h3-29=":443"; ma=2592000
>>>       >> < Accept-Ranges: none
>>>       >> < Vary: Accept-Encoding
>>>       >> < Transfer-Encoding: chunked
>>>       >> <
>>>       >> { [3674 bytes data]
>>>       >> * schannel: failed to decrypt data, need more data
>>>       >> { [8008 bytes data]
>>>       >> * schannel: failed to decrypt data, need more data
>>>       >> { [6880 bytes data]
>>>       >> * schannel: failed to decrypt data, need more data
>>>       >> { [2752 bytes data]
>>>       >> * schannel: failed to decrypt data, need more data
>>>       >> { [5504 bytes data]
>>>       >> * schannel: failed to decrypt data, need more data
>>>       >> { [2462 bytes data]
>>>       >> * schannel: failed to decrypt data, need more data
>>>       >> { [4128 bytes data]
>>>       >> * schannel: failed to decrypt data, need more data
>>>       >> { [2752 bytes data]
>>>       >> * schannel: failed to decrypt data, need more data
>>>       >> { [2752 bytes data]
>>>       >> * schannel: failed to decrypt data, need more data
>>>       >> { [4128 bytes data]
>>>       >> * schannel: failed to decrypt data, need more data
>>>       >> { [2752 bytes data]
>>>       >> * schannel: failed to decrypt data, need more data
>>>       >> { [5504 bytes data]
>>>       >> * schannel: failed to decrypt data, need more data
>>>       >> { [5504 bytes data]
>>>       >> * schannel: failed to decrypt data, need more data
>>>       >> { [4128 bytes data]
>>>       >> * schannel: failed to decrypt data, need more data
>>>       >> { [5242 bytes data]
>>>       >> * schannel: failed to decrypt data, need more data
>>>       >> { [2752 bytes data]
>>>       >> * schannel: failed to decrypt data, need more data
>>>       >> { [2752 bytes data]
>>>       >> * schannel: failed to decrypt data, need more data
>>>       >> { [6922 bytes data]
>>>       >> * schannel: failed to decrypt data, need more data
>>>       >> { [2752 bytes data]
>>>       >> * schannel: failed to decrypt data, need more data
>>>       >> { [6880 bytes data]
>>>       >> * schannel: failed to decrypt data, need more data
>>>       >> { [20378 bytes data]
>>>       >> * schannel: failed to decrypt data, need more data
>>>       >> { [6880 bytes data]
>>>       >> * schannel: failed to decrypt data, need more data
>>>       >> { [5504 bytes data]
>>>       >> * schannel: failed to decrypt data, need more data
>>>       >> { [5504 bytes data]
>>>       >> * schannel: failed to decrypt data, need more data
>>>       >> { [3839 bytes data]
>>>       >> * schannel: failed to decrypt data, need more data
>>>       >> { [6880 bytes data]
>>>       >> * schannel: failed to decrypt data, need more data
>>>       >> { [9632 bytes data]
>>>       >> * schannel: failed to decrypt data, need more data
>>>       >> { [6880 bytes data]
>>>       >> * schannel: failed to decrypt data, need more data
>>>       >> { [2752 bytes data]
>>>       >> * schannel: failed to decrypt data, need more data
>>>       >> { [7994 bytes data]
>>>       >> 100  193k    0  193k    0     0   293k      0 --:--:--
>>> --:--:--
>>>      --:--:--
>>>       >>    294k* schannel: failed to decrypt data, need more data
>>>       >> { [28937 bytes data]
>>>       >> * schannel: failed to decrypt data, need more data
>>>       >> { [8414 bytes data]
>>>       >> * schannel: failed to decrypt data, need more data
>>>       >> { [9632 bytes data]
>>>       >> * schannel: failed to decrypt data, need more data
>>>       >> { [5504 bytes data]
>>>       >> * schannel: failed to decrypt data, need more data
>>>       >> { [5504 bytes data]
>>>       >> * schannel: failed to decrypt data, need more data
>>>       >> { [7852 bytes data]
>>>       >> * schannel: failed to decrypt data, need more data
>>>       >> { [5504 bytes data]
>>>       >> * schannel: failed to decrypt data, need more data
>>>       >> { [17888 bytes data]
>>>       >> * schannel: failed to decrypt data, need more data
>>>       >> { [19016 bytes data]
>>>       >> * schannel: failed to decrypt data, need more data
>>>       >> { [15136 bytes data]
>>>       >> * schannel: failed to decrypt data, need more data
>>>       >> { [10760 bytes data]
>>>       >> * schannel: failed to decrypt data, need more data
>>>       >> { [6880 bytes data]
>>>       >> * schannel: failed to decrypt data, need more data
>>>       >> { [34152 bytes data]
>>>       >> * schannel: failed to decrypt data, need more data
>>>       >> { [28648 bytes data]
>>>       >> * schannel: failed to decrypt data, need more data
>>>       >> { [33026 bytes data]
>>>       >> * schannel: failed to decrypt data, need more data
>>>       >> { [14888 bytes data]
>>>       >> * schannel: failed to decrypt data, need more data
>>>       >> { [24768 bytes data]
>>>       >> * schannel: failed to decrypt data, need more data
>>>       >> { [12136 bytes data]
>>>       >> 100  498k    0  498k    0     0   665k      0 --:--:--
>>> --:--:--
>>>      --:--:--
>>>       >>    669k
>>>       >> * Connection #0 to host www.youtube.com
>>> <http://www.youtube.com>
>>>      <http://www.youtube.com <http://www.youtube.com>> left intact
>>>       >>
>>>       >> And the access.log:
>>>       >> 1724083303.298      0 192.168.78.15 NONE_NONE/000 0 -
>>>       >> error:invalid-request - HIER_NONE/- - -
>>>       >> 1724083303.888    589 192.168.78.15 TCP_TUNNEL/200 529157
>>> CONNECT
>>>       >> 142.250.185.78:443 <http://142.250.185.78:443>
>>>      <http://142.250.185.78:443 <http://142.250.185.78:443>> -
>>>       >> ORIGINAL_DST/142.250.185.78 <http://142.250.185.78>
>>>      <http://142.250.185.78 <http://142.250.185.78>> - -
>>>       >> 1724083307.305      0 192.168.78.15 NONE_NONE/000 0 -
>>>       >> error:invalid-request - HIER_NONE/- - -
>>>       >> 1724083307.908    603 192.168.78.15 TCP_TUNNEL/200 530241
>>> CONNECT
>>>       >> 142.250.185.78:443 <http://142.250.185.78:443>
>>>      <http://142.250.185.78:443 <http://142.250.185.78:443>> -
>>>       >> ORIGINAL_DST/142.250.185.78 <http://142.250.185.78>
>>>      <http://142.250.185.78 <http://142.250.185.78>> - -
>>>       >> 1724083311.615      0 192.168.78.15 NONE_NONE/000 0 -
>>>       >> error:invalid-request - HIER_NONE/- - -
>>>       >> 1724083312.255    640 192.168.78.15 TCP_TUNNEL/200 528465
>>> CONNECT
>>>       >> 142.250.185.78:443 <http://142.250.185.78:443>
>>>      <http://142.250.185.78:443 <http://142.250.185.78:443>> -
>>>       >> ORIGINAL_DST/142.250.185.78 <http://142.250.185.78>
>>>      <http://142.250.185.78 <http://142.250.185.78>> - -
>>>       >> 1724083316.666      0 192.168.78.15 NONE_NONE/000 0 -
>>>       >> error:invalid-request - HIER_NONE/- - -
>>>       >> 1724083317.315    649 192.168.78.15 TCP_TUNNEL/200 529617
>>> CONNECT
>>>       >> 142.250.185.78:443 <http://142.250.185.78:443>
>>>      <http://142.250.185.78:443 <http://142.250.185.78:443>> -
>>>       >> ORIGINAL_DST/142.250.185.78 <http://142.250.185.78>
>>>      <http://142.250.185.78 <http://142.250.185.78>> - -
>>>       >> 1724083342.731      0 192.168.78.15 NONE_NONE/000 0 -
>>>       >> error:invalid-request - HIER_NONE/- - -
>>>       >> 1724083343.377    645 192.168.78.15 TCP_TUNNEL/200 528377
>>> CONNECT
>>>       >> 142.250.185.78:443 <http://142.250.185.78:443>
>>>      <http://142.250.185.78:443 <http://142.250.185.78:443>> -
>>>       >> ORIGINAL_DST/142.250.185.78 <http://142.250.185.78>
>>>      <http://142.250.185.78 <http://142.250.185.78>> - -
>>>       >> 1724083378.565      0 192.168.78.15 NONE_NONE/000 0 -
>>>       >> error:invalid-request - HIER_NONE/- - -
>>>       >> 1724083378.801      0 192.168.78.15 NONE_NONE/000 0 -
>>>       >> error:invalid-request - HIER_NONE/- - -
>>>       >>
>>>       >>
>>>       >> ----
>>>       >> Eliezer Croitoru
>>>       >> Tech Support
>>>       >> Mobile: +972-5-28704261
>>>       >> Email: ngtech1ltd at gmail.com <mailto:ngtech1ltd at gmail.com>
>>>      <mailto:ngtech1ltd at gmail.com <mailto:ngtech1ltd at gmail.com>>
>>>       >>
>>>       >>
>>>       >> On Mon, Aug 19, 2024 at 3:21?PM Alex Rousskov
>>>       >> <rousskov at measurement-factory.com
>>>      <mailto:rousskov at measurement-factory.com>
>>>       >> <mailto:rousskov at measurement-factory.com
>>>      <mailto:rousskov at measurement-factory.com>>> wrote:
>>>       >>
>>>       >>      On 2024-08-19 03:47, NgTech LTD wrote:
>>>       >>       > I am testing Squid 6.10 on Fedora 40 (their package).
>>>       >>       > And it seems that Squid is unable to bump clients
>>>      (ESNI/ECH)?
>>>       >>       >
>>>       >>       > I had couple iterations of pek stare and bump and I
>>> am
>>>      not sure
>>>       >>      what is
>>>       >>       > the reason for that:
>>>       >>
>>>       >>      What do you use as a client? Judging by the number of
>>>       >>      error:invalid-request entries in your access.log, that
>>>      client may
>>>       >>      not be
>>>       >>      speaking HTTP/1 inside those CONNECT tunnels.
>>>       >>
>>>       >>      Does everything work for non-intercept ports?
>>>       >>
>>>       >>      Does everything work in a basic curl or wget test?
>>>       >>
>>>       >>      Does everything work when you remove "ssl-bump" and
>>> related
>>>      options
>>>       >>      from
>>>       >>      intercepting http_port 33128?
>>>       >>
>>>       >>      Does everything work when you use "ssl_bump splice all"
>>>      instead of your
>>>       >>      current ssl_bump rule?
>>>       >>
>>>       >>      Does everything work when you use "ssl_bump peek all"
>>>      instead of your
>>>       >>      current ssl_bump rule?
>>>       >>
>>>       >>      Alex.
>>>       >>
>>>       >>
>>>       >>       > shutdown_lifetime 3 seconds
>>>       >>       > external_acl_type whitelist-lookup-helper ipv4 ttl=10
>>>       >>      children-max=10
>>>       >>       > children-startup=2 \
>>>       >>       >          children-idle=2 concurrency=10 %URI %SRC
>>>       >>       > /usr/local/bin/squid-conf-url-lookup.rb
>>>       >>       > acl whitelist-lookup external
>>> whitelist-lookup-helper
>>>       >>       > acl ytmethods method POST GET
>>>       >>       > acl localnet src 0.0.0.1-0.255.255.255  # RFC 1122
>>>      "this" network
>>>       >>      (LAN)
>>>       >>       > acl localnet src 10.0.0.0/8 <http://10.0.0.0/8>
>>>      <http://10.0.0.0/8 <http://10.0.0.0/8>>
>>>       >>      <http://10.0.0.0/8 <http://10.0.0.0/8>
>>> <http://10.0.0.0/8
>>>      <http://10.0.0.0/8>>>             # RFC 1918
>>>       >>       > local private network (LAN)
>>>       >>       > acl localnet src 100.64.0.0/10 <http://100.64.0.0/10>
>>>      <http://100.64.0.0/10 <http://100.64.0.0/10>>
>>>       >>      <http://100.64.0.0/10 <http://100.64.0.0/10>
>>>      <http://100.64.0.0/10 <http://100.64.0.0/10>>>          # RFC
>>>       >>       > 6598 shared address space (CGN)
>>>       >>       > acl localnet src 169.254.0.0/16
>>> <http://169.254.0.0/16>
>>>      <http://169.254.0.0/16 <http://169.254.0.0/16>>
>>>       >>      <http://169.254.0.0/16 <http://169.254.0.0/16>
>>>      <http://169.254.0.0/16 <http://169.254.0.0/16>>>         # RFC
>>>       >>       > 3927 link-local (directly plugged) machines
>>>       >>       > acl localnet src 172.16.0.0/12 <http://172.16.0.0/12>
>>>      <http://172.16.0.0/12 <http://172.16.0.0/12>>
>>>       >>      <http://172.16.0.0/12 <http://172.16.0.0/12>
>>>      <http://172.16.0.0/12 <http://172.16.0.0/12>>>          # RFC
>>>       >>       > 1918 local private network (LAN)
>>>       >>       > acl localnet src 192.168.0.0/16
>>> <http://192.168.0.0/16>
>>>      <http://192.168.0.0/16 <http://192.168.0.0/16>>
>>>       >>      <http://192.168.0.0/16 <http://192.168.0.0/16>
>>>      <http://192.168.0.0/16 <http://192.168.0.0/16>>>         # RFC
>>>       >>       > 1918 local private network (LAN)
>>>       >>       > acl localnet src fc00::/7               # RFC 4193
>>> local
>>>      private
>>>       >>      network
>>>       >>       > range
>>>       >>       > acl localnet src fe80::/10              # RFC 4291
>>>      link-local
>>>       >>      (directly
>>>       >>       > plugged) machines
>>>       >>       > acl SSL_ports port 443
>>>       >>       > acl Safe_ports port 80          # http
>>>       >>       > acl Safe_ports port 21          # ftp
>>>       >>       > acl Safe_ports port 443         # https
>>>       >>       > acl Safe_ports port 70          # gopher
>>>       >>       > acl Safe_ports port 210         # wais
>>>       >>       > acl Safe_ports port 1025-65535  # unregistered ports
>>>       >>       > acl Safe_ports port 280         # http-mgmt
>>>       >>       > acl Safe_ports port 488         # gss-http
>>>       >>       > acl Safe_ports port 591         # filemaker
>>>       >>       > acl Safe_ports port 777         # multiling http
>>>       >>       > http_access deny !Safe_ports
>>>       >>       > http_access deny CONNECT !SSL_ports
>>>       >>       > http_access allow localhost manager
>>>       >>       > http_access deny manager
>>>       >>       > http_access allow localhost
>>>       >>       > http_access deny to_localhost
>>>       >>       > http_access deny to_linklocal
>>>       >>       > acl tubedoms dstdomain .ytimg.com <http://ytimg.com>
>>>      <http://ytimg.com <http://ytimg.com>>
>>>       >>      <http://ytimg.com <http://ytimg.com> <http://ytimg.com
>>>      <http://ytimg.com>>> .youtube.com <http://youtube.com>
>>>      <http://youtube.com <http://youtube.com>>
>>>       >>       > <http://youtube.com <http://youtube.com>
>>>      <http://youtube.com <http://youtube.com>>> .youtu.be
>>> <http://youtu.be>
>>>       >>      <http://youtu.be <http://youtu.be>> <http://youtu.be
>>>      <http://youtu.be> <http://youtu.be <http://youtu.be>>>
>>>       >>       > http_access allow ytmethods localnet tubedoms
>>>      whitelist-lookup
>>>       >>       > http_access allow localnet
>>>       >>       > http_access deny all
>>>       >>       > http_port 3128
>>>       >>       > http_port 13128 ssl-bump
>>> tls-cert=/etc/squid/ssl/cert.pem
>>>       >>       > tls-key=/etc/squid/ssl/key.pem \
>>>       >>       >          generate-host-certificates=on
>>>       >>      dynamic_cert_mem_cache_size=4MB
>>>       >>       > http_port 23128 tproxy ssl-bump
>>>      tls-cert=/etc/squid/ssl/cert.pem
>>>       >>       > tls-key=/etc/squid/ssl/key.pem \
>>>       >>       >          generate-host-certificates=on
>>>       >>      dynamic_cert_mem_cache_size=4MB
>>>       >>       > http_port 33128 intercept ssl-bump
>>>      tls-cert=/etc/squid/ssl/cert.pem
>>>       >>       > tls-key=/etc/squid/ssl/key.pem \
>>>       >>       >          generate-host-certificates=on
>>>       >>      dynamic_cert_mem_cache_size=4MB
>>>       >>       > sslcrtd_program
>>> /usr/lib64/squid/security_file_certgen -s
>>>       >>       > /var/spool/squid/ssl_db -M 4MB
>>>       >>       > sslcrtd_children 5
>>>       >>       > acl foreignProtocol squid_error ERR_PROTOCOL_UNKNOWN
>>>      ERR_TOO_BIG
>>>       >>       > acl serverTalksFirstProtocol squid_error
>>>      ERR_REQUEST_START_TIMEOUT
>>>       >>       > on_unsupported_protocol tunnel foreignProtocol
>>>       >>       > on_unsupported_protocol tunnel
>>> serverTalksFirstProtocol
>>>       >>       > on_unsupported_protocol respond all
>>>       >>       > acl monitoredSites ssl::server_name .youtube.com
>>>      <http://youtube.com>
>>>       >>      <http://youtube.com <http://youtube.com>>
>>>      <http://youtube.com <http://youtube.com> <http://youtube.com
>>>      <http://youtube.com>>>
>>>       >>       > .ytimg.com <http://ytimg.com> <http://ytimg.com
>>>      <http://ytimg.com>> <http://ytimg.com <http://ytimg.com>
>>>      <http://ytimg.com <http://ytimg.com>>>
>>>       >>       > acl monitoredSitesRegex ssl::server_name_regex
>>>      \.youtube\.com
>>>       >>      \.ytimg\.com
>>>       >>       > acl serverIsBank ssl::server_name .visa.com
>>>      <http://visa.com> <http://visa.com <http://visa.com>>
>>>       >>      <http://visa.com <http://visa.com> <http://visa.com
>>>      <http://visa.com>>>
>>>       >>       > acl step1 at_step SslBump1
>>>       >>       > acl step2 at_step SslBump2
>>>       >>       > acl step3 at_step SslBump3
>>>       >>       > ssl_bump bump all
>>>       >>       > strip_query_terms off
>>>       >>       > coredump_dir /var/spool/squid
>>>       >>       > refresh_pattern ^ftp:           1440    20%     10080
>>>       >>       > refresh_pattern -i (/cgi-bin/|\?) 0     0%      0
>>>       >>       > refresh_pattern .               0       20%     4320
>>>       >>       > logformat ssl_custom_format %ts.%03tu %6tr %>a
>>>      %Ss/%03>Hs %<st
>>>       >>      %rm %ru
>>>       >>       > %[un %Sh/%<a %mt %ssl::>sni
>>>       >>       > access_log daemon:/var/log/squid/access.log
>>>      ssl_custom_format
>>>       >>       > ##EOF
>>>       >>       >
>>>       >>       > access.log from before:
>>>       >>       > 1724028804.797    486 192.168.78.15 TCP_TUNNEL/200
>>> 17764
>>>      CONNECT
>>>       >>       > 40.126.31.73:443 <http://40.126.31.73:443>
>>>      <http://40.126.31.73:443 <http://40.126.31.73:443>>
>>>       >>      <http://40.126.31.73:443 <http://40.126.31.73:443>
>>>      <http://40.126.31.73:443 <http://40.126.31.73:443>>> -
>>>       >>      ORIGINAL_DST/40.126.31.73 <http://40.126.31.73>
>>>      <http://40.126.31.73 <http://40.126.31.73>>
>>>       >>       > <http://40.126.31.73 <http://40.126.31.73>
>>>      <http://40.126.31.73 <http://40.126.31.73>>> - -
>>>       >>       > 1724028805.413      0 192.168.78.15 NONE_NONE/000 0 -
>>>       >>       > error:invalid-request - HIER_NONE/- - -
>>>       >>       > 1724028806.028      0 192.168.78.15 NONE_NONE/000 0 -
>>>       >>       > error:invalid-request - HIER_NONE/- - -
>>>       >>       > 1724028806.028      0 192.168.78.15 NONE_NONE/000 0 -
>>>       >>       > error:invalid-request - HIER_NONE/- - -
>>>       >>       > 1724028806.029      0 192.168.78.15 NONE_NONE/000 0 -
>>>       >>       > error:invalid-request - HIER_NONE/- - -
>>>       >>       > 1724028806.030      0 192.168.78.15 NONE_NONE/000 0 -
>>>       >>       > error:invalid-request - HIER_NONE/- - -
>>>       >>       > 1724028806.085     57 192.168.78.15 TCP_TUNNEL/200
>>> 4513
>>>      CONNECT
>>>       >>       > 104.18.72.113:443 <http://104.18.72.113:443>
>>>      <http://104.18.72.113:443 <http://104.18.72.113:443>>
>>>       >>      <http://104.18.72.113:443 <http://104.18.72.113:443>
>>>      <http://104.18.72.113:443 <http://104.18.72.113:443>>> -
>>>       >>       > ORIGINAL_DST/104.18.72.113 <http://104.18.72.113>
>>>      <http://104.18.72.113 <http://104.18.72.113>>
>>>       >>      <http://104.18.72.113 <http://104.18.72.113>
>>>      <http://104.18.72.113 <http://104.18.72.113>>> - -
>>>       >>       > 1724028806.086     56 192.168.78.15 TCP_TUNNEL/200
>>> 4513
>>>      CONNECT
>>>       >>       > 104.18.72.113:443 <http://104.18.72.113:443>
>>>      <http://104.18.72.113:443 <http://104.18.72.113:443>>
>>>       >>      <http://104.18.72.113:443 <http://104.18.72.113:443>
>>>      <http://104.18.72.113:443 <http://104.18.72.113:443>>> -
>>>       >>       > ORIGINAL_DST/104.18.72.113 <http://104.18.72.113>
>>>      <http://104.18.72.113 <http://104.18.72.113>>
>>>       >>      <http://104.18.72.113 <http://104.18.72.113>
>>>      <http://104.18.72.113 <http://104.18.72.113>>> - -
>>>       >>       > 1724028806.086     56 192.168.78.15 TCP_TUNNEL/200
>>> 4512
>>>      CONNECT
>>>       >>       > 104.18.72.113:443 <http://104.18.72.113:443>
>>>      <http://104.18.72.113:443 <http://104.18.72.113:443>>
>>>       >>      <http://104.18.72.113:443 <http://104.18.72.113:443>
>>>      <http://104.18.72.113:443 <http://104.18.72.113:443>>> -
>>>       >>       > ORIGINAL_DST/104.18.72.113 <http://104.18.72.113>
>>>      <http://104.18.72.113 <http://104.18.72.113>>
>>>       >>      <http://104.18.72.113 <http://104.18.72.113>
>>>      <http://104.18.72.113 <http://104.18.72.113>>> - -
>>>       >>       > 1724028806.208      0 192.168.78.15 NONE_NONE/000 0 -
>>>       >>       > error:invalid-request - HIER_NONE/- - -
>>>       >>       > 1724028806.213      0 192.168.78.15 NONE_NONE/000 0 -
>>>       >>       > error:invalid-request - HIER_NONE/- - -
>>>       >>       > 1724028806.338      0 192.168.78.15 NONE_NONE/000 0 -
>>>       >>       > error:invalid-request - HIER_NONE/- - -
>>>       >>       > 1724028806.469      0 192.168.78.15 NONE_NONE/000 0 -
>>>       >>       > error:invalid-request - HIER_NONE/- - -
>>>       >>       > 1724028806.596      0 192.168.78.15 NONE_NONE/000 0 -
>>>       >>       > error:invalid-request - HIER_NONE/- - -
>>>       >>       > 1724028807.006      0 192.168.78.15 NONE_NONE/000 0 -
>>>       >>       > error:invalid-request - HIER_NONE/- - -
>>>       >>       > 1724028807.262      0 192.168.78.15 NONE_NONE/000 0 -
>>>       >>       > error:invalid-request - HIER_NONE/- - -
>>>       >>       > 1724028808.922   5037 192.168.78.15 TCP_TUNNEL/200
>>> 6096
>>>      CONNECT
>>>       >>       > 13.107.246.60:443 <http://13.107.246.60:443>
>>>      <http://13.107.246.60:443 <http://13.107.246.60:443>>
>>>       >>      <http://13.107.246.60:443 <http://13.107.246.60:443>
>>>      <http://13.107.246.60:443 <http://13.107.246.60:443>>> -
>>>       >>       > ORIGINAL_DST/13.107.246.60 <http://13.107.246.60>
>>>      <http://13.107.246.60 <http://13.107.246.60>>
>>>       >>      <http://13.107.246.60 <http://13.107.246.60>
>>>      <http://13.107.246.60 <http://13.107.246.60>>> - -
>>>       >>       > 1724028812.906   8336 192.168.78.15 TCP_TUNNEL/200
>>>      1071500 CONNECT
>>>       >>       > 104.126.37.171:443 <http://104.126.37.171:443>
>>>      <http://104.126.37.171:443 <http://104.126.37.171:443>>
>>>       >>      <http://104.126.37.171:443 <http://104.126.37.171:443>
>>>      <http://104.126.37.171:443 <http://104.126.37.171:443>>> -
>>>       >>       > ORIGINAL_DST/104.126.37.171 <http://104.126.37.171>
>>>      <http://104.126.37.171 <http://104.126.37.171>>
>>>       >>      <http://104.126.37.171 <http://104.126.37.171>
>>>      <http://104.126.37.171 <http://104.126.37.171>>> - -
>>>       >>       > 1724028819.209 247893 192.168.78.15 TCP_TUNNEL/200
>>> 4023
>>>      CONNECT
>>>       >>       > 142.250.186.34:443 <http://142.250.186.34:443>
>>>      <http://142.250.186.34:443 <http://142.250.186.34:443>>
>>>       >>      <http://142.250.186.34:443 <http://142.250.186.34:443>
>>>      <http://142.250.186.34:443 <http://142.250.186.34:443>>> -
>>>       >>       > ORIGINAL_DST/142.250.186.34 <http://142.250.186.34>
>>>      <http://142.250.186.34 <http://142.250.186.34>>
>>>       >>      <http://142.250.186.34 <http://142.250.186.34>
>>>      <http://142.250.186.34 <http://142.250.186.34>>> - -
>>>       >>       > 1724028820.097 250033 192.168.78.15 TCP_TUNNEL/200
>>>      549611 CONNECT
>>>       >>       > 142.250.184.246:443 <http://142.250.184.246:443>
>>>      <http://142.250.184.246:443 <http://142.250.184.246:443>>
>>>       >>      <http://142.250.184.246:443 <http://142.250.184.246:443>
>>>      <http://142.250.184.246:443 <http://142.250.184.246:443>>> -
>>>       >>       > ORIGINAL_DST/142.250.184.246 <http://142.250.184.246>
>>>      <http://142.250.184.246 <http://142.250.184.246>>
>>>       >>      <http://142.250.184.246 <http://142.250.184.246>
>>>      <http://142.250.184.246 <http://142.250.184.246>>> - -
>>>       >>       > 1724028820.154 246850 192.168.78.15 TCP_TUNNEL/200
>>> 15119
>>>      CONNECT
>>>       >>       > 216.58.206.65:443 <http://216.58.206.65:443>
>>>      <http://216.58.206.65:443 <http://216.58.206.65:443>>
>>>       >>      <http://216.58.206.65:443 <http://216.58.206.65:443>
>>>      <http://216.58.206.65:443 <http://216.58.206.65:443>>> -
>>>       >>       > ORIGINAL_DST/216.58.206.65 <http://216.58.206.65>
>>>      <http://216.58.206.65 <http://216.58.206.65>>
>>>       >>      <http://216.58.206.65 <http://216.58.206.65>
>>>      <http://216.58.206.65 <http://216.58.206.65>>> - -
>>>       >>       > 1724028820.164 246856 192.168.78.15 TCP_TUNNEL/200
>>> 3037
>>>      CONNECT
>>>       >>       > 142.250.181.227:443 <http://142.250.181.227:443>
>>>      <http://142.250.181.227:443 <http://142.250.181.227:443>>
>>>       >>      <http://142.250.181.227:443 <http://142.250.181.227:443>
>>>      <http://142.250.181.227:443 <http://142.250.181.227:443>>> -
>>>       >>       > ORIGINAL_DST/142.250.181.227 <http://142.250.181.227>
>>>      <http://142.250.181.227 <http://142.250.181.227>>
>>>       >>      <http://142.250.181.227 <http://142.250.181.227>
>>>      <http://142.250.181.227 <http://142.250.181.227>>> - -
>>>       >>       > 1724028820.203 246893 192.168.78.15 TCP_TUNNEL/200
>>> 3031
>>>      CONNECT
>>>       >>       > 172.217.16.196:443 <http://172.217.16.196:443>
>>>      <http://172.217.16.196:443 <http://172.217.16.196:443>>
>>>       >>      <http://172.217.16.196:443 <http://172.217.16.196:443>
>>>      <http://172.217.16.196:443 <http://172.217.16.196:443>>> -
>>>       >>       > ORIGINAL_DST/172.217.16.196 <http://172.217.16.196>
>>>      <http://172.217.16.196 <http://172.217.16.196>>
>>>       >>      <http://172.217.16.196 <http://172.217.16.196>
>>>      <http://172.217.16.196 <http://172.217.16.196>>> - -
>>>       >>       > 1724028822.656 271833 192.168.78.15 TCP_TUNNEL/200
>>>      387583 CONNECT
>>>       >>       > 142.250.185.238:443 <http://142.250.185.238:443>
>>>      <http://142.250.185.238:443 <http://142.250.185.238:443>>
>>>       >>      <http://142.250.185.238:443 <http://142.250.185.238:443>
>>>      <http://142.250.185.238:443 <http://142.250.185.238:443>>> -
>>>       >>       > ORIGINAL_DST/142.250.185.238 <http://142.250.185.238>
>>>      <http://142.250.185.238 <http://142.250.185.238>>
>>>       >>      <http://142.250.185.238 <http://142.250.185.238>
>>>      <http://142.250.185.238 <http://142.250.185.238>>> - -
>>>       >>       > 1724028830.336      0 192.168.78.15 NONE_NONE/000 0 -
>>>       >>       > error:invalid-request - HIER_NONE/- - -
>>>       >>       > 1724028830.781    444 192.168.78.15 TCP_TUNNEL/200
>>> 18505
>>>      CONNECT
>>>       >>       > 40.126.31.73:443 <http://40.126.31.73:443>
>>>      <http://40.126.31.73:443 <http://40.126.31.73:443>>
>>>       >>      <http://40.126.31.73:443 <http://40.126.31.73:443>
>>>      <http://40.126.31.73:443 <http://40.126.31.73:443>>> -
>>>       >>      ORIGINAL_DST/40.126.31.73 <http://40.126.31.73>
>>>      <http://40.126.31.73 <http://40.126.31.73>>
>>>       >>       > <http://40.126.31.73 <http://40.126.31.73>
>>>      <http://40.126.31.73 <http://40.126.31.73>>> - -
>>>       >>       > 1724028841.781 155018 192.168.78.15 TCP_TUNNEL/200
>>> 15960
>>>      CONNECT
>>>       >>       > 13.107.6.158:443 <http://13.107.6.158:443>
>>>      <http://13.107.6.158:443 <http://13.107.6.158:443>>
>>>       >>      <http://13.107.6.158:443 <http://13.107.6.158:443>
>>>      <http://13.107.6.158:443 <http://13.107.6.158:443>>> -
>>>       >>      ORIGINAL_DST/13.107.6.158 <http://13.107.6.158>
>>>      <http://13.107.6.158 <http://13.107.6.158>>
>>>       >>       > <http://13.107.6.158 <http://13.107.6.158>
>>>      <http://13.107.6.158 <http://13.107.6.158>>> - -
>>>       >>       > 1724028849.443      0 192.168.78.15 NONE_NONE/000 0 -
>>>       >>       > error:invalid-request - HIER_NONE/- - -
>>>       >>       > 1724028849.698      0 192.168.78.15 NONE_NONE/000 0 -
>>>       >>       > error:invalid-request - HIER_NONE/- - -
>>>       >>       > 1724028865.261      0 192.168.78.15 NONE_NONE/000 0 -
>>>       >>       > error:invalid-request - HIER_NONE/- - -
>>>       >>       > 1724028865.779    517 192.168.78.15 TCP_TUNNEL/200
>>> 18557
>>>      CONNECT
>>>       >>       > 40.126.31.73:443 <http://40.126.31.73:443>
>>>      <http://40.126.31.73:443 <http://40.126.31.73:443>>
>>>       >>      <http://40.126.31.73:443 <http://40.126.31.73:443>
>>>      <http://40.126.31.73:443 <http://40.126.31.73:443>>> -
>>>       >>      ORIGINAL_DST/40.126.31.73 <http://40.126.31.73>
>>>      <http://40.126.31.73 <http://40.126.31.73>>
>>>       >>       > <http://40.126.31.73 <http://40.126.31.73>
>>>      <http://40.126.31.73 <http://40.126.31.73>>> - -
>>>       >>       > 1724028870.718 109994 192.168.78.15 TCP_TUNNEL/200
>>> 6972
>>>      CONNECT
>>>       >>       > 20.42.65.94:443 <http://20.42.65.94:443>
>>>      <http://20.42.65.94:443 <http://20.42.65.94:443>>
>>>      <http://20.42.65.94:443 <http://20.42.65.94:443>
>>>       >>      <http://20.42.65.94:443 <http://20.42.65.94:443>>> -
>>>      ORIGINAL_DST/20.42.65.94 <http://20.42.65.94>
>>>       >>      <http://20.42.65.94 <http://20.42.65.94>>
>>>       >>       > <http://20.42.65.94 <http://20.42.65.94>
>>>      <http://20.42.65.94 <http://20.42.65.94>>> - -
>>>       >>       > 1724028871.179  64583 192.168.78.15 TCP_TUNNEL/200
>>> 1903
>>>      CONNECT
>>>       >>       > 104.18.10.207:443 <http://104.18.10.207:443>
>>>      <http://104.18.10.207:443 <http://104.18.10.207:443>>
>>>       >>      <http://104.18.10.207:443 <http://104.18.10.207:443>
>>>      <http://104.18.10.207:443 <http://104.18.10.207:443>>> -
>>>       >>       > ORIGINAL_DST/104.18.10.207 <http://104.18.10.207>
>>>      <http://104.18.10.207 <http://104.18.10.207>>
>>>       >>      <http://104.18.10.207 <http://104.18.10.207>
>>>      <http://104.18.10.207 <http://104.18.10.207>>> - -
>>>       >>       > 1724028871.179  63917 192.168.78.15 TCP_TUNNEL/200
>>> 2430
>>>      CONNECT
>>>       >>       > 142.250.186.99:443 <http://142.250.186.99:443>
>>>      <http://142.250.186.99:443 <http://142.250.186.99:443>>
>>>       >>      <http://142.250.186.99:443 <http://142.250.186.99:443>
>>>      <http://142.250.186.99:443 <http://142.250.186.99:443>>> -
>>>       >>       > ORIGINAL_DST/142.250.186.99 <http://142.250.186.99>
>>>      <http://142.250.186.99 <http://142.250.186.99>>
>>>       >>      <http://142.250.186.99 <http://142.250.186.99>
>>>      <http://142.250.186.99 <http://142.250.186.99>>> - -
>>>       >>       > 1724028871.179  64709 192.168.78.15 TCP_TUNNEL/200
>>> 2439
>>>      CONNECT
>>>       >>       > 142.250.185.170:443 <http://142.250.185.170:443>
>>>      <http://142.250.185.170:443 <http://142.250.185.170:443>>
>>>       >>      <http://142.250.185.170:443 <http://142.250.185.170:443>
>>>      <http://142.250.185.170:443 <http://142.250.185.170:443>>> -
>>>       >>       > ORIGINAL_DST/142.250.185.170 <http://142.250.185.170>
>>>      <http://142.250.185.170 <http://142.250.185.170>>
>>>       >>      <http://142.250.185.170 <http://142.250.185.170>
>>>      <http://142.250.185.170 <http://142.250.185.170>>> - -
>>>       >>       > 1724028871.308      0 192.168.78.15 NONE_NONE/000 0 -
>>>       >>       > error:invalid-request - HIER_NONE/- - -
>>>       >>       > 1724028871.731    422 192.168.78.15 TCP_TUNNEL/200
>>> 17789
>>>      CONNECT
>>>       >>       > 40.126.31.73:443 <http://40.126.31.73:443>
>>>      <http://40.126.31.73:443 <http://40.126.31.73:443>>
>>>       >>      <http://40.126.31.73:443 <http://40.126.31.73:443>
>>>      <http://40.126.31.73:443 <http://40.126.31.73:443>>> -
>>>       >>      ORIGINAL_DST/40.126.31.73 <http://40.126.31.73>
>>>      <http://40.126.31.73 <http://40.126.31.73>>
>>>       >>       > <http://40.126.31.73 <http://40.126.31.73>
>>>      <http://40.126.31.73 <http://40.126.31.73>>> - -
>>>       >>       > 1724028872.486      0 192.168.78.15 NONE_NONE/000 0 -
>>>       >>       > error:invalid-request - HIER_NONE/- - -
>>>       >>       > 1724028873.477      0 192.168.78.15 NONE_NONE/000 0 -
>>>       >>       > error:invalid-request - HIER_NONE/- - -
>>>       >>       > 1724028873.745      0 192.168.78.15 NONE_NONE/000 0 -
>>>       >>       > error:invalid-request - HIER_NONE/- - -
>>>       >>       > 1724028873.902    424 192.168.78.15 TCP_TUNNEL/200
>>> 18520
>>>      CONNECT
>>>       >>       > 40.126.31.73:443 <http://40.126.31.73:443>
>>>      <http://40.126.31.73:443 <http://40.126.31.73:443>>
>>>       >>      <http://40.126.31.73:443 <http://40.126.31.73:443>
>>>      <http://40.126.31.73:443 <http://40.126.31.73:443>>> -
>>>       >>      ORIGINAL_DST/40.126.31.73 <http://40.126.31.73>
>>>      <http://40.126.31.73 <http://40.126.31.73>>
>>>       >>       > <http://40.126.31.73 <http://40.126.31.73>
>>>      <http://40.126.31.73 <http://40.126.31.73>>> - -
>>>       >>       > 1724028877.056      0 192.168.78.15 NONE_NONE/000 0 -
>>>       >>       > error:invalid-request - HIER_NONE/- - -
>>>       >>       > 1724028877.060      0 192.168.78.15 NONE_NONE/000 0 -
>>>       >>       > error:invalid-request - HIER_NONE/- - -
>>>       >>       > 1724028877.060      0 192.168.78.15 NONE_NONE/000 0 -
>>>       >>       > error:invalid-request - HIER_NONE/- - -
>>>       >>       > 1724028877.060      0 192.168.78.15 NONE_NONE/000 0 -
>>>       >>       > error:invalid-request - HIER_NONE/- - -
>>>       >>       > 1724028877.430 312389 192.168.78.15 TCP_TUNNEL/200
>>> 7884
>>>      CONNECT
>>>       >>       > 142.250.186.78:443 <http://142.250.186.78:443>
>>>      <http://142.250.186.78:443 <http://142.250.186.78:443>>
>>>       >>      <http://142.250.186.78:443 <http://142.250.186.78:443>
>>>      <http://142.250.186.78:443 <http://142.250.186.78:443>>> -
>>>       >>       > ORIGINAL_DST/142.250.186.78 <http://142.250.186.78>
>>>      <http://142.250.186.78 <http://142.250.186.78>>
>>>       >>      <http://142.250.186.78 <http://142.250.186.78>
>>>      <http://142.250.186.78 <http://142.250.186.78>>> - -
>>>       >>       > 1724028878.800      0 192.168.78.15 NONE_NONE/000 0 -
>>>       >>       > error:invalid-request - HIER_NONE/- - -
>>>       >>       > 1724028878.920      0 192.168.78.15 NONE_NONE/000 0 -
>>>       >>       > error:invalid-request - HIER_NONE/- - -
>>>       >>       > 1724028879.072      0 192.168.78.15 NONE_NONE/000 0 -
>>>       >>       > error:invalid-request - HIER_NONE/- - -
>>>       >>       > 1724028880.808   7062 192.168.78.15 TCP_TUNNEL/200
>>>      836391 CONNECT
>>>       >>       > 104.126.37.145:443 <http://104.126.37.145:443>
>>>      <http://104.126.37.145:443 <http://104.126.37.145:443>>
>>>       >>      <http://104.126.37.145:443 <http://104.126.37.145:443>
>>>      <http://104.126.37.145:443 <http://104.126.37.145:443>>> -
>>>       >>       > ORIGINAL_DST/104.126.37.145 <http://104.126.37.145>
>>>      <http://104.126.37.145 <http://104.126.37.145>>
>>>       >>      <http://104.126.37.145 <http://104.126.37.145>
>>>      <http://104.126.37.145 <http://104.126.37.145>>> - -
>>>       >>       > 1724028882.468  33024 192.168.78.15 TCP_TUNNEL/200
>>>      1488697 CONNECT
>>>       >>       > 49.12.59.2:443 <http://49.12.59.2:443>
>>>      <http://49.12.59.2:443 <http://49.12.59.2:443>>
>>>      <http://49.12.59.2:443 <http://49.12.59.2:443>
>>>       >>      <http://49.12.59.2:443 <http://49.12.59.2:443>>> -
>>>      ORIGINAL_DST/49.12.59.2 <http://49.12.59.2> <http://49.12.59.2
>>>      <http://49.12.59.2>>
>>>       >>       > <http://49.12.59.2 <http://49.12.59.2>
>>>      <http://49.12.59.2 <http://49.12.59.2>>> - -
>>>       >>       > 1724028883.728   6671 192.168.78.15 TCP_TUNNEL/200
>>> 69351
>>>      CONNECT
>>>       >>       > 52.216.185.251:443 <http://52.216.185.251:443>
>>>      <http://52.216.185.251:443 <http://52.216.185.251:443>>
>>>       >>      <http://52.216.185.251:443 <http://52.216.185.251:443>
>>>      <http://52.216.185.251:443 <http://52.216.185.251:443>>> -
>>>       >>       > ORIGINAL_DST/52.216.185.251 <http://52.216.185.251>
>>>      <http://52.216.185.251 <http://52.216.185.251>>
>>>       >>      <http://52.216.185.251 <http://52.216.185.251>
>>>      <http://52.216.185.251 <http://52.216.185.251>>> - -
>>>       >>       > 1724028883.789   6728 192.168.78.15 TCP_TUNNEL/200
>>> 69216
>>>      CONNECT
>>>       >>       > 52.216.185.251:443 <http://52.216.185.251:443>
>>>      <http://52.216.185.251:443 <http://52.216.185.251:443>>
>>>       >>      <http://52.216.185.251:443 <http://52.216.185.251:443>
>>>      <http://52.216.185.251:443 <http://52.216.185.251:443>>> -
>>>       >>       > ORIGINAL_DST/52.216.185.251 <http://52.216.185.251>
>>>      <http://52.216.185.251 <http://52.216.185.251>>
>>>       >>      <http://52.216.185.251 <http://52.216.185.251>
>>>      <http://52.216.185.251 <http://52.216.185.251>>> - -
>>>       >>       > 1724028883.797   6736 192.168.78.15 TCP_TUNNEL/200
>>>      104657 CONNECT
>>>       >>       > 52.216.185.251:443 <http://52.216.185.251:443>
>>>      <http://52.216.185.251:443 <http://52.216.185.251:443>>
>>>       >>      <http://52.216.185.251:443 <http://52.216.185.251:443>
>>>      <http://52.216.185.251:443 <http://52.216.185.251:443>>> -
>>>       >>       > ORIGINAL_DST/52.216.185.251 <http://52.216.185.251>
>>>      <http://52.216.185.251 <http://52.216.185.251>>
>>>       >>      <http://52.216.185.251 <http://52.216.185.251>
>>>      <http://52.216.185.251 <http://52.216.185.251>>> - -
>>>       >>       > 1724028883.845   6784 192.168.78.15 TCP_TUNNEL/200
>>> 80277
>>>      CONNECT
>>>       >>       > 52.216.185.251:443 <http://52.216.185.251:443>
>>>      <http://52.216.185.251:443 <http://52.216.185.251:443>>
>>>       >>      <http://52.216.185.251:443 <http://52.216.185.251:443>
>>>      <http://52.216.185.251:443 <http://52.216.185.251:443>>> -
>>>       >>       > ORIGINAL_DST/52.216.185.251 <http://52.216.185.251>
>>>      <http://52.216.185.251 <http://52.216.185.251>>
>>>       >>      <http://52.216.185.251 <http://52.216.185.251>
>>>      <http://52.216.185.251 <http://52.216.185.251>>> - -
>>>       >>       > 1724028884.460 170355 192.168.78.15 TCP_TUNNEL/200
>>> 44690
>>>      CONNECT
>>>       >>       > 185.199.108.153:443 <http://185.199.108.153:443>
>>>      <http://185.199.108.153:443 <http://185.199.108.153:443>>
>>>       >>      <http://185.199.108.153:443 <http://185.199.108.153:443>
>>>      <http://185.199.108.153:443 <http://185.199.108.153:443>>> -
>>>       >>       > ORIGINAL_DST/185.199.108.153 <http://185.199.108.153>
>>>      <http://185.199.108.153 <http://185.199.108.153>>
>>>       >>      <http://185.199.108.153 <http://185.199.108.153>
>>>      <http://185.199.108.153 <http://185.199.108.153>>> - -
>>>       >>       > 1724028889.845 120370 192.168.78.15 TCP_TUNNEL/200
>>> 5868
>>>      CONNECT
>>>       >>       > 104.126.37.161:443 <http://104.126.37.161:443>
>>>      <http://104.126.37.161:443 <http://104.126.37.161:443>>
>>>       >>      <http://104.126.37.161:443 <http://104.126.37.161:443>
>>>      <http://104.126.37.161:443 <http://104.126.37.161:443>>> -
>>>       >>       > ORIGINAL_DST/104.126.37.161 <http://104.126.37.161>
>>>      <http://104.126.37.161 <http://104.126.37.161>>
>>>       >>      <http://104.126.37.161 <http://104.126.37.161>
>>>      <http://104.126.37.161 <http://104.126.37.161>>> - -
>>>       >>       > 1724028890.011 122862 192.168.78.15 TCP_TUNNEL/200
>>>      136726 CONNECT
>>>       >>       > 23.37.37.211:443 <http://23.37.37.211:443>
>>>      <http://23.37.37.211:443 <http://23.37.37.211:443>>
>>>       >>      <http://23.37.37.211:443 <http://23.37.37.211:443>
>>>      <http://23.37.37.211:443 <http://23.37.37.211:443>>> -
>>>       >>      ORIGINAL_DST/23.37.37.211 <http://23.37.37.211>
>>>      <http://23.37.37.211 <http://23.37.37.211>>
>>>       >>       > <http://23.37.37.211 <http://23.37.37.211>
>>>      <http://23.37.37.211 <http://23.37.37.211>>> - -
>>>       >>       > 1724028890.297 120381 192.168.78.15 TCP_TUNNEL/200
>>> 9176
>>>      CONNECT
>>>       >>       > 2.18.140.238:443 <http://2.18.140.238:443>
>>>      <http://2.18.140.238:443 <http://2.18.140.238:443>>
>>>       >>      <http://2.18.140.238:443 <http://2.18.140.238:443>
>>>      <http://2.18.140.238:443 <http://2.18.140.238:443>>> -
>>>       >>      ORIGINAL_DST/2.18.140.238 <http://2.18.140.238>
>>>      <http://2.18.140.238 <http://2.18.140.238>>
>>>       >>       > <http://2.18.140.238 <http://2.18.140.238>
>>>      <http://2.18.140.238 <http://2.18.140.238>>> - -
>>>       >>       > 1724028891.212      0 192.168.78.15 NONE_NONE/000 0 -
>>>       >>       > error:invalid-request - HIER_NONE/- - -
>>>       >>       > 1724028891.365    152 192.168.78.15 TCP_TUNNEL/200
>>> 2359
>>>      CONNECT
>>>       >>       > 142.250.185.138:443 <http://142.250.185.138:443>
>>>      <http://142.250.185.138:443 <http://142.250.185.138:443>>
>>>       >>      <http://142.250.185.138:443 <http://142.250.185.138:443>
>>>      <http://142.250.185.138:443 <http://142.250.185.138:443>>> -
>>>       >>       > ORIGINAL_DST/142.250.185.138 <http://142.250.185.138>
>>>      <http://142.250.185.138 <http://142.250.185.138>>
>>>       >>      <http://142.250.185.138 <http://142.250.185.138>
>>>      <http://142.250.185.138 <http://142.250.185.138>>> - -
>>>       >>       > 1724028893.885  90253 192.168.78.15 TCP_TUNNEL/200
>>> 6374
>>>      CONNECT
>>>       >>       > 13.107.246.60:443 <http://13.107.246.60:443>
>>>      <http://13.107.246.60:443 <http://13.107.246.60:443>>
>>>       >>      <http://13.107.246.60:443 <http://13.107.246.60:443>
>>>      <http://13.107.246.60:443 <http://13.107.246.60:443>>> -
>>>       >>       > ORIGINAL_DST/13.107.246.60 <http://13.107.246.60>
>>>      <http://13.107.246.60 <http://13.107.246.60>>
>>>       >>      <http://13.107.246.60 <http://13.107.246.60>
>>>      <http://13.107.246.60 <http://13.107.246.60>>> - -
>>>       >>       > 1724028900.169      0 192.168.78.15 NONE_NONE/000 0 -
>>>       >>       > error:invalid-request - HIER_NONE/- - -
>>>       >>       > 1724028934.465 900262 192.168.78.15 TCP_TUNNEL/200
>>> 5530
>>>      CONNECT
>>>       >>       > 52.123.243.197:443 <http://52.123.243.197:443>
>>>      <http://52.123.243.197:443 <http://52.123.243.197:443>>
>>>       >>      <http://52.123.243.197:443 <http://52.123.243.197:443>
>>>      <http://52.123.243.197:443 <http://52.123.243.197:443>>> -
>>>       >>       > ORIGINAL_DST/52.123.243.197 <http://52.123.243.197>
>>>      <http://52.123.243.197 <http://52.123.243.197>>
>>>       >>      <http://52.123.243.197 <http://52.123.243.197>
>>>      <http://52.123.243.197 <http://52.123.243.197>>> - -
>>>       >>       > 1724028960.494  60324 192.168.78.15 TCP_TUNNEL/503 0
>>> CONNECT
>>>       >>       > 172.217.16.206:443 <http://172.217.16.206:443>
>>>      <http://172.217.16.206:443 <http://172.217.16.206:443>>
>>>       >>      <http://172.217.16.206:443 <http://172.217.16.206:443>
>>>      <http://172.217.16.206:443 <http://172.217.16.206:443>>> -
>>>       >>       > ORIGINAL_DST/172.217.16.206 <http://172.217.16.206>
>>>      <http://172.217.16.206 <http://172.217.16.206>>
>>>       >>      <http://172.217.16.206 <http://172.217.16.206>
>>>      <http://172.217.16.206 <http://172.217.16.206>>> - -
>>>       >>       > 1724028960.494      0 192.168.78.15 NONE_NONE/000 0 -
>>>       >>       > error:transaction-end-before-headers - HIER_NONE/- -
>>> -
>>>       >>       >
>>>       >>       > Thanks for any help,
>>>       >>       >
>>>       >>       >
>>>       >>       > ----
>>>       >>       > Eliezer Croitoru
>>>       >>       > Tech Support
>>>       >>       > Mobile: +972-5-28704261
>>>       >>       > Email: ngtech1ltd at gmail.com
>>>      <mailto:ngtech1ltd at gmail.com> <mailto:ngtech1ltd at gmail.com
>>>      <mailto:ngtech1ltd at gmail.com>>
>>>       >>      <mailto:ngtech1ltd at gmail.com
>>> <mailto:ngtech1ltd at gmail.com>
>>>      <mailto:ngtech1ltd at gmail.com <mailto:ngtech1ltd at gmail.com>>>
>>>       >
>>>       >
>>>       > _______________________________________________
>>>       > squid-users mailing list
>>>       > squid-users at lists.squid-cache.org
>>>      <mailto:squid-users at lists.squid-cache.org>
>>>       > https://lists.squid-cache.org/listinfo/squid-users
>>>      <https://lists.squid-cache.org/listinfo/squid-users>
>>>
>>>      _______________________________________________
>>>      squid-users mailing list
>>>      squid-users at lists.squid-cache.org
>>>      <mailto:squid-users at lists.squid-cache.org>
>>>      https://lists.squid-cache.org/listinfo/squid-users
>>>      <https://lists.squid-cache.org/listinfo/squid-users>
>>>
>>
>> _______________________________________________
>> squid-users mailing list
>> squid-users at lists.squid-cache.org
>> https://lists.squid-cache.org/listinfo/squid-users
> 
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> https://lists.squid-cache.org/listinfo/squid-users



From ngtech1ltd at gmail.com  Fri Aug 23 10:29:05 2024
From: ngtech1ltd at gmail.com (ngtech1ltd at gmail.com)
Date: Fri, 23 Aug 2024 13:29:05 +0300
Subject: [squid-users] Squid 6.10 on Fedora 40 cannot intercept and bump
 SSL Traffic
In-Reply-To: <CABA8h=TSSsneVN5qvtaxsHfdknSd58ucZ9Vxg=Vxe5YWCsaAAA@mail.gmail.com>
References: <CABA8h=TSSsneVN5qvtaxsHfdknSd58ucZ9Vxg=Vxe5YWCsaAAA@mail.gmail.com>
Message-ID: <015a01daf547$4860af70$d9220e50$@gmail.com>

OK so the issue was that:

The http_port was used for ssl bump with intercept while the only port which can really intercept ssl connections is:

https_port

 

so I believe that there should be a warning about such a line in the cache log.

When there is http_port and intercept and ssl_bump there should be a warning.

 

Thanks,

Eliezer

 

From: NgTech LTD <ngtech1ltd at gmail.com> 
Sent: Monday, August 19, 2024 10:48 AM
To: Squid Users <squid-users at lists.squid-cache.org>
Subject: Squid 6.10 on Fedora 40 cannot intercept and bump SSL Traffic

 

I am testing Squid 6.10 on Fedora 40 (their package).
And it seems that Squid is unable to bump clients (ESNI/ECH)?

 

I had couple iterations of pek stare and bump and I am not sure what is the reason for that:
shutdown_lifetime 3 seconds
external_acl_type whitelist-lookup-helper ipv4 ttl=10 children-max=10 children-startup=2 \
        children-idle=2 concurrency=10 %URI %SRC /usr/local/bin/squid-conf-url-lookup.rb
acl whitelist-lookup external  whitelist-lookup-helper
acl ytmethods method POST GET
acl localnet src 0.0.0.1-0.255.255.255  # RFC 1122 "this" network (LAN)
acl localnet src 10.0.0.0/8 <http://10.0.0.0/8>              # RFC 1918 local private network (LAN)
acl localnet src 100.64.0.0/10 <http://100.64.0.0/10>           # RFC 6598 shared address space (CGN)
acl localnet src 169.254.0.0/16 <http://169.254.0.0/16>          # RFC 3927 link-local (directly plugged) machines
acl localnet src 172.16.0.0/12 <http://172.16.0.0/12>           # RFC 1918 local private network (LAN)
acl localnet src 192.168.0.0/16 <http://192.168.0.0/16>          # RFC 1918 local private network (LAN)
acl localnet src fc00::/7               # RFC 4193 local private network range
acl localnet src fe80::/10              # RFC 4291 link-local (directly plugged) machines
acl SSL_ports port 443
acl Safe_ports port 80          # http
acl Safe_ports port 21          # ftp
acl Safe_ports port 443         # https
acl Safe_ports port 70          # gopher
acl Safe_ports port 210         # wais
acl Safe_ports port 1025-65535  # unregistered ports
acl Safe_ports port 280         # http-mgmt
acl Safe_ports port 488         # gss-http
acl Safe_ports port 591         # filemaker
acl Safe_ports port 777         # multiling http
http_access deny !Safe_ports
http_access deny CONNECT !SSL_ports
http_access allow localhost manager
http_access deny manager
http_access allow localhost
http_access deny to_localhost
http_access deny to_linklocal
acl tubedoms dstdomain .ytimg.com <http://ytimg.com>  .youtube.com <http://youtube.com>  .youtu.be <http://youtu.be> 
http_access allow ytmethods localnet tubedoms whitelist-lookup
http_access allow localnet
http_access deny all
http_port 3128
http_port 13128 ssl-bump tls-cert=/etc/squid/ssl/cert.pem tls-key=/etc/squid/ssl/key.pem \
        generate-host-certificates=on dynamic_cert_mem_cache_size=4MB
http_port 23128 tproxy ssl-bump tls-cert=/etc/squid/ssl/cert.pem tls-key=/etc/squid/ssl/key.pem \
        generate-host-certificates=on dynamic_cert_mem_cache_size=4MB
http_port 33128 intercept ssl-bump tls-cert=/etc/squid/ssl/cert.pem tls-key=/etc/squid/ssl/key.pem \
        generate-host-certificates=on dynamic_cert_mem_cache_size=4MB
sslcrtd_program /usr/lib64/squid/security_file_certgen -s /var/spool/squid/ssl_db -M 4MB
sslcrtd_children 5
acl foreignProtocol squid_error ERR_PROTOCOL_UNKNOWN ERR_TOO_BIG
acl serverTalksFirstProtocol squid_error ERR_REQUEST_START_TIMEOUT
on_unsupported_protocol tunnel foreignProtocol
on_unsupported_protocol tunnel serverTalksFirstProtocol
on_unsupported_protocol respond all
acl monitoredSites ssl::server_name .youtube.com <http://youtube.com>  .ytimg.com <http://ytimg.com> 
acl monitoredSitesRegex ssl::server_name_regex \.youtube\.com \.ytimg\.com
acl serverIsBank ssl::server_name .visa.com <http://visa.com> 
acl step1 at_step SslBump1
acl step2 at_step SslBump2
acl step3 at_step SslBump3
ssl_bump bump all
strip_query_terms off
coredump_dir /var/spool/squid
refresh_pattern ^ftp:           1440    20%     10080
refresh_pattern -i (/cgi-bin/|\?) 0     0%      0
refresh_pattern .               0       20%     4320
logformat ssl_custom_format %ts.%03tu %6tr %>a %Ss/%03>Hs %<st %rm %ru %[un %Sh/%<a %mt %ssl::>sni
access_log daemon:/var/log/squid/access.log ssl_custom_format
##EOF

 

access.log from before:
1724028804.797    486 192.168.78.15 TCP_TUNNEL/200 17764 CONNECT 40.126.31.73:443 <http://40.126.31.73:443>  - ORIGINAL_DST/40.126.31.73 <http://40.126.31.73>  - -
1724028805.413      0 192.168.78.15 NONE_NONE/000 0 - error:invalid-request - HIER_NONE/- - -
1724028806.028      0 192.168.78.15 NONE_NONE/000 0 - error:invalid-request - HIER_NONE/- - -
1724028806.028      0 192.168.78.15 NONE_NONE/000 0 - error:invalid-request - HIER_NONE/- - -
1724028806.029      0 192.168.78.15 NONE_NONE/000 0 - error:invalid-request - HIER_NONE/- - -
1724028806.030      0 192.168.78.15 NONE_NONE/000 0 - error:invalid-request - HIER_NONE/- - -
1724028806.085     57 192.168.78.15 TCP_TUNNEL/200 4513 CONNECT 104.18.72.113:443 <http://104.18.72.113:443>  - ORIGINAL_DST/104.18.72.113 <http://104.18.72.113>  - -
1724028806.086     56 192.168.78.15 TCP_TUNNEL/200 4513 CONNECT 104.18.72.113:443 <http://104.18.72.113:443>  - ORIGINAL_DST/104.18.72.113 <http://104.18.72.113>  - -
1724028806.086     56 192.168.78.15 TCP_TUNNEL/200 4512 CONNECT 104.18.72.113:443 <http://104.18.72.113:443>  - ORIGINAL_DST/104.18.72.113 <http://104.18.72.113>  - -
1724028806.208      0 192.168.78.15 NONE_NONE/000 0 - error:invalid-request - HIER_NONE/- - -
1724028806.213      0 192.168.78.15 NONE_NONE/000 0 - error:invalid-request - HIER_NONE/- - -
1724028806.338      0 192.168.78.15 NONE_NONE/000 0 - error:invalid-request - HIER_NONE/- - -
1724028806.469      0 192.168.78.15 NONE_NONE/000 0 - error:invalid-request - HIER_NONE/- - -
1724028806.596      0 192.168.78.15 NONE_NONE/000 0 - error:invalid-request - HIER_NONE/- - -
1724028807.006      0 192.168.78.15 NONE_NONE/000 0 - error:invalid-request - HIER_NONE/- - -
1724028807.262      0 192.168.78.15 NONE_NONE/000 0 - error:invalid-request - HIER_NONE/- - -
1724028808.922   5037 192.168.78.15 TCP_TUNNEL/200 6096 CONNECT 13.107.246.60:443 <http://13.107.246.60:443>  - ORIGINAL_DST/13.107.246.60 <http://13.107.246.60>  - -
1724028812.906   8336 192.168.78.15 TCP_TUNNEL/200 1071500 CONNECT 104.126.37.171:443 <http://104.126.37.171:443>  - ORIGINAL_DST/104.126.37.171 <http://104.126.37.171>  - -
1724028819.209 247893 192.168.78.15 TCP_TUNNEL/200 4023 CONNECT 142.250.186.34:443 <http://142.250.186.34:443>  - ORIGINAL_DST/142.250.186.34 <http://142.250.186.34>  - -
1724028820.097 250033 192.168.78.15 TCP_TUNNEL/200 549611 CONNECT 142.250.184.246:443 <http://142.250.184.246:443>  - ORIGINAL_DST/142.250.184.246 <http://142.250.184.246>  - -
1724028820.154 246850 192.168.78.15 TCP_TUNNEL/200 15119 CONNECT 216.58.206.65:443 <http://216.58.206.65:443>  - ORIGINAL_DST/216.58.206.65 <http://216.58.206.65>  - -
1724028820.164 246856 192.168.78.15 TCP_TUNNEL/200 3037 CONNECT 142.250.181.227:443 <http://142.250.181.227:443>  - ORIGINAL_DST/142.250.181.227 <http://142.250.181.227>  - -
1724028820.203 246893 192.168.78.15 TCP_TUNNEL/200 3031 CONNECT 172.217.16.196:443 <http://172.217.16.196:443>  - ORIGINAL_DST/172.217.16.196 <http://172.217.16.196>  - -
1724028822.656 271833 192.168.78.15 TCP_TUNNEL/200 387583 CONNECT 142.250.185.238:443 <http://142.250.185.238:443>  - ORIGINAL_DST/142.250.185.238 <http://142.250.185.238>  - -
1724028830.336      0 192.168.78.15 NONE_NONE/000 0 - error:invalid-request - HIER_NONE/- - -
1724028830.781    444 192.168.78.15 TCP_TUNNEL/200 18505 CONNECT 40.126.31.73:443 <http://40.126.31.73:443>  - ORIGINAL_DST/40.126.31.73 <http://40.126.31.73>  - -
1724028841.781 155018 192.168.78.15 TCP_TUNNEL/200 15960 CONNECT 13.107.6.158:443 <http://13.107.6.158:443>  - ORIGINAL_DST/13.107.6.158 <http://13.107.6.158>  - -
1724028849.443      0 192.168.78.15 NONE_NONE/000 0 - error:invalid-request - HIER_NONE/- - -
1724028849.698      0 192.168.78.15 NONE_NONE/000 0 - error:invalid-request - HIER_NONE/- - -
1724028865.261      0 192.168.78.15 NONE_NONE/000 0 - error:invalid-request - HIER_NONE/- - -
1724028865.779    517 192.168.78.15 TCP_TUNNEL/200 18557 CONNECT 40.126.31.73:443 <http://40.126.31.73:443>  - ORIGINAL_DST/40.126.31.73 <http://40.126.31.73>  - -
1724028870.718 109994 192.168.78.15 TCP_TUNNEL/200 6972 CONNECT 20.42.65.94:443 <http://20.42.65.94:443>  - ORIGINAL_DST/20.42.65.94 <http://20.42.65.94>  - -
1724028871.179  64583 192.168.78.15 TCP_TUNNEL/200 1903 CONNECT 104.18.10.207:443 <http://104.18.10.207:443>  - ORIGINAL_DST/104.18.10.207 <http://104.18.10.207>  - -
1724028871.179  63917 192.168.78.15 TCP_TUNNEL/200 2430 CONNECT 142.250.186.99:443 <http://142.250.186.99:443>  - ORIGINAL_DST/142.250.186.99 <http://142.250.186.99>  - -
1724028871.179  64709 192.168.78.15 TCP_TUNNEL/200 2439 CONNECT 142.250.185.170:443 <http://142.250.185.170:443>  - ORIGINAL_DST/142.250.185.170 <http://142.250.185.170>  - -
1724028871.308      0 192.168.78.15 NONE_NONE/000 0 - error:invalid-request - HIER_NONE/- - -
1724028871.731    422 192.168.78.15 TCP_TUNNEL/200 17789 CONNECT 40.126.31.73:443 <http://40.126.31.73:443>  - ORIGINAL_DST/40.126.31.73 <http://40.126.31.73>  - -
1724028872.486      0 192.168.78.15 NONE_NONE/000 0 - error:invalid-request - HIER_NONE/- - -
1724028873.477      0 192.168.78.15 NONE_NONE/000 0 - error:invalid-request - HIER_NONE/- - -
1724028873.745      0 192.168.78.15 NONE_NONE/000 0 - error:invalid-request - HIER_NONE/- - -
1724028873.902    424 192.168.78.15 TCP_TUNNEL/200 18520 CONNECT 40.126.31.73:443 <http://40.126.31.73:443>  - ORIGINAL_DST/40.126.31.73 <http://40.126.31.73>  - -
1724028877.056      0 192.168.78.15 NONE_NONE/000 0 - error:invalid-request - HIER_NONE/- - -
1724028877.060      0 192.168.78.15 NONE_NONE/000 0 - error:invalid-request - HIER_NONE/- - -
1724028877.060      0 192.168.78.15 NONE_NONE/000 0 - error:invalid-request - HIER_NONE/- - -
1724028877.060      0 192.168.78.15 NONE_NONE/000 0 - error:invalid-request - HIER_NONE/- - -
1724028877.430 312389 192.168.78.15 TCP_TUNNEL/200 7884 CONNECT 142.250.186.78:443 <http://142.250.186.78:443>  - ORIGINAL_DST/142.250.186.78 <http://142.250.186.78>  - -
1724028878.800      0 192.168.78.15 NONE_NONE/000 0 - error:invalid-request - HIER_NONE/- - -
1724028878.920      0 192.168.78.15 NONE_NONE/000 0 - error:invalid-request - HIER_NONE/- - -
1724028879.072      0 192.168.78.15 NONE_NONE/000 0 - error:invalid-request - HIER_NONE/- - -
1724028880.808   7062 192.168.78.15 TCP_TUNNEL/200 836391 CONNECT 104.126.37.145:443 <http://104.126.37.145:443>  - ORIGINAL_DST/104.126.37.145 <http://104.126.37.145>  - -
1724028882.468  33024 192.168.78.15 TCP_TUNNEL/200 1488697 CONNECT 49.12.59.2:443 <http://49.12.59.2:443>  - ORIGINAL_DST/49.12.59.2 <http://49.12.59.2>  - -
1724028883.728   6671 192.168.78.15 TCP_TUNNEL/200 69351 CONNECT 52.216.185.251:443 <http://52.216.185.251:443>  - ORIGINAL_DST/52.216.185.251 <http://52.216.185.251>  - -
1724028883.789   6728 192.168.78.15 TCP_TUNNEL/200 69216 CONNECT 52.216.185.251:443 <http://52.216.185.251:443>  - ORIGINAL_DST/52.216.185.251 <http://52.216.185.251>  - -
1724028883.797   6736 192.168.78.15 TCP_TUNNEL/200 104657 CONNECT 52.216.185.251:443 <http://52.216.185.251:443>  - ORIGINAL_DST/52.216.185.251 <http://52.216.185.251>  - -
1724028883.845   6784 192.168.78.15 TCP_TUNNEL/200 80277 CONNECT 52.216.185.251:443 <http://52.216.185.251:443>  - ORIGINAL_DST/52.216.185.251 <http://52.216.185.251>  - -
1724028884.460 170355 192.168.78.15 TCP_TUNNEL/200 44690 CONNECT 185.199.108.153:443 <http://185.199.108.153:443>  - ORIGINAL_DST/185.199.108.153 <http://185.199.108.153>  - -
1724028889.845 120370 192.168.78.15 TCP_TUNNEL/200 5868 CONNECT 104.126.37.161:443 <http://104.126.37.161:443>  - ORIGINAL_DST/104.126.37.161 <http://104.126.37.161>  - -
1724028890.011 122862 192.168.78.15 TCP_TUNNEL/200 136726 CONNECT 23.37.37.211:443 <http://23.37.37.211:443>  - ORIGINAL_DST/23.37.37.211 <http://23.37.37.211>  - -
1724028890.297 120381 192.168.78.15 TCP_TUNNEL/200 9176 CONNECT 2.18.140.238:443 <http://2.18.140.238:443>  - ORIGINAL_DST/2.18.140.238 <http://2.18.140.238>  - -
1724028891.212      0 192.168.78.15 NONE_NONE/000 0 - error:invalid-request - HIER_NONE/- - -
1724028891.365    152 192.168.78.15 TCP_TUNNEL/200 2359 CONNECT 142.250.185.138:443 <http://142.250.185.138:443>  - ORIGINAL_DST/142.250.185.138 <http://142.250.185.138>  - -
1724028893.885  90253 192.168.78.15 TCP_TUNNEL/200 6374 CONNECT 13.107.246.60:443 <http://13.107.246.60:443>  - ORIGINAL_DST/13.107.246.60 <http://13.107.246.60>  - -
1724028900.169      0 192.168.78.15 NONE_NONE/000 0 - error:invalid-request - HIER_NONE/- - -
1724028934.465 900262 192.168.78.15 TCP_TUNNEL/200 5530 CONNECT 52.123.243.197:443 <http://52.123.243.197:443>  - ORIGINAL_DST/52.123.243.197 <http://52.123.243.197>  - -
1724028960.494  60324 192.168.78.15 TCP_TUNNEL/503 0 CONNECT 172.217.16.206:443 <http://172.217.16.206:443>  - ORIGINAL_DST/172.217.16.206 <http://172.217.16.206>  - -
1724028960.494      0 192.168.78.15 NONE_NONE/000 0 - error:transaction-end-before-headers - HIER_NONE/- - -

 

Thanks for any help,





----
Eliezer Croitoru
Tech Support
Mobile: +972-5-28704261
Email: ngtech1ltd at gmail.com <mailto:ngtech1ltd at gmail.com> 

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20240823/e40f7dd4/attachment.htm>

From rousskov at measurement-factory.com  Fri Aug 23 13:18:28 2024
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Fri, 23 Aug 2024 09:18:28 -0400
Subject: [squid-users] Squid 6.10 on Fedora 40 cannot intercept and bump
 SSL Traffic
In-Reply-To: <015a01daf547$4860af70$d9220e50$@gmail.com>
References: <CABA8h=TSSsneVN5qvtaxsHfdknSd58ucZ9Vxg=Vxe5YWCsaAAA@mail.gmail.com>
 <015a01daf547$4860af70$d9220e50$@gmail.com>
Message-ID: <77d2911c-6ab6-4d86-8722-b889fec6fb58@measurement-factory.com>

On 2024-08-23 06:29, ngtech1ltd at gmail.com wrote:
> OK so the issue was that:
> 
> The http_port was used for ssl bump with intercept

I would not phrase it that way because "bump" is a red herring here. I 
would instead say that the issue was that "http_port was used for 
intercepted TLS traffic" or "intercepted TLS traffic was directed to 
http_port".


> while the only port which can really intercept ssl connections is: 
> https_port

Correct (for some definition of "ssl connections").


> so I believe that ...
> When there is http_port and intercept and ssl_bump there should be a 
> warning.

When configuration X does not work for use case Y, there are several 
scenarios to consider when deciding whether Squid should warn about 
configuration X, including these three:

* When configuration X does not work at all, Squid should reject that 
configuration as invalid. It is not a warning; it is an error. This is 
not the case we are discussing (AFAICT) because "http_port intercept 
ssl-bump" does work in some cases.

* When configuration X does not work for use case Y, Squid should reject 
that configuration as invalid _if_ Squid can detect that it is being 
used for use case Y. This is not the case we are discussing (AFAICT) 
because Squid cannot detect (at configuration time) what traffic you 
intend to intercept and redirect to a given Squid port: It could be TLS. 
It could be plain HTTP. It could be a mix. Squid cannot tell.

* When an unusual configuration X does not work for common use cases, 
Squid may warn about it while giving the admin an ability to turn the 
warning off (to accommodate admins that utilize that configuration for 
some uncommon but valid use cases). One can argue that this is the case 
we are discussing: "http_port intercept ssl-bump" configuration in 
question is unusual, does not work for common TLS interception cases, 
but can be used (AFAICT) to bump traffic between a client and an HTTP 
proxy. Quality pull requests (that take this email considerations into 
account) are welcome.


HTH,

Alex.


> *From:* NgTech LTD <ngtech1ltd at gmail.com>
> *Sent:* Monday, August 19, 2024 10:48 AM
> *To:* Squid Users <squid-users at lists.squid-cache.org>
> *Subject:* Squid 6.10 on Fedora 40 cannot intercept and bump SSL Traffic
> 
> I am testing Squid 6.10 on Fedora 40 (their package).
> And it seems that Squid is unable?to bump clients (ESNI/ECH)?
> 
> I had couple iterations of pek stare and bump and I am not sure what is 
> the reason for that:
> shutdown_lifetime 3 seconds
> external_acl_type whitelist-lookup-helper ipv4 ttl=10 children-max=10 
> children-startup=2 \
>  ? ? ? ? children-idle=2 concurrency=10 %URI %SRC 
> /usr/local/bin/squid-conf-url-lookup.rb
> acl whitelist-lookup external ?whitelist-lookup-helper
> acl ytmethods method POST GET
> acl localnet src 0.0.0.1-0.255.255.255 ?# RFC 1122 "this" network (LAN)
> acl localnet src 10.0.0.0/8 <http://10.0.0.0/8> ? ? ? ? ? ? # RFC 1918 
> local private network (LAN)
> acl localnet src 100.64.0.0/10 <http://100.64.0.0/10> ? ? ? ? ?# RFC 
> 6598 shared address space (CGN)
> acl localnet src 169.254.0.0/16 <http://169.254.0.0/16> ? ? ? ? # RFC 
> 3927 link-local (directly plugged) machines
> acl localnet src 172.16.0.0/12 <http://172.16.0.0/12> ? ? ? ? ?# RFC 
> 1918 local private network (LAN)
> acl localnet src 192.168.0.0/16 <http://192.168.0.0/16> ? ? ? ? # RFC 
> 1918 local private network (LAN)
> acl localnet src fc00::/7 ? ? ? ? ? ? ? # RFC 4193 local private network 
> range
> acl localnet src fe80::/10 ? ? ? ? ? ? ?# RFC 4291 link-local (directly 
> plugged) machines
> acl SSL_ports port 443
> acl Safe_ports port 80 ? ? ? ? ?# http
> acl Safe_ports port 21 ? ? ? ? ?# ftp
> acl Safe_ports port 443 ? ? ? ? # https
> acl Safe_ports port 70 ? ? ? ? ?# gopher
> acl Safe_ports port 210 ? ? ? ? # wais
> acl Safe_ports port 1025-65535 ?# unregistered ports
> acl Safe_ports port 280 ? ? ? ? # http-mgmt
> acl Safe_ports port 488 ? ? ? ? # gss-http
> acl Safe_ports port 591 ? ? ? ? # filemaker
> acl Safe_ports port 777 ? ? ? ? # multiling http
> http_access deny !Safe_ports
> http_access deny CONNECT !SSL_ports
> http_access allow localhost manager
> http_access deny manager
> http_access allow localhost
> http_access deny to_localhost
> http_access deny to_linklocal
> acl tubedoms dstdomain .ytimg.com <http://ytimg.com> .youtube.com 
> <http://youtube.com> .youtu.be <http://youtu.be>
> http_access allow ytmethods localnet tubedoms whitelist-lookup
> http_access allow localnet
> http_access deny all
> http_port 3128
> http_port 13128 ssl-bump tls-cert=/etc/squid/ssl/cert.pem 
> tls-key=/etc/squid/ssl/key.pem \
>  ? ? ? ? generate-host-certificates=on dynamic_cert_mem_cache_size=4MB
> http_port 23128 tproxy ssl-bump tls-cert=/etc/squid/ssl/cert.pem 
> tls-key=/etc/squid/ssl/key.pem \
>  ? ? ? ? generate-host-certificates=on dynamic_cert_mem_cache_size=4MB
> http_port 33128 intercept ssl-bump tls-cert=/etc/squid/ssl/cert.pem 
> tls-key=/etc/squid/ssl/key.pem \
>  ? ? ? ? generate-host-certificates=on dynamic_cert_mem_cache_size=4MB
> sslcrtd_program /usr/lib64/squid/security_file_certgen -s 
> /var/spool/squid/ssl_db -M 4MB
> sslcrtd_children 5
> acl foreignProtocol squid_error ERR_PROTOCOL_UNKNOWN ERR_TOO_BIG
> acl serverTalksFirstProtocol squid_error ERR_REQUEST_START_TIMEOUT
> on_unsupported_protocol tunnel foreignProtocol
> on_unsupported_protocol tunnel serverTalksFirstProtocol
> on_unsupported_protocol respond all
> acl monitoredSites ssl::server_name .youtube.com <http://youtube.com> 
> .ytimg.com <http://ytimg.com>
> acl monitoredSitesRegex ssl::server_name_regex \.youtube\.com \.ytimg\.com
> acl serverIsBank ssl::server_name .visa.com <http://visa.com>
> acl step1 at_step SslBump1
> acl step2 at_step SslBump2
> acl step3 at_step SslBump3
> ssl_bump bump all
> strip_query_terms off
> coredump_dir /var/spool/squid
> refresh_pattern ^ftp: ? ? ? ? ? 1440 ? ?20% ? ? 10080
> refresh_pattern -i (/cgi-bin/|\?) 0 ? ? 0% ? ? ?0
> refresh_pattern . ? ? ? ? ? ? ? 0 ? ? ? 20% ? ? 4320
> logformat ssl_custom_format %ts.%03tu %6tr %>a %Ss/%03>Hs %<st %rm %ru 
> %[un %Sh/%<a %mt %ssl::>sni
> access_log daemon:/var/log/squid/access.log ssl_custom_format
> ##EOF
> 
> access.log from before:
> 1724028804.797 ? ?486 192.168.78.15 TCP_TUNNEL/200 17764 CONNECT 
> 40.126.31.73:443 <http://40.126.31.73:443> - ORIGINAL_DST/40.126.31.73 
> <http://40.126.31.73> - -
> 1724028805.413 ? ? ?0 192.168.78.15 NONE_NONE/000 0 - 
> error:invalid-request - HIER_NONE/- - -
> 1724028806.028 ? ? ?0 192.168.78.15 NONE_NONE/000 0 - 
> error:invalid-request - HIER_NONE/- - -
> 1724028806.028 ? ? ?0 192.168.78.15 NONE_NONE/000 0 - 
> error:invalid-request - HIER_NONE/- - -
> 1724028806.029 ? ? ?0 192.168.78.15 NONE_NONE/000 0 - 
> error:invalid-request - HIER_NONE/- - -
> 1724028806.030 ? ? ?0 192.168.78.15 NONE_NONE/000 0 - 
> error:invalid-request - HIER_NONE/- - -
> 1724028806.085 ? ? 57 192.168.78.15 TCP_TUNNEL/200 4513 CONNECT 
> 104.18.72.113:443 <http://104.18.72.113:443> - 
> ORIGINAL_DST/104.18.72.113 <http://104.18.72.113> - -
> 1724028806.086 ? ? 56 192.168.78.15 TCP_TUNNEL/200 4513 CONNECT 
> 104.18.72.113:443 <http://104.18.72.113:443> - 
> ORIGINAL_DST/104.18.72.113 <http://104.18.72.113> - -
> 1724028806.086 ? ? 56 192.168.78.15 TCP_TUNNEL/200 4512 CONNECT 
> 104.18.72.113:443 <http://104.18.72.113:443> - 
> ORIGINAL_DST/104.18.72.113 <http://104.18.72.113> - -
> 1724028806.208 ? ? ?0 192.168.78.15 NONE_NONE/000 0 - 
> error:invalid-request - HIER_NONE/- - -
> 1724028806.213 ? ? ?0 192.168.78.15 NONE_NONE/000 0 - 
> error:invalid-request - HIER_NONE/- - -
> 1724028806.338 ? ? ?0 192.168.78.15 NONE_NONE/000 0 - 
> error:invalid-request - HIER_NONE/- - -
> 1724028806.469 ? ? ?0 192.168.78.15 NONE_NONE/000 0 - 
> error:invalid-request - HIER_NONE/- - -
> 1724028806.596 ? ? ?0 192.168.78.15 NONE_NONE/000 0 - 
> error:invalid-request - HIER_NONE/- - -
> 1724028807.006 ? ? ?0 192.168.78.15 NONE_NONE/000 0 - 
> error:invalid-request - HIER_NONE/- - -
> 1724028807.262 ? ? ?0 192.168.78.15 NONE_NONE/000 0 - 
> error:invalid-request - HIER_NONE/- - -
> 1724028808.922 ? 5037 192.168.78.15 TCP_TUNNEL/200 6096 CONNECT 
> 13.107.246.60:443 <http://13.107.246.60:443> - 
> ORIGINAL_DST/13.107.246.60 <http://13.107.246.60> - -
> 1724028812.906 ? 8336 192.168.78.15 TCP_TUNNEL/200 1071500 CONNECT 
> 104.126.37.171:443 <http://104.126.37.171:443> - 
> ORIGINAL_DST/104.126.37.171 <http://104.126.37.171> - -
> 1724028819.209 247893 192.168.78.15 TCP_TUNNEL/200 4023 CONNECT 
> 142.250.186.34:443 <http://142.250.186.34:443> - 
> ORIGINAL_DST/142.250.186.34 <http://142.250.186.34> - -
> 1724028820.097 250033 192.168.78.15 TCP_TUNNEL/200 549611 CONNECT 
> 142.250.184.246:443 <http://142.250.184.246:443> - 
> ORIGINAL_DST/142.250.184.246 <http://142.250.184.246> - -
> 1724028820.154 246850 192.168.78.15 TCP_TUNNEL/200 15119 CONNECT 
> 216.58.206.65:443 <http://216.58.206.65:443> - 
> ORIGINAL_DST/216.58.206.65 <http://216.58.206.65> - -
> 1724028820.164 246856 192.168.78.15 TCP_TUNNEL/200 3037 CONNECT 
> 142.250.181.227:443 <http://142.250.181.227:443> - 
> ORIGINAL_DST/142.250.181.227 <http://142.250.181.227> - -
> 1724028820.203 246893 192.168.78.15 TCP_TUNNEL/200 3031 CONNECT 
> 172.217.16.196:443 <http://172.217.16.196:443> - 
> ORIGINAL_DST/172.217.16.196 <http://172.217.16.196> - -
> 1724028822.656 271833 192.168.78.15 TCP_TUNNEL/200 387583 CONNECT 
> 142.250.185.238:443 <http://142.250.185.238:443> - 
> ORIGINAL_DST/142.250.185.238 <http://142.250.185.238> - -
> 1724028830.336 ? ? ?0 192.168.78.15 NONE_NONE/000 0 - 
> error:invalid-request - HIER_NONE/- - -
> 1724028830.781 ? ?444 192.168.78.15 TCP_TUNNEL/200 18505 CONNECT 
> 40.126.31.73:443 <http://40.126.31.73:443> - ORIGINAL_DST/40.126.31.73 
> <http://40.126.31.73> - -
> 1724028841.781 155018 192.168.78.15 TCP_TUNNEL/200 15960 CONNECT 
> 13.107.6.158:443 <http://13.107.6.158:443> - ORIGINAL_DST/13.107.6.158 
> <http://13.107.6.158> - -
> 1724028849.443 ? ? ?0 192.168.78.15 NONE_NONE/000 0 - 
> error:invalid-request - HIER_NONE/- - -
> 1724028849.698 ? ? ?0 192.168.78.15 NONE_NONE/000 0 - 
> error:invalid-request - HIER_NONE/- - -
> 1724028865.261 ? ? ?0 192.168.78.15 NONE_NONE/000 0 - 
> error:invalid-request - HIER_NONE/- - -
> 1724028865.779 ? ?517 192.168.78.15 TCP_TUNNEL/200 18557 CONNECT 
> 40.126.31.73:443 <http://40.126.31.73:443> - ORIGINAL_DST/40.126.31.73 
> <http://40.126.31.73> - -
> 1724028870.718 109994 192.168.78.15 TCP_TUNNEL/200 6972 CONNECT 
> 20.42.65.94:443 <http://20.42.65.94:443> - ORIGINAL_DST/20.42.65.94 
> <http://20.42.65.94> - -
> 1724028871.179 ?64583 192.168.78.15 TCP_TUNNEL/200 1903 CONNECT 
> 104.18.10.207:443 <http://104.18.10.207:443> - 
> ORIGINAL_DST/104.18.10.207 <http://104.18.10.207> - -
> 1724028871.179 ?63917 192.168.78.15 TCP_TUNNEL/200 2430 CONNECT 
> 142.250.186.99:443 <http://142.250.186.99:443> - 
> ORIGINAL_DST/142.250.186.99 <http://142.250.186.99> - -
> 1724028871.179 ?64709 192.168.78.15 TCP_TUNNEL/200 2439 CONNECT 
> 142.250.185.170:443 <http://142.250.185.170:443> - 
> ORIGINAL_DST/142.250.185.170 <http://142.250.185.170> - -
> 1724028871.308 ? ? ?0 192.168.78.15 NONE_NONE/000 0 - 
> error:invalid-request - HIER_NONE/- - -
> 1724028871.731 ? ?422 192.168.78.15 TCP_TUNNEL/200 17789 CONNECT 
> 40.126.31.73:443 <http://40.126.31.73:443> - ORIGINAL_DST/40.126.31.73 
> <http://40.126.31.73> - -
> 1724028872.486 ? ? ?0 192.168.78.15 NONE_NONE/000 0 - 
> error:invalid-request - HIER_NONE/- - -
> 1724028873.477 ? ? ?0 192.168.78.15 NONE_NONE/000 0 - 
> error:invalid-request - HIER_NONE/- - -
> 1724028873.745 ? ? ?0 192.168.78.15 NONE_NONE/000 0 - 
> error:invalid-request - HIER_NONE/- - -
> 1724028873.902 ? ?424 192.168.78.15 TCP_TUNNEL/200 18520 CONNECT 
> 40.126.31.73:443 <http://40.126.31.73:443> - ORIGINAL_DST/40.126.31.73 
> <http://40.126.31.73> - -
> 1724028877.056 ? ? ?0 192.168.78.15 NONE_NONE/000 0 - 
> error:invalid-request - HIER_NONE/- - -
> 1724028877.060 ? ? ?0 192.168.78.15 NONE_NONE/000 0 - 
> error:invalid-request - HIER_NONE/- - -
> 1724028877.060 ? ? ?0 192.168.78.15 NONE_NONE/000 0 - 
> error:invalid-request - HIER_NONE/- - -
> 1724028877.060 ? ? ?0 192.168.78.15 NONE_NONE/000 0 - 
> error:invalid-request - HIER_NONE/- - -
> 1724028877.430 312389 192.168.78.15 TCP_TUNNEL/200 7884 CONNECT 
> 142.250.186.78:443 <http://142.250.186.78:443> - 
> ORIGINAL_DST/142.250.186.78 <http://142.250.186.78> - -
> 1724028878.800 ? ? ?0 192.168.78.15 NONE_NONE/000 0 - 
> error:invalid-request - HIER_NONE/- - -
> 1724028878.920 ? ? ?0 192.168.78.15 NONE_NONE/000 0 - 
> error:invalid-request - HIER_NONE/- - -
> 1724028879.072 ? ? ?0 192.168.78.15 NONE_NONE/000 0 - 
> error:invalid-request - HIER_NONE/- - -
> 1724028880.808 ? 7062 192.168.78.15 TCP_TUNNEL/200 836391 CONNECT 
> 104.126.37.145:443 <http://104.126.37.145:443> - 
> ORIGINAL_DST/104.126.37.145 <http://104.126.37.145> - -
> 1724028882.468 ?33024 192.168.78.15 TCP_TUNNEL/200 1488697 CONNECT 
> 49.12.59.2:443 <http://49.12.59.2:443> - ORIGINAL_DST/49.12.59.2 
> <http://49.12.59.2> - -
> 1724028883.728 ? 6671 192.168.78.15 TCP_TUNNEL/200 69351 CONNECT 
> 52.216.185.251:443 <http://52.216.185.251:443> - 
> ORIGINAL_DST/52.216.185.251 <http://52.216.185.251> - -
> 1724028883.789 ? 6728 192.168.78.15 TCP_TUNNEL/200 69216 CONNECT 
> 52.216.185.251:443 <http://52.216.185.251:443> - 
> ORIGINAL_DST/52.216.185.251 <http://52.216.185.251> - -
> 1724028883.797 ? 6736 192.168.78.15 TCP_TUNNEL/200 104657 CONNECT 
> 52.216.185.251:443 <http://52.216.185.251:443> - 
> ORIGINAL_DST/52.216.185.251 <http://52.216.185.251> - -
> 1724028883.845 ? 6784 192.168.78.15 TCP_TUNNEL/200 80277 CONNECT 
> 52.216.185.251:443 <http://52.216.185.251:443> - 
> ORIGINAL_DST/52.216.185.251 <http://52.216.185.251> - -
> 1724028884.460 170355 192.168.78.15 TCP_TUNNEL/200 44690 CONNECT 
> 185.199.108.153:443 <http://185.199.108.153:443> - 
> ORIGINAL_DST/185.199.108.153 <http://185.199.108.153> - -
> 1724028889.845 120370 192.168.78.15 TCP_TUNNEL/200 5868 CONNECT 
> 104.126.37.161:443 <http://104.126.37.161:443> - 
> ORIGINAL_DST/104.126.37.161 <http://104.126.37.161> - -
> 1724028890.011 122862 192.168.78.15 TCP_TUNNEL/200 136726 CONNECT 
> 23.37.37.211:443 <http://23.37.37.211:443> - ORIGINAL_DST/23.37.37.211 
> <http://23.37.37.211> - -
> 1724028890.297 120381 192.168.78.15 TCP_TUNNEL/200 9176 CONNECT 
> 2.18.140.238:443 <http://2.18.140.238:443> - ORIGINAL_DST/2.18.140.238 
> <http://2.18.140.238> - -
> 1724028891.212 ? ? ?0 192.168.78.15 NONE_NONE/000 0 - 
> error:invalid-request - HIER_NONE/- - -
> 1724028891.365 ? ?152 192.168.78.15 TCP_TUNNEL/200 2359 CONNECT 
> 142.250.185.138:443 <http://142.250.185.138:443> - 
> ORIGINAL_DST/142.250.185.138 <http://142.250.185.138> - -
> 1724028893.885 ?90253 192.168.78.15 TCP_TUNNEL/200 6374 CONNECT 
> 13.107.246.60:443 <http://13.107.246.60:443> - 
> ORIGINAL_DST/13.107.246.60 <http://13.107.246.60> - -
> 1724028900.169 ? ? ?0 192.168.78.15 NONE_NONE/000 0 - 
> error:invalid-request - HIER_NONE/- - -
> 1724028934.465 900262 192.168.78.15 TCP_TUNNEL/200 5530 CONNECT 
> 52.123.243.197:443 <http://52.123.243.197:443> - 
> ORIGINAL_DST/52.123.243.197 <http://52.123.243.197> - -
> 1724028960.494 ?60324 192.168.78.15 TCP_TUNNEL/503 0 CONNECT 
> 172.217.16.206:443 <http://172.217.16.206:443> - 
> ORIGINAL_DST/172.217.16.206 <http://172.217.16.206> - -
> 1724028960.494 ? ? ?0 192.168.78.15 NONE_NONE/000 0 - 
> error:transaction-end-before-headers - HIER_NONE/- - -
> 
> Thanks for any help,
> 
> 
> 
> ----
> Eliezer Croitoru
> Tech Support
> Mobile: +972-5-28704261
> Email: ngtech1ltd at gmail.com <mailto:ngtech1ltd at gmail.com>
> 
> 
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> https://lists.squid-cache.org/listinfo/squid-users



From Josh.Piana at hexcel.com  Fri Aug 23 16:07:26 2024
From: Josh.Piana at hexcel.com (Piana, Josh)
Date: Fri, 23 Aug 2024 16:07:26 +0000
Subject: [squid-users] Unable to access local addresses
Message-ID: <9efc7b92c5b044ccab9f1606654dd3f9@hexcel.com>

Hello Squid Support,

We upgraded our Squid Web Proxy from 2.5 to 5.5 recently. After working out a few issues with backend services and authentication, our client can finally browse the web and adhere to all of the ACL rules and lists as expected.

The problem we're having now is that we're unable to access local resources on different subnets. For instance, our "main" networks are 10.46.x.x and 10.47.x.x, but the proxy is blocking us when we try to get to 172.26.x.x as well as 10.96.x.x. When comparing our current config to the old, they are very nearly identical, and the old config works with no issue. Is there some change from 2.5 -> 5.5 that would stop some of our allow/deny rules from working as expected? Or maybe I need to open up the ACL's a bit more or define those subnets explicitly now?

I can post our config below, I'll skip the sections that most likely don't pertain to the issue.

##############################################################################
# Authentication
##############################################################################

auth_param negotiate program /usr/lib64/squid/negotiate_kerberos_auth -k /etc/squid/HTTP.keytab -s HTTP/<domain>.ad.<domain>.com at AD.<domain>.COM
auth_param negotiate children 10
auth_param negotiate keep_alive on
acl kerb-auth proxy_auth REQUIRED

##############################################################################
# Access control - shared/common ACL definitions
##############################################################################

# acl all src all

acl src_self src 127.0.0.0/8
acl src_self src 10.46.11.69

acl dst_self dst 127.0.0.0/8
acl dst_self dst 10.46.11.69

acl from_arc src 10.46.0.0/16
acl from_arc src 10.46.0.0/15

acl local_dst_addr dst 10.0.0.0/8
acl local_dst_addr dst bldg3.<domain>.com
acl local_dst_addr dst bldg5.<domain>.com

# not sure what this does
acl local_dst_dom dstdomain <proxy hostname>

# protocols
acl proto_FTP proto FTP
acl proto_HTTP proto HTTP

# TCP ports for HTTP
acl http_ports port 80
acl http_ports port 81

# TCP ports for HTTPS
acl ssl_ports port 443

acl ssh_ports port 22
acl ftp_ports port 21

# HTTP methods
acl method_CONNECT method CONNECT

# what are these used for?
dsacl methods_std method GET HEAD POST PUT DELETE
acl methods_std method TRACE OPTIONS

#############################################################################
# Access control - general proxy
##############################################################################

http_access deny dst_self
http_access deny src_self
http_access deny !from_arc

http_access       allow local_dst_dom
http_reply_access           allow local_dst_dom

http_access       allow local_dst_addr
http_reply_access           allow local_dst_addr

acl authless_src src "/etc/squid/authless_src"
http_access       allow authless_src
http_reply_access           allow authless_src

acl authless_dst dstdomain "/etc/squid/authless_dst"
http_access       allow authless_dst
http_reply_access           allow authless_dst

acl bad_domains_preauth dstdomain "/etc/squid/bad_domains_preauth"
http_access deny bad_domains_preauth

acl block_user proxy_auth_regex -i "/etc/squid/block_user"
http_access deny block_user

acl bad_exception_urls url_regex -i "/etc/squid/bad_exception_urls"

acl exec_files url_regex -i "/etc/squid/exec_files"
acl exec_users proxy_auth_regex -i "/etc/squid/exec_users"

http_access deny !bad_exception_urls !exec_users exec_files
deny_info ERR_BLOCK_TYPE exec_files

acl mmedia_users proxy_auth_regex -i "/etc/squid/mmedia_users"
acl mmedia_sites dstdomain "/etc/squid/mmedia_sites"

http_access       allow methods_std    proto_HTTP http_ports mmedia_sites mmedia_users
http_reply_access allow methods_std    proto_HTTP http_ports mmedia_sites mmedia_users

http_access       allow method_CONNECT            ssl_ports  mmedia_sites mmedia_users
http_reply_access allow method_CONNECT            ssl_ports  mmedia_sites mmedia_users

acl bad_domains dstdomain "/etc/squid/bad_domains"
http_access deny !bad_exception_urls bad_domains
deny_info ERR_BLOCK_DST         bad_domains

acl bad_domains_regex dstdom_regex -i "/etc/squid/bad_domains_regex"
http_access deny !bad_exception_urls bad_domains_regex
deny_info ERR_BLOCK_DST         bad_domains_regex

acl bad_urls url_regex -i "/etc/squid/bad_urls"
http_access deny !bad_exception_urls bad_urls
deny_info ERR_BLOCK_DST         bad_urls

acl bad_files urlpath_regex -i "/etc/squid/bad_files"
http_access deny !bad_exception_urls bad_files
deny_info ERR_BLOCK_TYPE bad_files

acl bad_types rep_mime_type -i "/etc/squid/bad_types"
http_reply_access deny bad_types !bad_exception_urls
deny_info ERR_BLOCK_TYPE bad_types

acl fsoguest_user proxy_auth_regex -i fsoguest
acl fsoguest_dst dstdomain .opm.gov
acl fsoguest_dst dstdomain .google-analytics.com
acl fsoguest_dst dstdomain pki.google.com
acl fsoguest_dst dstdomain ajax.googleapis.com
acl fsoguest_dst dstdomain fonts.googleapis.com
acl fsoguest_dst dstdomain html5shiv.googlecode.com
acl fsoguest_dst dstdomain fonts.gstatic.com
acl fsoguest_dst dstdomain clients1.google.com
acl fsoguest_dst dstdomain ajax.microsoft.com
acl fsoguest_dst dstdomain ajax.aspnetcdn.com
acl fsoguest_dst dstdomain .geotrust.com
acl fsoguest_dst dstdomain .akamaihd.net
acl fsoguest_dst dstdomain symcd.com
http_access allow methods_std proto_HTTP http_ports fsoguest_dst fsoguest_user
http_access allow method_CONNECT         ssl_ports  fsoguest_dst fsoguest_user
http_access deny fsoguest_user

http_access allow http_ports proto_HTTP methods_std
http_access allow method_CONNECT ssl_ports
http_access deny method_CONNECT

# catch-all
http_access allow ftp_ports proto_FTP
http_access allow kerb-auth
http_access deny all
http_reply_access allow all

##############################################################################
# END OF FILE
##############################################################################
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20240823/59f38198/attachment.htm>

From rousskov at measurement-factory.com  Fri Aug 23 17:13:55 2024
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Fri, 23 Aug 2024 13:13:55 -0400
Subject: [squid-users] Unable to access local addresses
In-Reply-To: <9efc7b92c5b044ccab9f1606654dd3f9@hexcel.com>
References: <9efc7b92c5b044ccab9f1606654dd3f9@hexcel.com>
Message-ID: <231fb248-bbe0-4a4a-a4a7-b516df1cb35b@measurement-factory.com>

On 2024-08-23 12:07, Piana, Josh wrote:

> The problem we?re having now is that we?re unable to access local 
> resources on different subnets. For instance, our ?main? networks are 
> 10.46.x.x and 10.47.x.x, but the proxy is blocking us when we try to get 
> to 172.26.x.x as well as 10.96.x.x. 

Blocking how? What kind of error page does the client get? What does 
Squid log to access.log (consider adding %err_code/%err_detail to your 
custom logformat definition if you have not already).

If access is blocked by an "http_access deny" rule you do not expect to 
match, then which "http_access allow" rule (located above the matched 
deny rule[^1]) do you expect to match those blocked transactions? If 
access is prevented due to connection establishment errors, then you may 
need to adjust your IP routing rules/etc. outside of Squid. And there 
are many other possibilities here...

[1]: If access is blocked by an "http_access deny" rule, you may be able 
to figure out which deny rule has matched by enabling ALL,2 debugging 
(see debug_options in squid.conf.documented), reproducing the problem 
using a single transaction, and searching cache.log for "last ACL 
checked". Older Squids have more bugs in determining that ACL name, but, 
if you are lucky, you will get the right answer.


> When comparing our current config to 
> the old, they are very nearly identical, and the old config works with 
> no issue. Is there some change from 2.5 -> 5.5 that would stop some of 
> our allow/deny rules from working as expected?

There are too many corner cases for me to give a reliable answer to that 
question, especially without knowing which http_access rule is denying 
access (assuming it is one of those rules). I recommend focusing on a 
specific matching/mismatching ACL/rule instead of trying to make a 
general statement regarding numerous v2-vs-v5 differences.


> Or maybe I need to open 
> up the ACL?s a bit more or define those subnets explicitly now?

If your existing rules already reflect your business logic and do not 
trigger any Squid configuration errors/warnings in cache.log, then it is 
unlikely that you will need to add explicit rules for previously working 
subnets. On the other hand, you are upgrading from an ancient Squid 
version that most do not remember much about to an already unsupported 
Squid version, so all bets are off.

 > acl from_arc src 10.46.0.0/16
 > acl from_arc src 10.46.0.0/15

Remove the line you do not need (I do not know which one, but the 
combination does not make sense because one subnet includes the other).


 > dsacl methods_std method GET HEAD POST PUT DELETE

If this is not a copy-paste typo, then edit this line to use a supported 
directive name like "acl". "dsacl" is not a supported directive name.


HTH,

Alex.


> I can post our config below, I?ll skip the sections that most likely 
> don?t pertain to the issue.
> 
> ##############################################################################
> 
> # Authentication
> 
> ##############################################################################
> 
> auth_param negotiate program /usr/lib64/squid/negotiate_kerberos_auth -k 
> /etc/squid/HTTP.keytab -s HTTP/<domain>.ad.<domain>.com at AD.<domain>.COM
> 
> auth_param negotiate children 10
> 
> auth_param negotiate keep_alive on
> 
> acl kerb-auth proxy_auth REQUIRED
> 
> ##############################################################################
> 
> # Access control - shared/common ACL definitions
> 
> ##############################################################################
> 
> # acl all src all
> 
> acl src_self src 127.0.0.0/8
> 
> acl src_self src 10.46.11.69
> 
> acl dst_self dst 127.0.0.0/8
> 
> acl dst_self dst 10.46.11.69
> 
> acl from_arc src 10.46.0.0/16
> 
> acl from_arc src 10.46.0.0/15
> 
> acl local_dst_addr dst 10.0.0.0/8
> 
> acl local_dst_addr dst bldg3.<domain>.com
> 
> acl local_dst_addr dst bldg5.<domain>.com
> 
> # not sure what this does
> 
> acl local_dst_dom dstdomain <proxy hostname>
> 
> # protocols
> 
> acl proto_FTP proto FTP
> 
> acl proto_HTTP proto HTTP
> 
> # TCP ports for HTTP
> 
> acl http_ports port 80
> 
> acl http_ports port 81
> 
> # TCP ports for HTTPS
> 
> acl ssl_ports port 443
> 
> acl ssh_ports port 22
> 
> acl ftp_ports port 21
> 
> # HTTP methods
> 
> acl method_CONNECT method CONNECT
> 
> # what are these used for?
> 
> dsacl methods_std method GET HEAD POST PUT DELETE
> 
> acl methods_std method TRACE OPTIONS
> 
> #############################################################################
> 
> # Access control - general proxy
> 
> ##############################################################################
> 
> http_access deny dst_self
> 
> http_access deny src_self
> 
> http_access deny !from_arc
> 
> http_access?????? allow local_dst_dom
> 
> http_reply_access ????????? allow local_dst_dom
> 
> http_access?????? allow local_dst_addr
> 
> http_reply_access ????????? allow local_dst_addr
> 
> acl authless_src src "/etc/squid/authless_src"
> 
> http_access?????? allow authless_src
> 
> http_reply_access ????????? allow authless_src
> 
> acl authless_dst dstdomain "/etc/squid/authless_dst"
> 
> http_access?????? allow authless_dst
> 
> http_reply_access ????????? allow authless_dst
> 
> acl bad_domains_preauth dstdomain "/etc/squid/bad_domains_preauth"
> 
> http_access deny bad_domains_preauth
> 
> acl block_user proxy_auth_regex -i "/etc/squid/block_user"
> 
> http_access deny block_user
> 
> acl bad_exception_urls url_regex -i "/etc/squid/bad_exception_urls"
> 
> acl exec_files url_regex -i "/etc/squid/exec_files"
> 
> acl exec_users proxy_auth_regex -i "/etc/squid/exec_users"
> 
> http_access deny !bad_exception_urls !exec_users exec_files
> 
> deny_info ERR_BLOCK_TYPE exec_files
> 
> acl mmedia_users proxy_auth_regex -i "/etc/squid/mmedia_users"
> 
> acl mmedia_sites dstdomain "/etc/squid/mmedia_sites"
> 
> http_access?????? allow methods_std??? proto_HTTP http_ports 
> mmedia_sites mmedia_users
> 
> http_reply_access allow methods_std??? proto_HTTP http_ports 
> mmedia_sites mmedia_users
> 
> http_access?????? allow method_CONNECT??????????? ssl_ports  
> mmedia_sites mmedia_users
> 
> http_reply_access allow method_CONNECT??????????? ssl_ports  
> mmedia_sites mmedia_users
> 
> acl bad_domains dstdomain "/etc/squid/bad_domains"
> 
> http_access deny !bad_exception_urls bad_domains
> 
> deny_info ERR_BLOCK_DST???????? bad_domains
> 
> acl bad_domains_regex dstdom_regex -i "/etc/squid/bad_domains_regex"
> 
> http_access deny !bad_exception_urls bad_domains_regex
> 
> deny_info ERR_BLOCK_DST???????? bad_domains_regex
> 
> acl bad_urls url_regex -i "/etc/squid/bad_urls"
> 
> http_access deny !bad_exception_urls bad_urls
> 
> deny_info ERR_BLOCK_DST???????? bad_urls
> 
> acl bad_files urlpath_regex -i "/etc/squid/bad_files"
> 
> http_access deny !bad_exception_urls bad_files
> 
> deny_info ERR_BLOCK_TYPE bad_files
> 
> acl bad_types rep_mime_type -i "/etc/squid/bad_types"
> 
> http_reply_access deny bad_types !bad_exception_urls
> 
> deny_info ERR_BLOCK_TYPE bad_types
> 
> acl fsoguest_user proxy_auth_regex -i fsoguest
> 
> acl fsoguest_dst dstdomain .opm.gov
> 
> acl fsoguest_dst dstdomain .google-analytics.com
> 
> acl fsoguest_dst dstdomain pki.google.com
> 
> acl fsoguest_dst dstdomain ajax.googleapis.com
> 
> acl fsoguest_dst dstdomain fonts.googleapis.com
> 
> acl fsoguest_dst dstdomain html5shiv.googlecode.com
> 
> acl fsoguest_dst dstdomain fonts.gstatic.com
> 
> acl fsoguest_dst dstdomain clients1.google.com
> 
> acl fsoguest_dst dstdomain ajax.microsoft.com
> 
> acl fsoguest_dst dstdomain ajax.aspnetcdn.com
> 
> acl fsoguest_dst dstdomain .geotrust.com
> 
> acl fsoguest_dst dstdomain .akamaihd.net
> 
> acl fsoguest_dst dstdomain symcd.com
> 
> http_access allow methods_std proto_HTTP http_ports fsoguest_dst 
> fsoguest_user
> 
> http_access allow method_CONNECT???????? ssl_ports? fsoguest_dst 
> fsoguest_user
> 
> http_access deny fsoguest_user
> 
> http_access allow http_ports proto_HTTP methods_std
> 
> http_access allow method_CONNECT ssl_ports
> 
> http_access deny method_CONNECT
> 
> # catch-all
> 
> http_access allow ftp_ports proto_FTP
> 
> http_access allow kerb-auth
> 
> http_access deny all
> 
> http_reply_access allow all
> 
> ##############################################################################
> 
> # END OF FILE
> 
> ##############################################################################
> 
> 
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> https://lists.squid-cache.org/listinfo/squid-users



From alexandru.mateescu at retailinmotion.com  Mon Aug 26 06:23:09 2024
From: alexandru.mateescu at retailinmotion.com (Alexandru Mateescu)
Date: Mon, 26 Aug 2024 06:23:09 +0000
Subject: [squid-users] Squid Vulnerabilities
In-Reply-To: <AS4PR09MB554982663D9F9364985D9B7AE48B2@AS4PR09MB5549.eurprd09.prod.outlook.com>
References: <AS4PR09MB554982663D9F9364985D9B7AE48B2@AS4PR09MB5549.eurprd09.prod.outlook.com>
Message-ID: <AS4PR09MB55498A9F0D65F29BBA294C10E48B2@AS4PR09MB5549.eurprd09.prod.outlook.com>

Internal

Hi all

In October 2023 the free vulnerabilities scanner of Greenbone (Openvas) has started reporting high vulnerabilities on squid for all versions.

When I questioned them about it they indicated https://megamansec.github.io/Squid-Security-Audit/ as their source of truth and to date they have not reduced the score of the vulnerability causing extensive issues for me and my security team.

I further asked them about it and they are looking for a published list of security advisories about these vulnerabilities.

Would it be possible to issue such a list for whichever ones are fixed to date in squid 6.10 so maybe they can lower that vulnerability score?

Regards

Alex Mateescu
The information contained in this email transmission is confidential and may be privileged. It is intended only for the addressee(s) stated above. If you are not an addressee, any use, dissemination, distribution, publication or copying of the information contained in this email is strictly prohibited. It is your responsibility to scan this email and any attachments for viruses. If you have received this email in error, please immediately notify us at infosec at retailinmotion.com<mailto:infosec at retailinmotion.com> and delete the email from your system.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20240826/60a1479d/attachment.htm>

From rousskov at measurement-factory.com  Mon Aug 26 14:01:26 2024
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Mon, 26 Aug 2024 10:01:26 -0400
Subject: [squid-users] Squid Vulnerabilities
In-Reply-To: <AS4PR09MB55498A9F0D65F29BBA294C10E48B2@AS4PR09MB5549.eurprd09.prod.outlook.com>
References: <AS4PR09MB554982663D9F9364985D9B7AE48B2@AS4PR09MB5549.eurprd09.prod.outlook.com>
 <AS4PR09MB55498A9F0D65F29BBA294C10E48B2@AS4PR09MB5549.eurprd09.prod.outlook.com>
Message-ID: <6d289899-e52a-4a1a-81bd-dbe82dd59469@measurement-factory.com>

On 2024-08-26 02:23, Alexandru Mateescu wrote:

> In October 2023 the free vulnerabilities scanner of Greenbone (Openvas) 
> has started reporting high vulnerabilities on squid for all versions.
> 
> When I questioned them about it they indicated 
> https://megamansec.github.io/Squid-Security-Audit/ as their source of 
> truth and to date they have not reduced the score of the vulnerability 
> causing extensive issues for me and my security team.
> 
> I further asked them about it and they are looking for a published list 
> of security advisories about these vulnerabilities.

FWIW, the official list of recent Squid advisories is at
https://github.com/squid-cache/squid/security/advisories/

Some year-2020 and earlier advisories are available at
http://www.squid-cache.org/Advisories/

Needless to say, converting the above information into a list dedicated 
to "Joshua 55" report (and to Squid v6.10) requires a lot of work.


> Would it be possible to issue such a list for whichever ones are fixed 
> to date in squid 6.10

Yes, it is possible. FWIW, I built a similar _unofficial_ list at
https://gist.github.com/rousskov/9af0d33d2a1f4b5b3b948b2da426e77d

Please note that any meaningful list would heavily depend on Squid build 
options and runtime configuration in this case, as detailed in a recent 
squid-users email: 
https://lists.squid-cache.org/pipermail/squid-users/2024-August/027043.html


HTH,

Alex.



From scott.bates at gmail.com  Tue Aug 27 18:07:04 2024
From: scott.bates at gmail.com (Scott Bates)
Date: Tue, 27 Aug 2024 14:07:04 -0400
Subject: [squid-users] Squid traffic paths
Message-ID: <CAFB-0QbBxyXopf+aYHKp_NosydHDg0AWBF9Xvc+C_RgB8UcCrQ@mail.gmail.com>

My lab is setup as such:
Hypervisor host
Squid VM
Test VM 1 (windows)
Test VM 2 (windows)
Test VM 3 (windows)

I have my proxies setup in the squid config. On the test vms I have the
windows proxy settings pointing to the squid IP and port. If I check the
public IP on that vm it shows up as the proxy IP. And in the proxy logs I
see traffic going out.

The issue I'm having is that some external services are seeing the hosts
public IP for the test vms and not the proxy ip.

Squid config:















*# First proxyhttp_port 3127acl port3127_acl myport 3127cache_peer PROXYIP
parent 9229 0 proxy-only no-query no-digest
login=USERNAME:PASSWORDcache_peer_access PROXYIP allow
port3127_aclcache_peer_access PROXYIP deny allnever_direct allow
port3127_aclnever_direct allow allhttp_access allow port3127_acl# Deny
caching on all proxies (optional)cache deny all# Default access
controlhttp_access deny alldns_nameservers 127.0.0.1forwarded_for
offrequest_header_access X-Forwarded-For deny all*

I'm not exactly sure how squid handles all dns traffic. I feel like this
might be a dns issue. I tried using google dns and the squid server ip as
dns on the test vms but same issue.
I started to mess around with dnsmasq installed on squid but I'm not sure
if I'm going down the right path or not.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20240827/9566497f/attachment.htm>

From rousskov at measurement-factory.com  Tue Aug 27 18:29:24 2024
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Tue, 27 Aug 2024 14:29:24 -0400
Subject: [squid-users] Squid traffic paths
In-Reply-To: <CAFB-0QbBxyXopf+aYHKp_NosydHDg0AWBF9Xvc+C_RgB8UcCrQ@mail.gmail.com>
References: <CAFB-0QbBxyXopf+aYHKp_NosydHDg0AWBF9Xvc+C_RgB8UcCrQ@mail.gmail.com>
Message-ID: <e2a5b503-e598-4c41-bd65-30d4b35208b8@measurement-factory.com>

On 2024-08-27 14:07, Scott Bates wrote:
> My lab is setup as such:
> Hypervisor host
> Squid VM
> Test VM 1 (windows)
> Test VM 2 (windows)
> Test VM 3 (windows)
> 
> I have my proxies setup in the squid config. On the test vms I have the 
> windows proxy settings pointing to the squid IP and port. If I check the 
> public IP on that vm it shows up as the proxy IP. And in the proxy logs 
> I see traffic going out.
> 
> The issue I'm having is that some external services are seeing the hosts 
> public IP for the test vms and not the proxy ip.

What protocol do those external services use in problematic use cases? 
Does Squid see the corresponding requests from VMs? Squid can only proxy 
HTTP and FTP...


 > I'm not exactly sure how squid handles all dns traffic.

Squid generates DNS queries (if needed) and, naturally, receives DNS 
answers for the queries it generates. Squid does not receive and, hence, 
does not forward/proxy DNS queries. There is no dns_port option in 
squid.conf; only http(s)_port and ftp_port.

 > never_direct allow port3127_acl
 > never_direct allow all

Pick one. The first (more restrictive) rule is not needed if you are 
going to allow all.


HTH,

Alex.


> Squid config:
> *# First proxy
> http_port 3127
> acl port3127_acl myport 3127
> cache_peer PROXYIP parent 9229 0 proxy-only no-query no-digest 
> login=USERNAME:PASSWORD
> cache_peer_access PROXYIP allow port3127_acl
> cache_peer_access PROXYIP deny all
> never_direct allow port3127_acl
> never_direct allow all
> http_access allow port3127_acl
> # Deny caching on all proxies (optional)
> cache deny all
> # Default access control
> http_access deny all
> dns_nameservers 127.0.0.1
> forwarded_for off
> request_header_access X-Forwarded-For deny all*
> 
> I'm not exactly sure how squid handles all dns traffic. I feel like this 
> might be a dns issue. I tried using google dns and the squid server ip 
> as dns on the test vms but same issue.
> I started to mess around with dnsmasq installed on squid but I'm not 
> sure if I'm going down the right path or not.
> 
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> https://lists.squid-cache.org/listinfo/squid-users



From uhlar at fantomas.sk  Tue Aug 27 18:45:58 2024
From: uhlar at fantomas.sk (Matus UHLAR - fantomas)
Date: Tue, 27 Aug 2024 20:45:58 +0200
Subject: [squid-users] SQUID 6.10 vulnerabilities
In-Reply-To: <GV2PR02MB8578B40A468F066BC11A0511B28C2@GV2PR02MB8578.eurprd02.prod.outlook.com>
References: <GV2PR02MB857836C6DB79C3B31F3BAA03B28C2@GV2PR02MB8578.eurprd02.prod.outlook.com>
 <GV2PR02MB8578E076D9F90F225A95FF5FB28C2@GV2PR02MB8578.eurprd02.prod.outlook.com>
 <GV2PR02MB8578B40A468F066BC11A0511B28C2@GV2PR02MB8578.eurprd02.prod.outlook.com>
Message-ID: <Zs4e5oKXMxNY7YIL@fantomas.sk>

On 19.08.24 11:37, Guy Tzudkevitz wrote:
>I'm running Squid on Ubuntu 22.04
>I ran a vulnerability scan on this server and got a result from the vendor that this version is vulnerable. See. Is there any way to fix it?

Ubuntu package developers and/or security team usually fix those bugs 
without raising version numbers.

these scanners usually use the version number reported by squid while 
knowing that the vulnerability may be fixed.

They often even notice you about it in scan results.

you can check if the particular bug is fixed in Ubuntu version on:
https://ubuntu.com/security/cves

e.g.
https://ubuntu.com/security/cves?q=&package=squid&version=jammy

>Vulnerability Details
>Name
>Squid Multiple 0-Day Vulnerabilities (Oct 2023)
>Found On
>X.X.X.X
>Insight
>
>The following flaws have been reported in 2021 to the vendor and seems to be not fixed yet:
> - Use-After-Free in TRACE Requests
> - X-Forwarded-For Stack Overflow
> - Chunked Encoding Stack Overflow
> - Use-After-Free in Cache Manager Errors
> - Memory Leak in HTTP Response Parsing
> - Memory Leak in ESI Error Processing
> - 1-Byte Buffer OverRead in RFC 1123 date/time Handling GHSA-8w9r-p88v-mmx9
> - One-Byte Buffer OverRead in HTTP Request Header Parsing
> - strlen(NULL) Crash Using Digest Authentication GHSA-254c-93q9-cp53
> - Assertion in ESI Header Handling
> - Gopher Assertion Crash
> - Whois Assertion Crash
> - RFC 2141 / 2169 (URN) Assertion Crash
> - Assertion in Negotiate/NTLM Authentication Using Pipeline Prefetching
> - Assertion on IPv6 Host Requests with
> --disable-ipv6
> - Assertion Crash on Unexpected 'HTTP/1.1 100 Continue' Response Header
> - Pipeline Prefetch Assertion With Double 'Expect:100-continue' Request Headers
> - Pipeline Prefetch Assertion With Invalid Headers
> - Assertion Crash in Deferred Requests
> - Assertion in Digest Authentication
> - FTP Authentication Crash
> - Assertion Crash In HTTP Response Headers Handling
> - Implicit Assertion in Stream Handling
> - Use-After-Free in ESI 'Try' (and 'Choose') Processing
> - Use-After-Free in ESI Expression Evaluation
> - Buffer Underflow in ESI GHSA-wgvf-q977-9xjg
> - Assertion in Squid 'Helper' Process Creator GHSA-xggx-9329-3c27
> - Assertion Due to 0 ESI 'when' Checking GHSA-4g88-277m-q89r
> - Assertion Using ESI's When Directive GHSA-4g88-277m-q89r
> - Assertion in ESI Variable Assignment (String)
> - Assertion in ESI Variable Assignment
> - Null Pointer Dereference In ESI's esi:include and esi:when Note: Various GHSA advisories have been provided by the security researcher but are not published / available yet.

-- 
Matus UHLAR - fantomas, uhlar at fantomas.sk ; http://www.fantomas.sk/
Warning: I wish NOT to receive e-mail advertising to this address.
Varovanie: na tuto adresu chcem NEDOSTAVAT akukolvek reklamnu postu.
He who laughs last thinks slowest.


From ngtech1ltd at gmail.com  Wed Aug 28 10:26:33 2024
From: ngtech1ltd at gmail.com (ngtech1ltd at gmail.com)
Date: Wed, 28 Aug 2024 13:26:33 +0300
Subject: [squid-users] Rocky 8 new repo
Message-ID: <049801daf934$c1d5f090$4581d1b0$@gmail.com>

Hey List,

After some time, work and testing I started maintaining the rocky squid
cache packaging at:
https://www.ngtech.co.il/repo/rocky/8/

Until now the tests are showing very good results in real usage.

https://www.nethserver.org/

Are using Rocky linux and their 7 release is pretty good, I am waiting to
see what will be the result for 8.


----
Eliezer Croitoru
NgTech, Tech Support
Mobile: +972-5-28704261
Email: http://lists.squid-cache.org/listinfo/squid-users





From scott.bates at gmail.com  Wed Aug 28 12:52:03 2024
From: scott.bates at gmail.com (Scott Bates)
Date: Wed, 28 Aug 2024 08:52:03 -0400
Subject: [squid-users] Squid traffic paths (Alex Rousskov)
Message-ID: <CAFB-0QZZtYrmueh5+qYQ2WJHVzOwNmH9ArSWAcsPhwyHrMSpXQ@mail.gmail.com>

> What protocol do those external services use in problematic use cases?
Does Squid see the corresponding requests from VMs? Squid can only proxy
HTTP and FTP...

http and https only

The weird thing is I have an android test phone that also goes through
squid and that device shows the correct IP on the online services.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20240828/bfebe8ca/attachment.htm>

From rousskov at measurement-factory.com  Wed Aug 28 13:14:49 2024
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Wed, 28 Aug 2024 09:14:49 -0400
Subject: [squid-users] Squid traffic paths
In-Reply-To: <CAFB-0QZZtYrmueh5+qYQ2WJHVzOwNmH9ArSWAcsPhwyHrMSpXQ@mail.gmail.com>
References: <CAFB-0QZZtYrmueh5+qYQ2WJHVzOwNmH9ArSWAcsPhwyHrMSpXQ@mail.gmail.com>
Message-ID: <5c1b19d1-b692-4958-a6b6-97caf32c11ce@measurement-factory.com>

On 2024-08-28 08:52, Scott Bates wrote:

>> Alex: What protocol do those external services use in problematic 
>> use cases?>> Does Squid see the corresponding requests from VMs?
>> Squid can only proxy HTTP and FTP...

> http and https only

Does Squid log the corresponding problematic transactions to its access.log?


> The weird thing is I have an android test phone that also goes through 
> squid and that device shows the correct IP on the online services.

My working theory is that (a) android test phone goes through Squid 
(i.e. uses Squid as an HTTP proxy) while (b) the problematic test 
traffic does not (i.e. goes directly to the external service).

The first guess can be confirmed using access.log (should be trivial in 
an isolated test environment). The second guess can be confirmed by 
packet capture analysis (may not be trivial in a virtualized environment 
and on Windows).


HTH,

Alex.



From Josh.Piana at hexcel.com  Wed Aug 28 14:20:50 2024
From: Josh.Piana at hexcel.com (Piana, Josh)
Date: Wed, 28 Aug 2024 14:20:50 +0000
Subject: [squid-users] Unable to access internal resources via hostname
Message-ID: <405705ce244447aca1b15385a171fada@hexcel.com>

Hello Squid Support,

We have a newly configured Squid Web Proxy that is allowing connections to external addresses as expected, seemingly following the written ACL's we have in place.

We are unable to get to internal resources via hostname but using the IP address works fine. Immediately, I thought this was DNS but when I checked the /etc/resolv.conf/ file it was pointing correctly to our Windows DNS server and we can ping all devices using their hostname, just not when browsing to it. This leads me to believe something may be wrong with our squid config.

Thank you for any help in this.
Josh
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20240828/fab5bb6e/attachment.htm>

From uhlar at fantomas.sk  Wed Aug 28 14:47:18 2024
From: uhlar at fantomas.sk (Matus UHLAR - fantomas)
Date: Wed, 28 Aug 2024 16:47:18 +0200
Subject: [squid-users] Unable to access internal resources via hostname
In-Reply-To: <405705ce244447aca1b15385a171fada@hexcel.com>
References: <405705ce244447aca1b15385a171fada@hexcel.com>
Message-ID: <Zs84drvoIpZ1f6DR@fantomas.sk>

On 28.08.24 14:20, Piana, Josh wrote:
>Hello Squid Support,

This squid user forum FYI

> We are unable to get to internal resources via hostname but using the IP 
> address works fine.  Immediately, I thought this was DNS but when I 
> checked the /etc/resolv.conf/ file it was pointing correctly to our 
> Windows DNS server and we can ping all devices using their hostname, just 
> not when browsing to it.  This leads me to believe something may be wrong 
> with our squid config.

hard to guess without seeing logs or ACL's.


-- 
Matus UHLAR - fantomas, uhlar at fantomas.sk ; http://www.fantomas.sk/
Warning: I wish NOT to receive e-mail advertising to this address.
Varovanie: na tuto adresu chcem NEDOSTAVAT akukolvek reklamnu postu.
It's now safe to throw off your computer.


From Josh.Piana at hexcel.com  Wed Aug 28 15:24:26 2024
From: Josh.Piana at hexcel.com (Piana, Josh)
Date: Wed, 28 Aug 2024 15:24:26 +0000
Subject: [squid-users] Unable to access internal resources via hostname
In-Reply-To: <Zs84drvoIpZ1f6DR@fantomas.sk>
References: <405705ce244447aca1b15385a171fada@hexcel.com>
 <Zs84drvoIpZ1f6DR@fantomas.sk>
Message-ID: <58bdfaada3fa46d0938b7346ec04c336@hexcel.com>

Squid Forums, 

Here's the log and (I think) relevant ACL's? 
-----------------------------------------------------------------------------------------------------------
# /var/log/squid/access.log results for internal conflicts

28/Aug/2024:10:57:17 -0400.234 10.46.49.190 TCP_DENIED/407 4132 CONNECT hexcelssp:443 - HIER_NONE/- text/html
28/Aug/2024:10:57:17 -0400.253 10.46.49.190 NONE_NONE/500 0 CONNECT hexcelssp:443 JPIANA at AD.<DOMAIN>.COM HIER_NONE/- -
28/Aug/2024:10:57:17 -0400.380 10.46.49.190 TCP_DENIED/407 4132 CONNECT hexcelssp:443 - HIER_NONE/- text/html
28/Aug/2024:10:57:17 -0400.399 10.46.49.190 NONE_NONE/500 0 CONNECT hexcelssp:443 JPIANA at AD.<DOMAIN>.COM HIER_NONE/- -
-----------------------------------------------------------------------------------------------------------

# acl all src all

acl src_self src 127.0.0.0/8
acl src_self src 10.46.11.69

acl dst_self dst 127.0.0.0/8
acl dst_self dst 10.46.11.69

acl from_arc src 10.46.0.0/15

acl local_dst_addr dst 10.0.0.0/8
acl local_dst_addr dst 172.0.0.0/8
acl local_dst_addr dst bldg3.<domain>.com
acl local_dst_addr dst bldg5.<domain>.com

# these keep URLs of popular local servers from being forwarded
acl local_dst_dom dstdomain arcgate

# allow connects to local destinations without authentication
# by domain name from URL
http_access       allow local_dst_dom
http_reply_access allow local_dst_dom

# by IP address name resolves to
http_access       allow local_dst_addr
http_reply_access allow local_dst_addr

# allow trusted hosts without authentication
# these are just ip's on the 10.46.11.x network
acl authless_src src "/etc/squid/authless_src"
http_access       allow authless_src
http_reply_access allow authless_src
-----------------------------------------------------------------------------------------------------------

-----Original Message-----
From: squid-users <squid-users-bounces at lists.squid-cache.org> On Behalf Of Matus UHLAR - fantomas
Sent: Wednesday, August 28, 2024 10:47 AM
To: squid-users at lists.squid-cache.org
Subject: Re: [squid-users] Unable to access internal resources via hostname

Caution: This email originated from outside of Hexcel. Do not click links or open attachments unless you recognize the sender and know the content is safe.


On 28.08.24 14:20, Piana, Josh wrote:
>Hello Squid Support,

This squid user forum FYI

> We are unable to get to internal resources via hostname but using the 
> IP address works fine.  Immediately, I thought this was DNS but when I 
> checked the /etc/resolv.conf/ file it was pointing correctly to our 
> Windows DNS server and we can ping all devices using their hostname, 
> just not when browsing to it.  This leads me to believe something may 
> be wrong with our squid config.

hard to guess without seeing logs or ACL's.


--
Matus UHLAR - fantomas, uhlar at fantomas.sk ; http://www.fantomas.sk/
Warning: I wish NOT to receive e-mail advertising to this address.
Varovanie: na tuto adresu chcem NEDOSTAVAT akukolvek reklamnu postu.
It's now safe to throw off your computer.
_______________________________________________
squid-users mailing list
squid-users at lists.squid-cache.org
https://lists.squid-cache.org/listinfo/squid-users


From rousskov at measurement-factory.com  Wed Aug 28 18:18:57 2024
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Wed, 28 Aug 2024 14:18:57 -0400
Subject: [squid-users] Unable to access internal resources via hostname
In-Reply-To: <58bdfaada3fa46d0938b7346ec04c336@hexcel.com>
References: <405705ce244447aca1b15385a171fada@hexcel.com>
 <Zs84drvoIpZ1f6DR@fantomas.sk> <58bdfaada3fa46d0938b7346ec04c336@hexcel.com>
Message-ID: <947309fa-d1fc-4a75-ac49-ea7bc5c5ff12@measurement-factory.com>

On 2024-08-28 11:24, Piana, Josh wrote:

> Here's the log and (I think) relevant ACL's?

According to your access.log, Squid denies problematic CONNECT requests 
with HTTP 407 errors responses. Usually, that means those requests match 
an "http_access deny" rule. Clearly, you expect an "allow" outcome 
instead, but it is difficult (for me) to figure out where your 
expectations mismatch reality; there are no rules that explicitly 
mention hexcelssp domain, for example: Which "http_access allow" rule do 
you expect those denied requests to match?

Also, does mgr:ipcache cache manager query confirm that Squid has read 
your /etc/hosts file and cached the record you expect it to use?

Alex.


> -----------------------------------------------------------------------------------------------------------
> # /var/log/squid/access.log results for internal conflicts
> 
> 28/Aug/2024:10:57:17 -0400.234 10.46.49.190 TCP_DENIED/407 4132 CONNECT hexcelssp:443 - HIER_NONE/- text/html
> 28/Aug/2024:10:57:17 -0400.253 10.46.49.190 NONE_NONE/500 0 CONNECT hexcelssp:443 JPIANA at AD.<DOMAIN>.COM HIER_NONE/- -
> 28/Aug/2024:10:57:17 -0400.380 10.46.49.190 TCP_DENIED/407 4132 CONNECT hexcelssp:443 - HIER_NONE/- text/html
> 28/Aug/2024:10:57:17 -0400.399 10.46.49.190 NONE_NONE/500 0 CONNECT hexcelssp:443 JPIANA at AD.<DOMAIN>.COM HIER_NONE/- -
> -----------------------------------------------------------------------------------------------------------
> 
> # acl all src all
> 
> acl src_self src 127.0.0.0/8
> acl src_self src 10.46.11.69
> 
> acl dst_self dst 127.0.0.0/8
> acl dst_self dst 10.46.11.69
> 
> acl from_arc src 10.46.0.0/15
> 
> acl local_dst_addr dst 10.0.0.0/8
> acl local_dst_addr dst 172.0.0.0/8
> acl local_dst_addr dst bldg3.<domain>.com
> acl local_dst_addr dst bldg5.<domain>.com
> 
> # these keep URLs of popular local servers from being forwarded
> acl local_dst_dom dstdomain arcgate
> 
> # allow connects to local destinations without authentication
> # by domain name from URL
> http_access       allow local_dst_dom
> http_reply_access allow local_dst_dom
> 
> # by IP address name resolves to
> http_access       allow local_dst_addr
> http_reply_access allow local_dst_addr
> 
> # allow trusted hosts without authentication
> # these are just ip's on the 10.46.11.x network
> acl authless_src src "/etc/squid/authless_src"
> http_access       allow authless_src
> http_reply_access allow authless_src
> -----------------------------------------------------------------------------------------------------------
> 
> -----Original Message-----
> From: squid-users <squid-users-bounces at lists.squid-cache.org> On Behalf Of Matus UHLAR - fantomas
> Sent: Wednesday, August 28, 2024 10:47 AM
> To: squid-users at lists.squid-cache.org
> Subject: Re: [squid-users] Unable to access internal resources via hostname
> 
> Caution: This email originated from outside of Hexcel. Do not click links or open attachments unless you recognize the sender and know the content is safe.
> 
> 
> On 28.08.24 14:20, Piana, Josh wrote:
>> Hello Squid Support,
> 
> This squid user forum FYI
> 
>> We are unable to get to internal resources via hostname but using the
>> IP address works fine.  Immediately, I thought this was DNS but when I
>> checked the /etc/resolv.conf/ file it was pointing correctly to our
>> Windows DNS server and we can ping all devices using their hostname,
>> just not when browsing to it.  This leads me to believe something may
>> be wrong with our squid config.
> 
> hard to guess without seeing logs or ACL's.
> 
> 
> --
> Matus UHLAR - fantomas, uhlar at fantomas.sk ; http://www.fantomas.sk/
> Warning: I wish NOT to receive e-mail advertising to this address.
> Varovanie: na tuto adresu chcem NEDOSTAVAT akukolvek reklamnu postu.
> It's now safe to throw off your computer.
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> https://lists.squid-cache.org/listinfo/squid-users
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> https://lists.squid-cache.org/listinfo/squid-users



From rousskov at measurement-factory.com  Wed Aug 28 18:30:54 2024
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Wed, 28 Aug 2024 14:30:54 -0400
Subject: [squid-users] Unable to access internal resources via hostname
In-Reply-To: <947309fa-d1fc-4a75-ac49-ea7bc5c5ff12@measurement-factory.com>
References: <405705ce244447aca1b15385a171fada@hexcel.com>
 <Zs84drvoIpZ1f6DR@fantomas.sk> <58bdfaada3fa46d0938b7346ec04c336@hexcel.com>
 <947309fa-d1fc-4a75-ac49-ea7bc5c5ff12@measurement-factory.com>
Message-ID: <faffca37-fa59-46ff-80e4-245c37fa90b9@measurement-factory.com>

On 2024-08-28 14:18, Alex Rousskov wrote:
> On 2024-08-28 11:24, Piana, Josh wrote:
> 
>> Here's the log and (I think) relevant ACL's?
> 
> According to your access.log, Squid denies problematic CONNECT requests 
> with HTTP 407 errors responses. Usually, that means those requests match 
> an "http_access deny" rule. Clearly, you expect an "allow" outcome 
> instead, but it is difficult (for me) to figure out where your 
> expectations mismatch reality; there are no rules that explicitly 
> mention hexcelssp domain, for example: Which "http_access allow" rule do 
> you expect those denied requests to match?

Sorry, I probably misinterpreted those access.log records: It looks like 
the denied (TCP_DENIED/407) access is something you actually expect 
because you want that test request to be authenticated. The client 
supplies the necessary credentials in the second request, and then that 
second request fails with a (rather generic) HTTP 500 error code, 
without contacting the origin server.

I am guessing that you are concerned about that second 
request/transaction rather than the first one.

Squid generates HTTP 500 errors for a variety of different reasons. Are 
there any messages in cache.log (at default debugging level) that 
correspond to these failing test transactions? If there are none, please 
add %err_code/%err_detail to your access_log logformat so that Squid 
logs more information about the problem to access.log (see logformat and 
access_log directives in squid.conf.documented for details).


Thank you,

Alex.



> Also, does mgr:ipcache cache manager query confirm that Squid has read 
> your /etc/hosts file and cached the record you expect it to use?
> 
> Alex.
> 
> 
>> -----------------------------------------------------------------------------------------------------------
>> # /var/log/squid/access.log results for internal conflicts
>>
>> 28/Aug/2024:10:57:17 -0400.234 10.46.49.190 TCP_DENIED/407 4132 
>> CONNECT hexcelssp:443 - HIER_NONE/- text/html
>> 28/Aug/2024:10:57:17 -0400.253 10.46.49.190 NONE_NONE/500 0 CONNECT 
>> hexcelssp:443 JPIANA at AD.<DOMAIN>.COM HIER_NONE/- -
>> 28/Aug/2024:10:57:17 -0400.380 10.46.49.190 TCP_DENIED/407 4132 
>> CONNECT hexcelssp:443 - HIER_NONE/- text/html
>> 28/Aug/2024:10:57:17 -0400.399 10.46.49.190 NONE_NONE/500 0 CONNECT 
>> hexcelssp:443 JPIANA at AD.<DOMAIN>.COM HIER_NONE/- -
>> -----------------------------------------------------------------------------------------------------------
>>
>> # acl all src all
>>
>> acl src_self src 127.0.0.0/8
>> acl src_self src 10.46.11.69
>>
>> acl dst_self dst 127.0.0.0/8
>> acl dst_self dst 10.46.11.69
>>
>> acl from_arc src 10.46.0.0/15
>>
>> acl local_dst_addr dst 10.0.0.0/8
>> acl local_dst_addr dst 172.0.0.0/8
>> acl local_dst_addr dst bldg3.<domain>.com
>> acl local_dst_addr dst bldg5.<domain>.com
>>
>> # these keep URLs of popular local servers from being forwarded
>> acl local_dst_dom dstdomain arcgate
>>
>> # allow connects to local destinations without authentication
>> # by domain name from URL
>> http_access?????? allow local_dst_dom
>> http_reply_access allow local_dst_dom
>>
>> # by IP address name resolves to
>> http_access?????? allow local_dst_addr
>> http_reply_access allow local_dst_addr
>>
>> # allow trusted hosts without authentication
>> # these are just ip's on the 10.46.11.x network
>> acl authless_src src "/etc/squid/authless_src"
>> http_access?????? allow authless_src
>> http_reply_access allow authless_src
>> -----------------------------------------------------------------------------------------------------------
>>
>> -----Original Message-----
>> From: squid-users <squid-users-bounces at lists.squid-cache.org> On 
>> Behalf Of Matus UHLAR - fantomas
>> Sent: Wednesday, August 28, 2024 10:47 AM
>> To: squid-users at lists.squid-cache.org
>> Subject: Re: [squid-users] Unable to access internal resources via 
>> hostname
>>
>> Caution: This email originated from outside of Hexcel. Do not click 
>> links or open attachments unless you recognize the sender and know the 
>> content is safe.
>>
>>
>> On 28.08.24 14:20, Piana, Josh wrote:
>>> Hello Squid Support,
>>
>> This squid user forum FYI
>>
>>> We are unable to get to internal resources via hostname but using the
>>> IP address works fine.? Immediately, I thought this was DNS but when I
>>> checked the /etc/resolv.conf/ file it was pointing correctly to our
>>> Windows DNS server and we can ping all devices using their hostname,
>>> just not when browsing to it.? This leads me to believe something may
>>> be wrong with our squid config.
>>
>> hard to guess without seeing logs or ACL's.
>>
>>
>> -- 
>> Matus UHLAR - fantomas, uhlar at fantomas.sk ; http://www.fantomas.sk/
>> Warning: I wish NOT to receive e-mail advertising to this address.
>> Varovanie: na tuto adresu chcem NEDOSTAVAT akukolvek reklamnu postu.
>> It's now safe to throw off your computer.
>> _______________________________________________
>> squid-users mailing list
>> squid-users at lists.squid-cache.org
>> https://lists.squid-cache.org/listinfo/squid-users
>> _______________________________________________
>> squid-users mailing list
>> squid-users at lists.squid-cache.org
>> https://lists.squid-cache.org/listinfo/squid-users
> 
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> https://lists.squid-cache.org/listinfo/squid-users



From Josh.Piana at hexcel.com  Wed Aug 28 19:25:52 2024
From: Josh.Piana at hexcel.com (Piana, Josh)
Date: Wed, 28 Aug 2024 19:25:52 +0000
Subject: [squid-users] Unable to access internal resources via hostname
In-Reply-To: <faffca37-fa59-46ff-80e4-245c37fa90b9@measurement-factory.com>
References: <405705ce244447aca1b15385a171fada@hexcel.com>
 <Zs84drvoIpZ1f6DR@fantomas.sk> <58bdfaada3fa46d0938b7346ec04c336@hexcel.com>
 <947309fa-d1fc-4a75-ac49-ea7bc5c5ff12@measurement-factory.com>
 <faffca37-fa59-46ff-80e4-245c37fa90b9@measurement-factory.com>
Message-ID: <c00942c1c8ab46b5b393d70f32346798@hexcel.com>

Alex, 

Thank you for your response! 

Unfortunately, this squid.conf I'm using was put together by one of our technicians that actually knew Linux and was staffed here at this location for nearly 20 years. 

He ran this off of a CentOS box using Squid 2.5 - and it was woefully out of date as you can imagine. I now understand that Squid 5.5, while newer, is actually out of date as well. I regret installing and working off of this because I jused assumed the "yum" install command for the Squid distro would give me the most recent, known-good, software. That's completely on me. From how I understand it, his intentions for internal users accessing internal resources, would skip authentication altogether. 

Here's a small piece, with his notes included, of why I think that. 

------------------------------------------------------------------------------------------------------------------------
# ----------------------------------------------------------------------------
# allow without authentication
# these rules allow certain connects without user authentication
# these allow any protocol/method/etc

#                 ***** IMPORTANT *****
# Adding to these lists also exempts from all content filtering.
# In particular, executables will be allowed to download!
#                 ***** IMPORTANT *****

# allow connects to local destinations without authentication
# by domain name from URL
http_access       allow local_dst_dom
http_reply_access allow local_dst_dom

# by IP address name resolves to
http_access       allow local_dst_addr
http_reply_access allow local_dst_addr
------------------------------------------------------------------------------------------------------------------------

The "http_access allow local_dst_dom" and the following reply statement seems to point toward his intentions when writing this. 

The only thing in the old config this was referencing was this, and to me, it doesn't make sense: 
# acl local_dst_dom dstdomain arcgate

It's worth noting that despite how awkward this seems, it DOES work. On the old web proxy we're currently still running live. 

I've gone as far as swapping out just the authentication settings and keeping the entire old config, but it still doesn't work. 
I've setup a realmd/sssd/kerberos backend instead of Samba/Windbind that the old server uses.

To state the issue we're having again - internal resources connecting to other internal resources fails via hostname, but works when using IP. I was able to troubleshoot and conclude DNS was not the issue, as all other aspects are working as intended and they certainly do use DNS. Also pings resolve using hostname from the new squidbox so that implies that DNS is working as expected. 

Ultimately, here's what I think we want, please feel free to poke holes in it: 
Allow clients who are accessing other internal rersources to be able to browse to it using its hostname, without needing authentication first.

 
I do intend on adding those parameters you mentioned to the logs so I can get better details within. I also need to look into how to use the debugging features, I'm not familiar with it at all.  

I apologize for the wall of text, looking forward to what you guys have to say about this.

Thanks, 
Josh

-----Original Message-----
From: squid-users <squid-users-bounces at lists.squid-cache.org> On Behalf Of Alex Rousskov
Sent: Wednesday, August 28, 2024 2:31 PM
To: squid-users at lists.squid-cache.org
Subject: Re: [squid-users] Unable to access internal resources via hostname

Caution: This email originated from outside of Hexcel. Do not click links or open attachments unless you recognize the sender and know the content is safe.


On 2024-08-28 14:18, Alex Rousskov wrote:
> On 2024-08-28 11:24, Piana, Josh wrote:
>
>> Here's the log and (I think) relevant ACL's?
>
> According to your access.log, Squid denies problematic CONNECT 
> requests with HTTP 407 errors responses. Usually, that means those 
> requests match an "http_access deny" rule. Clearly, you expect an 
> "allow" outcome instead, but it is difficult (for me) to figure out 
> where your expectations mismatch reality; there are no rules that 
> explicitly mention hexcelssp domain, for example: Which "http_access 
> allow" rule do you expect those denied requests to match?

Sorry, I probably misinterpreted those access.log records: It looks like the denied (TCP_DENIED/407) access is something you actually expect because you want that test request to be authenticated. The client supplies the necessary credentials in the second request, and then that second request fails with a (rather generic) HTTP 500 error code, without contacting the origin server.

I am guessing that you are concerned about that second request/transaction rather than the first one.

Squid generates HTTP 500 errors for a variety of different reasons. Are there any messages in cache.log (at default debugging level) that correspond to these failing test transactions? If there are none, please add %err_code/%err_detail to your access_log logformat so that Squid logs more information about the problem to access.log (see logformat and access_log directives in squid.conf.documented for details).


Thank you,

Alex.



> Also, does mgr:ipcache cache manager query confirm that Squid has read 
> your /etc/hosts file and cached the record you expect it to use?
>
> Alex.
>
>
>> ---------------------------------------------------------------------
>> --------------------------------------
>> # /var/log/squid/access.log results for internal conflicts
>>
>> 28/Aug/2024:10:57:17 -0400.234 10.46.49.190 TCP_DENIED/407 4132 
>> CONNECT hexcelssp:443 - HIER_NONE/- text/html
>> 28/Aug/2024:10:57:17 -0400.253 10.46.49.190 NONE_NONE/500 0 CONNECT
>> hexcelssp:443 JPIANA at AD.<DOMAIN>.COM HIER_NONE/- -
>> 28/Aug/2024:10:57:17 -0400.380 10.46.49.190 TCP_DENIED/407 4132 
>> CONNECT hexcelssp:443 - HIER_NONE/- text/html
>> 28/Aug/2024:10:57:17 -0400.399 10.46.49.190 NONE_NONE/500 0 CONNECT
>> hexcelssp:443 JPIANA at AD.<DOMAIN>.COM HIER_NONE/- -
>> ---------------------------------------------------------------------
>> --------------------------------------
>>
>> # acl all src all
>>
>> acl src_self src 127.0.0.0/8
>> acl src_self src 10.46.11.69
>>
>> acl dst_self dst 127.0.0.0/8
>> acl dst_self dst 10.46.11.69
>>
>> acl from_arc src 10.46.0.0/15
>>
>> acl local_dst_addr dst 10.0.0.0/8
>> acl local_dst_addr dst 172.0.0.0/8
>> acl local_dst_addr dst bldg3.<domain>.com acl local_dst_addr dst 
>> bldg5.<domain>.com
>>
>> # these keep URLs of popular local servers from being forwarded acl 
>> local_dst_dom dstdomain arcgate
>>
>> # allow connects to local destinations without authentication # by 
>> domain name from URL
>> http_access       allow local_dst_dom
>> http_reply_access allow local_dst_dom
>>
>> # by IP address name resolves to
>> http_access       allow local_dst_addr
>> http_reply_access allow local_dst_addr
>>
>> # allow trusted hosts without authentication # these are just ip's on 
>> the 10.46.11.x network acl authless_src src "/etc/squid/authless_src"
>> http_access       allow authless_src
>> http_reply_access allow authless_src
>> ---------------------------------------------------------------------
>> --------------------------------------
>>
>> -----Original Message-----
>> From: squid-users <squid-users-bounces at lists.squid-cache.org> On 
>> Behalf Of Matus UHLAR - fantomas
>> Sent: Wednesday, August 28, 2024 10:47 AM
>> To: squid-users at lists.squid-cache.org
>> Subject: Re: [squid-users] Unable to access internal resources via 
>> hostname
>>
>> Caution: This email originated from outside of Hexcel. Do not click 
>> links or open attachments unless you recognize the sender and know 
>> the content is safe.
>>
>>
>> On 28.08.24 14:20, Piana, Josh wrote:
>>> Hello Squid Support,
>>
>> This squid user forum FYI
>>
>>> We are unable to get to internal resources via hostname but using 
>>> the IP address works fine.  Immediately, I thought this was DNS but 
>>> when I checked the /etc/resolv.conf/ file it was pointing correctly 
>>> to our Windows DNS server and we can ping all devices using their 
>>> hostname, just not when browsing to it.  This leads me to believe 
>>> something may be wrong with our squid config.
>>
>> hard to guess without seeing logs or ACL's.
>>
>>
>> --
>> Matus UHLAR - fantomas, uhlar at fantomas.sk ; 
>> http://www/.
>> fantomas.sk%2F&data=05%7C02%7Cjosh.piana%40hexcel.com%7C2db72264caa04
>> f1fd80d08dcc78f9245%7C4248050df19546d5ac9c0c7c52b04cae%7C0%7C0%7C6386
>> 04666668859787%7CUnknown%7CTWFpbGZsb3d8eyJWIjoiMC4wLjAwMDAiLCJQIjoiV2
>> luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C0%7C%7C%7C&sdata=Z7cUEdNvInDAJ
>> PwgQJhXWSK3H2mkAPe4CNcfYJFyy6M%3D&reserved=0
>> Warning: I wish NOT to receive e-mail advertising to this address.
>> Varovanie: na tuto adresu chcem NEDOSTAVAT akukolvek reklamnu postu.
>> It's now safe to throw off your computer.
>> _______________________________________________
>> squid-users mailing list
>> squid-users at lists.squid-cache.org
>> https://lis/
>> ts.squid-cache.org%2Flistinfo%2Fsquid-users&data=05%7C02%7Cjosh.piana
>> %40hexcel.com%7C2db72264caa04f1fd80d08dcc78f9245%7C4248050df19546d5ac
>> 9c0c7c52b04cae%7C0%7C0%7C638604666674016161%7CUnknown%7CTWFpbGZsb3d8e
>> yJWIjoiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C0
>> %7C%7C%7C&sdata=%2B%2B7inZxg2LEmB2KFVWmtn64FG8SwHpEZeEyAjhNClnU%3D&re
>> served=0 _______________________________________________
>> squid-users mailing list
>> squid-users at lists.squid-cache.org
>> https://lis/
>> ts.squid-cache.org%2Flistinfo%2Fsquid-users&data=05%7C02%7Cjosh.piana
>> %40hexcel.com%7C2db72264caa04f1fd80d08dcc78f9245%7C4248050df19546d5ac
>> 9c0c7c52b04cae%7C0%7C0%7C638604666674016161%7CUnknown%7CTWFpbGZsb3d8e
>> yJWIjoiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C0
>> %7C%7C%7C&sdata=%2B%2B7inZxg2LEmB2KFVWmtn64FG8SwHpEZeEyAjhNClnU%3D&re
>> served=0
>
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> https://list/
> s.squid-cache.org%2Flistinfo%2Fsquid-users&data=05%7C02%7Cjosh.piana%4
> 0hexcel.com%7C2db72264caa04f1fd80d08dcc78f9245%7C4248050df19546d5ac9c0
> c7c52b04cae%7C0%7C0%7C638604666674016161%7CUnknown%7CTWFpbGZsb3d8eyJWI
> joiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C0%7C%7
> C%7C&sdata=%2B%2B7inZxg2LEmB2KFVWmtn64FG8SwHpEZeEyAjhNClnU%3D&reserved
> =0

_______________________________________________
squid-users mailing list
squid-users at lists.squid-cache.org
https://lists.squid-cache.org/listinfo/squid-users

From uhlar at fantomas.sk  Wed Aug 28 19:35:50 2024
From: uhlar at fantomas.sk (Matus UHLAR - fantomas)
Date: Wed, 28 Aug 2024 21:35:50 +0200
Subject: [squid-users] Unable to access internal resources via hostname
In-Reply-To: <58bdfaada3fa46d0938b7346ec04c336@hexcel.com>
References: <405705ce244447aca1b15385a171fada@hexcel.com>
 <Zs84drvoIpZ1f6DR@fantomas.sk>
 <58bdfaada3fa46d0938b7346ec04c336@hexcel.com>
Message-ID: <Zs98Fg6uCgOH3c0r@fantomas.sk>

>> We are unable to get to internal resources via hostname but using the
>> IP address works fine.  Immediately, I thought this was DNS but when I
>> checked the /etc/resolv.conf/ file it was pointing correctly to our
>> Windows DNS server and we can ping all devices using their hostname,
>> just not when browsing to it.  This leads me to believe something may
>> be wrong with our squid config.
>
>hard to guess without seeing logs or ACL's.

On 28.08.24 15:24, Piana, Josh wrote:
>Here's the log and (I think) relevant ACL's?
>-----------------------------------------------------------------------------------------------------------
># /var/log/squid/access.log results for internal conflicts
>
>28/Aug/2024:10:57:17 -0400.234 10.46.49.190 TCP_DENIED/407 4132 CONNECT hexcelssp:443 - HIER_NONE/- text/html
>28/Aug/2024:10:57:17 -0400.253 10.46.49.190 NONE_NONE/500 0 CONNECT hexcelssp:443 JPIANA at AD.<DOMAIN>.COM HIER_NONE/- -
>28/Aug/2024:10:57:17 -0400.380 10.46.49.190 TCP_DENIED/407 4132 CONNECT hexcelssp:443 - HIER_NONE/- text/html
>28/Aug/2024:10:57:17 -0400.399 10.46.49.190 NONE_NONE/500 0 CONNECT hexcelssp:443 JPIANA at AD.<DOMAIN>.COM HIER_NONE/- -
>-----------------------------------------------------------------------------------------------------------

[...]
>acl from_arc src 10.46.0.0/15
[...]
>acl local_dst_addr dst bldg3.<domain>.com
>acl local_dst_addr dst bldg5.<domain>.com

Are you aware that these get translated to IP addresses? 
If you want to use domain names as provided by client, use "dstdomain".

># these keep URLs of popular local servers from being forwarded
>acl local_dst_dom dstdomain arcgate

...just like this.

># allow connects to local destinations without authentication
># by domain name from URL
>http_access       allow local_dst_dom
>http_reply_access allow local_dst_dom

http_reply_access is usually not needed, unless you want control what 
clients get only after the content is known to squid, which generally 
applies to e.g.  mime types.

If you don't do that, better comment out "http_reply_access" lines.

># allow trusted hosts without authentication
># these are just ip's on the 10.46.11.x network
>acl authless_src src "/etc/squid/authless_src"
>http_access       allow authless_src
>http_reply_access allow authless_src

I don't see any http_access "deny" line.
Also, I don't see any "http_access allow from_arc"
or any other line that should allow CONNECT from 10.46.49.190  to "hexcelssp"


-- 
Matus UHLAR - fantomas, uhlar at fantomas.sk ; http://www.fantomas.sk/
Warning: I wish NOT to receive e-mail advertising to this address.
Varovanie: na tuto adresu chcem NEDOSTAVAT akukolvek reklamnu postu.
LSD will make your ECS screen display 16.7 million colors


From rousskov at measurement-factory.com  Wed Aug 28 20:01:23 2024
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Wed, 28 Aug 2024 16:01:23 -0400
Subject: [squid-users] Unable to access internal resources via hostname
In-Reply-To: <c00942c1c8ab46b5b393d70f32346798@hexcel.com>
References: <405705ce244447aca1b15385a171fada@hexcel.com>
 <Zs84drvoIpZ1f6DR@fantomas.sk> <58bdfaada3fa46d0938b7346ec04c336@hexcel.com>
 <947309fa-d1fc-4a75-ac49-ea7bc5c5ff12@measurement-factory.com>
 <faffca37-fa59-46ff-80e4-245c37fa90b9@measurement-factory.com>
 <c00942c1c8ab46b5b393d70f32346798@hexcel.com>
Message-ID: <59274673-47e9-431d-ad45-7fa3a5a8ebca@measurement-factory.com>

On 2024-08-28 15:25, Piana, Josh wrote:

> I now understand that Squid 5.5 ... is actually out of date as well.
> I regret installing and working off of this because I jused assumed
> the "yum" install command for the Squid distro would give me the most
> recent, known-good, software. That's completely on me.

Whether yum install installs something production-worthy today is 
between you and your Linux distro. Squid Project volunteers, including 
me, do no control what distribution you pick and what that distribution 
ships. The reason I mentioned v5 support status is to avoid creating a 
false impression that there are no _other_ (i.e. unreported by you on 
this thread) problems you may want to know about and to lower your 
expectations from the level of support you may get from Squid Project 
volunteers like me.

Said that, I doubt the problem you are trying to solve is v5-specific. 
You may get better diagnostics if you run v6+, and you may receive fewer 
unusable (with v5) instructions if you run v6+, but the problem is 
likely to be present in a v6-based setup as well.


> From how I understand it, his intentions for internal users accessing
> internal resources, would skip authentication altogether.

I assume that the problematic test that you want to fix is done using 
"internal users". You have already stated that the test is accessing 
"internal resources". Yet, we see that Squid asks the test client to 
authenticate (TCP_DENIED/407). Thus,

* either local_dst_dom, local_dst_addr, and authless_src ACLs do not 
match test client transactions

* or there is an authentication-triggering directive (e.g., "http_access 
deny block_user") located above a matching "http_access allow" rule that 
uses one of those ACLs three.

Ideally, we should figure out which http_access rule matches the 
problematic transaction and triage from there. Unfortunately, Squid does 
not make that basic task easy. The best option I can think of is for you 
to share (privately if needed to avoid publishing sensitive info) a 
pointer to compressed cache.log file collected while reproducing the 
problem using a single test transaction after setting debug_options to 
ALL,9. Squid FAQ has a few hints about collecting relevant info: 
https://wiki.squid-cache.org/SquidFaq/BugReporting#debugging-a-single-transaction

This "unexpected authentication" mystery may not be directly related to 
the "HTTP 500 error responses" mystery we discussed earlier, but it may 
help to fix authentication first.


HTH,

Alex.


> Here's a small piece, with his notes included, of why I think that.
> 
> ------------------------------------------------------------------------------------------------------------------------
> # ----------------------------------------------------------------------------
> # allow without authentication
> # these rules allow certain connects without user authentication
> # these allow any protocol/method/etc
> 
> #                 ***** IMPORTANT *****
> # Adding to these lists also exempts from all content filtering.
> # In particular, executables will be allowed to download!
> #                 ***** IMPORTANT *****
> 
> # allow connects to local destinations without authentication
> # by domain name from URL
> http_access       allow local_dst_dom
> http_reply_access allow local_dst_dom
> 
> # by IP address name resolves to
> http_access       allow local_dst_addr
> http_reply_access allow local_dst_addr
> ------------------------------------------------------------------------------------------------------------------------
> 
> The "http_access allow local_dst_dom" and the following reply statement seems to point toward his intentions when writing this.
> 
> The only thing in the old config this was referencing was this, and to me, it doesn't make sense:
> # acl local_dst_dom dstdomain arcgate
> 
> It's worth noting that despite how awkward this seems, it DOES work. On the old web proxy we're currently still running live.
> 
> I've gone as far as swapping out just the authentication settings and keeping the entire old config, but it still doesn't work.
> I've setup a realmd/sssd/kerberos backend instead of Samba/Windbind that the old server uses.
> 
> To state the issue we're having again - internal resources connecting to other internal resources fails via hostname, but works when using IP. I was able to troubleshoot and conclude DNS was not the issue, as all other aspects are working as intended and they certainly do use DNS. Also pings resolve using hostname from the new squidbox so that implies that DNS is working as expected.
> 
> Ultimately, here's what I think we want, please feel free to poke holes in it:
> Allow clients who are accessing other internal rersources to be able to browse to it using its hostname, without needing authentication first.
> 
>   
> I do intend on adding those parameters you mentioned to the logs so I can get better details within. I also need to look into how to use the debugging features, I'm not familiar with it at all.
> 
> I apologize for the wall of text, looking forward to what you guys have to say about this.
> 
> Thanks,
> Josh
> 
> -----Original Message-----
> From: squid-users <squid-users-bounces at lists.squid-cache.org> On Behalf Of Alex Rousskov
> Sent: Wednesday, August 28, 2024 2:31 PM
> To: squid-users at lists.squid-cache.org
> Subject: Re: [squid-users] Unable to access internal resources via hostname
> 
> Caution: This email originated from outside of Hexcel. Do not click links or open attachments unless you recognize the sender and know the content is safe.
> 
> 
> On 2024-08-28 14:18, Alex Rousskov wrote:
>> On 2024-08-28 11:24, Piana, Josh wrote:
>>
>>> Here's the log and (I think) relevant ACL's?
>>
>> According to your access.log, Squid denies problematic CONNECT
>> requests with HTTP 407 errors responses. Usually, that means those
>> requests match an "http_access deny" rule. Clearly, you expect an
>> "allow" outcome instead, but it is difficult (for me) to figure out
>> where your expectations mismatch reality; there are no rules that
>> explicitly mention hexcelssp domain, for example: Which "http_access
>> allow" rule do you expect those denied requests to match?
> 
> Sorry, I probably misinterpreted those access.log records: It looks like the denied (TCP_DENIED/407) access is something you actually expect because you want that test request to be authenticated. The client supplies the necessary credentials in the second request, and then that second request fails with a (rather generic) HTTP 500 error code, without contacting the origin server.
> 
> I am guessing that you are concerned about that second request/transaction rather than the first one.
> 
> Squid generates HTTP 500 errors for a variety of different reasons. Are there any messages in cache.log (at default debugging level) that correspond to these failing test transactions? If there are none, please add %err_code/%err_detail to your access_log logformat so that Squid logs more information about the problem to access.log (see logformat and access_log directives in squid.conf.documented for details).
> 
> 
> Thank you,
> 
> Alex.
> 
> 
> 
>> Also, does mgr:ipcache cache manager query confirm that Squid has read
>> your /etc/hosts file and cached the record you expect it to use?
>>
>> Alex.
>>
>>
>>> ---------------------------------------------------------------------
>>> --------------------------------------
>>> # /var/log/squid/access.log results for internal conflicts
>>>
>>> 28/Aug/2024:10:57:17 -0400.234 10.46.49.190 TCP_DENIED/407 4132
>>> CONNECT hexcelssp:443 - HIER_NONE/- text/html
>>> 28/Aug/2024:10:57:17 -0400.253 10.46.49.190 NONE_NONE/500 0 CONNECT
>>> hexcelssp:443 JPIANA at AD.<DOMAIN>.COM HIER_NONE/- -
>>> 28/Aug/2024:10:57:17 -0400.380 10.46.49.190 TCP_DENIED/407 4132
>>> CONNECT hexcelssp:443 - HIER_NONE/- text/html
>>> 28/Aug/2024:10:57:17 -0400.399 10.46.49.190 NONE_NONE/500 0 CONNECT
>>> hexcelssp:443 JPIANA at AD.<DOMAIN>.COM HIER_NONE/- -
>>> ---------------------------------------------------------------------
>>> --------------------------------------
>>>
>>> # acl all src all
>>>
>>> acl src_self src 127.0.0.0/8
>>> acl src_self src 10.46.11.69
>>>
>>> acl dst_self dst 127.0.0.0/8
>>> acl dst_self dst 10.46.11.69
>>>
>>> acl from_arc src 10.46.0.0/15
>>>
>>> acl local_dst_addr dst 10.0.0.0/8
>>> acl local_dst_addr dst 172.0.0.0/8
>>> acl local_dst_addr dst bldg3.<domain>.com acl local_dst_addr dst
>>> bldg5.<domain>.com
>>>
>>> # these keep URLs of popular local servers from being forwarded acl
>>> local_dst_dom dstdomain arcgate
>>>
>>> # allow connects to local destinations without authentication # by
>>> domain name from URL
>>> http_access       allow local_dst_dom
>>> http_reply_access allow local_dst_dom
>>>
>>> # by IP address name resolves to
>>> http_access       allow local_dst_addr
>>> http_reply_access allow local_dst_addr
>>>
>>> # allow trusted hosts without authentication # these are just ip's on
>>> the 10.46.11.x network acl authless_src src "/etc/squid/authless_src"
>>> http_access       allow authless_src
>>> http_reply_access allow authless_src
>>> ---------------------------------------------------------------------
>>> --------------------------------------
>>>
>>> -----Original Message-----
>>> From: squid-users <squid-users-bounces at lists.squid-cache.org> On
>>> Behalf Of Matus UHLAR - fantomas
>>> Sent: Wednesday, August 28, 2024 10:47 AM
>>> To: squid-users at lists.squid-cache.org
>>> Subject: Re: [squid-users] Unable to access internal resources via
>>> hostname
>>>
>>> Caution: This email originated from outside of Hexcel. Do not click
>>> links or open attachments unless you recognize the sender and know
>>> the content is safe.
>>>
>>>
>>> On 28.08.24 14:20, Piana, Josh wrote:
>>>> Hello Squid Support,
>>>
>>> This squid user forum FYI
>>>
>>>> We are unable to get to internal resources via hostname but using
>>>> the IP address works fine.  Immediately, I thought this was DNS but
>>>> when I checked the /etc/resolv.conf/ file it was pointing correctly
>>>> to our Windows DNS server and we can ping all devices using their
>>>> hostname, just not when browsing to it.  This leads me to believe
>>>> something may be wrong with our squid config.
>>>
>>> hard to guess without seeing logs or ACL's.
>>>
>>>
>>> --
>>> Matus UHLAR - fantomas, uhlar at fantomas.sk ;
>>> http://www/.
>>> fantomas.sk%2F&data=05%7C02%7Cjosh.piana%40hexcel.com%7C2db72264caa04
>>> f1fd80d08dcc78f9245%7C4248050df19546d5ac9c0c7c52b04cae%7C0%7C0%7C6386
>>> 04666668859787%7CUnknown%7CTWFpbGZsb3d8eyJWIjoiMC4wLjAwMDAiLCJQIjoiV2
>>> luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C0%7C%7C%7C&sdata=Z7cUEdNvInDAJ
>>> PwgQJhXWSK3H2mkAPe4CNcfYJFyy6M%3D&reserved=0
>>> Warning: I wish NOT to receive e-mail advertising to this address.
>>> Varovanie: na tuto adresu chcem NEDOSTAVAT akukolvek reklamnu postu.
>>> It's now safe to throw off your computer.
>>> _______________________________________________
>>> squid-users mailing list
>>> squid-users at lists.squid-cache.org
>>> https://lis/
>>> ts.squid-cache.org%2Flistinfo%2Fsquid-users&data=05%7C02%7Cjosh.piana
>>> %40hexcel.com%7C2db72264caa04f1fd80d08dcc78f9245%7C4248050df19546d5ac
>>> 9c0c7c52b04cae%7C0%7C0%7C638604666674016161%7CUnknown%7CTWFpbGZsb3d8e
>>> yJWIjoiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C0
>>> %7C%7C%7C&sdata=%2B%2B7inZxg2LEmB2KFVWmtn64FG8SwHpEZeEyAjhNClnU%3D&re
>>> served=0 _______________________________________________
>>> squid-users mailing list
>>> squid-users at lists.squid-cache.org
>>> https://lis/
>>> ts.squid-cache.org%2Flistinfo%2Fsquid-users&data=05%7C02%7Cjosh.piana
>>> %40hexcel.com%7C2db72264caa04f1fd80d08dcc78f9245%7C4248050df19546d5ac
>>> 9c0c7c52b04cae%7C0%7C0%7C638604666674016161%7CUnknown%7CTWFpbGZsb3d8e
>>> yJWIjoiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C0
>>> %7C%7C%7C&sdata=%2B%2B7inZxg2LEmB2KFVWmtn64FG8SwHpEZeEyAjhNClnU%3D&re
>>> served=0
>>
>> _______________________________________________
>> squid-users mailing list
>> squid-users at lists.squid-cache.org
>> https://list/
>> s.squid-cache.org%2Flistinfo%2Fsquid-users&data=05%7C02%7Cjosh.piana%4
>> 0hexcel.com%7C2db72264caa04f1fd80d08dcc78f9245%7C4248050df19546d5ac9c0
>> c7c52b04cae%7C0%7C0%7C638604666674016161%7CUnknown%7CTWFpbGZsb3d8eyJWI
>> joiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C0%7C%7
>> C%7C&sdata=%2B%2B7inZxg2LEmB2KFVWmtn64FG8SwHpEZeEyAjhNClnU%3D&reserved
>> =0
> 
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> https://lists.squid-cache.org/listinfo/squid-users
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> https://lists.squid-cache.org/listinfo/squid-users



From Josh.Piana at hexcel.com  Thu Aug 29 14:34:23 2024
From: Josh.Piana at hexcel.com (Piana, Josh)
Date: Thu, 29 Aug 2024 14:34:23 +0000
Subject: [squid-users] Unable to access internal resources via hostname
In-Reply-To: <59274673-47e9-431d-ad45-7fa3a5a8ebca@measurement-factory.com>
References: <405705ce244447aca1b15385a171fada@hexcel.com>
 <Zs84drvoIpZ1f6DR@fantomas.sk> <58bdfaada3fa46d0938b7346ec04c336@hexcel.com>
 <947309fa-d1fc-4a75-ac49-ea7bc5c5ff12@measurement-factory.com>
 <faffca37-fa59-46ff-80e4-245c37fa90b9@measurement-factory.com>
 <c00942c1c8ab46b5b393d70f32346798@hexcel.com>
 <59274673-47e9-431d-ad45-7fa3a5a8ebca@measurement-factory.com>
Message-ID: <d063bef52efd4e32a9f9bb27f934e673@hexcel.com>

Good morning Alex, 

I've added the following to my squid.conf file
# logformat custom %err_code/%err_detail
# access_log daemon:/var/log/squid/access,log custom

I've also enabled debugging options:
# debug_options ALL,9

I've also cleaned up our ACL's to better reflect what is going on: 
# acl src_self src 127.0.0.0/8
# acl src_self src 10.46.11.69
# acl dst_self dst 127.0.0.0/8
# acl dst_self dst 10.46.11.69

# acl from_arc src 10.46.0.0/15

# acl local_dst_addr dst 10.0.0.0/8
# acl local_dst_addr dst 172.0.0.0/8

When accessing internal devices via IP, it works. 
I think this is because of this ACL:
# http_access           allow local_dst_addr
# http_reply_access     allow local_dst_addr

But when I access those same internal devices via hostname, it fails. 
I'm using this ACL, which I just created a separate file for:
acl local_dst_dom dstdomain "etc/squid/local_dst_dom"
http_access       allow local_dst_dom
http_reply_access allow local_dst_dom

I added an ACL file because I figure it will be more extensive than the more simple IP range ACL's. 
I've added a few local websites to the "local_dst_dom" list, but I'm unable to get this to resolve without using IP.  

For instance: "https://hexcelssp/" is the name of one of our internal websites for our company. 
This doesn't load under our current config but "https://10.96.14.174/" DOES load. 

I've added "hexnt2067" as well, which you can see me testing in the below logs.  
Again, this DOES work with its IP, 10.96.102.67. 

I'm not getting a proxy error message when I try to browse to that URL though, we just can't reach it. 
	
Here's the log results after enabling debugging and better log features: 

29/Aug/2024:10:25:33 -0400.380 10.46.49.190 TCP_DENIED/407 4132 CONNECT hexcelssp:443 - HIER_NONE/- text/html
29/Aug/2024:10:25:33 -0400.515 10.46.49.190 NONE_NONE/500 0 CONNECT hexcelssp:443 JPIANA at AD.<DOMAIN>.COM HIER_NONE/- -
29/Aug/2024:10:25:39 -0400.799 10.46.49.190 TCP_TUNNEL/200 11716 CONNECT contile.services.mozilla.com:443 JPIANA at AD.<DOMAIN>.COM HIER_DIRECT/34.117.188.166 -
29/Aug/2024:10:26:05 -0400.507 10.46.49.190 TCP_DENIED/407 4474 GET http://hexnt2067/sites/it/help/SitePages/Home.aspx - HIER_NONE/- text/html
29/Aug/2024:10:26:05 -0400.646 10.46.49.190 TCP_MISS/500 8320 GET http://hexnt2067/sites/it/help/SitePages/Home.aspx JPIANA at AD.<DOMAIN>.COM HIER_NONE/- text/html
29/Aug/2024:10:26:05 -0400.735 10.46.49.190 TCP_DENIED/403 4440 GET http://arcgate2.ad/.<domain>.com:8080/squid-internal-static/icons/SN.png - HIER_NONE/- text/html
29/Aug/2024:10:26:05 -0400.779 10.46.49.190 TCP_MISS_ABORTED/500 0 GET http://hexnt2067/favicon.ico JPIANA at AD.<DOMAIN>.COM HIER_NONE/- text/html
29/Aug/2024:10:27:13 -0400.036 10.46.49.190 TCP_DENIED/407 4474 GET http://hexnt2067/sites/it/help/SitePages/Home.aspx - HIER_NONE/- text/html
29/Aug/2024:10:27:13 -0400.227 10.46.49.190 TCP_MISS/500 8334 GET http://hexnt2067/sites/it/help/SitePages/Home.aspx JPIANA at AD.<DOMAIN>.COM HIER_NONE/- text/html
29/Aug/2024:10:27:13 -0400.302 10.46.49.190 TCP_DENIED/403 4440 GET http://arcgate2.ad/.<domain>.com:8080/squid-internal-static/icons/SN.png - HIER_NONE/- text/html
29/Aug/2024:10:27:17 -0400.376 10.46.49.190 TCP_DENIED/407 4132 CONNECT hexcelssp:443 - HIER_NONE/- text/html
29/Aug/2024:10:27:17 -0400.514 10.46.49.190 NONE_NONE/500 0 CONNECT hexcelssp:443 JPIANA at AD.<DOMAIN>.COM HIER_NONE/- -

I'm not sure the debugging and extra log details were added correctly, because these look the same.

Thanks, 
Josh


-----Original Message-----
From: squid-users <squid-users-bounces at lists.squid-cache.org> On Behalf Of Alex Rousskov
Sent: Wednesday, August 28, 2024 4:01 PM
To: squid-users at lists.squid-cache.org
Subject: Re: [squid-users] Unable to access internal resources via hostname

Caution: This email originated from outside of Hexcel. Do not click links or open attachments unless you recognize the sender and know the content is safe.


On 2024-08-28 15:25, Piana, Josh wrote:

> I now understand that Squid 5.5 ... is actually out of date as well.
> I regret installing and working off of this because I jused assumed 
> the "yum" install command for the Squid distro would give me the most 
> recent, known-good, software. That's completely on me.

Whether yum install installs something production-worthy today is between you and your Linux distro. Squid Project volunteers, including me, do no control what distribution you pick and what that distribution ships. The reason I mentioned v5 support status is to avoid creating a false impression that there are no _other_ (i.e. unreported by you on this thread) problems you may want to know about and to lower your expectations from the level of support you may get from Squid Project volunteers like me.

Said that, I doubt the problem you are trying to solve is v5-specific.
You may get better diagnostics if you run v6+, and you may receive fewer unusable (with v5) instructions if you run v6+, but the problem is likely to be present in a v6-based setup as well.


> From how I understand it, his intentions for internal users accessing 
> internal resources, would skip authentication altogether.

I assume that the problematic test that you want to fix is done using "internal users". You have already stated that the test is accessing "internal resources". Yet, we see that Squid asks the test client to authenticate (TCP_DENIED/407). Thus,

* either local_dst_dom, local_dst_addr, and authless_src ACLs do not match test client transactions

* or there is an authentication-triggering directive (e.g., "http_access deny block_user") located above a matching "http_access allow" rule that uses one of those ACLs three.

Ideally, we should figure out which http_access rule matches the problematic transaction and triage from there. Unfortunately, Squid does not make that basic task easy. The best option I can think of is for you to share (privately if needed to avoid publishing sensitive info) a pointer to compressed cache.log file collected while reproducing the problem using a single test transaction after setting debug_options to ALL,9. Squid FAQ has a few hints about collecting relevant info:
https://wiki.squid-cache.org/SquidFaq/BugReporting#debugging-a-single-transaction

This "unexpected authentication" mystery may not be directly related to the "HTTP 500 error responses" mystery we discussed earlier, but it may help to fix authentication first.


HTH,

Alex.


> Here's a small piece, with his notes included, of why I think that.
>
> ----------------------------------------------------------------------
> --------------------------------------------------
> # 
> ----------------------------------------------------------------------
> ------
> # allow without authentication
> # these rules allow certain connects without user authentication # 
> these allow any protocol/method/etc
>
> #                 ***** IMPORTANT *****
> # Adding to these lists also exempts from all content filtering.
> # In particular, executables will be allowed to download!
> #                 ***** IMPORTANT *****
>
> # allow connects to local destinations without authentication # by 
> domain name from URL
> http_access       allow local_dst_dom
> http_reply_access allow local_dst_dom
>
> # by IP address name resolves to
> http_access       allow local_dst_addr
> http_reply_access allow local_dst_addr
> ----------------------------------------------------------------------
> --------------------------------------------------
>
> The "http_access allow local_dst_dom" and the following reply statement seems to point toward his intentions when writing this.
>
> The only thing in the old config this was referencing was this, and to me, it doesn't make sense:
> # acl local_dst_dom dstdomain arcgate
>
> It's worth noting that despite how awkward this seems, it DOES work. On the old web proxy we're currently still running live.
>
> I've gone as far as swapping out just the authentication settings and keeping the entire old config, but it still doesn't work.
> I've setup a realmd/sssd/kerberos backend instead of Samba/Windbind that the old server uses.
>
> To state the issue we're having again - internal resources connecting to other internal resources fails via hostname, but works when using IP. I was able to troubleshoot and conclude DNS was not the issue, as all other aspects are working as intended and they certainly do use DNS. Also pings resolve using hostname from the new squidbox so that implies that DNS is working as expected.
>
> Ultimately, here's what I think we want, please feel free to poke holes in it:
> Allow clients who are accessing other internal rersources to be able to browse to it using its hostname, without needing authentication first.
>
>
> I do intend on adding those parameters you mentioned to the logs so I can get better details within. I also need to look into how to use the debugging features, I'm not familiar with it at all.
>
> I apologize for the wall of text, looking forward to what you guys have to say about this.
>
> Thanks,
> Josh
>
> -----Original Message-----
> From: squid-users <squid-users-bounces at lists.squid-cache.org> On 
> Behalf Of Alex Rousskov
> Sent: Wednesday, August 28, 2024 2:31 PM
> To: squid-users at lists.squid-cache.org
> Subject: Re: [squid-users] Unable to access internal resources via 
> hostname
>
> Caution: This email originated from outside of Hexcel. Do not click links or open attachments unless you recognize the sender and know the content is safe.
>
>
> On 2024-08-28 14:18, Alex Rousskov wrote:
>> On 2024-08-28 11:24, Piana, Josh wrote:
>>
>>> Here's the log and (I think) relevant ACL's?
>>
>> According to your access.log, Squid denies problematic CONNECT 
>> requests with HTTP 407 errors responses. Usually, that means those 
>> requests match an "http_access deny" rule. Clearly, you expect an 
>> "allow" outcome instead, but it is difficult (for me) to figure out 
>> where your expectations mismatch reality; there are no rules that 
>> explicitly mention hexcelssp domain, for example: Which "http_access 
>> allow" rule do you expect those denied requests to match?
>
> Sorry, I probably misinterpreted those access.log records: It looks like the denied (TCP_DENIED/407) access is something you actually expect because you want that test request to be authenticated. The client supplies the necessary credentials in the second request, and then that second request fails with a (rather generic) HTTP 500 error code, without contacting the origin server.
>
> I am guessing that you are concerned about that second request/transaction rather than the first one.
>
> Squid generates HTTP 500 errors for a variety of different reasons. Are there any messages in cache.log (at default debugging level) that correspond to these failing test transactions? If there are none, please add %err_code/%err_detail to your access_log logformat so that Squid logs more information about the problem to access.log (see logformat and access_log directives in squid.conf.documented for details).
>
>
> Thank you,
>
> Alex.
>
>
>
>> Also, does mgr:ipcache cache manager query confirm that Squid has 
>> read your /etc/hosts file and cached the record you expect it to use?
>>
>> Alex.
>>
>>
>>> --------------------------------------------------------------------
>>> -
>>> --------------------------------------
>>> # /var/log/squid/access.log results for internal conflicts
>>>
>>> 28/Aug/2024:10:57:17 -0400.234 10.46.49.190 TCP_DENIED/407 4132 
>>> CONNECT hexcelssp:443 - HIER_NONE/- text/html
>>> 28/Aug/2024:10:57:17 -0400.253 10.46.49.190 NONE_NONE/500 0 CONNECT
>>> hexcelssp:443 JPIANA at AD.<DOMAIN>.COM HIER_NONE/- -
>>> 28/Aug/2024:10:57:17 -0400.380 10.46.49.190 TCP_DENIED/407 4132 
>>> CONNECT hexcelssp:443 - HIER_NONE/- text/html
>>> 28/Aug/2024:10:57:17 -0400.399 10.46.49.190 NONE_NONE/500 0 CONNECT
>>> hexcelssp:443 JPIANA at AD.<DOMAIN>.COM HIER_NONE/- -
>>> --------------------------------------------------------------------
>>> -
>>> --------------------------------------
>>>
>>> # acl all src all
>>>
>>> acl src_self src 127.0.0.0/8
>>> acl src_self src 10.46.11.69
>>>
>>> acl dst_self dst 127.0.0.0/8
>>> acl dst_self dst 10.46.11.69
>>>
>>> acl from_arc src 10.46.0.0/15
>>>
>>> acl local_dst_addr dst 10.0.0.0/8
>>> acl local_dst_addr dst 172.0.0.0/8
>>> acl local_dst_addr dst bldg3.<domain>.com acl local_dst_addr dst 
>>> bldg5.<domain>.com
>>>
>>> # these keep URLs of popular local servers from being forwarded acl 
>>> local_dst_dom dstdomain arcgate
>>>
>>> # allow connects to local destinations without authentication # by 
>>> domain name from URL
>>> http_access       allow local_dst_dom
>>> http_reply_access allow local_dst_dom
>>>
>>> # by IP address name resolves to
>>> http_access       allow local_dst_addr
>>> http_reply_access allow local_dst_addr
>>>
>>> # allow trusted hosts without authentication # these are just ip's 
>>> on the 10.46.11.x network acl authless_src src "/etc/squid/authless_src"
>>> http_access       allow authless_src
>>> http_reply_access allow authless_src
>>> --------------------------------------------------------------------
>>> -
>>> --------------------------------------
>>>
>>> -----Original Message-----
>>> From: squid-users <squid-users-bounces at lists.squid-cache.org> On 
>>> Behalf Of Matus UHLAR - fantomas
>>> Sent: Wednesday, August 28, 2024 10:47 AM
>>> To: squid-users at lists.squid-cache.org
>>> Subject: Re: [squid-users] Unable to access internal resources via 
>>> hostname
>>>
>>> Caution: This email originated from outside of Hexcel. Do not click 
>>> links or open attachments unless you recognize the sender and know 
>>> the content is safe.
>>>
>>>
>>> On 28.08.24 14:20, Piana, Josh wrote:
>>>> Hello Squid Support,
>>>
>>> This squid user forum FYI
>>>
>>>> We are unable to get to internal resources via hostname but using 
>>>> the IP address works fine.  Immediately, I thought this was DNS but 
>>>> when I checked the /etc/resolv.conf/ file it was pointing correctly 
>>>> to our Windows DNS server and we can ping all devices using their 
>>>> hostname, just not when browsing to it.  This leads me to believe 
>>>> something may be wrong with our squid config.
>>>
>>> hard to guess without seeing logs or ACL's.
>>>
>>>
>>> --
>>> Matus UHLAR - fantomas, uhlar at fantomas.sk ; http://www/.
>>> fantomas.sk%2F&data=05%7C02%7Cjosh.piana%40hexcel.com%7C2db72264caa0
>>> 4
>>> f1fd80d08dcc78f9245%7C4248050df19546d5ac9c0c7c52b04cae%7C0%7C0%7C638
>>> 6
>>> 04666668859787%7CUnknown%7CTWFpbGZsb3d8eyJWIjoiMC4wLjAwMDAiLCJQIjoiV
>>> 2 
>>> luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C0%7C%7C%7C&sdata=Z7cUEdNvInDA
>>> J
>>> PwgQJhXWSK3H2mkAPe4CNcfYJFyy6M%3D&reserved=0
>>> Warning: I wish NOT to receive e-mail advertising to this address.
>>> Varovanie: na tuto adresu chcem NEDOSTAVAT akukolvek reklamnu postu.
>>> It's now safe to throw off your computer.
>>> _______________________________________________
>>> squid-users mailing list
>>> squid-users at lists.squid-cache.org
>>> https://lis/
>>> ts.squid-cache.org%2Flistinfo%2Fsquid-users&data=05%7C02%7Cjosh.pian
>>> a 
>>> %40hexcel.com%7C2db72264caa04f1fd80d08dcc78f9245%7C4248050df19546d5a
>>> c 
>>> 9c0c7c52b04cae%7C0%7C0%7C638604666674016161%7CUnknown%7CTWFpbGZsb3d8
>>> e
>>> yJWIjoiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C
>>> 0 
>>> %7C%7C%7C&sdata=%2B%2B7inZxg2LEmB2KFVWmtn64FG8SwHpEZeEyAjhNClnU%3D&r
>>> e
>>> served=0 _______________________________________________
>>> squid-users mailing list
>>> squid-users at lists.squid-cache.org
>>> https://lis/
>>> ts.squid-cache.org%2Flistinfo%2Fsquid-users&data=05%7C02%7Cjosh.pian
>>> a 
>>> %40hexcel.com%7C2db72264caa04f1fd80d08dcc78f9245%7C4248050df19546d5a
>>> c 
>>> 9c0c7c52b04cae%7C0%7C0%7C638604666674016161%7CUnknown%7CTWFpbGZsb3d8
>>> e
>>> yJWIjoiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C
>>> 0 
>>> %7C%7C%7C&sdata=%2B%2B7inZxg2LEmB2KFVWmtn64FG8SwHpEZeEyAjhNClnU%3D&r
>>> e
>>> served=0
>>
>> _______________________________________________
>> squid-users mailing list
>> squid-users at lists.squid-cache.org
>> https://list/
>> s.squid-cache.org%2Flistinfo%2Fsquid-users&data=05%7C02%7Cjosh.piana%
>> 4
>> 0hexcel.com%7C2db72264caa04f1fd80d08dcc78f9245%7C4248050df19546d5ac9c
>> 0 
>> c7c52b04cae%7C0%7C0%7C638604666674016161%7CUnknown%7CTWFpbGZsb3d8eyJW
>> I
>> joiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C0%7C%
>> 7 
>> C%7C&sdata=%2B%2B7inZxg2LEmB2KFVWmtn64FG8SwHpEZeEyAjhNClnU%3D&reserve
>> d
>> =0
>
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> https://list/
> s.squid-cache.org%2Flistinfo%2Fsquid-users&data=05%7C02%7Cjosh.piana%4
> 0hexcel.com%7C6f7f2ea035ca4506507008dcc79c3598%7C4248050df19546d5ac9c0
> c7c52b04cae%7C0%7C0%7C638604720952164544%7CUnknown%7CTWFpbGZsb3d8eyJWI
> joiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C0%7C%7
> C%7C&sdata=RrdtLQu5y421WIi6vjyxj1ZsNRdIn%2FMaKusbjKGoY48%3D&reserved=0
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> https://list/
> s.squid-cache.org%2Flistinfo%2Fsquid-users&data=05%7C02%7Cjosh.piana%4
> 0hexcel.com%7C6f7f2ea035ca4506507008dcc79c3598%7C4248050df19546d5ac9c0
> c7c52b04cae%7C0%7C0%7C638604720952164544%7CUnknown%7CTWFpbGZsb3d8eyJWI
> joiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C0%7C%7
> C%7C&sdata=RrdtLQu5y421WIi6vjyxj1ZsNRdIn%2FMaKusbjKGoY48%3D&reserved=0

_______________________________________________
squid-users mailing list
squid-users at lists.squid-cache.org
https://lists.squid-cache.org/listinfo/squid-users


From rousskov at measurement-factory.com  Thu Aug 29 15:59:53 2024
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Thu, 29 Aug 2024 11:59:53 -0400
Subject: [squid-users] Unable to access internal resources via hostname
In-Reply-To: <d063bef52efd4e32a9f9bb27f934e673@hexcel.com>
References: <405705ce244447aca1b15385a171fada@hexcel.com>
 <Zs84drvoIpZ1f6DR@fantomas.sk> <58bdfaada3fa46d0938b7346ec04c336@hexcel.com>
 <947309fa-d1fc-4a75-ac49-ea7bc5c5ff12@measurement-factory.com>
 <faffca37-fa59-46ff-80e4-245c37fa90b9@measurement-factory.com>
 <c00942c1c8ab46b5b393d70f32346798@hexcel.com>
 <59274673-47e9-431d-ad45-7fa3a5a8ebca@measurement-factory.com>
 <d063bef52efd4e32a9f9bb27f934e673@hexcel.com>
Message-ID: <8f29292d-a074-42b0-a793-757782b9d9f9@measurement-factory.com>

On 2024-08-29 10:34, Piana, Josh wrote:

> I've added the following to my squid.conf file
> # logformat custom %err_code/%err_detail
> # access_log daemon:/var/log/squid/access,log custom

I assume you are using comment character (#) for email presentation 
purposes (i.e. it does not actually exist in your squid.conf).

I assume that comma in your access log file name above is a typo that 
does not actually exist in your squid.conf.


> I'm not sure ... extra log details were added correctly
The above access_log configuration should reduce all access.log records 
to exactly two fields separated by a slash. Clearly, it does not! Thus, 
you are either not testing with the new configuration file (e.g., you 
have not fully shut down and then started Squid) or there are other 
serious problems (e.g., malformed squid.conf that confuses Squid v5). We 
should solve this mystery before moving any further.


> I've also enabled debugging options:
> # debug_options ALL,9

Thank you. Please note that this debugging info goes into cache.log, not 
access.log. I trust you have examined your cache.log for errors and 
warnings _before_ enabling debugging -- finding them among debugging 
noise can be challenging! ALL,9 debugging is for Squid developers to study.

My recommendation for the next step remains the same. Look for "The best 
option" in my previous response.


HTH,

Alex.


> I've also cleaned up our ACL's to better reflect what is going on:
> # acl src_self src 127.0.0.0/8
> # acl src_self src 10.46.11.69
> # acl dst_self dst 127.0.0.0/8
> # acl dst_self dst 10.46.11.69
> 
> # acl from_arc src 10.46.0.0/15
> 
> # acl local_dst_addr dst 10.0.0.0/8
> # acl local_dst_addr dst 172.0.0.0/8
> 
> When accessing internal devices via IP, it works.
> I think this is because of this ACL:
> # http_access           allow local_dst_addr
> # http_reply_access     allow local_dst_addr
> 
> But when I access those same internal devices via hostname, it fails.
> I'm using this ACL, which I just created a separate file for:
> acl local_dst_dom dstdomain "etc/squid/local_dst_dom"
> http_access       allow local_dst_dom
> http_reply_access allow local_dst_dom
> 
> I added an ACL file because I figure it will be more extensive than the more simple IP range ACL's.
> I've added a few local websites to the "local_dst_dom" list, but I'm unable to get this to resolve without using IP.
> 
> For instance: "https://hexcelssp/" is the name of one of our internal websites for our company.
> This doesn't load under our current config but "https://10.96.14.174/" DOES load.
> 
> I've added "hexnt2067" as well, which you can see me testing in the below logs.
> Again, this DOES work with its IP, 10.96.102.67.
> 
> I'm not getting a proxy error message when I try to browse to that URL though, we just can't reach it.
> 	
> Here's the log results after enabling debugging and better log features:
> 
> 29/Aug/2024:10:25:33 -0400.380 10.46.49.190 TCP_DENIED/407 4132 CONNECT hexcelssp:443 - HIER_NONE/- text/html
> 29/Aug/2024:10:25:33 -0400.515 10.46.49.190 NONE_NONE/500 0 CONNECT hexcelssp:443 JPIANA at AD.<DOMAIN>.COM HIER_NONE/- -
> 29/Aug/2024:10:25:39 -0400.799 10.46.49.190 TCP_TUNNEL/200 11716 CONNECT contile.services.mozilla.com:443 JPIANA at AD.<DOMAIN>.COM HIER_DIRECT/34.117.188.166 -
> 29/Aug/2024:10:26:05 -0400.507 10.46.49.190 TCP_DENIED/407 4474 GET http://hexnt2067/sites/it/help/SitePages/Home.aspx - HIER_NONE/- text/html
> 29/Aug/2024:10:26:05 -0400.646 10.46.49.190 TCP_MISS/500 8320 GET http://hexnt2067/sites/it/help/SitePages/Home.aspx JPIANA at AD.<DOMAIN>.COM HIER_NONE/- text/html
> 29/Aug/2024:10:26:05 -0400.735 10.46.49.190 TCP_DENIED/403 4440 GET http://arcgate2.ad/.<domain>.com:8080/squid-internal-static/icons/SN.png - HIER_NONE/- text/html
> 29/Aug/2024:10:26:05 -0400.779 10.46.49.190 TCP_MISS_ABORTED/500 0 GET http://hexnt2067/favicon.ico JPIANA at AD.<DOMAIN>.COM HIER_NONE/- text/html
> 29/Aug/2024:10:27:13 -0400.036 10.46.49.190 TCP_DENIED/407 4474 GET http://hexnt2067/sites/it/help/SitePages/Home.aspx - HIER_NONE/- text/html
> 29/Aug/2024:10:27:13 -0400.227 10.46.49.190 TCP_MISS/500 8334 GET http://hexnt2067/sites/it/help/SitePages/Home.aspx JPIANA at AD.<DOMAIN>.COM HIER_NONE/- text/html
> 29/Aug/2024:10:27:13 -0400.302 10.46.49.190 TCP_DENIED/403 4440 GET http://arcgate2.ad/.<domain>.com:8080/squid-internal-static/icons/SN.png - HIER_NONE/- text/html
> 29/Aug/2024:10:27:17 -0400.376 10.46.49.190 TCP_DENIED/407 4132 CONNECT hexcelssp:443 - HIER_NONE/- text/html
> 29/Aug/2024:10:27:17 -0400.514 10.46.49.190 NONE_NONE/500 0 CONNECT hexcelssp:443 JPIANA at AD.<DOMAIN>.COM HIER_NONE/- -
> 
> I'm not sure the debugging and extra log details were added correctly, because these look the same.
> 
> Thanks,
> Josh
> 
> 
> -----Original Message-----
> From: squid-users <squid-users-bounces at lists.squid-cache.org> On Behalf Of Alex Rousskov
> Sent: Wednesday, August 28, 2024 4:01 PM
> To: squid-users at lists.squid-cache.org
> Subject: Re: [squid-users] Unable to access internal resources via hostname
> 
> Caution: This email originated from outside of Hexcel. Do not click links or open attachments unless you recognize the sender and know the content is safe.
> 
> 
> On 2024-08-28 15:25, Piana, Josh wrote:
> 
>> I now understand that Squid 5.5 ... is actually out of date as well.
>> I regret installing and working off of this because I jused assumed
>> the "yum" install command for the Squid distro would give me the most
>> recent, known-good, software. That's completely on me.
> 
> Whether yum install installs something production-worthy today is between you and your Linux distro. Squid Project volunteers, including me, do no control what distribution you pick and what that distribution ships. The reason I mentioned v5 support status is to avoid creating a false impression that there are no _other_ (i.e. unreported by you on this thread) problems you may want to know about and to lower your expectations from the level of support you may get from Squid Project volunteers like me.
> 
> Said that, I doubt the problem you are trying to solve is v5-specific.
> You may get better diagnostics if you run v6+, and you may receive fewer unusable (with v5) instructions if you run v6+, but the problem is likely to be present in a v6-based setup as well.
> 
> 
>>  From how I understand it, his intentions for internal users accessing
>> internal resources, would skip authentication altogether.
> 
> I assume that the problematic test that you want to fix is done using "internal users". You have already stated that the test is accessing "internal resources". Yet, we see that Squid asks the test client to authenticate (TCP_DENIED/407). Thus,
> 
> * either local_dst_dom, local_dst_addr, and authless_src ACLs do not match test client transactions
> 
> * or there is an authentication-triggering directive (e.g., "http_access deny block_user") located above a matching "http_access allow" rule that uses one of those ACLs three.
> 
> Ideally, we should figure out which http_access rule matches the problematic transaction and triage from there. Unfortunately, Squid does not make that basic task easy. The best option I can think of is for you to share (privately if needed to avoid publishing sensitive info) a pointer to compressed cache.log file collected while reproducing the problem using a single test transaction after setting debug_options to ALL,9. Squid FAQ has a few hints about collecting relevant info:
> https://wiki.squid-cache.org/SquidFaq/BugReporting#debugging-a-single-transaction
> 
> This "unexpected authentication" mystery may not be directly related to the "HTTP 500 error responses" mystery we discussed earlier, but it may help to fix authentication first.
> 
> 
> HTH,
> 
> Alex.
> 
> 
>> Here's a small piece, with his notes included, of why I think that.
>>
>> ----------------------------------------------------------------------
>> --------------------------------------------------
>> #
>> ----------------------------------------------------------------------
>> ------
>> # allow without authentication
>> # these rules allow certain connects without user authentication #
>> these allow any protocol/method/etc
>>
>> #                 ***** IMPORTANT *****
>> # Adding to these lists also exempts from all content filtering.
>> # In particular, executables will be allowed to download!
>> #                 ***** IMPORTANT *****
>>
>> # allow connects to local destinations without authentication # by
>> domain name from URL
>> http_access       allow local_dst_dom
>> http_reply_access allow local_dst_dom
>>
>> # by IP address name resolves to
>> http_access       allow local_dst_addr
>> http_reply_access allow local_dst_addr
>> ----------------------------------------------------------------------
>> --------------------------------------------------
>>
>> The "http_access allow local_dst_dom" and the following reply statement seems to point toward his intentions when writing this.
>>
>> The only thing in the old config this was referencing was this, and to me, it doesn't make sense:
>> # acl local_dst_dom dstdomain arcgate
>>
>> It's worth noting that despite how awkward this seems, it DOES work. On the old web proxy we're currently still running live.
>>
>> I've gone as far as swapping out just the authentication settings and keeping the entire old config, but it still doesn't work.
>> I've setup a realmd/sssd/kerberos backend instead of Samba/Windbind that the old server uses.
>>
>> To state the issue we're having again - internal resources connecting to other internal resources fails via hostname, but works when using IP. I was able to troubleshoot and conclude DNS was not the issue, as all other aspects are working as intended and they certainly do use DNS. Also pings resolve using hostname from the new squidbox so that implies that DNS is working as expected.
>>
>> Ultimately, here's what I think we want, please feel free to poke holes in it:
>> Allow clients who are accessing other internal rersources to be able to browse to it using its hostname, without needing authentication first.
>>
>>
>> I do intend on adding those parameters you mentioned to the logs so I can get better details within. I also need to look into how to use the debugging features, I'm not familiar with it at all.
>>
>> I apologize for the wall of text, looking forward to what you guys have to say about this.
>>
>> Thanks,
>> Josh
>>
>> -----Original Message-----
>> From: squid-users <squid-users-bounces at lists.squid-cache.org> On
>> Behalf Of Alex Rousskov
>> Sent: Wednesday, August 28, 2024 2:31 PM
>> To: squid-users at lists.squid-cache.org
>> Subject: Re: [squid-users] Unable to access internal resources via
>> hostname
>>
>> Caution: This email originated from outside of Hexcel. Do not click links or open attachments unless you recognize the sender and know the content is safe.
>>
>>
>> On 2024-08-28 14:18, Alex Rousskov wrote:
>>> On 2024-08-28 11:24, Piana, Josh wrote:
>>>
>>>> Here's the log and (I think) relevant ACL's?
>>>
>>> According to your access.log, Squid denies problematic CONNECT
>>> requests with HTTP 407 errors responses. Usually, that means those
>>> requests match an "http_access deny" rule. Clearly, you expect an
>>> "allow" outcome instead, but it is difficult (for me) to figure out
>>> where your expectations mismatch reality; there are no rules that
>>> explicitly mention hexcelssp domain, for example: Which "http_access
>>> allow" rule do you expect those denied requests to match?
>>
>> Sorry, I probably misinterpreted those access.log records: It looks like the denied (TCP_DENIED/407) access is something you actually expect because you want that test request to be authenticated. The client supplies the necessary credentials in the second request, and then that second request fails with a (rather generic) HTTP 500 error code, without contacting the origin server.
>>
>> I am guessing that you are concerned about that second request/transaction rather than the first one.
>>
>> Squid generates HTTP 500 errors for a variety of different reasons. Are there any messages in cache.log (at default debugging level) that correspond to these failing test transactions? If there are none, please add %err_code/%err_detail to your access_log logformat so that Squid logs more information about the problem to access.log (see logformat and access_log directives in squid.conf.documented for details).
>>
>>
>> Thank you,
>>
>> Alex.
>>
>>
>>
>>> Also, does mgr:ipcache cache manager query confirm that Squid has
>>> read your /etc/hosts file and cached the record you expect it to use?
>>>
>>> Alex.
>>>
>>>
>>>> --------------------------------------------------------------------
>>>> -
>>>> --------------------------------------
>>>> # /var/log/squid/access.log results for internal conflicts
>>>>
>>>> 28/Aug/2024:10:57:17 -0400.234 10.46.49.190 TCP_DENIED/407 4132
>>>> CONNECT hexcelssp:443 - HIER_NONE/- text/html
>>>> 28/Aug/2024:10:57:17 -0400.253 10.46.49.190 NONE_NONE/500 0 CONNECT
>>>> hexcelssp:443 JPIANA at AD.<DOMAIN>.COM HIER_NONE/- -
>>>> 28/Aug/2024:10:57:17 -0400.380 10.46.49.190 TCP_DENIED/407 4132
>>>> CONNECT hexcelssp:443 - HIER_NONE/- text/html
>>>> 28/Aug/2024:10:57:17 -0400.399 10.46.49.190 NONE_NONE/500 0 CONNECT
>>>> hexcelssp:443 JPIANA at AD.<DOMAIN>.COM HIER_NONE/- -
>>>> --------------------------------------------------------------------
>>>> -
>>>> --------------------------------------
>>>>
>>>> # acl all src all
>>>>
>>>> acl src_self src 127.0.0.0/8
>>>> acl src_self src 10.46.11.69
>>>>
>>>> acl dst_self dst 127.0.0.0/8
>>>> acl dst_self dst 10.46.11.69
>>>>
>>>> acl from_arc src 10.46.0.0/15
>>>>
>>>> acl local_dst_addr dst 10.0.0.0/8
>>>> acl local_dst_addr dst 172.0.0.0/8
>>>> acl local_dst_addr dst bldg3.<domain>.com acl local_dst_addr dst
>>>> bldg5.<domain>.com
>>>>
>>>> # these keep URLs of popular local servers from being forwarded acl
>>>> local_dst_dom dstdomain arcgate
>>>>
>>>> # allow connects to local destinations without authentication # by
>>>> domain name from URL
>>>> http_access       allow local_dst_dom
>>>> http_reply_access allow local_dst_dom
>>>>
>>>> # by IP address name resolves to
>>>> http_access       allow local_dst_addr
>>>> http_reply_access allow local_dst_addr
>>>>
>>>> # allow trusted hosts without authentication # these are just ip's
>>>> on the 10.46.11.x network acl authless_src src "/etc/squid/authless_src"
>>>> http_access       allow authless_src
>>>> http_reply_access allow authless_src
>>>> --------------------------------------------------------------------
>>>> -
>>>> --------------------------------------
>>>>
>>>> -----Original Message-----
>>>> From: squid-users <squid-users-bounces at lists.squid-cache.org> On
>>>> Behalf Of Matus UHLAR - fantomas
>>>> Sent: Wednesday, August 28, 2024 10:47 AM
>>>> To: squid-users at lists.squid-cache.org
>>>> Subject: Re: [squid-users] Unable to access internal resources via
>>>> hostname
>>>>
>>>> Caution: This email originated from outside of Hexcel. Do not click
>>>> links or open attachments unless you recognize the sender and know
>>>> the content is safe.
>>>>
>>>>
>>>> On 28.08.24 14:20, Piana, Josh wrote:
>>>>> Hello Squid Support,
>>>>
>>>> This squid user forum FYI
>>>>
>>>>> We are unable to get to internal resources via hostname but using
>>>>> the IP address works fine.  Immediately, I thought this was DNS but
>>>>> when I checked the /etc/resolv.conf/ file it was pointing correctly
>>>>> to our Windows DNS server and we can ping all devices using their
>>>>> hostname, just not when browsing to it.  This leads me to believe
>>>>> something may be wrong with our squid config.
>>>>
>>>> hard to guess without seeing logs or ACL's.
>>>>
>>>>
>>>> --
>>>> Matus UHLAR - fantomas, uhlar at fantomas.sk ; http://www/.
>>>> fantomas.sk%2F&data=05%7C02%7Cjosh.piana%40hexcel.com%7C2db72264caa0
>>>> 4
>>>> f1fd80d08dcc78f9245%7C4248050df19546d5ac9c0c7c52b04cae%7C0%7C0%7C638
>>>> 6
>>>> 04666668859787%7CUnknown%7CTWFpbGZsb3d8eyJWIjoiMC4wLjAwMDAiLCJQIjoiV
>>>> 2
>>>> luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C0%7C%7C%7C&sdata=Z7cUEdNvInDA
>>>> J
>>>> PwgQJhXWSK3H2mkAPe4CNcfYJFyy6M%3D&reserved=0
>>>> Warning: I wish NOT to receive e-mail advertising to this address.
>>>> Varovanie: na tuto adresu chcem NEDOSTAVAT akukolvek reklamnu postu.
>>>> It's now safe to throw off your computer.
>>>> _______________________________________________
>>>> squid-users mailing list
>>>> squid-users at lists.squid-cache.org
>>>> https://lis/
>>>> ts.squid-cache.org%2Flistinfo%2Fsquid-users&data=05%7C02%7Cjosh.pian
>>>> a
>>>> %40hexcel.com%7C2db72264caa04f1fd80d08dcc78f9245%7C4248050df19546d5a
>>>> c
>>>> 9c0c7c52b04cae%7C0%7C0%7C638604666674016161%7CUnknown%7CTWFpbGZsb3d8
>>>> e
>>>> yJWIjoiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C
>>>> 0
>>>> %7C%7C%7C&sdata=%2B%2B7inZxg2LEmB2KFVWmtn64FG8SwHpEZeEyAjhNClnU%3D&r
>>>> e
>>>> served=0 _______________________________________________
>>>> squid-users mailing list
>>>> squid-users at lists.squid-cache.org
>>>> https://lis/
>>>> ts.squid-cache.org%2Flistinfo%2Fsquid-users&data=05%7C02%7Cjosh.pian
>>>> a
>>>> %40hexcel.com%7C2db72264caa04f1fd80d08dcc78f9245%7C4248050df19546d5a
>>>> c
>>>> 9c0c7c52b04cae%7C0%7C0%7C638604666674016161%7CUnknown%7CTWFpbGZsb3d8
>>>> e
>>>> yJWIjoiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C
>>>> 0
>>>> %7C%7C%7C&sdata=%2B%2B7inZxg2LEmB2KFVWmtn64FG8SwHpEZeEyAjhNClnU%3D&r
>>>> e
>>>> served=0
>>>
>>> _______________________________________________
>>> squid-users mailing list
>>> squid-users at lists.squid-cache.org
>>> https://list/
>>> s.squid-cache.org%2Flistinfo%2Fsquid-users&data=05%7C02%7Cjosh.piana%
>>> 4
>>> 0hexcel.com%7C2db72264caa04f1fd80d08dcc78f9245%7C4248050df19546d5ac9c
>>> 0
>>> c7c52b04cae%7C0%7C0%7C638604666674016161%7CUnknown%7CTWFpbGZsb3d8eyJW
>>> I
>>> joiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C0%7C%
>>> 7
>>> C%7C&sdata=%2B%2B7inZxg2LEmB2KFVWmtn64FG8SwHpEZeEyAjhNClnU%3D&reserve
>>> d
>>> =0
>>
>> _______________________________________________
>> squid-users mailing list
>> squid-users at lists.squid-cache.org
>> https://list/
>> s.squid-cache.org%2Flistinfo%2Fsquid-users&data=05%7C02%7Cjosh.piana%4
>> 0hexcel.com%7C6f7f2ea035ca4506507008dcc79c3598%7C4248050df19546d5ac9c0
>> c7c52b04cae%7C0%7C0%7C638604720952164544%7CUnknown%7CTWFpbGZsb3d8eyJWI
>> joiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C0%7C%7
>> C%7C&sdata=RrdtLQu5y421WIi6vjyxj1ZsNRdIn%2FMaKusbjKGoY48%3D&reserved=0
>> _______________________________________________
>> squid-users mailing list
>> squid-users at lists.squid-cache.org
>> https://list/
>> s.squid-cache.org%2Flistinfo%2Fsquid-users&data=05%7C02%7Cjosh.piana%4
>> 0hexcel.com%7C6f7f2ea035ca4506507008dcc79c3598%7C4248050df19546d5ac9c0
>> c7c52b04cae%7C0%7C0%7C638604720952164544%7CUnknown%7CTWFpbGZsb3d8eyJWI
>> joiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C0%7C%7
>> C%7C&sdata=RrdtLQu5y421WIi6vjyxj1ZsNRdIn%2FMaKusbjKGoY48%3D&reserved=0
> 
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> https://lists.squid-cache.org/listinfo/squid-users
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> https://lists.squid-cache.org/listinfo/squid-users



From Josh.Piana at hexcel.com  Thu Aug 29 17:08:13 2024
From: Josh.Piana at hexcel.com (Piana, Josh)
Date: Thu, 29 Aug 2024 17:08:13 +0000
Subject: [squid-users] Unable to access internal resources via hostname
In-Reply-To: <8f29292d-a074-42b0-a793-757782b9d9f9@measurement-factory.com>
References: <405705ce244447aca1b15385a171fada@hexcel.com>
 <Zs84drvoIpZ1f6DR@fantomas.sk> <58bdfaada3fa46d0938b7346ec04c336@hexcel.com>
 <947309fa-d1fc-4a75-ac49-ea7bc5c5ff12@measurement-factory.com>
 <faffca37-fa59-46ff-80e4-245c37fa90b9@measurement-factory.com>
 <c00942c1c8ab46b5b393d70f32346798@hexcel.com>
 <59274673-47e9-431d-ad45-7fa3a5a8ebca@measurement-factory.com>
 <d063bef52efd4e32a9f9bb27f934e673@hexcel.com>
 <8f29292d-a074-42b0-a793-757782b9d9f9@measurement-factory.com>
Message-ID: <3de704666f56443fbfe762ce56f3e2dd@hexcel.com>

Alex, 

You assumed correctly! I'm trying to get in that habit of adding "#", seems to be popular amoung Linux users. I do know that it usually "comments out" the config to disable it but leave it there for testing/proof/options/etc. I also did add that comma by accident, I'll adjust that now. 

In regards to the debugging, do you still want me to do All,9 or is All,6 acceptable? I am reading that 9 is... huge. 

I did eventually find that it was the other log when I browsed /var/log/squid/... 
The log was dated for today, which is good. But I'm not sure how to generate it on purpose? 

Just so we're on the same understanding, I've only been using Linux for 2 months, this project is my first experience with it. I do apologize if I miss a lot of "common sense" stuff. This was tasked for me to figure out and I've been having a pretty fun learning experience so far. 

I'll update those logs and wait for your response to this before sending them or sending you a personal drop link. 

Thanks, 
Josh

-----Original Message-----
From: squid-users <squid-users-bounces at lists.squid-cache.org> On Behalf Of Alex Rousskov
Sent: Thursday, August 29, 2024 12:00 PM
To: squid-users at lists.squid-cache.org
Subject: Re: [squid-users] Unable to access internal resources via hostname

Caution: This email originated from outside of Hexcel. Do not click links or open attachments unless you recognize the sender and know the content is safe.


On 2024-08-29 10:34, Piana, Josh wrote:

> I've added the following to my squid.conf file # logformat custom 
> %err_code/%err_detail # access_log daemon:/var/log/squid/access,log 
> custom

I assume you are using comment character (#) for email presentation purposes (i.e. it does not actually exist in your squid.conf).

I assume that comma in your access log file name above is a typo that does not actually exist in your squid.conf.


> I'm not sure ... extra log details were added correctly
The above access_log configuration should reduce all access.log records to exactly two fields separated by a slash. Clearly, it does not! Thus, you are either not testing with the new configuration file (e.g., you have not fully shut down and then started Squid) or there are other serious problems (e.g., malformed squid.conf that confuses Squid v5). We should solve this mystery before moving any further.


> I've also enabled debugging options:
> # debug_options ALL,9

Thank you. Please note that this debugging info goes into cache.log, not access.log. I trust you have examined your cache.log for errors and warnings _before_ enabling debugging -- finding them among debugging noise can be challenging! ALL,9 debugging is for Squid developers to study.

My recommendation for the next step remains the same. Look for "The best option" in my previous response.


HTH,

Alex.


> I've also cleaned up our ACL's to better reflect what is going on:
> # acl src_self src 127.0.0.0/8
> # acl src_self src 10.46.11.69
> # acl dst_self dst 127.0.0.0/8
> # acl dst_self dst 10.46.11.69
>
> # acl from_arc src 10.46.0.0/15
>
> # acl local_dst_addr dst 10.0.0.0/8
> # acl local_dst_addr dst 172.0.0.0/8
>
> When accessing internal devices via IP, it works.
> I think this is because of this ACL:
> # http_access           allow local_dst_addr
> # http_reply_access     allow local_dst_addr
>
> But when I access those same internal devices via hostname, it fails.
> I'm using this ACL, which I just created a separate file for:
> acl local_dst_dom dstdomain "etc/squid/local_dst_dom"
> http_access       allow local_dst_dom
> http_reply_access allow local_dst_dom
>
> I added an ACL file because I figure it will be more extensive than the more simple IP range ACL's.
> I've added a few local websites to the "local_dst_dom" list, but I'm unable to get this to resolve without using IP.
>
> For instance: "https://hexcelssp/" is the name of one of our internal websites for our company.
> This doesn't load under our current config but "https://10.96.14.174/" DOES load.
>
> I've added "hexnt2067" as well, which you can see me testing in the below logs.
> Again, this DOES work with its IP, 10.96.102.67.
>
> I'm not getting a proxy error message when I try to browse to that URL though, we just can't reach it.
>
> Here's the log results after enabling debugging and better log features:
>
> 29/Aug/2024:10:25:33 -0400.380 10.46.49.190 TCP_DENIED/407 4132 
> CONNECT hexcelssp:443 - HIER_NONE/- text/html
> 29/Aug/2024:10:25:33 -0400.515 10.46.49.190 NONE_NONE/500 0 CONNECT 
> hexcelssp:443 JPIANA at AD.<DOMAIN>.COM HIER_NONE/- -
> 29/Aug/2024:10:25:39 -0400.799 10.46.49.190 TCP_TUNNEL/200 11716 
> CONNECT contile.services.mozilla.com:443 JPIANA at AD.<DOMAIN>.COM 
> HIER_DIRECT/34.117.188.166 -
> 29/Aug/2024:10:26:05 -0400.507 10.46.49.190 TCP_DENIED/407 4474 GET 
> http://hexnt2067/sites/it/help/SitePages/Home.aspx - HIER_NONE/- 
> text/html
> 29/Aug/2024:10:26:05 -0400.646 10.46.49.190 TCP_MISS/500 8320 GET 
> http://hexnt2067/sites/it/help/SitePages/Home.aspx 
> JPIANA at AD.<DOMAIN>.COM HIER_NONE/- text/html
> 29/Aug/2024:10:26:05 -0400.735 10.46.49.190 TCP_DENIED/403 4440 GET 
> http://arcga/
> te2.ad%2F&data=05%7C02%7Cjosh.piana%40hexcel.com%7Ce66ed645b81f49d475d
> e08dcc843a4a6%7C4248050df19546d5ac9c0c7c52b04cae%7C0%7C0%7C63860544007
> 1382901%7CUnknown%7CTWFpbGZsb3d8eyJWIjoiMC4wLjAwMDAiLCJQIjoiV2luMzIiLC
> JBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C0%7C%7C%7C&sdata=xqwHdvSxDiifEZVJALLtcC
> 6L9VoLptjKTHgDVTNBzLY%3D&reserved=0.<domain>.com:8080/squid-internal-s
> tatic/icons/SN.png - HIER_NONE/- text/html
> 29/Aug/2024:10:26:05 -0400.779 10.46.49.190 TCP_MISS_ABORTED/500 0 GET 
> http://hexnt2067/favicon.ico JPIANA at AD.<DOMAIN>.COM HIER_NONE/- 
> text/html
> 29/Aug/2024:10:27:13 -0400.036 10.46.49.190 TCP_DENIED/407 4474 GET 
> http://hexnt2067/sites/it/help/SitePages/Home.aspx - HIER_NONE/- 
> text/html
> 29/Aug/2024:10:27:13 -0400.227 10.46.49.190 TCP_MISS/500 8334 GET 
> http://hexnt2067/sites/it/help/SitePages/Home.aspx 
> JPIANA at AD.<DOMAIN>.COM HIER_NONE/- text/html
> 29/Aug/2024:10:27:13 -0400.302 10.46.49.190 TCP_DENIED/403 4440 GET 
> http://arcga/
> te2.ad%2F&data=05%7C02%7Cjosh.piana%40hexcel.com%7Ce66ed645b81f49d475d
> e08dcc843a4a6%7C4248050df19546d5ac9c0c7c52b04cae%7C0%7C0%7C63860544007
> 1382901%7CUnknown%7CTWFpbGZsb3d8eyJWIjoiMC4wLjAwMDAiLCJQIjoiV2luMzIiLC
> JBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C0%7C%7C%7C&sdata=xqwHdvSxDiifEZVJALLtcC
> 6L9VoLptjKTHgDVTNBzLY%3D&reserved=0.<domain>.com:8080/squid-internal-s
> tatic/icons/SN.png - HIER_NONE/- text/html
> 29/Aug/2024:10:27:17 -0400.376 10.46.49.190 TCP_DENIED/407 4132 
> CONNECT hexcelssp:443 - HIER_NONE/- text/html
> 29/Aug/2024:10:27:17 -0400.514 10.46.49.190 NONE_NONE/500 0 CONNECT 
> hexcelssp:443 JPIANA at AD.<DOMAIN>.COM HIER_NONE/- -
>
> I'm not sure the debugging and extra log details were added correctly, because these look the same.
>
> Thanks,
> Josh
>
>
> -----Original Message-----
> From: squid-users <squid-users-bounces at lists.squid-cache.org> On 
> Behalf Of Alex Rousskov
> Sent: Wednesday, August 28, 2024 4:01 PM
> To: squid-users at lists.squid-cache.org
> Subject: Re: [squid-users] Unable to access internal resources via 
> hostname
>
> Caution: This email originated from outside of Hexcel. Do not click links or open attachments unless you recognize the sender and know the content is safe.
>
>
> On 2024-08-28 15:25, Piana, Josh wrote:
>
>> I now understand that Squid 5.5 ... is actually out of date as well.
>> I regret installing and working off of this because I jused assumed 
>> the "yum" install command for the Squid distro would give me the most 
>> recent, known-good, software. That's completely on me.
>
> Whether yum install installs something production-worthy today is between you and your Linux distro. Squid Project volunteers, including me, do no control what distribution you pick and what that distribution ships. The reason I mentioned v5 support status is to avoid creating a false impression that there are no _other_ (i.e. unreported by you on this thread) problems you may want to know about and to lower your expectations from the level of support you may get from Squid Project volunteers like me.
>
> Said that, I doubt the problem you are trying to solve is v5-specific.
> You may get better diagnostics if you run v6+, and you may receive fewer unusable (with v5) instructions if you run v6+, but the problem is likely to be present in a v6-based setup as well.
>
>
>>  From how I understand it, his intentions for internal users 
>> accessing internal resources, would skip authentication altogether.
>
> I assume that the problematic test that you want to fix is done using 
> "internal users". You have already stated that the test is accessing 
> "internal resources". Yet, we see that Squid asks the test client to 
> authenticate (TCP_DENIED/407). Thus,
>
> * either local_dst_dom, local_dst_addr, and authless_src ACLs do not 
> match test client transactions
>
> * or there is an authentication-triggering directive (e.g., "http_access deny block_user") located above a matching "http_access allow" rule that uses one of those ACLs three.
>
> Ideally, we should figure out which http_access rule matches the problematic transaction and triage from there. Unfortunately, Squid does not make that basic task easy. The best option I can think of is for you to share (privately if needed to avoid publishing sensitive info) a pointer to compressed cache.log file collected while reproducing the problem using a single test transaction after setting debug_options to ALL,9. Squid FAQ has a few hints about collecting relevant info:
> https://wiki/
> .squid-cache.org%2FSquidFaq%2FBugReporting%23debugging-a-single-transa
> ction&data=05%7C02%7Cjosh.piana%40hexcel.com%7Ce66ed645b81f49d475de08d
> cc843a4a6%7C4248050df19546d5ac9c0c7c52b04cae%7C0%7C0%7C638605440071382
> 901%7CUnknown%7CTWFpbGZsb3d8eyJWIjoiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTi
> I6Ik1haWwiLCJXVCI6Mn0%3D%7C0%7C%7C%7C&sdata=RDkHh9Xa1Iyi3jC%2FbPGaoJoI
> %2FPvayueaofn8FRmb4KQ%3D&reserved=0
>
> This "unexpected authentication" mystery may not be directly related to the "HTTP 500 error responses" mystery we discussed earlier, but it may help to fix authentication first.
>
>
> HTH,
>
> Alex.
>
>
>> Here's a small piece, with his notes included, of why I think that.
>>
>> ---------------------------------------------------------------------
>> -
>> --------------------------------------------------
>> #
>> ---------------------------------------------------------------------
>> -
>> ------
>> # allow without authentication
>> # these rules allow certain connects without user authentication # 
>> these allow any protocol/method/etc
>>
>> #                 ***** IMPORTANT *****
>> # Adding to these lists also exempts from all content filtering.
>> # In particular, executables will be allowed to download!
>> #                 ***** IMPORTANT *****
>>
>> # allow connects to local destinations without authentication # by 
>> domain name from URL
>> http_access       allow local_dst_dom
>> http_reply_access allow local_dst_dom
>>
>> # by IP address name resolves to
>> http_access       allow local_dst_addr
>> http_reply_access allow local_dst_addr
>> ---------------------------------------------------------------------
>> -
>> --------------------------------------------------
>>
>> The "http_access allow local_dst_dom" and the following reply statement seems to point toward his intentions when writing this.
>>
>> The only thing in the old config this was referencing was this, and to me, it doesn't make sense:
>> # acl local_dst_dom dstdomain arcgate
>>
>> It's worth noting that despite how awkward this seems, it DOES work. On the old web proxy we're currently still running live.
>>
>> I've gone as far as swapping out just the authentication settings and keeping the entire old config, but it still doesn't work.
>> I've setup a realmd/sssd/kerberos backend instead of Samba/Windbind that the old server uses.
>>
>> To state the issue we're having again - internal resources connecting to other internal resources fails via hostname, but works when using IP. I was able to troubleshoot and conclude DNS was not the issue, as all other aspects are working as intended and they certainly do use DNS. Also pings resolve using hostname from the new squidbox so that implies that DNS is working as expected.
>>
>> Ultimately, here's what I think we want, please feel free to poke holes in it:
>> Allow clients who are accessing other internal rersources to be able to browse to it using its hostname, without needing authentication first.
>>
>>
>> I do intend on adding those parameters you mentioned to the logs so I can get better details within. I also need to look into how to use the debugging features, I'm not familiar with it at all.
>>
>> I apologize for the wall of text, looking forward to what you guys have to say about this.
>>
>> Thanks,
>> Josh
>>
>> -----Original Message-----
>> From: squid-users <squid-users-bounces at lists.squid-cache.org> On 
>> Behalf Of Alex Rousskov
>> Sent: Wednesday, August 28, 2024 2:31 PM
>> To: squid-users at lists.squid-cache.org
>> Subject: Re: [squid-users] Unable to access internal resources via 
>> hostname
>>
>> Caution: This email originated from outside of Hexcel. Do not click links or open attachments unless you recognize the sender and know the content is safe.
>>
>>
>> On 2024-08-28 14:18, Alex Rousskov wrote:
>>> On 2024-08-28 11:24, Piana, Josh wrote:
>>>
>>>> Here's the log and (I think) relevant ACL's?
>>>
>>> According to your access.log, Squid denies problematic CONNECT 
>>> requests with HTTP 407 errors responses. Usually, that means those 
>>> requests match an "http_access deny" rule. Clearly, you expect an 
>>> "allow" outcome instead, but it is difficult (for me) to figure out 
>>> where your expectations mismatch reality; there are no rules that 
>>> explicitly mention hexcelssp domain, for example: Which "http_access 
>>> allow" rule do you expect those denied requests to match?
>>
>> Sorry, I probably misinterpreted those access.log records: It looks like the denied (TCP_DENIED/407) access is something you actually expect because you want that test request to be authenticated. The client supplies the necessary credentials in the second request, and then that second request fails with a (rather generic) HTTP 500 error code, without contacting the origin server.
>>
>> I am guessing that you are concerned about that second request/transaction rather than the first one.
>>
>> Squid generates HTTP 500 errors for a variety of different reasons. Are there any messages in cache.log (at default debugging level) that correspond to these failing test transactions? If there are none, please add %err_code/%err_detail to your access_log logformat so that Squid logs more information about the problem to access.log (see logformat and access_log directives in squid.conf.documented for details).
>>
>>
>> Thank you,
>>
>> Alex.
>>
>>
>>
>>> Also, does mgr:ipcache cache manager query confirm that Squid has 
>>> read your /etc/hosts file and cached the record you expect it to use?
>>>
>>> Alex.
>>>
>>>
>>>> -------------------------------------------------------------------
>>>> -
>>>> -
>>>> --------------------------------------
>>>> # /var/log/squid/access.log results for internal conflicts
>>>>
>>>> 28/Aug/2024:10:57:17 -0400.234 10.46.49.190 TCP_DENIED/407 4132 
>>>> CONNECT hexcelssp:443 - HIER_NONE/- text/html
>>>> 28/Aug/2024:10:57:17 -0400.253 10.46.49.190 NONE_NONE/500 0 CONNECT
>>>> hexcelssp:443 JPIANA at AD.<DOMAIN>.COM HIER_NONE/- -
>>>> 28/Aug/2024:10:57:17 -0400.380 10.46.49.190 TCP_DENIED/407 4132 
>>>> CONNECT hexcelssp:443 - HIER_NONE/- text/html
>>>> 28/Aug/2024:10:57:17 -0400.399 10.46.49.190 NONE_NONE/500 0 CONNECT
>>>> hexcelssp:443 JPIANA at AD.<DOMAIN>.COM HIER_NONE/- -
>>>> -------------------------------------------------------------------
>>>> -
>>>> -
>>>> --------------------------------------
>>>>
>>>> # acl all src all
>>>>
>>>> acl src_self src 127.0.0.0/8
>>>> acl src_self src 10.46.11.69
>>>>
>>>> acl dst_self dst 127.0.0.0/8
>>>> acl dst_self dst 10.46.11.69
>>>>
>>>> acl from_arc src 10.46.0.0/15
>>>>
>>>> acl local_dst_addr dst 10.0.0.0/8
>>>> acl local_dst_addr dst 172.0.0.0/8
>>>> acl local_dst_addr dst bldg3.<domain>.com acl local_dst_addr dst 
>>>> bldg5.<domain>.com
>>>>
>>>> # these keep URLs of popular local servers from being forwarded acl 
>>>> local_dst_dom dstdomain arcgate
>>>>
>>>> # allow connects to local destinations without authentication # by 
>>>> domain name from URL
>>>> http_access       allow local_dst_dom
>>>> http_reply_access allow local_dst_dom
>>>>
>>>> # by IP address name resolves to
>>>> http_access       allow local_dst_addr
>>>> http_reply_access allow local_dst_addr
>>>>
>>>> # allow trusted hosts without authentication # these are just ip's 
>>>> on the 10.46.11.x network acl authless_src src "/etc/squid/authless_src"
>>>> http_access       allow authless_src
>>>> http_reply_access allow authless_src
>>>> -------------------------------------------------------------------
>>>> -
>>>> -
>>>> --------------------------------------
>>>>
>>>> -----Original Message-----
>>>> From: squid-users <squid-users-bounces at lists.squid-cache.org> On 
>>>> Behalf Of Matus UHLAR - fantomas
>>>> Sent: Wednesday, August 28, 2024 10:47 AM
>>>> To: squid-users at lists.squid-cache.org
>>>> Subject: Re: [squid-users] Unable to access internal resources via 
>>>> hostname
>>>>
>>>> Caution: This email originated from outside of Hexcel. Do not click 
>>>> links or open attachments unless you recognize the sender and know 
>>>> the content is safe.
>>>>
>>>>
>>>> On 28.08.24 14:20, Piana, Josh wrote:
>>>>> Hello Squid Support,
>>>>
>>>> This squid user forum FYI
>>>>
>>>>> We are unable to get to internal resources via hostname but using 
>>>>> the IP address works fine.  Immediately, I thought this was DNS 
>>>>> but when I checked the /etc/resolv.conf/ file it was pointing 
>>>>> correctly to our Windows DNS server and we can ping all devices 
>>>>> using their hostname, just not when browsing to it.  This leads me 
>>>>> to believe something may be wrong with our squid config.
>>>>
>>>> hard to guess without seeing logs or ACL's.
>>>>
>>>>
>>>> --
>>>> Matus UHLAR - fantomas, uhlar at fantomas.sk ; http://www/.
>>>> fantomas.sk%2F&data=05%7C02%7Cjosh.piana%40hexcel.com%7C2db72264caa
>>>> 0
>>>> 4
>>>> f1fd80d08dcc78f9245%7C4248050df19546d5ac9c0c7c52b04cae%7C0%7C0%7C63
>>>> 8
>>>> 6
>>>> 04666668859787%7CUnknown%7CTWFpbGZsb3d8eyJWIjoiMC4wLjAwMDAiLCJQIjoi
>>>> V
>>>> 2
>>>> luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C0%7C%7C%7C&sdata=Z7cUEdNvInD
>>>> A
>>>> J
>>>> PwgQJhXWSK3H2mkAPe4CNcfYJFyy6M%3D&reserved=0
>>>> Warning: I wish NOT to receive e-mail advertising to this address.
>>>> Varovanie: na tuto adresu chcem NEDOSTAVAT akukolvek reklamnu postu.
>>>> It's now safe to throw off your computer.
>>>> _______________________________________________
>>>> squid-users mailing list
>>>> squid-users at lists.squid-cache.org
>>>> https://lis/
>>>> ts.squid-cache.org%2Flistinfo%2Fsquid-users&data=05%7C02%7Cjosh.pia
>>>> n
>>>> a
>>>> %40hexcel.com%7C2db72264caa04f1fd80d08dcc78f9245%7C4248050df19546d5
>>>> a
>>>> c
>>>> 9c0c7c52b04cae%7C0%7C0%7C638604666674016161%7CUnknown%7CTWFpbGZsb3d
>>>> 8
>>>> e
>>>> yJWIjoiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7
>>>> C
>>>> 0
>>>> %7C%7C%7C&sdata=%2B%2B7inZxg2LEmB2KFVWmtn64FG8SwHpEZeEyAjhNClnU%3D&
>>>> r
>>>> e
>>>> served=0 _______________________________________________
>>>> squid-users mailing list
>>>> squid-users at lists.squid-cache.org
>>>> https://lis/
>>>> ts.squid-cache.org%2Flistinfo%2Fsquid-users&data=05%7C02%7Cjosh.pia
>>>> n
>>>> a
>>>> %40hexcel.com%7C2db72264caa04f1fd80d08dcc78f9245%7C4248050df19546d5
>>>> a
>>>> c
>>>> 9c0c7c52b04cae%7C0%7C0%7C638604666674016161%7CUnknown%7CTWFpbGZsb3d
>>>> 8
>>>> e
>>>> yJWIjoiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7
>>>> C
>>>> 0
>>>> %7C%7C%7C&sdata=%2B%2B7inZxg2LEmB2KFVWmtn64FG8SwHpEZeEyAjhNClnU%3D&
>>>> r
>>>> e
>>>> served=0
>>>
>>> _______________________________________________
>>> squid-users mailing list
>>> squid-users at lists.squid-cache.org
>>> https://list/
>>> s.squid-cache.org%2Flistinfo%2Fsquid-users&data=05%7C02%7Cjosh.piana
>>> %
>>> 4
>>> 0hexcel.com%7C2db72264caa04f1fd80d08dcc78f9245%7C4248050df19546d5ac9
>>> c
>>> 0
>>> c7c52b04cae%7C0%7C0%7C638604666674016161%7CUnknown%7CTWFpbGZsb3d8eyJ
>>> W
>>> I
>>> joiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C0%7C
>>> %
>>> 7
>>> C%7C&sdata=%2B%2B7inZxg2LEmB2KFVWmtn64FG8SwHpEZeEyAjhNClnU%3D&reserv
>>> e
>>> d
>>> =0
>>
>> _______________________________________________
>> squid-users mailing list
>> squid-users at lists.squid-cache.org
>> https://list/
>> s.squid-cache.org%2Flistinfo%2Fsquid-users&data=05%7C02%7Cjosh.piana%
>> 4
>> 0hexcel.com%7C6f7f2ea035ca4506507008dcc79c3598%7C4248050df19546d5ac9c
>> 0 
>> c7c52b04cae%7C0%7C0%7C638604720952164544%7CUnknown%7CTWFpbGZsb3d8eyJW
>> I
>> joiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C0%7C%
>> 7
>> C%7C&sdata=RrdtLQu5y421WIi6vjyxj1ZsNRdIn%2FMaKusbjKGoY48%3D&reserved=
>> 0 _______________________________________________
>> squid-users mailing list
>> squid-users at lists.squid-cache.org
>> https://list/
>> s.squid-cache.org%2Flistinfo%2Fsquid-users&data=05%7C02%7Cjosh.piana%
>> 4
>> 0hexcel.com%7C6f7f2ea035ca4506507008dcc79c3598%7C4248050df19546d5ac9c
>> 0 
>> c7c52b04cae%7C0%7C0%7C638604720952164544%7CUnknown%7CTWFpbGZsb3d8eyJW
>> I
>> joiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C0%7C%
>> 7
>> C%7C&sdata=RrdtLQu5y421WIi6vjyxj1ZsNRdIn%2FMaKusbjKGoY48%3D&reserved=
>> 0
>
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> https://list/
> s.squid-cache.org%2Flistinfo%2Fsquid-users&data=05%7C02%7Cjosh.piana%4
> 0hexcel.com%7Ce66ed645b81f49d475de08dcc843a4a6%7C4248050df19546d5ac9c0
> c7c52b04cae%7C0%7C0%7C638605440071382901%7CUnknown%7CTWFpbGZsb3d8eyJWI
> joiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C0%7C%7
> C%7C&sdata=1PZUcTcTx39ZCH76h1BVemyFSPKN6R%2B7%2F%2FJ3XEqoSFQ%3D&reserv
> ed=0 _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> https://list/
> s.squid-cache.org%2Flistinfo%2Fsquid-users&data=05%7C02%7Cjosh.piana%4
> 0hexcel.com%7Ce66ed645b81f49d475de08dcc843a4a6%7C4248050df19546d5ac9c0
> c7c52b04cae%7C0%7C0%7C638605440071382901%7CUnknown%7CTWFpbGZsb3d8eyJWI
> joiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C0%7C%7
> C%7C&sdata=1PZUcTcTx39ZCH76h1BVemyFSPKN6R%2B7%2F%2FJ3XEqoSFQ%3D&reserv
> ed=0

_______________________________________________
squid-users mailing list
squid-users at lists.squid-cache.org
https://lists.squid-cache.org/listinfo/squid-users


From rousskov at measurement-factory.com  Thu Aug 29 18:23:49 2024
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Thu, 29 Aug 2024 14:23:49 -0400
Subject: [squid-users] Unable to access internal resources via hostname
In-Reply-To: <3de704666f56443fbfe762ce56f3e2dd@hexcel.com>
References: <405705ce244447aca1b15385a171fada@hexcel.com>
 <Zs84drvoIpZ1f6DR@fantomas.sk> <58bdfaada3fa46d0938b7346ec04c336@hexcel.com>
 <947309fa-d1fc-4a75-ac49-ea7bc5c5ff12@measurement-factory.com>
 <faffca37-fa59-46ff-80e4-245c37fa90b9@measurement-factory.com>
 <c00942c1c8ab46b5b393d70f32346798@hexcel.com>
 <59274673-47e9-431d-ad45-7fa3a5a8ebca@measurement-factory.com>
 <d063bef52efd4e32a9f9bb27f934e673@hexcel.com>
 <8f29292d-a074-42b0-a793-757782b9d9f9@measurement-factory.com>
 <3de704666f56443fbfe762ce56f3e2dd@hexcel.com>
Message-ID: <c6b9332f-a847-4438-a819-f62199d01f79@measurement-factory.com>

On 2024-08-29 13:08, Piana, Josh wrote:

> In regards to the debugging, do you still want me to do All,9 or is
> All,6 acceptable? I am reading that 9 is... huge.

I want ALL,9. I can usually handle its size. If you cannot, then adjust 
as needed, but my willingness to help will decrease (because it often 
takes me a lot longer to grok partial logs correctly). FWIW, the ALL,9 
snippet size for a single-transaction test is usually quite manageable 
(under 1GB).


> I did eventually find that it was the other log when I browsed /var/log/squid/...
> The log was dated for today, which is good. But I'm not sure how to generate it on purpose?

Squid writes to cache.log as it runs. You can remove the old log while 
Squid does not run and Squid will create a new file, or, better, look 
for "tail" hints on that FAQ page.

When you run your test after configuring (and restarting) Squid with 
"debug_options ALL,9", Squid will write debugging info to its cache.log. 
There are more hints on that FAQ page.


> Just so we're on the same understanding, I've only been using Linux
> for 2 months, this project is my first experience with it. I do
> apologize if I miss a lot of "common sense" stuff. This was tasked
> for me to figure out and I've been having a pretty fun learning
> experience so far.

I sympathize, but do not have the time to offer enough guidance for 
basic sysadmin tasks. Others on the mailing list may be able to help 
with specific questions or, better, see if you can find a local Linux 
person who can help you with this task. If they know what they are 
doing, it should take them less than 30 minutes to produce the requested 
debugging cache.log snippet for the test transaction, even if they have 
never heard about Squid before. And you will learn a few new tricks...


> I'll update those logs and wait for your response to this before
> sending them or sending you a personal drop link.

A link usually works best.


Thank you,

Alex.


> -----Original Message-----
> From: squid-users <squid-users-bounces at lists.squid-cache.org> On Behalf Of Alex Rousskov
> Sent: Thursday, August 29, 2024 12:00 PM
> To: squid-users at lists.squid-cache.org
> Subject: Re: [squid-users] Unable to access internal resources via hostname
> 
> Caution: This email originated from outside of Hexcel. Do not click links or open attachments unless you recognize the sender and know the content is safe.
> 
> 
> On 2024-08-29 10:34, Piana, Josh wrote:
> 
>> I've added the following to my squid.conf file # logformat custom
>> %err_code/%err_detail # access_log daemon:/var/log/squid/access,log
>> custom
> 
> I assume you are using comment character (#) for email presentation purposes (i.e. it does not actually exist in your squid.conf).
> 
> I assume that comma in your access log file name above is a typo that does not actually exist in your squid.conf.
> 
> 
>> I'm not sure ... extra log details were added correctly
> The above access_log configuration should reduce all access.log records to exactly two fields separated by a slash. Clearly, it does not! Thus, you are either not testing with the new configuration file (e.g., you have not fully shut down and then started Squid) or there are other serious problems (e.g., malformed squid.conf that confuses Squid v5). We should solve this mystery before moving any further.
> 
> 
>> I've also enabled debugging options:
>> # debug_options ALL,9
> 
> Thank you. Please note that this debugging info goes into cache.log, not access.log. I trust you have examined your cache.log for errors and warnings _before_ enabling debugging -- finding them among debugging noise can be challenging! ALL,9 debugging is for Squid developers to study.
> 
> My recommendation for the next step remains the same. Look for "The best option" in my previous response.
> 
> 
> HTH,
> 
> Alex.
> 
> 
>> I've also cleaned up our ACL's to better reflect what is going on:
>> # acl src_self src 127.0.0.0/8
>> # acl src_self src 10.46.11.69
>> # acl dst_self dst 127.0.0.0/8
>> # acl dst_self dst 10.46.11.69
>>
>> # acl from_arc src 10.46.0.0/15
>>
>> # acl local_dst_addr dst 10.0.0.0/8
>> # acl local_dst_addr dst 172.0.0.0/8
>>
>> When accessing internal devices via IP, it works.
>> I think this is because of this ACL:
>> # http_access           allow local_dst_addr
>> # http_reply_access     allow local_dst_addr
>>
>> But when I access those same internal devices via hostname, it fails.
>> I'm using this ACL, which I just created a separate file for:
>> acl local_dst_dom dstdomain "etc/squid/local_dst_dom"
>> http_access       allow local_dst_dom
>> http_reply_access allow local_dst_dom
>>
>> I added an ACL file because I figure it will be more extensive than the more simple IP range ACL's.
>> I've added a few local websites to the "local_dst_dom" list, but I'm unable to get this to resolve without using IP.
>>
>> For instance: "https://hexcelssp/" is the name of one of our internal websites for our company.
>> This doesn't load under our current config but "https://10.96.14.174/" DOES load.
>>
>> I've added "hexnt2067" as well, which you can see me testing in the below logs.
>> Again, this DOES work with its IP, 10.96.102.67.
>>
>> I'm not getting a proxy error message when I try to browse to that URL though, we just can't reach it.
>>
>> Here's the log results after enabling debugging and better log features:
>>
>> 29/Aug/2024:10:25:33 -0400.380 10.46.49.190 TCP_DENIED/407 4132
>> CONNECT hexcelssp:443 - HIER_NONE/- text/html
>> 29/Aug/2024:10:25:33 -0400.515 10.46.49.190 NONE_NONE/500 0 CONNECT
>> hexcelssp:443 JPIANA at AD.<DOMAIN>.COM HIER_NONE/- -
>> 29/Aug/2024:10:25:39 -0400.799 10.46.49.190 TCP_TUNNEL/200 11716
>> CONNECT contile.services.mozilla.com:443 JPIANA at AD.<DOMAIN>.COM
>> HIER_DIRECT/34.117.188.166 -
>> 29/Aug/2024:10:26:05 -0400.507 10.46.49.190 TCP_DENIED/407 4474 GET
>> http://hexnt2067/sites/it/help/SitePages/Home.aspx - HIER_NONE/-
>> text/html
>> 29/Aug/2024:10:26:05 -0400.646 10.46.49.190 TCP_MISS/500 8320 GET
>> http://hexnt2067/sites/it/help/SitePages/Home.aspx
>> JPIANA at AD.<DOMAIN>.COM HIER_NONE/- text/html
>> 29/Aug/2024:10:26:05 -0400.735 10.46.49.190 TCP_DENIED/403 4440 GET
>> http://arcga/
>> te2.ad%2F&data=05%7C02%7Cjosh.piana%40hexcel.com%7Ce66ed645b81f49d475d
>> e08dcc843a4a6%7C4248050df19546d5ac9c0c7c52b04cae%7C0%7C0%7C63860544007
>> 1382901%7CUnknown%7CTWFpbGZsb3d8eyJWIjoiMC4wLjAwMDAiLCJQIjoiV2luMzIiLC
>> JBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C0%7C%7C%7C&sdata=xqwHdvSxDiifEZVJALLtcC
>> 6L9VoLptjKTHgDVTNBzLY%3D&reserved=0.<domain>.com:8080/squid-internal-s
>> tatic/icons/SN.png - HIER_NONE/- text/html
>> 29/Aug/2024:10:26:05 -0400.779 10.46.49.190 TCP_MISS_ABORTED/500 0 GET
>> http://hexnt2067/favicon.ico JPIANA at AD.<DOMAIN>.COM HIER_NONE/-
>> text/html
>> 29/Aug/2024:10:27:13 -0400.036 10.46.49.190 TCP_DENIED/407 4474 GET
>> http://hexnt2067/sites/it/help/SitePages/Home.aspx - HIER_NONE/-
>> text/html
>> 29/Aug/2024:10:27:13 -0400.227 10.46.49.190 TCP_MISS/500 8334 GET
>> http://hexnt2067/sites/it/help/SitePages/Home.aspx
>> JPIANA at AD.<DOMAIN>.COM HIER_NONE/- text/html
>> 29/Aug/2024:10:27:13 -0400.302 10.46.49.190 TCP_DENIED/403 4440 GET
>> http://arcga/
>> te2.ad%2F&data=05%7C02%7Cjosh.piana%40hexcel.com%7Ce66ed645b81f49d475d
>> e08dcc843a4a6%7C4248050df19546d5ac9c0c7c52b04cae%7C0%7C0%7C63860544007
>> 1382901%7CUnknown%7CTWFpbGZsb3d8eyJWIjoiMC4wLjAwMDAiLCJQIjoiV2luMzIiLC
>> JBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C0%7C%7C%7C&sdata=xqwHdvSxDiifEZVJALLtcC
>> 6L9VoLptjKTHgDVTNBzLY%3D&reserved=0.<domain>.com:8080/squid-internal-s
>> tatic/icons/SN.png - HIER_NONE/- text/html
>> 29/Aug/2024:10:27:17 -0400.376 10.46.49.190 TCP_DENIED/407 4132
>> CONNECT hexcelssp:443 - HIER_NONE/- text/html
>> 29/Aug/2024:10:27:17 -0400.514 10.46.49.190 NONE_NONE/500 0 CONNECT
>> hexcelssp:443 JPIANA at AD.<DOMAIN>.COM HIER_NONE/- -
>>
>> I'm not sure the debugging and extra log details were added correctly, because these look the same.
>>
>> Thanks,
>> Josh
>>
>>
>> -----Original Message-----
>> From: squid-users <squid-users-bounces at lists.squid-cache.org> On
>> Behalf Of Alex Rousskov
>> Sent: Wednesday, August 28, 2024 4:01 PM
>> To: squid-users at lists.squid-cache.org
>> Subject: Re: [squid-users] Unable to access internal resources via
>> hostname
>>
>> Caution: This email originated from outside of Hexcel. Do not click links or open attachments unless you recognize the sender and know the content is safe.
>>
>>
>> On 2024-08-28 15:25, Piana, Josh wrote:
>>
>>> I now understand that Squid 5.5 ... is actually out of date as well.
>>> I regret installing and working off of this because I jused assumed
>>> the "yum" install command for the Squid distro would give me the most
>>> recent, known-good, software. That's completely on me.
>>
>> Whether yum install installs something production-worthy today is between you and your Linux distro. Squid Project volunteers, including me, do no control what distribution you pick and what that distribution ships. The reason I mentioned v5 support status is to avoid creating a false impression that there are no _other_ (i.e. unreported by you on this thread) problems you may want to know about and to lower your expectations from the level of support you may get from Squid Project volunteers like me.
>>
>> Said that, I doubt the problem you are trying to solve is v5-specific.
>> You may get better diagnostics if you run v6+, and you may receive fewer unusable (with v5) instructions if you run v6+, but the problem is likely to be present in a v6-based setup as well.
>>
>>
>>>   From how I understand it, his intentions for internal users
>>> accessing internal resources, would skip authentication altogether.
>>
>> I assume that the problematic test that you want to fix is done using
>> "internal users". You have already stated that the test is accessing
>> "internal resources". Yet, we see that Squid asks the test client to
>> authenticate (TCP_DENIED/407). Thus,
>>
>> * either local_dst_dom, local_dst_addr, and authless_src ACLs do not
>> match test client transactions
>>
>> * or there is an authentication-triggering directive (e.g., "http_access deny block_user") located above a matching "http_access allow" rule that uses one of those ACLs three.
>>
>> Ideally, we should figure out which http_access rule matches the problematic transaction and triage from there. Unfortunately, Squid does not make that basic task easy. The best option I can think of is for you to share (privately if needed to avoid publishing sensitive info) a pointer to compressed cache.log file collected while reproducing the problem using a single test transaction after setting debug_options to ALL,9. Squid FAQ has a few hints about collecting relevant info:
>> https://wiki/
>> .squid-cache.org%2FSquidFaq%2FBugReporting%23debugging-a-single-transa
>> ction&data=05%7C02%7Cjosh.piana%40hexcel.com%7Ce66ed645b81f49d475de08d
>> cc843a4a6%7C4248050df19546d5ac9c0c7c52b04cae%7C0%7C0%7C638605440071382
>> 901%7CUnknown%7CTWFpbGZsb3d8eyJWIjoiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTi
>> I6Ik1haWwiLCJXVCI6Mn0%3D%7C0%7C%7C%7C&sdata=RDkHh9Xa1Iyi3jC%2FbPGaoJoI
>> %2FPvayueaofn8FRmb4KQ%3D&reserved=0
>>
>> This "unexpected authentication" mystery may not be directly related to the "HTTP 500 error responses" mystery we discussed earlier, but it may help to fix authentication first.
>>
>>
>> HTH,
>>
>> Alex.
>>
>>
>>> Here's a small piece, with his notes included, of why I think that.
>>>
>>> ---------------------------------------------------------------------
>>> -
>>> --------------------------------------------------
>>> #
>>> ---------------------------------------------------------------------
>>> -
>>> ------
>>> # allow without authentication
>>> # these rules allow certain connects without user authentication #
>>> these allow any protocol/method/etc
>>>
>>> #                 ***** IMPORTANT *****
>>> # Adding to these lists also exempts from all content filtering.
>>> # In particular, executables will be allowed to download!
>>> #                 ***** IMPORTANT *****
>>>
>>> # allow connects to local destinations without authentication # by
>>> domain name from URL
>>> http_access       allow local_dst_dom
>>> http_reply_access allow local_dst_dom
>>>
>>> # by IP address name resolves to
>>> http_access       allow local_dst_addr
>>> http_reply_access allow local_dst_addr
>>> ---------------------------------------------------------------------
>>> -
>>> --------------------------------------------------
>>>
>>> The "http_access allow local_dst_dom" and the following reply statement seems to point toward his intentions when writing this.
>>>
>>> The only thing in the old config this was referencing was this, and to me, it doesn't make sense:
>>> # acl local_dst_dom dstdomain arcgate
>>>
>>> It's worth noting that despite how awkward this seems, it DOES work. On the old web proxy we're currently still running live.
>>>
>>> I've gone as far as swapping out just the authentication settings and keeping the entire old config, but it still doesn't work.
>>> I've setup a realmd/sssd/kerberos backend instead of Samba/Windbind that the old server uses.
>>>
>>> To state the issue we're having again - internal resources connecting to other internal resources fails via hostname, but works when using IP. I was able to troubleshoot and conclude DNS was not the issue, as all other aspects are working as intended and they certainly do use DNS. Also pings resolve using hostname from the new squidbox so that implies that DNS is working as expected.
>>>
>>> Ultimately, here's what I think we want, please feel free to poke holes in it:
>>> Allow clients who are accessing other internal rersources to be able to browse to it using its hostname, without needing authentication first.
>>>
>>>
>>> I do intend on adding those parameters you mentioned to the logs so I can get better details within. I also need to look into how to use the debugging features, I'm not familiar with it at all.
>>>
>>> I apologize for the wall of text, looking forward to what you guys have to say about this.
>>>
>>> Thanks,
>>> Josh
>>>
>>> -----Original Message-----
>>> From: squid-users <squid-users-bounces at lists.squid-cache.org> On
>>> Behalf Of Alex Rousskov
>>> Sent: Wednesday, August 28, 2024 2:31 PM
>>> To: squid-users at lists.squid-cache.org
>>> Subject: Re: [squid-users] Unable to access internal resources via
>>> hostname
>>>
>>> Caution: This email originated from outside of Hexcel. Do not click links or open attachments unless you recognize the sender and know the content is safe.
>>>
>>>
>>> On 2024-08-28 14:18, Alex Rousskov wrote:
>>>> On 2024-08-28 11:24, Piana, Josh wrote:
>>>>
>>>>> Here's the log and (I think) relevant ACL's?
>>>>
>>>> According to your access.log, Squid denies problematic CONNECT
>>>> requests with HTTP 407 errors responses. Usually, that means those
>>>> requests match an "http_access deny" rule. Clearly, you expect an
>>>> "allow" outcome instead, but it is difficult (for me) to figure out
>>>> where your expectations mismatch reality; there are no rules that
>>>> explicitly mention hexcelssp domain, for example: Which "http_access
>>>> allow" rule do you expect those denied requests to match?
>>>
>>> Sorry, I probably misinterpreted those access.log records: It looks like the denied (TCP_DENIED/407) access is something you actually expect because you want that test request to be authenticated. The client supplies the necessary credentials in the second request, and then that second request fails with a (rather generic) HTTP 500 error code, without contacting the origin server.
>>>
>>> I am guessing that you are concerned about that second request/transaction rather than the first one.
>>>
>>> Squid generates HTTP 500 errors for a variety of different reasons. Are there any messages in cache.log (at default debugging level) that correspond to these failing test transactions? If there are none, please add %err_code/%err_detail to your access_log logformat so that Squid logs more information about the problem to access.log (see logformat and access_log directives in squid.conf.documented for details).
>>>
>>>
>>> Thank you,
>>>
>>> Alex.
>>>
>>>
>>>
>>>> Also, does mgr:ipcache cache manager query confirm that Squid has
>>>> read your /etc/hosts file and cached the record you expect it to use?
>>>>
>>>> Alex.
>>>>
>>>>
>>>>> -------------------------------------------------------------------
>>>>> -
>>>>> -
>>>>> --------------------------------------
>>>>> # /var/log/squid/access.log results for internal conflicts
>>>>>
>>>>> 28/Aug/2024:10:57:17 -0400.234 10.46.49.190 TCP_DENIED/407 4132
>>>>> CONNECT hexcelssp:443 - HIER_NONE/- text/html
>>>>> 28/Aug/2024:10:57:17 -0400.253 10.46.49.190 NONE_NONE/500 0 CONNECT
>>>>> hexcelssp:443 JPIANA at AD.<DOMAIN>.COM HIER_NONE/- -
>>>>> 28/Aug/2024:10:57:17 -0400.380 10.46.49.190 TCP_DENIED/407 4132
>>>>> CONNECT hexcelssp:443 - HIER_NONE/- text/html
>>>>> 28/Aug/2024:10:57:17 -0400.399 10.46.49.190 NONE_NONE/500 0 CONNECT
>>>>> hexcelssp:443 JPIANA at AD.<DOMAIN>.COM HIER_NONE/- -
>>>>> -------------------------------------------------------------------
>>>>> -
>>>>> -
>>>>> --------------------------------------
>>>>>
>>>>> # acl all src all
>>>>>
>>>>> acl src_self src 127.0.0.0/8
>>>>> acl src_self src 10.46.11.69
>>>>>
>>>>> acl dst_self dst 127.0.0.0/8
>>>>> acl dst_self dst 10.46.11.69
>>>>>
>>>>> acl from_arc src 10.46.0.0/15
>>>>>
>>>>> acl local_dst_addr dst 10.0.0.0/8
>>>>> acl local_dst_addr dst 172.0.0.0/8
>>>>> acl local_dst_addr dst bldg3.<domain>.com acl local_dst_addr dst
>>>>> bldg5.<domain>.com
>>>>>
>>>>> # these keep URLs of popular local servers from being forwarded acl
>>>>> local_dst_dom dstdomain arcgate
>>>>>
>>>>> # allow connects to local destinations without authentication # by
>>>>> domain name from URL
>>>>> http_access       allow local_dst_dom
>>>>> http_reply_access allow local_dst_dom
>>>>>
>>>>> # by IP address name resolves to
>>>>> http_access       allow local_dst_addr
>>>>> http_reply_access allow local_dst_addr
>>>>>
>>>>> # allow trusted hosts without authentication # these are just ip's
>>>>> on the 10.46.11.x network acl authless_src src "/etc/squid/authless_src"
>>>>> http_access       allow authless_src
>>>>> http_reply_access allow authless_src
>>>>> -------------------------------------------------------------------
>>>>> -
>>>>> -
>>>>> --------------------------------------
>>>>>
>>>>> -----Original Message-----
>>>>> From: squid-users <squid-users-bounces at lists.squid-cache.org> On
>>>>> Behalf Of Matus UHLAR - fantomas
>>>>> Sent: Wednesday, August 28, 2024 10:47 AM
>>>>> To: squid-users at lists.squid-cache.org
>>>>> Subject: Re: [squid-users] Unable to access internal resources via
>>>>> hostname
>>>>>
>>>>> Caution: This email originated from outside of Hexcel. Do not click
>>>>> links or open attachments unless you recognize the sender and know
>>>>> the content is safe.
>>>>>
>>>>>
>>>>> On 28.08.24 14:20, Piana, Josh wrote:
>>>>>> Hello Squid Support,
>>>>>
>>>>> This squid user forum FYI
>>>>>
>>>>>> We are unable to get to internal resources via hostname but using
>>>>>> the IP address works fine.  Immediately, I thought this was DNS
>>>>>> but when I checked the /etc/resolv.conf/ file it was pointing
>>>>>> correctly to our Windows DNS server and we can ping all devices
>>>>>> using their hostname, just not when browsing to it.  This leads me
>>>>>> to believe something may be wrong with our squid config.
>>>>>
>>>>> hard to guess without seeing logs or ACL's.
>>>>>
>>>>>
>>>>> --
>>>>> Matus UHLAR - fantomas, uhlar at fantomas.sk ; http://www/.
>>>>> fantomas.sk%2F&data=05%7C02%7Cjosh.piana%40hexcel.com%7C2db72264caa
>>>>> 0
>>>>> 4
>>>>> f1fd80d08dcc78f9245%7C4248050df19546d5ac9c0c7c52b04cae%7C0%7C0%7C63
>>>>> 8
>>>>> 6
>>>>> 04666668859787%7CUnknown%7CTWFpbGZsb3d8eyJWIjoiMC4wLjAwMDAiLCJQIjoi
>>>>> V
>>>>> 2
>>>>> luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C0%7C%7C%7C&sdata=Z7cUEdNvInD
>>>>> A
>>>>> J
>>>>> PwgQJhXWSK3H2mkAPe4CNcfYJFyy6M%3D&reserved=0
>>>>> Warning: I wish NOT to receive e-mail advertising to this address.
>>>>> Varovanie: na tuto adresu chcem NEDOSTAVAT akukolvek reklamnu postu.
>>>>> It's now safe to throw off your computer.
>>>>> _______________________________________________
>>>>> squid-users mailing list
>>>>> squid-users at lists.squid-cache.org
>>>>> https://lis/
>>>>> ts.squid-cache.org%2Flistinfo%2Fsquid-users&data=05%7C02%7Cjosh.pia
>>>>> n
>>>>> a
>>>>> %40hexcel.com%7C2db72264caa04f1fd80d08dcc78f9245%7C4248050df19546d5
>>>>> a
>>>>> c
>>>>> 9c0c7c52b04cae%7C0%7C0%7C638604666674016161%7CUnknown%7CTWFpbGZsb3d
>>>>> 8
>>>>> e
>>>>> yJWIjoiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7
>>>>> C
>>>>> 0
>>>>> %7C%7C%7C&sdata=%2B%2B7inZxg2LEmB2KFVWmtn64FG8SwHpEZeEyAjhNClnU%3D&
>>>>> r
>>>>> e
>>>>> served=0 _______________________________________________
>>>>> squid-users mailing list
>>>>> squid-users at lists.squid-cache.org
>>>>> https://lis/
>>>>> ts.squid-cache.org%2Flistinfo%2Fsquid-users&data=05%7C02%7Cjosh.pia
>>>>> n
>>>>> a
>>>>> %40hexcel.com%7C2db72264caa04f1fd80d08dcc78f9245%7C4248050df19546d5
>>>>> a
>>>>> c
>>>>> 9c0c7c52b04cae%7C0%7C0%7C638604666674016161%7CUnknown%7CTWFpbGZsb3d
>>>>> 8
>>>>> e
>>>>> yJWIjoiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7
>>>>> C
>>>>> 0
>>>>> %7C%7C%7C&sdata=%2B%2B7inZxg2LEmB2KFVWmtn64FG8SwHpEZeEyAjhNClnU%3D&
>>>>> r
>>>>> e
>>>>> served=0
>>>>
>>>> _______________________________________________
>>>> squid-users mailing list
>>>> squid-users at lists.squid-cache.org
>>>> https://list/
>>>> s.squid-cache.org%2Flistinfo%2Fsquid-users&data=05%7C02%7Cjosh.piana
>>>> %
>>>> 4
>>>> 0hexcel.com%7C2db72264caa04f1fd80d08dcc78f9245%7C4248050df19546d5ac9
>>>> c
>>>> 0
>>>> c7c52b04cae%7C0%7C0%7C638604666674016161%7CUnknown%7CTWFpbGZsb3d8eyJ
>>>> W
>>>> I
>>>> joiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C0%7C
>>>> %
>>>> 7
>>>> C%7C&sdata=%2B%2B7inZxg2LEmB2KFVWmtn64FG8SwHpEZeEyAjhNClnU%3D&reserv
>>>> e
>>>> d
>>>> =0
>>>
>>> _______________________________________________
>>> squid-users mailing list
>>> squid-users at lists.squid-cache.org
>>> https://list/
>>> s.squid-cache.org%2Flistinfo%2Fsquid-users&data=05%7C02%7Cjosh.piana%
>>> 4
>>> 0hexcel.com%7C6f7f2ea035ca4506507008dcc79c3598%7C4248050df19546d5ac9c
>>> 0
>>> c7c52b04cae%7C0%7C0%7C638604720952164544%7CUnknown%7CTWFpbGZsb3d8eyJW
>>> I
>>> joiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C0%7C%
>>> 7
>>> C%7C&sdata=RrdtLQu5y421WIi6vjyxj1ZsNRdIn%2FMaKusbjKGoY48%3D&reserved=
>>> 0 _______________________________________________
>>> squid-users mailing list
>>> squid-users at lists.squid-cache.org
>>> https://list/
>>> s.squid-cache.org%2Flistinfo%2Fsquid-users&data=05%7C02%7Cjosh.piana%
>>> 4
>>> 0hexcel.com%7C6f7f2ea035ca4506507008dcc79c3598%7C4248050df19546d5ac9c
>>> 0
>>> c7c52b04cae%7C0%7C0%7C638604720952164544%7CUnknown%7CTWFpbGZsb3d8eyJW
>>> I
>>> joiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C0%7C%
>>> 7
>>> C%7C&sdata=RrdtLQu5y421WIi6vjyxj1ZsNRdIn%2FMaKusbjKGoY48%3D&reserved=
>>> 0
>>
>> _______________________________________________
>> squid-users mailing list
>> squid-users at lists.squid-cache.org
>> https://list/
>> s.squid-cache.org%2Flistinfo%2Fsquid-users&data=05%7C02%7Cjosh.piana%4
>> 0hexcel.com%7Ce66ed645b81f49d475de08dcc843a4a6%7C4248050df19546d5ac9c0
>> c7c52b04cae%7C0%7C0%7C638605440071382901%7CUnknown%7CTWFpbGZsb3d8eyJWI
>> joiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C0%7C%7
>> C%7C&sdata=1PZUcTcTx39ZCH76h1BVemyFSPKN6R%2B7%2F%2FJ3XEqoSFQ%3D&reserv
>> ed=0 _______________________________________________
>> squid-users mailing list
>> squid-users at lists.squid-cache.org
>> https://list/
>> s.squid-cache.org%2Flistinfo%2Fsquid-users&data=05%7C02%7Cjosh.piana%4
>> 0hexcel.com%7Ce66ed645b81f49d475de08dcc843a4a6%7C4248050df19546d5ac9c0
>> c7c52b04cae%7C0%7C0%7C638605440071382901%7CUnknown%7CTWFpbGZsb3d8eyJWI
>> joiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C0%7C%7
>> C%7C&sdata=1PZUcTcTx39ZCH76h1BVemyFSPKN6R%2B7%2F%2FJ3XEqoSFQ%3D&reserv
>> ed=0
> 
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> https://lists.squid-cache.org/listinfo/squid-users
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> https://lists.squid-cache.org/listinfo/squid-users



From taku0919.taku at gmail.com  Fri Aug 30 02:28:11 2024
From: taku0919.taku at gmail.com (=?UTF-8?B?44Gr44Gw?=)
Date: Fri, 30 Aug 2024 11:28:11 +0900
Subject: [squid-users] Questions about Squid configuration
In-Reply-To: <add1024b-da05-46ba-9574-fd8048ec4fa1@measurement-factory.com>
References: <CAK0+96e5Wpq3LpE4pf8k38nUpsmg+nyyocbOmnXS6=fqR+3C0g@mail.gmail.com>
 <add1024b-da05-46ba-9574-fd8048ec4fa1@measurement-factory.com>
Message-ID: <CAK0+96eD+B2c_Fa3TpjE5E89WPsY-VaNadDSHK1ritgemkjrTw@mail.gmail.com>

Alex, people in the Suquid community
I really appreciate your cooperation.

I am continuing to verify this based on the responses I have received.

With the newly reviewed configuration in the attachment,
I was able to confirm that any one of the SNI, IP, or Host in the
request is incorrect (not whitelist allowed)
and Squid will correctly check and return a 409 Conflict.

However, I found the following statement in the following official document
https://www.squid-cache.org/Doc/config/host_verify_strict/

? * The host names (domain or IP) must be identical,
? but valueless or missing Host header disables all checks.
? For the two host names to match, both must be either IP
? or FQDN.

So I ran an additional validation with an empty Host value, and the
request succeeded for a domain that was not in the whitelist.
The curl command for verification is below, and as before, only
.pypi.org is allowed in the whitelist.

date;curl https://www.yahoo.co.jp/ -H "Host:" -v --cacert squid.crt -k

Is it possible for Squid to prevent such requests as well?
Are there other patterns of requests that cannot be prevented by the
current setup?
Please advise if you have any information.

2024?8?8?(?) 21:33 Alex Rousskov <rousskov at measurement-factory.com>:
>
> On 2024-08-06 20:59, ?? wrote:
>
> > When using Squid transparently, is it possible to control the
> > whitelist of the domain to connect to and inspect the Host field in
> > the request header together?
>
> Short answer: Yes.
>
>
> > According to the verification results, the Host field can be inspected
> > by "host_verify_strict on" in squid-transparent.conf, but it seems
> > that the whitelist is not controlled.
>
> AFAICT, the configuration you have shared allows all banned[1] traffic
> to/through https_port. For the problematic test case #5:
>
> All these http_access rules do _not_ match:
>
> > http_access allow localnet whitelist
> > http_access deny localnet whitelist_https !https_port
> > http_access deny localnet whitelist_transparent_https !https_port
>
>
> And then this next rule matches and allows traffic through:
>
> > http_access allow https_port
>
>
> This last http_access rule is not reached:
>
> > http_access deny all
>
>
> N.B. The above analysis assumes that your https_port ACL is explicitly
> defined in your squid.conf to match all traffic received at https_port.
> If you do not have such an ACL defined, then you need to fix that
> problem as well. I recommend naming ACLs differently from directive
> names (e.g., "toHttpsPort" rather than "https_port").
>
>
> Please note that Squid v4 is not supported by the Squid Project and is
> very buggy. I recommend using Squid v6 or later.
>
>
> HTH,
>
> Alex.
> [1] Here, "banned" means "_not_ matching whitelist ACL".
>
>
> > ?Configuration Details
> > ?squid-transparent.conf?Excerpts?
> > #Whitelist
> > acl whitelist dstdomain "/etc/squid/whitelist"
> > acl whitelist dstdomain "/etc/squid/whitelist_transparent"
> > acl whitelist_https dstdomain "/etc/squid/whitelist_https"
> > acl whitelist_transparent_https dstdomain
> > "/etc/squid/whitelist_transparent_https"
> >
> > proxy_protocol_access allow localnet
> > proxy_protocol_access deny all
> > http_access allow localnet whitelist
> > http_access deny localnet whitelist_https !https_port
> > http_access deny localnet whitelist_transparent_https !https_port
> >
> > # Handling HTTP requests
> > http_port 3129 intercept
> > # Handling HTTPS requests
> > https_port 3130 intercept tcpkeepalive=60,30,3 ssl-bump
> > generate-host-certificates=on dynamic_cert_mem_cache_size=20MB
> > tls-cert=/etc/squid/ssl/squid.crt tls-key=/etc/squid/ssl/squid.key
> > cipher=HIGH:MEDIUM:!LOW:!RC4:!SEED:!IDEA:!3DES:!MD5:!EXP:!PSK:!DSS
> > options=NO_TLSv1,NO_SSLv3,SINGLE_DH_USE,SINGLE_ECDH_USE
> > tls-dh=prime256v1:/etc/squid/ssl/bump_dhparam.pem
> > # Start up for squid process
> > http_port 3131
> > http_access allow https_port
> > acl allowed_https_sites ssl::server_name "/etc/squid/whitelist"
> > acl allowed_https_sites ssl::server_name "/etc/squid/whitelist_transparent"
> > acl allowed_https_sites ssl::server_name "/etc/squid/whitelist_https"
> > acl allowed_https_sites ssl::server_name
> > "/etc/squid/whitelist_transparent_https"
> >
> > http_access deny all
> >
> > # strict setting
> > host_verify_strict on
> >
> > # SSL_BUMP
> > sslcrtd_program /usr/lib64/squid/security_file_certgen -s
> > /var/lib/squid/ssl_db -M 20MB
> > acl step1 at_step SslBump1
> > acl step2 at_step SslBump2
> > acl step3 at_step SslBump3
> >
> > ssl_bump bump all
>
>
> > ?Verification of Settings
> > I ran the curl command from each of the client environments that use Squid.
> > 1. if SNI, Destination IP, and HeaderHost are correct, the user should
> > be able to connect to pypi.org
> > Command:
> > date;curl https://pypi.org/ -v --cacert squid_2.crt -k
> > Result: OK
> >
> > 2. rejection of communication to pypi.org if SNI is correct but
> > destination IP and HeaderHost are incorrect
> > Command:
> > date;curl https://pypi.org/ --resolve pypi.org:443:182.22.24.252 -H
> > "Host: www.yahoo.co.jp"  -v --cacert squid_2.crt -k
> > Result: OK (409 Conflict is returned)
> >
> > 3. rejection of communication to pypi.org if SNI and destination IP
> > are correct and HeaderHost is incorrect
> > Command:
> > date;curl https://pypi.org/ -H "Host: www.yahoo.co.jp" -v --cacert
> > squid_2.crt -k
> > Result: OK (409 Confilic returned)
> >
> > 4. rejection of communication to pypi.org if SNI and HeaderHost are
> > correct but destination IP is incorrect
> > Command:
> > date;curl https://pypi.org/ --resolve pypi.org:443:182.22.24.252 -v
> > --cacert squid_2.crt -k
> > Result: OK (409 Confilic returned)
> >
> > 5. if SNI, destination IP, and HeaderHost are all invalid (yahoo.co.jp
> > not registered in whitelist), communication will be rejected
> > Command:
> > date;curl https://yahoo.co.jp/ -v --cacert squid_2.crt -k
> > Result: NG (301 Moved Permanently is returned, but it appears that the
> > communication is reaching yahoo.co.jp)
>
>
>
>
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> https://lists.squid-cache.org/listinfo/squid-users
-------------- next part --------------
A non-text attachment was scrubbed...
Name: squid-transparent.conf
Type: application/octet-stream
Size: 3409 bytes
Desc: not available
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20240830/dbd8641e/attachment.obj>

From m.egert at sunsetfolien.de  Fri Aug 30 12:35:05 2024
From: m.egert at sunsetfolien.de (Michael Egert)
Date: Fri, 30 Aug 2024 12:35:05 +0000
Subject: [squid-users] negotiate_kerberos_auth not working anymore
Message-ID: <FR5P281MB4798BD5226BC5558D879FAE7FA972@FR5P281MB4798.DEUP281.PROD.OUTLOOK.COM>

Hello all,

I have a little problem with this helper, it worked fine for a while and then suddely stopped working.

I can call a kerberos ticket when using kinit



root at sv-asa-proxy:/var/log/squid# kinit -kt /etc/squid/sv-asa-proxy.keytab HTTP/sv-asa-proxy at ASA.LOCAL
root at sv-asa-proxy:/var/log/squid# klist
Ticket cache: FILE:/tmp/krb5cc_0
Default principal: HTTP/sv-asa-proxy at ASA.LOCAL

Valid starting     Expires            Service principal
08/30/24 14:24:27  08/31/24 00:24:27  krbtgt/ASA.LOCAL at ASA.LOCAL
        renew until 08/31/24 14:24:27
root at sv-asa-proxy:/var/log/squid#


so - this works well

this is a part of my squid.conf:

auth_param negotiate program /usr/lib/squid/negotiate_kerberos_auth -k /etc/squid/sv-asa-proxy.keytab -s HTTP/sv-asa-proxy at ASA.LOCAL<mailto:HTTP/sv-asa-proxy at ASA.LOCAL>  -r -d
auth_parauth_param negotiate children 100 startup=0 idle=10
auth_param negotiate keep_alive on
acl kerb-auth proxy_auth REQUIRED

i also tried

auth_param negotiate program /usr/lib/squid/negotiate_kerberos_auth -k /etc/squid/sv-asa-proxy.keytab -s HTTP/sv-asa-proxy at ASA.LOCAL  -s GSS_C_NO_NAME -r -d

no success...

when i try

root at sv-asa-proxy:/var/log/squid# /usr/lib/squid/negotiate_kerberos_auth_test -k /etc/squid/sv-asa-proxy.keytab -s HTTP/sv-asa-proxy.asa.local at ASA.LOCAL -s GSS_C_NO_NAME -d -i
2024/08/30 14:28:35| negotiate_kerberos_auth_test: gss_init_sec_context() failed: Unspecified GSS failure.  Minor code may provide more information. Server not found in Kerberos database
Token: NULL
root at sv-asa-proxy:/var/log/squid#

and when i try this one:

root at sv-asa-proxy:/var/log/squid# /usr/lib/squid/negotiate_kerberos_auth -k /etc/squid/sv-asa-proxy.keytab -s HTTP/sv-asa-proxy.asa.local at ASA.LOCAL<mailto:HTTP/sv-asa-proxy.asa.local at ASA.LOCAL> -d -r
negotiate_kerberos_auth.cc(489): pid=5286 :2024/08/30 14:29:25| negotiate_kerberos_auth: INFO: Starting version 3.1.0sq
negotiate_kerberos_auth.cc(548): pid=5286 :2024/08/30 14:29:25| negotiate_kerberos_auth: INFO: Setting keytab to /etc/squid/sv-asa-proxy.keytab
negotiate_kerberos_auth.cc(571): pid=5286 :2024/08/30 14:29:25| negotiate_kerberos_auth: INFO: Changed keytab to MEMORY:negotiate_kerberos_auth_5286
admin at ASA.LOCAL<mailto:admin at ASA.LOCAL>
negotiate_kerberos_auth.cc(612): pid=5286 :2024/08/30 14:30:06| negotiate_kerberos_auth: DEBUG: Got 'admin at ASA.LOCAL' from squid (length: 15).
negotiate_kerberos_auth.cc(661): pid=5286 :2024/08/30 14:30:06| negotiate_kerberos_auth: ERROR: Invalid request [admin at ASA.LOCAL]
BH Invalid request

And the log:

2024/08/30 14:31:25 kid1| Set Current Directory to /var/spool/squid
2024/08/30 14:31:25 kid1| Starting Squid Cache version 5.9 for x86_64-pc-linux-gnu...
2024/08/30 14:31:25 kid1| Service Name: squid
2024/08/30 14:31:25 kid1| Process ID 5309
2024/08/30 14:31:25 kid1| Process Roles: worker
2024/08/30 14:31:25 kid1| With 1024 file descriptors available
2024/08/30 14:31:25 kid1| Initializing IP Cache...
2024/08/30 14:31:25 kid1| DNS Socket created at [::], FD 9
2024/08/30 14:31:25 kid1| DNS Socket created at 0.0.0.0, FD 10
2024/08/30 14:31:25 kid1| Adding nameserver 192.168.40.1 from squid.conf
2024/08/30 14:31:25 kid1| Adding nameserver 192.168.40.2 from squid.conf
2024/08/30 14:31:25 kid1| helperOpenServers: Starting 0/100 'negotiate_kerberos_auth' processes
2024/08/30 14:31:25 kid1| helperStatefulOpenServers: No 'negotiate_kerberos_auth' processes needed.
2024/08/30 14:31:25 kid1| helperOpenServers: Starting 0/25 'ext_kerberos_ldap_group_acl' processes
2024/08/30 14:31:25 kid1| helperOpenServers: No 'ext_kerberos_ldap_group_acl' processes needed.
2024/08/30 14:31:25 kid1| Logfile: opening log daemon:/var/log/squid/access.log
2024/08/30 14:31:25 kid1| Logfile Daemon: opening log /var/log/squid/access.log
2024/08/30 14:31:26 kid1| Unlinkd pipe opened on FD 16
2024/08/30 14:31:26 kid1| Local cache digest enabled; rebuild/rewrite every 3600/3600 sec
2024/08/30 14:31:26 kid1| Logfile: opening log daemon:/var/log/squid/store.log
2024/08/30 14:31:26 kid1| Logfile Daemon: opening log /var/log/squid/store.log
2024/08/30 14:31:26 kid1| Swap maxSize 20480000 + 2097152 KB, estimated 1736704 objects
2024/08/30 14:31:26 kid1| Target number of buckets: 86835
2024/08/30 14:31:26 kid1| Using 131072 Store buckets
2024/08/30 14:31:26 kid1| Max Mem  size: 2097152 KB
2024/08/30 14:31:26 kid1| Max Swap size: 20480000 KB
2024/08/30 14:31:26 kid1| Rebuilding storage in /var/cache/squid (clean log)
2024/08/30 14:31:26 kid1| Using Least Load store dir selection
2024/08/30 14:31:26 kid1| Set Current Directory to /var/spool/squid
2024/08/30 14:31:26 kid1| Finished loading MIME types and icons.
2024/08/30 14:31:26 kid1| HTCP Disabled.
2024/08/30 14:31:26 kid1| Pinger socket opened on FD 23
2024/08/30 14:31:26 kid1| Squid plugin modules loaded: 0
2024/08/30 14:31:26 kid1| Adaptation support is off.
2024/08/30 14:31:26 kid1| Accepting HTTP Socket connections at conn3 local=[::]:8080 remote=[::] FD 21 flags=9
2024/08/30 14:31:26 kid1| Done reading /var/cache/squid swaplog (50 entries)
2024/08/30 14:31:26 kid1| Finished rebuilding storage from disk.
2024/08/30 14:31:26 kid1|        50 Entries scanned
2024/08/30 14:31:26 kid1|         0 Invalid entries.
2024/08/30 14:31:26 kid1|         0 With invalid flags.
2024/08/30 14:31:26 kid1|        50 Objects loaded.
2024/08/30 14:31:26 kid1|         0 Objects expired.
2024/08/30 14:31:26 kid1|         0 Objects cancelled.
2024/08/30 14:31:26 kid1|         0 Duplicate URLs purged.
2024/08/30 14:31:26 kid1|         0 Swapfile clashes avoided.
2024/08/30 14:31:26 kid1|   Took 0.01 seconds (5303.35 objects/sec).
2024/08/30 14:31:26 kid1| Beginning Validation Procedure
2024/08/30 14:31:26 kid1|   Completed Validation Procedure
2024/08/30 14:31:26 kid1|   Validated 50 Entries
2024/08/30 14:31:26 kid1|   store_swap_size = 732.00 KB
2024/08/30 14:31:26| pinger: Initialising ICMP pinger ...
2024/08/30 14:31:26| pinger: ICMP socket opened.
2024/08/30 14:31:26| pinger: ICMPv6 socket opened
2024/08/30 14:31:27 kid1| storeLateRelease: released 0 objects

Do you have any suggstions for me?

Kind regards

Michael

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20240830/fba8bd0a/attachment.htm>

From rousskov at measurement-factory.com  Fri Aug 30 13:27:46 2024
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Fri, 30 Aug 2024 09:27:46 -0400
Subject: [squid-users] Questions about Squid configuration
In-Reply-To: <CAK0+96eD+B2c_Fa3TpjE5E89WPsY-VaNadDSHK1ritgemkjrTw@mail.gmail.com>
References: <CAK0+96e5Wpq3LpE4pf8k38nUpsmg+nyyocbOmnXS6=fqR+3C0g@mail.gmail.com>
 <add1024b-da05-46ba-9574-fd8048ec4fa1@measurement-factory.com>
 <CAK0+96eD+B2c_Fa3TpjE5E89WPsY-VaNadDSHK1ritgemkjrTw@mail.gmail.com>
Message-ID: <c6889a69-d559-4180-ae27-5083e850329b@measurement-factory.com>

On 2024-08-29 22:28, ?? wrote:

> With the newly reviewed configuration in the attachment

OT: Please note that your configuration does not follow the recommended 
http_access rules order template in squid.conf.default and might, 
depending on your deployment environment, allow Squid to be used for 
attacks on 3rd party resources (e.g., ssh services). This observation is 
not related to your primary question and your "ban certain sites" goal. 
Following suggestions at the end of this email should fix this problem.


> I found the following statement in the following official document
> https://www.squid-cache.org/Doc/config/host_verify_strict/
> 
> ? * The host names (domain or IP) must be identical,
> ? but valueless or missing Host header disables all checks.
> 
> So I ran an additional validation with an empty Host value, and the
> request succeeded for a domain that was not in the whitelist.
> The curl command for verification is below, and as before, only
> .pypi.org is allowed in the whitelist.
> 
> date;curl https://www.yahoo.co.jp/ -H "Host:" -v --cacert squid.crt -k
> 
> Is it possible for Squid to prevent such requests as well?

Yes, a req_header ACL should be able to detect such requests (i.e. 
requests without a Host header or with an empty Host header value). 
However, I suspect that "missing Host" is _not_ the problem you should 
be solving (as detailed below).


> I was able to confirm that any one of the SNI, IP, or Host in the
> request is incorrect (not whitelist allowed)
> and Squid will correctly check and return a 409 Conflict.

IMHO, you should target/validate a different set of goals/conditions:

* A valid request targeting a banned site should be denied (HTTP 403 
response, %Ss=TCP_DENIED, %err_code=ERR_ACCESS_DENIED). This denial 
should be triggered by an "http_access deny" rule, preferably an 
explicit one. This denial will _not_ happen (and the request will 
instead be forwarded to the banned site it targets) if you replace all 
your http_access rules with a single "http_access allow all" line. This 
denial does not depend on host_verify_strict and underlying code.

* An invalid request should be rejected (HTTP 4xx response). This 
includes, but is not limited to, host_verify_strict-driven rejections. 
This rejection should happen even if you replace all your http_access 
rules with a single "http_access allow all" line.

AFAICT, your current configuration does not reach "deny valid requests 
targeting banned sites" goal while your question implies that you are 
incorrectly relying on host_verify_strict to perform that denial.


I recommend the following:

1. Remove all of your current http_access rules. Keep ACLs. Perform 
host_verify_strict and access tests to confirm that all valid requests 
are denied and all invalid requests are rejected. If necessary, ask 
questions, file bug reports, patch Squid, and/or adjust your 
configuration to pass this test.

2. Copy http_access rules, with comments, from generated 
squid.conf.default. Insert your own access rules in the location marked 
by "INSERT YOUR OWN RULE(S) HERE" comment. Perform host_verify_strict 
and access tests to confirm that all valid requests to banned sites are 
denied, all other valid requests are allowed, and all invalid requests 
are rejected. If necessary, ask questions, file bug reports, patch 
Squid, and/or adjust your configuration to pass this test.


HTH,

Alex.


> 2024?8?8?(?) 21:33 Alex Rousskov <rousskov at measurement-factory.com>:
>>
>> On 2024-08-06 20:59, ?? wrote:
>>
>>> When using Squid transparently, is it possible to control the
>>> whitelist of the domain to connect to and inspect the Host field in
>>> the request header together?
>>
>> Short answer: Yes.
>>
>>
>>> According to the verification results, the Host field can be inspected
>>> by "host_verify_strict on" in squid-transparent.conf, but it seems
>>> that the whitelist is not controlled.
>>
>> AFAICT, the configuration you have shared allows all banned[1] traffic
>> to/through https_port. For the problematic test case #5:
>>
>> All these http_access rules do _not_ match:
>>
>>> http_access allow localnet whitelist
>>> http_access deny localnet whitelist_https !https_port
>>> http_access deny localnet whitelist_transparent_https !https_port
>>
>>
>> And then this next rule matches and allows traffic through:
>>
>>> http_access allow https_port
>>
>>
>> This last http_access rule is not reached:
>>
>>> http_access deny all
>>
>>
>> N.B. The above analysis assumes that your https_port ACL is explicitly
>> defined in your squid.conf to match all traffic received at https_port.
>> If you do not have such an ACL defined, then you need to fix that
>> problem as well. I recommend naming ACLs differently from directive
>> names (e.g., "toHttpsPort" rather than "https_port").
>>
>>
>> Please note that Squid v4 is not supported by the Squid Project and is
>> very buggy. I recommend using Squid v6 or later.
>>
>>
>> HTH,
>>
>> Alex.
>> [1] Here, "banned" means "_not_ matching whitelist ACL".
>>
>>
>>> ?Configuration Details
>>> ?squid-transparent.conf?Excerpts?
>>> #Whitelist
>>> acl whitelist dstdomain "/etc/squid/whitelist"
>>> acl whitelist dstdomain "/etc/squid/whitelist_transparent"
>>> acl whitelist_https dstdomain "/etc/squid/whitelist_https"
>>> acl whitelist_transparent_https dstdomain
>>> "/etc/squid/whitelist_transparent_https"
>>>
>>> proxy_protocol_access allow localnet
>>> proxy_protocol_access deny all
>>> http_access allow localnet whitelist
>>> http_access deny localnet whitelist_https !https_port
>>> http_access deny localnet whitelist_transparent_https !https_port
>>>
>>> # Handling HTTP requests
>>> http_port 3129 intercept
>>> # Handling HTTPS requests
>>> https_port 3130 intercept tcpkeepalive=60,30,3 ssl-bump
>>> generate-host-certificates=on dynamic_cert_mem_cache_size=20MB
>>> tls-cert=/etc/squid/ssl/squid.crt tls-key=/etc/squid/ssl/squid.key
>>> cipher=HIGH:MEDIUM:!LOW:!RC4:!SEED:!IDEA:!3DES:!MD5:!EXP:!PSK:!DSS
>>> options=NO_TLSv1,NO_SSLv3,SINGLE_DH_USE,SINGLE_ECDH_USE
>>> tls-dh=prime256v1:/etc/squid/ssl/bump_dhparam.pem
>>> # Start up for squid process
>>> http_port 3131
>>> http_access allow https_port
>>> acl allowed_https_sites ssl::server_name "/etc/squid/whitelist"
>>> acl allowed_https_sites ssl::server_name "/etc/squid/whitelist_transparent"
>>> acl allowed_https_sites ssl::server_name "/etc/squid/whitelist_https"
>>> acl allowed_https_sites ssl::server_name
>>> "/etc/squid/whitelist_transparent_https"
>>>
>>> http_access deny all
>>>
>>> # strict setting
>>> host_verify_strict on
>>>
>>> # SSL_BUMP
>>> sslcrtd_program /usr/lib64/squid/security_file_certgen -s
>>> /var/lib/squid/ssl_db -M 20MB
>>> acl step1 at_step SslBump1
>>> acl step2 at_step SslBump2
>>> acl step3 at_step SslBump3
>>>
>>> ssl_bump bump all
>>
>>
>>> ?Verification of Settings
>>> I ran the curl command from each of the client environments that use Squid.
>>> 1. if SNI, Destination IP, and HeaderHost are correct, the user should
>>> be able to connect to pypi.org
>>> Command:
>>> date;curl https://pypi.org/ -v --cacert squid_2.crt -k
>>> Result: OK
>>>
>>> 2. rejection of communication to pypi.org if SNI is correct but
>>> destination IP and HeaderHost are incorrect
>>> Command:
>>> date;curl https://pypi.org/ --resolve pypi.org:443:182.22.24.252 -H
>>> "Host: www.yahoo.co.jp"  -v --cacert squid_2.crt -k
>>> Result: OK (409 Conflict is returned)
>>>
>>> 3. rejection of communication to pypi.org if SNI and destination IP
>>> are correct and HeaderHost is incorrect
>>> Command:
>>> date;curl https://pypi.org/ -H "Host: www.yahoo.co.jp" -v --cacert
>>> squid_2.crt -k
>>> Result: OK (409 Confilic returned)
>>>
>>> 4. rejection of communication to pypi.org if SNI and HeaderHost are
>>> correct but destination IP is incorrect
>>> Command:
>>> date;curl https://pypi.org/ --resolve pypi.org:443:182.22.24.252 -v
>>> --cacert squid_2.crt -k
>>> Result: OK (409 Confilic returned)
>>>
>>> 5. if SNI, destination IP, and HeaderHost are all invalid (yahoo.co.jp
>>> not registered in whitelist), communication will be rejected
>>> Command:
>>> date;curl https://yahoo.co.jp/ -v --cacert squid_2.crt -k
>>> Result: NG (301 Moved Permanently is returned, but it appears that the
>>> communication is reaching yahoo.co.jp)
>>
>>
>>
>>
>> _______________________________________________
>> squid-users mailing list
>> squid-users at lists.squid-cache.org
>> https://lists.squid-cache.org/listinfo/squid-users



From Josh.Piana at hexcel.com  Fri Aug 30 14:19:57 2024
From: Josh.Piana at hexcel.com (Piana, Josh)
Date: Fri, 30 Aug 2024 14:19:57 +0000
Subject: [squid-users] Unable to access internal resources via hostname
In-Reply-To: <c6b9332f-a847-4438-a819-f62199d01f79@measurement-factory.com>
References: <405705ce244447aca1b15385a171fada@hexcel.com>
 <Zs84drvoIpZ1f6DR@fantomas.sk> <58bdfaada3fa46d0938b7346ec04c336@hexcel.com>
 <947309fa-d1fc-4a75-ac49-ea7bc5c5ff12@measurement-factory.com>
 <faffca37-fa59-46ff-80e4-245c37fa90b9@measurement-factory.com>
 <c00942c1c8ab46b5b393d70f32346798@hexcel.com>
 <59274673-47e9-431d-ad45-7fa3a5a8ebca@measurement-factory.com>
 <d063bef52efd4e32a9f9bb27f934e673@hexcel.com>
 <8f29292d-a074-42b0-a793-757782b9d9f9@measurement-factory.com>
 <3de704666f56443fbfe762ce56f3e2dd@hexcel.com>
 <c6b9332f-a847-4438-a819-f62199d01f79@measurement-factory.com>
Message-ID: <6507ec1d399c4024a9fdc8d94ad17efa@hexcel.com>

Alex, 

If its not one issue its another. Now I can't seem to generate a cache log file for to to assist with further troubleshooting. 

I've restarted squid and used "squid -k reconfigure" a few times, verified debugging is enabled and set to "All,9", and I don't have any special rules in my config to point the cache log somewhere else. 

I'm not sure what I'm doing wrong with it. I did remove the file it created yesterday, because I wanted to make sure we had a fresh one to write to and send. I was thinking it may need explicit permissions to write the logs here but it didn't need that before and I'm not getting any errors related to it. The "access.log" file is still working, however.

-----Original Message-----
From: squid-users <squid-users-bounces at lists.squid-cache.org> On Behalf Of Alex Rousskov
Sent: Thursday, August 29, 2024 2:24 PM
To: squid-users at lists.squid-cache.org
Subject: Re: [squid-users] Unable to access internal resources via hostname

Caution: This email originated from outside of Hexcel. Do not click links or open attachments unless you recognize the sender and know the content is safe.


On 2024-08-29 13:08, Piana, Josh wrote:

> In regards to the debugging, do you still want me to do All,9 or is
> All,6 acceptable? I am reading that 9 is... huge.

I want ALL,9. I can usually handle its size. If you cannot, then adjust as needed, but my willingness to help will decrease (because it often takes me a lot longer to grok partial logs correctly). FWIW, the ALL,9 snippet size for a single-transaction test is usually quite manageable (under 1GB).


> I did eventually find that it was the other log when I browsed /var/log/squid/...
> The log was dated for today, which is good. But I'm not sure how to generate it on purpose?

Squid writes to cache.log as it runs. You can remove the old log while Squid does not run and Squid will create a new file, or, better, look for "tail" hints on that FAQ page.

When you run your test after configuring (and restarting) Squid with "debug_options ALL,9", Squid will write debugging info to its cache.log.
There are more hints on that FAQ page.


> Just so we're on the same understanding, I've only been using Linux 
> for 2 months, this project is my first experience with it. I do 
> apologize if I miss a lot of "common sense" stuff. This was tasked for 
> me to figure out and I've been having a pretty fun learning experience 
> so far.

I sympathize, but do not have the time to offer enough guidance for basic sysadmin tasks. Others on the mailing list may be able to help with specific questions or, better, see if you can find a local Linux person who can help you with this task. If they know what they are doing, it should take them less than 30 minutes to produce the requested debugging cache.log snippet for the test transaction, even if they have never heard about Squid before. And you will learn a few new tricks...


> I'll update those logs and wait for your response to this before 
> sending them or sending you a personal drop link.

A link usually works best.


Thank you,

Alex.


> -----Original Message-----
> From: squid-users <squid-users-bounces at lists.squid-cache.org> On 
> Behalf Of Alex Rousskov
> Sent: Thursday, August 29, 2024 12:00 PM
> To: squid-users at lists.squid-cache.org
> Subject: Re: [squid-users] Unable to access internal resources via 
> hostname
>
> Caution: This email originated from outside of Hexcel. Do not click links or open attachments unless you recognize the sender and know the content is safe.
>
>
> On 2024-08-29 10:34, Piana, Josh wrote:
>
>> I've added the following to my squid.conf file # logformat custom 
>> %err_code/%err_detail # access_log daemon:/var/log/squid/access,log 
>> custom
>
> I assume you are using comment character (#) for email presentation purposes (i.e. it does not actually exist in your squid.conf).
>
> I assume that comma in your access log file name above is a typo that does not actually exist in your squid.conf.
>
>
>> I'm not sure ... extra log details were added correctly
> The above access_log configuration should reduce all access.log records to exactly two fields separated by a slash. Clearly, it does not! Thus, you are either not testing with the new configuration file (e.g., you have not fully shut down and then started Squid) or there are other serious problems (e.g., malformed squid.conf that confuses Squid v5). We should solve this mystery before moving any further.
>
>
>> I've also enabled debugging options:
>> # debug_options ALL,9
>
> Thank you. Please note that this debugging info goes into cache.log, not access.log. I trust you have examined your cache.log for errors and warnings _before_ enabling debugging -- finding them among debugging noise can be challenging! ALL,9 debugging is for Squid developers to study.
>
> My recommendation for the next step remains the same. Look for "The best option" in my previous response.
>
>
> HTH,
>
> Alex.
>
>
>> I've also cleaned up our ACL's to better reflect what is going on:
>> # acl src_self src 127.0.0.0/8
>> # acl src_self src 10.46.11.69
>> # acl dst_self dst 127.0.0.0/8
>> # acl dst_self dst 10.46.11.69
>>
>> # acl from_arc src 10.46.0.0/15
>>
>> # acl local_dst_addr dst 10.0.0.0/8
>> # acl local_dst_addr dst 172.0.0.0/8
>>
>> When accessing internal devices via IP, it works.
>> I think this is because of this ACL:
>> # http_access           allow local_dst_addr
>> # http_reply_access     allow local_dst_addr
>>
>> But when I access those same internal devices via hostname, it fails.
>> I'm using this ACL, which I just created a separate file for:
>> acl local_dst_dom dstdomain "etc/squid/local_dst_dom"
>> http_access       allow local_dst_dom
>> http_reply_access allow local_dst_dom
>>
>> I added an ACL file because I figure it will be more extensive than the more simple IP range ACL's.
>> I've added a few local websites to the "local_dst_dom" list, but I'm unable to get this to resolve without using IP.
>>
>> For instance: "https://hexcelssp/" is the name of one of our internal websites for our company.
>> This doesn't load under our current config but "https://10.96.14.174/" DOES load.
>>
>> I've added "hexnt2067" as well, which you can see me testing in the below logs.
>> Again, this DOES work with its IP, 10.96.102.67.
>>
>> I'm not getting a proxy error message when I try to browse to that URL though, we just can't reach it.
>>
>> Here's the log results after enabling debugging and better log features:
>>
>> 29/Aug/2024:10:25:33 -0400.380 10.46.49.190 TCP_DENIED/407 4132 
>> CONNECT hexcelssp:443 - HIER_NONE/- text/html
>> 29/Aug/2024:10:25:33 -0400.515 10.46.49.190 NONE_NONE/500 0 CONNECT
>> hexcelssp:443 JPIANA at AD.<DOMAIN>.COM HIER_NONE/- -
>> 29/Aug/2024:10:25:39 -0400.799 10.46.49.190 TCP_TUNNEL/200 11716 
>> CONNECT contile.services.mozilla.com:443 JPIANA at AD.<DOMAIN>.COM
>> HIER_DIRECT/34.117.188.166 -
>> 29/Aug/2024:10:26:05 -0400.507 10.46.49.190 TCP_DENIED/407 4474 GET 
>> http://hexnt2067/sites/it/help/SitePages/Home.aspx - HIER_NONE/- 
>> text/html
>> 29/Aug/2024:10:26:05 -0400.646 10.46.49.190 TCP_MISS/500 8320 GET 
>> http://hexnt2067/sites/it/help/SitePages/Home.aspx
>> JPIANA at AD.<DOMAIN>.COM HIER_NONE/- text/html
>> 29/Aug/2024:10:26:05 -0400.735 10.46.49.190 TCP_DENIED/403 4440 GET 
>> http://arcga/ 
>> te2.ad%2F&data=05%7C02%7Cjosh.piana%40hexcel.com%7Ce66ed645b81f49d475
>> d
>> e08dcc843a4a6%7C4248050df19546d5ac9c0c7c52b04cae%7C0%7C0%7C6386054400
>> 7 
>> 1382901%7CUnknown%7CTWFpbGZsb3d8eyJWIjoiMC4wLjAwMDAiLCJQIjoiV2luMzIiL
>> C 
>> JBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C0%7C%7C%7C&sdata=xqwHdvSxDiifEZVJALLtc
>> C 
>> 6L9VoLptjKTHgDVTNBzLY%3D&reserved=0.<domain>.com:8080/squid-internal-
>> s tatic/icons/SN.png - HIER_NONE/- text/html
>> 29/Aug/2024:10:26:05 -0400.779 10.46.49.190 TCP_MISS_ABORTED/500 0 
>> GET http://hexnt2067/favicon.ico JPIANA at AD.<DOMAIN>.COM HIER_NONE/- 
>> text/html
>> 29/Aug/2024:10:27:13 -0400.036 10.46.49.190 TCP_DENIED/407 4474 GET 
>> http://hexnt2067/sites/it/help/SitePages/Home.aspx - HIER_NONE/- 
>> text/html
>> 29/Aug/2024:10:27:13 -0400.227 10.46.49.190 TCP_MISS/500 8334 GET 
>> http://hexnt2067/sites/it/help/SitePages/Home.aspx
>> JPIANA at AD.<DOMAIN>.COM HIER_NONE/- text/html
>> 29/Aug/2024:10:27:13 -0400.302 10.46.49.190 TCP_DENIED/403 4440 GET 
>> http://arcga/ 
>> te2.ad%2F&data=05%7C02%7Cjosh.piana%40hexcel.com%7Ce66ed645b81f49d475
>> d
>> e08dcc843a4a6%7C4248050df19546d5ac9c0c7c52b04cae%7C0%7C0%7C6386054400
>> 7 
>> 1382901%7CUnknown%7CTWFpbGZsb3d8eyJWIjoiMC4wLjAwMDAiLCJQIjoiV2luMzIiL
>> C 
>> JBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C0%7C%7C%7C&sdata=xqwHdvSxDiifEZVJALLtc
>> C 
>> 6L9VoLptjKTHgDVTNBzLY%3D&reserved=0.<domain>.com:8080/squid-internal-
>> s tatic/icons/SN.png - HIER_NONE/- text/html
>> 29/Aug/2024:10:27:17 -0400.376 10.46.49.190 TCP_DENIED/407 4132 
>> CONNECT hexcelssp:443 - HIER_NONE/- text/html
>> 29/Aug/2024:10:27:17 -0400.514 10.46.49.190 NONE_NONE/500 0 CONNECT
>> hexcelssp:443 JPIANA at AD.<DOMAIN>.COM HIER_NONE/- -
>>
>> I'm not sure the debugging and extra log details were added correctly, because these look the same.
>>
>> Thanks,
>> Josh
>>
>>
>> -----Original Message-----
>> From: squid-users <squid-users-bounces at lists.squid-cache.org> On 
>> Behalf Of Alex Rousskov
>> Sent: Wednesday, August 28, 2024 4:01 PM
>> To: squid-users at lists.squid-cache.org
>> Subject: Re: [squid-users] Unable to access internal resources via 
>> hostname
>>
>> Caution: This email originated from outside of Hexcel. Do not click links or open attachments unless you recognize the sender and know the content is safe.
>>
>>
>> On 2024-08-28 15:25, Piana, Josh wrote:
>>
>>> I now understand that Squid 5.5 ... is actually out of date as well.
>>> I regret installing and working off of this because I jused assumed 
>>> the "yum" install command for the Squid distro would give me the 
>>> most recent, known-good, software. That's completely on me.
>>
>> Whether yum install installs something production-worthy today is between you and your Linux distro. Squid Project volunteers, including me, do no control what distribution you pick and what that distribution ships. The reason I mentioned v5 support status is to avoid creating a false impression that there are no _other_ (i.e. unreported by you on this thread) problems you may want to know about and to lower your expectations from the level of support you may get from Squid Project volunteers like me.
>>
>> Said that, I doubt the problem you are trying to solve is v5-specific.
>> You may get better diagnostics if you run v6+, and you may receive fewer unusable (with v5) instructions if you run v6+, but the problem is likely to be present in a v6-based setup as well.
>>
>>
>>>   From how I understand it, his intentions for internal users 
>>> accessing internal resources, would skip authentication altogether.
>>
>> I assume that the problematic test that you want to fix is done using 
>> "internal users". You have already stated that the test is accessing 
>> "internal resources". Yet, we see that Squid asks the test client to 
>> authenticate (TCP_DENIED/407). Thus,
>>
>> * either local_dst_dom, local_dst_addr, and authless_src ACLs do not 
>> match test client transactions
>>
>> * or there is an authentication-triggering directive (e.g., "http_access deny block_user") located above a matching "http_access allow" rule that uses one of those ACLs three.
>>
>> Ideally, we should figure out which http_access rule matches the problematic transaction and triage from there. Unfortunately, Squid does not make that basic task easy. The best option I can think of is for you to share (privately if needed to avoid publishing sensitive info) a pointer to compressed cache.log file collected while reproducing the problem using a single test transaction after setting debug_options to ALL,9. Squid FAQ has a few hints about collecting relevant info:
>> https://wiki/
>> .squid-cache.org%2FSquidFaq%2FBugReporting%23debugging-a-single-trans
>> a 
>> ction&data=05%7C02%7Cjosh.piana%40hexcel.com%7Ce66ed645b81f49d475de08
>> d
>> cc843a4a6%7C4248050df19546d5ac9c0c7c52b04cae%7C0%7C0%7C63860544007138
>> 2 
>> 901%7CUnknown%7CTWFpbGZsb3d8eyJWIjoiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBT
>> i 
>> I6Ik1haWwiLCJXVCI6Mn0%3D%7C0%7C%7C%7C&sdata=RDkHh9Xa1Iyi3jC%2FbPGaoJo
>> I
>> %2FPvayueaofn8FRmb4KQ%3D&reserved=0
>>
>> This "unexpected authentication" mystery may not be directly related to the "HTTP 500 error responses" mystery we discussed earlier, but it may help to fix authentication first.
>>
>>
>> HTH,
>>
>> Alex.
>>
>>
>>> Here's a small piece, with his notes included, of why I think that.
>>>
>>> --------------------------------------------------------------------
>>> -
>>> -
>>> --------------------------------------------------
>>> #
>>> --------------------------------------------------------------------
>>> -
>>> -
>>> ------
>>> # allow without authentication
>>> # these rules allow certain connects without user authentication # 
>>> these allow any protocol/method/etc
>>>
>>> #                 ***** IMPORTANT *****
>>> # Adding to these lists also exempts from all content filtering.
>>> # In particular, executables will be allowed to download!
>>> #                 ***** IMPORTANT *****
>>>
>>> # allow connects to local destinations without authentication # by 
>>> domain name from URL
>>> http_access       allow local_dst_dom
>>> http_reply_access allow local_dst_dom
>>>
>>> # by IP address name resolves to
>>> http_access       allow local_dst_addr
>>> http_reply_access allow local_dst_addr
>>> --------------------------------------------------------------------
>>> -
>>> -
>>> --------------------------------------------------
>>>
>>> The "http_access allow local_dst_dom" and the following reply statement seems to point toward his intentions when writing this.
>>>
>>> The only thing in the old config this was referencing was this, and to me, it doesn't make sense:
>>> # acl local_dst_dom dstdomain arcgate
>>>
>>> It's worth noting that despite how awkward this seems, it DOES work. On the old web proxy we're currently still running live.
>>>
>>> I've gone as far as swapping out just the authentication settings and keeping the entire old config, but it still doesn't work.
>>> I've setup a realmd/sssd/kerberos backend instead of Samba/Windbind that the old server uses.
>>>
>>> To state the issue we're having again - internal resources connecting to other internal resources fails via hostname, but works when using IP. I was able to troubleshoot and conclude DNS was not the issue, as all other aspects are working as intended and they certainly do use DNS. Also pings resolve using hostname from the new squidbox so that implies that DNS is working as expected.
>>>
>>> Ultimately, here's what I think we want, please feel free to poke holes in it:
>>> Allow clients who are accessing other internal rersources to be able to browse to it using its hostname, without needing authentication first.
>>>
>>>
>>> I do intend on adding those parameters you mentioned to the logs so I can get better details within. I also need to look into how to use the debugging features, I'm not familiar with it at all.
>>>
>>> I apologize for the wall of text, looking forward to what you guys have to say about this.
>>>
>>> Thanks,
>>> Josh
>>>
>>> -----Original Message-----
>>> From: squid-users <squid-users-bounces at lists.squid-cache.org> On 
>>> Behalf Of Alex Rousskov
>>> Sent: Wednesday, August 28, 2024 2:31 PM
>>> To: squid-users at lists.squid-cache.org
>>> Subject: Re: [squid-users] Unable to access internal resources via 
>>> hostname
>>>
>>> Caution: This email originated from outside of Hexcel. Do not click links or open attachments unless you recognize the sender and know the content is safe.
>>>
>>>
>>> On 2024-08-28 14:18, Alex Rousskov wrote:
>>>> On 2024-08-28 11:24, Piana, Josh wrote:
>>>>
>>>>> Here's the log and (I think) relevant ACL's?
>>>>
>>>> According to your access.log, Squid denies problematic CONNECT 
>>>> requests with HTTP 407 errors responses. Usually, that means those 
>>>> requests match an "http_access deny" rule. Clearly, you expect an 
>>>> "allow" outcome instead, but it is difficult (for me) to figure out 
>>>> where your expectations mismatch reality; there are no rules that 
>>>> explicitly mention hexcelssp domain, for example: Which 
>>>> "http_access allow" rule do you expect those denied requests to match?
>>>
>>> Sorry, I probably misinterpreted those access.log records: It looks like the denied (TCP_DENIED/407) access is something you actually expect because you want that test request to be authenticated. The client supplies the necessary credentials in the second request, and then that second request fails with a (rather generic) HTTP 500 error code, without contacting the origin server.
>>>
>>> I am guessing that you are concerned about that second request/transaction rather than the first one.
>>>
>>> Squid generates HTTP 500 errors for a variety of different reasons. Are there any messages in cache.log (at default debugging level) that correspond to these failing test transactions? If there are none, please add %err_code/%err_detail to your access_log logformat so that Squid logs more information about the problem to access.log (see logformat and access_log directives in squid.conf.documented for details).
>>>
>>>
>>> Thank you,
>>>
>>> Alex.
>>>
>>>
>>>
>>>> Also, does mgr:ipcache cache manager query confirm that Squid has 
>>>> read your /etc/hosts file and cached the record you expect it to use?
>>>>
>>>> Alex.
>>>>
>>>>
>>>>> ------------------------------------------------------------------
>>>>> -
>>>>> -
>>>>> -
>>>>> --------------------------------------
>>>>> # /var/log/squid/access.log results for internal conflicts
>>>>>
>>>>> 28/Aug/2024:10:57:17 -0400.234 10.46.49.190 TCP_DENIED/407 4132 
>>>>> CONNECT hexcelssp:443 - HIER_NONE/- text/html
>>>>> 28/Aug/2024:10:57:17 -0400.253 10.46.49.190 NONE_NONE/500 0 
>>>>> CONNECT
>>>>> hexcelssp:443 JPIANA at AD.<DOMAIN>.COM HIER_NONE/- -
>>>>> 28/Aug/2024:10:57:17 -0400.380 10.46.49.190 TCP_DENIED/407 4132 
>>>>> CONNECT hexcelssp:443 - HIER_NONE/- text/html
>>>>> 28/Aug/2024:10:57:17 -0400.399 10.46.49.190 NONE_NONE/500 0 
>>>>> CONNECT
>>>>> hexcelssp:443 JPIANA at AD.<DOMAIN>.COM HIER_NONE/- -
>>>>> ------------------------------------------------------------------
>>>>> -
>>>>> -
>>>>> -
>>>>> --------------------------------------
>>>>>
>>>>> # acl all src all
>>>>>
>>>>> acl src_self src 127.0.0.0/8
>>>>> acl src_self src 10.46.11.69
>>>>>
>>>>> acl dst_self dst 127.0.0.0/8
>>>>> acl dst_self dst 10.46.11.69
>>>>>
>>>>> acl from_arc src 10.46.0.0/15
>>>>>
>>>>> acl local_dst_addr dst 10.0.0.0/8
>>>>> acl local_dst_addr dst 172.0.0.0/8 acl local_dst_addr dst 
>>>>> bldg3.<domain>.com acl local_dst_addr dst bldg5.<domain>.com
>>>>>
>>>>> # these keep URLs of popular local servers from being forwarded 
>>>>> acl local_dst_dom dstdomain arcgate
>>>>>
>>>>> # allow connects to local destinations without authentication # by 
>>>>> domain name from URL
>>>>> http_access       allow local_dst_dom
>>>>> http_reply_access allow local_dst_dom
>>>>>
>>>>> # by IP address name resolves to
>>>>> http_access       allow local_dst_addr
>>>>> http_reply_access allow local_dst_addr
>>>>>
>>>>> # allow trusted hosts without authentication # these are just ip's 
>>>>> on the 10.46.11.x network acl authless_src src "/etc/squid/authless_src"
>>>>> http_access       allow authless_src
>>>>> http_reply_access allow authless_src
>>>>> ------------------------------------------------------------------
>>>>> -
>>>>> -
>>>>> -
>>>>> --------------------------------------
>>>>>
>>>>> -----Original Message-----
>>>>> From: squid-users <squid-users-bounces at lists.squid-cache.org> On 
>>>>> Behalf Of Matus UHLAR - fantomas
>>>>> Sent: Wednesday, August 28, 2024 10:47 AM
>>>>> To: squid-users at lists.squid-cache.org
>>>>> Subject: Re: [squid-users] Unable to access internal resources via 
>>>>> hostname
>>>>>
>>>>> Caution: This email originated from outside of Hexcel. Do not 
>>>>> click links or open attachments unless you recognize the sender 
>>>>> and know the content is safe.
>>>>>
>>>>>
>>>>> On 28.08.24 14:20, Piana, Josh wrote:
>>>>>> Hello Squid Support,
>>>>>
>>>>> This squid user forum FYI
>>>>>
>>>>>> We are unable to get to internal resources via hostname but using 
>>>>>> the IP address works fine.  Immediately, I thought this was DNS 
>>>>>> but when I checked the /etc/resolv.conf/ file it was pointing 
>>>>>> correctly to our Windows DNS server and we can ping all devices 
>>>>>> using their hostname, just not when browsing to it.  This leads 
>>>>>> me to believe something may be wrong with our squid config.
>>>>>
>>>>> hard to guess without seeing logs or ACL's.
>>>>>
>>>>>
>>>>> --
>>>>> Matus UHLAR - fantomas, uhlar at fantomas.sk ; http://www/.
>>>>> fantomas.sk%2F&data=05%7C02%7Cjosh.piana%40hexcel.com%7C2db72264ca
>>>>> a
>>>>> 0
>>>>> 4
>>>>> f1fd80d08dcc78f9245%7C4248050df19546d5ac9c0c7c52b04cae%7C0%7C0%7C6
>>>>> 3
>>>>> 8
>>>>> 6
>>>>> 04666668859787%7CUnknown%7CTWFpbGZsb3d8eyJWIjoiMC4wLjAwMDAiLCJQIjo
>>>>> i
>>>>> V
>>>>> 2
>>>>> luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C0%7C%7C%7C&sdata=Z7cUEdNvIn
>>>>> D
>>>>> A
>>>>> J
>>>>> PwgQJhXWSK3H2mkAPe4CNcfYJFyy6M%3D&reserved=0
>>>>> Warning: I wish NOT to receive e-mail advertising to this address.
>>>>> Varovanie: na tuto adresu chcem NEDOSTAVAT akukolvek reklamnu postu.
>>>>> It's now safe to throw off your computer.
>>>>> _______________________________________________
>>>>> squid-users mailing list
>>>>> squid-users at lists.squid-cache.org
>>>>> https://lis/
>>>>> ts.squid-cache.org%2Flistinfo%2Fsquid-users&data=05%7C02%7Cjosh.pi
>>>>> a
>>>>> n
>>>>> a
>>>>> %40hexcel.com%7C2db72264caa04f1fd80d08dcc78f9245%7C4248050df19546d
>>>>> 5
>>>>> a
>>>>> c
>>>>> 9c0c7c52b04cae%7C0%7C0%7C638604666674016161%7CUnknown%7CTWFpbGZsb3
>>>>> d
>>>>> 8
>>>>> e
>>>>> yJWIjoiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%
>>>>> 7
>>>>> C
>>>>> 0
>>>>> %7C%7C%7C&sdata=%2B%2B7inZxg2LEmB2KFVWmtn64FG8SwHpEZeEyAjhNClnU%3D
>>>>> &
>>>>> r
>>>>> e
>>>>> served=0 _______________________________________________
>>>>> squid-users mailing list
>>>>> squid-users at lists.squid-cache.org
>>>>> https://lis/
>>>>> ts.squid-cache.org%2Flistinfo%2Fsquid-users&data=05%7C02%7Cjosh.pi
>>>>> a
>>>>> n
>>>>> a
>>>>> %40hexcel.com%7C2db72264caa04f1fd80d08dcc78f9245%7C4248050df19546d
>>>>> 5
>>>>> a
>>>>> c
>>>>> 9c0c7c52b04cae%7C0%7C0%7C638604666674016161%7CUnknown%7CTWFpbGZsb3
>>>>> d
>>>>> 8
>>>>> e
>>>>> yJWIjoiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%
>>>>> 7
>>>>> C
>>>>> 0
>>>>> %7C%7C%7C&sdata=%2B%2B7inZxg2LEmB2KFVWmtn64FG8SwHpEZeEyAjhNClnU%3D
>>>>> &
>>>>> r
>>>>> e
>>>>> served=0
>>>>
>>>> _______________________________________________
>>>> squid-users mailing list
>>>> squid-users at lists.squid-cache.org
>>>> https://list/
>>>> s.squid-cache.org%2Flistinfo%2Fsquid-users&data=05%7C02%7Cjosh.pian
>>>> a
>>>> %
>>>> 4
>>>> 0hexcel.com%7C2db72264caa04f1fd80d08dcc78f9245%7C4248050df19546d5ac
>>>> 9
>>>> c
>>>> 0
>>>> c7c52b04cae%7C0%7C0%7C638604666674016161%7CUnknown%7CTWFpbGZsb3d8ey
>>>> J
>>>> W
>>>> I
>>>> joiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C0%7
>>>> C
>>>> %
>>>> 7
>>>> C%7C&sdata=%2B%2B7inZxg2LEmB2KFVWmtn64FG8SwHpEZeEyAjhNClnU%3D&reser
>>>> v
>>>> e
>>>> d
>>>> =0
>>>
>>> _______________________________________________
>>> squid-users mailing list
>>> squid-users at lists.squid-cache.org
>>> https://list/
>>> s.squid-cache.org%2Flistinfo%2Fsquid-users&data=05%7C02%7Cjosh.piana
>>> %
>>> 4
>>> 0hexcel.com%7C6f7f2ea035ca4506507008dcc79c3598%7C4248050df19546d5ac9
>>> c
>>> 0
>>> c7c52b04cae%7C0%7C0%7C638604720952164544%7CUnknown%7CTWFpbGZsb3d8eyJ
>>> W
>>> I
>>> joiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C0%7C
>>> %
>>> 7
>>> C%7C&sdata=RrdtLQu5y421WIi6vjyxj1ZsNRdIn%2FMaKusbjKGoY48%3D&reserved
>>> =
>>> 0 _______________________________________________
>>> squid-users mailing list
>>> squid-users at lists.squid-cache.org
>>> https://list/
>>> s.squid-cache.org%2Flistinfo%2Fsquid-users&data=05%7C02%7Cjosh.piana
>>> %
>>> 4
>>> 0hexcel.com%7C6f7f2ea035ca4506507008dcc79c3598%7C4248050df19546d5ac9
>>> c
>>> 0
>>> c7c52b04cae%7C0%7C0%7C638604720952164544%7CUnknown%7CTWFpbGZsb3d8eyJ
>>> W
>>> I
>>> joiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C0%7C
>>> %
>>> 7
>>> C%7C&sdata=RrdtLQu5y421WIi6vjyxj1ZsNRdIn%2FMaKusbjKGoY48%3D&reserved
>>> =
>>> 0
>>
>> _______________________________________________
>> squid-users mailing list
>> squid-users at lists.squid-cache.org
>> https://list/
>> s.squid-cache.org%2Flistinfo%2Fsquid-users&data=05%7C02%7Cjosh.piana%
>> 4
>> 0hexcel.com%7Ce66ed645b81f49d475de08dcc843a4a6%7C4248050df19546d5ac9c
>> 0 
>> c7c52b04cae%7C0%7C0%7C638605440071382901%7CUnknown%7CTWFpbGZsb3d8eyJW
>> I
>> joiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C0%7C%
>> 7 
>> C%7C&sdata=1PZUcTcTx39ZCH76h1BVemyFSPKN6R%2B7%2F%2FJ3XEqoSFQ%3D&reser
>> v
>> ed=0 _______________________________________________
>> squid-users mailing list
>> squid-users at lists.squid-cache.org
>> https://list/
>> s.squid-cache.org%2Flistinfo%2Fsquid-users&data=05%7C02%7Cjosh.piana%
>> 4
>> 0hexcel.com%7Ce66ed645b81f49d475de08dcc843a4a6%7C4248050df19546d5ac9c
>> 0 
>> c7c52b04cae%7C0%7C0%7C638605440071382901%7CUnknown%7CTWFpbGZsb3d8eyJW
>> I
>> joiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C0%7C%
>> 7 
>> C%7C&sdata=1PZUcTcTx39ZCH76h1BVemyFSPKN6R%2B7%2F%2FJ3XEqoSFQ%3D&reser
>> v
>> ed=0
>
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> https://list/
> s.squid-cache.org%2Flistinfo%2Fsquid-users&data=05%7C02%7Cjosh.piana%4
> 0hexcel.com%7C56fa965859a74d555dd708dcc857beed%7C4248050df19546d5ac9c0
> c7c52b04cae%7C0%7C0%7C638605526440153938%7CUnknown%7CTWFpbGZsb3d8eyJWI
> joiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C0%7C%7
> C%7C&sdata=%2FpJeOC4wFdRLuaSSxriBI91J7OzBqPA71dCz%2BDkITIg%3D&reserved
> =0 _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> https://list/
> s.squid-cache.org%2Flistinfo%2Fsquid-users&data=05%7C02%7Cjosh.piana%4
> 0hexcel.com%7C56fa965859a74d555dd708dcc857beed%7C4248050df19546d5ac9c0
> c7c52b04cae%7C0%7C0%7C638605526440310231%7CUnknown%7CTWFpbGZsb3d8eyJWI
> joiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C0%7C%7
> C%7C&sdata=86Jd4eCPBOi8EbFA2d79Jg2ErbDJn5cmtOFwh2c5cA4%3D&reserved=0

_______________________________________________
squid-users mailing list
squid-users at lists.squid-cache.org
https://lists.squid-cache.org/listinfo/squid-users


From rousskov at measurement-factory.com  Fri Aug 30 16:24:06 2024
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Fri, 30 Aug 2024 12:24:06 -0400
Subject: [squid-users] Unable to access internal resources via hostname
In-Reply-To: <6507ec1d399c4024a9fdc8d94ad17efa@hexcel.com>
References: <405705ce244447aca1b15385a171fada@hexcel.com>
 <Zs84drvoIpZ1f6DR@fantomas.sk> <58bdfaada3fa46d0938b7346ec04c336@hexcel.com>
 <947309fa-d1fc-4a75-ac49-ea7bc5c5ff12@measurement-factory.com>
 <faffca37-fa59-46ff-80e4-245c37fa90b9@measurement-factory.com>
 <c00942c1c8ab46b5b393d70f32346798@hexcel.com>
 <59274673-47e9-431d-ad45-7fa3a5a8ebca@measurement-factory.com>
 <d063bef52efd4e32a9f9bb27f934e673@hexcel.com>
 <8f29292d-a074-42b0-a793-757782b9d9f9@measurement-factory.com>
 <3de704666f56443fbfe762ce56f3e2dd@hexcel.com>
 <c6b9332f-a847-4438-a819-f62199d01f79@measurement-factory.com>
 <6507ec1d399c4024a9fdc8d94ad17efa@hexcel.com>
Message-ID: <0a8661d2-1324-4d64-bfe9-a506f0181b9f@measurement-factory.com>

On 2024-08-30 10:19, Piana, Josh wrote:

> If its not one issue its another. Now I can't seem to generate a
> cache log file for to to assist with further troubleshooting.
> 
> I've restarted squid and used "squid -k reconfigure" a few times,
> verified debugging is enabled and set to "All,9", and I don't have
> any special rules in my config to point the cache log somewhere
> else.
> 
> I'm not sure what I'm doing wrong with it. I did remove the file it
> created yesterday, because I wanted to make sure we had a fresh one
> to write to and send. I was thinking it may need explicit permissions
> to write the logs here but it didn't need that before and I'm not
> getting any errors related to it. The "access.log" file is still
> working, however.

I cannot guess what exactly went wrong, but I can recommend the 
following recovery steps:

1. Stop/kill Squid. Make sure there are no Squid processes running 
(e.g., using `ps aux | grep squid` or a similar low-level check). If you 
cannot figure out how to get rid of old Squid processes, reboot the box.

2. Remove old cache.log and access.log files (if any) or move them into 
a different directory.

3. Start Squid.

If the problem persists, share the command you use to start Squid and 
any console output you get from that command.


In general, avoid using "squid -k reconfigure" when possible, especially 
when using Squid v5 and earlier.


HTH,

Alex.

> -----Original Message-----
> From: squid-users <squid-users-bounces at lists.squid-cache.org> On Behalf Of Alex Rousskov
> Sent: Thursday, August 29, 2024 2:24 PM
> To: squid-users at lists.squid-cache.org
> Subject: Re: [squid-users] Unable to access internal resources via hostname
> 
> Caution: This email originated from outside of Hexcel. Do not click links or open attachments unless you recognize the sender and know the content is safe.
> 
> 
> On 2024-08-29 13:08, Piana, Josh wrote:
> 
>> In regards to the debugging, do you still want me to do All,9 or is
>> All,6 acceptable? I am reading that 9 is... huge.
> 
> I want ALL,9. I can usually handle its size. If you cannot, then adjust as needed, but my willingness to help will decrease (because it often takes me a lot longer to grok partial logs correctly). FWIW, the ALL,9 snippet size for a single-transaction test is usually quite manageable (under 1GB).
> 
> 
>> I did eventually find that it was the other log when I browsed /var/log/squid/...
>> The log was dated for today, which is good. But I'm not sure how to generate it on purpose?
> 
> Squid writes to cache.log as it runs. You can remove the old log while Squid does not run and Squid will create a new file, or, better, look for "tail" hints on that FAQ page.
> 
> When you run your test after configuring (and restarting) Squid with "debug_options ALL,9", Squid will write debugging info to its cache.log.
> There are more hints on that FAQ page.
> 
> 
>> Just so we're on the same understanding, I've only been using Linux
>> for 2 months, this project is my first experience with it. I do
>> apologize if I miss a lot of "common sense" stuff. This was tasked for
>> me to figure out and I've been having a pretty fun learning experience
>> so far.
> 
> I sympathize, but do not have the time to offer enough guidance for basic sysadmin tasks. Others on the mailing list may be able to help with specific questions or, better, see if you can find a local Linux person who can help you with this task. If they know what they are doing, it should take them less than 30 minutes to produce the requested debugging cache.log snippet for the test transaction, even if they have never heard about Squid before. And you will learn a few new tricks...
> 
> 
>> I'll update those logs and wait for your response to this before
>> sending them or sending you a personal drop link.
> 
> A link usually works best.
> 
> 
> Thank you,
> 
> Alex.
> 
> 
>> -----Original Message-----
>> From: squid-users <squid-users-bounces at lists.squid-cache.org> On
>> Behalf Of Alex Rousskov
>> Sent: Thursday, August 29, 2024 12:00 PM
>> To: squid-users at lists.squid-cache.org
>> Subject: Re: [squid-users] Unable to access internal resources via
>> hostname
>>
>> Caution: This email originated from outside of Hexcel. Do not click links or open attachments unless you recognize the sender and know the content is safe.
>>
>>
>> On 2024-08-29 10:34, Piana, Josh wrote:
>>
>>> I've added the following to my squid.conf file # logformat custom
>>> %err_code/%err_detail # access_log daemon:/var/log/squid/access,log
>>> custom
>>
>> I assume you are using comment character (#) for email presentation purposes (i.e. it does not actually exist in your squid.conf).
>>
>> I assume that comma in your access log file name above is a typo that does not actually exist in your squid.conf.
>>
>>
>>> I'm not sure ... extra log details were added correctly
>> The above access_log configuration should reduce all access.log records to exactly two fields separated by a slash. Clearly, it does not! Thus, you are either not testing with the new configuration file (e.g., you have not fully shut down and then started Squid) or there are other serious problems (e.g., malformed squid.conf that confuses Squid v5). We should solve this mystery before moving any further.
>>
>>
>>> I've also enabled debugging options:
>>> # debug_options ALL,9
>>
>> Thank you. Please note that this debugging info goes into cache.log, not access.log. I trust you have examined your cache.log for errors and warnings _before_ enabling debugging -- finding them among debugging noise can be challenging! ALL,9 debugging is for Squid developers to study.
>>
>> My recommendation for the next step remains the same. Look for "The best option" in my previous response.
>>
>>
>> HTH,
>>
>> Alex.
>>
>>
>>> I've also cleaned up our ACL's to better reflect what is going on:
>>> # acl src_self src 127.0.0.0/8
>>> # acl src_self src 10.46.11.69
>>> # acl dst_self dst 127.0.0.0/8
>>> # acl dst_self dst 10.46.11.69
>>>
>>> # acl from_arc src 10.46.0.0/15
>>>
>>> # acl local_dst_addr dst 10.0.0.0/8
>>> # acl local_dst_addr dst 172.0.0.0/8
>>>
>>> When accessing internal devices via IP, it works.
>>> I think this is because of this ACL:
>>> # http_access           allow local_dst_addr
>>> # http_reply_access     allow local_dst_addr
>>>
>>> But when I access those same internal devices via hostname, it fails.
>>> I'm using this ACL, which I just created a separate file for:
>>> acl local_dst_dom dstdomain "etc/squid/local_dst_dom"
>>> http_access       allow local_dst_dom
>>> http_reply_access allow local_dst_dom
>>>
>>> I added an ACL file because I figure it will be more extensive than the more simple IP range ACL's.
>>> I've added a few local websites to the "local_dst_dom" list, but I'm unable to get this to resolve without using IP.
>>>
>>> For instance: "https://hexcelssp/" is the name of one of our internal websites for our company.
>>> This doesn't load under our current config but "https://10.96.14.174/" DOES load.
>>>
>>> I've added "hexnt2067" as well, which you can see me testing in the below logs.
>>> Again, this DOES work with its IP, 10.96.102.67.
>>>
>>> I'm not getting a proxy error message when I try to browse to that URL though, we just can't reach it.
>>>
>>> Here's the log results after enabling debugging and better log features:
>>>
>>> 29/Aug/2024:10:25:33 -0400.380 10.46.49.190 TCP_DENIED/407 4132
>>> CONNECT hexcelssp:443 - HIER_NONE/- text/html
>>> 29/Aug/2024:10:25:33 -0400.515 10.46.49.190 NONE_NONE/500 0 CONNECT
>>> hexcelssp:443 JPIANA at AD.<DOMAIN>.COM HIER_NONE/- -
>>> 29/Aug/2024:10:25:39 -0400.799 10.46.49.190 TCP_TUNNEL/200 11716
>>> CONNECT contile.services.mozilla.com:443 JPIANA at AD.<DOMAIN>.COM
>>> HIER_DIRECT/34.117.188.166 -
>>> 29/Aug/2024:10:26:05 -0400.507 10.46.49.190 TCP_DENIED/407 4474 GET
>>> http://hexnt2067/sites/it/help/SitePages/Home.aspx - HIER_NONE/-
>>> text/html
>>> 29/Aug/2024:10:26:05 -0400.646 10.46.49.190 TCP_MISS/500 8320 GET
>>> http://hexnt2067/sites/it/help/SitePages/Home.aspx
>>> JPIANA at AD.<DOMAIN>.COM HIER_NONE/- text/html
>>> 29/Aug/2024:10:26:05 -0400.735 10.46.49.190 TCP_DENIED/403 4440 GET
>>> http://arcga/
>>> te2.ad%2F&data=05%7C02%7Cjosh.piana%40hexcel.com%7Ce66ed645b81f49d475
>>> d
>>> e08dcc843a4a6%7C4248050df19546d5ac9c0c7c52b04cae%7C0%7C0%7C6386054400
>>> 7
>>> 1382901%7CUnknown%7CTWFpbGZsb3d8eyJWIjoiMC4wLjAwMDAiLCJQIjoiV2luMzIiL
>>> C
>>> JBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C0%7C%7C%7C&sdata=xqwHdvSxDiifEZVJALLtc
>>> C
>>> 6L9VoLptjKTHgDVTNBzLY%3D&reserved=0.<domain>.com:8080/squid-internal-
>>> s tatic/icons/SN.png - HIER_NONE/- text/html
>>> 29/Aug/2024:10:26:05 -0400.779 10.46.49.190 TCP_MISS_ABORTED/500 0
>>> GET http://hexnt2067/favicon.ico JPIANA at AD.<DOMAIN>.COM HIER_NONE/-
>>> text/html
>>> 29/Aug/2024:10:27:13 -0400.036 10.46.49.190 TCP_DENIED/407 4474 GET
>>> http://hexnt2067/sites/it/help/SitePages/Home.aspx - HIER_NONE/-
>>> text/html
>>> 29/Aug/2024:10:27:13 -0400.227 10.46.49.190 TCP_MISS/500 8334 GET
>>> http://hexnt2067/sites/it/help/SitePages/Home.aspx
>>> JPIANA at AD.<DOMAIN>.COM HIER_NONE/- text/html
>>> 29/Aug/2024:10:27:13 -0400.302 10.46.49.190 TCP_DENIED/403 4440 GET
>>> http://arcga/
>>> te2.ad%2F&data=05%7C02%7Cjosh.piana%40hexcel.com%7Ce66ed645b81f49d475
>>> d
>>> e08dcc843a4a6%7C4248050df19546d5ac9c0c7c52b04cae%7C0%7C0%7C6386054400
>>> 7
>>> 1382901%7CUnknown%7CTWFpbGZsb3d8eyJWIjoiMC4wLjAwMDAiLCJQIjoiV2luMzIiL
>>> C
>>> JBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C0%7C%7C%7C&sdata=xqwHdvSxDiifEZVJALLtc
>>> C
>>> 6L9VoLptjKTHgDVTNBzLY%3D&reserved=0.<domain>.com:8080/squid-internal-
>>> s tatic/icons/SN.png - HIER_NONE/- text/html
>>> 29/Aug/2024:10:27:17 -0400.376 10.46.49.190 TCP_DENIED/407 4132
>>> CONNECT hexcelssp:443 - HIER_NONE/- text/html
>>> 29/Aug/2024:10:27:17 -0400.514 10.46.49.190 NONE_NONE/500 0 CONNECT
>>> hexcelssp:443 JPIANA at AD.<DOMAIN>.COM HIER_NONE/- -
>>>
>>> I'm not sure the debugging and extra log details were added correctly, because these look the same.
>>>
>>> Thanks,
>>> Josh
>>>
>>>
>>> -----Original Message-----
>>> From: squid-users <squid-users-bounces at lists.squid-cache.org> On
>>> Behalf Of Alex Rousskov
>>> Sent: Wednesday, August 28, 2024 4:01 PM
>>> To: squid-users at lists.squid-cache.org
>>> Subject: Re: [squid-users] Unable to access internal resources via
>>> hostname
>>>
>>> Caution: This email originated from outside of Hexcel. Do not click links or open attachments unless you recognize the sender and know the content is safe.
>>>
>>>
>>> On 2024-08-28 15:25, Piana, Josh wrote:
>>>
>>>> I now understand that Squid 5.5 ... is actually out of date as well.
>>>> I regret installing and working off of this because I jused assumed
>>>> the "yum" install command for the Squid distro would give me the
>>>> most recent, known-good, software. That's completely on me.
>>>
>>> Whether yum install installs something production-worthy today is between you and your Linux distro. Squid Project volunteers, including me, do no control what distribution you pick and what that distribution ships. The reason I mentioned v5 support status is to avoid creating a false impression that there are no _other_ (i.e. unreported by you on this thread) problems you may want to know about and to lower your expectations from the level of support you may get from Squid Project volunteers like me.
>>>
>>> Said that, I doubt the problem you are trying to solve is v5-specific.
>>> You may get better diagnostics if you run v6+, and you may receive fewer unusable (with v5) instructions if you run v6+, but the problem is likely to be present in a v6-based setup as well.
>>>
>>>
>>>>    From how I understand it, his intentions for internal users
>>>> accessing internal resources, would skip authentication altogether.
>>>
>>> I assume that the problematic test that you want to fix is done using
>>> "internal users". You have already stated that the test is accessing
>>> "internal resources". Yet, we see that Squid asks the test client to
>>> authenticate (TCP_DENIED/407). Thus,
>>>
>>> * either local_dst_dom, local_dst_addr, and authless_src ACLs do not
>>> match test client transactions
>>>
>>> * or there is an authentication-triggering directive (e.g., "http_access deny block_user") located above a matching "http_access allow" rule that uses one of those ACLs three.
>>>
>>> Ideally, we should figure out which http_access rule matches the problematic transaction and triage from there. Unfortunately, Squid does not make that basic task easy. The best option I can think of is for you to share (privately if needed to avoid publishing sensitive info) a pointer to compressed cache.log file collected while reproducing the problem using a single test transaction after setting debug_options to ALL,9. Squid FAQ has a few hints about collecting relevant info:
>>> https://wiki/
>>> .squid-cache.org%2FSquidFaq%2FBugReporting%23debugging-a-single-trans
>>> a
>>> ction&data=05%7C02%7Cjosh.piana%40hexcel.com%7Ce66ed645b81f49d475de08
>>> d
>>> cc843a4a6%7C4248050df19546d5ac9c0c7c52b04cae%7C0%7C0%7C63860544007138
>>> 2
>>> 901%7CUnknown%7CTWFpbGZsb3d8eyJWIjoiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBT
>>> i
>>> I6Ik1haWwiLCJXVCI6Mn0%3D%7C0%7C%7C%7C&sdata=RDkHh9Xa1Iyi3jC%2FbPGaoJo
>>> I
>>> %2FPvayueaofn8FRmb4KQ%3D&reserved=0
>>>
>>> This "unexpected authentication" mystery may not be directly related to the "HTTP 500 error responses" mystery we discussed earlier, but it may help to fix authentication first.
>>>
>>>
>>> HTH,
>>>
>>> Alex.
>>>
>>>
>>>> Here's a small piece, with his notes included, of why I think that.
>>>>
>>>> --------------------------------------------------------------------
>>>> -
>>>> -
>>>> --------------------------------------------------
>>>> #
>>>> --------------------------------------------------------------------
>>>> -
>>>> -
>>>> ------
>>>> # allow without authentication
>>>> # these rules allow certain connects without user authentication #
>>>> these allow any protocol/method/etc
>>>>
>>>> #                 ***** IMPORTANT *****
>>>> # Adding to these lists also exempts from all content filtering.
>>>> # In particular, executables will be allowed to download!
>>>> #                 ***** IMPORTANT *****
>>>>
>>>> # allow connects to local destinations without authentication # by
>>>> domain name from URL
>>>> http_access       allow local_dst_dom
>>>> http_reply_access allow local_dst_dom
>>>>
>>>> # by IP address name resolves to
>>>> http_access       allow local_dst_addr
>>>> http_reply_access allow local_dst_addr
>>>> --------------------------------------------------------------------
>>>> -
>>>> -
>>>> --------------------------------------------------
>>>>
>>>> The "http_access allow local_dst_dom" and the following reply statement seems to point toward his intentions when writing this.
>>>>
>>>> The only thing in the old config this was referencing was this, and to me, it doesn't make sense:
>>>> # acl local_dst_dom dstdomain arcgate
>>>>
>>>> It's worth noting that despite how awkward this seems, it DOES work. On the old web proxy we're currently still running live.
>>>>
>>>> I've gone as far as swapping out just the authentication settings and keeping the entire old config, but it still doesn't work.
>>>> I've setup a realmd/sssd/kerberos backend instead of Samba/Windbind that the old server uses.
>>>>
>>>> To state the issue we're having again - internal resources connecting to other internal resources fails via hostname, but works when using IP. I was able to troubleshoot and conclude DNS was not the issue, as all other aspects are working as intended and they certainly do use DNS. Also pings resolve using hostname from the new squidbox so that implies that DNS is working as expected.
>>>>
>>>> Ultimately, here's what I think we want, please feel free to poke holes in it:
>>>> Allow clients who are accessing other internal rersources to be able to browse to it using its hostname, without needing authentication first.
>>>>
>>>>
>>>> I do intend on adding those parameters you mentioned to the logs so I can get better details within. I also need to look into how to use the debugging features, I'm not familiar with it at all.
>>>>
>>>> I apologize for the wall of text, looking forward to what you guys have to say about this.
>>>>
>>>> Thanks,
>>>> Josh
>>>>
>>>> -----Original Message-----
>>>> From: squid-users <squid-users-bounces at lists.squid-cache.org> On
>>>> Behalf Of Alex Rousskov
>>>> Sent: Wednesday, August 28, 2024 2:31 PM
>>>> To: squid-users at lists.squid-cache.org
>>>> Subject: Re: [squid-users] Unable to access internal resources via
>>>> hostname
>>>>
>>>> Caution: This email originated from outside of Hexcel. Do not click links or open attachments unless you recognize the sender and know the content is safe.
>>>>
>>>>
>>>> On 2024-08-28 14:18, Alex Rousskov wrote:
>>>>> On 2024-08-28 11:24, Piana, Josh wrote:
>>>>>
>>>>>> Here's the log and (I think) relevant ACL's?
>>>>>
>>>>> According to your access.log, Squid denies problematic CONNECT
>>>>> requests with HTTP 407 errors responses. Usually, that means those
>>>>> requests match an "http_access deny" rule. Clearly, you expect an
>>>>> "allow" outcome instead, but it is difficult (for me) to figure out
>>>>> where your expectations mismatch reality; there are no rules that
>>>>> explicitly mention hexcelssp domain, for example: Which
>>>>> "http_access allow" rule do you expect those denied requests to match?
>>>>
>>>> Sorry, I probably misinterpreted those access.log records: It looks like the denied (TCP_DENIED/407) access is something you actually expect because you want that test request to be authenticated. The client supplies the necessary credentials in the second request, and then that second request fails with a (rather generic) HTTP 500 error code, without contacting the origin server.
>>>>
>>>> I am guessing that you are concerned about that second request/transaction rather than the first one.
>>>>
>>>> Squid generates HTTP 500 errors for a variety of different reasons. Are there any messages in cache.log (at default debugging level) that correspond to these failing test transactions? If there are none, please add %err_code/%err_detail to your access_log logformat so that Squid logs more information about the problem to access.log (see logformat and access_log directives in squid.conf.documented for details).
>>>>
>>>>
>>>> Thank you,
>>>>
>>>> Alex.
>>>>
>>>>
>>>>
>>>>> Also, does mgr:ipcache cache manager query confirm that Squid has
>>>>> read your /etc/hosts file and cached the record you expect it to use?
>>>>>
>>>>> Alex.
>>>>>
>>>>>
>>>>>> ------------------------------------------------------------------
>>>>>> -
>>>>>> -
>>>>>> -
>>>>>> --------------------------------------
>>>>>> # /var/log/squid/access.log results for internal conflicts
>>>>>>
>>>>>> 28/Aug/2024:10:57:17 -0400.234 10.46.49.190 TCP_DENIED/407 4132
>>>>>> CONNECT hexcelssp:443 - HIER_NONE/- text/html
>>>>>> 28/Aug/2024:10:57:17 -0400.253 10.46.49.190 NONE_NONE/500 0
>>>>>> CONNECT
>>>>>> hexcelssp:443 JPIANA at AD.<DOMAIN>.COM HIER_NONE/- -
>>>>>> 28/Aug/2024:10:57:17 -0400.380 10.46.49.190 TCP_DENIED/407 4132
>>>>>> CONNECT hexcelssp:443 - HIER_NONE/- text/html
>>>>>> 28/Aug/2024:10:57:17 -0400.399 10.46.49.190 NONE_NONE/500 0
>>>>>> CONNECT
>>>>>> hexcelssp:443 JPIANA at AD.<DOMAIN>.COM HIER_NONE/- -
>>>>>> ------------------------------------------------------------------
>>>>>> -
>>>>>> -
>>>>>> -
>>>>>> --------------------------------------
>>>>>>
>>>>>> # acl all src all
>>>>>>
>>>>>> acl src_self src 127.0.0.0/8
>>>>>> acl src_self src 10.46.11.69
>>>>>>
>>>>>> acl dst_self dst 127.0.0.0/8
>>>>>> acl dst_self dst 10.46.11.69
>>>>>>
>>>>>> acl from_arc src 10.46.0.0/15
>>>>>>
>>>>>> acl local_dst_addr dst 10.0.0.0/8
>>>>>> acl local_dst_addr dst 172.0.0.0/8 acl local_dst_addr dst
>>>>>> bldg3.<domain>.com acl local_dst_addr dst bldg5.<domain>.com
>>>>>>
>>>>>> # these keep URLs of popular local servers from being forwarded
>>>>>> acl local_dst_dom dstdomain arcgate
>>>>>>
>>>>>> # allow connects to local destinations without authentication # by
>>>>>> domain name from URL
>>>>>> http_access       allow local_dst_dom
>>>>>> http_reply_access allow local_dst_dom
>>>>>>
>>>>>> # by IP address name resolves to
>>>>>> http_access       allow local_dst_addr
>>>>>> http_reply_access allow local_dst_addr
>>>>>>
>>>>>> # allow trusted hosts without authentication # these are just ip's
>>>>>> on the 10.46.11.x network acl authless_src src "/etc/squid/authless_src"
>>>>>> http_access       allow authless_src
>>>>>> http_reply_access allow authless_src
>>>>>> ------------------------------------------------------------------
>>>>>> -
>>>>>> -
>>>>>> -
>>>>>> --------------------------------------
>>>>>>
>>>>>> -----Original Message-----
>>>>>> From: squid-users <squid-users-bounces at lists.squid-cache.org> On
>>>>>> Behalf Of Matus UHLAR - fantomas
>>>>>> Sent: Wednesday, August 28, 2024 10:47 AM
>>>>>> To: squid-users at lists.squid-cache.org
>>>>>> Subject: Re: [squid-users] Unable to access internal resources via
>>>>>> hostname
>>>>>>
>>>>>> Caution: This email originated from outside of Hexcel. Do not
>>>>>> click links or open attachments unless you recognize the sender
>>>>>> and know the content is safe.
>>>>>>
>>>>>>
>>>>>> On 28.08.24 14:20, Piana, Josh wrote:
>>>>>>> Hello Squid Support,
>>>>>>
>>>>>> This squid user forum FYI
>>>>>>
>>>>>>> We are unable to get to internal resources via hostname but using
>>>>>>> the IP address works fine.  Immediately, I thought this was DNS
>>>>>>> but when I checked the /etc/resolv.conf/ file it was pointing
>>>>>>> correctly to our Windows DNS server and we can ping all devices
>>>>>>> using their hostname, just not when browsing to it.  This leads
>>>>>>> me to believe something may be wrong with our squid config.
>>>>>>
>>>>>> hard to guess without seeing logs or ACL's.
>>>>>>
>>>>>>
>>>>>> --
>>>>>> Matus UHLAR - fantomas, uhlar at fantomas.sk



From scott.bates at gmail.com  Sat Aug 31 19:00:56 2024
From: scott.bates at gmail.com (Scott Bates)
Date: Sat, 31 Aug 2024 15:00:56 -0400
Subject: [squid-users] Squid traffic paths (Alex Rousskov)
Message-ID: <CAFB-0QaP4uZhUB3V-E4DRYizVD+k2Ja1hHeAgY8bysQvE9-xRA@mail.gmail.com>

The squid logs show traffic going to the expected destinations.

If I look at wireshark on one of the client systems I do see some http
entries going to those destinations through the squid server. However most
of the traffic (UDP / TCP) doesn't seem to be going through the squid
server.
I'm not sure how to force all traffic to use squid on the client system.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20240831/54942494/attachment.htm>

