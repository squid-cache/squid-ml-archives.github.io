<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Questions about Squid configuration
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Questions%20about%20Squid%20configuration&In-Reply-To=%3CCAK0%2B96e5Wpq3LpE4pf8k38nUpsmg%2BnyyocbOmnXS6%3DfqR%2B3C0g%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="027020.html">
   <LINK REL="Next"  HREF="027027.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Questions about Squid configuration</H1>
    <B>&#12395;&#12400;</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Questions%20about%20Squid%20configuration&In-Reply-To=%3CCAK0%2B96e5Wpq3LpE4pf8k38nUpsmg%2BnyyocbOmnXS6%3DfqR%2B3C0g%40mail.gmail.com%3E"
       TITLE="[squid-users] Questions about Squid configuration">taku0919.taku at gmail.com
       </A><BR>
    <I>Wed Aug  7 00:59:10 UTC 2024</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="027020.html">[squid-users] Parse DNS for IPv4 and IPv6
</A></li>
        <LI>Next message (by thread): <A HREF="027027.html">[squid-users] Questions about Squid configuration
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27022">[ date ]</a>
              <a href="thread.html#27022">[ thread ]</a>
              <a href="subject.html#27022">[ subject ]</a>
              <a href="author.html#27022">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Dear Squid Community

Nice to meet you. I am a newbie who just recently started using Squid.
I have a question about Squid configuration.
If there is any missing information or clarification, please let me know...

&#9632;Questions
When using Squid transparently, is it possible to control the
whitelist of the domain to connect to and inspect the Host field in
the request header together?
According to the verification results, the Host field can be inspected
by &quot;host_verify_strict on&quot; in squid-transparent.conf, but it seems
that the whitelist is not controlled.

&#9632;Requirements
&#12539;Proxy shall be transparently configured to accommodate clients that
cannot configure proxy settings.
&#12539;Communication is possible only with authorized domains using the
whitelist method.
&#12539;Whitelists are managed by domain, not IP address.
&#12539;Check the Host field in the request header and reject communication
if the value is invalid.
&#12539;If the actual destination IP is different from the result of name
resolution of the FQDN specified by SNI, communication is denied.

&#9632;Environment
server&#65306;AWS EC2
platform&#65306;Amazon Linux
Squid Cache&#65306;Version 4.15

&#9632;Configuration Details
&#12295;squid-transparent.conf&#65288;Excerpts&#65289;
#Whitelist
acl whitelist dstdomain &quot;/etc/squid/whitelist&quot;
acl whitelist dstdomain &quot;/etc/squid/whitelist_transparent&quot;
acl whitelist_https dstdomain &quot;/etc/squid/whitelist_https&quot;
acl whitelist_transparent_https dstdomain
&quot;/etc/squid/whitelist_transparent_https&quot;

proxy_protocol_access allow localnet
proxy_protocol_access deny all
http_access allow localnet whitelist
http_access deny localnet whitelist_https !https_port
http_access deny localnet whitelist_transparent_https !https_port

# Handling HTTP requests
http_port 3129 intercept
# Handling HTTPS requests
https_port 3130 intercept tcpkeepalive=60,30,3 ssl-bump
generate-host-certificates=on dynamic_cert_mem_cache_size=20MB
tls-cert=/etc/squid/ssl/squid.crt tls-key=/etc/squid/ssl/squid.key
cipher=HIGH:MEDIUM:!LOW:!RC4:!SEED:!IDEA:!3DES:!MD5:!EXP:!PSK:!DSS
options=NO_TLSv1,NO_SSLv3,SINGLE_DH_USE,SINGLE_ECDH_USE
tls-dh=prime256v1:/etc/squid/ssl/bump_dhparam.pem
# Start up for squid process
http_port 3131
http_access allow https_port
acl allowed_https_sites ssl::server_name &quot;/etc/squid/whitelist&quot;
acl allowed_https_sites ssl::server_name &quot;/etc/squid/whitelist_transparent&quot;
acl allowed_https_sites ssl::server_name &quot;/etc/squid/whitelist_https&quot;
acl allowed_https_sites ssl::server_name
&quot;/etc/squid/whitelist_transparent_https&quot;

http_access deny all

# strict setting
host_verify_strict on

# SSL_BUMP
sslcrtd_program /usr/lib64/squid/security_file_certgen -s
/var/lib/squid/ssl_db -M 20MB
acl step1 at_step SslBump1
acl step2 at_step SslBump2
acl step3 at_step SslBump3

ssl_bump bump all


&#12295;/etc/squid/whitelist
.pypi.org


&#9632;Verification of Settings
I ran the curl command from each of the client environments that use Squid.
1. if SNI, Destination IP, and HeaderHost are correct, the user should
be able to connect to pypi.org
Command:
date;curl <A HREF="https://pypi.org/">https://pypi.org/</A> -v --cacert squid_2.crt -k
Result: OK

2. rejection of communication to pypi.org if SNI is correct but
destination IP and HeaderHost are incorrect
Command:
date;curl <A HREF="https://pypi.org/">https://pypi.org/</A> --resolve pypi.org:443:182.22.24.252 -H
&quot;Host: www.yahoo.co.jp&quot;  -v --cacert squid_2.crt -k
Result: OK (409 Conflict is returned)

3. rejection of communication to pypi.org if SNI and destination IP
are correct and HeaderHost is incorrect
Command:
date;curl <A HREF="https://pypi.org/">https://pypi.org/</A> -H &quot;Host: www.yahoo.co.jp&quot; -v --cacert
squid_2.crt -k
Result: OK (409 Confilic returned)

4. rejection of communication to pypi.org if SNI and HeaderHost are
correct but destination IP is incorrect
Command:
date;curl <A HREF="https://pypi.org/">https://pypi.org/</A> --resolve pypi.org:443:182.22.24.252 -v
--cacert squid_2.crt -k
Result: OK (409 Confilic returned)

5. if SNI, destination IP, and HeaderHost are all invalid (yahoo.co.jp
not registered in whitelist), communication will be rejected
Command:
date;curl <A HREF="https://yahoo.co.jp/">https://yahoo.co.jp/</A> -v --cacert squid_2.crt -k
Result: NG (301 Moved Permanently is returned, but it appears that the
communication is reaching yahoo.co.jp)

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="027020.html">[squid-users] Parse DNS for IPv4 and IPv6
</A></li>
	<LI>Next message (by thread): <A HREF="027027.html">[squid-users] Questions about Squid configuration
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27022">[ date ]</a>
              <a href="thread.html#27022">[ thread ]</a>
              <a href="subject.html#27022">[ subject ]</a>
              <a href="author.html#27022">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
