<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Questions about Squid configuration
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Questions%20about%20Squid%20configuration&In-Reply-To=%3Cadd1024b-da05-46ba-9574-fd8048ec4fa1%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="027022.html">
   <LINK REL="Next"  HREF="027087.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Questions about Squid configuration</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Questions%20about%20Squid%20configuration&In-Reply-To=%3Cadd1024b-da05-46ba-9574-fd8048ec4fa1%40measurement-factory.com%3E"
       TITLE="[squid-users] Questions about Squid configuration">rousskov at measurement-factory.com
       </A><BR>
    <I>Thu Aug  8 12:32:55 UTC 2024</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="027022.html">[squid-users] Questions about Squid configuration
</A></li>
        <LI>Next message (by thread): <A HREF="027087.html">[squid-users] Questions about Squid configuration
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27027">[ date ]</a>
              <a href="thread.html#27027">[ thread ]</a>
              <a href="subject.html#27027">[ subject ]</a>
              <a href="author.html#27027">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 2024-08-06 20:59, &#12395;&#12400; wrote:

&gt;<i> When using Squid transparently, is it possible to control the
</I>&gt;<i> whitelist of the domain to connect to and inspect the Host field in
</I>&gt;<i> the request header together?
</I>
Short answer: Yes.


&gt;<i> According to the verification results, the Host field can be inspected
</I>&gt;<i> by &quot;host_verify_strict on&quot; in squid-transparent.conf, but it seems
</I>&gt;<i> that the whitelist is not controlled.
</I>
AFAICT, the configuration you have shared allows all banned[1] traffic 
to/through https_port. For the problematic test case #5:

All these http_access rules do _not_ match:

&gt;<i> http_access allow localnet whitelist
</I>&gt;<i> http_access deny localnet whitelist_https !https_port
</I>&gt;<i> http_access deny localnet whitelist_transparent_https !https_port
</I>

And then this next rule matches and allows traffic through:

&gt;<i> http_access allow https_port
</I>

This last http_access rule is not reached:

&gt;<i> http_access deny all
</I>

N.B. The above analysis assumes that your https_port ACL is explicitly 
defined in your squid.conf to match all traffic received at https_port. 
If you do not have such an ACL defined, then you need to fix that 
problem as well. I recommend naming ACLs differently from directive 
names (e.g., &quot;toHttpsPort&quot; rather than &quot;https_port&quot;).


Please note that Squid v4 is not supported by the Squid Project and is 
very buggy. I recommend using Squid v6 or later.


HTH,

Alex.
[1] Here, &quot;banned&quot; means &quot;_not_ matching whitelist ACL&quot;.


&gt;<i> &#9632;Configuration Details
</I>&gt;<i> &#12295;squid-transparent.conf&#65288;Excerpts&#65289;
</I>&gt;<i> #Whitelist
</I>&gt;<i> acl whitelist dstdomain &quot;/etc/squid/whitelist&quot;
</I>&gt;<i> acl whitelist dstdomain &quot;/etc/squid/whitelist_transparent&quot;
</I>&gt;<i> acl whitelist_https dstdomain &quot;/etc/squid/whitelist_https&quot;
</I>&gt;<i> acl whitelist_transparent_https dstdomain
</I>&gt;<i> &quot;/etc/squid/whitelist_transparent_https&quot;
</I>&gt;<i> 
</I>&gt;<i> proxy_protocol_access allow localnet
</I>&gt;<i> proxy_protocol_access deny all
</I>&gt;<i> http_access allow localnet whitelist
</I>&gt;<i> http_access deny localnet whitelist_https !https_port
</I>&gt;<i> http_access deny localnet whitelist_transparent_https !https_port
</I>&gt;<i> 
</I>&gt;<i> # Handling HTTP requests
</I>&gt;<i> http_port 3129 intercept
</I>&gt;<i> # Handling HTTPS requests
</I>&gt;<i> https_port 3130 intercept tcpkeepalive=60,30,3 ssl-bump
</I>&gt;<i> generate-host-certificates=on dynamic_cert_mem_cache_size=20MB
</I>&gt;<i> tls-cert=/etc/squid/ssl/squid.crt tls-key=/etc/squid/ssl/squid.key
</I>&gt;<i> cipher=HIGH:MEDIUM:!LOW:!RC4:!SEED:!IDEA:!3DES:!MD5:!EXP:!PSK:!DSS
</I>&gt;<i> options=NO_TLSv1,NO_SSLv3,SINGLE_DH_USE,SINGLE_ECDH_USE
</I>&gt;<i> tls-dh=prime256v1:/etc/squid/ssl/bump_dhparam.pem
</I>&gt;<i> # Start up for squid process
</I>&gt;<i> http_port 3131
</I>&gt;<i> http_access allow https_port
</I>&gt;<i> acl allowed_https_sites ssl::server_name &quot;/etc/squid/whitelist&quot;
</I>&gt;<i> acl allowed_https_sites ssl::server_name &quot;/etc/squid/whitelist_transparent&quot;
</I>&gt;<i> acl allowed_https_sites ssl::server_name &quot;/etc/squid/whitelist_https&quot;
</I>&gt;<i> acl allowed_https_sites ssl::server_name
</I>&gt;<i> &quot;/etc/squid/whitelist_transparent_https&quot;
</I>&gt;<i> 
</I>&gt;<i> http_access deny all
</I>&gt;<i> 
</I>&gt;<i> # strict setting
</I>&gt;<i> host_verify_strict on
</I>&gt;<i> 
</I>&gt;<i> # SSL_BUMP
</I>&gt;<i> sslcrtd_program /usr/lib64/squid/security_file_certgen -s
</I>&gt;<i> /var/lib/squid/ssl_db -M 20MB
</I>&gt;<i> acl step1 at_step SslBump1
</I>&gt;<i> acl step2 at_step SslBump2
</I>&gt;<i> acl step3 at_step SslBump3
</I>&gt;<i> 
</I>&gt;<i> ssl_bump bump all
</I>

&gt;<i> &#9632;Verification of Settings
</I>&gt;<i> I ran the curl command from each of the client environments that use Squid.
</I>&gt;<i> 1. if SNI, Destination IP, and HeaderHost are correct, the user should
</I>&gt;<i> be able to connect to pypi.org
</I>&gt;<i> Command:
</I>&gt;<i> date;curl <A HREF="https://pypi.org/">https://pypi.org/</A> -v --cacert squid_2.crt -k
</I>&gt;<i> Result: OK
</I>&gt;<i> 
</I>&gt;<i> 2. rejection of communication to pypi.org if SNI is correct but
</I>&gt;<i> destination IP and HeaderHost are incorrect
</I>&gt;<i> Command:
</I>&gt;<i> date;curl <A HREF="https://pypi.org/">https://pypi.org/</A> --resolve pypi.org:443:182.22.24.252 -H
</I>&gt;<i> &quot;Host: www.yahoo.co.jp&quot;  -v --cacert squid_2.crt -k
</I>&gt;<i> Result: OK (409 Conflict is returned)
</I>&gt;<i> 
</I>&gt;<i> 3. rejection of communication to pypi.org if SNI and destination IP
</I>&gt;<i> are correct and HeaderHost is incorrect
</I>&gt;<i> Command:
</I>&gt;<i> date;curl <A HREF="https://pypi.org/">https://pypi.org/</A> -H &quot;Host: www.yahoo.co.jp&quot; -v --cacert
</I>&gt;<i> squid_2.crt -k
</I>&gt;<i> Result: OK (409 Confilic returned)
</I>&gt;<i> 
</I>&gt;<i> 4. rejection of communication to pypi.org if SNI and HeaderHost are
</I>&gt;<i> correct but destination IP is incorrect
</I>&gt;<i> Command:
</I>&gt;<i> date;curl <A HREF="https://pypi.org/">https://pypi.org/</A> --resolve pypi.org:443:182.22.24.252 -v
</I>&gt;<i> --cacert squid_2.crt -k
</I>&gt;<i> Result: OK (409 Confilic returned)
</I>&gt;<i> 
</I>&gt;<i> 5. if SNI, destination IP, and HeaderHost are all invalid (yahoo.co.jp
</I>&gt;<i> not registered in whitelist), communication will be rejected
</I>&gt;<i> Command:
</I>&gt;<i> date;curl <A HREF="https://yahoo.co.jp/">https://yahoo.co.jp/</A> -v --cacert squid_2.crt -k
</I>&gt;<i> Result: NG (301 Moved Permanently is returned, but it appears that the
</I>&gt;<i> communication is reaching yahoo.co.jp)
</I>




</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="027022.html">[squid-users] Questions about Squid configuration
</A></li>
	<LI>Next message (by thread): <A HREF="027087.html">[squid-users] Questions about Squid configuration
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27027">[ date ]</a>
              <a href="thread.html#27027">[ thread ]</a>
              <a href="subject.html#27027">[ subject ]</a>
              <a href="author.html#27027">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
