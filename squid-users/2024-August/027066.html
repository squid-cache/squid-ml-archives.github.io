<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Unable to access local addresses
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Unable%20to%20access%20local%20addresses&In-Reply-To=%3C231fb248-bbe0-4a4a-a4a7-b516df1cb35b%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="027065.html">
   <LINK REL="Next"  HREF="027067.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Unable to access local addresses</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Unable%20to%20access%20local%20addresses&In-Reply-To=%3C231fb248-bbe0-4a4a-a4a7-b516df1cb35b%40measurement-factory.com%3E"
       TITLE="[squid-users] Unable to access local addresses">rousskov at measurement-factory.com
       </A><BR>
    <I>Fri Aug 23 17:13:55 UTC 2024</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="027065.html">[squid-users] Unable to access local addresses
</A></li>
        <LI>Next message (by thread): <A HREF="027067.html">[squid-users] Squid Vulnerabilities
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27066">[ date ]</a>
              <a href="thread.html#27066">[ thread ]</a>
              <a href="subject.html#27066">[ subject ]</a>
              <a href="author.html#27066">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 2024-08-23 12:07, Piana, Josh wrote:

&gt;<i> The problem we&#8217;re having now is that we&#8217;re unable to access local 
</I>&gt;<i> resources on different subnets. For instance, our &#8220;main&#8221; networks are 
</I>&gt;<i> 10.46.x.x and 10.47.x.x, but the proxy is blocking us when we try to get 
</I>&gt;<i> to 172.26.x.x as well as 10.96.x.x. 
</I>
Blocking how? What kind of error page does the client get? What does 
Squid log to access.log (consider adding %err_code/%err_detail to your 
custom logformat definition if you have not already).

If access is blocked by an &quot;http_access deny&quot; rule you do not expect to 
match, then which &quot;http_access allow&quot; rule (located above the matched 
deny rule[^1]) do you expect to match those blocked transactions? If 
access is prevented due to connection establishment errors, then you may 
need to adjust your IP routing rules/etc. outside of Squid. And there 
are many other possibilities here...

[1]: If access is blocked by an &quot;http_access deny&quot; rule, you may be able 
to figure out which deny rule has matched by enabling ALL,2 debugging 
(see debug_options in squid.conf.documented), reproducing the problem 
using a single transaction, and searching cache.log for &quot;last ACL 
checked&quot;. Older Squids have more bugs in determining that ACL name, but, 
if you are lucky, you will get the right answer.


&gt;<i> When comparing our current config to 
</I>&gt;<i> the old, they are very nearly identical, and the old config works with 
</I>&gt;<i> no issue. Is there some change from 2.5 -&gt; 5.5 that would stop some of 
</I>&gt;<i> our allow/deny rules from working as expected?
</I>
There are too many corner cases for me to give a reliable answer to that 
question, especially without knowing which http_access rule is denying 
access (assuming it is one of those rules). I recommend focusing on a 
specific matching/mismatching ACL/rule instead of trying to make a 
general statement regarding numerous v2-vs-v5 differences.


&gt;<i> Or maybe I need to open 
</I>&gt;<i> up the ACL&#8217;s a bit more or define those subnets explicitly now?
</I>
If your existing rules already reflect your business logic and do not 
trigger any Squid configuration errors/warnings in cache.log, then it is 
unlikely that you will need to add explicit rules for previously working 
subnets. On the other hand, you are upgrading from an ancient Squid 
version that most do not remember much about to an already unsupported 
Squid version, so all bets are off.

 &gt; acl from_arc src 10.46.0.0/16
 &gt; acl from_arc src 10.46.0.0/15

Remove the line you do not need (I do not know which one, but the 
combination does not make sense because one subnet includes the other).


 &gt; dsacl methods_std method GET HEAD POST PUT DELETE

If this is not a copy-paste typo, then edit this line to use a supported 
directive name like &quot;acl&quot;. &quot;dsacl&quot; is not a supported directive name.


HTH,

Alex.


&gt;<i> I can post our config below, I&#8217;ll skip the sections that most likely 
</I>&gt;<i> don&#8217;t pertain to the issue.
</I>&gt;<i> 
</I>&gt;<i> ##############################################################################
</I>&gt;<i> 
</I>&gt;<i> # Authentication
</I>&gt;<i> 
</I>&gt;<i> ##############################################################################
</I>&gt;<i> 
</I>&gt;<i> auth_param negotiate program /usr/lib64/squid/negotiate_kerberos_auth -k 
</I>&gt;<i> /etc/squid/HTTP.keytab -s HTTP/&lt;domain&gt;.ad.&lt;domain&gt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">.com at AD.</A>&lt;domain&gt;.COM
</I>&gt;<i> 
</I>&gt;<i> auth_param negotiate children 10
</I>&gt;<i> 
</I>&gt;<i> auth_param negotiate keep_alive on
</I>&gt;<i> 
</I>&gt;<i> acl kerb-auth proxy_auth REQUIRED
</I>&gt;<i> 
</I>&gt;<i> ##############################################################################
</I>&gt;<i> 
</I>&gt;<i> # Access control - shared/common ACL definitions
</I>&gt;<i> 
</I>&gt;<i> ##############################################################################
</I>&gt;<i> 
</I>&gt;<i> # acl all src all
</I>&gt;<i> 
</I>&gt;<i> acl src_self src 127.0.0.0/8
</I>&gt;<i> 
</I>&gt;<i> acl src_self src 10.46.11.69
</I>&gt;<i> 
</I>&gt;<i> acl dst_self dst 127.0.0.0/8
</I>&gt;<i> 
</I>&gt;<i> acl dst_self dst 10.46.11.69
</I>&gt;<i> 
</I>&gt;<i> acl from_arc src 10.46.0.0/16
</I>&gt;<i> 
</I>&gt;<i> acl from_arc src 10.46.0.0/15
</I>&gt;<i> 
</I>&gt;<i> acl local_dst_addr dst 10.0.0.0/8
</I>&gt;<i> 
</I>&gt;<i> acl local_dst_addr dst bldg3.&lt;domain&gt;.com
</I>&gt;<i> 
</I>&gt;<i> acl local_dst_addr dst bldg5.&lt;domain&gt;.com
</I>&gt;<i> 
</I>&gt;<i> # not sure what this does
</I>&gt;<i> 
</I>&gt;<i> acl local_dst_dom dstdomain &lt;proxy hostname&gt;
</I>&gt;<i> 
</I>&gt;<i> # protocols
</I>&gt;<i> 
</I>&gt;<i> acl proto_FTP proto FTP
</I>&gt;<i> 
</I>&gt;<i> acl proto_HTTP proto HTTP
</I>&gt;<i> 
</I>&gt;<i> # TCP ports for HTTP
</I>&gt;<i> 
</I>&gt;<i> acl http_ports port 80
</I>&gt;<i> 
</I>&gt;<i> acl http_ports port 81
</I>&gt;<i> 
</I>&gt;<i> # TCP ports for HTTPS
</I>&gt;<i> 
</I>&gt;<i> acl ssl_ports port 443
</I>&gt;<i> 
</I>&gt;<i> acl ssh_ports port 22
</I>&gt;<i> 
</I>&gt;<i> acl ftp_ports port 21
</I>&gt;<i> 
</I>&gt;<i> # HTTP methods
</I>&gt;<i> 
</I>&gt;<i> acl method_CONNECT method CONNECT
</I>&gt;<i> 
</I>&gt;<i> # what are these used for?
</I>&gt;<i> 
</I>&gt;<i> dsacl methods_std method GET HEAD POST PUT DELETE
</I>&gt;<i> 
</I>&gt;<i> acl methods_std method TRACE OPTIONS
</I>&gt;<i> 
</I>&gt;<i> #############################################################################
</I>&gt;<i> 
</I>&gt;<i> # Access control - general proxy
</I>&gt;<i> 
</I>&gt;<i> ##############################################################################
</I>&gt;<i> 
</I>&gt;<i> http_access deny dst_self
</I>&gt;<i> 
</I>&gt;<i> http_access deny src_self
</I>&gt;<i> 
</I>&gt;<i> http_access deny !from_arc
</I>&gt;<i> 
</I>&gt;<i> http_access&#160;&#160;&#160;&#160;&#160;&#160; allow local_dst_dom
</I>&gt;<i> 
</I>&gt;<i> http_reply_access &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; allow local_dst_dom
</I>&gt;<i> 
</I>&gt;<i> http_access&#160;&#160;&#160;&#160;&#160;&#160; allow local_dst_addr
</I>&gt;<i> 
</I>&gt;<i> http_reply_access &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; allow local_dst_addr
</I>&gt;<i> 
</I>&gt;<i> acl authless_src src &quot;/etc/squid/authless_src&quot;
</I>&gt;<i> 
</I>&gt;<i> http_access&#160;&#160;&#160;&#160;&#160;&#160; allow authless_src
</I>&gt;<i> 
</I>&gt;<i> http_reply_access &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; allow authless_src
</I>&gt;<i> 
</I>&gt;<i> acl authless_dst dstdomain &quot;/etc/squid/authless_dst&quot;
</I>&gt;<i> 
</I>&gt;<i> http_access&#160;&#160;&#160;&#160;&#160;&#160; allow authless_dst
</I>&gt;<i> 
</I>&gt;<i> http_reply_access &#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; allow authless_dst
</I>&gt;<i> 
</I>&gt;<i> acl bad_domains_preauth dstdomain &quot;/etc/squid/bad_domains_preauth&quot;
</I>&gt;<i> 
</I>&gt;<i> http_access deny bad_domains_preauth
</I>&gt;<i> 
</I>&gt;<i> acl block_user proxy_auth_regex -i &quot;/etc/squid/block_user&quot;
</I>&gt;<i> 
</I>&gt;<i> http_access deny block_user
</I>&gt;<i> 
</I>&gt;<i> acl bad_exception_urls url_regex -i &quot;/etc/squid/bad_exception_urls&quot;
</I>&gt;<i> 
</I>&gt;<i> acl exec_files url_regex -i &quot;/etc/squid/exec_files&quot;
</I>&gt;<i> 
</I>&gt;<i> acl exec_users proxy_auth_regex -i &quot;/etc/squid/exec_users&quot;
</I>&gt;<i> 
</I>&gt;<i> http_access deny !bad_exception_urls !exec_users exec_files
</I>&gt;<i> 
</I>&gt;<i> deny_info ERR_BLOCK_TYPE exec_files
</I>&gt;<i> 
</I>&gt;<i> acl mmedia_users proxy_auth_regex -i &quot;/etc/squid/mmedia_users&quot;
</I>&gt;<i> 
</I>&gt;<i> acl mmedia_sites dstdomain &quot;/etc/squid/mmedia_sites&quot;
</I>&gt;<i> 
</I>&gt;<i> http_access&#160;&#160;&#160;&#160;&#160;&#160; allow methods_std&#160;&#160;&#160; proto_HTTP http_ports 
</I>&gt;<i> mmedia_sites mmedia_users
</I>&gt;<i> 
</I>&gt;<i> http_reply_access allow methods_std&#160;&#160;&#160; proto_HTTP http_ports 
</I>&gt;<i> mmedia_sites mmedia_users
</I>&gt;<i> 
</I>&gt;<i> http_access&#160;&#160;&#160;&#160;&#160;&#160; allow method_CONNECT&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; ssl_ports  
</I>&gt;<i> mmedia_sites mmedia_users
</I>&gt;<i> 
</I>&gt;<i> http_reply_access allow method_CONNECT&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; ssl_ports  
</I>&gt;<i> mmedia_sites mmedia_users
</I>&gt;<i> 
</I>&gt;<i> acl bad_domains dstdomain &quot;/etc/squid/bad_domains&quot;
</I>&gt;<i> 
</I>&gt;<i> http_access deny !bad_exception_urls bad_domains
</I>&gt;<i> 
</I>&gt;<i> deny_info ERR_BLOCK_DST&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; bad_domains
</I>&gt;<i> 
</I>&gt;<i> acl bad_domains_regex dstdom_regex -i &quot;/etc/squid/bad_domains_regex&quot;
</I>&gt;<i> 
</I>&gt;<i> http_access deny !bad_exception_urls bad_domains_regex
</I>&gt;<i> 
</I>&gt;<i> deny_info ERR_BLOCK_DST&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; bad_domains_regex
</I>&gt;<i> 
</I>&gt;<i> acl bad_urls url_regex -i &quot;/etc/squid/bad_urls&quot;
</I>&gt;<i> 
</I>&gt;<i> http_access deny !bad_exception_urls bad_urls
</I>&gt;<i> 
</I>&gt;<i> deny_info ERR_BLOCK_DST&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; bad_urls
</I>&gt;<i> 
</I>&gt;<i> acl bad_files urlpath_regex -i &quot;/etc/squid/bad_files&quot;
</I>&gt;<i> 
</I>&gt;<i> http_access deny !bad_exception_urls bad_files
</I>&gt;<i> 
</I>&gt;<i> deny_info ERR_BLOCK_TYPE bad_files
</I>&gt;<i> 
</I>&gt;<i> acl bad_types rep_mime_type -i &quot;/etc/squid/bad_types&quot;
</I>&gt;<i> 
</I>&gt;<i> http_reply_access deny bad_types !bad_exception_urls
</I>&gt;<i> 
</I>&gt;<i> deny_info ERR_BLOCK_TYPE bad_types
</I>&gt;<i> 
</I>&gt;<i> acl fsoguest_user proxy_auth_regex -i fsoguest
</I>&gt;<i> 
</I>&gt;<i> acl fsoguest_dst dstdomain .opm.gov
</I>&gt;<i> 
</I>&gt;<i> acl fsoguest_dst dstdomain .google-analytics.com
</I>&gt;<i> 
</I>&gt;<i> acl fsoguest_dst dstdomain pki.google.com
</I>&gt;<i> 
</I>&gt;<i> acl fsoguest_dst dstdomain ajax.googleapis.com
</I>&gt;<i> 
</I>&gt;<i> acl fsoguest_dst dstdomain fonts.googleapis.com
</I>&gt;<i> 
</I>&gt;<i> acl fsoguest_dst dstdomain html5shiv.googlecode.com
</I>&gt;<i> 
</I>&gt;<i> acl fsoguest_dst dstdomain fonts.gstatic.com
</I>&gt;<i> 
</I>&gt;<i> acl fsoguest_dst dstdomain clients1.google.com
</I>&gt;<i> 
</I>&gt;<i> acl fsoguest_dst dstdomain ajax.microsoft.com
</I>&gt;<i> 
</I>&gt;<i> acl fsoguest_dst dstdomain ajax.aspnetcdn.com
</I>&gt;<i> 
</I>&gt;<i> acl fsoguest_dst dstdomain .geotrust.com
</I>&gt;<i> 
</I>&gt;<i> acl fsoguest_dst dstdomain .akamaihd.net
</I>&gt;<i> 
</I>&gt;<i> acl fsoguest_dst dstdomain symcd.com
</I>&gt;<i> 
</I>&gt;<i> http_access allow methods_std proto_HTTP http_ports fsoguest_dst 
</I>&gt;<i> fsoguest_user
</I>&gt;<i> 
</I>&gt;<i> http_access allow method_CONNECT&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; ssl_ports&#160; fsoguest_dst 
</I>&gt;<i> fsoguest_user
</I>&gt;<i> 
</I>&gt;<i> http_access deny fsoguest_user
</I>&gt;<i> 
</I>&gt;<i> http_access allow http_ports proto_HTTP methods_std
</I>&gt;<i> 
</I>&gt;<i> http_access allow method_CONNECT ssl_ports
</I>&gt;<i> 
</I>&gt;<i> http_access deny method_CONNECT
</I>&gt;<i> 
</I>&gt;<i> # catch-all
</I>&gt;<i> 
</I>&gt;<i> http_access allow ftp_ports proto_FTP
</I>&gt;<i> 
</I>&gt;<i> http_access allow kerb-auth
</I>&gt;<i> 
</I>&gt;<i> http_access deny all
</I>&gt;<i> 
</I>&gt;<i> http_reply_access allow all
</I>&gt;<i> 
</I>&gt;<i> ##############################################################################
</I>&gt;<i> 
</I>&gt;<i> # END OF FILE
</I>&gt;<i> 
</I>&gt;<i> ##############################################################################
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">https://lists.squid-cache.org/listinfo/squid-users</A>
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="027065.html">[squid-users] Unable to access local addresses
</A></li>
	<LI>Next message (by thread): <A HREF="027067.html">[squid-users] Squid Vulnerabilities
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27066">[ date ]</a>
              <a href="thread.html#27066">[ thread ]</a>
              <a href="subject.html#27066">[ subject ]</a>
              <a href="author.html#27066">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
