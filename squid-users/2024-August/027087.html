<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Questions about Squid configuration
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Questions%20about%20Squid%20configuration&In-Reply-To=%3CCAK0%2B96eD%2BB2c_Fa3TpjE5E89WPsY-VaNadDSHK1ritgemkjrTw%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="027027.html">
   <LINK REL="Next"  HREF="027089.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Questions about Squid configuration</H1>
    <B>&#12395;&#12400;</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Questions%20about%20Squid%20configuration&In-Reply-To=%3CCAK0%2B96eD%2BB2c_Fa3TpjE5E89WPsY-VaNadDSHK1ritgemkjrTw%40mail.gmail.com%3E"
       TITLE="[squid-users] Questions about Squid configuration">taku0919.taku at gmail.com
       </A><BR>
    <I>Fri Aug 30 02:28:11 UTC 2024</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="027027.html">[squid-users] Questions about Squid configuration
</A></li>
        <LI>Next message (by thread): <A HREF="027089.html">[squid-users] Questions about Squid configuration
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27087">[ date ]</a>
              <a href="thread.html#27087">[ thread ]</a>
              <a href="subject.html#27087">[ subject ]</a>
              <a href="author.html#27087">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Alex, people in the Suquid community
I really appreciate your cooperation.

I am continuing to verify this based on the responses I have received.

With the newly reviewed configuration in the attachment,
I was able to confirm that any one of the SNI, IP, or Host in the
request is incorrect (not whitelist allowed)
and Squid will correctly check and return a 409 Conflict.

However, I found the following statement in the following official document
<A HREF="https://www.squid-cache.org/Doc/config/host_verify_strict/">https://www.squid-cache.org/Doc/config/host_verify_strict/</A>

&#65310; * The host names (domain or IP) must be identical,
&#65310; but valueless or missing Host header disables all checks.
&#65310; For the two host names to match, both must be either IP
&#65310; or FQDN.

So I ran an additional validation with an empty Host value, and the
request succeeded for a domain that was not in the whitelist.
The curl command for verification is below, and as before, only
.pypi.org is allowed in the whitelist.

date;curl <A HREF="https://www.yahoo.co.jp/">https://www.yahoo.co.jp/</A> -H &quot;Host:&quot; -v --cacert squid.crt -k

Is it possible for Squid to prevent such requests as well?
Are there other patterns of requests that cannot be prevented by the
current setup?
Please advise if you have any information.

2024&#24180;8&#26376;8&#26085;(&#26408;) 21:33 Alex Rousskov &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt;:
&gt;<i>
</I>&gt;<i> On 2024-08-06 20:59, &#12395;&#12400; wrote:
</I>&gt;<i>
</I>&gt;<i> &gt; When using Squid transparently, is it possible to control the
</I>&gt;<i> &gt; whitelist of the domain to connect to and inspect the Host field in
</I>&gt;<i> &gt; the request header together?
</I>&gt;<i>
</I>&gt;<i> Short answer: Yes.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; According to the verification results, the Host field can be inspected
</I>&gt;<i> &gt; by &quot;host_verify_strict on&quot; in squid-transparent.conf, but it seems
</I>&gt;<i> &gt; that the whitelist is not controlled.
</I>&gt;<i>
</I>&gt;<i> AFAICT, the configuration you have shared allows all banned[1] traffic
</I>&gt;<i> to/through https_port. For the problematic test case #5:
</I>&gt;<i>
</I>&gt;<i> All these http_access rules do _not_ match:
</I>&gt;<i>
</I>&gt;<i> &gt; http_access allow localnet whitelist
</I>&gt;<i> &gt; http_access deny localnet whitelist_https !https_port
</I>&gt;<i> &gt; http_access deny localnet whitelist_transparent_https !https_port
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> And then this next rule matches and allows traffic through:
</I>&gt;<i>
</I>&gt;<i> &gt; http_access allow https_port
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> This last http_access rule is not reached:
</I>&gt;<i>
</I>&gt;<i> &gt; http_access deny all
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> N.B. The above analysis assumes that your https_port ACL is explicitly
</I>&gt;<i> defined in your squid.conf to match all traffic received at https_port.
</I>&gt;<i> If you do not have such an ACL defined, then you need to fix that
</I>&gt;<i> problem as well. I recommend naming ACLs differently from directive
</I>&gt;<i> names (e.g., &quot;toHttpsPort&quot; rather than &quot;https_port&quot;).
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Please note that Squid v4 is not supported by the Squid Project and is
</I>&gt;<i> very buggy. I recommend using Squid v6 or later.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> HTH,
</I>&gt;<i>
</I>&gt;<i> Alex.
</I>&gt;<i> [1] Here, &quot;banned&quot; means &quot;_not_ matching whitelist ACL&quot;.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; &#9632;Configuration Details
</I>&gt;<i> &gt; &#12295;squid-transparent.conf&#65288;Excerpts&#65289;
</I>&gt;<i> &gt; #Whitelist
</I>&gt;<i> &gt; acl whitelist dstdomain &quot;/etc/squid/whitelist&quot;
</I>&gt;<i> &gt; acl whitelist dstdomain &quot;/etc/squid/whitelist_transparent&quot;
</I>&gt;<i> &gt; acl whitelist_https dstdomain &quot;/etc/squid/whitelist_https&quot;
</I>&gt;<i> &gt; acl whitelist_transparent_https dstdomain
</I>&gt;<i> &gt; &quot;/etc/squid/whitelist_transparent_https&quot;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; proxy_protocol_access allow localnet
</I>&gt;<i> &gt; proxy_protocol_access deny all
</I>&gt;<i> &gt; http_access allow localnet whitelist
</I>&gt;<i> &gt; http_access deny localnet whitelist_https !https_port
</I>&gt;<i> &gt; http_access deny localnet whitelist_transparent_https !https_port
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; # Handling HTTP requests
</I>&gt;<i> &gt; http_port 3129 intercept
</I>&gt;<i> &gt; # Handling HTTPS requests
</I>&gt;<i> &gt; https_port 3130 intercept tcpkeepalive=60,30,3 ssl-bump
</I>&gt;<i> &gt; generate-host-certificates=on dynamic_cert_mem_cache_size=20MB
</I>&gt;<i> &gt; tls-cert=/etc/squid/ssl/squid.crt tls-key=/etc/squid/ssl/squid.key
</I>&gt;<i> &gt; cipher=HIGH:MEDIUM:!LOW:!RC4:!SEED:!IDEA:!3DES:!MD5:!EXP:!PSK:!DSS
</I>&gt;<i> &gt; options=NO_TLSv1,NO_SSLv3,SINGLE_DH_USE,SINGLE_ECDH_USE
</I>&gt;<i> &gt; tls-dh=prime256v1:/etc/squid/ssl/bump_dhparam.pem
</I>&gt;<i> &gt; # Start up for squid process
</I>&gt;<i> &gt; http_port 3131
</I>&gt;<i> &gt; http_access allow https_port
</I>&gt;<i> &gt; acl allowed_https_sites ssl::server_name &quot;/etc/squid/whitelist&quot;
</I>&gt;<i> &gt; acl allowed_https_sites ssl::server_name &quot;/etc/squid/whitelist_transparent&quot;
</I>&gt;<i> &gt; acl allowed_https_sites ssl::server_name &quot;/etc/squid/whitelist_https&quot;
</I>&gt;<i> &gt; acl allowed_https_sites ssl::server_name
</I>&gt;<i> &gt; &quot;/etc/squid/whitelist_transparent_https&quot;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; http_access deny all
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; # strict setting
</I>&gt;<i> &gt; host_verify_strict on
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; # SSL_BUMP
</I>&gt;<i> &gt; sslcrtd_program /usr/lib64/squid/security_file_certgen -s
</I>&gt;<i> &gt; /var/lib/squid/ssl_db -M 20MB
</I>&gt;<i> &gt; acl step1 at_step SslBump1
</I>&gt;<i> &gt; acl step2 at_step SslBump2
</I>&gt;<i> &gt; acl step3 at_step SslBump3
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; ssl_bump bump all
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; &#9632;Verification of Settings
</I>&gt;<i> &gt; I ran the curl command from each of the client environments that use Squid.
</I>&gt;<i> &gt; 1. if SNI, Destination IP, and HeaderHost are correct, the user should
</I>&gt;<i> &gt; be able to connect to pypi.org
</I>&gt;<i> &gt; Command:
</I>&gt;<i> &gt; date;curl <A HREF="https://pypi.org/">https://pypi.org/</A> -v --cacert squid_2.crt -k
</I>&gt;<i> &gt; Result: OK
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; 2. rejection of communication to pypi.org if SNI is correct but
</I>&gt;<i> &gt; destination IP and HeaderHost are incorrect
</I>&gt;<i> &gt; Command:
</I>&gt;<i> &gt; date;curl <A HREF="https://pypi.org/">https://pypi.org/</A> --resolve pypi.org:443:182.22.24.252 -H
</I>&gt;<i> &gt; &quot;Host: www.yahoo.co.jp&quot;  -v --cacert squid_2.crt -k
</I>&gt;<i> &gt; Result: OK (409 Conflict is returned)
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; 3. rejection of communication to pypi.org if SNI and destination IP
</I>&gt;<i> &gt; are correct and HeaderHost is incorrect
</I>&gt;<i> &gt; Command:
</I>&gt;<i> &gt; date;curl <A HREF="https://pypi.org/">https://pypi.org/</A> -H &quot;Host: www.yahoo.co.jp&quot; -v --cacert
</I>&gt;<i> &gt; squid_2.crt -k
</I>&gt;<i> &gt; Result: OK (409 Confilic returned)
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; 4. rejection of communication to pypi.org if SNI and HeaderHost are
</I>&gt;<i> &gt; correct but destination IP is incorrect
</I>&gt;<i> &gt; Command:
</I>&gt;<i> &gt; date;curl <A HREF="https://pypi.org/">https://pypi.org/</A> --resolve pypi.org:443:182.22.24.252 -v
</I>&gt;<i> &gt; --cacert squid_2.crt -k
</I>&gt;<i> &gt; Result: OK (409 Confilic returned)
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; 5. if SNI, destination IP, and HeaderHost are all invalid (yahoo.co.jp
</I>&gt;<i> &gt; not registered in whitelist), communication will be rejected
</I>&gt;<i> &gt; Command:
</I>&gt;<i> &gt; date;curl <A HREF="https://yahoo.co.jp/">https://yahoo.co.jp/</A> -v --cacert squid_2.crt -k
</I>&gt;<i> &gt; Result: NG (301 Moved Permanently is returned, but it appears that the
</I>&gt;<i> &gt; communication is reaching yahoo.co.jp)
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">https://lists.squid-cache.org/listinfo/squid-users</A>
</I>-------------- next part --------------
A non-text attachment was scrubbed...
Name: squid-transparent.conf
Type: application/octet-stream
Size: 3409 bytes
Desc: not available
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20240830/dbd8641e/attachment.obj">http://lists.squid-cache.org/pipermail/squid-users/attachments/20240830/dbd8641e/attachment.obj</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="027027.html">[squid-users] Questions about Squid configuration
</A></li>
	<LI>Next message (by thread): <A HREF="027089.html">[squid-users] Questions about Squid configuration
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27087">[ date ]</a>
              <a href="thread.html#27087">[ thread ]</a>
              <a href="subject.html#27087">[ subject ]</a>
              <a href="author.html#27087">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
