<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Questions about Squid configuration
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Questions%20about%20Squid%20configuration&In-Reply-To=%3Cc6889a69-d559-4180-ae27-5083e850329b%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="027087.html">
   <LINK REL="Next"  HREF="027023.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Questions about Squid configuration</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Questions%20about%20Squid%20configuration&In-Reply-To=%3Cc6889a69-d559-4180-ae27-5083e850329b%40measurement-factory.com%3E"
       TITLE="[squid-users] Questions about Squid configuration">rousskov at measurement-factory.com
       </A><BR>
    <I>Fri Aug 30 13:27:46 UTC 2024</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="027087.html">[squid-users] Questions about Squid configuration
</A></li>
        <LI>Next message (by thread): <A HREF="027023.html">[squid-users] squid 5.7 FTP upload fails
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27089">[ date ]</a>
              <a href="thread.html#27089">[ thread ]</a>
              <a href="subject.html#27089">[ subject ]</a>
              <a href="author.html#27089">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 2024-08-29 22:28, &#12395;&#12400; wrote:

&gt;<i> With the newly reviewed configuration in the attachment
</I>
OT: Please note that your configuration does not follow the recommended 
http_access rules order template in squid.conf.default and might, 
depending on your deployment environment, allow Squid to be used for 
attacks on 3rd party resources (e.g., ssh services). This observation is 
not related to your primary question and your &quot;ban certain sites&quot; goal. 
Following suggestions at the end of this email should fix this problem.


&gt;<i> I found the following statement in the following official document
</I>&gt;<i> <A HREF="https://www.squid-cache.org/Doc/config/host_verify_strict/">https://www.squid-cache.org/Doc/config/host_verify_strict/</A>
</I>&gt;<i> 
</I>&gt;<i> &#65310; * The host names (domain or IP) must be identical,
</I>&gt;<i> &#65310; but valueless or missing Host header disables all checks.
</I>&gt;<i> 
</I>&gt;<i> So I ran an additional validation with an empty Host value, and the
</I>&gt;<i> request succeeded for a domain that was not in the whitelist.
</I>&gt;<i> The curl command for verification is below, and as before, only
</I>&gt;<i> .pypi.org is allowed in the whitelist.
</I>&gt;<i> 
</I>&gt;<i> date;curl <A HREF="https://www.yahoo.co.jp/">https://www.yahoo.co.jp/</A> -H &quot;Host:&quot; -v --cacert squid.crt -k
</I>&gt;<i> 
</I>&gt;<i> Is it possible for Squid to prevent such requests as well?
</I>
Yes, a req_header ACL should be able to detect such requests (i.e. 
requests without a Host header or with an empty Host header value). 
However, I suspect that &quot;missing Host&quot; is _not_ the problem you should 
be solving (as detailed below).


&gt;<i> I was able to confirm that any one of the SNI, IP, or Host in the
</I>&gt;<i> request is incorrect (not whitelist allowed)
</I>&gt;<i> and Squid will correctly check and return a 409 Conflict.
</I>
IMHO, you should target/validate a different set of goals/conditions:

* A valid request targeting a banned site should be denied (HTTP 403 
response, %Ss=TCP_DENIED, %err_code=ERR_ACCESS_DENIED). This denial 
should be triggered by an &quot;http_access deny&quot; rule, preferably an 
explicit one. This denial will _not_ happen (and the request will 
instead be forwarded to the banned site it targets) if you replace all 
your http_access rules with a single &quot;http_access allow all&quot; line. This 
denial does not depend on host_verify_strict and underlying code.

* An invalid request should be rejected (HTTP 4xx response). This 
includes, but is not limited to, host_verify_strict-driven rejections. 
This rejection should happen even if you replace all your http_access 
rules with a single &quot;http_access allow all&quot; line.

AFAICT, your current configuration does not reach &quot;deny valid requests 
targeting banned sites&quot; goal while your question implies that you are 
incorrectly relying on host_verify_strict to perform that denial.


I recommend the following:

1. Remove all of your current http_access rules. Keep ACLs. Perform 
host_verify_strict and access tests to confirm that all valid requests 
are denied and all invalid requests are rejected. If necessary, ask 
questions, file bug reports, patch Squid, and/or adjust your 
configuration to pass this test.

2. Copy http_access rules, with comments, from generated 
squid.conf.default. Insert your own access rules in the location marked 
by &quot;INSERT YOUR OWN RULE(S) HERE&quot; comment. Perform host_verify_strict 
and access tests to confirm that all valid requests to banned sites are 
denied, all other valid requests are allowed, and all invalid requests 
are rejected. If necessary, ask questions, file bug reports, patch 
Squid, and/or adjust your configuration to pass this test.


HTH,

Alex.


&gt;<i> 2024&#24180;8&#26376;8&#26085;(&#26408;) 21:33 Alex Rousskov &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt;:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> On 2024-08-06 20:59, &#12395;&#12400; wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> When using Squid transparently, is it possible to control the
</I>&gt;&gt;&gt;<i> whitelist of the domain to connect to and inspect the Host field in
</I>&gt;&gt;&gt;<i> the request header together?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Short answer: Yes.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> According to the verification results, the Host field can be inspected
</I>&gt;&gt;&gt;<i> by &quot;host_verify_strict on&quot; in squid-transparent.conf, but it seems
</I>&gt;&gt;&gt;<i> that the whitelist is not controlled.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> AFAICT, the configuration you have shared allows all banned[1] traffic
</I>&gt;&gt;<i> to/through https_port. For the problematic test case #5:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> All these http_access rules do _not_ match:
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> http_access allow localnet whitelist
</I>&gt;&gt;&gt;<i> http_access deny localnet whitelist_https !https_port
</I>&gt;&gt;&gt;<i> http_access deny localnet whitelist_transparent_https !https_port
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> And then this next rule matches and allows traffic through:
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> http_access allow https_port
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> This last http_access rule is not reached:
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> http_access deny all
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> N.B. The above analysis assumes that your https_port ACL is explicitly
</I>&gt;&gt;<i> defined in your squid.conf to match all traffic received at https_port.
</I>&gt;&gt;<i> If you do not have such an ACL defined, then you need to fix that
</I>&gt;&gt;<i> problem as well. I recommend naming ACLs differently from directive
</I>&gt;&gt;<i> names (e.g., &quot;toHttpsPort&quot; rather than &quot;https_port&quot;).
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Please note that Squid v4 is not supported by the Squid Project and is
</I>&gt;&gt;<i> very buggy. I recommend using Squid v6 or later.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> HTH,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Alex.
</I>&gt;&gt;<i> [1] Here, &quot;banned&quot; means &quot;_not_ matching whitelist ACL&quot;.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> &#9632;Configuration Details
</I>&gt;&gt;&gt;<i> &#12295;squid-transparent.conf&#65288;Excerpts&#65289;
</I>&gt;&gt;&gt;<i> #Whitelist
</I>&gt;&gt;&gt;<i> acl whitelist dstdomain &quot;/etc/squid/whitelist&quot;
</I>&gt;&gt;&gt;<i> acl whitelist dstdomain &quot;/etc/squid/whitelist_transparent&quot;
</I>&gt;&gt;&gt;<i> acl whitelist_https dstdomain &quot;/etc/squid/whitelist_https&quot;
</I>&gt;&gt;&gt;<i> acl whitelist_transparent_https dstdomain
</I>&gt;&gt;&gt;<i> &quot;/etc/squid/whitelist_transparent_https&quot;
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> proxy_protocol_access allow localnet
</I>&gt;&gt;&gt;<i> proxy_protocol_access deny all
</I>&gt;&gt;&gt;<i> http_access allow localnet whitelist
</I>&gt;&gt;&gt;<i> http_access deny localnet whitelist_https !https_port
</I>&gt;&gt;&gt;<i> http_access deny localnet whitelist_transparent_https !https_port
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> # Handling HTTP requests
</I>&gt;&gt;&gt;<i> http_port 3129 intercept
</I>&gt;&gt;&gt;<i> # Handling HTTPS requests
</I>&gt;&gt;&gt;<i> https_port 3130 intercept tcpkeepalive=60,30,3 ssl-bump
</I>&gt;&gt;&gt;<i> generate-host-certificates=on dynamic_cert_mem_cache_size=20MB
</I>&gt;&gt;&gt;<i> tls-cert=/etc/squid/ssl/squid.crt tls-key=/etc/squid/ssl/squid.key
</I>&gt;&gt;&gt;<i> cipher=HIGH:MEDIUM:!LOW:!RC4:!SEED:!IDEA:!3DES:!MD5:!EXP:!PSK:!DSS
</I>&gt;&gt;&gt;<i> options=NO_TLSv1,NO_SSLv3,SINGLE_DH_USE,SINGLE_ECDH_USE
</I>&gt;&gt;&gt;<i> tls-dh=prime256v1:/etc/squid/ssl/bump_dhparam.pem
</I>&gt;&gt;&gt;<i> # Start up for squid process
</I>&gt;&gt;&gt;<i> http_port 3131
</I>&gt;&gt;&gt;<i> http_access allow https_port
</I>&gt;&gt;&gt;<i> acl allowed_https_sites ssl::server_name &quot;/etc/squid/whitelist&quot;
</I>&gt;&gt;&gt;<i> acl allowed_https_sites ssl::server_name &quot;/etc/squid/whitelist_transparent&quot;
</I>&gt;&gt;&gt;<i> acl allowed_https_sites ssl::server_name &quot;/etc/squid/whitelist_https&quot;
</I>&gt;&gt;&gt;<i> acl allowed_https_sites ssl::server_name
</I>&gt;&gt;&gt;<i> &quot;/etc/squid/whitelist_transparent_https&quot;
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> http_access deny all
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> # strict setting
</I>&gt;&gt;&gt;<i> host_verify_strict on
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> # SSL_BUMP
</I>&gt;&gt;&gt;<i> sslcrtd_program /usr/lib64/squid/security_file_certgen -s
</I>&gt;&gt;&gt;<i> /var/lib/squid/ssl_db -M 20MB
</I>&gt;&gt;&gt;<i> acl step1 at_step SslBump1
</I>&gt;&gt;&gt;<i> acl step2 at_step SslBump2
</I>&gt;&gt;&gt;<i> acl step3 at_step SslBump3
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> ssl_bump bump all
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> &#9632;Verification of Settings
</I>&gt;&gt;&gt;<i> I ran the curl command from each of the client environments that use Squid.
</I>&gt;&gt;&gt;<i> 1. if SNI, Destination IP, and HeaderHost are correct, the user should
</I>&gt;&gt;&gt;<i> be able to connect to pypi.org
</I>&gt;&gt;&gt;<i> Command:
</I>&gt;&gt;&gt;<i> date;curl <A HREF="https://pypi.org/">https://pypi.org/</A> -v --cacert squid_2.crt -k
</I>&gt;&gt;&gt;<i> Result: OK
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> 2. rejection of communication to pypi.org if SNI is correct but
</I>&gt;&gt;&gt;<i> destination IP and HeaderHost are incorrect
</I>&gt;&gt;&gt;<i> Command:
</I>&gt;&gt;&gt;<i> date;curl <A HREF="https://pypi.org/">https://pypi.org/</A> --resolve pypi.org:443:182.22.24.252 -H
</I>&gt;&gt;&gt;<i> &quot;Host: www.yahoo.co.jp&quot;  -v --cacert squid_2.crt -k
</I>&gt;&gt;&gt;<i> Result: OK (409 Conflict is returned)
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> 3. rejection of communication to pypi.org if SNI and destination IP
</I>&gt;&gt;&gt;<i> are correct and HeaderHost is incorrect
</I>&gt;&gt;&gt;<i> Command:
</I>&gt;&gt;&gt;<i> date;curl <A HREF="https://pypi.org/">https://pypi.org/</A> -H &quot;Host: www.yahoo.co.jp&quot; -v --cacert
</I>&gt;&gt;&gt;<i> squid_2.crt -k
</I>&gt;&gt;&gt;<i> Result: OK (409 Confilic returned)
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> 4. rejection of communication to pypi.org if SNI and HeaderHost are
</I>&gt;&gt;&gt;<i> correct but destination IP is incorrect
</I>&gt;&gt;&gt;<i> Command:
</I>&gt;&gt;&gt;<i> date;curl <A HREF="https://pypi.org/">https://pypi.org/</A> --resolve pypi.org:443:182.22.24.252 -v
</I>&gt;&gt;&gt;<i> --cacert squid_2.crt -k
</I>&gt;&gt;&gt;<i> Result: OK (409 Confilic returned)
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> 5. if SNI, destination IP, and HeaderHost are all invalid (yahoo.co.jp
</I>&gt;&gt;&gt;<i> not registered in whitelist), communication will be rejected
</I>&gt;&gt;&gt;<i> Command:
</I>&gt;&gt;&gt;<i> date;curl <A HREF="https://yahoo.co.jp/">https://yahoo.co.jp/</A> -v --cacert squid_2.crt -k
</I>&gt;&gt;&gt;<i> Result: NG (301 Moved Permanently is returned, but it appears that the
</I>&gt;&gt;&gt;<i> communication is reaching yahoo.co.jp)
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;<i> squid-users mailing list
</I>&gt;&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">https://lists.squid-cache.org/listinfo/squid-users</A>
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="027087.html">[squid-users] Questions about Squid configuration
</A></li>
	<LI>Next message (by thread): <A HREF="027023.html">[squid-users] squid 5.7 FTP upload fails
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27089">[ date ]</a>
              <a href="thread.html#27089">[ thread ]</a>
              <a href="subject.html#27089">[ subject ]</a>
              <a href="author.html#27089">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
