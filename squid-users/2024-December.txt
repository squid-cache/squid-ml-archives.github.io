From jonathanlee571 at gmail.com  Sun Dec  1 17:01:31 2024
From: jonathanlee571 at gmail.com (Jonathan Lee)
Date: Sun, 1 Dec 2024 09:01:31 -0800
Subject: [squid-users] Wpad
In-Reply-To: <a98dbcb0-8a1e-445e-aba2-2e7b54429817@treenet.co.nz>
References: <C798FF8B-EA80-4FDF-83C4-2FEF9522008B@gmail.com>
 <a98dbcb0-8a1e-445e-aba2-2e7b54429817@treenet.co.nz>
Message-ID: <E21BE42F-2553-4D78-905B-E69F96DD3317@gmail.com>

Thank you again this works perfectly for my issues I had

> On Oct 2, 2024, at 20:51, Amos Jeffries <squid3 at treenet.co.nz> wrote:
> 
> On 2/10/24 05:05, Jonathan Lee wrote:
>> Hello fellow squid users,
>> Can you please help? I am attempting to run wpad on the same machine as squid however port 80 443 is blocked, I have a url redirect 192.168.1.1/wpad.dat to https://192.168.1.1:8080/wpad.dat this is done with use of squid guard, however you must disable bypass for 192.168.1.1 on squid. Squid resides on 192.168.1.1:3128,
>> It works on the iMac for auto config proxy I can access the url file within the redirect.
>> My question is how can this be managed directly with squid custom config ?? Is there a way to have squid manage a simple wpad?
> 
> 
>  acl wpad urlpath_regex ^/wpad.dat$
>  deny_info 200:/etc/squid/wpad.dat wpad
>  http_access deny wpad
> 
>  reply_header_access Content-Type deny wpad
>  reply_header_replace Content-Type application/x-ns-proxy-autoconfig
> 
> 
> 
> HTH
> Amos
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> https://lists.squid-cache.org/listinfo/squid-users



From jonathanlee571 at gmail.com  Sun Dec  1 22:03:33 2024
From: jonathanlee571 at gmail.com (Jonathan Lee)
Date: Sun, 1 Dec 2024 14:03:33 -0800
Subject: [squid-users] Wpad
In-Reply-To: <16666AF5-31F6-4A51-9B7B-A495DF801D46@gmail.com>
References: <C798FF8B-EA80-4FDF-83C4-2FEF9522008B@gmail.com>
 <a98dbcb0-8a1e-445e-aba2-2e7b54429817@treenet.co.nz>
 <E21BE42F-2553-4D78-905B-E69F96DD3317@gmail.com>
 <16666AF5-31F6-4A51-9B7B-A495DF801D46@gmail.com>
Message-ID: <CE311431-EA8D-4A30-810C-E33733E19D38@gmail.com>

this is the wpad file I am using 

function FindProxyForURL(url, host) 
{
url = url.toLowerCase();
host = host.toLowerCase();

if (isPlainHostName(host)) 
{
  return 'DIRECT';
}

if (isResolvable(host)) 
{
var hostIP = dnsResolve(host);

if (isInNet(hostIP, '0.0.0.0', '255.0.0.0') || isInNet(hostIP, '10.0.0.0', '255.0.0.0') ||
isInNet(hostIP, '127.0.0.0', '255.0.0.0') || isInNet(hostIP, '169.254.0.0', '255.255.0.0') ||
isInNet(hostIP, '172.16.0.0', '255.240.0.0') || isInNet(hostIP, '192.168.0.0', '255.255.0.0') ||
isInNet(hostIP, '198.18.0.0', '255.254.0.0') || isInNet(hostIP, '224.0.0.0', '240.0.0.0') ||
isInNet(hostIP, '240.0.0.0', '240.0.0.0')) 
{
  return 'DIRECT';
}

if (false) 
{
  return 'DIRECT';
}
}

if (url.substring(0, 5) == 'http:' || url.substring(0, 6) == 'https:' ||
url.substring(0, 4) == 'ftp:') 
{
  return 'PROXY 192.168.1.1:3128';
}

return 'DIRECT';
}

> On Dec 1, 2024, at 13:58, Jonathan Lee <jonathanlee571 at gmail.com> wrote:
> 
> this is what I have tried it also fails 
> 
> acl wpad urlpath_regex ^/wpad.dat$
> acl wpad urlpath_regex ^/proxy.pac$
> deny_info 200:/usr/local/www/wpad.dat wpad
> deny_info 200:/usr/local/www/proxy.pac wpad
> http_access deny wpad
> 
> reply_header_access Content-Type deny wpad
> reply_header_replace Content-Type application/x-ns-proxy-autoconfig
> 
> when you run squid -k parse it take the config file
> 
> 
> What I want to do is when it sees that reg ex to send it to this URL 
> https://192.168.1.1:8080/wpad.dat
> 
> 
> 
>> On Dec 1, 2024, at 09:01, Jonathan Lee <jonathanlee571 at gmail.com> wrote:
>> 
>> Thank you again this works perfectly for my issues I had
>> 
>>> On Oct 2, 2024, at 20:51, Amos Jeffries <squid3 at treenet.co.nz> wrote:
>>> 
>>> On 2/10/24 05:05, Jonathan Lee wrote:
>>>> Hello fellow squid users,
>>>> Can you please help? I am attempting to run wpad on the same machine as squid however port 80 443 is blocked, I have a url redirect 192.168.1.1/wpad.dat to https://192.168.1.1:8080/wpad.dat this is done with use of squid guard, however you must disable bypass for 192.168.1.1 on squid. Squid resides on 192.168.1.1:3128,
>>>> It works on the iMac for auto config proxy I can access the url file within the redirect.
>>>> My question is how can this be managed directly with squid custom config ?? Is there a way to have squid manage a simple wpad?
>>> 
>>> 
>>> acl wpad urlpath_regex ^/wpad.dat$
>>> deny_info 200:/etc/squid/wpad.dat wpad
>>> http_access deny wpad
>>> 
>>> reply_header_access Content-Type deny wpad
>>> reply_header_replace Content-Type application/x-ns-proxy-autoconfig
>>> 
>>> 
>>> 
>>> HTH
>>> Amos
>>> _______________________________________________
>>> squid-users mailing list
>>> squid-users at lists.squid-cache.org
>>> https://lists.squid-cache.org/listinfo/squid-users
>> 
> 

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20241201/b784b4a7/attachment.htm>

From standby24x7 at gmail.com  Mon Dec  2 08:56:17 2024
From: standby24x7 at gmail.com (Masanari Iida)
Date: Mon, 2 Dec 2024 17:56:17 +0900
Subject: [squid-users] memory_pools_limit question
Message-ID: <CALLJCT3g4P-_kosk4+0U0wmBK8QFqcq0VZDZJhBO-L++DaWO9A@mail.gmail.com>

Hi,
I would like to understand memory_pools and memory_pools_limits setting.

In case memory_pools_limit is set to none (as default),
all squid process memory that can be seen by ps(1) is being used by squid?

In case memory_pools_limit is set to 100MB and 1GB of memory is being
used by squid,  then actual memory usage is 900MB and 100MB is reserved
as unused.
In this case, process memory usage seen by ps(1) is 1GB.

Background of the question.
I would like to know whether memory_pool_limit size is
included in the process memory usage, seen from os commands such as
ps(1), top(1).

Masanari


From rousskov at measurement-factory.com  Mon Dec  2 14:33:32 2024
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Mon, 2 Dec 2024 09:33:32 -0500
Subject: [squid-users] memory_pools_limit question
In-Reply-To: <CALLJCT3g4P-_kosk4+0U0wmBK8QFqcq0VZDZJhBO-L++DaWO9A@mail.gmail.com>
References: <CALLJCT3g4P-_kosk4+0U0wmBK8QFqcq0VZDZJhBO-L++DaWO9A@mail.gmail.com>
Message-ID: <abf4df8c-162e-4d33-b353-04a33410c43e@measurement-factory.com>

On 2024-12-02 03:56, Masanari Iida wrote:
> Hi,
> I would like to understand memory_pools and memory_pools_limits setting.
> 
> In case memory_pools_limit is set to none (as default),
> all squid process memory that can be seen by ps(1) is being used by squid?

Yes, for some definition of "being used". Some of the memory reported by 
ps is idle memory_pools memory that is not used by current Squid 
transactions (but it is still "used" by Squid in general sense).


> In case memory_pools_limit is set to 100MB and 1GB of memory is being
> used by squid,  then actual memory usage is 900MB and 100MB is reserved
> as unused.

If you are asserting that "100MB is reserved as unused", then I disagree 
with that assertion. Squid does not pre-allocate memory just because you 
enable memory pools. Special tricks (that I do not recommend using, and 
you are not discussing above) aside, Squid memory pools may only 
preserve previously _used_ memory (to avoid re-allocation). 
memory_pools_limit limits how much previously used memory Squid can keep 
for that purpose.


> In this case, process memory usage seen by ps(1) is 1GB.
> 
> Background of the question.
> I would like to know whether memory_pool_limit size is
> included in the process memory usage, seen from os commands such as
> ps(1), top(1).

The short answer is "yes": OS commands do not know anything about Squid 
internals and, hence, include everything Squid is using, but there are 
different kinds of "use".


N.B. Some Squid memory allocations do not go through memory pools.


HTH,

Alex.



From vladislav-ex-squid-ml at vm-0.com  Wed Dec  4 18:58:13 2024
From: vladislav-ex-squid-ml at vm-0.com (Vladislav Yarmak)
Date: Wed, 04 Dec 2024 18:58:13 +0000
Subject: [squid-users] HMAC basic auth
Message-ID: <AfmbMb3zOAzJ3HsPfCJCnVIEDRxk1jTGFNQR7BwavfoxjKbhixIU81oW2wbM2VqBOzL_xzgymHeCQwqyNzH9N4KoD3L-lmNXwuzTSpK8UHM=@vm-0.com>

Hello,

I'd like to share Basic auth helper I made for Squid:
https://github.com/SenseUnit/basic_hmac_auth

This helper enables Squid basic authentication with HMAC-signatures passed as a
password.

Such scheme is useful in scenarios where proxy credentials are provisioned by
some central authority (e.g. webservice). This way proxy client obtains a login
and password pair from that authority and proxy can validate it without ever
contacting authority to check credentials status.

Compared to classical approaches with network request made by other helpers,
this approach has following benefits:
- No surge of validation requests whencredentials cache was emptied.
- No added latency to validate credentials.
- No issues with credentials cache coherence across different workers/instances
of Squid server, it's the client who will contact authority and just once per
credentials update.
- Some degree of autonomy - proxy will continue to serve when auth backend is
not available until credentials expire.

Hope some may also find it useful. Feedback is welcome!

--
Best regards,
Vladislav Yarmak


From david at articatech.com  Sun Dec  8 14:26:57 2024
From: david at articatech.com (David Touzeau)
Date: Sun, 8 Dec 2024 15:26:57 +0100
Subject: [squid-users] Proxy-Protocol inside cache_peer
Message-ID: <502bdd1a-c997-421e-a4c8-d9ef1cb4a6bf@articatech.com>

Hello

Is there any way or development plan to include ?proxy-protocol? in 
cache_peer?

Squid is able to listen for proxy-protocol, but I haven't seen how to 
use this protocol when redirecting to Squid parents with proxy-protocol 
enabled.


Thank you very much.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20241208/1aa4563f/attachment.htm>

From my.shellac at gmail.com  Mon Dec  9 07:49:22 2024
From: my.shellac at gmail.com (=?UTF-8?B?QWxleGV50Y/RgCBHcnV6ZG92?=)
Date: Mon, 9 Dec 2024 12:49:22 +0500
Subject: [squid-users] Cache peers auth on the fly
Message-ID: <CAFqyDwBvmX-p_Nx3W7yik1-syL_0k_9ARD3-0fF2vTwgyLYkMg@mail.gmail.com>

Hello guys!

Is that available to change the creds on the fly  for the parent proxy?
may be some external acl or something?

for example

user is authorized on the first proxy ----> then run some external script
with username/password as args ---> then squid will get the answer as new
username/password for use these in cache_peer authorize section

How do you think??

thanks.
Alexey
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20241209/75e98dfe/attachment.htm>

From vladislav-ex-squid-ml at vm-0.com  Mon Dec  9 13:12:54 2024
From: vladislav-ex-squid-ml at vm-0.com (Vladislav Yarmak)
Date: Mon, 09 Dec 2024 13:12:54 +0000
Subject: [squid-users] Cache peers auth on the fly
In-Reply-To: <CAFqyDwBvmX-p_Nx3W7yik1-syL_0k_9ARD3-0fF2vTwgyLYkMg@mail.gmail.com>
References: <CAFqyDwBvmX-p_Nx3W7yik1-syL_0k_9ARD3-0fF2vTwgyLYkMg@mail.gmail.com>
Message-ID: <2xAMC2b-Z5bB-AjcaqfRBj2wgJtJelNjy2-sBQFLHlflycrQ2o9MRQWMiizmmWav_zkyEd7co6M2c9TcT_0JCcdAGAWYtpkLVuGuiBKLLho=@vm-0.com>

> Is that available to change the creds on the fly for the parent proxy?
> may be some external acl or something?
> 

I think it should be possible with external_acl helper:

https://github.com/squid-cache/squid/blob/9685cb72268c5f9df073b9cea3ea6066863288c8/src/http.cc#L1855-L1869

cache_peer has to have login=PASS set and external_acl helper must return user= and password= keys.

--
Best regards,
Vladislav Yarmak


From ngtech1ltd at gmail.com  Mon Dec  9 13:40:51 2024
From: ngtech1ltd at gmail.com (ngtech1ltd at gmail.com)
Date: Mon, 9 Dec 2024 15:40:51 +0200
Subject: [squid-users] Wpad
In-Reply-To: <CE311431-EA8D-4A30-810C-E33733E19D38@gmail.com>
References: <C798FF8B-EA80-4FDF-83C4-2FEF9522008B@gmail.com>
 <a98dbcb0-8a1e-445e-aba2-2e7b54429817@treenet.co.nz>
 <E21BE42F-2553-4D78-905B-E69F96DD3317@gmail.com>
 <16666AF5-31F6-4A51-9B7B-A495DF801D46@gmail.com>
 <CE311431-EA8D-4A30-810C-E33733E19D38@gmail.com>
Message-ID: <044a01db4a3f$f6c2d3c0$e4487b40$@gmail.com>

Hey Jonathan,

 

Can you give more details on the setup?

I am unsure how this setup work.

Is this an intercept proxy or a simple forward proxy?

Is the 192.168.1.1 the proxy ip and port? Also is the client on the same
subnet?

 

I understand that you are trying to use the proxy to serve the wpad file
somehow.

 

Thanks,

Eliezer

 

From: squid-users <squid-users-bounces at lists.squid-cache.org> On Behalf Of
Jonathan Lee
Sent: Monday, December 2, 2024 12:04 AM
To: Jonathan Lee <jonathanlee571 at gmail.com>
Cc: squid-users <squid-users at lists.squid-cache.org>
Subject: Re: [squid-users] Wpad

 

this is the wpad file I am using 

 

function FindProxyForURL(url, host) 

{

url = url.toLowerCase();

host = host.toLowerCase();

 

if (isPlainHostName(host)) 

{

  return 'DIRECT';

}

 

if (isResolvable(host)) 

{

var hostIP = dnsResolve(host);

 

if (isInNet(hostIP, '0.0.0.0', '255.0.0.0') || isInNet(hostIP, '10.0.0.0',
'255.0.0.0') ||

isInNet(hostIP, '127.0.0.0', '255.0.0.0') || isInNet(hostIP, '169.254.0.0',
'255.255.0.0') ||

isInNet(hostIP, '172.16.0.0', '255.240.0.0') || isInNet(hostIP,
'192.168.0.0', '255.255.0.0') ||

isInNet(hostIP, '198.18.0.0', '255.254.0.0') || isInNet(hostIP, '224.0.0.0',
'240.0.0.0') ||

isInNet(hostIP, '240.0.0.0', '240.0.0.0')) 

{

  return 'DIRECT';

}

 

if (false) 

{

  return 'DIRECT';

}

}

 

if (url.substring(0, 5) == 'http:' || url.substring(0, 6) == 'https:' ||

url.substring(0, 4) == 'ftp:') 

{

  return 'PROXY 192.168.1.1:3128';

}

 

return 'DIRECT';

}





On Dec 1, 2024, at 13:58, Jonathan Lee <jonathanlee571 at gmail.com
<mailto:jonathanlee571 at gmail.com> > wrote:

 

this is what I have tried it also fails 

 

acl wpad urlpath_regex ^/wpad.dat$

acl wpad urlpath_regex ^/proxy.pac$

deny_info 200:/usr/local/www/wpad.dat wpad

deny_info 200:/usr/local/www/proxy.pac wpad

http_access deny wpad

 

reply_header_access Content-Type deny wpad

reply_header_replace Content-Type application/x-ns-proxy-autoconfig

 

when you run squid -k parse it take the config file

 

 

What I want to do is when it sees that reg ex to send it to this URL 

https://192.168.1.1:8080/wpad.dat

 

 





On Dec 1, 2024, at 09:01, Jonathan Lee <jonathanlee571 at gmail.com
<mailto:jonathanlee571 at gmail.com> > wrote:

 

Thank you again this works perfectly for my issues I had




On Oct 2, 2024, at 20:51, Amos Jeffries <squid3 at treenet.co.nz
<mailto:squid3 at treenet.co.nz> > wrote:

On 2/10/24 05:05, Jonathan Lee wrote:



Hello fellow squid users,
Can you please help? I am attempting to run wpad on the same machine as
squid however port 80 443 is blocked, I have a url redirect
192.168.1.1/wpad.dat to https://192.168.1.1:8080/wpad.dat this is done with
use of squid guard, however you must disable bypass for 192.168.1.1 on
squid. Squid resides on 192.168.1.1:3128,
It works on the iMac for auto config proxy I can access the url file within
the redirect.
My question is how can this be managed directly with squid custom config ??
Is there a way to have squid manage a simple wpad?



acl wpad urlpath_regex ^/wpad.dat$
deny_info 200:/etc/squid/wpad.dat wpad
http_access deny wpad

reply_header_access Content-Type deny wpad
reply_header_replace Content-Type application/x-ns-proxy-autoconfig



HTH
Amos
_______________________________________________
squid-users mailing list
squid-users at lists.squid-cache.org <mailto:squid-users at lists.squid-cache.org>

https://lists.squid-cache.org/listinfo/squid-users

 

 

 

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20241209/980fa5c5/attachment.htm>

From david at articatech.com  Tue Dec 10 14:50:08 2024
From: david at articatech.com (David Touzeau)
Date: Tue, 10 Dec 2024 15:50:08 +0100
Subject: [squid-users] Wpad
In-Reply-To: <044a01db4a3f$f6c2d3c0$e4487b40$@gmail.com>
References: <C798FF8B-EA80-4FDF-83C4-2FEF9522008B@gmail.com>
 <a98dbcb0-8a1e-445e-aba2-2e7b54429817@treenet.co.nz>
 <E21BE42F-2553-4D78-905B-E69F96DD3317@gmail.com>
 <16666AF5-31F6-4A51-9B7B-A495DF801D46@gmail.com>
 <CE311431-EA8D-4A30-810C-E33733E19D38@gmail.com>
 <044a01db4a3f$f6c2d3c0$e4487b40$@gmail.com>
Message-ID: <9cc40a72-ae7a-41d9-beb7-0a1eca025700@articatech.com>

Hi Jonathan

Using squid as a PAC proxy provider is not an efficient solution.
- Squid cache error pages, which may cause problems when modifying the 
source.
- The PAC proxy will generate events in squid that are polluting for 
troubleshooting.
- If squid has issues or is stopped ( disk full, false config..) , it 
will be difficult to provide an alternative way.

To this end, we're offering a free, open-source service dedicated to PAC 
proxies, with the distinctive feature of offering several PAC proxies 
depending on the client source and browser.
A web-based management console lets you build the Proxy PAC, test your 
rules and view access events.
This solution is independent, leaving the squid free to focus on its 
designated mission.

https://wiki.articatech.com/en/proxy-service/proxy-pac

regards


Le 09/12/2024 ? 14:40, ngtech1ltd at gmail.com a ?crit?:
>
> Hey Jonathan,
>
> Can you give more details on the setup?
>
> I am unsure how this setup work.
>
> Is this an intercept proxy or a simple forward proxy?
>
> Is the 192.168.1.1 the proxy ip and port? Also is the client on the 
> same subnet?
>
> I understand that you are trying to use the proxy to serve the wpad 
> file somehow.
>
> Thanks,
>
> Eliezer
>
> *From:* squid-users <squid-users-bounces at lists.squid-cache.org> *On 
> Behalf Of *Jonathan Lee
> *Sent:* Monday, December 2, 2024 12:04 AM
> *To:* Jonathan Lee <jonathanlee571 at gmail.com>
> *Cc:* squid-users <squid-users at lists.squid-cache.org>
> *Subject:* Re: [squid-users] Wpad
>
> this is the wpad file I am using
>
> function FindProxyForURL(url, host)
>
> {
>
> url = url.toLowerCase();
>
> host = host.toLowerCase();
>
> if (isPlainHostName(host))
>
> {
>
> ? return 'DIRECT';
>
> }
>
> if (isResolvable(host))
>
> {
>
> var hostIP = dnsResolve(host);
>
> if (isInNet(hostIP, '0.0.0.0', '255.0.0.0') || isInNet(hostIP, 
> '10.0.0.0', '255.0.0.0') ||
>
> isInNet(hostIP, '127.0.0.0', '255.0.0.0') || isInNet(hostIP, 
> '169.254.0.0', '255.255.0.0') ||
>
> isInNet(hostIP, '172.16.0.0', '255.240.0.0') || isInNet(hostIP, 
> '192.168.0.0', '255.255.0.0') ||
>
> isInNet(hostIP, '198.18.0.0', '255.254.0.0') || isInNet(hostIP, 
> '224.0.0.0', '240.0.0.0') ||
>
> isInNet(hostIP, '240.0.0.0', '240.0.0.0'))
>
> {
>
> ? return 'DIRECT';
>
> }
>
> if (false)
>
> {
>
> ? return 'DIRECT';
>
> }
>
> }
>
> if (url.substring(0, 5) == 'http:' || url.substring(0, 6) == 'https:' ||
>
> url.substring(0, 4) == 'ftp:')
>
> {
>
> ? return 'PROXY 192.168.1.1:3128';
>
> }
>
> return 'DIRECT';
>
> }
>
>
>
>     On Dec 1, 2024, at 13:58, Jonathan Lee <jonathanlee571 at gmail.com>
>     wrote:
>
>     this is what I have tried it also fails
>
>     acl wpad urlpath_regex ^/wpad.dat$
>
>     acl wpad urlpath_regex ^/proxy.pac$
>
>     deny_info 200:/usr/local/www/wpad.dat wpad
>
>     deny_info 200:/usr/local/www/proxy.pac wpad
>
>     http_access deny wpad
>
>     reply_header_access Content-Type deny wpad
>
>     reply_header_replace Content-Type application/x-ns-proxy-autoconfig
>
>     when you run squid -k parse it take the config file
>
>     What I want to do is when it sees that reg ex to send it to this URL
>
>     https://192.168.1.1:8080/wpad.dat
>
>
>
>         On Dec 1, 2024, at 09:01, Jonathan Lee
>         <jonathanlee571 at gmail.com> wrote:
>
>         Thank you again this works perfectly for my issues I had
>
>
>             On Oct 2, 2024, at 20:51, Amos Jeffries
>             <squid3 at treenet.co.nz> wrote:
>
>             On 2/10/24 05:05, Jonathan Lee wrote:
>
>                 Hello fellow squid users,
>                 Can you please help? I am attempting to run wpad on
>                 the same machine as squid however port 80 443 is
>                 blocked, I have a url redirect 192.168.1.1/wpad.dat to
>                 https://192.168.1.1:8080/wpad.dat this is done with
>                 use of squid guard, however you must disable bypass
>                 for 192.168.1.1 on squid. Squid resides on
>                 192.168.1.1:3128,
>                 It works on the iMac for auto config proxy I can
>                 access the url file within the redirect.
>                 My question is how can this be managed directly with
>                 squid custom config ?? Is there a way to have squid
>                 manage a simple wpad?
>
>
>
>             acl wpad urlpath_regex ^/wpad.dat$
>             deny_info 200:/etc/squid/wpad.dat wpad
>             http_access deny wpad
>
>             reply_header_access Content-Type deny wpad
>             reply_header_replace Content-Type
>             application/x-ns-proxy-autoconfig
>
>
>
>             HTH
>             Amos
>             _______________________________________________
>             squid-users mailing list
>             squid-users at lists.squid-cache.org
>             https://lists.squid-cache.org/listinfo/squid-users
>
>
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> https://lists.squid-cache.org/listinfo/squid-users

-- 
David Touzeau - Artica Tech France
Development team, level 3 support
----------------------------------
P: +33 6 58 44 69 46
www:https://wiki.articatech.com
www:http://articatech.net 
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20241210/e4ed5da5/attachment.htm>

From jonathanlee571 at gmail.com  Tue Dec 10 21:30:17 2024
From: jonathanlee571 at gmail.com (Jonathan Lee)
Date: Tue, 10 Dec 2024 13:30:17 -0800
Subject: [squid-users] Wpad
In-Reply-To: <9cc40a72-ae7a-41d9-beb7-0a1eca025700@articatech.com>
References: <C798FF8B-EA80-4FDF-83C4-2FEF9522008B@gmail.com>
 <a98dbcb0-8a1e-445e-aba2-2e7b54429817@treenet.co.nz>
 <E21BE42F-2553-4D78-905B-E69F96DD3317@gmail.com>
 <16666AF5-31F6-4A51-9B7B-A495DF801D46@gmail.com>
 <CE311431-EA8D-4A30-810C-E33733E19D38@gmail.com>
 <044a01db4a3f$f6c2d3c0$e4487b40$@gmail.com>
 <9cc40a72-ae7a-41d9-beb7-0a1eca025700@articatech.com>
Message-ID: <FE9405EC-EAF1-444D-87FC-88B514FE1182@gmail.com>

Thanks for the reply, I purchased a Raspberry Pi to run an Apache2 server on it and host my wpad. It is working should I use and proxy settings to block pivots to it? Example an invasive container accesses the proxy and pivots to other devices on the network from inside the cage

> On Dec 10, 2024, at 06:50, David Touzeau <david at articatech.com> wrote:
> 
> Hi Jonathan
> 
> Using squid as a PAC proxy provider is not an efficient solution.
> - Squid cache error pages, which may cause problems when modifying the source.
> - The PAC proxy will generate events in squid that are polluting for troubleshooting.
> - If squid has issues or is stopped ( disk full, false config..) , it will be difficult to provide an alternative way.
> 
> To this end, we're offering a free, open-source service dedicated to PAC proxies, with the distinctive feature of offering several PAC proxies depending on the client source and browser.
> A web-based management console lets you build the Proxy PAC, test your rules and view access events.
> This solution is independent, leaving the squid free to focus on its designated mission.
> 
> https://wiki.articatech.com/en/proxy-service/proxy-pac
> 
> regards
> 
> 
> Le 09/12/2024 ? 14:40, ngtech1ltd at gmail.com <mailto:ngtech1ltd at gmail.com> a ?crit :
>> Hey Jonathan,
>>  
>> Can you give more details on the setup?
>> I am unsure how this setup work.
>> Is this an intercept proxy or a simple forward proxy?
>> Is the 192.168.1.1 the proxy ip and port? Also is the client on the same subnet?
>>  
>> I understand that you are trying to use the proxy to serve the wpad file somehow.
>>  
>> Thanks,
>> Eliezer
>>  
>> From: squid-users <squid-users-bounces at lists.squid-cache.org> <mailto:squid-users-bounces at lists.squid-cache.org> On Behalf Of Jonathan Lee
>> Sent: Monday, December 2, 2024 12:04 AM
>> To: Jonathan Lee <jonathanlee571 at gmail.com> <mailto:jonathanlee571 at gmail.com>
>> Cc: squid-users <squid-users at lists.squid-cache.org> <mailto:squid-users at lists.squid-cache.org>
>> Subject: Re: [squid-users] Wpad
>>  
>> this is the wpad file I am using 
>>  
>> function FindProxyForURL(url, host) 
>> {
>> url = url.toLowerCase();
>> host = host.toLowerCase();
>>  
>> if (isPlainHostName(host)) 
>> {
>>   return 'DIRECT';
>> }
>>  
>> if (isResolvable(host)) 
>> {
>> var hostIP = dnsResolve(host);
>>  
>> if (isInNet(hostIP, '0.0.0.0', '255.0.0.0') || isInNet(hostIP, '10.0.0.0', '255.0.0.0') ||
>> isInNet(hostIP, '127.0.0.0', '255.0.0.0') || isInNet(hostIP, '169.254.0.0', '255.255.0.0') ||
>> isInNet(hostIP, '172.16.0.0', '255.240.0.0') || isInNet(hostIP, '192.168.0.0', '255.255.0.0') ||
>> isInNet(hostIP, '198.18.0.0', '255.254.0.0') || isInNet(hostIP, '224.0.0.0', '240.0.0.0') ||
>> isInNet(hostIP, '240.0.0.0', '240.0.0.0')) 
>> {
>>   return 'DIRECT';
>> }
>>  
>> if (false) 
>> {
>>   return 'DIRECT';
>> }
>> }
>>  
>> if (url.substring(0, 5) == 'http:' || url.substring(0, 6) == 'https:' ||
>> url.substring(0, 4) == 'ftp:') 
>> {
>>   return 'PROXY 192.168.1.1:3128';
>> }
>>  
>> return 'DIRECT';
>> }
>> 
>> 
>> On Dec 1, 2024, at 13:58, Jonathan Lee <jonathanlee571 at gmail.com <mailto:jonathanlee571 at gmail.com>> wrote:
>>  
>> this is what I have tried it also fails 
>>  
>> acl wpad urlpath_regex ^/wpad.dat$
>> acl wpad urlpath_regex ^/proxy.pac$
>> deny_info 200:/usr/local/www/wpad.dat wpad
>> deny_info 200:/usr/local/www/proxy.pac wpad
>> http_access deny wpad
>>  
>> reply_header_access Content-Type deny wpad
>> reply_header_replace Content-Type application/x-ns-proxy-autoconfig
>>  
>> when you run squid -k parse it take the config file
>>  
>>  
>> What I want to do is when it sees that reg ex to send it to this URL 
>> https://192.168.1.1:8080/wpad.dat
>>  
>>  
>> 
>> 
>> On Dec 1, 2024, at 09:01, Jonathan Lee <jonathanlee571 at gmail.com <mailto:jonathanlee571 at gmail.com>> wrote:
>>  
>> Thank you again this works perfectly for my issues I had
>> 
>> 
>> On Oct 2, 2024, at 20:51, Amos Jeffries <squid3 at treenet.co.nz <mailto:squid3 at treenet.co.nz>> wrote:
>> 
>> On 2/10/24 05:05, Jonathan Lee wrote:
>> 
>> Hello fellow squid users,
>> Can you please help? I am attempting to run wpad on the same machine as squid however port 80 443 is blocked, I have a url redirect 192.168.1.1/wpad.dat to https://192.168.1.1:8080/wpad.dat this is done with use of squid guard, however you must disable bypass for 192.168.1.1 on squid. Squid resides on 192.168.1.1:3128,
>> It works on the iMac for auto config proxy I can access the url file within the redirect.
>> My question is how can this be managed directly with squid custom config ?? Is there a way to have squid manage a simple wpad?
>> 
>> 
>> acl wpad urlpath_regex ^/wpad.dat$
>> deny_info 200:/etc/squid/wpad.dat wpad
>> http_access deny wpad
>> 
>> reply_header_access Content-Type deny wpad
>> reply_header_replace Content-Type application/x-ns-proxy-autoconfig
>> 
>> 
>> 
>> HTH
>> Amos
>> _______________________________________________
>> squid-users mailing list
>> squid-users at lists.squid-cache.org <mailto:squid-users at lists.squid-cache.org>
>> https://lists.squid-cache.org/listinfo/squid-users
>>  
>>  
>>  
>> 
>> 
>> _______________________________________________
>> squid-users mailing list
>> squid-users at lists.squid-cache.org <mailto:squid-users at lists.squid-cache.org>
>> https://lists.squid-cache.org/listinfo/squid-users
> 
> -- 
> David Touzeau - Artica Tech France
> Development team, level 3 support
> ----------------------------------
> P: +33 6 58 44 69 46
> www: https://wiki.articatech.com <https://wiki.articatech.com/>
> www: http://articatech.net <http://articatech.net/> 
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org <mailto:squid-users at lists.squid-cache.org>
> https://lists.squid-cache.org/listinfo/squid-users

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20241210/6ffa6c1c/attachment.htm>

From jonathanlee571 at gmail.com  Tue Dec 10 23:40:03 2024
From: jonathanlee571 at gmail.com (Jonathan Lee)
Date: Tue, 10 Dec 2024 15:40:03 -0800
Subject: [squid-users] Wpad
In-Reply-To: <FE9405EC-EAF1-444D-87FC-88B514FE1182@gmail.com>
References: <FE9405EC-EAF1-444D-87FC-88B514FE1182@gmail.com>
Message-ID: <EF76AA25-35CC-4243-8B78-32D5882AEF38@gmail.com>

An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20241210/c4bc7dfe/attachment.htm>

From jonathanlee571 at gmail.com  Thu Dec 12 06:29:10 2024
From: jonathanlee571 at gmail.com (Jonathan Lee)
Date: Wed, 11 Dec 2024 22:29:10 -0800
Subject: [squid-users] Wpad
In-Reply-To: <EF76AA25-35CC-4243-8B78-32D5882AEF38@gmail.com>
References: <EF76AA25-35CC-4243-8B78-32D5882AEF38@gmail.com>
Message-ID: <8DA53CAE-1F6C-43BF-9038-425216E91895@gmail.com>

An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20241211/2d4bf228/attachment.htm>

From randomrodrick at proton.me  Sat Dec 14 16:26:06 2024
From: randomrodrick at proton.me (R)
Date: Sat, 14 Dec 2024 16:26:06 +0000
Subject: [squid-users] ssl-bump works,
 but leads to many client errors being logged (NONE_NONE/200)
Message-ID: <Hbnh6yS3GpK0Pw8JeF72Ak_IcXaahxcIv2PGUfgtYOY7F888X7r-0xcWpqakYUYo42oWL0-XL9UAX38hwooK1ULWph-2wAvOg6TBY2e4Nac=@proton.me>

Hello,

My current goal is to set up a caching instance for https static content with squid 6.12.

ssl-bump is set up according to https://wiki.squid-cache.org/Features/SslBump and it works fine, at least from the clients' perspectives and without any noticeable issues (e.g. with Firefox or Safari). Sometimes (~5-8% of the total requests) I can even get a few cache hits - including those juicy TCP_MEM_HIT/200s.

What has been bothering me though is the impressive amount of client request errors being logged:

# a few seconds after an instance restart
openvpn-client2:/$ squidclient cache_object://localhost/counters | grep client_http.errors
client_http.errors = 8
openvpn-client2:/$ squidclient cache_object://localhost/counters | grep client_http.errors
client_http.errors = 20

In the access_log, it is possible to see many NONE_NONE/200 being logged for ?**almost every https request**. The amount of logged NONE_NONE/200 seem to vary according to the target website: github.com:443 throws 6-7 errors, while the lists.squid-cache.org throws only one.

As mentioned, everything seems to be fine for the clients (my grafana dashboard disagrees). Switching, for example, the config from:

acl step1 at_step SslBump1
ssl_bump peek step1
ssl_bump bump all

to

ssl_bump peek all
ssl_bump slice all

makes the NONE_NONE/200 disappear from the logs altogether, but that does not meet the initial caching objective.

What do these NONE_NONE/200 mean exactly? How to identify their underlying cause and reduce the total amount of logged errors?

Side question: are there any plans to move from this email-based list to GitHub issues in your repository (https://github.com/squid-cache/squid)?

Thanks and regards,
Rod

---


squid.conf:

cache_effective_user squid
cache_effective_group users
pid_filename /var/run/squid/squid.pid
acl localnet src 0.0.0.1-0.255.255.255 # RFC 1122 "this" network (LAN)
acl localnet src 10.0.0.0/8 # RFC 1918 local private network (LAN)
acl localnet src 100.64.0.0/10 # RFC 6598 shared address space (CGN)
acl localnet src 169.254.0.0/16 # RFC 3927 link-local (directly plugged) machines
acl localnet src 172.16.0.0/12 # RFC 1918 local private network (LAN)
acl localnet src 192.168.0.0/16 # RFC 1918 local private network (LAN)
acl localnet src fc00::/7 # RFC 4193 local private network range
acl localnet src fe80::/10 # RFC 4291 link-local (directly plugged) machines
acl SSL_ports port 443
acl Safe_ports port 80 # http
acl Safe_ports port 21 # ftp
acl Safe_ports port 443 # https
acl Safe_ports port 70 # gopher
acl Safe_ports port 210 # wais
acl Safe_ports port 1025-65535	# unregistered ports
acl Safe_ports port 280 # http-mgmt
acl Safe_ports port 488 # gss-http
acl Safe_ports port 591 # filemaker
acl Safe_ports port 777 # multiling http
acl CONNECT method CONNECT
acl snmppublic snmp_community public
snmp_port 3401
snmp_access allow snmppublic all
http_access deny !Safe_ports
http_access deny CONNECT !SSL_ports
http_access allow localhost manager
http_access allow localnet manager
http_access deny manager
http_access allow localnet
http_access allow localhost
http_access deny all
# begin ssl-bump
http_port 3128 \
ssl-bump \
cert=/etc/squid/ssl_cert/myCA.pem \
generate-host-certificates=on \
dynamic_cert_mem_cache_size=40MB
acl step1 at_step SslBump1
ssl_bump peek step1
ssl_bump bump all
sslcrtd_program /usr/lib/squid/security_file_certgen -s /var/lib/squid/ssl_db -M 40MB
sslcrtd_children 5
# end ssl-bump
cache allow all
cache_dir aufs /cache 51200 16 256
cache_mem 2 GB
maximum_object_size_in_memory 512 MB
maximum_object_size 6 GB
cache_swap_low 80
cache_swap_high 95
coredump_dir /cache
acl hasRequest has request
acl hasResponse has response
acl cachemgr1 url_regex ^cache_object://
logformat xsquid %tl %6tr %>a %Ss/%03>Hs %err_code/%err_detail %<st %rm %ru %un %Sh/%<A %mt
access_log daemon:/var/log/squid/access.log logformat=xsquid hasRequest !cachemgr1
refresh_pattern ^ftp: 1440	20%	10080
refresh_pattern ^gopher:	1440	0%	1440
refresh_pattern -i (/cgi-bin/|\?) 0	0%	0
refresh_pattern .jpg 120 50% 86400 override-lastmod override-expire ignore-reload ignore-no-store ignore-private store-stale # just to artificially force some hits
refresh_pattern . 3600	80%	14400
range_offset_limit none
forwarded_for on


access_log:

14/Dec/2024:15:28:14 +0000    122 192.168.1.125 NONE_NONE/200 -/- 0 CONNECT 4chan.org:443 - HIER_DIRECT/4chan.org -
14/Dec/2024:15:28:14 +0000    239 192.168.1.125 TCP_MISS/200 -/- 4876 GET https://4chan.org/ - HIER_DIRECT/4chan.org text/html
14/Dec/2024:15:28:14 +0000    145 192.168.1.125 NONE_NONE/200 -/- 0 CONNECT i.4cdn.org:443 - HIER_DIRECT/i.4cdn.org -
14/Dec/2024:15:28:14 +0000    145 192.168.1.125 NONE_NONE/200 -/- 0 CONNECT i.4cdn.org:443 - HIER_DIRECT/i.4cdn.org -
14/Dec/2024:15:28:14 +0000    145 192.168.1.125 NONE_NONE/200 -/- 0 CONNECT i.4cdn.org:443 - HIER_DIRECT/i.4cdn.org -
14/Dec/2024:15:28:14 +0000    144 192.168.1.125 NONE_NONE/200 -/- 0 CONNECT i.4cdn.org:443 - HIER_DIRECT/i.4cdn.org -
14/Dec/2024:15:28:14 +0000    147 192.168.1.125 NONE_NONE/200 -/- 0 CONNECT i.4cdn.org:443 - HIER_DIRECT/i.4cdn.org -
14/Dec/2024:15:28:14 +0000    153 192.168.1.125 NONE_NONE/200 -/- 0 CONNECT i.4cdn.org:443 - HIER_DIRECT/i.4cdn.org -
14/Dec/2024:15:28:14 +0000     60 192.168.1.125 TCP_MISS/200 -/- 9636 GET https://i.4cdn.org/sp/1734116081466614s.jpg - HIER_DIRECT/i.4cdn.org image/jpeg
14/Dec/2024:15:28:14 +0000     65 192.168.1.125 TCP_MISS/200 -/- 4521 GET https://i.4cdn.org/a/1734088830105726s.jpg - HIER_DIRECT/i.4cdn.org image/jpeg
14/Dec/2024:15:28:14 +0000     64 192.168.1.125 TCP_MISS/200 -/- 7356 GET https://i.4cdn.org/v/1734174698931944s.jpg - HIER_DIRECT/i.4cdn.org image/jpeg
14/Dec/2024:15:28:14 +0000     66 192.168.1.125 TCP_MISS/200 -/- 12559 GET https://i.4cdn.org/vr/1734154519311392s.jpg - HIER_DIRECT/i.4cdn.org image/jpeg
14/Dec/2024:15:28:14 +0000     67 192.168.1.125 TCP_MISS/200 -/- 4810 GET https://i.4cdn.org/vg/1734151107375798s.jpg - HIER_DIRECT/i.4cdn.org image/jpeg
14/Dec/2024:15:28:14 +0000     77 192.168.1.125 TCP_MISS/200 -/- 5194 GET https://i.4cdn.org/int/1734146907548086s.jpg - HIER_DIRECT/i.4cdn.org image/jpeg
14/Dec/2024:15:28:14 +0000     74 192.168.1.125 TCP_MISS/200 -/- 8464 GET https://i.4cdn.org/fit/1734081397035134s.jpg - HIER_DIRECT/i.4cdn.org image/jpeg
14/Dec/2024:15:28:14 +0000     75 192.168.1.125 TCP_MISS/200 -/- 7634 GET https://i.4cdn.org/co/1734014992706889s.jpg - HIER_DIRECT/i.4cdn.org image/jpeg
14/Dec/2024:15:28:17 +0000    105 192.168.1.125 NONE_NONE/200 -/- 0 CONNECT boards.4chan.org:443 - HIER_DIRECT/boards.4chan.org -
14/Dec/2024:15:28:17 +0000    117 192.168.1.125 TCP_REFRESH_MODIFIED/200 -/- 21264 GET https://boards.4chan.org/hr/ - HIER_DIRECT/boards.4chan.org text/html
14/Dec/2024:15:28:17 +0000    104 192.168.1.125 NONE_NONE/200 -/- 0 CONNECT s.4cdn.org:443 - HIER_DIRECT/s.4cdn.org -
14/Dec/2024:15:28:17 +0000     66 192.168.1.125 TCP_MISS/200 -/- 7329 GET https://s.4cdn.org/image/contest_banners/4da91e15078cd0b401a3df182447d7f6ef53a041.png - HIER_DIRECT/s.4cdn.org image/png
14/Dec/2024:15:28:17 +0000     64 192.168.1.125 TCP_MISS/200 -/- 2195 GET https://i.4cdn.org/hr/1734185018492644s.jpg - HIER_DIRECT/i.4cdn.org image/jpeg
14/Dec/2024:15:28:17 +0000     64 192.168.1.125 TCP_MISS/200 -/- 2488 GET https://i.4cdn.org/hr/1734184210267895s.jpg - HIER_DIRECT/i.4cdn.org image/jpeg
14/Dec/2024:15:28:17 +0000     67 192.168.1.125 TCP_MISS/200 -/- 2743 GET https://i.4cdn.org/hr/1734129280051325s.jpg - HIER_DIRECT/i.4cdn.org image/jpeg
14/Dec/2024:15:28:17 +0000     70 192.168.1.125 TCP_MISS/200 -/- 9838 GET https://i.4cdn.org/hr/1729975559696842s.jpg - HIER_DIRECT/i.4cdn.org image/jpeg
14/Dec/2024:15:28:17 +0000     68 192.168.1.125 TCP_MISS/200 -/- 8271 GET https://s.4cdn.org/image/title/1.jpg - HIER_DIRECT/s.4cdn.org image/jpeg
14/Dec/2024:15:28:17 +0000     76 192.168.1.125 TCP_MISS/200 -/- 2586 GET https://i.4cdn.org/hr/1734190031181606s.jpg - HIER_DIRECT/i.4cdn.org image/jpeg
14/Dec/2024:15:28:17 +0000     98 192.168.1.125 TCP_MISS/200 -/- 8941 GET https://i.4cdn.org/hr/1732533823407555s.jpg - HIER_DIRECT/i.4cdn.org image/jpeg
14/Dec/2024:15:28:17 +0000     65 192.168.1.125 TCP_MISS/200 -/- 6828 GET https://i.4cdn.org/hr/1729098446168049s.jpg - HIER_DIRECT/i.4cdn.org image/jpeg
14/Dec/2024:15:28:21 +0000     63 192.168.1.125 TCP_MISS/200 -/- 587 HEAD https://i.4cdn.org/hr/1732533823407555.jpg - HIER_DIRECT/i.4cdn.org image/jpeg
14/Dec/2024:15:28:21 +0000    269 192.168.1.125 TCP_MISS/200 -/- 757840 GET https://i.4cdn.org/hr/1732533823407555.jpg - HIER_DIRECT/i.4cdn.org image/jpeg
14/Dec/2024:15:28:25 +0000      4 192.168.1.125 TCP_MEM_HIT/200 -/- 757841 GET https://i.4cdn.org/hr/1732533823407555.jpg - HIER_NONE/- image/jpeg



From slagauterie at hotmail.com  Sun Dec 15 17:31:28 2024
From: slagauterie at hotmail.com (slagauterie at hotmail.com)
Date: Sun, 15 Dec 2024 18:31:28 +0100
Subject: [squid-users] ssl-bump works,
 but leads to many client errors being logged (NONE_NONE/200)
In-Reply-To: <Hbnh6yS3GpK0Pw8JeF72Ak_IcXaahxcIv2PGUfgtYOY7F888X7r-0xcWpqakYUYo42oWL0-XL9UAX38hwooK1ULWph-2wAvOg6TBY2e4Nac=@proton.me>
References: <Hbnh6yS3GpK0Pw8JeF72Ak_IcXaahxcIv2PGUfgtYOY7F888X7r-0xcWpqakYUYo42oWL0-XL9UAX38hwooK1ULWph-2wAvOg6TBY2e4Nac=@proton.me>
Message-ID: <GVXP189MB20315A284F97CBBD516AB522AD3A2@GVXP189MB2031.EURP189.PROD.OUTLOOK.COM>

Hello Rod,

Not an expert, but from my understanding it seems that your
NONE_NONE/200 are all related to a CONNECT. That means it is a SSL
Tunnel, which is the initial log of a HTTPS connection when doing
ssl_bumping.
It is normally followed by another "regular" log, where you can get
more information like protocole, Get or post, and URI, etc.

Bellow 2 examples from your access.log.
1) Here, you have a NONE_NONE/200 for the Tunnel, then a TCP_MISS/200
after bumping is performed:
14/Dec/2024:15:28:14 +0000    122 192.168.1.125 NONE_NONE/200 -/- 0
CONNECT 4chan.org:443 - HIER_DIRECT/4chan.org -
14/Dec/2024:15:28:14 +0000    239 192.168.1.125 TCP_MISS/200 -/- 4876
GET https://4chan.org/ - HIER_DIRECT/4chan.org text/html

2) Here, you have a NONE_NONE/200 for the Tunnel, then a
TCP_REFRESH_MODIFIED/200 after bumping is performed:
14/Dec/2024:15:28:17 +0000    105 192.168.1.125 NONE_NONE/200 -/- 0
CONNECT boards.4chan.org:443 - HIER_DIRECT/boards.4chan.org -
14/Dec/2024:15:28:17 +0000    117 192.168.1.125
TCP_REFRESH_MODIFIED/200 -/- 21264 GET https://boards.4chan.org/hr/ -
HIER_DIRECT/boards.4chan.org text/html

Regards,
Slag
Le samedi 14 d?cembre 2024 ? 16:26 +0000, R a ?crit?:
> 14/Dec/2024:15:28:17 +0000??? 105 192.168.1.125 NONE_NONE/200 -/- 0
> CONNECT boards.4chan.org:443 - HIER_DIRECT/boards.4chan.org -
> 14/Dec/2024:15:28:17 +0000??? 117 192.168.1.125
> TCP_REFRESH_MODIFIED/200 -/- 21264 GET https://boards.4chan.org/hr/?-
> HIER_DIRECT/boards.4chan.org text/html


From uwe.hering at cgi.com  Sun Dec 15 18:32:49 2024
From: uwe.hering at cgi.com (Hering, Uwe)
Date: Sun, 15 Dec 2024 18:32:49 +0000
Subject: [squid-users] squid-6.10-150600.3.6.1.src.rpm and ident
Message-ID: <9817fcbb814d45ceb28b422b887cfb2e@cgi.com>

Trusted 3rd Party

Hello all,

We are using squid (version see above) on SLES15, rebuild with "--enable-ident-lookups".

This works great up to SP5, but is broken with this squid version above belonging to SP6.

Squid ident config, which worked fine up to now, is:


acl userInfo ident REQUIRED

http_access allow userInfo

squid is just logging this error now:

2024/12/12 10:16:05 pinger| Pinger exiting.
2024/12/12 10:16:06 kid1| FATAL: assertion failed: FilledChecklist.cc:263: "!rfc931[0]"
    current master transaction: master53

This is whether ident is running or not, which means the error is not related to any identd answer because there is none, it will even not be requested.

Is this behavior known, any idea? Filed also a bug request, but no answer yet.

Regards,

Uwe
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20241215/8c26bd3f/attachment.htm>

From rousskov at measurement-factory.com  Mon Dec 16 01:37:25 2024
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Sun, 15 Dec 2024 20:37:25 -0500
Subject: [squid-users] squid-6.10-150600.3.6.1.src.rpm and ident
In-Reply-To: <9817fcbb814d45ceb28b422b887cfb2e@cgi.com>
References: <9817fcbb814d45ceb28b422b887cfb2e@cgi.com>
Message-ID: <c972397a-0a01-4866-8390-5e7dbe6a2de6@measurement-factory.com>

On 2024-12-15 13:32, Hering, Uwe wrote:

> We are using squid (version see above) on SLES15, rebuild with 
> ?--enable-ident-lookups".
> 
> This works great up to SP5, but is broken with this squid version above 
> belonging to SP6.

> 2024/12/12 10:16:06 kid1| FATAL: assertion failed: FilledChecklist.cc:263: "!rfc931[0]"

This is a known bug. There was a pull request fixing it in master/v7[1], 
but it was decided that it is best to remove IDENT support from v7 
instead of improving IDENT code. I think it was the right decision.

Squid v6 still has IDENT support. I cannot offer an official fix for 
Squid v6, but I know that the following _unofficial_ patch applies to 
the latest v6 sources. I have not tested whether that patch fixes the 
bug in v6.

https://github.com/measurement-factory/squid/commit/e0f1820.patch



> This is whether ident is running or not, which means the error is not 
> related to any identd answer because there is none, it will even not be 
> requested.
> 
> Is this behavior known, any idea? Filed also a bug request, but no 
> answer yet.

Unfortunately, Squid Bugzilla notifications are unreliable. AFAIK, I 
have not seen your bug report[2] until now. Sorry.


HTH,

Alex.
[1] https://github.com/squid-cache/squid/pull/1815
[2] https://bugs.squid-cache.org/show_bug.cgi?id=5454




From lists at compuniverse.de  Mon Dec 16 08:43:01 2024
From: lists at compuniverse.de (Amon Ott)
Date: Mon, 16 Dec 2024 09:43:01 +0100
Subject: [squid-users] ssl-bump works,
 but leads to many client errors being logged (NONE_NONE/200)
In-Reply-To: <Hbnh6yS3GpK0Pw8JeF72Ak_IcXaahxcIv2PGUfgtYOY7F888X7r-0xcWpqakYUYo42oWL0-XL9UAX38hwooK1ULWph-2wAvOg6TBY2e4Nac=@proton.me>
References: <Hbnh6yS3GpK0Pw8JeF72Ak_IcXaahxcIv2PGUfgtYOY7F888X7r-0xcWpqakYUYo42oWL0-XL9UAX38hwooK1ULWph-2wAvOg6TBY2e4Nac=@proton.me>
Message-ID: <6ef4aa26-297a-49b6-893d-9bd33d2de090@compuniverse.de>

Am 14.12.24 um 17:26 schrieb R:
> My current goal is to set up a caching instance for https static content with squid 6.12.
> 
> ssl-bump is set up according to https://wiki.squid-cache.org/Features/SslBump and it works fine, at least from the clients' perspectives and without any noticeable issues (e.g. with Firefox or Safari). Sometimes (~5-8% of the total requests) I can even get a few cache hits - including those juicy TCP_MEM_HIT/200s.
> 
> What has been bothering me though is the impressive amount of client request errors being logged:
> 
> # a few seconds after an instance restart
> openvpn-client2:/$ squidclient cache_object://localhost/counters | grep client_http.errors
> client_http.errors = 8
> openvpn-client2:/$ squidclient cache_object://localhost/counters | grep client_http.errors
> client_http.errors = 20
> 
> In the access_log, it is possible to see many NONE_NONE/200 being logged for ?**almost every https request**. The amount of logged NONE_NONE/200 seem to vary according to the target website: github.com:443 throws 6-7 errors, while the lists.squid-cache.org throws only one.

When using ssl-bump, you must allow the initial CONNECT request and then 
decide on the broken up requests. E.g. add
http_access allow CONNECT
before your first http_access line.

Amon Ott
-- 
Dr. Amon Ott
m-privacy GmbH           Tel: +49 30 24342334
Werner-Vo?-Damm 62       Fax: +49 30 99296856
12101 Berlin             http://www.m-privacy.de

Amtsgericht Charlottenburg, HRB 84946

Gesch?ftsf?hrer:
  Dipl.-Kfm. Holger Maczkowsky,
  Roman Maczkowsky

GnuPG-Key-ID: 0x2DD3A649



From rousskov at measurement-factory.com  Wed Dec 18 19:35:41 2024
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Wed, 18 Dec 2024 14:35:41 -0500
Subject: [squid-users] Proxy-Protocol inside cache_peer
In-Reply-To: <502bdd1a-c997-421e-a4c8-d9ef1cb4a6bf@articatech.com>
References: <502bdd1a-c997-421e-a4c8-d9ef1cb4a6bf@articatech.com>
Message-ID: <b18adde0-21ab-4722-af42-0e3f074f2574@measurement-factory.com>

On 2024-12-08 09:26, David Touzeau wrote:

> Is there any way or development plan to include ?proxy-protocol? in 
> cache_peer?

I am not aware of any specific current development plans, but there is 
interest in adding that feature, and I expect it to be added eventually.

Alex.


> Squid is able to listen for proxy-protocol, but I haven't seen how to 
> use this protocol when redirecting to Squid parents with proxy-protocol 
> enabled.




From alexmrrc at gmail.com  Sat Dec 21 17:26:14 2024
From: alexmrrc at gmail.com (A. Pechenin)
Date: Sat, 21 Dec 2024 20:26:14 +0300
Subject: [squid-users] SQUID problem with unavailability of Google services
Message-ID: <CAAny9T6o5XcQcPuwQX+a9O2uZU8=0dtLE6ysBAnN-ayi_SL4ug@mail.gmail.com>

 This week, when connecting users through a proxy server, some Google
services became inaccessible, such as Calendar, Translator, user profile.

When clicking on the services section in the browser on the Google portal,
the page does not open and then a connection error is displayed. When
directly going to the calendar section, the connection also hangs for a
long time without loading the page. At the same time, the Google home page,
mail, search work.

Transparent proxying is not used.
Viewing the proxy server logs did not add any understanding, all requests
are processed correctly and no errors or prohibitions are observed. There
are no other problems with the unavailability of any sites.

When connecting directly (bypassing the proxy server), all Google services
work completely correctly.
The platform on which the problem was suddenly discovered:
FreeBSD 13.2-RELEASE-p9
Squid 6.6

A new separate server was deployed for objectivity and finding the cause,
but the problem was also reproduced there, its platform.
FreeBSD 13.4-RELEASE-p2
Squid 6.10

I tried using the default configuration file (recommended minimum
configuration) to eliminate the problem in my working squid.conf, but the
problem remained

I repeat, the problem reproduced suddenly, no changes were made to the
proxy server configuration on our side, no problems with Google have arisen
for many years. What should I pay attention to in the Squid configuration?
Any idea
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20241221/d50a862e/attachment.htm>

From jonathanlee571 at gmail.com  Sat Dec 21 17:43:32 2024
From: jonathanlee571 at gmail.com (Jonathan Lee)
Date: Sat, 21 Dec 2024 09:43:32 -0800
Subject: [squid-users] SQUID problem with unavailability of Google
 services
In-Reply-To: <CAAny9T6o5XcQcPuwQX+a9O2uZU8=0dtLE6ysBAnN-ayi_SL4ug@mail.gmail.com>
References: <CAAny9T6o5XcQcPuwQX+a9O2uZU8=0dtLE6ysBAnN-ayi_SL4ug@mail.gmail.com>
Message-ID: <2FD41F05-38E7-41EC-AA0B-438AD4358945@gmail.com>

Have you created a splice only file with lists of items that must be spliced at all times, Google mail ethically should be spliced just as an example. Some know sites must be spliced. 
Sent from my iPhone

> On Dec 21, 2024, at 09:32, A. Pechenin <alexmrrc at gmail.com> wrote:
> 
> ?
> This week, when connecting users through a proxy server, some Google services became inaccessible, such as Calendar, Translator, user profile.
> 
> When clicking on the services section in the browser on the Google portal, the page does not open and then a connection error is displayed. When directly going to the calendar section, the connection also hangs for a long time without loading the page. At the same time, the Google home page, mail, search work.
> 
> Transparent proxying is not used.
> Viewing the proxy server logs did not add any understanding, all requests are processed correctly and no errors or prohibitions are observed. There are no other problems with the unavailability of any sites.
> 
> When connecting directly (bypassing the proxy server), all Google services work completely correctly.
> The platform on which the problem was suddenly discovered:
> FreeBSD 13.2-RELEASE-p9
> Squid 6.6
> 
> A new separate server was deployed for objectivity and finding the cause, but the problem was also reproduced there, its platform.
> FreeBSD 13.4-RELEASE-p2
> Squid 6.10
> 
> I tried using the default configuration file (recommended minimum configuration) to eliminate the problem in my working squid.conf, but the problem remained
> 
> I repeat, the problem reproduced suddenly, no changes were made to the proxy server configuration on our side, no problems with Google have arisen for many years. What should I pay attention to in the Squid configuration? Any idea
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> https://lists.squid-cache.org/listinfo/squid-users


From alexmrrc at gmail.com  Sat Dec 21 19:46:13 2024
From: alexmrrc at gmail.com (A. Pechenin)
Date: Sat, 21 Dec 2024 22:46:13 +0300
Subject: [squid-users] SQUID problem with unavailability of Google
 services
In-Reply-To: <2FD41F05-38E7-41EC-AA0B-438AD4358945@gmail.com>
References: <CAAny9T6o5XcQcPuwQX+a9O2uZU8=0dtLE6ysBAnN-ayi_SL4ug@mail.gmail.com>
 <2FD41F05-38E7-41EC-AA0B-438AD4358945@gmail.com>
Message-ID: <CAAny9T6FcdUnjb63U5z5CxhdykyAFGkfWD0dUDEbGoA_rGyozg@mail.gmail.com>

 I apologize for the formatting of the text of the letter?

I will be incorrect if I do not say that there are entries in the
cache.log, although the IP does not resolve directly to google subdomains,
but according to whois, this is the Google LLC farm.

2024/12/21 21:54:57 kid1| conn43356657 local=MYREALIP:53130 remote=
142.250.186.142:443 HIER_DIRECT FD 121 flags=1: read/write failure: (60)
Operation timed out
current master transaction: master13542083
2024/12/21 21:58:29 kid1| conn43398624 local=MYREALIP:58390 remote=
142.250.185.238:443 HIER_DIRECT FD 96 flags=1: read/write failure: (60)
Operation timed out
current master transaction: master13553287
2024/12/21 21:58:30 kid1| conn43398801 local=MYREALIP:58419 remote=
172.217.16.206:443 HIER_DIRECT FD 898 flags=1: read/write failure: (60)
Operation timed out


??, 21 ???. 2024??. ? 20:43, Jonathan Lee <jonathanlee571 at gmail.com>:

> Have you created a splice only file with lists of items that must be
> spliced at all times, Google mail ethically should be spliced just as an
> example. Some know sites must be spliced.
> Sent from my iPhone
>
> > On Dec 21, 2024, at 09:32, A. Pechenin <alexmrrc at gmail.com> wrote:
> >
> > ?
> > This week, when connecting users through a proxy server, some Google
> services became inaccessible, such as Calendar, Translator, user profile.
> >
> > When clicking on the services section in the browser on the Google
> portal, the page does not open and then a connection error is displayed.
> When directly going to the calendar section, the connection also hangs for
> a long time without loading the page. At the same time, the Google home
> page, mail, search work.
> >
> > Transparent proxying is not used.
> > Viewing the proxy server logs did not add any understanding, all
> requests are processed correctly and no errors or prohibitions are
> observed. There are no other problems with the unavailability of any sites.
> >
> > When connecting directly (bypassing the proxy server), all Google
> services work completely correctly.
> > The platform on which the problem was suddenly discovered:
> > FreeBSD 13.2-RELEASE-p9
> > Squid 6.6
> >
> > A new separate server was deployed for objectivity and finding the
> cause, but the problem was also reproduced there, its platform.
> > FreeBSD 13.4-RELEASE-p2
> > Squid 6.10
> >
> > I tried using the default configuration file (recommended minimum
> configuration) to eliminate the problem in my working squid.conf, but the
> problem remained
> >
> > I repeat, the problem reproduced suddenly, no changes were made to the
> proxy server configuration on our side, no problems with Google have arisen
> for many years. What should I pay attention to in the Squid configuration?
> Any idea
> > _______________________________________________
> > squid-users mailing list
> > squid-users at lists.squid-cache.org
> > https://lists.squid-cache.org/listinfo/squid-users
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20241221/51d73736/attachment.htm>

From jonathanlee571 at gmail.com  Sat Dec 21 19:57:03 2024
From: jonathanlee571 at gmail.com (Jonathan Lee)
Date: Sat, 21 Dec 2024 19:57:03 +0000
Subject: [squid-users] SQUID problem with unavailability of Google
 services
In-Reply-To: <CAAny9T6FcdUnjb63U5z5CxhdykyAFGkfWD0dUDEbGoA_rGyozg@mail.gmail.com>
References: <CAAny9T6o5XcQcPuwQX+a9O2uZU8=0dtLE6ysBAnN-ayi_SL4ug@mail.gmail.com>
 <2FD41F05-38E7-41EC-AA0B-438AD4358945@gmail.com>
 <CAAny9T6FcdUnjb63U5z5CxhdykyAFGkfWD0dUDEbGoA_rGyozg@mail.gmail.com>
Message-ID: <DS0PR19MB72708F2A9F428345199AFD2CA7002@DS0PR19MB7270.namprd19.prod.outlook.com>

You can use the following

acl NoSSLIntercept ssl::server_name_regex -i "/usr/local/pkg/reg.url.nobump"
acl NoBumpDNS dstdomain "/usr/local/pkg/dns.nobump"

I created a regex based no bump file and or use a dns based no bump file to mark splice only sites.

Example of what is in reg.url.nobump file

^((alt[0-9]-mtalk\.)|(mtalk\.)|(mtalk-(staging|dev)\.))google\.com
^((gvt)([0-9]))\.com
^(((clients)[0-9])|accounts)\.google\.(com|us)
^(pki|(crl|ocsp)\.pki)\.google\.com
(outlook\.)(office365|office)\.com
infinity-c[0-9][0-9]\.youboranqs[0-9][0-9]\.com
hulu\.com
nflxvideo\.net


Or example of what could be in dns.nobump
.play.google.com
.android.com
.google-analytics.com
.googleusercontent.com
.ggpht.com
.dl.google.com
.dl-ssl.google.com
.android.clients.google.com
.omahaproxy.appspot.com
.payments.google.com
.googleapis.com
.notifications.google.com
.ogs.google.com
.googleapis.com

Make sure you follow the enterprise policy for Google Android based products.

Some sites simply can not and or should not be bumped and you only should look at the get header.

________________________________
From: A. Pechenin <alexmrrc at gmail.com>
Sent: Saturday, December 21, 2024 11:46
To: Jonathan Lee <jonathanlee571 at gmail.com>
Cc: squid-users at lists.squid-cache.org <squid-users at lists.squid-cache.org>
Subject: Re: [squid-users] SQUID problem with unavailability of Google services

I apologize for the formatting of the text of the letter?

I will be incorrect if I do not say that there are entries in the cache.log, although the IP does not resolve directly to google subdomains, but according to whois, this is the Google LLC farm.
2024/12/21 21:54:57 kid1| conn43356657 local=MYREALIP:53130 remote=142.250.186.142:443<http://142.250.186.142:443> HIER_DIRECT FD 121 flags=1: read/write failure: (60) Operation timed out
current master transaction: master13542083
2024/12/21 21:58:29 kid1| conn43398624 local=MYREALIP:58390 remote=142.250.185.238:443<http://142.250.185.238:443> HIER_DIRECT FD 96 flags=1: read/write failure: (60) Operation timed out
current master transaction: master13553287
2024/12/21 21:58:30 kid1| conn43398801 local=MYREALIP:58419 remote=172.217.16.206:443<http://172.217.16.206:443> HIER_DIRECT FD 898 flags=1: read/write failure: (60) Operation timed out

??, 21 ???. 2024??. ? 20:43, Jonathan Lee <jonathanlee571 at gmail.com<mailto:jonathanlee571 at gmail.com>>:
Have you created a splice only file with lists of items that must be spliced at all times, Google mail ethically should be spliced just as an example. Some know sites must be spliced.
Sent from my iPhone

> On Dec 21, 2024, at 09:32, A. Pechenin <alexmrrc at gmail.com<mailto:alexmrrc at gmail.com>> wrote:
>
> ?
> This week, when connecting users through a proxy server, some Google services became inaccessible, such as Calendar, Translator, user profile.
>
> When clicking on the services section in the browser on the Google portal, the page does not open and then a connection error is displayed. When directly going to the calendar section, the connection also hangs for a long time without loading the page. At the same time, the Google home page, mail, search work.
>
> Transparent proxying is not used.
> Viewing the proxy server logs did not add any understanding, all requests are processed correctly and no errors or prohibitions are observed. There are no other problems with the unavailability of any sites.
>
> When connecting directly (bypassing the proxy server), all Google services work completely correctly.
> The platform on which the problem was suddenly discovered:
> FreeBSD 13.2-RELEASE-p9
> Squid 6.6
>
> A new separate server was deployed for objectivity and finding the cause, but the problem was also reproduced there, its platform.
> FreeBSD 13.4-RELEASE-p2
> Squid 6.10
>
> I tried using the default configuration file (recommended minimum configuration) to eliminate the problem in my working squid.conf, but the problem remained
>
> I repeat, the problem reproduced suddenly, no changes were made to the proxy server configuration on our side, no problems with Google have arisen for many years. What should I pay attention to in the Squid configuration? Any idea
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org<mailto:squid-users at lists.squid-cache.org>
> https://lists.squid-cache.org/listinfo/squid-users
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20241221/b6dc64e7/attachment.htm>

From jonathanlee571 at gmail.com  Sat Dec 21 20:10:32 2024
From: jonathanlee571 at gmail.com (Jonathan Lee)
Date: Sat, 21 Dec 2024 20:10:32 +0000
Subject: [squid-users] SQUID problem with unavailability of Google
 services
In-Reply-To: <DS0PR19MB72708F2A9F428345199AFD2CA7002@DS0PR19MB7270.namprd19.prod.outlook.com>
References: <CAAny9T6o5XcQcPuwQX+a9O2uZU8=0dtLE6ysBAnN-ayi_SL4ug@mail.gmail.com>
 <2FD41F05-38E7-41EC-AA0B-438AD4358945@gmail.com>
 <CAAny9T6FcdUnjb63U5z5CxhdykyAFGkfWD0dUDEbGoA_rGyozg@mail.gmail.com>
 <DS0PR19MB72708F2A9F428345199AFD2CA7002@DS0PR19MB7270.namprd19.prod.outlook.com>
Message-ID: <DS0PR19MB72700F60C03F5D972D0204F2A7002@DS0PR19MB7270.namprd19.prod.outlook.com>

Ref:
Android Enterprise Network Requirements - Android Enterprise Help<https://support.google.com/work/android/answer/10513641?hl=en>
Android Enterprise Network Requirements - Google Help<https://support.google.com/work/android/answer/10513641?hl=en>
The following article has been designed for IT admins, to help them determine the best way to set up their networks for Android Enterprise devices.
support.google.com


Use Apple products on enterprise networks ? Apple Support (UK)<https://support.apple.com/en-gb/101555>

The links above can be referenced to help you create your splice only list for items that you can not and should not bump.
Use Apple products on enterprise networks ? Apple Support (UK)<https://support.apple.com/en-gb/101555>
Find out which hosts and ports are required to use your Apple products on enterprise networks.
support.apple.com


________________________________
From: Jonathan Lee <jonathanlee571 at gmail.com>
Sent: Saturday, December 21, 2024 11:57
To: A. Pechenin <alexmrrc at gmail.com>
Cc: squid-users at lists.squid-cache.org <squid-users at lists.squid-cache.org>
Subject: Re: [squid-users] SQUID problem with unavailability of Google services

You can use the following

acl NoSSLIntercept ssl::server_name_regex -i "/usr/local/pkg/reg.url.nobump"
acl NoBumpDNS dstdomain "/usr/local/pkg/dns.nobump"

I created a regex based no bump file and or use a dns based no bump file to mark splice only sites.

Example of what is in reg.url.nobump file

^((alt[0-9]-mtalk\.)|(mtalk\.)|(mtalk-(staging|dev)\.))google\.com
^((gvt)([0-9]))\.com
^(((clients)[0-9])|accounts)\.google\.(com|us)
^(pki|(crl|ocsp)\.pki)\.google\.com
(outlook\.)(office365|office)\.com
infinity-c[0-9][0-9]\.youboranqs[0-9][0-9]\.com
hulu\.com
nflxvideo\.net


Or example of what could be in dns.nobump
.play.google.com
.android.com
.google-analytics.com
.googleusercontent.com
.ggpht.com
.dl.google.com
.dl-ssl.google.com
.android.clients.google.com
.omahaproxy.appspot.com
.payments.google.com
.googleapis.com
.notifications.google.com
.ogs.google.com
.googleapis.com

Make sure you follow the enterprise policy for Google Android based products.

Some sites simply can not and or should not be bumped and you only should look at the get header.

________________________________
From: A. Pechenin <alexmrrc at gmail.com>
Sent: Saturday, December 21, 2024 11:46
To: Jonathan Lee <jonathanlee571 at gmail.com>
Cc: squid-users at lists.squid-cache.org <squid-users at lists.squid-cache.org>
Subject: Re: [squid-users] SQUID problem with unavailability of Google services

I apologize for the formatting of the text of the letter?

I will be incorrect if I do not say that there are entries in the cache.log, although the IP does not resolve directly to google subdomains, but according to whois, this is the Google LLC farm.
2024/12/21 21:54:57 kid1| conn43356657 local=MYREALIP:53130 remote=142.250.186.142:443<http://142.250.186.142:443> HIER_DIRECT FD 121 flags=1: read/write failure: (60) Operation timed out
current master transaction: master13542083
2024/12/21 21:58:29 kid1| conn43398624 local=MYREALIP:58390 remote=142.250.185.238:443<http://142.250.185.238:443> HIER_DIRECT FD 96 flags=1: read/write failure: (60) Operation timed out
current master transaction: master13553287
2024/12/21 21:58:30 kid1| conn43398801 local=MYREALIP:58419 remote=172.217.16.206:443<http://172.217.16.206:443> HIER_DIRECT FD 898 flags=1: read/write failure: (60) Operation timed out

??, 21 ???. 2024??. ? 20:43, Jonathan Lee <jonathanlee571 at gmail.com<mailto:jonathanlee571 at gmail.com>>:
Have you created a splice only file with lists of items that must be spliced at all times, Google mail ethically should be spliced just as an example. Some know sites must be spliced.
Sent from my iPhone

> On Dec 21, 2024, at 09:32, A. Pechenin <alexmrrc at gmail.com<mailto:alexmrrc at gmail.com>> wrote:
>
> ?
> This week, when connecting users through a proxy server, some Google services became inaccessible, such as Calendar, Translator, user profile.
>
> When clicking on the services section in the browser on the Google portal, the page does not open and then a connection error is displayed. When directly going to the calendar section, the connection also hangs for a long time without loading the page. At the same time, the Google home page, mail, search work.
>
> Transparent proxying is not used.
> Viewing the proxy server logs did not add any understanding, all requests are processed correctly and no errors or prohibitions are observed. There are no other problems with the unavailability of any sites.
>
> When connecting directly (bypassing the proxy server), all Google services work completely correctly.
> The platform on which the problem was suddenly discovered:
> FreeBSD 13.2-RELEASE-p9
> Squid 6.6
>
> A new separate server was deployed for objectivity and finding the cause, but the problem was also reproduced there, its platform.
> FreeBSD 13.4-RELEASE-p2
> Squid 6.10
>
> I tried using the default configuration file (recommended minimum configuration) to eliminate the problem in my working squid.conf, but the problem remained
>
> I repeat, the problem reproduced suddenly, no changes were made to the proxy server configuration on our side, no problems with Google have arisen for many years. What should I pay attention to in the Squid configuration? Any idea
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org<mailto:squid-users at lists.squid-cache.org>
> https://lists.squid-cache.org/listinfo/squid-users
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20241221/858b97b8/attachment.htm>

From alexmrrc at gmail.com  Sat Dec 21 20:18:53 2024
From: alexmrrc at gmail.com (A. Pechenin)
Date: Sat, 21 Dec 2024 23:18:53 +0300
Subject: [squid-users] SQUID problem with unavailability of Google
 services
In-Reply-To: <DS0PR19MB72708F2A9F428345199AFD2CA7002@DS0PR19MB7270.namprd19.prod.outlook.com>
References: <CAAny9T6o5XcQcPuwQX+a9O2uZU8=0dtLE6ysBAnN-ayi_SL4ug@mail.gmail.com>
 <2FD41F05-38E7-41EC-AA0B-438AD4358945@gmail.com>
 <CAAny9T6FcdUnjb63U5z5CxhdykyAFGkfWD0dUDEbGoA_rGyozg@mail.gmail.com>
 <DS0PR19MB72708F2A9F428345199AFD2CA7002@DS0PR19MB7270.namprd19.prod.outlook.com>
Message-ID: <CAAny9T4=9Qrgbu6Pywtie5_3HtQrxfW3uL3cbO0p0Kay4FPuAw@mail.gmail.com>

 OK, but how can ACL data be applied in practice to solve the problem I
described?

??, 21 ???. 2024??. ? 22:57, Jonathan Lee <jonathanlee571 at gmail.com>:

> You can use the following
>
> acl NoSSLIntercept ssl::server_name_regex -i
> "/usr/local/pkg/reg.url.nobump"
> acl NoBumpDNS dstdomain "/usr/local/pkg/dns.nobump"
>
> I created a regex based no bump file and or use a dns based no bump file
> to mark splice only sites.
>
> Example of what is in reg.url.nobump file
>
> ^((alt[0-9]-mtalk\.)|(mtalk\.)|(mtalk-(staging|dev)\.))google\.com
> ^((gvt)([0-9]))\.com
> ^(((clients)[0-9])|accounts)\.google\.(com|us)
> ^(pki|(crl|ocsp)\.pki)\.google\.com
> (outlook\.)(office365|office)\.com
> infinity-c[0-9][0-9]\.youboranqs[0-9][0-9]\.com
> hulu\.com
> nflxvideo\.net
>
>
> Or example of what could be in dns.nobump
> .play.google.com
> .android.com
> .google-analytics.com
> .googleusercontent.com
> .ggpht.com
> .dl.google.com
> .dl-ssl.google.com
> .android.clients.google.com
> .omahaproxy.appspot.com
> .payments.google.com
> .googleapis.com
> .notifications.google.com
> .ogs.google.com
> .googleapis.com
>
> Make sure you follow the enterprise policy for Google Android based
> products.
>
> Some sites simply can not and or should not be bumped and you only should
> look at the get header.
>
> ------------------------------
> *From:* A. Pechenin <alexmrrc at gmail.com>
> *Sent:* Saturday, December 21, 2024 11:46
> *To:* Jonathan Lee <jonathanlee571 at gmail.com>
> *Cc:* squid-users at lists.squid-cache.org <squid-users at lists.squid-cache.org
> >
> *Subject:* Re: [squid-users] SQUID problem with unavailability of Google
> services
>
> I apologize for the formatting of the text of the letter?
>
> I will be incorrect if I do not say that there are entries in the
> cache.log, although the IP does not resolve directly to google subdomains,
> but according to whois, this is the Google LLC farm.
>
> 2024/12/21 21:54:57 kid1| conn43356657 local=MYREALIP:53130 remote=
> 142.250.186.142:443 HIER_DIRECT FD 121 flags=1: read/write failure: (60)
> Operation timed out
> current master transaction: master13542083
> 2024/12/21 21:58:29 kid1| conn43398624 local=MYREALIP:58390 remote=
> 142.250.185.238:443 HIER_DIRECT FD 96 flags=1: read/write failure: (60)
> Operation timed out
> current master transaction: master13553287
> 2024/12/21 21:58:30 kid1| conn43398801 local=MYREALIP:58419 remote=
> 172.217.16.206:443 HIER_DIRECT FD 898 flags=1: read/write failure: (60)
> Operation timed out
>
>
> ??, 21 ???. 2024??. ? 20:43, Jonathan Lee <jonathanlee571 at gmail.com>:
>
> Have you created a splice only file with lists of items that must be
> spliced at all times, Google mail ethically should be spliced just as an
> example. Some know sites must be spliced.
> Sent from my iPhone
>
> > On Dec 21, 2024, at 09:32, A. Pechenin <alexmrrc at gmail.com> wrote:
> >
> > ?
> > This week, when connecting users through a proxy server, some Google
> services became inaccessible, such as Calendar, Translator, user profile.
> >
> > When clicking on the services section in the browser on the Google
> portal, the page does not open and then a connection error is displayed.
> When directly going to the calendar section, the connection also hangs for
> a long time without loading the page. At the same time, the Google home
> page, mail, search work.
> >
> > Transparent proxying is not used.
> > Viewing the proxy server logs did not add any understanding, all
> requests are processed correctly and no errors or prohibitions are
> observed. There are no other problems with the unavailability of any sites.
> >
> > When connecting directly (bypassing the proxy server), all Google
> services work completely correctly.
> > The platform on which the problem was suddenly discovered:
> > FreeBSD 13.2-RELEASE-p9
> > Squid 6.6
> >
> > A new separate server was deployed for objectivity and finding the
> cause, but the problem was also reproduced there, its platform.
> > FreeBSD 13.4-RELEASE-p2
> > Squid 6.10
> >
> > I tried using the default configuration file (recommended minimum
> configuration) to eliminate the problem in my working squid.conf, but the
> problem remained
> >
> > I repeat, the problem reproduced suddenly, no changes were made to the
> proxy server configuration on our side, no problems with Google have arisen
> for many years. What should I pay attention to in the Squid configuration?
> Any idea
> > _______________________________________________
> > squid-users mailing list
> > squid-users at lists.squid-cache.org
> > https://lists.squid-cache.org/listinfo/squid-users
>
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20241221/20ca4ba7/attachment.htm>

From alexmrrc at gmail.com  Sat Dec 21 20:21:14 2024
From: alexmrrc at gmail.com (A. Pechenin)
Date: Sat, 21 Dec 2024 23:21:14 +0300
Subject: [squid-users] SQUID problem with unavailability of Google
 services
In-Reply-To: <DS0PR19MB72700F60C03F5D972D0204F2A7002@DS0PR19MB7270.namprd19.prod.outlook.com>
References: <CAAny9T6o5XcQcPuwQX+a9O2uZU8=0dtLE6ysBAnN-ayi_SL4ug@mail.gmail.com>
 <2FD41F05-38E7-41EC-AA0B-438AD4358945@gmail.com>
 <CAAny9T6FcdUnjb63U5z5CxhdykyAFGkfWD0dUDEbGoA_rGyozg@mail.gmail.com>
 <DS0PR19MB72708F2A9F428345199AFD2CA7002@DS0PR19MB7270.namprd19.prod.outlook.com>
 <DS0PR19MB72700F60C03F5D972D0204F2A7002@DS0PR19MB7270.namprd19.prod.outlook.com>
Message-ID: <CAAny9T52X77HGwGj5N4HL=o_pETCs5E6sjw-rj2qgSGUuM_ucg@mail.gmail.com>

 I do not use users with Android and iOS, all my users are Windows clients
with Google and Mozilla Firefox browsers and Yandex Browser.

??, 21 ???. 2024??. ? 23:10, Jonathan Lee <jonathanlee571 at gmail.com>:

> Ref:
> Android Enterprise Network Requirements - Android Enterprise Help
> <https://support.google.com/work/android/answer/10513641?hl=en>
> Android Enterprise Network Requirements - Google Help
> <https://support.google.com/work/android/answer/10513641?hl=en>
> The following article has been designed for IT admins, to help them
> determine the best way to set up their networks for Android Enterprise
> devices.
> support.google.com
>
>
> Use Apple products on enterprise networks ? Apple Support (UK)
> <https://support.apple.com/en-gb/101555>
>
> The links above can be referenced to help you create your splice only list
> for items that you can not and should not bump.
> Use Apple products on enterprise networks ? Apple Support (UK)
> <https://support.apple.com/en-gb/101555>
> Find out which hosts and ports are required to use your Apple products on
> enterprise networks.
> support.apple.com
>
>
> ------------------------------
> *From:* Jonathan Lee <jonathanlee571 at gmail.com>
> *Sent:* Saturday, December 21, 2024 11:57
> *To:* A. Pechenin <alexmrrc at gmail.com>
> *Cc:* squid-users at lists.squid-cache.org <squid-users at lists.squid-cache.org
> >
> *Subject:* Re: [squid-users] SQUID problem with unavailability of Google
> services
>
> You can use the following
>
> acl NoSSLIntercept ssl::server_name_regex -i
> "/usr/local/pkg/reg.url.nobump"
> acl NoBumpDNS dstdomain "/usr/local/pkg/dns.nobump"
>
> I created a regex based no bump file and or use a dns based no bump file
> to mark splice only sites.
>
> Example of what is in reg.url.nobump file
>
> ^((alt[0-9]-mtalk\.)|(mtalk\.)|(mtalk-(staging|dev)\.))google\.com
> ^((gvt)([0-9]))\.com
> ^(((clients)[0-9])|accounts)\.google\.(com|us)
> ^(pki|(crl|ocsp)\.pki)\.google\.com
> (outlook\.)(office365|office)\.com
> infinity-c[0-9][0-9]\.youboranqs[0-9][0-9]\.com
> hulu\.com
> nflxvideo\.net
>
>
> Or example of what could be in dns.nobump
> .play.google.com
> .android.com
> .google-analytics.com
> .googleusercontent.com
> .ggpht.com
> .dl.google.com
> .dl-ssl.google.com
> .android.clients.google.com
> .omahaproxy.appspot.com
> .payments.google.com
> .googleapis.com
> .notifications.google.com
> .ogs.google.com
> .googleapis.com
>
> Make sure you follow the enterprise policy for Google Android based
> products.
>
> Some sites simply can not and or should not be bumped and you only should
> look at the get header.
>
> ------------------------------
> *From:* A. Pechenin <alexmrrc at gmail.com>
> *Sent:* Saturday, December 21, 2024 11:46
> *To:* Jonathan Lee <jonathanlee571 at gmail.com>
> *Cc:* squid-users at lists.squid-cache.org <squid-users at lists.squid-cache.org
> >
> *Subject:* Re: [squid-users] SQUID problem with unavailability of Google
> services
>
> I apologize for the formatting of the text of the letter?
>
> I will be incorrect if I do not say that there are entries in the
> cache.log, although the IP does not resolve directly to google subdomains,
> but according to whois, this is the Google LLC farm.
>
> 2024/12/21 21:54:57 kid1| conn43356657 local=MYREALIP:53130 remote=
> 142.250.186.142:443 HIER_DIRECT FD 121 flags=1: read/write failure: (60)
> Operation timed out
> current master transaction: master13542083
> 2024/12/21 21:58:29 kid1| conn43398624 local=MYREALIP:58390 remote=
> 142.250.185.238:443 HIER_DIRECT FD 96 flags=1: read/write failure: (60)
> Operation timed out
> current master transaction: master13553287
> 2024/12/21 21:58:30 kid1| conn43398801 local=MYREALIP:58419 remote=
> 172.217.16.206:443 HIER_DIRECT FD 898 flags=1: read/write failure: (60)
> Operation timed out
>
>
> ??, 21 ???. 2024??. ? 20:43, Jonathan Lee <jonathanlee571 at gmail.com>:
>
> Have you created a splice only file with lists of items that must be
> spliced at all times, Google mail ethically should be spliced just as an
> example. Some know sites must be spliced.
> Sent from my iPhone
>
> > On Dec 21, 2024, at 09:32, A. Pechenin <alexmrrc at gmail.com> wrote:
> >
> > ?
> > This week, when connecting users through a proxy server, some Google
> services became inaccessible, such as Calendar, Translator, user profile.
> >
> > When clicking on the services section in the browser on the Google
> portal, the page does not open and then a connection error is displayed.
> When directly going to the calendar section, the connection also hangs for
> a long time without loading the page. At the same time, the Google home
> page, mail, search work.
> >
> > Transparent proxying is not used.
> > Viewing the proxy server logs did not add any understanding, all
> requests are processed correctly and no errors or prohibitions are
> observed. There are no other problems with the unavailability of any sites.
> >
> > When connecting directly (bypassing the proxy server), all Google
> services work completely correctly.
> > The platform on which the problem was suddenly discovered:
> > FreeBSD 13.2-RELEASE-p9
> > Squid 6.6
> >
> > A new separate server was deployed for objectivity and finding the
> cause, but the problem was also reproduced there, its platform.
> > FreeBSD 13.4-RELEASE-p2
> > Squid 6.10
> >
> > I tried using the default configuration file (recommended minimum
> configuration) to eliminate the problem in my working squid.conf, but the
> problem remained
> >
> > I repeat, the problem reproduced suddenly, no changes were made to the
> proxy server configuration on our side, no problems with Google have arisen
> for many years. What should I pay attention to in the Squid configuration?
> Any idea
> > _______________________________________________
> > squid-users mailing list
> > squid-users at lists.squid-cache.org
> > https://lists.squid-cache.org/listinfo/squid-users
>
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20241221/de5cb91e/attachment.htm>

From jonathanlee571 at gmail.com  Sat Dec 21 21:01:09 2024
From: jonathanlee571 at gmail.com (Jonathan Lee)
Date: Sat, 21 Dec 2024 13:01:09 -0800
Subject: [squid-users] SQUID problem with unavailability of Google
 services
In-Reply-To: <CAAny9T4=9Qrgbu6Pywtie5_3HtQrxfW3uL3cbO0p0Kay4FPuAw@mail.gmail.com>
References: <CAAny9T6o5XcQcPuwQX+a9O2uZU8=0dtLE6ysBAnN-ayi_SL4ug@mail.gmail.com>
 <2FD41F05-38E7-41EC-AA0B-438AD4358945@gmail.com>
 <CAAny9T6FcdUnjb63U5z5CxhdykyAFGkfWD0dUDEbGoA_rGyozg@mail.gmail.com>
 <DS0PR19MB72708F2A9F428345199AFD2CA7002@DS0PR19MB7270.namprd19.prod.outlook.com>
 <CAAny9T4=9Qrgbu6Pywtie5_3HtQrxfW3uL3cbO0p0Kay4FPuAw@mail.gmail.com>
Message-ID: <9CF36145-C25B-427A-B5AC-7652D6F1B355@gmail.com>

You apply it as a custom setting in Squid. I would seek out what header request is failing and start from there to fix your issue. 

Good luck. 


> On Dec 21, 2024, at 12:18, A. Pechenin <alexmrrc at gmail.com> wrote:
> 
> OK, but how can ACL data be applied in practice to solve the problem I described?
> 
> ??, 21 ???. 2024??. ? 22:57, Jonathan Lee <jonathanlee571 at gmail.com <mailto:jonathanlee571 at gmail.com>>:
>> You can use the following 
>> 
>> acl NoSSLIntercept ssl::server_name_regex -i "/usr/local/pkg/reg.url.nobump"
>> acl NoBumpDNS dstdomain "/usr/local/pkg/dns.nobump"
>> 
>> I created a regex based no bump file and or use a dns based no bump file to mark splice only sites.
>> 
>> Example of what is in reg.url.nobump file
>> 
>> ^((alt[0-9]-mtalk\.)|(mtalk\.)|(mtalk-(staging|dev)\.))google\.com
>> ^((gvt)([0-9]))\.com
>> ^(((clients)[0-9])|accounts)\.google\.(com|us)
>> ^(pki|(crl|ocsp)\.pki)\.google\.com
>> (outlook\.)(office365|office)\.com
>> infinity-c[0-9][0-9]\.youboranqs[0-9][0-9]\.com
>> hulu\.com
>> nflxvideo\.net
>> 
>> 
>> Or example of what could be in dns.nobump
>> .play.google.com <http://play.google.com/>
>> .android.com <http://android.com/>
>> .google-analytics.com <http://google-analytics.com/>
>> .googleusercontent.com <http://googleusercontent.com/>
>> .ggpht.com <http://ggpht.com/>
>> .dl.google.com <http://dl.google.com/>
>> .dl-ssl.google.com <http://dl-ssl.google.com/>
>> .android.clients.google.com <http://android.clients.google.com/>
>> .omahaproxy.appspot.com <http://omahaproxy.appspot.com/>
>> .payments.google.com <http://payments.google.com/>
>> .googleapis.com <http://googleapis.com/>
>> .notifications.google.com <http://notifications.google.com/>
>> .ogs.google.com <http://ogs.google.com/>
>> .googleapis.com <http://googleapis.com/>
>> 
>> Make sure you follow the enterprise policy for Google Android based products. 
>> 
>> Some sites simply can not and or should not be bumped and you only should look at the get header. 
>> 
>> From: A. Pechenin <alexmrrc at gmail.com <mailto:alexmrrc at gmail.com>>
>> Sent: Saturday, December 21, 2024 11:46
>> To: Jonathan Lee <jonathanlee571 at gmail.com <mailto:jonathanlee571 at gmail.com>>
>> Cc: squid-users at lists.squid-cache.org <mailto:squid-users at lists.squid-cache.org> <squid-users at lists.squid-cache.org <mailto:squid-users at lists.squid-cache.org>>
>> Subject: Re: [squid-users] SQUID problem with unavailability of Google services
>>  
>> I apologize for the formatting of the text of the letter?
>> 
>> I will be incorrect if I do not say that there are entries in the cache.log, although the IP does not resolve directly to google subdomains, but according to whois, this is the Google LLC farm.
>> 2024/12/21 21:54:57 kid1| conn43356657 local=MYREALIP:53130 remote=142.250.186.142:443 <http://142.250.186.142:443/> HIER_DIRECT FD 121 flags=1: read/write failure: (60) Operation timed out
>> current master transaction: master13542083
>> 2024/12/21 21:58:29 kid1| conn43398624 local=MYREALIP:58390 remote=142.250.185.238:443 <http://142.250.185.238:443/> HIER_DIRECT FD 96 flags=1: read/write failure: (60) Operation timed out
>> current master transaction: master13553287
>> 2024/12/21 21:58:30 kid1| conn43398801 local=MYREALIP:58419 remote=172.217.16.206:443 <http://172.217.16.206:443/> HIER_DIRECT FD 898 flags=1: read/write failure: (60) Operation timed out
>> 
>> ??, 21 ???. 2024??. ? 20:43, Jonathan Lee <jonathanlee571 at gmail.com <mailto:jonathanlee571 at gmail.com>>:
>> Have you created a splice only file with lists of items that must be spliced at all times, Google mail ethically should be spliced just as an example. Some know sites must be spliced. 
>> Sent from my iPhone
>> 
>> > On Dec 21, 2024, at 09:32, A. Pechenin <alexmrrc at gmail.com <mailto:alexmrrc at gmail.com>> wrote:
>> > 
>> > ?
>> > This week, when connecting users through a proxy server, some Google services became inaccessible, such as Calendar, Translator, user profile.
>> > 
>> > When clicking on the services section in the browser on the Google portal, the page does not open and then a connection error is displayed. When directly going to the calendar section, the connection also hangs for a long time without loading the page. At the same time, the Google home page, mail, search work.
>> > 
>> > Transparent proxying is not used.
>> > Viewing the proxy server logs did not add any understanding, all requests are processed correctly and no errors or prohibitions are observed. There are no other problems with the unavailability of any sites.
>> > 
>> > When connecting directly (bypassing the proxy server), all Google services work completely correctly.
>> > The platform on which the problem was suddenly discovered:
>> > FreeBSD 13.2-RELEASE-p9
>> > Squid 6.6
>> > 
>> > A new separate server was deployed for objectivity and finding the cause, but the problem was also reproduced there, its platform.
>> > FreeBSD 13.4-RELEASE-p2
>> > Squid 6.10
>> > 
>> > I tried using the default configuration file (recommended minimum configuration) to eliminate the problem in my working squid.conf, but the problem remained
>> > 
>> > I repeat, the problem reproduced suddenly, no changes were made to the proxy server configuration on our side, no problems with Google have arisen for many years. What should I pay attention to in the Squid configuration? Any idea
>> > _______________________________________________
>> > squid-users mailing list
>> > squid-users at lists.squid-cache.org <mailto:squid-users at lists.squid-cache.org>
>> > https://lists.squid-cache.org/listinfo/squid-users

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20241221/fa71923e/attachment.htm>

From jonathanlee571 at gmail.com  Sat Dec 21 21:56:29 2024
From: jonathanlee571 at gmail.com (Jonathan Lee)
Date: Sat, 21 Dec 2024 13:56:29 -0800
Subject: [squid-users] SQUID problem with unavailability of Google
 services
In-Reply-To: <CAAny9T4=9Qrgbu6Pywtie5_3HtQrxfW3uL3cbO0p0Kay4FPuAw@mail.gmail.com>
References: <CAAny9T4=9Qrgbu6Pywtie5_3HtQrxfW3uL3cbO0p0Kay4FPuAw@mail.gmail.com>
Message-ID: <91A3FA40-377D-40BF-97CB-AAFF6DCA67E1@gmail.com>

An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20241221/b62b4a36/attachment.htm>

From rousskov at measurement-factory.com  Sun Dec 22 01:51:00 2024
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Sat, 21 Dec 2024 20:51:00 -0500
Subject: [squid-users] SQUID problem with unavailability of Google
 services
In-Reply-To: <CAAny9T6o5XcQcPuwQX+a9O2uZU8=0dtLE6ysBAnN-ayi_SL4ug@mail.gmail.com>
References: <CAAny9T6o5XcQcPuwQX+a9O2uZU8=0dtLE6ysBAnN-ayi_SL4ug@mail.gmail.com>
Message-ID: <6fa6d462-7a11-4225-8c7f-92ac68691ab9@measurement-factory.com>

On 2024-12-21 12:26, A. Pechenin wrote:
> This week, when connecting users through a proxy server, some Google 
> services became inaccessible, such as Calendar, Translator, user profile.

Do you use any ssl_bump directives? You have mentioned a test with 
"default configuration file" below. That configuration file does not 
have any ssl_bump directives. When testing with that default 
configuration file, did you add any ssl_bump directives?

If you are not using SslBump, then suggestions regarding "splicing" do 
not apply to your environment -- your Squid is already effectively 
splicing all TLS connections. In this case, please clarify whether 
"Operation timed out" failures that you have mentioned in your second 
post are also reflected in access.log records. You have said that "all 
requests are processed correctly and no errors or prohibitions are 
observed", and I am trying to correlate that statement with those 
timeout errors...


> 2024/12/21 21:54:57 kid1| conn43356657 local=MYREALIP:53130
> remote=142.250.186.142:443 HIER_DIRECT FD 121 flags=1: 
> read/write failure: (60) Operation timed out
> current master transaction: master13542083

Do you know whether these timeout errors were present when everything 
was working correctly?

Do you always see at least one such timeout error for every case when 
"the page does not open and then a connection error is displayed"? In 
other words, is there a strong correlation between client-side problems 
and these timeout errors in cache.log?


Thank you,

Alex.


> When clicking on the services section in the browser on the Google 
> portal, the page does not open and then a connection error is displayed. 
> When directly going to the calendar section, the connection also hangs 
> for a long time without loading the page. At the same time, the Google 
> home page, mail, search work.
> 
> Transparent proxying is not used.
> Viewing the proxy server logs did not add any understanding, all 
> requests are processed correctly and no errors or prohibitions are 
> observed. There are no other problems with the unavailability of any sites.
> 
> When connecting directly (bypassing the proxy server), all Google 
> services work completely correctly.
> The platform on which the problem was suddenly discovered:
> FreeBSD 13.2-RELEASE-p9
> Squid 6.6
> 
> A new separate server was deployed for objectivity and finding the 
> cause, but the problem was also reproduced there, its platform.
> FreeBSD 13.4-RELEASE-p2
> Squid 6.10
> 
> I tried using the default configuration file (recommended minimum 
> configuration) to eliminate the problem in my working squid.conf, but 
> the problem remained
> 
> I repeat, the problem reproduced suddenly, no changes were made to the 
> proxy server configuration on our side, no problems with Google have 
> arisen for many years. What should I pay attention to in the Squid 
> configuration? Any idea
> 
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> https://lists.squid-cache.org/listinfo/squid-users



From alexmrrc at gmail.com  Sun Dec 22 06:38:02 2024
From: alexmrrc at gmail.com (A. Pechenin)
Date: Sun, 22 Dec 2024 09:38:02 +0300
Subject: [squid-users] SQUID problem with unavailability of Google
 services
In-Reply-To: <6fa6d462-7a11-4225-8c7f-92ac68691ab9@measurement-factory.com>
References: <CAAny9T6o5XcQcPuwQX+a9O2uZU8=0dtLE6ysBAnN-ayi_SL4ug@mail.gmail.com>
 <6fa6d462-7a11-4225-8c7f-92ac68691ab9@measurement-factory.com>
Message-ID: <CAAny9T76QTgLrupK2s43p8NX=CbHuMQaBVGaKBqnQnYVNAw2vQ@mail.gmail.com>

 No, ssl_bump is not used in any form in Squid, I intentionally reproduced
the problem on the default configuration file.

In access.log i do not observe any questionable recordings when reproducing
the problem:
acl hasRequest has request
access_log daemon:/var/log/squid/access.log squid hasRequest

TCP_TUNNEL/200 39 CONNECT play.google.com:443 - HIER_DIRECT/216.58.212.174 -
TCP_TUNNEL/200 39 CONNECT www.gstatic.com:443 - HIER_DIRECT/142.250.185.195
-
TCP_TUNNEL/200 6623 CONNECT drive.google.com:443 - HIER_DIRECT/
142.250.27.194 -
TCP_TUNNEL/200 13269 CONNECT waa-pa.clients6.google.com:443 - HIER_DIRECT/
142.250.186.138 -

Yes, such messages were present in the cache.log when the Google service
was running. I didn't attach any significant importance to them.

Probably not, rather than yes. Either these messages will appear in the
cache.log with a delay.


??, 22 ???. 2024??. ? 07:17, Alex Rousskov <rousskov at measurement-factory.com
>:

> On 2024-12-21 12:26, A. Pechenin wrote:
> > This week, when connecting users through a proxy server, some Google
> > services became inaccessible, such as Calendar, Translator, user profile.
>
> Do you use any ssl_bump directives? You have mentioned a test with
> "default configuration file" below. That configuration file does not
> have any ssl_bump directives. When testing with that default
> configuration file, did you add any ssl_bump directives?
>
> If you are not using SslBump, then suggestions regarding "splicing" do
> not apply to your environment -- your Squid is already effectively
> splicing all TLS connections. In this case, please clarify whether
> "Operation timed out" failures that you have mentioned in your second
> post are also reflected in access.log records. You have said that "all
> requests are processed correctly and no errors or prohibitions are
> observed", and I am trying to correlate that statement with those
> timeout errors...
>
>
> > 2024/12/21 21:54:57 kid1| conn43356657 local=MYREALIP:53130
> > remote=142.250.186.142:443 HIER_DIRECT FD 121 flags=1:
> > read/write failure: (60) Operation timed out
> > current master transaction: master13542083
>
> Do you know whether these timeout errors were present when everything
> was working correctly?
>
> Do you always see at least one such timeout error for every case when
> "the page does not open and then a connection error is displayed"? In
> other words, is there a strong correlation between client-side problems
> and these timeout errors in cache.log?
>
>
> Thank you,
>
> Alex.
>
>
> > When clicking on the services section in the browser on the Google
> > portal, the page does not open and then a connection error is displayed.
> > When directly going to the calendar section, the connection also hangs
> > for a long time without loading the page. At the same time, the Google
> > home page, mail, search work.
> >
> > Transparent proxying is not used.
> > Viewing the proxy server logs did not add any understanding, all
> > requests are processed correctly and no errors or prohibitions are
> > observed. There are no other problems with the unavailability of any
> sites.
> >
> > When connecting directly (bypassing the proxy server), all Google
> > services work completely correctly.
> > The platform on which the problem was suddenly discovered:
> > FreeBSD 13.2-RELEASE-p9
> > Squid 6.6
> >
> > A new separate server was deployed for objectivity and finding the
> > cause, but the problem was also reproduced there, its platform.
> > FreeBSD 13.4-RELEASE-p2
> > Squid 6.10
> >
> > I tried using the default configuration file (recommended minimum
> > configuration) to eliminate the problem in my working squid.conf, but
> > the problem remained
> >
> > I repeat, the problem reproduced suddenly, no changes were made to the
> > proxy server configuration on our side, no problems with Google have
> > arisen for many years. What should I pay attention to in the Squid
> > configuration? Any idea
> >
> > _______________________________________________
> > squid-users mailing list
> > squid-users at lists.squid-cache.org
> > https://lists.squid-cache.org/listinfo/squid-users
>
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> https://lists.squid-cache.org/listinfo/squid-users
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20241222/6d1d1f79/attachment.htm>

From alexmrrc at gmail.com  Sun Dec 22 06:45:02 2024
From: alexmrrc at gmail.com (A. Pechenin)
Date: Sun, 22 Dec 2024 09:45:02 +0300
Subject: [squid-users] SQUID problem with unavailability of Google
 services
In-Reply-To: <9CF36145-C25B-427A-B5AC-7652D6F1B355@gmail.com>
References: <CAAny9T6o5XcQcPuwQX+a9O2uZU8=0dtLE6ysBAnN-ayi_SL4ug@mail.gmail.com>
 <2FD41F05-38E7-41EC-AA0B-438AD4358945@gmail.com>
 <CAAny9T6FcdUnjb63U5z5CxhdykyAFGkfWD0dUDEbGoA_rGyozg@mail.gmail.com>
 <DS0PR19MB72708F2A9F428345199AFD2CA7002@DS0PR19MB7270.namprd19.prod.outlook.com>
 <CAAny9T4=9Qrgbu6Pywtie5_3HtQrxfW3uL3cbO0p0Kay4FPuAw@mail.gmail.com>
 <9CF36145-C25B-427A-B5AC-7652D6F1B355@gmail.com>
Message-ID: <CAAny9T5Pj2v7J_1Vh52ahF3ngisXt4m3qd+uqTTCmPbFi3ubOA@mail.gmail.com>

 But I don't use sslbump in the proxy server configuration. In general, I
do not understand the procedure for further actions to resolve the problem.

??, 22 ???. 2024??. ? 00:01, Jonathan Lee <jonathanlee571 at gmail.com>:

> You apply it as a custom setting in Squid. I would seek out what header
> request is failing and start from there to fix your issue.
>
> Good luck.
>
>
> On Dec 21, 2024, at 12:18, A. Pechenin <alexmrrc at gmail.com> wrote:
>
> OK, but how can ACL data be applied in practice to solve the problem I
> described?
>
> ??, 21 ???. 2024??. ? 22:57, Jonathan Lee <jonathanlee571 at gmail.com>:
>
>> You can use the following
>>
>> acl NoSSLIntercept ssl::server_name_regex -i
>> "/usr/local/pkg/reg.url.nobump"
>> acl NoBumpDNS dstdomain "/usr/local/pkg/dns.nobump"
>>
>> I created a regex based no bump file and or use a dns based no bump file
>> to mark splice only sites.
>>
>> Example of what is in reg.url.nobump file
>>
>> ^((alt[0-9]-mtalk\.)|(mtalk\.)|(mtalk-(staging|dev)\.))google\.com
>> ^((gvt)([0-9]))\.com
>> ^(((clients)[0-9])|accounts)\.google\.(com|us)
>> ^(pki|(crl|ocsp)\.pki)\.google\.com
>> (outlook\.)(office365|office)\.com
>> infinity-c[0-9][0-9]\.youboranqs[0-9][0-9]\.com
>> hulu\.com
>> nflxvideo\.net
>>
>>
>> Or example of what could be in dns.nobump
>> .play.google.com
>> .android.com
>> .google-analytics.com
>> .googleusercontent.com
>> .ggpht.com
>> .dl.google.com
>> .dl-ssl.google.com
>> .android.clients.google.com
>> .omahaproxy.appspot.com
>> .payments.google.com
>> .googleapis.com
>> .notifications.google.com
>> .ogs.google.com
>> .googleapis.com
>>
>> Make sure you follow the enterprise policy for Google Android based
>> products.
>>
>> Some sites simply can not and or should not be bumped and you only should
>> look at the get header.
>>
>> ------------------------------
>> *From:* A. Pechenin <alexmrrc at gmail.com>
>> *Sent:* Saturday, December 21, 2024 11:46
>> *To:* Jonathan Lee <jonathanlee571 at gmail.com>
>> *Cc:* squid-users at lists.squid-cache.org <
>> squid-users at lists.squid-cache.org>
>> *Subject:* Re: [squid-users] SQUID problem with unavailability of Google
>> services
>>
>> I apologize for the formatting of the text of the letter?
>>
>> I will be incorrect if I do not say that there are entries in the
>> cache.log, although the IP does not resolve directly to google subdomains,
>> but according to whois, this is the Google LLC farm.
>>
>> 2024/12/21 21:54:57 kid1| conn43356657 local=MYREALIP:53130 remote=
>> 142.250.186.142:443 HIER_DIRECT FD 121 flags=1: read/write failure: (60)
>> Operation timed out
>> current master transaction: master13542083
>> 2024/12/21 21:58:29 kid1| conn43398624 local=MYREALIP:58390 remote=
>> 142.250.185.238:443 HIER_DIRECT FD 96 flags=1: read/write failure: (60)
>> Operation timed out
>> current master transaction: master13553287
>> 2024/12/21 21:58:30 kid1| conn43398801 local=MYREALIP:58419 remote=
>> 172.217.16.206:443 HIER_DIRECT FD 898 flags=1: read/write failure: (60)
>> Operation timed out
>>
>>
>> ??, 21 ???. 2024??. ? 20:43, Jonathan Lee <jonathanlee571 at gmail.com>:
>>
>> Have you created a splice only file with lists of items that must be
>> spliced at all times, Google mail ethically should be spliced just as an
>> example. Some know sites must be spliced.
>> Sent from my iPhone
>>
>> > On Dec 21, 2024, at 09:32, A. Pechenin <alexmrrc at gmail.com> wrote:
>> >
>> > ?
>> > This week, when connecting users through a proxy server, some Google
>> services became inaccessible, such as Calendar, Translator, user profile.
>> >
>> > When clicking on the services section in the browser on the Google
>> portal, the page does not open and then a connection error is displayed.
>> When directly going to the calendar section, the connection also hangs for
>> a long time without loading the page. At the same time, the Google home
>> page, mail, search work.
>> >
>> > Transparent proxying is not used.
>> > Viewing the proxy server logs did not add any understanding, all
>> requests are processed correctly and no errors or prohibitions are
>> observed. There are no other problems with the unavailability of any sites.
>> >
>> > When connecting directly (bypassing the proxy server), all Google
>> services work completely correctly.
>> > The platform on which the problem was suddenly discovered:
>> > FreeBSD 13.2-RELEASE-p9
>> > Squid 6.6
>> >
>> > A new separate server was deployed for objectivity and finding the
>> cause, but the problem was also reproduced there, its platform.
>> > FreeBSD 13.4-RELEASE-p2
>> > Squid 6.10
>> >
>> > I tried using the default configuration file (recommended minimum
>> configuration) to eliminate the problem in my working squid.conf, but the
>> problem remained
>> >
>> > I repeat, the problem reproduced suddenly, no changes were made to the
>> proxy server configuration on our side, no problems with Google have arisen
>> for many years. What should I pay attention to in the Squid configuration?
>> Any idea
>> > _______________________________________________
>> > squid-users mailing list
>> > squid-users at lists.squid-cache.org
>> > https://lists.squid-cache.org/listinfo/squid-users
>>
>>
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20241222/d0d4765c/attachment.htm>

From alexmrrc at gmail.com  Sun Dec 22 13:13:20 2024
From: alexmrrc at gmail.com (A. Pechenin)
Date: Sun, 22 Dec 2024 16:13:20 +0300
Subject: [squid-users] SQUID problem with unavailability of Google
 services
In-Reply-To: <CAAny9T6o5XcQcPuwQX+a9O2uZU8=0dtLE6ysBAnN-ayi_SL4ug@mail.gmail.com>
References: <CAAny9T6o5XcQcPuwQX+a9O2uZU8=0dtLE6ysBAnN-ayi_SL4ug@mail.gmail.com>
Message-ID: <CAAny9T6m2a988SuwX5BQVqJJwdBuzt-8+sWhQBC8seByV+orAQ@mail.gmail.com>

The reason and solution were not simple and obvious at first glance.
I have two providers accessing the gateway, the main and backup channels,
and automatic switching is configured when the connection on the main
channel is lost.
To check, I switched the proxy server to the second channel and the problem
with partial unavailability of Google services was solved.

I returned it back, used a simple formula in the configuration file with
subsequent partial adjustment of ipfw.

# Google via ISP2
acl google dstdomain .google.com
tcp_outgoing_address REAL_IP_ISP2 google

??, 21 ???. 2024??. ? 20:26, A. Pechenin <alexmrrc at gmail.com>:

> This week, when connecting users through a proxy server, some Google
> services became inaccessible, such as Calendar, Translator, user profile.
>
> When clicking on the services section in the browser on the Google portal,
> the page does not open and then a connection error is displayed. When
> directly going to the calendar section, the connection also hangs for a
> long time without loading the page. At the same time, the Google home page,
> mail, search work.
>
> Transparent proxying is not used.
> Viewing the proxy server logs did not add any understanding, all requests
> are processed correctly and no errors or prohibitions are observed. There
> are no other problems with the unavailability of any sites.
>
> When connecting directly (bypassing the proxy server), all Google services
> work completely correctly.
> The platform on which the problem was suddenly discovered:
> FreeBSD 13.2-RELEASE-p9
> Squid 6.6
>
> A new separate server was deployed for objectivity and finding the cause,
> but the problem was also reproduced there, its platform.
> FreeBSD 13.4-RELEASE-p2
> Squid 6.10
>
> I tried using the default configuration file (recommended minimum
> configuration) to eliminate the problem in my working squid.conf, but the
> problem remained
>
> I repeat, the problem reproduced suddenly, no changes were made to the
> proxy server configuration on our side, no problems with Google have arisen
> for many years. What should I pay attention to in the Squid configuration?
> Any idea
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20241222/c57c77f7/attachment.htm>

From rousskov at measurement-factory.com  Sun Dec 22 19:40:41 2024
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Sun, 22 Dec 2024 14:40:41 -0500
Subject: [squid-users] SQUID problem with unavailability of Google
 services
In-Reply-To: <CAAny9T6m2a988SuwX5BQVqJJwdBuzt-8+sWhQBC8seByV+orAQ@mail.gmail.com>
References: <CAAny9T6o5XcQcPuwQX+a9O2uZU8=0dtLE6ysBAnN-ayi_SL4ug@mail.gmail.com>
 <CAAny9T6m2a988SuwX5BQVqJJwdBuzt-8+sWhQBC8seByV+orAQ@mail.gmail.com>
Message-ID: <4a3c3f95-5efa-4c75-892e-bf5039818218@measurement-factory.com>

On 2024-12-22 08:13, A. Pechenin wrote:
> The reason and solution were not simple and obvious at first glance.
> I have two providers accessing the gateway, the main and backup 
> channels, and automatic switching is configured when the connection on 
> the main channel is lost.
> To check, I switched the proxy server to the second channel and the 
> problem with partial unavailability of Google services was solved.
> 
> I returned it back, used a simple formula in the configuration file with 
> subsequent partial adjustment of ipfw.

Glad you found a solution! Diagnosing problems related to CONNECT 
tunnels is difficult because Squid (playing a role of a dumb TCP relay) 
is often unaware of problems experienced by clients and origin servers.


> # Google via ISP2
> acl google dstdomain .google.com
> tcp_outgoing_address REAL_IP_ISP2 google

Please note that the above configuration usually "works" but is 
unreliable and unsupported: tcp_outgoing_address directive does not 
support slow ACLs and your ACL named google is a slow ACL.

For a more reliable solution, consider annotating google-matching 
transaction at http_access check time and then using those annotations 
at tcp_outgoing_address check time. For a somewhat related example, look 
for "markSpecial" in squid.conf.documented or search this mailing list 
archives for annotate_transaction discussions.


HTH,

Alex.


> ??, 21 ???. 2024??. ? 20:26, A. Pechenin <alexmrrc at gmail.com>:
> 
>     This week, when connecting users through a proxy server, some Google
>     services became inaccessible, such as Calendar, Translator, user
>     profile.
> 
>     When clicking on the services section in the browser on the Google
>     portal, the page does not open and then a connection error is
>     displayed. When directly going to the calendar section, the
>     connection also hangs for a long time without loading the page. At
>     the same time, the Google home page, mail, search work.
> 
>     Transparent proxying is not used.
>     Viewing the proxy server logs did not add any understanding, all
>     requests are processed correctly and no errors or prohibitions are
>     observed. There are no other problems with the unavailability of any
>     sites.
> 
>     When connecting directly (bypassing the proxy server), all Google
>     services work completely correctly.
>     The platform on which the problem was suddenly discovered:
>     FreeBSD 13.2-RELEASE-p9
>     Squid 6.6
> 
>     A new separate server was deployed for objectivity and finding the
>     cause, but the problem was also reproduced there, its platform.
>     FreeBSD 13.4-RELEASE-p2
>     Squid 6.10
> 
>     I tried using the default configuration file (recommended minimum
>     configuration) to eliminate the problem in my working squid.conf,
>     but the problem remained
> 
>     I repeat, the problem reproduced suddenly, no changes were made to
>     the proxy server configuration on our side, no problems with Google
>     have arisen for many years. What should I pay attention to in the
>     Squid configuration? Any idea
> 
> 
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> https://lists.squid-cache.org/listinfo/squid-users



From jonathanlee571 at gmail.com  Sun Dec 22 19:52:37 2024
From: jonathanlee571 at gmail.com (Jonathan Lee)
Date: Sun, 22 Dec 2024 11:52:37 -0800
Subject: [squid-users] SQUID problem with unavailability of Google
 services
In-Reply-To: <4a3c3f95-5efa-4c75-892e-bf5039818218@measurement-factory.com>
References: <4a3c3f95-5efa-4c75-892e-bf5039818218@measurement-factory.com>
Message-ID: <F3BDFE6A-8C62-4591-8314-D38FAF908B8F@gmail.com>

Great Job sorry I assumed this was related to ssl bump issues.
Sent from my iPhone

> On Dec 22, 2024, at 11:47, Alex Rousskov <rousskov at measurement-factory.com> wrote:
> 
> ?On 2024-12-22 08:13, A. Pechenin wrote:
>> The reason and solution were not simple and obvious at first glance.
>> I have two providers accessing the gateway, the main and backup channels, and automatic switching is configured when the connection on the main channel is lost.
>> To check, I switched the proxy server to the second channel and the problem with partial unavailability of Google services was solved.
>> I returned it back, used a simple formula in the configuration file with subsequent partial adjustment of ipfw.
> 
> Glad you found a solution! Diagnosing problems related to CONNECT tunnels is difficult because Squid (playing a role of a dumb TCP relay) is often unaware of problems experienced by clients and origin servers.
> 
> 
>> # Google via ISP2
>> acl google dstdomain .google.com
>> tcp_outgoing_address REAL_IP_ISP2 google
> 
> Please note that the above configuration usually "works" but is unreliable and unsupported: tcp_outgoing_address directive does not support slow ACLs and your ACL named google is a slow ACL.
> 
> For a more reliable solution, consider annotating google-matching transaction at http_access check time and then using those annotations at tcp_outgoing_address check time. For a somewhat related example, look for "markSpecial" in squid.conf.documented or search this mailing list archives for annotate_transaction discussions.
> 
> 
> HTH,
> 
> Alex.
> 
> 
>> ??, 21 ???. 2024??. ? 20:26, A. Pechenin <alexmrrc at gmail.com>:
>>    This week, when connecting users through a proxy server, some Google
>>    services became inaccessible, such as Calendar, Translator, user
>>    profile.
>>    When clicking on the services section in the browser on the Google
>>    portal, the page does not open and then a connection error is
>>    displayed. When directly going to the calendar section, the
>>    connection also hangs for a long time without loading the page. At
>>    the same time, the Google home page, mail, search work.
>>    Transparent proxying is not used.
>>    Viewing the proxy server logs did not add any understanding, all
>>    requests are processed correctly and no errors or prohibitions are
>>    observed. There are no other problems with the unavailability of any
>>    sites.
>>    When connecting directly (bypassing the proxy server), all Google
>>    services work completely correctly.
>>    The platform on which the problem was suddenly discovered:
>>    FreeBSD 13.2-RELEASE-p9
>>    Squid 6.6
>>    A new separate server was deployed for objectivity and finding the
>>    cause, but the problem was also reproduced there, its platform.
>>    FreeBSD 13.4-RELEASE-p2
>>    Squid 6.10
>>    I tried using the default configuration file (recommended minimum
>>    configuration) to eliminate the problem in my working squid.conf,
>>    but the problem remained
>>    I repeat, the problem reproduced suddenly, no changes were made to
>>    the proxy server configuration on our side, no problems with Google
>>    have arisen for many years. What should I pay attention to in the
>>    Squid configuration? Any idea
>> _______________________________________________
>> squid-users mailing list
>> squid-users at lists.squid-cache.org
>> https://lists.squid-cache.org/listinfo/squid-users
> 
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> https://lists.squid-cache.org/listinfo/squid-users


From alexmrrc at gmail.com  Sun Dec 22 20:13:50 2024
From: alexmrrc at gmail.com (A. Pechenin)
Date: Sun, 22 Dec 2024 23:13:50 +0300
Subject: [squid-users] SQUID problem with unavailability of Google
 services
In-Reply-To: <4a3c3f95-5efa-4c75-892e-bf5039818218@measurement-factory.com>
References: <CAAny9T6o5XcQcPuwQX+a9O2uZU8=0dtLE6ysBAnN-ayi_SL4ug@mail.gmail.com>
 <CAAny9T6m2a988SuwX5BQVqJJwdBuzt-8+sWhQBC8seByV+orAQ@mail.gmail.com>
 <4a3c3f95-5efa-4c75-892e-bf5039818218@measurement-factory.com>
Message-ID: <CAAny9T6Kgo=weO02yBJyNbXLA2qYG3RWF3BaToovVqri+NZ6wQ@mail.gmail.com>

 Thank you for your clarification.
But could you please explain in more detail and in my case what needs to be
added to "strengthen and ensure" the operation of my solution?
The quote from the file squid.conf.documented is not very clear to me.

#         #  # First, mark transactions accepted after aclX matched
#         #  acl markSpecial annotate_transaction special=true
#         #  http_access allow acl001
#         #  ...
#         #  http_access deny acl100
#         #  http_access allow aclX markSpecial

??, 22 ???. 2024??. ? 22:47, Alex Rousskov <rousskov at measurement-factory.com
>:

> On 2024-12-22 08:13, A. Pechenin wrote:
> > The reason and solution were not simple and obvious at first glance.
> > I have two providers accessing the gateway, the main and backup
> > channels, and automatic switching is configured when the connection on
> > the main channel is lost.
> > To check, I switched the proxy server to the second channel and the
> > problem with partial unavailability of Google services was solved.
> >
> > I returned it back, used a simple formula in the configuration file with
> > subsequent partial adjustment of ipfw.
>
> Glad you found a solution! Diagnosing problems related to CONNECT
> tunnels is difficult because Squid (playing a role of a dumb TCP relay)
> is often unaware of problems experienced by clients and origin servers.
>
>
> > # Google via ISP2
> > acl google dstdomain .google.com
> > tcp_outgoing_address REAL_IP_ISP2 google
>
> Please note that the above configuration usually "works" but is
> unreliable and unsupported: tcp_outgoing_address directive does not
> support slow ACLs and your ACL named google is a slow ACL.
>
> For a more reliable solution, consider annotating google-matching
> transaction at http_access check time and then using those annotations
> at tcp_outgoing_address check time. For a somewhat related example, look
> for "markSpecial" in squid.conf.documented or search this mailing list
> archives for annotate_transaction discussions.
>
>
> HTH,
>
> Alex.
>
>
> > ??, 21 ???. 2024??. ? 20:26, A. Pechenin <alexmrrc at gmail.com>:
> >
> >     This week, when connecting users through a proxy server, some Google
> >     services became inaccessible, such as Calendar, Translator, user
> >     profile.
> >
> >     When clicking on the services section in the browser on the Google
> >     portal, the page does not open and then a connection error is
> >     displayed. When directly going to the calendar section, the
> >     connection also hangs for a long time without loading the page. At
> >     the same time, the Google home page, mail, search work.
> >
> >     Transparent proxying is not used.
> >     Viewing the proxy server logs did not add any understanding, all
> >     requests are processed correctly and no errors or prohibitions are
> >     observed. There are no other problems with the unavailability of any
> >     sites.
> >
> >     When connecting directly (bypassing the proxy server), all Google
> >     services work completely correctly.
> >     The platform on which the problem was suddenly discovered:
> >     FreeBSD 13.2-RELEASE-p9
> >     Squid 6.6
> >
> >     A new separate server was deployed for objectivity and finding the
> >     cause, but the problem was also reproduced there, its platform.
> >     FreeBSD 13.4-RELEASE-p2
> >     Squid 6.10
> >
> >     I tried using the default configuration file (recommended minimum
> >     configuration) to eliminate the problem in my working squid.conf,
> >     but the problem remained
> >
> >     I repeat, the problem reproduced suddenly, no changes were made to
> >     the proxy server configuration on our side, no problems with Google
> >     have arisen for many years. What should I pay attention to in the
> >     Squid configuration? Any idea
> >
> >
> > _______________________________________________
> > squid-users mailing list
> > squid-users at lists.squid-cache.org
> > https://lists.squid-cache.org/listinfo/squid-users
>
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> https://lists.squid-cache.org/listinfo/squid-users
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20241222/097bebb2/attachment.htm>

From rousskov at measurement-factory.com  Sun Dec 22 21:32:43 2024
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Sun, 22 Dec 2024 16:32:43 -0500
Subject: [squid-users] SQUID problem with unavailability of Google
 services
In-Reply-To: <CAAny9T6Kgo=weO02yBJyNbXLA2qYG3RWF3BaToovVqri+NZ6wQ@mail.gmail.com>
References: <CAAny9T6o5XcQcPuwQX+a9O2uZU8=0dtLE6ysBAnN-ayi_SL4ug@mail.gmail.com>
 <CAAny9T6m2a988SuwX5BQVqJJwdBuzt-8+sWhQBC8seByV+orAQ@mail.gmail.com>
 <4a3c3f95-5efa-4c75-892e-bf5039818218@measurement-factory.com>
 <CAAny9T6Kgo=weO02yBJyNbXLA2qYG3RWF3BaToovVqri+NZ6wQ@mail.gmail.com>
Message-ID: <f0f4eae9-43a3-4de4-82cc-9fd14013b536@measurement-factory.com>

On 2024-12-22 15:13, A. Pechenin wrote:
> could you please explain in more detail and in my case what needs to 
> be added to "strengthen and ensure" the operation of my solution?

Does Q2 and Q3 at [1] help? If not, I hope that others can guide you 
through using a never-matching http_access rule and annotate_transaction 
ACL side effects to improve reliability of your current configuration.

[1] 
https://lists.squid-cache.org/pipermail/squid-dev/2021-January/009643.html


BTW, more about transaction annotations is available at
https://lists.squid-cache.org/pipermail/squid-users/2023-April/025784.html


HTH,

Alex.



> ??, 22 ???. 2024??. ? 22:47, Alex Rousskov 
> <rousskov at measurement-factory.com 
> <mailto:rousskov at measurement-factory.com>>:
> 
>     On 2024-12-22 08:13, A. Pechenin wrote:
>      > The reason and solution were not simple and obvious at first glance.
>      > I have two providers accessing the gateway, the main and backup
>      > channels, and automatic switching is configured when the
>     connection on
>      > the main channel is lost.
>      > To check, I switched the proxy server to the second channel and the
>      > problem with partial unavailability of Google services was solved.
>      >
>      > I returned it back, used a simple formula in the configuration
>     file with
>      > subsequent partial adjustment of ipfw.
> 
>     Glad you found a solution! Diagnosing problems related to CONNECT
>     tunnels is difficult because Squid (playing a role of a dumb TCP relay)
>     is often unaware of problems experienced by clients and origin servers.
> 
> 
>      > # Google via ISP2
>      > acl google dstdomain .google.com <http://google.com>
>      > tcp_outgoing_address REAL_IP_ISP2 google
> 
>     Please note that the above configuration usually "works" but is
>     unreliable and unsupported: tcp_outgoing_address directive does not
>     support slow ACLs and your ACL named google is a slow ACL.
> 
>     For a more reliable solution, consider annotating google-matching
>     transaction at http_access check time and then using those annotations
>     at tcp_outgoing_address check time. For a somewhat related example,
>     look
>     for "markSpecial" in squid.conf.documented or search this mailing list
>     archives for annotate_transaction discussions.
> 
> 
>     HTH,
> 
>     Alex.
> 
> 
>      > ??, 21 ???. 2024??. ? 20:26, A. Pechenin <alexmrrc at gmail.com
>     <mailto:alexmrrc at gmail.com>>:
>      >
>      >? ? ?This week, when connecting users through a proxy server, some
>     Google
>      >? ? ?services became inaccessible, such as Calendar, Translator, user
>      >? ? ?profile.
>      >
>      >? ? ?When clicking on the services section in the browser on the
>     Google
>      >? ? ?portal, the page does not open and then a connection error is
>      >? ? ?displayed. When directly going to the calendar section, the
>      >? ? ?connection also hangs for a long time without loading the
>     page. At
>      >? ? ?the same time, the Google home page, mail, search work.
>      >
>      >? ? ?Transparent proxying is not used.
>      >? ? ?Viewing the proxy server logs did not add any understanding, all
>      >? ? ?requests are processed correctly and no errors or
>     prohibitions are
>      >? ? ?observed. There are no other problems with the unavailability
>     of any
>      >? ? ?sites.
>      >
>      >? ? ?When connecting directly (bypassing the proxy server), all Google
>      >? ? ?services work completely correctly.
>      >? ? ?The platform on which the problem was suddenly discovered:
>      >? ? ?FreeBSD 13.2-RELEASE-p9
>      >? ? ?Squid 6.6
>      >
>      >? ? ?A new separate server was deployed for objectivity and
>     finding the
>      >? ? ?cause, but the problem was also reproduced there, its platform.
>      >? ? ?FreeBSD 13.4-RELEASE-p2
>      >? ? ?Squid 6.10
>      >
>      >? ? ?I tried using the default configuration file (recommended minimum
>      >? ? ?configuration) to eliminate the problem in my working squid.conf,
>      >? ? ?but the problem remained
>      >
>      >? ? ?I repeat, the problem reproduced suddenly, no changes were
>     made to
>      >? ? ?the proxy server configuration on our side, no problems with
>     Google
>      >? ? ?have arisen for many years. What should I pay attention to in the
>      >? ? ?Squid configuration? Any idea
>      >
>      >
>      > _______________________________________________
>      > squid-users mailing list
>      > squid-users at lists.squid-cache.org
>     <mailto:squid-users at lists.squid-cache.org>
>      > https://lists.squid-cache.org/listinfo/squid-users
>     <https://lists.squid-cache.org/listinfo/squid-users>
> 
>     _______________________________________________
>     squid-users mailing list
>     squid-users at lists.squid-cache.org
>     <mailto:squid-users at lists.squid-cache.org>
>     https://lists.squid-cache.org/listinfo/squid-users
>     <https://lists.squid-cache.org/listinfo/squid-users>
> 



From edreamer322 at gmail.com  Mon Dec 23 05:27:25 2024
From: edreamer322 at gmail.com (Eternal Dreamer)
Date: Mon, 23 Dec 2024 08:27:25 +0300
Subject: [squid-users] Squid-internal-mgr/forward help
Message-ID: <CAFw4dKqGUbp2+jf8KS_hg-0ybz1U7c5SabXkDeyr6+VC1bubeg@mail.gmail.com>

Greetings!
I need some help with my squid-6.7 installation. I need to see forwarding
status codes for my monitoring system, but squidclient -h 3128 mgr:forward
is empty. Another stats from mgr:* works fine. In squid-3.5 same
configuration works wine and shows FULL information by mgr:*. How can I fix
it?
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20241223/fc5461ce/attachment.htm>

From alexmrrc at gmail.com  Mon Dec 23 11:33:16 2024
From: alexmrrc at gmail.com (A. Pechenin)
Date: Mon, 23 Dec 2024 14:33:16 +0300
Subject: [squid-users] SQUID problem with unavailability of Google
 services
In-Reply-To: <f0f4eae9-43a3-4de4-82cc-9fd14013b536@measurement-factory.com>
References: <CAAny9T6o5XcQcPuwQX+a9O2uZU8=0dtLE6ysBAnN-ayi_SL4ug@mail.gmail.com>
 <CAAny9T6m2a988SuwX5BQVqJJwdBuzt-8+sWhQBC8seByV+orAQ@mail.gmail.com>
 <4a3c3f95-5efa-4c75-892e-bf5039818218@measurement-factory.com>
 <CAAny9T6Kgo=weO02yBJyNbXLA2qYG3RWF3BaToovVqri+NZ6wQ@mail.gmail.com>
 <f0f4eae9-43a3-4de4-82cc-9fd14013b536@measurement-factory.com>
Message-ID: <CAAny9T4encRADqGX5Oj6w2NmCWBz_A6NwzHMGUvngcnvdg7HVQ@mail.gmail.com>

 Unfortunately, there is no greater clarity in the practical application of
the techniques used in the topics you have provided.
I would be grateful for practice specifically in my case for a better
understanding of the work.

??, 23 ???. 2024??. ? 00:42, Alex Rousskov <rousskov at measurement-factory.com
>:

> On 2024-12-22 15:13, A. Pechenin wrote:
> > could you please explain in more detail and in my case what needs to
> > be added to "strengthen and ensure" the operation of my solution?
>
> Does Q2 and Q3 at [1] help? If not, I hope that others can guide you
> through using a never-matching http_access rule and annotate_transaction
> ACL side effects to improve reliability of your current configuration.
>
> [1]
> https://lists.squid-cache.org/pipermail/squid-dev/2021-January/009643.html
>
>
> BTW, more about transaction annotations is available at
> https://lists.squid-cache.org/pipermail/squid-users/2023-April/025784.html
>
>
> HTH,
>
> Alex.
>
>
>
> > ??, 22 ???. 2024??. ? 22:47, Alex Rousskov
> > <rousskov at measurement-factory.com
> > <mailto:rousskov at measurement-factory.com>>:
> >
> >     On 2024-12-22 08:13, A. Pechenin wrote:
> >      > The reason and solution were not simple and obvious at first
> glance.
> >      > I have two providers accessing the gateway, the main and backup
> >      > channels, and automatic switching is configured when the
> >     connection on
> >      > the main channel is lost.
> >      > To check, I switched the proxy server to the second channel and
> the
> >      > problem with partial unavailability of Google services was solved.
> >      >
> >      > I returned it back, used a simple formula in the configuration
> >     file with
> >      > subsequent partial adjustment of ipfw.
> >
> >     Glad you found a solution! Diagnosing problems related to CONNECT
> >     tunnels is difficult because Squid (playing a role of a dumb TCP
> relay)
> >     is often unaware of problems experienced by clients and origin
> servers.
> >
> >
> >      > # Google via ISP2
> >      > acl google dstdomain .google.com <http://google.com>
> >      > tcp_outgoing_address REAL_IP_ISP2 google
> >
> >     Please note that the above configuration usually "works" but is
> >     unreliable and unsupported: tcp_outgoing_address directive does not
> >     support slow ACLs and your ACL named google is a slow ACL.
> >
> >     For a more reliable solution, consider annotating google-matching
> >     transaction at http_access check time and then using those
> annotations
> >     at tcp_outgoing_address check time. For a somewhat related example,
> >     look
> >     for "markSpecial" in squid.conf.documented or search this mailing
> list
> >     archives for annotate_transaction discussions.
> >
> >
> >     HTH,
> >
> >     Alex.
> >
> >
> >      > ??, 21 ???. 2024??. ? 20:26, A. Pechenin <alexmrrc at gmail.com
> >     <mailto:alexmrrc at gmail.com>>:
> >      >
> >      >     This week, when connecting users through a proxy server, some
> >     Google
> >      >     services became inaccessible, such as Calendar, Translator,
> user
> >      >     profile.
> >      >
> >      >     When clicking on the services section in the browser on the
> >     Google
> >      >     portal, the page does not open and then a connection error is
> >      >     displayed. When directly going to the calendar section, the
> >      >     connection also hangs for a long time without loading the
> >     page. At
> >      >     the same time, the Google home page, mail, search work.
> >      >
> >      >     Transparent proxying is not used.
> >      >     Viewing the proxy server logs did not add any understanding,
> all
> >      >     requests are processed correctly and no errors or
> >     prohibitions are
> >      >     observed. There are no other problems with the unavailability
> >     of any
> >      >     sites.
> >      >
> >      >     When connecting directly (bypassing the proxy server), all
> Google
> >      >     services work completely correctly.
> >      >     The platform on which the problem was suddenly discovered:
> >      >     FreeBSD 13.2-RELEASE-p9
> >      >     Squid 6.6
> >      >
> >      >     A new separate server was deployed for objectivity and
> >     finding the
> >      >     cause, but the problem was also reproduced there, its
> platform.
> >      >     FreeBSD 13.4-RELEASE-p2
> >      >     Squid 6.10
> >      >
> >      >     I tried using the default configuration file (recommended
> minimum
> >      >     configuration) to eliminate the problem in my working
> squid.conf,
> >      >     but the problem remained
> >      >
> >      >     I repeat, the problem reproduced suddenly, no changes were
> >     made to
> >      >     the proxy server configuration on our side, no problems with
> >     Google
> >      >     have arisen for many years. What should I pay attention to in
> the
> >      >     Squid configuration? Any idea
> >      >
> >      >
> >      > _______________________________________________
> >      > squid-users mailing list
> >      > squid-users at lists.squid-cache.org
> >     <mailto:squid-users at lists.squid-cache.org>
> >      > https://lists.squid-cache.org/listinfo/squid-users
> >     <https://lists.squid-cache.org/listinfo/squid-users>
> >
> >     _______________________________________________
> >     squid-users mailing list
> >     squid-users at lists.squid-cache.org
> >     <mailto:squid-users at lists.squid-cache.org>
> >     https://lists.squid-cache.org/listinfo/squid-users
> >     <https://lists.squid-cache.org/listinfo/squid-users>
> >
>
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> https://lists.squid-cache.org/listinfo/squid-users
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20241223/fa13ed8a/attachment.htm>

From rousskov at measurement-factory.com  Mon Dec 23 14:57:29 2024
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Mon, 23 Dec 2024 09:57:29 -0500
Subject: [squid-users] Squid-internal-mgr/forward help
In-Reply-To: <CAFw4dKqGUbp2+jf8KS_hg-0ybz1U7c5SabXkDeyr6+VC1bubeg@mail.gmail.com>
References: <CAFw4dKqGUbp2+jf8KS_hg-0ybz1U7c5SabXkDeyr6+VC1bubeg@mail.gmail.com>
Message-ID: <29c2134a-df68-414d-a570-6251aa2f24a5@measurement-factory.com>

On 2024-12-23 00:27, Eternal Dreamer wrote:

> I need some help with my squid-6.7 installation. I need to see 
> forwarding status codes for my monitoring system, but squidclient -h 
> 3128 mgr:forward is empty. Another stats from mgr:* works fine.

You are suffering from a Squid bug: In many cases, Squid incorrectly 
concludes that there are no mgr:forward stats available. Long time ago, 
the same code happened to work, but we accidentally violated its hidden 
invariant while fixing other problems related to counting forwarding 
attempts (e.g., Bug #4788).

There are also bugs related to how the number of forwarding attempts are 
currently shown in "tryN" columns of mgr:forward output: At least one 
"tryN" column _heading_ is missing, and "try#1" column corresponds to 
the rare case where no forwarding attempts had been made (rather than 
the implied common case where one forwarding attempt has happened).

Finally, due to poor code duplication, some forwarding attempts related 
to tunneling traffic (e.g., when handling CONNECT requests) may not be 
reflected in mgr:forward stats.


> How can I fix it?

Properly fixing mgr:forward report requires non-trivial development. 
Until somebody facilitates that[1], you can try an unofficial workaround 
patch[2] that alleviates _some_ of mgr:forward pains. The patch is 
against current master/v7, but it applies cleanly to Squid v6.7 AFAICT.


[1]: 
https://wiki.squid-cache.org/SquidFaq/AboutSquid#how-to-add-a-new-squid-feature-enhance-of-fix-something

[2]: 
https://github.com/measurement-factory/squid/commit/ec91885e04aeab5597c8792a14854ef653cb5cbf.patch


HTH,

Alex.


From ankor2023 at gmail.com  Tue Dec 24 02:59:13 2024
From: ankor2023 at gmail.com (Andrey K)
Date: Tue, 24 Dec 2024 05:59:13 +0300
Subject: [squid-users] SQUID problem with unavailability of Google
 services
In-Reply-To: <CAAny9T4encRADqGX5Oj6w2NmCWBz_A6NwzHMGUvngcnvdg7HVQ@mail.gmail.com>
References: <CAAny9T6o5XcQcPuwQX+a9O2uZU8=0dtLE6ysBAnN-ayi_SL4ug@mail.gmail.com>
 <CAAny9T6m2a988SuwX5BQVqJJwdBuzt-8+sWhQBC8seByV+orAQ@mail.gmail.com>
 <4a3c3f95-5efa-4c75-892e-bf5039818218@measurement-factory.com>
 <CAAny9T6Kgo=weO02yBJyNbXLA2qYG3RWF3BaToovVqri+NZ6wQ@mail.gmail.com>
 <f0f4eae9-43a3-4de4-82cc-9fd14013b536@measurement-factory.com>
 <CAAny9T4encRADqGX5Oj6w2NmCWBz_A6NwzHMGUvngcnvdg7HVQ@mail.gmail.com>
Message-ID: <CADJd0Y388_JvvqgaOp9-M0uvGri4MZMPcvVLrqzUh4gBW5wYUw@mail.gmail.com>

Hello,

I am sorry to interrupt the conversation, but in my opinion, the ACL used in
the policy is fast, as stated in the documentation (
https://www.squid-cache.org/Doc/config/acl/):

acl aclname dstdomain [-n] .foo.com ...
	  # Destination server from URL [fast]

So the configuration is reliable.
Alex, maybe there are other factors that I'm not considering?

Kind regards,
Ankor.

>> # Google via ISP2
>> acl google dstdomain .google.com
>> tcp_outgoing_address REAL_IP_ISP2 google

> Please note that the above configuration usually "works" but is
> unreliable and unsupported: tcp_outgoing_address directive does not
> support slow ACLs and your ACL named google is a slow ACL.







??, 23 ???. 2024??. ? 14:33, A. Pechenin <alexmrrc at gmail.com>:

> Unfortunately, there is no greater clarity in the practical application of
> the techniques used in the topics you have provided.
> I would be grateful for practice specifically in my case for a better
> understanding of the work.
>
> ??, 23 ???. 2024??. ? 00:42, Alex Rousskov <
> rousskov at measurement-factory.com>:
>
>> On 2024-12-22 15:13, A. Pechenin wrote:
>> > could you please explain in more detail and in my case what needs to
>> > be added to "strengthen and ensure" the operation of my solution?
>>
>> Does Q2 and Q3 at [1] help? If not, I hope that others can guide you
>> through using a never-matching http_access rule and annotate_transaction
>> ACL side effects to improve reliability of your current configuration.
>>
>> [1]
>> https://lists.squid-cache.org/pipermail/squid-dev/2021-January/009643.html
>>
>>
>> BTW, more about transaction annotations is available at
>> https://lists.squid-cache.org/pipermail/squid-users/2023-April/025784.html
>>
>>
>> HTH,
>>
>> Alex.
>>
>>
>>
>> > ??, 22 ???. 2024??. ? 22:47, Alex Rousskov
>> > <rousskov at measurement-factory.com
>> > <mailto:rousskov at measurement-factory.com>>:
>> >
>> >     On 2024-12-22 08:13, A. Pechenin wrote:
>> >      > The reason and solution were not simple and obvious at first
>> glance.
>> >      > I have two providers accessing the gateway, the main and backup
>> >      > channels, and automatic switching is configured when the
>> >     connection on
>> >      > the main channel is lost.
>> >      > To check, I switched the proxy server to the second channel and
>> the
>> >      > problem with partial unavailability of Google services was
>> solved.
>> >      >
>> >      > I returned it back, used a simple formula in the configuration
>> >     file with
>> >      > subsequent partial adjustment of ipfw.
>> >
>> >     Glad you found a solution! Diagnosing problems related to CONNECT
>> >     tunnels is difficult because Squid (playing a role of a dumb TCP
>> relay)
>> >     is often unaware of problems experienced by clients and origin
>> servers.
>> >
>> >
>> >      > # Google via ISP2
>> >      > acl google dstdomain .google.com <http://google.com>
>> >      > tcp_outgoing_address REAL_IP_ISP2 google
>> >
>> >     Please note that the above configuration usually "works" but is
>> >     unreliable and unsupported: tcp_outgoing_address directive does not
>> >     support slow ACLs and your ACL named google is a slow ACL.
>> >
>> >     For a more reliable solution, consider annotating google-matching
>> >     transaction at http_access check time and then using those
>> annotations
>> >     at tcp_outgoing_address check time. For a somewhat related example,
>> >     look
>> >     for "markSpecial" in squid.conf.documented or search this mailing
>> list
>> >     archives for annotate_transaction discussions.
>> >
>> >
>> >     HTH,
>> >
>> >     Alex.
>> >
>> >
>> >      > ??, 21 ???. 2024??. ? 20:26, A. Pechenin <alexmrrc at gmail.com
>> >     <mailto:alexmrrc at gmail.com>>:
>> >      >
>> >      >     This week, when connecting users through a proxy server, some
>> >     Google
>> >      >     services became inaccessible, such as Calendar, Translator,
>> user
>> >      >     profile.
>> >      >
>> >      >     When clicking on the services section in the browser on the
>> >     Google
>> >      >     portal, the page does not open and then a connection error is
>> >      >     displayed. When directly going to the calendar section, the
>> >      >     connection also hangs for a long time without loading the
>> >     page. At
>> >      >     the same time, the Google home page, mail, search work.
>> >      >
>> >      >     Transparent proxying is not used.
>> >      >     Viewing the proxy server logs did not add any understanding,
>> all
>> >      >     requests are processed correctly and no errors or
>> >     prohibitions are
>> >      >     observed. There are no other problems with the unavailability
>> >     of any
>> >      >     sites.
>> >      >
>> >      >     When connecting directly (bypassing the proxy server), all
>> Google
>> >      >     services work completely correctly.
>> >      >     The platform on which the problem was suddenly discovered:
>> >      >     FreeBSD 13.2-RELEASE-p9
>> >      >     Squid 6.6
>> >      >
>> >      >     A new separate server was deployed for objectivity and
>> >     finding the
>> >      >     cause, but the problem was also reproduced there, its
>> platform.
>> >      >     FreeBSD 13.4-RELEASE-p2
>> >      >     Squid 6.10
>> >      >
>> >      >     I tried using the default configuration file (recommended
>> minimum
>> >      >     configuration) to eliminate the problem in my working
>> squid.conf,
>> >      >     but the problem remained
>> >      >
>> >      >     I repeat, the problem reproduced suddenly, no changes were
>> >     made to
>> >      >     the proxy server configuration on our side, no problems with
>> >     Google
>> >      >     have arisen for many years. What should I pay attention to
>> in the
>> >      >     Squid configuration? Any idea
>> >      >
>> >      >
>> >      > _______________________________________________
>> >      > squid-users mailing list
>> >      > squid-users at lists.squid-cache.org
>> >     <mailto:squid-users at lists.squid-cache.org>
>> >      > https://lists.squid-cache.org/listinfo/squid-users
>> >     <https://lists.squid-cache.org/listinfo/squid-users>
>> >
>> >     _______________________________________________
>> >     squid-users mailing list
>> >     squid-users at lists.squid-cache.org
>> >     <mailto:squid-users at lists.squid-cache.org>
>> >     https://lists.squid-cache.org/listinfo/squid-users
>> >     <https://lists.squid-cache.org/listinfo/squid-users>
>> >
>>
>> _______________________________________________
>> squid-users mailing list
>> squid-users at lists.squid-cache.org
>> https://lists.squid-cache.org/listinfo/squid-users
>>
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> https://lists.squid-cache.org/listinfo/squid-users
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20241224/a5a0fe54/attachment.htm>

From rousskov at measurement-factory.com  Tue Dec 24 14:56:25 2024
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Tue, 24 Dec 2024 09:56:25 -0500
Subject: [squid-users] SQUID problem with unavailability of Google
 services
In-Reply-To: <CADJd0Y388_JvvqgaOp9-M0uvGri4MZMPcvVLrqzUh4gBW5wYUw@mail.gmail.com>
References: <CAAny9T6o5XcQcPuwQX+a9O2uZU8=0dtLE6ysBAnN-ayi_SL4ug@mail.gmail.com>
 <CAAny9T6m2a988SuwX5BQVqJJwdBuzt-8+sWhQBC8seByV+orAQ@mail.gmail.com>
 <4a3c3f95-5efa-4c75-892e-bf5039818218@measurement-factory.com>
 <CAAny9T6Kgo=weO02yBJyNbXLA2qYG3RWF3BaToovVqri+NZ6wQ@mail.gmail.com>
 <f0f4eae9-43a3-4de4-82cc-9fd14013b536@measurement-factory.com>
 <CAAny9T4encRADqGX5Oj6w2NmCWBz_A6NwzHMGUvngcnvdg7HVQ@mail.gmail.com>
 <CADJd0Y388_JvvqgaOp9-M0uvGri4MZMPcvVLrqzUh4gBW5wYUw@mail.gmail.com>
Message-ID: <e8701f88-1361-4419-b34b-e1ff9b9f4e5a@measurement-factory.com>

On 2024-12-23 21:59, Andrey K wrote:

> in my opinion, the 
> ACL used in the policy is fast, as stated in the documentation 
> (https://www.squid-cache.org/Doc/config/acl/):
> 
> acl aclname dstdomain [-n] .foo.com ...
> 	  # Destination server from URL [fast]

That documentation is misleading: In some cases, intended dstdomain 
evaluation is slow. In other cases, it is fast. Thus, in general, 
dstdomain should be treated as a slow ACL. Technically, one can define 
the term "slow ACL" in such a way that dstdomain would be considered 
"fast"[0], but I do not recommend using such definitions because (when 
used by human admins) they are likely to lead to unreliable configurations.

N.B. "dstdomain -n" is a fast ACL, but "dstdomain -n x" does not match 
in certain cases where "dstdomain x" would match.

SquidAcl FAQ entry[1] similarly misleads when listing dstdomain on the 
"Fast ACLs include" list, but the following (abridged) text on that same 
FAQ page is correct with respect to asynchronous (a.k.a. "slow") DNS 
lookups that dstdomain performs (or is intended to perform):

 > acl Cooking2 dstdomain example.test
 >
> Note that when IP addresses are used 
> (instead of domain names), Squid may have to do a DNS lookup to
> determine whether the ACL matches: If a domain name for the IP
> address is already in the Squid?s ?FQDN cache?, then Squid can
> immediately compare the destination domain against the access
> controls. Otherwise, Squid does an asynchronous reverse DNS lookup
> and evaluates the ACL after that lookup is over.
 >
> Asynchronous lookups are done for http_access and other directives
> that support so called ?slow? ACLs. If a directive does not support a
> required asynchronous DNS lookup, then modern Squids use ?none?
> instead of the actual domain name to determine whether a dstdomain
> ACL matches, but you should not rely on that behavior. To disable DNS
> lookups, use the ?-n? ACL option (where supported).


[0]: Depending on the "fast ACL" definition, the "none" comparison 
documented a few lines above can be used as an excuse to categorize 
dstdomain as a fast ACL, but "you should not rely on that behavior" 
advice is correct, and configurations that are not using that trick 
consistently/correctly (while using dstdomain with directives that do 
not support slow ACLs) are likely unreliable.

[1]: https://wiki.squid-cache.org/SquidFaq/SquidAcl


HTH,

Alex.



>>> # Google via ISP2
>>> acl google dstdomain .google.com <http://google.com/>
>>> tcp_outgoing_address REAL_IP_ISP2 google
> 
>  > Please note that the above configuration usually "works" but is
>  > unreliable and unsupported: tcp_outgoing_address directive does not
>  > support slow ACLs and your ACL named google is a slow ACL.
> 
> 
> 
> 
> 
> 
> 
> ??, 23 ???. 2024??. ? 14:33, A. Pechenin <alexmrrc at gmail.com 
> <mailto:alexmrrc at gmail.com>>:
> 
>     Unfortunately, there is no greater clarity in the practical
>     application of the techniques used in the topics you have provided.
>     I would be grateful for practice specifically in my case for a
>     better understanding of the work.
> 
>     ??, 23 ???. 2024??. ? 00:42, Alex Rousskov
>     <rousskov at measurement-factory.com
>     <mailto:rousskov at measurement-factory.com>>:
> 
>         On 2024-12-22 15:13, A. Pechenin wrote:
>          > could you please explain in more detail and in my case what
>         needs to
>          > be added to "strengthen and ensure" the operation of my solution?
> 
>         Does Q2 and Q3 at [1] help? If not, I hope that others can guide
>         you
>         through using a never-matching http_access rule and
>         annotate_transaction
>         ACL side effects to improve reliability of your current
>         configuration.
> 
>         [1]
>         https://lists.squid-cache.org/pipermail/squid-dev/2021-January/009643.html <https://lists.squid-cache.org/pipermail/squid-dev/2021-January/009643.html>
> 
> 
>         BTW, more about transaction annotations is available at
>         https://lists.squid-cache.org/pipermail/squid-users/2023-April/025784.html <https://lists.squid-cache.org/pipermail/squid-users/2023-April/025784.html>
> 
> 
>         HTH,
> 
>         Alex.
> 
> 
> 
>          > ??, 22 ???. 2024??. ? 22:47, Alex Rousskov
>          > <rousskov at measurement-factory.com
>         <mailto:rousskov at measurement-factory.com>
>          > <mailto:rousskov at measurement-factory.com
>         <mailto:rousskov at measurement-factory.com>>>:
>          >
>          >? ? ?On 2024-12-22 08:13, A. Pechenin wrote:
>          >? ? ? > The reason and solution were not simple and obvious at
>         first glance.
>          >? ? ? > I have two providers accessing the gateway, the main
>         and backup
>          >? ? ? > channels, and automatic switching is configured when the
>          >? ? ?connection on
>          >? ? ? > the main channel is lost.
>          >? ? ? > To check, I switched the proxy server to the second
>         channel and the
>          >? ? ? > problem with partial unavailability of Google services
>         was solved.
>          >? ? ? >
>          >? ? ? > I returned it back, used a simple formula in the
>         configuration
>          >? ? ?file with
>          >? ? ? > subsequent partial adjustment of ipfw.
>          >
>          >? ? ?Glad you found a solution! Diagnosing problems related to
>         CONNECT
>          >? ? ?tunnels is difficult because Squid (playing a role of a
>         dumb TCP relay)
>          >? ? ?is often unaware of problems experienced by clients and
>         origin servers.
>          >
>          >
>          >? ? ? > # Google via ISP2
>          >? ? ? > acl google dstdomain .google.com <http://google.com>
>         <http://google.com <http://google.com>>
>          >? ? ? > tcp_outgoing_address REAL_IP_ISP2 google
>          >
>          >? ? ?Please note that the above configuration usually "works"
>         but is
>          >? ? ?unreliable and unsupported: tcp_outgoing_address
>         directive does not
>          >? ? ?support slow ACLs and your ACL named google is a slow ACL.
>          >
>          >? ? ?For a more reliable solution, consider annotating
>         google-matching
>          >? ? ?transaction at http_access check time and then using
>         those annotations
>          >? ? ?at tcp_outgoing_address check time. For a somewhat
>         related example,
>          >? ? ?look
>          >? ? ?for "markSpecial" in squid.conf.documented or search this
>         mailing list
>          >? ? ?archives for annotate_transaction discussions.
>          >
>          >
>          >? ? ?HTH,
>          >
>          >? ? ?Alex.
>          >
>          >
>          >? ? ? > ??, 21 ???. 2024??. ? 20:26, A. Pechenin
>         <alexmrrc at gmail.com <mailto:alexmrrc at gmail.com>
>          >? ? ?<mailto:alexmrrc at gmail.com <mailto:alexmrrc at gmail.com>>>:
>          >? ? ? >
>          >? ? ? >? ? ?This week, when connecting users through a proxy
>         server, some
>          >? ? ?Google
>          >? ? ? >? ? ?services became inaccessible, such as Calendar,
>         Translator, user
>          >? ? ? >? ? ?profile.
>          >? ? ? >
>          >? ? ? >? ? ?When clicking on the services section in the
>         browser on the
>          >? ? ?Google
>          >? ? ? >? ? ?portal, the page does not open and then a
>         connection error is
>          >? ? ? >? ? ?displayed. When directly going to the calendar
>         section, the
>          >? ? ? >? ? ?connection also hangs for a long time without
>         loading the
>          >? ? ?page. At
>          >? ? ? >? ? ?the same time, the Google home page, mail, search
>         work.
>          >? ? ? >
>          >? ? ? >? ? ?Transparent proxying is not used.
>          >? ? ? >? ? ?Viewing the proxy server logs did not add any
>         understanding, all
>          >? ? ? >? ? ?requests are processed correctly and no errors or
>          >? ? ?prohibitions are
>          >? ? ? >? ? ?observed. There are no other problems with the
>         unavailability
>          >? ? ?of any
>          >? ? ? >? ? ?sites.
>          >? ? ? >
>          >? ? ? >? ? ?When connecting directly (bypassing the proxy
>         server), all Google
>          >? ? ? >? ? ?services work completely correctly.
>          >? ? ? >? ? ?The platform on which the problem was suddenly
>         discovered:
>          >? ? ? >? ? ?FreeBSD 13.2-RELEASE-p9
>          >? ? ? >? ? ?Squid 6.6
>          >? ? ? >
>          >? ? ? >? ? ?A new separate server was deployed for objectivity and
>          >? ? ?finding the
>          >? ? ? >? ? ?cause, but the problem was also reproduced there,
>         its platform.
>          >? ? ? >? ? ?FreeBSD 13.4-RELEASE-p2
>          >? ? ? >? ? ?Squid 6.10
>          >? ? ? >
>          >? ? ? >? ? ?I tried using the default configuration file
>         (recommended minimum
>          >? ? ? >? ? ?configuration) to eliminate the problem in my
>         working squid.conf,
>          >? ? ? >? ? ?but the problem remained
>          >? ? ? >
>          >? ? ? >? ? ?I repeat, the problem reproduced suddenly, no
>         changes were
>          >? ? ?made to
>          >? ? ? >? ? ?the proxy server configuration on our side, no
>         problems with
>          >? ? ?Google
>          >? ? ? >? ? ?have arisen for many years. What should I pay
>         attention to in the
>          >? ? ? >? ? ?Squid configuration? Any idea
>          >? ? ? >
>          >? ? ? >
>          >? ? ? > _______________________________________________
>          >? ? ? > squid-users mailing list
>          >? ? ? > squid-users at lists.squid-cache.org
>         <mailto:squid-users at lists.squid-cache.org>
>          >? ? ?<mailto:squid-users at lists.squid-cache.org
>         <mailto:squid-users at lists.squid-cache.org>>
>          >? ? ? > https://lists.squid-cache.org/listinfo/squid-users
>         <https://lists.squid-cache.org/listinfo/squid-users>
>          >? ? ?<https://lists.squid-cache.org/listinfo/squid-users
>         <https://lists.squid-cache.org/listinfo/squid-users>>
>          >
>          >? ? ?_______________________________________________
>          >? ? ?squid-users mailing list
>          > squid-users at lists.squid-cache.org
>         <mailto:squid-users at lists.squid-cache.org>
>          >? ? ?<mailto:squid-users at lists.squid-cache.org
>         <mailto:squid-users at lists.squid-cache.org>>
>          > https://lists.squid-cache.org/listinfo/squid-users
>         <https://lists.squid-cache.org/listinfo/squid-users>
>          >? ? ?<https://lists.squid-cache.org/listinfo/squid-users
>         <https://lists.squid-cache.org/listinfo/squid-users>>
>          >
> 
>         _______________________________________________
>         squid-users mailing list
>         squid-users at lists.squid-cache.org
>         <mailto:squid-users at lists.squid-cache.org>
>         https://lists.squid-cache.org/listinfo/squid-users
>         <https://lists.squid-cache.org/listinfo/squid-users>
> 
>     _______________________________________________
>     squid-users mailing list
>     squid-users at lists.squid-cache.org
>     <mailto:squid-users at lists.squid-cache.org>
>     https://lists.squid-cache.org/listinfo/squid-users
>     <https://lists.squid-cache.org/listinfo/squid-users>
> 



From jonathanlee571 at gmail.com  Mon Dec 30 16:46:31 2024
From: jonathanlee571 at gmail.com (Jonathan Lee)
Date: Mon, 30 Dec 2024 08:46:31 -0800
Subject: [squid-users] Optimization
Message-ID: <9BFB8724-625D-479A-B8FB-7A4E0C8C1250@gmail.com>

Hello Fellow Squid Users,

I wanted to try to speed up my SSL interception caching, or optimize it 

I have some small issues with some websites loading slowly not really bad just a small lag and I started to play around with 
all-of and any-of to create new concatenated acls. 

I have arp mac addresses being used to check for ip and mac address for approval of proxy use and some other items. 

Does this speed up anything I am trying to get the ssl bump items to have better performance. The splice side is lighting fast again I just wonder if anything can be done to speed up the bump side. I am attempting to combine and concatenate access control lists. 

the Mac address and IP address matching does work it has been for some time I am just attempting a better way to create a better single acl for use with the ssl_bump directive 

Here is the part of my config I am asking about see #!!!!!!!

acl wpad urlpath_regex ^/wpad.dat$
acl wpad urlpath_regex ^/proxy.pac$
acl wpad urlpath_regex ^/wpad.da$
deny_info TCP_RESET wpad
#deny_info 200:/etc/squid/wpad.dat wpad
reply_header_access Content-Type deny wpad
http_access deny wpad
http_access deny !safeports
http_access deny CONNECT !sslports
#http_access allow localhost manager
#http_access deny manager
cachemgr_passwd disable offline_toggle reconfigure shutdown
cachemgr_passwd CLASSIFIED all
eui_lookup on
acl no_miss url_regex -i gateway\.facebook\.com\/ws\/realtime\?
acl no_miss url_regex -i web-chat-e2ee\.facebook\.com\/ws\/chat
acl CONNECT method CONNECT
acl wuCONNECT dstdomain www.update.microsoft.com
acl wuCONNECT dstdomain sls.microsoft.com
http_access allow CONNECT wuCONNECT localnet
http_access allow CONNECT wuCONNECT localhost
http_access allow CONNECT windowsupdate localnet
http_access allow CONNECT windowsupdate localhost
http_access allow CONNECT HttpAccess localnet
http_access allow CONNECT HttpAccess localhost
#http_access deny manager
http_access deny to_ipv6
http_access deny from_ipv6

acl BrokenButTrustedServers dstdomain "/usr/local/pkg/dstdom.broken"
acl DomainMismatch ssl_error SQUID_X509_V_ERR_DOMAIN_MISMATCH
sslproxy_cert_error allow BrokenButTrustedServers DomainMismatch
sslproxy_cert_error deny all

acl splice_only src 192.168.1.8 
acl splice_only src 192.168.1.10 
acl splice_only src 192.168.1.11
acl splice_only src 192.168.1.15
acl splice_only src 192.168.1.16

acl splice_only_mac arp MAC
acl splice_only_mac arp MAC
acl splice_only_mac arp MAC
acl splice_only_mac arp MAC
acl splice_only_mac arp MAC

acl NoSSLIntercept ssl::server_name_regex -i "/usr/local/pkg/reg.url.nobump"
acl NoBumpDNS dstdomain "/usr/local/pkg/dns.nobump"
acl SSL_Intercept_Terminate dstdomain "/usr/local/pkg/url.bump"

#acl markBumped annotate_client bumped=true #TESTING NOT USED
acl active_use annotate_client active=true

acl bump_only src 192.168.1.3
acl bump_only src 192.168.1.4
acl bump_only src 192.168.1.5
#acl bump_only src 192.168.1.6
acl bump_only src 192.168.1.9
acl bump_only src 192.168.1.13

acl bump_only_mac arp MAC
acl bump_only_mac arp MAC
acl bump_only_mac arp MAC
acl bump_only_mac arp MAC
acl bump_only_mac arp MAC
#acl bump_only_mac arp MAC

collapsed_forwarding on
negative_dns_ttl 5 minutes
coredump_dir /label/swap0
read_ahead_gap 64 KB
pipeline_prefetch 100
happy_eyeballs_connect_timeout 10
memory_pools on


#!!!!!!!!
acl splice_group any-of https_login NoBumpDNS NoSSLIntercept #any of the splice lists OR acl ||
acl splice_only_local_group all-of splice_only_mac splice_only #MAC AND IP ADDRESS &&
acl splice_main any-of splice_group splice_only_local_group  #combine to OR acl ||

acl bump_main all-of bump_only_mac bump_only #MAC AND IP ADDRESS &&
#!!!!!!!!



ssl_bump peek step1
ssl_bump terminate SSL_Intercept_Terminate
miss_access deny no_miss active_use

#OLD WAY
#ssl_bump splice https_login active_use 
#ssl_bump splice splice_only_mac splice_only active_use
#ssl_bump splice NoBumpDNS active_use
#ssl_bump splice NoSSLIntercept active_use

#NEW WAY ONE ACL
ssl_bump splice splice_main active_use

#OLD WAY 
#ssl_bump bump bump_only_mac bump_only active_use

#NEW WAY ONE ACL
ssl_bump bump bump_main active_use

acl activated note active_use true
ssl_bump terminate !activated

From jonathanlee571 at gmail.com  Mon Dec 30 16:55:14 2024
From: jonathanlee571 at gmail.com (Jonathan Lee)
Date: Mon, 30 Dec 2024 08:55:14 -0800
Subject: [squid-users] Optimization
In-Reply-To: <9BFB8724-625D-479A-B8FB-7A4E0C8C1250@gmail.com>
References: <9BFB8724-625D-479A-B8FB-7A4E0C8C1250@gmail.com>
Message-ID: <611BD762-326D-45BD-A059-FB1540CFB993@gmail.com>

This was the before what is faster or better for performance? The parsed ssl_bump lists or the singular list ?

----Parsed??
#no concatenation used here 
#acl splice_group any-of https_login NoBumpDNS NoSSLIntercept
#acl splice_only_local_group all-of splice_only_mac splice_only
#acl splice_main any-of splice_group splice_only_local_group
#acl bump_main all-of bump_only_mac bump_only

ssl_bump peek step1
ssl_bump terminate SSL_Intercept_Terminate
miss_access deny no_miss active_use
ssl_bump splice https_login active_use
ssl_bump splice splice_only_mac splice_only active_use
ssl_bump splice NoBumpDNS active_use
ssl_bump splice NoSSLIntercept active_use
ssl_bump bump bump_only_mac bump_only active_use
acl activated note active_use true
ssl_bump terminate !activated


-----Concatenated new version??
acl splice_group any-of https_login NoBumpDNS NoSSLIntercept #any of the splice lists OR acl ||
acl splice_only_local_group all-of splice_only_mac splice_only #MAC AND IP ADDRESS &&
acl splice_main any-of splice_group splice_only_local_group  #combine to OR acl ||
acl bump_main all-of bump_only_mac bump_only #MAC AND IP ADDRESS &&


ssl_bump peek step1
ssl_bump terminate SSL_Intercept_Terminate
miss_access deny no_miss active_use
ssl_bump splice splice_main active_use
ssl_bump bump bump_main active_use
acl activated note active_use true
ssl_bump terminate !activated



> On Dec 30, 2024, at 08:46, Jonathan Lee <jonathanlee571 at gmail.com> wrote:
> 
> Hello Fellow Squid Users,
> 
> I wanted to try to speed up my SSL interception caching, or optimize it 
> 
> I have some small issues with some websites loading slowly not really bad just a small lag and I started to play around with 
> all-of and any-of to create new concatenated acls. 
> 
> I have arp mac addresses being used to check for ip and mac address for approval of proxy use and some other items. 
> 
> Does this speed up anything I am trying to get the ssl bump items to have better performance. The splice side is lighting fast again I just wonder if anything can be done to speed up the bump side. I am attempting to combine and concatenate access control lists. 
> 
> the Mac address and IP address matching does work it has been for some time I am just attempting a better way to create a better single acl for use with the ssl_bump directive 
> 
> Here is the part of my config I am asking about see #!!!!!!!
> 
> acl wpad urlpath_regex ^/wpad.dat$
> acl wpad urlpath_regex ^/proxy.pac$
> acl wpad urlpath_regex ^/wpad.da$
> deny_info TCP_RESET wpad
> #deny_info 200:/etc/squid/wpad.dat wpad
> reply_header_access Content-Type deny wpad
> http_access deny wpad
> http_access deny !safeports
> http_access deny CONNECT !sslports
> #http_access allow localhost manager
> #http_access deny manager
> cachemgr_passwd disable offline_toggle reconfigure shutdown
> cachemgr_passwd CLASSIFIED all
> eui_lookup on
> acl no_miss url_regex -i gateway\.facebook\.com\/ws\/realtime\?
> acl no_miss url_regex -i web-chat-e2ee\.facebook\.com\/ws\/chat
> acl CONNECT method CONNECT
> acl wuCONNECT dstdomain www.update.microsoft.com
> acl wuCONNECT dstdomain sls.microsoft.com
> http_access allow CONNECT wuCONNECT localnet
> http_access allow CONNECT wuCONNECT localhost
> http_access allow CONNECT windowsupdate localnet
> http_access allow CONNECT windowsupdate localhost
> http_access allow CONNECT HttpAccess localnet
> http_access allow CONNECT HttpAccess localhost
> #http_access deny manager
> http_access deny to_ipv6
> http_access deny from_ipv6
> 
> acl BrokenButTrustedServers dstdomain "/usr/local/pkg/dstdom.broken"
> acl DomainMismatch ssl_error SQUID_X509_V_ERR_DOMAIN_MISMATCH
> sslproxy_cert_error allow BrokenButTrustedServers DomainMismatch
> sslproxy_cert_error deny all
> 
> acl splice_only src 192.168.1.8 
> acl splice_only src 192.168.1.10 
> acl splice_only src 192.168.1.11
> acl splice_only src 192.168.1.15
> acl splice_only src 192.168.1.16
> 
> acl splice_only_mac arp MAC
> acl splice_only_mac arp MAC
> acl splice_only_mac arp MAC
> acl splice_only_mac arp MAC
> acl splice_only_mac arp MAC
> 
> acl NoSSLIntercept ssl::server_name_regex -i "/usr/local/pkg/reg.url.nobump"
> acl NoBumpDNS dstdomain "/usr/local/pkg/dns.nobump"
> acl SSL_Intercept_Terminate dstdomain "/usr/local/pkg/url.bump"
> 
> #acl markBumped annotate_client bumped=true #TESTING NOT USED
> acl active_use annotate_client active=true
> 
> acl bump_only src 192.168.1.3
> acl bump_only src 192.168.1.4
> acl bump_only src 192.168.1.5
> #acl bump_only src 192.168.1.6
> acl bump_only src 192.168.1.9
> acl bump_only src 192.168.1.13
> 
> acl bump_only_mac arp MAC
> acl bump_only_mac arp MAC
> acl bump_only_mac arp MAC
> acl bump_only_mac arp MAC
> acl bump_only_mac arp MAC
> #acl bump_only_mac arp MAC
> 
> collapsed_forwarding on
> negative_dns_ttl 5 minutes
> coredump_dir /label/swap0
> read_ahead_gap 64 KB
> pipeline_prefetch 100
> happy_eyeballs_connect_timeout 10
> memory_pools on
> 
> 
> #!!!!!!!!
> acl splice_group any-of https_login NoBumpDNS NoSSLIntercept #any of the splice lists OR acl ||
> acl splice_only_local_group all-of splice_only_mac splice_only #MAC AND IP ADDRESS &&
> acl splice_main any-of splice_group splice_only_local_group  #combine to OR acl ||
> 
> acl bump_main all-of bump_only_mac bump_only #MAC AND IP ADDRESS &&
> #!!!!!!!!
> 
> 
> 
> ssl_bump peek step1
> ssl_bump terminate SSL_Intercept_Terminate
> miss_access deny no_miss active_use
> 
> #OLD WAY
> #ssl_bump splice https_login active_use 
> #ssl_bump splice splice_only_mac splice_only active_use
> #ssl_bump splice NoBumpDNS active_use
> #ssl_bump splice NoSSLIntercept active_use
> 
> #NEW WAY ONE ACL
> ssl_bump splice splice_main active_use
> 
> #OLD WAY 
> #ssl_bump bump bump_only_mac bump_only active_use
> 
> #NEW WAY ONE ACL
> ssl_bump bump bump_main active_use
> 
> acl activated note active_use true
> ssl_bump terminate !activated



From rousskov at measurement-factory.com  Mon Dec 30 18:28:31 2024
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Mon, 30 Dec 2024 13:28:31 -0500
Subject: [squid-users] Optimization
In-Reply-To: <611BD762-326D-45BD-A059-FB1540CFB993@gmail.com>
References: <9BFB8724-625D-479A-B8FB-7A4E0C8C1250@gmail.com>
 <611BD762-326D-45BD-A059-FB1540CFB993@gmail.com>
Message-ID: <65b6660c-ce86-4ffa-9578-4d23cd37f098@measurement-factory.com>

On 2024-12-30 11:55, Jonathan Lee wrote:
> what is faster or better for performance? The parsed ssl_bump lists
> or the singular list?

To remove very distracting noise, I am posting an abridged version of 
your "before" and "after" configurations:

     # before
     ssl_bump splice A
     ssl_bump splice D E
     ssl_bump splice B
     ssl_bump splice C
     ssl_bump bump F G

     # after
     ssl_bump splice AorBorCorDE
     ssl_bump bump FG


The two versions differ only in evaluation order:

     before: ACLs D and E evaluate before ACLs B and C
     after:  ACLs D and E evaluate after ACLs B and C

Which version is faster depends on whether ACLs D and E match (together) 
more often than ACL B or ACL C matches (each) _and_ on the cost of 
evaluating the respective ACLs. I do not have enough information to do 
the math.

If the evaluation order is kept the same, then both configurations 
should have about the same performance. Internally, modern Squid interprets

     directive actionX a
     directive actionX b

almost as if it was written as

     acl AorB any-of a b
     directive actionX AorB

The latter configuration might consume slightly less memory in some 
cases, but that difference in memory consumption is unlikely to have a 
measurable effect on performance in most cases.


HTH,

Alex.

>     acl AorBorC any-of A B C
>     acl DE all-of D E
>     acl AorBorCorDE any-of AorBorC DE
>     acl FG all-of F G


> ----Parsed??
> acl splice_group any-of https_login NoBumpDNS NoSSLIntercept
> acl splice_only_local_group all-of splice_only_mac splice_only
> acl splice_main any-of splice_group splice_only_local_group
> acl bump_main all-of bump_only_mac bump_only
> 
> ssl_bump peek step1
> ssl_bump terminate SSL_Intercept_Terminate
> ssl_bump splice https_login active_use
> ssl_bump splice splice_only_mac splice_only active_use
> ssl_bump splice NoBumpDNS active_use
> ssl_bump splice NoSSLIntercept active_use
> ssl_bump bump bump_only_mac bump_only active_use
> 
> 
> -----Concatenated new version??
> acl splice_group any-of https_login NoBumpDNS NoSSLIntercept
> acl splice_only_local_group all-of splice_only_mac splice_only
> acl splice_main any-of splice_group splice_only_local_group
> acl bump_main all-of bump_only_mac bump_only


> ssl_bump peek step1
> ssl_bump terminate SSL_Intercept_Terminate
> ssl_bump splice splice_main active_use
> ssl_bump bump bump_main active_use
> acl activated note active_use true
> 
> 
> 
>> On Dec 30, 2024, at 08:46, Jonathan Lee <jonathanlee571 at gmail.com> wrote:
>>
>> Hello Fellow Squid Users,
>>
>> I wanted to try to speed up my SSL interception caching, or optimize it
>>
>> I have some small issues with some websites loading slowly not really bad just a small lag and I started to play around with
>> all-of and any-of to create new concatenated acls.
>>
>> I have arp mac addresses being used to check for ip and mac address for approval of proxy use and some other items.
>>
>> Does this speed up anything I am trying to get the ssl bump items to have better performance. The splice side is lighting fast again I just wonder if anything can be done to speed up the bump side. I am attempting to combine and concatenate access control lists.
>>
>> the Mac address and IP address matching does work it has been for some time I am just attempting a better way to create a better single acl for use with the ssl_bump directive
>>
>> Here is the part of my config I am asking about see #!!!!!!!
>>
>> acl wpad urlpath_regex ^/wpad.dat$
>> acl wpad urlpath_regex ^/proxy.pac$
>> acl wpad urlpath_regex ^/wpad.da$
>> deny_info TCP_RESET wpad
>> #deny_info 200:/etc/squid/wpad.dat wpad
>> reply_header_access Content-Type deny wpad
>> http_access deny wpad
>> http_access deny !safeports
>> http_access deny CONNECT !sslports
>> #http_access allow localhost manager
>> #http_access deny manager
>> cachemgr_passwd disable offline_toggle reconfigure shutdown
>> cachemgr_passwd CLASSIFIED all
>> eui_lookup on
>> acl no_miss url_regex -i gateway\.facebook\.com\/ws\/realtime\?
>> acl no_miss url_regex -i web-chat-e2ee\.facebook\.com\/ws\/chat
>> acl CONNECT method CONNECT
>> acl wuCONNECT dstdomain www.update.microsoft.com
>> acl wuCONNECT dstdomain sls.microsoft.com
>> http_access allow CONNECT wuCONNECT localnet
>> http_access allow CONNECT wuCONNECT localhost
>> http_access allow CONNECT windowsupdate localnet
>> http_access allow CONNECT windowsupdate localhost
>> http_access allow CONNECT HttpAccess localnet
>> http_access allow CONNECT HttpAccess localhost
>> #http_access deny manager
>> http_access deny to_ipv6
>> http_access deny from_ipv6
>>
>> acl BrokenButTrustedServers dstdomain "/usr/local/pkg/dstdom.broken"
>> acl DomainMismatch ssl_error SQUID_X509_V_ERR_DOMAIN_MISMATCH
>> sslproxy_cert_error allow BrokenButTrustedServers DomainMismatch
>> sslproxy_cert_error deny all
>>
>> acl splice_only src 192.168.1.8
>> acl splice_only src 192.168.1.10
>> acl splice_only src 192.168.1.11
>> acl splice_only src 192.168.1.15
>> acl splice_only src 192.168.1.16
>>
>> acl splice_only_mac arp MAC
>> acl splice_only_mac arp MAC
>> acl splice_only_mac arp MAC
>> acl splice_only_mac arp MAC
>> acl splice_only_mac arp MAC
>>
>> acl NoSSLIntercept ssl::server_name_regex -i "/usr/local/pkg/reg.url.nobump"
>> acl NoBumpDNS dstdomain "/usr/local/pkg/dns.nobump"
>> acl SSL_Intercept_Terminate dstdomain "/usr/local/pkg/url.bump"
>>
>> #acl markBumped annotate_client bumped=true #TESTING NOT USED
>> acl active_use annotate_client active=true
>>
>> acl bump_only src 192.168.1.3
>> acl bump_only src 192.168.1.4
>> acl bump_only src 192.168.1.5
>> #acl bump_only src 192.168.1.6
>> acl bump_only src 192.168.1.9
>> acl bump_only src 192.168.1.13
>>
>> acl bump_only_mac arp MAC
>> acl bump_only_mac arp MAC
>> acl bump_only_mac arp MAC
>> acl bump_only_mac arp MAC
>> acl bump_only_mac arp MAC
>> #acl bump_only_mac arp MAC
>>
>> collapsed_forwarding on
>> negative_dns_ttl 5 minutes
>> coredump_dir /label/swap0
>> read_ahead_gap 64 KB
>> pipeline_prefetch 100
>> happy_eyeballs_connect_timeout 10
>> memory_pools on
>>
>>
>> #!!!!!!!!
>> acl splice_group any-of https_login NoBumpDNS NoSSLIntercept #any of the splice lists OR acl ||
>> acl splice_only_local_group all-of splice_only_mac splice_only #MAC AND IP ADDRESS &&
>> acl splice_main any-of splice_group splice_only_local_group  #combine to OR acl ||
>>
>> acl bump_main all-of bump_only_mac bump_only #MAC AND IP ADDRESS &&
>> #!!!!!!!!
>>
>>
>>
>> ssl_bump peek step1
>> ssl_bump terminate SSL_Intercept_Terminate
>> miss_access deny no_miss active_use
>>
>> #OLD WAY
>> #ssl_bump splice https_login active_use
>> #ssl_bump splice splice_only_mac splice_only active_use
>> #ssl_bump splice NoBumpDNS active_use
>> #ssl_bump splice NoSSLIntercept active_use
>>
>> #NEW WAY ONE ACL
>> ssl_bump splice splice_main active_use
>>
>> #OLD WAY
>> #ssl_bump bump bump_only_mac bump_only active_use
>>
>> #NEW WAY ONE ACL
>> ssl_bump bump bump_main active_use
>>
>> acl activated note active_use true
>> ssl_bump terminate !activated
> 
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> https://lists.squid-cache.org/listinfo/squid-users



From jonathanlee571 at gmail.com  Mon Dec 30 18:40:31 2024
From: jonathanlee571 at gmail.com (Jonathan Lee)
Date: Mon, 30 Dec 2024 10:40:31 -0800
Subject: [squid-users] Optimization
In-Reply-To: <65b6660c-ce86-4ffa-9578-4d23cd37f098@measurement-factory.com>
References: <9BFB8724-625D-479A-B8FB-7A4E0C8C1250@gmail.com>
 <611BD762-326D-45BD-A059-FB1540CFB993@gmail.com>
 <65b6660c-ce86-4ffa-9578-4d23cd37f098@measurement-factory.com>
Message-ID: <51D29234-AEA8-4A92-866F-EDBF3B5BB3FD@gmail.com>

Thanks, Merry Christmas and Happy New Year everyone. That answered my question.

Again thank you. 

> On Dec 30, 2024, at 10:28, Alex Rousskov <rousskov at measurement-factory.com> wrote:
> 
> latter

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20241230/7d561935/attachment.htm>

From jonathanlee571 at gmail.com  Mon Dec 30 22:10:07 2024
From: jonathanlee571 at gmail.com (Jonathan Lee)
Date: Mon, 30 Dec 2024 14:10:07 -0800
Subject: [squid-users] Thoughts on caching aspx jsp asp cgi-bin
Message-ID: <B1A27C83-9CF6-48AF-940A-10B493FE4F7F@gmail.com>

Hello fellow Squid Users, 

Can you please help?

What are your thoughts on this rule? Should cgi-bin aspx and jsp files be excluded from the web-cache? They are dynamic correct? This could help speed up systems right?


acl QUERY urlpath_regex cgi-bin \? asp aspx jsp

## Prevent caching jsp, cgi-bin etc
cache deny QUERY

Ref:
https://wiki.alpinelinux.org/wiki/Setting_up_Explicit_Squid_Proxy?
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20241230/61b7547f/attachment.htm>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: favicon.png
Type: image/png
Size: 1039 bytes
Desc: not available
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20241230/61b7547f/attachment.png>

From jonathanlee571 at gmail.com  Tue Dec 31 17:54:53 2024
From: jonathanlee571 at gmail.com (Jonathan Lee)
Date: Tue, 31 Dec 2024 09:54:53 -0800
Subject: [squid-users] Thoughts on caching aspx jsp asp cgi-bin
In-Reply-To: <B1A27C83-9CF6-48AF-940A-10B493FE4F7F@gmail.com>
References: <B1A27C83-9CF6-48AF-940A-10B493FE4F7F@gmail.com>
Message-ID: <9B993437-FC3B-417B-A7A7-89DB3AAB176C@gmail.com>

An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20241231/03bd05f5/attachment.htm>

From squid at digi.ninja  Tue Dec 31 22:47:27 2024
From: squid at digi.ninja (Robin Wood)
Date: Tue, 31 Dec 2024 22:47:27 +0000
Subject: [squid-users] Thoughts on caching aspx jsp asp cgi-bin
In-Reply-To: <9B993437-FC3B-417B-A7A7-89DB3AAB176C@gmail.com>
References: <B1A27C83-9CF6-48AF-940A-10B493FE4F7F@gmail.com>
 <9B993437-FC3B-417B-A7A7-89DB3AAB176C@gmail.com>
Message-ID: <CALmccy6KaRu8y2kbtwBhngwFcKbi4L9q2Uag1p_45OUd5WO8vA@mail.gmail.com>

I would say that it depends on what the dynamic content is. If it is public
content from a CMS and you are OK with it potentially being your cache age
out of date, then caching it rather than reloading it from the database
every page load is fine. If the pages are for anything sensitive, for
example a user's account, then definitely do not cache it.

Robin

On Tue, 31 Dec 2024 at 17:55, Jonathan Lee <jonathanlee571 at gmail.com> wrote:

> What are your thoughts? This is in relation to ssl intercept with
> certificates installed and bump active.
>
> Keep in mind I am still a student and learning.
> Is a rule like this recommended? Does anyone have a better version of
> this?
> Sent from my iPhone
>
> On Dec 30, 2024, at 14:10, Jonathan Lee <jonathanlee571 at gmail.com> wrote:
>
> ?Hello fellow Squid Users,
>
> Can you please help?
>
> What are your thoughts on this rule? Should cgi-bin aspx and jsp files be
> excluded from the web-cache? They are dynamic correct? This could help
> speed up systems right?
>
>
> acl QUERY urlpath_regex cgi-bin \? asp aspx jsp
>
>
> ## Prevent caching jsp, cgi-bin etc
>
> cache deny QUERY
>
> Ref:
> Setting up Explicit Squid Proxy
> <https://wiki.alpinelinux.org/wiki/Setting_up_Explicit_Squid_Proxy>
> wiki.alpinelinux.org
> <https://wiki.alpinelinux.org/wiki/Setting_up_Explicit_Squid_Proxy>
> <favicon.png>
> <https://wiki.alpinelinux.org/wiki/Setting_up_Explicit_Squid_Proxy>
> <https://wiki.alpinelinux.org/wiki/Setting_up_Explicit_Squid_Proxy>
>
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> https://lists.squid-cache.org/listinfo/squid-users
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20241231/49d959d6/attachment.htm>

From jonathanlee571 at gmail.com  Tue Dec 31 23:04:35 2024
From: jonathanlee571 at gmail.com (Jonathan Lee)
Date: Tue, 31 Dec 2024 15:04:35 -0800
Subject: [squid-users] StoreID Question
Message-ID: <A865F380-002F-47E9-BC77-78B4AF604B80@gmail.com>

Hello Fellow Squid Users,

Can you please help? I have been researching this for a long time and cannot find any information on this "what is the $ mean? within StoreID?

Below is my failed attempt to make StoreID work correctly. Sorry it's a mess. I have since disabled my customized StoreID patterns because it caused issues. My question is with regard to the $number part of the program. I disabled all the facebook and all my tests because my photos where showing up wrong and it would duplicate itself over everything, I would have to clear the cache and change items and try again below is my failed attempt to get it to work correctly. 

It did work sometimes however I would get issues the longer it went on for. I decided to stop the trial and testing of it because it was driving me crazy. It is a great puzzle to solve. Does anyone have any tips? I have some Squid text books like the Squid the definitive guide, and The Squid Proxy Server 3.1 guide still nothing really explains StoreID outside of the Squid website. Yes the website comes with a great database that does work, I tested some database items with Ubuntu updates inside of VMs and it worked and reserved them to other machines asking for the same update. So in my quest I thought can I also do this with Facebook? (I do not recommend you try it) or something else, Youtube. 

This is the Text file I have been testing and it was a failed test outside of Ubuntu updates however I do not use that OS anymore so it is removed I think I had the $ wrong I have no info on what it does some are 1 some are 5 some are doubles $ and another of them:

^https?:\/\/(fbcdn|scontent).*(akamaihd|fbcdn)\.net\/.*\/v\/.*\/(.*\.mp4)		http://facebook.squid.internal/$3
^https?:\/\/fbcdn\-(static|profile)\-a\.akamaihd\.net\/static\-ak\/rsrc\.php\/((?!.*\.(?:js|css|swf)).*)	http://facebook.squid.internal/static/$2
^https?:\/\/(fbcdn|scontent).*(akamaihd|fbcdn)\.net\/(h|s)(profile|photos).*\/(.*\.(png|gif|jpg))(\?.+)? 	http://facebook.squid.internal/$5
^https?:\/\/fbstatic\-a\.akamaihd\.net\/rsrc\.php\/((?!.*\.(?:js|css|swf)).*) 	http://facebook.squid.internal/static/$1
^http:\/\/.*[steampowered|steamcontent]\.com\/([^?]*)	http://steamupdates.squid.internal/$1
^https?\:\/\/download\.oracle\.com\/((otn\-pub|otn)\/[\d\w]+\/[\d\w]+\/[\w\d\-]+\/[\w\d\-]+\.(exe|dmg|rpm|msi|tar\.(gz|Z)))\?	http://java.oracle.otn.ngtech.squid.internal/$1
^https?\:\/\/([\d\w\-]+)\.oracle\.com\/(([\d\w]+)\/[\d\w]+\/[\d\w]+\/([\d\w\-]+)\/([\d\w]+\/)?[\d\w\-\.\_]+\.(dmg|msi|exe|tar\.gz|tar\.Z))\?	http://java.oracle.download.ngtech.squid.internal/$2
^http:\/\/[^\.]+\.phobos\.apple\.com\/(.*)	http://appupdates.apple.squid.internal/$1
^http:\/\/[^\.]+\.c\.android\.clients\.google\.com\/(.*)	http://androidupdates.google.squid.internal/$1

My question here is:
What does this $3 mean within the the store id program?

This is the config and refresh patterns that I was learning with for Squid StoreID. Much of it is ?#?ed out but this is what I was using:

#store_id_program /usr/local/libexec/squid/storeid_file_rewrite /var/squid/storeid/storeid_rewrite.txt
#store_id_children 10 startup=5 idle=1 concurrency=0
#always_direct allow all
#store_id_access deny connect
#store_id_access deny !getmethod
#store_id_access allow rewritedoms
#store_id_access deny all

refresh_all_ims on
reload_into_ims on
max_stale 20 years
minimum_expiry_time 0

#refresh_pattern -i ^http.*squid\.internal.* 43200 100% 79900 override-expire override-lastmod ignore-reload ignore-no-store ignore-must-revalidate ignore-private ignore-auth

#FACEBOOK
#refresh_pattern ^https.*.facebook.com/* 10080 80% 43200

#FACEBOOK IMAGES  
#refresh_pattern -i pixel.facebook.com..(jpg|png|gif|ico|css|js|jpg?) 10080 80% 43200
#refresh_pattern -i .akamaihd.net..(jpg|png|gif|ico|css|js|jpg?) 10080 80% 43200 
#refresh_pattern -i facebook.com.(jpg|png|gif|jpg?) 10080 80% 43200 store-stale
#refresh_pattern static.(xx|ak).fbcdn.net.(jpg|gif|png|jpg?) 10080 80% 43200
#refresh_pattern ^https.*profile.ak.fbcdn.net.*(jpg|gif|png|jpg?) 10080 80% 43200
#refresh_pattern ^https.*fbcdn.net.*(jpg|gif|png|jpg?) 10080 80% 43200

#FACEBOOK VIDEO
#refresh_pattern -i .video.ak.fbcdn.net.*.(mp4|flv|mp3|amf) 10080 80% 43200
#refresh_pattern (audio|video)/(webm|mp4) 10080 80% 43200

#APPLE STUFF
#refresh_pattern -i apple.com/..(cab|exe|msi|msu|msf|asf|wmv|wma|dat|zip|dist)$ 0 80% 43200  refresh-ims

#apple update
#refresh_pattern -i (download|adcdownload).apple.com/.*\.(pkg|dmg) 4320 100% 43200
#refresh_pattern -i appldnld\.apple\.com 129600 100% 129600
#refresh_pattern -i phobos\.apple\.com 129600 100% 129600
#refresh_pattern -i iosapps\.itunes\.apple\.com 129600 100% 129600

refresh_pattern -i windowsupdate.com/.*\.(cab|exe|ms[i|u|f|p]|[ap]sf|wm[v|a]|dat|zip|psf) 43200 80% 129600 reload-into-ims
refresh_pattern -i microsoft.com/.*\.(cab|exe|ms[i|u|f|p]|[ap]sf|wm[v|a]|dat|zip|psf) 43200 80% 129600 reload-into-ims
refresh_pattern -i windows.com/.*\.(cab|exe|ms[i|u|f|p]|[ap]sf|wm[v|a]|dat|zip|psf) 43200 80% 129600 reload-into-ims
refresh_pattern -i microsoft.com.akadns.net/.*\.(cab|exe|ms[i|u|f|p]|[ap]sf|wm[v|a]|dat|zip|psf) 43200 80% 129600 reload-into-ims
refresh_pattern -i deploy.akamaitechnologies.com/.*\.(cab|exe|ms[i|u|f|p]|[ap]sf|wm[v|a]|dat|zip|psf) 43200 80% 129600 reload-into-ims

# Updates: Windows
#refresh_pattern -i microsoft.com/..(cab|exe|msi|msu|msf|asf|wma|dat|zip)$ 4320 80% 43200  refresh-ims
refresh_pattern -i windowsupdate.com/..(cab|exe|msi|msu|msf|asf|wma|wmv)|dat|zip)$ 4320 80% 43200  refresh-ims
#refresh_pattern -i windows.com/..(cab|exe|msi|msu|msf|asf|wmv|wma|dat|zip)$ 4320 80% 43200  refresh-ims
#refresh_pattern -i microsoft.com/.*\.(cab|exe|ms[i|u|f]|[ap]sf|wm[v|a]|dat|zip) 4320 80% 43200 
#refresh_pattern -i windowsupdate.com/.*\.(cab|exe|ms[i|u|f]|[ap]sf|wm[v|a]|dat|zip) 4320 80% 43200 
#refresh_pattern -i windows.com/.*\.(cab|exe|ms[i|u|f]|[ap]sf|wm[v|a]|dat|zip) 4320 80% 43200 
#refresh_pattern -i .*windowsupdate.com/.*\.(cab|exe) 259200 100% 259200   
#refresh_pattern -i .*update.microsoft.com/.*\.(cab|exe|dll|msi|psf) 259200 100% 259200   
#refresh_pattern windowsupdate.com/.*\.(cab|exe|dll|msi|psf) 10080 100% 43200 
#refresh_pattern download.microsoft.com/.*\.(cab|exe|dll|msi|psf) 10080 100% 43200 
#refresh_pattern www.microsoft.com/.*\.(cab|exe|dll|msi|psf) 10080 100% 43200 
#refresh_pattern au.download.windowsupdate.com/.*\.(cab|exe|dll|msi|psf) 4320 100% 43200 
#refresh_pattern bg.v4.pr.dl.ws.microsoft.com/.*\.(cab|exe|dll|msi|psf) 4320 100% 43200
#windows update NEW UPDATE 0.04
#refresh_pattern update.microsoft.com/.*\.(cab|exe) 43200 100% 129600    
#refresh_pattern ([^.]+\.)?(download|(windows)?update)\.(microsoft\.)?com/.*\.(cab|exe|msi|msp|psf) 4320 100% 43200  
#refresh_pattern update.microsoft.com/.*\.(cab|exe|dll|msi|psf) 10080 100% 43200 
#refresh_pattern -i \.update.microsoft.com/.*\.(cab|exe|ms[i|u|f]|[ap]sf|wm[v|a]|dat|zip) 525600 100% 525600       
#refresh_pattern -i \.windowsupdate.com/.*\.(cab|exe|ms[i|u|f]|[ap]sf|wm[v|a]|dat|zip) 525600 100% 525600       
#refresh_pattern -i \.download.microsoft.com/.*\.(cab|exe|ms[i|u|f]|[ap]sf|wm[v|a]|dat|zip) 525600 100% 525600       
#refresh_pattern -i \.ws.microsoft.com/.*\.(cab|exe|ms[i|u|f]|[ap]sf|wm[v|a]|dat|zip) 525600 100% 525600       
    
#refresh_pattern ([^.]+\.)?(cs|content[1-9]|hsar|content-origin|client-download).[steampowered|steamcontent].com/.*\.* 43200 100% 43200     
#refresh_pattern ([^.]+\.)?.akamai.steamstatic.com/.*\.* 43200 100% 43200

#refresh_pattern -i ([^.]+\.)?.adobe.com/.*\.(zip|exe) 43200 100% 43200
#refresh_pattern -i ([^.]+\.)?.java.com/.*\.(zip|exe) 43200 100% 43200
#refresh_pattern -i ([^.]+\.)?.sun.com/.*\.(zip|exe) 43200 100% 43200
#refresh_pattern -i ([^.]+\.)?.oracle.com/.*\.(zip|exe|tar.gz) 43200 100% 43200

#refresh_pattern -i appldnld\.apple\.com 43200 100% 43200
#refresh_pattern -i ([^.]+\.)?apple.com/.*\.(ipa) 43200 100% 43200
 
#refresh_pattern -i ([^.]+\.)?.google.com/.*\.(exe|crx) 10080 80% 43200
#refresh_pattern -i ([^.]+\.)?g.static.com/.*\.(exe|crx) 10080 80% 43200

acl https_login url_regex -i ^https.*(login|Login).*
cache deny https_login

#range_offset_limit 512 MB windowsupdate
range_offset_limit 0 !windowsupdate
quick_abort_min -1 KB


Store ID program:

I am using the built in program attached here..
/usr/local/libexec/squid/storeid_file_rewrite
#!/usr/local/bin/perl

use strict;
use warnings;
use Pod::Usage;

=pod

=head1 NAME

 storeid_file_rewrite - File based Store-ID helper for Squid

=head1 SYNOPSIS

 storeid_file_rewrite filepath

=head1 DESCRIPTION

This program acts as a store_id helper program, rewriting URLs passed
by Squid into storage-ids that can be used to achieve better caching
for websites that use different URLs for the same content.

It takes a text file with two tab separated columns.
Column 1: Regular expression to match against the URL
Column 2: Rewrite rule to generate a Store-ID
Eg:
^http:\/\/[^\.]+\.dl\.sourceforge\.net\/(.*)    http://dl.sourceforge.net.squid.internal/$1

Rewrite rules are matched in the same order as they appear in the rules file.
So for best performance, sort it in order of frequency of occurrence.

This program will automatically detect the existence of a concurrency channel-ID and adjust appropriately.
It may be used with any value 0 or above for the store_id_children concurrency= parameter.

=head1 OPTIONS

The only command line parameter this helper takes is the regex rules file name.

=head1 AUTHOR

This program and documentation was written by I<Alan Mizrahi <alan at mizrahi.com.ve>>

Based on prior work by I<Eliezer Croitoru <eliezer at ngtech.co.il>>

=head1 COPYRIGHT

 * Copyright (C) 1996-2023 The Squid Software Foundation and contributors
 *
 * Squid software is distributed under GPLv2+ license and includes
 * contributions from numerous individuals and organizations.
 * Please see the COPYING and CONTRIBUTORS files for details.

 Copyright (C) 2013 Alan Mizrahi <alan at mizrahi.com.ve>
 Based on code from Eliezer Croitoru <eliezer at ngtech.co.il>

 This program is free software; you can redistribute it and/or modify
 it under the terms of the GNU General Public License as published by
 the Free Software Foundation; either version 2 of the License, or
 (at your option) any later version.

 This program is distributed in the hope that it will be useful,
 but WITHOUT ANY WARRANTY; without even the implied warranty of
 MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 GNU General Public License for more details.

 You should have received a copy of the GNU General Public License
 along with this program; if not, write to the Free Software
 Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307, USA.

=head1 QUESTIONS

Questions on the usage of this program can be sent to the I<Squid Users mailing list <squid-users at lists.squid-cache.org>>

=head1 REPORTING BUGS

Bug reports need to be made in English.
See http://wiki.squid-cache.org/SquidFaq/BugReporting for details of what you need to include with your bug report.

Report bugs or bug fixes using http://bugs.squid-cache.org/

Report serious security bugs to I<Squid Bugs <squid-bugs at lists.squid-cache.org>>

Report ideas for new improvements to the I<Squid Developers mailing list <squid-dev at lists.squid-cache.org>>

=head1 SEE ALSO

squid (8), GPL (7),

The Squid wiki http://wiki.squid-cache.org/Features/StoreID

The Squid Configuration Manual http://www.squid-cache.org/Doc/config/

=cut

my @rules; # array of [regex, replacement string]

die "Usage: $0 <rewrite-file>\n" unless $#ARGV == 0;

# read config file
open RULES, $ARGV[0] or die "Error opening $ARGV[0]: $!";
while (<RULES>) {
    chomp;
    next if /^\s*#?$/;
    if (/^\s*([^\t]+?)\s*\t+\s*([^\t]+?)\s*$/) {
        push(@rules, [qr/$1/, $2]);
    } else {
        print STDERR "$0: Parse error in $ARGV[0] (line $.)\n";
    }
}
close RULES;

$|=1;
# read urls from squid and do the replacement
URL: while (<STDIN>) {
    chomp;
    last if $_ eq 'quit';

    my $channel = "";
    if (s/^(\d+\s+)//o) {
        $channel = $1;
    }

    foreach my $rule (@rules) {
        if (my @match = /$rule->[0]/) {
            $_ = $rule->[1];

            for (my $i=1; $i<=scalar(@match); $i++) {
                s/\$$i/$match[$i-1]/g;
            }
            print $channel, "OK store-id=$_\n";
            next URL;
        }
    }
    print $channel, "ERR\n";
}






-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20241231/dccaac8e/attachment.htm>

From jonathanlee571 at gmail.com  Tue Dec 31 23:06:46 2024
From: jonathanlee571 at gmail.com (Jonathan Lee)
Date: Tue, 31 Dec 2024 15:06:46 -0800
Subject: [squid-users] Thoughts on caching aspx jsp asp cgi-bin
In-Reply-To: <CALmccy6KaRu8y2kbtwBhngwFcKbi4L9q2Uag1p_45OUd5WO8vA@mail.gmail.com>
References: <B1A27C83-9CF6-48AF-940A-10B493FE4F7F@gmail.com>
 <9B993437-FC3B-417B-A7A7-89DB3AAB176C@gmail.com>
 <CALmccy6KaRu8y2kbtwBhngwFcKbi4L9q2Uag1p_45OUd5WO8vA@mail.gmail.com>
Message-ID: <56BE53E0-84A1-47D7-A30D-0E9A339F76F3@gmail.com>

Thanks I have to admit I am a student currently,

I guess my last question is what do cgi-bin asp aspx asp files do inside of websites? The reason I ask this is the rule below I have seen the same rule on different websites so it must be the main ones that cause issues. Is it just for dynamic content? 

> On Dec 31, 2024, at 14:47, Robin Wood <squid at digi.ninja> wrote:
> 
> I would say that it depends on what the dynamic content is. If it is public content from a CMS and you are OK with it potentially being your cache age out of date, then caching it rather than reloading it from the database every page load is fine. If the pages are for anything sensitive, for example a user's account, then definitely do not cache it.
> 
> Robin
> 
> On Tue, 31 Dec 2024 at 17:55, Jonathan Lee <jonathanlee571 at gmail.com <mailto:jonathanlee571 at gmail.com>> wrote:
>> What are your thoughts? This is in relation to ssl intercept with certificates installed and bump active.
>> 
>> Keep in mind I am still a student and learning.
>> 
>> Is a rule like this recommended? Does anyone have a better version of this?  
>> Sent from my iPhone
>> 
>>> On Dec 30, 2024, at 14:10, Jonathan Lee <jonathanlee571 at gmail.com <mailto:jonathanlee571 at gmail.com>> wrote:
>>> 
>>> ?Hello fellow Squid Users, 
>>> 
>>> Can you please help?
>>> 
>>> What are your thoughts on this rule? Should cgi-bin aspx and jsp files be excluded from the web-cache? They are dynamic correct? This could help speed up systems right?
>>> 
>>> 
>>> acl QUERY urlpath_regex cgi-bin \? asp aspx jsp
>>> 
>>> ## Prevent caching jsp, cgi-bin etc
>>> cache deny QUERY
>>> 
>>> Ref:
>>> Setting up Explicit Squid Proxy
>>> wiki.alpinelinux.org
>>> <favicon.png>
>>>  <https://wiki.alpinelinux.org/wiki/Setting_up_Explicit_Squid_Proxy>Setting up Explicit Squid Proxy <https://wiki.alpinelinux.org/wiki/Setting_up_Explicit_Squid_Proxy>
>>> wiki.alpinelinux.org <https://wiki.alpinelinux.org/wiki/Setting_up_Explicit_Squid_Proxy>	<favicon.png>
>>>  <https://wiki.alpinelinux.org/wiki/Setting_up_Explicit_Squid_Proxy>_______________________________________________
>> squid-users mailing list
>> squid-users at lists.squid-cache.org <mailto:squid-users at lists.squid-cache.org>
>> https://lists.squid-cache.org/listinfo/squid-users

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20241231/31821a71/attachment.htm>

