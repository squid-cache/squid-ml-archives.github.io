<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] StoreID Question
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20StoreID%20Question&In-Reply-To=%3CA865F380-002F-47E9-BC77-78B4AF604B80%40gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="027344.html">
   
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] StoreID Question</H1>
    <B>Jonathan Lee</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20StoreID%20Question&In-Reply-To=%3CA865F380-002F-47E9-BC77-78B4AF604B80%40gmail.com%3E"
       TITLE="[squid-users] StoreID Question">jonathanlee571 at gmail.com
       </A><BR>
    <I>Tue Dec 31 23:04:35 UTC 2024</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="027344.html">[squid-users] Thoughts on caching aspx jsp asp cgi-bin
</A></li>
        
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27343">[ date ]</a>
              <a href="thread.html#27343">[ thread ]</a>
              <a href="subject.html#27343">[ subject ]</a>
              <a href="author.html#27343">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello Fellow Squid Users,

Can you please help? I have been researching this for a long time and cannot find any information on this &quot;what is the $ mean&#8221; within StoreID?

Below is my failed attempt to make StoreID work correctly. Sorry it's a mess. I have since disabled my customized StoreID patterns because it caused issues. My question is with regard to the $number part of the program. I disabled all the facebook and all my tests because my photos where showing up wrong and it would duplicate itself over everything, I would have to clear the cache and change items and try again below is my failed attempt to get it to work correctly. 

It did work sometimes however I would get issues the longer it went on for. I decided to stop the trial and testing of it because it was driving me crazy. It is a great puzzle to solve. Does anyone have any tips? I have some Squid text books like the Squid the definitive guide, and The Squid Proxy Server 3.1 guide still nothing really explains StoreID outside of the Squid website. Yes the website comes with a great database that does work, I tested some database items with Ubuntu updates inside of VMs and it worked and reserved them to other machines asking for the same update. So in my quest I thought can I also do this with Facebook&#8230; (I do not recommend you try it) or something else, Youtube. 

This is the Text file I have been testing and it was a failed test outside of Ubuntu updates however I do not use that OS anymore so it is removed I think I had the $ wrong I have no info on what it does some are 1 some are 5 some are doubles $ and another of them:

^https?:\/\/(fbcdn|scontent).*(akamaihd|fbcdn)\.net\/.*\/v\/.*\/(.*\.mp4)		<A HREF="http://facebook.squid.internal/$3">http://facebook.squid.internal/$3</A>
^https?:\/\/fbcdn\-(static|profile)\-a\.akamaihd\.net\/static\-ak\/rsrc\.php\/((?!.*\.(?:js|css|swf)).*)	<A HREF="http://facebook.squid.internal/static/$2">http://facebook.squid.internal/static/$2</A>
^https?:\/\/(fbcdn|scontent).*(akamaihd|fbcdn)\.net\/(h|s)(profile|photos).*\/(.*\.(png|gif|jpg))(\?.+)? 	<A HREF="http://facebook.squid.internal/$5">http://facebook.squid.internal/$5</A>
^https?:\/\/fbstatic\-a\.akamaihd\.net\/rsrc\.php\/((?!.*\.(?:js|css|swf)).*) 	<A HREF="http://facebook.squid.internal/static/$1">http://facebook.squid.internal/static/$1</A>
^http:\/\/.*[steampowered|steamcontent]\.com\/([^?]*)	<A HREF="http://steamupdates.squid.internal/$1">http://steamupdates.squid.internal/$1</A>
^https?\:\/\/download\.oracle\.com\/((otn\-pub|otn)\/[\d\w]+\/[\d\w]+\/[\w\d\-]+\/[\w\d\-]+\.(exe|dmg|rpm|msi|tar\.(gz|Z)))\?	<A HREF="http://java.oracle.otn.ngtech.squid.internal/$1">http://java.oracle.otn.ngtech.squid.internal/$1</A>
^https?\:\/\/([\d\w\-]+)\.oracle\.com\/(([\d\w]+)\/[\d\w]+\/[\d\w]+\/([\d\w\-]+)\/([\d\w]+\/)?[\d\w\-\.\_]+\.(dmg|msi|exe|tar\.gz|tar\.Z))\?	<A HREF="http://java.oracle.download.ngtech.squid.internal/$2">http://java.oracle.download.ngtech.squid.internal/$2</A>
^http:\/\/[^\.]+\.phobos\.apple\.com\/(.*)	<A HREF="http://appupdates.apple.squid.internal/$1">http://appupdates.apple.squid.internal/$1</A>
^http:\/\/[^\.]+\.c\.android\.clients\.google\.com\/(.*)	<A HREF="http://androidupdates.google.squid.internal/$1">http://androidupdates.google.squid.internal/$1</A>

My question here is:
What does this $3 mean within the the store id program?

This is the config and refresh patterns that I was learning with for Squid StoreID. Much of it is &#8220;#&#8221;ed out but this is what I was using:

#store_id_program /usr/local/libexec/squid/storeid_file_rewrite /var/squid/storeid/storeid_rewrite.txt
#store_id_children 10 startup=5 idle=1 concurrency=0
#always_direct allow all
#store_id_access deny connect
#store_id_access deny !getmethod
#store_id_access allow rewritedoms
#store_id_access deny all

refresh_all_ims on
reload_into_ims on
max_stale 20 years
minimum_expiry_time 0

#refresh_pattern -i ^http.*squid\.internal.* 43200 100% 79900 override-expire override-lastmod ignore-reload ignore-no-store ignore-must-revalidate ignore-private ignore-auth

#FACEBOOK
#refresh_pattern ^https.*.facebook.com/* 10080 80% 43200

#FACEBOOK IMAGES  
#refresh_pattern -i pixel.facebook.com..(jpg|png|gif|ico|css|js|jpg?) 10080 80% 43200
#refresh_pattern -i .akamaihd.net..(jpg|png|gif|ico|css|js|jpg?) 10080 80% 43200 
#refresh_pattern -i facebook.com.(jpg|png|gif|jpg?) 10080 80% 43200 store-stale
#refresh_pattern static.(xx|ak).fbcdn.net.(jpg|gif|png|jpg?) 10080 80% 43200
#refresh_pattern ^https.*profile.ak.fbcdn.net.*(jpg|gif|png|jpg?) 10080 80% 43200
#refresh_pattern ^https.*fbcdn.net.*(jpg|gif|png|jpg?) 10080 80% 43200

#FACEBOOK VIDEO
#refresh_pattern -i .video.ak.fbcdn.net.*.(mp4|flv|mp3|amf) 10080 80% 43200
#refresh_pattern (audio|video)/(webm|mp4) 10080 80% 43200

#APPLE STUFF
#refresh_pattern -i apple.com/..(cab|exe|msi|msu|msf|asf|wmv|wma|dat|zip|dist)$ 0 80% 43200  refresh-ims

#apple update
#refresh_pattern -i (download|adcdownload).apple.com/.*\.(pkg|dmg) 4320 100% 43200
#refresh_pattern -i appldnld\.apple\.com 129600 100% 129600
#refresh_pattern -i phobos\.apple\.com 129600 100% 129600
#refresh_pattern -i iosapps\.itunes\.apple\.com 129600 100% 129600

refresh_pattern -i windowsupdate.com/.*\.(cab|exe|ms[i|u|f|p]|[ap]sf|wm[v|a]|dat|zip|psf) 43200 80% 129600 reload-into-ims
refresh_pattern -i microsoft.com/.*\.(cab|exe|ms[i|u|f|p]|[ap]sf|wm[v|a]|dat|zip|psf) 43200 80% 129600 reload-into-ims
refresh_pattern -i windows.com/.*\.(cab|exe|ms[i|u|f|p]|[ap]sf|wm[v|a]|dat|zip|psf) 43200 80% 129600 reload-into-ims
refresh_pattern -i microsoft.com.akadns.net/.*\.(cab|exe|ms[i|u|f|p]|[ap]sf|wm[v|a]|dat|zip|psf) 43200 80% 129600 reload-into-ims
refresh_pattern -i deploy.akamaitechnologies.com/.*\.(cab|exe|ms[i|u|f|p]|[ap]sf|wm[v|a]|dat|zip|psf) 43200 80% 129600 reload-into-ims

# Updates: Windows
#refresh_pattern -i microsoft.com/..(cab|exe|msi|msu|msf|asf|wma|dat|zip)$ 4320 80% 43200  refresh-ims
refresh_pattern -i windowsupdate.com/..(cab|exe|msi|msu|msf|asf|wma|wmv)|dat|zip)$ 4320 80% 43200  refresh-ims
#refresh_pattern -i windows.com/..(cab|exe|msi|msu|msf|asf|wmv|wma|dat|zip)$ 4320 80% 43200  refresh-ims
#refresh_pattern -i microsoft.com/.*\.(cab|exe|ms[i|u|f]|[ap]sf|wm[v|a]|dat|zip) 4320 80% 43200 
#refresh_pattern -i windowsupdate.com/.*\.(cab|exe|ms[i|u|f]|[ap]sf|wm[v|a]|dat|zip) 4320 80% 43200 
#refresh_pattern -i windows.com/.*\.(cab|exe|ms[i|u|f]|[ap]sf|wm[v|a]|dat|zip) 4320 80% 43200 
#refresh_pattern -i .*windowsupdate.com/.*\.(cab|exe) 259200 100% 259200   
#refresh_pattern -i .*update.microsoft.com/.*\.(cab|exe|dll|msi|psf) 259200 100% 259200   
#refresh_pattern windowsupdate.com/.*\.(cab|exe|dll|msi|psf) 10080 100% 43200 
#refresh_pattern download.microsoft.com/.*\.(cab|exe|dll|msi|psf) 10080 100% 43200 
#refresh_pattern www.microsoft.com/.*\.(cab|exe|dll|msi|psf) 10080 100% 43200 
#refresh_pattern au.download.windowsupdate.com/.*\.(cab|exe|dll|msi|psf) 4320 100% 43200 
#refresh_pattern bg.v4.pr.dl.ws.microsoft.com/.*\.(cab|exe|dll|msi|psf) 4320 100% 43200
#windows update NEW UPDATE 0.04
#refresh_pattern update.microsoft.com/.*\.(cab|exe) 43200 100% 129600    
#refresh_pattern ([^.]+\.)?(download|(windows)?update)\.(microsoft\.)?com/.*\.(cab|exe|msi|msp|psf) 4320 100% 43200  
#refresh_pattern update.microsoft.com/.*\.(cab|exe|dll|msi|psf) 10080 100% 43200 
#refresh_pattern -i \.update.microsoft.com/.*\.(cab|exe|ms[i|u|f]|[ap]sf|wm[v|a]|dat|zip) 525600 100% 525600       
#refresh_pattern -i \.windowsupdate.com/.*\.(cab|exe|ms[i|u|f]|[ap]sf|wm[v|a]|dat|zip) 525600 100% 525600       
#refresh_pattern -i \.download.microsoft.com/.*\.(cab|exe|ms[i|u|f]|[ap]sf|wm[v|a]|dat|zip) 525600 100% 525600       
#refresh_pattern -i \.ws.microsoft.com/.*\.(cab|exe|ms[i|u|f]|[ap]sf|wm[v|a]|dat|zip) 525600 100% 525600       
    
#refresh_pattern ([^.]+\.)?(cs|content[1-9]|hsar|content-origin|client-download).[steampowered|steamcontent].com/.*\.* 43200 100% 43200     
#refresh_pattern ([^.]+\.)?.akamai.steamstatic.com/.*\.* 43200 100% 43200

#refresh_pattern -i ([^.]+\.)?.adobe.com/.*\.(zip|exe) 43200 100% 43200
#refresh_pattern -i ([^.]+\.)?.java.com/.*\.(zip|exe) 43200 100% 43200
#refresh_pattern -i ([^.]+\.)?.sun.com/.*\.(zip|exe) 43200 100% 43200
#refresh_pattern -i ([^.]+\.)?.oracle.com/.*\.(zip|exe|tar.gz) 43200 100% 43200

#refresh_pattern -i appldnld\.apple\.com 43200 100% 43200
#refresh_pattern -i ([^.]+\.)?apple.com/.*\.(ipa) 43200 100% 43200
 
#refresh_pattern -i ([^.]+\.)?.google.com/.*\.(exe|crx) 10080 80% 43200
#refresh_pattern -i ([^.]+\.)?g.static.com/.*\.(exe|crx) 10080 80% 43200

acl https_login url_regex -i ^https.*(login|Login).*
cache deny https_login

#range_offset_limit 512 MB windowsupdate
range_offset_limit 0 !windowsupdate
quick_abort_min -1 KB


Store ID program:

I am using the built in program attached here..
/usr/local/libexec/squid/storeid_file_rewrite
#!/usr/local/bin/perl

use strict;
use warnings;
use Pod::Usage;

=pod

=head1 NAME

 storeid_file_rewrite - File based Store-ID helper for Squid

=head1 SYNOPSIS

 storeid_file_rewrite filepath

=head1 DESCRIPTION

This program acts as a store_id helper program, rewriting URLs passed
by Squid into storage-ids that can be used to achieve better caching
for websites that use different URLs for the same content.

It takes a text file with two tab separated columns.
Column 1: Regular expression to match against the URL
Column 2: Rewrite rule to generate a Store-ID
Eg:
^http:\/\/[^\.]+\.dl\.sourceforge\.net\/(.*)    <A HREF="http://dl.sourceforge.net.squid.internal/$1">http://dl.sourceforge.net.squid.internal/$1</A>

Rewrite rules are matched in the same order as they appear in the rules file.
So for best performance, sort it in order of frequency of occurrence.

This program will automatically detect the existence of a concurrency channel-ID and adjust appropriately.
It may be used with any value 0 or above for the store_id_children concurrency= parameter.

=head1 OPTIONS

The only command line parameter this helper takes is the regex rules file name.

=head1 AUTHOR

This program and documentation was written by I&lt;Alan Mizrahi &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">alan at mizrahi.com.ve</A>&gt;&gt;

Based on prior work by I&lt;Eliezer Croitoru &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">eliezer at ngtech.co.il</A>&gt;&gt;

=head1 COPYRIGHT

 * Copyright (C) 1996-2023 The Squid Software Foundation and contributors
 *
 * Squid software is distributed under GPLv2+ license and includes
 * contributions from numerous individuals and organizations.
 * Please see the COPYING and CONTRIBUTORS files for details.

 Copyright (C) 2013 Alan Mizrahi &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">alan at mizrahi.com.ve</A>&gt;
 Based on code from Eliezer Croitoru &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">eliezer at ngtech.co.il</A>&gt;

 This program is free software; you can redistribute it and/or modify
 it under the terms of the GNU General Public License as published by
 the Free Software Foundation; either version 2 of the License, or
 (at your option) any later version.

 This program is distributed in the hope that it will be useful,
 but WITHOUT ANY WARRANTY; without even the implied warranty of
 MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 GNU General Public License for more details.

 You should have received a copy of the GNU General Public License
 along with this program; if not, write to the Free Software
 Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307, USA.

=head1 QUESTIONS

Questions on the usage of this program can be sent to the I&lt;Squid Users mailing list &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>&gt;&gt;

=head1 REPORTING BUGS

Bug reports need to be made in English.
See <A HREF="http://wiki.squid-cache.org/SquidFaq/BugReporting">http://wiki.squid-cache.org/SquidFaq/BugReporting</A> for details of what you need to include with your bug report.

Report bugs or bug fixes using <A HREF="http://bugs.squid-cache.org/">http://bugs.squid-cache.org/</A>

Report serious security bugs to I&lt;Squid Bugs &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-bugs at lists.squid-cache.org</A>&gt;&gt;

Report ideas for new improvements to the I&lt;Squid Developers mailing list &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-dev at lists.squid-cache.org</A>&gt;&gt;

=head1 SEE ALSO

squid (8), GPL (7),

The Squid wiki <A HREF="http://wiki.squid-cache.org/Features/StoreID">http://wiki.squid-cache.org/Features/StoreID</A>

The Squid Configuration Manual <A HREF="http://www.squid-cache.org/Doc/config/">http://www.squid-cache.org/Doc/config/</A>

=cut

my @rules; # array of [regex, replacement string]

die &quot;Usage: $0 &lt;rewrite-file&gt;\n&quot; unless $#ARGV == 0;

# read config file
open RULES, $ARGV[0] or die &quot;Error opening $ARGV[0]: $!&quot;;
while (&lt;RULES&gt;) {
    chomp;
    next if /^\s*#?$/;
    if (/^\s*([^\t]+?)\s*\t+\s*([^\t]+?)\s*$/) {
        push(@rules, [qr/$1/, $2]);
    } else {
        print STDERR &quot;$0: Parse error in $ARGV[0] (line $.)\n&quot;;
    }
}
close RULES;

$|=1;
# read urls from squid and do the replacement
URL: while (&lt;STDIN&gt;) {
    chomp;
    last if $_ eq 'quit';

    my $channel = &quot;&quot;;
    if (s/^(\d+\s+)//o) {
        $channel = $1;
    }

    foreach my $rule (@rules) {
        if (my @match = /$rule-&gt;[0]/) {
            $_ = $rule-&gt;[1];

            for (my $i=1; $i&lt;=scalar(@match); $i++) {
                s/\$$i/$match[$i-1]/g;
            }
            print $channel, &quot;OK store-id=$_\n&quot;;
            next URL;
        }
    }
    print $channel, &quot;ERR\n&quot;;
}






-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20241231/dccaac8e/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20241231/dccaac8e/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="027344.html">[squid-users] Thoughts on caching aspx jsp asp cgi-bin
</A></li>
	
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27343">[ date ]</a>
              <a href="thread.html#27343">[ thread ]</a>
              <a href="subject.html#27343">[ subject ]</a>
              <a href="author.html#27343">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
