<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] stale-if-error returning a 502
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20stale-if-error%20returning%20a%20502&In-Reply-To=%3CCANOuv9oUdha%2Bv1oUTwY%2BkE1xV9bidp_G3ynyiqOfsAdXqWB3Dw%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="026409.html">
   <LINK REL="Next"  HREF="026411.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] stale-if-error returning a 502</H1>
    <B>Robin Carlisle</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20stale-if-error%20returning%20a%20502&In-Reply-To=%3CCANOuv9oUdha%2Bv1oUTwY%2BkE1xV9bidp_G3ynyiqOfsAdXqWB3Dw%40mail.gmail.com%3E"
       TITLE="[squid-users] stale-if-error returning a 502">robin.carlisle at framestore.com
       </A><BR>
    <I>Thu Feb  1 17:03:38 UTC 2024</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="026409.html">[squid-users] does the logging of cache.log support the log modules like daemon, syslog, udp ...
</A></li>
        <LI>Next message (by thread): <A HREF="026411.html">[squid-users] stale-if-error returning a 502
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26410">[ date ]</a>
              <a href="thread.html#26410">[ thread ]</a>
              <a href="subject.html#26410">[ subject ]</a>
              <a href="author.html#26410">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi, I am having trouble with stale-if-error response.  I am making calls
using curl to an API (under my control) on Amazon AWS.  Config and details
below ...


# /etc/squid/squid.conf :

acl to_aws dstdomain .amazonaws.com

acl from_local src localhost

http_access allow to_aws

http_access allow from_local

cache allow all

cache_dir ufs /var/cache/squid 1024 16 256

http_port 3129 ssl-bump cert=/etc/squid/maul.pem
generate-host-certificates=on dynamic_cert_mem_cache_size=4MB

sslcrtd_program /usr/lib/squid/security_file_certgen -s
/var/lib/squid/ssl_db -M 4MB

acl step1 at_step SslBump1

ssl_bump bump step1

ssl_bump bump all

sslproxy_cert_error deny all

cache_store_log stdio:/var/log/squid/store.log

logfile_rotate 0

shutdown_lifetime 3 seconds

# /usr/bin/proxy-test :

#!/bin/bash

curl --proxy <A HREF="http://localhost:3129">http://localhost:3129</A> \

  --cacert /etc/squid/stuff.pem \

  -v &quot;<A HREF="https://stuff.amazonaws.com/api/v1/stuff/stuff.json">https://stuff.amazonaws.com/api/v1/stuff/stuff.json</A>&quot; \

  -H &quot;Authorization: token MYTOKEN&quot; \

  -H &quot;Content-Type: application/json&quot; \

  --output &quot;/tmp/stuff.json&quot;


Tests  ..........

At this point in time the network cable is unattached.  Squid returns the
cached object it got when the network was online earlier. The Age of this
object is just still under the max_age of 3600.     Previously I was using
offline_mode but I found that it did not try to revalidate from the origin
after the object expired (defined via max-age response).   My understanding
is that stale-if-error should work under my circumstances.

# /var/log/squid/access.log

1706799404.440      6 127.0.0.1 NONE_NONE/200 0 CONNECT
stuff.amazonaws.com:443 - HIER_NONE/- -

1706799404.440      0 127.0.0.1 TCP_MEM_HIT/200 20726 GET
<A HREF="https://stuff.amazonaws.com/stuff.json">https://stuff.amazonaws.com/stuff.json</A> - HIER_NONE/- application/json

# extract from /usr/bin/proxy-test

&lt; HTTP/1.1 200 OK

&lt; Date: Thu, 01 Feb 2024 13:57:11 GMT

&lt; Content-Type: application/json

&lt; Content-Length: 20134

&lt; x-amzn-RequestId: 3a2d3b26-df73-4b30-88cb-1a9268fa0df2

&lt; Last-Modified: 2024-02-01T13:00:45.000Z

&lt; Access-Control-Allow-Origin: *

&lt; x-amz-apigw-id: SdZwpG7qiYcERUQ=

&lt; Cache-Control: public, max-age=3600, stale-if-error=31536000

&lt; ETag: &quot;cec102b43372840737ab773c2e77858b&quot;

&lt; X-Amzn-Trace-Id: Root=1-65bba337-292be751134161b03555cdd6

&lt; Age: 3573

&lt; X-Cache: HIT from labs-maul-st-31

&lt; X-Cache-Lookup: HIT from labs-maul-st-31:3129

&lt; Via: 1.1 labs-maul-st-31 (squid/5.7)

&lt; Connection: keep-alive



Below .. the curl script executes again.  The Age has gone over the max-age
so squid attempted to refresh from the origin.  The machine is still
offline so the refresh failed.   I expected that the stale-if-error
response would instruct squid to return the cached object as a 200.

# /var/log/squid/access.log

1706799434.464      5 127.0.0.1 NONE_NONE/200 0 CONNECT
stuff.amazonaws.com:443 - HIER_NONE/- -

1706799434.464      0 127.0.0.1 TCP_REFRESH_FAIL_ERR/502 4235 GET
<A HREF="https://stuff.amazonaws.com/stuff.json">https://stuff.amazonaws.com/stuff.json</A> - HIER_NONE/- text/html

# extract from /usr/bin/proxy-test

&lt; HTTP/1.1 502 Bad Gateway

&lt; Server: squid/5.7

&lt; Mime-Version: 1.0

&lt; Date: Thu, 01 Feb 2024 14:57:14 GMT

&lt; Content-Type: text/html;charset=utf-8

&lt; Content-Length: 3853

&lt; X-Squid-Error: ERR_READ_ERROR 0

&lt; Vary: Accept-Language

&lt; Content-Language: en

&lt; X-Cache: MISS from labs-maul-st-31

&lt; X-Cache-Lookup: HIT from labs-maul-st-31:3129

&lt; Via: 1.1 labs-maul-st-31 (squid/5.7)

&lt; Connection: close


Hope someone can help me with this.  All the best,

Robin Carlisle
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20240201/5e93b7bd/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20240201/5e93b7bd/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="026409.html">[squid-users] does the logging of cache.log support the log modules like daemon, syslog, udp ...
</A></li>
	<LI>Next message (by thread): <A HREF="026411.html">[squid-users] stale-if-error returning a 502
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26410">[ date ]</a>
              <a href="thread.html#26410">[ thread ]</a>
              <a href="subject.html#26410">[ subject ]</a>
              <a href="author.html#26410">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
