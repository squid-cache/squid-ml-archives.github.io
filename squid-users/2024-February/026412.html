<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] stale-if-error returning a 502
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20stale-if-error%20returning%20a%20502&In-Reply-To=%3CCANOuv9rsG%2BA%2BMN77E4AadTFm4OxzJcMkmZ4FQWuTTi8vJvzaLA%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="026411.html">
   <LINK REL="Next"  HREF="026435.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] stale-if-error returning a 502</H1>
    <B>Robin Carlisle</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20stale-if-error%20returning%20a%20502&In-Reply-To=%3CCANOuv9rsG%2BA%2BMN77E4AadTFm4OxzJcMkmZ4FQWuTTi8vJvzaLA%40mail.gmail.com%3E"
       TITLE="[squid-users] stale-if-error returning a 502">robin.carlisle at framestore.com
       </A><BR>
    <I>Fri Feb  2 11:20:33 UTC 2024</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="026411.html">[squid-users] stale-if-error returning a 502
</A></li>
        <LI>Next message (by thread): <A HREF="026435.html">[squid-users] stale-if-error returning a 502
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26412">[ date ]</a>
              <a href="thread.html#26412">[ thread ]</a>
              <a href="subject.html#26412">[ subject ]</a>
              <a href="author.html#26412">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi, thanks for your reply.

I have been looking at :
<A HREF="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Cache-Control">https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Cache-Control</A>






*The stale-if-error response directive indicates that the cache can reuse a
stale response when an upstream server generates an error, or when the
error is generated locally. Here, an error is considered any response with
a status code of 500, 502, 503, or 504.Cache-Control: max-age=604800,
stale-if-error=86400In the example above, the response is fresh for 7 days
(604800s). Afterwards, it becomes stale, but can be used for an extra 1 day
(86400s) when an error is encountered.After the stale-if-error period
passes, the client will receive any error generated*

Given what you have said and what the above docs say - I am still confused
as it looks like (in my test cases) the cached response can be used for
3600 secs (this works), after which the cached response can still be used
for an additional 31536000 seconds on an error (this doesnt work).

I am going to dig into the error logging you suggested to see if I can make
sense of that - and will send on if I can't.

Thanks v much for your help again,

Robin





On Thu, 1 Feb 2024 at 18:27, Alex Rousskov &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt;
wrote:

&gt;<i> On 2024-02-01 12:03, Robin Carlisle wrote:
</I>&gt;<i> &gt; Hi, I am having trouble with stale-if-error response.
</I>&gt;<i>
</I>&gt;<i> If I am interpreting Squid code correctly, in primary use cases:
</I>&gt;<i>
</I>&gt;<i> * without a Cache-Control:stale-if-error=X in the original response,
</I>&gt;<i> Squid sends a stale object if revalidation results in a 5xx error;
</I>&gt;<i>
</I>&gt;<i> * with a Cache-Control:stale-if-error=X and object age at most X, Squid
</I>&gt;<i> sends a stale object if revalidation results in a 5xx error;
</I>&gt;<i>
</I>&gt;<i> * with a Cache-Control:stale-if-error=X and object age exceeding X,
</I>&gt;<i> Squid forwards the 5xx error response if revalidation results in a 5xx
</I>&gt;<i> error;
</I>&gt;<i>
</I>&gt;<i> In other words, stale-if-error=X turns on a &quot;fail on validation errors&quot;
</I>&gt;<i> behavior for stale objects older than X. It has no other effects.
</I>&gt;<i>
</I>&gt;<i> In your test case, the stale objects are much younger than
</I>&gt;<i> stale-if-error value (e.g., Age~=3601 vs. stale-if-error=31536000).
</I>&gt;<i> Thus, stale-if-error should have no relevant effect.
</I>&gt;<i>
</I>&gt;<i> Something else is probably preventing your Squid from serving the stale
</I>&gt;<i> response when facing a 5xx error. I do not know what that something is.
</I>&gt;<i>
</I>&gt;<i> I recommend sharing (privately if you need to protect sensitive info) a
</I>&gt;<i> pointer to a compressed ALL,9 cache.log collected while reproducing the
</I>&gt;<i> problem (using two transactions similar to the ones you have shared
</I>&gt;<i> below -- a successful stale hit and a problematic one):
</I>&gt;<i>
</I>&gt;<i> <A HREF="https://wiki.squid-cache.org/SquidFaq/BugReporting#debugging-a-single-transaction">https://wiki.squid-cache.org/SquidFaq/BugReporting#debugging-a-single-transaction</A>
</I>&gt;<i>
</I>&gt;<i> Alternatively, you can try to study cache.log yourself after setting
</I>&gt;<i> debug_options to ALL,3. Searching for &quot;refresh&quot; and &quot;handleIMSReply&quot; may
</I>&gt;<i> yield enough clues.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> HTH,
</I>&gt;<i>
</I>&gt;<i> Alex.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; # /etc/squid/squid.conf :
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; acl to_aws dstdomain .amazonaws.com &lt;<A HREF="http://amazonaws.com">http://amazonaws.com</A>&gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; acl from_local src localhost
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; http_access allow to_aws
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; http_access allow from_local
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; cache allow all
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; cache_dir ufs /var/cache/squid 1024 16 256
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; http_port 3129 ssl-bump cert=/etc/squid/maul.pem
</I>&gt;<i> &gt; generate-host-certificates=on dynamic_cert_mem_cache_size=4MB
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; sslcrtd_program /usr/lib/squid/security_file_certgen -s
</I>&gt;<i> &gt; /var/lib/squid/ssl_db -M 4MB
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; acl step1 at_step SslBump1
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; ssl_bump bump step1
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; ssl_bump bump all
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; sslproxy_cert_error deny all
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; cache_store_log stdio:/var/log/squid/store.log
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; logfile_rotate 0
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; shutdown_lifetime 3 seconds
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; # /usr/bin/proxy-test :
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; #!/bin/bash
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; curl --proxy <A HREF="http://localhost:3129">http://localhost:3129</A> &lt;<A HREF="http://localhost:3129">http://localhost:3129</A>&gt; \
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;    --cacert /etc/squid/stuff.pem \
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;    -v &quot;<A HREF="https://stuff.amazonaws.com/api/v1/stuff/stuff.json">https://stuff.amazonaws.com/api/v1/stuff/stuff.json</A>
</I>&gt;<i> &gt; &lt;<A HREF="https://stuff.amazonaws.com/api/v1/stuff/stuff.json">https://stuff.amazonaws.com/api/v1/stuff/stuff.json</A>&gt;&quot; \
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;    -H &quot;Authorization: token MYTOKEN&quot; \
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;    -H &quot;Content-Type: application/json&quot; \
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;    --output &quot;/tmp/stuff.json&quot;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Tests  ..........
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; At this point in time the network cable is unattached.  Squid returns
</I>&gt;<i> &gt; the cached object it got when the network was online earlier. The Age of
</I>&gt;<i> &gt; this object is just still under the max_age of 3600.     Previously I
</I>&gt;<i> &gt; was using offline_mode but I found that it did not try to revalidate
</I>&gt;<i> &gt; from the origin after the object expired (defined via max-age response).
</I>&gt;<i> &gt;    My understanding is that stale-if-error should work under my
</I>&gt;<i> &gt; circumstances.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; # /var/log/squid/access.log
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; 1706799404.440      6 127.0.0.1 NONE_NONE/200 0 CONNECT
</I>&gt;<i> &gt; stuff.amazonaws.com:443 &lt;<A HREF="http://stuff.amazonaws.com:443">http://stuff.amazonaws.com:443</A>&gt; - HIER_NONE/- -
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; 1706799404.440      0 127.0.0.1 TCP_MEM_HIT/200 20726 GET
</I>&gt;<i> &gt; <A HREF="https://stuff.amazonaws.com/stuff.json">https://stuff.amazonaws.com/stuff.json</A>
</I>&gt;<i> &gt; &lt;<A HREF="https://stuff.amazonaws.com/stuff.json">https://stuff.amazonaws.com/stuff.json</A>&gt; - HIER_NONE/- application/json
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; # extract from /usr/bin/proxy-test
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; &lt; HTTP/1.1 200 OK
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; &lt; Date: Thu, 01 Feb 2024 13:57:11 GMT
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; &lt; Content-Type: application/json
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; &lt; Content-Length: 20134
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; &lt; x-amzn-RequestId: 3a2d3b26-df73-4b30-88cb-1a9268fa0df2
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; &lt; Last-Modified: 2024-02-01T13:00:45.000Z
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; &lt; Access-Control-Allow-Origin: *
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; &lt; x-amz-apigw-id: SdZwpG7qiYcERUQ=
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; &lt; Cache-Control: public, max-age=3600, stale-if-error=31536000
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; &lt; ETag: &quot;cec102b43372840737ab773c2e77858b&quot;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; &lt; X-Amzn-Trace-Id: Root=1-65bba337-292be751134161b03555cdd6
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; &lt; Age: 3573
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; &lt; X-Cache: HIT from labs-maul-st-31
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; &lt; X-Cache-Lookup: HIT from labs-maul-st-31:3129
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; &lt; Via: 1.1 labs-maul-st-31 (squid/5.7)
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; &lt; Connection: keep-alive
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Below .. the curl script executes again.  The Age has gone over the
</I>&gt;<i> &gt; max-age so squid attempted to refresh from the origin.  The machine is
</I>&gt;<i> &gt; still offline so the refresh failed.   I expected that the
</I>&gt;<i> &gt; stale-if-error response would instruct squid to return the cached object
</I>&gt;<i> &gt; as a 200.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; # /var/log/squid/access.log
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; 1706799434.464      5 127.0.0.1 NONE_NONE/200 0 CONNECT
</I>&gt;<i> &gt; stuff.amazonaws.com:443 &lt;<A HREF="http://stuff.amazonaws.com:443">http://stuff.amazonaws.com:443</A>&gt; - HIER_NONE/- -
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; 1706799434.464      0 127.0.0.1 TCP_REFRESH_FAIL_ERR/502 4235 GET
</I>&gt;<i> &gt; <A HREF="https://stuff.amazonaws.com/stuff.json">https://stuff.amazonaws.com/stuff.json</A>
</I>&gt;<i> &gt; &lt;<A HREF="https://stuff.amazonaws.com/stuff.json">https://stuff.amazonaws.com/stuff.json</A>&gt; - HIER_NONE/- text/html
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; # extract from /usr/bin/proxy-test
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; &lt; HTTP/1.1 502 Bad Gateway
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; &lt; Server: squid/5.7
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; &lt; Mime-Version: 1.0
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; &lt; Date: Thu, 01 Feb 2024 14:57:14 GMT
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; &lt; Content-Type: text/html;charset=utf-8
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; &lt; Content-Length: 3853
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; &lt; X-Squid-Error: ERR_READ_ERROR 0
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; &lt; Vary: Accept-Language
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; &lt; Content-Language: en
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; &lt; X-Cache: MISS from labs-maul-st-31
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; &lt; X-Cache-Lookup: HIT from labs-maul-st-31:3129
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; &lt; Via: 1.1 labs-maul-st-31 (squid/5.7)
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; &lt; Connection: close
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Hope someone can help me with this.  All the best,
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Robin Carlisle
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; _______________________________________________
</I>&gt;<i> &gt; squid-users mailing list
</I>&gt;<i> &gt; <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> &gt; <A HREF="https://lists.squid-cache.org/listinfo/squid-users">https://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">https://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20240202/ca911108/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20240202/ca911108/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="026411.html">[squid-users] stale-if-error returning a 502
</A></li>
	<LI>Next message (by thread): <A HREF="026435.html">[squid-users] stale-if-error returning a 502
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26412">[ date ]</a>
              <a href="thread.html#26412">[ thread ]</a>
              <a href="subject.html#26412">[ subject ]</a>
              <a href="author.html#26412">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
