<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] external icap issue with squid 5 and higher
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20external%20icap%20issue%20with%20squid%205%20and%20higher&In-Reply-To=%3CDB9PR07MB9809F5E68F411A1C1C5E240C9C472%40DB9PR07MB9809.eurprd07.prod.outlook.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="026419.html">
   <LINK REL="Next"  HREF="026421.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] external icap issue with squid 5 and higher</H1>
    <B>Yvain PAYEN</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20external%20icap%20issue%20with%20squid%205%20and%20higher&In-Reply-To=%3CDB9PR07MB9809F5E68F411A1C1C5E240C9C472%40DB9PR07MB9809.eurprd07.prod.outlook.com%3E"
       TITLE="[squid-users] external icap issue with squid 5 and higher">yvain.payen at tessi.fr
       </A><BR>
    <I>Mon Feb  5 09:38:11 UTC 2024</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="026419.html">[squid-users] external icap issue with squid 5 and higher
</A></li>
        <LI>Next message (by thread): <A HREF="026421.html">[squid-users] New Squid prefers IPv4
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26420">[ date ]</a>
              <a href="thread.html#26420">[ thread ]</a>
              <a href="subject.html#26420">[ subject ]</a>
              <a href="author.html#26420">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello Alex,

Thank you so much for your time and this detailed analysis.

We will get back to the Forcepoint editor and ask for a correction.

Best regards,

Yvain PAYEN

P&#244;le Op&#233;rations &amp; Technologies
Equipe Infrastructure syst&#232;me
T. +33 (0)5 57 57 01 85 (Poste 1185)
M. +33 (0)7 87 30 34 01

Absent tous les mercredi

Tessi France
Immeuble Cassiop&#233;e
1-3 avenue des Satellites
33185 Le Haillan

Pensez &#224; l'environnement avant d'imprimer cet e-mail.

-----Message d'origine-----
De&#160;: Alex Rousskov &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt; 
Envoy&#233;&#160;: samedi 3 f&#233;vrier 2024 04:32
&#192;&#160;: Yvain PAYEN &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">yvain.payen at tessi.fr</A>&gt;; <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
Objet&#160;: Re: [squid-users] external icap issue with squid 5 and higher

&#9888; FR : Ce message provient de l'ext&#233;rieur de l'organisation. N'ouvrez pas de liens ou de pi&#232;ces jointes &#224; moins que vous ne sachiez que le contenu est fiable.  &#9888;



On 2024-02-02 17:36, Yvain PAYEN wrote:

&gt;<i> I just sent you a Onedrive link to 2 pcap files, one for http request 
</I>&gt;<i> and one for https request.
</I>
Thank you. The ICAP service you are using is sending a malformed ICAP response to Squid. That ICAP response promises that there will be no HTTP body in the encapsulated HTTP message:

     Encapsulated: res-hdr=0, null-body=524

... but the service does send a body after HTTP headers. That HTTP body contains an HTML resource explaining that the CONNECT message was blocked and redirecting the user to blockpage.cgi, but that content does not really matter here. What matters is that there are some bytes after the encapsulated HTTP header. There should be no such bytes (or the ICAP Encapsulated header should have res-body=184 instead of null-body=524).

The null-body offset in the ICAP Encapsulated header is wrong. It should be 184 bytes (i.e. the size of the encapsulated HTTP response header), not 524 bytes. FWIW, 524 is the sum of the encapsulated HTTP response header (184 bytes) and the encapsulated HTTP response body (340 bytes).
It sounds like the ICAP service thinks that it is encapsulating an HTTP response header, but it is actually encapsulating the whole HTTP response.

Since this is an ICAP framing error(s), Squid rejects the whole transaction and bypasses the ICAP service (as configured).

To fix this, fix the ICAP service configuration (or code).

It is also possible to modify Squid code to ignore these errors, but I do not recommend that, and a hard-coded or rigid tolerance code like that should not be accepted by the Squid Project for the official inclusion.


The ICAP response in the &quot;http request&quot; capture does not have this problem. It contains an encapsulated HTTP 302 Moved header without any encapsulated HTTP body. That encapsulation matches the ICAP Encapsulated header.


HTH,

Alex.



&gt;<i> -----Message d'origine-----
</I>&gt;<i> De : Alex Rousskov &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt;
</I>&gt;<i> Envoy&#233; : vendredi 2 f&#233;vrier 2024 18:45 &#192; : Yvain PAYEN 
</I>&gt;<i> &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">yvain.payen at tessi.fr</A>&gt;; <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A> Objet : Re: 
</I>&gt;<i> [squid-users] external icap issue with squid 5 and higher
</I>&gt;<i>
</I>&gt;<i> &#9888; FR : Ce message provient de l'ext&#233;rieur de l'organisation. N'ouvrez 
</I>&gt;<i> pas de liens ou de pi&#232;ces jointes &#224; moins que vous ne sachiez que le 
</I>&gt;<i> contenu est fiable.  &#9888;
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> On 2024-02-02 12:04, Yvain PAYEN wrote:
</I>&gt;<i>
</I>&gt;&gt;<i> We don't use ssl_bump, icap service only analyze HTTP CONNECT 
</I>&gt;&gt;<i> requests
</I>&gt;<i>
</I>&gt;<i> Great, that simplifies things a lot.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> Adaptation::Icap::Xaction::noteCommRead threw exception: &gt; check
</I>&gt;&gt;<i> failed: readBuf.isEmpty()&gt; exception location: ModXact.cc(1219)
</I>&gt;<i> stopParsing
</I>&gt;<i>
</I>&gt;<i> It looks like Squid found some leftovers after the ICAP response that Squid (thought it) had fully parsed. I do not yet know whether that ICAP response was malformed or Squid is buggy.
</I>&gt;<i>
</I>&gt;<i> Can you share raw ICAP response bytes (preferrably in libpcap or similar raw packet capture format) collected by tcpdump, wireshark, or a similar tool? You can obfuscate/convert that ICAP response to text as needed, but if those extra bytes get lost in those conversions, then we would not be able to tell what those bytes are (e.g., they may contain whitespace characters that get easily lost).
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Thank you,
</I>&gt;<i>
</I>&gt;<i> Alex.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i>        2024/02/02 17:40:41.943 kid1| 93,3| ModXact.cc(679) callException: bypassing 0x558f358fdae0*2 exception: check failed: readBuf.isEmpty()
</I>&gt;&gt;<i>                exception location: ModXact.cc(1219) stopParsing  [FD 17;rp(1)S(2)YG/Rw job17]
</I>&gt;&gt;<i>        2024/02/02 17:40:41.943 kid1| 93,7| ModXact.cc(720) disableBypass: will never start bypass because already started to bypass
</I>&gt;&gt;<i>        2024/02/02 17:40:41.943 kid1| 93,5| Xaction.cc(127) disableRepeats: Adaptation::Icap::ModXact still cannot be repeated because preparing to echo content [FD    17;rp(1)S(2)G/Rw job17]
</I>&gt;&gt;<i>        2024/02/02 17:40:41.943 kid1| 93,7| ModXact.cc(724) disableBypass: not protecting group bypass because preparing to echo content
</I>&gt;&gt;<i>        2024/02/02 17:40:41.943 kid1| 93,3| Xaction.cc(564) setOutcome: WARNING: resetting outcome: from ICAP_SAT to ICAP_ECHO
</I>&gt;&gt;<i>        2024/02/02 17:40:41.943 kid1| 93,7| ModXact.cc(962) prepEchoing: cloning virgin message 0x558f358ff040
</I>&gt;&gt;<i>        2024/02/02 17:40:41.943 kid1| 93,3| Xaction.cc(564) setOutcome: WARNING: resetting outcome: from ICAP_ECHO to ICAP_ERR_OTHER
</I>&gt;&gt;<i>        2024/02/02 17:40:41.943 kid1| 93,4| ServiceRep.cc(97) noteFailure:  failure 1 out of 10 allowed in 0sec [up,fail1]
</I>&gt;&gt;<i>        2024/02/02 17:40:41.943 kid1| 93,2| AsyncJob.cc(130) callException: check failed: !adapted.header
</I>&gt;&gt;<i>                 exception location: ModXact.cc(971) prepEchoing
</I>&gt;&gt;<i>        2024/02/02 17:40:41.943 kid1| 93,5| AsyncJob.cc(85) mustStop: Adaptation::Icap::ModXact will stop, reason: exception
</I>&gt;&gt;<i>        2024/02/02 17:40:41.943 kid1| 93,5| AsyncJob.cc(140) callEnd: Adaptation::Icap::Xaction::noteCommRead(conn8 local=X.X.X.X:46704 remote=X.X.X.X:1344 FD  17 flags=1, data=0x558f358fe888) ends job [FD 17;rp(1)S(2)/StoppedRw job17]
</I>&gt;&gt;<i>        2024/02/02 17:40:41.943 kid1| 93,5| ModXact.cc(1295) swanSong: swan sings [FD 17;rp(1)S(2)/StoppedRw job17]
</I>&gt;&gt;<i>        2024/02/02 17:40:41.943 kid1| 93,7| ModXact.cc(616) stopSending: Enter stop sending
</I>&gt;&gt;<i>        2024/02/02 17:40:41.943 kid1| 93,7| ModXact.cc(619) stopSending:
</I>&gt;&gt;<i> Proceed with stop sending
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> It seems to bypass because something gone wrong.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Yvain PAYEN
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> P&#244;le Op&#233;rations &amp; Technologies
</I>&gt;&gt;<i> Equipe Infrastructure syst&#232;me
</I>&gt;&gt;<i> T. +33 (0)5 57 57 01 85 (Poste 1185)
</I>&gt;&gt;<i> M. +33 (0)7 87 30 34 01
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Absent tous les mercredi
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Tessi France
</I>&gt;&gt;<i> Immeuble Cassiop&#233;e
</I>&gt;&gt;<i> 1-3 avenue des Satellites
</I>&gt;&gt;<i> 33185 Le Haillan
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Pensez &#224; l'environnement avant d'imprimer cet e-mail.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> -----Message d'origine-----
</I>&gt;&gt;<i> De : squid-users &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>&gt; De la 
</I>&gt;&gt;<i> part de Alex Rousskov Envoy&#233; : vendredi 2 f&#233;vrier 2024 17:19 &#192; :
</I>&gt;&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A> Objet : Re: [squid-users] external 
</I>&gt;&gt;<i> icap issue with squid 5 and higher
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &#9888; FR : Ce message provient de l'ext&#233;rieur de l'organisation. N'ouvrez 
</I>&gt;&gt;<i> pas de liens ou de pi&#232;ces jointes &#224; moins que vous ne sachiez que le 
</I>&gt;&gt;<i> contenu est fiable.  &#9888;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> On 2024-02-02 11:00, Yvain PAYEN wrote:
</I>&gt;&gt;&gt;<i> Hi Squid users,
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> I have an issue with an external icap service I have to use (from 
</I>&gt;&gt;&gt;<i> Forcepoint).
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> This service is working great with squid v3 and v4.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Starting v5 (v6 also tested) the service only work with plain text 
</I>&gt;&gt;&gt;<i> http requests, all requests for https content are allowed even if 
</I>&gt;&gt;&gt;<i> the website should be denied.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Do you use ssl_bump rules to decode affected HTTPS traffic? Or is your service supposed to analyze plain HTTP CONNECT requests?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> With Squid v6, does your ICAP service actually receive expected &quot;requests for https content&quot; for analysis from Squid? Or does Squid allow them without contacting the ICAP service with those requests? You can check service logs and/or enable icap.log in Squid to answer these high-level questions (see icap_log).
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> My first question is : do you know if a big change in the icap code 
</I>&gt;&gt;&gt;<i> happened between v4 and v5 ?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I do not recall, unfortunately; it was too long ago. Please keep in mind that your problems may not be triggered by ICAP code changes (if any).
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> My second question : How can I trace only icap debug logs
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> ICAP code uses debug section 93. See debug_options directive and docs/debug-sections.txt.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> HTH,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Alex.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Service is setup like this :
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> icap_service service_req reqmod_precache <A HREF="icap://10.1.1.1:1344/icap">icap://10.1.1.1:1344/icap</A>
</I>&gt;&gt;&gt;<i> bypass=1
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Regards,
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> *Yvain PAYEN*
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> *
</I>&gt;&gt;&gt;<i> **P&#244;le Op&#233;rations &amp; Technologies
</I>&gt;&gt;&gt;<i> *Equipe Infrastructure syst&#232;me
</I>&gt;&gt;&gt;<i> T. +33 (0)5 57 57 01 85 (Poste 1185)
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> M. +33 (0)7 87 30 34 01
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Absent tous les mercredi
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Tessi France
</I>&gt;&gt;&gt;<i> Immeuble Cassiop&#233;e
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> 1-3 avenue des Satellites
</I>&gt;&gt;&gt;<i> 33185 Le Haillan
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> *<A HREF="https://lists.squid-cache.org/listinfo/squid-users">yvain.payen at tessi.fr</A> &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">yvain.payen at tessi.fr</A>&gt; www.tessi.eu 
</I>&gt;&gt;&gt;<i> &lt;www.tessi.eu&gt;
</I>&gt;&gt;&gt;<i> ***
</I>&gt;&gt;&gt;<i> Pensez &#224; l'environnement avant d'imprimer cet e-mail.**
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;&gt;<i> squid-users mailing list
</I>&gt;&gt;&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;&gt;&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">https://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;<i> squid-users mailing list
</I>&gt;&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">https://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i>
</I>
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="026419.html">[squid-users] external icap issue with squid 5 and higher
</A></li>
	<LI>Next message (by thread): <A HREF="026421.html">[squid-users] New Squid prefers IPv4
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26420">[ date ]</a>
              <a href="thread.html#26420">[ thread ]</a>
              <a href="subject.html#26420">[ subject ]</a>
              <a href="author.html#26420">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
