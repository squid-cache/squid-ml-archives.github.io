<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] IPv4 addresses go missing - markAsBad wrong?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20IPv4%20addresses%20go%20missing%20-%20markAsBad%20wrong%3F&In-Reply-To=%3C399501d1-e42a-4d18-b26d-c044409cf292%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="026352.html">
   <LINK REL="Next"  HREF="026354.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] IPv4 addresses go missing - markAsBad wrong?</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20IPv4%20addresses%20go%20missing%20-%20markAsBad%20wrong%3F&In-Reply-To=%3C399501d1-e42a-4d18-b26d-c044409cf292%40measurement-factory.com%3E"
       TITLE="[squid-users] IPv4 addresses go missing - markAsBad wrong?">rousskov at measurement-factory.com
       </A><BR>
    <I>Tue Jan  9 03:41:52 UTC 2024</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="026352.html">[squid-users] IPv4 addresses go missing - markAsBad wrong?
</A></li>
        <LI>Next message (by thread): <A HREF="026354.html">[squid-users] IPv4 addresses go missing - markAsBad wrong?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26353">[ date ]</a>
              <a href="thread.html#26353">[ thread ]</a>
              <a href="subject.html#26353">[ subject ]</a>
              <a href="author.html#26353">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 2024-01-08 08:31, Stephen Borrill wrote:
&gt;<i> I'm trying to determine why squid 6.x (seen with 6.5) connected via 
</I>&gt;<i> IPv4-only periodically fails to connect to the destination and then 
</I>&gt;<i> requires a restart to fix it (reload is not sufficient).
</I>&gt;<i> 
</I>&gt;<i> The problem appears to be that a host that has one address each of IPv4 
</I>&gt;<i> and IPv6 occasionally has its IPv4 address go missing as a destination. 
</I>&gt;<i> On closer inspection, this appears to happen when the IPv6 address (not 
</I>&gt;<i> the IPv4) address is marked as bad. A log fragment is as follows:
</I>&gt;<i> 
</I>&gt;<i> 2024/01/08 13:18:39.974 kid1| 44,2| peer_select.cc(460) resolveSelected: 
</I>&gt;<i> Find IP destination for: clientservices.googleapis.com:443' via 
</I>&gt;<i> clientservices.googleapis.com
</I>&gt;<i> 2024/01/08 13:18:39.974 kid1| 44,2| peer_select.cc(1174) handlePath: 
</I>&gt;<i> PeerSelector82284 found conn696198 local=0.0.0.0 
</I>&gt;<i> remote=142.250.187.227:443 HIER_DIRECT flags=1, destination #1 for 
</I>&gt;<i> clientservices.googleapis.com:443
</I>&gt;<i> 2024/01/08 13:18:39.974 kid1| 44,2| peer_select.cc(1174) handlePath: 
</I>&gt;<i> PeerSelector82284 found conn696199 local=[::] 
</I>&gt;<i> remote=[2a00:1450:4009:820::2003]:443 HIER_DIRECT flags=1, destination 
</I>&gt;<i> #2 for clientservices.googleapis.com:443
</I>&gt;<i> 2024/01/08 13:18:39.974 kid1| 44,2| peer_select.cc(479) resolveSelected: 
</I>&gt;<i> PeerSelector82284 found all 2 destinations for 
</I>&gt;<i> clientservices.googleapis.com:443
</I>&gt;<i> 2024/01/08 13:18:40.245 kid1| 14,2| ipcache.cc(1031) markAsBad: 
</I>&gt;<i> [2a00:1450:4009:820::2003]:443 of clientservices.googleapis.com
</I>&gt;<i> 2024/01/08 13:18:40.245 kid1| 14,3| ipcache.cc(946) seekNewGood: 
</I>&gt;<i> succeeded for clientservices.googleapis.com: [2a00:1450:4009:820::2003] 
</I>&gt;<i> #2/2-1
</I>&gt;<i> 2024/01/08 13:18:40.245 kid1| 14,3| ipcache.cc(978) restoreGoodness: 
</I>&gt;<i> cleared all IPs for clientservices.googleapis.com; now back to 
</I>&gt;<i> [2a00:1450:4009:820::2003] #2/2-1
</I>&gt;<i> 2024/01/08 13:18:42.065 kid1| 14,3| Address.cc(389) lookupHostIP: Given 
</I>&gt;<i> Non-IP 'clientservices.googleapis.com': hostname or servname not 
</I>&gt;<i> provided or not known
</I>&gt;<i> 2024/01/08 13:18:42.065 kid1| 44,2| peer_select.cc(460) resolveSelected: 
</I>&gt;<i> Find IP destination for: clientservices.googleapis.com:443' via 
</I>&gt;<i> clientservices.googleapis.com
</I>&gt;<i> 2024/01/08 13:18:42.065 kid1| 14,3| Address.cc(389) lookupHostIP: Given 
</I>&gt;<i> Non-IP 'clientservices.googleapis.com': hostname or servname not 
</I>&gt;<i> provided or not known
</I>&gt;<i> 2024/01/08 13:18:42.065 kid1| 44,2| peer_select.cc(1174) handlePath: 
</I>&gt;<i> PeerSelector82372 found conn697148 local=[::] 
</I>&gt;<i> remote=[2a00:1450:4009:820::2003]:443 HIER_DIRECT flags=1, destination 
</I>&gt;<i> #1 for clientservices.googleapis.com:443
</I>&gt;<i> 2024/01/08 13:18:42.065 kid1| 44,2| peer_select.cc(479) resolveSelected: 
</I>&gt;<i> PeerSelector82372 found all 1 destinations for 
</I>&gt;<i> clientservices.googleapis.com:443
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> This shows two subsequent connection attempts to 
</I>&gt;<i> clientservices.googleapis.com. The first one has both IPv4 and IPv6 
</I>&gt;<i> destinations. The IPv6 address is passed to markAsBad. 
</I>
Yes.


&gt;<i> After that the IPv4 address is not listed as a destination.
</I>
I do not see that. I see IPv6 address being selected as the first 
destination (instead of the IPv4 address).

I cannot explain why that happens though. Moreover, a combination of 
certain lines in your debug output near &quot;seekNewGood&quot; do not make sense 
to me -- I do not see how it is possible for Squid to display those 
exact debugging details, but I am probably missing something. Can you 
retest and repost similar lines with 14,9 (or at least 14,7) added to 
your debug_options (or share those lines privately; the more lines you 
can share, the better)?


&gt;<i> Note that there have been many connections to 
</I>&gt;<i> clientservices.googleapis.com prior to this where markAsBad was not 
</I>&gt;<i> called, even though IPv6 connectivity was never available.
</I>
No markAsBad() is probably normal if Squid did not try to establish an 
IPv6 connection or did not wait long enough to know the result of that 
attempt. However, that does not explain why Squid selected an IPv6 
address as the next &quot;good&quot; address right after marking that IPv6 address 
as bad (at &quot;restoreGoodness&quot; line) when there was another good IP 
address available. It is as if Squid stored two identical IPv6 addresses 
(and not IPv4 ones), but that should not happen either.

Alex.


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="026352.html">[squid-users] IPv4 addresses go missing - markAsBad wrong?
</A></li>
	<LI>Next message (by thread): <A HREF="026354.html">[squid-users] IPv4 addresses go missing - markAsBad wrong?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26353">[ date ]</a>
              <a href="thread.html#26353">[ thread ]</a>
              <a href="subject.html#26353">[ subject ]</a>
              <a href="author.html#26353">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
