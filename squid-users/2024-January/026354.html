<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] IPv4 addresses go missing - markAsBad wrong?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20IPv4%20addresses%20go%20missing%20-%20markAsBad%20wrong%3F&In-Reply-To=%3C82d5d410-3940-4f82-893c-a28653b9d50a%40borrill.org.uk%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="026353.html">
   <LINK REL="Next"  HREF="026355.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] IPv4 addresses go missing - markAsBad wrong?</H1>
    <B>Stephen Borrill</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20IPv4%20addresses%20go%20missing%20-%20markAsBad%20wrong%3F&In-Reply-To=%3C82d5d410-3940-4f82-893c-a28653b9d50a%40borrill.org.uk%3E"
       TITLE="[squid-users] IPv4 addresses go missing - markAsBad wrong?">squid at borrill.org.uk
       </A><BR>
    <I>Tue Jan  9 09:51:01 UTC 2024</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="026353.html">[squid-users] IPv4 addresses go missing - markAsBad wrong?
</A></li>
        <LI>Next message (by thread): <A HREF="026355.html">[squid-users] IPv4 addresses go missing - markAsBad wrong?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26354">[ date ]</a>
              <a href="thread.html#26354">[ thread ]</a>
              <a href="subject.html#26354">[ subject ]</a>
              <a href="author.html#26354">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 09/01/2024 03:41, Alex Rousskov wrote:
&gt;<i> On 2024-01-08 08:31, Stephen Borrill wrote:
</I>&gt;&gt;<i> I'm trying to determine why squid 6.x (seen with 6.5) connected via 
</I>&gt;&gt;<i> IPv4-only periodically fails to connect to the destination and then 
</I>&gt;&gt;<i> requires a restart to fix it (reload is not sufficient).
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The problem appears to be that a host that has one address each of 
</I>&gt;&gt;<i> IPv4 and IPv6 occasionally has its IPv4 address go missing as a 
</I>&gt;&gt;<i> destination. On closer inspection, this appears to happen when the 
</I>&gt;&gt;<i> IPv6 address (not the IPv4) address is marked as bad. A log fragment 
</I>&gt;&gt;<i> is as follows:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> 2024/01/08 13:18:39.974 kid1| 44,2| peer_select.cc(460) 
</I>&gt;&gt;<i> resolveSelected: Find IP destination for: 
</I>&gt;&gt;<i> clientservices.googleapis.com:443' via clientservices.googleapis.com
</I>&gt;&gt;<i> 2024/01/08 13:18:39.974 kid1| 44,2| peer_select.cc(1174) handlePath: 
</I>&gt;&gt;<i> PeerSelector82284 found conn696198 local=0.0.0.0 
</I>&gt;&gt;<i> remote=142.250.187.227:443 HIER_DIRECT flags=1, destination #1 for 
</I>&gt;&gt;<i> clientservices.googleapis.com:443
</I>&gt;&gt;<i> 2024/01/08 13:18:39.974 kid1| 44,2| peer_select.cc(1174) handlePath: 
</I>&gt;&gt;<i> PeerSelector82284 found conn696199 local=[::] 
</I>&gt;&gt;<i> remote=[2a00:1450:4009:820::2003]:443 HIER_DIRECT flags=1, destination 
</I>&gt;&gt;<i> #2 for clientservices.googleapis.com:443
</I>&gt;&gt;<i> 2024/01/08 13:18:39.974 kid1| 44,2| peer_select.cc(479) 
</I>&gt;&gt;<i> resolveSelected: PeerSelector82284 found all 2 destinations for 
</I>&gt;&gt;<i> clientservices.googleapis.com:443
</I>&gt;&gt;<i> 2024/01/08 13:18:40.245 kid1| 14,2| ipcache.cc(1031) markAsBad: 
</I>&gt;&gt;<i> [2a00:1450:4009:820::2003]:443 of clientservices.googleapis.com
</I>&gt;&gt;<i> 2024/01/08 13:18:40.245 kid1| 14,3| ipcache.cc(946) seekNewGood: 
</I>&gt;&gt;<i> succeeded for clientservices.googleapis.com: 
</I>&gt;&gt;<i> [2a00:1450:4009:820::2003] #2/2-1
</I>&gt;&gt;<i> 2024/01/08 13:18:40.245 kid1| 14,3| ipcache.cc(978) restoreGoodness: 
</I>&gt;&gt;<i> cleared all IPs for clientservices.googleapis.com; now back to 
</I>&gt;&gt;<i> [2a00:1450:4009:820::2003] #2/2-1
</I>&gt;&gt;<i> 2024/01/08 13:18:42.065 kid1| 14,3| Address.cc(389) lookupHostIP: 
</I>&gt;&gt;<i> Given Non-IP 'clientservices.googleapis.com': hostname or servname not 
</I>&gt;&gt;<i> provided or not known
</I>&gt;&gt;<i> 2024/01/08 13:18:42.065 kid1| 44,2| peer_select.cc(460) 
</I>&gt;&gt;<i> resolveSelected: Find IP destination for: 
</I>&gt;&gt;<i> clientservices.googleapis.com:443' via clientservices.googleapis.com
</I>&gt;&gt;<i> 2024/01/08 13:18:42.065 kid1| 14,3| Address.cc(389) lookupHostIP: 
</I>&gt;&gt;<i> Given Non-IP 'clientservices.googleapis.com': hostname or servname not 
</I>&gt;&gt;<i> provided or not known
</I>&gt;&gt;<i> 2024/01/08 13:18:42.065 kid1| 44,2| peer_select.cc(1174) handlePath: 
</I>&gt;&gt;<i> PeerSelector82372 found conn697148 local=[::] 
</I>&gt;&gt;<i> remote=[2a00:1450:4009:820::2003]:443 HIER_DIRECT flags=1, destination 
</I>&gt;&gt;<i> #1 for clientservices.googleapis.com:443
</I>&gt;&gt;<i> 2024/01/08 13:18:42.065 kid1| 44,2| peer_select.cc(479) 
</I>&gt;&gt;<i> resolveSelected: PeerSelector82372 found all 1 destinations for 
</I>&gt;&gt;<i> clientservices.googleapis.com:443
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> This shows two subsequent connection attempts to 
</I>&gt;&gt;<i> clientservices.googleapis.com. The first one has both IPv4 and IPv6 
</I>&gt;&gt;<i> destinations. The IPv6 address is passed to markAsBad. 
</I>&gt;<i> 
</I>&gt;<i> Yes.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> After that the IPv4 address is not listed as a destination.
</I>&gt;<i> 
</I>&gt;<i> I do not see that. I see IPv6 address being selected as the first 
</I>&gt;<i> destination (instead of the IPv4 address).
</I>
My reading of the the log files is that all possible destinations are 
listed, e.g. &quot;found all 18 destinations for www.googleapis.com:443&quot;. 
Prior to markAsBad being called both IP addresses for 
clientservices.googleapis.com are shown, afterwards the IPv4 is not 
listed. It isn't just that IPv6 is being selected as the first 
destination, it is the ONLY destination as the IPv4 address is no longer 
a candidate.


&gt;<i> I cannot explain why that happens though. Moreover, a combination of 
</I>&gt;<i> certain lines in your debug output near &quot;seekNewGood&quot; do not make sense 
</I>&gt;<i> to me -- I do not see how it is possible for Squid to display those 
</I>&gt;<i> exact debugging details, but I am probably missing something. Can you 
</I>&gt;<i> retest and repost similar lines with 14,9 (or at least 14,7) added to 
</I>&gt;<i> your debug_options (or share those lines privately; the more lines you 
</I>&gt;<i> can share, the better)?
</I>
Thanks, I have started a new run with 14,7 and will pass it on privately 
unless I can distil out the relevant lines to be small enough for the list.

&gt;&gt;<i> Note that there have been many connections to 
</I>&gt;&gt;<i> clientservices.googleapis.com prior to this where markAsBad was not 
</I>&gt;&gt;<i> called, even though IPv6 connectivity was never available.
</I>&gt;<i> 
</I>&gt;<i> No markAsBad() is probably normal if Squid did not try to establish an 
</I>&gt;<i> IPv6 connection or did not wait long enough to know the result of that 
</I>&gt;<i> attempt. However, that does not explain why Squid selected an IPv6 
</I>&gt;<i> address as the next &quot;good&quot; address right after marking that IPv6 address 
</I>&gt;<i> as bad (at &quot;restoreGoodness&quot; line) when there was another good IP 
</I>&gt;<i> address available. It is as if Squid stored two identical IPv6 addresses 
</I>&gt;<i> (and not IPv4 ones), but that should not happen either.
</I>
This is tangentially related to this thread too:
<A HREF="https://lists.squid-cache.org/pipermail/squid-users/2023-November/026266.html">https://lists.squid-cache.org/pipermail/squid-users/2023-November/026266.html</A>

Once only the IPv6 address is being used, then it returns 503 for that 
host and thus can quickly get marked as dead by a downstream squid 
meaning it does not get used at all (and if it's the only peer all 
access stops).

-- 
Stephen


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="026353.html">[squid-users] IPv4 addresses go missing - markAsBad wrong?
</A></li>
	<LI>Next message (by thread): <A HREF="026355.html">[squid-users] IPv4 addresses go missing - markAsBad wrong?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26354">[ date ]</a>
              <a href="thread.html#26354">[ thread ]</a>
              <a href="subject.html#26354">[ subject ]</a>
              <a href="author.html#26354">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
