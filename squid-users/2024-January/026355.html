<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] IPv4 addresses go missing - markAsBad wrong?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20IPv4%20addresses%20go%20missing%20-%20markAsBad%20wrong%3F&In-Reply-To=%3C917b9fdc-7998-4d95-873d-35ca19824cff%40borrill.org.uk%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="026354.html">
   <LINK REL="Next"  HREF="026358.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] IPv4 addresses go missing - markAsBad wrong?</H1>
    <B>Stephen Borrill</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20IPv4%20addresses%20go%20missing%20-%20markAsBad%20wrong%3F&In-Reply-To=%3C917b9fdc-7998-4d95-873d-35ca19824cff%40borrill.org.uk%3E"
       TITLE="[squid-users] IPv4 addresses go missing - markAsBad wrong?">squid at borrill.org.uk
       </A><BR>
    <I>Tue Jan  9 10:56:16 UTC 2024</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="026354.html">[squid-users] IPv4 addresses go missing - markAsBad wrong?
</A></li>
        <LI>Next message (by thread): <A HREF="026358.html">[squid-users] IPv4 addresses go missing - markAsBad wrong?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26355">[ date ]</a>
              <a href="thread.html#26355">[ thread ]</a>
              <a href="subject.html#26355">[ subject ]</a>
              <a href="author.html#26355">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 09/01/2024 09:51, Stephen Borrill wrote:
&gt;<i> On 09/01/2024 03:41, Alex Rousskov wrote:
</I>&gt;&gt;<i> On 2024-01-08 08:31, Stephen Borrill wrote:
</I>&gt;&gt;&gt;<i> I'm trying to determine why squid 6.x (seen with 6.5) connected via 
</I>&gt;&gt;&gt;<i> IPv4-only periodically fails to connect to the destination and then 
</I>&gt;&gt;&gt;<i> requires a restart to fix it (reload is not sufficient).
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> The problem appears to be that a host that has one address each of 
</I>&gt;&gt;&gt;<i> IPv4 and IPv6 occasionally has its IPv4 address go missing as a 
</I>&gt;&gt;&gt;<i> destination. On closer inspection, this appears to happen when the 
</I>&gt;&gt;&gt;<i> IPv6 address (not the IPv4) address is marked as bad. A log fragment 
</I>&gt;&gt;&gt;<i> is as follows:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> 2024/01/08 13:18:39.974 kid1| 44,2| peer_select.cc(460) 
</I>&gt;&gt;&gt;<i> resolveSelected: Find IP destination for: 
</I>&gt;&gt;&gt;<i> clientservices.googleapis.com:443' via clientservices.googleapis.com
</I>&gt;&gt;&gt;<i> 2024/01/08 13:18:39.974 kid1| 44,2| peer_select.cc(1174) handlePath: 
</I>&gt;&gt;&gt;<i> PeerSelector82284 found conn696198 local=0.0.0.0 
</I>&gt;&gt;&gt;<i> remote=142.250.187.227:443 HIER_DIRECT flags=1, destination #1 for 
</I>&gt;&gt;&gt;<i> clientservices.googleapis.com:443
</I>&gt;&gt;&gt;<i> 2024/01/08 13:18:39.974 kid1| 44,2| peer_select.cc(1174) handlePath: 
</I>&gt;&gt;&gt;<i> PeerSelector82284 found conn696199 local=[::] 
</I>&gt;&gt;&gt;<i> remote=[2a00:1450:4009:820::2003]:443 HIER_DIRECT flags=1, 
</I>&gt;&gt;&gt;<i> destination #2 for clientservices.googleapis.com:443
</I>&gt;&gt;&gt;<i> 2024/01/08 13:18:39.974 kid1| 44,2| peer_select.cc(479) 
</I>&gt;&gt;&gt;<i> resolveSelected: PeerSelector82284 found all 2 destinations for 
</I>&gt;&gt;&gt;<i> clientservices.googleapis.com:443
</I>&gt;&gt;&gt;<i> 2024/01/08 13:18:40.245 kid1| 14,2| ipcache.cc(1031) markAsBad: 
</I>&gt;&gt;&gt;<i> [2a00:1450:4009:820::2003]:443 of clientservices.googleapis.com
</I>&gt;&gt;&gt;<i> 2024/01/08 13:18:40.245 kid1| 14,3| ipcache.cc(946) seekNewGood: 
</I>&gt;&gt;&gt;<i> succeeded for clientservices.googleapis.com: 
</I>&gt;&gt;&gt;<i> [2a00:1450:4009:820::2003] #2/2-1
</I>&gt;&gt;&gt;<i> 2024/01/08 13:18:40.245 kid1| 14,3| ipcache.cc(978) restoreGoodness: 
</I>&gt;&gt;&gt;<i> cleared all IPs for clientservices.googleapis.com; now back to 
</I>&gt;&gt;&gt;<i> [2a00:1450:4009:820::2003] #2/2-1
</I>&gt;&gt;&gt;<i> 2024/01/08 13:18:42.065 kid1| 14,3| Address.cc(389) lookupHostIP: 
</I>&gt;&gt;&gt;<i> Given Non-IP 'clientservices.googleapis.com': hostname or servname 
</I>&gt;&gt;&gt;<i> not provided or not known
</I>&gt;&gt;&gt;<i> 2024/01/08 13:18:42.065 kid1| 44,2| peer_select.cc(460) 
</I>&gt;&gt;&gt;<i> resolveSelected: Find IP destination for: 
</I>&gt;&gt;&gt;<i> clientservices.googleapis.com:443' via clientservices.googleapis.com
</I>&gt;&gt;&gt;<i> 2024/01/08 13:18:42.065 kid1| 14,3| Address.cc(389) lookupHostIP: 
</I>&gt;&gt;&gt;<i> Given Non-IP 'clientservices.googleapis.com': hostname or servname 
</I>&gt;&gt;&gt;<i> not provided or not known
</I>&gt;&gt;&gt;<i> 2024/01/08 13:18:42.065 kid1| 44,2| peer_select.cc(1174) handlePath: 
</I>&gt;&gt;&gt;<i> PeerSelector82372 found conn697148 local=[::] 
</I>&gt;&gt;&gt;<i> remote=[2a00:1450:4009:820::2003]:443 HIER_DIRECT flags=1, 
</I>&gt;&gt;&gt;<i> destination #1 for clientservices.googleapis.com:443
</I>&gt;&gt;&gt;<i> 2024/01/08 13:18:42.065 kid1| 44,2| peer_select.cc(479) 
</I>&gt;&gt;&gt;<i> resolveSelected: PeerSelector82372 found all 1 destinations for 
</I>&gt;&gt;&gt;<i> clientservices.googleapis.com:443
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> This shows two subsequent connection attempts to 
</I>&gt;&gt;&gt;<i> clientservices.googleapis.com. The first one has both IPv4 and IPv6 
</I>&gt;&gt;&gt;<i> destinations. The IPv6 address is passed to markAsBad. 
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Yes.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> After that the IPv4 address is not listed as a destination.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I do not see that. I see IPv6 address being selected as the first 
</I>&gt;&gt;<i> destination (instead of the IPv4 address).
</I>&gt;<i> 
</I>&gt;<i> My reading of the the log files is that all possible destinations are 
</I>&gt;<i> listed, e.g. &quot;found all 18 destinations for www.googleapis.com:443&quot;. 
</I>&gt;<i> Prior to markAsBad being called both IP addresses for 
</I>&gt;<i> clientservices.googleapis.com are shown, afterwards the IPv4 is not 
</I>&gt;<i> listed. It isn't just that IPv6 is being selected as the first 
</I>&gt;<i> destination, it is the ONLY destination as the IPv4 address is no longer 
</I>&gt;<i> a candidate.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> I cannot explain why that happens though. Moreover, a combination of 
</I>&gt;&gt;<i> certain lines in your debug output near &quot;seekNewGood&quot; do not make 
</I>&gt;&gt;<i> sense to me -- I do not see how it is possible for Squid to display 
</I>&gt;&gt;<i> those exact debugging details, but I am probably missing something. 
</I>&gt;&gt;<i> Can you retest and repost similar lines with 14,9 (or at least 14,7) 
</I>&gt;&gt;<i> added to your debug_options (or share those lines privately; the more 
</I>&gt;&gt;<i> lines you can share, the better)?
</I>&gt;<i> 
</I>&gt;<i> Thanks, I have started a new run with 14,7 and will pass it on privately 
</I>&gt;<i> unless I can distil out the relevant lines to be small enough for the list.
</I>
A distilled version is here. Let me know if you want the full log.

This looks suspicious to me:
have: [2001:4860:4802:32::78]:443 at 0 in 216.239.38.120 #1/2-0

2024/01/09 09:34:34.102 kid1| 14,4| ipcache.cc(617) nbgethostbyname: 
forcesafesearch.google.com
2024/01/09 09:34:34.102 kid1| 14,4| ipcache.cc(657) 
ipcache_nbgethostbyname_: ipcache_nbgethostbyname: HIT for 
'forcesafesearch.google.com'
2024/01/09 09:34:34.102 kid1| 14,7| ipcache.cc(253) forwardIp: 
216.239.38.120
2024/01/09 09:34:34.102 kid1| 44,2| peer_select.cc(1174) handlePath: 
PeerSelector128957 found conn1010793 local=0.0.0.0 
remote=216.239.38.120:443 HIER_DIRECT flags=1, destination #1 for 
forcesafesearch.google.com:443
2024/01/09 09:34:34.102 kid1| 14,7| ipcache.cc(253) forwardIp: 
[2001:4860:4802:32::78]
2024/01/09 09:34:34.102 kid1| 44,2| peer_select.cc(1174) handlePath: 
PeerSelector128957 found conn1010794 local=[::] 
remote=[2001:4860:4802:32::78]:443 HIER_DIRECT flags=1, destination #2 
for forcesafesearch.google.com:443
2024/01/09 09:34:34.102 kid1| 14,7| ipcache.cc(236) finalCallback: 
0x18f816d38
2024/01/09 09:34:34.102 kid1| 44,2| peer_select.cc(479) resolveSelected: 
PeerSelector128957 found all 2 destinations for 
forcesafesearch.google.com:443
2024/01/09 09:34:34.352 kid1| 14,7| ipcache.cc(990) have: 
[2001:4860:4802:32::78]:443 at 0 in 216.239.38.120 #1/2-0
2024/01/09 09:34:34.352 kid1| 14,2| ipcache.cc(1031) markAsBad: 
[2001:4860:4802:32::78]:443 of forcesafesearch.google.com
2024/01/09 09:34:34.352 kid1| 14,3| ipcache.cc(946) seekNewGood: 
succeeded for forcesafesearch.google.com: [2001:4860:4802:32::78] #2/2-1
2024/01/09 09:34:34.352 kid1| 14,3| ipcache.cc(978) restoreGoodness: 
cleared all IPs for forcesafesearch.google.com; now back to 
[2001:4860:4802:32::78] #2/2-1

2024/01/09 09:34:35.683 kid1| 14,4| ipcache.cc(617) nbgethostbyname: 
forcesafesearch.google.com
2024/01/09 09:34:35.683 kid1| 14,3| Address.cc(389) lookupHostIP: Given 
Non-IP 'forcesafesearch.google.com': hostname or servname not provided 
or not known
2024/01/09 09:34:35.683 kid1| 14,4| ipcache.cc(657) 
ipcache_nbgethostbyname_: ipcache_nbgethostbyname: HIT for 
'forcesafesearch.google.com'
2024/01/09 09:34:35.683 kid1| 14,7| ipcache.cc(253) forwardIp: 
[2001:4860:4802:32::78]
2024/01/09 09:34:35.683 kid1| 44,2| peer_select.cc(1174) handlePath: 
PeerSelector128974 found conn1010956 local=[::] 
remote=[2001:4860:4802:32::78]:443 HIER_DIRECT flags=1, destination #1 
for forcesafesearch.google.com:443
2024/01/09 09:34:35.683 kid1| 14,7| ipcache.cc(236) finalCallback: 
0x18f816d38
2024/01/09 09:34:35.683 kid1| 44,2| peer_select.cc(479) resolveSelected: 
PeerSelector128974 found all 1 destinations for 
forcesafesearch.google.com:443
2024/01/09 09:34:35.683 kid1| 14,7| ipcache.cc(990) have: 
[2001:4860:4802:32::78]:443 at 0 in [2001:4860:4802:32::78] #2/2-1


&gt;&gt;&gt;<i> Note that there have been many connections to 
</I>&gt;&gt;&gt;<i> clientservices.googleapis.com prior to this where markAsBad was not 
</I>&gt;&gt;&gt;<i> called, even though IPv6 connectivity was never available.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> No markAsBad() is probably normal if Squid did not try to establish an 
</I>&gt;&gt;<i> IPv6 connection or did not wait long enough to know the result of that 
</I>&gt;&gt;<i> attempt. However, that does not explain why Squid selected an IPv6 
</I>&gt;&gt;<i> address as the next &quot;good&quot; address right after marking that IPv6 
</I>&gt;&gt;<i> address as bad (at &quot;restoreGoodness&quot; line) when there was another good 
</I>&gt;&gt;<i> IP address available. It is as if Squid stored two identical IPv6 
</I>&gt;&gt;<i> addresses (and not IPv4 ones), but that should not happen either.
</I>&gt;<i> 
</I>&gt;<i> This is tangentially related to this thread too:
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/pipermail/squid-users/2023-November/026266.html">https://lists.squid-cache.org/pipermail/squid-users/2023-November/026266.html</A>
</I>&gt;<i> 
</I>&gt;<i> Once only the IPv6 address is being used, then it returns 503 for that 
</I>&gt;<i> host and thus can quickly get marked as dead by a downstream squid 
</I>&gt;<i> meaning it does not get used at all (and if it's the only peer all 
</I>&gt;<i> access stops).
</I>&gt;<i> 
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="026354.html">[squid-users] IPv4 addresses go missing - markAsBad wrong?
</A></li>
	<LI>Next message (by thread): <A HREF="026358.html">[squid-users] IPv4 addresses go missing - markAsBad wrong?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26355">[ date ]</a>
              <a href="thread.html#26355">[ thread ]</a>
              <a href="subject.html#26355">[ subject ]</a>
              <a href="author.html#26355">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
