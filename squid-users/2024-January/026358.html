<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] IPv4 addresses go missing - markAsBad wrong?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20IPv4%20addresses%20go%20missing%20-%20markAsBad%20wrong%3F&In-Reply-To=%3C2f9b9a7a-88d4-4bd0-901b-4898473d74c6%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="026355.html">
   <LINK REL="Next"  HREF="026363.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] IPv4 addresses go missing - markAsBad wrong?</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20IPv4%20addresses%20go%20missing%20-%20markAsBad%20wrong%3F&In-Reply-To=%3C2f9b9a7a-88d4-4bd0-901b-4898473d74c6%40measurement-factory.com%3E"
       TITLE="[squid-users] IPv4 addresses go missing - markAsBad wrong?">rousskov at measurement-factory.com
       </A><BR>
    <I>Tue Jan  9 15:42:15 UTC 2024</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="026355.html">[squid-users] IPv4 addresses go missing - markAsBad wrong?
</A></li>
        <LI>Next message (by thread): <A HREF="026363.html">[squid-users] IPv4 addresses go missing - markAsBad wrong?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26358">[ date ]</a>
              <a href="thread.html#26358">[ thread ]</a>
              <a href="subject.html#26358">[ subject ]</a>
              <a href="author.html#26358">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 2024-01-09 05:56, Stephen Borrill wrote:
&gt;<i> On 09/01/2024 09:51, Stephen Borrill wrote:
</I>&gt;&gt;<i> On 09/01/2024 03:41, Alex Rousskov wrote:
</I>&gt;&gt;&gt;<i> On 2024-01-08 08:31, Stephen Borrill wrote:
</I>&gt;&gt;&gt;&gt;<i> I'm trying to determine why squid 6.x (seen with 6.5) connected via 
</I>&gt;&gt;&gt;&gt;<i> IPv4-only periodically fails to connect to the destination and then 
</I>&gt;&gt;&gt;&gt;<i> requires a restart to fix it (reload is not sufficient).
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> The problem appears to be that a host that has one address each of 
</I>&gt;&gt;&gt;&gt;<i> IPv4 and IPv6 occasionally has its IPv4 address go missing as a 
</I>&gt;&gt;&gt;&gt;<i> destination. On closer inspection, this appears to happen when the 
</I>&gt;&gt;&gt;&gt;<i> IPv6 address (not the IPv4) address is marked as bad.
</I>
&gt;<i> ipcache.cc(990) have: [2001:4860:4802:32::78]:443 at 0 in 216.239.38.120 #1/2-0
</I>

Thank you for sharing more debugging info!

The above log line is self-contradictory AFAICT: It says that the cache 
has both IPv6-looking and IPv4-looking address at the same cache 
position (0) and, judging by the corresponding code, those two IP 
addresses are equal. This is not possible (for those specific IP address 
values). The subsequent Squid behavior can be explained by this 
(unexplained) conflict.

I assume you are running official Squid v6.5 code.

I can suggest the following two steps for going forward:

1. Upgrade to the latest Squid v6 in hope that the problem goes away.

2. If the problem is still there, patch the latest Squid v6 to add more 
debugging in hope to explain what is going on. This may take a few 
iterations, and it will take me some time to produce the necessary 
debugging patch.


HTH,

Alex.


&gt;&gt;&gt;&gt;<i> Note that there have been many connections to 
</I>&gt;&gt;&gt;&gt;<i> clientservices.googleapis.com prior to this where markAsBad was not 
</I>&gt;&gt;&gt;&gt;<i> called, even though IPv6 connectivity was never available.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> No markAsBad() is probably normal if Squid did not try to establish 
</I>&gt;&gt;&gt;<i> an IPv6 connection or did not wait long enough to know the result of 
</I>&gt;&gt;&gt;<i> that attempt. However, that does not explain why Squid selected an 
</I>&gt;&gt;&gt;<i> IPv6 address as the next &quot;good&quot; address right after marking that IPv6 
</I>&gt;&gt;&gt;<i> address as bad (at &quot;restoreGoodness&quot; line) when there was another 
</I>&gt;&gt;&gt;<i> good IP address available. It is as if Squid stored two identical 
</I>&gt;&gt;&gt;<i> IPv6 addresses (and not IPv4 ones), but that should not happen either.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> This is tangentially related to this thread too:
</I>&gt;&gt;<i> <A HREF="https://lists.squid-cache.org/pipermail/squid-users/2023-November/026266.html">https://lists.squid-cache.org/pipermail/squid-users/2023-November/026266.html</A>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Once only the IPv6 address is being used, then it returns 503 for that 
</I>&gt;&gt;<i> host and thus can quickly get marked as dead by a downstream squid 
</I>&gt;&gt;<i> meaning it does not get used at all (and if it's the only peer all 
</I>&gt;&gt;<i> access stops).
</I>&gt;&gt;<i>
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">https://lists.squid-cache.org/listinfo/squid-users</A>
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="026355.html">[squid-users] IPv4 addresses go missing - markAsBad wrong?
</A></li>
	<LI>Next message (by thread): <A HREF="026363.html">[squid-users] IPv4 addresses go missing - markAsBad wrong?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26358">[ date ]</a>
              <a href="thread.html#26358">[ thread ]</a>
              <a href="subject.html#26358">[ subject ]</a>
              <a href="author.html#26358">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
