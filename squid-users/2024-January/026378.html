<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] offline mode not working for me
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20offline%20mode%20not%20working%20for%20me&In-Reply-To=%3C697ba41e-73cc-440d-a5bb-71338f6b2a14%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="026377.html">
   <LINK REL="Next"  HREF="026381.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] offline mode not working for me</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20offline%20mode%20not%20working%20for%20me&In-Reply-To=%3C697ba41e-73cc-440d-a5bb-71338f6b2a14%40measurement-factory.com%3E"
       TITLE="[squid-users] offline mode not working for me">rousskov at measurement-factory.com
       </A><BR>
    <I>Thu Jan 18 16:03:22 UTC 2024</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="026377.html">[squid-users] offline mode not working for me
</A></li>
        <LI>Next message (by thread): <A HREF="026381.html">[squid-users] offline mode not working for me
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26378">[ date ]</a>
              <a href="thread.html#26378">[ thread ]</a>
              <a href="subject.html#26378">[ subject ]</a>
              <a href="author.html#26378">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 2024-01-18 09:53, Robin Carlisle wrote:

&gt;<i> My expectation/hope is that squid would return the cached object on
</I>&gt;<i> any network failure in between ubuntu-pc and the AWS endpoint - and
</I>&gt;<i> continue to return this cached object forever.   Is this something
</I>&gt;<i> squid can do? It would seem that offline_mode should do this?
</I>
Yes and yes. The reason you are getting errors are not related to cache 
hits or misses. Those errors happen _before_ Squid gets the requested 
resource URL and looks up that resource in Squid cache.

&gt;<i> ssl_bump peek step1
</I>&gt;<i> ssl_bump bump all 
</I>
To get that URL (in your configuration), Squid must bump the connection. 
To bump the connection at step2, Squid must contact the origin server. 
When the cable is unplugged, Squid obviously cannot do that: The attempt 
to open a Squid-AWS connection fails.

 &gt; .../200 0 CONNECT stuff.amazonaws.com:443 - HIER_DIRECT
 &gt; .../503 4087 GET <A HREF="https://stuff.amazonaws.com/api/...">https://stuff.amazonaws.com/api/...</A> - HIER_NONE

Squid reports bumping errors to the client using HTTP responses. To do 
that, Squid remembers the error response, bumps the client connection, 
receives GET from the client on that bumped connection, and sends that 
error response to the client. This is why you see both CONNECT/200 and 
GET/503 access.log records. Note that Squid does not check whether the 
received GET request would have been a cache hit in this case -- the 
response to that request has been preordained by the earlier bumping 
failure.


Solution candidates to consider include:

* Stop bumping: https_port 443 cert=/etc/squid/stuff.pem

Configure Squid as (a reverse HTTPS proxy for) the AWS service. Use 
https_port. No SslBump rules/options! The client would think that it is 
sending HTTPS requests directly to the service. Squid will forward 
client requests to the service. If this works (and I do not have enough 
information to know that this will work in your specific environment), 
then you will get a much simpler setup.


* Bump at step1, before Squid contacts AWS: ssl_bump bump all

Bugs notwithstanding, there will be no Squid-AWS connection for cache 
hits. The resulting certificate will not be based on AWS service info, 
but it looks like your client is ignorant enough to ignore related 
certificate problems.


HTH,

Alex.


&gt;<i> Hi, Hoping someone can help me with this issue that I have been 
</I>&gt;<i> struggling with for days now. &#160; I am setting up squid on an ubuntu PC to 
</I>&gt;<i> forward HTTPS requests to an API and an s3 bucket under my control on 
</I>&gt;<i> amazon AWS.&#160; The reason I am setting up the proxy is two-fold...
</I>&gt;<i> 
</I>&gt;<i> 1) To reduce costs from AWS.
</I>&gt;<i> 2) To provide content to the client on the ubuntu PC if there is a 
</I>&gt;<i> networking issue somewhere in between the ubuntu PC and AWS.
</I>&gt;<i> 
</I>&gt;<i> Item 1 is going well so far. &#160; Item 2 is not going well. &#160; Setup details ...
</I>&gt;<i> 
</I>&gt;<i> *# squid - setup cache folder*
</I>&gt;<i> mkdir -p /var/cache/squid
</I>&gt;<i> chown -R proxy:proxy &#160;/var/cache/squid
</I>&gt;<i> 
</I>&gt;<i> *# ssl - generate key*
</I>&gt;<i> apt --yes install squid-openssl libnss3-tools
</I>&gt;<i> openssl req -new -newkey rsa:2048 -days 365 -nodes -x509 \
</I>&gt;<i>  &#160; -subj &quot;/C=US/ST=Denial/L=Springfield/O=Dis/CN=www.example.com 
</I>&gt;<i> &lt;<A HREF="http://www.example.com">http://www.example.com</A>&gt;&quot; \
</I>&gt;<i>  &#160; -keyout /etc/squid/stuff.pem -out /etc/squid/stuff.pem
</I>&gt;<i> chown root:proxy /etc/squid/stuff.pem
</I>&gt;<i> chmod 644 &#160;/etc/squid/stuff.pem
</I>&gt;<i> 
</I>&gt;<i> *# ssl - ssl DB*
</I>&gt;<i> mkdir -p /var/lib/squid
</I>&gt;<i> rm -rf /var/lib/squid/ssl_db
</I>&gt;<i> /usr/lib/squid/security_file_certgen -c -s /var/lib/squid/ssl_db -M 4MB
</I>&gt;<i> chown -R proxy:proxy /var/lib/squid/ssl_db
</I>&gt;<i> 
</I>&gt;<i> *# /etc/squid/squid.conf :*
</I>&gt;<i> acl to_aws dstdomain .amazonaws.com &lt;<A HREF="http://amazonaws.com">http://amazonaws.com</A>&gt;
</I>&gt;<i> acl from_local src localhost
</I>&gt;<i> http_access allow to_aws
</I>&gt;<i> http_access allow from_local
</I>&gt;<i> cache allow all
</I>&gt;<i> cache_dir ufs /var/cache/squid 1024 16 256
</I>&gt;<i> offline_mode on
</I>&gt;<i> http_port 3129 ssl-bump cert=/etc/squid/stuff.pem 
</I>&gt;<i> generate-host-certificates=on dynamic_cert_mem_cache_size=4MB
</I>&gt;<i> sslcrtd_program /usr/lib/squid/security_file_certgen -s 
</I>&gt;<i> /var/lib/squid/ssl_db -M 4MB
</I>&gt;<i> acl step1 at_step SslBump1
</I>&gt;<i> ssl_bump peek step1
</I>&gt;<i> ssl_bump bump all
</I>&gt;<i> sslproxy_cert_error deny all
</I>&gt;<i> cache_store_log stdio:/var/log/squid/store.log
</I>&gt;<i> logfile_rotate 0
</I>&gt;<i> 
</I>&gt;<i> *# /usr/bin/proxy-test :*
</I>&gt;<i> #!/bin/bash
</I>&gt;<i> curl --proxy <A HREF="http://localhost:3129">http://localhost:3129</A> &lt;<A HREF="http://localhost:3129">http://localhost:3129</A>&gt; \
</I>&gt;<i>  &#160; --cacert /etc/squid/stuff.pem \
</I>&gt;<i>  &#160; -v &quot;<A HREF="https://stuff.amazonaws.com/api/v1/stuff/stuff.json">https://stuff.amazonaws.com/api/v1/stuff/stuff.json</A> 
</I>&gt;<i> &lt;<A HREF="https://stuff.amazonaws.com/api/v1/stuff/stuff.json">https://stuff.amazonaws.com/api/v1/stuff/stuff.json</A>&gt;&quot; \
</I>&gt;<i>  &#160; -H &quot;Authorization: token MYTOKEN&quot; \
</I>&gt;<i>  &#160; -H &quot;Content-Type: application/json&quot; \
</I>&gt;<i>  &#160; --output &quot;/tmp/stuff.json&quot;
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> When network connectivity is GOOD, everything works well and I get cache 
</I>&gt;<i> HITS ...
</I>&gt;<i> 
</I>&gt;<i> *# /var/log/squid/access.log*
</I>&gt;<i> 1705587538.837 &#160; &#160;238 127.0.0.1 NONE_NONE/200 0 CONNECT 
</I>&gt;<i> stuff.amazonaws.com:443 &lt;<A HREF="http://stuff.amazonaws.com:443">http://stuff.amazonaws.com:443</A>&gt; - 
</I>&gt;<i> HIER_DIRECT/3.136.246.238 &lt;<A HREF="http://3.136.246.238">http://3.136.246.238</A>&gt; -
</I>&gt;<i> 1705587538.838 &#160; &#160; &#160;0 127.0.0.1 TCP_MEM_HIT/200 32818 GET 
</I>&gt;<i> <A HREF="https://stuff.amazonaws.com/api/v1/stuff/stuff.json">https://stuff.amazonaws.com/api/v1/stuff/stuff.json</A> 
</I>&gt;<i> &lt;<A HREF="https://stuff.amazonaws.com/api/v1/stuff/stuff.json">https://stuff.amazonaws.com/api/v1/stuff/stuff.json</A>&gt; - HIER_NONE/- 
</I>&gt;<i> application/json
</I>&gt;<i> 
</I>&gt;<i> *# extract from /usr/bin/proxy-test output*
</I>&gt;<i> &lt; HTTP/1.1 200 OK
</I>&gt;<i> &lt; Date: Thu, 18 Jan 2024 13:38:01 GMT
</I>&gt;<i> &lt; Content-Type: application/json
</I>&gt;<i> &lt; Content-Length: 32187
</I>&gt;<i> &lt; x-amzn-RequestId: 8afba80e-6df7-4d5b-a34b-a70bd9b54380
</I>&gt;<i> &lt; Last-Modified: 2024-01-03T11:23:19.000Z
</I>&gt;<i> &lt; Access-Control-Allow-Origin: *
</I>&gt;<i> &lt; x-amz-apigw-id: RvN1CF2_iYcEokA=
</I>&gt;<i> &lt; Cache-Control: max-age=2147483648,public,stale-if-error
</I>&gt;<i> &lt; ETag: &quot;53896156c4e8e26933188a092c4e40f1&quot;
</I>&gt;<i> &lt; X-Amzn-Trace-Id: Root=1-65a929b9-3bd3285934151c1a2495481a
</I>&gt;<i> &lt; Age: 2578
</I>&gt;<i> &lt; Warning: 110 squid/5.7 &quot;Response is stale&quot;
</I>&gt;<i> &lt; X-Cache: HIT from ubuntu-pc
</I>&gt;<i> &lt; X-Cache-Lookup: HIT from ubuntu-pc:3129
</I>&gt;<i> &lt; Via: 1.1 ubuntu-pc (squid/5.7)
</I>&gt;<i> &lt; Connection: keep-alive
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> When network connectivity is BAD, I get errors and a cache MISS. &#160; In 
</I>&gt;<i> this test case I unplugged the ethernet cable from the back on the 
</I>&gt;<i> ubuntu-pc ...
</I>&gt;<i> 
</I>&gt;<i> *# /var/log/squid/access.log*
</I>&gt;<i> 1705588717.420 &#160; &#160; 11 127.0.0.1 NONE_NONE/200 0 CONNECT 
</I>&gt;<i> stuff.amazonaws.com:443 &lt;<A HREF="http://stuff.amazonaws.com:443">http://stuff.amazonaws.com:443</A>&gt; - 
</I>&gt;<i> HIER_DIRECT/3.135.162.228 &lt;<A HREF="http://3.135.162.228">http://3.135.162.228</A>&gt; -
</I>&gt;<i> 1705588717.420 &#160; &#160; &#160;0 127.0.0.1 NONE_NONE/503 4087 GET 
</I>&gt;<i> <A HREF="https://stuff.amazonaws.com/api/v1/stuff/stuff.json">https://stuff.amazonaws.com/api/v1/stuff/stuff.json</A> 
</I>&gt;<i> &lt;<A HREF="https://stuff.amazonaws.com/api/v1/stuff/stuff.json">https://stuff.amazonaws.com/api/v1/stuff/stuff.json</A>&gt; - HIER_NONE/- 
</I>&gt;<i> text/html
</I>&gt;<i> 
</I>&gt;<i> *# extract from /usr/bin/proxy-test output*
</I>&gt;<i> &lt; HTTP/1.1 503 Service Unavailable
</I>&gt;<i> &lt; Server: squid/5.7
</I>&gt;<i> &lt; Mime-Version: 1.0
</I>&gt;<i> &lt; Date: Thu, 18 Jan 2024 14:38:37 GMT
</I>&gt;<i> &lt; Content-Type: text/html;charset=utf-8
</I>&gt;<i> &lt; Content-Length: 3692
</I>&gt;<i> &lt; X-Squid-Error: ERR_CONNECT_FAIL 101
</I>&gt;<i> &lt; Vary: Accept-Language
</I>&gt;<i> &lt; Content-Language: en
</I>&gt;<i> &lt; X-Cache: MISS from ubuntu-pc
</I>&gt;<i> &lt; X-Cache-Lookup: NONE from ubuntu-pc:3129
</I>&gt;<i> &lt; Via: 1.1 ubuntu-pc (squid/5.7)
</I>&gt;<i> &lt; Connection: close
</I>&gt;<i> 
</I>&gt;<i> I have also seen it error in a different way with a 502 but with the 
</I>&gt;<i> same ultimate result.
</I>&gt;<i> 
</I>&gt;<i> My expectation/hope is that squid would return the cached object on any 
</I>&gt;<i> network failure in between ubuntu-pc and the AWS endpoint - and continue 
</I>&gt;<i> to return this cached object forever.&#160; &#160;Is this something squid can do? 
</I>&gt;<i>  &#160; It would seem that offline_mode should do this?
</I>&gt;<i> 
</I>&gt;<i> Hope you can help,
</I>&gt;<i> 
</I>&gt;<i> Robin
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">https://lists.squid-cache.org/listinfo/squid-users</A>
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="026377.html">[squid-users] offline mode not working for me
</A></li>
	<LI>Next message (by thread): <A HREF="026381.html">[squid-users] offline mode not working for me
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26378">[ date ]</a>
              <a href="thread.html#26378">[ thread ]</a>
              <a href="subject.html#26378">[ subject ]</a>
              <a href="author.html#26378">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
