<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] offline mode not working for me
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20offline%20mode%20not%20working%20for%20me&In-Reply-To=%3CCANOuv9qeniLNrrj5YM69f3qoCS8Zi_fb14HEpYiUyggTG4cOVQ%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="026378.html">
   <LINK REL="Next"  HREF="026384.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] offline mode not working for me</H1>
    <B>Robin Carlisle</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20offline%20mode%20not%20working%20for%20me&In-Reply-To=%3CCANOuv9qeniLNrrj5YM69f3qoCS8Zi_fb14HEpYiUyggTG4cOVQ%40mail.gmail.com%3E"
       TITLE="[squid-users] offline mode not working for me">robin.carlisle at framestore.com
       </A><BR>
    <I>Fri Jan 19 13:05:23 UTC 2024</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="026378.html">[squid-users] offline mode not working for me
</A></li>
        <LI>Next message (by thread): <A HREF="026384.html">[squid-users] offline mode not working for me
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26381">[ date ]</a>
              <a href="thread.html#26381">[ thread ]</a>
              <a href="subject.html#26381">[ subject ]</a>
              <a href="author.html#26381">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi, thanks so much for the detailed response.  I chose to test option 2
from your recommendations as I am new to squid and I do not understand how
to set it up as a reverse proxy anyway.  I made the change to my squid.conf
:<i>
</I>

#ssl_bump peek step1

ssl_bump bump step1

ssl_bump bump all


This made it work - which is great news.   My curl requests now are
satisfied by the cache when the pc is offline!


I do have 1 followup question which I think is unrelated, let me know if
etiquette demands I create a new post for this.  When I test using
chromium browser, chromium sends OPTION requests - which I think is
something to do with CORS.   These always cause cache MISS  from squid,.. I
think because the return code is 204...?


1705669236.776    113 ::1 TCP_MISS/204 680 OPTIONS
<A HREF="https://stuff.amazonaws.com/api/v1/stuff/stuff.json">https://stuff.amazonaws.com/api/v1/stuff/stuff.json</A> - HIER_DIRECT/
3.135.146.17 application/json


I can prevent my chromium instance from making these (pointless?) OPTIONS
calls using the following args, but I would rather not have to do this.


--disable-web-security  --disable-features=IsolateOrigins,site-per-process


Any way I can get squid to cache these calls?


Thanks again and all the best,


Robin





On Thu, 18 Jan 2024 at 16:03, Alex Rousskov &lt;
<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt; wrote:

&gt;<i> On 2024-01-18 09:53, Robin Carlisle wrote:
</I>&gt;<i>
</I>&gt;<i> &gt; My expectation/hope is that squid would return the cached object on
</I>&gt;<i> &gt; any network failure in between ubuntu-pc and the AWS endpoint - and
</I>&gt;<i> &gt; continue to return this cached object forever.   Is this something
</I>&gt;<i> &gt; squid can do? It would seem that offline_mode should do this?
</I>&gt;<i>
</I>&gt;<i> Yes and yes. The reason you are getting errors are not related to cache
</I>&gt;<i> hits or misses. Those errors happen _before_ Squid gets the requested
</I>&gt;<i> resource URL and looks up that resource in Squid cache.
</I>&gt;<i>
</I>&gt;<i> &gt; ssl_bump peek step1
</I>&gt;<i> &gt; ssl_bump bump all
</I>&gt;<i>
</I>&gt;<i> To get that URL (in your configuration), Squid must bump the connection.
</I>&gt;<i> To bump the connection at step2, Squid must contact the origin server.
</I>&gt;<i> When the cable is unplugged, Squid obviously cannot do that: The attempt
</I>&gt;<i> to open a Squid-AWS connection fails.
</I>&gt;<i>
</I>&gt;<i>  &gt; .../200 0 CONNECT stuff.amazonaws.com:443 - HIER_DIRECT
</I>&gt;<i>  &gt; .../503 4087 GET <A HREF="https://stuff.amazonaws.com/api/...">https://stuff.amazonaws.com/api/...</A> - HIER_NONE
</I>&gt;<i>
</I>&gt;<i> Squid reports bumping errors to the client using HTTP responses. To do
</I>&gt;<i> that, Squid remembers the error response, bumps the client connection,
</I>&gt;<i> receives GET from the client on that bumped connection, and sends that
</I>&gt;<i> error response to the client. This is why you see both CONNECT/200 and
</I>&gt;<i> GET/503 access.log records. Note that Squid does not check whether the
</I>&gt;<i> received GET request would have been a cache hit in this case -- the
</I>&gt;<i> response to that request has been preordained by the earlier bumping
</I>&gt;<i> failure.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Solution candidates to consider include:
</I>&gt;<i>
</I>&gt;<i> * Stop bumping: https_port 443 cert=/etc/squid/stuff.pem
</I>&gt;<i>
</I>&gt;<i> Configure Squid as (a reverse HTTPS proxy for) the AWS service. Use
</I>&gt;<i> https_port. No SslBump rules/options! The client would think that it is
</I>&gt;<i> sending HTTPS requests directly to the service. Squid will forward
</I>&gt;<i> client requests to the service. If this works (and I do not have enough
</I>&gt;<i> information to know that this will work in your specific environment),
</I>&gt;<i> then you will get a much simpler setup.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> * Bump at step1, before Squid contacts AWS: ssl_bump bump all
</I>&gt;<i>
</I>&gt;<i> Bugs notwithstanding, there will be no Squid-AWS connection for cache
</I>&gt;<i> hits. The resulting certificate will not be based on AWS service info,
</I>&gt;<i> but it looks like your client is ignorant enough to ignore related
</I>&gt;<i> certificate problems.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> HTH,
</I>&gt;<i>
</I>&gt;<i> Alex.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; Hi, Hoping someone can help me with this issue that I have been
</I>&gt;<i> &gt; struggling with for days now.   I am setting up squid on an ubuntu PC to
</I>&gt;<i> &gt; forward HTTPS requests to an API and an s3 bucket under my control on
</I>&gt;<i> &gt; amazon AWS.  The reason I am setting up the proxy is two-fold...
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; 1) To reduce costs from AWS.
</I>&gt;<i> &gt; 2) To provide content to the client on the ubuntu PC if there is a
</I>&gt;<i> &gt; networking issue somewhere in between the ubuntu PC and AWS.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Item 1 is going well so far.   Item 2 is not going well.   Setup details
</I>&gt;<i> ...
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; *# squid - setup cache folder*
</I>&gt;<i> &gt; mkdir -p /var/cache/squid
</I>&gt;<i> &gt; chown -R proxy:proxy  /var/cache/squid
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; *# ssl - generate key*
</I>&gt;<i> &gt; apt --yes install squid-openssl libnss3-tools
</I>&gt;<i> &gt; openssl req -new -newkey rsa:2048 -days 365 -nodes -x509 \
</I>&gt;<i> &gt;    -subj &quot;/C=US/ST=Denial/L=Springfield/O=Dis/CN=www.example.com
</I>&gt;<i> &gt; &lt;<A HREF="http://www.example.com">http://www.example.com</A>&gt;&quot; \
</I>&gt;<i> &gt;    -keyout /etc/squid/stuff.pem -out /etc/squid/stuff.pem
</I>&gt;<i> &gt; chown root:proxy /etc/squid/stuff.pem
</I>&gt;<i> &gt; chmod 644  /etc/squid/stuff.pem
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; *# ssl - ssl DB*
</I>&gt;<i> &gt; mkdir -p /var/lib/squid
</I>&gt;<i> &gt; rm -rf /var/lib/squid/ssl_db
</I>&gt;<i> &gt; /usr/lib/squid/security_file_certgen -c -s /var/lib/squid/ssl_db -M 4MB
</I>&gt;<i> &gt; chown -R proxy:proxy /var/lib/squid/ssl_db
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; *# /etc/squid/squid.conf :*
</I>&gt;<i> &gt; acl to_aws dstdomain .amazonaws.com &lt;<A HREF="http://amazonaws.com">http://amazonaws.com</A>&gt;
</I>&gt;<i> &gt; acl from_local src localhost
</I>&gt;<i> &gt; http_access allow to_aws
</I>&gt;<i> &gt; http_access allow from_local
</I>&gt;<i> &gt; cache allow all
</I>&gt;<i> &gt; cache_dir ufs /var/cache/squid 1024 16 256
</I>&gt;<i> &gt; offline_mode on
</I>&gt;<i> &gt; http_port 3129 ssl-bump cert=/etc/squid/stuff.pem
</I>&gt;<i> &gt; generate-host-certificates=on dynamic_cert_mem_cache_size=4MB
</I>&gt;<i> &gt; sslcrtd_program /usr/lib/squid/security_file_certgen -s
</I>&gt;<i> &gt; /var/lib/squid/ssl_db -M 4MB
</I>&gt;<i> &gt; acl step1 at_step SslBump1
</I>&gt;<i> &gt; ssl_bump peek step1
</I>&gt;<i> &gt; ssl_bump bump all
</I>&gt;<i> &gt; sslproxy_cert_error deny all
</I>&gt;<i> &gt; cache_store_log stdio:/var/log/squid/store.log
</I>&gt;<i> &gt; logfile_rotate 0
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; *# /usr/bin/proxy-test :*
</I>&gt;<i> &gt; #!/bin/bash
</I>&gt;<i> &gt; curl --proxy <A HREF="http://localhost:3129">http://localhost:3129</A> &lt;<A HREF="http://localhost:3129">http://localhost:3129</A>&gt; \
</I>&gt;<i> &gt;    --cacert /etc/squid/stuff.pem \
</I>&gt;<i> &gt;    -v &quot;<A HREF="https://stuff.amazonaws.com/api/v1/stuff/stuff.json">https://stuff.amazonaws.com/api/v1/stuff/stuff.json</A>
</I>&gt;<i> &gt; &lt;<A HREF="https://stuff.amazonaws.com/api/v1/stuff/stuff.json">https://stuff.amazonaws.com/api/v1/stuff/stuff.json</A>&gt;&quot; \
</I>&gt;<i> &gt;    -H &quot;Authorization: token MYTOKEN&quot; \
</I>&gt;<i> &gt;    -H &quot;Content-Type: application/json&quot; \
</I>&gt;<i> &gt;    --output &quot;/tmp/stuff.json&quot;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; When network connectivity is GOOD, everything works well and I get cache
</I>&gt;<i> &gt; HITS ...
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; *# /var/log/squid/access.log*
</I>&gt;<i> &gt; 1705587538.837    238 127.0.0.1 NONE_NONE/200 0 CONNECT
</I>&gt;<i> &gt; stuff.amazonaws.com:443 &lt;<A HREF="http://stuff.amazonaws.com:443">http://stuff.amazonaws.com:443</A>&gt; -
</I>&gt;<i> &gt; HIER_DIRECT/3.136.246.238 &lt;<A HREF="http://3.136.246.238">http://3.136.246.238</A>&gt; -
</I>&gt;<i> &gt; 1705587538.838      0 127.0.0.1 TCP_MEM_HIT/200 32818 GET
</I>&gt;<i> &gt; <A HREF="https://stuff.amazonaws.com/api/v1/stuff/stuff.json">https://stuff.amazonaws.com/api/v1/stuff/stuff.json</A>
</I>&gt;<i> &gt; &lt;<A HREF="https://stuff.amazonaws.com/api/v1/stuff/stuff.json">https://stuff.amazonaws.com/api/v1/stuff/stuff.json</A>&gt; - HIER_NONE/-
</I>&gt;<i> &gt; application/json
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; *# extract from /usr/bin/proxy-test output*
</I>&gt;<i> &gt; &lt; HTTP/1.1 200 OK
</I>&gt;<i> &gt; &lt; Date: Thu, 18 Jan 2024 13:38:01 GMT
</I>&gt;<i> &gt; &lt; Content-Type: application/json
</I>&gt;<i> &gt; &lt; Content-Length: 32187
</I>&gt;<i> &gt; &lt; x-amzn-RequestId: 8afba80e-6df7-4d5b-a34b-a70bd9b54380
</I>&gt;<i> &gt; &lt; Last-Modified: 2024-01-03T11:23:19.000Z
</I>&gt;<i> &gt; &lt; Access-Control-Allow-Origin: *
</I>&gt;<i> &gt; &lt; x-amz-apigw-id: RvN1CF2_iYcEokA=
</I>&gt;<i> &gt; &lt; Cache-Control: max-age=2147483648,public,stale-if-error
</I>&gt;<i> &gt; &lt; ETag: &quot;53896156c4e8e26933188a092c4e40f1&quot;
</I>&gt;<i> &gt; &lt; X-Amzn-Trace-Id: Root=1-65a929b9-3bd3285934151c1a2495481a
</I>&gt;<i> &gt; &lt; Age: 2578
</I>&gt;<i> &gt; &lt; Warning: 110 squid/5.7 &quot;Response is stale&quot;
</I>&gt;<i> &gt; &lt; X-Cache: HIT from ubuntu-pc
</I>&gt;<i> &gt; &lt; X-Cache-Lookup: HIT from ubuntu-pc:3129
</I>&gt;<i> &gt; &lt; Via: 1.1 ubuntu-pc (squid/5.7)
</I>&gt;<i> &gt; &lt; Connection: keep-alive
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; When network connectivity is BAD, I get errors and a cache MISS.   In
</I>&gt;<i> &gt; this test case I unplugged the ethernet cable from the back on the
</I>&gt;<i> &gt; ubuntu-pc ...
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; *# /var/log/squid/access.log*
</I>&gt;<i> &gt; 1705588717.420     11 127.0.0.1 NONE_NONE/200 0 CONNECT
</I>&gt;<i> &gt; stuff.amazonaws.com:443 &lt;<A HREF="http://stuff.amazonaws.com:443">http://stuff.amazonaws.com:443</A>&gt; -
</I>&gt;<i> &gt; HIER_DIRECT/3.135.162.228 &lt;<A HREF="http://3.135.162.228">http://3.135.162.228</A>&gt; -
</I>&gt;<i> &gt; 1705588717.420      0 127.0.0.1 NONE_NONE/503 4087 GET
</I>&gt;<i> &gt; <A HREF="https://stuff.amazonaws.com/api/v1/stuff/stuff.json">https://stuff.amazonaws.com/api/v1/stuff/stuff.json</A>
</I>&gt;<i> &gt; &lt;<A HREF="https://stuff.amazonaws.com/api/v1/stuff/stuff.json">https://stuff.amazonaws.com/api/v1/stuff/stuff.json</A>&gt; - HIER_NONE/-
</I>&gt;<i> &gt; text/html
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; *# extract from /usr/bin/proxy-test output*
</I>&gt;<i> &gt; &lt; HTTP/1.1 503 Service Unavailable
</I>&gt;<i> &gt; &lt; Server: squid/5.7
</I>&gt;<i> &gt; &lt; Mime-Version: 1.0
</I>&gt;<i> &gt; &lt; Date: Thu, 18 Jan 2024 14:38:37 GMT
</I>&gt;<i> &gt; &lt; Content-Type: text/html;charset=utf-8
</I>&gt;<i> &gt; &lt; Content-Length: 3692
</I>&gt;<i> &gt; &lt; X-Squid-Error: ERR_CONNECT_FAIL 101
</I>&gt;<i> &gt; &lt; Vary: Accept-Language
</I>&gt;<i> &gt; &lt; Content-Language: en
</I>&gt;<i> &gt; &lt; X-Cache: MISS from ubuntu-pc
</I>&gt;<i> &gt; &lt; X-Cache-Lookup: NONE from ubuntu-pc:3129
</I>&gt;<i> &gt; &lt; Via: 1.1 ubuntu-pc (squid/5.7)
</I>&gt;<i> &gt; &lt; Connection: close
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I have also seen it error in a different way with a 502 but with the
</I>&gt;<i> &gt; same ultimate result.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; My expectation/hope is that squid would return the cached object on any
</I>&gt;<i> &gt; network failure in between ubuntu-pc and the AWS endpoint - and continue
</I>&gt;<i> &gt; to return this cached object forever.   Is this something squid can do?
</I>&gt;<i> &gt;    It would seem that offline_mode should do this?
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Hope you can help,
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Robin
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; _______________________________________________
</I>&gt;<i> &gt; squid-users mailing list
</I>&gt;<i> &gt; <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> &gt; <A HREF="https://lists.squid-cache.org/listinfo/squid-users">https://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20240119/06298d11/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20240119/06298d11/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="026378.html">[squid-users] offline mode not working for me
</A></li>
	<LI>Next message (by thread): <A HREF="026384.html">[squid-users] offline mode not working for me
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26381">[ date ]</a>
              <a href="thread.html#26381">[ thread ]</a>
              <a href="subject.html#26381">[ subject ]</a>
              <a href="author.html#26381">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
