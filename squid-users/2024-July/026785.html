<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] FATAL: assertion failed: mem/PageStack.cc:159: &quot;StoredNode().is_lock_free()&quot;
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20FATAL%3A%20assertion%20failed%3A%20mem/PageStack.cc%3A159%3A%0A%20%22StoredNode%28%29.is_lock_free%28%29%22&In-Reply-To=%3C1cde8458-00c3-4c01-af34-361402283feb%40gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   
   <LINK REL="Next"  HREF="026787.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] FATAL: assertion failed: mem/PageStack.cc:159: &quot;StoredNode().is_lock_free()&quot;</H1>
    <B>Nishant Sharma</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20FATAL%3A%20assertion%20failed%3A%20mem/PageStack.cc%3A159%3A%0A%20%22StoredNode%28%29.is_lock_free%28%29%22&In-Reply-To=%3C1cde8458-00c3-4c01-af34-361402283feb%40gmail.com%3E"
       TITLE="[squid-users] FATAL: assertion failed: mem/PageStack.cc:159: &quot;StoredNode().is_lock_free()&quot;">codemarauder at gmail.com
       </A><BR>
    <I>Wed Jul  3 13:27:10 UTC 2024</I>
    <P><UL>
        
        <LI>Next message (by thread): <A HREF="026787.html">[squid-users] FATAL: assertion failed: mem/PageStack.cc:159: &quot;StoredNode().is_lock_free()&quot;
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26785">[ date ]</a>
              <a href="thread.html#26785">[ thread ]</a>
              <a href="subject.html#26785">[ subject ]</a>
              <a href="author.html#26785">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello,

On 28/06/24 20:01, Nishant Sharma wrote:
&gt;<i> On 28/06/24 19:44, Alex Rousskov wrote:
</I>&gt;&gt;<i> I do not know the answer to your question. SMP performance penalties 
</I>&gt;&gt;<i> are often smaller for smaller cache sizes, but cache size is not the 
</I>&gt;&gt;<i> only performance-affecting locking-sensitive parameter, so YMMV.
</I>&gt;<i> 
</I>&gt;<i> I was able to compile after commenting the specific line of code. Squid 
</I>&gt;<i> workers start and I am able to bind them to specific CPU cores.
</I>
I had reported the issue to Openwrt project as well and I understood 
that in order to save space, squid was being compiled for mips16 instead 
of mips32.

Even after compiling it for mips32 (by adding a flag for the build 
system), the error is still occuring as in the code in 
`ipc/mem/PageStack.h` `uint64_t` is specified.

I was able to compile by replacing `uint64_t` to `uint32_t` and squid 
worked with workers &gt; 1.

Further discussion on Openwrt issue tracker suggested [1] the following:

&lt;quote&gt;
The posix definition is that lock ID is native integer. It should be 
some conditional in ./configure style portability of squid to run on 
(most) 32bit platforms.
&lt;/quote&gt;

Is there any change that we need to do in the configure script to check 
for the availability of 64 bit atomic lock and use 32 bit lock if not 
available?

Or may be document the fact that it is not advisable / possible to run 
squid in SMP mode on such platforms that are not able to provide 64 bit 
lock ID.

I tried to go through config.log and could see the following messages 
which might or might not be related to this:

&lt;config.log&gt;
...
...
...

configure:46036: checking for uint64_t
configure:46036: $? = 0
configure:46036: result: yes

AND

configure:46027: checking for int64_t

configure:46027: mipsel-openwrt-linux-musl-g++ -std=c++17 -c 
-I/home/devuser/openwrt-23.05/arthur/mt7621/openwrt/staging_dir/target-mipsel_24kc_musl/usr/include 
-I/home/devuser/openwrt-23.05/arthur/mt7621/openwrt/staging_dir/target-mipsel_24kc_musl/usr/include 
  -Os -pipe -mno-branch-likely -mips32r2 -mtune=24kc -fno-caller-saves 
-fno-plt -fhonour-copts -msoft-float 
-fmacro-prefix-map=/home/devuser/openwrt-23.05/arthur/mt7621/openwrt/build_dir/target-mipsel_24kc_musl/squid-6.10=squid-6.10 
-Wformat -Werror=format-security -fstack-protector -D_FORTIFY_SOURCE=1 
-Wl,-z,now -Wl,-z,relro -Wno-error 
-I/home/devuser/openwrt-23.05/arthur/mt7621/openwrt/staging_dir/target-mipsel_24kc_musl/usr/include 
-I/home/devuser/openwrt-23.05/arthur/mt7621/openwrt/staging_dir/target-mipsel_24kc_musl/usr/include/libxml2 
-I/home/devuser/openwrt-23.05/arthur/mt7621/openwrt/staging_dir/toolchain-mipsel_24kc_gcc-12.3.0_musl/usr/include 
-I/home/devuser/openwrt-23.05/arthur/mt7621/openwrt/staging_dir/toolchain-mipsel_24kc_gcc-12.3.0_musl/include/fortify 
-I/home/devuser/openwrt-23.05/arthur/mt7621/openwrt/staging_dir/toolchain-mipsel_24kc_gcc-12.3.0_musl/include 
  conftest.cpp &gt;&amp;5
configure:46027: $? = 0

configure:46027: mipsel-openwrt-linux-musl-g++ -std=c++17 -c 
-I/home/devuser/openwrt-23.05/arthur/mt7621/openwrt/staging_dir/target-mipsel_24kc_musl/usr/include 
-I/home/devuser/openwrt-23.05/arthur/mt7621/openwrt/staging_dir/target-mipsel_24kc_musl/usr/include 
  -Os -pipe -mno-branch-likely -mips32r2 -mtune=24kc -fno-caller-saves 
-fno-plt -fhonour-copts -msoft-float 
-fmacro-prefix-map=/home/devuser/openwrt-23.05/arthur/mt7621/openwrt/build_dir/target-mipsel_24kc_musl/squid-6.10=squid-6.10 
-Wformat -Werror=format-security -fstack-protector -D_FORTIFY_SOURCE=1 
-Wl,-z,now -Wl,-z,relro -Wno-error 
-I/home/devuser/openwrt-23.05/arthur/mt7621/openwrt/staging_dir/target-mipsel_24kc_musl/usr/include 
-I/home/devuser/openwrt-23.05/arthur/mt7621/openwrt/staging_dir/target-mipsel_24kc_musl/usr/include/libxml2 
-I/home/devuser/openwrt-23.05/arthur/mt7621/openwrt/staging_dir/toolchain-mipsel_24kc_gcc-12.3.0_musl/usr/include 
-I/home/devuser/openwrt-23.05/arthur/mt7621/openwrt/staging_dir/toolchain-mipsel_24kc_gcc-12.3.0_musl/include/fortify 
-I/home/devuser/openwrt-23.05/arthur/mt7621/openwrt/staging_dir/toolchain-mipsel_24kc_gcc-12.3.0_musl/include 
  conftest.cpp &gt;&amp;5

conftest.cpp: In function 'int main()':
conftest.cpp:324:67: warning: integer overflow in expression of type 
'int64_t' {aka 'long long int'} results in '-9223372036854775808' 
[-Woverflow]
   324 |                  &lt; (int64_t) (((((int64_t) 1 &lt;&lt; N) &lt;&lt; N) - 1) * 
2 + 2))];
       | 
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^~~
conftest.cpp:323:26: error: size '-1' of array 'test_array' is negative
   323 | static int test_array [1 - 2 * !((int64_t) (((((int64_t) 1 &lt;&lt; 
N) &lt;&lt; N) - 1) * 2 + 1)
       | 
~~^~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
   324 |                  &lt; (int64_t) (((((int64_t) 1 &lt;&lt; N) &lt;&lt; N) - 1) * 
2 + 2))];
       | 
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
configure:46027: $? = 1

configure: failed program was:
|<i> /* confdefs.h */
</I>|<i> #define PACKAGE_NAME &quot;Squid Web Proxy&quot;
</I>|<i> #define PACKAGE_TARNAME &quot;squid&quot;
</I>|<i> #define PACKAGE_VERSION &quot;6.10&quot;
</I>|<i> #define PACKAGE_STRING &quot;Squid Web Proxy 6.10&quot;
</I>|<i> #define PACKAGE_BUGREPORT &quot;<A HREF="https://bugs.squid-cache.org/">https://bugs.squid-cache.org/</A>&quot;
</I>|<i> #define PACKAGE_URL &quot;&quot;
</I>...
...
...
...
&lt;/config.log&gt;

Regards,
Nishant

* [1] 
<A HREF="https://github.com/openwrt/packages/issues/24469#issuecomment-2203033868">https://github.com/openwrt/packages/issues/24469#issuecomment-2203033868</A>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	
	<LI>Next message (by thread): <A HREF="026787.html">[squid-users] FATAL: assertion failed: mem/PageStack.cc:159: &quot;StoredNode().is_lock_free()&quot;
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26785">[ date ]</a>
              <a href="thread.html#26785">[ thread ]</a>
              <a href="subject.html#26785">[ subject ]</a>
              <a href="author.html#26785">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
