<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] FATAL: assertion failed: mem/PageStack.cc:159: &quot;StoredNode().is_lock_free()&quot;
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20FATAL%3A%20assertion%20failed%3A%20mem/PageStack.cc%3A159%3A%0A%20%22StoredNode%28%29.is_lock_free%28%29%22&In-Reply-To=%3Cd11426f0-a401-4900-8e2c-e08544a388df%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="026785.html">
   <LINK REL="Next"  HREF="026790.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] FATAL: assertion failed: mem/PageStack.cc:159: &quot;StoredNode().is_lock_free()&quot;</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20FATAL%3A%20assertion%20failed%3A%20mem/PageStack.cc%3A159%3A%0A%20%22StoredNode%28%29.is_lock_free%28%29%22&In-Reply-To=%3Cd11426f0-a401-4900-8e2c-e08544a388df%40measurement-factory.com%3E"
       TITLE="[squid-users] FATAL: assertion failed: mem/PageStack.cc:159: &quot;StoredNode().is_lock_free()&quot;">rousskov at measurement-factory.com
       </A><BR>
    <I>Wed Jul  3 15:57:31 UTC 2024</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="026785.html">[squid-users] FATAL: assertion failed: mem/PageStack.cc:159: &quot;StoredNode().is_lock_free()&quot;
</A></li>
        <LI>Next message (by thread): <A HREF="026790.html">[squid-users] FATAL: assertion failed: mem/PageStack.cc:159: &quot;StoredNode().is_lock_free()&quot;
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26787">[ date ]</a>
              <a href="thread.html#26787">[ thread ]</a>
              <a href="subject.html#26787">[ subject ]</a>
              <a href="author.html#26787">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 2024-07-03 09:27, Nishant Sharma wrote:

&gt;<i> I had reported the issue to Openwrt project as well and I understood 
</I>&gt;<i> that in order to save space, squid was being compiled for mips16 instead 
</I>&gt;<i> of mips32.
</I>
Sorry, I do not know why/how that fact is relevant to this discussion, 
but thank you for sharing it as it may be useful for others.


&gt;<i> Even after compiling it for mips32 (by adding a flag for the build 
</I>&gt;<i> system), the error is still occuring as in the code in 
</I>&gt;<i> `ipc/mem/PageStack.h` `uint64_t` is specified.
</I>
Glad to hear that: That assertion should not depend on those build flags 
AFAICT.


&gt;<i> I was able to compile by replacing `uint64_t` to `uint32_t` and squid 
</I>&gt;<i> worked with workers &gt; 1.
</I>
Where did you replace uint64_t with uint32_t? In IdSet::Node typedef? 
Any other changes? AFAICT, changing just IdSet::Node badly breaks the 
corresponding binary tree code because we hard-code the number of bits 
per leaf node (at least!) to be 64. I did not audit code for other 
dependencies.


&gt;<i> Further discussion on Openwrt issue tracker suggested [1] the following:
</I>&gt;<i> 
</I>&gt;<i> &lt;quote&gt;
</I>&gt;<i> The posix definition is that lock ID is native integer. It should be 
</I>&gt;<i> some conditional in ./configure style portability of squid to run on 
</I>&gt;<i> (most) 32bit platforms.
</I>&gt;<i> &lt;/quote&gt;
</I>
It is possible that the above comment was negatively influenced by the 
previous misleading statement about Squid v4 having no uint64_t: &quot;In 
code for version 4.x, there is no mention of uint64_t. It was introduced 
with 5.x.&quot; In reality, Squid has been using 64-bit integers since before 
Squid v3. It is neither practical nor necessary to remove uint64_t from 
Squid so there will be no corresponding conditionals in ./configure.

The shared binary tree (that contains the assertion) did not exist in 
v4, as we discussed earlier.


&gt;<i> Is there any change that we need to do in the configure script to check 
</I>&gt;<i> for the availability of 64 bit atomic lock and use 32 bit lock if not 
</I>&gt;<i> available?
</I>
It is technically possible (perhaps even without ./configure checks), 
but it would require adjusting complex shared tree code in the abcense 
of comprehensive ready-to-use tests. It is trivial to break that code. 
It is difficult to detect bugs. IMO, we should not expose ourselves to 
such risks in this case, especially since Squid uses 64-bit atomics in 
many other places: Supporting 32 bits in shared binary tree nodes is not 
going to remove the last frequently used 64-bit lock.


&gt;<i> Or may be document the fact that it is not advisable / possible to run 
</I>&gt;<i> squid in SMP mode on such platforms that are not able to provide 64 bit 
</I>&gt;<i> lock ID.
</I>
I believe your experiments with removing the assertion point in a rather 
different direction: If your tests do not suggest otherwise, we should 
downgrade that assertion to a startup warning. Let folks run Squid on 
platforms without 64-bit atomic locks (if they wish to do so), but warn 
them about an uncertain impact. Perhaps we can even convince ourselves 
that the impact can only be on performance (i.e., there can be no 
deadlocks due to mutexes).

Disclaimer: I do not know what &quot;lock ID&quot; is in this context.


HTH,

Alex.


&gt;<i> I tried to go through config.log and could see the following messages 
</I>&gt;<i> which might or might not be related to this:
</I>&gt;<i> 
</I>&gt;<i> &lt;config.log&gt;
</I>&gt;<i> ...
</I>&gt;<i> ...
</I>&gt;<i> ...
</I>&gt;<i> 
</I>&gt;<i> configure:46036: checking for uint64_t
</I>&gt;<i> configure:46036: $? = 0
</I>&gt;<i> configure:46036: result: yes
</I>&gt;<i> 
</I>&gt;<i> AND
</I>&gt;<i> 
</I>&gt;<i> configure:46027: checking for int64_t
</I>&gt;<i> 
</I>&gt;<i> configure:46027: mipsel-openwrt-linux-musl-g++ -std=c++17 -c 
</I>&gt;<i> -I/home/devuser/openwrt-23.05/arthur/mt7621/openwrt/staging_dir/target-mipsel_24kc_musl/usr/include -I/home/devuser/openwrt-23.05/arthur/mt7621/openwrt/staging_dir/target-mipsel_24kc_musl/usr/include &#160;-Os -pipe -mno-branch-likely -mips32r2 -mtune=24kc -fno-caller-saves -fno-plt -fhonour-copts -msoft-float -fmacro-prefix-map=/home/devuser/openwrt-23.05/arthur/mt7621/openwrt/build_dir/target-mipsel_24kc_musl/squid-6.10=squid-6.10 -Wformat -Werror=format-security -fstack-protector -D_FORTIFY_SOURCE=1 -Wl,-z,now -Wl,-z,relro -Wno-error -I/home/devuser/openwrt-23.05/arthur/mt7621/openwrt/staging_dir/target-mipsel_24kc_musl/usr/include -I/home/devuser/openwrt-23.05/arthur/mt7621/openwrt/staging_dir/target-mipsel_24kc_musl/usr/include/libxml2 -I/home/devuser/openwrt-23.05/arthur/mt7621/openwrt/staging_dir/toolchain-mipsel_24kc_gcc-12.3.0_musl/usr/include -I/home/devuser/openwrt-23.05/arthur/mt7621/openwrt/staging_dir/toolchain-mipsel_24kc_gcc-12.3.0_musl/include/fortify -I/home/devuser/openwrt-23.05/arthur/mt7621/openwrt/staging_dir/toolchain-mipsel_24kc_gcc-12.3.0_musl/include &#160;conftest.cpp &gt;&amp;5
</I>&gt;<i> configure:46027: $? = 0
</I>&gt;<i> 
</I>&gt;<i> configure:46027: mipsel-openwrt-linux-musl-g++ -std=c++17 -c 
</I>&gt;<i> -I/home/devuser/openwrt-23.05/arthur/mt7621/openwrt/staging_dir/target-mipsel_24kc_musl/usr/include -I/home/devuser/openwrt-23.05/arthur/mt7621/openwrt/staging_dir/target-mipsel_24kc_musl/usr/include &#160;-Os -pipe -mno-branch-likely -mips32r2 -mtune=24kc -fno-caller-saves -fno-plt -fhonour-copts -msoft-float -fmacro-prefix-map=/home/devuser/openwrt-23.05/arthur/mt7621/openwrt/build_dir/target-mipsel_24kc_musl/squid-6.10=squid-6.10 -Wformat -Werror=format-security -fstack-protector -D_FORTIFY_SOURCE=1 -Wl,-z,now -Wl,-z,relro -Wno-error -I/home/devuser/openwrt-23.05/arthur/mt7621/openwrt/staging_dir/target-mipsel_24kc_musl/usr/include -I/home/devuser/openwrt-23.05/arthur/mt7621/openwrt/staging_dir/target-mipsel_24kc_musl/usr/include/libxml2 -I/home/devuser/openwrt-23.05/arthur/mt7621/openwrt/staging_dir/toolchain-mipsel_24kc_gcc-12.3.0_musl/usr/include -I/home/devuser/openwrt-23.05/arthur/mt7621/openwrt/staging_dir/toolchain-mipsel_24kc_gcc-12.3.0_musl/include/fortify -I/home/devuser/openwrt-23.05/arthur/mt7621/openwrt/staging_dir/toolchain-mipsel_24kc_gcc-12.3.0_musl/include &#160;conftest.cpp &gt;&amp;5
</I>&gt;<i> 
</I>&gt;<i> conftest.cpp: In function 'int main()':
</I>&gt;<i> conftest.cpp:324:67: warning: integer overflow in expression of type 
</I>&gt;<i> 'int64_t' {aka 'long long int'} results in '-9223372036854775808' 
</I>&gt;<i> [-Woverflow]
</I>&gt;<i>  &#160; 324 |&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; &lt; (int64_t) (((((int64_t) 1 &lt;&lt; N) &lt;&lt; N) - 1) * 
</I>&gt;<i> 2 + 2))];
</I>&gt;<i>  &#160;&#160;&#160;&#160;&#160; | ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^~~
</I>&gt;<i> conftest.cpp:323:26: error: size '-1' of array 'test_array' is negative
</I>&gt;<i>  &#160; 323 | static int test_array [1 - 2 * !((int64_t) (((((int64_t) 1 &lt;&lt; 
</I>&gt;<i> N) &lt;&lt; N) - 1) * 2 + 1)
</I>&gt;<i>  &#160;&#160;&#160;&#160;&#160; | ~~^~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
</I>&gt;<i>  &#160; 324 |&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; &lt; (int64_t) (((((int64_t) 1 &lt;&lt; N) &lt;&lt; N) - 1) * 
</I>&gt;<i> 2 + 2))];
</I>&gt;<i>  &#160;&#160;&#160;&#160;&#160; | ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
</I>&gt;<i> configure:46027: $? = 1
</I>&gt;<i> 
</I>&gt;<i> configure: failed program was:
</I>&gt;<i> | /* confdefs.h */
</I>&gt;<i> | #define PACKAGE_NAME &quot;Squid Web Proxy&quot;
</I>&gt;<i> | #define PACKAGE_TARNAME &quot;squid&quot;
</I>&gt;<i> | #define PACKAGE_VERSION &quot;6.10&quot;
</I>&gt;<i> | #define PACKAGE_STRING &quot;Squid Web Proxy 6.10&quot;
</I>&gt;<i> | #define PACKAGE_BUGREPORT &quot;<A HREF="https://bugs.squid-cache.org/">https://bugs.squid-cache.org/</A>&quot;
</I>&gt;<i> | #define PACKAGE_URL &quot;&quot;
</I>&gt;<i> ...
</I>&gt;<i> ...
</I>&gt;<i> ...
</I>&gt;<i> ...
</I>&gt;<i> &lt;/config.log&gt;
</I>&gt;<i> 
</I>&gt;<i> Regards,
</I>&gt;<i> Nishant
</I>&gt;<i> 
</I>&gt;<i> * [1] 
</I>&gt;<i> <A HREF="https://github.com/openwrt/packages/issues/24469#issuecomment-2203033868">https://github.com/openwrt/packages/issues/24469#issuecomment-2203033868</A>
</I>
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="026785.html">[squid-users] FATAL: assertion failed: mem/PageStack.cc:159: &quot;StoredNode().is_lock_free()&quot;
</A></li>
	<LI>Next message (by thread): <A HREF="026790.html">[squid-users] FATAL: assertion failed: mem/PageStack.cc:159: &quot;StoredNode().is_lock_free()&quot;
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26787">[ date ]</a>
              <a href="thread.html#26787">[ thread ]</a>
              <a href="subject.html#26787">[ subject ]</a>
              <a href="author.html#26787">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
