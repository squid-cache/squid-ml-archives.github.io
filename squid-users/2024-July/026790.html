<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] FATAL: assertion failed: mem/PageStack.cc:159: &quot;StoredNode().is_lock_free()&quot;
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20FATAL%3A%20assertion%20failed%3A%20mem/PageStack.cc%3A159%3A%0A%20%22StoredNode%28%29.is_lock_free%28%29%22&In-Reply-To=%3C19461178-4d1c-49e6-b9d7-611596689f8a%40gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="026787.html">
   <LINK REL="Next"  HREF="026792.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] FATAL: assertion failed: mem/PageStack.cc:159: &quot;StoredNode().is_lock_free()&quot;</H1>
    <B>Nishant Sharma</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20FATAL%3A%20assertion%20failed%3A%20mem/PageStack.cc%3A159%3A%0A%20%22StoredNode%28%29.is_lock_free%28%29%22&In-Reply-To=%3C19461178-4d1c-49e6-b9d7-611596689f8a%40gmail.com%3E"
       TITLE="[squid-users] FATAL: assertion failed: mem/PageStack.cc:159: &quot;StoredNode().is_lock_free()&quot;">codemarauder at gmail.com
       </A><BR>
    <I>Thu Jul  4 08:57:51 UTC 2024</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="026787.html">[squid-users] FATAL: assertion failed: mem/PageStack.cc:159: &quot;StoredNode().is_lock_free()&quot;
</A></li>
        <LI>Next message (by thread): <A HREF="026792.html">[squid-users] FATAL: assertion failed: mem/PageStack.cc:159: &quot;StoredNode().is_lock_free()&quot;
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26790">[ date ]</a>
              <a href="thread.html#26790">[ thread ]</a>
              <a href="subject.html#26790">[ subject ]</a>
              <a href="author.html#26790">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 03/07/24 21:27, Alex Rousskov wrote:
&gt;<i> On 2024-07-03 09:27, Nishant Sharma wrote:
</I>&gt;&gt;<i> I was able to compile by replacing `uint64_t` to `uint32_t` and squid 
</I>&gt;&gt;<i> worked with workers &gt; 1.
</I>&gt;<i> 
</I>&gt;<i> Where did you replace uint64_t with uint32_t? In IdSet::Node typedef? 
</I>&gt;<i> Any other changes? AFAICT, changing just IdSet::Node badly breaks the 
</I>&gt;<i> corresponding binary tree code because we hard-code the number of bits 
</I>&gt;<i> per leaf node (at least!) to be 64. I did not audit code for other 
</I>&gt;<i> dependencies.
</I>
In the code for squid-6.10, in ipc/mem/PageStack.h there is just one 
occurrence of `uint64_t` at line 79 inside class IdSet. I had changed 
that. But now I understand that I don't have to, rolled it back.

class IdSet
{
public:
    using size_type = IdSetMeasurement::size_type;
    using Position = IdSetPosition;
...
...
...
private:
    typedef uint64_t Node; ///&lt; either leaf or intermediate node
    typedef std::atomic&lt;Node&gt; StoredNode; ///&lt; a Node stored in shared 
memory
...
...
    // No more data members should follow! See FlexibleArray&lt;&gt; for details.
};

&gt;&gt;<i> Further discussion on Openwrt issue tracker suggested [1] the following:
</I>&gt;&gt;<i>
</I>&gt;<i> 
</I>&gt;<i> It is possible that the above comment was negatively influenced by the 
</I>&gt;<i> previous misleading statement about Squid v4 having no uint64_t: &quot;In 
</I>&gt;<i> code for version 4.x, there is no mention of uint64_t. It was introduced 
</I>&gt;<i> with 5.x.&quot; In reality, Squid has been using 64-bit integers since before 
</I>&gt;<i> Squid v3. It is neither practical nor necessary to remove uint64_t from 
</I>&gt;<i> Squid so there will be no corresponding conditionals in ./configure.
</I>
That was due to my comment there. I actually meant to convey that I 
couldn't find a reference to `uint64_t` in the PageStack.cc file as I 
simply knew that the assert error message is being generated from the 
code in this file.

&gt;<i> The shared binary tree (that contains the assertion) did not exist in 
</I>&gt;<i> v4, as we discussed earlier.
</I>
Ack. This is the correct statement that I should have used while 
replying on Openwrt issue tracker.

&gt;&gt;<i> Is there any change that we need to do in the configure script to 
</I>&gt;&gt;<i> check for the availability of 64 bit atomic lock and use 32 bit lock 
</I>&gt;&gt;<i> if not available?
</I>&gt;<i> 
</I>&gt;<i> It is technically possible (perhaps even without ./configure checks), 
</I>&gt;<i> but it would require adjusting complex shared tree code in the abcense 
</I>&gt;<i> of comprehensive ready-to-use tests. It is trivial to break that code. 
</I>&gt;<i> It is difficult to detect bugs. IMO, we should not expose ourselves to 
</I>&gt;<i> such risks in this case, especially since Squid uses 64-bit atomics in 
</I>&gt;<i> many other places: Supporting 32 bits in shared binary tree nodes is not 
</I>&gt;<i> going to remove the last frequently used 64-bit lock.
</I>
Just being curious here, if a certain platform (mips32 in this case) is 
unable to guarantee a 64 bit atomic lock, other functions except SMP 
mode might get affected as well?

&gt;&gt;<i> Or may be document the fact that it is not advisable / possible to run 
</I>&gt;&gt;<i> squid in SMP mode on such platforms that are not able to provide 64 
</I>&gt;&gt;<i> bit lock ID.
</I>&gt;<i> 
</I>&gt;<i> I believe your experiments with removing the assertion point in a rather 
</I>&gt;<i> different direction: If your tests do not suggest otherwise, we should 
</I>&gt;<i> downgrade that assertion to a startup warning. Let folks run Squid on 
</I>&gt;<i> platforms without 64-bit atomic locks (if they wish to do so), but warn 
</I>&gt;<i> them about an uncertain impact. Perhaps we can even convince ourselves 
</I>&gt;<i> that the impact can only be on performance (i.e., there can be no 
</I>&gt;<i> deadlocks due to mutexes).
</I>&gt;<i> 
</I>&gt;<i> Disclaimer: I do not know what &quot;lock ID&quot; is in this context.
</I>
I am not a programmer and not very well versed with a lot of these 
terms, so I have mixed / messed up while passing messages between the 
two forums.

&quot;lock ID&quot; term was used on Openwrt issue tracker where it was suggested 
that &quot;The assertion assumes 64bit lock id.&quot;. [1]

Let me experiment with squid-6.x on these devices and also use them in 
the live environment.

The only change being commenting out the following line from 
ipc/mem/PageStack.c:

`assertion(StoredNode().is_lock_free());`

I will report back with success or any failures encountered.

Regards,
Nishant

[1] 
&quot;<A HREF="https://github.com/openwrt/packages/issues/24469#issuecomment-2202322703">https://github.com/openwrt/packages/issues/24469#issuecomment-2202322703</A>&quot;

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="026787.html">[squid-users] FATAL: assertion failed: mem/PageStack.cc:159: &quot;StoredNode().is_lock_free()&quot;
</A></li>
	<LI>Next message (by thread): <A HREF="026792.html">[squid-users] FATAL: assertion failed: mem/PageStack.cc:159: &quot;StoredNode().is_lock_free()&quot;
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26790">[ date ]</a>
              <a href="thread.html#26790">[ thread ]</a>
              <a href="subject.html#26790">[ subject ]</a>
              <a href="author.html#26790">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
