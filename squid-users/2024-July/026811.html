<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid as http to https forward proxy
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20as%20http%20to%20https%20forward%20proxy&In-Reply-To=%3Cfe25c303-6335-4256-90d8-1e202d2b29e6%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="026809.html">
   <LINK REL="Next"  HREF="026812.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid as http to https forward proxy</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20as%20http%20to%20https%20forward%20proxy&In-Reply-To=%3Cfe25c303-6335-4256-90d8-1e202d2b29e6%40measurement-factory.com%3E"
       TITLE="[squid-users] Squid as http to https forward proxy">rousskov at measurement-factory.com
       </A><BR>
    <I>Fri Jul  5 13:52:21 UTC 2024</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="026809.html">[squid-users] Squid as http to https forward proxy
</A></li>
        <LI>Next message (by thread): <A HREF="026812.html">[squid-users] Squid as http to https forward proxy
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26811">[ date ]</a>
              <a href="thread.html#26811">[ thread ]</a>
              <a href="subject.html#26811">[ subject ]</a>
              <a href="author.html#26811">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 2024-07-05 09:16, Wagner, Juergen03 wrote:

&gt;<i> Actually we want to be able to connect to any remote server.
</I>&gt;<i> So we are not looking for a solution with a &quot;single true origin server&quot;.
</I>
Thank you for clarifying that.


&gt;<i> My current understanding from your response is, that a simple
</I>&gt;<i> url-rewrite only, as we tried, is not working to forward http
</I>&gt;<i> requests form a client to any https server.
</I>
FWIW, I do not know why URL scheme rewriting does not work in your use 
case. In principle, bugs notwithstanding, I would expect URL scheme 
rewriting to work. In my original response, I was focusing on avoiding 
rewrites for a case where they should not be needed because they should 
not be needed (in that use case) and because they did not work (in your 
specific tests), but _not_ because they should not work in principle or 
on some fundamental level.


&gt;<i> Just to be clear, is the usage of Squid as a forward http proxy for a
</I>&gt;<i> client while using https for external communication possible without
</I>&gt;<i> any Squid code changes?
</I>
That particular question covers several different scenarios. Your use 
case is one of them. The answer for your specific use case is unknown 
(to me) -- I would expect URL scheme rewrites to work but they do not in 
your test. I do not know why.


&gt;<i> Alex: At some point, depending on the use case, it will be easier to
</I>&gt;<i> enhance Squid to encrypt plain HTTP requests
</I>
That comment still applies. However, if you would prefer to avoid (or at 
least reduce) Squid code modifications, it may be useful to triage why 
scheme rewrites do not work in your tests. In other words, why Squid 
generates a &quot;Bad Gateway&quot; error when the rewriter changes request URL 
scheme from &quot;http&quot; to &quot;https&quot;. Sharing a pointer to compressed cache.log 
collected with debug_options set to ALL,9 while reproducing the problem 
with a single test transaction may be the best next step.


HTH,

Alex.


&gt;<i> -----Original Message-----
</I>&gt;<i> From: squid-users &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>&gt; On Behalf Of Alex Rousskov
</I>&gt;<i> Sent: Donnerstag, 4. Juli 2024 18:43
</I>&gt;<i> To: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> Subject: Re: [squid-users] Squid as http to https forward proxy
</I>&gt;<i> 
</I>&gt;<i> CAUTION: This is an external email. Do not click or open any attachments unless you recognize the sender and know that the content is safe. (<A HREF="http://links.conti.de/mailcheck">http://links.conti.de/mailcheck</A>)
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> On 2024-07-04 12:36, Alex Rousskov wrote:
</I>&gt;&gt;<i> On 2024-07-04 10:58, Matus UHLAR - fantomas wrote:
</I>&gt;&gt;&gt;&gt;<i> On 2024-07-04 09:20, Wagner, Juergen03 wrote:
</I>&gt;&gt;&gt;&gt;&gt;<i> we are evaluating Squid to be used as a http to https forward proxy.
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> So Squid would need to support the following setup:
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i>      http (client)    ----&gt;   Squid  ---&gt;  https ( server )
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> Could someone please confirm if the given setup is in principle
</I>&gt;&gt;&gt;&gt;&gt;<i> possible with Squid?
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> If yes, which configuration needs to be done?
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> On 04.07.24 10:36, Alex Rousskov wrote:
</I>&gt;&gt;&gt;&gt;<i>     Yes, Squid should be able to forward plain text HTTP requests to
</I>&gt;&gt;&gt;&gt;<i> a secure server. Use cache_peer directive with &quot;tls&quot; and &quot;originserver&quot;
</I>&gt;&gt;&gt;&gt;<i> flags. Here is an untested sketch:
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>     # routing all traffic to one HTTPS origin server
</I>&gt;&gt;&gt;&gt;<i>     cache_peer 127.0.0.1 parent 443 0 tls originserver \
</I>&gt;&gt;&gt;&gt;<i>         name=MySecureOrigin \
</I>&gt;&gt;&gt;&gt;<i>         no-query no-digest
</I>&gt;&gt;&gt;&gt;<i>     cache_peer_access MySecureOrigin allow all
</I>&gt;&gt;&gt;&gt;<i>     always_direct deny all
</I>&gt;&gt;&gt;&gt;<i>     never_direct allow all
</I>&gt;&gt;&gt;&gt;<i>     nonhierarchical_direct off
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Afaik this means that it is not possible with any remote server,
</I>&gt;&gt;&gt;<i> because all servers you want to access this way must be explicitly
</I>&gt;&gt;&gt;<i> set up in squid.conf, correct?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I assumed (possibly incorrectly) that Juergen was asking about a
</I>&gt;&gt;<i> single &quot;true origin server&quot; (e.g., example.com). The above example was
</I>&gt;&gt;<i> written with a single &quot;true origin server&quot; in mind. However, exactly
</I>&gt;&gt;<i> the same Squid configuration may work to forward traffic to a reverse
</I>&gt;&gt;<i> proxy (running at 127.0.0.1 on port 443) that &quot;represents&quot;
</I>&gt;&gt;<i> multiple/different &quot;true origin servers&quot;.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> That reverse proxy will need to shovel TLS bytes received from Squid
</I>&gt;&gt;<i> to the right &quot;true origin server&quot;, but I am guessing that it can do
</I>&gt;&gt;<i> that based on TLS SNI supplied by Squid. Some Squid code modifications
</I>&gt;&gt;<i> may be necessary to make this work correctly with persistent
</I>&gt;&gt;<i> Squid-to-peer connections and such, but nothing major AFAICT (and they
</I>&gt;&gt;<i> can be turned off using server_persistent_connections if they are in the way).
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> AFAICT, with either SslBump or some Squid code modifications, that
</I>&gt;&gt;<i> reverse proxy can be a Squid proxy. With even more Squid enhancements,
</I>&gt;&gt;<i> that reverse proxy can also become an https_port on the same Squid
</I>&gt;&gt;<i> proxy instance where the http_port receives plain HTTP requests!
</I>&gt;<i> 
</I>&gt;<i> At some point, depending on the use case, it will be easier to enhance Squid to encrypt plain HTTP requests without using this TLS cache_peer hack, of course.
</I>&gt;<i> 
</I>&gt;<i> Alex.
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">https://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">https://lists.squid-cache.org/listinfo/squid-users</A>
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="026809.html">[squid-users] Squid as http to https forward proxy
</A></li>
	<LI>Next message (by thread): <A HREF="026812.html">[squid-users] Squid as http to https forward proxy
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26811">[ date ]</a>
              <a href="thread.html#26811">[ thread ]</a>
              <a href="subject.html#26811">[ subject ]</a>
              <a href="author.html#26811">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
