<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid 6.6 kick abandoning connections
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%206.6%20kick%20abandoning%20connections&In-Reply-To=%3C000201dad260%247bfe07b0%2473fa1710%24%40gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="026840.html">
   <LINK REL="Next"  HREF="026925.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid 6.6 kick abandoning connections</H1>
    <B>jonathanlee571 at gmail.com</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%206.6%20kick%20abandoning%20connections&In-Reply-To=%3C000201dad260%247bfe07b0%2473fa1710%24%40gmail.com%3E"
       TITLE="[squid-users] Squid 6.6 kick abandoning connections">jonathanlee571 at gmail.com
       </A><BR>
    <I>Wed Jul 10 00:31:18 UTC 2024</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="026840.html">[squid-users] Squid 6.6 kick abandoning connections
</A></li>
        <LI>Next message (by thread): <A HREF="026925.html">[squid-users] Squid 6.6 kick abandoning connections
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26848">[ date ]</a>
              <a href="thread.html#26848">[ thread ]</a>
              <a href="subject.html#26848">[ subject ]</a>
              <a href="author.html#26848">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I found the older patch from 2017 I cant find the path to client_sid_request.cc in the pfsense filesystem 

Does anyone know the path to this file &quot;modified file 'src/client_side_request.cc&quot; so I can test it with the patches application if it doesn&#8217;t work no big deal I can just restore it to to prior and or use an older boot environment




kick abandoning [connection]&quot; message in cache.log

This patch call quitAfterError() to force Squid to close the connection after
writing a &quot;Host header forgery&quot; error response  instead of just logging a
[misleading] &quot;kick abandoning [connection]&quot; message in cache.log.

This is a Measurement Factory project

=== modified file 'src/client_side_request.cc'
--- src/client_side_request.cc	2017-02-07 23:11:33 +0000
+++ src/client_side_request.cc	2017-03-31 08:00:01 +0000
@@ -564,40 +564,41 @@
         debugs(85, 3, &quot;SECURITY ALERT: Host header forgery detected on &quot; &lt;&lt; http-&gt;getConn()-&gt;clientConnection &lt;&lt;
                &quot; (&quot; &lt;&lt; A &lt;&lt; &quot; does not match &quot; &lt;&lt; B &lt;&lt; &quot;) on URL: &quot; &lt;&lt; http-&gt;request-&gt;effectiveRequestUri());
 
         // NP: it is tempting to use 'flags.noCache' but that is all about READing cache data.
         // The problems here are about WRITE for new cache content, which means flags.cachable
         http-&gt;request-&gt;flags.cachable = false; // MUST NOT cache (for now)
         // XXX: when we have updated the cache key to base on raw-IP + URI this cacheable limit can go.
         http-&gt;request-&gt;flags.hierarchical = false; // MUST NOT pass to peers (for now)
         // XXX: when we have sorted out the best way to relay requests properly to peers this hierarchical limit can go.
         http-&gt;doCallouts();
         return;
     }
 
     debugs(85, DBG_IMPORTANT, &quot;SECURITY ALERT: Host header forgery detected on &quot; &lt;&lt;
            http-&gt;getConn()-&gt;clientConnection &lt;&lt; &quot; (&quot; &lt;&lt; A &lt;&lt; &quot; does not match &quot; &lt;&lt; B &lt;&lt; &quot;)&quot;);
     if (const char *ua = http-&gt;request-&gt;header.getStr(Http::HdrType::USER_AGENT))
         debugs(85, DBG_IMPORTANT, &quot;SECURITY ALERT: By user agent: &quot; &lt;&lt; ua);
     debugs(85, DBG_IMPORTANT, &quot;SECURITY ALERT: on URL: &quot; &lt;&lt; http-&gt;request-&gt;effectiveRequestUri());
 
     // IP address validation for Host: failed. reject the connection.
+    http-&gt;getConn()-&gt;quitAfterError(http-&gt;request);
     clientStreamNode *node = (clientStreamNode *)http-&gt;client_stream.tail-&gt;prev-&gt;data;
     clientReplyContext *repContext = dynamic_cast&lt;clientReplyContext *&gt;(node-&gt;data.getRaw());
     assert (repContext);
     repContext-&gt;setReplyToError(ERR_CONFLICT_HOST, Http::scConflict,
                                 http-&gt;request-&gt;method, NULL,
                                 http-&gt;getConn()-&gt;clientConnection-&gt;remote,
                                 http-&gt;request,
                                 NULL,
 #if USE_AUTH
                                 http-&gt;getConn() != NULL &amp;&amp; http-&gt;getConn()-&gt;getAuth() != NULL ?
                                 http-&gt;getConn()-&gt;getAuth() : http-&gt;request-&gt;auth_user_request);
 #else
                                 NULL);
 #endif
     node = (clientStreamNode *)http-&gt;client_stream.tail-&gt;data;
     clientStreamRead(node, http, node-&gt;readBuffer);
 }
 
 void
 ClientRequestContext::hostHeaderVerify()



-----Original Message-----
From: Alex Rousskov &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt; 
Sent: Monday, July 8, 2024 10:41 AM
To: squid-users &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>&gt;
Cc: Jonathan Lee &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">jonathanlee571 at gmail.com</A>&gt;
Subject: Re: [squid-users] Squid 6.6 kick abandoning connections

On 2024-07-08 12:31, Jonathan Lee wrote:

&gt;<i> I can confirm I have no ipv6 our isp is ipv4 only and I have IPv6 
</I>&gt;<i> disabled on the firewall and with layer 2 and 3 traffic
</I>
This problem is not specific to any IP family/version.

Alex.


&gt;&gt;<i> On Jul 8, 2024, at 09:15, Alex Rousskov &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt; wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &#65279;On 2024-07-05 21:07, Jonathan Lee wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> I am using Bump with certificates installed on devices does anyone know what this error is...
</I>&gt;&gt;&gt;<i> kick abandoning conn43723 local=192.168.1.1:3128 
</I>&gt;&gt;&gt;<i> remote=192.168.1.5:52129 FD 178 flags=1
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> This &quot;kick abandoning&quot; message marks a Squid problem or bug: Squid enters a seemingly impossible state. In some (but probably not all) cases, the client connection might become stuck (hopefully until some timeout closes it). In some (and possibly all) cases, Squid might immediately close the connection and nobody gets hurt. Code reporting this problem does not know how we got here and what will happen next.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> There were several incomplete/unfinished attempts to fix this problem, including two different patches posted at Bug 3715. I do not know whether either of them is safe and applies to Squid v6. Neither is a comprehensive solution.
</I>&gt;&gt;<i> <A HREF="https://bugs.squid-cache.org/show_bug.cgi?id=3715">https://bugs.squid-cache.org/show_bug.cgi?id=3715</A>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Does anyone know how to fix my last weird error I have with Squid 
</I>&gt;&gt;&gt;<i> 6.6
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I do not know of a good configuration-based workaround. Squid code modifications are required to properly address this problem. Other errors may trigger this bug, so addressing those other errors may hide (and reduce the pressure to fix) this bug. Besides fixing those other errors (if any -- I am aware that you have said that there are no other errors left, but perhaps you found other problems since then), these basic options apply:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> <A HREF="https://wiki.squid-cache.org/SquidFaq/AboutSquid#how-to-add-a-new-squ">https://wiki.squid-cache.org/SquidFaq/AboutSquid#how-to-add-a-new-squ</A>
</I>&gt;&gt;<i> id-feature-enhance-of-fix-something
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Alex.
</I>&gt;&gt;<i>
</I>


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="026840.html">[squid-users] Squid 6.6 kick abandoning connections
</A></li>
	<LI>Next message (by thread): <A HREF="026925.html">[squid-users] Squid 6.6 kick abandoning connections
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26848">[ date ]</a>
              <a href="thread.html#26848">[ thread ]</a>
              <a href="subject.html#26848">[ subject ]</a>
              <a href="author.html#26848">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
