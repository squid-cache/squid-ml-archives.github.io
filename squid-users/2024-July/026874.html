<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Rewriting HTTP to HTTPS for generic package proxy
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Rewriting%20HTTP%20to%20HTTPS%20for%20generic%20package%20proxy&In-Reply-To=%3Cb44b830f-3ec4-4464-adf3-5695fe280ad5%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="026868.html">
   <LINK REL="Next"  HREF="026877.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Rewriting HTTP to HTTPS for generic package proxy</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Rewriting%20HTTP%20to%20HTTPS%20for%20generic%20package%20proxy&In-Reply-To=%3Cb44b830f-3ec4-4464-adf3-5695fe280ad5%40measurement-factory.com%3E"
       TITLE="[squid-users] Rewriting HTTP to HTTPS for generic package proxy">rousskov at measurement-factory.com
       </A><BR>
    <I>Thu Jul 11 16:15:07 UTC 2024</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="026868.html">[squid-users] Rewriting HTTP to HTTPS for generic package proxy
</A></li>
        <LI>Next message (by thread): <A HREF="026877.html">[squid-users] Rewriting HTTP to HTTPS for generic package proxy
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26874">[ date ]</a>
              <a href="thread.html#26874">[ thread ]</a>
              <a href="subject.html#26874">[ subject ]</a>
              <a href="author.html#26874">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 2024-07-10 16:57, Fiehe, Christoph wrote:

&gt;<i> I am just trying to find something that helps to narrow down the
</I>&gt;<i> problem. What I want to achieve is, that a client can use HTTP in the
</I>&gt;<i> LAN, so that Squid can cache distribution packages without making use
</I>&gt;<i> of SSL intercepting when repos are only accessible via HTTPS.
</I>
OK.


&gt;<i> In that case the secure connection must start at the proxy and end on
</I>&gt;<i> the target server with or without any upstream proxies in betweem.
</I>
It depends on whether you trust the parent proxy:

If you trust the parent proxy, then you can use two secure connections:

1.1. child - parent (TLS; no CONNECT)
1.2. parent - origin (TLS; no CONNECT)

If you do not trust the parent proxy, then, yes, you will need a tunnel:

2.1. child - parent (CONNECT)
2.2. child - origin (TLS inside the CONNECT tunnel)

N.B. CONNECT request in 2.1 may be plain text (common) or encrypted 
(rare); I am ignoring the difference between those two subcases for now.


&gt;<i> We have the following setup:
</I>&gt;<i> 
</I>&gt;<i> client -&gt; downstream proxy -&gt; upstream proxy -&gt; <A HREF="https://download.docker.com">https://download.docker.com</A>
</I>&gt;<i> 
</I>&gt;<i> Now let us assume the client wants to retrieve the following resource <A HREF="http://download.docker.com/linux/ubuntu/dists/jammy/InRelease">http://download.docker.com/linux/ubuntu/dists/jammy/InRelease</A> from the upstream proxy.
</I>&gt;<i> 
</I>&gt;<i> The client initiates a HTTP GET request and sends it to the downstream proxy. Now, the URL gets rewritten.
</I>
OK.


&gt;<i> It indicates to use a HTTPS connection instead in order to talk to the target server, in our case the result is <A HREF="https://download.docker.com/linux/ubuntu/dists/jammy/InRelease.">https://download.docker.com/linux/ubuntu/dists/jammy/InRelease.</A>
</I>
Yes, but HTTPS scheme does not imply that the child Squid has to use 
CONNECT. There are two possible scenarios detailed above. I do not know 
which of them applies to your use case.


&gt;<i> Now comes the critical point: From my understanding &#8211; it may be 
</I>&gt;<i> wrongof course - the downstream server now has to send a CONNECT 
</I>&gt;<i> request to the upstream server
</I>
Yes, provided the child (downstream) proxy does not trust that parent 
(upstream) proxy. That is scenario 2. Scenario 1 is different.


&gt;<i> to advise him to establish a secure connection to the target server.
</I>
No, the CONNECT tunnel itself is just a pair of TCP connections. The 
parent proxy &quot;secures&quot; nothing but basic TCP connectivity. It is the 
child proxy that negotiates TLS (over/inside that tunnel) with the 
origin server.


&gt;<i> After creation, the downstream proxy can retrieve the resource and
</I>&gt;<i> send it back to the client via plain HTTP.
</I>
Yes.



&gt;<i> I suppose, that the GnuTLS occurs because of a missing SSL handshake
</I>&gt;<i> between downstream proxy and download.docker.com.
</I>
At this time, I can only say that a TLS negotiation error occurs (while 
child Squid is using the encryption library it probably should not be 
using for this). It is not yet clear to me whether child Squid is 
negotiating with the wrong hop or something goes wrong during 
negotiation with the right hop.

As the next steps, I recommend switching to OpenSSL and, if that alone 
does not help, sharing new errors and determining whether you want to 
use scenario 1 (no CONNECT), scenario 2 (CONNECT), or either (whichever 
works): Do you trust the parent Squid?


HTH,

Alex.


&gt;&gt;<i> -----Urspr&#252;ngliche Nachricht-----
</I>&gt;&gt;<i> Von: Alex Rousskov &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt;
</I>&gt;&gt;<i> Gesendet: Mittwoch, 10. Juli 2024 22:15
</I>&gt;&gt;<i> An: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;&gt;<i> Cc: Fiehe, Christoph &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">c.fiehe at eurodata.de</A>&gt;
</I>&gt;&gt;<i> Betreff: AW: [squid-users] Rewriting HTTP to HTTPS for generic package proxy
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> On 2024-07-10 15:31, Fiehe, Christoph wrote:
</I>&gt;&gt;&gt;<i> The problem is that the proxy just forwards the client GET request to the upstream proxy
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Why does sending a GET request to the upstream proxy represent a problem
</I>&gt;&gt;<i> in your use case? I cannot find anything in your prior messages on this
</I>&gt;&gt;<i> thread that would preclude sending a GET request to the upstream proxy.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> but in that case a CONNECT is required.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Why?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Please do not interpret my response as implying that this &quot;must send
</I>&gt;&gt;<i> CONNECT&quot; requirement is wrong (or correct). At this point, I am just
</I>&gt;&gt;<i> trying to understand what problem(s) you are trying to solve beyond the
</I>&gt;&gt;<i> one you have originally described.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Thank you,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Alex.
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">https://lists.squid-cache.org/listinfo/squid-users</A>
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="026868.html">[squid-users] Rewriting HTTP to HTTPS for generic package proxy
</A></li>
	<LI>Next message (by thread): <A HREF="026877.html">[squid-users] Rewriting HTTP to HTTPS for generic package proxy
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26874">[ date ]</a>
              <a href="thread.html#26874">[ thread ]</a>
              <a href="subject.html#26874">[ subject ]</a>
              <a href="author.html#26874">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
