<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Rewriting HTTP to HTTPS for generic package proxy
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Rewriting%20HTTP%20to%20HTTPS%20for%20generic%20package%20proxy&In-Reply-To=%3C41737fa0-ab1a-4d94-a355-eb77a1fabc21%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="026877.html">
   <LINK REL="Next"  HREF="026933.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Rewriting HTTP to HTTPS for generic package proxy</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Rewriting%20HTTP%20to%20HTTPS%20for%20generic%20package%20proxy&In-Reply-To=%3C41737fa0-ab1a-4d94-a355-eb77a1fabc21%40measurement-factory.com%3E"
       TITLE="[squid-users] Rewriting HTTP to HTTPS for generic package proxy">rousskov at measurement-factory.com
       </A><BR>
    <I>Thu Jul 11 18:27:20 UTC 2024</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="026877.html">[squid-users] Rewriting HTTP to HTTPS for generic package proxy
</A></li>
        <LI>Next message (by thread): <A HREF="026933.html">[squid-users] Rewriting HTTP to HTTPS for generic package proxy
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26883">[ date ]</a>
              <a href="thread.html#26883">[ thread ]</a>
              <a href="subject.html#26883">[ subject ]</a>
              <a href="author.html#26883">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 2024-07-11 13:37, Fiehe, Christoph wrote:
&gt;<i> My proxy (the child proxy) already uses the OpenSSL library:
</I>
Good.


&gt;<i> The parent proxy was compiled ... '--with-gnutls'
</I>
&gt;<i> The GnuTLS exception is thrown at my parent proxy. 
</I>
Thank you for reminding me of that fact; I did not notice or have 
forgotten about it. I assume you cannot rebuild your parent proxy to use 
OpenSSL.

I see the following choice:

A) Continue with the current no-CONNECT setup: Find somebody who can 
help you get Squid+GnuTLS code path working on the parent proxy. It 
might be impossible to get this working without making build or 
configuration changes at the parent proxy. Moreover, please note that 
your current no-CONNECT setup lacks encryption on the child-parent 
segment. If that was not intentional, then fixing that will increase 
TLS-related work for the parent, potentially triggering more problems there.

B) Switch to a CONNECT-based setup: Find somebody who can enhance Squid 
code to establish a CONNECT tunnel through parent proxy when dealing 
with a GET-https request. Today, Squid will not do that AFAICT[^1].

<A HREF="https://wiki.squid-cache.org/SquidFaq/AboutSquid#how-to-add-a-new-squid-feature-enhance-of-fix-something">https://wiki.squid-cache.org/SquidFaq/AboutSquid#how-to-add-a-new-squid-feature-enhance-of-fix-something</A>


[^1]: AFAICT: Today, there are two primary Squid code conditions for 
establishing a CONNECT tunnel on a caching code path: Request method is 
CONNECT or SslBump is in use. Neither matches your GET-https request 
scenario. Squid current behavior is not &quot;wrong&quot; (as detailed in my 
earlier email about CONNECT and no-CONNECT scenarios), so, to make these 
changes official, the author will need to add a configuration option to 
let admins enable this behavior. The corresponding code changes feel 
straightforward to me, but I have not studied any details.


HTH,

Alex.



&gt;<i> Unfortunately, I cannot make any changes here. So yes, I trust my parent proxy, but not using a tunnel between child and parent does not seem to work and results in the TLS exception on the parent proxy.
</I>&gt;<i> 
</I>&gt;<i> I have not find a way to tell my child proxy to always setup a tunnel through the parent proxy, when the target server talks HTTPS. Do you know, how to achieve that? It would be a promising approach.
</I>&gt;<i> 
</I>&gt;<i> Thank you very much help and your patience, Alex.
</I>&gt;<i> 
</I>&gt;<i> Regards,
</I>&gt;<i> Christoph
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> -----Urspr&#252;ngliche Nachricht-----
</I>&gt;&gt;<i> Von: squid-users &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>&gt; Im Auftrag von Alex Rousskov
</I>&gt;&gt;<i> Gesendet: Donnerstag, 11. Juli 2024 18:15
</I>&gt;&gt;<i> An: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;&gt;<i> Betreff: Re: [squid-users] Rewriting HTTP to HTTPS for generic package proxy
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> On 2024-07-10 16:57, Fiehe, Christoph wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> I am just trying to find something that helps to narrow down the
</I>&gt;&gt;&gt;<i> problem. What I want to achieve is, that a client can use HTTP in the
</I>&gt;&gt;&gt;<i> LAN, so that Squid can cache distribution packages without making use
</I>&gt;&gt;&gt;<i> of SSL intercepting when repos are only accessible via HTTPS.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> OK.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> In that case the secure connection must start at the proxy and end on
</I>&gt;&gt;&gt;<i> the target server with or without any upstream proxies in betweem.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> It depends on whether you trust the parent proxy:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> If you trust the parent proxy, then you can use two secure connections:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> 1.1. child - parent (TLS; no CONNECT)
</I>&gt;&gt;<i> 1.2. parent - origin (TLS; no CONNECT)
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> If you do not trust the parent proxy, then, yes, you will need a tunnel:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> 2.1. child - parent (CONNECT)
</I>&gt;&gt;<i> 2.2. child - origin (TLS inside the CONNECT tunnel)
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> N.B. CONNECT request in 2.1 may be plain text (common) or encrypted
</I>&gt;&gt;<i> (rare); I am ignoring the difference between those two subcases for now.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> We have the following setup:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> client -&gt; downstream proxy -&gt; upstream proxy -&gt; <A HREF="https://download.docker.com">https://download.docker.com</A>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Now let us assume the client wants to retrieve the following resource
</I>&gt;&gt;<i> <A HREF="http://download.docker.com/linux/ubuntu/dists/jammy/InRelease">http://download.docker.com/linux/ubuntu/dists/jammy/InRelease</A> from the upstream proxy.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> The client initiates a HTTP GET request and sends it to the downstream proxy. Now, the
</I>&gt;&gt;<i> URL gets rewritten.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> OK.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> It indicates to use a HTTPS connection instead in order to talk to the target server, in
</I>&gt;&gt;<i> our case the result is <A HREF="https://download.docker.com/linux/ubuntu/dists/jammy/InRelease.">https://download.docker.com/linux/ubuntu/dists/jammy/InRelease.</A>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Yes, but HTTPS scheme does not imply that the child Squid has to use
</I>&gt;&gt;<i> CONNECT. There are two possible scenarios detailed above. I do not know
</I>&gt;&gt;<i> which of them applies to your use case.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Now comes the critical point: From my understanding &#8211; it may be
</I>&gt;&gt;&gt;<i> wrongof course - the downstream server now has to send a CONNECT
</I>&gt;&gt;&gt;<i> request to the upstream server
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Yes, provided the child (downstream) proxy does not trust that parent
</I>&gt;&gt;<i> (upstream) proxy. That is scenario 2. Scenario 1 is different.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> to advise him to establish a secure connection to the target server.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> No, the CONNECT tunnel itself is just a pair of TCP connections. The
</I>&gt;&gt;<i> parent proxy &quot;secures&quot; nothing but basic TCP connectivity. It is the
</I>&gt;&gt;<i> child proxy that negotiates TLS (over/inside that tunnel) with the
</I>&gt;&gt;<i> origin server.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> After creation, the downstream proxy can retrieve the resource and
</I>&gt;&gt;&gt;<i> send it back to the client via plain HTTP.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Yes.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> I suppose, that the GnuTLS occurs because of a missing SSL handshake
</I>&gt;&gt;&gt;<i> between downstream proxy and download.docker.com.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> At this time, I can only say that a TLS negotiation error occurs (while
</I>&gt;&gt;<i> child Squid is using the encryption library it probably should not be
</I>&gt;&gt;<i> using for this). It is not yet clear to me whether child Squid is
</I>&gt;&gt;<i> negotiating with the wrong hop or something goes wrong during
</I>&gt;&gt;<i> negotiation with the right hop.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> As the next steps, I recommend switching to OpenSSL and, if that alone
</I>&gt;&gt;<i> does not help, sharing new errors and determining whether you want to
</I>&gt;&gt;<i> use scenario 1 (no CONNECT), scenario 2 (CONNECT), or either (whichever
</I>&gt;&gt;<i> works): Do you trust the parent Squid?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> HTH,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Alex.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> -----Urspr&#252;ngliche Nachricht-----
</I>&gt;&gt;&gt;&gt;<i> Von: Alex Rousskov &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt;
</I>&gt;&gt;&gt;&gt;<i> Gesendet: Mittwoch, 10. Juli 2024 22:15
</I>&gt;&gt;&gt;&gt;<i> An: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;&gt;&gt;&gt;<i> Cc: Fiehe, Christoph &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">c.fiehe at eurodata.de</A>&gt;
</I>&gt;&gt;&gt;&gt;<i> Betreff: AW: [squid-users] Rewriting HTTP to HTTPS for generic package proxy
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> On 2024-07-10 15:31, Fiehe, Christoph wrote:
</I>&gt;&gt;&gt;&gt;&gt;<i> The problem is that the proxy just forwards the client GET request to the upstream
</I>&gt;&gt;<i> proxy
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> Why does sending a GET request to the upstream proxy represent a problem
</I>&gt;&gt;&gt;&gt;<i> in your use case? I cannot find anything in your prior messages on this
</I>&gt;&gt;&gt;&gt;<i> thread that would preclude sending a GET request to the upstream proxy.
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> but in that case a CONNECT is required.
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> Why?
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> Please do not interpret my response as implying that this &quot;must send
</I>&gt;&gt;&gt;&gt;<i> CONNECT&quot; requirement is wrong (or correct). At this point, I am just
</I>&gt;&gt;&gt;&gt;<i> trying to understand what problem(s) you are trying to solve beyond the
</I>&gt;&gt;&gt;&gt;<i> one you have originally described.
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> Thank you,
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> Alex.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;&gt;<i> squid-users mailing list
</I>&gt;&gt;&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;&gt;&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">https://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;<i> squid-users mailing list
</I>&gt;&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">https://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">https://lists.squid-cache.org/listinfo/squid-users</A>
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="026877.html">[squid-users] Rewriting HTTP to HTTPS for generic package proxy
</A></li>
	<LI>Next message (by thread): <A HREF="026933.html">[squid-users] Rewriting HTTP to HTTPS for generic package proxy
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26883">[ date ]</a>
              <a href="thread.html#26883">[ thread ]</a>
              <a href="subject.html#26883">[ subject ]</a>
              <a href="author.html#26883">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
