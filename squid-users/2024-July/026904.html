<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Socket handle leak?
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Socket%20handle%20leak%3F&In-Reply-To=%3C83789855-5dff-49c4-80ed-0d35120aa8c2%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="026903.html">
   <LINK REL="Next"  HREF="026908.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Socket handle leak?</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Socket%20handle%20leak%3F&In-Reply-To=%3C83789855-5dff-49c4-80ed-0d35120aa8c2%40measurement-factory.com%3E"
       TITLE="[squid-users] Socket handle leak?">rousskov at measurement-factory.com
       </A><BR>
    <I>Fri Jul 12 13:42:53 UTC 2024</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="026903.html">[squid-users] Socket handle leak?
</A></li>
        <LI>Next message (by thread): <A HREF="026908.html">[squid-users] cachemgr.cgi isn't mgr:info ?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26904">[ date ]</a>
              <a href="thread.html#26904">[ thread ]</a>
              <a href="subject.html#26904">[ subject ]</a>
              <a href="author.html#26904">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 2024-07-12 06:58, <A HREF="https://lists.squid-cache.org/listinfo/squid-users">paolo.prinx at gmail.com</A> wrote:

&gt;<i> We are having some stability issues with our squid farms after a recent 
</I>&gt;<i> upgrade from Centos/Squid 3.5.x to Ubuntu/Squid 5.7/6.9.
</I>
&gt;<i> In short, after running for a certain period the servers run out of file 
</I>&gt;<i> descriptors. We see a slowly growing number of TCP or TCPv6 socket 
</I>&gt;<i> handles
</I>
Assuming that your Squids are not under an ever-increasing load, what 
you describe sounds like a Squid bug. I do not see any obviously related 
fixes in the latest official code, so it is possible that this bug is 
unknown to Squid developers and is still present in v6+. I recommend the 
following steps:

1. Forget about Squid v5. Aim to upgrade to Squid v6.

2. Collect a few mgr:filedescriptors cache manager snapshots from a 
problematic Squid in hope to discover a common theme among leaked 
descriptors metadata. Share your findings (and/or a pointer to 
compressed snapshots).

3. Check cache.log for frequent (or at least persistent) ERROR and 
WARNING messages and report your findings.

4. Does your Squid grow its resident memory usage as well? Descriptor 
leaks are often (but not always!) accompanied by memory leaks. The 
latter are sometimes easier to pinpoint. If (and only if) your Squid is 
leaking a lot of memory, then collect a few dozen mgr:mem snapshots 
(e.g., one every busy hour) and share a pointer to a compressed snapshot 
  archive for analysis by Squid developers. There is at least one v6 
memory leak fixed in master/v7 (Bug 5322), but, hopefully, you are not 
suffering from that memory leak (otherwise the noise from that leak may 
obscure what we are looking for).


You may continue this triage on this mailing list or file a bug report 
at <A HREF="https://bugs.squid-cache.org/enter_bug.cgi?product=Squid">https://bugs.squid-cache.org/enter_bug.cgi?product=Squid</A>


Thank you,

Alex.



&gt;<i> It is somewhat similar to what reported under 
</I>&gt;<i> <A HREF="https://access.redhat.com/solutions/3362211">https://access.redhat.com/solutions/3362211</A> 
</I>&gt;<i> &lt;<A HREF="https://access.redhat.com/solutions/3362211">https://access.redhat.com/solutions/3362211</A>&gt;&#160;. They state that
</I>&gt;<i> 
</I>&gt;<i>   * /If an application fails to |close()|&#160;it's socket descriptors and
</I>&gt;<i>     continues to allocate new sockets then it can use up all the system
</I>&gt;<i>     memory on TCP(v6) slab objects./
</I>&gt;<i>   * /Note some of these sockets will not show up in
</I>&gt;<i>     |/proc/net/sockstat(6)|. Sockets that still have a file descriptor
</I>&gt;<i>     but are in the |TCP_CLOSE|&#160;state will consume a slab object. But
</I>&gt;<i>     will not be accounted for in |/proc/net/sockstat(6)|&#160;or &quot;ss&quot; or
</I>&gt;<i>     &quot;netstat&quot;./
</I>&gt;<i>   * It can be determined whether this is an application sockets leak, by
</I>&gt;<i>     stopping the application processes that are consuming sockets. If
</I>&gt;<i>     the slab objects in |/proc/slabinfo|&#160;are freed then the application
</I>&gt;<i>     is responsible. As that means that destructor routines have found
</I>&gt;<i>     open file descriptors to sockets in the process.
</I>&gt;<i> 
</I>&gt;<i> /
</I>&gt;<i> /
</I>&gt;<i> /&quot;/This is most likely to be a case of the application not handling 
</I>&gt;<i> error conditions correctly and not calling |close()|&#160;to free the FD and 
</I>&gt;<i> socket.&quot;/
</I>&gt;<i> /
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> For example, on a server with squid 5.7, unmodified package:
</I>&gt;<i> 
</I>&gt;<i> list of open files;
</I>&gt;<i> 
</I>&gt;<i>     lsof |wc -l
</I>&gt;<i>     56963
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> of which 35K in TCPv6:
</I>&gt;<i> 
</I>&gt;<i>     lsof |grep proxy |grep TCPv6 |wc -l
</I>&gt;<i> 
</I>&gt;<i>  &#160;&#160;&#160;&#160;35301
</I>&gt;<i> 
</I>&gt;<i> under /proc I see less objects
</I>&gt;<i>  &#160; &#160; cat&#160; /proc/net/tcp6 |wc -l
</I>&gt;<i>  &#160;&#160;&#160;&#160;3095
</I>&gt;<i> 
</I>&gt;<i> but the number of objects in the slabs is high
</I>&gt;<i>  &#160;&#160;&#160;&#160;cat /proc/slabinfo |grep TCPv6
</I>&gt;<i>  &#160;&#160;&#160;&#160;MPTCPv6&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; 0&#160; &#160; &#160; 0&#160; &#160;2048&#160; &#160;16&#160; &#160; 8 : tunables&#160; &#160; 0    
</I>&gt;<i> 0&#160; &#160; 0 : slabdata&#160; &#160; &#160; 0&#160; &#160; &#160; 0&#160; &#160; &#160; 0
</I>&gt;<i>  &#160;&#160;&#160;&#160;tw_sock_TCPv6&#160; &#160; &#160; &#160;1155&#160; &#160;1155&#160; &#160; 248&#160; &#160;33&#160; &#160; 2 : tunables&#160; &#160; 0    
</I>&gt;<i> 0&#160; &#160; 0 : slabdata&#160; &#160; &#160;35&#160; &#160; &#160;35&#160; &#160; &#160; 0
</I>&gt;<i>  &#160;&#160;&#160;&#160;request_sock_TCPv6&#160; &#160; &#160; 0&#160; &#160; &#160; 0&#160; &#160; 304&#160; &#160;26&#160; &#160; 2 : tunables&#160; &#160; 0  
</I>&gt;<i>  &#160; 0&#160; &#160; 0 : slabdata&#160; &#160; &#160; 0&#160; &#160; &#160; 0&#160; &#160; &#160; 0
</I>&gt;<i>  &#160;&#160;&#160;&#160;TCPv6 *38519&#160; 38519*&#160; &#160;2432&#160; &#160;13&#160; &#160; 8 : tunables&#160; &#160; 0&#160; &#160; 0&#160; &#160; 0 : 
</I>&gt;<i> slabdata&#160; &#160;2963&#160; &#160;2963&#160; &#160; &#160; 0
</I>&gt;<i> 
</I>&gt;<i> I have 35K of lines like this
</I>&gt;<i>  &#160;&#160;&#160;&#160;lsof |grep proxy |grep TCPv6 |more
</I>&gt;<i>  &#160;&#160;&#160;&#160;squid&#160; &#160; &#160; &#160; 1049&#160; &#160; &#160; &#160; &#160; &#160; &#160; proxy&#160; &#160;13u&#160; &#160; &#160;sock                
</I>&gt;<i> 0,8&#160; &#160; &#160; &#160; 0t0&#160; &#160; 5428173 protocol: TCPv6
</I>&gt;<i>  &#160;&#160;&#160;&#160;squid&#160; &#160; &#160; &#160; 1049&#160; &#160; &#160; &#160; &#160; &#160; &#160; proxy&#160; &#160;14u&#160; &#160; &#160;sock                
</I>&gt;<i> 0,8&#160; &#160; &#160; &#160; 0t0&#160; &#160;27941608 protocol: TCPv6
</I>&gt;<i>  &#160;&#160;&#160;&#160;squid&#160; &#160; &#160; &#160; 1049&#160; &#160; &#160; &#160; &#160; &#160; &#160; proxy&#160; &#160;24u&#160; &#160; &#160;sock                
</I>&gt;<i> 0,8&#160; &#160; &#160; &#160; 0t0&#160; &#160;45124047 protocol: TCPv6
</I>&gt;<i>  &#160;&#160;&#160;&#160;squid&#160; &#160; &#160; &#160; 1049&#160; &#160; &#160; &#160; &#160; &#160; &#160; proxy&#160; &#160;25u&#160; &#160; &#160;sock                
</I>&gt;<i> 0,8&#160; &#160; &#160; &#160; 0t0&#160; &#160;50689821 protocol: TCPv6
</I>&gt;<i> ...
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> We thought maybe this is a weird IPv6 thing, as we only route IPv4, so 
</I>&gt;<i> we compiled a more recent version of squid with no v6 support. The thing 
</I>&gt;<i> just moved to TCP4..
</I>&gt;<i> 
</I>&gt;<i> lsof |wc -l
</I>&gt;<i> 120313
</I>&gt;<i> 
</I>&gt;<i> cat /proc/slabinfo |grep TCP
</I>&gt;<i> MPTCPv6&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; 0&#160; &#160; &#160; 0&#160; &#160;2048&#160; &#160;16&#160; &#160; 8 : tunables&#160; &#160; 0&#160; &#160; 0    
</I>&gt;<i> 0 : slabdata&#160; &#160; &#160; 0&#160; &#160; &#160; 0&#160; &#160; &#160; 0
</I>&gt;<i> tw_sock_TCPv6&#160; &#160; &#160; &#160; &#160; 0&#160; &#160; &#160; 0&#160; &#160; 248&#160; &#160;33&#160; &#160; 2 : tunables&#160; &#160; 0&#160; &#160; 0    
</I>&gt;<i> 0 : slabdata&#160; &#160; &#160; 0&#160; &#160; &#160; 0&#160; &#160; &#160; 0
</I>&gt;<i> request_sock_TCPv6&#160; &#160; &#160; 0&#160; &#160; &#160; 0&#160; &#160; 304&#160; &#160;26&#160; &#160; 2 : tunables&#160; &#160; 0&#160; &#160; 0  
</I>&gt;<i>  &#160; 0 : slabdata&#160; &#160; &#160; 0&#160; &#160; &#160; 0&#160; &#160; &#160; 0
</I>&gt;<i> TCPv6&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; 208&#160; &#160; 208&#160; &#160;2432&#160; &#160;13&#160; &#160; 8 : tunables&#160; &#160; 0&#160; &#160; 0    
</I>&gt;<i> 0 : slabdata&#160; &#160; &#160;16&#160; &#160; &#160;16&#160; &#160; &#160; 0
</I>&gt;<i> MPTCP&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; 0&#160; &#160; &#160; 0&#160; &#160;1856&#160; &#160;17&#160; &#160; 8 : tunables&#160; &#160; 0&#160; &#160; 0    
</I>&gt;<i> 0 : slabdata&#160; &#160; &#160; 0&#160; &#160; &#160; 0&#160; &#160; &#160; 0
</I>&gt;<i> tw_sock_TCP&#160; &#160; &#160; &#160; &#160;5577&#160; &#160;5577&#160; &#160; 248&#160; &#160;33&#160; &#160; 2 : tunables&#160; &#160; 0&#160; &#160; 0    
</I>&gt;<i> 0 : slabdata&#160; &#160; 169&#160; &#160; 169&#160; &#160; &#160; 0
</I>&gt;<i> request_sock_TCP&#160; &#160; 1898&#160; &#160;2002&#160; &#160; 304&#160; &#160;26&#160; &#160; 2 : tunables&#160; &#160; 0&#160; &#160; 0    
</I>&gt;<i> 0 : slabdata&#160; &#160; &#160;77&#160; &#160; &#160;77&#160; &#160; &#160; 0
</I>&gt;<i> TCP *102452 113274 *&#160;2240&#160; &#160;14&#160; &#160; 8 : tunables&#160; &#160; 0&#160; &#160; 0&#160; &#160; 0 : 
</I>&gt;<i> slabdata&#160; &#160;8091&#160; &#160;8091&#160; &#160; &#160; 0
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> cat /proc/net/tcp |wc -l
</I>&gt;<i> 255
</I>&gt;<i> 
</I>&gt;<i> After restarting squid the slab objects are released and the open file 
</I>&gt;<i> descriptors drop to a reasonable value. This further suggests it is 
</I>&gt;<i> squid hanging on to these FDs.
</I>&gt;<i> 
</I>&gt;<i> lsof |grep proxy |wc -l
</I>&gt;<i> 1221
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Any suggestion? I guess it's something blatantly obvious, but it's a 
</I>&gt;<i> couple of days we look at this and we're not going anywhere...
</I>&gt;<i> 
</I>&gt;<i> Thanks again
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">https://lists.squid-cache.org/listinfo/squid-users</A>
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="026903.html">[squid-users] Socket handle leak?
</A></li>
	<LI>Next message (by thread): <A HREF="026908.html">[squid-users] cachemgr.cgi isn't mgr:info ?
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26904">[ date ]</a>
              <a href="thread.html#26904">[ thread ]</a>
              <a href="subject.html#26904">[ subject ]</a>
              <a href="author.html#26904">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
