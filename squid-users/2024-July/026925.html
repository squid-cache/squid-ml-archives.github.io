<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid 6.6 kick abandoning connections
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%206.6%20kick%20abandoning%20connections&In-Reply-To=%3CCADJd0Y3LOrRDEzHHBgzdxVkD6VgxB16dB8HSLYtDt74bO%2Bgj9g%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="026848.html">
   <LINK REL="Next"  HREF="026832.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid 6.6 kick abandoning connections</H1>
    <B>Andrey K</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%206.6%20kick%20abandoning%20connections&In-Reply-To=%3CCADJd0Y3LOrRDEzHHBgzdxVkD6VgxB16dB8HSLYtDt74bO%2Bgj9g%40mail.gmail.com%3E"
       TITLE="[squid-users] Squid 6.6 kick abandoning connections">ankor2023 at gmail.com
       </A><BR>
    <I>Sat Jul 13 03:57:32 UTC 2024</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="026848.html">[squid-users] Squid 6.6 kick abandoning connections
</A></li>
        <LI>Next message (by thread): <A HREF="026832.html">[squid-users] ICMP and QUIC
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26925">[ date ]</a>
              <a href="thread.html#26925">[ thread ]</a>
              <a href="subject.html#26925">[ subject ]</a>
              <a href="author.html#26925">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello, Jonathan,

&gt;&gt;<i> Does anyone know the path to this file &quot;modified file
</I>'src/client_side_request.cc&quot; so I can test it with the patches application
if it doesn&#8217;t work no big deal I can just restore it to to prior and or use
an older boot environment

You can find it in the squid sources:
tar -tvzf squid-6.10.tar.gz | grep src/client_side_request.cc
-rw-rw-r-- kinkie/kinkie  77063 2024-06-08 16:28
squid-6.10/src/client_side_request.cc

Kind regards,
      Ankor

&#1089;&#1088;, 10 &#1080;&#1102;&#1083;. 2024&#8239;&#1075;. &#1074; 03:31, &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">jonathanlee571 at gmail.com</A>&gt;:

&gt;<i> I found the older patch from 2017 I cant find the path to
</I>&gt;<i> client_sid_request.cc in the pfsense filesystem
</I>&gt;<i>
</I>&gt;<i> Does anyone know the path to this file &quot;modified file
</I>&gt;<i> 'src/client_side_request.cc&quot; so I can test it with the patches application
</I>&gt;<i> if it doesn&#8217;t work no big deal I can just restore it to to prior and or use
</I>&gt;<i> an older boot environment
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> kick abandoning [connection]&quot; message in cache.log
</I>&gt;<i>
</I>&gt;<i> This patch call quitAfterError() to force Squid to close the connection
</I>&gt;<i> after
</I>&gt;<i> writing a &quot;Host header forgery&quot; error response  instead of just logging a
</I>&gt;<i> [misleading] &quot;kick abandoning [connection]&quot; message in cache.log.
</I>&gt;<i>
</I>&gt;<i> This is a Measurement Factory project
</I>&gt;<i>
</I>&gt;<i> === modified file 'src/client_side_request.cc'
</I>&gt;<i> --- src/client_side_request.cc  2017-02-07 23:11:33 +0000
</I>&gt;<i> +++ src/client_side_request.cc  2017-03-31 08:00:01 +0000
</I>&gt;<i> @@ -564,40 +564,41 @@
</I>&gt;<i>          debugs(85, 3, &quot;SECURITY ALERT: Host header forgery detected on &quot;
</I>&gt;<i> &lt;&lt; http-&gt;getConn()-&gt;clientConnection &lt;&lt;
</I>&gt;<i>                 &quot; (&quot; &lt;&lt; A &lt;&lt; &quot; does not match &quot; &lt;&lt; B &lt;&lt; &quot;) on URL: &quot; &lt;&lt;
</I>&gt;<i> http-&gt;request-&gt;effectiveRequestUri());
</I>&gt;<i>
</I>&gt;<i>          // NP: it is tempting to use 'flags.noCache' but that is all
</I>&gt;<i> about READing cache data.
</I>&gt;<i>          // The problems here are about WRITE for new cache content, which
</I>&gt;<i> means flags.cachable
</I>&gt;<i>          http-&gt;request-&gt;flags.cachable = false; // MUST NOT cache (for now)
</I>&gt;<i>          // XXX: when we have updated the cache key to base on raw-IP +
</I>&gt;<i> URI this cacheable limit can go.
</I>&gt;<i>          http-&gt;request-&gt;flags.hierarchical = false; // MUST NOT pass to
</I>&gt;<i> peers (for now)
</I>&gt;<i>          // XXX: when we have sorted out the best way to relay requests
</I>&gt;<i> properly to peers this hierarchical limit can go.
</I>&gt;<i>          http-&gt;doCallouts();
</I>&gt;<i>          return;
</I>&gt;<i>      }
</I>&gt;<i>
</I>&gt;<i>      debugs(85, DBG_IMPORTANT, &quot;SECURITY ALERT: Host header forgery
</I>&gt;<i> detected on &quot; &lt;&lt;
</I>&gt;<i>             http-&gt;getConn()-&gt;clientConnection &lt;&lt; &quot; (&quot; &lt;&lt; A &lt;&lt; &quot; does not
</I>&gt;<i> match &quot; &lt;&lt; B &lt;&lt; &quot;)&quot;);
</I>&gt;<i>      if (const char *ua =
</I>&gt;<i> http-&gt;request-&gt;header.getStr(Http::HdrType::USER_AGENT))
</I>&gt;<i>          debugs(85, DBG_IMPORTANT, &quot;SECURITY ALERT: By user agent: &quot; &lt;&lt;
</I>&gt;<i> ua);
</I>&gt;<i>      debugs(85, DBG_IMPORTANT, &quot;SECURITY ALERT: on URL: &quot; &lt;&lt;
</I>&gt;<i> http-&gt;request-&gt;effectiveRequestUri());
</I>&gt;<i>
</I>&gt;<i>      // IP address validation for Host: failed. reject the connection.
</I>&gt;<i> +    http-&gt;getConn()-&gt;quitAfterError(http-&gt;request);
</I>&gt;<i>      clientStreamNode *node = (clientStreamNode
</I>&gt;<i> *)http-&gt;client_stream.tail-&gt;prev-&gt;data;
</I>&gt;<i>      clientReplyContext *repContext = dynamic_cast&lt;clientReplyContext
</I>&gt;<i> *&gt;(node-&gt;data.getRaw());
</I>&gt;<i>      assert (repContext);
</I>&gt;<i>      repContext-&gt;setReplyToError(ERR_CONFLICT_HOST, Http::scConflict,
</I>&gt;<i>                                  http-&gt;request-&gt;method, NULL,
</I>&gt;<i>                                  http-&gt;getConn()-&gt;clientConnection-&gt;remote,
</I>&gt;<i>                                  http-&gt;request,
</I>&gt;<i>                                  NULL,
</I>&gt;<i>  #if USE_AUTH
</I>&gt;<i>                                  http-&gt;getConn() != NULL &amp;&amp;
</I>&gt;<i> http-&gt;getConn()-&gt;getAuth() != NULL ?
</I>&gt;<i>                                  http-&gt;getConn()-&gt;getAuth() :
</I>&gt;<i> http-&gt;request-&gt;auth_user_request);
</I>&gt;<i>  #else
</I>&gt;<i>                                  NULL);
</I>&gt;<i>  #endif
</I>&gt;<i>      node = (clientStreamNode *)http-&gt;client_stream.tail-&gt;data;
</I>&gt;<i>      clientStreamRead(node, http, node-&gt;readBuffer);
</I>&gt;<i>  }
</I>&gt;<i>
</I>&gt;<i>  void
</I>&gt;<i>  ClientRequestContext::hostHeaderVerify()
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> -----Original Message-----
</I>&gt;<i> From: Alex Rousskov &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt;
</I>&gt;<i> Sent: Monday, July 8, 2024 10:41 AM
</I>&gt;<i> To: squid-users &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>&gt;
</I>&gt;<i> Cc: Jonathan Lee &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">jonathanlee571 at gmail.com</A>&gt;
</I>&gt;<i> Subject: Re: [squid-users] Squid 6.6 kick abandoning connections
</I>&gt;<i>
</I>&gt;<i> On 2024-07-08 12:31, Jonathan Lee wrote:
</I>&gt;<i>
</I>&gt;<i> &gt; I can confirm I have no ipv6 our isp is ipv4 only and I have IPv6
</I>&gt;<i> &gt; disabled on the firewall and with layer 2 and 3 traffic
</I>&gt;<i>
</I>&gt;<i> This problem is not specific to any IP family/version.
</I>&gt;<i>
</I>&gt;<i> Alex.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt;&gt; On Jul 8, 2024, at 09:15, Alex Rousskov &lt;
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt; wrote:
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; &#65279;On 2024-07-05 21:07, Jonathan Lee wrote:
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt;&gt; I am using Bump with certificates installed on devices does anyone
</I>&gt;<i> know what this error is...
</I>&gt;<i> &gt;&gt;&gt; kick abandoning conn43723 local=192.168.1.1:3128
</I>&gt;<i> &gt;&gt;&gt; remote=192.168.1.5:52129 FD 178 flags=1
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; This &quot;kick abandoning&quot; message marks a Squid problem or bug: Squid
</I>&gt;<i> enters a seemingly impossible state. In some (but probably not all) cases,
</I>&gt;<i> the client connection might become stuck (hopefully until some timeout
</I>&gt;<i> closes it). In some (and possibly all) cases, Squid might immediately close
</I>&gt;<i> the connection and nobody gets hurt. Code reporting this problem does not
</I>&gt;<i> know how we got here and what will happen next.
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; There were several incomplete/unfinished attempts to fix this problem,
</I>&gt;<i> including two different patches posted at Bug 3715. I do not know whether
</I>&gt;<i> either of them is safe and applies to Squid v6. Neither is a comprehensive
</I>&gt;<i> solution.
</I>&gt;<i> &gt;&gt; <A HREF="https://bugs.squid-cache.org/show_bug.cgi?id=3715">https://bugs.squid-cache.org/show_bug.cgi?id=3715</A>
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt;&gt; Does anyone know how to fix my last weird error I have with Squid
</I>&gt;<i> &gt;&gt;&gt; 6.6
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; I do not know of a good configuration-based workaround. Squid code
</I>&gt;<i> modifications are required to properly address this problem. Other errors
</I>&gt;<i> may trigger this bug, so addressing those other errors may hide (and reduce
</I>&gt;<i> the pressure to fix) this bug. Besides fixing those other errors (if any --
</I>&gt;<i> I am aware that you have said that there are no other errors left, but
</I>&gt;<i> perhaps you found other problems since then), these basic options apply:
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; <A HREF="https://wiki.squid-cache.org/SquidFaq/AboutSquid#how-to-add-a-new-squ">https://wiki.squid-cache.org/SquidFaq/AboutSquid#how-to-add-a-new-squ</A>
</I>&gt;<i> &gt;&gt; id-feature-enhance-of-fix-something
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; Alex.
</I>&gt;<i> &gt;&gt;
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">https://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20240713/77f64bfa/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20240713/77f64bfa/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="026848.html">[squid-users] Squid 6.6 kick abandoning connections
</A></li>
	<LI>Next message (by thread): <A HREF="026832.html">[squid-users] ICMP and QUIC
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26925">[ date ]</a>
              <a href="thread.html#26925">[ thread ]</a>
              <a href="subject.html#26925">[ subject ]</a>
              <a href="author.html#26925">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
