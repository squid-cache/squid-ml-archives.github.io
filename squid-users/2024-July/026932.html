<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Rewriting HTTP to HTTPS for generic package proxy
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Rewriting%20HTTP%20to%20HTTPS%20for%20generic%20package%20proxy&In-Reply-To=%3C456eb9f4cf1746a7b749217b1f8262cc%40eurodata.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="026893.html">
   <LINK REL="Next"  HREF="026938.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Rewriting HTTP to HTTPS for generic package proxy</H1>
    <B>Fiehe, Christoph</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Rewriting%20HTTP%20to%20HTTPS%20for%20generic%20package%20proxy&In-Reply-To=%3C456eb9f4cf1746a7b749217b1f8262cc%40eurodata.de%3E"
       TITLE="[squid-users] Rewriting HTTP to HTTPS for generic package proxy">c.fiehe at eurodata.de
       </A><BR>
    <I>Sun Jul 14 16:35:47 UTC 2024</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="026893.html">[squid-users] Rewriting HTTP to HTTPS for generic package proxy
</A></li>
        <LI>Next message (by thread): <A HREF="026938.html">[squid-users] Rewriting HTTP to HTTPS for generic package proxy
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26932">[ date ]</a>
              <a href="thread.html#26932">[ thread ]</a>
              <a href="subject.html#26932">[ subject ]</a>
              <a href="author.html#26932">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>The only solution I was currently able to get working, was to make use of an Apache server installed locally beside Squid. It acts as a reverse proxy and gets queried by Squid when the client requests an external resource via HTTP, but that resource must be accessed transparently for the client via HTTPS using an upstream proxy. The Apache is able to initiate the required CONNECT request to the upstream proxy and to fetch that resource from the specified source via the established tunnel.

I do not like the solution. It would be nice to get rid of the Apache, but I have not found a way to use URL rewriting in combination with Squid's reverse proxy capabilities to fetch that resource in case of HTTPS via a CONNECT to the upstream proxy.

If someone has a better idea to achieve that behavior, please do not hesitate to send a response.

This is just an experimental configuration and should not be used in production:

jesred.rules:

regex ^(<A HREF="http://download\.docker\.com.*">http://download\.docker\.com.*</A>)$ <A HREF="http://localhost:9090?uri=\1">http://localhost:9090?uri=\1</A>

vhost.conf:

Listen 9090
&lt;VirtualHost 127.0.0.1:9090&gt;
    ServerName  localhost
    ServerAlias 127.0.0.1

    ErrorLog ${APACHE_LOG_DIR}/error.log
    CustomLog ${APACHE_LOG_DIR}/access.log combined

    SSLProxyEngine On

    ProxyRemoteMatch ^(?!.*internaldomain\.com).*$ <A HREF="http://&lt;PROXY-FQDN">http://&lt;PROXY-FQDN</A>&gt;:&lt;PROXY-PORT&gt;

    RewriteCond %{QUERY_STRING} uri=https?:\/\/([^&amp;]*)$
    RewriteRule ^ <A HREF="https://%1">https://%1</A> [P,L]
&lt;/VirtualHost&gt;

squid.conf:

http_port 8000
visible_hostname pkg-proxy

cache_peer &lt;PROXY-FQDN&gt; parent &lt;PROXY-PORT&gt; 0 no-query default

always_direct allow to_localhost

never_direct allow all

http_access allow all

cache deny all

url_rewrite_children 3 startup=0 idle=1 concurrency=1
url_rewrite_program /usr/lib/squid/jesred

Regards,
Christoph

&gt;<i>-----Urspr&#252;ngliche Nachricht-----
</I>&gt;<i>Von: squid-users &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>&gt; Im Auftrag von Alex Rousskov
</I>&gt;<i>Gesendet: Freitag, 12. Juli 2024 00:11
</I>&gt;<i>An: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i>Betreff: Re: [squid-users] Rewriting HTTP to HTTPS for generic package proxy
</I>&gt;<i>
</I>&gt;<i>On 2024-07-11 17:03, Amos Jeffries wrote:
</I>&gt;&gt;<i> On 11/07/24 00:49, Alex Rousskov wrote:
</I>&gt;&gt;&gt;<i> On 2024-07-09 18:25, Fiehe, Christoph wrote:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> I hope that somebody has an idea, what I am doing wrong.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> AFAICT from the debugging log, it is your parent proxy that returns an
</I>&gt;&gt;&gt;<i> ERR_SECURE_CONNECT_FAIL error page in response to a seemingly valid
</I>&gt;&gt;&gt;<i> &quot;HEAD <A HREF="https://...">https://...</A>&quot; request. Can you ask their admin to investigate?
</I>&gt;&gt;&gt;<i> You may also recommend that they upgrade from Squid v4 that has many
</I>&gt;&gt;&gt;<i> known security vulnerabiities.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> If parent is uncooperative, you can try to reproduce the problem by
</I>&gt;&gt;&gt;<i> temporary installing your own parent Squid instance and configuring
</I>&gt;&gt;&gt;<i> your child Squid to use that instead.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> HTH,
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Alex.
</I>&gt;&gt;&gt;<i> P.S. Unlike Amos, I do not see serious conceptual problems with
</I>&gt;&gt;&gt;<i> rewriting request target scheme (as a temporary compatibility
</I>&gt;&gt;&gt;<i> measure). It may not always work, for various reasons, but it does not
</I>&gt;&gt;&gt;<i> necessarily make things worse (and may make things better).
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> To which I refer you to:
</I>&gt;<i>
</I>&gt;<i>None of the weaknesses below are applicable to request target scheme
</I>&gt;<i>rewriting (assuming both proxies in question are implemented/configured
</I>&gt;<i>correctly, of course). Specific non-applicability reasons are given
</I>&gt;<i>below for each weakness URL:
</I>&gt;<i>
</I>&gt;&gt;<i> <A HREF="https://cwe.mitre.org/data/definitions/311.html">https://cwe.mitre.org/data/definitions/311.html</A>
</I>&gt;<i>
</I>&gt;<i>The above &quot;The product does not encrypt sensitive or critical
</I>&gt;<i>information before storage or transmission&quot; case is not applicable: All
</I>&gt;<i>connections can be encrypted as needed after the scheme rewrite.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> <A HREF="https://cwe.mitre.org/data/definitions/312.html">https://cwe.mitre.org/data/definitions/312.html</A>
</I>&gt;<i>
</I>&gt;<i>The above &quot;The product stores sensitive information in cleartext within
</I>&gt;<i>a resource that might be accessible to another control sphere.&quot; case is
</I>&gt;<i>not applicable: Squid does not store information in such an accessible
</I>&gt;<i>resource.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> <A HREF="https://cwe.mitre.org/data/definitions/319.html">https://cwe.mitre.org/data/definitions/319.html</A>
</I>&gt;<i>
</I>&gt;<i>The above &quot;The product transmits sensitive or security-critical data in
</I>&gt;<i>cleartext in a communication channel that can be sniffed by unauthorized
</I>&gt;<i>actors.&quot; case is not applicable: All connections can be encrypted as
</I>&gt;<i>needed after the scheme rewrite.
</I>&gt;<i>
</I>&gt;<i>Alex.
</I>&gt;<i>
</I>&gt;<i>_______________________________________________
</I>&gt;<i>squid-users mailing list
</I>&gt;<i><A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i><A HREF="https://lists.squid-cache.org/listinfo/squid-users">https://lists.squid-cache.org/listinfo/squid-users</A>
</I>
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="026893.html">[squid-users] Rewriting HTTP to HTTPS for generic package proxy
</A></li>
	<LI>Next message (by thread): <A HREF="026938.html">[squid-users] Rewriting HTTP to HTTPS for generic package proxy
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26932">[ date ]</a>
              <a href="thread.html#26932">[ thread ]</a>
              <a href="subject.html#26932">[ subject ]</a>
              <a href="author.html#26932">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
