<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] SQUID - WINDBIND - very slow internet speed
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20SQUID%20-%20WINDBIND%20-%20very%20slow%20internet%20speed&In-Reply-To=%3CCA%2BY8hcO1HkF3oRtK7ra5CCpu6ZW74NCfLXP8OD15YjffhbV9yQ%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="026980.html">
   <LINK REL="Next"  HREF="026983.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] SQUID - WINDBIND - very slow internet speed</H1>
    <B>Francesco Chemolli</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20SQUID%20-%20WINDBIND%20-%20very%20slow%20internet%20speed&In-Reply-To=%3CCA%2BY8hcO1HkF3oRtK7ra5CCpu6ZW74NCfLXP8OD15YjffhbV9yQ%40mail.gmail.com%3E"
       TITLE="[squid-users] SQUID - WINDBIND - very slow internet speed">gkinkie at gmail.com
       </A><BR>
    <I>Wed Jul 24 18:48:07 UTC 2024</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="026980.html">[squid-users] SQUID - WINDBIND - very slow internet speed
</A></li>
        <LI>Next message (by thread): <A HREF="026983.html">[squid-users] SQUID - WINDBIND - very slow internet speed
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26981">[ date ]</a>
              <a href="thread.html#26981">[ thread ]</a>
              <a href="subject.html#26981">[ subject ]</a>
              <a href="author.html#26981">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Andre,

The chain of services here is:

browser &lt;-&gt; squid &lt;-&gt; ntlm_auth &lt;-&gt; winbindd &lt;-&gt; active directory

In order to bisect the problem, could you try using `wbinfo -a` on one
of the affected machiens to authenticate against Active Directory and
see if the performance is on the winbindd &lt;-&gt; AD side of the equation
on on the squid &lt;-&gt; ntlm_auth side?

On Wed, Jul 24, 2024 at 7:27&#8239;PM Andre Bolinhas
&lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">andre.bolinhas at articatech.com</A>&gt; wrote:
&gt;<i>
</I>&gt;<i> Hi Team.
</I>&gt;<i>
</I>&gt;<i> I'm using SQUID 5.9 + windbindd 4.9.5, the authentication method is NTLM.
</I>&gt;<i>
</I>&gt;<i> Every day, around 5pm, the internet speed becomes very slow, with users reporting that websites takes too long to open.
</I>&gt;<i>
</I>&gt;<i> Also, the time that the issue occur is very strange, since is when most of the users are not in the office anymore
</I>&gt;<i>
</I>&gt;<i> By doing a deep analyze on Proxy server, I manage to find this error that could be related with this issue.
</I>&gt;<i>
</I>&gt;<i> Cache.log
</I>&gt;<i> GENSEC login failed: NT_STATUS_LOGON_FAILURE
</I>&gt;<i> GENSEC login failed: NT_STATUS_LOGON_FAILURE
</I>&gt;<i> GENSEC login failed: NT_STATUS_LOGON_FAILURE
</I>&gt;<i> GENSEC login failed: NT_STATUS_LOGON_FAILURE
</I>&gt;<i>
</I>&gt;<i> Windbindd.log
</I>&gt;<i> [2024/07/22 17:06:48.220216,  2] ../source3/winbindd/winbindd.c:1121(remove_client)
</I>&gt;<i>   final write to client failed: Broken pipe
</I>&gt;<i> [2024/07/22 17:06:48.220319,  0] ../source3/winbindd/winbindd.c:1246(winbindd_listen_fde_handler)
</I>&gt;<i>   winbindd: Exceeding 500 client connections, no idle connection found
</I>&gt;<i> [2024/07/22 17:06:48.261482,  0] ../source3/winbindd/winbindd.c:1246(winbindd_listen_fde_handler)
</I>&gt;<i>   winbindd: Exceeding 500 client connections, no idle connection found
</I>&gt;<i> [2024/07/22 17:06:48.261857,  2] ../source3/winbindd/winbindd.c:1121(remove_client)
</I>&gt;<i>   final write to client failed: Broken pipe
</I>&gt;<i> [2024/07/22 17:06:48.261926,  0] ../source3/winbindd/winbindd.c:1246(winbindd_listen_fde_handler)
</I>&gt;<i>   winbindd: Exceeding 500 client connections, no idle connection found
</I>&gt;<i> [2024/07/22 17:06:48.276216,  0] ../source3/winbindd/winbindd.c:1246(winbindd_listen_fde_handler)
</I>&gt;<i>   winbindd: Exceeding 500 client connections, no idle connection found
</I>&gt;<i> [2024/07/22 17:06:48.276507,  2] ../source3/winbindd/winbindd.c:1121(remove_client)
</I>&gt;<i>   final write to client failed: Broken pipe
</I>&gt;<i> [2024/07/22 17:06:48.276568,  0] ../source3/winbindd/winbindd.c:1246(winbindd_listen_fde_handler)
</I>&gt;<i>   winbindd: Exceeding 500 client connections, no idle connection found
</I>&gt;<i> [2024/07/22 17:09:02.512093,  1] ../source4/lib/messaging/messaging.c:83(ping_message)
</I>&gt;<i>   INFO: Received PING message from server 10301 []
</I>&gt;<i> [2024/07/22 17:09:02.512159,  1] ../source3/lib/messages.c:131(ping_message)
</I>&gt;<i>   INFO: Received PING message from PID 10301 []
</I>&gt;<i> [2024/07/22 17:11:27.979681,  1] ../source3/winbindd/winbindd_util.c:440(trustdom_list_done)
</I>&gt;<i>   trustdom_list_done: Could not receive trusts for domain BANK
</I>&gt;<i> [2024/07/22 17:11:27.979756,  1] ../source3/winbindd/winbindd_util.c:440(trustdom_list_done)
</I>&gt;<i>   trustdom_list_done: Could not receive trusts for domain HLGROUP
</I>&gt;<i> [2024/07/22 17:12:02.612725,  1] ../source4/lib/messaging/messaging.c:83(ping_message)
</I>&gt;<i>   INFO: Received PING message from server 4706 []
</I>&gt;<i> [2024/07/22 17:12:02.612794,  1] ../source3/lib/messages.c:131(ping_message)
</I>&gt;<i>   INFO: Received PING message from PID 4706 []
</I>&gt;<i> [2024/07/22 17:15:03.307322,  1] ../source4/lib/messaging/messaging.c:83(ping_message)
</I>&gt;<i>   INFO: Received PING message from server 13541 []
</I>&gt;<i> [2024/07/22 17:15:03.307477,  1] ../source3/lib/messages.c:131(ping_message)
</I>&gt;<i>   INFO: Received PING message from PID 13541 []
</I>&gt;<i> [2024/07/22 17:18:02.603927,  1] ../source4/lib/messaging/messaging.c:83(ping_message)
</I>&gt;<i>   INFO: Received PING message from server 27640 []
</I>&gt;<i> [2024/07/22 17:18:02.603983,  1] ../source3/lib/messages.c:131(ping_message)
</I>&gt;<i>   INFO: Received PING message from PID 27640 []
</I>&gt;<i>
</I>&gt;<i> smb.conf
</I>&gt;<i> [global]
</I>&gt;<i>    netbios name               = ASP02
</I>&gt;<i>    log level                  = 2
</I>&gt;<i>    workgroup                  = mydom
</I>&gt;<i>    kerberos method            = dedicated keytab
</I>&gt;<i>    dedicated keytab file      = /etc/krb5.keytab
</I>&gt;<i>    realm                      = mydom.MY
</I>&gt;<i>    password server            = 10.150.1.62
</I>&gt;<i>    security                   = ads
</I>&gt;<i>    winbind enum groups        = No
</I>&gt;<i>    winbind enum users         = No
</I>&gt;<i>    idmap config * : backend   = tdb
</I>&gt;<i>    idmap config * : range     = 3000-7999
</I>&gt;<i>    idmap config mydom:backend = ad
</I>&gt;<i>    idmap config mydom:schema_mode = rfc2307
</I>&gt;<i>    idmap config mydom:range = 10000-999999
</I>&gt;<i>    idmap config mydom:unix_nss_info = yes
</I>&gt;<i> tls enabled = yes
</I>&gt;<i> ldap ssl = start tls
</I>&gt;<i> tls keyfile  = tls/key.pem
</I>&gt;<i> tls certfile = tls/cert.pem
</I>&gt;<i> tls cafile   = tls/ca.pem
</I>&gt;<i> client ldap sasl wrapping = plain
</I>&gt;<i>    client ntlmv2 auth         = Yes
</I>&gt;<i>    client lanman auth         = No
</I>&gt;<i>    client ldap sasl wrapping  = sign
</I>&gt;<i>    winbind normalize names    = No
</I>&gt;<i>    winbind separator          = /
</I>&gt;<i>    winbind use default domain = yes
</I>&gt;<i>    winbind nested groups      = Yes
</I>&gt;<i>    winbind reconnect delay    = 30
</I>&gt;<i>    winbind offline logon      = true
</I>&gt;<i>    winbind cache time         = 1800
</I>&gt;<i>    winbind refresh tickets    = true
</I>&gt;<i>    winbind refresh tickets    = true
</I>&gt;<i>    winbind max clients        = 500
</I>&gt;<i>    allow trusted domains      = Yes
</I>&gt;<i>    server signing             = auto
</I>&gt;<i>    client signing             = auto
</I>&gt;<i>    lm announce                = No
</I>&gt;<i>    ntlm auth                  = No
</I>&gt;<i>    lanman auth                = No
</I>&gt;<i>    preferred master           = No
</I>&gt;<i>    local master               = No
</I>&gt;<i>    wins support               = No
</I>&gt;<i>    encrypt passwords          = yes
</I>&gt;<i>    printing                   = bsd
</I>&gt;<i>    load printers              = no
</I>&gt;<i>    socket options             = TCP_NODELAY SO_RCVBUF=8192 SO_SNDBUF=8192
</I>&gt;<i>    min protocol               = SMB2
</I>&gt;<i>    client min protocol          = SMB2
</I>&gt;<i>    client max protocol          = SMB3
</I>&gt;<i>    load printers              = no
</I>&gt;<i>    printing                   = bsd
</I>&gt;<i>    printcap name              = /dev/null
</I>&gt;<i>    disable spoolss            = yes
</I>&gt;<i>
</I>&gt;<i> Squid.conf
</I>&gt;<i>
</I>&gt;<i> # kerberos_conf() LockActiveDirectoryToKerberos = 0
</I>&gt;<i>
</I>&gt;<i> #
</I>&gt;<i> #KerbAuthMethod = 0/1 and NOT_NTLM = False
</I>&gt;<i> auth_param ntlm program /usr/bin/ntlm_auth  --domain=mydom.MY --helper-protocol=squid-2.5-ntlmssp
</I>&gt;<i> auth_param ntlm children 500 startup=5 idle=1 concurrency=0 queue-size=2000 on-persistent-overload=ERR
</I>&gt;<i> auth_param ntlm keep_alive off
</I>&gt;<i>
</I>&gt;<i> #
</I>&gt;<i> # ads groups OK
</I>&gt;<i> #Other settings
</I>&gt;<i> auth_param basic credentialsttl 7200 seconds
</I>&gt;<i> authenticate_ttl 3600 seconds
</I>&gt;<i> authenticate_ip_ttl 1 seconds
</I>&gt;<i> authenticate_cache_garbage_interval 3600 seconds
</I>&gt;<i>
</I>&gt;<i> acl authFailed src all
</I>&gt;<i> acl AUTHENTICATED proxy_auth REQUIRED
</I>&gt;<i> # END NTLM Parameters --------------------------------
</I>&gt;<i> # Basic authentication for other browser that did not supports NTLM
</I>&gt;<i> auth_param basic program /usr/bin/ntlm_auth --helper-protocol=squid-2.5-basic
</I>&gt;<i> auth_param basic children 60 startup=2 idle=1
</I>&gt;<i> auth_param basic realm Active Directory Basic Identification
</I>&gt;<i> auth_param basic credentialsttl 7200 seconds
</I>&gt;<i> authenticate_ttl 3600 seconds
</I>&gt;<i> authenticate_ip_ttl 1 seconds
</I>&gt;<i> authenticate_cache_garbage_interval 3600 seconds
</I>&gt;<i>
</I>&gt;<i> # ldap_auth_ad() EnableAdLDAPAuth = 0 - SKIP
</I>&gt;<i>
</I>&gt;<i> # ads groups OK
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> # --------------------------------------------------
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">https://lists.squid-cache.org/listinfo/squid-users</A>
</I>


-- 
    Francesco

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="026980.html">[squid-users] SQUID - WINDBIND - very slow internet speed
</A></li>
	<LI>Next message (by thread): <A HREF="026983.html">[squid-users] SQUID - WINDBIND - very slow internet speed
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26981">[ date ]</a>
              <a href="thread.html#26981">[ thread ]</a>
              <a href="subject.html#26981">[ subject ]</a>
              <a href="author.html#26981">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
