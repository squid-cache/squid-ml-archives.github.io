<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] SQUID - WINDBIND - very slow internet speed
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20SQUID%20-%20WINDBIND%20-%20very%20slow%20internet%20speed&In-Reply-To=%3CCADJd0Y1S5f4vAp-Ek1gt1-hRC214p6soZq1-O-QoPW0-Q-hfGw%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="026981.html">
   <LINK REL="Next"  HREF="026984.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] SQUID - WINDBIND - very slow internet speed</H1>
    <B>Andrey K</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20SQUID%20-%20WINDBIND%20-%20very%20slow%20internet%20speed&In-Reply-To=%3CCADJd0Y1S5f4vAp-Ek1gt1-hRC214p6soZq1-O-QoPW0-Q-hfGw%40mail.gmail.com%3E"
       TITLE="[squid-users] SQUID - WINDBIND - very slow internet speed">ankor2023 at gmail.com
       </A><BR>
    <I>Thu Jul 25 06:02:10 UTC 2024</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="026981.html">[squid-users] SQUID - WINDBIND - very slow internet speed
</A></li>
        <LI>Next message (by thread): <A HREF="026984.html">[squid-users] SQUID - WINDBIND - very slow internet speed
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26983">[ date ]</a>
              <a href="thread.html#26983">[ thread ]</a>
              <a href="subject.html#26983">[ subject ]</a>
              <a href="author.html#26983">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello, Andre,

Your logs say:
&gt;<i> winbindd: Exceeding 500 client connections, no idle connection found
</I>
So In addition to Francesco's suggestion, you can try to increase the
&quot;winbind max clients&quot; parameter in your smb.conf

Your squid.conf record:
auth_param ntlm children 500 startup=5 idle=1
limits the number of ntlm-helpers, but in the SMP squid configuration this
value is multiplied by the number of workers (although I did not notice the
activation of multiprocessing support in your squid configuration).

Kind regards,
     Andrey





&#1089;&#1088;, 24 &#1080;&#1102;&#1083;. 2024&#8239;&#1075;. &#1074; 21:57, Francesco Chemolli &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">gkinkie at gmail.com</A>&gt;:

&gt;<i> Hi Andre,
</I>&gt;<i>
</I>&gt;<i> The chain of services here is:
</I>&gt;<i>
</I>&gt;<i> browser &lt;-&gt; squid &lt;-&gt; ntlm_auth &lt;-&gt; winbindd &lt;-&gt; active directory
</I>&gt;<i>
</I>&gt;<i> In order to bisect the problem, could you try using `wbinfo -a` on one
</I>&gt;<i> of the affected machiens to authenticate against Active Directory and
</I>&gt;<i> see if the performance is on the winbindd &lt;-&gt; AD side of the equation
</I>&gt;<i> on on the squid &lt;-&gt; ntlm_auth side?
</I>&gt;<i>
</I>&gt;<i> On Wed, Jul 24, 2024 at 7:27&#8239;PM Andre Bolinhas
</I>&gt;<i> &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">andre.bolinhas at articatech.com</A>&gt; wrote:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Hi Team.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I'm using SQUID 5.9 + windbindd 4.9.5, the authentication method is NTLM.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Every day, around 5pm, the internet speed becomes very slow, with users
</I>&gt;<i> reporting that websites takes too long to open.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Also, the time that the issue occur is very strange, since is when most
</I>&gt;<i> of the users are not in the office anymore
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; By doing a deep analyze on Proxy server, I manage to find this error
</I>&gt;<i> that could be related with this issue.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Cache.log
</I>&gt;<i> &gt; GENSEC login failed: NT_STATUS_LOGON_FAILURE
</I>&gt;<i> &gt; GENSEC login failed: NT_STATUS_LOGON_FAILURE
</I>&gt;<i> &gt; GENSEC login failed: NT_STATUS_LOGON_FAILURE
</I>&gt;<i> &gt; GENSEC login failed: NT_STATUS_LOGON_FAILURE
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Windbindd.log
</I>&gt;<i> &gt; [2024/07/22 17:06:48.220216,  2]
</I>&gt;<i> ../source3/winbindd/winbindd.c:1121(remove_client)
</I>&gt;<i> &gt;   final write to client failed: Broken pipe
</I>&gt;<i> &gt; [2024/07/22 17:06:48.220319,  0]
</I>&gt;<i> ../source3/winbindd/winbindd.c:1246(winbindd_listen_fde_handler)
</I>&gt;<i> &gt;   winbindd: Exceeding 500 client connections, no idle connection found
</I>&gt;<i> &gt; [2024/07/22 17:06:48.261482,  0]
</I>&gt;<i> ../source3/winbindd/winbindd.c:1246(winbindd_listen_fde_handler)
</I>&gt;<i> &gt;   winbindd: Exceeding 500 client connections, no idle connection found
</I>&gt;<i> &gt; [2024/07/22 17:06:48.261857,  2]
</I>&gt;<i> ../source3/winbindd/winbindd.c:1121(remove_client)
</I>&gt;<i> &gt;   final write to client failed: Broken pipe
</I>&gt;<i> &gt; [2024/07/22 17:06:48.261926,  0]
</I>&gt;<i> ../source3/winbindd/winbindd.c:1246(winbindd_listen_fde_handler)
</I>&gt;<i> &gt;   winbindd: Exceeding 500 client connections, no idle connection found
</I>&gt;<i> &gt; [2024/07/22 17:06:48.276216,  0]
</I>&gt;<i> ../source3/winbindd/winbindd.c:1246(winbindd_listen_fde_handler)
</I>&gt;<i> &gt;   winbindd: Exceeding 500 client connections, no idle connection found
</I>&gt;<i> &gt; [2024/07/22 17:06:48.276507,  2]
</I>&gt;<i> ../source3/winbindd/winbindd.c:1121(remove_client)
</I>&gt;<i> &gt;   final write to client failed: Broken pipe
</I>&gt;<i> &gt; [2024/07/22 17:06:48.276568,  0]
</I>&gt;<i> ../source3/winbindd/winbindd.c:1246(winbindd_listen_fde_handler)
</I>&gt;<i> &gt;   winbindd: Exceeding 500 client connections, no idle connection found
</I>&gt;<i> &gt; [2024/07/22 17:09:02.512093,  1]
</I>&gt;<i> ../source4/lib/messaging/messaging.c:83(ping_message)
</I>&gt;<i> &gt;   INFO: Received PING message from server 10301 []
</I>&gt;<i> &gt; [2024/07/22 17:09:02.512159,  1]
</I>&gt;<i> ../source3/lib/messages.c:131(ping_message)
</I>&gt;<i> &gt;   INFO: Received PING message from PID 10301 []
</I>&gt;<i> &gt; [2024/07/22 17:11:27.979681,  1]
</I>&gt;<i> ../source3/winbindd/winbindd_util.c:440(trustdom_list_done)
</I>&gt;<i> &gt;   trustdom_list_done: Could not receive trusts for domain BANK
</I>&gt;<i> &gt; [2024/07/22 17:11:27.979756,  1]
</I>&gt;<i> ../source3/winbindd/winbindd_util.c:440(trustdom_list_done)
</I>&gt;<i> &gt;   trustdom_list_done: Could not receive trusts for domain HLGROUP
</I>&gt;<i> &gt; [2024/07/22 17:12:02.612725,  1]
</I>&gt;<i> ../source4/lib/messaging/messaging.c:83(ping_message)
</I>&gt;<i> &gt;   INFO: Received PING message from server 4706 []
</I>&gt;<i> &gt; [2024/07/22 17:12:02.612794,  1]
</I>&gt;<i> ../source3/lib/messages.c:131(ping_message)
</I>&gt;<i> &gt;   INFO: Received PING message from PID 4706 []
</I>&gt;<i> &gt; [2024/07/22 17:15:03.307322,  1]
</I>&gt;<i> ../source4/lib/messaging/messaging.c:83(ping_message)
</I>&gt;<i> &gt;   INFO: Received PING message from server 13541 []
</I>&gt;<i> &gt; [2024/07/22 17:15:03.307477,  1]
</I>&gt;<i> ../source3/lib/messages.c:131(ping_message)
</I>&gt;<i> &gt;   INFO: Received PING message from PID 13541 []
</I>&gt;<i> &gt; [2024/07/22 17:18:02.603927,  1]
</I>&gt;<i> ../source4/lib/messaging/messaging.c:83(ping_message)
</I>&gt;<i> &gt;   INFO: Received PING message from server 27640 []
</I>&gt;<i> &gt; [2024/07/22 17:18:02.603983,  1]
</I>&gt;<i> ../source3/lib/messages.c:131(ping_message)
</I>&gt;<i> &gt;   INFO: Received PING message from PID 27640 []
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; smb.conf
</I>&gt;<i> &gt; [global]
</I>&gt;<i> &gt;    netbios name               = ASP02
</I>&gt;<i> &gt;    log level                  = 2
</I>&gt;<i> &gt;    workgroup                  = mydom
</I>&gt;<i> &gt;    kerberos method            = dedicated keytab
</I>&gt;<i> &gt;    dedicated keytab file      = /etc/krb5.keytab
</I>&gt;<i> &gt;    realm                      = mydom.MY
</I>&gt;<i> &gt;    password server            = 10.150.1.62
</I>&gt;<i> &gt;    security                   = ads
</I>&gt;<i> &gt;    winbind enum groups        = No
</I>&gt;<i> &gt;    winbind enum users         = No
</I>&gt;<i> &gt;    idmap config * : backend   = tdb
</I>&gt;<i> &gt;    idmap config * : range     = 3000-7999
</I>&gt;<i> &gt;    idmap config mydom:backend = ad
</I>&gt;<i> &gt;    idmap config mydom:schema_mode = rfc2307
</I>&gt;<i> &gt;    idmap config mydom:range = 10000-999999
</I>&gt;<i> &gt;    idmap config mydom:unix_nss_info = yes
</I>&gt;<i> &gt; tls enabled = yes
</I>&gt;<i> &gt; ldap ssl = start tls
</I>&gt;<i> &gt; tls keyfile  = tls/key.pem
</I>&gt;<i> &gt; tls certfile = tls/cert.pem
</I>&gt;<i> &gt; tls cafile   = tls/ca.pem
</I>&gt;<i> &gt; client ldap sasl wrapping = plain
</I>&gt;<i> &gt;    client ntlmv2 auth         = Yes
</I>&gt;<i> &gt;    client lanman auth         = No
</I>&gt;<i> &gt;    client ldap sasl wrapping  = sign
</I>&gt;<i> &gt;    winbind normalize names    = No
</I>&gt;<i> &gt;    winbind separator          = /
</I>&gt;<i> &gt;    winbind use default domain = yes
</I>&gt;<i> &gt;    winbind nested groups      = Yes
</I>&gt;<i> &gt;    winbind reconnect delay    = 30
</I>&gt;<i> &gt;    winbind offline logon      = true
</I>&gt;<i> &gt;    winbind cache time         = 1800
</I>&gt;<i> &gt;    winbind refresh tickets    = true
</I>&gt;<i> &gt;    winbind refresh tickets    = true
</I>&gt;<i> &gt;    winbind max clients        = 500
</I>&gt;<i> &gt;    allow trusted domains      = Yes
</I>&gt;<i> &gt;    server signing             = auto
</I>&gt;<i> &gt;    client signing             = auto
</I>&gt;<i> &gt;    lm announce                = No
</I>&gt;<i> &gt;    ntlm auth                  = No
</I>&gt;<i> &gt;    lanman auth                = No
</I>&gt;<i> &gt;    preferred master           = No
</I>&gt;<i> &gt;    local master               = No
</I>&gt;<i> &gt;    wins support               = No
</I>&gt;<i> &gt;    encrypt passwords          = yes
</I>&gt;<i> &gt;    printing                   = bsd
</I>&gt;<i> &gt;    load printers              = no
</I>&gt;<i> &gt;    socket options             = TCP_NODELAY SO_RCVBUF=8192 SO_SNDBUF=8192
</I>&gt;<i> &gt;    min protocol               = SMB2
</I>&gt;<i> &gt;    client min protocol          = SMB2
</I>&gt;<i> &gt;    client max protocol          = SMB3
</I>&gt;<i> &gt;    load printers              = no
</I>&gt;<i> &gt;    printing                   = bsd
</I>&gt;<i> &gt;    printcap name              = /dev/null
</I>&gt;<i> &gt;    disable spoolss            = yes
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Squid.conf
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; # kerberos_conf() LockActiveDirectoryToKerberos = 0
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; #
</I>&gt;<i> &gt; #KerbAuthMethod = 0/1 and NOT_NTLM = False
</I>&gt;<i> &gt; auth_param ntlm program /usr/bin/ntlm_auth  --domain=mydom.MY
</I>&gt;<i> --helper-protocol=squid-2.5-ntlmssp
</I>&gt;<i> &gt; auth_param ntlm children 500 startup=5 idle=1 concurrency=0
</I>&gt;<i> queue-size=2000 on-persistent-overload=ERR
</I>&gt;<i> &gt; auth_param ntlm keep_alive off
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; #
</I>&gt;<i> &gt; # ads groups OK
</I>&gt;<i> &gt; #Other settings
</I>&gt;<i> &gt; auth_param basic credentialsttl 7200 seconds
</I>&gt;<i> &gt; authenticate_ttl 3600 seconds
</I>&gt;<i> &gt; authenticate_ip_ttl 1 seconds
</I>&gt;<i> &gt; authenticate_cache_garbage_interval 3600 seconds
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; acl authFailed src all
</I>&gt;<i> &gt; acl AUTHENTICATED proxy_auth REQUIRED
</I>&gt;<i> &gt; # END NTLM Parameters --------------------------------
</I>&gt;<i> &gt; # Basic authentication for other browser that did not supports NTLM
</I>&gt;<i> &gt; auth_param basic program /usr/bin/ntlm_auth
</I>&gt;<i> --helper-protocol=squid-2.5-basic
</I>&gt;<i> &gt; auth_param basic children 60 startup=2 idle=1
</I>&gt;<i> &gt; auth_param basic realm Active Directory Basic Identification
</I>&gt;<i> &gt; auth_param basic credentialsttl 7200 seconds
</I>&gt;<i> &gt; authenticate_ttl 3600 seconds
</I>&gt;<i> &gt; authenticate_ip_ttl 1 seconds
</I>&gt;<i> &gt; authenticate_cache_garbage_interval 3600 seconds
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; # ldap_auth_ad() EnableAdLDAPAuth = 0 - SKIP
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; # ads groups OK
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; # --------------------------------------------------
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; _______________________________________________
</I>&gt;<i> &gt; squid-users mailing list
</I>&gt;<i> &gt; <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> &gt; <A HREF="https://lists.squid-cache.org/listinfo/squid-users">https://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> --
</I>&gt;<i>     Francesco
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">https://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20240725/828c1bb7/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20240725/828c1bb7/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="026981.html">[squid-users] SQUID - WINDBIND - very slow internet speed
</A></li>
	<LI>Next message (by thread): <A HREF="026984.html">[squid-users] SQUID - WINDBIND - very slow internet speed
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26983">[ date ]</a>
              <a href="thread.html#26983">[ thread ]</a>
              <a href="subject.html#26983">[ subject ]</a>
              <a href="author.html#26983">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
