<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] IPTABLES - Can't redirect HTTPS traffic to external Squid
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20IPTABLES%20-%20Can%27t%20redirect%20HTTPS%20traffic%20to%0A%20external%20Squid&In-Reply-To=%3CCABA8h%3DTwHtQGSkW19vX3M_fJxAVM4p561fU36Wf%3Dyye1G4s0ew%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="027004.html">
   <LINK REL="Next"  HREF="027003.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] IPTABLES - Can't redirect HTTPS traffic to external Squid</H1>
    <B>NgTech LTD</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20IPTABLES%20-%20Can%27t%20redirect%20HTTPS%20traffic%20to%0A%20external%20Squid&In-Reply-To=%3CCABA8h%3DTwHtQGSkW19vX3M_fJxAVM4p561fU36Wf%3Dyye1G4s0ew%40mail.gmail.com%3E"
       TITLE="[squid-users] IPTABLES - Can't redirect HTTPS traffic to external Squid">ngtech1ltd at gmail.com
       </A><BR>
    <I>Tue Jul 30 21:27:11 UTC 2024</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="027004.html">[squid-users] IPTABLES - Can't redirect HTTPS traffic to external Squid
</A></li>
        <LI>Next message (by thread): <A HREF="027003.html">[squid-users] Parse DNS for IPv4 and IPv6
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27005">[ date ]</a>
              <a href="thread.html#27005">[ thread ]</a>
              <a href="subject.html#27005">[ subject ]</a>
              <a href="author.html#27005">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hey,

Sorry I missed understand the scenario.
For now lets assume the packets are routed to the proxy properly but, lets
try to understand how do you route the traffic to the proxy?

Also what is defined on the proxy http_port

Are you using artica proxy?
Where do you implement the iptables rules?

Eliezer

&#1489;&#1514;&#1488;&#1512;&#1497;&#1498; &#1497;&#1493;&#1501; &#1490;&#1523;, 30 &#1489;&#1497;&#1493;&#1500;&#1497; 2024, 23:54, &#1502;&#1488;&#1514; Bolinhas Andr&#233; &#8207;&lt;
<A HREF="https://lists.squid-cache.org/listinfo/squid-users">andre.bolinhas at articatech.com</A>&gt;:

&gt;<i>
</I>&gt;<i> Hi
</I>&gt;<i>
</I>&gt;<i> Do you mean user this
</I>&gt;<i>
</I>&gt;<i> iptables -t nat -I PREROUTING -s 192.168.60.90/32 -p tcp -m tcp --dport
</I>&gt;<i> 443 -m comment --comment ArticaSquidTransparent -j DNAT --to-destination
</I>&gt;<i> 172.31.0.1:25976
</I>&gt;<i>
</I>&gt;<i> iptables -t nat -I PREROUTING -s 192.168.60.90/32 -p tcp -m tcp --dport
</I>&gt;<i> 80 -m comment --comment ArticaSquidTransparent -j DNAT --to-destination
</I>&gt;<i> 172.31.0.1:52406
</I>&gt;<i>
</I>&gt;<i> Instead this
</I>&gt;<i>
</I>&gt;<i> iptables -t nat -I PREROUTING -s 192.168.60.90/32 -p tcp -m tcp --dport
</I>&gt;<i> 443 -m comment --comment ArticaSquidTransparent -j REDIRECT --to-ports 25976
</I>&gt;<i>
</I>&gt;<i> iptables -t nat -I PREROUTING -s 192.168.60.90/32 -p tcp -m tcp --dport
</I>&gt;<i> 80 -m comment --comment ArticaSquidTransparent -j REDIRECT --to-ports 52406
</I>&gt;<i>
</I>&gt;<i> ?
</I>&gt;<i>
</I>&gt;<i> Do I also need some kind of
</I>&gt;<i>
</I>&gt;<i> -m state --state NEW,ESTABLISHED,RELATED -j ACCEPT
</I>&gt;<i>
</I>&gt;<i> ?
</I>&gt;<i>
</I>&gt;<i> Best regards
</I>&gt;<i> Sent from Nine &lt;<A HREF="http://www.9folders.com/">http://www.9folders.com/</A>&gt;
</I>&gt;<i> ------------------------------
</I>&gt;<i> *De:* NgTech LTD &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">ngtech1ltd at gmail.com</A>&gt;
</I>&gt;<i> *Enviado:* ter&#231;a-feira, 30 de julho de 2024 14:44
</I>&gt;<i> *Para:* Bolinhas Andr&#233;
</I>&gt;<i> *Cc:* <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> *Assunto* Re: [squid-users] IPTABLES - Can't redirect HTTPS traffic to
</I>&gt;<i> external Squid
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Hey,
</I>&gt;<i>
</I>&gt;<i> The dnat rule should be done on the squid itsef.
</I>&gt;<i> You will need to re-route the relevant traffic over the ipsec tunnel to
</I>&gt;<i> the squid ip.
</I>&gt;<i> It's possible to do that over ipip or gre tunnels.
</I>&gt;<i>
</I>&gt;<i> Eliezer
</I>&gt;<i>
</I>&gt;<i> &#1489;&#1514;&#1488;&#1512;&#1497;&#1498; &#1497;&#1493;&#1501; &#1490;&#1523;, 30 &#1489;&#1497;&#1493;&#1500;&#1497; 2024, 15:41, &#1502;&#1488;&#1514; Bolinhas Andr&#233; &#8207;&lt;
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">andre.bolinhas at articatech.com</A>&gt;:
</I>&gt;<i>
</I>&gt;&gt;<i> I have a external proxy server connected by VPN (IPSEC) to my main
</I>&gt;&gt;<i> branch, and i'm trying to redirect all users HTTP / HTTPS traffic to this
</I>&gt;&gt;<i> proxy.
</I>&gt;&gt;<i> Scenario Users -&gt; Gateway (Main Branch) -&gt; IPSEC -&gt; Squid Proxy
</I>&gt;&gt;<i> (transparent mode)
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> In my Gateway (Main Branch) I have this test iptables rule, that is
</I>&gt;&gt;<i> forwarding all the TPC / UDP traffic to the Proxy server.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> iptables -t nat -I PREROUTING -s 192.168.60.90 -p tcp -j DNAT --to-destination 172.31.0.1
</I>&gt;&gt;<i> iptables -t nat -I PREROUTING -s 192.168.60.90 -p udp -j DNAT --to-destination 172.31.0.1
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> In Squidd Proxy server I have the followed rules
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> iptables -t nat -I PREROUTING -s 192.168.60.90/32 -p tcp -m tcp --dport 443 -m comment --comment ArticaSquidTransparent -j REDIRECT --to-ports 8081
</I>&gt;&gt;<i> iptables -t nat -I PREROUTING -s 192.168.60.90/32 -p tcp -m tcp --dport 80 -m comment --comment ArticaSquidTransparent -j REDIRECT --to-ports 8080
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Everything is working correctly, HTTP traffic is ok, DNS are also
</I>&gt;&gt;<i> working, the only exeption is the HTTPS traffic, I can see the HTTPS
</I>&gt;&gt;<i> traffic inside the squid access.log but on client side I got a timeout
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> 1722265740.867      1 192.168.60.90 TCP_TUNNEL/200 0 CONNECT cnn.com:443 - HIER_DIRECT/51.210.183.2:443 - mac=&quot;00:00:00:00:00:00&quot; webfilterpolicy:%200%0D%0A exterr=&quot;-|-&quot;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Anyone can help me to understant if I'm missing so iptable rule to handle
</I>&gt;&gt;<i> the HTTPS traffic?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Sent from Nine &lt;<A HREF="http://www.9folders.com/">http://www.9folders.com/</A>&gt;
</I>&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;<i> squid-users mailing list
</I>&gt;&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">https://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;&gt;<i>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20240731/2f704b46/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20240731/2f704b46/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="027004.html">[squid-users] IPTABLES - Can't redirect HTTPS traffic to external Squid
</A></li>
	<LI>Next message (by thread): <A HREF="027003.html">[squid-users] Parse DNS for IPv4 and IPv6
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27005">[ date ]</a>
              <a href="thread.html#27005">[ thread ]</a>
              <a href="subject.html#27005">[ subject ]</a>
              <a href="author.html#27005">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
