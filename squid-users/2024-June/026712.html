<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] IPv6 happy eyeball on dualstack host
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20IPv6%20happy%20eyeball%20on%20dualstack%20host&In-Reply-To=%3C547a317b-3592-4aea-ad11-0667b6f0d015%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="026711.html">
   <LINK REL="Next"  HREF="026713.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] IPv6 happy eyeball on dualstack host</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20IPv6%20happy%20eyeball%20on%20dualstack%20host&In-Reply-To=%3C547a317b-3592-4aea-ad11-0667b6f0d015%40measurement-factory.com%3E"
       TITLE="[squid-users] IPv6 happy eyeball on dualstack host">rousskov at measurement-factory.com
       </A><BR>
    <I>Wed Jun  5 13:24:32 UTC 2024</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="026711.html">[squid-users] IPv6 happy eyeball on dualstack host
</A></li>
        <LI>Next message (by thread): <A HREF="026713.html">[squid-users] Upgrade path from squid 4.15 to 6.x
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26712">[ date ]</a>
              <a href="thread.html#26712">[ thread ]</a>
              <a href="subject.html#26712">[ subject ]</a>
              <a href="author.html#26712">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 2024-06-05 07:31, sachin gupta wrote:

&gt;<i> We are shifting to IPv6 dual stack hosts. As per squid documentation 
</I>&gt;<i> &lt;<A HREF="https://wiki.squid-cache.org/Features/IPv6">https://wiki.squid-cache.org/Features/IPv6</A>&gt;, IPv6 is enabled by 
</I>&gt;<i> default.
</I>
That statement is a bit misleading: IPv6 detection or probing is enabled 
in default Squid builds (i.e. ./configure --enable-ipv6 is the default), 
but whether a Squid instance will actually &quot;enable IPv6&quot; also depends on 
the result of certain startup probes or checks. If those startup checks 
fail, Squid will not send DNS AAAA queries.


&gt;<i> As per documentation, based on DNS response squid will try both IP4 and 
</I>&gt;<i> IPv6 if DNS return both addresses. 
</I>
FWIW, this summary does not quite match modern Squid behavior. The 
difference is _not_ important for your current triage because your Squid 
currently does not even request an IPv6 address from DNS. Once you fix 
that, you should _not_ expect Squid to use both IPv4 and IPv6 TCP/IP 
connections in every test case: Squid may or may not use both address 
families, depending on various runtime factors that affect Squid's Happy 
Eyeballs algorithm (e.g., see happy_eyeballs_connect_timeout directive).


&gt;<i> But I see that squid is only getting IPv4 address
</I>
To be more precise, your Squid does not send a DNS AAAA query after 
sending a DNS A query (no idnsSendSlaveAAAAQuery line after idnsALookup 
in your cache.log). That fact suggests that your Squid runs with 
disabled IPv6. I suggest the following triage steps:

1. Examine &quot;/path/to/your/executable/squid -v&quot; output to make sure your 
Squid executable is _not_ built with --disable-ipv6.

2. Examine level-1 cache.log for startup BCP 177 warnings like this one:
    WARNING: BCP 177 violation. Detected non-functional IPv6 loopback

3. Examine _early_ level-2 startup ProbeTransport messages. For example:
    $ your/squid -f your.squid.conf -N -X -d9 2&gt;&amp;1 | grep ProbeTransport
     ProbeTransport: Detected IPv6 hybrid or v4-mapping stack...
     ProbeTransport: Detected functional IPv6 loopback ...
     ProbeTransport: IPv6 transport Enabled


Someday, somebody will (a) completely remove --disable-ipv6 and (b) 
improve startup probing code to make steps 1 and 3 completely 
unnecessary. We have recently done a couple of baby steps towards (a).


HTH,

Alex.


&gt;<i> though with dis command I can see IPv6 address as well. 
</I>&gt;<i> Also from same host, I am able to make curl command to google using IPv6.
</I>&gt;<i> 
</I>&gt;<i> DNS logs for squid
</I>&gt;<i> 
</I>&gt;<i> 24/06/05 10:41:54.953 kid1| 5,4| AsyncCallQueue.cc(59) fireNext: 
</I>&gt;<i> entering helperHandleRead(conn4 local=[::] remote=[::] FD 13 flags=1, 
</I>&gt;<i> data=0x55c87a45bb38, size=5, buf=0x55c87a45bd60)
</I>&gt;<i> 
</I>&gt;<i> 2024/06/05 10:41:54.953 kid1| 5,4| AsyncCall.cc(41) make: make call 
</I>&gt;<i> helperHandleRead [call4]
</I>&gt;<i> 
</I>&gt;<i> 2024/06/05 10:41:54.953 kid1| 78,3| dns_internal.cc(1792) idnsALookup: 
</I>&gt;<i> idnsALookup: buf is 32 bytes for www.google.com &lt;<A HREF="http://www.google.com">http://www.google.com</A>&gt;, 
</I>&gt;<i> id = 0xe006
</I>&gt;<i> 
</I>&gt;<i> 2024/06/05 10:41:54.953 kid1| 5,4| AsyncCall.cc(29) AsyncCall: The 
</I>&gt;<i> AsyncCall helperHandleRead constructed, this=0x55c87a9301e0 [call89]
</I>&gt;<i> 
</I>&gt;<i> 2024/06/05 10:41:54.953 kid1| 5,5| Read.cc(58) comm_read_base: 
</I>&gt;<i> comm_read, queueing read for conn4 local=[::] remote=[::] FD 13 flags=1; 
</I>&gt;<i> asynCall 0x55c87a9301e0*1
</I>&gt;<i> 
</I>&gt;<i> 2024/06/05 10:41:54.954 kid1| 5,5| ModEpoll.cc(116) SetSelect: FD 13, 
</I>&gt;<i> type=1, handler=1, client_data=0x7f183475a700, timeout=0
</I>&gt;<i> 
</I>&gt;<i> 2024/06/05 10:41:54.954 kid1| 5,4| AsyncCallQueue.cc(61) fireNext: 
</I>&gt;<i> leaving helperHandleRead(conn4 local=[::] remote=[::] FD 13 flags=1, 
</I>&gt;<i> data=0x55c87a45bb38, size=5, buf=0x55c87a45bd60)
</I>&gt;<i> 
</I>&gt;<i> 2024/06/05 10:41:54.955 kid1| 78,3| dns_internal.cc(1318) idnsRead: 
</I>&gt;<i> idnsRead: starting with FD 11
</I>&gt;<i> 
</I>&gt;<i> 2024/06/05 10:41:54.955 kid1| 5,5| ModEpoll.cc(116) SetSelect: FD 11, 
</I>&gt;<i> type=1, handler=1, client_data=0, timeout=0
</I>&gt;<i> 
</I>&gt;<i> 2024/06/05 10:41:54.955 kid1| 78,3| dns_internal.cc(1364) idnsRead: 
</I>&gt;<i> idnsRead: FD 11: received 48 bytes from 10.0.32.2:53 &lt;<A HREF="http://10.0.32.2:53">http://10.0.32.2:53</A>&gt;
</I>&gt;<i> 
</I>&gt;<i> 2024/06/05 10:41:54.955 kid1| 78,3| dns_internal.cc(1171) idnsGrokReply: 
</I>&gt;<i> idnsGrokReply: QID 0xe006, 1 answers
</I>&gt;<i> 
</I>&gt;<i> 2024/06/05 10:41:54.955 kid1| 5,5| Connection.cc(99) cloneProfile: 
</I>&gt;<i> 0x55c87a944210 made conn56 local=0.0.0.0 remote=142.251.215.228:80 
</I>&gt;<i> &lt;<A HREF="http://142.251.215.228:80">http://142.251.215.228:80</A>&gt; HIER_DIRECT flags=1
</I>&gt;<i> 
</I>&gt;<i> 2024/06/05 10:41:54.955 kid1| 5,5| Connection.cc(99) cloneProfile: 
</I>&gt;<i> 0x55c87a944830 made conn57 local=0.0.0.0 remote=142.251.215.228:80 
</I>&gt;<i> &lt;<A HREF="http://142.251.215.228:80">http://142.251.215.228:80</A>&gt; HIER_DIRECT flags=1
</I>&gt;<i> 
</I>&gt;<i> 2024/06/05 10:41:54.955 kid1| 5,3| ConnOpener.cc(43) ConnOpener: will 
</I>&gt;<i> connect to conn57 local=0.0.0.0 remote=142.251.215.228:80 
</I>&gt;<i> &lt;<A HREF="http://142.251.215.228:80">http://142.251.215.228:80</A>&gt; HIER_DIRECT flags=1 with 15 timeout
</I>&gt;<i> 
</I>&gt;<i> 2024/06/05 10:41:54.955 kid1| 5,5| comm.cc(428) comm_init_opened: conn58 
</I>&gt;<i> local=0.0.0.0 remote=[::] FD 16 flags=1 is a new socket
</I>&gt;<i> 
</I>&gt;<i> 2024/06/05 10:41:54.955 kid1| 5,4| AsyncCall.cc(29) AsyncCall: The 
</I>&gt;<i> AsyncCall Comm::ConnOpener::earlyAbort constructed, this=0x55c87a944cd0 
</I>&gt;<i> [call95]
</I>&gt;<i> 
</I>&gt;<i> 2024/06/05 10:41:54.955 kid1| 5,5| comm.cc(1004) comm_add_close_handler: 
</I>&gt;<i> comm_add_close_handler: FD 16, AsyncCall=0x55c87a944cd0*1
</I>&gt;<i> 
</I>&gt;<i> 2024/06/05 10:41:54.955 kid1| 5,4| AsyncCall.cc(29) AsyncCall: The 
</I>&gt;<i> AsyncCall Comm::ConnOpener::timeout constructed, this=0x55c87a944d70 
</I>&gt;<i> [call96]
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Dig Output
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> dig www.google.com &lt;<A HREF="http://www.google.com">http://www.google.com</A>&gt;AAAA
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> ; &lt;&lt;&gt;&gt; DiG 9.16.23-RH &lt;&lt;&gt;&gt; www.google.com &lt;<A HREF="http://www.google.com">http://www.google.com</A>&gt; AAAA
</I>&gt;<i> 
</I>&gt;<i> ;; global options: +cmd
</I>&gt;<i> 
</I>&gt;<i> ;; Got answer:
</I>&gt;<i> 
</I>&gt;<i> ;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 27477
</I>&gt;<i> 
</I>&gt;<i> ;; flags: qr rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> ;; OPT PSEUDOSECTION:
</I>&gt;<i> 
</I>&gt;<i> ; EDNS: version: 0, flags:; udp: 4096
</I>&gt;<i> 
</I>&gt;<i> ;; QUESTION SECTION:
</I>&gt;<i> 
</I>&gt;<i> ;www.google.com &lt;<A HREF="http://www.google.com">http://www.google.com</A>&gt;.INAAAA
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> ;; ANSWER SECTION:
</I>&gt;<i> 
</I>&gt;<i> www.google.com &lt;<A HREF="http://www.google.com">http://www.google.com</A>&gt;.237INAAAA2607:f8b0:400a:804::2004
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> ;; Query time: 0 msec
</I>&gt;<i> 
</I>&gt;<i> ;; SERVER: 10.0.32.2#53(10.0.32.2)
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Can you please help and let me know if I am missing anything.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Regards
</I>&gt;<i> 
</I>&gt;<i> Sachin
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">https://lists.squid-cache.org/listinfo/squid-users</A>
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="026711.html">[squid-users] IPv6 happy eyeball on dualstack host
</A></li>
	<LI>Next message (by thread): <A HREF="026713.html">[squid-users] Upgrade path from squid 4.15 to 6.x
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26712">[ date ]</a>
              <a href="thread.html#26712">[ thread ]</a>
              <a href="subject.html#26712">[ subject ]</a>
              <a href="author.html#26712">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
