<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] can't explain 403 denied for authenticated
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20can%27t%20explain%20403%20denied%20for%20authenticated&In-Reply-To=%3C0B651117-9E91-4C7D-B804-0E3B25D67E21%40gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="026721.html">
   <LINK REL="Next"  HREF="026723.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] can't explain 403 denied for authenticated</H1>
    <B>Jonathan Lee</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20can%27t%20explain%20403%20denied%20for%20authenticated&In-Reply-To=%3C0B651117-9E91-4C7D-B804-0E3B25D67E21%40gmail.com%3E"
       TITLE="[squid-users] can't explain 403 denied for authenticated">jonathanlee571 at gmail.com
       </A><BR>
    <I>Fri Jun  7 06:16:09 UTC 2024</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="026721.html">[squid-users] can't explain 403 denied for authenticated
</A></li>
        <LI>Next message (by thread): <A HREF="026723.html">[squid-users] can't explain 403 denied for authenticated
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26722">[ date ]</a>
              <a href="thread.html#26722">[ thread ]</a>
              <a href="subject.html#26722">[ subject ]</a>
              <a href="author.html#26722">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>You can also add this to lock down the proxy after hours so nothing is used much like locking a door, whatever is inside is going to keep working ie connections already established however all new connections will be blocked. I love this one 

acl block_hours time 00:30-05:00
ssl_bump terminate all block_hours
http_access deny all block_hours

however this is for use with ssl intercept and root certificates installed however it also works for spliced connections as it comes before everything else the terminate everything line 

you can also if you want to lock down to specific mac addresses ie small office home network 

use 

eui_lookup on


Example of use with mac addresses

acl splice_only src 192.168.1.8 #Tasha iPhone
acl splice_only src 192.168.1.10 #Jon iPhone
acl splice_only src 192.168.1.11 #Amazon Fire
acl splice_only src 192.168.1.15 #Tasha HP
acl splice_only src 192.168.1.16 #iPad

acl splice_only_mac arp  (unique 48bit hardware address here)
acl splice_only_mac arp (unique 48bit hardware address here)
acl splice_only_mac arp (unique 48bit hardware address here)
acl splice_only_mac arp  (unique 48bit hardware address here)
acl splice_only_mac arp  (unique 48bit hardware address here)

acl NoSSLIntercept ssl::server_name_regex -i &quot;/usr/local/pkg/reg.url.nobump&quot;
acl NoBumpDNS dstdomain &quot;/usr/local/pkg/dns.nobump&quot;

acl markBumped annotate_client bumped=true
acl active_use annotate_client active=true
acl bump_only src 192.168.1.3 #webtv
acl bump_only src 192.168.1.4 #toshiba
acl bump_only src 192.168.1.5 #imac
acl bump_only src 192.168.1.9 #macbook
acl bump_only src 192.168.1.13 #dell

acl bump_only_mac arp (unique 48bit hardware address here)
acl bump_only_mac arp  (unique 48bit hardware address here)
acl bump_only_mac arp  (unique 48bit hardware address here)
acl bump_only_mac arp  (unique 48bit hardware address here)
acl bump_only_mac arp  (unique 48bit hardware address here)

ssl_bump peek step1
miss_access deny no_miss active_use
ssl_bump splice https_login active_use
ssl_bump splice splice_only_mac splice_only active_use (this works as &#8220;and logic&#8221; except my annotate active use)
ssl_bump splice NoBumpDNS active_use
ssl_bump splice NoSSLIntercept active_use
ssl_bump bump bump_only_mac bump_only active_use
acl activated note active_use true
ssl_bump terminate !activated

acl markedBumped note bumped true
url_rewrite_access deny markedBumped

&gt;<i> On Jun 6, 2024, at 12:08, Kevin &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid at kretz.net</A>&gt; wrote:
</I>&gt;<i> 
</I>&gt;<i> &gt;&gt; uri_whitespace encode
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;Hmm. Accepting whitespace in URLs is a risky choice. One can never be
</I>&gt;<i> &gt;completely sure how third-party agents in the network are handling it
</I>&gt;<i> &gt;before the request arrived.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;If (big IF) you are able to use &quot;uri_whitespace deny&quot; this proxy would
</I>&gt;<i> &gt;be a bit more secure. This is just a suggestion, you know best here.
</I>&gt;<i> 
</I>&gt;<i> I think that was a workaround for a vulnerability.  If it was, it may no longer be needed.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;&gt; acl trellix_phone_cloud dstdomain amcore-ens.rest.gti.trellix.com
</I>&gt;<i> &gt;&gt; http_access deny trellix_phone_cloud
</I>&gt;<i> &gt;&gt; external_acl_type host_based_filter children-max=15 ttl=0 0X0P+0CL &gt;&gt; acl HostBasedRules external host_based_filter
</I>&gt;<i> &gt;&gt; http_access allow HostBasedRules
</I>&gt;<i> &gt;&gt; auth_param digest program /usr/lib/squid/digest_file_auth -c /etc/squid/passwd
</I>&gt;<i> &gt;&gt; auth_param digest realm squid
</I>&gt;<i> &gt;&gt; auth_param digest children 2
</I>&gt;<i> &gt;&gt; auth_param basic program /usr/lib/squid/basic_ncsa_auth /etc/squid/basic_passwd
</I>&gt;<i> &gt;&gt; auth_param basic children 2
</I>&gt;<i> &gt;&gt; auth_param basic realm squidb
</I>&gt;<i> &gt;&gt; auth_param basic credentialsttl 2 hours
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;&gt; acl auth_users proxy_auth REQUIRED
</I>&gt;<i> &gt;&gt; external_acl_type custom_acl_db children-max=15 ttl=0 0X0P+0CL &gt;&gt; acl CustomAclDB external custom_acl_db
</I>&gt;<i> &gt;&gt; http_access allow CustomAclDB
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;Hmm, this use of combined authentication+authorization is a bit tricky
</I>&gt;<i> &gt;with two layers of asynchronous helper lookups going on. That alone
</I>&gt;<i> &gt;might be what is going on with the weird 403's.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;A better sequence would be:
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;# ensure login is performed
</I>&gt;<i> &gt;http_access deny !auth_users
</I>&gt;<i> &gt;
</I>&gt;<i> &gt;# check the access permissions for whichever user logged in
</I>&gt;<i> &gt;http_access allow CustomAclDB
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> The first call the the external_acl is to process unauthenticated requests.   Is the suggestion to replace
</I>&gt;<i> 
</I>&gt;<i> acl auth_users proxy_auth REQUIRED
</I>&gt;<i> 
</I>&gt;<i> with
</I>&gt;<i> 
</I>&gt;<i> http_access deny !auth_users
</I>&gt;<i> 
</I>&gt;<i> before the second external_acl (for authenticated requests)?
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Thanks again, very much
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Kevin
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">https://lists.squid-cache.org/listinfo/squid-users</A>
</I>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20240606/99fc975e/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20240606/99fc975e/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="026721.html">[squid-users] can't explain 403 denied for authenticated
</A></li>
	<LI>Next message (by thread): <A HREF="026723.html">[squid-users] can't explain 403 denied for authenticated
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26722">[ date ]</a>
              <a href="thread.html#26722">[ thread ]</a>
              <a href="subject.html#26722">[ subject ]</a>
              <a href="author.html#26722">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
