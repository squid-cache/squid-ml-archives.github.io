<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] FATAL: assertion failed: mem/PageStack.cc:159: &quot;StoredNode().is_lock_free()&quot;
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20FATAL%3A%20assertion%20failed%3A%20mem/PageStack.cc%3A159%3A%0A%20%22StoredNode%28%29.is_lock_free%28%29%22&In-Reply-To=%3Cf07dddcd-8f6e-422e-b21b-9b9d9a60c718%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="026780.html">
   <LINK REL="Next"  HREF="026782.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] FATAL: assertion failed: mem/PageStack.cc:159: &quot;StoredNode().is_lock_free()&quot;</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20FATAL%3A%20assertion%20failed%3A%20mem/PageStack.cc%3A159%3A%0A%20%22StoredNode%28%29.is_lock_free%28%29%22&In-Reply-To=%3Cf07dddcd-8f6e-422e-b21b-9b9d9a60c718%40measurement-factory.com%3E"
       TITLE="[squid-users] FATAL: assertion failed: mem/PageStack.cc:159: &quot;StoredNode().is_lock_free()&quot;">rousskov at measurement-factory.com
       </A><BR>
    <I>Thu Jun 27 17:36:05 UTC 2024</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="026780.html">[squid-users] FATAL: assertion failed: mem/PageStack.cc:159: &quot;StoredNode().is_lock_free()&quot;
</A></li>
        <LI>Next message (by thread): <A HREF="026782.html">[squid-users] FATAL: assertion failed: mem/PageStack.cc:159: &quot;StoredNode().is_lock_free()&quot;
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26781">[ date ]</a>
              <a href="thread.html#26781">[ thread ]</a>
              <a href="subject.html#26781">[ subject ]</a>
              <a href="author.html#26781">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 2024-06-27 10:35, Nishant Sharma wrote:

&gt;<i> I am running squid 6.10 on Openwrt 23.05.2, which is cross compiled for 
</I>&gt;<i> ramips / mipsel_24kc which has a 32 bit CPU (MT7621A) with 2 cores and 2 
</I>&gt;<i> threads.
</I>&gt;<i> 
</I>&gt;<i> Squid fails to start in SMP mode when I set workers &gt; 1.
</I>
The assertion in question may be overreaching -- I suspect the relevant 
code works correctly when std::atomic&lt;uint64_t&gt;::is_lock_free() is 
false. Depending on how those locks are implemented in your environment, 
and how your traffic tickles them, SMP Squid without atomic locks might 
become very slow! We do not (and, IMO, should not) optimize performance 
for environments without lock-free atomics!

I see the following options for going forward:

* Comment out the assertion, void your warranty, and hope for the best.
* Audit relevant code to confirm that the assertion is safe to remove.
* Find a usable OS/environment that has lock-free 64-bit atomics.


&gt;<i> SMP worked fine with squid 4.13 on same architecture.
</I>
SMP Squid v4 has an ABA problem that could, at least in theory, result 
in silent cache corruption. If you are interested in low-level details, 
please see commit 7a5af8db message:
<A HREF="https://github.com/squid-cache/squid/commit/7a5af8db">https://github.com/squid-cache/squid/commit/7a5af8db</A>


HTH,

Alex.


&gt;<i> I have filed a bug report with Openwrt at
</I>&gt;<i> 
</I>&gt;<i> <A HREF="https://github.com/openwrt/packages/issues/24469">https://github.com/openwrt/packages/issues/24469</A>
</I>&gt;<i> 
</I>&gt;<i> where someone suggested, &quot;ramips has one CPU and the assert is that 
</I>&gt;<i> system pointers are not 64bit.&quot;
</I>&gt;<i> 
</I>&gt;<i> Below are the logs for debug_options 54,9:
</I>&gt;<i> 
</I>&gt;<i> 2024/06/27 19:48:45.888| 54,3| mem/Segment.cc(245) unlink: unlinked 
</I>&gt;<i> /squid-cf__metadata.shm segment
</I>&gt;<i> 2024/06/27 19:48:45.888| 54,3| mem/Segment.cc(128) create: created 
</I>&gt;<i> /squid-cf__metadata.shm segment: 8
</I>&gt;<i> 2024/06/27 19:48:45.888| 54,5| mem/Segment.cc(211) lock: mlock(2)-ing 
</I>&gt;<i> disabled
</I>&gt;<i> 2024/06/27 19:48:45.889| 54,3| mem/Segment.cc(245) unlink: unlinked 
</I>&gt;<i> /squid-cf__queues.shm segment
</I>&gt;<i> 2024/06/27 19:48:45.889| 54,3| mem/Segment.cc(128) create: created 
</I>&gt;<i> /squid-cf__queues.shm segment: 32852
</I>&gt;<i> 2024/06/27 19:48:45.889| 54,5| mem/Segment.cc(211) lock: mlock(2)-ing 
</I>&gt;<i> disabled
</I>&gt;<i> 2024/06/27 19:48:45.890| 54,3| mem/Segment.cc(245) unlink: unlinked 
</I>&gt;<i> /squid-cf__readers.shm segment
</I>&gt;<i> 2024/06/27 19:48:45.890| 54,3| mem/Segment.cc(128) create: created 
</I>&gt;<i> /squid-cf__readers.shm segment: 40
</I>&gt;<i> 2024/06/27 19:48:45.890| 54,5| mem/Segment.cc(211) lock: mlock(2)-ing 
</I>&gt;<i> disabled
</I>&gt;<i> 2024/06/27 19:48:45.891| 54,7| Queue.cc(50) QueueReader: constructed ipcQR1
</I>&gt;<i> 2024/06/27 19:48:45.891| 54,7| Queue.cc(50) QueueReader: constructed ipcQR2
</I>&gt;<i> 2024/06/27 19:48:45.891| 54,5| mem/PageStack.cc(129) IdSetMeasurements: 
</I>&gt;<i> rounded capacity up from 8192 to 8192
</I>&gt;<i> 2024/06/27 19:48:45.891| 54,3| mem/Segment.cc(245) unlink: unlinked 
</I>&gt;<i> /squid-squid-page-pool.shm segment
</I>&gt;<i> 2024/06/27 19:48:45.892| 54,3| mem/Segment.cc(128) create: created 
</I>&gt;<i> /squid-squid-page-pool.shm segment: 268437592
</I>&gt;<i> 2024/06/27 19:48:45.892| 54,5| mem/Segment.cc(211) lock: mlock(2)-ing 
</I>&gt;<i> disabled
</I>&gt;<i> 2024/06/27 19:48:45.892| 54,5| mem/PageStack.cc(129) IdSetMeasurements: 
</I>&gt;<i> rounded capacity up from 8192 to 8192
</I>&gt;<i> 2024/06/27 19:48:45| FATAL: assertion failed: mem/PageStack.cc:159: 
</I>&gt;<i> &quot;StoredNode().is_lock_free()&quot;
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Any pointers would be really helpful.
</I>&gt;<i> 
</I>&gt;<i> Thanks in advance.
</I>&gt;<i> 
</I>&gt;<i> Regards,
</I>&gt;<i> Nishant
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">https://lists.squid-cache.org/listinfo/squid-users</A>
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="026780.html">[squid-users] FATAL: assertion failed: mem/PageStack.cc:159: &quot;StoredNode().is_lock_free()&quot;
</A></li>
	<LI>Next message (by thread): <A HREF="026782.html">[squid-users] FATAL: assertion failed: mem/PageStack.cc:159: &quot;StoredNode().is_lock_free()&quot;
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26781">[ date ]</a>
              <a href="thread.html#26781">[ thread ]</a>
              <a href="subject.html#26781">[ subject ]</a>
              <a href="author.html#26781">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
