From shorvath at npsh.hu  Mon Mar  4 11:31:29 2024
From: shorvath at npsh.hu (=?UTF-8?B?U3ppbMOhcmQgSG9ydsOhdGg=?=)
Date: Mon, 04 Mar 2024 12:31:29 +0100
Subject: [squid-users] Squid delay_access with external acl
In-Reply-To: <8ef8e83a-346d-4ce1-bde3-88c1c31f14d4@measurement-factory.com>
References: <65D4517B020000230004796F@groupwise.npsh.hu>
 <CA+Y8hcMkoAz2cuxtqd0Y_7JKfhMBzN+zYbTZJWfXR6DfjdtQTg@mail.gmail.com>
 <8ef8e83a-346d-4ce1-bde3-88c1c31f14d4@measurement-factory.com>
Message-ID: <65E5B1110200002300047C90@groupwise.npsh.hu>

Hi Alex,
 
Thank you so much your answer but this solution isn't work. Please check
my config maybe i made a mistake. Or maybe have you any
other solution? 
 
I can use proxy users from QUOTA_EXCEEDED_USERS.acl which contain e-mail
address or get from ldap with external_acl_type overkvota
children-max=10 children-startup=10 ttl=600 negative_ttl=600 %LOGIN
/usr/lib/squid/ext_ldap_group_acl -Z -v 3 -P -p 389 -h
ldapm1.xxxxx.hu -s sub -D cn=squid_proxy,o=services -W /etc/squid/secret
-b o=xxxx -f
"(&(mail=%u)(objectclass=InetorgPerson)(InternetUser=true)(QuotaExceeded=true))"
 
acl QUOTA_EXCEEDED_USERS ext_user "/etc/squid/QUOTA_EXCEEDED_USERS.acl"
acl markAsLimited annotate_transaction limited=yes
acl markedAsLimited note limited yes
http_access allow QUOTA_EXCEEDED_USERS markAsLimited !all

 
delay_pools 1
delay_class 1 1
delay_parameters 1 32000/32000
delay_access 1 allow markedAsLimited
delay_access 1 deny all
 
br,
Szilard


>>> Alex Rousskov <rousskov at measurement-factory.com> 02/20/2024, 04:52
PM >>>
On 2024-02-20 03:14, Francesco Chemolli wrote:

> acl users ext_user foo bar gazonk
> http_access allow users all # always allow

The above does not always allow. What you meant it probably this:

# This rule never matches. It is used for its side effect:
# The rule evaluates users ACL, caching evaluation result.
http_access allow users !all


> delay_access 3 allow users
>
> should do the trick

... but sometimes will not. Wiki recommendation to "exploit caching" is
an ugly outdated hack that should be avoided. The correct solution these
days is to use annotate_transaction ACL to mark the transaction
accordingly. Here is an untested sketch:

acl fromUserThatShouldBeLimited ext_user ...
acl markAsLimited annotate_transaction limited=yes
acl markedAsLimited note limited yes

# This rule never matches; used for its annotation side effect.
http_access allow fromUserThatShouldBeLimited markAsLimited !all

delay_access 3 allow markedAsLimited

HTH,

Alex.



> On Tue, Feb 20, 2024 at 2:15?PM Szil?rd Horv?th wrote:
>
> Good Day!
>
> I try to make limitation bandwidth for some user group. I have an
> external acl which get the users from ldap database server. In the
> old version of config we blocked the internet with http_access deny
> GROUP, but now i try to allow the internet which has limited
> bandwidth. I know that the delay_access work with only fast ACL and
> external acl or proxy_auth acl are slow. I already tried some
> opportunity but i couldn't solve.
>
> Maybe have you any solution for this? Or any idea how can limitation
> the bandwidth for some user? I need use the username (e-mail address
> format) because that use to login to the proxy.
>
> Version: Squid Cache: Version 5.6
>
> Thank you so much and i am waiting for your answer!
>
> Have a good day!
>
> Br,
> Szilard Horvath
>
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> <mailto:squid-users at lists.squid-cache.org>
> https://lists.squid-cache.org/listinfo/squid-users
> <https://lists.squid-cache.org/listinfo/squid-users>
>
>
>
> --
> Francesco
>
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> https://lists.squid-cache.org/listinfo/squid-users


-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20240304/9a2a4fb0/attachment.htm>

From rousskov at measurement-factory.com  Mon Mar  4 17:54:01 2024
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Mon, 4 Mar 2024 12:54:01 -0500
Subject: [squid-users] Squid delay_access with external acl
In-Reply-To: <65E5B1110200002300047C90@groupwise.npsh.hu>
References: <65D4517B020000230004796F@groupwise.npsh.hu>
 <CA+Y8hcMkoAz2cuxtqd0Y_7JKfhMBzN+zYbTZJWfXR6DfjdtQTg@mail.gmail.com>
 <8ef8e83a-346d-4ce1-bde3-88c1c31f14d4@measurement-factory.com>
 <65E5B1110200002300047C90@groupwise.npsh.hu>
Message-ID: <ee5efe0b-429b-4c1c-9253-1416a0eb2cd3@measurement-factory.com>

On 2024-03-04 06:31, Szil?rd Horv?th wrote:

> Thank you so much your answer but this solution isn't work.

Please note that I did not (try to) offer a solution. I only tried to 
correct a specific problem in a specific configuration statement.

I hope that Francesco will continue to guide you towards the solution 
that works in your environment. It may be useful to know what exactly 
does not work at this point (e.g., the transaction never gets a 
limited=yes annotation, which you can check by logging %note to 
access.log, OR the transaction is annotated as expected but is not 
delayed as expected).


Good luck,

Alex.



> Please check 
> my config maybe i made a mistake. Or maybe have you any other solution?
> I can use proxy users from QUOTA_EXCEEDED_USERS.acl which contain e-mail 
> address or get from ldap with external_acl_type overkvota 
> children-max=10 children-startup=10 ttl=600 negative_ttl=600 %LOGIN 
> /usr/lib/squid/ext_ldap_group_acl -Z -v 3 -P -p 389 -h ldapm1.xxxxx.hu 
> -s sub -D cn=squid_proxy,o=services -W /etc/squid/secret -b o=xxxx -f 
> "(&(mail=%u)(objectclass=InetorgPerson)(InternetUser=true)(QuotaExceeded=true))"
> *acl QUOTA_EXCEEDED_USERS ext_user "/etc/squid/QUOTA_EXCEEDED_USERS.acl"*
> *acl markAsLimited annotate_transaction limited=yes*
> *acl markedAsLimited note limited yes*
> *http_access allow QUOTA_EXCEEDED_USERS markAsLimited !all
> *
> *delay_pools 1
> delay_class 1 1
> delay_parameters 1 32000/32000
> delay_access 1 allow markedAsLimited
> delay_access 1 deny all*
> br,
> Szilard
> 
> 
>>>> Alex Rousskov <rousskov at measurement-factory.com> 02/20/2024, 04:52 PM >>>
> On 2024-02-20 03:14, Francesco Chemolli wrote:
> 
>  > acl users ext_user foo bar gazonk
>  > http_access allow users all # always allow
> 
> The above does not always allow. What you meant it probably this:
> 
> # This rule never matches. It is used for its side effect:
> # The rule evaluates users ACL, caching evaluation result.
> http_access allow users !all
> 
> 
>  > delay_access 3 allow users
>  >
>  > should do the trick
> 
> ... but sometimes will not. Wiki recommendation to "exploit caching" is
> an ugly outdated hack that should be avoided. The correct solution these
> days is to use annotate_transaction ACL to mark the transaction
> accordingly. Here is an untested sketch:
> 
> acl fromUserThatShouldBeLimited ext_user ...
> acl markAsLimited annotate_transaction limited=yes
> acl markedAsLimited note limited yes
> 
> # This rule never matches; used for its annotation side effect.
> http_access allow fromUserThatShouldBeLimited markAsLimited !all
> 
> delay_access 3 allow markedAsLimited
> 
> HTH,
> 
> Alex.
> 
> 
> 
>  > On Tue, Feb 20, 2024 at 2:15?PM Szil?rd Horv?th wrote:
>  >
>  > Good Day!
>  >
>  > I try to make limitation bandwidth for some user group. I have an
>  > external acl which get the users from ldap database server. In the
>  > old version of config we blocked the internet with http_access deny
>  > GROUP, but now i try to allow the internet which has limited
>  > bandwidth. I know that the delay_access work with only fast ACL and
>  > external acl or proxy_auth acl are slow. I already tried some
>  > opportunity but i couldn't solve.
>  >
>  > Maybe have you any solution for this? Or any idea how can limitation
>  > the bandwidth for some user? I need use the username (e-mail address
>  > format) because that use to login to the proxy.
>  >
>  > Version: Squid Cache: Version 5.6
>  >
>  > Thank you so much and i am waiting for your answer!
>  >
>  > Have a good day!
>  >
>  > Br,
>  > Szilard Horvath
>  >
>  > _______________________________________________
>  > squid-users mailing list
>  > squid-users at lists.squid-cache.org
>  > <mailto:squid-users at lists.squid-cache.org>
>  > https://lists.squid-cache.org/listinfo/squid-users
>  > <https://lists.squid-cache.org/listinfo/squid-users>
>  >
>  >
>  >
>  > --
>  > Francesco
>  >
>  > _______________________________________________
>  > squid-users mailing list
>  > squid-users at lists.squid-cache.org
>  > https://lists.squid-cache.org/listinfo/squid-users
> 



From dragosrp at proton.me  Mon Mar  4 19:03:51 2024
From: dragosrp at proton.me (Dragos Pacher)
Date: Mon, 04 Mar 2024 19:03:51 +0000
Subject: [squid-users] Missing IPv6 sockets in Squid 6.7 in some servers
Message-ID: <6OLdiBPAdFLozHPxeeJRbnE04faaC6D1FVJwkCceBklRfEZThhwSflwzLZikXonJF__ViZE1ati_4u0AA_HY3XP5AD6bg-JMjPWv-AuX6is=@proton.me>

Hello,

I am a Squid beginner and we would like to use Squid inside our organization only as a HTTPS traffic inspection/logging tool for some 3rd party apps that we bought,
something close to what a "MITM proxy" is called but we will not do that, instead we use a self signed certificate and the 3rd party app owners know this. Everything is
100% completely legal. (Ps: I am the IT lead).

We will be using Squid only internally, no outside access. Here is my issue with the current knowledge of Squid: POC running well on 3 servers but on the 4th I get no IPv6
sockets:
ubuntu at A2-3:/$ sudo netstat -patun | grep squid | grep tcp
tcp 0 0 10.10.0.16:3128 0.0.0.0:* LISTEN 2891391/(squid-1)

and on the other 3 I have IPv6:
ubuntu at A2-2:/$ sudo netstat -patun | grep squid | grep tcp
tcp 0 0 x.x.x.x:52386 x.x.x.x:443 ESTABLISHED 997651/(squid-1)
tcp6 0 0 :::3128 :::* LISTEN 997651/(squid-1)
tcp6 0 0 10.10.0.12:3128 10.20.0.1:39428 ESTABLISHED 997651/(squid-1)

This creates a problem for us since the apps I monitor are not starting since their start routine is IPV6 only and then they switch to IPv4/IPV6, but the start is IPV6 alone.

Therefore my questions are as follows:

- How can I make it listen on both IPV6/IPV4 like on the other servers?
- Any configuration improvement suggestions?

Please find all details here:
So far I did a POC on 4 servers, here is the full config, nothing sophisticated since this is where my Squid knowledge took me so far. Running Squid 6.7 with some basic options
on Ubuntu 22.04 kernel 5.15.0-89-generic x86_64
squid -v
Squid Cache: Version 6.7
Service Name: squidThis binary uses OpenSSL 3.0.2 15 Mar 2022. configure options: '--prefix=/usr' '--localstatedir=/var' '--libexecdir=/lib/squid' '--datadir=/share/squid' '--sysconfdir=/etc/squid' '--with-default-user=proxy' '--with-logdir=/var/log/squid' '--enable-ssl-crtd' '--with-openssl'

and here is the syslog of Squid start:
Mar 4 16:09:28 A2-3 systemd[1]: Starting Squid Web Proxy Server...
Mar 4 16:09:28 A2-3 squid[3094662]: 2024/03/04 16:09:28| Processing Configuration File: /etc/squid/squid.conf (depth 0)
Mar 4 16:09:28 A2-3 squid[3094662]: 2024/03/04 16:09:28| WARNING: empty ACL: acl broken_sites ssl::server_name "/etc/squid/ssl_broken_sites.txt"
Mar 4 16:09:28 A2-3 squid[3094662]: 2024/03/04 16:09:28| WARNING: The "Hs" formatting code is deprecated. Use the ">Hs" instead.
Mar 4 16:09:28 A2-3 squid[3094662]: 2024/03/04 16:09:28| Created PID file (/var/run/squid.pid)
Mar 4 16:09:28 A2-3 squid[3094662]: Squid Parent: will start 1 kids
Mar 4 16:09:28 A2-3 squid[3094662]: Squid Parent: (squid-1) process 3094665 started
Mar 4 16:09:28 A2-3 squid[3094665]: 2024/03/04 16:09:28 kid1| Processing Configuration File: /etc/squid/squid.conf (depth 0)
Mar 4 16:09:28 A2-3 squid[3094665]: 2024/03/04 16:09:28 kid1| WARNING: empty ACL: acl broken_sites ssl::server_name "/etc/squid/ssl_broken_sites.txt"
Mar 4 16:09:28 A2-3 squid[3094665]: 2024/03/04 16:09:28 kid1| WARNING: The "Hs" formatting code is deprecated. Use the ">Hs" instead.
Mar 4 16:09:28 A2-3 squid[3094665]: 2024/03/04 16:09:28 kid1| Set Current Directory to /var/cache/squid
Mar 4 16:09:28 A2-3 squid[3094665]: 2024/03/04 16:09:28 kid1| Creating missing swap directories
Mar 4 16:09:28 A2-3 squid[3094665]: 2024/03/04 16:09:28 kid1| No cache_dir stores are configured.
Mar 4 16:09:28 A2-3 squid[3094662]: Squid Parent: squid-1 process 3094665 exited with status 0
Mar 4 16:09:28 A2-3 squid[3094662]: 2024/03/04 16:09:28| Removing PID file (/var/run/squid.pid)
Mar 4 16:09:28 A2-3 squid[3094666]: Processing Configuration File: /etc/squid/squid.conf (depth 0)
Mar 4 16:09:28 A2-3 squid[3094666]: WARNING: empty ACL: acl broken_sites ssl::server_name "/etc/squid/ssl_broken_sites.txt"
Mar 4 16:09:28 A2-3 squid[3094666]: WARNING: The "Hs" formatting code is deprecated. Use the ">Hs" instead.
Mar 4 16:09:28 A2-3 squid[3094666]: Created PID file (/var/run/squid.pid)
Mar 4 16:09:28 A2-3 squid[3094666]: Squid Parent: will start 1 kids
Mar 4 16:09:28 A2-3 squid[3094666]: Squid Parent: (squid-1) process 3094668 started
Mar 4 16:09:28 A2-3 squid[3094668]: Processing Configuration File: /etc/squid/squid.conf (depth 0)
Mar 4 16:09:28 A2-3 squid[3094668]: WARNING: empty ACL: acl broken_sites ssl::server_name "/etc/squid/ssl_broken_sites.txt"
Mar 4 16:09:28 A2-3 squid[3094668]: WARNING: The "Hs" formatting code is deprecated. Use the ">Hs" instead.
Mar 4 16:09:28 A2-3 squid[3094668]: Set Current Directory to /var/cache/squid
Mar 4 16:09:28 A2-3 squid[3094668]: Starting Squid Cache version 6.7 for x86_64-pc-linux-gnu...
Mar 4 16:09:28 A2-3 squid[3094668]: Service Name: squid
Mar 4 16:09:28 A2-3 squid[3094668]: Process ID 3094668
Mar 4 16:09:28 A2-3 squid[3094668]: Process Roles: worker
Mar 4 16:09:28 A2-3 squid[3094668]: With 1000000 file descriptors available
Mar 4 16:09:28 A2-3 squid[3094668]: Initializing IP Cache...
Mar 4 16:09:28 A2-3 squid[3094668]: DNS IPv6 socket created at [::], FD 9
Mar 4 16:09:28 A2-3 squid[3094668]: DNS IPv4 socket created at 0.0.0.0, FD 10
Mar 4 16:09:28 A2-3 squid[3094668]: Adding nameserver 127.0.0.53 from /etc/resolv.conf
Mar 4 16:09:28 A2-3 squid[3094668]: Adding domain . from /etc/resolv.conf
Mar 4 16:09:28 A2-3 squid[3094668]: helperOpenServers: Starting 5/5 'security_file_certgen' processes
Mar 4 16:09:28 A2-3 squid[3094668]: Logfile: opening log stdio:/var/log/squid/success.log
Mar 4 16:09:28 A2-3 squid[3094668]: Logfile: opening log stdio:/var/log/squid/failure.log
Mar 4 16:09:28 A2-3 squid[3094668]: Logfile: opening log daemon:/var/log/squid/access.log
Mar 4 16:09:28 A2-3 squid[3094668]: Logfile Daemon: opening log /var/log/squid/access.log
Mar 4 16:09:28 A2-3 squid[3094668]: Store logging disabled
Mar 4 16:09:28 A2-3 squid[3094668]: Swap maxSize 0 + 262144 KB, estimated 20164 objects
Mar 4 16:09:28 A2-3 squid[3094668]: Target number of buckets: 1008
Mar 4 16:09:28 A2-3 squid[3094668]: Using 8192 Store buckets
Mar 4 16:09:28 A2-3 squid[3094668]: Max Mem size: 262144 KB
Mar 4 16:09:28 A2-3 squid[3094668]: Max Swap size: 0 KB
Mar 4 16:09:28 A2-3 squid[3094668]: Using Least Load store dir selection
Mar 4 16:09:28 A2-3 squid[3094668]: Set Current Directory to /var/cache/squid
Mar 4 16:09:28 A2-3 squid[3094668]: Finished loading MIME types and icons.
Mar 4 16:09:28 A2-3 squid[3094668]: HTCP Disabled.
Mar 4 16:09:28 A2-3 squid[3094668]: Squid plugin modules loaded: 0
Mar 4 16:09:28 A2-3 squid[3094668]: Adaptation support is off.
Mar 4 16:09:28 A2-3 squid[3094668]: Accepting SSL bumped HTTP Socket connections at conn13 local=10.10.0.16:3128 remote=[::] FD 25 flags=9#012 listening port: 10.10.0.16:3128
Mar 4 16:09:28 A2-3 systemd[1]: Started Squid Web Proxy Server.
Mar 4 16:09:29 A2-3 squid[3094668]: storeLateRelease: released 0 objects

-- full config --
acl SSL_ports port 443
acl SSL_ports port 443
http_access allow localhost
http_access allow localnet
http_access allow all

acl step1 at_step SslBump1
acl step2 at_step SslBump2
acl step3 at_step SslBump3

acl broken_sites ssl::server_name "/etc/squid/ssl_broken_sites.txt"
http_upgrade_request_protocols websocket allow all

ssl_bump peek step1 all
ssl_bump splice broken_sites
ssl_bump stare step2 all
ssl_bump bump step3 all

acl CONNECT method CONNECT
acl success_hier hier_code HIER_DIRECT
acl failure_hier hier_code HIER_NONE
acl failure all-of CONNECT failure_hier
acl failure all-of !CONNECT failure_codes
acl success all-of CONNECT success_hier
acl success all-of !CONNECT success_codes

access_log stdio:/var/log/squid/success.log logformat=squid success
access_log stdio:/var/log/squid/failure.log logformat=squid failure

cache deny all

http_port [::]:3128 ssl-bump generate-host-certificates=on dynamic_cert_mem_cache_size=8MB tls-cert=/etc/squid/myCA.pem tls-key=/etc/squid/myCA1.pem

strip_query_terms off

logformat timereadable %tl %6tr %>a %Ss/%03Hs %<st %rm %ru %un %Sh/%<A %mt
access_log daemon:/var/log/squid/access.log timereadable

coredump_dir /var/cache/squid
refresh_pattern ^ftp: 1440 20% 10080
refresh_pattern -i (/cgi-bin/|\?) 0 0% 0
refresh_pattern . 0 20% 4320
sslcrtd_program /usr/lib/squid/security_file_certgen -s /var/lib/squid/ssl_db -M 16MB
sslcrtd_children 5
ssl_bump server-first all
sslproxy_cert_error allow all
-- end of config

Thank you,

Dragos

Sent with [Proton Mail](https://proton.me/) secure email.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20240304/f15c8e57/attachment.htm>

From rousskov at measurement-factory.com  Mon Mar  4 19:43:00 2024
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Mon, 4 Mar 2024 14:43:00 -0500
Subject: [squid-users] Missing IPv6 sockets in Squid 6.7 in some servers
In-Reply-To: <6OLdiBPAdFLozHPxeeJRbnE04faaC6D1FVJwkCceBklRfEZThhwSflwzLZikXonJF__ViZE1ati_4u0AA_HY3XP5AD6bg-JMjPWv-AuX6is=@proton.me>
References: <6OLdiBPAdFLozHPxeeJRbnE04faaC6D1FVJwkCceBklRfEZThhwSflwzLZikXonJF__ViZE1ati_4u0AA_HY3XP5AD6bg-JMjPWv-AuX6is=@proton.me>
Message-ID: <d276b611-deb3-41a4-8d85-4509391103e4@measurement-factory.com>

On 2024-03-04 14:03, Dragos Pacher wrote:

> POC running well on 3 servers but on the 4th I get no IPv6
> sockets:
> ubuntu at A2-3:/$ sudo netstat -patun | grep squid | grep tcp
> tcp ? ? ? ?0 ? ? ?0 10.10.0.16:3128 ? ? ? ? 0.0.0.0:*               
> LISTEN ? ? ?2891391/(squid-1)

Are there any other processes listening on IPv6 addresses on this 
problematic host?

Does something like "nc -6 -l 3128" listen on an IPv6 address on this 
problematic host?

If possible, please also check cache.log for messages mentioning IPv6 
and "BCP 177"; I know you shared syslog output, but I am a bit worried 
that syslog might be missing some relevant early debugging messages.


If nothing helps, consider sharing a pointer to compressed Squid startup 
cache.log after adding "debug_options ALL,2 50,3" to your squid.conf. We 
do not need to see any transactions, just Squid startup steps. Still, 
this log may contain some sensitive details, so share privately if needed.


Thank you,

Alex.



> and on the other 3 I have IPv6:
> ubuntu at A2-2:/$ sudo netstat -patun | grep squid | grep tcp
> tcp ? ? ? ?0 ? ? ?0 x.x.x.x:52386 ?? x.x.x.x:443 ? ? ESTABLISHED 
> 997651/(squid-1)
> tcp6 ? ? ? 0 ? ? ?0 :::3128 ? ? ? ? ? ? ? ? :::*                   
>  ?LISTEN ? ? ?997651/(squid-1)
> tcp6 ? ? ? 0 ? ? ?0 10.10.0.12:3128 ? ? ? ? 10.20.0.1:39428       
>  ?ESTABLISHED 997651/(squid-1)





> This creates a problem for us since the apps I monitor are not starting 
> since their start routine is IPV6 only and then they switch to 
> IPv4/IPV6, but the start is IPV6 alone.
> 
> Therefore my questions are as follows:
> 
>  1. How can I make it listen on both IPV6/IPV4 like on the other servers?
>  2. Any configuration improvement suggestions?
> 
> 
> Please find all details here:
> So far I did a POC on 4 servers, here is the full config, nothing 
> sophisticated since this is where my Squid knowledge took me so far. 
> Running Squid 6.7 with some basic options
> on Ubuntu 22.04 kernel 5.15.0-89-generic x86_64
> squid -v
> Squid Cache: Version 6.7
> Service Name: squid
> This binary uses OpenSSL 3.0.2 15 Mar 2022. configure options: 
>  ?'--prefix=/usr' '--localstatedir=/var' '--libexecdir=/lib/squid' 
> '--datadir=/share/squid' '--sysconfdir=/etc/squid' 
> '--with-default-user=proxy' '--with-logdir=/var/log/squid' 
> '--enable-ssl-crtd' '--with-openssl'
> 
> and here is the syslog of Squid start:
> Mar ?4 16:09:28 A2-3 systemd[1]: Starting Squid Web Proxy Server...
> Mar ?4 16:09:28 A2-3 squid[3094662]: 2024/03/04 16:09:28| Processing 
> Configuration File: /etc/squid/squid.conf (depth 0)
> Mar ?4 16:09:28 A2-3 squid[3094662]: 2024/03/04 16:09:28| WARNING: empty 
> ACL: acl broken_sites ssl::server_name "/etc/squid/ssl_broken_sites.txt"
> Mar ?4 16:09:28 A2-3 squid[3094662]: 2024/03/04 16:09:28| WARNING: The 
> "Hs" formatting code is deprecated. Use the ">Hs" instead.
> Mar ?4 16:09:28 A2-3 squid[3094662]: 2024/03/04 16:09:28| Created PID 
> file (/var/run/squid.pid)
> Mar ?4 16:09:28 A2-3 squid[3094662]: Squid Parent: will start 1 kids
> Mar ?4 16:09:28 A2-3 squid[3094662]: Squid Parent: (squid-1) process 
> 3094665 started
> Mar ?4 16:09:28 A2-3 squid[3094665]: 2024/03/04 16:09:28 kid1| 
> Processing Configuration File: /etc/squid/squid.conf (depth 0)
> Mar ?4 16:09:28 A2-3 squid[3094665]: 2024/03/04 16:09:28 kid1| WARNING: 
> empty ACL: acl broken_sites ssl::server_name 
> "/etc/squid/ssl_broken_sites.txt"
> Mar ?4 16:09:28 A2-3 squid[3094665]: 2024/03/04 16:09:28 kid1| WARNING: 
> The "Hs" formatting code is deprecated. Use the ">Hs" instead.
> Mar ?4 16:09:28 A2-3 squid[3094665]: 2024/03/04 16:09:28 kid1| Set 
> Current Directory to /var/cache/squid
> Mar ?4 16:09:28 A2-3 squid[3094665]: 2024/03/04 16:09:28 kid1| Creating 
> missing swap directories
> Mar ?4 16:09:28 A2-3 squid[3094665]: 2024/03/04 16:09:28 kid1| No 
> cache_dir stores are configured.
> Mar ?4 16:09:28 A2-3 squid[3094662]: Squid Parent: squid-1 process 
> 3094665 exited with status 0
> Mar ?4 16:09:28 A2-3 squid[3094662]: 2024/03/04 16:09:28| Removing PID 
> file (/var/run/squid.pid)
> Mar ?4 16:09:28 A2-3 squid[3094666]: Processing Configuration File: 
> /etc/squid/squid.conf (depth 0)
> Mar ?4 16:09:28 A2-3 squid[3094666]: WARNING: empty ACL: acl 
> broken_sites ssl::server_name "/etc/squid/ssl_broken_sites.txt"
> Mar ?4 16:09:28 A2-3 squid[3094666]: WARNING: The "Hs" formatting code 
> is deprecated. Use the ">Hs" instead.
> Mar ?4 16:09:28 A2-3 squid[3094666]: Created PID file (/var/run/squid.pid)
> Mar ?4 16:09:28 A2-3 squid[3094666]: Squid Parent: will start 1 kids
> Mar ?4 16:09:28 A2-3 squid[3094666]: Squid Parent: (squid-1) process 
> 3094668 started
> Mar ?4 16:09:28 A2-3 squid[3094668]: Processing Configuration File: 
> /etc/squid/squid.conf (depth 0)
> Mar ?4 16:09:28 A2-3 squid[3094668]: WARNING: empty ACL: acl 
> broken_sites ssl::server_name "/etc/squid/ssl_broken_sites.txt"
> Mar ?4 16:09:28 A2-3 squid[3094668]: WARNING: The "Hs" formatting code 
> is deprecated. Use the ">Hs" instead.
> Mar ?4 16:09:28 A2-3 squid[3094668]: Set Current Directory to 
> /var/cache/squid
> Mar ?4 16:09:28 A2-3 squid[3094668]: Starting Squid Cache version 6.7 
> for x86_64-pc-linux-gnu...
> Mar ?4 16:09:28 A2-3 squid[3094668]: Service Name: squid
> Mar ?4 16:09:28 A2-3 squid[3094668]: Process ID 3094668
> Mar ?4 16:09:28 A2-3 squid[3094668]: Process Roles: worker
> Mar ?4 16:09:28 A2-3 squid[3094668]: With 1000000 file descriptors available
> Mar ?4 16:09:28 A2-3 squid[3094668]: Initializing IP Cache...
> Mar ?4 16:09:28 A2-3 squid[3094668]: DNS IPv6 socket created at [::], FD 9
> Mar ?4 16:09:28 A2-3 squid[3094668]: DNS IPv4 socket created at 0.0.0.0, 
> FD 10
> Mar ?4 16:09:28 A2-3 squid[3094668]: Adding nameserver 127.0.0.53 from 
> /etc/resolv.conf
> Mar ?4 16:09:28 A2-3 squid[3094668]: Adding domain . from /etc/resolv.conf
> Mar ?4 16:09:28 A2-3 squid[3094668]: helperOpenServers: Starting 5/5 
> 'security_file_certgen' processes
> Mar ?4 16:09:28 A2-3 squid[3094668]: Logfile: opening log 
> stdio:/var/log/squid/success.log
> Mar ?4 16:09:28 A2-3 squid[3094668]: Logfile: opening log 
> stdio:/var/log/squid/failure.log
> Mar ?4 16:09:28 A2-3 squid[3094668]: Logfile: opening log 
> daemon:/var/log/squid/access.log
> Mar ?4 16:09:28 A2-3 squid[3094668]: Logfile Daemon: opening log 
> /var/log/squid/access.log
> Mar ?4 16:09:28 A2-3 squid[3094668]: Store logging disabled
> Mar ?4 16:09:28 A2-3 squid[3094668]: Swap maxSize 0 + 262144 KB, 
> estimated 20164 objects
> Mar ?4 16:09:28 A2-3 squid[3094668]: Target number of buckets: 1008
> Mar ?4 16:09:28 A2-3 squid[3094668]: Using 8192 Store buckets
> Mar ?4 16:09:28 A2-3 squid[3094668]: Max Mem ?size: 262144 KB
> Mar ?4 16:09:28 A2-3 squid[3094668]: Max Swap size: 0 KB
> Mar ?4 16:09:28 A2-3 squid[3094668]: Using Least Load store dir selection
> Mar ?4 16:09:28 A2-3 squid[3094668]: Set Current Directory to 
> /var/cache/squid
> Mar ?4 16:09:28 A2-3 squid[3094668]: Finished loading MIME types and icons.
> Mar ?4 16:09:28 A2-3 squid[3094668]: HTCP Disabled.
> Mar ?4 16:09:28 A2-3 squid[3094668]: Squid plugin modules loaded: 0
> Mar ?4 16:09:28 A2-3 squid[3094668]: Adaptation support is off.
> Mar ?4 16:09:28 A2-3 squid[3094668]: Accepting SSL bumped HTTP Socket 
> connections at conn13 local=10.10.0.16:3128 remote=[::] FD 25 
> flags=9#012 ? ?listening port: 10.10.0.16:3128
> Mar ?4 16:09:28 A2-3 systemd[1]: Started Squid Web Proxy Server.
> Mar ?4 16:09:29 A2-3 squid[3094668]: storeLateRelease: released 0 objects
> 
> -- full config --
> acl SSL_ports port 443
> acl SSL_ports port 443
> http_access allow localhost
> http_access allow localnet
> http_access allow all
> 
> acl step1 at_step SslBump1
> acl step2 at_step SslBump2
> acl step3 at_step SslBump3
> 
> acl broken_sites ssl::server_name "/etc/squid/ssl_broken_sites.txt"
> http_upgrade_request_protocols websocket allow all
> 
> ssl_bump peek step1 all
> ssl_bump splice broken_sites
> ssl_bump stare step2 all
> ssl_bump bump step3 all
> 
> acl CONNECT method CONNECT
> acl success_hier hier_code HIER_DIRECT
> acl failure_hier hier_code HIER_NONE
> acl failure all-of CONNECT failure_hier
> acl failure all-of !CONNECT failure_codes
> acl success all-of CONNECT success_hier
> acl success all-of !CONNECT success_codes
> 
> access_log stdio:/var/log/squid/success.log logformat=squid success
> access_log stdio:/var/log/squid/failure.log logformat=squid failure
> 
> cache deny all
> 
> http_port [::]:3128 ssl-bump generate-host-certificates=on 
> dynamic_cert_mem_cache_size=8MB tls-cert=/etc/squid/myCA.pem 
> tls-key=/etc/squid/myCA1.pem
> strip_query_terms off
> 
> logformat timereadable %tl %6tr %>a %Ss/%03Hs %<st %rm %ru %un %Sh/%<A %mt
> access_log daemon:/var/log/squid/access.log timereadable
> 
> coredump_dir /var/cache/squid
> refresh_pattern ^ftp: ? ? ? ? ? 1440 ? ?20% ? ? 10080
> refresh_pattern -i (/cgi-bin/|\?) 0 ? ? 0% ? ? ?0
> refresh_pattern . ? ? ? ? ? ? ? 0 ? ? ? 20% ? ? 4320
> sslcrtd_program /usr/lib/squid/security_file_certgen -s 
> /var/lib/squid/ssl_db -M 16MB
> sslcrtd_children 5
> ssl_bump server-first all
> sslproxy_cert_error allow all
> -- end of config
> 
> Thank you,
> 
> Dragos
> 
> Sent with Proton Mail <https://proton.me/> secure email.
> 
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> https://lists.squid-cache.org/listinfo/squid-users



From dragosrp at proton.me  Mon Mar  4 21:59:16 2024
From: dragosrp at proton.me (Dragos Pacher)
Date: Mon, 04 Mar 2024 21:59:16 +0000
Subject: [squid-users] Missing IPv6 sockets in Squid 6.7 in some servers
In-Reply-To: <d276b611-deb3-41a4-8d85-4509391103e4@measurement-factory.com>
References: <6OLdiBPAdFLozHPxeeJRbnE04faaC6D1FVJwkCceBklRfEZThhwSflwzLZikXonJF__ViZE1ati_4u0AA_HY3XP5AD6bg-JMjPWv-AuX6is=@proton.me>
 <d276b611-deb3-41a4-8d85-4509391103e4@measurement-factory.com>
Message-ID: <vieEDwMgRhEP5V3bVCHd30hDNi5IK9b4FGwDWz6diq8xx6YIkoLa2esgCSDOtghn8xNiYIrNb81HaLQe0bCRBxFGSLz5i_0NWU1ivG8YI8A=@proton.me>

Thank you Alex,

Indeed something is listening on this port, but it looks to be Squid:
root at A2-3:/# nc -6 -l 3128
nc: Address already in use

root at A2-3:/# lsof -i:3128
COMMAND     PID  USER   FD   TYPE    DEVICE SIZE/OFF NODE NAME
squid   3480423 proxy   25u  IPv4 283726201      0t0  TCP A2-3:3128 (LISTEN)

but the socket is IPV4 only on the problem host:
root at A2-3:/# lsof -a -i4 -i6 -itcp | grep 3128
squid     3480423           proxy   25u  IPv4 283726201      0t0  TCP A2-3:3128 (LISTEN)

compared to a 'healthy' server:
root at A2-2:~# lsof -a -i4 -i6 -itcp | grep 3128
squid      997651           proxy   12u  IPv6 254219302      0t0  TCP A2-2:3128->x.x.x.x:46816 (ESTABLISHED)
squid      997651           proxy   25u  IPv6 241163587      0t0  TCP *:3128 (LISTEN)

As I know a IPV6 socket accepts both v4 and v6 connections but a V4 socket only V4 connections, and this looks to be the symptom. 

This is what I found in the cache.log:
2024/03/04 16:09:28 kid1| With 1000000 file descriptors available
2024/03/04 16:09:28 kid1| Initializing IP Cache...
2024/03/04 16:09:28 kid1| DNS IPv6 socket created at [::], FD 9
2024/03/04 16:09:28 kid1| DNS IPv4 socket created at 0.0.0.0, FD 10

so it looks like it creates the IPv6 socket but it's not working somehow:
root at A2-3:/# telnet ::1 3128
Trying ::1...
telnet: Unable to connect to remote host: Connection refused

Unfortunately nothing else relevant to me in the cache.log, I enabled debugging, to what email can I 
send the archive for you to look at it, please?

Thank you,

Dragos

Sent with Proton Mail secure email.

On Monday, March 4th, 2024 at 9:43 PM, Alex Rousskov <rousskov at measurement-factory.com> wrote:

> On 2024-03-04 14:03, Dragos Pacher wrote:
> 
> > POC running well on 3 servers but on the 4th I get no IPv6
> > sockets:
> > ubuntu at A2-3:/$ sudo netstat -patun | grep squid | grep tcp
> > tcp 0 0 10.10.0.16:3128 0.0.0.0:*
> > LISTEN 2891391/(squid-1)
> 
> 
> Are there any other processes listening on IPv6 addresses on this
> problematic host?
> 
> Does something like "nc -6 -l 3128" listen on an IPv6 address on this
> problematic host?
> 
> If possible, please also check cache.log for messages mentioning IPv6
> and "BCP 177"; I know you shared syslog output, but I am a bit worried
> that syslog might be missing some relevant early debugging messages.
> 
> 
> If nothing helps, consider sharing a pointer to compressed Squid startup
> cache.log after adding "debug_options ALL,2 50,3" to your squid.conf. We
> do not need to see any transactions, just Squid startup steps. Still,
> this log may contain some sensitive details, so share privately if needed.
> 
> 
> Thank you,
> 
> Alex.
> 
> 
> > and on the other 3 I have IPv6:
> > ubuntu at A2-2:/$ sudo netstat -patun | grep squid | grep tcp
> > tcp 0 0 x.x.x.x:52386 x.x.x.x:443 ESTABLISHED
> > 997651/(squid-1)
> > tcp6 0 0 :::3128 :::*
> > LISTEN 997651/(squid-1)
> > tcp6 0 0 10.10.0.12:3128 10.20.0.1:39428
> > ESTABLISHED 997651/(squid-1)
> 
> 
> 
> 
> 
> 
> > This creates a problem for us since the apps I monitor are not starting
> > since their start routine is IPV6 only and then they switch to
> > IPv4/IPV6, but the start is IPV6 alone.
> > 
> > Therefore my questions are as follows:
> > 
> > 1. How can I make it listen on both IPV6/IPV4 like on the other servers?
> > 2. Any configuration improvement suggestions?
> > 
> > Please find all details here:
> > So far I did a POC on 4 servers, here is the full config, nothing
> > sophisticated since this is where my Squid knowledge took me so far.
> > Running Squid 6.7 with some basic options
> > on Ubuntu 22.04 kernel 5.15.0-89-generic x86_64
> > squid -v
> > Squid Cache: Version 6.7
> > Service Name: squid
> > This binary uses OpenSSL 3.0.2 15 Mar 2022. configure options:
> > '--prefix=/usr' '--localstatedir=/var' '--libexecdir=/lib/squid'
> > '--datadir=/share/squid' '--sysconfdir=/etc/squid'
> > '--with-default-user=proxy' '--with-logdir=/var/log/squid'
> > '--enable-ssl-crtd' '--with-openssl'
> > 
> > and here is the syslog of Squid start:
> > Mar 4 16:09:28 A2-3 systemd[1]: Starting Squid Web Proxy Server...
> > Mar 4 16:09:28 A2-3 squid[3094662]: 2024/03/04 16:09:28| Processing
> > Configuration File: /etc/squid/squid.conf (depth 0)
> > Mar 4 16:09:28 A2-3 squid[3094662]: 2024/03/04 16:09:28| WARNING: empty
> > ACL: acl broken_sites ssl::server_name "/etc/squid/ssl_broken_sites.txt"
> > Mar 4 16:09:28 A2-3 squid[3094662]: 2024/03/04 16:09:28| WARNING: The
> > "Hs" formatting code is deprecated. Use the ">Hs" instead.
> > Mar 4 16:09:28 A2-3 squid[3094662]: 2024/03/04 16:09:28| Created PID
> > file (/var/run/squid.pid)
> > Mar 4 16:09:28 A2-3 squid[3094662]: Squid Parent: will start 1 kids
> > Mar 4 16:09:28 A2-3 squid[3094662]: Squid Parent: (squid-1) process
> > 3094665 started
> > Mar 4 16:09:28 A2-3 squid[3094665]: 2024/03/04 16:09:28 kid1|
> > Processing Configuration File: /etc/squid/squid.conf (depth 0)
> > Mar 4 16:09:28 A2-3 squid[3094665]: 2024/03/04 16:09:28 kid1| WARNING:
> > empty ACL: acl broken_sites ssl::server_name
> > "/etc/squid/ssl_broken_sites.txt"
> > Mar 4 16:09:28 A2-3 squid[3094665]: 2024/03/04 16:09:28 kid1| WARNING:
> > The "Hs" formatting code is deprecated. Use the ">Hs" instead.
> > Mar 4 16:09:28 A2-3 squid[3094665]: 2024/03/04 16:09:28 kid1| Set
> > Current Directory to /var/cache/squid
> > Mar 4 16:09:28 A2-3 squid[3094665]: 2024/03/04 16:09:28 kid1| Creating
> > missing swap directories
> > Mar 4 16:09:28 A2-3 squid[3094665]: 2024/03/04 16:09:28 kid1| No
> > cache_dir stores are configured.
> > Mar 4 16:09:28 A2-3 squid[3094662]: Squid Parent: squid-1 process
> > 3094665 exited with status 0
> > Mar 4 16:09:28 A2-3 squid[3094662]: 2024/03/04 16:09:28| Removing PID
> > file (/var/run/squid.pid)
> > Mar 4 16:09:28 A2-3 squid[3094666]: Processing Configuration File:
> > /etc/squid/squid.conf (depth 0)
> > Mar 4 16:09:28 A2-3 squid[3094666]: WARNING: empty ACL: acl
> > broken_sites ssl::server_name "/etc/squid/ssl_broken_sites.txt"
> > Mar 4 16:09:28 A2-3 squid[3094666]: WARNING: The "Hs" formatting code
> > is deprecated. Use the ">Hs" instead.
> > Mar 4 16:09:28 A2-3 squid[3094666]: Created PID file (/var/run/squid.pid)
> > Mar 4 16:09:28 A2-3 squid[3094666]: Squid Parent: will start 1 kids
> > Mar 4 16:09:28 A2-3 squid[3094666]: Squid Parent: (squid-1) process
> > 3094668 started
> > Mar 4 16:09:28 A2-3 squid[3094668]: Processing Configuration File:
> > /etc/squid/squid.conf (depth 0)
> > Mar 4 16:09:28 A2-3 squid[3094668]: WARNING: empty ACL: acl
> > broken_sites ssl::server_name "/etc/squid/ssl_broken_sites.txt"
> > Mar 4 16:09:28 A2-3 squid[3094668]: WARNING: The "Hs" formatting code
> > is deprecated. Use the ">Hs" instead.
> > Mar 4 16:09:28 A2-3 squid[3094668]: Set Current Directory to
> > /var/cache/squid
> > Mar 4 16:09:28 A2-3 squid[3094668]: Starting Squid Cache version 6.7
> > for x86_64-pc-linux-gnu...
> > Mar 4 16:09:28 A2-3 squid[3094668]: Service Name: squid
> > Mar 4 16:09:28 A2-3 squid[3094668]: Process ID 3094668
> > Mar 4 16:09:28 A2-3 squid[3094668]: Process Roles: worker
> > Mar 4 16:09:28 A2-3 squid[3094668]: With 1000000 file descriptors available
> > Mar 4 16:09:28 A2-3 squid[3094668]: Initializing IP Cache...
> > Mar 4 16:09:28 A2-3 squid[3094668]: DNS IPv6 socket created at [::], FD 9
> > Mar 4 16:09:28 A2-3 squid[3094668]: DNS IPv4 socket created at 0.0.0.0,
> > FD 10
> > Mar 4 16:09:28 A2-3 squid[3094668]: Adding nameserver 127.0.0.53 from
> > /etc/resolv.conf
> > Mar 4 16:09:28 A2-3 squid[3094668]: Adding domain . from /etc/resolv.conf
> > Mar 4 16:09:28 A2-3 squid[3094668]: helperOpenServers: Starting 5/5
> > 'security_file_certgen' processes
> > Mar 4 16:09:28 A2-3 squid[3094668]: Logfile: opening log
> > stdio:/var/log/squid/success.log
> > Mar 4 16:09:28 A2-3 squid[3094668]: Logfile: opening log
> > stdio:/var/log/squid/failure.log
> > Mar 4 16:09:28 A2-3 squid[3094668]: Logfile: opening log
> > daemon:/var/log/squid/access.log
> > Mar 4 16:09:28 A2-3 squid[3094668]: Logfile Daemon: opening log
> > /var/log/squid/access.log
> > Mar 4 16:09:28 A2-3 squid[3094668]: Store logging disabled
> > Mar 4 16:09:28 A2-3 squid[3094668]: Swap maxSize 0 + 262144 KB,
> > estimated 20164 objects
> > Mar 4 16:09:28 A2-3 squid[3094668]: Target number of buckets: 1008
> > Mar 4 16:09:28 A2-3 squid[3094668]: Using 8192 Store buckets
> > Mar 4 16:09:28 A2-3 squid[3094668]: Max Mem size: 262144 KB
> > Mar 4 16:09:28 A2-3 squid[3094668]: Max Swap size: 0 KB
> > Mar 4 16:09:28 A2-3 squid[3094668]: Using Least Load store dir selection
> > Mar 4 16:09:28 A2-3 squid[3094668]: Set Current Directory to
> > /var/cache/squid
> > Mar 4 16:09:28 A2-3 squid[3094668]: Finished loading MIME types and icons.
> > Mar 4 16:09:28 A2-3 squid[3094668]: HTCP Disabled.
> > Mar 4 16:09:28 A2-3 squid[3094668]: Squid plugin modules loaded: 0
> > Mar 4 16:09:28 A2-3 squid[3094668]: Adaptation support is off.
> > Mar 4 16:09:28 A2-3 squid[3094668]: Accepting SSL bumped HTTP Socket
> > connections at conn13 local=10.10.0.16:3128 remote=[::] FD 25
> > flags=9#012 listening port: 10.10.0.16:3128
> > Mar 4 16:09:28 A2-3 systemd[1]: Started Squid Web Proxy Server.
> > Mar 4 16:09:29 A2-3 squid[3094668]: storeLateRelease: released 0 objects
> > 
> > -- full config --
> > acl SSL_ports port 443
> > acl SSL_ports port 443
> > http_access allow localhost
> > http_access allow localnet
> > http_access allow all
> > 
> > acl step1 at_step SslBump1
> > acl step2 at_step SslBump2
> > acl step3 at_step SslBump3
> > 
> > acl broken_sites ssl::server_name "/etc/squid/ssl_broken_sites.txt"
> > http_upgrade_request_protocols websocket allow all
> > 
> > ssl_bump peek step1 all
> > ssl_bump splice broken_sites
> > ssl_bump stare step2 all
> > ssl_bump bump step3 all
> > 
> > acl CONNECT method CONNECT
> > acl success_hier hier_code HIER_DIRECT
> > acl failure_hier hier_code HIER_NONE
> > acl failure all-of CONNECT failure_hier
> > acl failure all-of !CONNECT failure_codes
> > acl success all-of CONNECT success_hier
> > acl success all-of !CONNECT success_codes
> > 
> > access_log stdio:/var/log/squid/success.log logformat=squid success
> > access_log stdio:/var/log/squid/failure.log logformat=squid failure
> > 
> > cache deny all
> > 
> > http_port [::]:3128 ssl-bump generate-host-certificates=on
> > dynamic_cert_mem_cache_size=8MB tls-cert=/etc/squid/myCA.pem
> > tls-key=/etc/squid/myCA1.pem
> > strip_query_terms off
> > 
> > logformat timereadable %tl %6tr %>a %Ss/%03Hs %<st %rm %ru %un %Sh/%<A %mt
> > access_log daemon:/var/log/squid/access.log timereadable
> > 
> > coredump_dir /var/cache/squid
> > refresh_pattern ^ftp: 1440 20% 10080
> > refresh_pattern -i (/cgi-bin/|\?) 0 0% 0
> > refresh_pattern . 0 20% 4320
> > sslcrtd_program /usr/lib/squid/security_file_certgen -s
> > /var/lib/squid/ssl_db -M 16MB
> > sslcrtd_children 5
> > ssl_bump server-first all
> > sslproxy_cert_error allow all
> > -- end of config
> > 
> > Thank you,
> > 
> > Dragos
> > 
> > Sent with Proton Mail https://proton.me/ secure email.
> > 
> > _______________________________________________
> > squid-users mailing list
> > squid-users at lists.squid-cache.org
> > https://lists.squid-cache.org/listinfo/squid-users
> 
> 
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> https://lists.squid-cache.org/listinfo/squid-users


From squid3 at treenet.co.nz  Tue Mar  5 03:40:50 2024
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Tue, 5 Mar 2024 16:40:50 +1300
Subject: [squid-users] Missing IPv6 sockets in Squid 6.7 in some servers
In-Reply-To: <6OLdiBPAdFLozHPxeeJRbnE04faaC6D1FVJwkCceBklRfEZThhwSflwzLZikXonJF__ViZE1ati_4u0AA_HY3XP5AD6bg-JMjPWv-AuX6is=@proton.me>
References: <6OLdiBPAdFLozHPxeeJRbnE04faaC6D1FVJwkCceBklRfEZThhwSflwzLZikXonJF__ViZE1ati_4u0AA_HY3XP5AD6bg-JMjPWv-AuX6is=@proton.me>
Message-ID: <7c07f1f6-dda2-4278-8e74-ab2ee5ded45a@treenet.co.nz>

On 5/03/24 08:03, Dragos Pacher wrote:
> Hello,
> 
> I am a Squid beginner and we would like to use Squid inside our 
> organization only as a HTTPS traffic inspection/logging tool for some 
> 3rd party apps that we bought,
> something close to what a "MITM proxy" is called but we will not do 
> that, instead we use a self signed certificate and the 3rd party app 
> owners know this. Everything is
> 100% completely legal. (Ps: I am the IT lead).
> 

FYI: "MITM proxy" is a ridiculous term. "MITM" means "intermediary" in 
security terminology, "proxy" means "intermediary" in networking 
terminology.
  So that term just means "intermediary intermediary", yeah.



Any serious HTTPS inspection/logging by Squid needs some form of 
SSL-Bump configuration and those 3rd-party Apps MUST be configured with 
trust for the self-signed root CA you are using.


Without that nothing Squid (or any other proxy) does will allow traffic 
inspection beyond the initial TLS handshake.



Assuming that you have checked that detail, on to your issue ...


> We will be using Squid only internally, no outside access. Here is my 
> issue with the current knowledge of Squid: POC running well on 3 servers 
> but on the 4th I get no IPv6
> sockets:
> ubuntu at A2-3:/$ sudo netstat -patun | grep squid | grep tcp
> tcp ? ? ? ?0 ? ? ?0 10.10.0.16:3128 ? ? ? ? 0.0.0.0:*               
> LISTEN ? ? ?2891391/(squid-1)


Your problem is the https(s)_port "port" configuration parameter.


This Squid is configured to listen like:

   http_port 10.10.0.16:3128

or

   http_port example.com:3128

(when example.com has only address 10.10.0.16)


The "http_port" receives port 80 syntax traffic, it may also be
"https_port" which receives port 443 syntax traffic.


> 
> and on the other 3 I have IPv6:
> ubuntu at A2-2:/$ sudo netstat -patun | grep squid | grep tcp
> tcp ? ? ? ?0 ? ? ?0 x.x.x.x:52386 ?? x.x.x.x:443 ? ? ESTABLISHED 
> 997651/(squid-1)
> tcp6 ? ? ? 0 ? ? ?0 :::3128 ? ? ? ? ? ? ? ? :::*                   
>  ?LISTEN ? ? ?997651/(squid-1)


These Squid are configured to listen like:

  http_port 3128


Ensure that the machine/server the 4th Squid is running on has its 
http(s)_port line matching the other three machines port value.

At this point do not care about the "mode" or options later in the line. 
Your issue is solely the "port" parameter.


Cheers
Amos


From squid3 at treenet.co.nz  Tue Mar  5 03:59:52 2024
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Tue, 05 Mar 2024 03:59:52 -0000
Subject: [squid-users] [squid-announce] [ADVISORY] SQUID-2023:10 Denial of
 Service in HTTP Request parsing
Message-ID: <f3c5fe43-a2a9-441c-a4de-f6a13b7270de@treenet.co.nz>

__________________________________________________________________

   Squid Proxy Cache Security Update Advisory SQUID-2023:10
__________________________________________________________________

Advisory ID:       | SQUID-2023:10
Date:              | Dec 10, 2023
Summary:           | Denial of Service in HTTP Request parsing
Affected versions: | Squid 2.6 -> 2.7.STABLE9
                    | Squid 3.1 -> 3.5.28
                    | Squid 4.x -> 4.17
                    | Squid 5.x -> 5.9
                    | Squid 6.x -> 6.5
Fixed in version:  | Squid 6.6
__________________________________________________________________

Problem Description:

  Due to an Uncontrolled Recursion bug, Squid may be vulnerable to a
  Denial of Service attack against HTTP Request parsing.

__________________________________________________________________

Severity:

This problem allows a remote client to perform Denial of Service attack
by sending a large X-Forwarded-For header when the
follow_x_forwarded_for feature is configured.

__________________________________________________________________

Updated Packages:

     This bug is fixed by Squid version 6.6.

  In addition, patches addressing this problem for the stable
  releases can be found in our patch archives:

Squid 5:
  <http://www.squid-cache.org/Versions/v5/SQUID-2023_10.patch>

Squid 6:
  <http://www.squid-cache.org/Versions/v6/SQUID-2023_10.patch>

  If you are using a prepackaged version of Squid then please refer
  to the package vendor for availability information on updated
  packages.

__________________________________________________________________

Determining if your version is vulnerable:

  To check for follow_x_forwarded_for run the following command:

   `squid -k parse 2>&1 |grep follow_x_forwarded_for`


  All Squid configured without follow_x_forwarded_for are not
  vulnerable.

  All Squid older than 5.0.5 have not been tested and should be
  assumed to be vulnerable when configured with
  follow_x_forwarded_for.

  All Squid-5.x up to and including 5.9 are vulnerable when
  configured with follow_x_forwarded_for.

  All Squid-6.x up to and including 6.5 are vulnerable when
  configured with follow_x_forwarded_for.

__________________________________________________________________

Workaround:

  Remove all follow_x_forwarded_for lines from squid.conf

__________________________________________________________________

Contact details for the Squid project:

  For installation / upgrade support on binary packaged versions
  of Squid: Your first point of contact should be your binary
  package vendor.

  If you install and build Squid from the original Squid sources
  then the <squid-users at lists.squid-cache.org> mailing list is your
  primary support point. For subscription details see
  <http://www.squid-cache.org/Support/mailing-lists.html>.

  For reporting of non-security bugs in the latest STABLE release
  the squid bugzilla database should be used
  <https://bugs.squid-cache.org/>.

  For reporting of security sensitive bugs send an email to the
  <squid-bugs at lists.squid-cache.org> mailing list. It's a closed
  list (though anyone can post) and security related bug reports
  are treated in confidence until the impact has been established.

__________________________________________________________________

Credits:

  This vulnerability was discovered by Joshua Rogers of Opera
  Software.

  Fixed by Thomas Leroy of the SUSE security team.

__________________________________________________________________

Revision history:

  2023-10-12 11:53:02 UTC Initial Report
  2023-11-28 07:35:46 UTC Patches Released
__________________________________________________________________
END
_______________________________________________
squid-announce mailing list
squid-announce at lists.squid-cache.org
https://lists.squid-cache.org/listinfo/squid-announce


From squid3 at treenet.co.nz  Tue Mar  5 03:59:55 2024
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Tue, 05 Mar 2024 03:59:55 -0000
Subject: [squid-users] [squid-announce] [ADVISORY] SQUID-2023:11 Denial of
 Service in Cache Manager
Message-ID: <5d0162d5-c1b9-4cd0-ae86-2ebe4aeae074@treenet.co.nz>

__________________________________________________________________

   Squid Proxy Cache Security Update Advisory SQUID-2023:11
__________________________________________________________________

Advisory ID:       | SQUID-2023:11
Date:              | Jan 24, 2024
Summary:           | Denial of Service in Cache Manager
Affected versions: | Squid 2.x -> 2.7.STABLE9
                    | Squid 3.x -> 3.5.28
                    | Squid 4.x -> 4.17
                    | Squid 5.x -> 5.9
                    | Squid 6.x -> 6.5
Fixed in version:  | Squid 6.6
__________________________________________________________________

Problem Description:

  Due to a hanging pointer reference bug Squid is vulnerable to a
  Denial of Service attack against Cache Manager error responses.

__________________________________________________________________

Severity:

  This problem allows a trusted client to perform Denial of Service
  when generating error pages for Client Manager reports.

__________________________________________________________________

Updated Packages:

   This bug is fixed by Squid version 6.6.

  In addition, patches addressing this problem for the stable
  releases can be found in our patch archives:

Squid 5:
  <http://www.squid-cache.org/Versions/v5/SQUID-2023_11.patch>

Squid 6:
  <http://www.squid-cache.org/Versions/v6/SQUID-2023_11.patch>

  If you are using a prepackaged version of Squid then please refer
  to the package vendor for availability information on updated
  packages.

__________________________________________________________________

Determining if your version is vulnerable:

  Squid older than 5.0.5 have not been tested and should be assumed
  to be vulnerable.

  All Squid-5.x up to and including 5.9 are vulnerable.

  All Squid-6.x up to and including 6.5 are vulnerable.

__________________________________________________________________

Workaround:

  Prevent access to Cache Manager using Squid's main access
  control:

   http_access deny manager

__________________________________________________________________

Contact details for the Squid project:

  For installation / upgrade support on binary packaged versions
  of Squid: Your first point of contact should be your binary
  package vendor.

  If you install and build Squid from the original Squid sources
  then the <squid-users at lists.squid-cache.org> mailing list is your
  primary support point. For subscription details see
  <http://www.squid-cache.org/Support/mailing-lists.html>.

  For reporting of non-security bugs in the latest STABLE release
  the squid bugzilla database should be used
  <https://bugs.squid-cache.org/>.

  For reporting of security sensitive bugs send an email to the
  <squid-bugs at lists.squid-cache.org> mailing list. It's a closed
  list (though anyone can post) and security related bug reports
  are treated in confidence until the impact has been established.

__________________________________________________________________

Credits:

  This vulnerability was discovered by Joshua Rogers of Opera
  Software.

  Fixed by The Measurement Factory.

__________________________________________________________________

Revision history:

  2023-10-12 11:53:02 UTC Initial Report
  2023-11-12 09:33:20 UTC Patches Released
__________________________________________________________________
END
_______________________________________________
squid-announce mailing list
squid-announce at lists.squid-cache.org
https://lists.squid-cache.org/listinfo/squid-announce


From squid3 at treenet.co.nz  Tue Mar  5 03:59:58 2024
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Tue, 05 Mar 2024 03:59:58 -0000
Subject: [squid-users] [squid-announce] [ADVISORY] SQUID-2024:2 Denial of
 Service in HTTP Header parser
Message-ID: <9304a062-e4dd-465f-bb39-3f35f028e3b2@treenet.co.nz>

__________________________________________________________________

     Squid Proxy Cache Security Update Advisory SQUID-2024:2
__________________________________________________________________

Advisory ID:       | SQUID-2024:2
Date:              | Feb 15, 2024
Summary:           | Denial of Service in HTTP Header parser
Affected versions: | Squid 3.x -> 3.5.28
                    | Squid 4.x -> 4.17
                    | Squid 5.x -> 5.9
                    | Squid 6.x -> 6.4
Fixed in version:  | Squid 6.5
__________________________________________________________________

Problem Description:

  Due to a Collapse of Data into Unsafe Value bug,
  Squid may be vulnerable to a Denial of Service
  attack against HTTP header parsing.

__________________________________________________________________

Severity:

  This problem allows a remote client or a remote server to
  perform Denial of Service when sending oversized headers in
  HTTP messages.

  In versions of Squid prior to 6.5 this can be achieved if the
  request_header_max_size or reply_header_max_size settings are
  unchanged from the default.

  In Squid version 6.5 and later, the default setting of these
  parameters is safe. Squid will emit a critical warning in
  cache.log if the administrator is setting these parameters to
  unsafe values. Squid will not at this time prevent these settings
  from being changed to unsafe values.

__________________________________________________________________

Updated Packages:

Hardening against this issue is added to Squid version 6.5.

  In addition, patches addressing this problem for the stable
  releases can be found in our patch archives:

Squid 6:
  <http://www.squid-cache.org/Versions/v6/SQUID-2024_2.patch>

  If you are using a prepackaged version of Squid then please refer
  to the package vendor for availability information on updated
  packages.

__________________________________________________________________

Determining if your version is vulnerable:

  Run the following command to identify how (and whether)
  your Squid has been configured with relevant settings:

     squid -k parse 2>&1 | grep header_max_size

  All Squid-3.0 up to and including 6.4 without header_max_size
  settings are vulnerable.

  All Squid-3.0 up to and including 6.4 with either header_max_size
  setting over 21 KB are vulnerable.

  All Squid-3.0 up to and including 6.4 with both header_max_size
  settings below 21 KB are not vulnerable.

  All Squid-6.5 and later without header_max_size configured
  are not vulnerable.

  All Squid-6.5 and later configured with both header_max_size
  settings below 64 KB are not vulnerable.

  All Squid-6.5 and later configured with either header_max_size
  setting over 64 KB are vulnerable.

__________________________________________________________________

Workaround:

For Squid older than 6.5, add to squid.conf:

   request_header_max_size 21 KB
   reply_header_max_size 21 KB


For Squid 6.5 and later, remove request_header_max_size
  and reply_header_max_size from squid.conf

__________________________________________________________________

Contact details for the Squid project:

  For installation / upgrade support on binary packaged versions
  of Squid: Your first point of contact should be your binary
  package vendor.

  If you install and build Squid from the original Squid sources
  then the <squid-users at lists.squid-cache.org> mailing list is your
  primary support point. For subscription details see
  <http://www.squid-cache.org/Support/mailing-lists.html>.

  For reporting of non-security bugs in the latest STABLE release
  the squid bugzilla database should be used
  <https://bugs.squid-cache.org/>.

  For reporting of security sensitive bugs send an email to the
  <squid-bugs at lists.squid-cache.org> mailing list. It's a closed
  list (though anyone can post) and security related bug reports
  are treated in confidence until the impact has been established.

__________________________________________________________________

Credits:

  This vulnerability was discovered by Joshua Rogers of Opera
  Software.

  Fixed by The Measurement Factory.

__________________________________________________________________

Revision history:

  2023-10-12 11:53:02 UTC Initial Report
  2023-10-25 11:47:19 UTC Patches Released
__________________________________________________________________
END
_______________________________________________
squid-announce mailing list
squid-announce at lists.squid-cache.org
https://lists.squid-cache.org/listinfo/squid-announce


From squid3 at treenet.co.nz  Tue Mar  5 03:49:09 2024
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Tue, 5 Mar 2024 16:49:09 +1300
Subject: [squid-users] [squid-announce] [ADVISORY] SQUID-2024:1 Denial of
 Service in HTTP Chunked Decoding
Message-ID: <773fe262-4ad3-4317-b560-78af78f9106a@treenet.co.nz>

__________________________________________________________________

     Squid Proxy Cache Security Update Advisory SQUID-2024:1
__________________________________________________________________

Advisory ID:       | SQUID-2024:1
Date:              | Mar 4, 2024
Summary:           | Denial of Service in HTTP Chunked Decoding
Affected versions: | Squid 3.5.27 -> 3.5.28
                    | Squid 4.x -> 4.17
                    | Squid 5.x -> 5.9
                    | Squid 6.x -> 6.7
Fixed in version:  | Squid 6.8
__________________________________________________________________

Problem Description:

  Due to an Uncontrolled Recursion bug, Squid may be vulnerable to
  a Denial of Service attack against HTTP Chunked decoder.

__________________________________________________________________

Severity:

  This problem allows a remote attacker to perform Denial of
  Service when sending a crafted chunked encoded HTTP Message.

__________________________________________________________________

Updated Packages:

     This bug is fixed by Squid version 6.8.

  In addition, patches addressing this problem for the stable
  releases can be found in our patch archives:

Squid 6:
  <http://www.squid-cache.org/Versions/v6/SQUID-2024_1.patch>

  If you are using a prepackaged version of Squid then please refer
  to the package vendor for availability information on updated
  packages.

__________________________________________________________________

Determining if your version is vulnerable:

  Squid older than 3.5.27 are not vulnerable.

  All Squid 3.5.27 to 4.17 have not been tested and should be
  assumed to be vulnerable.

  All Squid-5.x up to and including 5.9 are vulnerable.

  All Squid-6.x up to and including 6.7 are vulnerable.

__________________________________________________________________

Workaround:

   **There is no workaround for this issue**
__________________________________________________________________

Contact details for the Squid project:

  For installation / upgrade support on binary packaged versions
  of Squid: your first point of contact should be your binary
  package vendor.

  If you install and build Squid from the original Squid sources
  then the <squid-users at lists.squid-cache.org> mailing list is your
  primary support point. For subscription details see
  <http://www.squid-cache.org/Support/mailing-lists.html>.

  For reporting of non-security bugs in the latest STABLE release
  the squid bugzilla database should be used
  <https://bugs.squid-cache.org/>.

  For reporting of security sensitive bugs send an email to the
  <squid-bugs at lists.squid-cache.org> mailing list. It's a closed
  list (though anyone can post) and security related bug reports
  are treated in confidence until the impact has been established.

__________________________________________________________________

Credits:

  This vulnerability was discovered by Joshua Rogers of Opera
  Software.

  Fixed by The Measurement Factory.

__________________________________________________________________

Revision history:

  2023-10-12 11:53:02 UTC Initial Report
  2023-10-31 11:35:02 UTC Patches Released
  2024-03-04 06:27:00 UTC Fixed Version Released
__________________________________________________________________
END
_______________________________________________
squid-announce mailing list
squid-announce at lists.squid-cache.org
https://lists.squid-cache.org/listinfo/squid-announce


From nuit123 at earthlink.net  Tue Mar  5 09:53:42 2024
From: nuit123 at earthlink.net (nuit123 at earthlink.net)
Date: Tue, 5 Mar 2024 01:53:42 -0800
Subject: [squid-users] Squid stops responding after 12 browser tabs opened
Message-ID: <000701da6ee3$0237e4e0$06a7aea0$@earthlink.net>

Squid 4.17 compiled on Debian 11

Squid works, but, after 12 to 17 browser tabs are opened to any web site,
subsequent tabs fail to load web site content. At the same time, telnet:80
through Squid also fails. Yet, network traffic that bypasses Squid
successfully communicates with the target web site.

Ultimately, after about two minutes, unresponsive browser tabs usually
finish loading web site content.

Adjusting cache_mem makes no difference.

This is remarked:
#cache_dir ufs /var/spool/squid 100 16 256
Tried to enable it, but squid -z fails with permission issues, so keeping
cache_dir enabled breaks squid entirely.

Any thoughts, please?

With apologies if this violates etiquette (hey, I did
--enable-http-violations!), this Squid server is taking on greater
importance, and while it's infinitely fascinating, I recognize my limits, so
I'm open to experienced help managing and maintaining it, and probably
building a newer version. :-)

Thanks!




From dragosrp at proton.me  Tue Mar  5 09:59:21 2024
From: dragosrp at proton.me (Dragos Pacher)
Date: Tue, 05 Mar 2024 09:59:21 +0000
Subject: [squid-users] Missing IPv6 sockets in Squid 6.7 in some servers
In-Reply-To: <7c07f1f6-dda2-4278-8e74-ab2ee5ded45a@treenet.co.nz>
References: <6OLdiBPAdFLozHPxeeJRbnE04faaC6D1FVJwkCceBklRfEZThhwSflwzLZikXonJF__ViZE1ati_4u0AA_HY3XP5AD6bg-JMjPWv-AuX6is=@proton.me>
 <7c07f1f6-dda2-4278-8e74-ab2ee5ded45a@treenet.co.nz>
Message-ID: <GX4Z3rDI1Bna5dIQ1kgiD2nbUEKQw7Kr9X5LKimFiBbfZ5yNKTGS1EnYAalAc-uL--BdS2cw69DBjC5A5OHqYdndMK1H7AzBlYRwPAlsm6o=@proton.me>

Please see my replies in between the lines below.

On Tuesday, March 5th, 2024 at 5:40 AM, Amos Jeffries <squid3 at treenet.co.nz> wrote:

> On 5/03/24 08:03, Dragos Pacher wrote:
> 
> > Hello,
> > 
> > I am a Squid beginner and we would like to use Squid inside our
> > organization only as a HTTPS traffic inspection/logging tool for some
> > 3rd party apps that we bought,
> > something close to what a "MITM proxy" is called but we will not do
> > that, instead we use a self signed certificate and the 3rd party app
> > owners know this. Everything is
> > 100% completely legal. (Ps: I am the IT lead).
> 
> 
> FYI: "MITM proxy" is a ridiculous term. "MITM" means "intermediary" in
> security terminology, "proxy" means "intermediary" in networking
> terminology.
> So that term just means "intermediary intermediary", yeah.
> 

I did not coined this term, I was referring to this: https://mitmproxy.org,
I guess it entered IT popular culture somehow..

> 
> 
> Any serious HTTPS inspection/logging by Squid needs some form of
> SSL-Bump configuration and those 3rd-party Apps MUST be configured with
> trust for the self-signed root CA you are using.
> 
> 
> Without that nothing Squid (or any other proxy) does will allow traffic
> inspection beyond the initial TLS handshake.
> 

I specified in my first email I did this already, maybe I was not so clear but
my self-signed certificate is working with the 3rd party apps.

> 
> 
> Assuming that you have checked that detail, on to your issue ...
> 
> > We will be using Squid only internally, no outside access. Here is my
> > issue with the current knowledge of Squid: POC running well on 3 servers
> > but on the 4th I get no IPv6
> > sockets:
> > ubuntu at A2-3:/$ sudo netstat -patun | grep squid | grep tcp
> > tcp 0 0 10.10.0.16:3128 0.0.0.0:*
> > LISTEN 2891391/(squid-1)
> 
> 
> 
> Your problem is the https(s)_port "port" configuration parameter.
> 
> 
> This Squid is configured to listen like:
> 
> http_port 10.10.0.16:3128
> 
> or
> 
> http_port example.com:3128
> 
> (when example.com has only address 10.10.0.16)
> 
> 
> The "http_port" receives port 80 syntax traffic, it may also be
> "https_port" which receives port 443 syntax traffic.
> 
> > and on the other 3 I have IPv6:
> > ubuntu at A2-2:/$ sudo netstat -patun | grep squid | grep tcp
> > tcp 0 0 x.x.x.x:52386 x.x.x.x:443 ESTABLISHED
> > 997651/(squid-1)
> > tcp6 0 0 :::3128 :::*
> > LISTEN 997651/(squid-1)
> 
> 
> 
> These Squid are configured to listen like:
> 
> http_port 3128
> 
> 
> Ensure that the machine/server the 4th Squid is running on has its
> http(s)_port line matching the other three machines port value.
> 
> At this point do not care about the "mode" or options later in the line.
> Your issue is solely the "port" parameter.
> 

So far it seems I was missing [::] in my http_port in the problem server, because of automatic deployment
something went wrong and I assumed my Squid configuration is all the same all over the place. I fixed this but the issue is still there,
please see: this is inside a docker container on a healthy server:
# netstat -patun
Active Internet connections (servers and established)
Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name
tcp        0      0 127.0.0.11:41421        0.0.0.0:*               LISTEN      1574/dockerd
tcp        0      1 172.18.0.10:46950       10.10.0.16:3128         SYN_SENT    307601/node
udp        0      0 127.0.0.11:57486        0.0.0.0:*                           1574/dockerd

and same netstat on the unhealthy server, still inside docker:

Active Internet connections (servers and established)
Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name
tcp        0      0 127.0.0.11:38339        0.0.0.0:*               LISTEN      273025/dockerd
tcp        0      0 172.18.0.4:50666        10.10.0.11:3128         ESTABLISHED 494253/node
tcp6       0      0 :::8080                 :::*                    LISTEN      494253/node
tcp6       0      0 127.0.0.1:8080          127.0.0.1:46168         TIME_WAIT   -
tcp6       0      0 127.0.0.1:8080          127.0.0.1:44480         TIME_WAIT   -
udp        0      0 127.0.0.11:56639        0.0.0.0:*                           273025/dockerd

and a tcpdump from the docker bridge interface, 172.18.0.10 is my issue container with the SYN sent only

root at A2-3:~# tcpdump -i br-7b47c165c9ba dst port 3128 -vvv
tcpdump: listening on br-7b47c165c9ba, link-type EN10MB (Ethernet), snapshot length 262144 bytes
09:55:53.436758 IP (tos 0x0, ttl 64, id 48752, offset 0, flags [DF], proto TCP (6), length 60)
    172.18.0.10.59056 > A2-3.3128: Flags [S], cksum 0xb661 (incorrect -> 0x0dd4), seq 2115452268, win 65535, options [mss 1460,sackOK,TS val 1708093369 ecr 0,nop,wscale 11], length 0
09:56:20.845804 IP (tos 0x0, ttl 64, id 40649, offset 0, flags [DF], proto TCP (6), length 60)
    172.18.0.10.56272 > A2-3.3128: Flags [S], cksum 0xb661 (incorrect -> 0x48f3), seq 2480704598, win 65535, options [mss 1460,sackOK,TS val 1708120778 ecr 0,nop,wscale 11], length 0
09:56:21.852827 IP (tos 0x0, ttl 64, id 40650, offset 0, flags [DF], proto TCP (6), length 60)
    172.18.0.10.56272 > A2-3.3128: Flags [S], cksum 0xb661 (incorrect -> 0x4504), seq 2480704598, win 65535, options [mss 1460,sackOK,TS val 1708121785 ecr 0,nop,wscale 11], length 0
09:56:23.868762 IP (tos 0x0, ttl 64, id 40651, offset 0, flags [DF], proto TCP (6), length 60)
    172.18.0.10.56272 > A2-3.3128: Flags [S], cksum 0xb661 (incorrect -> 0x3d24), seq 2480704598, win 65535, options [mss 1460,sackOK,TS val 1708123801 ecr 0,nop,wscale 11], length 0
09:56:27.996768 IP (tos 0x0, ttl 64, id 40652, offset 0, flags [DF], proto TCP (6), length 60)
    172.18.0.10.56272 > A2-3.3128: Flags [S], cksum 0xb661 (incorrect -> 0x2d04), seq 2480704598, win 65535, options [mss 1460,sackOK,TS val 1708127929 ecr 0,nop,wscale 11], length 0
09:56:36.188758 IP (tos 0x0, ttl 64, id 40653, offset 0, flags [DF], proto TCP (6), length 60)
    172.18.0.10.56272 > A2-3.3128: Flags [S], cksum 0xb661 (incorrect -> 0x0d04), seq 2480704598, win 65535, options [mss 1460,sackOK,TS val 1708136121 ecr 0,nop,wscale 11], length 0
09:56:52.316463 IP (tos 0x0, ttl 64, id 40654, offset 0, flags [DF], proto TCP (6), length 60)
    172.18.0.10.56272 > A2-3.3128: Flags [S], cksum 0xb661 (incorrect -> 0xce03), seq 2480704598, win 65535, options [mss 1460,sackOK,TS val 1708152249 ecr 0,nop,wscale 11], length 0

7 packets captured
7 packets received by filter


Why the SYN sent only state? Any ideas?

Thank you,

Dragos

> 
> Cheers
> Amos
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> https://lists.squid-cache.org/listinfo/squid-users


From gkinkie at gmail.com  Tue Mar  5 10:00:56 2024
From: gkinkie at gmail.com (Francesco Chemolli)
Date: Tue, 5 Mar 2024 17:00:56 +0700
Subject: [squid-users] Squid stops responding after 12 browser tabs
 opened
In-Reply-To: <000701da6ee3$0237e4e0$06a7aea0$@earthlink.net>
References: <000701da6ee3$0237e4e0$06a7aea0$@earthlink.net>
Message-ID: <CA+Y8hcMq1GbadnQPmsGBpq+Brhs-GxZCVwJZhW=af_Q5fWST0A@mail.gmail.com>

Have you tried checking the number and status of open TCP connections
within squid?
You can check it by running netstat (as root) on either box, or by checking
with cache manager, if it's enabled and responding

On Tue, Mar 5, 2024 at 4:53?PM <nuit123 at earthlink.net> wrote:

> Squid 4.17 compiled on Debian 11
>
> Squid works, but, after 12 to 17 browser tabs are opened to any web site,
> subsequent tabs fail to load web site content. At the same time, telnet:80
> through Squid also fails. Yet, network traffic that bypasses Squid
> successfully communicates with the target web site.
>
> Ultimately, after about two minutes, unresponsive browser tabs usually
> finish loading web site content.
>
> Adjusting cache_mem makes no difference.
>
> This is remarked:
> #cache_dir ufs /var/spool/squid 100 16 256
> Tried to enable it, but squid -z fails with permission issues, so keeping
> cache_dir enabled breaks squid entirely.
>
> Any thoughts, please?
>
> With apologies if this violates etiquette (hey, I did
> --enable-http-violations!), this Squid server is taking on greater
> importance, and while it's infinitely fascinating, I recognize my limits,
> so
> I'm open to experienced help managing and maintaining it, and probably
> building a newer version. :-)
>
> Thanks!
>
>
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> https://lists.squid-cache.org/listinfo/squid-users
>


-- 
    Francesco
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20240305/bbea4cd1/attachment.htm>

From dragosrp at proton.me  Tue Mar  5 12:22:52 2024
From: dragosrp at proton.me (Dragos Pacher)
Date: Tue, 05 Mar 2024 12:22:52 +0000
Subject: [squid-users] Missing IPv6 sockets in Squid 6.7 in some servers
In-Reply-To: <GX4Z3rDI1Bna5dIQ1kgiD2nbUEKQw7Kr9X5LKimFiBbfZ5yNKTGS1EnYAalAc-uL--BdS2cw69DBjC5A5OHqYdndMK1H7AzBlYRwPAlsm6o=@proton.me>
References: <6OLdiBPAdFLozHPxeeJRbnE04faaC6D1FVJwkCceBklRfEZThhwSflwzLZikXonJF__ViZE1ati_4u0AA_HY3XP5AD6bg-JMjPWv-AuX6is=@proton.me>
 <7c07f1f6-dda2-4278-8e74-ab2ee5ded45a@treenet.co.nz>
 <GX4Z3rDI1Bna5dIQ1kgiD2nbUEKQw7Kr9X5LKimFiBbfZ5yNKTGS1EnYAalAc-uL--BdS2cw69DBjC5A5OHqYdndMK1H7AzBlYRwPAlsm6o=@proton.me>
Message-ID: <7m1_Xrm6WA3f7jnlMmszKwoDSF3ML9fe6CysaaCHl_Ze_swxF9waTM0vx14kjimVrmva1xgGW_T_lo537dqpclfA1JLpQ3olMoEblJtqhwY=@proton.me>

So far it seems there are some issues with my docker networks on the host, thank you for your help, I will come later if this will not be the case.

Kind regards,

Dragos

On Tuesday, March 5th, 2024 at 11:59 AM, Dragos Pacher <dragosrp at proton.me> wrote:

> Please see my replies in between the lines below.
> 
> On Tuesday, March 5th, 2024 at 5:40 AM, Amos Jeffries squid3 at treenet.co.nz wrote:
> 
> > On 5/03/24 08:03, Dragos Pacher wrote:
> > 
> > > Hello,
> > > 
> > > I am a Squid beginner and we would like to use Squid inside our
> > > organization only as a HTTPS traffic inspection/logging tool for some
> > > 3rd party apps that we bought,
> > > something close to what a "MITM proxy" is called but we will not do
> > > that, instead we use a self signed certificate and the 3rd party app
> > > owners know this. Everything is
> > > 100% completely legal. (Ps: I am the IT lead).
> > 
> > FYI: "MITM proxy" is a ridiculous term. "MITM" means "intermediary" in
> > security terminology, "proxy" means "intermediary" in networking
> > terminology.
> > So that term just means "intermediary intermediary", yeah.
> 
> 
> I did not coined this term, I was referring to this: https://mitmproxy.org,
> I guess it entered IT popular culture somehow..
> 
> > Any serious HTTPS inspection/logging by Squid needs some form of
> > SSL-Bump configuration and those 3rd-party Apps MUST be configured with
> > trust for the self-signed root CA you are using.
> > 
> > Without that nothing Squid (or any other proxy) does will allow traffic
> > inspection beyond the initial TLS handshake.
> 
> 
> I specified in my first email I did this already, maybe I was not so clear but
> my self-signed certificate is working with the 3rd party apps.
> 
> > Assuming that you have checked that detail, on to your issue ...
> > 
> > > We will be using Squid only internally, no outside access. Here is my
> > > issue with the current knowledge of Squid: POC running well on 3 servers
> > > but on the 4th I get no IPv6
> > > sockets:
> > > ubuntu at A2-3:/$ sudo netstat -patun | grep squid | grep tcp
> > > tcp 0 0 10.10.0.16:3128 0.0.0.0:*
> > > LISTEN 2891391/(squid-1)
> > 
> > Your problem is the https(s)_port "port" configuration parameter.
> > 
> > This Squid is configured to listen like:
> > 
> > http_port 10.10.0.16:3128
> > 
> > or
> > 
> > http_port example.com:3128
> > 
> > (when example.com has only address 10.10.0.16)
> > 
> > The "http_port" receives port 80 syntax traffic, it may also be
> > "https_port" which receives port 443 syntax traffic.
> > 
> > > and on the other 3 I have IPv6:
> > > ubuntu at A2-2:/$ sudo netstat -patun | grep squid | grep tcp
> > > tcp 0 0 x.x.x.x:52386 x.x.x.x:443 ESTABLISHED
> > > 997651/(squid-1)
> > > tcp6 0 0 :::3128 :::*
> > > LISTEN 997651/(squid-1)
> > 
> > These Squid are configured to listen like:
> > 
> > http_port 3128
> > 
> > Ensure that the machine/server the 4th Squid is running on has its
> > http(s)_port line matching the other three machines port value.
> > 
> > At this point do not care about the "mode" or options later in the line.
> > Your issue is solely the "port" parameter.
> 
> 
> So far it seems I was missing [::] in my http_port in the problem server, because of automatic deployment
> something went wrong and I assumed my Squid configuration is all the same all over the place. I fixed this but the issue is still there,
> please see: this is inside a docker container on a healthy server:
> # netstat -patun
> Active Internet connections (servers and established)
> Proto Recv-Q Send-Q Local Address Foreign Address State PID/Program name
> tcp 0 0 127.0.0.11:41421 0.0.0.0:* LISTEN 1574/dockerd
> tcp 0 1 172.18.0.10:46950 10.10.0.16:3128 SYN_SENT 307601/node
> udp 0 0 127.0.0.11:57486 0.0.0.0:* 1574/dockerd
> 
> and same netstat on the unhealthy server, still inside docker:
> 
> Active Internet connections (servers and established)
> Proto Recv-Q Send-Q Local Address Foreign Address State PID/Program name
> tcp 0 0 127.0.0.11:38339 0.0.0.0:* LISTEN 273025/dockerd
> tcp 0 0 172.18.0.4:50666 10.10.0.11:3128 ESTABLISHED 494253/node
> tcp6 0 0 :::8080 :::* LISTEN 494253/node
> tcp6 0 0 127.0.0.1:8080 127.0.0.1:46168 TIME_WAIT -
> tcp6 0 0 127.0.0.1:8080 127.0.0.1:44480 TIME_WAIT -
> udp 0 0 127.0.0.11:56639 0.0.0.0:* 273025/dockerd
> 
> and a tcpdump from the docker bridge interface, 172.18.0.10 is my issue container with the SYN sent only
> 
> root at A2-3:~# tcpdump -i br-7b47c165c9ba dst port 3128 -vvv
> tcpdump: listening on br-7b47c165c9ba, link-type EN10MB (Ethernet), snapshot length 262144 bytes
> 09:55:53.436758 IP (tos 0x0, ttl 64, id 48752, offset 0, flags [DF], proto TCP (6), length 60)
> 172.18.0.10.59056 > A2-3.3128: Flags [S], cksum 0xb661 (incorrect -> 0x0dd4), seq 2115452268, win 65535, options [mss 1460,sackOK,TS val 1708093369 ecr 0,nop,wscale 11], length 0
> 
> 09:56:20.845804 IP (tos 0x0, ttl 64, id 40649, offset 0, flags [DF], proto TCP (6), length 60)
> 172.18.0.10.56272 > A2-3.3128: Flags [S], cksum 0xb661 (incorrect -> 0x48f3), seq 2480704598, win 65535, options [mss 1460,sackOK,TS val 1708120778 ecr 0,nop,wscale 11], length 0
> 
> 09:56:21.852827 IP (tos 0x0, ttl 64, id 40650, offset 0, flags [DF], proto TCP (6), length 60)
> 172.18.0.10.56272 > A2-3.3128: Flags [S], cksum 0xb661 (incorrect -> 0x4504), seq 2480704598, win 65535, options [mss 1460,sackOK,TS val 1708121785 ecr 0,nop,wscale 11], length 0
> 
> 09:56:23.868762 IP (tos 0x0, ttl 64, id 40651, offset 0, flags [DF], proto TCP (6), length 60)
> 172.18.0.10.56272 > A2-3.3128: Flags [S], cksum 0xb661 (incorrect -> 0x3d24), seq 2480704598, win 65535, options [mss 1460,sackOK,TS val 1708123801 ecr 0,nop,wscale 11], length 0
> 
> 09:56:27.996768 IP (tos 0x0, ttl 64, id 40652, offset 0, flags [DF], proto TCP (6), length 60)
> 172.18.0.10.56272 > A2-3.3128: Flags [S], cksum 0xb661 (incorrect -> 0x2d04), seq 2480704598, win 65535, options [mss 1460,sackOK,TS val 1708127929 ecr 0,nop,wscale 11], length 0
> 
> 09:56:36.188758 IP (tos 0x0, ttl 64, id 40653, offset 0, flags [DF], proto TCP (6), length 60)
> 172.18.0.10.56272 > A2-3.3128: Flags [S], cksum 0xb661 (incorrect -> 0x0d04), seq 2480704598, win 65535, options [mss 1460,sackOK,TS val 1708136121 ecr 0,nop,wscale 11], length 0
> 
> 09:56:52.316463 IP (tos 0x0, ttl 64, id 40654, offset 0, flags [DF], proto TCP (6), length 60)
> 172.18.0.10.56272 > A2-3.3128: Flags [S], cksum 0xb661 (incorrect -> 0xce03), seq 2480704598, win 65535, options [mss 1460,sackOK,TS val 1708152249 ecr 0,nop,wscale 11], length 0
> 
> 
> 7 packets captured
> 7 packets received by filter
> 
> 
> Why the SYN sent only state? Any ideas?
> 
> Thank you,
> 
> Dragos
> 
> > Cheers
> > Amos
> > _______________________________________________
> > squid-users mailing list
> > squid-users at lists.squid-cache.org
> > https://lists.squid-cache.org/listinfo/squid-users


From anitha.m at hpe.com  Tue Mar  5 18:23:04 2024
From: anitha.m at hpe.com (M, Anitha (CSS))
Date: Tue, 5 Mar 2024 18:23:04 +0000
Subject: [squid-users] Squid Proxy timing out 500/503 errors
Message-ID: <DM4PR84MB3032E6F81C06FE29B158E56D90222@DM4PR84MB3032.NAMPRD84.PROD.OUTLOOK.COM>

Hi team,
We are using squid service deployed as a KVM VM on SLES 15 Sp5 os image.
We are using squid. Rpm: squid-5.7-150400.3.20.1.x86_64

We are seeing too many 503 errors with this version of squid.
This is the squid configuration file. Pls review it and let us know if issues.

We are performing squid scale testing, where every secs there will be 200+requests reaching the squid and squid is spitting out 500/503 errors.

Squid.conf:

gl-pcesreblr-squidproxy03:/var/log/squid # cat /etc/squid/squid.conf
# Recommended minimum configuration:
acl localnet src 172.28.1.0/24
acl localnet src 172.28.4.0/24
acl localnet src 172.28.0.0/24
acl localnet src 172.28.0.12/32
connect_timeout 120 seconds
connect_retries 10
#debug_options ALL,5
#connect_retries_delay 5 seconds
acl localnet src 0.0.0.1-0.255.255.255  # RFC 1122 "this" network (LAN)
acl localnet src 10.0.0.0/8             # RFC 1918 local private network (LAN)
acl localnet src 100.64.0.0/10          # RFC 6598 shared address space (CGN)
acl localnet src 169.254.0.0/16         # RFC 3927 link-local (directly plugged) machines
acl localnet src 172.28.11.0/24
#acl localnet src 172.16.0.0/12         # RFC 1918 local private network (LAN)
#acl localnet src 192.168.0.0/16                # RFC 1918 local private network (LAN)
#acl localnet src fc00::/7              # RFC 4193 local private network range
#acl localnet src fe80::/10             # RFC 4291 link-local (directly plugged) machines



acl blocksites url_regex "/etc/squid/blocksites"
http_access deny blocksites



debug_options ALL,7



acl SSL_ports port 443
acl SSL_ports port 8071
acl SSL_ports port 11052
acl Safe_ports port 80          # http
acl Safe_ports port 21          # ftp
acl Safe_ports port 443         # https
acl Safe_ports port 70          # gopher
acl Safe_ports port 210         # wais
acl Safe_ports port 1025-65535  # unregistered ports
acl Safe_ports port 280         # http-mgmt
acl Safe_ports port 488         # gss-http
acl Safe_ports port 591         # filemaker
acl Safe_ports port 777         # multiling http
acl Safe_ports port 53          # pdns
acl Safe_ports port 5300        # pdns
acl Safe_ports port 123     #NTP
acl Safe_ports port 8071
acl Safe_ports port 11052       # pdns web server
acl Safe_ports port 514         # rsyslog
acl CONNECT method CONNECT
acl SSL_ports port 8053
acl Safe_ports port 8053
acl SSL_ports port 3002
acl Safe_ports port 3002
acl SSL_ports port 3006
acl Safe_ports port 3006
acl SSL_ports port 8203
acl Safe_ports port 8203
acl SSL_ports port 8204
acl Safe_ports port 8204
acl SSL_ports port 8071
acl Safe_ports port 8071
acl Safe_ports port 8200
acl SSL_ports port 8099
acl Safe_ports port 8099
tcp_outgoing_address 20.20.30.5



#
# Recommended minimum Access Permission configuration:
#
# Deny requests to certain unsafe ports
http_access deny !Safe_ports



# Deny CONNECT to other than secure SSL ports
http_access deny CONNECT !SSL_ports



# Only allow cachemgr access from localhost
http_access allow localhost manager
http_access deny manager



# We strongly recommend the following be uncommented to protect innocent
# web applications running on the proxy server who think the only
# one who can access services on "localhost" is a local user
#http_access deny to_localhost



#
# INSERT YOUR OWN RULE(S) HERE TO ALLOW ACCESS FROM YOUR CLIENTS
#



# Example rule allowing access from your local networks.
# Adapt localnet in the ACL section to list your (internal) IP networks
# from where browsing should be allowed
http_access allow localnet
http_access allow localhost



# And finally deny all other access to this proxy
#http_access deny all
#http_access allow all



cache_peer proxy-in.its.hpecorp.net parent 443 0 no-query no-delay default
#cache_peer 16.242.46.11 parent 8080 0 no-query default
#cache_peer 10.132.100.29 parent 3128 0 no-query default



acl parent_proxy src all
http_access allow parent_proxy
never_direct allow parent_proxy



# Squid normally listens to port 3128
http_port 3128



# Leave coredumps in the first cache dir
coredump_dir /var/cache/squid



#
# Add any of your own refresh_pattern entries above these.
#
refresh_pattern ^ftp:           1440    20%     10080
refresh_pattern ^gopher:        1440    0%      1440
refresh_pattern -i (/cgi-bin/|\?) 0     0%      0
refresh_pattern .               0       20%     4320



dns_nameservers 172.28.0.121 16.110.135.52



max_filedescriptors 3200
cache_dir ufs /var/cache/squid 8192 16 256
cache_mem 2096 MB
cache_swap_high 95
cache_swap_low 90
ftp_passive on
maximum_object_size 4096 MB
memory_replacement_policy lru
minimum_object_size 0 KB



# Recommended minimum configuration:
acl localnet src 172.28.4.0/24
acl localnet src 172.28.0.0/24
acl localnet src 172.28.1.0/24 # OOBM Network outbound access
#acl HOGAN dst hogan.nimblestorage.com
acl localnet src 0.0.0.1-0.255.255.255 # RFC 1122 "this" network (LAN)
acl blocksites url_regex "/etc/squid/blocksites"
http_access deny blocksites
acl SSL_ports port 443
acl SSL_ports port 8071
acl SSL_ports port 11052
acl SSL_ports port 8200
acl SSL_ports port 8282
acl Safe_ports port 8282
#acl HOGAN_port port 2222 # hogan.nimblestorage.com:2222 SSH support tunnel
# Example rule allowing access from your local networks.
# Adapt localnet in the ACL section to list your (internal) IP networks
# from where browsing should be allowed
acl localnet src 172.16.117.0/24
http_access allow localnet
http_access allow localhost
#http_access allow HOGAN HOGAN_port
acl localnet src 20.20.30.0/21
acl parent_proxy_exclude dst 20.20.30.0/21
acl parent_proxy_exclude_ST0100 dst 20.20.30.222/22
always_direct allow parent_proxy_exclude_ST0100
acl servicenet dst 172.28.4.0/24
always_direct allow parent_proxy_exclude
always_direct allow servicenet



Logs:

2024/03/05 22:42:57.000 kid1| 1,5| CodeContext.cc(60) Entering: master1604
2024/03/05 22:42:57.000 kid1| 5,3| Read.cc(148) HandleRead: FD 756, size 65535, retval 206, errno 0
2024/03/05 22:42:57.000 kid1| 5,3| IoCallback.cc(112) finish: called for conn3875 local=20.20.30.5:50937 remote=10.120.125.146:443 FIRSTUP_PARENT FD 756 flags=1 (0, 0)
2024/03/05 22:42:57.000 kid1| 5,4| AsyncCall.cc(97) ScheduleCall: IoCallback.cc(131) will call TunnelBlindCopyReadHandler(conn3875 local=20.20.30.5:50937 remote=10.120.125.146:443 FIRSTUP_PARENT FD 756 flags=1, data=0x557f30aec0a8, size=206, buf=0x557f30d277a0) [call131521]
2024/03/05 22:42:57.000 kid1| 1,7| CodeContext.cc(70) Leaving: master1604
2024/03/05 22:42:57.000 kid1| 1,5| CodeContext.cc(60) Entering: master1604
2024/03/05 22:42:57.000 kid1| 5,4| AsyncCallQueue.cc(59) fireNext: entering TunnelBlindCopyReadHandler(conn3875 local=20.20.30.5:50937 remote=10.120.125.146:443 FIRSTUP_PARENT FD 756 flags=1, data=0x557f30aec0a8, size=206, buf=0x557f30d277a0)
2024/03/05 22:42:57.000 kid1| 5,4| AsyncCall.cc(42) make: make call TunnelBlindCopyReadHandler [call131521]
2024/03/05 22:42:57.000 kid1| 26,3| tunnel.cc(526) ReadServer: conn3875 local=20.20.30.5:50937 remote=10.120.125.146:443 FIRSTUP_PARENT FD 756 flags=1
2024/03/05 22:42:57.000 kid1| 26,3| tunnel.cc(534) readServer: conn3875 local=20.20.30.5:50937 remote=10.120.125.146:443 FIRSTUP_PARENT FD 756 flags=1, read 206 bytes, err=0
2024/03/05 22:42:57.000 kid1| 26,3| tunnel.cc(486) bytesIn: len=0 + count=206
2024/03/05 22:42:57.000 kid1| 26,3| tunnel.cc(603) keepGoingAfterRead: from={conn3875 local=20.20.30.5:50937 remote=10.120.125.146:443 FIRSTUP_PARENT FD 756 flags=1}, to={conn3867 local=20.20.30.2:3128 remote=20.20.31.153:49724 FD 753 flags=1}
2024/03/05 22:42:57.000 kid1| 5,4| AsyncCall.cc(30) AsyncCall: The AsyncCall tunnelTimeout constructed, this=0x557f30a20410 [call132703]
2024/03/05 22:42:57.000 kid1| 5,3| comm.cc(571) commSetConnTimeout: conn3875 local=20.20.30.5:50937 remote=10.120.125.146:443 FIRSTUP_PARENT FD 756 flags=1 timeout 900
2024/03/05 22:42:57.000 kid1| 5,4| AsyncCall.cc(30) AsyncCall: The AsyncCall tunnelTimeout constructed, this=0x557f2ebd3660 [call132704]
2024/03/05 22:42:57.000 kid1| 5,3| comm.cc(571) commSetConnTimeout: conn3867 local=20.20.30.2:3128 remote=20.20.31.153:49724 FD 753 flags=1 timeout 900
2024/03/05 22:42:57.000 kid1| 26,3| tunnel.cc(646) copy: Schedule Write
2024/03/05 22:42:57.000 kid1| 5,5| AsyncCall.cc(30) AsyncCall: The AsyncCall TunnelBlindCopyWriteHandler constructed, this=0x557f2ef09120 [call132705]
2024/03/05 22:42:57.000 kid1| 5,5| Write.cc(37) Write: conn3867 local=20.20.30.2:3128 remote=20.20.31.153:49724 FD 753 flags=1: sz 206: asynCall 0x557f2ef09120*2
2024/03/05 22:42:57.000 kid1| 5,5| ModEpoll.cc(118) SetSelect: FD 753, type=2, handler=1, client_data=0x7f766627b060, timeout=0
2024/03/05 22:42:57.000 kid1| 5,4| AsyncCallQueue.cc(61) fireNext: leaving TunnelBlindCopyReadHandler(conn3875 local=20.20.30.5:50937 remote=10.120.125.146:443 FIRSTUP_PARENT FD 756 flags=1, data=0x557f30aec0a8, size=206, buf=0x557f30d277a0)
2024/03/05 22:42:57.000 kid1| 1,7| CodeContext.cc(70) Leaving: master1604
2024/03/05 22:42:57.000 kid1| 1,5| CodeContext.cc(60) Entering: master87
2024/03/05 22:42:57.000 kid1| 5,5| comm.cc(1633) checkTimeouts: checkTimeouts: FD 45 Expired
2024/03/05 22:42:57.000 kid1| 5,5| comm.cc(1636) checkTimeouts: checkTimeouts: FD 45: Call timeout handler
2024/03/05 22:42:57.000 kid1| 5,4| AsyncCall.cc(97) ScheduleCall: comm.cc(1639) will call Comm::ConnOpener::timeout(conn85 local=20.20.30.5 remote=10.120.125.146:443 FIRSTUP_PARENT flags=1, data=0x557f2c68ec48) [call419]
2024/03/05 22:42:57.000 kid1| 1,7| CodeContext.cc(70) Leaving: master87
2024/03/05 22:42:57.000 kid1| 1,5| CodeContext.cc(60) Entering: master138
2024/03/05 22:42:57.000 kid1| 5,5| comm.cc(1633) checkTimeouts: checkTimeouts: FD 91 Expired
2024/03/05 22:42:57.000 kid1| 5,5| comm.cc(1636) checkTimeouts: checkTimeouts: FD 91: Call timeout handler
2024/03/05 22:42:57.000 kid1| 5,4| AsyncCall.cc(97) ScheduleCall: comm.cc(1639) will call Comm::ConnOpener::timeout(conn213 local=20.20.30.5 remote=10.120.125.146:443 FIRSTUP_PARENT flags=1, data=0x557f2c9750e8) [call1148]
2024/03/05 22:42:57.000 kid1| 1,7| CodeContext.cc(70) Leaving: master138
2024/03/05 22:42:57.000 kid1| 1,5| CodeContext.cc(60) Entering: master1604
2024/03/05 22:42:57.000 kid1| 5,5| Write.cc(69) HandleWrite: conn3867 local=20.20.30.2:3128 remote=20.20.31.153:49724 FD 753 flags=1: off 0, sz 206.
2024/03/05 22:42:57.001 kid1| 5,5| Write.cc(89) HandleWrite: write() returns 206
2024/03/05 22:42:57.001 kid1| 5,3| IoCallback.cc(112) finish: called for conn3867 local=20.20.30.2:3128 remote=20.20.31.153:49724 FD 753 flags=1 (0, 0)
2024/03/05 22:42:57.001 kid1| 5,5| AsyncCall.cc(97) ScheduleCall: IoCallback.cc(131) will call TunnelBlindCopyWriteHandler(conn3867 local=20.20.30.2:3128 remote=20.20.31.153:49724 FD 753 flags=1, data=0x557f30aec0a8, size=206, buf=0x557f30d277a0) [call132705]
2024/03/05 22:42:57.001 kid1| 1,7| CodeContext.cc(70) Leaving: master1604
2024/03/05 22:42:57.001 kid1| 1,5| CodeContext.cc(60) Entering: master87
2024/03/05 22:42:57.001 kid1| 5,4| AsyncCallQueue.cc(59) fireNext: entering Comm::ConnOpener::timeout(conn85 local=20.20.30.5 remote=10.120.125.146:443 FIRSTUP_PARENT flags=1, data=0x557f2c68ec48)
2024/03/05 22:42:57.001 kid1| 5,4| AsyncCall.cc(42) make: make call Comm::ConnOpener::timeout [call419]
2024/03/05 22:42:57.001 kid1| 5,4| AsyncJob.cc(124) callStart: Comm::ConnOpener status in: [ job76]
2024/03/05 22:42:57.001 kid1| 5,5| ConnOpener.cc(467) timeout: conn85 local=20.20.30.5 remote=10.120.125.146:443 FIRSTUP_PARENT flags=1: * - ERR took too long to receive response.
2024/03/05 22:42:57.001 kid1| 48,5| AsyncCall.cc(97) ScheduleCall: ConnOpener.cc(160) will call HappyConnOpener::notePrimeConnectDone(conn85 local=20.20.30.5 remote=10.120.125.146:443 FIRSTUP_PARENT flags=1, errno=110, flag=-4, data=0x557f2c68e278) [call403]
2024/03/05 22:42:57.001 kid1| 93,5| AsyncJob.cc(85) mustStop: Comm::ConnOpener will stop, reason: Comm::ConnOpener::timeout
2024/03/05 22:42:57.001 kid1| 93,5| AsyncJob.cc(140) callEnd: Comm::ConnOpener::timeout(conn85 local=20.20.30.5 remote=10.120.125.146:443 FIRSTUP_PARENT flags=1, data=0x557f2c68ec48) ends job [Stopped, reason:Comm::ConnOpener::timeout job76]
2024/03/05 22:42:57.001 kid1| 5,4| ConnOpener.cc(176) cleanFd: ; temp FD 45
2024/03/05 22:42:57.001 kid1| 5,5| ModEpoll.cc(118) SetSelect: FD 45, type=2, handler=0, client_data=0, timeout=0
2024/03/05 22:42:57.001 kid1| 5,5| comm.cc(1048) comm_remove_close_handler: comm_remove_close_handler: FD 45, AsyncCall=0x557f2c68ecd0*2
2024/03/05 22:42:57.001 kid1| 5,4| AsyncCall.cc(60) cancel: will not call Comm::ConnOpener::earlyAbort [call418] because comm_remove_close_handler
2024/03/05 22:42:57.001 kid1| 5,3| comm.cc(877) _comm_close: start closing FD 45 by ConnOpener.cc:233
2024/03/05 22:42:57.001 kid1| 5,3| comm.cc(558) commUnsetFdTimeout: Remove timeout for FD 45
2024/03/05 22:42:57.001 kid1| 5,5| comm.cc(739) commCallCloseHandlers: commCallCloseHandlers: FD 45

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20240305/adcb85a0/attachment.htm>

From squid3 at treenet.co.nz  Wed Mar  6 07:37:29 2024
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Wed, 6 Mar 2024 20:37:29 +1300
Subject: [squid-users] Squid Proxy timing out 500/503 errors
In-Reply-To: <DM4PR84MB3032E6F81C06FE29B158E56D90222@DM4PR84MB3032.NAMPRD84.PROD.OUTLOOK.COM>
References: <DM4PR84MB3032E6F81C06FE29B158E56D90222@DM4PR84MB3032.NAMPRD84.PROD.OUTLOOK.COM>
Message-ID: <c77c1794-8061-4e97-91fc-242da06574b9@treenet.co.nz>

On 6/03/24 07:23, M, Anitha (CSS) wrote:
> Hi team,
> 
> We are using squid service deployed as a KVM VM on SLES 15 Sp5 os image.
> 
> We are using squid. Rpm: *squid-5.7-150400.3.20.1.x86_64*
> 
> **
> 
> We are seeing too many 503 errors with this version of squid.
> 
> This is the squid configuration file. Pls review it and let us know if 
> issues.
> 

It appears that your configuration file consists of at least 2 different 
configuration files appended to each other.

Please start by running "squid -k parse" and fixing all the warnings it 
should produce.


> We are performing squid scale testing, where every secs there will be 
> 200+requests reaching the squid and squid is spitting out 500/503 errors.
> 

FYI: you have restricted Squid to no more than 3200 filedescriptors. 
That is rather low. I recommend at least 64K.


> Squid.conf:
> 
> gl-pcesreblr-squidproxy03:/var/log/squid # cat /etc/squid/squid.conf
> # Recommended minimum configuration:
> acl localnet src 172.28.1.0/24
> acl localnet src 172.28.4.0/24
> acl localnet src 172.28.0.0/24
> acl localnet src 172.28.0.12/32
> connect_timeout 120 seconds
> connect_retries 10
> #debug_options ALL,5
> #connect_retries_delay 5 seconds
> acl localnet src 0.0.0.1-0.255.255.255? # RFC 1122 "this" network (LAN)
> acl localnet src 10.0.0.0/8???????????? # RFC 1918 local private network 
> (LAN)
> acl localnet src 100.64.0.0/10????????? # RFC 6598 shared address space 
> (CGN)
> acl localnet src 169.254.0.0/16???????? # RFC 3927 link-local (directly 
> plugged) machines
> acl localnet src 172.28.11.0/24
> #acl localnet src 172.16.0.0/12???????? # RFC 1918 local private network 
> (LAN)
> #acl localnet src 192.168.0.0/16??????????????? # RFC 1918 local private 
> network (LAN)
> #acl localnet src fc00::/7????????????? # RFC 4193 local private network 
> range
> #acl localnet src fe80::/10???????????? # RFC 4291 link-local (directly 
> plugged) machines
> 
> acl blocksites url_regex "/etc/squid/blocksites"
> http_access deny blocksites
> 
> debug_options ALL,7
> 
> acl SSL_ports port 443
> acl SSL_ports port 8071
> acl SSL_ports port 11052
> acl Safe_ports port 80????????? # http
> acl Safe_ports port 21????????? # ftp
> acl Safe_ports port 443???????? # https
> acl Safe_ports port 70????????? # gopher
> acl Safe_ports port 210???????? # wais
> acl Safe_ports port 1025-65535? # unregistered ports
> acl Safe_ports port 280???????? # http-mgmt
> acl Safe_ports port 488???????? # gss-http
> acl Safe_ports port 591???????? # filemaker
> acl Safe_ports port 777???????? # multiling http
> acl Safe_ports port 53????????? # pdns
> acl Safe_ports port 5300??????? # pdns
> acl Safe_ports port 123???? #NTP
> acl Safe_ports port 8071
> acl Safe_ports port 11052?????? # pdns web server
> acl Safe_ports port 514???????? # rsyslog
> acl CONNECT method CONNECT
> acl SSL_ports port 8053
> acl Safe_ports port 8053
> acl SSL_ports port 3002
> acl Safe_ports port 3002
> acl SSL_ports port 3006
> acl Safe_ports port 3006
> acl SSL_ports port 8203
> acl Safe_ports port 8203
> acl SSL_ports port 8204
> acl Safe_ports port 8204
> acl SSL_ports port 8071
> acl Safe_ports port 8071
> acl Safe_ports port 8200
> acl SSL_ports port 8099
> acl Safe_ports port 8099
> tcp_outgoing_address 20.20.30.5
> 
> #
> # Recommended minimum Access Permission configuration:
> #
> # Deny requests to certain unsafe ports
> http_access deny !Safe_ports
> 
> # Deny CONNECT to other than secure SSL ports
> http_access deny CONNECT !SSL_ports
> 
> # Only allow cachemgr access from localhost
> http_access allow localhost manager
> http_access deny manager
> 
> # We strongly recommend the following be uncommented to protect innocent
> # web applications running on the proxy server who think the only
> # one who can access services on "localhost" is a local user
> #http_access deny to_localhost
> 
> #
> # INSERT YOUR OWN RULE(S) HERE TO ALLOW ACCESS FROM YOUR CLIENTS
> #

Please notice what the above line says.

> 
> # Example rule allowing access from your local networks.
> # Adapt localnet in the ACL section to list your (internal) IP networks
> # from where browsing should be allowed
> http_access allow localnet
> http_access allow localhost
> 
> # And finally deny all other access to this proxy
> #http_access deny all
> #http_access allow all
> 
> cache_peer proxy-in.its.hpecorp.net parent 443 0 no-query no-delay default

... so a server listening for plain-text HTTP on port 443. That is a bit 
broken. At least consider enabling TLS/SSL on connections to this peer 
so Squid can send it HTTPS traffic.


> #cache_peer 16.242.46.11 parent 8080 0 no-query default
> #cache_peer 10.132.100.29 parent 3128 0 no-query default
> 
> acl parent_proxy src all
> http_access allow parent_proxy

The above two lines are identical to:
   http_access allow all

... no http_access lines following this one will ever have any effects.

> never_direct allow parent_proxy

Likewise same as:
   never_direct allow all

... however you have always_direct rules later that override this.

> 
> # Squid normally listens to port 3128
> http_port 3128
> 
> # Leave coredumps in the first cache dir
> coredump_dir /var/cache/squid
> 
> #
> # Add any of your own refresh_pattern entries above these.
> #
> refresh_pattern ^ftp:?????????? 1440??? 20%???? 10080
> refresh_pattern ^gopher:??????? 1440??? 0%????? 1440
> refresh_pattern -i (/cgi-bin/|\?) 0???? 0%????? 0
> refresh_pattern .?????????????? 0?????? 20%???? 4320
> 
> dns_nameservers 172.28.0.121 16.110.135.52
> 
> max_filedescriptors 3200
> cache_dir ufs /var/cache/squid 8192 16 256
> cache_mem 2096 MB
> cache_swap_high 95
> cache_swap_low 90
> ftp_passive on
> maximum_object_size 4096 MB
> memory_replacement_policy lru
> minimum_object_size 0 KB
> 

At this point your file just starts repeating rules, with different 
settings. Some of these replace the above settings, some append to the, 
and some have no effect due to earlier rules.


> # Recommended minimum configuration:
> acl localnet src 172.28.4.0/24
> acl localnet src 172.28.0.0/24
> acl localnet src 172.28.1.0/24 # OOBM Network outbound access
> #acl HOGAN dst hogan.nimblestorage.com
> acl localnet src 0.0.0.1-0.255.255.255 # RFC 1122 ?this? network (LAN)
> acl blocksites url_regex ?/etc/squid/blocksites?
> http_access deny blocksites
> acl SSL_ports port 443
> acl SSL_ports port 8071
> acl SSL_ports port 11052
> acl SSL_ports port 8200
> acl SSL_ports port 8282
> acl Safe_ports port 8282
> #acl HOGAN_port port 2222 # hogan.nimblestorage.com:2222 SSH support tunnel
> # Example rule allowing access from your local networks.
> # Adapt localnet in the ACL section to list your (internal) IP networks
> # from where browsing should be allowed
> acl localnet src 172.16.117.0/24
> http_access allow localnet
> http_access allow localhost
> #http_access allow HOGAN HOGAN_port
> acl localnet src 20.20.30.0/21
> acl parent_proxy_exclude dst 20.20.30.0/21
> acl parent_proxy_exclude_ST0100 dst 20.20.30.222/22
> always_direct allow parent_proxy_exclude_ST0100
> acl servicenet dst 172.28.4.0/24
> always_direct allow parent_proxy_exclude
> always_direct allow servicenet
> 


HTH
Amos



From anitha.m at hpe.com  Wed Mar  6 10:32:07 2024
From: anitha.m at hpe.com (M, Anitha (CSS))
Date: Wed, 6 Mar 2024 10:32:07 +0000
Subject: [squid-users] Squid Proxy timing out 500/503 errors
In-Reply-To: <c77c1794-8061-4e97-91fc-242da06574b9@treenet.co.nz>
References: <DM4PR84MB3032E6F81C06FE29B158E56D90222@DM4PR84MB3032.NAMPRD84.PROD.OUTLOOK.COM>
 <c77c1794-8061-4e97-91fc-242da06574b9@treenet.co.nz>
Message-ID: <DM4PR84MB30324B75DDF87B8A0CEBD39690212@DM4PR84MB3032.NAMPRD84.PROD.OUTLOOK.COM>

Hi , 

Thank you for the response. 

I cleaned up all the duplicates and updated the configuration file. And still seeing the errors. 
Pls note this issue is easily reproducible when  squid is loaded up  with more then 300+ requests  at a time.

===========================================
# Recommended minimum configuration:
acl localnet src 172.28.1.0/24
acl localnet src 172.28.4.0/24
acl localnet src 172.28.0.0/24

acl localnet src 0.0.0.1-0.255.255.255  # RFC 1122 "this" network (LAN)
acl localnet src 10.0.0.0/8             # RFC 1918 local private network (LAN)
acl localnet src 100.64.0.0/10          # RFC 6598 shared address space (CGN)
acl localnet src 169.254.0.0/16         # RFC 3927 link-local (directly plugged) machines
acl localnet src 172.28.11.0/24
acl localnet src 172.16.117.0/24
acl localnet src 20.20.30.0/21

acl parent_proxy_exclude dst 20.20.30.0/21
acl servicenet dst 172.28.4.0/24
acl parent_proxy_exclude_ST0100 dst 20.20.30.222/22
always_direct allow parent_proxy_exclude_ST0100

always_direct allow parent_proxy_exclude
always_direct allow servicenet

acl blocksites url_regex "/etc/squid/blocksites"
http_access deny blocksites

#debug_options ALL,5

acl SSL_ports port 443
acl SSL_ports port 8071
acl SSL_ports port 11052
acl Safe_ports port 80          # http
acl Safe_ports port 21          # ftp
acl Safe_ports port 443         # https
acl Safe_ports port 70          # gopher
acl Safe_ports port 210         # wais
acl Safe_ports port 1025-65535  # unregistered ports
acl Safe_ports port 280         # http-mgmt
acl Safe_ports port 488         # gss-http
acl Safe_ports port 591         # filemaker
acl Safe_ports port 777         # multiling http
acl Safe_ports port 53          # pdns
acl Safe_ports port 5300        # pdns
acl Safe_ports port 123     #NTP
acl Safe_ports port 8071
acl Safe_ports port 11052       # pdns web server
acl Safe_ports port 514         # rsyslog
acl Safe_ports port 8200
acl SSL_ports port 8053
acl Safe_ports port 8053
acl SSL_ports port 3002
acl Safe_ports port 3002
acl SSL_ports port 3006
acl Safe_ports port 3006
acl SSL_ports port 8203
acl Safe_ports port 8203
acl SSL_ports port 8204
acl Safe_ports port 8204
acl SSL_ports port 8099
acl Safe_ports port 8099

acl CONNECT method CONNECT

tcp_outgoing_address 20.20.30.3

#
# Recommended minimum Access Permission configuration:
#
# Deny requests to certain unsafe ports
http_access deny !Safe_ports

# Deny CONNECT to other than secure SSL ports
http_access deny CONNECT !SSL_ports

# Only allow cachemgr access from localhost
http_access allow localhost manager
http_access deny manager

# We strongly recommend the following be uncommented to protect innocent
# web applications running on the proxy server who think the only
# one who can access services on "localhost" is a local user
http_access deny to_localhost

#
# INSERT YOUR OWN RULE(S) HERE TO ALLOW ACCESS FROM YOUR CLIENTS
#

# Example rule allowing access from your local networks.
# Adapt localnet in the ACL section to list your (internal) IP networks
# from where browsing should be allowed
http_access allow localnet
http_access allow localhost

# And finally deny all other access to this proxy
http_access deny all

cache_peer proxy-in.its.hpecorp.net parent 443 0 no-query default
acl parent_proxy src all
http_access allow parent_proxy
never_direct allow parent_proxy

# Squid normally listens to port 3128
http_port 3128

# Leave coredumps in the first cache dir
coredump_dir /var/cache/squid

#
# Add any of your own refresh_pattern entries above these.
#
refresh_pattern ^ftp:           1440    20%     10080
refresh_pattern ^gopher:        1440    0%      1440
refresh_pattern -i (/cgi-bin/|\?) 0     0%      0
refresh_pattern .               0       20%     4320

dns_nameservers 172.28.0.121 16.110.135.52

max_filedescriptors 64000
cache_dir ufs /var/cache/squid 8192 16 256
cache_mem 2096 MB
cache_swap_high 95
cache_swap_low 90
ftp_passive on
maximum_object_size 4096 MB
memory_replacement_policy lru
minimum_object_size 0 KB
===========================================

Regards,
Anitha. 
-----Original Message-----
From: squid-users <squid-users-bounces at lists.squid-cache.org> On Behalf Of Amos Jeffries
Sent: Wednesday, March 6, 2024 1:07 PM
To: squid-users at lists.squid-cache.org
Subject: Re: [squid-users] Squid Proxy timing out 500/503 errors

On 6/03/24 07:23, M, Anitha (CSS) wrote:
> Hi team,
> 
> We are using squid service deployed as a KVM VM on SLES 15 Sp5 os image.
> 
> We are using squid. Rpm: *squid-5.7-150400.3.20.1.x86_64*
> 
> **
> 
> We are seeing too many 503 errors with this version of squid.
> 
> This is the squid configuration file. Pls review it and let us know if 
> issues.
> 

It appears that your configuration file consists of at least 2 different configuration files appended to each other.

Please start by running "squid -k parse" and fixing all the warnings it should produce.


> We are performing squid scale testing, where every secs there will be 
> 200+requests reaching the squid and squid is spitting out 500/503 errors.
> 

FYI: you have restricted Squid to no more than 3200 filedescriptors. 
That is rather low. I recommend at least 64K.


> Squid.conf:
> 
> gl-pcesreblr-squidproxy03:/var/log/squid # cat /etc/squid/squid.conf
> # Recommended minimum configuration:
> acl localnet src 172.28.1.0/24
> acl localnet src 172.28.4.0/24
> acl localnet src 172.28.0.0/24
> acl localnet src 172.28.0.12/32
> connect_timeout 120 seconds
> connect_retries 10
> #debug_options ALL,5
> #connect_retries_delay 5 seconds
> acl localnet src 0.0.0.1-0.255.255.255? # RFC 1122 "this" network (LAN)
> acl localnet src 10.0.0.0/8???????????? # RFC 1918 local private network 
> (LAN)
> acl localnet src 100.64.0.0/10????????? # RFC 6598 shared address space 
> (CGN)
> acl localnet src 169.254.0.0/16???????? # RFC 3927 link-local (directly 
> plugged) machines
> acl localnet src 172.28.11.0/24
> #acl localnet src 172.16.0.0/12???????? # RFC 1918 local private network 
> (LAN)
> #acl localnet src 192.168.0.0/16??????????????? # RFC 1918 local private 
> network (LAN)
> #acl localnet src fc00::/7????????????? # RFC 4193 local private network 
> range
> #acl localnet src fe80::/10???????????? # RFC 4291 link-local (directly 
> plugged) machines
> 
> acl blocksites url_regex "/etc/squid/blocksites"
> http_access deny blocksites
> 
> debug_options ALL,7
> 
> acl SSL_ports port 443
> acl SSL_ports port 8071
> acl SSL_ports port 11052
> acl Safe_ports port 80????????? # http
> acl Safe_ports port 21????????? # ftp
> acl Safe_ports port 443???????? # https
> acl Safe_ports port 70????????? # gopher
> acl Safe_ports port 210???????? # wais
> acl Safe_ports port 1025-65535? # unregistered ports
> acl Safe_ports port 280???????? # http-mgmt
> acl Safe_ports port 488???????? # gss-http
> acl Safe_ports port 591???????? # filemaker
> acl Safe_ports port 777???????? # multiling http
> acl Safe_ports port 53????????? # pdns
> acl Safe_ports port 5300??????? # pdns
> acl Safe_ports port 123???? #NTP
> acl Safe_ports port 8071
> acl Safe_ports port 11052?????? # pdns web server
> acl Safe_ports port 514???????? # rsyslog
> acl CONNECT method CONNECT
> acl SSL_ports port 8053
> acl Safe_ports port 8053
> acl SSL_ports port 3002
> acl Safe_ports port 3002
> acl SSL_ports port 3006
> acl Safe_ports port 3006
> acl SSL_ports port 8203
> acl Safe_ports port 8203
> acl SSL_ports port 8204
> acl Safe_ports port 8204
> acl SSL_ports port 8071
> acl Safe_ports port 8071
> acl Safe_ports port 8200
> acl SSL_ports port 8099
> acl Safe_ports port 8099
> tcp_outgoing_address 20.20.30.5
> 
> #
> # Recommended minimum Access Permission configuration:
> #
> # Deny requests to certain unsafe ports
> http_access deny !Safe_ports
> 
> # Deny CONNECT to other than secure SSL ports
> http_access deny CONNECT !SSL_ports
> 
> # Only allow cachemgr access from localhost
> http_access allow localhost manager
> http_access deny manager
> 
> # We strongly recommend the following be uncommented to protect innocent
> # web applications running on the proxy server who think the only
> # one who can access services on "localhost" is a local user
> #http_access deny to_localhost
> 
> #
> # INSERT YOUR OWN RULE(S) HERE TO ALLOW ACCESS FROM YOUR CLIENTS
> #

Please notice what the above line says.

> 
> # Example rule allowing access from your local networks.
> # Adapt localnet in the ACL section to list your (internal) IP networks
> # from where browsing should be allowed
> http_access allow localnet
> http_access allow localhost
> 
> # And finally deny all other access to this proxy
> #http_access deny all
> #http_access allow all
> 
> cache_peer proxy-in.its.hpecorp.net parent 443 0 no-query no-delay default

... so a server listening for plain-text HTTP on port 443. That is a bit 
broken. At least consider enabling TLS/SSL on connections to this peer 
so Squid can send it HTTPS traffic.


> #cache_peer 16.242.46.11 parent 8080 0 no-query default
> #cache_peer 10.132.100.29 parent 3128 0 no-query default
> 
> acl parent_proxy src all
> http_access allow parent_proxy

The above two lines are identical to:
   http_access allow all

... no http_access lines following this one will ever have any effects.

> never_direct allow parent_proxy

Likewise same as:
   never_direct allow all

... however you have always_direct rules later that override this.

> 
> # Squid normally listens to port 3128
> http_port 3128
> 
> # Leave coredumps in the first cache dir
> coredump_dir /var/cache/squid
> 
> #
> # Add any of your own refresh_pattern entries above these.
> #
> refresh_pattern ^ftp:?????????? 1440??? 20%???? 10080
> refresh_pattern ^gopher:??????? 1440??? 0%????? 1440
> refresh_pattern -i (/cgi-bin/|\?) 0???? 0%????? 0
> refresh_pattern .?????????????? 0?????? 20%???? 4320
> 
> dns_nameservers 172.28.0.121 16.110.135.52
> 
> max_filedescriptors 3200
> cache_dir ufs /var/cache/squid 8192 16 256
> cache_mem 2096 MB
> cache_swap_high 95
> cache_swap_low 90
> ftp_passive on
> maximum_object_size 4096 MB
> memory_replacement_policy lru
> minimum_object_size 0 KB
> 

At this point your file just starts repeating rules, with different 
settings. Some of these replace the above settings, some append to the, 
and some have no effect due to earlier rules.


> # Recommended minimum configuration:
> acl localnet src 172.28.4.0/24
> acl localnet src 172.28.0.0/24
> acl localnet src 172.28.1.0/24 # OOBM Network outbound access
> #acl HOGAN dst hogan.nimblestorage.com
> acl localnet src 0.0.0.1-0.255.255.255 # RFC 1122 ?this? network (LAN)
> acl blocksites url_regex ?/etc/squid/blocksites?
> http_access deny blocksites
> acl SSL_ports port 443
> acl SSL_ports port 8071
> acl SSL_ports port 11052
> acl SSL_ports port 8200
> acl SSL_ports port 8282
> acl Safe_ports port 8282
> #acl HOGAN_port port 2222 # hogan.nimblestorage.com:2222 SSH support tunnel
> # Example rule allowing access from your local networks.
> # Adapt localnet in the ACL section to list your (internal) IP networks
> # from where browsing should be allowed
> acl localnet src 172.16.117.0/24
> http_access allow localnet
> http_access allow localhost
> #http_access allow HOGAN HOGAN_port
> acl localnet src 20.20.30.0/21
> acl parent_proxy_exclude dst 20.20.30.0/21
> acl parent_proxy_exclude_ST0100 dst 20.20.30.222/22
> always_direct allow parent_proxy_exclude_ST0100
> acl servicenet dst 172.28.4.0/24
> always_direct allow parent_proxy_exclude
> always_direct allow servicenet
> 


HTH
Amos

_______________________________________________
squid-users mailing list
squid-users at lists.squid-cache.org
https://lists.squid-cache.org/listinfo/squid-users 

From jason.marshall at gmail.com  Wed Mar  6 14:48:56 2024
From: jason.marshall at gmail.com (Jason Marshall)
Date: Wed, 6 Mar 2024 09:48:56 -0500
Subject: [squid-users] Recommended squid settings when using IPS-based
 domain blocking
Message-ID: <CAG8TTAbNxZKKxJgWR9Kcpf3b0vnafaNWbnthjitsS-sNNerpyg@mail.gmail.com>

Good morning,

We have been using squid (version squid-5.5-6.el9_3.5) under RHEL9 as a
simple pass-through proxy without issue for the past month or so. Recently
our security team implemented an IPS product that intercepts domain names
known to be associated with malware and ransomware command and control.
Once this was in place, we started having issues with the behavior of squid.

Through some troubleshooting, it appears that what is happening is that
that when a user's machine make a request through squid for one of these
bad domains, the request is dropped by the IPS, squid waits for the DNS
timeout, and then all requests made to squid after that result
in NONE_NONE/500 errors, and it never seems to recover until we do a
restart or reload of the service.

Initially the dns_timeout was set for 30 seconds. I reduced this, thinking
that perhaps requests were building up or something along those lines. I
set it to 5 seconds, but that just got us to a failure state faster.

I also found the negative_dns_ttl setting and thought it might be having an
effect, but setting this to 0 seconds resulted in no change to the behavior.

Are there any configuration tips that anyone can provide that might work
better with dropped/intercepted DNS requests? My current configuration is
included here:

acl localnet src 0.0.0.1-0.255.255.255  # RFC 1122 "this" network (LAN)
acl localnet src 10.0.0.0/8             # RFC 1918 local private network
(LAN)
acl localnet src 100.64.0.0/10          # RFC 6598 shared address space
(CGN)
acl localnet src 169.254.0.0/16         # RFC 3927 link-local (directly
plugged) machines
acl localnet src 172.16.0.0/12          # RFC 1918 local private network
(LAN)
acl localnet src 192.168.0.0/16         # RFC 1918 local private network
(LAN)

acl localnet src fc00::/7               # RFC 4193 local private network
range
acl localnet src fe80::/10              # RFC 4291 link-local (directly
plugged) machines

acl SSL_ports port 443
acl Safe_ports port 80          # http
acl Safe_ports port 443         # https
acl Safe_ports port 9191        # papercut
http_access deny !Safe_ports
http_access allow localhost manager
http_access deny manager

http_access allow localnet
http_access allow localhost
http_access deny all
http_port 0.0.0.0:3128
http_port 0.0.0.0:3129
cache deny all
coredump_dir /var/spool/squid
refresh_pattern ^ftp:           1440    20%     10080
refresh_pattern ^gopher:        1440    0%      1440
refresh_pattern -i (/cgi-bin/|\?) 0     0%      0
refresh_pattern .               0       20%     4320
debug_options rotate=1 ALL,2
negative_dns_ttl 0 seconds
dns_timeout 5 seconds

Thank you for any help that you can provide.

Jason Marshall
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20240306/a67484ce/attachment.htm>

From rousskov at measurement-factory.com  Wed Mar  6 14:58:35 2024
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Wed, 6 Mar 2024 09:58:35 -0500
Subject: [squid-users] Recommended squid settings when using IPS-based
 domain blocking
In-Reply-To: <CAG8TTAbNxZKKxJgWR9Kcpf3b0vnafaNWbnthjitsS-sNNerpyg@mail.gmail.com>
References: <CAG8TTAbNxZKKxJgWR9Kcpf3b0vnafaNWbnthjitsS-sNNerpyg@mail.gmail.com>
Message-ID: <321adc97-103d-493f-8f88-d3c1dc783c35@measurement-factory.com>

On 2024-03-06 09:48, Jason Marshall wrote:

> We have been using squid (version?squid-5.5-6.el9_3.5) under RHEL9 as a 
> simple pass-through proxy without issue for the past month or so. 
> Recently our security team implemented an IPS product that intercepts 
> domain names known to be associated with malware and ransomware command 
> and control. Once this was in place, we started having issues with the 
> behavior of squid.
> 
> Through some troubleshooting, it appears that what is happening is that 
> that when a user's machine make a request through squid for one of these 
> bad domains, the request is dropped by the IPS, squid waits for the DNS 
> timeout, and then all requests made to squid after that result 
> in?NONE_NONE/500 errors, and it never seems to recover until we do a 
> restart or reload of the service.


DNS errors, including DNS query timeouts, are common, and Squid is 
supposed to handle them well. Assuming the DNS server is operational, 
what you describe sounds like a Squid bug. Lots of bugs were fixed since 
Squid v5.5, but I do not recall any single bug that would have such a 
drastic outcome.

Squid v5 is not supported by the Squid Project. I recommend upgrading to 
the latest Squid v6 and retesting.


HTH,

Alex.


> Initially the dns_timeout was set for 30 seconds. I reduced this, 
> thinking that perhaps requests were building up or something along those 
> lines. I set it to 5 seconds, but that just got us to a failure state 
> faster.
> 
> I also found the negative_dns_ttl setting and thought it might be having 
> an effect, but setting this to 0 seconds resulted in no change to the 
> behavior.
> 
> Are there any configuration tips that anyone can provide that might work 
> better with dropped/intercepted DNS requests? My current configuration 
> is included here:
> 
> acl localnet src 0.0.0.1-0.255.255.255? # RFC 1122 "this" network (LAN)
> acl localnet src 10.0.0.0/8 <http://10.0.0.0/8>? ? ? ? ? ? ?# RFC 1918 
> local private network (LAN)
> acl localnet src 100.64.0.0/10 <http://100.64.0.0/10>? ? ? ? ? # RFC 
> 6598 shared address space (CGN)
> acl localnet src 169.254.0.0/16 <http://169.254.0.0/16>? ? ? ? ?# RFC 
> 3927 link-local (directly plugged) machines
> acl localnet src 172.16.0.0/12 <http://172.16.0.0/12>? ? ? ? ? # RFC 
> 1918 local private network (LAN)
> acl localnet src 192.168.0.0/16 <http://192.168.0.0/16>? ? ? ? ?# RFC 
> 1918 local private network (LAN)
> 
> acl localnet src fc00::/7? ? ? ? ? ? ? ?# RFC 4193 local private network 
> range
> acl localnet src fe80::/10? ? ? ? ? ? ? # RFC 4291 link-local (directly 
> plugged) machines
> 
> acl SSL_ports port 443
> acl Safe_ports port 80? ? ? ? ? # http
> acl Safe_ports port 443? ? ? ? ?# https
> acl Safe_ports port 9191? ? ? ? # papercut
> http_access deny !Safe_ports
> http_access allow localhost manager
> http_access deny manager
> 
> http_access allow localnet
> http_access allow localhost
> http_access deny all
> http_port 0.0.0.0:3128 <http://0.0.0.0:3128>
> http_port 0.0.0.0:3129 <http://0.0.0.0:3129>
> cache deny all
> coredump_dir /var/spool/squid
> refresh_pattern ^ftp:? ? ? ? ? ?1440? ? 20%? ? ?10080
> refresh_pattern ^gopher:? ? ? ? 1440? ? 0%? ? ? 1440
> refresh_pattern -i (/cgi-bin/|\?) 0? ? ?0%? ? ? 0
> refresh_pattern .? ? ? ? ? ? ? ?0? ? ? ?20%? ? ?4320
> debug_options rotate=1 ALL,2
> negative_dns_ttl 0 seconds
> dns_timeout 5 seconds
> 
> Thank you for any help that you can provide.
> 
> Jason Marshall
> 
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> https://lists.squid-cache.org/listinfo/squid-users



From bpk678 at gmail.com  Wed Mar  6 16:16:23 2024
From: bpk678 at gmail.com (brendan kearney)
Date: Wed, 6 Mar 2024 11:16:23 -0500
Subject: [squid-users] Recommended squid settings when using IPS-based
 domain blocking
In-Reply-To: <321adc97-103d-493f-8f88-d3c1dc783c35@measurement-factory.com>
References: <CAG8TTAbNxZKKxJgWR9Kcpf3b0vnafaNWbnthjitsS-sNNerpyg@mail.gmail.com>
 <321adc97-103d-493f-8f88-d3c1dc783c35@measurement-factory.com>
Message-ID: <CAARxGtj=a=rn36XGVW1ue3aGNph0qjHQbw0f7OnX+wSzMQGafg@mail.gmail.com>

tell the team that is running the IPS to change their policy from DROP
to something else, so you are not a captive audience to the timeout.
By sending a RST, they can cause Squid to close the connection and
fail faster.  if they are intercepting the DNS request, have them
leverage an RPZ and send a NXDOMAIN response.  there are probably
other options to consider, too, and a conversation about how to handle
these scenarios should have been had before they moved to a Prevent
posture.

in short they made decisions in a vacuum and didnt include all
impacted teams (up or downsteam) that their actions affected.  this,
as a policy problem, should be addressed with leadership.

HTH
brendan

On Wed, Mar 6, 2024 at 9:58?AM Alex Rousskov
<rousskov at measurement-factory.com> wrote:
>
> On 2024-03-06 09:48, Jason Marshall wrote:
>
> > We have been using squid (version squid-5.5-6.el9_3.5) under RHEL9 as a
> > simple pass-through proxy without issue for the past month or so.
> > Recently our security team implemented an IPS product that intercepts
> > domain names known to be associated with malware and ransomware command
> > and control. Once this was in place, we started having issues with the
> > behavior of squid.
> >
> > Through some troubleshooting, it appears that what is happening is that
> > that when a user's machine make a request through squid for one of these
> > bad domains, the request is dropped by the IPS, squid waits for the DNS
> > timeout, and then all requests made to squid after that result
> > in NONE_NONE/500 errors, and it never seems to recover until we do a
> > restart or reload of the service.
>
>
> DNS errors, including DNS query timeouts, are common, and Squid is
> supposed to handle them well. Assuming the DNS server is operational,
> what you describe sounds like a Squid bug. Lots of bugs were fixed since
> Squid v5.5, but I do not recall any single bug that would have such a
> drastic outcome.
>
> Squid v5 is not supported by the Squid Project. I recommend upgrading to
> the latest Squid v6 and retesting.
>
>
> HTH,
>
> Alex.
>
>
> > Initially the dns_timeout was set for 30 seconds. I reduced this,
> > thinking that perhaps requests were building up or something along those
> > lines. I set it to 5 seconds, but that just got us to a failure state
> > faster.
> >
> > I also found the negative_dns_ttl setting and thought it might be having
> > an effect, but setting this to 0 seconds resulted in no change to the
> > behavior.
> >
> > Are there any configuration tips that anyone can provide that might work
> > better with dropped/intercepted DNS requests? My current configuration
> > is included here:
> >
> > acl localnet src 0.0.0.1-0.255.255.255  # RFC 1122 "this" network (LAN)
> > acl localnet src 10.0.0.0/8 <http://10.0.0.0/8>             # RFC 1918
> > local private network (LAN)
> > acl localnet src 100.64.0.0/10 <http://100.64.0.0/10>          # RFC
> > 6598 shared address space (CGN)
> > acl localnet src 169.254.0.0/16 <http://169.254.0.0/16>         # RFC
> > 3927 link-local (directly plugged) machines
> > acl localnet src 172.16.0.0/12 <http://172.16.0.0/12>          # RFC
> > 1918 local private network (LAN)
> > acl localnet src 192.168.0.0/16 <http://192.168.0.0/16>         # RFC
> > 1918 local private network (LAN)
> >
> > acl localnet src fc00::/7               # RFC 4193 local private network
> > range
> > acl localnet src fe80::/10              # RFC 4291 link-local (directly
> > plugged) machines
> >
> > acl SSL_ports port 443
> > acl Safe_ports port 80          # http
> > acl Safe_ports port 443         # https
> > acl Safe_ports port 9191        # papercut
> > http_access deny !Safe_ports
> > http_access allow localhost manager
> > http_access deny manager
> >
> > http_access allow localnet
> > http_access allow localhost
> > http_access deny all
> > http_port 0.0.0.0:3128 <http://0.0.0.0:3128>
> > http_port 0.0.0.0:3129 <http://0.0.0.0:3129>
> > cache deny all
> > coredump_dir /var/spool/squid
> > refresh_pattern ^ftp:           1440    20%     10080
> > refresh_pattern ^gopher:        1440    0%      1440
> > refresh_pattern -i (/cgi-bin/|\?) 0     0%      0
> > refresh_pattern .               0       20%     4320
> > debug_options rotate=1 ALL,2
> > negative_dns_ttl 0 seconds
> > dns_timeout 5 seconds
> >
> > Thank you for any help that you can provide.
> >
> > Jason Marshall
> >
> > _______________________________________________
> > squid-users mailing list
> > squid-users at lists.squid-cache.org
> > https://lists.squid-cache.org/listinfo/squid-users
>
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> https://lists.squid-cache.org/listinfo/squid-users


From s_p_arun at yahoo.com  Thu Mar  7 00:24:48 2024
From: s_p_arun at yahoo.com (Arun Kumar)
Date: Thu, 7 Mar 2024 00:24:48 +0000 (UTC)
Subject: [squid-users] Any Python ICAP server available
References: <1152541294.1298339.1709771088012.ref@mail.yahoo.com>
Message-ID: <1152541294.1298339.1709771088012@mail.yahoo.com>

The ICAP-Server(Python) mentioned in this page, seems to be very old. Any other squid compatible ICAP server available?
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20240307/d8a4ca17/attachment.htm>

From gtaylor at tnetconsulting.net  Thu Mar  7 02:21:05 2024
From: gtaylor at tnetconsulting.net (Grant Taylor)
Date: Wed, 6 Mar 2024 20:21:05 -0600
Subject: [squid-users] Recommended squid settings when using IPS-based
 domain blocking
In-Reply-To: <CAG8TTAbNxZKKxJgWR9Kcpf3b0vnafaNWbnthjitsS-sNNerpyg@mail.gmail.com>
References: <CAG8TTAbNxZKKxJgWR9Kcpf3b0vnafaNWbnthjitsS-sNNerpyg@mail.gmail.com>
Message-ID: <036278e7-09c4-4d49-85e6-8d36086fab62@tnetconsulting.net>

On 3/6/24 08:48, Jason Marshall wrote:
> We have been using squid (version?squid-5.5-6.el9_3.5) under RHEL9 as a 
> simple pass-through proxy without issue for the past month or so. 
> Recently our security team implemented an IPS product that intercepts 
> domain names known to be associated with malware and ransomware command 
> and control. Once this was in place, we started having issues with the 
> behavior of squid.

Can you get a feed of the verboten domains from the team and configure 
Squid to block such requests, thereby eliminating the need to do the DNS 
lookup?



-- 
Grant. . . .
-------------- next part --------------
A non-text attachment was scrubbed...
Name: smime.p7s
Type: application/pkcs7-signature
Size: 4033 bytes
Desc: S/MIME Cryptographic Signature
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20240306/a024d20e/attachment.bin>

From anitha.m at hpe.com  Thu Mar  7 17:20:17 2024
From: anitha.m at hpe.com (M, Anitha (CSS))
Date: Thu, 7 Mar 2024 17:20:17 +0000
Subject: [squid-users] Squid Proxy timing out 500/503 errors
In-Reply-To: <c77c1794-8061-4e97-91fc-242da06574b9@treenet.co.nz>
References: <DM4PR84MB3032E6F81C06FE29B158E56D90222@DM4PR84MB3032.NAMPRD84.PROD.OUTLOOK.COM>
 <c77c1794-8061-4e97-91fc-242da06574b9@treenet.co.nz>
Message-ID: <DM4PR84MB3032BF389F49D52CC5CBBFB190202@DM4PR84MB3032.NAMPRD84.PROD.OUTLOOK.COM>

Hi Team,

Thanks for the  quick response. 

We have cleaned up the squid configuration file  as per the below feedback. 
Pls review the below file.  

Pls note, even with below changes we still have 503/500 errors when squid is loaded up with 300+ requests.  Would really help if any other insights on this issue. 

=======================================
# Recommended minimum configuration:
acl localnet src 172.28.1.0/24
acl localnet src 172.28.4.0/24
acl localnet src 172.28.0.0/24

acl localnet src 0.0.0.1-0.255.255.255  # RFC 1122 "this" network (LAN)
acl localnet src 10.0.0.0/8             # RFC 1918 local private network (LAN)
acl localnet src 100.64.0.0/10          # RFC 6598 shared address space (CGN)
acl localnet src 169.254.0.0/16         # RFC 3927 link-local (directly plugged) machines
acl localnet src 172.28.11.0/24
acl localnet src 172.16.117.0/24
acl localnet src 20.20.30.0/21

acl parent_proxy_exclude dst 20.20.30.0/21
acl servicenet dst 172.28.4.0/24
#acl parent_proxy_exclude_ST0100 dst 20.20.30.222/22
#always_direct allow parent_proxy_exclude_ST0100

always_direct allow parent_proxy_exclude
always_direct allow servicenet

acl blocksites url_regex "/etc/squid/blocksites"
http_access deny blocksites

#debug_options ALL,5

acl SSL_ports port 443
acl SSL_ports port 8071
acl SSL_ports port 11052
acl Safe_ports port 80          # http
acl Safe_ports port 21          # ftp
acl Safe_ports port 443         # https
acl Safe_ports port 70          # gopher
acl Safe_ports port 210         # wais
acl Safe_ports port 1025-65535  # unregistered ports
acl Safe_ports port 280         # http-mgmt
acl Safe_ports port 488         # gss-http
acl Safe_ports port 591         # filemaker
acl Safe_ports port 777         # multiling http
acl Safe_ports port 53          # pdns
acl Safe_ports port 5300        # pdns
acl Safe_ports port 123     #NTP
acl Safe_ports port 8071
acl Safe_ports port 11052       # pdns web server
acl Safe_ports port 514         # rsyslog
acl Safe_ports port 8200
acl SSL_ports port 8053
acl Safe_ports port 8053
acl SSL_ports port 3002
acl Safe_ports port 3002
acl SSL_ports port 3006
acl Safe_ports port 3006
acl SSL_ports port 8203
acl Safe_ports port 8203
acl SSL_ports port 8204
acl Safe_ports port 8204
acl SSL_ports port 8099
acl SSL_ports port 8099
acl SSL_ports port 8282
acl Safe_ports port 8282
acl SSL_ports port 8200
acl Safe_ports port 8200

acl CONNECT method CONNECT


tcp_outgoing_address 20.20.30.3

#
# Recommended minimum Access Permission configuration:
#
# Deny requests to certain unsafe ports
http_access deny !Safe_ports

# Deny CONNECT to other than secure SSL ports
http_access deny CONNECT !SSL_ports

# Only allow cachemgr access from localhost
http_access allow localhost manager
http_access deny manager

# We strongly recommend the following be uncommented to protect innocent
# web applications running on the proxy server who think the only
# one who can access services on "localhost" is a local user
#http_access deny to_localhost

#
# INSERT YOUR OWN RULE(S) HERE TO ALLOW ACCESS FROM YOUR CLIENTS
#

# Example rule allowing access from your local networks.
# Adapt localnet in the ACL section to list your (internal) IP networks
# from where browsing should be allowed
http_access allow localnet
http_access allow localhost

# And finally deny all other access to this proxy
http_access deny all

cache_peer proxy-in.its.hpecorp.net parent 443 0 no-query default
acl parent_proxy src all
http_access allow parent_proxy
never_direct allow parent_proxy

# Squid normally listens to port 3128
http_port 3128

# Leave coredumps in the first cache dir
coredump_dir /var/cache/squid

#
# Add any of your own refresh_pattern entries above these.
#
refresh_pattern ^ftp:           1440    20%     10080
refresh_pattern ^gopher:        1440    0%      1440
refresh_pattern -i (/cgi-bin/|\?) 0     0%      0
refresh_pattern .               0       20%     4320

dns_nameservers 172.28.0.121 16.110.135.52

max_filedescriptors 64000
cache_dir ufs /var/cache/squid 8192 16 256
cache_mem 2096 MB
cache_swap_high 95
cache_swap_low 90
ftp_passive on
maximum_object_size 4096 MB
memory_replacement_policy lru
minimum_object_size 0 KB

=========================================

Regards,
Anitha. 

-----Original Message-----
From: squid-users <squid-users-bounces at lists.squid-cache.org> On Behalf Of Amos Jeffries
Sent: Wednesday, March 6, 2024 1:07 PM
To: squid-users at lists.squid-cache.org
Subject: Re: [squid-users] Squid Proxy timing out 500/503 errors

On 6/03/24 07:23, M, Anitha (CSS) wrote:
> Hi team,
> 
> We are using squid service deployed as a KVM VM on SLES 15 Sp5 os image.
> 
> We are using squid. Rpm: *squid-5.7-150400.3.20.1.x86_64*
> 
> **
> 
> We are seeing too many 503 errors with this version of squid.
> 
> This is the squid configuration file. Pls review it and let us know if 
> issues.
> 

It appears that your configuration file consists of at least 2 different configuration files appended to each other.

Please start by running "squid -k parse" and fixing all the warnings it should produce.


> We are performing squid scale testing, where every secs there will be 
> 200+requests reaching the squid and squid is spitting out 500/503 errors.
> 

FYI: you have restricted Squid to no more than 3200 filedescriptors. 
That is rather low. I recommend at least 64K.


> Squid.conf:
> 
> gl-pcesreblr-squidproxy03:/var/log/squid # cat /etc/squid/squid.conf
> # Recommended minimum configuration:
> acl localnet src 172.28.1.0/24
> acl localnet src 172.28.4.0/24
> acl localnet src 172.28.0.0/24
> acl localnet src 172.28.0.12/32
> connect_timeout 120 seconds
> connect_retries 10
> #debug_options ALL,5
> #connect_retries_delay 5 seconds
> acl localnet src 0.0.0.1-0.255.255.255? # RFC 1122 "this" network (LAN)
> acl localnet src 10.0.0.0/8???????????? # RFC 1918 local private network 
> (LAN)
> acl localnet src 100.64.0.0/10????????? # RFC 6598 shared address space 
> (CGN)
> acl localnet src 169.254.0.0/16???????? # RFC 3927 link-local (directly 
> plugged) machines
> acl localnet src 172.28.11.0/24
> #acl localnet src 172.16.0.0/12???????? # RFC 1918 local private network 
> (LAN)
> #acl localnet src 192.168.0.0/16??????????????? # RFC 1918 local private 
> network (LAN)
> #acl localnet src fc00::/7????????????? # RFC 4193 local private network 
> range
> #acl localnet src fe80::/10???????????? # RFC 4291 link-local (directly 
> plugged) machines
> 
> acl blocksites url_regex "/etc/squid/blocksites"
> http_access deny blocksites
> 
> debug_options ALL,7
> 
> acl SSL_ports port 443
> acl SSL_ports port 8071
> acl SSL_ports port 11052
> acl Safe_ports port 80????????? # http
> acl Safe_ports port 21????????? # ftp
> acl Safe_ports port 443???????? # https
> acl Safe_ports port 70????????? # gopher
> acl Safe_ports port 210???????? # wais
> acl Safe_ports port 1025-65535? # unregistered ports
> acl Safe_ports port 280???????? # http-mgmt
> acl Safe_ports port 488???????? # gss-http
> acl Safe_ports port 591???????? # filemaker
> acl Safe_ports port 777???????? # multiling http
> acl Safe_ports port 53????????? # pdns
> acl Safe_ports port 5300??????? # pdns
> acl Safe_ports port 123???? #NTP
> acl Safe_ports port 8071
> acl Safe_ports port 11052?????? # pdns web server
> acl Safe_ports port 514???????? # rsyslog
> acl CONNECT method CONNECT
> acl SSL_ports port 8053
> acl Safe_ports port 8053
> acl SSL_ports port 3002
> acl Safe_ports port 3002
> acl SSL_ports port 3006
> acl Safe_ports port 3006
> acl SSL_ports port 8203
> acl Safe_ports port 8203
> acl SSL_ports port 8204
> acl Safe_ports port 8204
> acl SSL_ports port 8071
> acl Safe_ports port 8071
> acl Safe_ports port 8200
> acl SSL_ports port 8099
> acl Safe_ports port 8099
> tcp_outgoing_address 20.20.30.5
> 
> #
> # Recommended minimum Access Permission configuration:
> #
> # Deny requests to certain unsafe ports
> http_access deny !Safe_ports
> 
> # Deny CONNECT to other than secure SSL ports
> http_access deny CONNECT !SSL_ports
> 
> # Only allow cachemgr access from localhost
> http_access allow localhost manager
> http_access deny manager
> 
> # We strongly recommend the following be uncommented to protect innocent
> # web applications running on the proxy server who think the only
> # one who can access services on "localhost" is a local user
> #http_access deny to_localhost
> 
> #
> # INSERT YOUR OWN RULE(S) HERE TO ALLOW ACCESS FROM YOUR CLIENTS
> #

Please notice what the above line says.

> 
> # Example rule allowing access from your local networks.
> # Adapt localnet in the ACL section to list your (internal) IP networks
> # from where browsing should be allowed
> http_access allow localnet
> http_access allow localhost
> 
> # And finally deny all other access to this proxy
> #http_access deny all
> #http_access allow all
> 
> cache_peer proxy-in.its.hpecorp.net parent 443 0 no-query no-delay default

... so a server listening for plain-text HTTP on port 443. That is a bit 
broken. At least consider enabling TLS/SSL on connections to this peer 
so Squid can send it HTTPS traffic.


> #cache_peer 16.242.46.11 parent 8080 0 no-query default
> #cache_peer 10.132.100.29 parent 3128 0 no-query default
> 
> acl parent_proxy src all
> http_access allow parent_proxy

The above two lines are identical to:
   http_access allow all

... no http_access lines following this one will ever have any effects.

> never_direct allow parent_proxy

Likewise same as:
   never_direct allow all

... however you have always_direct rules later that override this.

> 
> # Squid normally listens to port 3128
> http_port 3128
> 
> # Leave coredumps in the first cache dir
> coredump_dir /var/cache/squid
> 
> #
> # Add any of your own refresh_pattern entries above these.
> #
> refresh_pattern ^ftp:?????????? 1440??? 20%???? 10080
> refresh_pattern ^gopher:??????? 1440??? 0%????? 1440
> refresh_pattern -i (/cgi-bin/|\?) 0???? 0%????? 0
> refresh_pattern .?????????????? 0?????? 20%???? 4320
> 
> dns_nameservers 172.28.0.121 16.110.135.52
> 
> max_filedescriptors 3200
> cache_dir ufs /var/cache/squid 8192 16 256
> cache_mem 2096 MB
> cache_swap_high 95
> cache_swap_low 90
> ftp_passive on
> maximum_object_size 4096 MB
> memory_replacement_policy lru
> minimum_object_size 0 KB
> 

At this point your file just starts repeating rules, with different 
settings. Some of these replace the above settings, some append to the, 
and some have no effect due to earlier rules.


> # Recommended minimum configuration:
> acl localnet src 172.28.4.0/24
> acl localnet src 172.28.0.0/24
> acl localnet src 172.28.1.0/24 # OOBM Network outbound access
> #acl HOGAN dst hogan.nimblestorage.com
> acl localnet src 0.0.0.1-0.255.255.255 # RFC 1122 ?this? network (LAN)
> acl blocksites url_regex ?/etc/squid/blocksites?
> http_access deny blocksites
> acl SSL_ports port 443
> acl SSL_ports port 8071
> acl SSL_ports port 11052
> acl SSL_ports port 8200
> acl SSL_ports port 8282
> acl Safe_ports port 8282
> #acl HOGAN_port port 2222 # hogan.nimblestorage.com:2222 SSH support tunnel
> # Example rule allowing access from your local networks.
> # Adapt localnet in the ACL section to list your (internal) IP networks
> # from where browsing should be allowed
> acl localnet src 172.16.117.0/24
> http_access allow localnet
> http_access allow localhost
> #http_access allow HOGAN HOGAN_port
> acl localnet src 20.20.30.0/21
> acl parent_proxy_exclude dst 20.20.30.0/21
> acl parent_proxy_exclude_ST0100 dst 20.20.30.222/22
> always_direct allow parent_proxy_exclude_ST0100
> acl servicenet dst 172.28.4.0/24
> always_direct allow parent_proxy_exclude
> always_direct allow servicenet
> 


HTH
Amos

_______________________________________________
squid-users mailing list
squid-users at lists.squid-cache.org
https://lists.squid-cache.org/listinfo/squid-users 

From yvain.payen at tessi.fr  Fri Mar  8 14:06:00 2024
From: yvain.payen at tessi.fr (Yvain PAYEN)
Date: Fri, 8 Mar 2024 14:06:00 +0000
Subject: [squid-users] Squid Proxy timing out 500/503 errors
In-Reply-To: <DM4PR84MB3032BF389F49D52CC5CBBFB190202@DM4PR84MB3032.NAMPRD84.PROD.OUTLOOK.COM>
References: <DM4PR84MB3032E6F81C06FE29B158E56D90222@DM4PR84MB3032.NAMPRD84.PROD.OUTLOOK.COM>
 <c77c1794-8061-4e97-91fc-242da06574b9@treenet.co.nz>
 <DM4PR84MB3032BF389F49D52CC5CBBFB190202@DM4PR84MB3032.NAMPRD84.PROD.OUTLOOK.COM>
Message-ID: <DB9PR07MB98092ED341C8C0191B5CED129C272@DB9PR07MB9809.eurprd07.prod.outlook.com>

Hi Anitha,

Please check with "cat /proc/(pid)/limits" the Max open files limit for your squid process.
You can also use "squidclient mgr:info" to display File descriptor usage by squid.

Regards,

Yvain PAYEN
Tessi France

-----Message d'origine-----
De?: squid-users <squid-users-bounces at lists.squid-cache.org> De la part de M, Anitha (CSS)
Envoy??: jeudi 7 mars 2024 18:20
??: Amos Jeffries <squid3 at treenet.co.nz>; squid-users at lists.squid-cache.org
Cc?: Gopalsamy, Seetharam <seetharam.gopalsamy at hpe.com>; Ambikapathy, Baskaran <baskaran.ambikapathy at hpe.com>; TS, Savitha <savitha.ts at hpe.com>
Objet?: Re: [squid-users] Squid Proxy timing out 500/503 errors

? FR : Ce message provient de l'ext?rieur de l'organisation. N'ouvrez pas de liens ou de pi?ces jointes ? moins que vous ne sachiez que le contenu est fiable.  ?



Hi Team,

Thanks for the  quick response.

We have cleaned up the squid configuration file  as per the below feedback.
Pls review the below file.

Pls note, even with below changes we still have 503/500 errors when squid is loaded up with 300+ requests.  Would really help if any other insights on this issue.

=======================================
# Recommended minimum configuration:
acl localnet src 172.28.1.0/24
acl localnet src 172.28.4.0/24
acl localnet src 172.28.0.0/24

acl localnet src 0.0.0.1-0.255.255.255  # RFC 1122 "this" network (LAN)
acl localnet src 10.0.0.0/8             # RFC 1918 local private network (LAN)
acl localnet src 100.64.0.0/10          # RFC 6598 shared address space (CGN)
acl localnet src 169.254.0.0/16         # RFC 3927 link-local (directly plugged) machines
acl localnet src 172.28.11.0/24
acl localnet src 172.16.117.0/24
acl localnet src 20.20.30.0/21

acl parent_proxy_exclude dst 20.20.30.0/21 acl servicenet dst 172.28.4.0/24 #acl parent_proxy_exclude_ST0100 dst 20.20.30.222/22 #always_direct allow parent_proxy_exclude_ST0100

always_direct allow parent_proxy_exclude always_direct allow servicenet

acl blocksites url_regex "/etc/squid/blocksites"
http_access deny blocksites

#debug_options ALL,5

acl SSL_ports port 443
acl SSL_ports port 8071
acl SSL_ports port 11052
acl Safe_ports port 80          # http
acl Safe_ports port 21          # ftp
acl Safe_ports port 443         # https
acl Safe_ports port 70          # gopher
acl Safe_ports port 210         # wais
acl Safe_ports port 1025-65535  # unregistered ports
acl Safe_ports port 280         # http-mgmt
acl Safe_ports port 488         # gss-http
acl Safe_ports port 591         # filemaker
acl Safe_ports port 777         # multiling http
acl Safe_ports port 53          # pdns
acl Safe_ports port 5300        # pdns
acl Safe_ports port 123     #NTP
acl Safe_ports port 8071
acl Safe_ports port 11052       # pdns web server
acl Safe_ports port 514         # rsyslog
acl Safe_ports port 8200
acl SSL_ports port 8053
acl Safe_ports port 8053
acl SSL_ports port 3002
acl Safe_ports port 3002
acl SSL_ports port 3006
acl Safe_ports port 3006
acl SSL_ports port 8203
acl Safe_ports port 8203
acl SSL_ports port 8204
acl Safe_ports port 8204
acl SSL_ports port 8099
acl SSL_ports port 8099
acl SSL_ports port 8282
acl Safe_ports port 8282
acl SSL_ports port 8200
acl Safe_ports port 8200

acl CONNECT method CONNECT


tcp_outgoing_address 20.20.30.3

#
# Recommended minimum Access Permission configuration:
#
# Deny requests to certain unsafe ports
http_access deny !Safe_ports

# Deny CONNECT to other than secure SSL ports http_access deny CONNECT !SSL_ports

# Only allow cachemgr access from localhost http_access allow localhost manager http_access deny manager

# We strongly recommend the following be uncommented to protect innocent # web applications running on the proxy server who think the only # one who can access services on "localhost" is a local user #http_access deny to_localhost

#
# INSERT YOUR OWN RULE(S) HERE TO ALLOW ACCESS FROM YOUR CLIENTS #

# Example rule allowing access from your local networks.
# Adapt localnet in the ACL section to list your (internal) IP networks # from where browsing should be allowed http_access allow localnet http_access allow localhost

# And finally deny all other access to this proxy http_access deny all

cache_peer proxy-in.its.hpecorp.net parent 443 0 no-query default acl parent_proxy src all http_access allow parent_proxy never_direct allow parent_proxy

# Squid normally listens to port 3128
http_port 3128

# Leave coredumps in the first cache dir coredump_dir /var/cache/squid

#
# Add any of your own refresh_pattern entries above these.
#
refresh_pattern ^ftp:           1440    20%     10080
refresh_pattern ^gopher:        1440    0%      1440
refresh_pattern -i (/cgi-bin/|\?) 0     0%      0
refresh_pattern .               0       20%     4320

dns_nameservers 172.28.0.121 16.110.135.52

max_filedescriptors 64000
cache_dir ufs /var/cache/squid 8192 16 256 cache_mem 2096 MB cache_swap_high 95 cache_swap_low 90 ftp_passive on maximum_object_size 4096 MB memory_replacement_policy lru minimum_object_size 0 KB

=========================================

Regards,
Anitha.

-----Original Message-----
From: squid-users <squid-users-bounces at lists.squid-cache.org> On Behalf Of Amos Jeffries
Sent: Wednesday, March 6, 2024 1:07 PM
To: squid-users at lists.squid-cache.org
Subject: Re: [squid-users] Squid Proxy timing out 500/503 errors

On 6/03/24 07:23, M, Anitha (CSS) wrote:
> Hi team,
>
> We are using squid service deployed as a KVM VM on SLES 15 Sp5 os image.
>
> We are using squid. Rpm: *squid-5.7-150400.3.20.1.x86_64*
>
> **
>
> We are seeing too many 503 errors with this version of squid.
>
> This is the squid configuration file. Pls review it and let us know if 
> issues.
>

It appears that your configuration file consists of at least 2 different configuration files appended to each other.

Please start by running "squid -k parse" and fixing all the warnings it should produce.


> We are performing squid scale testing, where every secs there will be
> 200+requests reaching the squid and squid is spitting out 500/503 errors.
>

FYI: you have restricted Squid to no more than 3200 filedescriptors.
That is rather low. I recommend at least 64K.


> Squid.conf:
>
> gl-pcesreblr-squidproxy03:/var/log/squid # cat /etc/squid/squid.conf # 
> Recommended minimum configuration:
> acl localnet src 172.28.1.0/24
> acl localnet src 172.28.4.0/24
> acl localnet src 172.28.0.0/24
> acl localnet src 172.28.0.12/32
> connect_timeout 120 seconds
> connect_retries 10
> #debug_options ALL,5
> #connect_retries_delay 5 seconds
> acl localnet src 0.0.0.1-0.255.255.255  # RFC 1122 "this" network (LAN)
> acl localnet src 10.0.0.0/8             # RFC 1918 local private network
> (LAN)
> acl localnet src 100.64.0.0/10          # RFC 6598 shared address space
> (CGN)
> acl localnet src 169.254.0.0/16         # RFC 3927 link-local (directly
> plugged) machines
> acl localnet src 172.28.11.0/24
> #acl localnet src 172.16.0.0/12         # RFC 1918 local private network
> (LAN)
> #acl localnet src 192.168.0.0/16                # RFC 1918 local private
> network (LAN)
> #acl localnet src fc00::/7              # RFC 4193 local private network
> range
> #acl localnet src fe80::/10             # RFC 4291 link-local (directly
> plugged) machines
>
> acl blocksites url_regex "/etc/squid/blocksites"
> http_access deny blocksites
>
> debug_options ALL,7
>
> acl SSL_ports port 443
> acl SSL_ports port 8071
> acl SSL_ports port 11052
> acl Safe_ports port 80          # http
> acl Safe_ports port 21          # ftp
> acl Safe_ports port 443         # https
> acl Safe_ports port 70          # gopher
> acl Safe_ports port 210         # wais
> acl Safe_ports port 1025-65535  # unregistered ports
> acl Safe_ports port 280         # http-mgmt
> acl Safe_ports port 488         # gss-http
> acl Safe_ports port 591         # filemaker
> acl Safe_ports port 777         # multiling http
> acl Safe_ports port 53          # pdns
> acl Safe_ports port 5300        # pdns
> acl Safe_ports port 123     #NTP
> acl Safe_ports port 8071
> acl Safe_ports port 11052       # pdns web server
> acl Safe_ports port 514         # rsyslog
> acl CONNECT method CONNECT
> acl SSL_ports port 8053
> acl Safe_ports port 8053
> acl SSL_ports port 3002
> acl Safe_ports port 3002
> acl SSL_ports port 3006
> acl Safe_ports port 3006
> acl SSL_ports port 8203
> acl Safe_ports port 8203
> acl SSL_ports port 8204
> acl Safe_ports port 8204
> acl SSL_ports port 8071
> acl Safe_ports port 8071
> acl Safe_ports port 8200
> acl SSL_ports port 8099
> acl Safe_ports port 8099
> tcp_outgoing_address 20.20.30.5
>
> #
> # Recommended minimum Access Permission configuration:
> #
> # Deny requests to certain unsafe ports http_access deny !Safe_ports
>
> # Deny CONNECT to other than secure SSL ports http_access deny CONNECT 
> !SSL_ports
>
> # Only allow cachemgr access from localhost http_access allow 
> localhost manager http_access deny manager
>
> # We strongly recommend the following be uncommented to protect 
> innocent # web applications running on the proxy server who think the 
> only # one who can access services on "localhost" is a local user 
> #http_access deny to_localhost
>
> #
> # INSERT YOUR OWN RULE(S) HERE TO ALLOW ACCESS FROM YOUR CLIENTS #

Please notice what the above line says.

>
> # Example rule allowing access from your local networks.
> # Adapt localnet in the ACL section to list your (internal) IP 
> networks # from where browsing should be allowed http_access allow 
> localnet http_access allow localhost
>
> # And finally deny all other access to this proxy #http_access deny 
> all #http_access allow all
>
> cache_peer proxy-in.its.hpecorp.net parent 443 0 no-query no-delay 
> default

... so a server listening for plain-text HTTP on port 443. That is a bit broken. At least consider enabling TLS/SSL on connections to this peer so Squid can send it HTTPS traffic.


> #cache_peer 16.242.46.11 parent 8080 0 no-query default #cache_peer 
> 10.132.100.29 parent 3128 0 no-query default
>
> acl parent_proxy src all
> http_access allow parent_proxy

The above two lines are identical to:
   http_access allow all

... no http_access lines following this one will ever have any effects.

> never_direct allow parent_proxy

Likewise same as:
   never_direct allow all

... however you have always_direct rules later that override this.

>
> # Squid normally listens to port 3128
> http_port 3128
>
> # Leave coredumps in the first cache dir coredump_dir /var/cache/squid
>
> #
> # Add any of your own refresh_pattern entries above these.
> #
> refresh_pattern ^ftp:           1440    20%     10080
> refresh_pattern ^gopher:        1440    0%      1440
> refresh_pattern -i (/cgi-bin/|\?) 0     0%      0
> refresh_pattern .               0       20%     4320
>
> dns_nameservers 172.28.0.121 16.110.135.52
>
> max_filedescriptors 3200
> cache_dir ufs /var/cache/squid 8192 16 256 cache_mem 2096 MB 
> cache_swap_high 95 cache_swap_low 90 ftp_passive on 
> maximum_object_size 4096 MB memory_replacement_policy lru 
> minimum_object_size 0 KB
>

At this point your file just starts repeating rules, with different settings. Some of these replace the above settings, some append to the, and some have no effect due to earlier rules.


> # Recommended minimum configuration:
> acl localnet src 172.28.4.0/24
> acl localnet src 172.28.0.0/24
> acl localnet src 172.28.1.0/24 # OOBM Network outbound access #acl 
> HOGAN dst hogan.nimblestorage.com acl localnet src 
> 0.0.0.1-0.255.255.255 # RFC 1122 ?this? network (LAN) acl blocksites 
> url_regex ?/etc/squid/blocksites?
> http_access deny blocksites
> acl SSL_ports port 443
> acl SSL_ports port 8071
> acl SSL_ports port 11052
> acl SSL_ports port 8200
> acl SSL_ports port 8282
> acl Safe_ports port 8282
> #acl HOGAN_port port 2222 # hogan.nimblestorage.com:2222 SSH support 
> tunnel # Example rule allowing access from your local networks.
> # Adapt localnet in the ACL section to list your (internal) IP 
> networks # from where browsing should be allowed acl localnet src 
> 172.16.117.0/24 http_access allow localnet http_access allow localhost 
> #http_access allow HOGAN HOGAN_port acl localnet src 20.20.30.0/21 acl 
> parent_proxy_exclude dst 20.20.30.0/21 acl parent_proxy_exclude_ST0100 
> dst 20.20.30.222/22 always_direct allow parent_proxy_exclude_ST0100 
> acl servicenet dst 172.28.4.0/24 always_direct allow 
> parent_proxy_exclude always_direct allow servicenet
>


HTH
Amos

_______________________________________________
squid-users mailing list
squid-users at lists.squid-cache.org
https://lists.squid-cache.org/listinfo/squid-users
_______________________________________________
squid-users mailing list
squid-users at lists.squid-cache.org
https://lists.squid-cache.org/listinfo/squid-users

From anitha.m at hpe.com  Fri Mar  8 14:21:44 2024
From: anitha.m at hpe.com (M, Anitha (CSS))
Date: Fri, 8 Mar 2024 14:21:44 +0000
Subject: [squid-users] Squid Proxy timing out 500/503 errors
In-Reply-To: <DB9PR07MB98092ED341C8C0191B5CED129C272@DB9PR07MB9809.eurprd07.prod.outlook.com>
References: <DM4PR84MB3032E6F81C06FE29B158E56D90222@DM4PR84MB3032.NAMPRD84.PROD.OUTLOOK.COM>
 <c77c1794-8061-4e97-91fc-242da06574b9@treenet.co.nz>
 <DM4PR84MB3032BF389F49D52CC5CBBFB190202@DM4PR84MB3032.NAMPRD84.PROD.OUTLOOK.COM>
 <DB9PR07MB98092ED341C8C0191B5CED129C272@DB9PR07MB9809.eurprd07.prod.outlook.com>
Message-ID: <DM4PR84MB3032B44A967B60FE84FCF94990272@DM4PR84MB3032.NAMPRD84.PROD.OUTLOOK.COM>

Hi, 
 I used squidclient mgr:info to get the usage, and see enough available descriptors.

File descriptor usage for squid:
        Maximum number of file descriptors:   4096
        Largest file desc currently in use:   1885
        Number of file desc currently in use: 1879
        Files queued for open:                   0
        Available number of file descriptors: 2217
        Reserved number of file descriptors:   100
        Store Disk files open:                   0

Regards,
Anitha. 
-----Original Message-----
From: Yvain PAYEN <yvain.payen at tessi.fr> 
Sent: Friday, March 8, 2024 7:36 PM
To: M, Anitha (CSS) <anitha.m at hpe.com>; squid-users at lists.squid-cache.org
Subject: RE: [squid-users] Squid Proxy timing out 500/503 errors

Hi Anitha,

Please check with "cat /proc/(pid)/limits" the Max open files limit for your squid process.
You can also use "squidclient mgr:info" to display File descriptor usage by squid.

Regards,

Yvain PAYEN
Tessi France

-----Message d'origine-----
De?: squid-users <squid-users-bounces at lists.squid-cache.org> De la part de M, Anitha (CSS) Envoy??: jeudi 7 mars 2024 18:20 ??: Amos Jeffries <squid3 at treenet.co.nz>; squid-users at lists.squid-cache.org Cc?: Gopalsamy, Seetharam <seetharam.gopalsamy at hpe.com>; Ambikapathy, Baskaran <baskaran.ambikapathy at hpe.com>; TS, Savitha <savitha.ts at hpe.com> Objet?: Re: [squid-users] Squid Proxy timing out 500/503 errors

? FR : Ce message provient de l'ext?rieur de l'organisation. N'ouvrez pas de liens ou de pi?ces jointes ? moins que vous ne sachiez que le contenu est fiable.  ?



Hi Team,

Thanks for the  quick response.

We have cleaned up the squid configuration file  as per the below feedback.
Pls review the below file.

Pls note, even with below changes we still have 503/500 errors when squid is loaded up with 300+ requests.  Would really help if any other insights on this issue.

=======================================
# Recommended minimum configuration:
acl localnet src 172.28.1.0/24
acl localnet src 172.28.4.0/24
acl localnet src 172.28.0.0/24

acl localnet src 0.0.0.1-0.255.255.255  # RFC 1122 "this" network (LAN)
acl localnet src 10.0.0.0/8             # RFC 1918 local private network (LAN)
acl localnet src 100.64.0.0/10          # RFC 6598 shared address space (CGN)
acl localnet src 169.254.0.0/16         # RFC 3927 link-local (directly plugged) machines
acl localnet src 172.28.11.0/24
acl localnet src 172.16.117.0/24
acl localnet src 20.20.30.0/21

acl parent_proxy_exclude dst 20.20.30.0/21 acl servicenet dst 172.28.4.0/24 #acl parent_proxy_exclude_ST0100 dst 20.20.30.222/22 #always_direct allow parent_proxy_exclude_ST0100

always_direct allow parent_proxy_exclude always_direct allow servicenet

acl blocksites url_regex "/etc/squid/blocksites"
http_access deny blocksites

#debug_options ALL,5

acl SSL_ports port 443
acl SSL_ports port 8071
acl SSL_ports port 11052
acl Safe_ports port 80          # http
acl Safe_ports port 21          # ftp
acl Safe_ports port 443         # https
acl Safe_ports port 70          # gopher
acl Safe_ports port 210         # wais
acl Safe_ports port 1025-65535  # unregistered ports
acl Safe_ports port 280         # http-mgmt
acl Safe_ports port 488         # gss-http
acl Safe_ports port 591         # filemaker
acl Safe_ports port 777         # multiling http
acl Safe_ports port 53          # pdns
acl Safe_ports port 5300        # pdns
acl Safe_ports port 123     #NTP
acl Safe_ports port 8071
acl Safe_ports port 11052       # pdns web server
acl Safe_ports port 514         # rsyslog
acl Safe_ports port 8200
acl SSL_ports port 8053
acl Safe_ports port 8053
acl SSL_ports port 3002
acl Safe_ports port 3002
acl SSL_ports port 3006
acl Safe_ports port 3006
acl SSL_ports port 8203
acl Safe_ports port 8203
acl SSL_ports port 8204
acl Safe_ports port 8204
acl SSL_ports port 8099
acl SSL_ports port 8099
acl SSL_ports port 8282
acl Safe_ports port 8282
acl SSL_ports port 8200
acl Safe_ports port 8200

acl CONNECT method CONNECT


tcp_outgoing_address 20.20.30.3

#
# Recommended minimum Access Permission configuration:
#
# Deny requests to certain unsafe ports
http_access deny !Safe_ports

# Deny CONNECT to other than secure SSL ports http_access deny CONNECT !SSL_ports

# Only allow cachemgr access from localhost http_access allow localhost manager http_access deny manager

# We strongly recommend the following be uncommented to protect innocent # web applications running on the proxy server who think the only # one who can access services on "localhost" is a local user #http_access deny to_localhost

#
# INSERT YOUR OWN RULE(S) HERE TO ALLOW ACCESS FROM YOUR CLIENTS #

# Example rule allowing access from your local networks.
# Adapt localnet in the ACL section to list your (internal) IP networks # from where browsing should be allowed http_access allow localnet http_access allow localhost

# And finally deny all other access to this proxy http_access deny all

cache_peer proxy-in.its.hpecorp.net parent 443 0 no-query default acl parent_proxy src all http_access allow parent_proxy never_direct allow parent_proxy

# Squid normally listens to port 3128
http_port 3128

# Leave coredumps in the first cache dir coredump_dir /var/cache/squid

#
# Add any of your own refresh_pattern entries above these.
#
refresh_pattern ^ftp:           1440    20%     10080
refresh_pattern ^gopher:        1440    0%      1440
refresh_pattern -i (/cgi-bin/|\?) 0     0%      0
refresh_pattern .               0       20%     4320

dns_nameservers 172.28.0.121 16.110.135.52

max_filedescriptors 64000
cache_dir ufs /var/cache/squid 8192 16 256 cache_mem 2096 MB cache_swap_high 95 cache_swap_low 90 ftp_passive on maximum_object_size 4096 MB memory_replacement_policy lru minimum_object_size 0 KB

=========================================

Regards,
Anitha.

-----Original Message-----
From: squid-users <squid-users-bounces at lists.squid-cache.org> On Behalf Of Amos Jeffries
Sent: Wednesday, March 6, 2024 1:07 PM
To: squid-users at lists.squid-cache.org
Subject: Re: [squid-users] Squid Proxy timing out 500/503 errors

On 6/03/24 07:23, M, Anitha (CSS) wrote:
> Hi team,
>
> We are using squid service deployed as a KVM VM on SLES 15 Sp5 os image.
>
> We are using squid. Rpm: *squid-5.7-150400.3.20.1.x86_64*
>
> **
>
> We are seeing too many 503 errors with this version of squid.
>
> This is the squid configuration file. Pls review it and let us know if 
> issues.
>

It appears that your configuration file consists of at least 2 different configuration files appended to each other.

Please start by running "squid -k parse" and fixing all the warnings it should produce.


> We are performing squid scale testing, where every secs there will be
> 200+requests reaching the squid and squid is spitting out 500/503 errors.
>

FYI: you have restricted Squid to no more than 3200 filedescriptors.
That is rather low. I recommend at least 64K.


> Squid.conf:
>
> gl-pcesreblr-squidproxy03:/var/log/squid # cat /etc/squid/squid.conf # 
> Recommended minimum configuration:
> acl localnet src 172.28.1.0/24
> acl localnet src 172.28.4.0/24
> acl localnet src 172.28.0.0/24
> acl localnet src 172.28.0.12/32
> connect_timeout 120 seconds
> connect_retries 10
> #debug_options ALL,5
> #connect_retries_delay 5 seconds
> acl localnet src 0.0.0.1-0.255.255.255  # RFC 1122 "this" network (LAN)
> acl localnet src 10.0.0.0/8             # RFC 1918 local private network
> (LAN)
> acl localnet src 100.64.0.0/10          # RFC 6598 shared address space
> (CGN)
> acl localnet src 169.254.0.0/16         # RFC 3927 link-local (directly
> plugged) machines
> acl localnet src 172.28.11.0/24
> #acl localnet src 172.16.0.0/12         # RFC 1918 local private network
> (LAN)
> #acl localnet src 192.168.0.0/16                # RFC 1918 local private
> network (LAN)
> #acl localnet src fc00::/7              # RFC 4193 local private network
> range
> #acl localnet src fe80::/10             # RFC 4291 link-local (directly
> plugged) machines
>
> acl blocksites url_regex "/etc/squid/blocksites"
> http_access deny blocksites
>
> debug_options ALL,7
>
> acl SSL_ports port 443
> acl SSL_ports port 8071
> acl SSL_ports port 11052
> acl Safe_ports port 80          # http
> acl Safe_ports port 21          # ftp
> acl Safe_ports port 443         # https
> acl Safe_ports port 70          # gopher
> acl Safe_ports port 210         # wais
> acl Safe_ports port 1025-65535  # unregistered ports
> acl Safe_ports port 280         # http-mgmt
> acl Safe_ports port 488         # gss-http
> acl Safe_ports port 591         # filemaker
> acl Safe_ports port 777         # multiling http
> acl Safe_ports port 53          # pdns
> acl Safe_ports port 5300        # pdns
> acl Safe_ports port 123     #NTP
> acl Safe_ports port 8071
> acl Safe_ports port 11052       # pdns web server
> acl Safe_ports port 514         # rsyslog
> acl CONNECT method CONNECT
> acl SSL_ports port 8053
> acl Safe_ports port 8053
> acl SSL_ports port 3002
> acl Safe_ports port 3002
> acl SSL_ports port 3006
> acl Safe_ports port 3006
> acl SSL_ports port 8203
> acl Safe_ports port 8203
> acl SSL_ports port 8204
> acl Safe_ports port 8204
> acl SSL_ports port 8071
> acl Safe_ports port 8071
> acl Safe_ports port 8200
> acl SSL_ports port 8099
> acl Safe_ports port 8099
> tcp_outgoing_address 20.20.30.5
>
> #
> # Recommended minimum Access Permission configuration:
> #
> # Deny requests to certain unsafe ports http_access deny !Safe_ports
>
> # Deny CONNECT to other than secure SSL ports http_access deny CONNECT 
> !SSL_ports
>
> # Only allow cachemgr access from localhost http_access allow 
> localhost manager http_access deny manager
>
> # We strongly recommend the following be uncommented to protect 
> innocent # web applications running on the proxy server who think the 
> only # one who can access services on "localhost" is a local user 
> #http_access deny to_localhost
>
> #
> # INSERT YOUR OWN RULE(S) HERE TO ALLOW ACCESS FROM YOUR CLIENTS #

Please notice what the above line says.

>
> # Example rule allowing access from your local networks.
> # Adapt localnet in the ACL section to list your (internal) IP 
> networks # from where browsing should be allowed http_access allow 
> localnet http_access allow localhost
>
> # And finally deny all other access to this proxy #http_access deny 
> all #http_access allow all
>
> cache_peer proxy-in.its.hpecorp.net parent 443 0 no-query no-delay 
> default

... so a server listening for plain-text HTTP on port 443. That is a bit broken. At least consider enabling TLS/SSL on connections to this peer so Squid can send it HTTPS traffic.


> #cache_peer 16.242.46.11 parent 8080 0 no-query default #cache_peer
> 10.132.100.29 parent 3128 0 no-query default
>
> acl parent_proxy src all
> http_access allow parent_proxy

The above two lines are identical to:
   http_access allow all

... no http_access lines following this one will ever have any effects.

> never_direct allow parent_proxy

Likewise same as:
   never_direct allow all

... however you have always_direct rules later that override this.

>
> # Squid normally listens to port 3128
> http_port 3128
>
> # Leave coredumps in the first cache dir coredump_dir /var/cache/squid
>
> #
> # Add any of your own refresh_pattern entries above these.
> #
> refresh_pattern ^ftp:           1440    20%     10080
> refresh_pattern ^gopher:        1440    0%      1440
> refresh_pattern -i (/cgi-bin/|\?) 0     0%      0
> refresh_pattern .               0       20%     4320
>
> dns_nameservers 172.28.0.121 16.110.135.52
>
> max_filedescriptors 3200
> cache_dir ufs /var/cache/squid 8192 16 256 cache_mem 2096 MB 
> cache_swap_high 95 cache_swap_low 90 ftp_passive on 
> maximum_object_size 4096 MB memory_replacement_policy lru 
> minimum_object_size 0 KB
>

At this point your file just starts repeating rules, with different settings. Some of these replace the above settings, some append to the, and some have no effect due to earlier rules.


> # Recommended minimum configuration:
> acl localnet src 172.28.4.0/24
> acl localnet src 172.28.0.0/24
> acl localnet src 172.28.1.0/24 # OOBM Network outbound access #acl 
> HOGAN dst hogan.nimblestorage.com acl localnet src
> 0.0.0.1-0.255.255.255 # RFC 1122 ?this? network (LAN) acl blocksites 
> url_regex ?/etc/squid/blocksites?
> http_access deny blocksites
> acl SSL_ports port 443
> acl SSL_ports port 8071
> acl SSL_ports port 11052
> acl SSL_ports port 8200
> acl SSL_ports port 8282
> acl Safe_ports port 8282
> #acl HOGAN_port port 2222 # hogan.nimblestorage.com:2222 SSH support 
> tunnel # Example rule allowing access from your local networks.
> # Adapt localnet in the ACL section to list your (internal) IP 
> networks # from where browsing should be allowed acl localnet src
> 172.16.117.0/24 http_access allow localnet http_access allow localhost 
> #http_access allow HOGAN HOGAN_port acl localnet src 20.20.30.0/21 acl 
> parent_proxy_exclude dst 20.20.30.0/21 acl parent_proxy_exclude_ST0100 
> dst 20.20.30.222/22 always_direct allow parent_proxy_exclude_ST0100 
> acl servicenet dst 172.28.4.0/24 always_direct allow 
> parent_proxy_exclude always_direct allow servicenet
>


HTH
Amos

_______________________________________________
squid-users mailing list
squid-users at lists.squid-cache.org
https://lists.squid-cache.org/listinfo/squid-users
_______________________________________________
squid-users mailing list
squid-users at lists.squid-cache.org
https://lists.squid-cache.org/listinfo/squid-users 

From yvain.payen at tessi.fr  Fri Mar  8 14:30:55 2024
From: yvain.payen at tessi.fr (Yvain PAYEN)
Date: Fri, 8 Mar 2024 14:30:55 +0000
Subject: [squid-users] Squid Proxy timing out 500/503 errors
In-Reply-To: <DM4PR84MB3032B44A967B60FE84FCF94990272@DM4PR84MB3032.NAMPRD84.PROD.OUTLOOK.COM>
References: <DM4PR84MB3032E6F81C06FE29B158E56D90222@DM4PR84MB3032.NAMPRD84.PROD.OUTLOOK.COM>
 <c77c1794-8061-4e97-91fc-242da06574b9@treenet.co.nz>
 <DM4PR84MB3032BF389F49D52CC5CBBFB190202@DM4PR84MB3032.NAMPRD84.PROD.OUTLOOK.COM>
 <DB9PR07MB98092ED341C8C0191B5CED129C272@DB9PR07MB9809.eurprd07.prod.outlook.com>
 <DM4PR84MB3032B44A967B60FE84FCF94990272@DM4PR84MB3032.NAMPRD84.PROD.OUTLOOK.COM>
Message-ID: <DB9PR07MB980915044FDA21E7456C86149C272@DB9PR07MB9809.eurprd07.prod.outlook.com>

We can see with this output that your line max_filedescriptors 64000 is not working.
It can be your system that have a default limit of 4096 fd by process.

Personally I have created this file to setup the limit : 
root at myproxy:~$ cat /etc/security/limits.d/10-squid.conf
squid        soft    nofile  64000
squid        hard    nofile  65500

Note that it is on Ubuntu system, check how to manage limits on you system.

Regards,

Yvain PAYEN
Tessi France

-----Message d'origine-----
De?: M, Anitha (CSS) <anitha.m at hpe.com> 
Envoy??: vendredi 8 mars 2024 15:22
??: Yvain PAYEN <yvain.payen at tessi.fr>; squid-users at lists.squid-cache.org
Cc?: Ambikapathy, Baskaran <baskaran.ambikapathy at hpe.com>
Objet?: RE: [squid-users] Squid Proxy timing out 500/503 errors

? FR : Ce message provient de l'ext?rieur de l'organisation. N'ouvrez pas de liens ou de pi?ces jointes ? moins que vous ne sachiez que le contenu est fiable.  ?



Hi,
 I used squidclient mgr:info to get the usage, and see enough available descriptors.

File descriptor usage for squid:
        Maximum number of file descriptors:   4096
        Largest file desc currently in use:   1885
        Number of file desc currently in use: 1879
        Files queued for open:                   0
        Available number of file descriptors: 2217
        Reserved number of file descriptors:   100
        Store Disk files open:                   0

Regards,
Anitha.
-----Original Message-----
From: Yvain PAYEN <yvain.payen at tessi.fr>
Sent: Friday, March 8, 2024 7:36 PM
To: M, Anitha (CSS) <anitha.m at hpe.com>; squid-users at lists.squid-cache.org
Subject: RE: [squid-users] Squid Proxy timing out 500/503 errors

Hi Anitha,

Please check with "cat /proc/(pid)/limits" the Max open files limit for your squid process.
You can also use "squidclient mgr:info" to display File descriptor usage by squid.

Regards,

Yvain PAYEN
Tessi France

-----Message d'origine-----
De : squid-users <squid-users-bounces at lists.squid-cache.org> De la part de M, Anitha (CSS) Envoy? : jeudi 7 mars 2024 18:20 ? : Amos Jeffries <squid3 at treenet.co.nz>; squid-users at lists.squid-cache.org Cc : Gopalsamy, Seetharam <seetharam.gopalsamy at hpe.com>; Ambikapathy, Baskaran <baskaran.ambikapathy at hpe.com>; TS, Savitha <savitha.ts at hpe.com> Objet : Re: [squid-users] Squid Proxy timing out 500/503 errors

? FR : Ce message provient de l'ext?rieur de l'organisation. N'ouvrez pas de liens ou de pi?ces jointes ? moins que vous ne sachiez que le contenu est fiable.  ?



Hi Team,

Thanks for the  quick response.

We have cleaned up the squid configuration file  as per the below feedback.
Pls review the below file.

Pls note, even with below changes we still have 503/500 errors when squid is loaded up with 300+ requests.  Would really help if any other insights on this issue.

=======================================
# Recommended minimum configuration:
acl localnet src 172.28.1.0/24
acl localnet src 172.28.4.0/24
acl localnet src 172.28.0.0/24

acl localnet src 0.0.0.1-0.255.255.255  # RFC 1122 "this" network (LAN)
acl localnet src 10.0.0.0/8             # RFC 1918 local private network (LAN)
acl localnet src 100.64.0.0/10          # RFC 6598 shared address space (CGN)
acl localnet src 169.254.0.0/16         # RFC 3927 link-local (directly plugged) machines
acl localnet src 172.28.11.0/24
acl localnet src 172.16.117.0/24
acl localnet src 20.20.30.0/21

acl parent_proxy_exclude dst 20.20.30.0/21 acl servicenet dst 172.28.4.0/24 #acl parent_proxy_exclude_ST0100 dst 20.20.30.222/22 #always_direct allow parent_proxy_exclude_ST0100

always_direct allow parent_proxy_exclude always_direct allow servicenet

acl blocksites url_regex "/etc/squid/blocksites"
http_access deny blocksites

#debug_options ALL,5

acl SSL_ports port 443
acl SSL_ports port 8071
acl SSL_ports port 11052
acl Safe_ports port 80          # http
acl Safe_ports port 21          # ftp
acl Safe_ports port 443         # https
acl Safe_ports port 70          # gopher
acl Safe_ports port 210         # wais
acl Safe_ports port 1025-65535  # unregistered ports
acl Safe_ports port 280         # http-mgmt
acl Safe_ports port 488         # gss-http
acl Safe_ports port 591         # filemaker
acl Safe_ports port 777         # multiling http
acl Safe_ports port 53          # pdns
acl Safe_ports port 5300        # pdns
acl Safe_ports port 123     #NTP
acl Safe_ports port 8071
acl Safe_ports port 11052       # pdns web server
acl Safe_ports port 514         # rsyslog
acl Safe_ports port 8200
acl SSL_ports port 8053
acl Safe_ports port 8053
acl SSL_ports port 3002
acl Safe_ports port 3002
acl SSL_ports port 3006
acl Safe_ports port 3006
acl SSL_ports port 8203
acl Safe_ports port 8203
acl SSL_ports port 8204
acl Safe_ports port 8204
acl SSL_ports port 8099
acl SSL_ports port 8099
acl SSL_ports port 8282
acl Safe_ports port 8282
acl SSL_ports port 8200
acl Safe_ports port 8200

acl CONNECT method CONNECT


tcp_outgoing_address 20.20.30.3

#
# Recommended minimum Access Permission configuration:
#
# Deny requests to certain unsafe ports
http_access deny !Safe_ports

# Deny CONNECT to other than secure SSL ports http_access deny CONNECT !SSL_ports

# Only allow cachemgr access from localhost http_access allow localhost manager http_access deny manager

# We strongly recommend the following be uncommented to protect innocent # web applications running on the proxy server who think the only # one who can access services on "localhost" is a local user #http_access deny to_localhost

#
# INSERT YOUR OWN RULE(S) HERE TO ALLOW ACCESS FROM YOUR CLIENTS #

# Example rule allowing access from your local networks.
# Adapt localnet in the ACL section to list your (internal) IP networks # from where browsing should be allowed http_access allow localnet http_access allow localhost

# And finally deny all other access to this proxy http_access deny all

cache_peer proxy-in.its.hpecorp.net parent 443 0 no-query default acl parent_proxy src all http_access allow parent_proxy never_direct allow parent_proxy

# Squid normally listens to port 3128
http_port 3128

# Leave coredumps in the first cache dir coredump_dir /var/cache/squid

#
# Add any of your own refresh_pattern entries above these.
#
refresh_pattern ^ftp:           1440    20%     10080
refresh_pattern ^gopher:        1440    0%      1440
refresh_pattern -i (/cgi-bin/|\?) 0     0%      0
refresh_pattern .               0       20%     4320

dns_nameservers 172.28.0.121 16.110.135.52

max_filedescriptors 64000
cache_dir ufs /var/cache/squid 8192 16 256 cache_mem 2096 MB cache_swap_high 95 cache_swap_low 90 ftp_passive on maximum_object_size 4096 MB memory_replacement_policy lru minimum_object_size 0 KB

=========================================

Regards,
Anitha.

-----Original Message-----
From: squid-users <squid-users-bounces at lists.squid-cache.org> On Behalf Of Amos Jeffries
Sent: Wednesday, March 6, 2024 1:07 PM
To: squid-users at lists.squid-cache.org
Subject: Re: [squid-users] Squid Proxy timing out 500/503 errors

On 6/03/24 07:23, M, Anitha (CSS) wrote:
> Hi team,
>
> We are using squid service deployed as a KVM VM on SLES 15 Sp5 os image.
>
> We are using squid. Rpm: *squid-5.7-150400.3.20.1.x86_64*
>
> **
>
> We are seeing too many 503 errors with this version of squid.
>
> This is the squid configuration file. Pls review it and let us know if 
> issues.
>

It appears that your configuration file consists of at least 2 different configuration files appended to each other.

Please start by running "squid -k parse" and fixing all the warnings it should produce.


> We are performing squid scale testing, where every secs there will be
> 200+requests reaching the squid and squid is spitting out 500/503 errors.
>

FYI: you have restricted Squid to no more than 3200 filedescriptors.
That is rather low. I recommend at least 64K.


> Squid.conf:
>
> gl-pcesreblr-squidproxy03:/var/log/squid # cat /etc/squid/squid.conf # 
> Recommended minimum configuration:
> acl localnet src 172.28.1.0/24
> acl localnet src 172.28.4.0/24
> acl localnet src 172.28.0.0/24
> acl localnet src 172.28.0.12/32
> connect_timeout 120 seconds
> connect_retries 10
> #debug_options ALL,5
> #connect_retries_delay 5 seconds
> acl localnet src 0.0.0.1-0.255.255.255  # RFC 1122 "this" network (LAN)
> acl localnet src 10.0.0.0/8             # RFC 1918 local private network
> (LAN)
> acl localnet src 100.64.0.0/10          # RFC 6598 shared address space
> (CGN)
> acl localnet src 169.254.0.0/16         # RFC 3927 link-local (directly
> plugged) machines
> acl localnet src 172.28.11.0/24
> #acl localnet src 172.16.0.0/12         # RFC 1918 local private network
> (LAN)
> #acl localnet src 192.168.0.0/16                # RFC 1918 local private
> network (LAN)
> #acl localnet src fc00::/7              # RFC 4193 local private network
> range
> #acl localnet src fe80::/10             # RFC 4291 link-local (directly
> plugged) machines
>
> acl blocksites url_regex "/etc/squid/blocksites"
> http_access deny blocksites
>
> debug_options ALL,7
>
> acl SSL_ports port 443
> acl SSL_ports port 8071
> acl SSL_ports port 11052
> acl Safe_ports port 80          # http
> acl Safe_ports port 21          # ftp
> acl Safe_ports port 443         # https
> acl Safe_ports port 70          # gopher
> acl Safe_ports port 210         # wais
> acl Safe_ports port 1025-65535  # unregistered ports
> acl Safe_ports port 280         # http-mgmt
> acl Safe_ports port 488         # gss-http
> acl Safe_ports port 591         # filemaker
> acl Safe_ports port 777         # multiling http
> acl Safe_ports port 53          # pdns
> acl Safe_ports port 5300        # pdns
> acl Safe_ports port 123     #NTP
> acl Safe_ports port 8071
> acl Safe_ports port 11052       # pdns web server
> acl Safe_ports port 514         # rsyslog
> acl CONNECT method CONNECT
> acl SSL_ports port 8053
> acl Safe_ports port 8053
> acl SSL_ports port 3002
> acl Safe_ports port 3002
> acl SSL_ports port 3006
> acl Safe_ports port 3006
> acl SSL_ports port 8203
> acl Safe_ports port 8203
> acl SSL_ports port 8204
> acl Safe_ports port 8204
> acl SSL_ports port 8071
> acl Safe_ports port 8071
> acl Safe_ports port 8200
> acl SSL_ports port 8099
> acl Safe_ports port 8099
> tcp_outgoing_address 20.20.30.5
>
> #
> # Recommended minimum Access Permission configuration:
> #
> # Deny requests to certain unsafe ports http_access deny !Safe_ports
>
> # Deny CONNECT to other than secure SSL ports http_access deny CONNECT 
> !SSL_ports
>
> # Only allow cachemgr access from localhost http_access allow 
> localhost manager http_access deny manager
>
> # We strongly recommend the following be uncommented to protect 
> innocent # web applications running on the proxy server who think the 
> only # one who can access services on "localhost" is a local user 
> #http_access deny to_localhost
>
> #
> # INSERT YOUR OWN RULE(S) HERE TO ALLOW ACCESS FROM YOUR CLIENTS #

Please notice what the above line says.

>
> # Example rule allowing access from your local networks.
> # Adapt localnet in the ACL section to list your (internal) IP 
> networks # from where browsing should be allowed http_access allow 
> localnet http_access allow localhost
>
> # And finally deny all other access to this proxy #http_access deny 
> all #http_access allow all
>
> cache_peer proxy-in.its.hpecorp.net parent 443 0 no-query no-delay 
> default

... so a server listening for plain-text HTTP on port 443. That is a bit broken. At least consider enabling TLS/SSL on connections to this peer so Squid can send it HTTPS traffic.


> #cache_peer 16.242.46.11 parent 8080 0 no-query default #cache_peer
> 10.132.100.29 parent 3128 0 no-query default
>
> acl parent_proxy src all
> http_access allow parent_proxy

The above two lines are identical to:
   http_access allow all

... no http_access lines following this one will ever have any effects.

> never_direct allow parent_proxy

Likewise same as:
   never_direct allow all

... however you have always_direct rules later that override this.

>
> # Squid normally listens to port 3128
> http_port 3128
>
> # Leave coredumps in the first cache dir coredump_dir /var/cache/squid
>
> #
> # Add any of your own refresh_pattern entries above these.
> #
> refresh_pattern ^ftp:           1440    20%     10080
> refresh_pattern ^gopher:        1440    0%      1440
> refresh_pattern -i (/cgi-bin/|\?) 0     0%      0
> refresh_pattern .               0       20%     4320
>
> dns_nameservers 172.28.0.121 16.110.135.52
>
> max_filedescriptors 3200
> cache_dir ufs /var/cache/squid 8192 16 256 cache_mem 2096 MB 
> cache_swap_high 95 cache_swap_low 90 ftp_passive on 
> maximum_object_size 4096 MB memory_replacement_policy lru 
> minimum_object_size 0 KB
>

At this point your file just starts repeating rules, with different settings. Some of these replace the above settings, some append to the, and some have no effect due to earlier rules.


> # Recommended minimum configuration:
> acl localnet src 172.28.4.0/24
> acl localnet src 172.28.0.0/24
> acl localnet src 172.28.1.0/24 # OOBM Network outbound access #acl 
> HOGAN dst hogan.nimblestorage.com acl localnet src
> 0.0.0.1-0.255.255.255 # RFC 1122 ?this? network (LAN) acl blocksites 
> url_regex ?/etc/squid/blocksites?
> http_access deny blocksites
> acl SSL_ports port 443
> acl SSL_ports port 8071
> acl SSL_ports port 11052
> acl SSL_ports port 8200
> acl SSL_ports port 8282
> acl Safe_ports port 8282
> #acl HOGAN_port port 2222 # hogan.nimblestorage.com:2222 SSH support 
> tunnel # Example rule allowing access from your local networks.
> # Adapt localnet in the ACL section to list your (internal) IP 
> networks # from where browsing should be allowed acl localnet src
> 172.16.117.0/24 http_access allow localnet http_access allow localhost 
> #http_access allow HOGAN HOGAN_port acl localnet src 20.20.30.0/21 acl 
> parent_proxy_exclude dst 20.20.30.0/21 acl parent_proxy_exclude_ST0100 
> dst 20.20.30.222/22 always_direct allow parent_proxy_exclude_ST0100 
> acl servicenet dst 172.28.4.0/24 always_direct allow 
> parent_proxy_exclude always_direct allow servicenet
>


HTH
Amos

_______________________________________________
squid-users mailing list
squid-users at lists.squid-cache.org
https://lists.squid-cache.org/listinfo/squid-users
_______________________________________________
squid-users mailing list
squid-users at lists.squid-cache.org
https://lists.squid-cache.org/listinfo/squid-users

From ben.goz87 at gmail.com  Mon Mar 11 15:00:16 2024
From: ben.goz87 at gmail.com (Ben Goz)
Date: Mon, 11 Mar 2024 17:00:16 +0200
Subject: [squid-users] Manipulating request headers
Message-ID: <CADAqQfx+pR94G6eFjq=CmraB_Y3uR=pAJBZT4KbOTr-jDzNT=w@mail.gmail.com>

By the help of God.

Hi all,
I'm using squid with ssl-bump I want to remove br encoding for request
header Accept-Encoding
currently I'm doing it using the following configuration:
request_header_access Accept-Encoding deny all
request_header_add Accept-Encoding gzip,deflate

Is there a more gentle way of doing it?

Thanks,
Ben
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20240311/589e4c07/attachment.htm>

From squid3 at treenet.co.nz  Mon Mar 11 15:18:24 2024
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Tue, 12 Mar 2024 04:18:24 +1300
Subject: [squid-users] Manipulating request headers
In-Reply-To: <CADAqQfx+pR94G6eFjq=CmraB_Y3uR=pAJBZT4KbOTr-jDzNT=w@mail.gmail.com>
References: <CADAqQfx+pR94G6eFjq=CmraB_Y3uR=pAJBZT4KbOTr-jDzNT=w@mail.gmail.com>
Message-ID: <86539283-54c6-4a52-994e-af4dbc78fc00@treenet.co.nz>

On 12/03/24 04:00, Ben Goz wrote:
> By the help of God.
> 
> Hi all,
> I'm using squid with ssl-bump I want to remove br encoding for request 
> header Accept-Encoding
> currently I'm doing it using the following configuration:
> request_header_access Accept-Encoding deny all
> request_header_add Accept-Encoding gzip,deflate
> 
> Is there a more gentle?way of doing it?

You could use q-value to prohibit it instead.


Replace both the above lines with just this one:

  request_header_add Accept-Encoding br;q=0


HTH
Amos


From squid.org at bloms.de  Mon Mar 11 15:31:42 2024
From: squid.org at bloms.de (Dieter Bloms)
Date: Mon, 11 Mar 2024 16:31:42 +0100
Subject: [squid-users] After upgrade from squid6.6 to 6.8 we have a lot of
 ICAP_ERR_OTHER and ICAP_ERR_GONE messages in icap logfiles
Message-ID: <20240311153142.gfanwq4toaqpcrrq@bloms.de>

Hello,

after an upgrade from squid6.6 to squid6.8 on a debian bookworm we have a lot
of messages from type:

ICAP_ERR_GONE/000
ICAP_ERR_OTHER/200
ICAP_ERR_OTHER/408
ICAP_ERR_OTHER/204

and some of our users claim about bad performance and some get "empty
pages". 
Unfortunately it is not deterministic, the page will appear the next
time it is called up. I can't see anything conspicuous in the cache.log.

There was no change to the virus scanner nor any change to the squid
config during the upgrade.

Here the icap spefific config lines from squid:

--snip--
acl CONNECT method CONNECT
acl withoutvirusscanner.dstnames dstdomain "/etc/squid/withoutvirusscanner.dstnames"
acl audio rep_mime_type ^audio/
acl audio rep_mime_type ^video/

icap_enable on
icap_preview_enable on
icap_preview_size 128
icap_persistent_connections on
icap_send_client_ip on
icap_send_client_username on
icap_service_failure_limit -1
icap_service_revival_delay 30
logformat icap_debug %ts.%03tu %6icap::tr %>a %icap::to/%03icap::Hs %icap::<st %icap::rm %ru %icap::<A -
icap_log daemon:/var/log/squid/icap.log icap_debug
icap_service service_reqmod reqmod_precache bypass=0 max-conn=4096 icap://xx.xx.xx.xx:1344/service_scanner
icap_service service_respmod respmod_precache bypass=0 max-conn=4096 icap://xx.xx.xx.xx:1344/service_scanner
adaptation_service_chain icap_request_scanners service_reqmod
adaptation_service_chain icap_respond_scanners service_respmod
adaptation_access icap_request_scanners allow all !to_localhost !manager !CONNECT !withoutvirusscanner.dstnames
adaptation_access icap_respond_scanners allow all !to_localhost !manager !CONNECT !audio !withoutvirusscanner.dstnames
--snip--

I don't see any changes in the ICAP server area between 6.6 and 6.8


-- 
Regards

  Dieter

--
I do not get viruses because I do not use MS software.
If you use Outlook then please do not put my email address in your
address-book so that WHEN you get a virus it won't use my address in the
>From field.


From ngtech1ltd at gmail.com  Wed Mar 13 06:32:12 2024
From: ngtech1ltd at gmail.com (ngtech1ltd at gmail.com)
Date: Wed, 13 Mar 2024 08:32:12 +0200
Subject: [squid-users] [squid-dev] Using AWS and a SQUID server to
 create Residential Proxies
In-Reply-To: <CAN4PM7=pirLtxWOq4KiyEzKAoVZywKbddRix46Naak-z=X-iOQ@mail.gmail.com>
References: <CAN4PM7=pirLtxWOq4KiyEzKAoVZywKbddRix46Naak-z=X-iOQ@mail.gmail.com>
Message-ID: <000301da7510$2f825c90$8e8715b0$@gmail.com>

Hey Edwin,

The best place to start is Squid-Users and please do not send emails to all the available lists.

Squid-Cache is an open source project which you can use on any Linux OS (and couple others) and the 
project is not publishing any official AWS products in the any marketplace.
There are IT service providers which offer their services based on Squid-Cache.
To use squid as a residential proxy you would need more then just AWS knowledge and you are more then
welcome to ask and continue this thread here in the public list but just so you know you probably need more knowledge.

Eliezer

From: squid-dev <squid-dev-bounces at lists.squid-cache.org> On Behalf Of trance eastaf
Sent: Friday, March 8, 2024 2:28 AM
To: squid-users at lists.squid-cache.org; info at squid-cache.org; squid-dev at lists.squid-cache.org
Subject: [squid-dev] Using AWS and a SQUID server to create Residential Proxies

Hello Team Squid,

I saw your proxy servers on Aws Marketplace.

How do i use them to create many rotating residential proxies on AWS, can you guide me step by step, please?


Thank you, 
Edwin





From ngtech1ltd at gmail.com  Wed Mar 13 08:38:28 2024
From: ngtech1ltd at gmail.com (ngtech1ltd at gmail.com)
Date: Wed, 13 Mar 2024 10:38:28 +0200
Subject: [squid-users] Recommended squid settings when using IPS-based
 domain blocking
In-Reply-To: <CAG8TTAbNxZKKxJgWR9Kcpf3b0vnafaNWbnthjitsS-sNNerpyg@mail.gmail.com>
References: <CAG8TTAbNxZKKxJgWR9Kcpf3b0vnafaNWbnthjitsS-sNNerpyg@mail.gmail.com>
Message-ID: <000601da7521$d37c24f0$7a746ed0$@gmail.com>

Hey Jason,

I can try to build Squid 6.8 for RHEL 9, would this help you to test it as a solution?

Eliezer

From: squid-users <squid-users-bounces at lists.squid-cache.org> On Behalf Of Jason Marshall
Sent: Wednesday, March 6, 2024 4:49 PM
To: squid-users at lists.squid-cache.org
Subject: [squid-users] Recommended squid settings when using IPS-based domain blocking

Good morning,

We have been using squid (version squid-5.5-6.el9_3.5) under RHEL9 as a simple pass-through proxy without issue for the past month or so. Recently our security team implemented an IPS product that intercepts domain names known to be associated with malware and ransomware command and control. Once this was in place, we started having issues with the behavior of squid.

Through some troubleshooting, it appears that what is happening is that that when a user's machine make a request through squid for one of these bad domains, the request is dropped by the IPS, squid waits for the DNS timeout, and then all requests made to squid after that result in NONE_NONE/500 errors, and it never seems to recover until we do a restart or reload of the service.

Initially the dns_timeout was set for 30 seconds. I reduced this, thinking that perhaps requests were building up or something along those lines. I set it to 5 seconds, but that just got us to a failure state faster.

I also found the negative_dns_ttl setting and thought it might be having an effect, but setting this to 0 seconds resulted in no change to the behavior.

Are there any configuration tips that anyone can provide that might work better with dropped/intercepted DNS requests? My current configuration is included here:
acl localnet src 0.0.0.1-0.255.255.255  # RFC 1122 "this" network (LAN)
acl localnet src http://10.0.0.0/8             # RFC 1918 local private network (LAN)
acl localnet src http://100.64.0.0/10          # RFC 6598 shared address space (CGN)
acl localnet src http://169.254.0.0/16         # RFC 3927 link-local (directly plugged) machines
acl localnet src http://172.16.0.0/12          # RFC 1918 local private network (LAN)
acl localnet src http://192.168.0.0/16         # RFC 1918 local private network (LAN)

acl localnet src fc00::/7               # RFC 4193 local private network range
acl localnet src fe80::/10              # RFC 4291 link-local (directly plugged) machines

acl SSL_ports port 443
acl Safe_ports port 80          # http
acl Safe_ports port 443         # https
acl Safe_ports port 9191        # papercut
http_access deny !Safe_ports
http_access allow localhost manager
http_access deny manager

http_access allow localnet
http_access allow localhost
http_access deny all
http_port http://0.0.0.0:3128
http_port http://0.0.0.0:3129
cache deny all
coredump_dir /var/spool/squid
refresh_pattern ^ftp:           1440    20%     10080
refresh_pattern ^gopher:        1440    0%      1440
refresh_pattern -i (/cgi-bin/|\?) 0     0%      0
refresh_pattern .               0       20%     4320
debug_options rotate=1 ALL,2
negative_dns_ttl 0 seconds
dns_timeout 5 seconds

Thank you for any help that you can provide.

Jason Marshall



From ngtech1ltd at gmail.com  Wed Mar 13 08:42:34 2024
From: ngtech1ltd at gmail.com (ngtech1ltd at gmail.com)
Date: Wed, 13 Mar 2024 10:42:34 +0200
Subject: [squid-users] Squid stops responding after 12 browser tabs
 opened
In-Reply-To: <000701da6ee3$0237e4e0$06a7aea0$@earthlink.net>
References: <000701da6ee3$0237e4e0$06a7aea0$@earthlink.net>
Message-ID: <000701da7522$65733d80$3059b880$@gmail.com>

Hey,

I should have built the newest version of squid for debian 11 but for some reason I didn't built and published them.
I am using a tar.gz packages and not .deb ones.
I will try to build one later on.

Eliezer

-----Original Message-----
From: squid-users <squid-users-bounces at lists.squid-cache.org> On Behalf Of nuit123 at earthlink.net
Sent: Tuesday, March 5, 2024 11:54 AM
To: squid-users at lists.squid-cache.org
Subject: [squid-users] Squid stops responding after 12 browser tabs opened

Squid 4.17 compiled on Debian 11

Squid works, but, after 12 to 17 browser tabs are opened to any web site,
subsequent tabs fail to load web site content. At the same time, telnet:80
through Squid also fails. Yet, network traffic that bypasses Squid
successfully communicates with the target web site.

Ultimately, after about two minutes, unresponsive browser tabs usually
finish loading web site content.

Adjusting cache_mem makes no difference.

This is remarked:
#cache_dir ufs /var/spool/squid 100 16 256
Tried to enable it, but squid -z fails with permission issues, so keeping
cache_dir enabled breaks squid entirely.

Any thoughts, please?

With apologies if this violates etiquette (hey, I did
--enable-http-violations!), this Squid server is taking on greater
importance, and while it's infinitely fascinating, I recognize my limits, so
I'm open to experienced help managing and maintaining it, and probably
building a newer version. :-)

Thanks!


_______________________________________________
squid-users mailing list
squid-users at lists.squid-cache.org
https://lists.squid-cache.org/listinfo/squid-users



From jason.marshall at gmail.com  Wed Mar 13 09:09:13 2024
From: jason.marshall at gmail.com (Jason Marshall)
Date: Wed, 13 Mar 2024 05:09:13 -0400
Subject: [squid-users] Recommended squid settings when using IPS-based
 domain blocking
In-Reply-To: <000601da7521$d37c24f0$7a746ed0$@gmail.com>
References: <CAG8TTAbNxZKKxJgWR9Kcpf3b0vnafaNWbnthjitsS-sNNerpyg@mail.gmail.com>
 <000601da7521$d37c24f0$7a746ed0$@gmail.com>
Message-ID: <CAG8TTAawU+T_mSfx77fgD-HXVuP5TMtMkKB_Dodfew=kHeZmcw@mail.gmail.com>

I would certainly be willing to give it a shot, yes!

Thank you!

Jason

<https://www.avast.com/sig-email?utm_medium=email&utm_source=link&utm_campaign=sig-email&utm_content=webmail>
Virus-free.www.avast.com
<https://www.avast.com/sig-email?utm_medium=email&utm_source=link&utm_campaign=sig-email&utm_content=webmail>
<#DAB4FAD8-2DD7-40BB-A1B8-4E2AA1F9FDF2>

On Wed, Mar 13, 2024 at 4:38?AM <ngtech1ltd at gmail.com> wrote:

> Hey Jason,
>
> I can try to build Squid 6.8 for RHEL 9, would this help you to test it as
> a solution?
>
> Eliezer
>
> From: squid-users <squid-users-bounces at lists.squid-cache.org> On Behalf
> Of Jason Marshall
> Sent: Wednesday, March 6, 2024 4:49 PM
> To: squid-users at lists.squid-cache.org
> Subject: [squid-users] Recommended squid settings when using IPS-based
> domain blocking
>
> Good morning,
>
> We have been using squid (version squid-5.5-6.el9_3.5) under RHEL9 as a
> simple pass-through proxy without issue for the past month or so. Recently
> our security team implemented an IPS product that intercepts domain names
> known to be associated with malware and ransomware command and control.
> Once this was in place, we started having issues with the behavior of squid.
>
> Through some troubleshooting, it appears that what is happening is that
> that when a user's machine make a request through squid for one of these
> bad domains, the request is dropped by the IPS, squid waits for the DNS
> timeout, and then all requests made to squid after that result in
> NONE_NONE/500 errors, and it never seems to recover until we do a restart
> or reload of the service.
>
> Initially the dns_timeout was set for 30 seconds. I reduced this, thinking
> that perhaps requests were building up or something along those lines. I
> set it to 5 seconds, but that just got us to a failure state faster.
>
> I also found the negative_dns_ttl setting and thought it might be having
> an effect, but setting this to 0 seconds resulted in no change to the
> behavior.
>
> Are there any configuration tips that anyone can provide that might work
> better with dropped/intercepted DNS requests? My current configuration is
> included here:
> acl localnet src 0.0.0.1-0.255.255.255  # RFC 1122 "this" network (LAN)
> acl localnet src http://10.0.0.0/8             # RFC 1918 local private
> network (LAN)
> acl localnet src http://100.64.0.0/10          # RFC 6598 shared address
> space (CGN)
> acl localnet src http://169.254.0.0/16         # RFC 3927 link-local
> (directly plugged) machines
> acl localnet src http://172.16.0.0/12          # RFC 1918 local private
> network (LAN)
> acl localnet src http://192.168.0.0/16         # RFC 1918 local private
> network (LAN)
>
> acl localnet src fc00::/7               # RFC 4193 local private network
> range
> acl localnet src fe80::/10              # RFC 4291 link-local (directly
> plugged) machines
>
> acl SSL_ports port 443
> acl Safe_ports port 80          # http
> acl Safe_ports port 443         # https
> acl Safe_ports port 9191        # papercut
> http_access deny !Safe_ports
> http_access allow localhost manager
> http_access deny manager
>
> http_access allow localnet
> http_access allow localhost
> http_access deny all
> http_port http://0.0.0.0:3128
> http_port http://0.0.0.0:3129
> cache deny all
> coredump_dir /var/spool/squid
> refresh_pattern ^ftp:           1440    20%     10080
> refresh_pattern ^gopher:        1440    0%      1440
> refresh_pattern -i (/cgi-bin/|\?) 0     0%      0
> refresh_pattern .               0       20%     4320
> debug_options rotate=1 ALL,2
> negative_dns_ttl 0 seconds
> dns_timeout 5 seconds
>
> Thank you for any help that you can provide.
>
> Jason Marshall
>
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20240313/1f1e7fe9/attachment.htm>

From ngtech1ltd at gmail.com  Wed Mar 13 09:10:32 2024
From: ngtech1ltd at gmail.com (ngtech1ltd at gmail.com)
Date: Wed, 13 Mar 2024 11:10:32 +0200
Subject: [squid-users] Manipulating request headers
In-Reply-To: <CADAqQfx+pR94G6eFjq=CmraB_Y3uR=pAJBZT4KbOTr-jDzNT=w@mail.gmail.com>
References: <CADAqQfx+pR94G6eFjq=CmraB_Y3uR=pAJBZT4KbOTr-jDzNT=w@mail.gmail.com>
Message-ID: <000801da7526$4da70750$e8f515f0$@gmail.com>

Hey Ben,

There is another option which is to use an ICAP server to modify the headers and strip the br part if exists.
It depends on the load on the server but you can edit only the headers and to not use any preview which will remove some un-needed overhead.

Take a peek at the example:
https://github.com/elico/bgu-icap-example


Eliezer

From: squid-users <squid-users-bounces at lists.squid-cache.org> On Behalf Of Ben Goz
Sent: Monday, March 11, 2024 5:00 PM
To: squid-users at lists.squid-cache.org
Subject: [squid-users] Manipulating request headers

By the help of God.

Hi all,
I'm using squid with ssl-bump I want to remove br encoding for request header Accept-Encoding
currently I'm doing it using the following configuration:
request_header_access Accept-Encoding deny all
request_header_add Accept-Encoding gzip,deflate

Is there a more gentle way of doing it?

Thanks,
Ben



From ngtech1ltd at gmail.com  Wed Mar 13 09:50:36 2024
From: ngtech1ltd at gmail.com (ngtech1ltd at gmail.com)
Date: Wed, 13 Mar 2024 11:50:36 +0200
Subject: [squid-users] Squid stops responding after 12 browser tabs
 opened
In-Reply-To: <000701da6ee3$0237e4e0$06a7aea0$@earthlink.net>
References: <000701da6ee3$0237e4e0$06a7aea0$@earthlink.net>
Message-ID: <001d01da752b$e69db670$b3d92350$@gmail.com>

OK So I have built 6.8 for debian-11 but the NIS support has been removed.

https://www.ngtech.co.il/repo/debian/11/x86_64/

https://www.ngtech.co.il/repo/debian/11/x86_64/squid-6.8-64-bin-stripped-only.tar

I have yet to publish an installation script for it but there are couple binaries and shared folders.
It should be a "drop-in" replacement for the currently installed squid version of debian-11.
First backup your squid config and then untar the tar into some specific folder and backup your  (with the -C option) and make sure you sync the files into the current locations.

Let me know if you need some help.
Eliezer

-----Original Message-----
From: squid-users <squid-users-bounces at lists.squid-cache.org> On Behalf Of nuit123 at earthlink.net
Sent: Tuesday, March 5, 2024 11:54 AM
To: squid-users at lists.squid-cache.org
Subject: [squid-users] Squid stops responding after 12 browser tabs opened

Squid 4.17 compiled on Debian 11

Squid works, but, after 12 to 17 browser tabs are opened to any web site,
subsequent tabs fail to load web site content. At the same time, telnet:80
through Squid also fails. Yet, network traffic that bypasses Squid
successfully communicates with the target web site.

Ultimately, after about two minutes, unresponsive browser tabs usually
finish loading web site content.

Adjusting cache_mem makes no difference.

This is remarked:
#cache_dir ufs /var/spool/squid 100 16 256
Tried to enable it, but squid -z fails with permission issues, so keeping
cache_dir enabled breaks squid entirely.

Any thoughts, please?

With apologies if this violates etiquette (hey, I did
--enable-http-violations!), this Squid server is taking on greater
importance, and while it's infinitely fascinating, I recognize my limits, so
I'm open to experienced help managing and maintaining it, and probably
building a newer version. :-)

Thanks!


_______________________________________________
squid-users mailing list
squid-users at lists.squid-cache.org
https://lists.squid-cache.org/listinfo/squid-users



From squid3 at treenet.co.nz  Thu Mar 14 01:10:59 2024
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Thu, 14 Mar 2024 14:10:59 +1300
Subject: [squid-users] After upgrade from squid6.6 to 6.8 we have a lot
 of ICAP_ERR_OTHER and ICAP_ERR_GONE messages in icap logfiles
In-Reply-To: <20240311153142.gfanwq4toaqpcrrq@bloms.de>
References: <20240311153142.gfanwq4toaqpcrrq@bloms.de>
Message-ID: <83a90c3c-c46f-45d5-ba29-cf9cfb7d493e@treenet.co.nz>


On 12/03/24 04:31, Dieter Bloms wrote:
> Hello,
> 
> after an upgrade from squid6.6 to squid6.8 on a debian bookworm we have a lot
> of messages from type:
> 
> ICAP_ERR_GONE/000
> ICAP_ERR_OTHER/200
> ICAP_ERR_OTHER/408
> ICAP_ERR_OTHER/204
> 
> and some of our users claim about bad performance and some get "empty
> pages".
> Unfortunately it is not deterministic, the page will appear the next
> time it is called up. I can't see anything conspicuous in the cache.log.
> 

Hmm, there was 
<https://github.com/squid-cache/squid/commit/4658d0fc049738c2e6cd25fc0af10e820cf4c11a> 
changing message I/O in particular. The behavioural changes from that 
might have impacted ICAP in some unexpected way.

Also, if you are using SSL-Bump to enable virus scanning then 
<https://github.com/squid-cache/squid/commit/debf3f17be7761ea4992864a828f42ee773dfbaf> 
might also be having effects.

HTH
Amos


From misho.98118 at gmail.com  Thu Mar 14 12:21:04 2024
From: misho.98118 at gmail.com (Miha Miha)
Date: Thu, 14 Mar 2024 14:21:04 +0200
Subject: [squid-users] Compilation error for v6.8
Message-ID: <CABZyDWHSLG6j=_S+QXHoRmJm4K-Bc=c1wnUYX-nPh4X9bPG2nw@mail.gmail.com>

Hello Squid team,

I get following error while compiling v6.8

...

In file included from basic_nis_auth.cc:15:
../../../../src/auth/basic/NIS/nis_support.h:8: error: unterminated #ifndef
#ifndef SQUID_SRC_AUTH_BASIC_NIS_NIS_SUPPORT_H
basic_nis_auth.cc: In function 'int main(int, char**)':
basic_nis_auth.cc:71:21: error: 'get_nis_password' was not declared in
this scope
         nispasswd = get_nis_password(user, nisdomain, nismap);
                     ^~~~~~~~~~~~~~~~
...
Build environment: CentOS7.9; gcc version 8.3.1 20190311 (Red Hat 8.3.1-3) (GCC)
Note: I'm able to compile successfully v6.7 in same build environment.

Regards,
Mihail Mihaylov


From dm at belkam.com  Thu Mar 14 12:25:01 2024
From: dm at belkam.com (Dmitry Melekhov)
Date: Thu, 14 Mar 2024 16:25:01 +0400
Subject: [squid-users] Compilation error for v6.8
In-Reply-To: <CABZyDWHSLG6j=_S+QXHoRmJm4K-Bc=c1wnUYX-nPh4X9bPG2nw@mail.gmail.com>
References: <CABZyDWHSLG6j=_S+QXHoRmJm4K-Bc=c1wnUYX-nPh4X9bPG2nw@mail.gmail.com>
Message-ID: <2328d23c-3194-4e7c-875b-75b1478b59d1@belkam.com>

14.03.2024 16:21, Miha Miha ?????:
> Hello Squid team,
>
> I get following error while compiling v6.8
>
> ...
>
> In file included from basic_nis_auth.cc:15:
> ../../../../src/auth/basic/NIS/nis_support.h:8: error: unterminated #ifndef
> #ifndef SQUID_SRC_AUTH_BASIC_NIS_NIS_SUPPORT_H
> basic_nis_auth.cc: In function 'int main(int, char**)':
> basic_nis_auth.cc:71:21: error: 'get_nis_password' was not declared in
> this scope
>           nispasswd = get_nis_password(user, nisdomain, nismap);
>                       ^~~~~~~~~~~~~~~~
> ...
> Build environment: CentOS7.9; gcc version 8.3.1 20190311 (Red Hat 8.3.1-3) (GCC)
> Note: I'm able to compile successfully v6.7 in same build environment.
>
> Regards,
> Mihail Mihaylov
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> https://lists.squid-cache.org/listinfo/squid-users

Do you really need NIS auth? I just disabled it when got the same 
problem on ubuntu 20.04 :-)




From rousskov at measurement-factory.com  Thu Mar 14 13:20:50 2024
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Thu, 14 Mar 2024 09:20:50 -0400
Subject: [squid-users] Compilation error for v6.8
In-Reply-To: <CABZyDWHSLG6j=_S+QXHoRmJm4K-Bc=c1wnUYX-nPh4X9bPG2nw@mail.gmail.com>
References: <CABZyDWHSLG6j=_S+QXHoRmJm4K-Bc=c1wnUYX-nPh4X9bPG2nw@mail.gmail.com>
Message-ID: <646faa38-a06f-429d-9360-f4a3e4b460a5@measurement-factory.com>

On 2024-03-14 08:21, Miha Miha wrote:
> Hello Squid team,
> 
> I get following error while compiling v6.8
> 
> ...
> 
> In file included from basic_nis_auth.cc:15:
> ../../../../src/auth/basic/NIS/nis_support.h:8: error: unterminated #ifndef
> #ifndef SQUID_SRC_AUTH_BASIC_NIS_NIS_SUPPORT_H
> basic_nis_auth.cc: In function 'int main(int, char**)':
> basic_nis_auth.cc:71:21: error: 'get_nis_password' was not declared in
> this scope
>           nispasswd = get_nis_password(user, nisdomain, nismap);
>                       ^~~~~~~~~~~~~~~~
> ...
> Build environment: CentOS7.9; gcc version 8.3.1 20190311 (Red Hat 8.3.1-3) (GCC)
> Note: I'm able to compile successfully v6.7 in same build environment.

Please see Squid Bug 5349 for a fix:
https://bugs.squid-cache.org/show_bug.cgi?id=5349

Alex.



From rousskov at measurement-factory.com  Thu Mar 14 14:06:57 2024
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Thu, 14 Mar 2024 10:06:57 -0400
Subject: [squid-users] After upgrade from squid6.6 to 6.8 we have a lot
 of ICAP_ERR_OTHER and ICAP_ERR_GONE messages in icap logfiles
In-Reply-To: <20240311153142.gfanwq4toaqpcrrq@bloms.de>
References: <20240311153142.gfanwq4toaqpcrrq@bloms.de>
Message-ID: <bc93d31a-54d2-484f-8dc1-a0d3e01c6898@measurement-factory.com>

On 2024-03-11 11:31, Dieter Bloms wrote:
> Hello,
> 
> after an upgrade from squid6.6 to squid6.8 on a debian bookworm we have a lot
> of messages from type:
> 
> ICAP_ERR_GONE/000
> ICAP_ERR_OTHER/200
> ICAP_ERR_OTHER/408
> ICAP_ERR_OTHER/204
> 
> and some of our users claim about bad performance and some get "empty
> pages".

Please see Squid Bug 5352 for a work-in-progress fix that needs testing:
https://bugs.squid-cache.org/show_bug.cgi?id=5352

Thank you,

Alex.


> Unfortunately it is not deterministic, the page will appear the next
> time it is called up. I can't see anything conspicuous in the cache.log.
> 
> There was no change to the virus scanner nor any change to the squid
> config during the upgrade.
> 
> Here the icap spefific config lines from squid:
> 
> --snip--
> acl CONNECT method CONNECT
> acl withoutvirusscanner.dstnames dstdomain "/etc/squid/withoutvirusscanner.dstnames"
> acl audio rep_mime_type ^audio/
> acl audio rep_mime_type ^video/
> 
> icap_enable on
> icap_preview_enable on
> icap_preview_size 128
> icap_persistent_connections on
> icap_send_client_ip on
> icap_send_client_username on
> icap_service_failure_limit -1
> icap_service_revival_delay 30
> logformat icap_debug %ts.%03tu %6icap::tr %>a %icap::to/%03icap::Hs %icap::<st %icap::rm %ru %icap::<A -
> icap_log daemon:/var/log/squid/icap.log icap_debug
> icap_service service_reqmod reqmod_precache bypass=0 max-conn=4096 icap://xx.xx.xx.xx:1344/service_scanner
> icap_service service_respmod respmod_precache bypass=0 max-conn=4096 icap://xx.xx.xx.xx:1344/service_scanner
> adaptation_service_chain icap_request_scanners service_reqmod
> adaptation_service_chain icap_respond_scanners service_respmod
> adaptation_access icap_request_scanners allow all !to_localhost !manager !CONNECT !withoutvirusscanner.dstnames
> adaptation_access icap_respond_scanners allow all !to_localhost !manager !CONNECT !audio !withoutvirusscanner.dstnames
> --snip--
> 
> I don't see any changes in the ICAP server area between 6.6 and 6.8
> 
> 



From squid.org at bloms.de  Thu Mar 14 15:13:21 2024
From: squid.org at bloms.de (Dieter Bloms)
Date: Thu, 14 Mar 2024 16:13:21 +0100
Subject: [squid-users] After upgrade from squid6.6 to 6.8 we have a lot
 of ICAP_ERR_OTHER and ICAP_ERR_GONE messages in icap logfiles
In-Reply-To: <83a90c3c-c46f-45d5-ba29-cf9cfb7d493e@treenet.co.nz>
References: <20240311153142.gfanwq4toaqpcrrq@bloms.de>
 <83a90c3c-c46f-45d5-ba29-cf9cfb7d493e@treenet.co.nz>
Message-ID: <20240314151321.oj32nhva43dszyww@bloms.de>

Hello Amos,

thank you for your answer!
I opened a bugreport https://bugs.squid-cache.org/show_bug.cgi?id=5353
with some debug infos attached.

On Thu, Mar 14, Amos Jeffries wrote:

> 
> On 12/03/24 04:31, Dieter Bloms wrote:
> > Hello,
> > 
> > after an upgrade from squid6.6 to squid6.8 on a debian bookworm we have a lot
> > of messages from type:
> > 
> > ICAP_ERR_GONE/000
> > ICAP_ERR_OTHER/200
> > ICAP_ERR_OTHER/408
> > ICAP_ERR_OTHER/204
> > 
> > and some of our users claim about bad performance and some get "empty
> > pages".
> > Unfortunately it is not deterministic, the page will appear the next
> > time it is called up. I can't see anything conspicuous in the cache.log.
> > 
> 
> Hmm, there was <https://github.com/squid-cache/squid/commit/4658d0fc049738c2e6cd25fc0af10e820cf4c11a>
> changing message I/O in particular. The behavioural changes from that might
> have impacted ICAP in some unexpected way.
> 
> Also, if you are using SSL-Bump to enable virus scanning then <https://github.com/squid-cache/squid/commit/debf3f17be7761ea4992864a828f42ee773dfbaf>
> might also be having effects.
> 
> HTH
> Amos
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> https://lists.squid-cache.org/listinfo/squid-users

-- 
Gru?

  Dieter

--
I do not get viruses because I do not use MS software.
If you use Outlook then please do not put my email address in your
address-book so that WHEN you get a virus it won't use my address in the
From field.


From s_p_arun at yahoo.com  Mon Mar 18 22:46:47 2024
From: s_p_arun at yahoo.com (Arun Kumar)
Date: Mon, 18 Mar 2024 22:46:47 +0000 (UTC)
Subject: [squid-users] Error during ICAP RESPMOD
References: <334246463.6454176.1710802007981.ref@mail.yahoo.com>
Message-ID: <334246463.6454176.1710802007981@mail.yahoo.com>

Any idea, the reason for error in ModXact.cc parsePart fuction.Happening during parsing the response from ICAP

parsePart: have 144 head bytes to parse; state: 0parsePart: head parsing result: 0 detail: 600

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20240318/ec50e5e9/attachment.htm>

From rousskov at measurement-factory.com  Tue Mar 19 03:21:00 2024
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Mon, 18 Mar 2024 23:21:00 -0400
Subject: [squid-users] Error during ICAP RESPMOD
In-Reply-To: <334246463.6454176.1710802007981@mail.yahoo.com>
References: <334246463.6454176.1710802007981.ref@mail.yahoo.com>
 <334246463.6454176.1710802007981@mail.yahoo.com>
Message-ID: <400fe870-9742-4fd8-a66e-22a9b281c932@measurement-factory.com>

On 2024-03-18 18:46, Arun Kumar wrote:
> Any idea, the reason for error in ModXact.cc parsePart fuction.
> Happening during parsing the response from ICAP
> 
> 
> parsePart: have 144 head bytes to parse; state: 0
> parsePart: head parsing result: 0 detail: 600

AFAICT, Squid considers received ICAP response header malformed. More 
than five possible problems/cases may match the above lines. The answer 
to your question (or an additional clue!) is in different debugging 
output, possibly logged somewhere between the two lines quoted above. 
The right debugging lines may be visible in "debug_options ALL,2 58,5, 
93,5" output, but it is usually best to share compressed ALL,9 logs 
(privately if needed).

https://wiki.squid-cache.org/SquidFaq/BugReporting#debugging-a-single-transaction


Sharing the problematic ICAP response (header) in a raw packet capture 
format (to preserve important details) may also be very useful.


HTH,

Alex.



From yvong at gmx.net  Tue Mar 19 10:36:18 2024
From: yvong at gmx.net (=?UTF-8?Q?Yvon_Gro=C3=9F?=)
Date: Tue, 19 Mar 2024 11:36:18 +0100
Subject: [squid-users] Cache Manager (cachemgr.cgi) with IIS version 10 as
 web server
Message-ID: <70abb1fe-b765-4635-8367-a0582a6f9ec8@gmx.net>

Hello and good morning,

I installed Squid (v5.7) in the last couple of weeks on 2 Windows Server
2022 systems (test blades) in a WSL(1) and WSL(2) environment. As
distribution I use Ubuntu 22.04.4 LTS. Squid is running on the server.
Clients can reach Squid as a proxy. SquidClient also works. Wonderful.
Now I want to get Cache Manager running via cachemgr.cgi. Since I use
Windows Server 2022 and use IIS version 10 as a web server, I try to
reach the Cache Manager website on several weekends. I am still gritting
my teeth on this. There is not much information available for
configuring the web server (IIS) in conjunction with Squid. If there is,
it is very old. I did find a few hints in the Mailling list. In
connection with IIS v6, partially. On a website
(http://androidyou.blogspot.com/2010/10/install-squid-cachemgrcgi-to-iis-7-iis.html),
for example, I used a template to make Cache Manager accessible in the
browser. I fail at point 3: You should adjust <isapiCgiRestriction
notListedIsapisAllowed="false" notListedCgisAllowed="True"> in the
applicationHost.config file at the position isapiCgiRestriction.
However, this position does not exist under IIS v10. Even manual
insertion fails. I get different error messages like HTTP-Error 404.2. I
know that IIS has restrictive rejection of CGIs in the newer versions.
But I have to admit that I am a newbie when it comes to IIS as a web
server. I am therefore hoping for valuable tips and/or hints on how I
can still get the cache manager running under IIS v10.

Thanx and Greeting

Yvon


From gkinkie at gmail.com  Tue Mar 19 11:03:06 2024
From: gkinkie at gmail.com (Francesco Chemolli)
Date: Tue, 19 Mar 2024 18:03:06 +0700
Subject: [squid-users] Cache Manager (cachemgr.cgi) with IIS version 10
 as web server
In-Reply-To: <70abb1fe-b765-4635-8367-a0582a6f9ec8@gmx.net>
References: <70abb1fe-b765-4635-8367-a0582a6f9ec8@gmx.net>
Message-ID: <CA+Y8hcM9AYh6+N8V=mhOS6hSfbA9W7GWfjemJ8eNhxQFSM+3Jw@mail.gmail.com>

Hi Yvon,
   the good news is, you don't really need cachemgr.cgi; it offers little
value by now, and in fact it will be removed in squid 7.

You can use any regular web browser (or curl or any other command line
tool) pointing at the URL:

http://
<adminuser:adminpassword>@<squid_hostname>:<squidport>/squid-internal-mgr/menu




On Tue, Mar 19, 2024 at 5:36?PM Yvon Gro? <yvong at gmx.net> wrote:

> Hello and good morning,
>
> I installed Squid (v5.7) in the last couple of weeks on 2 Windows Server
> 2022 systems (test blades) in a WSL(1) and WSL(2) environment. As
> distribution I use Ubuntu 22.04.4 LTS. Squid is running on the server.
> Clients can reach Squid as a proxy. SquidClient also works. Wonderful.
> Now I want to get Cache Manager running via cachemgr.cgi. Since I use
> Windows Server 2022 and use IIS version 10 as a web server, I try to
> reach the Cache Manager website on several weekends. I am still gritting
> my teeth on this. There is not much information available for
> configuring the web server (IIS) in conjunction with Squid. If there is,
> it is very old. I did find a few hints in the Mailling list. In
> connection with IIS v6, partially. On a website
> (
> http://androidyou.blogspot.com/2010/10/install-squid-cachemgrcgi-to-iis-7-iis.html
> ),
> for example, I used a template to make Cache Manager accessible in the
> browser. I fail at point 3: You should adjust <isapiCgiRestriction
> notListedIsapisAllowed="false" notListedCgisAllowed="True"> in the
> applicationHost.config file at the position isapiCgiRestriction.
> However, this position does not exist under IIS v10. Even manual
> insertion fails. I get different error messages like HTTP-Error 404.2. I
> know that IIS has restrictive rejection of CGIs in the newer versions.
> But I have to admit that I am a newbie when it comes to IIS as a web
> server. I am therefore hoping for valuable tips and/or hints on how I
> can still get the cache manager running under IIS v10.
>
> Thanx and Greeting
>
> Yvon
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> https://lists.squid-cache.org/listinfo/squid-users
>


-- 
    Francesco
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20240319/45e277cf/attachment.htm>

From andre.bolinhas at articatech.com  Fri Mar 22 13:38:00 2024
From: andre.bolinhas at articatech.com (Andre Bolinhas)
Date: Fri, 22 Mar 2024 13:38:00 +0000
Subject: [squid-users] ACL / http_access rules stop work using Squid 6+
Message-ID: <8b35e262-d609-4532-a2c3-33f15dbea54f@articatech.com>

Hi all,

In previous versions of squid, from 3 to 5.9, I use this kind of deny 
rules and they work like charm

acl AnnotateRule28 annotate_transaction accessrule=Rule28
http_access deny HTTP Group38 AnnotateRule28

This allows me to deny objects without bump / show the error page 
(deny_info)

But using squid 6+ this rules stop to work and everything is allowed.

Example:
Squid 5.9 (OK)
https://ibb.co/YdKgL1Y

Squid 6.8 (NOK)
https://ibb.co/tbyY2GV

Sample of both cache.log in debug mode

https://we.tl/t-T7Nz1rVbVu


-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20240322/8cb6a055/attachment.htm>

From s_p_arun at yahoo.com  Fri Mar 22 17:11:37 2024
From: s_p_arun at yahoo.com (Arun Kumar)
Date: Fri, 22 Mar 2024 17:11:37 +0000 (UTC)
Subject: [squid-users] Error during ICAP RESPMOD
In-Reply-To: <400fe870-9742-4fd8-a66e-22a9b281c932@measurement-factory.com>
References: <334246463.6454176.1710802007981.ref@mail.yahoo.com>
 <334246463.6454176.1710802007981@mail.yahoo.com>
 <400fe870-9742-4fd8-a66e-22a9b281c932@measurement-factory.com>
Message-ID: <283160880.349514.1711127497866@mail.yahoo.com>

 The lines above are. The content-length is 138 (8a in hex), but the bytes are 144. Could this be the reason?
parseMore: have 144 bytes to parse [FD 14;RBG/Comm(14)wr job24]parseMore:
8a^M{"activity":"Make a simple musical instrument","type":"music","participants":1,"price:0.4,"link":"","key":"7091374","accessibility":0.25}^MparseHeaders: parse ICAP headersparsePart: have 144 head bytes to parse; state: 0
parsePart: head parsing result: 0 detail: 600

    On Monday, March 18, 2024 at 11:21:02 PM EDT, Alex Rousskov <rousskov at measurement-factory.com> wrote:  
 
 On 2024-03-18 18:46, Arun Kumar wrote:
> Any idea, the reason for error in ModXact.cc parsePart fuction.
> Happening during parsing the response from ICAP
> 
> 
> parsePart: have 144 head bytes to parse; state: 0
> parsePart: head parsing result: 0 detail: 600

AFAICT, Squid considers received ICAP response header malformed. More 
than five possible problems/cases may match the above lines. The answer 
to your question (or an additional clue!) is in different debugging 
output, possibly logged somewhere between the two lines quoted above. 
The right debugging lines may be visible in "debug_options ALL,2 58,5, 
93,5" output, but it is usually best to share compressed ALL,9 logs 
(privately if needed).

https://wiki.squid-cache.org/SquidFaq/BugReporting#debugging-a-single-transaction


Sharing the problematic ICAP response (header) in a raw packet capture 
format (to preserve important details) may also be very useful.


HTH,

Alex.

  
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20240322/50e98a01/attachment.htm>

From rousskov at measurement-factory.com  Sat Mar 23 03:02:47 2024
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Fri, 22 Mar 2024 23:02:47 -0400
Subject: [squid-users] Error during ICAP RESPMOD
In-Reply-To: <283160880.349514.1711127497866@mail.yahoo.com>
References: <334246463.6454176.1710802007981.ref@mail.yahoo.com>
 <334246463.6454176.1710802007981@mail.yahoo.com>
 <400fe870-9742-4fd8-a66e-22a9b281c932@measurement-factory.com>
 <283160880.349514.1711127497866@mail.yahoo.com>
Message-ID: <9d34831b-1f9c-41d0-b123-e022c872ecc9@measurement-factory.com>

On 2024-03-22 13:11, Arun Kumar wrote:
> The lines above are. The content-length is 138 (8a in hex), but the 
> bytes are 144. Could this be the reason?
> 
> parseMore: have 144 bytes to parse [FD 14;RBG/Comm(14)wr job24]
> parseMore:
> 8a^M
> {"activity":"Make a simple musical 
> instrument","type":"music","participants":1,"price:0.4,"link":"","key":"7091374","accessibility":0.25}^M
> parseHeaders: parse ICAP headers
> parsePart: have 144 head bytes to parse; state: 0
> parsePart: head parsing result: 0 detail: 600


I cannot be sure based on the tiny snippets shared so far, but it 
_looks_ like Squid expected an ICAP response header and got an ICAP 
response body chunk instead. It is also possible that we are looking at 
log lines from two unrelated ICAP transactions, or I am simply 
misinterpreting the snippets.

If you want a more reliable diagnosis, then my earlier recommendation 
regarding sharing (privately if needed) the following information still 
stands:

* compressed ALL,9 cache.log and
* the problematic ICAP response in a raw packet capture format.


HTH,

Alex.


> On Monday, March 18, 2024 at 11:21:02 PM EDT, Alex Rousskov 
> <rousskov at measurement-factory.com> wrote:
> 
> 
> On 2024-03-18 18:46, Arun Kumar wrote:
> 
>  > Any idea, the reason for error in ModXact.cc parsePart fuction.
>  > Happening during parsing the response from ICAP
>  >
>  >
>  > parsePart: have 144 head bytes to parse; state: 0
>  > parsePart: head parsing result: 0 detail: 600
> 
> 
> AFAICT, Squid considers received ICAP response header malformed. More
> than five possible problems/cases may match the above lines. The answer
> to your question (or an additional clue!) is in different debugging
> output, possibly logged somewhere between the two lines quoted above.
> The right debugging lines may be visible in "debug_options ALL,2 58,5,
> 93,5" output, but it is usually best to share compressed ALL,9 logs
> (privately if needed).
> 
> https://wiki.squid-cache.org/SquidFaq/BugReporting#debugging-a-single-transaction <https://wiki.squid-cache.org/SquidFaq/BugReporting#debugging-a-single-transaction>
> 
> 
> Sharing the problematic ICAP response (header) in a raw packet capture
> format (to preserve important details) may also be very useful.
> 
> 
> HTH,
> 
> Alex.
> 
> 



From dave at killthe.net  Sun Mar 24 18:20:36 2024
From: dave at killthe.net (Dave Blanchard)
Date: Sun, 24 Mar 2024 13:20:36 -0500
Subject: [squid-users] GCC optimizer is provably junk. Here is the evidence.
Message-ID: <20240324132036.20f5ec87ce9e534cf1d759a6@killthe.net>


To whom it may concern--e.g. users of GCC who naively assume GCC is maintained by professionals who care about correct code generation:

Stefan Kanthak has collected a body of evidence showing that the GCC optimizer is essentially garbage on both x86-32 and -64 targets. This ongoing regression apparently started in GCC 6.x and continues to get worse with every version of GCC. Here is the proof:

https://skanthak.hier-im-netz.de/gcc.html

I invite users of GCC and others concerned about this situation to review Mr. Kanthak's numerous posts to the GCC mailing list, along with the indifferent/hostile responses by GCC mailing list members. They attacked him, ridiculed him, called him a stupid noob, tried to shuffle him off to the dusty and dark corner of a bug tracker so he could be conveniently ignored and forgotten, and in every way refused to acknowledge or accept his findings.

I found this situatio disturbing, and have been rather unimpressed with the generally nasty and hateful attitude of GCC representatives to his postings plus my own supportive comments, in various responses such as the following:

>From Jonathan Wakely:

> Dave [...] contributes nothing here except bile.

>From Mark Wielaard: 

> You have been warned before. Please stop sending these negative
unproductive messages to this list attacking well respected productive
maintainers of the project. Your attitude is not welcome.

Here's a nice gem from Julian Waters, a thoroughly pleasant and amiable fellow:

> Hello again, Dave. Have you managed to learn how a basic language
> Interpreter works before commenting on the significantly-more-complex
> gcc's efficiency? Or were you not able to because your IQ is below the
> freezing point of water and you can't even understand what a basic
> tree walker is?

> Then again, with an address like killthe.net, why should we even take
> you seriously? Hell, even though I miraculously agree that stuff like
> GNU and Linux is not beginner friendly, and gcc could do with some
> improvements in that department, no one wants to take any advice from
> a self righteous and idiotic piece of shit like yourself. At least
> Stefan was smart enough to bail when others pointed out the holes in
> his examples of gcc's instruction selection allegedly being poor. You,
> not so much. I doubt the clang people want you either, so do them a
> favour and stay the hell away from LLVM, and this is coming from
> someone who doesn't really like LLVM in the first place.

(In case is it of any interest to you, Julian, the domain 'killthe.net' is my own small way of protesting the absolute dumpster fire the internet has become in recent years, with your increasingly broken compiler being only one notable example of the continuous, ongoing degradation--"enshittification"--of everything in tech.)

Clearly, judging by the hostiliy of their responses, these GCC representatives find it irksome that anyone would dare criticize their project. Nevermind that this project has maneuvered itself into a position where thousands of software projects and operating systems depend on their increasingly junk code output. The ongoing degradation of their code generator and the resulting economic damages to their millions of users is apparently of little concern to them. The silence of GNU founder Richard Stallman on this topic is notable, and equally disturbing.

Given the increasing severity of this problem with every GCC version, and the toxic responses by GCC "maintainers" to this situation, there are only two conclusions one can logically reach:

a) sheer incompetence on the part of GCC "maintainers", combined with haughty arrogance

b) active malice on the part of GCC "maintainers", combined with haughty arrogance

I know enough about how the world actually works to know that the correct conclusion is 'B'. They are doing this purposefully, they know exactly what they are doing, and they really don't like their evil deeds being exposed to daylight.

In my view, the entire GNU organization is a toxic cancer on the UNIX world...and it was designed to be exactly that from the very beginning.

It appears the true purpose of GNU was to "embrace, extend, extinguish" the fledgling UNIX open source world; to capture and control it with sinister and selfish motives and intentions; exactly the same strategy as Microsoft has famously used elsewhere, and exactly the same as RedHat along with Linux Puttering and their ilk have continued today. When one understands this, and a lot of things that don't make any sense will suddenly become clear.

Let this email be a warning To Whom It May Concern that the GCC project is a flaming dumpster heap which should be abandoned by freedom-loving programmers and system maintainers ASAP.

Don't assume LLVM/clang is any better, either. They are controlled by the same sinister forces who control GCC (i.e. the people who own Apple, Microsoft, and every other major tech company) and are NOT to be trusted.

What freedom-loving people actually need is a new compiler that can actually be trusted. I leave that solution as an exercise to the reader.

Sincerely,

Dave Blanchard (aka "the idiotic and self-righteous piece of shit")



From squid3 at treenet.co.nz  Mon Mar 25 03:24:10 2024
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Mon, 25 Mar 2024 16:24:10 +1300
Subject: [squid-users] GCC optimizer is provably junk. Here is the
 evidence.
In-Reply-To: <20240324132036.20f5ec87ce9e534cf1d759a6@killthe.net>
References: <20240324132036.20f5ec87ce9e534cf1d759a6@killthe.net>
Message-ID: <4a5ca07e-9ec1-4806-b480-581ad889df91@treenet.co.nz>

This inflammatory post is not relevant to Squid.

Please do not followup to this thread.


Cheers
Amos Jeffries
The Squid Software Foundation


From rousskov at measurement-factory.com  Mon Mar 25 18:25:49 2024
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Mon, 25 Mar 2024 14:25:49 -0400
Subject: [squid-users] ACL / http_access rules stop work using Squid 6+
In-Reply-To: <8b35e262-d609-4532-a2c3-33f15dbea54f@articatech.com>
References: <8b35e262-d609-4532-a2c3-33f15dbea54f@articatech.com>
Message-ID: <8ff19597-56d6-4214-9c59-14eb4b5a7bfe@measurement-factory.com>

On 2024-03-22 09:38, Andre Bolinhas wrote:

> In previous versions of squid, from 3 to 5.9, I use this kind of deny 
> rules and they work like charm
> 
> acl AnnotateRule28 annotate_transaction accessrule=Rule28
> http_access deny HTTP Group38 AnnotateRule28
> 
> This allows me to deny objects without bump / show the error page 
> (deny_info)
> 
> But using squid 6+ this rules stop to work and everything is allowed.
> 
> Example:
> Squid 5.9 (OK)
> https://ibb.co/YdKgL1Y
> 
> Squid 6.8 (NOK)
> https://ibb.co/tbyY2GV
> 
> Sample of both cache.log in debug mode
> 
> https://we.tl/t-T7Nz1rVbVu


In you v6 logs, most logged transactions are allowed because a rule 
similar to the one reconstructed below is matching:

     http_access allow all AnnotateFinalAllow


There are similar cases in v5 logs as well, but most denied v5 
transactions match the following rule instead (i.e. the one you shared 
above):

     http_access deny HTTP Group38 AnnotateRule28


In your Squid configuration, v6 allow rule is listed much higher than v5 
deny rule (#43 vs #149). I do not see any signs of Group38 or 
AnnotateRule28 ACL evaluation in v6 logs, as if the rule sets are 
different for two different Squid instances. Are you using the same set 
of http_access rules for both Squid versions?

Alex.



From andre.bolinhas at articatech.com  Wed Mar 27 03:59:23 2024
From: andre.bolinhas at articatech.com (=?utf-8?Q?Bolinhas_Andr=C3=A9?=)
Date: Wed, 27 Mar 2024 04:59:23 +0100
Subject: [squid-users] ACL / http_access rules stop work using Squid 6+
Message-ID: <zarafa.6603999b.5e26.7f8245033410d3a5@ns413437.ip-37-187-142.eu>

Hi. 

The configuration is the exact copy between squid 5 and squid 6, nothing changes except the squid version. 

Any idea what can cause this issue on squid 6?

Best regards 


Sent from Nine <http://www.9folders.com/> 
--------------------------------
De: Alex Rousskov <rousskov at measurement-factory.com>
Enviado: segunda-feira, 25 de mar?o de 2024 19:12
Para: squid-users at lists.squid-cache.org
Assunto Re: [squid-users] ACL / http_access rules stop work using Squid 6+



On 2024-03-22 09:38, Andre Bolinhas wrote:

> In previous versions of squid, from 3 to 5.9, I use this kind of deny 
> rules and they work like charm
> 
> acl AnnotateRule28 annotate_transaction accessrule=Rule28
> http_access deny HTTP Group38 AnnotateRule28
> 
> This allows me to deny objects without bump / show the error page 
> (deny_info)
> 
> But using squid 6+ this rules stop to work and everything is allowed.
> 
> Example:
> Squid 5.9 (OK)
> https://ibb.co/YdKgL1Y
> 
> Squid 6.8 (NOK)
> https://ibb.co/tbyY2GV
> 
> Sample of both cache.log in debug mode
> 
> https://we.tl/t-T7Nz1rVbVu


In you v6 logs, most logged transactions are allowed because a rule 
similar to the one reconstructed below is matching:

???? http_access allow all AnnotateFinalAllow


There are similar cases in v5 logs as well, but most denied v5 
transactions match the following rule instead (i.e. the one you shared 
above):

???? http_access deny HTTP Group38 AnnotateRule28


In your Squid configuration, v6 allow rule is listed much higher than v5 
deny rule (#43 vs #149). I do not see any signs of Group38 or 
AnnotateRule28 ACL evaluation in v6 logs, as if the rule sets are 
different for two different Squid instances. Are you using the same set 
of http_access rules for both Squid versions?

Alex.

_______________________________________________
squid-users mailing list
squid-users at lists.squid-cache.org
https://lists.squid-cache.org/listinfo/squid-users

-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20240327/0538521f/attachment.htm>

From Mario.Rauch at dieboldnixdorf.com  Wed Mar 27 09:10:19 2024
From: Mario.Rauch at dieboldnixdorf.com (Rauch, Mario)
Date: Wed, 27 Mar 2024 09:10:19 +0000
Subject: [squid-users] Squid Upgrade from 3.5 > 6.8
Message-ID: <GV1PR10MB61001028A9E7DFD57691E95583342@GV1PR10MB6100.EURPRD10.PROD.OUTLOOK.COM>

Hi,
hope somebody can help here.
We have installed following versions on our server:
Squid Cache: Version 3.5.24
Ubuntu 16.04.7 LTS

We now need to upgrade to latest version 6.8 because of security reasons.
Could somebody assist how to upgrade and if we need to change something in our current squid.conf?

Regards,
Mario


-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20240327/d034c668/attachment.htm>

From gkinkie at gmail.com  Wed Mar 27 12:33:14 2024
From: gkinkie at gmail.com (Francesco Chemolli)
Date: Wed, 27 Mar 2024 20:33:14 +0800
Subject: [squid-users] Squid Upgrade from 3.5 > 6.8
In-Reply-To: <GV1PR10MB61001028A9E7DFD57691E95583342@GV1PR10MB6100.EURPRD10.PROD.OUTLOOK.COM>
References: <GV1PR10MB61001028A9E7DFD57691E95583342@GV1PR10MB6100.EURPRD10.PROD.OUTLOOK.COM>
Message-ID: <CA+Y8hcO0bLj4vmSh0rMixd2cG9irW1VP6UfSLfF9-FDenxGo3w@mail.gmail.com>

Hi Mario,
  the easiest way to check is to ask squid itself, by running "squid -k
parse" with the new squid version and the current configuration.
Developers take great pains to ensure that configuration backwards
compatible as much as possible, and Squid will complain if something is not
right.

On Wed, Mar 27, 2024 at 5:10?PM Rauch, Mario <Mario.Rauch at dieboldnixdorf.com>
wrote:

> Hi,
>
> hope somebody can help here.
>
> We have installed following versions on our server:
>
> Squid Cache: Version 3.5.24
>
> Ubuntu 16.04.7 LTS
>
>
>
> We now need to upgrade to latest version 6.8 because of security reasons.
>
> Could somebody assist how to upgrade and if we need to change something in
> our current squid.conf?
>
>
>
> Regards,
>
> Mario
>
>
>
>
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> https://lists.squid-cache.org/listinfo/squid-users
>


-- 
    Francesco
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20240327/2a4256df/attachment.htm>

From andream231208 at outlook.com  Thu Mar 28 10:12:24 2024
From: andream231208 at outlook.com (Bill Andream)
Date: Thu, 28 Mar 2024 10:12:24 +0000
Subject: [squid-users] Request for Assistance with Squid Compilation on
 Windows 11
Message-ID: <PH7PR11MB70751977CA79356A2C0087F0A63B2@PH7PR11MB7075.namprd11.prod.outlook.com>

Dear Squid Development Team,

I hope this message finds you well. First, allow me to extend my sincerest appreciation for the remarkable work you've been doing with Squid. Your dedication to advancing the open-source community has not gone unnoticed, and it has significantly benefited our project among many others.

I am reaching out to seek your guidance on a challenge I've encountered. In the process of integrating Squid into our product, I followed the instructions on your Knowledge Base to compile the Squid source code on a Windows 11 system using Cygwin. My setup includes Perl (v5.36.3), GCC (v11.4.0), and Make (v4.4.1). After executing:

./configure --prefix=c:/squid --with-maxfd=2048 --enable-win32-service

and proceeding with the make command, I faced several fatal errors, such as unused-parameter, redefinition, missing-declaration, format, and wrong type argument to unary plus, to name a few.

Given your expertise, I was hoping you could shed some light on:

\1. Any potential missteps in my compilation environment that might have led to these issues?

\2. The environment used to compile the Windows executable squid.msi available for download. If it's convenient, could you share the specifics of the setup?

I understand the demands on your time and truly appreciate any insights you can provide. The success of Squid is a clear reflection of the commitment and support from developers like yourselves and the broader community, for which I am deeply grateful.

Thank you once again for your time and assistance. Wishing you and your team all the best in your ongoing and future projects.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20240328/4ab18f9f/attachment.htm>

From parat.gerard at gmail.com  Fri Mar 29 08:24:27 2024
From: parat.gerard at gmail.com (=?UTF-8?Q?G=C3=A9rard_Parat?=)
Date: Fri, 29 Mar 2024 09:24:27 +0100
Subject: [squid-users] Request for Assistance with Squid Compilation on
 Windows 11
In-Reply-To: <PH7PR11MB70751977CA79356A2C0087F0A63B2@PH7PR11MB7075.namprd11.prod.outlook.com>
References: <PH7PR11MB70751977CA79356A2C0087F0A63B2@PH7PR11MB7075.namprd11.prod.outlook.com>
Message-ID: <CAJ6qB7JRHzWT5hWkehWjHHaTF257JhWsJ0ug2o3sGxGiBnfrMg@mail.gmail.com>

Hi,

You may use this guide
<https://github.com/diladele/squid-windows/issues/101#issuecomment-1411186464>
for a starter.

Regards
G?rard


Le jeu. 28 mars 2024 ? 11:12, Bill Andream <andream231208 at outlook.com> a
?crit :

> Dear Squid Development Team,
>
> I hope this message finds you well. First, allow me to extend my sincerest
> appreciation for the remarkable work you've been doing with Squid. Your
> dedication to advancing the open-source community has not gone unnoticed,
> and it has significantly benefited our project among many others.
>
> I am reaching out to seek your guidance on a challenge I've encountered.
> In the process of integrating Squid into our product, I followed the
> instructions on your Knowledge Base to compile the Squid source code on a
> Windows 11 system using Cygwin. My setup includes Perl (v5.36.3), GCC
> (v11.4.0), and Make (v4.4.1). After executing:
>
> ./configure --prefix=c:/squid --with-maxfd=2048 --enable-win32-service
>
> and proceeding with the make command, I faced several fatal errors, such
> as unused-parameter, redefinition, missing-declaration, format, and wrong
> type argument to unary plus, to name a few.
>
> Given your expertise, I was hoping you could shed some light on:
>
> \1. Any potential missteps in my compilation environment that might have
> led to these issues?
>
> \2. The environment used to compile the Windows executable squid.msi
> available for download. If it's convenient, could you share the specifics
> of the setup?
>
> I understand the demands on your time and truly appreciate any insights
> you can provide. The success of Squid is a clear reflection of the
> commitment and support from developers like yourselves and the broader
> community, for which I am deeply grateful.
>
> Thank you once again for your time and assistance. Wishing you and your
> team all the best in your ongoing and future projects.
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> https://lists.squid-cache.org/listinfo/squid-users
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20240329/61feda2d/attachment.htm>

From rousskov at measurement-factory.com  Fri Mar 29 17:40:58 2024
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Fri, 29 Mar 2024 13:40:58 -0400
Subject: [squid-users] ACL / http_access rules stop work using Squid 6+
In-Reply-To: <zarafa.6601cce9.6f7a.695ad7ca298a924d@ns413437.ip-37-187-142.eu>
References: <zarafa.6601cce9.6f7a.695ad7ca298a924d@ns413437.ip-37-187-142.eu>
Message-ID: <9cd03f00-a87e-4c48-8a9c-61eb6751c0d9@measurement-factory.com>

On 2024-03-25 15:13, Bolinhas Andr? wrote:

> Yes, the configuration is the same for both versions.

The logs archive you shared previously has expired, so I cannot double 
check, but from what I remember, the shared logs did not support the 
above assertion, so there may be more to the story here. However, to 
make progress, let's assume that v5 configuration files are identical to 
v6 configuration files.

1. Is there an "http_access allow all AnnotateFinalAllow" rule?

2. Is there an "http_access deny HTTP Group38 AnnotateRule28" rule?

3. Assuming the answers are "yes" and "yes", which rule comes first? If 
you use include files, this question applies to the imaginary 
preprocessed squid.conf file with all the include files inlined 
(recursively if needed). That kind of preprocessed configuration is what 
Squid effectively sees when compiling http_access rules, one by one. 
Which of the two rules will Squid see first?

One way to answer all of the above questions is to look at the following 
output:

     squid -k parse ... |& grep Processing:.http_access

Replace "..." with your regular squid startup command line options and 
adjust standard error redirection (|&) as needed for your shell. Run the 
above command for both Squid v5 and v6 binaries. You should see output 
like this:


> 2024/03/29 13:31:05| Processing: http_access allow manager
> 2024/03/29 13:31:05| Processing: http_access deny all


HTH,

Alex.


> ------------------------------------------------------------------------
> *De:* Alex Rousskov <rousskov at measurement-factory.com>
> *Enviado:* segunda-feira, 25 de mar?o de 2024 19:12
> *Para:* squid-users at lists.squid-cache.org
> *Assunto* Re: [squid-users] ACL / http_access rules stop work using Squid 6+
> 
> 
> 
> On 2024-03-22 09:38, Andre Bolinhas wrote:
> 
>  > In previous versions of squid, from 3 to 5.9, I use this kind of deny
>  > rules and they work like charm
>  >
>  > acl AnnotateRule28 annotate_transaction accessrule=Rule28
>  > http_access deny HTTP Group38 AnnotateRule28
>  >
>  > This allows me to deny objects without bump / show the error page
>  > (deny_info)
>  >
>  > But using squid 6+ this rules stop to work and everything is allowed.
>  >
>  > Example:
>  > Squid 5.9 (OK)
>  > https://ibb.co/YdKgL1Y
>  >
>  > Squid 6.8 (NOK)
>  > https://ibb.co/tbyY2GV
>  >
>  > Sample of both cache.log in debug mode
>  >
>  > https://we.tl/t-T7Nz1rVbVu
> 
> 
> In you v6 logs, most logged transactions are allowed because a rule
> similar to the one reconstructed below is matching:
> 
>  ???? http_access allow all AnnotateFinalAllow
> 
> 
> There are similar cases in v5 logs as well, but most denied v5
> transactions match the following rule instead (i.e. the one you shared
> above):
> 
>  ???? http_access deny HTTP Group38 AnnotateRule28
> 
> 
> In your Squid configuration, v6 allow rule is listed much higher than v5
> deny rule (#43 vs #149). I do not see any signs of Group38 or
> AnnotateRule28 ACL evaluation in v6 logs, as if the rule sets are
> different for two different Squid instances. Are you using the same set
> of http_access rules for both Squid versions?
> 
> Alex.
> 
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> https://lists.squid-cache.org/listinfo/squid-users
> 



