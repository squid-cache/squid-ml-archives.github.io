<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid delay_access with external acl
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20delay_access%20with%20external%20acl&In-Reply-To=%3Cee5efe0b-429b-4c1c-9253-1416a0eb2cd3%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="026485.html">
   <LINK REL="Next"  HREF="026487.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid delay_access with external acl</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20delay_access%20with%20external%20acl&In-Reply-To=%3Cee5efe0b-429b-4c1c-9253-1416a0eb2cd3%40measurement-factory.com%3E"
       TITLE="[squid-users] Squid delay_access with external acl">rousskov at measurement-factory.com
       </A><BR>
    <I>Mon Mar  4 17:54:01 UTC 2024</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="026485.html">[squid-users] Squid delay_access with external acl
</A></li>
        <LI>Next message (by thread): <A HREF="026487.html">[squid-users] Missing IPv6 sockets in Squid 6.7 in some servers
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26486">[ date ]</a>
              <a href="thread.html#26486">[ thread ]</a>
              <a href="subject.html#26486">[ subject ]</a>
              <a href="author.html#26486">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 2024-03-04 06:31, Szil&#225;rd Horv&#225;th wrote:

&gt;<i> Thank you so much your answer but this solution isn't work.
</I>
Please note that I did not (try to) offer a solution. I only tried to 
correct a specific problem in a specific configuration statement.

I hope that Francesco will continue to guide you towards the solution 
that works in your environment. It may be useful to know what exactly 
does not work at this point (e.g., the transaction never gets a 
limited=yes annotation, which you can check by logging %note to 
access.log, OR the transaction is annotated as expected but is not 
delayed as expected).


Good luck,

Alex.



&gt;<i> Please check 
</I>&gt;<i> my config maybe i made a mistake. Or maybe have you any other solution?
</I>&gt;<i> I can use proxy users from QUOTA_EXCEEDED_USERS.acl which contain e-mail 
</I>&gt;<i> address or get from ldap with external_acl_type overkvota 
</I>&gt;<i> children-max=10 children-startup=10 ttl=600 negative_ttl=600 %LOGIN 
</I>&gt;<i> /usr/lib/squid/ext_ldap_group_acl -Z -v 3 -P -p 389 -h ldapm1.xxxxx.hu 
</I>&gt;<i> -s sub -D cn=squid_proxy,o=services -W /etc/squid/secret -b o=xxxx -f 
</I>&gt;<i> &quot;(&amp;(mail=%u)(objectclass=InetorgPerson)(InternetUser=true)(QuotaExceeded=true))&quot;
</I>&gt;<i> *acl QUOTA_EXCEEDED_USERS ext_user &quot;/etc/squid/QUOTA_EXCEEDED_USERS.acl&quot;*
</I>&gt;<i> *acl markAsLimited annotate_transaction limited=yes*
</I>&gt;<i> *acl markedAsLimited note limited yes*
</I>&gt;<i> *http_access allow QUOTA_EXCEEDED_USERS markAsLimited !all
</I>&gt;<i> *
</I>&gt;<i> *delay_pools 1
</I>&gt;<i> delay_class 1 1
</I>&gt;<i> delay_parameters 1 32000/32000
</I>&gt;<i> delay_access 1 allow markedAsLimited
</I>&gt;<i> delay_access 1 deny all*
</I>&gt;<i> br,
</I>&gt;<i> Szilard
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;&gt;&gt;<i> Alex Rousskov &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt; 02/20/2024, 04:52 PM &gt;&gt;&gt;
</I>&gt;<i> On 2024-02-20 03:14, Francesco Chemolli wrote:
</I>&gt;<i> 
</I>&gt;<i>  &gt; acl users ext_user foo bar gazonk
</I>&gt;<i>  &gt; http_access allow users all # always allow
</I>&gt;<i> 
</I>&gt;<i> The above does not always allow. What you meant it probably this:
</I>&gt;<i> 
</I>&gt;<i> # This rule never matches. It is used for its side effect:
</I>&gt;<i> # The rule evaluates users ACL, caching evaluation result.
</I>&gt;<i> http_access allow users !all
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i>  &gt; delay_access 3 allow users
</I>&gt;<i>  &gt;
</I>&gt;<i>  &gt; should do the trick
</I>&gt;<i> 
</I>&gt;<i> ... but sometimes will not. Wiki recommendation to &quot;exploit caching&quot; is
</I>&gt;<i> an ugly outdated hack that should be avoided. The correct solution these
</I>&gt;<i> days is to use annotate_transaction ACL to mark the transaction
</I>&gt;<i> accordingly. Here is an untested sketch:
</I>&gt;<i> 
</I>&gt;<i> acl fromUserThatShouldBeLimited ext_user ...
</I>&gt;<i> acl markAsLimited annotate_transaction limited=yes
</I>&gt;<i> acl markedAsLimited note limited yes
</I>&gt;<i> 
</I>&gt;<i> # This rule never matches; used for its annotation side effect.
</I>&gt;<i> http_access allow fromUserThatShouldBeLimited markAsLimited !all
</I>&gt;<i> 
</I>&gt;<i> delay_access 3 allow markedAsLimited
</I>&gt;<i> 
</I>&gt;<i> HTH,
</I>&gt;<i> 
</I>&gt;<i> Alex.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i>  &gt; On Tue, Feb 20, 2024 at 2:15&#8239;PM Szil&#225;rd Horv&#225;th wrote:
</I>&gt;<i>  &gt;
</I>&gt;<i>  &gt; Good Day!
</I>&gt;<i>  &gt;
</I>&gt;<i>  &gt; I try to make limitation bandwidth for some user group. I have an
</I>&gt;<i>  &gt; external acl which get the users from ldap database server. In the
</I>&gt;<i>  &gt; old version of config we blocked the internet with http_access deny
</I>&gt;<i>  &gt; GROUP, but now i try to allow the internet which has limited
</I>&gt;<i>  &gt; bandwidth. I know that the delay_access work with only fast ACL and
</I>&gt;<i>  &gt; external acl or proxy_auth acl are slow. I already tried some
</I>&gt;<i>  &gt; opportunity but i couldn't solve.
</I>&gt;<i>  &gt;
</I>&gt;<i>  &gt; Maybe have you any solution for this? Or any idea how can limitation
</I>&gt;<i>  &gt; the bandwidth for some user? I need use the username (e-mail address
</I>&gt;<i>  &gt; format) because that use to login to the proxy.
</I>&gt;<i>  &gt;
</I>&gt;<i>  &gt; Version: Squid Cache: Version 5.6
</I>&gt;<i>  &gt;
</I>&gt;<i>  &gt; Thank you so much and i am waiting for your answer!
</I>&gt;<i>  &gt;
</I>&gt;<i>  &gt; Have a good day!
</I>&gt;<i>  &gt;
</I>&gt;<i>  &gt; Br,
</I>&gt;<i>  &gt; Szilard Horvath
</I>&gt;<i>  &gt;
</I>&gt;<i>  &gt; _______________________________________________
</I>&gt;<i>  &gt; squid-users mailing list
</I>&gt;<i>  &gt; <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i>  &gt; &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>&gt;
</I>&gt;<i>  &gt; <A HREF="https://lists.squid-cache.org/listinfo/squid-users">https://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i>  &gt; &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">https://lists.squid-cache.org/listinfo/squid-users</A>&gt;
</I>&gt;<i>  &gt;
</I>&gt;<i>  &gt;
</I>&gt;<i>  &gt;
</I>&gt;<i>  &gt; --
</I>&gt;<i>  &gt; Francesco
</I>&gt;<i>  &gt;
</I>&gt;<i>  &gt; _______________________________________________
</I>&gt;<i>  &gt; squid-users mailing list
</I>&gt;<i>  &gt; <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i>  &gt; <A HREF="https://lists.squid-cache.org/listinfo/squid-users">https://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i> 
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="026485.html">[squid-users] Squid delay_access with external acl
</A></li>
	<LI>Next message (by thread): <A HREF="026487.html">[squid-users] Missing IPv6 sockets in Squid 6.7 in some servers
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26486">[ date ]</a>
              <a href="thread.html#26486">[ thread ]</a>
              <a href="subject.html#26486">[ subject ]</a>
              <a href="author.html#26486">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
