<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Missing IPv6 sockets in Squid 6.7 in some servers
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Missing%20IPv6%20sockets%20in%20Squid%206.7%20in%20some%20servers&In-Reply-To=%3Cd276b611-deb3-41a4-8d85-4509391103e4%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="026487.html">
   <LINK REL="Next"  HREF="026489.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Missing IPv6 sockets in Squid 6.7 in some servers</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Missing%20IPv6%20sockets%20in%20Squid%206.7%20in%20some%20servers&In-Reply-To=%3Cd276b611-deb3-41a4-8d85-4509391103e4%40measurement-factory.com%3E"
       TITLE="[squid-users] Missing IPv6 sockets in Squid 6.7 in some servers">rousskov at measurement-factory.com
       </A><BR>
    <I>Mon Mar  4 19:43:00 UTC 2024</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="026487.html">[squid-users] Missing IPv6 sockets in Squid 6.7 in some servers
</A></li>
        <LI>Next message (by thread): <A HREF="026489.html">[squid-users] Missing IPv6 sockets in Squid 6.7 in some servers
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26488">[ date ]</a>
              <a href="thread.html#26488">[ thread ]</a>
              <a href="subject.html#26488">[ subject ]</a>
              <a href="author.html#26488">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 2024-03-04 14:03, Dragos Pacher wrote:

&gt;<i> POC running well on 3 servers but on the 4th I get no IPv6
</I>&gt;<i> sockets:
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">ubuntu at A2-3</A>:/$ sudo netstat -patun | grep squid | grep tcp
</I>&gt;<i> tcp &#160; &#160; &#160; &#160;0 &#160; &#160; &#160;0 10.10.0.16:3128 &#160; &#160; &#160; &#160; 0.0.0.0:*               
</I>&gt;<i> LISTEN &#160; &#160; &#160;2891391/(squid-1)
</I>
Are there any other processes listening on IPv6 addresses on this 
problematic host?

Does something like &quot;nc -6 -l 3128&quot; listen on an IPv6 address on this 
problematic host?

If possible, please also check cache.log for messages mentioning IPv6 
and &quot;BCP 177&quot;; I know you shared syslog output, but I am a bit worried 
that syslog might be missing some relevant early debugging messages.


If nothing helps, consider sharing a pointer to compressed Squid startup 
cache.log after adding &quot;debug_options ALL,2 50,3&quot; to your squid.conf. We 
do not need to see any transactions, just Squid startup steps. Still, 
this log may contain some sensitive details, so share privately if needed.


Thank you,

Alex.



&gt;<i> and on the other 3 I have IPv6:
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">ubuntu at A2-2</A>:/$ sudo netstat -patun | grep squid | grep tcp
</I>&gt;<i> tcp &#160; &#160; &#160; &#160;0 &#160; &#160; &#160;0 x.x.x.x:52386 &#160;&#160; x.x.x.x:443 &#160; &#160; ESTABLISHED 
</I>&gt;<i> 997651/(squid-1)
</I>&gt;<i> tcp6 &#160; &#160; &#160; 0 &#160; &#160; &#160;0 :::3128 &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; :::*                   
</I>&gt;<i>  &#160;LISTEN &#160; &#160; &#160;997651/(squid-1)
</I>&gt;<i> tcp6 &#160; &#160; &#160; 0 &#160; &#160; &#160;0 10.10.0.12:3128 &#160; &#160; &#160; &#160; 10.20.0.1:39428       
</I>&gt;<i>  &#160;ESTABLISHED 997651/(squid-1)
</I>




&gt;<i> This creates a problem for us since the apps I monitor are not starting 
</I>&gt;<i> since their start routine is IPV6 only and then they switch to 
</I>&gt;<i> IPv4/IPV6, but the start is IPV6 alone.
</I>&gt;<i> 
</I>&gt;<i> Therefore my questions are as follows:
</I>&gt;<i> 
</I>&gt;<i>  1. How can I make it listen on both IPV6/IPV4 like on the other servers?
</I>&gt;<i>  2. Any configuration improvement suggestions?
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Please find all details here:
</I>&gt;<i> So far I did a POC on 4 servers, here is the full config, nothing 
</I>&gt;<i> sophisticated since this is where my Squid knowledge took me so far. 
</I>&gt;<i> Running Squid 6.7 with some basic options
</I>&gt;<i> on Ubuntu 22.04 kernel 5.15.0-89-generic x86_64
</I>&gt;<i> squid -v
</I>&gt;<i> Squid Cache: Version 6.7
</I>&gt;<i> Service Name: squid
</I>&gt;<i> This binary uses OpenSSL 3.0.2 15 Mar 2022. configure options: 
</I>&gt;<i>  &#160;'--prefix=/usr' '--localstatedir=/var' '--libexecdir=/lib/squid' 
</I>&gt;<i> '--datadir=/share/squid' '--sysconfdir=/etc/squid' 
</I>&gt;<i> '--with-default-user=proxy' '--with-logdir=/var/log/squid' 
</I>&gt;<i> '--enable-ssl-crtd' '--with-openssl'
</I>&gt;<i> 
</I>&gt;<i> and here is the syslog of Squid start:
</I>&gt;<i> Mar &#160;4 16:09:28 A2-3 systemd[1]: Starting Squid Web Proxy Server...
</I>&gt;<i> Mar &#160;4 16:09:28 A2-3 squid[3094662]: 2024/03/04 16:09:28| Processing 
</I>&gt;<i> Configuration File: /etc/squid/squid.conf (depth 0)
</I>&gt;<i> Mar &#160;4 16:09:28 A2-3 squid[3094662]: 2024/03/04 16:09:28| WARNING: empty 
</I>&gt;<i> ACL: acl broken_sites ssl::server_name &quot;/etc/squid/ssl_broken_sites.txt&quot;
</I>&gt;<i> Mar &#160;4 16:09:28 A2-3 squid[3094662]: 2024/03/04 16:09:28| WARNING: The 
</I>&gt;<i> &quot;Hs&quot; formatting code is deprecated. Use the &quot;&gt;Hs&quot; instead.
</I>&gt;<i> Mar &#160;4 16:09:28 A2-3 squid[3094662]: 2024/03/04 16:09:28| Created PID 
</I>&gt;<i> file (/var/run/squid.pid)
</I>&gt;<i> Mar &#160;4 16:09:28 A2-3 squid[3094662]: Squid Parent: will start 1 kids
</I>&gt;<i> Mar &#160;4 16:09:28 A2-3 squid[3094662]: Squid Parent: (squid-1) process 
</I>&gt;<i> 3094665 started
</I>&gt;<i> Mar &#160;4 16:09:28 A2-3 squid[3094665]: 2024/03/04 16:09:28 kid1| 
</I>&gt;<i> Processing Configuration File: /etc/squid/squid.conf (depth 0)
</I>&gt;<i> Mar &#160;4 16:09:28 A2-3 squid[3094665]: 2024/03/04 16:09:28 kid1| WARNING: 
</I>&gt;<i> empty ACL: acl broken_sites ssl::server_name 
</I>&gt;<i> &quot;/etc/squid/ssl_broken_sites.txt&quot;
</I>&gt;<i> Mar &#160;4 16:09:28 A2-3 squid[3094665]: 2024/03/04 16:09:28 kid1| WARNING: 
</I>&gt;<i> The &quot;Hs&quot; formatting code is deprecated. Use the &quot;&gt;Hs&quot; instead.
</I>&gt;<i> Mar &#160;4 16:09:28 A2-3 squid[3094665]: 2024/03/04 16:09:28 kid1| Set 
</I>&gt;<i> Current Directory to /var/cache/squid
</I>&gt;<i> Mar &#160;4 16:09:28 A2-3 squid[3094665]: 2024/03/04 16:09:28 kid1| Creating 
</I>&gt;<i> missing swap directories
</I>&gt;<i> Mar &#160;4 16:09:28 A2-3 squid[3094665]: 2024/03/04 16:09:28 kid1| No 
</I>&gt;<i> cache_dir stores are configured.
</I>&gt;<i> Mar &#160;4 16:09:28 A2-3 squid[3094662]: Squid Parent: squid-1 process 
</I>&gt;<i> 3094665 exited with status 0
</I>&gt;<i> Mar &#160;4 16:09:28 A2-3 squid[3094662]: 2024/03/04 16:09:28| Removing PID 
</I>&gt;<i> file (/var/run/squid.pid)
</I>&gt;<i> Mar &#160;4 16:09:28 A2-3 squid[3094666]: Processing Configuration File: 
</I>&gt;<i> /etc/squid/squid.conf (depth 0)
</I>&gt;<i> Mar &#160;4 16:09:28 A2-3 squid[3094666]: WARNING: empty ACL: acl 
</I>&gt;<i> broken_sites ssl::server_name &quot;/etc/squid/ssl_broken_sites.txt&quot;
</I>&gt;<i> Mar &#160;4 16:09:28 A2-3 squid[3094666]: WARNING: The &quot;Hs&quot; formatting code 
</I>&gt;<i> is deprecated. Use the &quot;&gt;Hs&quot; instead.
</I>&gt;<i> Mar &#160;4 16:09:28 A2-3 squid[3094666]: Created PID file (/var/run/squid.pid)
</I>&gt;<i> Mar &#160;4 16:09:28 A2-3 squid[3094666]: Squid Parent: will start 1 kids
</I>&gt;<i> Mar &#160;4 16:09:28 A2-3 squid[3094666]: Squid Parent: (squid-1) process 
</I>&gt;<i> 3094668 started
</I>&gt;<i> Mar &#160;4 16:09:28 A2-3 squid[3094668]: Processing Configuration File: 
</I>&gt;<i> /etc/squid/squid.conf (depth 0)
</I>&gt;<i> Mar &#160;4 16:09:28 A2-3 squid[3094668]: WARNING: empty ACL: acl 
</I>&gt;<i> broken_sites ssl::server_name &quot;/etc/squid/ssl_broken_sites.txt&quot;
</I>&gt;<i> Mar &#160;4 16:09:28 A2-3 squid[3094668]: WARNING: The &quot;Hs&quot; formatting code 
</I>&gt;<i> is deprecated. Use the &quot;&gt;Hs&quot; instead.
</I>&gt;<i> Mar &#160;4 16:09:28 A2-3 squid[3094668]: Set Current Directory to 
</I>&gt;<i> /var/cache/squid
</I>&gt;<i> Mar &#160;4 16:09:28 A2-3 squid[3094668]: Starting Squid Cache version 6.7 
</I>&gt;<i> for x86_64-pc-linux-gnu...
</I>&gt;<i> Mar &#160;4 16:09:28 A2-3 squid[3094668]: Service Name: squid
</I>&gt;<i> Mar &#160;4 16:09:28 A2-3 squid[3094668]: Process ID 3094668
</I>&gt;<i> Mar &#160;4 16:09:28 A2-3 squid[3094668]: Process Roles: worker
</I>&gt;<i> Mar &#160;4 16:09:28 A2-3 squid[3094668]: With 1000000 file descriptors available
</I>&gt;<i> Mar &#160;4 16:09:28 A2-3 squid[3094668]: Initializing IP Cache...
</I>&gt;<i> Mar &#160;4 16:09:28 A2-3 squid[3094668]: DNS IPv6 socket created at [::], FD 9
</I>&gt;<i> Mar &#160;4 16:09:28 A2-3 squid[3094668]: DNS IPv4 socket created at 0.0.0.0, 
</I>&gt;<i> FD 10
</I>&gt;<i> Mar &#160;4 16:09:28 A2-3 squid[3094668]: Adding nameserver 127.0.0.53 from 
</I>&gt;<i> /etc/resolv.conf
</I>&gt;<i> Mar &#160;4 16:09:28 A2-3 squid[3094668]: Adding domain . from /etc/resolv.conf
</I>&gt;<i> Mar &#160;4 16:09:28 A2-3 squid[3094668]: helperOpenServers: Starting 5/5 
</I>&gt;<i> 'security_file_certgen' processes
</I>&gt;<i> Mar &#160;4 16:09:28 A2-3 squid[3094668]: Logfile: opening log 
</I>&gt;<i> stdio:/var/log/squid/success.log
</I>&gt;<i> Mar &#160;4 16:09:28 A2-3 squid[3094668]: Logfile: opening log 
</I>&gt;<i> stdio:/var/log/squid/failure.log
</I>&gt;<i> Mar &#160;4 16:09:28 A2-3 squid[3094668]: Logfile: opening log 
</I>&gt;<i> daemon:/var/log/squid/access.log
</I>&gt;<i> Mar &#160;4 16:09:28 A2-3 squid[3094668]: Logfile Daemon: opening log 
</I>&gt;<i> /var/log/squid/access.log
</I>&gt;<i> Mar &#160;4 16:09:28 A2-3 squid[3094668]: Store logging disabled
</I>&gt;<i> Mar &#160;4 16:09:28 A2-3 squid[3094668]: Swap maxSize 0 + 262144 KB, 
</I>&gt;<i> estimated 20164 objects
</I>&gt;<i> Mar &#160;4 16:09:28 A2-3 squid[3094668]: Target number of buckets: 1008
</I>&gt;<i> Mar &#160;4 16:09:28 A2-3 squid[3094668]: Using 8192 Store buckets
</I>&gt;<i> Mar &#160;4 16:09:28 A2-3 squid[3094668]: Max Mem &#160;size: 262144 KB
</I>&gt;<i> Mar &#160;4 16:09:28 A2-3 squid[3094668]: Max Swap size: 0 KB
</I>&gt;<i> Mar &#160;4 16:09:28 A2-3 squid[3094668]: Using Least Load store dir selection
</I>&gt;<i> Mar &#160;4 16:09:28 A2-3 squid[3094668]: Set Current Directory to 
</I>&gt;<i> /var/cache/squid
</I>&gt;<i> Mar &#160;4 16:09:28 A2-3 squid[3094668]: Finished loading MIME types and icons.
</I>&gt;<i> Mar &#160;4 16:09:28 A2-3 squid[3094668]: HTCP Disabled.
</I>&gt;<i> Mar &#160;4 16:09:28 A2-3 squid[3094668]: Squid plugin modules loaded: 0
</I>&gt;<i> Mar &#160;4 16:09:28 A2-3 squid[3094668]: Adaptation support is off.
</I>&gt;<i> Mar &#160;4 16:09:28 A2-3 squid[3094668]: Accepting SSL bumped HTTP Socket 
</I>&gt;<i> connections at conn13 local=10.10.0.16:3128 remote=[::] FD 25 
</I>&gt;<i> flags=9#012 &#160; &#160;listening port: 10.10.0.16:3128
</I>&gt;<i> Mar &#160;4 16:09:28 A2-3 systemd[1]: Started Squid Web Proxy Server.
</I>&gt;<i> Mar &#160;4 16:09:29 A2-3 squid[3094668]: storeLateRelease: released 0 objects
</I>&gt;<i> 
</I>&gt;<i> -- full config --
</I>&gt;<i> acl SSL_ports port 443
</I>&gt;<i> acl SSL_ports port 443
</I>&gt;<i> http_access allow localhost
</I>&gt;<i> http_access allow localnet
</I>&gt;<i> http_access allow all
</I>&gt;<i> 
</I>&gt;<i> acl step1 at_step SslBump1
</I>&gt;<i> acl step2 at_step SslBump2
</I>&gt;<i> acl step3 at_step SslBump3
</I>&gt;<i> 
</I>&gt;<i> acl broken_sites ssl::server_name &quot;/etc/squid/ssl_broken_sites.txt&quot;
</I>&gt;<i> http_upgrade_request_protocols websocket allow all
</I>&gt;<i> 
</I>&gt;<i> ssl_bump peek step1 all
</I>&gt;<i> ssl_bump splice broken_sites
</I>&gt;<i> ssl_bump stare step2 all
</I>&gt;<i> ssl_bump bump step3 all
</I>&gt;<i> 
</I>&gt;<i> acl CONNECT method CONNECT
</I>&gt;<i> acl success_hier hier_code HIER_DIRECT
</I>&gt;<i> acl failure_hier hier_code HIER_NONE
</I>&gt;<i> acl failure all-of CONNECT failure_hier
</I>&gt;<i> acl failure all-of !CONNECT failure_codes
</I>&gt;<i> acl success all-of CONNECT success_hier
</I>&gt;<i> acl success all-of !CONNECT success_codes
</I>&gt;<i> 
</I>&gt;<i> access_log stdio:/var/log/squid/success.log logformat=squid success
</I>&gt;<i> access_log stdio:/var/log/squid/failure.log logformat=squid failure
</I>&gt;<i> 
</I>&gt;<i> cache deny all
</I>&gt;<i> 
</I>&gt;<i> http_port [::]:3128 ssl-bump generate-host-certificates=on 
</I>&gt;<i> dynamic_cert_mem_cache_size=8MB tls-cert=/etc/squid/myCA.pem 
</I>&gt;<i> tls-key=/etc/squid/myCA1.pem
</I>&gt;<i> strip_query_terms off
</I>&gt;<i> 
</I>&gt;<i> logformat timereadable %tl %6tr %&gt;a %Ss/%03Hs %&lt;st %rm %ru %un %Sh/%&lt;A %mt
</I>&gt;<i> access_log daemon:/var/log/squid/access.log timereadable
</I>&gt;<i> 
</I>&gt;<i> coredump_dir /var/cache/squid
</I>&gt;<i> refresh_pattern ^ftp: &#160; &#160; &#160; &#160; &#160; 1440 &#160; &#160;20% &#160; &#160; 10080
</I>&gt;<i> refresh_pattern -i (/cgi-bin/|\?) 0 &#160; &#160; 0% &#160; &#160; &#160;0
</I>&gt;<i> refresh_pattern . &#160; &#160; &#160; &#160; &#160; &#160; &#160; 0 &#160; &#160; &#160; 20% &#160; &#160; 4320
</I>&gt;<i> sslcrtd_program /usr/lib/squid/security_file_certgen -s 
</I>&gt;<i> /var/lib/squid/ssl_db -M 16MB
</I>&gt;<i> sslcrtd_children 5
</I>&gt;<i> ssl_bump server-first all
</I>&gt;<i> sslproxy_cert_error allow all
</I>&gt;<i> -- end of config
</I>&gt;<i> 
</I>&gt;<i> Thank you,
</I>&gt;<i> 
</I>&gt;<i> Dragos
</I>&gt;<i> 
</I>&gt;<i> Sent with Proton Mail &lt;<A HREF="https://proton.me/">https://proton.me/</A>&gt; secure email.
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">https://lists.squid-cache.org/listinfo/squid-users</A>
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="026487.html">[squid-users] Missing IPv6 sockets in Squid 6.7 in some servers
</A></li>
	<LI>Next message (by thread): <A HREF="026489.html">[squid-users] Missing IPv6 sockets in Squid 6.7 in some servers
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26488">[ date ]</a>
              <a href="thread.html#26488">[ thread ]</a>
              <a href="subject.html#26488">[ subject ]</a>
              <a href="author.html#26488">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
