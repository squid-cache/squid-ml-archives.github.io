<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Missing IPv6 sockets in Squid 6.7 in some servers
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Missing%20IPv6%20sockets%20in%20Squid%206.7%20in%20some%20servers&In-Reply-To=%3C7m1_Xrm6WA3f7jnlMmszKwoDSF3ML9fe6CysaaCHl_Ze_swxF9waTM0vx14kjimVrmva1xgGW_T_lo537dqpclfA1JLpQ3olMoEblJtqhwY%3D%40proton.me%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="026496.html">
   <LINK REL="Next"  HREF="026494.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Missing IPv6 sockets in Squid 6.7 in some servers</H1>
    <B>Dragos Pacher</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Missing%20IPv6%20sockets%20in%20Squid%206.7%20in%20some%20servers&In-Reply-To=%3C7m1_Xrm6WA3f7jnlMmszKwoDSF3ML9fe6CysaaCHl_Ze_swxF9waTM0vx14kjimVrmva1xgGW_T_lo537dqpclfA1JLpQ3olMoEblJtqhwY%3D%40proton.me%3E"
       TITLE="[squid-users] Missing IPv6 sockets in Squid 6.7 in some servers">dragosrp at proton.me
       </A><BR>
    <I>Tue Mar  5 12:22:52 UTC 2024</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="026496.html">[squid-users] Missing IPv6 sockets in Squid 6.7 in some servers
</A></li>
        <LI>Next message (by thread): <A HREF="026494.html">[squid-users] [squid-announce] [ADVISORY] SQUID-2024:1 Denial of Service in HTTP Chunked Decoding
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26498">[ date ]</a>
              <a href="thread.html#26498">[ thread ]</a>
              <a href="subject.html#26498">[ subject ]</a>
              <a href="author.html#26498">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>So far it seems there are some issues with my docker networks on the host, thank you for your help, I will come later if this will not be the case.

Kind regards,

Dragos

On Tuesday, March 5th, 2024 at 11:59 AM, Dragos Pacher &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">dragosrp at proton.me</A>&gt; wrote:

&gt;<i> Please see my replies in between the lines below.
</I>&gt;<i> 
</I>&gt;<i> On Tuesday, March 5th, 2024 at 5:40 AM, Amos Jeffries <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A> wrote:
</I>&gt;<i> 
</I>&gt;<i> &gt; On 5/03/24 08:03, Dragos Pacher wrote:
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; &gt; Hello,
</I>&gt;<i> &gt; &gt; 
</I>&gt;<i> &gt; &gt; I am a Squid beginner and we would like to use Squid inside our
</I>&gt;<i> &gt; &gt; organization only as a HTTPS traffic inspection/logging tool for some
</I>&gt;<i> &gt; &gt; 3rd party apps that we bought,
</I>&gt;<i> &gt; &gt; something close to what a &quot;MITM proxy&quot; is called but we will not do
</I>&gt;<i> &gt; &gt; that, instead we use a self signed certificate and the 3rd party app
</I>&gt;<i> &gt; &gt; owners know this. Everything is
</I>&gt;<i> &gt; &gt; 100% completely legal. (Ps: I am the IT lead).
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; FYI: &quot;MITM proxy&quot; is a ridiculous term. &quot;MITM&quot; means &quot;intermediary&quot; in
</I>&gt;<i> &gt; security terminology, &quot;proxy&quot; means &quot;intermediary&quot; in networking
</I>&gt;<i> &gt; terminology.
</I>&gt;<i> &gt; So that term just means &quot;intermediary intermediary&quot;, yeah.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> I did not coined this term, I was referring to this: <A HREF="https://mitmproxy.org,">https://mitmproxy.org,</A>
</I>&gt;<i> I guess it entered IT popular culture somehow..
</I>&gt;<i> 
</I>&gt;<i> &gt; Any serious HTTPS inspection/logging by Squid needs some form of
</I>&gt;<i> &gt; SSL-Bump configuration and those 3rd-party Apps MUST be configured with
</I>&gt;<i> &gt; trust for the self-signed root CA you are using.
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; Without that nothing Squid (or any other proxy) does will allow traffic
</I>&gt;<i> &gt; inspection beyond the initial TLS handshake.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> I specified in my first email I did this already, maybe I was not so clear but
</I>&gt;<i> my self-signed certificate is working with the 3rd party apps.
</I>&gt;<i> 
</I>&gt;<i> &gt; Assuming that you have checked that detail, on to your issue ...
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; &gt; We will be using Squid only internally, no outside access. Here is my
</I>&gt;<i> &gt; &gt; issue with the current knowledge of Squid: POC running well on 3 servers
</I>&gt;<i> &gt; &gt; but on the 4th I get no IPv6
</I>&gt;<i> &gt; &gt; sockets:
</I>&gt;<i> &gt; &gt; <A HREF="https://lists.squid-cache.org/listinfo/squid-users">ubuntu at A2-3</A>:/$ sudo netstat -patun | grep squid | grep tcp
</I>&gt;<i> &gt; &gt; tcp 0 0 10.10.0.16:3128 0.0.0.0:*
</I>&gt;<i> &gt; &gt; LISTEN 2891391/(squid-1)
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; Your problem is the https(s)_port &quot;port&quot; configuration parameter.
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; This Squid is configured to listen like:
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; http_port 10.10.0.16:3128
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; or
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; http_port example.com:3128
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; (when example.com has only address 10.10.0.16)
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; The &quot;http_port&quot; receives port 80 syntax traffic, it may also be
</I>&gt;<i> &gt; &quot;https_port&quot; which receives port 443 syntax traffic.
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; &gt; and on the other 3 I have IPv6:
</I>&gt;<i> &gt; &gt; <A HREF="https://lists.squid-cache.org/listinfo/squid-users">ubuntu at A2-2</A>:/$ sudo netstat -patun | grep squid | grep tcp
</I>&gt;<i> &gt; &gt; tcp 0 0 x.x.x.x:52386 x.x.x.x:443 ESTABLISHED
</I>&gt;<i> &gt; &gt; 997651/(squid-1)
</I>&gt;<i> &gt; &gt; tcp6 0 0 :::3128 :::*
</I>&gt;<i> &gt; &gt; LISTEN 997651/(squid-1)
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; These Squid are configured to listen like:
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; http_port 3128
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; Ensure that the machine/server the 4th Squid is running on has its
</I>&gt;<i> &gt; http(s)_port line matching the other three machines port value.
</I>&gt;<i> &gt; 
</I>&gt;<i> &gt; At this point do not care about the &quot;mode&quot; or options later in the line.
</I>&gt;<i> &gt; Your issue is solely the &quot;port&quot; parameter.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> So far it seems I was missing [::] in my http_port in the problem server, because of automatic deployment
</I>&gt;<i> something went wrong and I assumed my Squid configuration is all the same all over the place. I fixed this but the issue is still there,
</I>&gt;<i> please see: this is inside a docker container on a healthy server:
</I>&gt;<i> # netstat -patun
</I>&gt;<i> Active Internet connections (servers and established)
</I>&gt;<i> Proto Recv-Q Send-Q Local Address Foreign Address State PID/Program name
</I>&gt;<i> tcp 0 0 127.0.0.11:41421 0.0.0.0:* LISTEN 1574/dockerd
</I>&gt;<i> tcp 0 1 172.18.0.10:46950 10.10.0.16:3128 SYN_SENT 307601/node
</I>&gt;<i> udp 0 0 127.0.0.11:57486 0.0.0.0:* 1574/dockerd
</I>&gt;<i> 
</I>&gt;<i> and same netstat on the unhealthy server, still inside docker:
</I>&gt;<i> 
</I>&gt;<i> Active Internet connections (servers and established)
</I>&gt;<i> Proto Recv-Q Send-Q Local Address Foreign Address State PID/Program name
</I>&gt;<i> tcp 0 0 127.0.0.11:38339 0.0.0.0:* LISTEN 273025/dockerd
</I>&gt;<i> tcp 0 0 172.18.0.4:50666 10.10.0.11:3128 ESTABLISHED 494253/node
</I>&gt;<i> tcp6 0 0 :::8080 :::* LISTEN 494253/node
</I>&gt;<i> tcp6 0 0 127.0.0.1:8080 127.0.0.1:46168 TIME_WAIT -
</I>&gt;<i> tcp6 0 0 127.0.0.1:8080 127.0.0.1:44480 TIME_WAIT -
</I>&gt;<i> udp 0 0 127.0.0.11:56639 0.0.0.0:* 273025/dockerd
</I>&gt;<i> 
</I>&gt;<i> and a tcpdump from the docker bridge interface, 172.18.0.10 is my issue container with the SYN sent only
</I>&gt;<i> 
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at A2-3</A>:~# tcpdump -i br-7b47c165c9ba dst port 3128 -vvv
</I>&gt;<i> tcpdump: listening on br-7b47c165c9ba, link-type EN10MB (Ethernet), snapshot length 262144 bytes
</I>&gt;<i> 09:55:53.436758 IP (tos 0x0, ttl 64, id 48752, offset 0, flags [DF], proto TCP (6), length 60)
</I>&gt;<i> 172.18.0.10.59056 &gt; A2-3.3128: Flags [S], cksum 0xb661 (incorrect -&gt; 0x0dd4), seq 2115452268, win 65535, options [mss 1460,sackOK,TS val 1708093369 ecr 0,nop,wscale 11], length 0
</I>&gt;<i> 
</I>&gt;<i> 09:56:20.845804 IP (tos 0x0, ttl 64, id 40649, offset 0, flags [DF], proto TCP (6), length 60)
</I>&gt;<i> 172.18.0.10.56272 &gt; A2-3.3128: Flags [S], cksum 0xb661 (incorrect -&gt; 0x48f3), seq 2480704598, win 65535, options [mss 1460,sackOK,TS val 1708120778 ecr 0,nop,wscale 11], length 0
</I>&gt;<i> 
</I>&gt;<i> 09:56:21.852827 IP (tos 0x0, ttl 64, id 40650, offset 0, flags [DF], proto TCP (6), length 60)
</I>&gt;<i> 172.18.0.10.56272 &gt; A2-3.3128: Flags [S], cksum 0xb661 (incorrect -&gt; 0x4504), seq 2480704598, win 65535, options [mss 1460,sackOK,TS val 1708121785 ecr 0,nop,wscale 11], length 0
</I>&gt;<i> 
</I>&gt;<i> 09:56:23.868762 IP (tos 0x0, ttl 64, id 40651, offset 0, flags [DF], proto TCP (6), length 60)
</I>&gt;<i> 172.18.0.10.56272 &gt; A2-3.3128: Flags [S], cksum 0xb661 (incorrect -&gt; 0x3d24), seq 2480704598, win 65535, options [mss 1460,sackOK,TS val 1708123801 ecr 0,nop,wscale 11], length 0
</I>&gt;<i> 
</I>&gt;<i> 09:56:27.996768 IP (tos 0x0, ttl 64, id 40652, offset 0, flags [DF], proto TCP (6), length 60)
</I>&gt;<i> 172.18.0.10.56272 &gt; A2-3.3128: Flags [S], cksum 0xb661 (incorrect -&gt; 0x2d04), seq 2480704598, win 65535, options [mss 1460,sackOK,TS val 1708127929 ecr 0,nop,wscale 11], length 0
</I>&gt;<i> 
</I>&gt;<i> 09:56:36.188758 IP (tos 0x0, ttl 64, id 40653, offset 0, flags [DF], proto TCP (6), length 60)
</I>&gt;<i> 172.18.0.10.56272 &gt; A2-3.3128: Flags [S], cksum 0xb661 (incorrect -&gt; 0x0d04), seq 2480704598, win 65535, options [mss 1460,sackOK,TS val 1708136121 ecr 0,nop,wscale 11], length 0
</I>&gt;<i> 
</I>&gt;<i> 09:56:52.316463 IP (tos 0x0, ttl 64, id 40654, offset 0, flags [DF], proto TCP (6), length 60)
</I>&gt;<i> 172.18.0.10.56272 &gt; A2-3.3128: Flags [S], cksum 0xb661 (incorrect -&gt; 0xce03), seq 2480704598, win 65535, options [mss 1460,sackOK,TS val 1708152249 ecr 0,nop,wscale 11], length 0
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 7 packets captured
</I>&gt;<i> 7 packets received by filter
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Why the SYN sent only state? Any ideas?
</I>&gt;<i> 
</I>&gt;<i> Thank you,
</I>&gt;<i> 
</I>&gt;<i> Dragos
</I>&gt;<i> 
</I>&gt;<i> &gt; Cheers
</I>&gt;<i> &gt; Amos
</I>&gt;<i> &gt; _______________________________________________
</I>&gt;<i> &gt; squid-users mailing list
</I>&gt;<i> &gt; <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> &gt; <A HREF="https://lists.squid-cache.org/listinfo/squid-users">https://lists.squid-cache.org/listinfo/squid-users</A>
</I>
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="026496.html">[squid-users] Missing IPv6 sockets in Squid 6.7 in some servers
</A></li>
	<LI>Next message (by thread): <A HREF="026494.html">[squid-users] [squid-announce] [ADVISORY] SQUID-2024:1 Denial of Service in HTTP Chunked Decoding
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26498">[ date ]</a>
              <a href="thread.html#26498">[ thread ]</a>
              <a href="subject.html#26498">[ subject ]</a>
              <a href="author.html#26498">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
