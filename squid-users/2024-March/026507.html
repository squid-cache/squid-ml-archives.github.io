<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid Proxy timing out 500/503 errors
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20Proxy%20timing%20out%20500/503%20errors&In-Reply-To=%3CDM4PR84MB3032BF389F49D52CC5CBBFB190202%40DM4PR84MB3032.NAMPRD84.PROD.OUTLOOK.COM%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="026501.html">
   <LINK REL="Next"  HREF="026508.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid Proxy timing out 500/503 errors</H1>
    <B>M, Anitha (CSS)</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20Proxy%20timing%20out%20500/503%20errors&In-Reply-To=%3CDM4PR84MB3032BF389F49D52CC5CBBFB190202%40DM4PR84MB3032.NAMPRD84.PROD.OUTLOOK.COM%3E"
       TITLE="[squid-users] Squid Proxy timing out 500/503 errors">anitha.m at hpe.com
       </A><BR>
    <I>Thu Mar  7 17:20:17 UTC 2024</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="026501.html">[squid-users] Squid Proxy timing out 500/503 errors
</A></li>
        <LI>Next message (by thread): <A HREF="026508.html">[squid-users] Squid Proxy timing out 500/503 errors
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26507">[ date ]</a>
              <a href="thread.html#26507">[ thread ]</a>
              <a href="subject.html#26507">[ subject ]</a>
              <a href="author.html#26507">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Team,

Thanks for the  quick response. 

We have cleaned up the squid configuration file  as per the below feedback. 
Pls review the below file.  

Pls note, even with below changes we still have 503/500 errors when squid is loaded up with 300+ requests.  Would really help if any other insights on this issue. 

=======================================
# Recommended minimum configuration:
acl localnet src 172.28.1.0/24
acl localnet src 172.28.4.0/24
acl localnet src 172.28.0.0/24

acl localnet src 0.0.0.1-0.255.255.255  # RFC 1122 &quot;this&quot; network (LAN)
acl localnet src 10.0.0.0/8             # RFC 1918 local private network (LAN)
acl localnet src 100.64.0.0/10          # RFC 6598 shared address space (CGN)
acl localnet src 169.254.0.0/16         # RFC 3927 link-local (directly plugged) machines
acl localnet src 172.28.11.0/24
acl localnet src 172.16.117.0/24
acl localnet src 20.20.30.0/21

acl parent_proxy_exclude dst 20.20.30.0/21
acl servicenet dst 172.28.4.0/24
#acl parent_proxy_exclude_ST0100 dst 20.20.30.222/22
#always_direct allow parent_proxy_exclude_ST0100

always_direct allow parent_proxy_exclude
always_direct allow servicenet

acl blocksites url_regex &quot;/etc/squid/blocksites&quot;
http_access deny blocksites

#debug_options ALL,5

acl SSL_ports port 443
acl SSL_ports port 8071
acl SSL_ports port 11052
acl Safe_ports port 80          # http
acl Safe_ports port 21          # ftp
acl Safe_ports port 443         # https
acl Safe_ports port 70          # gopher
acl Safe_ports port 210         # wais
acl Safe_ports port 1025-65535  # unregistered ports
acl Safe_ports port 280         # http-mgmt
acl Safe_ports port 488         # gss-http
acl Safe_ports port 591         # filemaker
acl Safe_ports port 777         # multiling http
acl Safe_ports port 53          # pdns
acl Safe_ports port 5300        # pdns
acl Safe_ports port 123     #NTP
acl Safe_ports port 8071
acl Safe_ports port 11052       # pdns web server
acl Safe_ports port 514         # rsyslog
acl Safe_ports port 8200
acl SSL_ports port 8053
acl Safe_ports port 8053
acl SSL_ports port 3002
acl Safe_ports port 3002
acl SSL_ports port 3006
acl Safe_ports port 3006
acl SSL_ports port 8203
acl Safe_ports port 8203
acl SSL_ports port 8204
acl Safe_ports port 8204
acl SSL_ports port 8099
acl SSL_ports port 8099
acl SSL_ports port 8282
acl Safe_ports port 8282
acl SSL_ports port 8200
acl Safe_ports port 8200

acl CONNECT method CONNECT


tcp_outgoing_address 20.20.30.3

#
# Recommended minimum Access Permission configuration:
#
# Deny requests to certain unsafe ports
http_access deny !Safe_ports

# Deny CONNECT to other than secure SSL ports
http_access deny CONNECT !SSL_ports

# Only allow cachemgr access from localhost
http_access allow localhost manager
http_access deny manager

# We strongly recommend the following be uncommented to protect innocent
# web applications running on the proxy server who think the only
# one who can access services on &quot;localhost&quot; is a local user
#http_access deny to_localhost

#
# INSERT YOUR OWN RULE(S) HERE TO ALLOW ACCESS FROM YOUR CLIENTS
#

# Example rule allowing access from your local networks.
# Adapt localnet in the ACL section to list your (internal) IP networks
# from where browsing should be allowed
http_access allow localnet
http_access allow localhost

# And finally deny all other access to this proxy
http_access deny all

cache_peer proxy-in.its.hpecorp.net parent 443 0 no-query default
acl parent_proxy src all
http_access allow parent_proxy
never_direct allow parent_proxy

# Squid normally listens to port 3128
http_port 3128

# Leave coredumps in the first cache dir
coredump_dir /var/cache/squid

#
# Add any of your own refresh_pattern entries above these.
#
refresh_pattern ^ftp:           1440    20%     10080
refresh_pattern ^gopher:        1440    0%      1440
refresh_pattern -i (/cgi-bin/|\?) 0     0%      0
refresh_pattern .               0       20%     4320

dns_nameservers 172.28.0.121 16.110.135.52

max_filedescriptors 64000
cache_dir ufs /var/cache/squid 8192 16 256
cache_mem 2096 MB
cache_swap_high 95
cache_swap_low 90
ftp_passive on
maximum_object_size 4096 MB
memory_replacement_policy lru
minimum_object_size 0 KB

=========================================

Regards,
Anitha. 

-----Original Message-----
From: squid-users &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>&gt; On Behalf Of Amos Jeffries
Sent: Wednesday, March 6, 2024 1:07 PM
To: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
Subject: Re: [squid-users] Squid Proxy timing out 500/503 errors

On 6/03/24 07:23, M, Anitha (CSS) wrote:
&gt;<i> Hi team,
</I>&gt;<i> 
</I>&gt;<i> We are using squid service deployed as a KVM VM on SLES 15 Sp5 os image.
</I>&gt;<i> 
</I>&gt;<i> We are using squid. Rpm: *squid-5.7-150400.3.20.1.x86_64*
</I>&gt;<i> 
</I>&gt;<i> **
</I>&gt;<i> 
</I>&gt;<i> We are seeing too many 503 errors with this version of squid.
</I>&gt;<i> 
</I>&gt;<i> This is the squid configuration file. Pls review it and let us know if 
</I>&gt;<i> issues.
</I>&gt;<i> 
</I>
It appears that your configuration file consists of at least 2 different configuration files appended to each other.

Please start by running &quot;squid -k parse&quot; and fixing all the warnings it should produce.


&gt;<i> We are performing squid scale testing, where every secs there will be 
</I>&gt;<i> 200+requests reaching the squid and squid is spitting out 500/503 errors.
</I>&gt;<i> 
</I>
FYI: you have restricted Squid to no more than 3200 filedescriptors. 
That is rather low. I recommend at least 64K.


&gt;<i> Squid.conf:
</I>&gt;<i> 
</I>&gt;<i> gl-pcesreblr-squidproxy03:/var/log/squid # cat /etc/squid/squid.conf
</I>&gt;<i> # Recommended minimum configuration:
</I>&gt;<i> acl localnet src 172.28.1.0/24
</I>&gt;<i> acl localnet src 172.28.4.0/24
</I>&gt;<i> acl localnet src 172.28.0.0/24
</I>&gt;<i> acl localnet src 172.28.0.12/32
</I>&gt;<i> connect_timeout 120 seconds
</I>&gt;<i> connect_retries 10
</I>&gt;<i> #debug_options ALL,5
</I>&gt;<i> #connect_retries_delay 5 seconds
</I>&gt;<i> acl localnet src 0.0.0.1-0.255.255.255&#160; # RFC 1122 &quot;this&quot; network (LAN)
</I>&gt;<i> acl localnet src 10.0.0.0/8&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; # RFC 1918 local private network 
</I>&gt;<i> (LAN)
</I>&gt;<i> acl localnet src 100.64.0.0/10&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; # RFC 6598 shared address space 
</I>&gt;<i> (CGN)
</I>&gt;<i> acl localnet src 169.254.0.0/16&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; # RFC 3927 link-local (directly 
</I>&gt;<i> plugged) machines
</I>&gt;<i> acl localnet src 172.28.11.0/24
</I>&gt;<i> #acl localnet src 172.16.0.0/12&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; # RFC 1918 local private network 
</I>&gt;<i> (LAN)
</I>&gt;<i> #acl localnet src 192.168.0.0/16&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; # RFC 1918 local private 
</I>&gt;<i> network (LAN)
</I>&gt;<i> #acl localnet src fc00::/7&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; # RFC 4193 local private network 
</I>&gt;<i> range
</I>&gt;<i> #acl localnet src fe80::/10&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; # RFC 4291 link-local (directly 
</I>&gt;<i> plugged) machines
</I>&gt;<i> 
</I>&gt;<i> acl blocksites url_regex &quot;/etc/squid/blocksites&quot;
</I>&gt;<i> http_access deny blocksites
</I>&gt;<i> 
</I>&gt;<i> debug_options ALL,7
</I>&gt;<i> 
</I>&gt;<i> acl SSL_ports port 443
</I>&gt;<i> acl SSL_ports port 8071
</I>&gt;<i> acl SSL_ports port 11052
</I>&gt;<i> acl Safe_ports port 80&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; # http
</I>&gt;<i> acl Safe_ports port 21&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; # ftp
</I>&gt;<i> acl Safe_ports port 443&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; # https
</I>&gt;<i> acl Safe_ports port 70&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; # gopher
</I>&gt;<i> acl Safe_ports port 210&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; # wais
</I>&gt;<i> acl Safe_ports port 1025-65535&#160; # unregistered ports
</I>&gt;<i> acl Safe_ports port 280&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; # http-mgmt
</I>&gt;<i> acl Safe_ports port 488&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; # gss-http
</I>&gt;<i> acl Safe_ports port 591&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; # filemaker
</I>&gt;<i> acl Safe_ports port 777&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; # multiling http
</I>&gt;<i> acl Safe_ports port 53&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; # pdns
</I>&gt;<i> acl Safe_ports port 5300&#160;&#160;&#160;&#160;&#160;&#160;&#160; # pdns
</I>&gt;<i> acl Safe_ports port 123&#160;&#160;&#160;&#160; #NTP
</I>&gt;<i> acl Safe_ports port 8071
</I>&gt;<i> acl Safe_ports port 11052&#160;&#160;&#160;&#160;&#160;&#160; # pdns web server
</I>&gt;<i> acl Safe_ports port 514&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; # rsyslog
</I>&gt;<i> acl CONNECT method CONNECT
</I>&gt;<i> acl SSL_ports port 8053
</I>&gt;<i> acl Safe_ports port 8053
</I>&gt;<i> acl SSL_ports port 3002
</I>&gt;<i> acl Safe_ports port 3002
</I>&gt;<i> acl SSL_ports port 3006
</I>&gt;<i> acl Safe_ports port 3006
</I>&gt;<i> acl SSL_ports port 8203
</I>&gt;<i> acl Safe_ports port 8203
</I>&gt;<i> acl SSL_ports port 8204
</I>&gt;<i> acl Safe_ports port 8204
</I>&gt;<i> acl SSL_ports port 8071
</I>&gt;<i> acl Safe_ports port 8071
</I>&gt;<i> acl Safe_ports port 8200
</I>&gt;<i> acl SSL_ports port 8099
</I>&gt;<i> acl Safe_ports port 8099
</I>&gt;<i> tcp_outgoing_address 20.20.30.5
</I>&gt;<i> 
</I>&gt;<i> #
</I>&gt;<i> # Recommended minimum Access Permission configuration:
</I>&gt;<i> #
</I>&gt;<i> # Deny requests to certain unsafe ports
</I>&gt;<i> http_access deny !Safe_ports
</I>&gt;<i> 
</I>&gt;<i> # Deny CONNECT to other than secure SSL ports
</I>&gt;<i> http_access deny CONNECT !SSL_ports
</I>&gt;<i> 
</I>&gt;<i> # Only allow cachemgr access from localhost
</I>&gt;<i> http_access allow localhost manager
</I>&gt;<i> http_access deny manager
</I>&gt;<i> 
</I>&gt;<i> # We strongly recommend the following be uncommented to protect innocent
</I>&gt;<i> # web applications running on the proxy server who think the only
</I>&gt;<i> # one who can access services on &quot;localhost&quot; is a local user
</I>&gt;<i> #http_access deny to_localhost
</I>&gt;<i> 
</I>&gt;<i> #
</I>&gt;<i> # INSERT YOUR OWN RULE(S) HERE TO ALLOW ACCESS FROM YOUR CLIENTS
</I>&gt;<i> #
</I>
Please notice what the above line says.

&gt;<i> 
</I>&gt;<i> # Example rule allowing access from your local networks.
</I>&gt;<i> # Adapt localnet in the ACL section to list your (internal) IP networks
</I>&gt;<i> # from where browsing should be allowed
</I>&gt;<i> http_access allow localnet
</I>&gt;<i> http_access allow localhost
</I>&gt;<i> 
</I>&gt;<i> # And finally deny all other access to this proxy
</I>&gt;<i> #http_access deny all
</I>&gt;<i> #http_access allow all
</I>&gt;<i> 
</I>&gt;<i> cache_peer proxy-in.its.hpecorp.net parent 443 0 no-query no-delay default
</I>
... so a server listening for plain-text HTTP on port 443. That is a bit 
broken. At least consider enabling TLS/SSL on connections to this peer 
so Squid can send it HTTPS traffic.


&gt;<i> #cache_peer 16.242.46.11 parent 8080 0 no-query default
</I>&gt;<i> #cache_peer 10.132.100.29 parent 3128 0 no-query default
</I>&gt;<i> 
</I>&gt;<i> acl parent_proxy src all
</I>&gt;<i> http_access allow parent_proxy
</I>
The above two lines are identical to:
   http_access allow all

... no http_access lines following this one will ever have any effects.

&gt;<i> never_direct allow parent_proxy
</I>
Likewise same as:
   never_direct allow all

... however you have always_direct rules later that override this.

&gt;<i> 
</I>&gt;<i> # Squid normally listens to port 3128
</I>&gt;<i> http_port 3128
</I>&gt;<i> 
</I>&gt;<i> # Leave coredumps in the first cache dir
</I>&gt;<i> coredump_dir /var/cache/squid
</I>&gt;<i> 
</I>&gt;<i> #
</I>&gt;<i> # Add any of your own refresh_pattern entries above these.
</I>&gt;<i> #
</I>&gt;<i> refresh_pattern ^ftp:&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; 1440&#160;&#160;&#160; 20%&#160;&#160;&#160;&#160; 10080
</I>&gt;<i> refresh_pattern ^gopher:&#160;&#160;&#160;&#160;&#160;&#160;&#160; 1440&#160;&#160;&#160; 0%&#160;&#160;&#160;&#160;&#160; 1440
</I>&gt;<i> refresh_pattern -i (/cgi-bin/|\?) 0&#160;&#160;&#160;&#160; 0%&#160;&#160;&#160;&#160;&#160; 0
</I>&gt;<i> refresh_pattern .&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; 0&#160;&#160;&#160;&#160;&#160;&#160; 20%&#160;&#160;&#160;&#160; 4320
</I>&gt;<i> 
</I>&gt;<i> dns_nameservers 172.28.0.121 16.110.135.52
</I>&gt;<i> 
</I>&gt;<i> max_filedescriptors 3200
</I>&gt;<i> cache_dir ufs /var/cache/squid 8192 16 256
</I>&gt;<i> cache_mem 2096 MB
</I>&gt;<i> cache_swap_high 95
</I>&gt;<i> cache_swap_low 90
</I>&gt;<i> ftp_passive on
</I>&gt;<i> maximum_object_size 4096 MB
</I>&gt;<i> memory_replacement_policy lru
</I>&gt;<i> minimum_object_size 0 KB
</I>&gt;<i> 
</I>
At this point your file just starts repeating rules, with different 
settings. Some of these replace the above settings, some append to the, 
and some have no effect due to earlier rules.


&gt;<i> # Recommended minimum configuration:
</I>&gt;<i> acl localnet src 172.28.4.0/24
</I>&gt;<i> acl localnet src 172.28.0.0/24
</I>&gt;<i> acl localnet src 172.28.1.0/24 # OOBM Network outbound access
</I>&gt;<i> #acl HOGAN dst hogan.nimblestorage.com
</I>&gt;<i> acl localnet src 0.0.0.1-0.255.255.255 # RFC 1122 &#8220;this&#8221; network (LAN)
</I>&gt;<i> acl blocksites url_regex &#8220;/etc/squid/blocksites&#8221;
</I>&gt;<i> http_access deny blocksites
</I>&gt;<i> acl SSL_ports port 443
</I>&gt;<i> acl SSL_ports port 8071
</I>&gt;<i> acl SSL_ports port 11052
</I>&gt;<i> acl SSL_ports port 8200
</I>&gt;<i> acl SSL_ports port 8282
</I>&gt;<i> acl Safe_ports port 8282
</I>&gt;<i> #acl HOGAN_port port 2222 # hogan.nimblestorage.com:2222 SSH support tunnel
</I>&gt;<i> # Example rule allowing access from your local networks.
</I>&gt;<i> # Adapt localnet in the ACL section to list your (internal) IP networks
</I>&gt;<i> # from where browsing should be allowed
</I>&gt;<i> acl localnet src 172.16.117.0/24
</I>&gt;<i> http_access allow localnet
</I>&gt;<i> http_access allow localhost
</I>&gt;<i> #http_access allow HOGAN HOGAN_port
</I>&gt;<i> acl localnet src 20.20.30.0/21
</I>&gt;<i> acl parent_proxy_exclude dst 20.20.30.0/21
</I>&gt;<i> acl parent_proxy_exclude_ST0100 dst 20.20.30.222/22
</I>&gt;<i> always_direct allow parent_proxy_exclude_ST0100
</I>&gt;<i> acl servicenet dst 172.28.4.0/24
</I>&gt;<i> always_direct allow parent_proxy_exclude
</I>&gt;<i> always_direct allow servicenet
</I>&gt;<i> 
</I>

HTH
Amos

_______________________________________________
squid-users mailing list
<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
<A HREF="https://lists.squid-cache.org/listinfo/squid-users">https://lists.squid-cache.org/listinfo/squid-users</A> 
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="026501.html">[squid-users] Squid Proxy timing out 500/503 errors
</A></li>
	<LI>Next message (by thread): <A HREF="026508.html">[squid-users] Squid Proxy timing out 500/503 errors
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26507">[ date ]</a>
              <a href="thread.html#26507">[ thread ]</a>
              <a href="subject.html#26507">[ subject ]</a>
              <a href="author.html#26507">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
