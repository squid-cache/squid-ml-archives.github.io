<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] ACL / http_access rules stop work using Squid 6+
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20ACL%20/%20http_access%20rules%20stop%20work%20using%20Squid%206%2B&In-Reply-To=%3C9cd03f00-a87e-4c48-8a9c-61eb6751c0d9%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="026536.html">
   <LINK REL="Next"  HREF="026533.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] ACL / http_access rules stop work using Squid 6+</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20ACL%20/%20http_access%20rules%20stop%20work%20using%20Squid%206%2B&In-Reply-To=%3C9cd03f00-a87e-4c48-8a9c-61eb6751c0d9%40measurement-factory.com%3E"
       TITLE="[squid-users] ACL / http_access rules stop work using Squid 6+">rousskov at measurement-factory.com
       </A><BR>
    <I>Fri Mar 29 17:40:58 UTC 2024</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="026536.html">[squid-users] ACL / http_access rules stop work using Squid 6+
</A></li>
        <LI>Next message (by thread): <A HREF="026533.html">[squid-users] GCC optimizer is provably junk. Here is the evidence.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26541">[ date ]</a>
              <a href="thread.html#26541">[ thread ]</a>
              <a href="subject.html#26541">[ subject ]</a>
              <a href="author.html#26541">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 2024-03-25 15:13, Bolinhas Andr&#233; wrote:

&gt;<i> Yes, the configuration is the same for both versions.
</I>
The logs archive you shared previously has expired, so I cannot double 
check, but from what I remember, the shared logs did not support the 
above assertion, so there may be more to the story here. However, to 
make progress, let's assume that v5 configuration files are identical to 
v6 configuration files.

1. Is there an &quot;http_access allow all AnnotateFinalAllow&quot; rule?

2. Is there an &quot;http_access deny HTTP Group38 AnnotateRule28&quot; rule?

3. Assuming the answers are &quot;yes&quot; and &quot;yes&quot;, which rule comes first? If 
you use include files, this question applies to the imaginary 
preprocessed squid.conf file with all the include files inlined 
(recursively if needed). That kind of preprocessed configuration is what 
Squid effectively sees when compiling http_access rules, one by one. 
Which of the two rules will Squid see first?

One way to answer all of the above questions is to look at the following 
output:

     squid -k parse ... |&amp; grep Processing:.http_access

Replace &quot;...&quot; with your regular squid startup command line options and 
adjust standard error redirection (|&amp;) as needed for your shell. Run the 
above command for both Squid v5 and v6 binaries. You should see output 
like this:


&gt;<i> 2024/03/29 13:31:05| Processing: http_access allow manager
</I>&gt;<i> 2024/03/29 13:31:05| Processing: http_access deny all
</I>

HTH,

Alex.


&gt;<i> ------------------------------------------------------------------------
</I>&gt;<i> *De:* Alex Rousskov &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt;
</I>&gt;<i> *Enviado:* segunda-feira, 25 de mar&#231;o de 2024 19:12
</I>&gt;<i> *Para:* <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> *Assunto* Re: [squid-users] ACL / http_access rules stop work using Squid 6+
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> On 2024-03-22 09:38, Andre Bolinhas wrote:
</I>&gt;<i> 
</I>&gt;<i>  &gt; In previous versions of squid, from 3 to 5.9, I use this kind of deny
</I>&gt;<i>  &gt; rules and they work like charm
</I>&gt;<i>  &gt;
</I>&gt;<i>  &gt; acl AnnotateRule28 annotate_transaction accessrule=Rule28
</I>&gt;<i>  &gt; http_access deny HTTP Group38 AnnotateRule28
</I>&gt;<i>  &gt;
</I>&gt;<i>  &gt; This allows me to deny objects without bump / show the error page
</I>&gt;<i>  &gt; (deny_info)
</I>&gt;<i>  &gt;
</I>&gt;<i>  &gt; But using squid 6+ this rules stop to work and everything is allowed.
</I>&gt;<i>  &gt;
</I>&gt;<i>  &gt; Example:
</I>&gt;<i>  &gt; Squid 5.9 (OK)
</I>&gt;<i>  &gt; <A HREF="https://ibb.co/YdKgL1Y">https://ibb.co/YdKgL1Y</A>
</I>&gt;<i>  &gt;
</I>&gt;<i>  &gt; Squid 6.8 (NOK)
</I>&gt;<i>  &gt; <A HREF="https://ibb.co/tbyY2GV">https://ibb.co/tbyY2GV</A>
</I>&gt;<i>  &gt;
</I>&gt;<i>  &gt; Sample of both cache.log in debug mode
</I>&gt;<i>  &gt;
</I>&gt;<i>  &gt; <A HREF="https://we.tl/t-T7Nz1rVbVu">https://we.tl/t-T7Nz1rVbVu</A>
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> In you v6 logs, most logged transactions are allowed because a rule
</I>&gt;<i> similar to the one reconstructed below is matching:
</I>&gt;<i> 
</I>&gt;<i>  &#160;&#160;&#160;&#160; http_access allow all AnnotateFinalAllow
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> There are similar cases in v5 logs as well, but most denied v5
</I>&gt;<i> transactions match the following rule instead (i.e. the one you shared
</I>&gt;<i> above):
</I>&gt;<i> 
</I>&gt;<i>  &#160;&#160;&#160;&#160; http_access deny HTTP Group38 AnnotateRule28
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> In your Squid configuration, v6 allow rule is listed much higher than v5
</I>&gt;<i> deny rule (#43 vs #149). I do not see any signs of Group38 or
</I>&gt;<i> AnnotateRule28 ACL evaluation in v6 logs, as if the rule sets are
</I>&gt;<i> different for two different Squid instances. Are you using the same set
</I>&gt;<i> of http_access rules for both Squid versions?
</I>&gt;<i> 
</I>&gt;<i> Alex.
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">https://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i> 
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="026536.html">[squid-users] ACL / http_access rules stop work using Squid 6+
</A></li>
	<LI>Next message (by thread): <A HREF="026533.html">[squid-users] GCC optimizer is provably junk. Here is the evidence.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26541">[ date ]</a>
              <a href="thread.html#26541">[ thread ]</a>
              <a href="subject.html#26541">[ subject ]</a>
              <a href="author.html#26541">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
