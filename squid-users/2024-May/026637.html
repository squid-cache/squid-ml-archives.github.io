<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid TCP_TUNNEL_ABORTED/200
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20TCP_TUNNEL_ABORTED/200&In-Reply-To=%3C0fafca47-b7fe-460c-8f42-3f15f89f1f26%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="026636.html">
   <LINK REL="Next"  HREF="026638.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid TCP_TUNNEL_ABORTED/200</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20TCP_TUNNEL_ABORTED/200&In-Reply-To=%3C0fafca47-b7fe-460c-8f42-3f15f89f1f26%40treenet.co.nz%3E"
       TITLE="[squid-users] Squid TCP_TUNNEL_ABORTED/200">squid3 at treenet.co.nz
       </A><BR>
    <I>Fri May  3 16:31:25 UTC 2024</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="026636.html">[squid-users] Squid TCP_TUNNEL_ABORTED/200
</A></li>
        <LI>Next message (by thread): <A HREF="026638.html">[squid-users] Squid TCP_TUNNEL_ABORTED/200
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26637">[ date ]</a>
              <a href="thread.html#26637">[ thread ]</a>
              <a href="subject.html#26637">[ subject ]</a>
              <a href="author.html#26637">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 4/05/24 02:29, Emre Oksum wrote:
&gt;<i> Hi everyone,
</I>&gt;<i> 
</I>&gt;<i> I'm having a issue with Squid Cache 4.10 which I cannot fix for weeks 
</I>&gt;<i> now and kinda lost at the moment. I will be appreciated if someone can 
</I>&gt;<i> guide me through the issue I'm having.
</I>&gt;<i> I need to create a IPv6 HTTP proxy which should match the entry address 
</I>&gt;<i> to outgoing TCP address. For example, if user is connecting from 
</I>&gt;<i> fe80:abcd::1 it should exit the HTTP proxy from the same address. We got 
</I>&gt;<i> like 50k addresses like this at the moment.
</I>
What your &quot;for example,...&quot; describes is Transparent Proxy (TPROXY).


However, what you have in the config below is very different. The IP the 
client is connected **to** (not &quot;from&quot;) is being pinned on outgoing 
connections.


&gt;<i> The issue is, client connecting to the proxy is receiving &quot;EOF&quot; or 
</I>&gt;<i> &quot;FLOW_CONTROL_ERROR&quot; on their side.
</I>
The FLOW_CONTROL_ERROR is not something produced by Squid. Likely it 
comes from the TCP stack and/or OS routing system.

The EOF may be coming from either Squid or the OS. It also may be 
perfectly normal for the circumstances, or a side effect of an error 
elsewhere.


To solve will require identifying exactly what is sending those signals, 
and why. Since they are signals going to the client, focus on the 
client-&gt;Squid connections (not the Squid-&gt;server ones you talk about 
testing below).



&gt;<i> When I test connection by connecting 
</I>&gt;<i> to whatismyip.com &lt;<A HREF="http://whatismyip.com">http://whatismyip.com</A>&gt; everything works fine and 
</I>&gt;<i> entry IP always matches with outgoing IP for each of the 50k addresses. 
</I>&gt;<i> Client tells me this problem occurs both at GET and POST requests with 
</I>&gt;<i> around 10 MB of data.
</I>
Well, you are trying to manually force certain flow patterns that 
prohibit or break some major HTTP performance features. Some problems 
are to be expected.

The issues which I expect to occur in your proxy would not show up in a 
trivial outgoing-IP or connectivity test.


&gt;<i> I initially thought that could be related to server resources being 
</I>&gt;<i> drained but upon inspecting server resource usage, Squid isn't even 
</I>&gt;<i> topping at 100% CPU or RAM anytime so not that.
</I>&gt;<i> 
</I>
IMO, &quot;FLOW_CONTROL_ERROR&quot; is likely related to quantity of traffic 
flooding through the proxy to specific origin servers.

The concept you are implementing of the outgoing TCP connection having 
the same IP as the incoming connection reduces the available TCP sockets 
by 25%. Prohibiting the OS from allocating ports on otherwise unused 
outgoing addresses when



&gt;<i> My Squid.conf is like this at the moment:
</I>
Some improvements highlighted inline below.
Nothing stands out to me as being related to your issues.

&gt;<i> 
</I>&gt;<i> auth_param basic program /usr/lib/squid/basic_ncsa_auth /etc/squid/passwd
</I>&gt;<i> acl auth_users proxy_auth REQUIRED
</I>&gt;<i> http_access allow auth_users
</I>&gt;<i> http_access deny !auth_users
</I>
Above two lines are backwards. Deny first, then allow.


&gt;<i> cache deny all
</I>&gt;<i> dns_nameservers &lt;nameservers here&gt;
</I>&gt;<i> dns_v4_first off
</I>&gt;<i> via off
</I>&gt;<i> forwarded_for delete
</I>&gt;<i> follow_x_forwarded_for deny all
</I>&gt;<i> server_persistent_connections off
</I>
*If* the issue turns out to be congestion on Squid-&gt;server connections
enabling this might be worthwhile. Otherwise it should be fine.


&gt;<i> max_filedesc 1048576
</I>
You can remove that line. &quot;max_filedesc&quot; was a RedHat hack from 20+ 
years ago when the feature was experimental.

Any value you set on the line above, will be erased and replaced by the 
line below:


&gt;<i> max_filedescriptors 1048576
</I>&gt;<i> workers 8
</I>&gt;<i> http_port [::0]:1182
</I>
Above is just a complicated way to write:

  http_port 1182


Any particular reason not to use the registered port 3128 ?
(Not important, just wondering.)


&gt;<i> acl binding1 myip fe80:abcd::1
</I>&gt;<i> tcp_outgoing_address fe80:abcd::1 binding1
</I>&gt;<i> acl binding2 myip fe80:abcd::2
</I>&gt;<i> tcp_outgoing_address fe80:abcd::2 binding2
</I>&gt;<i> acl binding3 myip fe80:abcd::3
</I>&gt;<i> tcp_outgoing_address fe80:abcd::3 binding3
</I>&gt;<i> ...
</I>&gt;<i> ...
</I>&gt;<i> ...
</I>&gt;<i> access_log /var/log/squid/access.log squid
</I>
&gt;<i> cache_store_log none
</I>
You can erase this line.
This is default setting. No need to manually set it.


&gt;<i> cache deny all
</I>
You can erase this line.
This &quot;cache deny all&quot; exists earlier in the config.


&gt;<i> 
</I>&gt;<i> I've tried to get a PCAP file and realized when client tries to connect 
</I>&gt;<i> with a new IPv6 address, Squid is not trying to open a new connection 
</I>&gt;<i> instead tries to resume a previously opened one on a different outgoing 
</I>&gt;<i> IPv6 address.
</I>
Can you provide the trace demonstrating that issue?

Although, as noted earlier your problems are apparently on the client 
connections. This is about server connections behaviour.


&gt;<i> I set server_persistent_connections off which should have 
</I>&gt;<i> disabled this behavior but it's still the same.
</I>
Nod. Yes that should forbid re-use of connections.

I/we will need to see the PCAP trace along with a cache.log generated 
using &quot;debug_options ALL,6&quot; to confirm a bug or identify other breakage 
though.



&gt;<i> I tried using a newer 
</I>&gt;<i> version of Squid but it behaved differently and did not follow my 
</I>&gt;<i> outgoing address specifications and kept connecting on IPv4.
</I>
That would seem to indicate that your IPv4 connectivity is better than 
your IPv6 connectivity. Later Squid use various &quot;Happy Eyeballs&quot; 
implementations for the server selection.

You can usually work around this by configuring the DNS server specified 
by dns_nameservers to only deliver IPv6 results when a mixed set are 
available.


HTH
Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="026636.html">[squid-users] Squid TCP_TUNNEL_ABORTED/200
</A></li>
	<LI>Next message (by thread): <A HREF="026638.html">[squid-users] Squid TCP_TUNNEL_ABORTED/200
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26637">[ date ]</a>
              <a href="thread.html#26637">[ thread ]</a>
              <a href="subject.html#26637">[ subject ]</a>
              <a href="author.html#26637">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
