<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid TCP_TUNNEL_ABORTED/200
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20TCP_TUNNEL_ABORTED/200&In-Reply-To=%3CCADG8LiWapFmxnS5j%2BUUn8Pu-zFGfVFoF0Ck5H%2B7Pm7XUUkFV5Q%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="026637.html">
   <LINK REL="Next"  HREF="026639.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid TCP_TUNNEL_ABORTED/200</H1>
    <B>Emre Oksum</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20TCP_TUNNEL_ABORTED/200&In-Reply-To=%3CCADG8LiWapFmxnS5j%2BUUn8Pu-zFGfVFoF0Ck5H%2B7Pm7XUUkFV5Q%40mail.gmail.com%3E"
       TITLE="[squid-users] Squid TCP_TUNNEL_ABORTED/200">emreoksum at gmail.com
       </A><BR>
    <I>Fri May  3 17:36:44 UTC 2024</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="026637.html">[squid-users] Squid TCP_TUNNEL_ABORTED/200
</A></li>
        <LI>Next message (by thread): <A HREF="026639.html">[squid-users] Squid TCP_TUNNEL_ABORTED/200
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26638">[ date ]</a>
              <a href="thread.html#26638">[ thread ]</a>
              <a href="subject.html#26638">[ subject ]</a>
              <a href="author.html#26638">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Amos, thank you for your reply.

&gt;<i>What your &quot;for example,...&quot; describes is Transparent Proxy (TPROXY).
</I>&gt;<i>However, what you have in the config below is very different. The IP the
</I>&gt;<i>client is connected **to** (not &quot;from&quot;) is being pinned on outgoing
</I>&gt;<i>connections.
</I>
Sorry for the misunderstanding. Maybe I wasn't clear with my wording. I
only need to create a proxy instance where the IPv6 address that client
uses to connect to Squid, is used by Squid to connect to remote locations.
In this setup, server running Squid has around 50k IPv6 addresses assigned
to it and client is expected to connect to Squid proxy with 50k different
IPv6 addresses of the Squid and Squid should always use the IP address
client connects to it as outgoing address. I'm not sure if I explained that
well.

So if client connects to Squid proxy by the address of Squid let's say is
feef:1234::1, Squid should use that IP for outgoing connections. That's not
transparent proxy TPROXY because client and proxy is on different networks
in this setup. Just like ordinary HTTP proxies.

&gt;<i>The FLOW_CONTROL_ERROR is not something produced by Squid. Likely it
</I>&gt;<i>comes from the TCP stack and/or OS routing system.
</I>Client connects to Squid by a script written in Golang. Thats where they
get that error. On the Squid's access.log, I can see that error as
TCP_TUNNEL_ABORTED/200

&gt;<i>Some improvements highlighted inline below.
</I>&gt;<i>Nothing stands out to me as being related to your issues.
</I>Thank you, I'll fix them however I don't think this issue is any related to
the config.

&gt;<i>Any particular reason not to use the registered port 3128 ?
</I>&gt;<i>(Not important, just wondering.)
</I>My client wants to prevent proxies from being detected by bots so we picked
a different port number but it's not the one I shared here. I edited
numbers and addresses from the config before sharing it here.

&gt;<i>I/we will need to see the PCAP trace along with a cache.log generated
</I>&gt;<i>using &quot;debug_options ALL,6&quot; to confirm a bug or identify other breakage
</I>&gt;<i>though.
</I>Interestingly, debug_options ALL does not log anything related to this
issue to cache.log. That left me very confused about this problem.
I'm currently sending you the PCAP file. It's being uploaded. I would be
appreciated if you can take a look at it.

Thanks
Amos Jeffries &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt;, 3 May 2024 Cum, 19:31 tarihinde &#351;unu
yazd&#305;:

&gt;<i> On 4/05/24 02:29, Emre Oksum wrote:
</I>&gt;<i> &gt; Hi everyone,
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I'm having a issue with Squid Cache 4.10 which I cannot fix for weeks
</I>&gt;<i> &gt; now and kinda lost at the moment. I will be appreciated if someone can
</I>&gt;<i> &gt; guide me through the issue I'm having.
</I>&gt;<i> &gt; I need to create a IPv6 HTTP proxy which should match the entry address
</I>&gt;<i> &gt; to outgoing TCP address. For example, if user is connecting from
</I>&gt;<i> &gt; fe80:abcd::1 it should exit the HTTP proxy from the same address. We got
</I>&gt;<i> &gt; like 50k addresses like this at the moment.
</I>&gt;<i>
</I>&gt;<i> What your &quot;for example,...&quot; describes is Transparent Proxy (TPROXY).
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> However, what you have in the config below is very different. The IP the
</I>&gt;<i> client is connected **to** (not &quot;from&quot;) is being pinned on outgoing
</I>&gt;<i> connections.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; The issue is, client connecting to the proxy is receiving &quot;EOF&quot; or
</I>&gt;<i> &gt; &quot;FLOW_CONTROL_ERROR&quot; on their side.
</I>&gt;<i>
</I>&gt;<i> The FLOW_CONTROL_ERROR is not something produced by Squid. Likely it
</I>&gt;<i> comes from the TCP stack and/or OS routing system.
</I>&gt;<i>
</I>&gt;<i> The EOF may be coming from either Squid or the OS. It also may be
</I>&gt;<i> perfectly normal for the circumstances, or a side effect of an error
</I>&gt;<i> elsewhere.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> To solve will require identifying exactly what is sending those signals,
</I>&gt;<i> and why. Since they are signals going to the client, focus on the
</I>&gt;<i> client-&gt;Squid connections (not the Squid-&gt;server ones you talk about
</I>&gt;<i> testing below).
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; When I test connection by connecting
</I>&gt;<i> &gt; to whatismyip.com &lt;<A HREF="http://whatismyip.com">http://whatismyip.com</A>&gt; everything works fine and
</I>&gt;<i> &gt; entry IP always matches with outgoing IP for each of the 50k addresses.
</I>&gt;<i> &gt; Client tells me this problem occurs both at GET and POST requests with
</I>&gt;<i> &gt; around 10 MB of data.
</I>&gt;<i>
</I>&gt;<i> Well, you are trying to manually force certain flow patterns that
</I>&gt;<i> prohibit or break some major HTTP performance features. Some problems
</I>&gt;<i> are to be expected.
</I>&gt;<i>
</I>&gt;<i> The issues which I expect to occur in your proxy would not show up in a
</I>&gt;<i> trivial outgoing-IP or connectivity test.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; I initially thought that could be related to server resources being
</I>&gt;<i> &gt; drained but upon inspecting server resource usage, Squid isn't even
</I>&gt;<i> &gt; topping at 100% CPU or RAM anytime so not that.
</I>&gt;<i> &gt;
</I>&gt;<i>
</I>&gt;<i> IMO, &quot;FLOW_CONTROL_ERROR&quot; is likely related to quantity of traffic
</I>&gt;<i> flooding through the proxy to specific origin servers.
</I>&gt;<i>
</I>&gt;<i> The concept you are implementing of the outgoing TCP connection having
</I>&gt;<i> the same IP as the incoming connection reduces the available TCP sockets
</I>&gt;<i> by 25%. Prohibiting the OS from allocating ports on otherwise unused
</I>&gt;<i> outgoing addresses when
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; My Squid.conf is like this at the moment:
</I>&gt;<i>
</I>&gt;<i> Some improvements highlighted inline below.
</I>&gt;<i> Nothing stands out to me as being related to your issues.
</I>&gt;<i>
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; auth_param basic program /usr/lib/squid/basic_ncsa_auth /etc/squid/passwd
</I>&gt;<i> &gt; acl auth_users proxy_auth REQUIRED
</I>&gt;<i> &gt; http_access allow auth_users
</I>&gt;<i> &gt; http_access deny !auth_users
</I>&gt;<i>
</I>&gt;<i> Above two lines are backwards. Deny first, then allow.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; cache deny all
</I>&gt;<i> &gt; dns_nameservers &lt;nameservers here&gt;
</I>&gt;<i> &gt; dns_v4_first off
</I>&gt;<i> &gt; via off
</I>&gt;<i> &gt; forwarded_for delete
</I>&gt;<i> &gt; follow_x_forwarded_for deny all
</I>&gt;<i> &gt; server_persistent_connections off
</I>&gt;<i>
</I>&gt;<i> *If* the issue turns out to be congestion on Squid-&gt;server connections
</I>&gt;<i> enabling this might be worthwhile. Otherwise it should be fine.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; max_filedesc 1048576
</I>&gt;<i>
</I>&gt;<i> You can remove that line. &quot;max_filedesc&quot; was a RedHat hack from 20+
</I>&gt;<i> years ago when the feature was experimental.
</I>&gt;<i>
</I>&gt;<i> Any value you set on the line above, will be erased and replaced by the
</I>&gt;<i> line below:
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; max_filedescriptors 1048576
</I>&gt;<i> &gt; workers 8
</I>&gt;<i> &gt; http_port [::0]:1182
</I>&gt;<i>
</I>&gt;<i> Above is just a complicated way to write:
</I>&gt;<i>
</I>&gt;<i>   http_port 1182
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> Any particular reason not to use the registered port 3128 ?
</I>&gt;<i> (Not important, just wondering.)
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; acl binding1 myip fe80:abcd::1
</I>&gt;<i> &gt; tcp_outgoing_address fe80:abcd::1 binding1
</I>&gt;<i> &gt; acl binding2 myip fe80:abcd::2
</I>&gt;<i> &gt; tcp_outgoing_address fe80:abcd::2 binding2
</I>&gt;<i> &gt; acl binding3 myip fe80:abcd::3
</I>&gt;<i> &gt; tcp_outgoing_address fe80:abcd::3 binding3
</I>&gt;<i> &gt; ...
</I>&gt;<i> &gt; ...
</I>&gt;<i> &gt; ...
</I>&gt;<i> &gt; access_log /var/log/squid/access.log squid
</I>&gt;<i>
</I>&gt;<i> &gt; cache_store_log none
</I>&gt;<i>
</I>&gt;<i> You can erase this line.
</I>&gt;<i> This is default setting. No need to manually set it.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; cache deny all
</I>&gt;<i>
</I>&gt;<i> You can erase this line.
</I>&gt;<i> This &quot;cache deny all&quot; exists earlier in the config.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I've tried to get a PCAP file and realized when client tries to connect
</I>&gt;<i> &gt; with a new IPv6 address, Squid is not trying to open a new connection
</I>&gt;<i> &gt; instead tries to resume a previously opened one on a different outgoing
</I>&gt;<i> &gt; IPv6 address.
</I>&gt;<i>
</I>&gt;<i> Can you provide the trace demonstrating that issue?
</I>&gt;<i>
</I>&gt;<i> Although, as noted earlier your problems are apparently on the client
</I>&gt;<i> connections. This is about server connections behaviour.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; I set server_persistent_connections off which should have
</I>&gt;<i> &gt; disabled this behavior but it's still the same.
</I>&gt;<i>
</I>&gt;<i> Nod. Yes that should forbid re-use of connections.
</I>&gt;<i>
</I>&gt;<i> I/we will need to see the PCAP trace along with a cache.log generated
</I>&gt;<i> using &quot;debug_options ALL,6&quot; to confirm a bug or identify other breakage
</I>&gt;<i> though.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; I tried using a newer
</I>&gt;<i> &gt; version of Squid but it behaved differently and did not follow my
</I>&gt;<i> &gt; outgoing address specifications and kept connecting on IPv4.
</I>&gt;<i>
</I>&gt;<i> That would seem to indicate that your IPv4 connectivity is better than
</I>&gt;<i> your IPv6 connectivity. Later Squid use various &quot;Happy Eyeballs&quot;
</I>&gt;<i> implementations for the server selection.
</I>&gt;<i>
</I>&gt;<i> You can usually work around this by configuring the DNS server specified
</I>&gt;<i> by dns_nameservers to only deliver IPv6 results when a mixed set are
</I>&gt;<i> available.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> HTH
</I>&gt;<i> Amos
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">https://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20240503/950af113/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20240503/950af113/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="026637.html">[squid-users] Squid TCP_TUNNEL_ABORTED/200
</A></li>
	<LI>Next message (by thread): <A HREF="026639.html">[squid-users] Squid TCP_TUNNEL_ABORTED/200
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26638">[ date ]</a>
              <a href="thread.html#26638">[ thread ]</a>
              <a href="subject.html#26638">[ subject ]</a>
              <a href="author.html#26638">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
