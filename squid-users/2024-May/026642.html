<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid TCP_TUNNEL_ABORTED/200
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20TCP_TUNNEL_ABORTED/200&In-Reply-To=%3CCADG8LiX6MjY%2Bz%3D8pwe7R6guudE301uF3RVywyYi1SpKULUXX9g%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="026639.html">
   <LINK REL="Next"  HREF="026643.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid TCP_TUNNEL_ABORTED/200</H1>
    <B>Emre Oksum</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20TCP_TUNNEL_ABORTED/200&In-Reply-To=%3CCADG8LiX6MjY%2Bz%3D8pwe7R6guudE301uF3RVywyYi1SpKULUXX9g%40mail.gmail.com%3E"
       TITLE="[squid-users] Squid TCP_TUNNEL_ABORTED/200">emreoksum at gmail.com
       </A><BR>
    <I>Fri May  3 20:33:51 UTC 2024</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="026639.html">[squid-users] Squid TCP_TUNNEL_ABORTED/200
</A></li>
        <LI>Next message (by thread): <A HREF="026643.html">[squid-users] Squid TCP_TUNNEL_ABORTED/200
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26642">[ date ]</a>
              <a href="thread.html#26642">[ thread ]</a>
              <a href="subject.html#26642">[ subject ]</a>
              <a href="author.html#26642">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Jonathan,

&gt;&gt;<i> Have you attempted to enable debugging ??
</I>Yes, debugging was enabled but as I have pointed out, unfortunately it
didn't give any information about the issue.
Maybe I was missing something? I don't know. debug_options was ALL in my
squid.conf.

Thanks

Jonathan Lee &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">jonathanlee571 at gmail.com</A>&gt;, 3 May 2024 Cum, 23:00 tarihinde
&#351;unu yazd&#305;:

&gt;<i> Have you attempted to enable debugging ??
</I>&gt;<i>
</I>&gt;<i> Researching debug_options I found you can control detailed messages in the
</I>&gt;<i> cache.log
</I>&gt;<i> Sent from my iPhone
</I>&gt;<i>
</I>&gt;<i> On May 3, 2024, at 10:37, Emre Oksum &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">emreoksum at gmail.com</A>&gt; wrote:
</I>&gt;<i>
</I>&gt;<i> &#65279;
</I>&gt;<i> Hi Amos, thank you for your reply.
</I>&gt;<i>
</I>&gt;<i> &gt;What your &quot;for example,...&quot; describes is Transparent Proxy (TPROXY).
</I>&gt;<i> &gt;However, what you have in the config below is very different. The IP the
</I>&gt;<i> &gt;client is connected **to** (not &quot;from&quot;) is being pinned on outgoing
</I>&gt;<i> &gt;connections.
</I>&gt;<i>
</I>&gt;<i> Sorry for the misunderstanding. Maybe I wasn't clear with my wording. I
</I>&gt;<i> only need to create a proxy instance where the IPv6 address that client
</I>&gt;<i> uses to connect to Squid, is used by Squid to connect to remote locations.
</I>&gt;<i> In this setup, server running Squid has around 50k IPv6 addresses assigned
</I>&gt;<i> to it and client is expected to connect to Squid proxy with 50k different
</I>&gt;<i> IPv6 addresses of the Squid and Squid should always use the IP address
</I>&gt;<i> client connects to it as outgoing address. I'm not sure if I explained that
</I>&gt;<i> well.
</I>&gt;<i>
</I>&gt;<i> So if client connects to Squid proxy by the address of Squid let's say is
</I>&gt;<i> feef:1234::1, Squid should use that IP for outgoing connections. That's not
</I>&gt;<i> transparent proxy TPROXY because client and proxy is on different networks
</I>&gt;<i> in this setup. Just like ordinary HTTP proxies.
</I>&gt;<i>
</I>&gt;<i> &gt;The FLOW_CONTROL_ERROR is not something produced by Squid. Likely it
</I>&gt;<i> &gt;comes from the TCP stack and/or OS routing system.
</I>&gt;<i> Client connects to Squid by a script written in Golang. Thats where they
</I>&gt;<i> get that error. On the Squid's access.log, I can see that error as
</I>&gt;<i> TCP_TUNNEL_ABORTED/200
</I>&gt;<i>
</I>&gt;<i> &gt;Some improvements highlighted inline below.
</I>&gt;<i> &gt;Nothing stands out to me as being related to your issues.
</I>&gt;<i> Thank you, I'll fix them however I don't think this issue is any related
</I>&gt;<i> to the config.
</I>&gt;<i>
</I>&gt;<i> &gt;Any particular reason not to use the registered port 3128 ?
</I>&gt;<i> &gt;(Not important, just wondering.)
</I>&gt;<i> My client wants to prevent proxies from being detected by bots so we
</I>&gt;<i> picked a different port number but it's not the one I shared here. I edited
</I>&gt;<i> numbers and addresses from the config before sharing it here.
</I>&gt;<i>
</I>&gt;<i> &gt;I/we will need to see the PCAP trace along with a cache.log generated
</I>&gt;<i> &gt;using &quot;debug_options ALL,6&quot; to confirm a bug or identify other breakage
</I>&gt;<i> &gt;though.
</I>&gt;<i> Interestingly, debug_options ALL does not log anything related to this
</I>&gt;<i> issue to cache.log. That left me very confused about this problem.
</I>&gt;<i> I'm currently sending you the PCAP file. It's being uploaded. I would be
</I>&gt;<i> appreciated if you can take a look at it.
</I>&gt;<i>
</I>&gt;<i> Thanks
</I>&gt;<i> Amos Jeffries &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt;, 3 May 2024 Cum, 19:31 tarihinde
</I>&gt;<i> &#351;unu yazd&#305;:
</I>&gt;<i>
</I>&gt;&gt;<i> On 4/05/24 02:29, Emre Oksum wrote:
</I>&gt;&gt;<i> &gt; Hi everyone,
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; I'm having a issue with Squid Cache 4.10 which I cannot fix for weeks
</I>&gt;&gt;<i> &gt; now and kinda lost at the moment. I will be appreciated if someone can
</I>&gt;&gt;<i> &gt; guide me through the issue I'm having.
</I>&gt;&gt;<i> &gt; I need to create a IPv6 HTTP proxy which should match the entry address
</I>&gt;&gt;<i> &gt; to outgoing TCP address. For example, if user is connecting from
</I>&gt;&gt;<i> &gt; fe80:abcd::1 it should exit the HTTP proxy from the same address. We
</I>&gt;&gt;<i> got
</I>&gt;&gt;<i> &gt; like 50k addresses like this at the moment.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> What your &quot;for example,...&quot; describes is Transparent Proxy (TPROXY).
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> However, what you have in the config below is very different. The IP the
</I>&gt;&gt;<i> client is connected **to** (not &quot;from&quot;) is being pinned on outgoing
</I>&gt;&gt;<i> connections.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &gt; The issue is, client connecting to the proxy is receiving &quot;EOF&quot; or
</I>&gt;&gt;<i> &gt; &quot;FLOW_CONTROL_ERROR&quot; on their side.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The FLOW_CONTROL_ERROR is not something produced by Squid. Likely it
</I>&gt;&gt;<i> comes from the TCP stack and/or OS routing system.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The EOF may be coming from either Squid or the OS. It also may be
</I>&gt;&gt;<i> perfectly normal for the circumstances, or a side effect of an error
</I>&gt;&gt;<i> elsewhere.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> To solve will require identifying exactly what is sending those signals,
</I>&gt;&gt;<i> and why. Since they are signals going to the client, focus on the
</I>&gt;&gt;<i> client-&gt;Squid connections (not the Squid-&gt;server ones you talk about
</I>&gt;&gt;<i> testing below).
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &gt; When I test connection by connecting
</I>&gt;&gt;<i> &gt; to whatismyip.com &lt;<A HREF="http://whatismyip.com">http://whatismyip.com</A>&gt; everything works fine and
</I>&gt;&gt;<i> &gt; entry IP always matches with outgoing IP for each of the 50k addresses.
</I>&gt;&gt;<i> &gt; Client tells me this problem occurs both at GET and POST requests with
</I>&gt;&gt;<i> &gt; around 10 MB of data.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Well, you are trying to manually force certain flow patterns that
</I>&gt;&gt;<i> prohibit or break some major HTTP performance features. Some problems
</I>&gt;&gt;<i> are to be expected.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The issues which I expect to occur in your proxy would not show up in a
</I>&gt;&gt;<i> trivial outgoing-IP or connectivity test.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &gt; I initially thought that could be related to server resources being
</I>&gt;&gt;<i> &gt; drained but upon inspecting server resource usage, Squid isn't even
</I>&gt;&gt;<i> &gt; topping at 100% CPU or RAM anytime so not that.
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> IMO, &quot;FLOW_CONTROL_ERROR&quot; is likely related to quantity of traffic
</I>&gt;&gt;<i> flooding through the proxy to specific origin servers.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The concept you are implementing of the outgoing TCP connection having
</I>&gt;&gt;<i> the same IP as the incoming connection reduces the available TCP sockets
</I>&gt;&gt;<i> by 25%. Prohibiting the OS from allocating ports on otherwise unused
</I>&gt;&gt;<i> outgoing addresses when
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &gt; My Squid.conf is like this at the moment:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Some improvements highlighted inline below.
</I>&gt;&gt;<i> Nothing stands out to me as being related to your issues.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; auth_param basic program /usr/lib/squid/basic_ncsa_auth
</I>&gt;&gt;<i> /etc/squid/passwd
</I>&gt;&gt;<i> &gt; acl auth_users proxy_auth REQUIRED
</I>&gt;&gt;<i> &gt; http_access allow auth_users
</I>&gt;&gt;<i> &gt; http_access deny !auth_users
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Above two lines are backwards. Deny first, then allow.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &gt; cache deny all
</I>&gt;&gt;<i> &gt; dns_nameservers &lt;nameservers here&gt;
</I>&gt;&gt;<i> &gt; dns_v4_first off
</I>&gt;&gt;<i> &gt; via off
</I>&gt;&gt;<i> &gt; forwarded_for delete
</I>&gt;&gt;<i> &gt; follow_x_forwarded_for deny all
</I>&gt;&gt;<i> &gt; server_persistent_connections off
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> *If* the issue turns out to be congestion on Squid-&gt;server connections
</I>&gt;&gt;<i> enabling this might be worthwhile. Otherwise it should be fine.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &gt; max_filedesc 1048576
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> You can remove that line. &quot;max_filedesc&quot; was a RedHat hack from 20+
</I>&gt;&gt;<i> years ago when the feature was experimental.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Any value you set on the line above, will be erased and replaced by the
</I>&gt;&gt;<i> line below:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &gt; max_filedescriptors 1048576
</I>&gt;&gt;<i> &gt; workers 8
</I>&gt;&gt;<i> &gt; http_port [::0]:1182
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Above is just a complicated way to write:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>   http_port 1182
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Any particular reason not to use the registered port 3128 ?
</I>&gt;&gt;<i> (Not important, just wondering.)
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &gt; acl binding1 myip fe80:abcd::1
</I>&gt;&gt;<i> &gt; tcp_outgoing_address fe80:abcd::1 binding1
</I>&gt;&gt;<i> &gt; acl binding2 myip fe80:abcd::2
</I>&gt;&gt;<i> &gt; tcp_outgoing_address fe80:abcd::2 binding2
</I>&gt;&gt;<i> &gt; acl binding3 myip fe80:abcd::3
</I>&gt;&gt;<i> &gt; tcp_outgoing_address fe80:abcd::3 binding3
</I>&gt;&gt;<i> &gt; ...
</I>&gt;&gt;<i> &gt; ...
</I>&gt;&gt;<i> &gt; ...
</I>&gt;&gt;<i> &gt; access_log /var/log/squid/access.log squid
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &gt; cache_store_log none
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> You can erase this line.
</I>&gt;&gt;<i> This is default setting. No need to manually set it.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &gt; cache deny all
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> You can erase this line.
</I>&gt;&gt;<i> This &quot;cache deny all&quot; exists earlier in the config.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &gt;
</I>&gt;&gt;<i> &gt; I've tried to get a PCAP file and realized when client tries to connect
</I>&gt;&gt;<i> &gt; with a new IPv6 address, Squid is not trying to open a new connection
</I>&gt;&gt;<i> &gt; instead tries to resume a previously opened one on a different outgoing
</I>&gt;&gt;<i> &gt; IPv6 address.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Can you provide the trace demonstrating that issue?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Although, as noted earlier your problems are apparently on the client
</I>&gt;&gt;<i> connections. This is about server connections behaviour.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &gt; I set server_persistent_connections off which should have
</I>&gt;&gt;<i> &gt; disabled this behavior but it's still the same.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Nod. Yes that should forbid re-use of connections.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I/we will need to see the PCAP trace along with a cache.log generated
</I>&gt;&gt;<i> using &quot;debug_options ALL,6&quot; to confirm a bug or identify other breakage
</I>&gt;&gt;<i> though.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &gt; I tried using a newer
</I>&gt;&gt;<i> &gt; version of Squid but it behaved differently and did not follow my
</I>&gt;&gt;<i> &gt; outgoing address specifications and kept connecting on IPv4.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> That would seem to indicate that your IPv4 connectivity is better than
</I>&gt;&gt;<i> your IPv6 connectivity. Later Squid use various &quot;Happy Eyeballs&quot;
</I>&gt;&gt;<i> implementations for the server selection.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> You can usually work around this by configuring the DNS server specified
</I>&gt;&gt;<i> by dns_nameservers to only deliver IPv6 results when a mixed set are
</I>&gt;&gt;<i> available.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> HTH
</I>&gt;&gt;<i> Amos
</I>&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;<i> squid-users mailing list
</I>&gt;&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">https://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">https://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i>
</I>&gt;<i>
</I>-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20240503/a03ffe3c/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20240503/a03ffe3c/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="026639.html">[squid-users] Squid TCP_TUNNEL_ABORTED/200
</A></li>
	<LI>Next message (by thread): <A HREF="026643.html">[squid-users] Squid TCP_TUNNEL_ABORTED/200
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26642">[ date ]</a>
              <a href="thread.html#26642">[ thread ]</a>
              <a href="subject.html#26642">[ subject ]</a>
              <a href="author.html#26642">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
