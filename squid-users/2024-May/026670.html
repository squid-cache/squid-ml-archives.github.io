<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Tune Squid proxy to handle 90k connection
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Tune%20Squid%20proxy%20to%20handle%2090k%20connection&In-Reply-To=%3C2ef8fee9-5d29-492b-a482-b85b3003801f%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="026666.html">
   <LINK REL="Next"  HREF="026671.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Tune Squid proxy to handle 90k connection</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Tune%20Squid%20proxy%20to%20handle%2090k%20connection&In-Reply-To=%3C2ef8fee9-5d29-492b-a482-b85b3003801f%40measurement-factory.com%3E"
       TITLE="[squid-users] Tune Squid proxy to handle 90k connection">rousskov at measurement-factory.com
       </A><BR>
    <I>Thu May 16 13:08:17 UTC 2024</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="026666.html">[squid-users] Tune Squid proxy to handle 90k connection
</A></li>
        <LI>Next message (by thread): <A HREF="026671.html">[squid-users] Tune Squid proxy to handle 90k connection
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26670">[ date ]</a>
              <a href="thread.html#26670">[ thread ]</a>
              <a href="subject.html#26670">[ subject ]</a>
              <a href="author.html#26670">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 2024-05-15 19:02, Andre Bolinhas wrote:

&gt;<i> To handle this amount of traffic should I enable 
</I>&gt;<i> client_persistent_connections and server_persistent_connections or is it 
</I>&gt;<i> better to keep it disable?
</I>
As Jonathan has already mentioned, the question is misleading because 
these directives default to &quot;on&quot; -- persistent connections are enabled 
by default. Modern HTTP specs enable them by default as well.

Since you do not know whether persistent connections are harmful in your 
particular deployment environments, remove those two directives from 
your Squid configuration files (effectively enabling persistent 
connection use). There are always exceptions, but in the vast majority 
of cases, not specifying those directives is the best first step.

If you want to research whether persistent connections are harmful in 
your environments, you will need to define performance metrics and 
experiment with all four different combinations across the two boolean 
directives (at least -- there are more directives that affect connection 
persistency). Doing this kind of research right is difficult!


HTH,

Alex.


&gt;<i> Best regards
</I>&gt;<i> 
</I>&gt;<i> On 31/01/2022 14:52, Eliezer Croitoru wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Hey Andre,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I *would not *recommend on 5.x yet since there are couple bugs which 
</I>&gt;&gt;<i> are blocking it to be used as stable.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I believe that your current setup is pretty good.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> The only thing which might affect the system is the authentication and 
</I>&gt;&gt;<i> ACLs.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> As long these ACL rules are static it should not affect too much on 
</I>&gt;&gt;<i> the operation, however,
</I>&gt;&gt;<i> When adding external authentication and external helpers for other 
</I>&gt;&gt;<i> things it&#8217;s possible to see some slowdown in specific scenarios.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> As long as the credentials and the ACLs will be fast enough it is 
</I>&gt;&gt;<i> expected to work fast but only testing will prove how the real world usage
</I>&gt;&gt;<i> will affect the service.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I believe that 5 workers is enough and also take into account that the 
</I>&gt;&gt;<i> external helpers would also require CPU so don&#8217;t rush into
</I>&gt;&gt;<i> changing the workers amount just yet.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> All The Bests,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Eliezer
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> ----
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Eliezer Croitoru
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> NgTech, Tech Support
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Mobile: +972-5-28704261
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Email: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">ngtech1ltd at gmail.com</A>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> *From:* Andr&#233; Bolinhas &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">andre.bolinhas at articatech.com</A>&gt;
</I>&gt;&gt;<i> *Sent:* Monday, January 31, 2022 15:47
</I>&gt;&gt;<i> *To:* 'NgTech LTD' &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">ngtech1ltd at gmail.com</A>&gt;
</I>&gt;&gt;<i> *Cc:* 'Squid Users' &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>&gt;
</I>&gt;&gt;<i> *Subject:* RE: [squid-users] Tune Squid proxy to handle 90k connection
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Hi
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I will not use cache in this project.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Yes, I will need
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>   * ACL (based on Domain, AD user, Headers, User Agent&#8230;)
</I>&gt;&gt;<i>   * Authentication
</I>&gt;&gt;<i>   * SSL bump just for one domain.
</I>&gt;&gt;<i>   * DNS resolution (I will use Unbound DNS service for this)
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Also, I will divide the traffic between two Squid box instead just one.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> So each box will handle around 50k request.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Each box have:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>   * CPU(s) 16
</I>&gt;&gt;<i>   * Threads per code 2
</I>&gt;&gt;<i>   * Cores per socket 8
</I>&gt;&gt;<i>   * Sockets 1
</I>&gt;&gt;<i>   * Inter Xeron Silver 4208&#160; @ 2.10GHz
</I>&gt;&gt;<i>   * 96GB Ram
</I>&gt;&gt;<i>   * 1TB raid-0 SSD
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> At this time I have 5 workers on each Squid box and the Squid version 
</I>&gt;&gt;<i> is 4.17, do you recommend more workers or upgrade the squid version to 5?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Best regards
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> *De:*NgTech LTD &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">ngtech1ltd at gmail.com</A>&gt;
</I>&gt;&gt;<i> *Enviada:* 31 de janeiro de 2022 04:59
</I>&gt;&gt;<i> *Para:* Andr&#233; Bolinhas &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">andre.bolinhas at articatech.com</A>&gt;
</I>&gt;&gt;<i> *Cc:* Squid Users &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>&gt;
</I>&gt;&gt;<i> *Assunto:* Re: [squid-users] Tune Squid proxy to handle 90k connection
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I would recommend you to start with 0 caching.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> However, for choosing the right solution you must give more details.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> For example there is an IBM reasearch that prooved that for about 90k 
</I>&gt;&gt;<i> connections you can use vm's ontop of such hardware with apache web 
</I>&gt;&gt;<i> server.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> If you do have the set of the other requirements from the proxy else 
</I>&gt;&gt;<i> then the 90k requests it would be wise to mention them.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Do you need any specific acls?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Do you need authentication?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> etc..
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> For a simple forward proxy I would suggest to use a simpler solution 
</I>&gt;&gt;<i> and if possible to not log anything as a starter point.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Any local disk i/o will slow down the machine.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> About the url categorization, I do not have experience with ufdbguard 
</I>&gt;&gt;<i> on such scale but it would be pretty heavy for any software to handle 
</I>&gt;&gt;<i> 90k rps...
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &#160;It's doable to implement such setup but will require testing.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Will you use ssl bump in this setup?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> If I will have all the technical and specs/requirements details I 
</I>&gt;&gt;<i> might be able to suggest better then now.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Take into account that each squid worker can handle about 3k rps 
</I>&gt;&gt;<i> tops(with my experience) and it's a juggling between two sides so... 
</I>&gt;&gt;<i> 3k is really 3k+3k+external_acls+dns...
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I believe that in this case an example of configuration from the squid 
</I>&gt;&gt;<i> developers might be usefull.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Eliezer
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> &#1489;&#1514;&#1488;&#1512;&#1497;&#1498; &#1497;&#1493;&#1501; &#1490;&#1523;, 25 &#1489;&#1497;&#1504;&#1493;&#1523; 2022, 18:42, &#1502;&#1488;&#1514;Andr&#233; Bolinhas 
</I>&gt;&gt;<i> &#8207;&lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">andre.bolinhas at articatech.com</A>&gt;:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>     Any tip about my last comment?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>     -----Mensagem original-----
</I>&gt;&gt;<i>     De: Andr&#233; Bolinhas &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">andre.bolinhas at articatech.com</A>&gt;
</I>&gt;&gt;<i>     Enviada: 21 de janeiro de 2022 16:36
</I>&gt;&gt;<i>     Para: 'Amos Jeffries' &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt;;
</I>&gt;&gt;<i>     <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;&gt;<i>     Assunto: RE: [squid-users] Tune Squid proxy to handle 90k connection
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>     Thanks Amos
</I>&gt;&gt;<i>     Yes, you are right, I will put a second box with HaProxy in front
</I>&gt;&gt;<i>     to balance the traffic.
</I>&gt;&gt;<i>     About the sockets I can't double it because is a physical machine,
</I>&gt;&gt;<i>     do you think disable hyperthreading from bios will help, because
</I>&gt;&gt;<i>     we have other services inside the box that works in
</I>&gt;&gt;<i>     multi-threading, like unbound DNS?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>     Just more a few questions:
</I>&gt;&gt;<i>     1&#186; The server have 92Gb of Ram, do you think that is needed that
</I>&gt;&gt;<i>     adding swap will help squid performance?
</I>&gt;&gt;<i>     2&#186; Right now we are using squid 4.17 did you recommend upgrade or
</I>&gt;&gt;<i>     downgrade to any specific version?
</I>&gt;&gt;<i>     3&#186; We need categorization, for this we are using an external
</I>&gt;&gt;<i>     helper to achieve it, do you recommend use this approach with ACL
</I>&gt;&gt;<i>     or move to some kind of ufdbguard service?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>     Best regards
</I>&gt;&gt;<i>     -----Mensagem original-----
</I>&gt;&gt;<i>     De: squid-users &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>&gt; Em
</I>&gt;&gt;<i>     Nome De Amos Jeffries
</I>&gt;&gt;<i>     Enviada: 21 de janeiro de 2022 16:05
</I>&gt;&gt;<i>     Para: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;&gt;<i>     Assunto: Re: [squid-users] Tune Squid proxy to handle 90k connection
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>     Sorry for the slow reply. Responses inline.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>     On 14/01/22 05:44, Andr&#233; Bolinhas wrote:
</I>&gt;&gt;<i>     &gt; Hi
</I>&gt;&gt;<i>     &gt; ~80k request per second&#160; 10k users
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>     Test this, but you may need a second machine to achieve the full
</I>&gt;&gt;<i>     80k RPS.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>     Latest Squid do not have any details analysis, but older Squid-3.5
</I>&gt;&gt;<i>     were only achieving &gt;15k RPS under lab conditions, more likely
</I>&gt;&gt;<i>     expect under 10k RPS/worker on real traffic.
</I>&gt;&gt;<i>     &#160; That means (IME) this machine is quite likely to hit its
</I>&gt;&gt;<i>     capacity somewhere under 70k RPS.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>     &gt; CPU info:
</I>&gt;&gt;<i>     &gt; CPU(s) 16
</I>&gt;&gt;<i>     &gt; Threads per code 2
</I>&gt;&gt;<i>     &gt; Cores per socket 8
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>     With this CPU you will be able to run 7 workers. Setup affinity of
</I>&gt;&gt;<i>     one core per worker (the &quot;kidN&quot; processes of Squid). Leaving one
</I>&gt;&gt;<i>     core to the OS and additional processing needs - this matters at
</I>&gt;&gt;<i>     peak loading.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>     CPU &quot;threads&quot; tend not to be useful for Squid. Under high loads
</I>&gt;&gt;<i>     Squid workers will consume all available cycles on their core, not
</I>&gt;&gt;<i>     leaving any for the fancy &quot;thread&quot; core sharing features to
</I>&gt;&gt;<i>     pretend there is another core available. YMMV. One of the tests to
</I>&gt;&gt;<i>     try when tuning is to turn off the CPU hyperthreading and see what
</I>&gt;&gt;<i>     effect it has (if any).
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>     &gt; Sockets 1
</I>&gt;&gt;<i>     &gt; Inter Xeron Silver 4208&#160; @ 2.10GHz
</I>&gt;&gt;<i>     &gt;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>     Okay. Doable, but for best performance you want as high GHz rating
</I>&gt;&gt;<i>     on the cores as your budget can afford. The amount of &quot;lag&quot; Squid
</I>&gt;&gt;<i>     adds to traffic and RPS performance/parallelism directly
</I>&gt;&gt;<i>     correlates with how fast the CPU core can run cycles.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>     HTH
</I>&gt;&gt;<i>     Amos
</I>&gt;&gt;<i>     _______________________________________________
</I>&gt;&gt;<i>     squid-users mailing list
</I>&gt;&gt;<i>     <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;&gt;<i>     <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>     _______________________________________________
</I>&gt;&gt;<i>     squid-users mailing list
</I>&gt;&gt;<i>     <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;&gt;<i>     <A HREF="http://lists.squid-cache.org/listinfo/squid-users">http://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;&gt;<i>
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">https://lists.squid-cache.org/listinfo/squid-users</A>
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="026666.html">[squid-users] Tune Squid proxy to handle 90k connection
</A></li>
	<LI>Next message (by thread): <A HREF="026671.html">[squid-users] Tune Squid proxy to handle 90k connection
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26670">[ date ]</a>
              <a href="thread.html#26670">[ thread ]</a>
              <a href="subject.html#26670">[ subject ]</a>
              <a href="author.html#26670">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
