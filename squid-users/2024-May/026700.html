<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Validation of IP address for SSL spliced connections
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Validation%20of%20IP%20address%20for%20SSL%20spliced%20connections&In-Reply-To=%3Cc4cb371a-9aa4-4046-8b81-05a8824b48ea%40esat.kuleuven.be%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="026705.html">
   <LINK REL="Next"  HREF="026701.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Validation of IP address for SSL spliced connections</H1>
    <B>Rik Theys</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Validation%20of%20IP%20address%20for%20SSL%20spliced%20connections&In-Reply-To=%3Cc4cb371a-9aa4-4046-8b81-05a8824b48ea%40esat.kuleuven.be%3E"
       TITLE="[squid-users] Validation of IP address for SSL spliced connections">Rik.Theys at esat.kuleuven.be
       </A><BR>
    <I>Wed May 29 09:01:31 UTC 2024</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="026705.html">[squid-users] urlfilterdb.com
</A></li>
        <LI>Next message (by thread): <A HREF="026701.html">[squid-users] Validation of IP address for SSL spliced connections
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26700">[ date ]</a>
              <a href="thread.html#26700">[ thread ]</a>
              <a href="subject.html#26700">[ subject ]</a>
              <a href="author.html#26700">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

I'm configuring squid as a transparent proxy where local outbound 
traffic is redirect to a local squid process using tproxy.

I would like to limit the domains the host can contact by having an 
allow list. I have the following config file:

------

acl allowed_clients src &quot;/etc/squid/allowed_clients&quot;

acl allowed_domains dstdomain &quot;/etc/squid/allowed_domains&quot;

acl SSL_ports port 443
acl Safe_ports port 80
acl Safe_ports port 443
acl CONNECT method CONNECT

acl step1 at_step SslBump1
acl step2 at_step SslBump2
acl step3 at_step SslBump3

# Additional access control lists
acl https_domains ssl::server_name &quot;/etc/squid/allowed_domains&quot;

# Deny requests to certain unsafe ports
http_access deny !Safe_ports

# Deny CONNECT to other than secure SSL ports
http_access deny CONNECT !SSL_ports

# Only allow cachemgr access from localhost
http_access allow localhost manager
http_access deny manager

# We strongly recommend the following be uncommented to protect innocent
# web applications running on the proxy server who think the only
# one who can access services on &quot;localhost&quot; is a local user
http_access deny to_localhost

#
# INSERT YOUR OWN RULE(S) HERE TO ALLOW ACCESS FROM YOUR CLIENTS
#
http_access allow allowed_clients allowed_domains
http_access allow allowed_clients CONNECT

# Example rule allowing access from your local networks.
# Adapt localnet in the ACL section to list your (internal) IP networks
# from where browsing should be allowed
#http_access allow localnet
#http_access allow localhost

# And finally deny all other access to this proxy
http_access deny all

# Squid normally listens to port 3128
http_port 3128
http_port 3129 tproxy
https_port 3130 tproxy ssl-bump cert=/etc/squid/cert/local_ca.pem

# SSL bump configuration
ssl_bump peek step1
ssl_bump peek step2 https_domains
ssl_bump splice step3 https_domains
ssl_bump terminate all

------

When the Host header in an intercepted request matches a domain on the 
allowed_domains list, the request is allowed. Otherwise it's denied as 
expected.

But squid doesn't seem to validate that the IP address we're connecting 
to is valid for the specified name in the SNI header?

For example, if I add &quot;wordpress.org&quot; to my allowed_domains list, the 
following request is allowed:

curl -v <A HREF="https://wordpress.org">https://wordpress.org</A> --connect-to wordpress.org:443:8.8.8.8:443

8.8.8.8 is not a valid IP address for wordpress.org. This could be used 
to bypass the restrictions.

Is there an option in squid to make it perform a forward DNS lookup for 
the domain from the SNI information from step1 to validate that the IP 
address we're trying to connect to is actually valid for that host? In 
the example above, a DNS lookup for wordpress.org would return 
198.143.164.252 as the IP address. This is not the IP address we're 
trying to connect to, so squid should block the request.

Similar question for the server certificate: I've configured the 
'ssl_bump peek step2 https_domains' line so squid can peek at the server 
certificate. Is there a way to configure squid to validate that the 
server certificate is valid for the host specified in the SNI header?


Regards,

Rik
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20240529/b843ca1b/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20240529/b843ca1b/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="026705.html">[squid-users] urlfilterdb.com
</A></li>
	<LI>Next message (by thread): <A HREF="026701.html">[squid-users] Validation of IP address for SSL spliced connections
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26700">[ date ]</a>
              <a href="thread.html#26700">[ thread ]</a>
              <a href="subject.html#26700">[ subject ]</a>
              <a href="author.html#26700">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
