<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Validation of IP address for SSL spliced connections
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Validation%20of%20IP%20address%20for%20SSL%20spliced%0A%20connections&In-Reply-To=%3Ceead6ccc-96e9-4441-9200-35bcf37fee73%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="026700.html">
   <LINK REL="Next"  HREF="026702.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Validation of IP address for SSL spliced connections</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Validation%20of%20IP%20address%20for%20SSL%20spliced%0A%20connections&In-Reply-To=%3Ceead6ccc-96e9-4441-9200-35bcf37fee73%40measurement-factory.com%3E"
       TITLE="[squid-users] Validation of IP address for SSL spliced connections">rousskov at measurement-factory.com
       </A><BR>
    <I>Wed May 29 15:29:18 UTC 2024</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="026700.html">[squid-users] Validation of IP address for SSL spliced connections
</A></li>
        <LI>Next message (by thread): <A HREF="026702.html">[squid-users] Validation of IP address for SSL spliced connections
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26701">[ date ]</a>
              <a href="thread.html#26701">[ thread ]</a>
              <a href="subject.html#26701">[ subject ]</a>
              <a href="author.html#26701">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 2024-05-29 05:01, Rik Theys wrote:
&gt;<i> acl allowed_clients src &quot;/etc/squid/allowed_clients&quot;
</I>&gt;<i> acl allowed_domains dstdomain &quot;/etc/squid/allowed_domains&quot;
</I>
&gt;<i> http_access allow allowed_clients allowed_domains
</I>&gt;<i> http_access allow allowed_clients CONNECT
</I>&gt;<i> http_access deny all
</I>
Please note that the second http_access rule in the above configuration 
allows CONNECT tunnels to prohibited domains (i.e. domains that do not 
match allowed_domains). Consider restricting your &quot;allow...CONNECT&quot; rule 
to step1. For example:

     http_access allow allowed_clients step1 CONNECT


&gt;<i> squid doesn't seem to validate that the IP address we're connecting 
</I>&gt;<i> to is valid for the specified name in the SNI header?
</I>
That observation matches my reading of Squid Host header forgery 
detection code which says &quot;we do not yet handle CONNECT tunnels well, so 
ignore for them&quot;. To validate that theory, use &quot;debug_options ALL,3&quot; and 
look for &quot;SECURITY ALERT: Host header forgery detected&quot; messages in 
cache.log.

Please note that in many environments forgery detection does not work 
well (for cases where it is performed) due to clients and Squid seeing 
different sets of IP addresses for the same host name. There are 
numerous complains about that in squid-users archives.


&gt;<i> For example, if I add &quot;wordpress.org&quot; to my allowed_domains list, the 
</I>&gt;<i> following request is allowed:
</I>&gt;<i> 
</I>&gt;<i> curl -v <A HREF="https://wordpress.org">https://wordpress.org</A> --connect-to wordpress.org:443:8.8.8.8:443
</I>&gt;<i> 
</I>&gt;<i> 8.8.8.8 is not a valid IP address for wordpress.org. This could be used 
</I>&gt;<i> to bypass the restrictions.
</I>
Agreed.


&gt;<i> Is there an option in squid to make it perform a forward DNS lookup for 
</I>&gt;<i> the domain from the SNI information from step1
</I>
FYI: SNI comes from step2. step1 looks at TCP/IP client info.


&gt;<i> to validate that the IP 
</I>&gt;<i> address we're trying to connect to is actually valid for that host? In 
</I>&gt;<i> the example above, a DNS lookup for wordpress.org would return 
</I>&gt;<i> 198.143.164.252 as the IP address. This is not the IP address we're 
</I>&gt;<i> trying to connect to, so squid should block the request.
</I>
AFAICT, there is no built-in support for that in current Squid code. One 
could enhance Squid or write an external ACL to perform that kind of 
validation. See above for details/caveats.


&gt;<i> Similar question for the server certificate: I've configured the 
</I>&gt;<i> 'ssl_bump peek step2 https_domains' line so squid can peek at the server 
</I>&gt;<i> certificate.
</I>
Peeking at the server certificates happens at step3. In many modern use 
cases, server certificates are encrypted, so a _peeking_ Squid cannot 
see them. To validate, Squid has to bump the tunnel (supported today but 
problematic for other reasons) or be enhanced to use out-of-band 
validation tricks (that come with their own set of problems).


&gt;<i> Is there a way to configure squid to validate that the 
</I>&gt;<i> server certificate is valid for the host specified in the SNI header?
</I>
IIRC, that validation happens automatically in modern Squid versions 
when Squid receives an (unencrypted) server certificate.


HTH,

Alex.


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="026700.html">[squid-users] Validation of IP address for SSL spliced connections
</A></li>
	<LI>Next message (by thread): <A HREF="026702.html">[squid-users] Validation of IP address for SSL spliced connections
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26701">[ date ]</a>
              <a href="thread.html#26701">[ thread ]</a>
              <a href="subject.html#26701">[ subject ]</a>
              <a href="author.html#26701">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
