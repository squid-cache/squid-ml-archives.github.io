<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Validation of IP address for SSL spliced connections
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Validation%20of%20IP%20address%20for%20SSL%20spliced%0A%20connections&In-Reply-To=%3C54178fff-365f-4fa5-b2ec-0b13b829a0ca%40esat.kuleuven.be%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="026701.html">
   <LINK REL="Next"  HREF="026703.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Validation of IP address for SSL spliced connections</H1>
    <B>Rik Theys</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Validation%20of%20IP%20address%20for%20SSL%20spliced%0A%20connections&In-Reply-To=%3C54178fff-365f-4fa5-b2ec-0b13b829a0ca%40esat.kuleuven.be%3E"
       TITLE="[squid-users] Validation of IP address for SSL spliced connections">Rik.Theys at esat.kuleuven.be
       </A><BR>
    <I>Wed May 29 21:06:08 UTC 2024</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="026701.html">[squid-users] Validation of IP address for SSL spliced connections
</A></li>
        <LI>Next message (by thread): <A HREF="026703.html">[squid-users] Validation of IP address for SSL spliced connections
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26702">[ date ]</a>
              <a href="thread.html#26702">[ thread ]</a>
              <a href="subject.html#26702">[ subject ]</a>
              <a href="author.html#26702">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

On 5/29/24 5:29 PM, Alex Rousskov wrote:
&gt;<i> On 2024-05-29 05:01, Rik Theys wrote:
</I>&gt;&gt;<i> acl allowed_clients src &quot;/etc/squid/allowed_clients&quot;
</I>&gt;&gt;<i> acl allowed_domains dstdomain &quot;/etc/squid/allowed_domains&quot;
</I>&gt;<i>
</I>&gt;&gt;<i> http_access allow allowed_clients allowed_domains
</I>&gt;&gt;<i> http_access allow allowed_clients CONNECT
</I>&gt;&gt;<i> http_access deny all
</I>&gt;<i>
</I>&gt;<i> Please note that the second http_access rule in the above 
</I>&gt;<i> configuration allows CONNECT tunnels to prohibited domains (i.e. 
</I>&gt;<i> domains that do not match allowed_domains). Consider restricting your 
</I>&gt;<i> &quot;allow...CONNECT&quot; rule to step1. For example:
</I>&gt;<i>
</I>&gt;<i> &#160;&#160;&#160; http_access allow allowed_clients step1 CONNECT
</I>Thanks, I've updated my configuration.
&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> squid doesn't seem to validate that the IP address we're connecting 
</I>&gt;&gt;<i> to is valid for the specified name in the SNI header?
</I>&gt;<i>
</I>&gt;<i> That observation matches my reading of Squid Host header forgery 
</I>&gt;<i> detection code which says &quot;we do not yet handle CONNECT tunnels well, 
</I>&gt;<i> so ignore for them&quot;. To validate that theory, use &quot;debug_options 
</I>&gt;<i> ALL,3&quot; and look for &quot;SECURITY ALERT: Host header forgery detected&quot; 
</I>&gt;<i> messages in cache.log.
</I>&gt;<i>
</I>I've enabled this debug option, but I never see the security alert in 
the logs. Maybe it was introduced in more recent versions? I'm currently 
using Squid 5.5 that comes with Rocky Linux 9.4.

Looking at the logs, I'm also having problems determining where each 
ssl-bump step is started.

&gt;<i> Please note that in many environments forgery detection does not work 
</I>&gt;<i> well (for cases where it is performed) due to clients and Squid seeing 
</I>&gt;<i> different sets of IP addresses for the same host name. There are 
</I>&gt;<i> numerous complains about that in squid-users archives.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> For example, if I add &quot;wordpress.org&quot; to my allowed_domains list, the 
</I>&gt;&gt;<i> following request is allowed:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> curl -v <A HREF="https://wordpress.org">https://wordpress.org</A> --connect-to wordpress.org:443:8.8.8.8:443
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> 8.8.8.8 is not a valid IP address for wordpress.org. This could be 
</I>&gt;&gt;<i> used to bypass the restrictions.
</I>&gt;<i>
</I>&gt;<i> Agreed.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> Is there an option in squid to make it perform a forward DNS lookup 
</I>&gt;&gt;<i> for the domain from the SNI information from step1
</I>&gt;<i>
</I>&gt;<i> FYI: SNI comes from step2. step1 looks at TCP/IP client info.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> to validate that the IP address we're trying to connect to is 
</I>&gt;&gt;<i> actually valid for that host? In the example above, a DNS lookup for 
</I>&gt;&gt;<i> wordpress.org would return 198.143.164.252 as the IP address. This is 
</I>&gt;&gt;<i> not the IP address we're trying to connect to, so squid should block 
</I>&gt;&gt;<i> the request.
</I>&gt;<i>
</I>&gt;<i> AFAICT, there is no built-in support for that in current Squid code. 
</I>&gt;<i> One could enhance Squid or write an external ACL to perform that kind 
</I>&gt;<i> of validation. See above for details/caveats.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> Similar question for the server certificate: I've configured the 
</I>&gt;&gt;<i> 'ssl_bump peek step2 https_domains' line so squid can peek at the 
</I>&gt;&gt;<i> server certificate.
</I>&gt;<i>
</I>&gt;<i> Peeking at the server certificates happens at step3. In many modern 
</I>&gt;<i> use cases, server certificates are encrypted, so a _peeking_ Squid 
</I>&gt;<i> cannot see them. To validate, Squid has to bump the tunnel (supported 
</I>&gt;<i> today but problematic for other reasons) or be enhanced to use 
</I>&gt;<i> out-of-band validation tricks (that come with their own set of problems).
</I>
I guess that explains why if I add &quot;%ssl::&lt;cert_subject&quot; to my logformat 
for the access log, the field is always &quot;-&quot;?

&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> Is there a way to configure squid to validate that the server 
</I>&gt;&gt;<i> certificate is valid for the host specified in the SNI header?
</I>&gt;<i>
</I>&gt;<i> IIRC, that validation happens automatically in modern Squid versions 
</I>&gt;<i> when Squid receives an (unencrypted) server certificate.
</I>&gt;<i>
</I>Do you happen to known which version of Squid introduced that check?

Regards,

Rik



</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="026701.html">[squid-users] Validation of IP address for SSL spliced connections
</A></li>
	<LI>Next message (by thread): <A HREF="026703.html">[squid-users] Validation of IP address for SSL spliced connections
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26702">[ date ]</a>
              <a href="thread.html#26702">[ thread ]</a>
              <a href="subject.html#26702">[ subject ]</a>
              <a href="author.html#26702">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
