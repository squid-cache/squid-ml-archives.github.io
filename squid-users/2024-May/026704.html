<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Validation of IP address for SSL spliced connections
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Validation%20of%20IP%20address%20for%20SSL%20spliced%0A%20connections&In-Reply-To=%3Ca4b55d47-6122-43f6-aed0-0aa1741dcd28%40esat.kuleuven.be%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="026703.html">
   <LINK REL="Next"  HREF="026706.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Validation of IP address for SSL spliced connections</H1>
    <B>Rik Theys</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Validation%20of%20IP%20address%20for%20SSL%20spliced%0A%20connections&In-Reply-To=%3Ca4b55d47-6122-43f6-aed0-0aa1741dcd28%40esat.kuleuven.be%3E"
       TITLE="[squid-users] Validation of IP address for SSL spliced connections">Rik.Theys at esat.kuleuven.be
       </A><BR>
    <I>Thu May 30 06:30:27 UTC 2024</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="026703.html">[squid-users] Validation of IP address for SSL spliced connections
</A></li>
        <LI>Next message (by thread): <A HREF="026706.html">[squid-users] Validation of IP address for SSL spliced connections
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26704">[ date ]</a>
              <a href="thread.html#26704">[ thread ]</a>
              <a href="subject.html#26704">[ subject ]</a>
              <a href="author.html#26704">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

On 5/29/24 11:31 PM, Alex Rousskov wrote:
&gt;<i> On 2024-05-29 17:06, Rik Theys wrote:
</I>&gt;&gt;<i> On 5/29/24 5:29 PM, Alex Rousskov wrote:
</I>&gt;&gt;&gt;<i> On 2024-05-29 05:01, Rik Theys wrote:
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> squid doesn't seem to validate that the IP address we're connecting 
</I>&gt;&gt;&gt;&gt;<i> to is valid for the specified name in the SNI header?
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> That observation matches my reading of Squid Host header forgery 
</I>&gt;&gt;&gt;<i> detection code which says &quot;we do not yet handle CONNECT tunnels 
</I>&gt;&gt;&gt;<i> well, so ignore for them&quot;. To validate that theory, use 
</I>&gt;&gt;&gt;<i> &quot;debug_options ALL,3&quot; and look for &quot;SECURITY ALERT: Host header 
</I>&gt;&gt;&gt;<i> forgery detected&quot; messages in cache.log.
</I>&gt;<i>
</I>&gt;&gt;<i> I've enabled this debug option, but I never see the security alert in 
</I>&gt;&gt;<i> the logs. Maybe it was introduced in more recent versions? I'm 
</I>&gt;&gt;<i> currently using Squid 5.5 that comes with Rocky Linux 9.4.
</I>&gt;<i>
</I>&gt;<i> The code logging &quot;SECURITY ALERT: Host header forgery detected&quot; 
</I>&gt;<i> messages is present in v5.5, but perhaps it is not triggered in that 
</I>&gt;<i> version (or even in modern/supported Squids) when I expect it to be 
</I>&gt;<i> triggered. Unfortunately, there are too many variables for me to 
</I>&gt;<i> predict what exactly went wrong in your particular test case without 
</I>&gt;<i> doing a lot more work (and I cannot volunteer to do that work right now).
</I>
Looking at <A HREF="https://wiki.squid-cache.org/KnowledgeBase/HostHeaderForgery,">https://wiki.squid-cache.org/KnowledgeBase/HostHeaderForgery,</A> 
it always seems to mention the Host header. It has no mention of 
performing the same checks for the SNI value. Since we're peeking at the 
request, we can't see the actual Host header being sent.

And indeed: if I perform the same test for HTTP traffic, I do see the 
error message:

curl <A HREF="http://wordpress.org">http://wordpress.org</A> --connect-to wordpress.org:80:8.8.8.8:80


I believe that for my use-case (only splice certain domains and prevent 
connecting to a wrong IP address), there's currently no solution then. 
Squid would also have to perform a similar check as the Host check for 
the SNI information. Maybe I can perform the same function with an 
external acl as you've mentioned. I will look into that later. Thanks 
for your time.

&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;<i> Looking at the logs, I'm also having problems determining where each 
</I>&gt;&gt;<i> ssl-bump step is started.
</I>&gt;<i>
</I>&gt;<i> Yes, it is a known problem (even for developers). There are also bugs 
</I>&gt;<i> related to step boundaries.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;&gt;&gt;<i> Peeking at the server certificates happens at step3. In many modern 
</I>&gt;&gt;&gt;<i> use cases, server certificates are encrypted, so a _peeking_ Squid 
</I>&gt;&gt;&gt;<i> cannot see them. To validate, Squid has to bump the tunnel 
</I>&gt;&gt;&gt;<i> (supported today but problematic for other reasons) or be enhanced 
</I>&gt;&gt;&gt;<i> to use out-of-band validation tricks (that come with their own set 
</I>&gt;&gt;&gt;<i> of problems).
</I>&gt;<i>
</I>&gt;&gt;<i> I guess that explains why if I add &quot;%ssl::&lt;cert_subject&quot; to my 
</I>&gt;&gt;<i> logformat for the access log, the field is always &quot;-&quot;?
</I>&gt;<i>
</I>&gt;<i> It may explain that, but other problems may lead to the same &quot;no 
</I>&gt;<i> certificate&quot; result as well, of course. You can kind of check by using 
</I>&gt;<i> stare/bump instead of peek/splice -- if you see certificate details 
</I>&gt;<i> logged in that bumping test, then it is more likely that Squid just 
</I>&gt;<i> does not get a plain text certificate in peeking configurations.
</I>
I've updated the configuration to use stare/bump instead. The field is 
then indeed added to the log file. A curl request that forces the 
connection to a different IP address then also fails because the 
certificate isn't valid for the name. There's no mention of the Host 
header not matching the IP address, but I assume that check comes after 
the certificate check then.

Regards,

Rik



</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="026703.html">[squid-users] Validation of IP address for SSL spliced connections
</A></li>
	<LI>Next message (by thread): <A HREF="026706.html">[squid-users] Validation of IP address for SSL spliced connections
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26704">[ date ]</a>
              <a href="thread.html#26704">[ thread ]</a>
              <a href="subject.html#26704">[ subject ]</a>
              <a href="author.html#26704">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
