<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] can't explain 403 denied for authenticated user
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20can%27t%20explain%20403%20denied%20for%20authenticated%20user&In-Reply-To=%3C96746157-da51-47db-8d52-d65239f2717e%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="026696.html">
   <LINK REL="Next"  HREF="026697.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] can't explain 403 denied for authenticated user</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20can%27t%20explain%20403%20denied%20for%20authenticated%20user&In-Reply-To=%3C96746157-da51-47db-8d52-d65239f2717e%40treenet.co.nz%3E"
       TITLE="[squid-users] can't explain 403 denied for authenticated user">squid3 at treenet.co.nz
       </A><BR>
    <I>Thu May 30 10:15:27 UTC 2024</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="026696.html">[squid-users] can't explain 403 denied for authenticated user
</A></li>
        <LI>Next message (by thread): <A HREF="026697.html">[squid-users] urlfilterdb.com
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26707">[ date ]</a>
              <a href="thread.html#26707">[ thread ]</a>
              <a href="subject.html#26707">[ subject ]</a>
              <a href="author.html#26707">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 25/05/24 07:28, Kevin wrote:
&gt;<i> Hi,
</I>&gt;<i> 
</I>&gt;<i> We have 2 external ACLs that take a request's data (IP, authenticated 
</I>&gt;<i> username, URL, user-agent, etc) and uses that information to determine 
</I>&gt;<i> whether a user or host should be permitted to access that URL.&#160;&#160; It 
</I>&gt;<i> almost always works well, but we have a recurring occasional issue that 
</I>&gt;<i> I can't figure out.
</I>&gt;<i> 
</I>&gt;<i> When it occurs, it's always around 4AM.&#160;&#160; This particular request occurs 
</I>&gt;<i> often - averages about once a second throughout the day.
</I>&gt;<i> 
</I>&gt;<i> What we see is a &quot;403 forbidden&quot; for a (should be) permitted site from 
</I>&gt;<i> an authenticated user from the same IP/user and to the same site that 
</I>&gt;<i> gets a &quot;202 connection established&quot; every other time.
</I>
Is maybe 4am the time when your auth system refreshes all nonce?
  - thus making any currently in-use by the clients invalid until they 
re-auth. You might see a mix of 403/401/407 in a bunch at such times.


Or maybe in a similar style one/some of the clients is broken and fails 
to update its nonce before it expires at 4am?
  - looking at which client agent and IP were getting the 403 and/or the 
nonce which received 403 will give you hints about this possibility.


Or your network router(s) do garbage collection and terminate 
long-running connections to free up TCP resources?
  - thus forcing a lot of client re-connects at 4am, which may:
  a) overload the auth system/helper, or
  b) break a transaction that included nonce update for clients - 
resulting in their next request being invalid nonce.


Or maybe you have log processing software that does &quot;squid -k restart&quot; 
instead of the proper &quot;squid -k rotate&quot; to get access to the log files?

Or maybe your auth system has a limit on how large nonce-count can become?
  - I notice that the working request has 0x2F uses and the forbidden 
has 0x35 (suspiciously close to 50 in decimal)




&gt;<i> 
</I>&gt;<i> The difference I see in the logs:&#160; though all the digest auth info looks 
</I>&gt;<i> okay, the %un field in the log for the usual (successful) request is the 
</I>&gt;<i> authenticated username, while in the failed request, it's &quot;-&quot;.&#160;&#160; So 
</I>&gt;<i> though there hasn't been an authentication error or &quot;authentication 
</I>&gt;<i> required&quot; in the log - and the username is in the authentication details 
</I>&gt;<i> in the log entry -&#160; it seems like squid isn't recognizing that username 
</I>&gt;<i> as %un.
</I>

Be aware that a properly behaving client will *not* send credentials 
until they are requested, after which it should *always* send 
credentials on that same connection (even if they are not requested 
explicitly).

That means some requests on a multiplex/pipeline/keep-alive connection 
MAY arrive with credentials and be accepted(2xx)/denied(403) without 
authentication having occured. Entirely due to your *_access directives 
sequence. In these cases the log will show auth headers but no value for 
%un and/or %ul.


&gt;<i> 
</I>&gt;<i> My squid.conf first tests a request to see if an unauthenticated request 
</I>&gt;<i> from a particular host is permitted.&#160; That external ACL doesn't take a 
</I>&gt;<i> username as an argument.&#160;&#160; If that external ACL passes, the request is 
</I>&gt;<i> allowed.
</I>&gt;<i> 
</I>
Please *show* the config lines rather than describing what you *think* 
they do. Their exact ordering matters *a lot*.

  Obfuscation of sensitive details is okay/expected so long as you makes 
it easy for us to tell that value A and value B are different.


FWIW; if your config file is *actually* containing only what you 
described it is missing a number of things necessary to have a safe and 
secure proxy. A look at your full config (without comments or empty 
lines) will help us point out any unnoticed issues for you to consider 
fixing.


&gt;<i> The next line in squid.conf is
</I>&gt;<i> 
</I>&gt;<i> acl auth_users proxy_auth REQUIRED
</I>&gt;<i> 
</I>
FYI the above just means that Squid is using authentication. It says 
nothing about when the authentication will be (or not be) performed.


&gt;<i> ... and after that, the external ACL that takes the username as well as 
</I>&gt;<i> the other info.
</I>&gt;<i> 
</I>

HTH
Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="026696.html">[squid-users] can't explain 403 denied for authenticated user
</A></li>
	<LI>Next message (by thread): <A HREF="026697.html">[squid-users] urlfilterdb.com
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#26707">[ date ]</a>
              <a href="thread.html#26707">[ thread ]</a>
              <a href="subject.html#26707">[ subject ]</a>
              <a href="author.html#26707">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
