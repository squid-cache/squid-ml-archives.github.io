<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Questions about Squid configuration
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Questions%20about%20Squid%20configuration&In-Reply-To=%3Cd87dd344-2ccc-4534-93fc-d22e24a1757b%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="027178.html">
   <LINK REL="Next"  HREF="027180.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Questions about Squid configuration</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Questions%20about%20Squid%20configuration&In-Reply-To=%3Cd87dd344-2ccc-4534-93fc-d22e24a1757b%40measurement-factory.com%3E"
       TITLE="[squid-users] Questions about Squid configuration">rousskov at measurement-factory.com
       </A><BR>
    <I>Thu Oct  3 21:52:11 UTC 2024</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="027178.html">[squid-users] Squid + c-icap + SquidClamav + ClamAV
</A></li>
        <LI>Next message (by thread): <A HREF="027180.html">[squid-users] Squid 6.10 SSL-Bump Woes
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27179">[ date ]</a>
              <a href="thread.html#27179">[ thread ]</a>
              <a href="subject.html#27179">[ subject ]</a>
              <a href="author.html#27179">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 2024-09-25 01:57, &#12395;&#12400; wrote:

&gt;<i> We then added the following settings that were in the existing Squid proxy
</I>&gt;<i> 
</I>&gt;<i> # SSL_BUMP
</I>&gt;<i> acl allowed_https_sites ssl::server_name &quot;/etc/squid/whitelist&quot;
</I>&gt;<i> acl allowed_https_sites ssl::server_name &quot;/etc/squid/whitelist_transparent&quot;
</I>&gt;<i> acl allowed_https_sites ssl::server_name &quot;/etc/squid/whitelist_https&quot;
</I>&gt;<i> acl allowed_https_sites ssl::server_name
</I>&gt;<i> &quot;/etc/squid/whitelist_transparent_https&quot;
</I>&gt;<i> sslcrtd_program [sslcrtd-program-setting]
</I>&gt;<i> 
</I>&gt;<i> acl step1 at_step SslBump1
</I>&gt;<i> acl step2 at_step SslBump2
</I>&gt;<i> acl step3 at_step SslBump3
</I>&gt;<i> 
</I>&gt;<i> ssl_bump peek step1 all
</I>&gt;<i> ssl_bump peek step2 allowed_https_sites
</I>&gt;<i> ssl_bump splice step3 allowed_https_sites
</I>&gt;<i> ssl_bump terminate step2 all
</I>&gt;<i> 
</I>&gt;<i> Then I verified the 4 patterns again and all of them gave me 403 Forbidden...
</I>&gt;<i> Even the following pattern which is allowed in whitelist.
</I>&gt;&gt;<i> 1. successful communication of a valid request to an allowed site
</I>&gt;&gt;<i> curl <A HREF="https://pypi.org/">https://pypi.org/</A> -v --cacert squid.crt -k
</I>&gt;<i> 
</I>&gt;<i> After checking access-transparent.log and cache.log, it appears that
</I>&gt;<i> pypi.org is comparing inspections by IP and not by domain.
</I>
AFAICT, you expect allowed_https_sites ACL to match the above 
intercepted pypi request and, hence, to be allowed by the following 
http_access rule:

     http_access allow allowed_https_sites https_port

Since you are intercepting traffic, at SslBump step1, Squid only sees 
TCP-level information extracted from the intercepted connection. There 
are no domain names. There is no HTTP-level information at that time. 
See &quot;Step 1:&quot; at <A HREF="https://wiki.squid-cache.org/Features/SslPeekAndSplice">https://wiki.squid-cache.org/Features/SslPeekAndSplice</A>

When evaluating that dstdomain ACL (allowed_https_sites), Squid will 
attempt to convert the intended destination IP address of the 
intercepted TCP connection to a domain name and will compare the result 
of that conversion to allowed_https_sites entries. Evidently, either 
that reverse DNS lookup fails in your case, or the result (is not 
&quot;pypi.org&quot; and) does not match any allowed_https_sites names.

Since no other &quot;http_access allow&quot; rule matches the fake CONNECT at 
SslBump step1, the transaction is denied by the first &quot;http_access deny 
all&quot; rule (BTW, you can remove the second one -- it is unreachable).


&gt;<i> How do I modify the configuration to allow this correctly by domain?
</I>
It is difficult for me to answer this loaded question in a meaningful 
way. At SslBump step1, Squid gets an IP address. Squid has to either 
allow or deny that request based on available information. You have 
several options, including:

A. During SslBump step1, deny access based on IP addresses by adding 
appropriate dst ACLs that would be checked by http_access rules.

B. During SslBump step1, allow fake CONNECT requests to any IP address 
while making sure that you deny what needs to be denied at step2 or step3.


Needless to say, for an http_access rule to only apply during SslBump 
step1 it has to have an &quot;SslBump1&quot; ACL name. For example, the following 
rule allows any(*) fake CONNECT request during SslBump step1:

     # Allow all fake CONNECTs on intercepted connections until
     # we have a chance to extract TLS SNI information (step2).
     http_access allow step1 https_port


(*) any request that was not denied by earlier rules, of course


&gt;<i> Also, to begin with, these settings follow the existing squid proxy
</I>&gt;<i> created by my predecessor, so I don't know what they are for...
</I>&gt;<i> What are the disadvantages of removing these settings?
</I>
If you remove all ssl_bump rules, then Squid will not examine traffic 
inside intercepted TCP/TLS connections. Thus, TLS clients will be able 
to request/do anything (if their intercepted TCP connections are allowed 
using TCP-level information). Whether that effect is a &quot;disadvantage&quot; is 
your call.


HTH,

Alex.


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="027178.html">[squid-users] Squid + c-icap + SquidClamav + ClamAV
</A></li>
	<LI>Next message (by thread): <A HREF="027180.html">[squid-users] Squid 6.10 SSL-Bump Woes
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27179">[ date ]</a>
              <a href="thread.html#27179">[ thread ]</a>
              <a href="subject.html#27179">[ subject ]</a>
              <a href="author.html#27179">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
