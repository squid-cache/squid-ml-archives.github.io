<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] proxy_auth_regex
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20proxy_auth_regex&In-Reply-To=%3C1d43b17c9ca14400a0d0edbcd0cb33f5%40hexcel.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="027219.html">
   <LINK REL="Next"  HREF="027221.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] proxy_auth_regex</H1>
    <B>Piana, Josh</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20proxy_auth_regex&In-Reply-To=%3C1d43b17c9ca14400a0d0edbcd0cb33f5%40hexcel.com%3E"
       TITLE="[squid-users] proxy_auth_regex">Josh.Piana at hexcel.com
       </A><BR>
    <I>Thu Oct 24 20:23:13 UTC 2024</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="027219.html">[squid-users] proxy_auth_regex
</A></li>
        <LI>Next message (by thread): <A HREF="027221.html">[squid-users] proxy_auth_regex
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27220">[ date ]</a>
              <a href="thread.html#27220">[ thread ]</a>
              <a href="subject.html#27220">[ subject ]</a>
              <a href="author.html#27220">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Alex, 

From what I can tell, squid does not receive a good username. When I check the access logs, I receive something like this:
24/Oct/2024:16:01:08 -0400.334 10.46.49.190 TCP_DENIED/407 7821 CONNECT www.google.com:443 - \ HIER_NONE/- text/html ERR_CACHE_ACCESS_DENIED/-

However, I think some of my log information may be missing. I believe you mentioned it before, so I'll show you what I'm using for our custom log directive. Maybe we can fix this too? What I originally tried to do with this was just get &quot;human readable&quot; time stamps:
logformat custom %tl.%03tu %&gt;a %Ss/%03&gt;Hs %&lt;st %rm %ru %[un \ %Sh/%&lt;a %mt %err_code/%err_detail

In regards to the TLS connectors vs HTTP CONNECT requests, that is a great point. I'm not sure if that is the case, but is &quot;proxy_auth_regex&quot; not compatible with certain things? How would you recommend I test plain http traffic?


-----Original Message-----
From: Alex Rousskov &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt; 
Sent: Thursday, October 24, 2024 4:13 PM
To: Piana, Josh &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">Josh.Piana at hexcel.com</A>&gt;; <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
Subject: Re: [squid-users] proxy_auth_regex

Caution: This email originated from outside of Hexcel. Do not click links or open attachments unless you recognize the sender and know the content is safe.


On 2024-10-24 15:53, Piana, Josh wrote:
&gt;<i> Hey Squid users,
</I>&gt;<i>
</I>&gt;<i> Running into an issue I&#8217;m trying to figure out.
</I>&gt;<i>
</I>&gt;<i> We have a few acl directives using &#8220;proxy_auth_regex &#8211;i&#8221; and when I 
</I>&gt;<i> have these active, it blocks any proxy connection with an HTTP 407 
</I>&gt;<i> error, according to the logs.
</I>&gt;<i>
</I>&gt;<i> Here&#8217;s an example:
</I>&gt;<i>
</I>&gt;<i> # block certain user IDs from using proxy server
</I>&gt;<i>
</I>&gt;<i> #acl block_user proxy_auth_regex -i &quot;/etc/squid/block_user&quot;
</I>&gt;<i>
</I>&gt;<i> #http_access deny block_user
</I>&gt;<i>
</I>&gt;<i> What&#8217;s supposed to happen with this ACL, is that any username we have 
</I>&gt;<i> on that list is to be blocked from internet access. But it seems to be 
</I>&gt;<i> blocking known good usernames too. I&#8217;m not sure where to go from here
</I>
After asking for one with a 407 response, does Squid ever receive a &quot;good username&quot; from the client? Do you see a username in client HTTP request headers or access.log records containing %un field?

Perhaps the client refuses to authenticate its requests because Squid intercepts TLS client connections rather than receiving HTTP CONNECT requests from the client? Have you tested this with plain text traffic?

Alex.


&gt;<i> we would like to use these ACL&#8217;s but for right now I have these rules 
</I>&gt;<i> commented out.
</I>&gt;<i>
</I>&gt;<i> Here's a few other rules we have that have the same issue:
</I>&gt;<i>
</I>&gt;<i> # executable blocking
</I>&gt;<i>
</I>&gt;<i> # reference this list for extensions to block
</I>&gt;<i>
</I>&gt;<i> acl exec_files url_regex -i &quot;/etc/squid/exec_files&quot;
</I>&gt;<i>
</I>&gt;<i> # ignore these usernames from being blocked
</I>&gt;<i>
</I>&gt;<i> #acl exec_users proxy_auth_regex -i &quot;/etc/squid/exec_users&quot;
</I>&gt;<i>
</I>&gt;<i> # combine the rules
</I>&gt;<i>
</I>&gt;<i> #http_access deny !bad_exception_urls !exec_users exec_files
</I>&gt;<i>
</I>&gt;<i> #deny_info ERR_BLOCK_TYPE exec_files
</I>&gt;<i>
</I>&gt;<i>  From what you can see above, we have &#8220;acl exec_files url_regex -i 
</I>&gt;<i> /etc/squid/exec_files&quot; uncommented, but it&#8217;s not active because the 
</I>&gt;<i> &#8220;http_access directive&#8221; had to be commented out because it includes 
</I>&gt;<i> the other statements that include &#8220;proxy_auth_regex &#8211;i&#8221; which block 
</I>&gt;<i> all internet access as well.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="https://eur02.safelinks.protection.outlook.com/?url=https%3A%2F%2Flist">https://eur02.safelinks.protection.outlook.com/?url=https%3A%2F%2Flist</A>
</I>&gt;<i> s.squid-cache.org%2Flistinfo%2Fsquid-users&amp;data=05%7C02%7CJosh.Piana%4
</I>&gt;<i> 0hexcel.com%7C7fb1087ae57b47c397a408dcf4684eaf%7C4248050df19546d5ac9c0
</I>&gt;<i> c7c52b04cae%7C0%7C0%7C638653976041876515%7CUnknown%7CTWFpbGZsb3d8eyJWI
</I>&gt;<i> joiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C0%7C%7
</I>&gt;<i> C%7C&amp;sdata=D6d%2BXvUp%2FHTvsqC5oneWw%2FdYNWYkmsQUz0lKHLzRk0o%3D&amp;reserv
</I>&gt;<i> ed=0
</I>
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="027219.html">[squid-users] proxy_auth_regex
</A></li>
	<LI>Next message (by thread): <A HREF="027221.html">[squid-users] proxy_auth_regex
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27220">[ date ]</a>
              <a href="thread.html#27220">[ thread ]</a>
              <a href="subject.html#27220">[ subject ]</a>
              <a href="author.html#27220">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
