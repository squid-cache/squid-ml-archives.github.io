<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Help regarding access controls for TLS connections
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Help%20regarding%20access%20controls%20for%20TLS%20connections&In-Reply-To=%3Cfb0b75ba-44d9-4552-8ddf-18c42cb3b8de%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="027227.html">
   <LINK REL="Next"  HREF="027230.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Help regarding access controls for TLS connections</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Help%20regarding%20access%20controls%20for%20TLS%20connections&In-Reply-To=%3Cfb0b75ba-44d9-4552-8ddf-18c42cb3b8de%40measurement-factory.com%3E"
       TITLE="[squid-users] Help regarding access controls for TLS connections">rousskov at measurement-factory.com
       </A><BR>
    <I>Sun Oct 27 23:14:27 UTC 2024</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="027227.html">[squid-users] Help regarding access controls for TLS connections
</A></li>
        <LI>Next message (by thread): <A HREF="027230.html">[squid-users] Help regarding access controls for TLS connections
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27229">[ date ]</a>
              <a href="thread.html#27229">[ thread ]</a>
              <a href="subject.html#27229">[ subject ]</a>
              <a href="author.html#27229">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 2024-10-25 18:18, Erik Schulz wrote:

&gt;<i> I would like to use squid as an egress proxy, to prevent unauthorized egress.
</I>&gt;<i> 
</I>&gt;<i> Let's say that the only allowed egress is 'example.com'.
</I>&gt;<i> I can define acl along the lines of:
</I>&gt;<i> ```
</I>&gt;<i> acl allowed_domains ssl::server_name .example.com
</I>&gt;<i> http_access allow allowed_domains
</I>&gt;<i> ```
</I>
&gt;<i> But can someone help me understand what actually happens?
</I>
A lot of thing happens, including: After parsing received HTTP(S) or FTP 
request, Squid checks http_access rules and either allows or denies the 
request. For HTTPS requests that are subject to ssl_bump rules, that 
processing happens multiple times, at various SslBump steps, as detailed 
at <A HREF="https://wiki.squid-cache.org/Features/SslPeekAndSplice">https://wiki.squid-cache.org/Features/SslPeekAndSplice</A>

N.B. http_access check is a part of &quot;Callout Sequence&quot; referenced on the 
above page in step1 and step2. There are some bugs in the current Squid 
implementation of that document, but it is still a useful starting point.


&gt;<i> I want to avoid any DNS egress attack.
</I>
How do you define &quot;DNS egress attack&quot;? To the extent possible, please 
answer in terms of what Squid should or should not do with traffic Squid 
receives.


&gt;<i> The client does not have DNS access.
</I>&gt;<i> Am I correct that the client can use HTTPS_PROXY without DNS, such
</I>&gt;<i> that the proxy will perform the DNS lookup?
</I>
If you do not control the client, then you should assume that it can 
send any request to/through Squid. This includes sending an HTTPS 
requests without using DNS. Whether the proxy receiving the request is 
going to perform a DNS lookup is a separate question. Many factors 
affect that proxy decision.


&gt;<i> Can you help me understand how the acl checks the server_name?
</I>
You already know how server_name documentation answers this question. It 
is not clear to me what undocumented aspects you want to know about. 
Could you please clarify by asking a more specific question?


&gt;<i> In order to connect to the server, it must perform a DNS lookup, which
</I>&gt;<i> causes a leak.
</I>
Sorry, I am not sure what &quot;it&quot; is in this context, but, as you probably 
already know from the same docs, &quot;Unlike dstdomain, [ssl::server_name] 
ACL does not perform DNS lookups.&quot;

If Squid needs to connect to server X, and X is a domain name, Squid 
will (in most cases) attempt to resolve X to get server IP address(es), 
but that attempt happens before and/or after Sqiud evaluates 
ssl::server_name ACL.


&gt;<i> So the ACL must validate the server_name without a DNS lookup, and
</I>&gt;<i> since the server IP is therefore unknown, without connecting to the
</I>&gt;<i> server or verifying against its certificate.
</I>
During server_name ACL evaluation, Squid does not attempt to connection 
to any other server or service. The ACL match/mismatch decision is made 
by comparing various strings using either domain comparison function 
(for server_name) or regex evaluation (for server_name_regex).

The server IP address may or may not be known at ssl::server_name 
evaluation time.


&gt;<i> I'm assuming the hostname is known in the CONNECT phase of the request?
</I>
Assuming that CONNECT request has arrived at http_port, the answer 
depends on many factors, possibly including:

* whether the client supplied a hostname in CONNECT request headers;
* whether the client supplied a hostname in TLS SNI field;
* whether the CONNECT request is subject to ssl_bump rules;
* whether Squid is opening a tunnel to an origin server or cache_peer

&gt;<i> Is it possible to check against the connect hostname only?
</I>
Without SslBump, &quot;dstdomain -n&quot; would probably do that. With SslBump, 
&quot;dstdomain -n&quot; would probably do that during SslBump step1 (and step2 if 
client does not supply TLS SNI). All this needs careful testing though; 
there are many configuration parameters and request specifics at play here!


&gt;<i> The docs say that
</I>&gt;&gt;<i> &quot;The ACL computes server name(s) using such information sources as CONNECT request URI, TLS client SNI, and TLS server certificate subject (CN and SubjectAltName). The computed server name(s) usually change with each SslBump step&quot;
</I>&gt;<i> 
</I>&gt;<i> I find this concerning, because I assume the client could perform a
</I>&gt;<i> request with an IP, and a forged SNI name that passes the acl.
</I>&gt;<i> So I would like to only allow requests that declare FQDN hostname, and
</I>&gt;<i> reject IP hostnames.
</I>
You probably can use dstdomain_reject to reject IP-based hostnames, but 
it may not be easy to do it reliably using regular expressions because 
IP addresses come in many forms. Squid is probably missing an 
&quot;dst_is_ip&quot; or similar ACL(s) to make such checks reliable.


&gt;<i> And, only perform validation against the CONNECT request URI.
</I>
See above regarding using &quot;dstdomain -n&quot; for this.


HTH,

Alex.


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="027227.html">[squid-users] Help regarding access controls for TLS connections
</A></li>
	<LI>Next message (by thread): <A HREF="027230.html">[squid-users] Help regarding access controls for TLS connections
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27229">[ date ]</a>
              <a href="thread.html#27229">[ thread ]</a>
              <a href="subject.html#27229">[ subject ]</a>
              <a href="author.html#27229">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
