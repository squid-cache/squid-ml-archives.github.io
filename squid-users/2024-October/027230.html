<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Help regarding access controls for TLS connections
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Help%20regarding%20access%20controls%20for%20TLS%20connections&In-Reply-To=%3CCAE5KivggGuNE8S7Hjs_gX0qMLUwJF2XOO0ixGyrOE46YWn_VEA%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="027229.html">
   <LINK REL="Next"  HREF="027231.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Help regarding access controls for TLS connections</H1>
    <B>Erik Schulz</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Help%20regarding%20access%20controls%20for%20TLS%20connections&In-Reply-To=%3CCAE5KivggGuNE8S7Hjs_gX0qMLUwJF2XOO0ixGyrOE46YWn_VEA%40mail.gmail.com%3E"
       TITLE="[squid-users] Help regarding access controls for TLS connections">erikschulz184 at gmail.com
       </A><BR>
    <I>Mon Oct 28 15:47:10 UTC 2024</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="027229.html">[squid-users] Help regarding access controls for TLS connections
</A></li>
        <LI>Next message (by thread): <A HREF="027231.html">[squid-users] Help regarding access controls for TLS connections
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27230">[ date ]</a>
              <a href="thread.html#27230">[ thread ]</a>
              <a href="subject.html#27230">[ subject ]</a>
              <a href="author.html#27230">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Alex,

Thank you for your detailed response!

I realized later that I was applying 'localnet' rules before the
dstdomain rules, which was the cause of the unauthorized dns lookup.
By rearranging the rules, such that `dstdomain -n` rules are tested
first, there is no dns lookup. Well, I do see a reverse dns lookup for
the client's ip, that I can't explain, but even if that is the case,
it would require client IP spoofing. But I don't understand why the
reverse lookup happens. I'm only testing `src`, not `srcdomain`.
----
# deny if not authenticated
auth_param basic program /usr/lib/squid/basic_ncsa_auth /etc/squid/passwd
acl authenticated proxy_auth REQUIRED
http_access deny !authenticated

# deny if not allowed domains
acl user_user2 proxy_auth user2
acl allowed_domains2 dstdomain -n .example.com
http_access deny user_user2 !allowed_domains2

# deny public ip
acl localnet_src src 0.0.0.1-0.255.255.255
acl localnet_src src 10.0.0.0/8
acl localnet_src src 100.64.0.0/10
acl localnet_src src 169.254.0.0/16
acl localnet_src src 172.16.0.0/12
acl localnet_src src 192.168.0.0/16
acl localnet_src src fc00::/7
acl localnet_src src fe80::/10
http_access deny !localnet_src

# deny local destination (resolved hostname)
acl localnet_dst dst 0.0.0.1-0.255.255.255
acl localnet_dst dst 10.0.0.0/8
acl localnet_dst dst 100.64.0.0/10
acl localnet_dst dst 169.254.0.0/16
acl localnet_dst dst 172.16.0.0/12
acl localnet_dst dst 192.168.0.0/16
acl localnet_dst dst fc00::/7
acl localnet_dst dst fe80::/10
http_access deny localnet_dst

acl Safe_ports port 80
acl Safe_ports port 443
http_access deny !Safe_ports

cache deny all

http_access allow
----

Regarding what DNS egress attack is:
The use of a forward proxy (&quot;egress controller&quot;) is to prevent
unauthorized egress, i.e. leaking any data, including TLS or CA
private keys, which can be relatively few bytes.
Unauthorized DNS egress is low bandwidth, but that doesn't matter.
Here is a ChatGPT explanation of what a DNS egress attack is:
---
A DNS egress attack exploits DNS queries to stealthily extract
sensitive information from within a network. Here&#8217;s how it operates
and why it&#8217;s effective:
- DNS as a Covert Channel: DNS requests are typically unfiltered and
allowed through most firewalls. Attackers use DNS requests to
exfiltrate data by embedding information in DNS queries, which often
bypasses traditional egress filters.
- Steganography in DNS Requests: Attackers encode sensitive
information (like passwords or encryption keys) into DNS request
subdomains. For example, a query like data1234.attacker.com can encode
data (data1234) before resolving to the attacker-controlled domain.
- Recursive Resolver Complicity: Since DNS queries are recursively
resolved, intermediate DNS resolvers help propagate the data-laden
requests to the final DNS server controlled by the attacker. This adds
complexity to tracking and blocking the egress path.
- Low Detectability: Normal DNS queries blend into typical network
traffic, making these attacks hard to detect, especially if small
amounts of data are exfiltrated over time.
- Mitigation Gaps: Most firewalls overlook the payload within DNS
queries, focusing instead on blocking IPs or domains, which doesn't
stop the encoding of sensitive data in the DNS request itself.
- DNS data egress attacks are potent because they exploit a
foundational internet protocol for covert data transmission. Solutions
demand vigilant DNS traffic analysis and strict egress filtering
policies.
---

On Mon, Oct 28, 2024 at 12:14&#8239;AM Alex Rousskov
&lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt; wrote:
&gt;<i>
</I>&gt;<i> On 2024-10-25 18:18, Erik Schulz wrote:
</I>&gt;<i>
</I>&gt;<i> &gt; I would like to use squid as an egress proxy, to prevent unauthorized egress.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Let's say that the only allowed egress is 'example.com'.
</I>&gt;<i> &gt; I can define acl along the lines of:
</I>&gt;<i> &gt; ```
</I>&gt;<i> &gt; acl allowed_domains ssl::server_name .example.com
</I>&gt;<i> &gt; http_access allow allowed_domains
</I>&gt;<i> &gt; ```
</I>&gt;<i>
</I>&gt;<i> &gt; But can someone help me understand what actually happens?
</I>&gt;<i>
</I>&gt;<i> A lot of thing happens, including: After parsing received HTTP(S) or FTP
</I>&gt;<i> request, Squid checks http_access rules and either allows or denies the
</I>&gt;<i> request. For HTTPS requests that are subject to ssl_bump rules, that
</I>&gt;<i> processing happens multiple times, at various SslBump steps, as detailed
</I>&gt;<i> at <A HREF="https://wiki.squid-cache.org/Features/SslPeekAndSplice">https://wiki.squid-cache.org/Features/SslPeekAndSplice</A>
</I>&gt;<i>
</I>&gt;<i> N.B. http_access check is a part of &quot;Callout Sequence&quot; referenced on the
</I>&gt;<i> above page in step1 and step2. There are some bugs in the current Squid
</I>&gt;<i> implementation of that document, but it is still a useful starting point.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; I want to avoid any DNS egress attack.
</I>&gt;<i>
</I>&gt;<i> How do you define &quot;DNS egress attack&quot;? To the extent possible, please
</I>&gt;<i> answer in terms of what Squid should or should not do with traffic Squid
</I>&gt;<i> receives.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; The client does not have DNS access.
</I>&gt;<i> &gt; Am I correct that the client can use HTTPS_PROXY without DNS, such
</I>&gt;<i> &gt; that the proxy will perform the DNS lookup?
</I>&gt;<i>
</I>&gt;<i> If you do not control the client, then you should assume that it can
</I>&gt;<i> send any request to/through Squid. This includes sending an HTTPS
</I>&gt;<i> requests without using DNS. Whether the proxy receiving the request is
</I>&gt;<i> going to perform a DNS lookup is a separate question. Many factors
</I>&gt;<i> affect that proxy decision.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; Can you help me understand how the acl checks the server_name?
</I>&gt;<i>
</I>&gt;<i> You already know how server_name documentation answers this question. It
</I>&gt;<i> is not clear to me what undocumented aspects you want to know about.
</I>&gt;<i> Could you please clarify by asking a more specific question?
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; In order to connect to the server, it must perform a DNS lookup, which
</I>&gt;<i> &gt; causes a leak.
</I>&gt;<i>
</I>&gt;<i> Sorry, I am not sure what &quot;it&quot; is in this context, but, as you probably
</I>&gt;<i> already know from the same docs, &quot;Unlike dstdomain, [ssl::server_name]
</I>&gt;<i> ACL does not perform DNS lookups.&quot;
</I>&gt;<i>
</I>&gt;<i> If Squid needs to connect to server X, and X is a domain name, Squid
</I>&gt;<i> will (in most cases) attempt to resolve X to get server IP address(es),
</I>&gt;<i> but that attempt happens before and/or after Sqiud evaluates
</I>&gt;<i> ssl::server_name ACL.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; So the ACL must validate the server_name without a DNS lookup, and
</I>&gt;<i> &gt; since the server IP is therefore unknown, without connecting to the
</I>&gt;<i> &gt; server or verifying against its certificate.
</I>&gt;<i>
</I>&gt;<i> During server_name ACL evaluation, Squid does not attempt to connection
</I>&gt;<i> to any other server or service. The ACL match/mismatch decision is made
</I>&gt;<i> by comparing various strings using either domain comparison function
</I>&gt;<i> (for server_name) or regex evaluation (for server_name_regex).
</I>&gt;<i>
</I>&gt;<i> The server IP address may or may not be known at ssl::server_name
</I>&gt;<i> evaluation time.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; I'm assuming the hostname is known in the CONNECT phase of the request?
</I>&gt;<i>
</I>&gt;<i> Assuming that CONNECT request has arrived at http_port, the answer
</I>&gt;<i> depends on many factors, possibly including:
</I>&gt;<i>
</I>&gt;<i> * whether the client supplied a hostname in CONNECT request headers;
</I>&gt;<i> * whether the client supplied a hostname in TLS SNI field;
</I>&gt;<i> * whether the CONNECT request is subject to ssl_bump rules;
</I>&gt;<i> * whether Squid is opening a tunnel to an origin server or cache_peer
</I>&gt;<i>
</I>&gt;<i> &gt; Is it possible to check against the connect hostname only?
</I>&gt;<i>
</I>&gt;<i> Without SslBump, &quot;dstdomain -n&quot; would probably do that. With SslBump,
</I>&gt;<i> &quot;dstdomain -n&quot; would probably do that during SslBump step1 (and step2 if
</I>&gt;<i> client does not supply TLS SNI). All this needs careful testing though;
</I>&gt;<i> there are many configuration parameters and request specifics at play here!
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; The docs say that
</I>&gt;<i> &gt;&gt; &quot;The ACL computes server name(s) using such information sources as CONNECT request URI, TLS client SNI, and TLS server certificate subject (CN and SubjectAltName). The computed server name(s) usually change with each SslBump step&quot;
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; I find this concerning, because I assume the client could perform a
</I>&gt;<i> &gt; request with an IP, and a forged SNI name that passes the acl.
</I>&gt;<i> &gt; So I would like to only allow requests that declare FQDN hostname, and
</I>&gt;<i> &gt; reject IP hostnames.
</I>&gt;<i>
</I>&gt;<i> You probably can use dstdomain_reject to reject IP-based hostnames, but
</I>&gt;<i> it may not be easy to do it reliably using regular expressions because
</I>&gt;<i> IP addresses come in many forms. Squid is probably missing an
</I>&gt;<i> &quot;dst_is_ip&quot; or similar ACL(s) to make such checks reliable.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; And, only perform validation against the CONNECT request URI.
</I>&gt;<i>
</I>&gt;<i> See above regarding using &quot;dstdomain -n&quot; for this.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> HTH,
</I>&gt;<i>
</I>&gt;<i> Alex.
</I>&gt;<i>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">https://lists.squid-cache.org/listinfo/squid-users</A>
</I>
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="027229.html">[squid-users] Help regarding access controls for TLS connections
</A></li>
	<LI>Next message (by thread): <A HREF="027231.html">[squid-users] Help regarding access controls for TLS connections
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27230">[ date ]</a>
              <a href="thread.html#27230">[ thread ]</a>
              <a href="subject.html#27230">[ subject ]</a>
              <a href="author.html#27230">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
