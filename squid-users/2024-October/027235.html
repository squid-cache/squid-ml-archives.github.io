<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] proxy_auth_regex
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20proxy_auth_regex&In-Reply-To=%3C8ac4926f-e751-4d85-86f8-32beaa30dd07%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="027234.html">
   <LINK REL="Next"  HREF="027225.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] proxy_auth_regex</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20proxy_auth_regex&In-Reply-To=%3C8ac4926f-e751-4d85-86f8-32beaa30dd07%40measurement-factory.com%3E"
       TITLE="[squid-users] proxy_auth_regex">rousskov at measurement-factory.com
       </A><BR>
    <I>Mon Oct 28 23:09:03 UTC 2024</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="027234.html">[squid-users] proxy_auth_regex
</A></li>
        <LI>Next message (by thread): <A HREF="027225.html">[squid-users] Square Bracket in LogFormat
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27235">[ date ]</a>
              <a href="thread.html#27235">[ thread ]</a>
              <a href="subject.html#27235">[ subject ]</a>
              <a href="author.html#27235">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 2024-10-28 16:35, Piana, Josh wrote:

&gt;<i> TL;DR, anytime I turn on one of our ACL's that have
</I>&gt;<i> &quot;proxy_auth_regex&quot;, I'm unable to access the internet through the
</I>&gt;<i> proxy at all.
</I>
Hello Josh,

     Your Squid authentication helper probably does not work. Until that 
problem is fixed, you will not be able to use authentication ACLs 
reliably or at all, as detailed at 
<A HREF="https://lists.squid-cache.org/pipermail/squid-users/2024-October/027224.html">https://lists.squid-cache.org/pipermail/squid-users/2024-October/027224.html</A>

Alex.


&gt;<i> Here's an example of one of our rules:
</I>&gt;<i> 
</I>&gt;<i> # block certain user IDs from using proxy server
</I>&gt;<i> acl block_user proxy_auth_regex -i &quot;/etc/squid/block_user&quot;
</I>&gt;<i> http_access deny block_user
</I>&gt;<i> 
</I>&gt;<i> I'm testing with an account that is not on the &quot;block_user&quot; list. Yet, when I browse to known good sites, I'm met with a generic webpage error, and not a squid error. The generic error, using Firefox, is &quot;The proxy server is refusing connections&quot;. Yet, activating that ACL should not have this behavior. Only if a username that's a part of the block_user list is on there. This is the same for the 3 other rules we're using &quot; proxy_auth_regex&quot; for. Which leads me to believe we're not able to pass what the directive is asking for.
</I>&gt;<i> 
</I>&gt;<i> The issue is, I'm having trouble pinpointing it.
</I>&gt;<i> 
</I>&gt;<i> I went here, on the Squid config pages and looked into it further:
</I>&gt;<i> <A HREF="https://www.squid-cache.org/Doc/config/acl/">https://www.squid-cache.org/Doc/config/acl/</A>
</I>&gt;<i> 
</I>&gt;<i> I read the notes for this directive but I'm still a bit confused on where the issue is. Authentication seems to be working, but it's like this term either doesn't pass the credentials along, or it's expecting some other response. Is there anyone that could help me figure out what the issue is with this?
</I>&gt;<i> 
</I>&gt;<i> Thank you,
</I>&gt;<i> Josh
</I>&gt;<i> 
</I>&gt;<i> -----Original Message-----
</I>&gt;<i> From: Alex Rousskov &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt;
</I>&gt;<i> Sent: Thursday, October 24, 2024 4:46 PM
</I>&gt;<i> To: Piana, Josh &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">Josh.Piana at hexcel.com</A>&gt;; <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> Subject: Re: [squid-users] proxy_auth_regex
</I>&gt;<i> 
</I>&gt;<i> Caution: This email originated from outside of Hexcel. Do not click links or open attachments unless you recognize the sender and know the content is safe.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> On 2024-10-24 16:23, Piana, Josh wrote:
</I>&gt;<i> 
</I>&gt;&gt;<i>  From what I can tell, squid does not receive a good username. When I check the access logs, I receive something like this:
</I>&gt;<i> 
</I>&gt;&gt;<i> 24/Oct/2024:16:01:08 -0400.334 10.46.49.190 TCP_DENIED/407 7821
</I>&gt;&gt;<i> CONNECT
</I>&gt;&gt;<i> <A HREF="http://www.g/">http://www.g/</A>
</I>&gt;&gt;<i> oogle.com%3A443%2F&amp;data=05%7C02%7CJosh.Piana%40hexcel.com%7C29bbc9983f
</I>&gt;&gt;<i> 2742ff81e108dcf46cd820%7C4248050df19546d5ac9c0c7c52b04cae%7C0%7C0%7C63
</I>&gt;&gt;<i> 8653995560620056%7CUnknown%7CTWFpbGZsb3d8eyJWIjoiMC4wLjAwMDAiLCJQIjoiV
</I>&gt;&gt;<i> 2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C60000%7C%7C%7C&amp;sdata=W%2BZDXkp
</I>&gt;&gt;<i> r6hr5wvICtWMUGsugzHqz7%2BHS7UEKX7N5CPI%3D&amp;reserved=0 - \ HIER_NONE/-
</I>&gt;&gt;<i> text/html ERR_CACHE_ACCESS_DENIED/-
</I>&gt;<i> 
</I>&gt;<i> Please check CONNECT request headers in packet captures or cache.log with debug_options set to ALL,2. If client does not send any user credentials to Squid, then Squid should request them (with a 407 CONNECT response containing appropriate headers).
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> In regards to the TLS connectors vs HTTP CONNECT requests ...
</I>&gt;<i>   &gt; I'm not sure if that is the case
</I>&gt;<i> 
</I>&gt;<i> Does the problematic test transaction arrive at http_port or https_port?
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i>   &gt; is &quot;proxy_auth_regex&quot; not compatible with certain things?
</I>&gt;<i> 
</I>&gt;<i> Nearly every Squid configuration option is not compatible with certain things.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i>   &gt; How would you recommend I test plain http traffic?
</I>&gt;<i> 
</I>&gt;<i> I would start with
</I>&gt;<i> 
</I>&gt;<i>       curl --verbose ... <A HREF="http://example.com/">http://example.com/</A>
</I>&gt;<i> 
</I>&gt;<i> or a similar request (add proxy/other options instead of &quot;...&quot; as needed).
</I>&gt;<i> 
</I>&gt;<i> Alex.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> However, I think some of my log information may be missing. I believe you mentioned it before, so I'll show you what I'm using for our custom log directive. Maybe we can fix this too? What I originally tried to do with this was just get &quot;human readable&quot; time stamps:
</I>&gt;&gt;<i> logformat custom %tl.%03tu %&gt;a %Ss/%03&gt;Hs %&lt;st %rm %ru %[un \ %Sh/%&lt;a
</I>&gt;&gt;<i> %mt %err_code/%err_detail
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> In regards to the TLS connectors vs HTTP CONNECT requests, that is a great point. I'm not sure if that is the case, but is &quot;proxy_auth_regex&quot; not compatible with certain things? How would you recommend I test plain http traffic?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> -----Original Message-----
</I>&gt;&gt;<i> From: Alex Rousskov &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt;
</I>&gt;&gt;<i> Sent: Thursday, October 24, 2024 4:13 PM
</I>&gt;&gt;<i> To: Piana, Josh &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">Josh.Piana at hexcel.com</A>&gt;;
</I>&gt;&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;&gt;<i> Subject: Re: [squid-users] proxy_auth_regex
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Caution: This email originated from outside of Hexcel. Do not click links or open attachments unless you recognize the sender and know the content is safe.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> On 2024-10-24 15:53, Piana, Josh wrote:
</I>&gt;&gt;&gt;<i> Hey Squid users,
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Running into an issue I&#8217;m trying to figure out.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> We have a few acl directives using &#8220;proxy_auth_regex &#8211;i&#8221; and when I
</I>&gt;&gt;&gt;<i> have these active, it blocks any proxy connection with an HTTP 407
</I>&gt;&gt;&gt;<i> error, according to the logs.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Here&#8217;s an example:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> # block certain user IDs from using proxy server
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> #acl block_user proxy_auth_regex -i &quot;/etc/squid/block_user&quot;
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> #http_access deny block_user
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> What&#8217;s supposed to happen with this ACL, is that any username we have
</I>&gt;&gt;&gt;<i> on that list is to be blocked from internet access. But it seems to
</I>&gt;&gt;&gt;<i> be blocking known good usernames too. I&#8217;m not sure where to go from
</I>&gt;&gt;&gt;<i> here
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> After asking for one with a 407 response, does Squid ever receive a &quot;good username&quot; from the client? Do you see a username in client HTTP request headers or access.log records containing %un field?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Perhaps the client refuses to authenticate its requests because Squid intercepts TLS client connections rather than receiving HTTP CONNECT requests from the client? Have you tested this with plain text traffic?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Alex.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> we would like to use these ACL&#8217;s but for right now I have these rules
</I>&gt;&gt;&gt;<i> commented out.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Here's a few other rules we have that have the same issue:
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> # executable blocking
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> # reference this list for extensions to block
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> acl exec_files url_regex -i &quot;/etc/squid/exec_files&quot;
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> # ignore these usernames from being blocked
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> #acl exec_users proxy_auth_regex -i &quot;/etc/squid/exec_users&quot;
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> # combine the rules
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> #http_access deny !bad_exception_urls !exec_users exec_files
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> #deny_info ERR_BLOCK_TYPE exec_files
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>    From what you can see above, we have &#8220;acl exec_files url_regex -i
</I>&gt;&gt;&gt;<i> /etc/squid/exec_files&quot; uncommented, but it&#8217;s not active because the
</I>&gt;&gt;&gt;<i> &#8220;http_access directive&#8221; had to be commented out because it includes
</I>&gt;&gt;&gt;<i> the other statements that include &#8220;proxy_auth_regex &#8211;i&#8221; which block
</I>&gt;&gt;&gt;<i> all internet access as well.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;&gt;<i> squid-users mailing list
</I>&gt;&gt;&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;&gt;&gt;<i> <A HREF="https://lis/">https://lis/</A>
</I>&gt;&gt;&gt;<i> t%2F&amp;data=05%7C02%7CJosh.Piana%40hexcel.com%7C29bbc9983f2742ff81e108d
</I>&gt;&gt;&gt;<i> cf46cd820%7C4248050df19546d5ac9c0c7c52b04cae%7C0%7C0%7C63865399556062
</I>&gt;&gt;&gt;<i> 0056%7CUnknown%7CTWFpbGZsb3d8eyJWIjoiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJB
</I>&gt;&gt;&gt;<i> TiI6Ik1haWwiLCJXVCI6Mn0%3D%7C60000%7C%7C%7C&amp;sdata=PCQLdRbIhLqZa1TDHvK
</I>&gt;&gt;&gt;<i> 3tJ4%2Ft7KciRwqiLysnAUxzcE%3D&amp;reserved=0
</I>&gt;&gt;&gt;<i> s.squid-cache.org%2Flistinfo%2Fsquid-users&amp;data=05%7C02%7CJosh.Piana%
</I>&gt;&gt;&gt;<i> 4
</I>&gt;&gt;&gt;<i> 0hexcel.com%7C7fb1087ae57b47c397a408dcf4684eaf%7C4248050df19546d5ac9c
</I>&gt;&gt;&gt;<i> 0
</I>&gt;&gt;&gt;<i> c7c52b04cae%7C0%7C0%7C638653976041876515%7CUnknown%7CTWFpbGZsb3d8eyJW
</I>&gt;&gt;&gt;<i> I
</I>&gt;&gt;&gt;<i> joiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C0%7C%
</I>&gt;&gt;&gt;<i> 7
</I>&gt;&gt;&gt;<i> C%7C&amp;sdata=D6d%2BXvUp%2FHTvsqC5oneWw%2FdYNWYkmsQUz0lKHLzRk0o%3D&amp;reser
</I>&gt;&gt;&gt;<i> v
</I>&gt;&gt;&gt;<i> ed=0
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;<i> squid-users mailing list
</I>&gt;&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;&gt;<i> <A HREF="https://list/">https://list/</A>
</I>&gt;&gt;<i> s.squid-cache.org%2Flistinfo%2Fsquid-users&amp;data=05%7C02%7CJosh.Piana%4
</I>&gt;&gt;<i> 0hexcel.com%7C29bbc9983f2742ff81e108dcf46cd820%7C4248050df19546d5ac9c0
</I>&gt;&gt;<i> c7c52b04cae%7C0%7C0%7C638653995560776281%7CUnknown%7CTWFpbGZsb3d8eyJWI
</I>&gt;&gt;<i> joiMC4wLjAwMDAiLCJQIjoiV2luMzIiLCJBTiI6Ik1haWwiLCJXVCI6Mn0%3D%7C60000%
</I>&gt;&gt;<i> 7C%7C%7C&amp;sdata=oAOv7ObjGY%2FIMJOAC0LdMf0eJ1wzpn6P0Q5tCNOvSTY%3D&amp;reserv
</I>&gt;&gt;<i> ed=0
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">https://lists.squid-cache.org/listinfo/squid-users</A>
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="027234.html">[squid-users] proxy_auth_regex
</A></li>
	<LI>Next message (by thread): <A HREF="027225.html">[squid-users] Square Bracket in LogFormat
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27235">[ date ]</a>
              <a href="thread.html#27235">[ thread ]</a>
              <a href="subject.html#27235">[ subject ]</a>
              <a href="author.html#27235">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
