<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Questions about Squid configuration
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Questions%20about%20Squid%20configuration&In-Reply-To=%3CCAK0%2B96dnXhvu6LyCrULcWfO0uxAiDDKaMm3Kj6a2BkS69yR5Hw%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="027120.html">
   <LINK REL="Next"  HREF="027108.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Questions about Squid configuration</H1>
    <B>&#12395;&#12400;</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Questions%20about%20Squid%20configuration&In-Reply-To=%3CCAK0%2B96dnXhvu6LyCrULcWfO0uxAiDDKaMm3Kj6a2BkS69yR5Hw%40mail.gmail.com%3E"
       TITLE="[squid-users] Questions about Squid configuration">taku0919.taku at gmail.com
       </A><BR>
    <I>Thu Sep  5 08:58:41 UTC 2024</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="027120.html">[squid-users] squid5.5 restart failure due to domain list duplication
</A></li>
        <LI>Next message (by thread): <A HREF="027108.html">[squid-users] Questions about Squid configuration
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27107">[ date ]</a>
              <a href="thread.html#27107">[ thread ]</a>
              <a href="subject.html#27107">[ subject ]</a>
              <a href="author.html#27107">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi Alex

Thanks for the reply !

I took the advice I received, reviewed the verification details, and
verified again with the two recommended steps.
The new verification includes the following four patterns:
1. successful communication of a valid request to an allowed site
[command]
curl <A HREF="https://pypi.org/">https://pypi.org/</A> -v --cacert squid.crt -k

2. communication of invalid requests to allowed sites is denied
[command] &#8251;Invalid header host
curl <A HREF="https://pypi.org/">https://pypi.org/</A> -H &quot;Host: www.yahoo.co.jp&quot; -v --cacert squid.crt -k

3. communication of valid requests to prohibited sites is denied
[command]
curl <A HREF="https://www.yahoo.co.jp/">https://www.yahoo.co.jp/</A> -v --cacert squid.crt -k

4. communication of invalid requests to prohibited sites is denied
[command]
curl <A HREF="https://www.yahoo.co.jp/">https://www.yahoo.co.jp/</A> -H &quot;Host:&quot; -v --cacert squid.crt -k


STEP&#65297;
&#65310;1. Remove all of your current http_access rules. Keep ACLs. Perform
&#65310;host_verify_strict and access tests to confirm that all valid requests
&#65310;are denied and all invalid requests are rejected. If necessary, ask
&#65310;questions, file bug reports, patch Squid, and/or adjust your
&#65310;configuration to pass this test.

&#12539;Results for validation patterns
&#65297;&#65294;403 Forbidden&#12289;X-Squid-Error: ERR_ACCESS_DENIED 0
&#65298;&#65294;403 Forbidden&#12289;X-Squid-Error: ERR_ACCESS_DENIED 0
&#65299;&#65294;403 Forbidden&#12289;X-Squid-Error: ERR_ACCESS_DENIED 0
&#65300;&#65294;403 Forbidden&#12289;X-Squid-Error: ERR_ACCESS_DENIED 0

STEP&#65298;
&#65310;2. Copy http_access rules, with comments, from generated
&#65310;squid.conf.default. Insert your own access rules in the location marked
&#65310;by &quot;INSERT YOUR OWN RULE(S) HERE&quot; comment. Perform host_verify_strict
&#65310;and access tests to confirm that all valid requests to banned sites are
&#65310;denied, all other valid requests are allowed, and all invalid requests
&#65310;are rejected. If necessary, ask questions, file bug reports, patch
&#65310;Squid, and/or adjust your configuration to pass this test.

&#12539;Results for validation patterns
&#65297;&#65294;200 OK
&#65298;&#65294;409 Conflict&#12289;X-Squid-Error: ERR_CONFLICT_HOST 0
&#65299;&#65294;409 Conflict&#12289;X-Squid-Error: ERR_CONFLICT_HOST 0
&#65300;&#65294;200 OK

So my question is, in STEP 1.
&#12539;I expected to get a different response for a valid request than for
an invalid request, is this result correct?
In STEP 2.
&#12539;4. still returns 200 OK. Is this due to an error in the existing
configuration? Or do I need to add a new setting?

I am not a good English, so I may not have understood Alex's advice exactly.
If there are still mistakes, please point them out to me.

Thank you in advance.

2024&#24180;8&#26376;30&#26085;(&#37329;) 22:27 Alex Rousskov &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt;:
&gt;<i>
</I>&gt;<i> On 2024-08-29 22:28, &#12395;&#12400; wrote:
</I>&gt;<i>
</I>&gt;<i> &gt; With the newly reviewed configuration in the attachment
</I>&gt;<i>
</I>&gt;<i> OT: Please note that your configuration does not follow the recommended
</I>&gt;<i> http_access rules order template in squid.conf.default and might,
</I>&gt;<i> depending on your deployment environment, allow Squid to be used for
</I>&gt;<i> attacks on 3rd party resources (e.g., ssh services). This observation is
</I>&gt;<i> not related to your primary question and your &quot;ban certain sites&quot; goal.
</I>&gt;<i> Following suggestions at the end of this email should fix this problem.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; I found the following statement in the following official document
</I>&gt;<i> &gt; <A HREF="https://www.squid-cache.org/Doc/config/host_verify_strict/">https://www.squid-cache.org/Doc/config/host_verify_strict/</A>
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; &#65310; * The host names (domain or IP) must be identical,
</I>&gt;<i> &gt; &#65310; but valueless or missing Host header disables all checks.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; So I ran an additional validation with an empty Host value, and the
</I>&gt;<i> &gt; request succeeded for a domain that was not in the whitelist.
</I>&gt;<i> &gt; The curl command for verification is below, and as before, only
</I>&gt;<i> &gt; .pypi.org is allowed in the whitelist.
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; date;curl <A HREF="https://www.yahoo.co.jp/">https://www.yahoo.co.jp/</A> -H &quot;Host:&quot; -v --cacert squid.crt -k
</I>&gt;<i> &gt;
</I>&gt;<i> &gt; Is it possible for Squid to prevent such requests as well?
</I>&gt;<i>
</I>&gt;<i> Yes, a req_header ACL should be able to detect such requests (i.e.
</I>&gt;<i> requests without a Host header or with an empty Host header value).
</I>&gt;<i> However, I suspect that &quot;missing Host&quot; is _not_ the problem you should
</I>&gt;<i> be solving (as detailed below).
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; I was able to confirm that any one of the SNI, IP, or Host in the
</I>&gt;<i> &gt; request is incorrect (not whitelist allowed)
</I>&gt;<i> &gt; and Squid will correctly check and return a 409 Conflict.
</I>&gt;<i>
</I>&gt;<i> IMHO, you should target/validate a different set of goals/conditions:
</I>&gt;<i>
</I>&gt;<i> * A valid request targeting a banned site should be denied (HTTP 403
</I>&gt;<i> response, %Ss=TCP_DENIED, %err_code=ERR_ACCESS_DENIED). This denial
</I>&gt;<i> should be triggered by an &quot;http_access deny&quot; rule, preferably an
</I>&gt;<i> explicit one. This denial will _not_ happen (and the request will
</I>&gt;<i> instead be forwarded to the banned site it targets) if you replace all
</I>&gt;<i> your http_access rules with a single &quot;http_access allow all&quot; line. This
</I>&gt;<i> denial does not depend on host_verify_strict and underlying code.
</I>&gt;<i>
</I>&gt;<i> * An invalid request should be rejected (HTTP 4xx response). This
</I>&gt;<i> includes, but is not limited to, host_verify_strict-driven rejections.
</I>&gt;<i> This rejection should happen even if you replace all your http_access
</I>&gt;<i> rules with a single &quot;http_access allow all&quot; line.
</I>&gt;<i>
</I>&gt;<i> AFAICT, your current configuration does not reach &quot;deny valid requests
</I>&gt;<i> targeting banned sites&quot; goal while your question implies that you are
</I>&gt;<i> incorrectly relying on host_verify_strict to perform that denial.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> I recommend the following:
</I>&gt;<i>
</I>&gt;<i> 1. Remove all of your current http_access rules. Keep ACLs. Perform
</I>&gt;<i> host_verify_strict and access tests to confirm that all valid requests
</I>&gt;<i> are denied and all invalid requests are rejected. If necessary, ask
</I>&gt;<i> questions, file bug reports, patch Squid, and/or adjust your
</I>&gt;<i> configuration to pass this test.
</I>&gt;<i>
</I>&gt;<i> 2. Copy http_access rules, with comments, from generated
</I>&gt;<i> squid.conf.default. Insert your own access rules in the location marked
</I>&gt;<i> by &quot;INSERT YOUR OWN RULE(S) HERE&quot; comment. Perform host_verify_strict
</I>&gt;<i> and access tests to confirm that all valid requests to banned sites are
</I>&gt;<i> denied, all other valid requests are allowed, and all invalid requests
</I>&gt;<i> are rejected. If necessary, ask questions, file bug reports, patch
</I>&gt;<i> Squid, and/or adjust your configuration to pass this test.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> HTH,
</I>&gt;<i>
</I>&gt;<i> Alex.
</I>&gt;<i>
</I>&gt;<i>
</I>&gt;<i> &gt; 2024&#24180;8&#26376;8&#26085;(&#26408;) 21:33 Alex Rousskov &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt;:
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; On 2024-08-06 20:59, &#12395;&#12400; wrote:
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt;&gt; When using Squid transparently, is it possible to control the
</I>&gt;<i> &gt;&gt;&gt; whitelist of the domain to connect to and inspect the Host field in
</I>&gt;<i> &gt;&gt;&gt; the request header together?
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; Short answer: Yes.
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt;&gt; According to the verification results, the Host field can be inspected
</I>&gt;<i> &gt;&gt;&gt; by &quot;host_verify_strict on&quot; in squid-transparent.conf, but it seems
</I>&gt;<i> &gt;&gt;&gt; that the whitelist is not controlled.
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; AFAICT, the configuration you have shared allows all banned[1] traffic
</I>&gt;<i> &gt;&gt; to/through https_port. For the problematic test case #5:
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; All these http_access rules do _not_ match:
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt;&gt; http_access allow localnet whitelist
</I>&gt;<i> &gt;&gt;&gt; http_access deny localnet whitelist_https !https_port
</I>&gt;<i> &gt;&gt;&gt; http_access deny localnet whitelist_transparent_https !https_port
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; And then this next rule matches and allows traffic through:
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt;&gt; http_access allow https_port
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; This last http_access rule is not reached:
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt;&gt; http_access deny all
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; N.B. The above analysis assumes that your https_port ACL is explicitly
</I>&gt;<i> &gt;&gt; defined in your squid.conf to match all traffic received at https_port.
</I>&gt;<i> &gt;&gt; If you do not have such an ACL defined, then you need to fix that
</I>&gt;<i> &gt;&gt; problem as well. I recommend naming ACLs differently from directive
</I>&gt;<i> &gt;&gt; names (e.g., &quot;toHttpsPort&quot; rather than &quot;https_port&quot;).
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; Please note that Squid v4 is not supported by the Squid Project and is
</I>&gt;<i> &gt;&gt; very buggy. I recommend using Squid v6 or later.
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; HTH,
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; Alex.
</I>&gt;<i> &gt;&gt; [1] Here, &quot;banned&quot; means &quot;_not_ matching whitelist ACL&quot;.
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt;&gt; &#9632;Configuration Details
</I>&gt;<i> &gt;&gt;&gt; &#12295;squid-transparent.conf&#65288;Excerpts&#65289;
</I>&gt;<i> &gt;&gt;&gt; #Whitelist
</I>&gt;<i> &gt;&gt;&gt; acl whitelist dstdomain &quot;/etc/squid/whitelist&quot;
</I>&gt;<i> &gt;&gt;&gt; acl whitelist dstdomain &quot;/etc/squid/whitelist_transparent&quot;
</I>&gt;<i> &gt;&gt;&gt; acl whitelist_https dstdomain &quot;/etc/squid/whitelist_https&quot;
</I>&gt;<i> &gt;&gt;&gt; acl whitelist_transparent_https dstdomain
</I>&gt;<i> &gt;&gt;&gt; &quot;/etc/squid/whitelist_transparent_https&quot;
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt; proxy_protocol_access allow localnet
</I>&gt;<i> &gt;&gt;&gt; proxy_protocol_access deny all
</I>&gt;<i> &gt;&gt;&gt; http_access allow localnet whitelist
</I>&gt;<i> &gt;&gt;&gt; http_access deny localnet whitelist_https !https_port
</I>&gt;<i> &gt;&gt;&gt; http_access deny localnet whitelist_transparent_https !https_port
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt; # Handling HTTP requests
</I>&gt;<i> &gt;&gt;&gt; http_port 3129 intercept
</I>&gt;<i> &gt;&gt;&gt; # Handling HTTPS requests
</I>&gt;<i> &gt;&gt;&gt; https_port 3130 intercept tcpkeepalive=60,30,3 ssl-bump
</I>&gt;<i> &gt;&gt;&gt; generate-host-certificates=on dynamic_cert_mem_cache_size=20MB
</I>&gt;<i> &gt;&gt;&gt; tls-cert=/etc/squid/ssl/squid.crt tls-key=/etc/squid/ssl/squid.key
</I>&gt;<i> &gt;&gt;&gt; cipher=HIGH:MEDIUM:!LOW:!RC4:!SEED:!IDEA:!3DES:!MD5:!EXP:!PSK:!DSS
</I>&gt;<i> &gt;&gt;&gt; options=NO_TLSv1,NO_SSLv3,SINGLE_DH_USE,SINGLE_ECDH_USE
</I>&gt;<i> &gt;&gt;&gt; tls-dh=prime256v1:/etc/squid/ssl/bump_dhparam.pem
</I>&gt;<i> &gt;&gt;&gt; # Start up for squid process
</I>&gt;<i> &gt;&gt;&gt; http_port 3131
</I>&gt;<i> &gt;&gt;&gt; http_access allow https_port
</I>&gt;<i> &gt;&gt;&gt; acl allowed_https_sites ssl::server_name &quot;/etc/squid/whitelist&quot;
</I>&gt;<i> &gt;&gt;&gt; acl allowed_https_sites ssl::server_name &quot;/etc/squid/whitelist_transparent&quot;
</I>&gt;<i> &gt;&gt;&gt; acl allowed_https_sites ssl::server_name &quot;/etc/squid/whitelist_https&quot;
</I>&gt;<i> &gt;&gt;&gt; acl allowed_https_sites ssl::server_name
</I>&gt;<i> &gt;&gt;&gt; &quot;/etc/squid/whitelist_transparent_https&quot;
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt; http_access deny all
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt; # strict setting
</I>&gt;<i> &gt;&gt;&gt; host_verify_strict on
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt; # SSL_BUMP
</I>&gt;<i> &gt;&gt;&gt; sslcrtd_program /usr/lib64/squid/security_file_certgen -s
</I>&gt;<i> &gt;&gt;&gt; /var/lib/squid/ssl_db -M 20MB
</I>&gt;<i> &gt;&gt;&gt; acl step1 at_step SslBump1
</I>&gt;<i> &gt;&gt;&gt; acl step2 at_step SslBump2
</I>&gt;<i> &gt;&gt;&gt; acl step3 at_step SslBump3
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt; ssl_bump bump all
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt;&gt; &#9632;Verification of Settings
</I>&gt;<i> &gt;&gt;&gt; I ran the curl command from each of the client environments that use Squid.
</I>&gt;<i> &gt;&gt;&gt; 1. if SNI, Destination IP, and HeaderHost are correct, the user should
</I>&gt;<i> &gt;&gt;&gt; be able to connect to pypi.org
</I>&gt;<i> &gt;&gt;&gt; Command:
</I>&gt;<i> &gt;&gt;&gt; date;curl <A HREF="https://pypi.org/">https://pypi.org/</A> -v --cacert squid_2.crt -k
</I>&gt;<i> &gt;&gt;&gt; Result: OK
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt; 2. rejection of communication to pypi.org if SNI is correct but
</I>&gt;<i> &gt;&gt;&gt; destination IP and HeaderHost are incorrect
</I>&gt;<i> &gt;&gt;&gt; Command:
</I>&gt;<i> &gt;&gt;&gt; date;curl <A HREF="https://pypi.org/">https://pypi.org/</A> --resolve pypi.org:443:182.22.24.252 -H
</I>&gt;<i> &gt;&gt;&gt; &quot;Host: www.yahoo.co.jp&quot;  -v --cacert squid_2.crt -k
</I>&gt;<i> &gt;&gt;&gt; Result: OK (409 Conflict is returned)
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt; 3. rejection of communication to pypi.org if SNI and destination IP
</I>&gt;<i> &gt;&gt;&gt; are correct and HeaderHost is incorrect
</I>&gt;<i> &gt;&gt;&gt; Command:
</I>&gt;<i> &gt;&gt;&gt; date;curl <A HREF="https://pypi.org/">https://pypi.org/</A> -H &quot;Host: www.yahoo.co.jp&quot; -v --cacert
</I>&gt;<i> &gt;&gt;&gt; squid_2.crt -k
</I>&gt;<i> &gt;&gt;&gt; Result: OK (409 Confilic returned)
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt; 4. rejection of communication to pypi.org if SNI and HeaderHost are
</I>&gt;<i> &gt;&gt;&gt; correct but destination IP is incorrect
</I>&gt;<i> &gt;&gt;&gt; Command:
</I>&gt;<i> &gt;&gt;&gt; date;curl <A HREF="https://pypi.org/">https://pypi.org/</A> --resolve pypi.org:443:182.22.24.252 -v
</I>&gt;<i> &gt;&gt;&gt; --cacert squid_2.crt -k
</I>&gt;<i> &gt;&gt;&gt; Result: OK (409 Confilic returned)
</I>&gt;<i> &gt;&gt;&gt;
</I>&gt;<i> &gt;&gt;&gt; 5. if SNI, destination IP, and HeaderHost are all invalid (yahoo.co.jp
</I>&gt;<i> &gt;&gt;&gt; not registered in whitelist), communication will be rejected
</I>&gt;<i> &gt;&gt;&gt; Command:
</I>&gt;<i> &gt;&gt;&gt; date;curl <A HREF="https://yahoo.co.jp/">https://yahoo.co.jp/</A> -v --cacert squid_2.crt -k
</I>&gt;<i> &gt;&gt;&gt; Result: NG (301 Moved Permanently is returned, but it appears that the
</I>&gt;<i> &gt;&gt;&gt; communication is reaching yahoo.co.jp)
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt;
</I>&gt;<i> &gt;&gt; _______________________________________________
</I>&gt;<i> &gt;&gt; squid-users mailing list
</I>&gt;<i> &gt;&gt; <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> &gt;&gt; <A HREF="https://lists.squid-cache.org/listinfo/squid-users">https://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i>
</I>
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="027120.html">[squid-users] squid5.5 restart failure due to domain list duplication
</A></li>
	<LI>Next message (by thread): <A HREF="027108.html">[squid-users] Questions about Squid configuration
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27107">[ date ]</a>
              <a href="thread.html#27107">[ thread ]</a>
              <a href="subject.html#27107">[ subject ]</a>
              <a href="author.html#27107">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
