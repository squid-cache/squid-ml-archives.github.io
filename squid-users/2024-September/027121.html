<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Questions about Squid configuration
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Questions%20about%20Squid%20configuration&In-Reply-To=%3C0be99458-53b3-4f37-a86f-48f20c1abe9d%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="027108.html">
   <LINK REL="Next"  HREF="027152.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Questions about Squid configuration</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Questions%20about%20Squid%20configuration&In-Reply-To=%3C0be99458-53b3-4f37-a86f-48f20c1abe9d%40measurement-factory.com%3E"
       TITLE="[squid-users] Questions about Squid configuration">rousskov at measurement-factory.com
       </A><BR>
    <I>Tue Sep 10 15:13:06 UTC 2024</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="027108.html">[squid-users] Questions about Squid configuration
</A></li>
        <LI>Next message (by thread): <A HREF="027152.html">[squid-users] Questions about Squid configuration
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27121">[ date ]</a>
              <a href="thread.html#27121">[ thread ]</a>
              <a href="subject.html#27121">[ subject ]</a>
              <a href="author.html#27121">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 2024-09-05 04:58, &#12395;&#12400; wrote:

&gt;<i> I took the advice I received, reviewed the verification details, and
</I>&gt;<i> verified again with the two recommended steps.
</I>&gt;<i> The new verification includes the following four patterns:
</I>&gt;<i> 1. successful communication of a valid request to an allowed site
</I>&gt;<i> [command]
</I>&gt;<i> curl <A HREF="https://pypi.org/">https://pypi.org/</A> -v --cacert squid.crt -k
</I>&gt;<i> 
</I>&gt;<i> 2. communication of invalid requests to allowed sites is denied
</I>&gt;<i> [command] &#8251;Invalid header host
</I>&gt;<i> curl <A HREF="https://pypi.org/">https://pypi.org/</A> -H &quot;Host: www.yahoo.co.jp&quot; -v --cacert squid.crt -k
</I>&gt;<i> 
</I>&gt;<i> 3. communication of valid requests to prohibited sites is denied
</I>&gt;<i> [command]
</I>&gt;<i> curl <A HREF="https://www.yahoo.co.jp/">https://www.yahoo.co.jp/</A> -v --cacert squid.crt -k
</I>&gt;<i> 
</I>&gt;<i> 4. communication of invalid requests to prohibited sites is denied
</I>&gt;<i> [command]
</I>&gt;<i> curl <A HREF="https://www.yahoo.co.jp/">https://www.yahoo.co.jp/</A> -H &quot;Host:&quot; -v --cacert squid.crt -k
</I>

Thank you for following my recommendations, documenting your tests, and 
sharing configurations!

Do you run these &quot;curl&quot; commands on the same box that runs Squid?


&gt;<i> STEP&#65297;
</I>&gt;<i> &#65310;1. Remove all of your current http_access rules. Keep ACLs. Perform
</I>&gt;<i> &#65310;host_verify_strict and access tests to confirm that all valid requests
</I>&gt;<i> &#65310;are denied and all invalid requests are rejected. If necessary, ask
</I>&gt;<i> &#65310;questions, file bug reports, patch Squid, and/or adjust your
</I>&gt;<i> &#65310;configuration to pass this test.
</I>&gt;<i> 
</I>&gt;<i> &#12539;Results for validation patterns
</I>&gt;<i> &#65297;&#65294;403 Forbidden&#12289;X-Squid-Error: ERR_ACCESS_DENIED 0
</I>&gt;<i> &#65298;&#65294;403 Forbidden&#12289;X-Squid-Error: ERR_ACCESS_DENIED 0
</I>&gt;<i> &#65299;&#65294;403 Forbidden&#12289;X-Squid-Error: ERR_ACCESS_DENIED 0
</I>&gt;<i> &#65300;&#65294;403 Forbidden&#12289;X-Squid-Error: ERR_ACCESS_DENIED 0
</I>
&gt;<i> I expected to get a different response for a valid request than for 
</I>&gt;<i> an invalid request, is this result correct?
</I>
AFAICT, the above results are correct.

Your expectations are reasonable, but you are thinking in terms of plain 
HTTP while your Squid is configured to bump intercepted HTTPS 
connections. In your &quot;STEP 1&quot; configuration, Squid does not see the HTTP 
request at all! Squid generates a fake CONNECT request using 
TCP/IP-level information from the intercepted TCP connection (and denies 
that generated request because there are no http_access rules to allow it).

When I was formulating my expectations, I was thinking in terms of HTTP 
requests as well. That is why I expected invalid requests to be rejected 
(by host_verify_strict) rather than denied (by http_access). 
Interception with SslBump makes everything more complex by adding 
another layer of fake CONNECT requests...

Let's consider this step 1 validation successfully completed.


&gt;<i> STEP&#65298;
</I>&gt;<i> &#65310;2. Copy http_access rules, with comments, from generated
</I>&gt;<i> &#65310;squid.conf.default. Insert your own access rules in the location marked
</I>&gt;<i> &#65310;by &quot;INSERT YOUR OWN RULE(S) HERE&quot; comment. Perform host_verify_strict
</I>&gt;<i> &#65310;and access tests to confirm that all valid requests to banned sites are
</I>&gt;<i> &#65310;denied, all other valid requests are allowed, and all invalid requests
</I>&gt;<i> &#65310;are rejected. If necessary, ask questions, file bug reports, patch
</I>&gt;<i> &#65310;Squid, and/or adjust your configuration to pass this test.
</I>&gt;<i> 
</I>&gt;<i> &#12539;Results for validation patterns
</I>&gt;<i> &#65297;&#65294;200 OK
</I>&gt;<i> &#65298;&#65294;409 Conflict&#12289;X-Squid-Error: ERR_CONFLICT_HOST 0
</I>&gt;<i> &#65299;&#65294;409 Conflict&#12289;X-Squid-Error: ERR_CONFLICT_HOST 0
</I>&gt;<i> &#65300;&#65294;200 OK
</I>

&gt;<i> &#12539;4. still returns 200 OK. Is this due to an error in the existing
</I>&gt;<i> configuration? Or do I need to add a new setting?
</I>
I believe Test 4 does not result in ERR_CONFLICT_HOST because Squid does 
not consider empty Host headers invalid from host header validation 
point of view: As we discussed earlier, &quot;valueless or missing Host 
header disables all checks&quot;.

If you do consider requests with valueless or missing Host header 
invalid, then you need to add a custom &quot;http_access deny&quot; rule that 
would ban them. Look for &quot;req_header&quot; discussion in my earlier answer 
for (untested) hints about detecting requests with a valueless Host header.

However, you may want to double check whether rejecting requests with an 
empty Host header is actually necessary in your environment. Perhaps 
they can be considered valid (which is what Squid does by default)?


My primary concern here is that test 4 request was not blocked by an 
&quot;http_access deny&quot; rule. I suspect that happens because the following 
allow rule matched:

     acl https_port port 443
     http_access allow https_port

I recommend deleting the above http_access rule. AFAICT, you only want 
to allow valid requests targeting specific/allowed sites. You already 
have other rules for that. The above &quot;all HTTPS&quot; rule is too broad and 
is seemingly unnecessary.

I also recommend deleting a similar rule that allows all port-80 
requests, for similar reasons:

     acl http_port port 80
     http_access allow http_port


If you think you do need those two broad rules, please clarify what you 
think you need them for. In other words, what tests would break if you 
remove them?


HTH,

Alex.




&gt;<i> 2024&#24180;8&#26376;30&#26085;(&#37329;) 22:27 Alex Rousskov &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt;:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> On 2024-08-29 22:28, &#12395;&#12400; wrote:
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> With the newly reviewed configuration in the attachment
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> OT: Please note that your configuration does not follow the recommended
</I>&gt;&gt;<i> http_access rules order template in squid.conf.default and might,
</I>&gt;&gt;<i> depending on your deployment environment, allow Squid to be used for
</I>&gt;&gt;<i> attacks on 3rd party resources (e.g., ssh services). This observation is
</I>&gt;&gt;<i> not related to your primary question and your &quot;ban certain sites&quot; goal.
</I>&gt;&gt;<i> Following suggestions at the end of this email should fix this problem.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> I found the following statement in the following official document
</I>&gt;&gt;&gt;<i> <A HREF="https://www.squid-cache.org/Doc/config/host_verify_strict/">https://www.squid-cache.org/Doc/config/host_verify_strict/</A>
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> &#65310; * The host names (domain or IP) must be identical,
</I>&gt;&gt;&gt;<i> &#65310; but valueless or missing Host header disables all checks.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> So I ran an additional validation with an empty Host value, and the
</I>&gt;&gt;&gt;<i> request succeeded for a domain that was not in the whitelist.
</I>&gt;&gt;&gt;<i> The curl command for verification is below, and as before, only
</I>&gt;&gt;&gt;<i> .pypi.org is allowed in the whitelist.
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> date;curl <A HREF="https://www.yahoo.co.jp/">https://www.yahoo.co.jp/</A> -H &quot;Host:&quot; -v --cacert squid.crt -k
</I>&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> Is it possible for Squid to prevent such requests as well?
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Yes, a req_header ACL should be able to detect such requests (i.e.
</I>&gt;&gt;<i> requests without a Host header or with an empty Host header value).
</I>&gt;&gt;<i> However, I suspect that &quot;missing Host&quot; is _not_ the problem you should
</I>&gt;&gt;<i> be solving (as detailed below).
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> I was able to confirm that any one of the SNI, IP, or Host in the
</I>&gt;&gt;&gt;<i> request is incorrect (not whitelist allowed)
</I>&gt;&gt;&gt;<i> and Squid will correctly check and return a 409 Conflict.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> IMHO, you should target/validate a different set of goals/conditions:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> * A valid request targeting a banned site should be denied (HTTP 403
</I>&gt;&gt;<i> response, %Ss=TCP_DENIED, %err_code=ERR_ACCESS_DENIED). This denial
</I>&gt;&gt;<i> should be triggered by an &quot;http_access deny&quot; rule, preferably an
</I>&gt;&gt;<i> explicit one. This denial will _not_ happen (and the request will
</I>&gt;&gt;<i> instead be forwarded to the banned site it targets) if you replace all
</I>&gt;&gt;<i> your http_access rules with a single &quot;http_access allow all&quot; line. This
</I>&gt;&gt;<i> denial does not depend on host_verify_strict and underlying code.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> * An invalid request should be rejected (HTTP 4xx response). This
</I>&gt;&gt;<i> includes, but is not limited to, host_verify_strict-driven rejections.
</I>&gt;&gt;<i> This rejection should happen even if you replace all your http_access
</I>&gt;&gt;<i> rules with a single &quot;http_access allow all&quot; line.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> AFAICT, your current configuration does not reach &quot;deny valid requests
</I>&gt;&gt;<i> targeting banned sites&quot; goal while your question implies that you are
</I>&gt;&gt;<i> incorrectly relying on host_verify_strict to perform that denial.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I recommend the following:
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> 1. Remove all of your current http_access rules. Keep ACLs. Perform
</I>&gt;&gt;<i> host_verify_strict and access tests to confirm that all valid requests
</I>&gt;&gt;<i> are denied and all invalid requests are rejected. If necessary, ask
</I>&gt;&gt;<i> questions, file bug reports, patch Squid, and/or adjust your
</I>&gt;&gt;<i> configuration to pass this test.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> 2. Copy http_access rules, with comments, from generated
</I>&gt;&gt;<i> squid.conf.default. Insert your own access rules in the location marked
</I>&gt;&gt;<i> by &quot;INSERT YOUR OWN RULE(S) HERE&quot; comment. Perform host_verify_strict
</I>&gt;&gt;<i> and access tests to confirm that all valid requests to banned sites are
</I>&gt;&gt;<i> denied, all other valid requests are allowed, and all invalid requests
</I>&gt;&gt;<i> are rejected. If necessary, ask questions, file bug reports, patch
</I>&gt;&gt;<i> Squid, and/or adjust your configuration to pass this test.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> HTH,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Alex.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;&gt;<i> 2024&#24180;8&#26376;8&#26085;(&#26408;) 21:33 Alex Rousskov &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt;:
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> On 2024-08-06 20:59, &#12395;&#12400; wrote:
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> When using Squid transparently, is it possible to control the
</I>&gt;&gt;&gt;&gt;&gt;<i> whitelist of the domain to connect to and inspect the Host field in
</I>&gt;&gt;&gt;&gt;&gt;<i> the request header together?
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> Short answer: Yes.
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> According to the verification results, the Host field can be inspected
</I>&gt;&gt;&gt;&gt;&gt;<i> by &quot;host_verify_strict on&quot; in squid-transparent.conf, but it seems
</I>&gt;&gt;&gt;&gt;&gt;<i> that the whitelist is not controlled.
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> AFAICT, the configuration you have shared allows all banned[1] traffic
</I>&gt;&gt;&gt;&gt;<i> to/through https_port. For the problematic test case #5:
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> All these http_access rules do _not_ match:
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> http_access allow localnet whitelist
</I>&gt;&gt;&gt;&gt;&gt;<i> http_access deny localnet whitelist_https !https_port
</I>&gt;&gt;&gt;&gt;&gt;<i> http_access deny localnet whitelist_transparent_https !https_port
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> And then this next rule matches and allows traffic through:
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> http_access allow https_port
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> This last http_access rule is not reached:
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> http_access deny all
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> N.B. The above analysis assumes that your https_port ACL is explicitly
</I>&gt;&gt;&gt;&gt;<i> defined in your squid.conf to match all traffic received at https_port.
</I>&gt;&gt;&gt;&gt;<i> If you do not have such an ACL defined, then you need to fix that
</I>&gt;&gt;&gt;&gt;<i> problem as well. I recommend naming ACLs differently from directive
</I>&gt;&gt;&gt;&gt;<i> names (e.g., &quot;toHttpsPort&quot; rather than &quot;https_port&quot;).
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> Please note that Squid v4 is not supported by the Squid Project and is
</I>&gt;&gt;&gt;&gt;<i> very buggy. I recommend using Squid v6 or later.
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> HTH,
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> Alex.
</I>&gt;&gt;&gt;&gt;<i> [1] Here, &quot;banned&quot; means &quot;_not_ matching whitelist ACL&quot;.
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> &#9632;Configuration Details
</I>&gt;&gt;&gt;&gt;&gt;<i> &#12295;squid-transparent.conf&#65288;Excerpts&#65289;
</I>&gt;&gt;&gt;&gt;&gt;<i> #Whitelist
</I>&gt;&gt;&gt;&gt;&gt;<i> acl whitelist dstdomain &quot;/etc/squid/whitelist&quot;
</I>&gt;&gt;&gt;&gt;&gt;<i> acl whitelist dstdomain &quot;/etc/squid/whitelist_transparent&quot;
</I>&gt;&gt;&gt;&gt;&gt;<i> acl whitelist_https dstdomain &quot;/etc/squid/whitelist_https&quot;
</I>&gt;&gt;&gt;&gt;&gt;<i> acl whitelist_transparent_https dstdomain
</I>&gt;&gt;&gt;&gt;&gt;<i> &quot;/etc/squid/whitelist_transparent_https&quot;
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> proxy_protocol_access allow localnet
</I>&gt;&gt;&gt;&gt;&gt;<i> proxy_protocol_access deny all
</I>&gt;&gt;&gt;&gt;&gt;<i> http_access allow localnet whitelist
</I>&gt;&gt;&gt;&gt;&gt;<i> http_access deny localnet whitelist_https !https_port
</I>&gt;&gt;&gt;&gt;&gt;<i> http_access deny localnet whitelist_transparent_https !https_port
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> # Handling HTTP requests
</I>&gt;&gt;&gt;&gt;&gt;<i> http_port 3129 intercept
</I>&gt;&gt;&gt;&gt;&gt;<i> # Handling HTTPS requests
</I>&gt;&gt;&gt;&gt;&gt;<i> https_port 3130 intercept tcpkeepalive=60,30,3 ssl-bump
</I>&gt;&gt;&gt;&gt;&gt;<i> generate-host-certificates=on dynamic_cert_mem_cache_size=20MB
</I>&gt;&gt;&gt;&gt;&gt;<i> tls-cert=/etc/squid/ssl/squid.crt tls-key=/etc/squid/ssl/squid.key
</I>&gt;&gt;&gt;&gt;&gt;<i> cipher=HIGH:MEDIUM:!LOW:!RC4:!SEED:!IDEA:!3DES:!MD5:!EXP:!PSK:!DSS
</I>&gt;&gt;&gt;&gt;&gt;<i> options=NO_TLSv1,NO_SSLv3,SINGLE_DH_USE,SINGLE_ECDH_USE
</I>&gt;&gt;&gt;&gt;&gt;<i> tls-dh=prime256v1:/etc/squid/ssl/bump_dhparam.pem
</I>&gt;&gt;&gt;&gt;&gt;<i> # Start up for squid process
</I>&gt;&gt;&gt;&gt;&gt;<i> http_port 3131
</I>&gt;&gt;&gt;&gt;&gt;<i> http_access allow https_port
</I>&gt;&gt;&gt;&gt;&gt;<i> acl allowed_https_sites ssl::server_name &quot;/etc/squid/whitelist&quot;
</I>&gt;&gt;&gt;&gt;&gt;<i> acl allowed_https_sites ssl::server_name &quot;/etc/squid/whitelist_transparent&quot;
</I>&gt;&gt;&gt;&gt;&gt;<i> acl allowed_https_sites ssl::server_name &quot;/etc/squid/whitelist_https&quot;
</I>&gt;&gt;&gt;&gt;&gt;<i> acl allowed_https_sites ssl::server_name
</I>&gt;&gt;&gt;&gt;&gt;<i> &quot;/etc/squid/whitelist_transparent_https&quot;
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> http_access deny all
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> # strict setting
</I>&gt;&gt;&gt;&gt;&gt;<i> host_verify_strict on
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> # SSL_BUMP
</I>&gt;&gt;&gt;&gt;&gt;<i> sslcrtd_program /usr/lib64/squid/security_file_certgen -s
</I>&gt;&gt;&gt;&gt;&gt;<i> /var/lib/squid/ssl_db -M 20MB
</I>&gt;&gt;&gt;&gt;&gt;<i> acl step1 at_step SslBump1
</I>&gt;&gt;&gt;&gt;&gt;<i> acl step2 at_step SslBump2
</I>&gt;&gt;&gt;&gt;&gt;<i> acl step3 at_step SslBump3
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> ssl_bump bump all
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> &#9632;Verification of Settings
</I>&gt;&gt;&gt;&gt;&gt;<i> I ran the curl command from each of the client environments that use Squid.
</I>&gt;&gt;&gt;&gt;&gt;<i> 1. if SNI, Destination IP, and HeaderHost are correct, the user should
</I>&gt;&gt;&gt;&gt;&gt;<i> be able to connect to pypi.org
</I>&gt;&gt;&gt;&gt;&gt;<i> Command:
</I>&gt;&gt;&gt;&gt;&gt;<i> date;curl <A HREF="https://pypi.org/">https://pypi.org/</A> -v --cacert squid_2.crt -k
</I>&gt;&gt;&gt;&gt;&gt;<i> Result: OK
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> 2. rejection of communication to pypi.org if SNI is correct but
</I>&gt;&gt;&gt;&gt;&gt;<i> destination IP and HeaderHost are incorrect
</I>&gt;&gt;&gt;&gt;&gt;<i> Command:
</I>&gt;&gt;&gt;&gt;&gt;<i> date;curl <A HREF="https://pypi.org/">https://pypi.org/</A> --resolve pypi.org:443:182.22.24.252 -H
</I>&gt;&gt;&gt;&gt;&gt;<i> &quot;Host: www.yahoo.co.jp&quot;  -v --cacert squid_2.crt -k
</I>&gt;&gt;&gt;&gt;&gt;<i> Result: OK (409 Conflict is returned)
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> 3. rejection of communication to pypi.org if SNI and destination IP
</I>&gt;&gt;&gt;&gt;&gt;<i> are correct and HeaderHost is incorrect
</I>&gt;&gt;&gt;&gt;&gt;<i> Command:
</I>&gt;&gt;&gt;&gt;&gt;<i> date;curl <A HREF="https://pypi.org/">https://pypi.org/</A> -H &quot;Host: www.yahoo.co.jp&quot; -v --cacert
</I>&gt;&gt;&gt;&gt;&gt;<i> squid_2.crt -k
</I>&gt;&gt;&gt;&gt;&gt;<i> Result: OK (409 Confilic returned)
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> 4. rejection of communication to pypi.org if SNI and HeaderHost are
</I>&gt;&gt;&gt;&gt;&gt;<i> correct but destination IP is incorrect
</I>&gt;&gt;&gt;&gt;&gt;<i> Command:
</I>&gt;&gt;&gt;&gt;&gt;<i> date;curl <A HREF="https://pypi.org/">https://pypi.org/</A> --resolve pypi.org:443:182.22.24.252 -v
</I>&gt;&gt;&gt;&gt;&gt;<i> --cacert squid_2.crt -k
</I>&gt;&gt;&gt;&gt;&gt;<i> Result: OK (409 Confilic returned)
</I>&gt;&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;&gt;<i> 5. if SNI, destination IP, and HeaderHost are all invalid (yahoo.co.jp
</I>&gt;&gt;&gt;&gt;&gt;<i> not registered in whitelist), communication will be rejected
</I>&gt;&gt;&gt;&gt;&gt;<i> Command:
</I>&gt;&gt;&gt;&gt;&gt;<i> date;curl <A HREF="https://yahoo.co.jp/">https://yahoo.co.jp/</A> -v --cacert squid_2.crt -k
</I>&gt;&gt;&gt;&gt;&gt;<i> Result: NG (301 Moved Permanently is returned, but it appears that the
</I>&gt;&gt;&gt;&gt;&gt;<i> communication is reaching yahoo.co.jp)
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i>
</I>&gt;&gt;&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;&gt;&gt;<i> squid-users mailing list
</I>&gt;&gt;&gt;&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;&gt;&gt;&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">https://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;&gt;<i>
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="027108.html">[squid-users] Questions about Squid configuration
</A></li>
	<LI>Next message (by thread): <A HREF="027152.html">[squid-users] Questions about Squid configuration
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27121">[ date ]</a>
              <a href="thread.html#27121">[ thread ]</a>
              <a href="subject.html#27121">[ subject ]</a>
              <a href="author.html#27121">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
