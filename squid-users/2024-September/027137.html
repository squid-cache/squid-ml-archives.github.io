<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Looking for a solution to identify &quot;unauthenticated&quot; squid proxy users.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Looking%20for%20a%20solution%20to%20identify%0A%20%22unauthenticated%22%20squid%20proxy%20users.&In-Reply-To=%3C9368190.148686860.1726574832494.JavaMail.root%40zimbra17-e3.priv.proxad.net%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="027095.html">
   <LINK REL="Next"  HREF="027141.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Looking for a solution to identify &quot;unauthenticated&quot; squid proxy users.</H1>
    <B>Xavier Lecluse</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Looking%20for%20a%20solution%20to%20identify%0A%20%22unauthenticated%22%20squid%20proxy%20users.&In-Reply-To=%3C9368190.148686860.1726574832494.JavaMail.root%40zimbra17-e3.priv.proxad.net%3E"
       TITLE="[squid-users] Looking for a solution to identify &quot;unauthenticated&quot; squid proxy users.">zebu14 at free.fr
       </A><BR>
    <I>Tue Sep 17 12:07:12 UTC 2024</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="027095.html">[squid-users] Looking for a solution to identify &quot;unauthenticated&quot; squid proxy users.
</A></li>
        <LI>Next message (by thread): <A HREF="027141.html">[squid-users] Looking for a solution to identify &quot;unauthenticated&quot; squid proxy users.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27137">[ date ]</a>
              <a href="thread.html#27137">[ thread ]</a>
              <a href="subject.html#27137">[ subject ]</a>
              <a href="author.html#27137">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello, with the advice from Alex, we managed to add a custom field to the access.log, using an always matching &quot;annotate_transaction&quot; ACL.

We had to add the ACL on each line of our rulesets and the value inserted was the rule_name.
Then, by adding %{name}note in a custom logformat, we were able to display the rule matching each line in the access.log.


Thank you for your help Alex.

Regards,
Xavier

----- Mail original -----
De: &quot;Alex Rousskov&quot; &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt;
&#192;: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
Envoy&#233;: Lundi 2 Septembre 2024 22:38:44
Objet: Re: [squid-users] Looking for a solution to identify &quot;unauthenticated&quot; squid proxy users.

On 2024-09-02 15:00, Xavier Lecluse wrote:

&gt;<i> I am facing a problem with my actual access.log configuration.
</I>&gt;<i> I use this logformat for the access.log :
</I>&gt;<i> &quot;logformat timereadable %tl %un %Ss %&gt;Hs %&gt;a:%&gt;p %st %rm %ru %mt %&lt;st %Sh %&lt;A %la %lp %2tr&quot;
</I>&gt;<i> 
</I>&gt;<i> It's all good to trace requests when users are authentified, the login is present into &lt;%un&gt;.
</I>&gt;<i> But I have some users which are not authentified (because of incompatiblity with their softwares) and then I don't have any information to differentiate which requests are made by each &quot;user&quot;.
</I>&gt;<i> 
</I>&gt;<i> I tried to add &lt;%et&gt; &lt;%ea&gt; &lt;%ul&gt; &lt;%ue&gt;, without any success (the &lt;%ul&gt; just display the same as &lt;%un&gt; in my case).
</I>&gt;<i> 
</I>&gt;<i> I am searching a way to display a field which would help me to identify the requester.
</I>&gt;<i> For example, I use an ACL a rule file for each &quot;user&quot; in which several ACLs are defined. (squid/current/etc/current/rule/PXI_TESTPXI_P.conf)
</I>&gt;<i> 
</I>&gt;<i> Is there a way to use the &quot;matching rule&quot; file in the access log ?
</I>
Since many squid.conf directives are driven by ACLs, a typical 
transaction often matches dozens of rules, explicit and implicit ones. 
There is no %code that correctly guesses which matching rule should be 
logged.

However, you can define an always-matching annotate_transaction ACL and 
add it to any rule (or multiple rules). Specific or all transaction 
annotations can then be logged (or sent to helpers, etc.) using %note 
logformat code.

Untested example:

     acl markAsSpecial annotate_transaction category=special
     acl markAsBad annotate_transaction category=bad
     ...
     http_access allow goodClients
     http_access allow specialClients markAsSpecial
     http_access deny to_localhost markAsBad
     ...
     logformat timereadable %tl %note{category} %un %Ss ...


* annotate_transaction ACL type is documented at
<A HREF="http://www.squid-cache.org/Doc/config/acl/">http://www.squid-cache.org/Doc/config/acl/</A>

* %note logformat code is documented at
<A HREF="http://www.squid-cache.org/Doc/config/logformat/">http://www.squid-cache.org/Doc/config/logformat/</A>



HTH,

Alex.


&gt;<i> Actually, this is the log from an authenticated user :
</I>&gt;<i> Sep  2 17:08:32 FPVPXI2 squid[312387]: 02/Sep/2024:17:08:32 +0200 test TCP_TUNNEL 200 10.x.x.250:51994 6765 CONNECT www.google.com:443 - 5716 FIRSTUP_PARENT 10.x.x.241 10.x.x.240 3128 326
</I>&gt;<i> 
</I>&gt;<i> And one from an unauthenticated user :
</I>&gt;<i> Sep  2 16:38:47 QFPVPXI2 squid[311234]: 02/Sep/2024:16:38:47 +0200 - TCP_TUNNEL 200 10.x.x.242:22426 6726 CONNECT www.google.com:443 - 5718 FIRSTUP_PARENT 10.x.x.241 10.x.x.240 3128 249
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Regards,
</I>&gt;<i> 
</I>&gt;<i> Xavier
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">https://lists.squid-cache.org/listinfo/squid-users</A>
</I>
_______________________________________________
squid-users mailing list
<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
<A HREF="https://lists.squid-cache.org/listinfo/squid-users">https://lists.squid-cache.org/listinfo/squid-users</A>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="027095.html">[squid-users] Looking for a solution to identify &quot;unauthenticated&quot; squid proxy users.
</A></li>
	<LI>Next message (by thread): <A HREF="027141.html">[squid-users] Looking for a solution to identify &quot;unauthenticated&quot; squid proxy users.
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27137">[ date ]</a>
              <a href="thread.html#27137">[ thread ]</a>
              <a href="subject.html#27137">[ subject ]</a>
              <a href="author.html#27137">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
