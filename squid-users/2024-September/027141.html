<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Looking for a solution to identify &quot;unauthenticated&quot; squid proxy users.
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Looking%20for%20a%20solution%20to%20identify%0A%20%22unauthenticated%22%20squid%20proxy%20users.&In-Reply-To=%3Cc105b2e3-921b-4f58-b4c3-c9d962057dc5%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="027137.html">
   <LINK REL="Next"  HREF="027096.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Looking for a solution to identify &quot;unauthenticated&quot; squid proxy users.</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Looking%20for%20a%20solution%20to%20identify%0A%20%22unauthenticated%22%20squid%20proxy%20users.&In-Reply-To=%3Cc105b2e3-921b-4f58-b4c3-c9d962057dc5%40measurement-factory.com%3E"
       TITLE="[squid-users] Looking for a solution to identify &quot;unauthenticated&quot; squid proxy users.">rousskov at measurement-factory.com
       </A><BR>
    <I>Tue Sep 17 13:14:02 UTC 2024</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="027137.html">[squid-users] Looking for a solution to identify &quot;unauthenticated&quot; squid proxy users.
</A></li>
        <LI>Next message (by thread): <A HREF="027096.html">[squid-users] Squid traffic paths
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27141">[ date ]</a>
              <a href="thread.html#27141">[ thread ]</a>
              <a href="subject.html#27141">[ subject ]</a>
              <a href="author.html#27141">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 2024-09-17 08:07, Xavier Lecluse wrote:
&gt;<i> Hello, with the advice from Alex, we managed to add a custom field to the access.log, using an always matching &quot;annotate_transaction&quot; ACL.
</I>&gt;<i> 
</I>&gt;<i> We had to add the ACL on each line of our rulesets and the value inserted was the rule_name.
</I>&gt;<i> Then, by adding %{name}note in a custom logformat, we were able to display the rule matching each line in the access.log.
</I>
Glad you made it work! Someday, Squid will optionally add an 
&quot;http_access(*) rule matched&quot; annotation to all transactions, so that 
admins do not have to manually annotate all their rules.

(*) Similar breadcrumbs will be collected for other directives as well.

Alex.


&gt;<i> ----- Mail original -----
</I>&gt;<i> De: &quot;Alex Rousskov&quot; &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">rousskov at measurement-factory.com</A>&gt;
</I>&gt;<i> &#192;: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> Envoy&#233;: Lundi 2 Septembre 2024 22:38:44
</I>&gt;<i> Objet: Re: [squid-users] Looking for a solution to identify &quot;unauthenticated&quot; squid proxy users.
</I>&gt;<i> 
</I>&gt;<i> On 2024-09-02 15:00, Xavier Lecluse wrote:
</I>&gt;<i> 
</I>&gt;&gt;<i> I am facing a problem with my actual access.log configuration.
</I>&gt;&gt;<i> I use this logformat for the access.log :
</I>&gt;&gt;<i> &quot;logformat timereadable %tl %un %Ss %&gt;Hs %&gt;a:%&gt;p %st %rm %ru %mt %&lt;st %Sh %&lt;A %la %lp %2tr&quot;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> It's all good to trace requests when users are authentified, the login is present into &lt;%un&gt;.
</I>&gt;&gt;<i> But I have some users which are not authentified (because of incompatiblity with their softwares) and then I don't have any information to differentiate which requests are made by each &quot;user&quot;.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I tried to add &lt;%et&gt; &lt;%ea&gt; &lt;%ul&gt; &lt;%ue&gt;, without any success (the &lt;%ul&gt; just display the same as &lt;%un&gt; in my case).
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> I am searching a way to display a field which would help me to identify the requester.
</I>&gt;&gt;<i> For example, I use an ACL a rule file for each &quot;user&quot; in which several ACLs are defined. (squid/current/etc/current/rule/PXI_TESTPXI_P.conf)
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Is there a way to use the &quot;matching rule&quot; file in the access log ?
</I>&gt;<i> 
</I>&gt;<i> Since many squid.conf directives are driven by ACLs, a typical
</I>&gt;<i> transaction often matches dozens of rules, explicit and implicit ones.
</I>&gt;<i> There is no %code that correctly guesses which matching rule should be
</I>&gt;<i> logged.
</I>&gt;<i> 
</I>&gt;<i> However, you can define an always-matching annotate_transaction ACL and
</I>&gt;<i> add it to any rule (or multiple rules). Specific or all transaction
</I>&gt;<i> annotations can then be logged (or sent to helpers, etc.) using %note
</I>&gt;<i> logformat code.
</I>&gt;<i> 
</I>&gt;<i> Untested example:
</I>&gt;<i> 
</I>&gt;<i>       acl markAsSpecial annotate_transaction category=special
</I>&gt;<i>       acl markAsBad annotate_transaction category=bad
</I>&gt;<i>       ...
</I>&gt;<i>       http_access allow goodClients
</I>&gt;<i>       http_access allow specialClients markAsSpecial
</I>&gt;<i>       http_access deny to_localhost markAsBad
</I>&gt;<i>       ...
</I>&gt;<i>       logformat timereadable %tl %note{category} %un %Ss ...
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> * annotate_transaction ACL type is documented at
</I>&gt;<i> <A HREF="http://www.squid-cache.org/Doc/config/acl/">http://www.squid-cache.org/Doc/config/acl/</A>
</I>&gt;<i> 
</I>&gt;<i> * %note logformat code is documented at
</I>&gt;<i> <A HREF="http://www.squid-cache.org/Doc/config/logformat/">http://www.squid-cache.org/Doc/config/logformat/</A>
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> HTH,
</I>&gt;<i> 
</I>&gt;<i> Alex.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;&gt;<i> Actually, this is the log from an authenticated user :
</I>&gt;&gt;<i> Sep  2 17:08:32 FPVPXI2 squid[312387]: 02/Sep/2024:17:08:32 +0200 test TCP_TUNNEL 200 10.x.x.250:51994 6765 CONNECT www.google.com:443 - 5716 FIRSTUP_PARENT 10.x.x.241 10.x.x.240 3128 326
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> And one from an unauthenticated user :
</I>&gt;&gt;<i> Sep  2 16:38:47 QFPVPXI2 squid[311234]: 02/Sep/2024:16:38:47 +0200 - TCP_TUNNEL 200 10.x.x.242:22426 6726 CONNECT www.google.com:443 - 5718 FIRSTUP_PARENT 10.x.x.241 10.x.x.240 3128 249
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Regards,
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> Xavier
</I>&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;<i> squid-users mailing list
</I>&gt;&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">https://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">https://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">https://lists.squid-cache.org/listinfo/squid-users</A>
</I>

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="027137.html">[squid-users] Looking for a solution to identify &quot;unauthenticated&quot; squid proxy users.
</A></li>
	<LI>Next message (by thread): <A HREF="027096.html">[squid-users] Squid traffic paths
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27141">[ date ]</a>
              <a href="thread.html#27141">[ thread ]</a>
              <a href="subject.html#27141">[ subject ]</a>
              <a href="author.html#27141">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
