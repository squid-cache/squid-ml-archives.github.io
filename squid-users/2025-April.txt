From jonathanlee571 at gmail.com  Tue Apr  1 00:56:03 2025
From: jonathanlee571 at gmail.com (Jonathan Lee)
Date: Tue, 1 Apr 2025 00:56:03 +0000
Subject: [squid-users] ssl_engine
In-Reply-To: <91ad862e-3db9-459b-a0ea-9ad3e53bf516@treenet.co.nz>
References: <0FE45949-AD42-44BC-B334-B9DBEB193D50@gmail.com>
 <91ad862e-3db9-459b-a0ea-9ad3e53bf516@treenet.co.nz>
Message-ID: <DS0PR19MB7270C5E4F71314DAC4463E25A7AC2@DS0PR19MB7270.namprd19.prod.outlook.com>

I got it to work with the Safexcel chip

ssl_engine devcrypto

It has a vast improvement to performance with ssl intercept active and use of certificates. This was like night and day to use my safexcel chip like this.

I am also seeing increments when webpage load with the command

vmstat -i | grep safexcel

THANK YOU Jeffries Amos.

It is no longer noticeable that it is doing ssl interception.
________________________________
From: squid-users <squid-users-bounces at lists.squid-cache.org> on behalf of Amos Jeffries <squid3 at treenet.co.nz>
Sent: Wednesday, March 5, 2025 17:49
To: squid-users at lists.squid-cache.org <squid-users at lists.squid-cache.org>
Subject: Re: [squid-users] ssl_engine

[ answering because nobody else has, I have no direct experience with
that particular setup. ]


On 5/03/25 18:03, Jonathan Lee wrote:
> Hello fellow Squid Users can you please help?
>
> Does anyone know how to set ssl_engine to use devcrypto for use with a
> safexcel accelerator?
>

  ssl_engine devcryptoeng


BUT "ssl_engine" is ...

>
>        Not supported in builds with OpenSSL 3.0 or newer.
>


If your Squid is built for libssl 3.0 or later, you may be able to
configure /etc/ssl/openssl.cnf default provider to be the one you want.
Such that Squid does not have to do anything for it to work.


I expect all the details relating to how devcrypto does its thing to be
configured in /etc/ssl/openssl.cnf.

You may find this discussion from the OpenSSL community helpful:
  <https://github.com/openssl/openssl/issues/10701>

(FTR; the

HTH
Amos
_______________________________________________
squid-users mailing list
squid-users at lists.squid-cache.org
https://lists.squid-cache.org/listinfo/squid-users
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20250401/b6eb1290/attachment.htm>

From dwd at cern.ch  Wed Apr  2 14:45:06 2025
From: dwd at cern.ch (Dave Dykstra)
Date: Wed, 2 Apr 2025 09:45:06 -0500
Subject: [squid-users] cacheNumbObject unreasonably small with rock cache
Message-ID: <Z-1NcpbVJSlFyiYT@cern.ch>

Hi,

We're trying rock cache for the first time, on squid 6.13.  The machine is quite large and heavily used, with 10 workers configured, 140G of shared memory cache, and 500G of rock cache configured.  However, the cacheNumObject SNMP counter is staying quite steadily at around only 570 even as the cache grows.  Currently du shows the rock file taking 40G, and the mgr:storedir statistics show 448k entries.

Does anyone have any ideas about this for us?

squid.conf is attached.

Dave
-------------- next part --------------
workers 10
acl NET_LOCAL src 0.0.0.0/32
acl CMS_FRONTIER dstdom_regex <redacted>
acl MAJOR_CVMFS dstdom_regex <redacted>
acl HOST_MONITOR src 127.0.0.1/32 <redacted>
acl snmppublic snmp_community public
acl localnet src 0.0.0.1-0.255.255.255	# RFC 1122 "this" network (LAN)
acl localnet src 10.0.0.0/8		# RFC 1918 local private network (LAN)
acl localnet src 100.64.0.0/10		# RFC 6598 shared address space (CGN)
acl localnet src 169.254.0.0/16 	# RFC 3927 link-local (directly plugged) machines
acl localnet src 172.16.0.0/12		# RFC 1918 local private network (LAN)
acl localnet src 192.168.0.0/16		# RFC 1918 local private network (LAN)
acl localnet src fc00::/7       	# RFC 4193 local private network range
acl localnet src fe80::/10      	# RFC 4291 link-local (directly plugged) machines
acl SSL_ports port 443
acl Safe_ports port 80		# http
acl Safe_ports port 21		# ftp
acl Safe_ports port 443		# https
acl Safe_ports port 70		# gopher
acl Safe_ports port 210		# wais
acl Safe_ports port 1025-65535	# unregistered ports
acl Safe_ports port 280		# http-mgmt
acl Safe_ports port 488		# gss-http
acl Safe_ports port 591		# filemaker
acl Safe_ports port 777		# multiling http
http_access deny !Safe_ports
http_access deny CONNECT !SSL_ports
http_access allow localhost manager
http_access deny manager
http_access deny to_linklocal
acl URNPROTO proto URN
http_access deny URNPROTO
acl TEST_NODE dstdomain frontier1.cern.ch
http_access allow TEST_NODE
http_access allow CMS_FRONTIER
http_access allow MAJOR_CVMFS
acl TRACE method TRACE
http_access deny TRACE
http_access allow localhost
http_access deny all
http_port 3128
cache_mem 140 GB
maximum_object_size_in_memory 1 GB
memory_cache_shared on
maximum_object_size 1 GB
cache_dir rock /var/cache/squid 500000
logformat awstats %>a %ui %un [%{%d/%b/%Y:%H:%M:%S}tl.%03tu %{%z}tl] "%rm %ru HTTP/%rv" %>Hs %<st %Ss:%Sh %tr "%{X-Frontier-Id}>h %{cvmfs-info}>h" "%{Referer}>h" "%{User-Agent}>h"
access_log daemon:/var/log/squid/access.log awstats
logfile_rotate 30
	logfile_rotate 0
mime_table /etc/squid/mime.conf
pid_filename /run/squid/${service_name}.pid
strip_query_terms off
cache_log /var/log/squid/cache.log
coredump_dir /var/cache/squid
url_rewrite_extras XXX
store_id_extras XXX
acl PragmaNoCache req_header Pragma no-cache
send_hit deny PragmaNoCache
refresh_pattern ^ftp:		1440	20%	10080
refresh_pattern -i (/cgi-bin/|\?) 0	0%	0
refresh_pattern .		0	20%	4320
quick_abort_min 0 KB
quick_abort_max 0 KB
negative_ttl 1 minute
minimum_expiry_time 0
request_header_access If-Modified-Since deny all
collapsed_forwarding on
cache_mgr squid
cache_effective_user dbfrontier
cache_effective_group users
umask 022
if ${process_number} = 1
snmp_port 3401
endif
snmp_access allow snmppublic HOST_MONITOR
snmp_access deny all
icon_directory /usr/share/squid/icons
cache_miss_revalidate off
uri_whitespace deny

From rousskov at measurement-factory.com  Wed Apr  2 15:21:15 2025
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Wed, 2 Apr 2025 11:21:15 -0400
Subject: [squid-users] cacheNumbObject unreasonably small with rock cache
In-Reply-To: <Z-1NcpbVJSlFyiYT@cern.ch>
References: <Z-1NcpbVJSlFyiYT@cern.ch>
Message-ID: <b5995f78-8f29-4872-9567-de111f8a78f4@measurement-factory.com>

On 2025-04-02 10:45, Dave Dykstra wrote:

> We're trying rock cache for the first time, on squid 6.13.  The
> machine is quite large and heavily used, with 10 workers configured,
> 140G of shared memory cache, and 500G of rock cache configured.
> However, the cacheNumObject SNMP counter is staying quite steadily at
> around only 570 even as the cache grows.  Currently du shows the rock
> file taking 40G, and the mgr:storedir statistics show 448k entries.

I assume you are asking about an SNMP measurement that Squid MIB file 
calls cacheNumObjCount (node 1.3.6.1.4.1.3495.1.3.1).

Today, that measurement reports the number of StoreEntry objects 
currently in use. You should see similar stats on the "StoreEntry" line 
in "Internal Data Structures" section of mgr:info cache manager report.

Roughly speaking:

* For UFS-based caches and non-SMP memory caches, that number is often 
(but not always!) close to the number of cached objects because these 
caches create a StoreEntry object for every object stored in the cache. 
That is how these stores index cached content.

* For rock caches and SMP memory caches, that number is usually very 
different from the number of cached objects because these caches do not 
create StoreEntry objects when indexing cached content.

* StoreEntry objects are not limited to caches. Many transactions, 
including many transactions that do not retrieve cache hits and do not 
store cache misses create StoreEntry objects. In related Squid 
terminology, "Store" is not just "cache", but a more general medium for 
passing HTTP responses around.

I have not checked all the necessary details, but I suspect that SNMP 
code needs to be fixed to report the same stats that are currently 
available on "on-disk objects" line in "Internal Data Structures" 
section of mgr:info cache manager report.

I hope that mgr:storedir statistics that you have mentioned also 
reflects the actual disk cache usage, at least for rock caches.


HTH,

Alex.


From dwd at cern.ch  Wed Apr  2 17:05:20 2025
From: dwd at cern.ch (Dave Dykstra)
Date: Wed, 2 Apr 2025 12:05:20 -0500
Subject: [squid-users] cacheNumbObject unreasonably small with rock cache
In-Reply-To: <b5995f78-8f29-4872-9567-de111f8a78f4@measurement-factory.com>
References: <Z-1NcpbVJSlFyiYT@cern.ch>
 <b5995f78-8f29-4872-9567-de111f8a78f4@measurement-factory.com>
Message-ID: <Z-1uUCkszW-vdW0M@cern.ch>

Yes that helps a lot, Alex.  I do see at the end of mgr:info:

Internal Data Structures:
	   576 StoreEntries
	   576 StoreEntries with MemObjects
	557676 Hot Object Cache Items
	584657 on-disk objects

We'll work on a pull request to change that to on-disk objects for rock cache.

Dave

On Wed, Apr 02, 2025 at 11:21:15AM -0400, Alex Rousskov wrote:
> On 2025-04-02 10:45, Dave Dykstra wrote:
> 
> > We're trying rock cache for the first time, on squid 6.13.  The
> > machine is quite large and heavily used, with 10 workers configured,
> > 140G of shared memory cache, and 500G of rock cache configured.
> > However, the cacheNumObject SNMP counter is staying quite steadily at
> > around only 570 even as the cache grows.  Currently du shows the rock
> > file taking 40G, and the mgr:storedir statistics show 448k entries.
> 
> I assume you are asking about an SNMP measurement that Squid MIB file 
> calls cacheNumObjCount (node 1.3.6.1.4.1.3495.1.3.1).
> 
> Today, that measurement reports the number of StoreEntry objects 
> currently in use. You should see similar stats on the "StoreEntry" line 
> in "Internal Data Structures" section of mgr:info cache manager report.
> 
> Roughly speaking:
> 
> * For UFS-based caches and non-SMP memory caches, that number is often 
> (but not always!) close to the number of cached objects because these 
> caches create a StoreEntry object for every object stored in the cache. 
> That is how these stores index cached content.
> 
> * For rock caches and SMP memory caches, that number is usually very 
> different from the number of cached objects because these caches do not 
> create StoreEntry objects when indexing cached content.
> 
> * StoreEntry objects are not limited to caches. Many transactions, 
> including many transactions that do not retrieve cache hits and do not 
> store cache misses create StoreEntry objects. In related Squid 
> terminology, "Store" is not just "cache", but a more general medium for 
> passing HTTP responses around.
> 
> I have not checked all the necessary details, but I suspect that SNMP 
> code needs to be fixed to report the same stats that are currently 
> available on "on-disk objects" line in "Internal Data Structures" 
> section of mgr:info cache manager report.
> 
> I hope that mgr:storedir statistics that you have mentioned also 
> reflects the actual disk cache usage, at least for rock caches.
> 
> 
> HTH,
> 
> Alex.
> 
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> https://lists.squid-cache.org/listinfo/squid-users
> 

From rousskov at measurement-factory.com  Wed Apr  2 17:23:15 2025
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Wed, 2 Apr 2025 13:23:15 -0400
Subject: [squid-users] cacheNumbObject unreasonably small with rock cache
In-Reply-To: <Z-1uUCkszW-vdW0M@cern.ch>
References: <Z-1NcpbVJSlFyiYT@cern.ch>
 <b5995f78-8f29-4872-9567-de111f8a78f4@measurement-factory.com>
 <Z-1uUCkszW-vdW0M@cern.ch>
Message-ID: <2e0326bc-464f-4dcb-bc8c-ff2a62be7beb@measurement-factory.com>

On 2025-04-02 13:05, Dave Dykstra wrote:
> Yes that helps a lot, Alex.  I do see at the end of mgr:info:
> 
> Internal Data Structures:
> 	   576 StoreEntries
> 	   576 StoreEntries with MemObjects
> 	557676 Hot Object Cache Items
> 	584657 on-disk objects
> 
> We'll work on a pull request to change that to on-disk objects for rock cache.

Strike the last three words: As I strongly implied, current SNMP 
cacheNumObjCount stats are wrong for configurations using UFS-based 
caches, configurations using rock caches, and non-caching configurations.


Cheers,

Alex.


> On Wed, Apr 02, 2025 at 11:21:15AM -0400, Alex Rousskov wrote:
>> On 2025-04-02 10:45, Dave Dykstra wrote:
>>
>>> We're trying rock cache for the first time, on squid 6.13.  The
>>> machine is quite large and heavily used, with 10 workers configured,
>>> 140G of shared memory cache, and 500G of rock cache configured.
>>> However, the cacheNumObject SNMP counter is staying quite steadily at
>>> around only 570 even as the cache grows.  Currently du shows the rock
>>> file taking 40G, and the mgr:storedir statistics show 448k entries.
>>
>> I assume you are asking about an SNMP measurement that Squid MIB file
>> calls cacheNumObjCount (node 1.3.6.1.4.1.3495.1.3.1).
>>
>> Today, that measurement reports the number of StoreEntry objects
>> currently in use. You should see similar stats on the "StoreEntry" line
>> in "Internal Data Structures" section of mgr:info cache manager report.
>>
>> Roughly speaking:
>>
>> * For UFS-based caches and non-SMP memory caches, that number is often
>> (but not always!) close to the number of cached objects because these
>> caches create a StoreEntry object for every object stored in the cache.
>> That is how these stores index cached content.
>>
>> * For rock caches and SMP memory caches, that number is usually very
>> different from the number of cached objects because these caches do not
>> create StoreEntry objects when indexing cached content.
>>
>> * StoreEntry objects are not limited to caches. Many transactions,
>> including many transactions that do not retrieve cache hits and do not
>> store cache misses create StoreEntry objects. In related Squid
>> terminology, "Store" is not just "cache", but a more general medium for
>> passing HTTP responses around.
>>
>> I have not checked all the necessary details, but I suspect that SNMP
>> code needs to be fixed to report the same stats that are currently
>> available on "on-disk objects" line in "Internal Data Structures"
>> section of mgr:info cache manager report.
>>
>> I hope that mgr:storedir statistics that you have mentioned also
>> reflects the actual disk cache usage, at least for rock caches.
>>
>>
>> HTH,
>>
>> Alex.
>>
>> _______________________________________________
>> squid-users mailing list
>> squid-users at lists.squid-cache.org
>> https://lists.squid-cache.org/listinfo/squid-users
>>


From reinhard.westerholt at gmail.com  Mon Apr  7 18:42:51 2025
From: reinhard.westerholt at gmail.com (Reinhard Westerholt)
Date: Mon, 7 Apr 2025 20:42:51 +0200
Subject: [squid-users] Error determining LDAP server type: Timed out
Message-ID: <CADCk2kpNAoDXrx1CkPkiYRM5p-VU8hMBz=JLnBeQ2g1S9nGgiA@mail.gmail.com>

Hello everybody,

I have configured Squid to use Kerberos authentication and employed
ext_kerberos_ldap_group_acl to limit HTTP access. This setup works fine in
most cases. However, randomly (and rarely), there seems to be an issue with
the LDAP query, causing the Active Directory groups to fail to resolve,
which subsequently denies user access. When this occurs, the issue persists
for about an hour. I suspect this might be due to caching or TTL.

Here is a relevant part of the configuration:

auth_param negotiate program /usr/lib/squid/negotiate_kerberos_auth -s
HTTP/server.fqdn at domain
auth_param negotiate children 500
auth_param negotiate keep_alive on

external_acl_type INetAccess ttl=3600 children-max=1000 %LOGIN
/usr/lib/squid/ext_kerberos_ldap_group_acl -g "INetAccess" -a -i -l
ldap://server.fqdn:389 -D "DOMAIN"


The debug output from `ext_kerberos_ldap_group_acl` appears as follows when
the error occurs:
support_resolv.cc(445): pid=2574238 :2025/04/07 13:49:52|
kerberos_ldap_group: DEBUG: Host: DOMAIN Port: -1 Priority: -2 Weight: -2
support_ldap.cc(1066): pid=2574238 :2025/04/07 13:49:52|
kerberos_ldap_group: DEBUG: Setting up connection to LDAP server
server.fqdn:389
support_ldap.cc(1079): pid=2574238 :2025/04/07 13:49:52|
kerberos_ldap_group: DEBUG: Bind to LDAP server with SASL/GSSAPI
support_ldap.cc(1097): pid=2574238 :2025/04/07 13:49:55|
kerberos_ldap_group: DEBUG: Successfully initialized connection to LDAP
server server.fqdn:389
support_ldap.cc(314): pid=2574238 :2025/04/07 13:49:55|
kerberos_ldap_group: DEBUG: Search LDAP server with bind path "" and
filter: (objectclass=*)
support_ldap.cc(336): pid=2574238 :2025/04/07 13:50:25|
kerberos_ldap_group: DEBUG: Did not find LDAP entry for subschemasubentry
support_ldap.cc(339): pid=2574238 :2025/04/07 13:50:25|
kerberos_ldap_group: DEBUG: Determined LDAP server not as an Active
Directory server
support_ldap.cc(1213): pid=2574238 :2025/04/07 13:50:25|
kerberos_ldap_group: ERROR: Error determining LDAP server type: Timed out


I manually attempted to retrieve the subschemasubentry using ldapsearch. As
far as I can see, there is no issue, or I could not reproduce the problem
manually via ldapsearch.

Does anyone have any ideas on how to further debug this issue?
Additionally, are there any recommendations regarding the TTL value? If I
reduce the TTL, the duration of the issue might be shorter for individual
users.

Thanks in advance.

Kind regards,
Reinhard Westerholt
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20250407/9fbba259/attachment.htm>

From hpcmtint at gmail.com  Tue Apr  8 12:24:24 2025
From: hpcmtint at gmail.com (Michael Tint)
Date: Tue, 8 Apr 2025 13:24:24 +0100
Subject: [squid-users] Fwd: Issue with proxy-protocol in http_port on Squid
 6.13 via Docker
In-Reply-To: <CAGZi1t5Xov0dX5otYRugD0Pb9d3UpdC8oYsJOUmVz1uvnAdrpw@mail.gmail.com>
References: <mailman.12143.1744114879.1200.squid-users@lists.squid-cache.org>
 <CAGZi1t5Xov0dX5otYRugD0Pb9d3UpdC8oYsJOUmVz1uvnAdrpw@mail.gmail.com>
Message-ID: <CAGZi1t44EyexCdBgjFRbhcM25K1rdwPAcZfVwx9R-vGQoAM8dg@mail.gmail.com>

Hi all,

I'm running into a blocking issue while deploying Squid 6.13 via Docker (in
a Docker Swarm setup) using a Dockerfile based on b4tman/docker-squid
<https://github.com/b4tman/docker-squid>. My goal is to enable the *PROXY
protocol* support via the following config line:

http_port 3128 proxy-protocol

However, on startup I consistently get this error:

2025/04/08 13:14:44| Processing Configuration File:
/etc/squid/my-squid.conf (depth 0)
2025/04/08 13:14:44| FATAL: Unknown http_port option 'proxy-protocol'.
2025/04/08 13:14:44| FATAL: Bungled /etc/squid/my-squid.conf line 1:
http_port 3128 proxy-protocol
2025/04/08 13:14:44| Squid Cache (Version 6.13): Terminated abnormally.

------------------------------
? *What I?ve Done So Far:*

   -

   Using Squid *6.13* (confirmed)
   -

   Verified --enable-proxy-auth, --enable-auth-*, and many other flags in
   my Dockerfile
   -

   Using the Dockerfile provided by b4tman/docker-squid repo
   -

   Running on *Docker Swarm* and mapping config via:

volumes:
  - ./config/squid.conf:/etc/squid/my-squid.conf:ro


   -

   SQUID_CONFIG_FILE is set properly, and the config loads ? until it hits
   that line.

------------------------------
? *What is proxy-protocol supposed to do?*

The proxy-protocol option is designed to allow Squid to accept *original
client IP addresses* from trusted proxies or load balancers (e.g., HAProxy,
AWS ELB, Traefik) via the PROXY protocol
<https://www.haproxy.org/download/2.0/doc/proxy-protocol.txt>.

It lets you do things like:

http_port 3128 proxy-protocol

Instead of seeing the IP of the load balancer, Squid gets the real client
IP passed in the PROXY header ? which is essential for proper logging,
ACLs, or geo-restrictions in reverse-proxy environments.
------------------------------
? *Current Blocker*

Despite enabling many Squid features in the Docker build, this one fails
with Unknown http_port option 'proxy-protocol', which usually means the *binary
wasn't compiled with support* for it.
------------------------------
?? *Questions / Help Needed*

   -

   Is --with-proxy-protocol or equivalent *compile flag* required to enable
   this? (I can't find it in the list of ./configure options for Squid.)
   -

   Has anyone used proxy-protocol successfully with Squid 6.13 in Docker or
   with the b4tman/docker-squid base image?
   -

   Is there a specific patch, module, or feature flag I'm missing?

Thanks in advance ? this feature is critical for deployment in Swarm behind
a reverse proxy, and I?m stuck!

Best regards,


*Michael Tint*
Linux Admin
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20250408/055ce868/attachment.htm>

From rousskov at measurement-factory.com  Tue Apr  8 13:09:16 2025
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Tue, 8 Apr 2025 09:09:16 -0400
Subject: [squid-users] Fwd: Issue with proxy-protocol in http_port on
 Squid 6.13 via Docker
In-Reply-To: <CAGZi1t44EyexCdBgjFRbhcM25K1rdwPAcZfVwx9R-vGQoAM8dg@mail.gmail.com>
References: <mailman.12143.1744114879.1200.squid-users@lists.squid-cache.org>
 <CAGZi1t5Xov0dX5otYRugD0Pb9d3UpdC8oYsJOUmVz1uvnAdrpw@mail.gmail.com>
 <CAGZi1t44EyexCdBgjFRbhcM25K1rdwPAcZfVwx9R-vGQoAM8dg@mail.gmail.com>
Message-ID: <23d8d5b8-fb4f-4988-969a-f75a4e5f08f4@measurement-factory.com>

On 2025-04-08 08:24, Michael Tint wrote:

> I'm running into a blocking issue while deploying Squid 6.13 ... My goal is 
> to enable the PROXY protocol?support via the following config line:
> 
> http_port 3128 proxy-protocol


The correct http_port option name for enabling PROXY protocol support is 
not "proxy-protocol" but "require-proxy-header". See http_port directive 
description in your generated squid.conf.documented or at
https://www.squid-cache.org/Doc/config/http_port/

HTH,

Alex.



> However, on startup I consistently get this error:
> 
> |2025/04/08 13:14:44| Processing Configuration File: 
> /etc/squid/my-squid.conf (depth 0) 2025/04/08 13:14:44| FATAL: Unknown 
> http_port option 'proxy-protocol'. 2025/04/08 13:14:44| FATAL: Bungled 
> /etc/squid/my-squid.conf line 1: http_port 3128 proxy-protocol 
> 2025/04/08 13:14:44| Squid Cache (Version 6.13): Terminated abnormally. |
> 
> ------------------------------------------------------------------------
> 
> 
>       ? *What I?ve Done So Far:*
> 
>   *
> 
>     Using Squid *6.13*?(confirmed)
> 
>   *
> 
>     Verified |--enable-proxy-auth|, |--enable-auth-*|, and many other
>     flags in my Dockerfile
> 
>   *
> 
>     Using the Dockerfile provided by |b4tman/docker-squid|?repo
> 
>   *
> 
>     Running on *Docker Swarm*?and mapping config via:
> 
> |volumes: - ./config/squid.conf:/etc/squid/my-squid.conf:ro |
> 
>   *
> 
>     |SQUID_CONFIG_FILE|?is set properly, and the config loads ? until it
>     hits that line.
> 
> ------------------------------------------------------------------------
> 
> 
>       ? *What is |proxy-protocol|?supposed to do?*
> 
> The |proxy-protocol|?option is designed to allow Squid to accept 
> *original client IP addresses*?from trusted proxies or load balancers 
> (e.g., HAProxy, AWS ELB, Traefik) via the PROXY protocol 
> <https://www.haproxy.org/download/2.0/doc/proxy-protocol.txt>.
> 
> It lets you do things like:
> 
> |http_port 3128 proxy-protocol |
> 
> Instead of seeing the IP of the load balancer, Squid gets the real 
> client IP passed in the PROXY header ? which is essential for proper 
> logging, ACLs, or geo-restrictions in reverse-proxy environments.
> 
> ------------------------------------------------------------------------
> 
> 
>       ? *Current Blocker*
> 
> Despite enabling many Squid features in the Docker build, this one fails 
> with |Unknown http_port option 'proxy-protocol'|, which usually means 
> the *binary wasn't compiled with support*?for it.
> 
> ------------------------------------------------------------------------
> 
> 
>       ?? *Questions / Help Needed*
> 
>   *
> 
>     Is |--with-proxy-protocol|?or equivalent *compile flag*?required to
>     enable this? (I can't find it in the list of |./configure|?options
>     for Squid.)
> 
>   *
> 
>     Has anyone used |proxy-protocol|?successfully with Squid 6.13 in
>     Docker or with the |b4tman/docker-squid|?base image?
> 
>   *
> 
>     Is there a specific patch, module, or feature flag I'm missing?
> 
> Thanks in advance ? this feature is critical for deployment in Swarm 
> behind a reverse proxy, and I?m stuck!
> 
> Best regards,
> 
> 
> *Michael Tint*
> Linux Admin
> 
> 
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> https://lists.squid-cache.org/listinfo/squid-users


From hpcmtint at gmail.com  Tue Apr  8 13:22:48 2025
From: hpcmtint at gmail.com (Michael Tint)
Date: Tue, 8 Apr 2025 14:22:48 +0100
Subject: [squid-users] Fwd: Issue with proxy-protocol in http_port on
 Squid 6.13 via Docker
In-Reply-To: <23d8d5b8-fb4f-4988-969a-f75a4e5f08f4@measurement-factory.com>
References: <mailman.12143.1744114879.1200.squid-users@lists.squid-cache.org>
 <CAGZi1t5Xov0dX5otYRugD0Pb9d3UpdC8oYsJOUmVz1uvnAdrpw@mail.gmail.com>
 <CAGZi1t44EyexCdBgjFRbhcM25K1rdwPAcZfVwx9R-vGQoAM8dg@mail.gmail.com>
 <23d8d5b8-fb4f-4988-969a-f75a4e5f08f4@measurement-factory.com>
Message-ID: <CAGZi1t45ewCr7B8zSVJK9xGB6GwjQ8gA7XpBYz6RL1Lj1QZoDg@mail.gmail.com>

Hi Alex,

Thank you very much for your quick and helpful response regarding the PROXY
protocol configuration.

Your clarification about using require-proxy-header instead of
proxy-protocol was spot on ? I?ve updated my squid.conf accordingly, and it
now seems to be working as expected.

I really appreciate your support and guidance on this!

Best regards,

Michael Tin



On Tue, 8 Apr 2025 at 14:09, Alex Rousskov <rousskov at measurement-factory.com>
wrote:

> On 2025-04-08 08:24, Michael Tint wrote:
>
> > I'm running into a blocking issue while deploying Squid 6.13 ... My goal
> is
> > to enable the PROXY protocol support via the following config line:
> >
> > http_port 3128 proxy-protocol
>
>
> The correct http_port option name for enabling PROXY protocol support is
> not "proxy-protocol" but "require-proxy-header". See http_port directive
> description in your generated squid.conf.documented or at
> https://www.squid-cache.org/Doc/config/http_port/
>
> HTH,
>
> Alex.
>
>
>
> > However, on startup I consistently get this error:
> >
> > |2025/04/08 13:14:44| Processing Configuration File:
> > /etc/squid/my-squid.conf (depth 0) 2025/04/08 13:14:44| FATAL: Unknown
> > http_port option 'proxy-protocol'. 2025/04/08 13:14:44| FATAL: Bungled
> > /etc/squid/my-squid.conf line 1: http_port 3128 proxy-protocol
> > 2025/04/08 13:14:44| Squid Cache (Version 6.13): Terminated abnormally. |
> >
> > ------------------------------------------------------------------------
> >
> >
> >       ? *What I?ve Done So Far:*
> >
> >   *
> >
> >     Using Squid *6.13* (confirmed)
> >
> >   *
> >
> >     Verified |--enable-proxy-auth|, |--enable-auth-*|, and many other
> >     flags in my Dockerfile
> >
> >   *
> >
> >     Using the Dockerfile provided by |b4tman/docker-squid| repo
> >
> >   *
> >
> >     Running on *Docker Swarm* and mapping config via:
> >
> > |volumes: - ./config/squid.conf:/etc/squid/my-squid.conf:ro |
> >
> >   *
> >
> >     |SQUID_CONFIG_FILE| is set properly, and the config loads ? until it
> >     hits that line.
> >
> > ------------------------------------------------------------------------
> >
> >
> >       ? *What is |proxy-protocol| supposed to do?*
> >
> > The |proxy-protocol| option is designed to allow Squid to accept
> > *original client IP addresses* from trusted proxies or load balancers
> > (e.g., HAProxy, AWS ELB, Traefik) via the PROXY protocol
> > <https://www.haproxy.org/download/2.0/doc/proxy-protocol.txt>.
> >
> > It lets you do things like:
> >
> > |http_port 3128 proxy-protocol |
> >
> > Instead of seeing the IP of the load balancer, Squid gets the real
> > client IP passed in the PROXY header ? which is essential for proper
> > logging, ACLs, or geo-restrictions in reverse-proxy environments.
> >
> > ------------------------------------------------------------------------
> >
> >
> >       ? *Current Blocker*
> >
> > Despite enabling many Squid features in the Docker build, this one fails
> > with |Unknown http_port option 'proxy-protocol'|, which usually means
> > the *binary wasn't compiled with support* for it.
> >
> > ------------------------------------------------------------------------
> >
> >
> >       ?? *Questions / Help Needed*
> >
> >   *
> >
> >     Is |--with-proxy-protocol| or equivalent *compile flag* required to
> >     enable this? (I can't find it in the list of |./configure| options
> >     for Squid.)
> >
> >   *
> >
> >     Has anyone used |proxy-protocol| successfully with Squid 6.13 in
> >     Docker or with the |b4tman/docker-squid| base image?
> >
> >   *
> >
> >     Is there a specific patch, module, or feature flag I'm missing?
> >
> > Thanks in advance ? this feature is critical for deployment in Swarm
> > behind a reverse proxy, and I?m stuck!
> >
> > Best regards,
> >
> >
> > *Michael Tint*
> > Linux Admin
> >
> >
> > _______________________________________________
> > squid-users mailing list
> > squid-users at lists.squid-cache.org
> > https://lists.squid-cache.org/listinfo/squid-users
>
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20250408/3feb36c3/attachment-0001.htm>

From squid3 at treenet.co.nz  Wed Apr  9 08:19:43 2025
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Wed, 9 Apr 2025 20:19:43 +1200
Subject: [squid-users] Error determining LDAP server type: Timed out
In-Reply-To: <CADCk2kpNAoDXrx1CkPkiYRM5p-VU8hMBz=JLnBeQ2g1S9nGgiA@mail.gmail.com>
References: <CADCk2kpNAoDXrx1CkPkiYRM5p-VU8hMBz=JLnBeQ2g1S9nGgiA@mail.gmail.com>
Message-ID: <aa689fed-6c2c-41c0-850a-d8aad43fb547@treenet.co.nz>

On 8/04/25 06:42, Reinhard Westerholt wrote:
> Hello everybody,
> 
> I have configured Squid to use Kerberos authentication and employed 
> ext_kerberos_ldap_group_acl to limit HTTP access. This setup works fine 
> in most cases. However, randomly (and rarely), there seems to be an 
> issue with the LDAP query, causing the Active Directory groups to fail 
> to resolve, which subsequently denies user access. When this occurs, the 
> issue persists for about an hour. I suspect this might be due to caching 
> or TTL.

Very likely.

> 
> Here is a relevant part of the configuration:
> 
> auth_param negotiate program /usr/lib/squid/negotiate_kerberos_auth -s 
> HTTP/server.fqdn at domain
> auth_param negotiate children 500
> auth_param negotiate keep_alive on
> 
> external_acl_type INetAccess ttl=3600 children-max=1000 %LOGIN /usr/lib/ 
> squid/ext_kerberos_ldap_group_acl -g "INetAccess" -a -i -l ldap:// 
> server.fqdn:389 -D "DOMAIN"

There you have it " ttl=3600 "  (ie 1 hour, in seconds). If this is the 
only TTL configured it will be used for both OK and ERR results.


...
> 
> I manually attempted to retrieve the subschemasubentry using ldapsearch. 
> As far as I can see, there is no issue, or I could not reproduce the 
> problem manually via ldapsearch.
> 
> Does anyone have any ideas on how to further debug this issue? 
> Additionally, are there any recommendations regarding the TTL value? If 
> I reduce the TTL, the duration of the issue might be shorter for 
> individual users.


There are three alternatives to changing "ttl=" itself.

In order of my recommendation:

1) Avoiding the external helper entirely if you can.

The auth helper you are using should be providing Squid with a list of 
the group SSID's the logged in user is a member of. With those, Squid 
can use the 'note' type ACL to check the groups quickly instead of 
needing a separate helper lookup.

Like so:
   acl INetAccess note group ...[SSID]...


2) Setting "grace=" which will attempt the re-lookup before the TTL 
finishes. That way Squid will use the already cached value at the exact 
time the failure occurs, and may be able to re-try the failed lookup at 
least once before it has any effects.
   This grace= option should ideally be only a few seconds and must be 
strictly less than both ttl= and negative-ttl= values.


3) Add a shorter value for the ERR results with "negative-ttl=".

Just be aware that lowering either of these TTL values will impact 
transaction speed for all the traffic where the user is (ttl=), or not 
(negative-ttl=) a member of that group.


HTH
Amos

From jonathanlee571 at gmail.com  Thu Apr 10 15:47:03 2025
From: jonathanlee571 at gmail.com (Jonathan Lee)
Date: Thu, 10 Apr 2025 08:47:03 -0700
Subject: [squid-users] Status page error
Message-ID: <309DE681-3D74-4F41-A28B-A770091AF8C5@gmail.com>

An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20250410/3f6194e4/attachment.htm>
-------------- next part --------------
A non-text attachment was scrubbed...
Name: favicon.ico
Type: image/x-icon
Size: 7886 bytes
Desc: not available
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20250410/3f6194e4/attachment.bin>

From squid3 at treenet.co.nz  Fri Apr 11 05:08:32 2025
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Fri, 11 Apr 2025 17:08:32 +1200
Subject: [squid-users] Status page error
In-Reply-To: <309DE681-3D74-4F41-A28B-A770091AF8C5@gmail.com>
References: <309DE681-3D74-4F41-A28B-A770091AF8C5@gmail.com>
Message-ID: <815ea5ac-1261-452e-bd43-0a5ffb019787@treenet.co.nz>

On 11/04/25 03:47, Jonathan Lee wrote:
> Hello fellow Squid users,
> 
> Does anyone use pfSense squid package that knows a possible solution to 
> this issue ? I have went as far as to remove all custom config and go to 
> complete splice all and it still occurs with or without cache enabled 
> and or squid guard enabled. It is something I just don?t know how to 
> correct it. I worked on testing it in command line a while back but 
> could not find a way to get the status page working again.

> Bug #15410: cache_object://URL Scheme is removed in Squid-6 - pfSense 
> Packages - pfSense bugtracker <https://redmine.pfsense.org/issues/15410>

As discussed in that bug report the "cache_object://" scheme has been 
replaced by "http://(visible_hostname):3128/squid-internal-mgr/"

* The scheme can be "https://" so long as the proxy listening port is 
configured with the https_port directive.

* visible_hostname should be replaced by the contents of the 
visible_hostname directive, or listening IP address. This is just one of 
the many reasons that directive **needs** to be a DNS resolvable domain 
name.

* The port 3128 can be another forward-proxy or an 'accel' mode port if 
you wish. Cannot be an 'intercept' or 'tproxy' *_port, nor an https_port 
with SSL-Bump enabled.


FTR; What we are familiar with as an "index page" is not provided by the 
Squid cache manager by default. I provide a basic UI at 
<https://github.com/yadij/cachemgr.js> that makes accessing the reports 
a bit easier for humans.


HTH
Amos


From rousskov at measurement-factory.com  Fri Apr 11 14:12:46 2025
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Fri, 11 Apr 2025 10:12:46 -0400
Subject: [squid-users] Status page error
In-Reply-To: <815ea5ac-1261-452e-bd43-0a5ffb019787@treenet.co.nz>
References: <309DE681-3D74-4F41-A28B-A770091AF8C5@gmail.com>
 <815ea5ac-1261-452e-bd43-0a5ffb019787@treenet.co.nz>
Message-ID: <884c7b4f-b1aa-427d-ab82-de06f2d26007@measurement-factory.com>

On 2025-04-11 01:08, Amos Jeffries wrote:
> On 11/04/25 03:47, Jonathan Lee wrote:
>> Hello fellow Squid users,
>>
>> Does anyone use pfSense squid package that knows a possible solution 
>> to this issue ? I have went as far as to remove all custom config and 
>> go to complete splice all and it still occurs with or without cache 
>> enabled and or squid guard enabled. It is something I just don?t know 
>> how to correct it. I worked on testing it in command line a while back 
>> but could not find a way to get the status page working again.
> 
>> Bug #15410: cache_object://URL Scheme is removed in Squid-6 - pfSense 
>> Packages - pfSense bugtracker <https://redmine.pfsense.org/issues/15410>
> 
> As discussed in that bug report the "cache_object://" scheme has been 
> replaced by "http://(visible_hostname):3128/squid-internal-mgr/"
> 
> * The scheme can be "https://" so long as the proxy listening port is 
> configured with the https_port directive.

... and as long as you are not using SMP Squid: SMP Squids do not yet 
support responding to certain(*) cache manager requests received on TLS 
connections.

Alex.

(*) Affected (i.e. TLS-incompatible) cache manager reports are the ones 
that do not fully aggregate reported information across SMP kids and, 
hence, have "by kidN" wrappers around kid-specific reports. For example, 
mgr:mem.



> * visible_hostname should be replaced by the contents of the 
> visible_hostname directive, or listening IP address. This is just one of 
> the many reasons that directive **needs** to be a DNS resolvable domain 
> name.
> 
> * The port 3128 can be another forward-proxy or an 'accel' mode port if 
> you wish. Cannot be an 'intercept' or 'tproxy' *_port, nor an https_port 
> with SSL-Bump enabled.
> 
> 
> FTR; What we are familiar with as an "index page" is not provided by the 
> Squid cache manager by default. I provide a basic UI at 
> <https://github.com/yadij/cachemgr.js> that makes accessing the reports 
> a bit easier for humans.
> 
> 
> HTH
> Amos
> 
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> https://lists.squid-cache.org/listinfo/squid-users


From jonathanlee571 at gmail.com  Sat Apr 12 04:12:09 2025
From: jonathanlee571 at gmail.com (Jonathan Lee)
Date: Fri, 11 Apr 2025 21:12:09 -0700
Subject: [squid-users] Status page error
In-Reply-To: <815ea5ac-1261-452e-bd43-0a5ffb019787@treenet.co.nz>
References: <815ea5ac-1261-452e-bd43-0a5ffb019787@treenet.co.nz>
Message-ID: <50EF8178-DE90-426A-A386-90EE547F3173@gmail.com>

An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20250411/5fbc8e3e/attachment.htm>

From buckroger2011 at gmail.com  Wed Apr 16 06:37:54 2025
From: buckroger2011 at gmail.com (Renzo Marengo)
Date: Wed, 16 Apr 2025 08:37:54 +0200
Subject: [squid-users] application to proxy should have to use CONNECT
 method ?
Message-ID: <CAMmfGZSR8J8bU9wmMcc5B-JT_0yVR6WgTAOGQ8YTuJJqoqR2iQ@mail.gmail.com>

I know browser uses CONNECT method in http request to communicate to proxy
server, I ask  about other applications (which use this proxy server) if
It's requirement to use the same  CONNECT method creating a http request to
proxy server.
It often occurs applications communicate to hosts with ports which are
different from 80/443 so I think I't' necessary to establish tunnel
connection to non standard ports.
It's all right ?
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20250416/134b04df/attachment.htm>

From squid3 at treenet.co.nz  Wed Apr 16 09:00:57 2025
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Wed, 16 Apr 2025 21:00:57 +1200
Subject: [squid-users] application to proxy should have to use CONNECT
 method ?
In-Reply-To: <CAMmfGZSR8J8bU9wmMcc5B-JT_0yVR6WgTAOGQ8YTuJJqoqR2iQ@mail.gmail.com>
References: <CAMmfGZSR8J8bU9wmMcc5B-JT_0yVR6WgTAOGQ8YTuJJqoqR2iQ@mail.gmail.com>
Message-ID: <9c3524ce-a116-41ad-a91a-71f96aab79ff@treenet.co.nz>

On 16/04/25 18:37, Renzo Marengo wrote:
> I know browser uses CONNECT method in http request to communicate to 
> proxy server, I ask? about other applications (which use this proxy 
> server) if It's requirement to use the same? CONNECT method creating a 
> http request to proxy server.
> It often occurs applications communicate to hosts with ports which are 
> different from 80/443 so I think I't' necessary to establish tunnel 
> connection to non standard ports.
> It's all right ?
> 

Not quite. HTTP may occur over any port (unusual, but permitted).

The CONNECT method is to establish a TCP-like tunnel between client and 
server through an HTTP proxy. That includes HTTPS (port 443) traffic 
going through an HTTP proxy.


HTH
Amos


From buckroger2011 at gmail.com  Wed Apr 16 10:11:50 2025
From: buckroger2011 at gmail.com (Renzo Marengo)
Date: Wed, 16 Apr 2025 12:11:50 +0200
Subject: [squid-users] ACL with the same name
Message-ID: <CAMmfGZScQAJTTPUA8A-UoN-s-XrLjuF03-TMeELdo2JjtiprBA@mail.gmail.com>

I don't understand what happens if I have multiple acl with same name, e.g.
(only for educational purposes)

acl SSL_ports port 82           # ImageScope - Anatomia Patologica
acl SSL_ports port 443          # https
acl SSL_ports port 563          # news

http_access deny CONNECT !SSL_ports

SSL_port includes last acl that is 563 or all ports ?
Wheh http_access directive is processed, all 3 SSL_ports acl are scanned ?
Or only the last one is  checked ?
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20250416/8e9ea815/attachment.htm>

From jonathanlee571 at gmail.com  Wed Apr 16 13:09:08 2025
From: jonathanlee571 at gmail.com (Jonathan Lee)
Date: Wed, 16 Apr 2025 06:09:08 -0700
Subject: [squid-users] ACL with the same name
In-Reply-To: <CAMmfGZScQAJTTPUA8A-UoN-s-XrLjuF03-TMeELdo2JjtiprBA@mail.gmail.com>
References: <CAMmfGZScQAJTTPUA8A-UoN-s-XrLjuF03-TMeELdo2JjtiprBA@mail.gmail.com>
Message-ID: <A4E240A1-3204-4FD1-9D36-277B673C13C6@gmail.com>

To my understanding it just increments the ACL. Or adds to it.
Sent from my iPhone

> On Apr 16, 2025, at 03:12, Renzo Marengo <buckroger2011 at gmail.com> wrote:
> 
> ?
> I don't understand what happens if I have multiple acl with same name, e.g. (only for educational purposes)
> 
> acl SSL_ports port 82           # ImageScope - Anatomia Patologica
> acl SSL_ports port 443          # https
> acl SSL_ports port 563          # news
> 
> http_access deny CONNECT !SSL_ports
> 
> SSL_port includes last acl that is 563 or all ports ?
> Wheh http_access directive is processed, all 3 SSL_ports acl are scanned ? Or only the last one is  checked ?
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> https://lists.squid-cache.org/listinfo/squid-users

From abarnett at belofx.com  Wed Apr 16 13:28:14 2025
From: abarnett at belofx.com (Adam Barnett)
Date: Wed, 16 Apr 2025 14:28:14 +0100
Subject: [squid-users] Maxon App
Message-ID: <CAP9Tep5F02Eg4behvJ=WubqBgZ7859g5N172NTu_Zvd3X=jMVQ@mail.gmail.com>

Hi All,

Has anyone managed to get the maxon application working via squid?
I have added all the IP's and URL that they have given us but it still does
not work, just sit on "Loading application" after signing in.

There is nothing in the logs and i even did a wirehark and an still nothing
that i could see.


This is the section from my config

acl dst_maxon_domains url_regex .maxon.net
acl dst_maxon_domains url_regex id.maxon.net
acl dst_maxon_domains url_regex packages.maxon.net
acl dst_maxon_domains url_regex asset.maxon.net
acl dst_maxon_domains url_regex cloudfront.net
acl dst_maxon_domains url_regex cloudflare.com
acl dst_maxon_domains url_regex recaptcha.net
acl dst_maxon_domains url_regex fonts.googleapis.com
acl dst_maxon_domains url_regex zbrushcentral.com
acl dst_maxon_domains url_regex mini-cart.widget.maxon.net
acl dst_maxon_domains url_regex recaptcha.net
acl dst_maxon_domains url_regex cacerts.digicert.com
acl dst_maxon_domains url_regex ts-aia.ws.symantec.com
acl dst_maxon_domains url_regex rb.symcb.com
acl dst_maxon_domains url_regex static.edge.microsoftapp.net
acl dst_maxon_domains url_regex cookiebot.com
acl dst_maxon_domains url_regex maxon-prod.eu-west-1.elasticbeanstalk.com

acl maxon_ip dst 173.245.48.0/20
acl maxon_ip dst 103.21.244.0/22
acl maxon_ip dst 103.22.200.0/22
acl maxon_ip dst 103.31.4.0/22
acl maxon_ip dst 141.101.64.0/18
acl maxon_ip dst 108.162.192.0/18
acl maxon_ip dst 190.93.240.0/20
acl maxon_ip dst 188.114.96.0/20
acl maxon_ip dst 197.234.240.0/22
acl maxon_ip dst 198.41.128.0/17
acl maxon_ip dst 162.158.0.0/15
acl maxon_ip dst 104.16.0.0/13
acl maxon_ip dst 104.24.0.0/14
acl maxon_ip dst 172.64.0.0/13
acl maxon_ip dst 131.0.72.0/22
acl maxon_ip dst 169.254.169.254

Any suggestions

Thanks
Adam
--
Adam Barnett
Senior Systems Engineer  @ BeloFX
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20250416/7f0c2a9d/attachment.htm>

From gkinkie at gmail.com  Wed Apr 16 20:18:55 2025
From: gkinkie at gmail.com (Francesco Chemolli)
Date: Wed, 16 Apr 2025 21:18:55 +0100
Subject: [squid-users] ACL with the same name
In-Reply-To: <CAMmfGZScQAJTTPUA8A-UoN-s-XrLjuF03-TMeELdo2JjtiprBA@mail.gmail.com>
References: <CAMmfGZScQAJTTPUA8A-UoN-s-XrLjuF03-TMeELdo2JjtiprBA@mail.gmail.com>
Message-ID: <CA+Y8hcPZ3K-EWy-3+0CGOfcf4rGv_1N8hKY_eAz+hfSLWkdH-A@mail.gmail.com>

acl SSL_ports port 82
acl SSL_ports port 443
acl SSL_ports port 563

is exactly the same as:

acl SSL_ports port 82 443 563


ACLs with the same name need to be of the same type, and they get appended


On Wed, Apr 16, 2025 at 5:48?PM Renzo Marengo <buckroger2011 at gmail.com> wrote:
>
> I don't understand what happens if I have multiple acl with same name, e.g. (only for educational purposes)
>
> acl SSL_ports port 82           # ImageScope - Anatomia Patologica
> acl SSL_ports port 443          # https
> acl SSL_ports port 563          # news
>
> http_access deny CONNECT !SSL_ports
>
> SSL_port includes last acl that is 563 or all ports ?
> Wheh http_access directive is processed, all 3 SSL_ports acl are scanned ? Or only the last one is  checked ?
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> https://lists.squid-cache.org/listinfo/squid-users



-- 
    Francesco

From rousskov at measurement-factory.com  Wed Apr 16 21:22:27 2025
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Thu, 17 Apr 2025 00:22:27 +0300
Subject: [squid-users] ACL with the same name
In-Reply-To: <CA+Y8hcPZ3K-EWy-3+0CGOfcf4rGv_1N8hKY_eAz+hfSLWkdH-A@mail.gmail.com>
References: <CAMmfGZScQAJTTPUA8A-UoN-s-XrLjuF03-TMeELdo2JjtiprBA@mail.gmail.com>
 <CA+Y8hcPZ3K-EWy-3+0CGOfcf4rGv_1N8hKY_eAz+hfSLWkdH-A@mail.gmail.com>
Message-ID: <196407b5638.282b.0fa0e86c8d2ee43f749db760f8bca319@measurement-factory.com>

On April 16, 2025 23:19:13 Francesco Chemolli <gkinkie at gmail.com> wrote:

> acl SSL_ports port 82
> acl SSL_ports port 443
> acl SSL_ports port 563
>
> is exactly the same as:
>
> acl SSL_ports port 82 443 563
>
>
> ACLs with the same name need to be of the same type, and they get appended


To be more precise, their conditions are ORed.

For more information, see the following wiki page, especially its Notes 
section:
https://wiki.squid-cache.org/SquidFaq/SquidAcl


HTH,

Alex.


>
>
> On Wed, Apr 16, 2025 at 5:48?PM Renzo Marengo <buckroger2011 at gmail.com> wrote:
>>
>> I don't understand what happens if I have multiple acl with same name, e.g. 
>> (only for educational purposes)
>>
>> acl SSL_ports port 82           # ImageScope - Anatomia Patologica
>> acl SSL_ports port 443          # https
>> acl SSL_ports port 563          # news
>>
>> http_access deny CONNECT !SSL_ports
>>
>> SSL_port includes last acl that is 563 or all ports ?
>> Wheh http_access directive is processed, all 3 SSL_ports acl are scanned ? 
>> Or only the last one is  checked ?
>> _______________________________________________
>> squid-users mailing list
>> squid-users at lists.squid-cache.org
>> https://lists.squid-cache.org/listinfo/squid-users
>
>
>
> --
>    Francesco
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> https://lists.squid-cache.org/listinfo/squid-users





From squid3 at treenet.co.nz  Wed Apr 16 23:07:36 2025
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Thu, 17 Apr 2025 11:07:36 +1200
Subject: [squid-users] Maxon App
In-Reply-To: <CAP9Tep5F02Eg4behvJ=WubqBgZ7859g5N172NTu_Zvd3X=jMVQ@mail.gmail.com>
References: <CAP9Tep5F02Eg4behvJ=WubqBgZ7859g5N172NTu_Zvd3X=jMVQ@mail.gmail.com>
Message-ID: <4e9dc057-8a37-43f5-a86d-ef7fc7220ff0@treenet.co.nz>

On 17/04/25 01:28, Adam Barnett wrote:
> Hi All,
> 
> Has anyone managed to get the maxon application working via squid?
> I have added all the IP's and URL that they have given us but it still 
> does not work, just sit on "Loading application" after signing?in.
> 
> There is nothing?in the logs and i even did a wirehark and an still 
> nothing that i could see.
> 
> 
> This is the section from?my config
> 
> acl dst_maxon_domains url_regex .maxon.net
> acl dst_maxon_domains url_regex id.maxon.net
> acl dst_maxon_domains url_regex packages.maxon.net
> acl dst_maxon_domains url_regex asset.maxon.net
> acl dst_maxon_domains url_regex cloudfront.net
> acl dst_maxon_domains url_regex cloudflare.com
> acl dst_maxon_domains url_regex recaptcha.net
> acl dst_maxon_domains url_regex fonts.googleapis.com
> acl dst_maxon_domains url_regex zbrushcentral.com
> acl dst_maxon_domains url_regex mini-cart.widget.maxon.net
> acl dst_maxon_domains url_regex recaptcha.net
> acl dst_maxon_domains url_regex cacerts.digicert.com
> acl dst_maxon_domains url_regex ts-aia.ws.symantec.com
> acl dst_maxon_domains url_regex rb.symcb.com
> acl dst_maxon_domains url_regex static.edge.microsoftapp.net
> acl dst_maxon_domains url_regex cookiebot.com
> acl dst_maxon_domains url_regex maxon-prod.eu-west-1.elasticbeanstalk.com


Several problems with the above.

1) these are dstdomain patterns. Not regex.
   Currently


2) The entry for " .maxon.net " overlaps with all of these (and more):

 > acl dst_maxon_domains url_regex id.maxon.net
 > acl dst_maxon_domains url_regex packages.maxon.net
 > acl dst_maxon_domains url_regex asset.maxon.net
 > acl dst_maxon_domains url_regex mini-cart.widget.maxon.net

you can remove those extras.


3) Multiple entries for "recaptcha.net"



> 
> acl maxon_ip dst 173.245.48.0/20
> acl maxon_ip dst 103.21.244.0/22
> acl maxon_ip dst 103.22.200.0/22
> acl maxon_ip dst 103.31.4.0/22
> acl maxon_ip dst 141.101.64.0/18
> acl maxon_ip dst 108.162.192.0/18
> acl maxon_ip dst 190.93.240.0/20
> acl maxon_ip dst 188.114.96.0/20
> acl maxon_ip dst 197.234.240.0/22
> acl maxon_ip dst 198.41.128.0/17
> acl maxon_ip dst 162.158.0.0/15
> acl maxon_ip dst 104.16.0.0/13
> acl maxon_ip dst 104.24.0.0/14
> acl maxon_ip dst 172.64.0.0/13
> acl maxon_ip dst 131.0.72.0/22
> acl maxon_ip dst 169.254.169.254
> 

IP ranges are fine, but you should not need them unless the proxy is 
receiving URLs containing raw-URLs. Otherwise you risk allowing access 
to foreign domains that are simply hosted somewhere within those very 
large IP spaces.


> Any suggestions


So your "acl lines" have defined the data to test against.

What access policy have you defined for using these?

Please show your *_access configuration.


HTH
Amos


From manoj.ramakrishna95 at gmail.com  Thu Apr 17 12:32:49 2025
From: manoj.ramakrishna95 at gmail.com (manoj ramakrishna95)
Date: Thu, 17 Apr 2025 18:02:49 +0530
Subject: [squid-users] Squid Intercept Issue
Message-ID: <CAO5VAihY+k8QVKOte6qQmwmGRF4m1-F-Rcnfp+B570jVCc-LJQ@mail.gmail.com>

Hello Team,

I hope you are well, been working on the powerful squid proxy for the past
few months and have been struck at the dead end while setting up a
transparent proxy.
My goal is to set up a squid proxy as a transparent proxy for http.
Below is the config file(have included only the important part not all),
I have a fedora box as a client where I have mentioned the squid proxy ip
and a demo website in
/etc/hosts file forcing it to go through the squid proxy.
my.squid.ip.address     www.neverssl.com

And on the server is the below configuration and output which I have shared.
_________
http_port 0.0.0.0:3128
http_port 192.168.124.130:3130 intercept
acl SSL_ports port 443
acl Safe_ports port 80 443 3128 3129 3130 3131 21 70 210 280 488 591 777
1025-65535
# === ACLs and Access Rules ===
acl localnet src 192.168.124.0/24
acl fedora_client src 192.168.0.0/16
acl localhost src 127.0.0.1/32
acl SSL_ports port 443
acl Safe_ports port 80 443 3128 3129 3130 3131 21 70 210 280 488 591 777
1025-65535
acl CONNECT method CONNECT
http_access allow all

logformat MyLogFormat  ---> local_time="[%tl]" squid_service=%{service}note
squid_status=%Ss squid_hierarchy_status=%Sh |
lb_sessionid=%{X-SSL-sessionid}>h | **FLOW1** src_ip=%>a src_port=%>p
squid_ingress_ip=%>la squid_ingress_port=%>lp | **FLOW2**
squid_egress_ip=%<la squid_egress_port=%<lp dst_ip=%<a dst_host=%<A
dst_port=%<p ident_username=%[ui username=%[un request_method=%rm
request="%rm %ru HTTP/%rv" dst_url="%ru" status_code_from_server=%>Hs
status_code_to_client=%<Hs referer="%{Referer}>h"
user_agent="%{User-Agent}>h" protocol_version=%rv ** dns_response_time=%dt
response_time=%tr mime_type=%mt *XFER* total_request_size=%>st
total_reply_size=%<st ** %{src_zone}note %{dst_zone}note
%{method_category}note %{dst_category}note %{file_upload}note ** REQUEST
HEADERS %>h *** RESPONSE HEADERS %<h *** tag_returned=%et tag_string="%ea"
previous_hop_mac=%>eui peer_response_time=%<pt total_response_time=%<tt
*SSL* src_ssl_negotiated_version=%ssl::>negotiated_version
dst_ssl_negotiated_version=%ssl::<negotiated_version
src_tls_hello_version=%ssl::>received_hello_version
 dst_tls_hello_version=%ssl::<received_hello_version
src_tls_max_version=%ssl::>received_supported_version
dst_tls_max_version=%ssl::<received_supported_version
src_tls_cipher=%ssl::>negotiated_cipher
dst_tls_cipher=%ssl::<negotiated_cipher ssl_bump=%<bs
ssl_bump_mode=%ssl::bump_mode ssl_sni=%ssl::>sni
src_cert_subject="%ssl::>cert_subject" src_cert_issuer="%ssl::>cert_issuer"
dst_cert_subject="%ssl::<cert_subject" dst_cert_issuer="%ssl::<cert_issuer"
cert_errors="%ssl::<cert_errors" ssl_handshake="%>handshake" ***
error_page_presented=%err_code err_detail="%err_detail"
 rule_id=%{ruleid}note rule_type=%{ruletype}note
 XFF="%{X-Forwarded-For}>h" squid_dst_app=%{dst_app}note
SkipSsl=%{SkipSslDecrypt}note BrokenButTrusted=%{BrokenButTrusted}note | **
dns_response_time=%dt peer_response_time=%<pt total_response_time=%<tt
response_time=%tr |

__________
Below are the output for netstat
[root at redhat squid]# netstat -tulnp | grep -i squid
tcp        0      0 0.0.0.0:3128            0.0.0.0:*               LISTEN
     935/(squid-1)
tcp        0      0 192.168.124.130:3130    0.0.0.0:*               LISTEN
     935/(squid-1)
____________
Below are the iptables rule
#iptables -A INPUT -p tcp --dport 80 -j ACCEPT
 #iptables -A INPUT -p tcp --dport 3128 -j ACCEPT
 #iptables -A INPUT -p tcp --dport 3130 -j ACCEPT
#iptables -t nat -A PREROUTING -i enp1s0 -p tcp --dport 80 -j REDIRECT
--to-port 3130
___________________
Below are the output of the logs (Flow 1: Is from client to proxy; Flow 2:
is from proxy to destination) while executing curl from the client. The
proxy is not reaching the destination server rather talking to itself.
**FLOW1** src_ip=192.168.124.1 src_port=53564
squid_ingress_ip=192.168.124.130 squid_ingress_port=3130
**FLOW2** squid_egress_ip=192.168.124.130 squid_egress_port=44378
dst_ip=192.168.124.130 dst_host=www.neverssl.com dst_port=3130
ident_username=- username=- request_method=GET request="GET
http://www.neverssl.com/ HTTP/1.1" dst_url="http://www.neverssl.com/"
status_code_from_server=403 status_code_to_client=403 referer="-"
user_agent="curl/8.9.1" protocol_version=1.1 ** dns_response_time=22
response_time=24 mime_type=text/html *XFER* total_request_size=132
total_reply_size=4127 ** - - - - - ** REQUEST HEADERS
User-Agent:%20curl/8.9.1%0D%0AAccept:%20*/*%0D%0AProxy-Connection:%20Keep-Alive%0D%0AHost:%
20www.neverssl.com%0D%0A *** RESPONSE HEADERS
HTTP/1.1%20403%20Forbidden%0D%0AServer:%20squid/5.5%0D%0AMime-Version:%201.0%0D%0ADate:%20Mon,%2007%20Apr%202025%2015:00:52%20GMT%0D%0AContent-Type:%20text/html;charset=utf-8%0D%0AContent-Length:%203633%0D%0AX-Squid-Error:%20ERR_ACCESS_DENIED
-------------------

P.S: Have good success on setting it up as explicit by setting the IP on
the browser. But that's not the ultimate goal.
I would appreciate any help that you can offer in this regard.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20250417/baf27768/attachment.htm>

From squid3 at treenet.co.nz  Fri Apr 18 06:36:23 2025
From: squid3 at treenet.co.nz (Amos Jeffries)
Date: Fri, 18 Apr 2025 18:36:23 +1200
Subject: [squid-users] Squid Intercept Issue
In-Reply-To: <CAO5VAihY+k8QVKOte6qQmwmGRF4m1-F-Rcnfp+B570jVCc-LJQ@mail.gmail.com>
References: <CAO5VAihY+k8QVKOte6qQmwmGRF4m1-F-Rcnfp+B570jVCc-LJQ@mail.gmail.com>
Message-ID: <4b95648a-beb5-419d-9ec1-9555fdf94ff4@treenet.co.nz>

On 18/04/25 00:32, manoj ramakrishna95 wrote:
> Hello Team,
> 
> I hope you are well, been working on the powerful squid proxy for the 
> past few months and have been struck at the dead end while setting up a 
> transparent proxy.
> My goal is to set up a squid proxy as a transparent proxy for http.
> Below is the config file(have included only the important part not all),
> I have a fedora box as a client where I have mentioned the squid proxy 
> ip and a demo website in
> /etc/hosts file forcing it to go through the squid proxy.
> my.squid.ip.address www.neverssl.com


The setup you have on your client is trying to use the proxy as if it 
were an origin server. Squid receives such traffic with:

   http_port 80 accel

   https_port 443 accel \
      tls-cert=/cert/and/key/for/neverssl.com.pem


For transparent proxy, it is your network router which needs rules 
passing port 80/443 traffic from client->Internet to the proxy machine.


> 
> And on the server is the below configuration and output which I have shared.
> _________
> http_port 0.0.0.0:3128
> http_port 192.168.124.130:3130 intercept
> acl SSL_ports port 443
> acl Safe_ports port 80 443 3128 3129 3130 3131 21 70 210 280 488 591 777 
> 1025-65535
> # === ACLs and Access Rules ===
> acl localnet src 192.168.124.0/24
> acl fedora_client src 192.168.0.0/16
> acl localhost src 127.0.0.1/32
> acl SSL_ports port 443
> acl Safe_ports port 80 443 3128 3129 3130 3131 21 70 210 280 488 591 777 
> 1025-65535
> acl CONNECT method CONNECT
> http_access allow all

Please restore the basic security protections:

  http_access deny !Safe_ports
  http_access deny CONNECT !SSL_ports

...

> ____________
> Below are the iptables rule
> #iptables -A INPUT -p tcp --dport 80 -j ACCEPT
>  ?#iptables -A INPUT -p tcp --dport 3128 -j ACCEPT
>  ?#iptables -A INPUT -p tcp --dport 3130 -j ACCEPT
> #iptables -t nat -A PREROUTING -i enp1s0 -p tcp --dport 80 -j REDIRECT 
> --to-port 3130

Okay. You should also have a MASQUERADE rule, and a "mangle" table 
protection against malware hijacking your proxies intercept port.

See <https://wiki.squid-cache.org/ConfigExamples/Intercept/LinuxRedirect>


HTH
Amos


From buckroger2011 at gmail.com  Tue Apr 29 06:54:31 2025
From: buckroger2011 at gmail.com (Renzo Marengo)
Date: Tue, 29 Apr 2025 08:54:31 +0200
Subject: [squid-users] connect with http and https protocols
Message-ID: <CAMmfGZTeQJBgRH=FhAYJZg9dQ5V3POfA72tPNRm61uo-s8w2eQ@mail.gmail.com>

When client uses CONNECT directive I understand that proxy establishes
tunnel to destination host on specified port

e.g.
http://www.example.com:8888/test.php
https://www.example.com:8888/test.php

1. I don't understand if this occurs both in presence of http and https
requests, The request (using CONNECT method) can be http or https ?
2.  if In both cases CONNECT method is invoked but how I can discover
protocol (http, https) looking for inside access.log ?
A.B.C.D TCP_TUNNEL/200 7085 CONNECT mtalk.google.com:5228 - HIER_DIRECT/
142.251.18.188

I see only info about destination host and port but no http/https protocol
is referenced.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20250429/b9ea5215/attachment.htm>

From rousskov at measurement-factory.com  Tue Apr 29 13:50:09 2025
From: rousskov at measurement-factory.com (Alex Rousskov)
Date: Tue, 29 Apr 2025 09:50:09 -0400
Subject: [squid-users] connect with http and https protocols
In-Reply-To: <CAMmfGZTeQJBgRH=FhAYJZg9dQ5V3POfA72tPNRm61uo-s8w2eQ@mail.gmail.com>
References: <CAMmfGZTeQJBgRH=FhAYJZg9dQ5V3POfA72tPNRm61uo-s8w2eQ@mail.gmail.com>
Message-ID: <d3069202-5c59-4613-bfcb-532730948640@measurement-factory.com>

On 2025-04-29 02:54, Renzo Marengo wrote:
> When client uses CONNECT directive I understand that proxy establishes 
> tunnel to destination host on specified port

Yes, the proxy establishes a TCP tunnel with the destination.


> 1. I don't understand if this occurs both in presence of http and https 
> requests, The request (using CONNECT method) can be http or https ?

I do not know how _you_ define "http" and "https" in this context, but 
CONNECT request may be received on a plain text connection (i.e. a 
connection to an http_port), on an encrypted connection (i.e. a TLS 
connection to an https_port), and even inside a bumped TLS connection 
(on either port; e.g., a CONNECT request received inside a bumped 
CONNECT tunnel)!


> 2.? if In both cases CONNECT method is invoked but how I can discover 
> protocol (http, https) looking for inside access.log ?

If you are not telling Squid to bump the corresponding CONNECT tunnel 
using ssl_bump, then you cannot discover the protocol inside that 
tunnel. Squid is just shoveling opaque bytes using TCP in that (default) 
case.

If Squid successfully bumps the corresponding CONNECT tunnel, then the 
protocol inside that tunnel is HTTPS or, more precise, TLS-encrypted 
HTTP/0 or HTTP/1 transactions. You should see those decrypted 
transactions in access.log, logged with the same 
%transport::>connection_id as the CONNECT transaction.

If Squid attempts to bump the corresponding CONNECT tunnel, and that 
tunnel starts with a TLS handshake, then you may be able to recover the 
underlying protocol from ALPN extension in %>handshake.

See logformat directive for the above %code documentation:
https://www.squid-cache.org/Doc/config/logformat/


HTH,

Alex.


From uhlar at fantomas.sk  Tue Apr 29 14:11:33 2025
From: uhlar at fantomas.sk (Matus UHLAR - fantomas)
Date: Tue, 29 Apr 2025 16:11:33 +0200
Subject: [squid-users] Maxon App
In-Reply-To: <4e9dc057-8a37-43f5-a86d-ef7fc7220ff0@treenet.co.nz>
References: <CAP9Tep5F02Eg4behvJ=WubqBgZ7859g5N172NTu_Zvd3X=jMVQ@mail.gmail.com>
 <4e9dc057-8a37-43f5-a86d-ef7fc7220ff0@treenet.co.nz>
Message-ID: <aBDeFUttdz6jNZ2f@fantomas.sk>

>On 17/04/25 01:28, Adam Barnett wrote:
>>Has anyone managed to get the maxon application working via squid?
>>I have added all the IP's and URL that they have given us but it 
>>still does not work, just sit on "Loading application" after 
>>signing?in.
>>
>>There is nothing?in the logs and i even did a wirehark and an still 
>>nothing that i could see.
>>
>>
>>This is the section from?my config
>>
>>acl dst_maxon_domains url_regex .maxon.net
>>acl dst_maxon_domains url_regex id.maxon.net
>>acl dst_maxon_domains url_regex packages.maxon.net
>>acl dst_maxon_domains url_regex asset.maxon.net
>>acl dst_maxon_domains url_regex cloudfront.net
>>acl dst_maxon_domains url_regex cloudflare.com
>>acl dst_maxon_domains url_regex recaptcha.net
>>acl dst_maxon_domains url_regex fonts.googleapis.com
>>acl dst_maxon_domains url_regex zbrushcentral.com
>>acl dst_maxon_domains url_regex mini-cart.widget.maxon.net
>>acl dst_maxon_domains url_regex recaptcha.net
>>acl dst_maxon_domains url_regex cacerts.digicert.com
>>acl dst_maxon_domains url_regex ts-aia.ws.symantec.com
>>acl dst_maxon_domains url_regex rb.symcb.com
>>acl dst_maxon_domains url_regex static.edge.microsoftapp.net
>>acl dst_maxon_domains url_regex cookiebot.com
>>acl dst_maxon_domains url_regex maxon-prod.eu-west-1.elasticbeanstalk.com

On 17.04.25 11:07, Amos Jeffries wrote:
>Several problems with the above.
>
>1) these are dstdomain patterns. Not regex.
>  Currently


perhaps you prematurely hit send but I add:

use "dstdomain -n .maxon.net"
- this prevents from resolving if client provides IP Address


>2) The entry for " .maxon.net " overlaps with all of these (and more):
>
>> acl dst_maxon_domains url_regex id.maxon.net
>> acl dst_maxon_domains url_regex packages.maxon.net
>> acl dst_maxon_domains url_regex asset.maxon.net
>> acl dst_maxon_domains url_regex mini-cart.widget.maxon.net
>
>you can remove those extras.

With url_regex squid shouldn't notice, with "dstdomain" would complain.


url_regex is horribly ineffective and has unexpected consequences

- "." applies for any character unless escaped
- applies within strings

e.g.
url_regex .maxon.net

matches

"ourmaxonanet.com"

-- 
Matus UHLAR - fantomas, uhlar at fantomas.sk ; http://www.fantomas.sk/
Warning: I wish NOT to receive e-mail advertising to this address.
Varovanie: na tuto adresu chcem NEDOSTAVAT akukolvek reklamnu postu.
On the other hand, you have different fingers.

From uhlar at fantomas.sk  Tue Apr 29 14:35:52 2025
From: uhlar at fantomas.sk (Matus UHLAR - fantomas)
Date: Tue, 29 Apr 2025 16:35:52 +0200
Subject: [squid-users] connect with http and https protocols
In-Reply-To: <CAMmfGZTeQJBgRH=FhAYJZg9dQ5V3POfA72tPNRm61uo-s8w2eQ@mail.gmail.com>
References: <CAMmfGZTeQJBgRH=FhAYJZg9dQ5V3POfA72tPNRm61uo-s8w2eQ@mail.gmail.com>
Message-ID: <aBDjyBvpty-WNHnz@fantomas.sk>

On 29.04.25 08:54, Renzo Marengo wrote:
>When client uses CONNECT directive I understand that proxy establishes
>tunnel to destination host on specified port
>
>e.g.
>http://www.example.com:8888/test.php
>https://www.example.com:8888/test.php
>
>1. I don't understand if this occurs both in presence of http and https
>requests, The request (using CONNECT method) can be http or https ?


When you enter "http://www.example.com:8888/test.php" into your browser, 
your browser asks proxy server for "http://www.example.com:8888/test.php"
- it delegates fetching the content to proxy.

When you enter "https://www.example.com:8888/test.php" to your browser, it 
asks proxy server to "CONNET www.example.com:8888" and browser handles the 
SSL negotiation and further communication itself.

This way, you can tunnel different protocols through the proxy, not just 
HTTP (squid must be able to allow it, the destination ports are usually 
restricted via "https_port" acl).

>2.  if In both cases CONNECT method is invoked but how I can discover
>protocol (http, https) looking for inside access.log ?
>A.B.C.D TCP_TUNNEL/200 7085 CONNECT mtalk.google.com:5228 - HIER_DIRECT/
>142.251.18.188
>
>I see only info about destination host and port but no http/https protocol
>is referenced.


In this case, client A.B.C.D asked the proxy to "CONNECT 
mtalk.google.com:5228" and the proxy fullfilled the request.
In case of CONNECT requests, the proxy has no idea what data flow through 
the server. Afaik mtalk.google.com:5228 is used for google/firebase cloud 
messaging.

-- 
Matus UHLAR - fantomas, uhlar at fantomas.sk ; http://www.fantomas.sk/
Warning: I wish NOT to receive e-mail advertising to this address.
Varovanie: na tuto adresu chcem NEDOSTAVAT akukolvek reklamnu postu.
    One OS to rule them all, One OS to find them,
One OS to bring them all and into darkness bind them

From buckroger2011 at gmail.com  Wed Apr 30 12:39:44 2025
From: buckroger2011 at gmail.com (Renzo Marengo)
Date: Wed, 30 Apr 2025 14:39:44 +0200
Subject: [squid-users] connect with http and https protocols
In-Reply-To: <aBDjyBvpty-WNHnz@fantomas.sk>
References: <CAMmfGZTeQJBgRH=FhAYJZg9dQ5V3POfA72tPNRm61uo-s8w2eQ@mail.gmail.com>
 <aBDjyBvpty-WNHnz@fantomas.sk>
Message-ID: <CAMmfGZTr5aQ3AYE7_SZvHf402yvyv8OuXYagvwWkdTwMic+Pdg@mail.gmail.com>

>> When you enter "https://www.example.com:8888/test.php" to your browser,
it
>>asks proxy server to "CONNECT www.example.com:8888" and browser handles
the
>>SSL negotiation and further communication itself.

what you are saying It's very interesting, infact previously I understood
CONNECT method was invoked both by http and by https protocols.
You are saying CONNECT method is invoked only if protocol is https, while
if you type http://site:port, no CONNECT method is invoked.
Right ?


Il giorno mar 29 apr 2025 alle ore 16:36 Matus UHLAR - fantomas <
uhlar at fantomas.sk> ha scritto:

> On 29.04.25 08:54, Renzo Marengo wrote:
> >When client uses CONNECT directive I understand that proxy establishes
> >tunnel to destination host on specified port
> >
> >e.g.
> >http://www.example.com:8888/test.php
> >https://www.example.com:8888/test.php
> >
> >1. I don't understand if this occurs both in presence of http and https
> >requests, The request (using CONNECT method) can be http or https ?
>
>
> When you enter "http://www.example.com:8888/test.php" into your browser,
> your browser asks proxy server for "http://www.example.com:8888/test.php"
> - it delegates fetching the content to proxy.
>
> When you enter "https://www.example.com:8888/test.php" to your browser,
> it
> asks proxy server to "CONNET www.example.com:8888" and browser handles
> the
> SSL negotiation and further communication itself.
>
> This way, you can tunnel different protocols through the proxy, not just
> HTTP (squid must be able to allow it, the destination ports are usually
> restricted via "https_port" acl).
>
> >2.  if In both cases CONNECT method is invoked but how I can discover
> >protocol (http, https) looking for inside access.log ?
> >A.B.C.D TCP_TUNNEL/200 7085 CONNECT mtalk.google.com:5228 - HIER_DIRECT/
> >142.251.18.188
> >
> >I see only info about destination host and port but no http/https protocol
> >is referenced.
>
>
> In this case, client A.B.C.D asked the proxy to "CONNECT
> mtalk.google.com:5228" and the proxy fullfilled the request.
> In case of CONNECT requests, the proxy has no idea what data flow through
> the server. Afaik mtalk.google.com:5228 is used for google/firebase cloud
> messaging.
>
> --
> Matus UHLAR - fantomas, uhlar at fantomas.sk ; http://www.fantomas.sk/
> Warning: I wish NOT to receive e-mail advertising to this address.
> Varovanie: na tuto adresu chcem NEDOSTAVAT akukolvek reklamnu postu.
>     One OS to rule them all, One OS to find them,
> One OS to bring them all and into darkness bind them
> _______________________________________________
> squid-users mailing list
> squid-users at lists.squid-cache.org
> https://lists.squid-cache.org/listinfo/squid-users
>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: <http://lists.squid-cache.org/pipermail/squid-users/attachments/20250430/6d072675/attachment.htm>

From uhlar at fantomas.sk  Wed Apr 30 13:47:11 2025
From: uhlar at fantomas.sk (Matus UHLAR - fantomas)
Date: Wed, 30 Apr 2025 15:47:11 +0200
Subject: [squid-users] connect with http and https protocols
In-Reply-To: <CAMmfGZTr5aQ3AYE7_SZvHf402yvyv8OuXYagvwWkdTwMic+Pdg@mail.gmail.com>
References: <CAMmfGZTeQJBgRH=FhAYJZg9dQ5V3POfA72tPNRm61uo-s8w2eQ@mail.gmail.com>
 <aBDjyBvpty-WNHnz@fantomas.sk>
 <CAMmfGZTr5aQ3AYE7_SZvHf402yvyv8OuXYagvwWkdTwMic+Pdg@mail.gmail.com>
Message-ID: <aBIp3_bi-zN6VeUn@fantomas.sk>

On 30.04.25 14:39, Renzo Marengo wrote:
>what you are saying It's very interesting, infact previously I understood
>CONNECT method was invoked both by http and by https protocols.
>You are saying CONNECT method is invoked only if protocol is https, while
>if you type http://site:port, no CONNECT method is invoked.
>Right ?

Correct.

While it is possible to issue CONNECT for HTTP request, most clients do not 
do that, and squid does not allow by default CONNECT requests to port 80 
(where most HTTP servers listen at).
The FTP requests are often also issued through GET/PUT requests instead of 
CONNECT, the default FTP port 21 is also not allowed by default.

Also, using GET requests gives us advantage to cache content on proxy's 
side, which may benefit us in lower latency and spared bandwidth.

There's still much of internet content that is available without encryption, 
like CRL lists or any kinds of signed content, where you don't have to be 
afraid of it being modified, e.g. debian packages


-- 
Matus UHLAR - fantomas, uhlar at fantomas.sk ; http://www.fantomas.sk/
Warning: I wish NOT to receive e-mail advertising to this address.
Varovanie: na tuto adresu chcem NEDOSTAVAT akukolvek reklamnu postu.
I just got lost in thought. It was unfamiliar territory.

