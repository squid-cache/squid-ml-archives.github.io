<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Squid Intercept Issue
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20Intercept%20Issue&In-Reply-To=%3CCAO5VAihY%2Bk8QVKOte6qQmwmGRF4m1-F-Rcnfp%2BB570jVCc-LJQ%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="027552.html">
   <LINK REL="Next"  HREF="027549.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Squid Intercept Issue</H1>
    <B>manoj ramakrishna95</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Squid%20Intercept%20Issue&In-Reply-To=%3CCAO5VAihY%2Bk8QVKOte6qQmwmGRF4m1-F-Rcnfp%2BB570jVCc-LJQ%40mail.gmail.com%3E"
       TITLE="[squid-users] Squid Intercept Issue">manoj.ramakrishna95 at gmail.com
       </A><BR>
    <I>Thu Apr 17 12:32:49 UTC 2025</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="027552.html">[squid-users] Maxon App
</A></li>
        <LI>Next message (by thread): <A HREF="027549.html">[squid-users] Squid Intercept Issue
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27548">[ date ]</a>
              <a href="thread.html#27548">[ thread ]</a>
              <a href="subject.html#27548">[ subject ]</a>
              <a href="author.html#27548">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello Team,

I hope you are well, been working on the powerful squid proxy for the past
few months and have been struck at the dead end while setting up a
transparent proxy.
My goal is to set up a squid proxy as a transparent proxy for http.
Below is the config file(have included only the important part not all),
I have a fedora box as a client where I have mentioned the squid proxy ip
and a demo website in
/etc/hosts file forcing it to go through the squid proxy.
my.squid.ip.address     www.neverssl.com

And on the server is the below configuration and output which I have shared.
_________
http_port 0.0.0.0:3128
http_port 192.168.124.130:3130 intercept
acl SSL_ports port 443
acl Safe_ports port 80 443 3128 3129 3130 3131 21 70 210 280 488 591 777
1025-65535
# === ACLs and Access Rules ===
acl localnet src 192.168.124.0/24
acl fedora_client src 192.168.0.0/16
acl localhost src 127.0.0.1/32
acl SSL_ports port 443
acl Safe_ports port 80 443 3128 3129 3130 3131 21 70 210 280 488 591 777
1025-65535
acl CONNECT method CONNECT
http_access allow all

logformat MyLogFormat  ---&gt; local_time=&quot;[%tl]&quot; squid_service=%{service}note
squid_status=%Ss squid_hierarchy_status=%Sh |
lb_sessionid=%{X-SSL-sessionid}&gt;h | **FLOW1** src_ip=%&gt;a src_port=%&gt;p
squid_ingress_ip=%&gt;la squid_ingress_port=%&gt;lp | **FLOW2**
squid_egress_ip=%&lt;la squid_egress_port=%&lt;lp dst_ip=%&lt;a dst_host=%&lt;A
dst_port=%&lt;p ident_username=%[ui username=%[un request_method=%rm
request=&quot;%rm %ru HTTP/%rv&quot; dst_url=&quot;%ru&quot; status_code_from_server=%&gt;Hs
status_code_to_client=%&lt;Hs referer=&quot;%{Referer}&gt;h&quot;
user_agent=&quot;%{User-Agent}&gt;h&quot; protocol_version=%rv ** dns_response_time=%dt
response_time=%tr mime_type=%mt *XFER* total_request_size=%&gt;st
total_reply_size=%&lt;st ** %{src_zone}note %{dst_zone}note
%{method_category}note %{dst_category}note %{file_upload}note ** REQUEST
HEADERS %&gt;h *** RESPONSE HEADERS %&lt;h *** tag_returned=%et tag_string=&quot;%ea&quot;
previous_hop_mac=%&gt;eui peer_response_time=%&lt;pt total_response_time=%&lt;tt
*SSL* src_ssl_negotiated_version=%ssl::&gt;negotiated_version
dst_ssl_negotiated_version=%ssl::&lt;negotiated_version
src_tls_hello_version=%ssl::&gt;received_hello_version
 dst_tls_hello_version=%ssl::&lt;received_hello_version
src_tls_max_version=%ssl::&gt;received_supported_version
dst_tls_max_version=%ssl::&lt;received_supported_version
src_tls_cipher=%ssl::&gt;negotiated_cipher
dst_tls_cipher=%ssl::&lt;negotiated_cipher ssl_bump=%&lt;bs
ssl_bump_mode=%ssl::bump_mode ssl_sni=%ssl::&gt;sni
src_cert_subject=&quot;%ssl::&gt;cert_subject&quot; src_cert_issuer=&quot;%ssl::&gt;cert_issuer&quot;
dst_cert_subject=&quot;%ssl::&lt;cert_subject&quot; dst_cert_issuer=&quot;%ssl::&lt;cert_issuer&quot;
cert_errors=&quot;%ssl::&lt;cert_errors&quot; ssl_handshake=&quot;%&gt;handshake&quot; ***
error_page_presented=%err_code err_detail=&quot;%err_detail&quot;
 rule_id=%{ruleid}note rule_type=%{ruletype}note
 XFF=&quot;%{X-Forwarded-For}&gt;h&quot; squid_dst_app=%{dst_app}note
SkipSsl=%{SkipSslDecrypt}note BrokenButTrusted=%{BrokenButTrusted}note | **
dns_response_time=%dt peer_response_time=%&lt;pt total_response_time=%&lt;tt
response_time=%tr |

__________
Below are the output for netstat
[<A HREF="https://lists.squid-cache.org/listinfo/squid-users">root at redhat</A> squid]# netstat -tulnp | grep -i squid
tcp        0      0 0.0.0.0:3128            0.0.0.0:*               LISTEN
     935/(squid-1)
tcp        0      0 192.168.124.130:3130    0.0.0.0:*               LISTEN
     935/(squid-1)
____________
Below are the iptables rule
#iptables -A INPUT -p tcp --dport 80 -j ACCEPT
 #iptables -A INPUT -p tcp --dport 3128 -j ACCEPT
 #iptables -A INPUT -p tcp --dport 3130 -j ACCEPT
#iptables -t nat -A PREROUTING -i enp1s0 -p tcp --dport 80 -j REDIRECT
--to-port 3130
___________________
Below are the output of the logs (Flow 1: Is from client to proxy; Flow 2:
is from proxy to destination) while executing curl from the client. The
proxy is not reaching the destination server rather talking to itself.
**FLOW1** src_ip=192.168.124.1 src_port=53564
squid_ingress_ip=192.168.124.130 squid_ingress_port=3130
**FLOW2** squid_egress_ip=192.168.124.130 squid_egress_port=44378
dst_ip=192.168.124.130 dst_host=www.neverssl.com dst_port=3130
ident_username=- username=- request_method=GET request=&quot;GET
<A HREF="http://www.neverssl.com/">http://www.neverssl.com/</A> HTTP/1.1&quot; dst_url=&quot;<A HREF="http://www.neverssl.com/">http://www.neverssl.com/</A>&quot;
status_code_from_server=403 status_code_to_client=403 referer=&quot;-&quot;
user_agent=&quot;curl/8.9.1&quot; protocol_version=1.1 ** dns_response_time=22
response_time=24 mime_type=text/html *XFER* total_request_size=132
total_reply_size=4127 ** - - - - - ** REQUEST HEADERS
User-Agent:%20curl/8.9.1%0D%0AAccept:%20*/*%0D%0AProxy-Connection:%20Keep-Alive%0D%0AHost:%
20www.neverssl.com%0D%0A *** RESPONSE HEADERS
HTTP/1.1%20403%20Forbidden%0D%0AServer:%20squid/5.5%0D%0AMime-Version:%201.0%0D%0ADate:%20Mon,%2007%20Apr%202025%2015:00:52%20GMT%0D%0AContent-Type:%20text/html;charset=utf-8%0D%0AContent-Length:%203633%0D%0AX-Squid-Error:%20ERR_ACCESS_DENIED
-------------------

P.S: Have good success on setting it up as explicit by setting the IP on
the browser. But that's not the ultimate goal.
I would appreciate any help that you can offer in this regard.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20250417/baf27768/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20250417/baf27768/attachment.htm</A>&gt;
</PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="027552.html">[squid-users] Maxon App
</A></li>
	<LI>Next message (by thread): <A HREF="027549.html">[squid-users] Squid Intercept Issue
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27548">[ date ]</a>
              <a href="thread.html#27548">[ thread ]</a>
              <a href="subject.html#27548">[ subject ]</a>
              <a href="author.html#27548">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
