<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] bypassing the domains
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20bypassing%20the%20domains&In-Reply-To=%3C422627f2-476d-4a24-b6bb-07fae6d16457%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="027426.html">
   <LINK REL="Next"  HREF="027431.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] bypassing the domains</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20bypassing%20the%20domains&In-Reply-To=%3C422627f2-476d-4a24-b6bb-07fae6d16457%40measurement-factory.com%3E"
       TITLE="[squid-users] bypassing the domains">rousskov at measurement-factory.com
       </A><BR>
    <I>Wed Feb  5 14:46:04 UTC 2025</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="027426.html">[squid-users] bypassing the domains
</A></li>
        <LI>Next message (by thread): <A HREF="027431.html">[squid-users] test ICAP server
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27428">[ date ]</a>
              <a href="thread.html#27428">[ thread ]</a>
              <a href="subject.html#27428">[ subject ]</a>
              <a href="author.html#27428">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 2025-02-05 05:54, udhayakumar wrote:

&gt;<i> if i put whitelist_regex in below config which domains i was try
</I>&gt;<i> browse in browser it's says*SSL_ERROR_RX_RECORD_TOO_LONG*
</I>
IIRC, that usually happens when Squid responds with a plain text error 
page while the browser expects TLS. You may be able to confirm that by 
looking at the problematic browser-Squid transactions using wireshark or 
a similar packet analysis tool.


&gt;<i> ssl_bump peek step1
</I>&gt;<i> ssl_bump splice sslwhitelist
</I>&gt;<i> ssl_bump splice allowed_sites
</I> &gt; ssl_bump bump all

Do you have http_access rules that allow TLS connections to sites 
matching sslwhitelist and allowed_sites ACLs? I do not see them. Please 
keep in mind that http_access controls access (for requests on all 
connections) while ssl_bump controls whether/when TLS connections are 
decrypted. Both sets of rules are important. For example, if http_access 
denies a request, then Squid will not splice the corresponding 
client-to-Squid and Squid-to-server connections.

Please also note that your second set of ssl_bump rules (not shown 
above) will never be reached because one of the ssl_bump rules shown 
above will always match, ending ssl_bump rule evaliation.


HTH,

Alex.


&gt;&gt;<i> http_port 3128
</I>&gt;&gt;<i> http_port 3129 tproxy
</I>&gt;&gt;<i> https_port 3127 tproxy ssl-bump cert=/etc/squid_av/ssl_cert/squidCA.pem generate-host-certificates=on dynamic_cert_mem_cache_size=16MB cipher=EECDH+ECDSA+AESGCM:EECDH+aRSA+AESGCM:EECDH+ECDSA+SHA384:EECDH+ECDSA+SHA256:EECDH+aRSA+SHA384:EECDH+aRSA+SHA256:EECDH+aRSA+RC4:EECDH:EDH+aRSA:HIGH:RC4:!aNULL:!eNULL:!LOW:3DES:!MD5:!EXP:!PSK:!SRP:!DSS options=ALL:NO_SSLv3
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> #don't verifying peer &amp; allow accept with validate and error
</I>&gt;&gt;<i> #tls_outgoing_options flags=DONT_VERIFY_PEER
</I>&gt;&gt;<i> tls_outgoing_options flags=DONT_VERIFY_DOMAIN
</I>&gt;&gt;<i> tls_outgoing_options cipher=EECDH+ECDSA+AESGCM:EECDH+aRSA+AESGCM:EECDH+ECDSA+SHA384:EECDH+ECDSA+SHA256:EECDH+aRSA+SHA384:EECDH+aRSA+SHA256:EECDH+aRSA+RC4:EECDH:EDH+aRSA:HIGH:!RC4:!aNULL:!eNULL:!LOW:!3DES:!MD5:!EXP:!PSK:!SRP:!DSS
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> icp_port 0
</I>&gt;&gt;<i> digest_generation off
</I>&gt;&gt;<i> error_default_language en
</I>&gt;&gt;<i> #logformat icap_squid %tl %&gt;a %&gt;p %&lt;A %la %lp %&lt;la %&lt;lp %tr %dt
</I>&gt;&gt;<i> #icap_log /var/log/squid/access.log
</I>&gt;&gt;<i> #logformat customlog (%tl) source_ip=%&gt;a src_port=%&gt;p user=%ui [%tl] &quot;%rm %ru HTTP/%rv&quot; status=%&gt;Hs size=%&lt;st user_agent=&quot;%{User-Agent}&gt;h&quot;
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> cache_log /var/log/squid/cache.log
</I>&gt;&gt;<i> cache_store_log none
</I>&gt;&gt;<i> netdb_filename /var/squid/logs/netdb.state
</I>&gt;&gt;<i> pinger_enable off
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> log_icp_queries off
</I>&gt;&gt;<i> logfile_rotate 1
</I>&gt;&gt;<i> # squid worker config optmize based on processor
</I>&gt;&gt;<i> workers 16
</I>&gt;&gt;<i> cpu_affinity_map process_numbers=1,2, cores=1,3
</I>&gt;&gt;<i> # certificate mimic
</I>&gt;&gt;<i> sslcrtd_program /usr/lib/squid/security_file_certgen -s /var/lib/squid/ssl_db -M 16MB -b 2048
</I>&gt;&gt;<i> logfile_rotate 2
</I>&gt;&gt;<i> debug_options rotate=2
</I>&gt;&gt;<i> #proxy options
</I>&gt;&gt;<i> hosts_file /etc/hosts
</I>&gt;&gt;<i> fqdncache_size 6000
</I>&gt;&gt;<i> visible_hostname fatpipe_proxy
</I>&gt;&gt;<i> collapsed_forwarding on
</I>&gt;&gt;<i> forwarded_for transparent
</I>&gt;&gt;<i> via on
</I>&gt;&gt;<i> httpd_suppress_version_string on
</I>&gt;&gt;<i> uri_whitespace strip
</I>&gt;&gt;<i> shutdown_lifetime 3 seconds
</I>&gt;&gt;<i> url_rewrite_host_header on
</I>&gt;&gt;<i> #loggiing strop
</I>&gt;&gt;<i> strip_query_terms on
</I>&gt;&gt;<i> #cache option Amount RAM half
</I>&gt;&gt;<i> cache_mem 8096 MB
</I>&gt;&gt;<i> memory_cache_mode always
</I>&gt;&gt;<i> maximum_object_size_in_memory 256 KB
</I>&gt;&gt;<i> memory_replacement_policy heap GDSF
</I>&gt;&gt;<i> cache_replacement_policy heap LFUDA
</I>&gt;&gt;<i> minimum_object_size 0 KB
</I>&gt;&gt;<i> maximum_object_size 4 MB
</I>&gt;&gt;<i> #cache allocation disk store block by block it's helps disk i/o
</I>&gt;&gt;<i> cache_dir rock /var/spool/rockfs/squid_cache 20000 max-size=32768 max-swap-rate=250 swap-timeout=200
</I>&gt;&gt;<i> max_stale 1 week
</I>&gt;&gt;<i> on_unsupported_protocol tunnel
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> offline_mode off
</I>&gt;&gt;<i> #cache low and high mark
</I>&gt;&gt;<i> cache_swap_low 90
</I>&gt;&gt;<i> cache_swap_high 96
</I>&gt;&gt;<i> cache allow all
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> #pipelining for HTTP pipelining
</I>&gt;&gt;<i> pipeline_prefetch 6
</I>&gt;&gt;<i> acl SSL_ports port 443          #https
</I>&gt;&gt;<i> acl SSL_ports port 563          #https
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> acl Safe_ports port 80          # http
</I>&gt;&gt;<i> acl Safe_ports port 21          # ftp
</I>&gt;&gt;<i> acl Safe_ports port 443         # https
</I>&gt;&gt;<i> acl Safe_ports port 70          # gopher
</I>&gt;&gt;<i> acl Safe_ports port 210         # wais
</I>&gt;&gt;<i> acl Safe_ports port 1025-65535  # unregistered ports
</I>&gt;&gt;<i> acl Safe_ports port 280         # http-mgmt
</I>&gt;&gt;<i> acl Safe_ports port 488         # gss-http
</I>&gt;&gt;<i> acl Safe_ports port 591         # filemaker
</I>&gt;&gt;<i> acl Safe_ports port 777         # multiling http
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> acl HTTP proto HTTP
</I>&gt;&gt;<i> acl HTTPS proto HTTPS
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> acl purge method PURGE
</I>&gt;&gt;<i> acl CONNECT method CONNECT
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> #new tweak
</I>&gt;&gt;<i> acl step1 at_step SslBump1
</I>&gt;&gt;<i> acl step2 at_step SslBump2
</I>&gt;&gt;<i> acl step3 at_step SslBump3
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> # Example rule allowing access from your local networks.
</I>&gt;&gt;<i> # Adapt to list your (internal) IP networks from where browsing
</I>&gt;&gt;<i> # should be allowed
</I>&gt;&gt;<i> acl localnet src 0.0.0.1-0.255.255.255  # RFC 1122 &quot;this&quot; network (LAN)
</I>&gt;&gt;<i> acl localnet src 10.0.0.0/8             # RFC 1918 local private network (LAN)
</I>&gt;&gt;<i> acl localnet src 100.64.0.0/10          # RFC 6598 shared address space (CGN)
</I>&gt;&gt;<i> acl localnet src 169.254.0.0/16         # RFC 3927 link-local (directly plugged) machines
</I>&gt;&gt;<i> acl localnet src 172.16.0.0/12          # RFC 1918 local private network (LAN)
</I>&gt;&gt;<i> acl localnet src 192.168.0.0/16         # RFC 1918 local private network (LAN)
</I>&gt;&gt;<i> acl localnet src fc00::/7               # RFC 4193 local private network range
</I>&gt;&gt;<i> acl localnet src fe80::/10              # RFC 4291 link-local (directly plugged) machines
</I>&gt;&gt;<i> acl allsrc src all
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> #
</I>&gt;&gt;<i> # INSERT YOUR OWN RULE(S) HERE TO ALLOW ACCESS FROM YOUR CLIENTS
</I>&gt;&gt;<i> #
</I>&gt;&gt;<i> acl windowsupdate dstdomain windowsupdate.microsoft.com
</I>&gt;&gt;<i> cl windowsupdate dstdomain .update.microsoft.com
</I>&gt;&gt;<i> acl windowsupdate dstdomain download.windowsupdate.com
</I>&gt;&gt;<i> acl windowsupdate dstdomain redir.metaservices.microsoft.com
</I>&gt;&gt;<i> acl windowsupdate dstdomain images.metaservices.microsoft.com
</I>&gt;&gt;<i> acl windowsupdate dstdomain c.microsoft.com
</I>&gt;&gt;<i> acl windowsupdate dstdomainwww.download.windowsupdate.com
</I>&gt;&gt;<i> acl windowsupdate dstdomain wustat.windows.com
</I>&gt;&gt;<i> acl windowsupdate dstdomain crl.microsoft.com
</I>&gt;&gt;<i> acl windowsupdate dstdomain sls.microsoft.com
</I>&gt;&gt;<i> acl windowsupdate dstdomain productactivation.one.microsoft.com
</I>&gt;&gt;<i> acl windowsupdate dstdomain ntservicepack.microsoft.com
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> acl CONNECT method CONNECT
</I>&gt;&gt;<i> acl wuCONNECT dstdomainwww.update.microsoft.com
</I>&gt;&gt;<i> acl wuCONNECT dstdomain sls.microsoft.com
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> http_access allow CONNECT wuCONNECT localnet
</I>&gt;&gt;<i> http_access allow windowsupdate localnet
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> #skip lan subnet
</I>&gt;&gt;<i> #acl DomainMismatch ssl_error SQUID_X509_V_ERR_DOMAIN_MISMATCH
</I>&gt;&gt;<i> #sslproxy_cert_error allow localnet DomainMismatch
</I>&gt;&gt;<i> #sslproxy_cert_error deny all
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> # Define a list of websites to skip the proxy
</I>&gt;&gt;<i> #acl sslwhitelist ssl::server_name_regex -i &quot;/etc/squid_av/whitelist_regex.acl&quot;
</I>&gt;&gt;<i> #acl allowed_sites ssl::server_name &quot;/etc/squid_av/whitelist.acl&quot;
</I>&gt;&gt;<i> #acl local-external dstdomain .google.com .icicibank.com
</I>&gt;&gt;<i> #always_direct allow local-external
</I>&gt;&gt;<i> #acl allowed_sites ssl::server_name .foo.com .hdfcbank.com .copilot.microsoft.com
</I>&gt;&gt;<i> #sslproxy_cert_error allow allowed_sites
</I>&gt;&gt;<i> host_verify_strict off
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> ssl_bump peek step1
</I>&gt;&gt;<i> #ssl_bump splice sslwhitelist
</I>&gt;&gt;<i> #ssl_bump splice allowed_sites
</I>&gt;&gt;<i> ssl_bump bump all
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> http_access allow manager localhost
</I>&gt;&gt;<i> http_access deny manager
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> http_access allow purge localhost
</I>&gt;&gt;<i> http_access deny purge
</I>&gt;&gt;<i> # Deny requests to certain unsafe ports
</I>&gt;&gt;<i> http_access deny !Safe_ports
</I>&gt;&gt;<i> # Deny CONNECT to other than secure SSL ports
</I>&gt;&gt;<i> http_access deny CONNECT !SSL_ports
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> http_access allow localnet
</I>&gt;&gt;<i> http_access allow localhost
</I>&gt;&gt;<i> #request header config
</I>&gt;&gt;<i> quick_abort_min 0 KB
</I>&gt;&gt;<i> quick_abort_max 0 KB
</I>&gt;&gt;<i> request_body_max_size 0 KB
</I>&gt;&gt;<i> #delay_pools config
</I>&gt;&gt;<i> delay_pools 1
</I>&gt;&gt;<i> delay_class 1 2
</I>&gt;&gt;<i> delay_parameters 1 -1/-1 -1/-1
</I>&gt;&gt;<i> delay_initial_bucket_level 100
</I>&gt;&gt;<i> # Throttle extensions matched in the url
</I>&gt;&gt;<i> #acl throttle_exts urlpath_regex -i &quot;/var/squid/acl/throttle_exts.acl&quot;
</I>&gt;&gt;<i> #delay_access 1 allow throttle_exts
</I>&gt;&gt;<i> #delay_access 1 deny allsrc
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> # Set YouTube safesearch restriction
</I>&gt;&gt;<i> #acl youtubedst dstdomain -nwww.youtube.com  m.youtube.com youtubei.googleapis.com youtube.googleapis.comwww.youtube-nocookie.com
</I>&gt;&gt;<i> #request_header_access YouTube-Restrict deny all
</I>&gt;&gt;<i> #request_header_add YouTube-Restrict moderate youtubedst
</I>&gt;&gt;<i> ssl_bump peek step1
</I>&gt;&gt;<i> ssl_bump bump all
</I>&gt;&gt;<i> # Allow local network(s) on interface(s)
</I>&gt;&gt;<i> http_access allow localnet
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> # Default block all to be sure
</I>&gt;&gt;<i> http_access deny allsrc
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> icap_enable on
</I>&gt;&gt;<i> icap_send_client_ip on
</I>&gt;&gt;<i> icap_send_client_username on
</I>&gt;&gt;<i> icap_client_username_encode off
</I>&gt;&gt;<i> icap_client_username_header X-Authenticated-User
</I>&gt;&gt;<i> icap_preview_enable on
</I>&gt;&gt;<i> icap_preview_size 1024
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> icap_service service_avi_req reqmod_precache <A HREF="icap://localhost:1344/squidclamav">icap://localhost:1344/squidclamav</A> bypass=on
</I>&gt;&gt;<i> adaptation_access service_avi_req allow all
</I>&gt;&gt;<i> icap_service service_avi_resp respmod_precache <A HREF="icap://localhost:1344/squidclamav">icap://localhost:1344/squidclamav</A> bypass=off
</I>&gt;&gt;<i> adaptation_access service_avi_resp allow all
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> #debug_options ALL,1
</I>&gt;&gt;<i> sslproxy_cert_error allow all
</I>&gt;&gt;<i> negative_ttl 0 seconds
</I>&gt;&gt;<i> negative_dns_ttl 1 second
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> # Leave coredumps in the first cache dir
</I>&gt;&gt;<i> coredump_dir /var/log/dump/squid
</I>&gt;&gt;<i>
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> /udhayakumar.
</I>&gt;&gt;<i>
</I>&gt;&gt;<i> _______________________________________________
</I>&gt;&gt;<i> squid-users mailing list
</I>&gt;&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">https://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">https://lists.squid-cache.org/listinfo/squid-users</A>
</I>
</PRE>







<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="027426.html">[squid-users] bypassing the domains
</A></li>
	<LI>Next message (by thread): <A HREF="027431.html">[squid-users] test ICAP server
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27428">[ date ]</a>
              <a href="thread.html#27428">[ thread ]</a>
              <a href="subject.html#27428">[ subject ]</a>
              <a href="author.html#27428">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
