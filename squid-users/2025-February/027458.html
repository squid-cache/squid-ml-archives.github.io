<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] ssl-bump with url_regex [SOLVED]
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20ssl-bump%20with%20url_regex%20%5BSOLVED%5D&In-Reply-To=%3Ca1a245b79e594054b73a7ab99bffb142%40ecritel.net%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="027457.html">
   <LINK REL="Next"  HREF="027460.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] ssl-bump with url_regex [SOLVED]</H1>
    <B>BOISIAUD Jean-Yves</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20ssl-bump%20with%20url_regex%20%5BSOLVED%5D&In-Reply-To=%3Ca1a245b79e594054b73a7ab99bffb142%40ecritel.net%3E"
       TITLE="[squid-users] ssl-bump with url_regex [SOLVED]">jyboisiaud-ext at ecritel.net
       </A><BR>
    <I>Mon Feb 24 17:22:36 UTC 2025</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="027457.html">[squid-users] ssl-bump with url_regex
</A></li>
        <LI>Next message (by thread): <A HREF="027460.html">[squid-users] ssl-bump with url_regex [SOLVED]
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27458">[ date ]</a>
              <a href="thread.html#27458">[ thread ]</a>
              <a href="subject.html#27458">[ subject ]</a>
              <a href="author.html#27458">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Solution:


It is the error message 'TCP_DENIED/200 0 CONNECT' wich showed me the way.


Directive is too restrictive:

http_access deny CONNECT !SSL_ports

It works now with:
http_access allow CONNECT safe_ports

where safe ports are:
80, 443, 1025-65535 (maybe too large)

________________________________
De : squid-users &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>&gt; de la part de BOISIAUD Jean-Yves &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">jyboisiaud-ext at ecritel.net</A>&gt;
Envoy&#233; : lundi 24 f&#233;vrier 2025 16:38
&#192; : <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
Objet : [squid-users] ssl-bump with url_regex


Hello,


I am using Squid 5.7 on a Debian 12 system.


I would like to grant only some given URL path for a site using HTTPS.


For example, in the following configuration:

...

http_port 3128 ssl-bump tcpkeepalive=60,30,3 \
    cert=/etc/squid/certs/signingCA.crt \
    key=/etc/squid/certs/signingCA.key \
    tls-cafile=/etc/squid/certs/chain.pem \
    generate-host-certificates=on \
    dynamic_cert_mem_cache_size=20MB \
    cipher=HIGH:MEDIUM:!LOW:!RC4:!SEED:!IDEA:!3DES:!MD5:!EXP:!PSK:!DSS \
    options=NO_TLSv1,NO_SSLv3 \
    tls-dh=prime256v1:/etc/squid/certs/dhparam.pem


acl intermediate_fetching transaction_initiator certificate-fetching

acl SSLBumpSites ssl::server_name www.example.com&lt;<A HREF="http://www.example.com">http://www.example.com</A>&gt;

acl server src 192.168.1.1

acl path urlpath_regex ^/valid_path/$

...

http_access allow  src path

...

ssl_bump peek all
ssl_bump bump SSLBumpSites
ssl_bump slice all

http_access deny all

cache deny all

Works with http (curl <A HREF="http://www.example.com/valid_path/">http://www.example.com/valid_path/</A>):
- TCP_MISS/200 467686 GET <A HREF="http://www.example.com/valid_path/">http://www.example.com/valid_path/</A> - HIER_DIRECT/151.101.122.132

Does not work with HTTPS (curl <A HREF="https://www.example.com/valid_path/">https://www.example.com/valid_path/</A>):
- TCP_DENIED/200 0 CONNECT www.example.com:443 - HIER_NONE/- - bump
- NONE_NONE/403 3894 GET <A HREF="https://www.example.com/valid_path/">https://www.example.com/valid_path/</A> - HIER_NONE/- text/html -

Other https requests work fine:

- TCP_TUNNEL/200 - splice


What is wrong in my configuration ?


Thank you for your help.
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20250224/8c1e0b97/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20250224/8c1e0b97/attachment.htm</A>&gt;
</PRE>










<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="027457.html">[squid-users] ssl-bump with url_regex
</A></li>
	<LI>Next message (by thread): <A HREF="027460.html">[squid-users] ssl-bump with url_regex [SOLVED]
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27458">[ date ]</a>
              <a href="thread.html#27458">[ thread ]</a>
              <a href="subject.html#27458">[ subject ]</a>
              <a href="author.html#27458">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
