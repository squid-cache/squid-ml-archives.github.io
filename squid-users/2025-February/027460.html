<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] ssl-bump with url_regex [SOLVED]
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20ssl-bump%20with%20url_regex%20%5BSOLVED%5D&In-Reply-To=%3C3b912f4d-33ab-470a-9bc3-bbb8865f1415%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="027458.html">
   <LINK REL="Next"  HREF="027461.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] ssl-bump with url_regex [SOLVED]</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20ssl-bump%20with%20url_regex%20%5BSOLVED%5D&In-Reply-To=%3C3b912f4d-33ab-470a-9bc3-bbb8865f1415%40treenet.co.nz%3E"
       TITLE="[squid-users] ssl-bump with url_regex [SOLVED]">squid3 at treenet.co.nz
       </A><BR>
    <I>Mon Feb 24 20:30:38 UTC 2025</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="027458.html">[squid-users] ssl-bump with url_regex [SOLVED]
</A></li>
        <LI>Next message (by thread): <A HREF="027461.html">[squid-users] Squid 7.0.1 BETA is available
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27460">[ date ]</a>
              <a href="thread.html#27460">[ thread ]</a>
              <a href="subject.html#27460">[ subject ]</a>
              <a href="author.html#27460">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>I do not think this solution is correct.

The SSL_Ports ACL should already contain &quot;443&quot;. So the traffic was 
**not** being blocked by this line:
   &quot;deny CONNECT !SSL_Ports&quot;


AFAICS the lack of URL-path details on the CONNECT request was failing 
to match the urlpath_regex ACL.

FYI;

While most of the time we think of Squid access controls as boolean 
conditions, they actually have a tri-state logic (allow, deny, skip).


One option here instead of requiring that path to exist (allow X), is to 
reject invalid paths (deny !X). Like so:

   http_access deny src !path

.. in which case the other access controls later will handle the CONNECT 
requests.


Another option is to allow all CONNECT attempts from the given client. 
Like this:

   http_access deny CONNECT !Safe_ports
   http_access allow CONNECT src

.. in which case you rely on the ssl_bump rules to correctly handle the 
CONNECT, and http_access to correctly handle the decrypted traffic.



Amos


On 25/02/25 06:22, BOISIAUD Jean-Yves wrote:
&gt;<i> Solution:
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> It is the error message 'TCP_DENIED/200 0 CONNECT' wich showed me the way.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Directive&#160;is too restrictive:
</I>&gt;<i> 
</I>&gt;<i> http_access deny CONNECT !SSL_ports
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> It works now with:
</I>&gt;<i> http_access allow CONNECT safe_ports
</I>&gt;<i> 
</I>&gt;<i> where safe ports are:
</I>&gt;<i> 80, 443, 1025-65535 (maybe too large)
</I>&gt;<i> 
</I>&gt;<i> ------------------------------------------------------------------------
</I>&gt;<i> *De :* squid-users &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users-bounces at lists.squid-cache.org</A>&gt; de la 
</I>&gt;<i> part de BOISIAUD Jean-Yves &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">jyboisiaud-ext at ecritel.net</A>&gt;
</I>&gt;<i> *Envoy&#233; :* lundi 24 f&#233;vrier 2025 16:38
</I>&gt;<i> *&#192; :* <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> *Objet :* [squid-users] ssl-bump with url_regex
</I>&gt;<i> 
</I>&gt;<i> Hello,
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> I am using Squid 5.7 on a Debian 12 system.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> I would like to grant only some given URL path for a site using HTTPS.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> For example, in the following configuration:
</I>&gt;<i> 
</I>&gt;<i> ...
</I>&gt;<i> 
</I>&gt;<i> http_port 3128 ssl-bump tcpkeepalive=60,30,3 \
</I>&gt;<i>  &#160;&#160;&#160; cert=/etc/squid/certs/signingCA.crt \
</I>&gt;<i>  &#160;&#160;&#160; key=/etc/squid/certs/signingCA.key \
</I>&gt;<i>  &#160;&#160;&#160; tls-cafile=/etc/squid/certs/chain.pem \
</I>&gt;<i>  &#160;&#160;&#160; generate-host-certificates=on \
</I>&gt;<i>  &#160;&#160;&#160; dynamic_cert_mem_cache_size=20MB \
</I>&gt;<i>  &#160;&#160;&#160; cipher=HIGH:MEDIUM:!LOW:!RC4:!SEED:!IDEA:!3DES:!MD5:!EXP:!PSK:!DSS \
</I>&gt;<i>  &#160;&#160;&#160; options=NO_TLSv1,NO_SSLv3 \
</I>&gt;<i>  &#160;&#160;&#160; tls-dh=prime256v1:/etc/squid/certs/dhparam.pem
</I>&gt;<i> 
</I>&gt;<i> acl intermediate_fetching transaction_initiator certificate-fetching
</I>&gt;<i> 
</I>&gt;<i> acl SSLBumpSites ssl::server_name www.example.com &lt;<A HREF="http://www.example.com">http://www.example.com</A>&gt;
</I>&gt;<i> 
</I>&gt;<i> acl server src 192.168.1.1
</I>&gt;<i> 
</I>&gt;<i> acl path urlpath_regex ^/valid_path/$
</I>&gt;<i> 
</I>&gt;<i> ...
</I>&gt;<i> 
</I>&gt;<i> http_access allow&#160;&#160;src path
</I>&gt;<i> 
</I>&gt;<i> ...
</I>&gt;<i> 
</I>&gt;<i> ssl_bump peek all
</I>&gt;<i> ssl_bump bump SSLBumpSites
</I>&gt;<i> ssl_bump slice all
</I>&gt;<i> 
</I>&gt;<i> http_access deny all
</I>&gt;<i> 
</I>&gt;<i> cache deny all
</I>&gt;<i> 
</I>&gt;<i> Works with http (curl <A HREF="http://www.example.com">http://www.example.com</A> &lt;<A HREF="http://www.example.com">http://www.example.com</A>&gt;/ 
</I>&gt;<i> valid_path/):
</I>&gt;<i> - TCP_MISS/200 467686 GET <A HREF="http://www.example.com/valid_path/">http://www.example.com/valid_path/</A> - 
</I>&gt;<i> HIER_DIRECT/151.101.122.132
</I>&gt;<i> 
</I>&gt;<i> Does not work with HTTPS (curl <A HREF="https://www.example.com/valid_path/">https://www.example.com/valid_path/</A> 
</I>&gt;<i> &lt;<A HREF="https://www.example.com/valid_path/">https://www.example.com/valid_path/</A>&gt;):
</I>&gt;<i> - TCP_DENIED/200 0 CONNECT www.example.com:443 - HIER_NONE/- - bump
</I>&gt;<i> - NONE_NONE/403 3894 GET <A HREF="https://www.example.com/valid_path/">https://www.example.com/valid_path/</A> - 
</I>&gt;<i> HIER_NONE/- text/html -
</I>&gt;<i> 
</I>&gt;<i> Other https requests work fine:
</I>&gt;<i> 
</I>&gt;<i> - TCP_TUNNEL/200 - splice
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> What is wrong in my configuration ?
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> Thank you for your help.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> _______________________________________________
</I>&gt;<i> squid-users mailing list
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i> <A HREF="https://lists.squid-cache.org/listinfo/squid-users">https://lists.squid-cache.org/listinfo/squid-users</A>
</I>
</PRE>









<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="027458.html">[squid-users] ssl-bump with url_regex [SOLVED]
</A></li>
	<LI>Next message (by thread): <A HREF="027461.html">[squid-users] Squid 7.0.1 BETA is available
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27460">[ date ]</a>
              <a href="thread.html#27460">[ thread ]</a>
              <a href="subject.html#27460">[ subject ]</a>
              <a href="author.html#27460">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
