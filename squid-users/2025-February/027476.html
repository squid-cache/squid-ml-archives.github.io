<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Need clarifications on custom log timestamps
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Need%20clarifications%20on%20custom%20log%20timestamps&In-Reply-To=%3C18d7623a-dd1f-444a-b08c-3e3c6b7f1e70%40measurement-factory.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="027477.html">
   <LINK REL="Next"  HREF="027442.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Need clarifications on custom log timestamps</H1>
    <B>Alex Rousskov</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Need%20clarifications%20on%20custom%20log%20timestamps&In-Reply-To=%3C18d7623a-dd1f-444a-b08c-3e3c6b7f1e70%40measurement-factory.com%3E"
       TITLE="[squid-users] Need clarifications on custom log timestamps">rousskov at measurement-factory.com
       </A><BR>
    <I>Wed Feb 26 16:06:35 UTC 2025</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="027477.html">[squid-users] Need clarifications on custom log timestamps
</A></li>
        <LI>Next message (by thread): <A HREF="027442.html">[squid-users] Authentication of Domain PC
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27476">[ date ]</a>
              <a href="thread.html#27476">[ thread ]</a>
              <a href="subject.html#27476">[ subject ]</a>
              <a href="author.html#27476">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 2025-02-25 06:33, BENJAMIN DELANNOY wrote:
&gt;<i>  &gt; Please detail what you mean by &quot;choice&quot; or &quot;decision&quot;. For example, do
</I>&gt;&gt;<i> you want to stop the timer when Squid makes its final http_access decision?
</I>&gt;<i> 
</I>&gt;<i> I want to monitor the latency on what I could manage : the 
</I>&gt;<i> communication between client &amp; squid, the time squid uses to process 
</I>&gt;<i> requests. But not the time spent by the destination server as I don't 
</I>&gt;<i> manage it.
</I>

Just to clarify why I keep asking about specifics: I believe I 
understand your overall goals, but to offer a specific solution, those 
high-level goals needs to be distilled into something Squid can measure.


&gt;<i> This could be multiple monitors if 1 is too complicated or not possible. 
</I>&gt;<i> So yes for example a timer that stop when Squid makes its 
</I>&gt;<i> final&#160;http_access decision (in case of http or bumped https) or its 
</I>&gt;<i> final ssl_bump splice decision.
</I>
Today, Squid does not record the time when those events happen, but 
there is work in progress to add the necessary framework. You can 
approximate those times by appending an external always-matching ACL 
(that would report current time in the form of transaction annotation 
that can be logged). Here is a rough sketch for http_access case:

     # external ACL that returns access_decision_time_=time annotation
     external_acl_type AccessDecisionTimeRecorder ...
     acl recordAccessDecisionTime external AccessDecisionTimeRecorder

     # recordAccessDecisionTime appended to all http_access rules
     http_access allow ... recordAccessDecisionTime
     http_access deny all recordAccessDecisionTime

     logformat myAccessLogRecordFormat ... %note{access_decision_time_}
     access_log ... logformat=myAccessLogRecordFormat

The same approach can be used for ssl_bump rules.

However, this is not pretty (i.e. this workaround is clearly bad UX), 
and I the precision of that solution may not be high enough for your 
needs (external ACLs will add at least a few milliseconds of delays). We 
need to (and will) do better!

<A HREF="https://wiki.squid-cache.org/SquidFaq/AboutSquid#how-to-add-a-new-squid-feature-enhance-of-fix-something">https://wiki.squid-cache.org/SquidFaq/AboutSquid#how-to-add-a-new-squid-feature-enhance-of-fix-something</A>


HTH,

Alex.



&gt;<i> On Wed, Feb 19, 2025 at 5:39&#8239;PM Alex Rousskov wrote:
</I>&gt;<i> 
</I>&gt;<i>     On 2025-02-19 06:26, BENJAMIN DELANNOY wrote:
</I>&gt;<i> 
</I>&gt;<i>      &gt; For %&lt;pt : &quot;The timer starts when the last request byte is sent
</I>&gt;<i>     to the
</I>&gt;<i>      &gt; next hop and stops when the last response byte is received.&quot;&#160; Are we
</I>&gt;<i>      &gt; talking of last request / last response of a single TCP
</I>&gt;<i>     connection on
</I>&gt;<i>      &gt; server side ?
</I>&gt;<i> 
</I>&gt;<i>     I believe the short answer is &quot;no&quot;: If Squid uses multiple TCP
</I>&gt;<i>     Squid-peer connections to forward a single client request, then the
</I>&gt;<i>     last
</I>&gt;<i>     connection used for that request forwarding should determine overall
</I>&gt;<i>     transaction outcome and %&lt;pt values in access.log.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i>      &gt; Do we agree that we are purely talking about
</I>&gt;<i>      &gt; request/response on HTTP, and thus this time does not take into
</I>&gt;<i>     account
</I>&gt;<i>      &gt; the time spent with SSL negotiation&#160;/ squid actions before ?
</I>&gt;<i> 
</I>&gt;<i>     I believe the short answer is &quot;yes&quot;: Today, %&lt;pt timer starts after the
</I>&gt;<i>     HTTP (or FTP) request is written to the peer, so TLS handshake (if any)
</I>&gt;<i>     would happen before that timer starts. AFAIK, Squid does not support
</I>&gt;<i>     0-RTT TLS.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i>      &gt; For %&lt;tt : I understand that all the time spent&#160;sending&#160;requests &amp;
</I>&gt;<i>      &gt; waiting responses from the Origin are added. It would also means
</I>&gt;<i>     that if
</I>&gt;<i>      &gt; I subtract this timer to %tr, I would have only the ClientSide time
</I>&gt;<i>      &gt; before first packet is sent to Origin by the squid &amp; after the last
</I>&gt;<i>      &gt; packet is received from the Origin ?
</I>&gt;<i> 
</I>&gt;<i>     Yes, but &quot;before&quot; and &quot;after&quot; can be misleading here (in general)
</I>&gt;<i>     because there may be periods of time when Squid is _not_ talking to a
</I>&gt;<i>     peer but is working on what you call &quot;ClientSide&quot;. For example,
</I>&gt;<i>     there is
</I>&gt;<i>     code that decides whether to revalidate a received peer response. From
</I>&gt;<i>     Squid point of view, that code runs on &quot;ClientSide&quot; -- %&lt;tt timers may
</I>&gt;<i>     be stopped when that code runs. Since you are not caching, that
</I>&gt;<i>     particular code is not relevant to you.
</I>&gt;<i> 
</I>&gt;<i>     Also, please keep in mind that a slow client may effectively stall
</I>&gt;<i>     Squid-to-peer I/O by not consuming response data fast enough, filling
</I>&gt;<i>     Squid response buffers (see read_ahead_gap). If one only looks at
</I>&gt;<i>     &quot;%tr -
</I>&gt;<i>     %&lt;tt&quot; difference in such cases, one would observe near-0 values and may
</I>&gt;<i>     mistakenly conclude that the slow client is super fast!
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i>      &gt; Actually, what I want&#160;to monitor, is the time between the first
</I>&gt;<i>     client
</I>&gt;<i>      &gt; packet received on the Squid and the time the squid makes its
</I>&gt;<i>     choice :
</I>&gt;<i>      &gt; - based on SNI for SSL Splice
</I>&gt;<i>      &gt; - based on HTTP ACL (HTTP traffic or HTTPS traffic with SSL Bump)
</I>&gt;<i>      &gt; Based on this, I would be able to check if a squid server is
</I>&gt;<i>     taking too
</I>&gt;<i>      &gt; much time making a decision.
</I>&gt;<i>      &gt;
</I>&gt;<i>      &gt; Is this something feasible?
</I>&gt;<i> 
</I>&gt;<i>     Please detail what you mean by &quot;choice&quot; or &quot;decision&quot;. For example, do
</I>&gt;<i>     you want to stop the timer when Squid makes its final http_access
</I>&gt;<i>     decision?
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i>     Thank you,
</I>&gt;<i> 
</I>&gt;<i>     Alex.
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i>      &gt; On Mon, Feb 17, 2025 at 4:47&#8239;PM Alex Rousskov wrote:
</I>&gt;<i>      &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160;On 2025-02-17 10:02, BENJAMIN DELANNOY wrote:
</I>&gt;<i>      &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt; I try to figure out what is exactly measured with the &lt;pt
</I>&gt;<i>     &amp; &lt;tt
</I>&gt;<i>      &gt;&#160; &#160; &#160;timings.
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt; I don't get what are the difference between them, what is the
</I>&gt;<i>      &gt;&#160; &#160; &#160;difference
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt; between &quot;peer response time&quot; &amp; &quot;time spent forwarding to
</I>&gt;<i>     origin
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt; servers&quot;,
</I>&gt;<i>      &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160;Have you seen %&lt;pt and %&lt;tt descriptions at [1]? %&lt;tt
</I>&gt;<i>     description was
</I>&gt;<i>      &gt;&#160; &#160; &#160;updated in August 2024, and squid.conf.documented in Squid v6 and
</I>&gt;<i>      &gt;&#160; &#160; &#160;earlier does not have those documentation updates (and the
</I>&gt;<i>      &gt;&#160; &#160; &#160;corresponding
</I>&gt;<i>      &gt;&#160; &#160; &#160;bug fixes)...
</I>&gt;<i>      &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160;[1] <A HREF="http://www.squid-cache.org/Doc/config/logformat/">http://www.squid-cache.org/Doc/config/logformat/</A>
</I>&gt;<i>     &lt;<A HREF="http://www.squid-cache.org/Doc/config/logformat/">http://www.squid-cache.org/Doc/config/logformat/</A>&gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160;&lt;<A HREF="http://www.squid-cache.org/Doc/config/logformat/">http://www.squid-cache.org/Doc/config/logformat/</A>
</I>&gt;<i>     &lt;<A HREF="http://www.squid-cache.org/Doc/config/logformat/">http://www.squid-cache.org/Doc/config/logformat/</A>&gt;&gt;
</I>&gt;<i>      &gt;
</I>&gt;<i>      &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt; what is the &quot;last I/O with the last peer&quot;, etc.
</I>&gt;<i>      &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160;When forwarding a single client request, Squid may talk to
</I>&gt;<i>     multiple
</I>&gt;<i>      &gt;&#160; &#160; &#160;cache_peer and origin server addresses (collectively called
</I>&gt;<i>     &quot;peers&quot;).
</I>&gt;<i>      &gt;&#160; &#160; &#160;Talking to a given peer may include multiple socket reading
</I>&gt;<i>     and writing
</I>&gt;<i>      &gt;&#160; &#160; &#160;(i.e. I/O) events. Does this clarify?
</I>&gt;<i>      &gt;
</I>&gt;<i>      &gt;
</I>&gt;<i>      &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt; For information, I aim to calculate the time spent on the
</I>&gt;<i>      &gt;&#160; &#160; &#160;client-side &amp;
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt; by squid processing time,&#160; excluding the server-side time
</I>&gt;<i>     spent
</I>&gt;<i>      &gt;&#160; &#160; &#160;(=what I
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt; don't manage).
</I>&gt;<i>      &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160;This kind of calculation is a common need. Please keep in
</I>&gt;<i>     mind that
</I>&gt;<i>      &gt;&#160; &#160; &#160;Squid may spend time on the client side (e.g., awaiting the next
</I>&gt;<i>      &gt;&#160; &#160; &#160;request
</I>&gt;<i>      &gt;&#160; &#160; &#160;body byte) while also spending time on the server side (e.g.,
</I>&gt;<i>     awaiting
</I>&gt;<i>      &gt;&#160; &#160; &#160;the next response body byte), complicating things.
</I>&gt;<i>      &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160;If existing %codes are not enough, please detail your needs
</I>&gt;<i>     in terms of
</I>&gt;<i>      &gt;&#160; &#160; &#160;events that Squid can recognize (e.g., receiving the first
</I>&gt;<i>     response
</I>&gt;<i>      &gt;&#160; &#160; &#160;header byte or sending the last request body byte).
</I>&gt;<i>      &gt;
</I>&gt;<i>      &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160;HTH,
</I>&gt;<i>      &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160;Alex.
</I>&gt;<i>      &gt;
</I>&gt;<i>      &gt;
</I>&gt;<i>      &gt;
</I>&gt;<i>      &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt; We do not use squid for caching but only for http &amp; ssl
</I>&gt;<i>      &gt;&#160; &#160; &#160;proxy/filtering.
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt; Thanks a lot !
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt; Cordialement, Regards,
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt; Benjamin DELANNOY
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt; Cloud Network Engineer
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt; NETWORK SOLUTIONS - GTDP
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt; Mobile +33 (0)6 16 98 23 72
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt; 135 rue Sadi Carnot &#8226; CS 00001 &#8226; 59790 Ronchin &#8226; FRANCE
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt; positivetech.adeo.com &lt;<A HREF="http://positivetech.adeo.com">http://positivetech.adeo.com</A>&gt;
</I>&gt;<i>     &lt;<A HREF="http://positivetech.adeo.com">http://positivetech.adeo.com</A> &lt;<A HREF="http://positivetech.adeo.com">http://positivetech.adeo.com</A>&gt;&gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160;&lt;<A HREF="https://positivetech.adeo.com/">https://positivetech.adeo.com/</A>
</I>&gt;<i>     &lt;<A HREF="https://positivetech.adeo.com/">https://positivetech.adeo.com/</A>&gt; &lt;<A HREF="https://positivetech.adeo.com/">https://positivetech.adeo.com/</A>
</I>&gt;<i>     &lt;<A HREF="https://positivetech.adeo.com/">https://positivetech.adeo.com/</A>&gt;&gt;&gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt; adeolinkedin &lt;<A HREF="https://www.linkedin.com/company/groupe-adeo">https://www.linkedin.com/company/groupe-adeo</A>
</I>&gt;<i>     &lt;<A HREF="https://www.linkedin.com/company/groupe-adeo">https://www.linkedin.com/company/groupe-adeo</A>&gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160;&lt;<A HREF="https://www.linkedin.com/company/groupe-adeo">https://www.linkedin.com/company/groupe-adeo</A>
</I>&gt;<i>     &lt;<A HREF="https://www.linkedin.com/company/groupe-adeo">https://www.linkedin.com/company/groupe-adeo</A>&gt;&gt;&gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt; _______________________________________________
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt; squid-users mailing list
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt; <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i>     &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>&gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160;&lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i>     &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>&gt;&gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160; &gt; <A HREF="https://lists.squid-cache.org/listinfo/squid-users">https://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i>     &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">https://lists.squid-cache.org/listinfo/squid-users</A>&gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160;&lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">https://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i>     &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">https://lists.squid-cache.org/listinfo/squid-users</A>&gt;&gt;
</I>&gt;<i>      &gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160;_______________________________________________
</I>&gt;<i>      &gt;&#160; &#160; &#160;squid-users mailing list
</I>&gt;<i>      &gt; <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i>     &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>&gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160;&lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
</I>&gt;<i>     &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>&gt;&gt;
</I>&gt;<i>      &gt; <A HREF="https://lists.squid-cache.org/listinfo/squid-users">https://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i>     &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">https://lists.squid-cache.org/listinfo/squid-users</A>&gt;
</I>&gt;<i>      &gt;&#160; &#160; &#160;&lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">https://lists.squid-cache.org/listinfo/squid-users</A>
</I>&gt;<i>     &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">https://lists.squid-cache.org/listinfo/squid-users</A>&gt;&gt;
</I>&gt;<i>      &gt;
</I>&gt;<i> 
</I>
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="027477.html">[squid-users] Need clarifications on custom log timestamps
</A></li>
	<LI>Next message (by thread): <A HREF="027442.html">[squid-users] Authentication of Domain PC
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27476">[ date ]</a>
              <a href="thread.html#27476">[ thread ]</a>
              <a href="subject.html#27476">[ subject ]</a>
              <a href="author.html#27476">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
