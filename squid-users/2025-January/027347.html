<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Assistance Needed for Kerberos Authentication with AD Group-Based ACLs in Squid
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Assistance%20Needed%20for%20Kerberos%20Authentication%20with%20AD%0A%20Group-Based%20ACLs%20in%20Squid&In-Reply-To=%3CPAWPR03MB9010BC03BDA24EC5A47FCDF1F40B2%40PAWPR03MB9010.eurprd03.prod.outlook.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="027352.html">
   <LINK REL="Next"  HREF="027350.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Assistance Needed for Kerberos Authentication with AD Group-Based ACLs in Squid</H1>
    <B>Enfal Gok</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Assistance%20Needed%20for%20Kerberos%20Authentication%20with%20AD%0A%20Group-Based%20ACLs%20in%20Squid&In-Reply-To=%3CPAWPR03MB9010BC03BDA24EC5A47FCDF1F40B2%40PAWPR03MB9010.eurprd03.prod.outlook.com%3E"
       TITLE="[squid-users] Assistance Needed for Kerberos Authentication with AD Group-Based ACLs in Squid">enfal.gok2004 at gmail.com
       </A><BR>
    <I>Wed Jan  1 10:34:39 UTC 2025</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="027352.html">[squid-users] StoreID Question
</A></li>
        <LI>Next message (by thread): <A HREF="027350.html">[squid-users] Assistance Needed for Kerberos Authentication with AD Group-Based ACLs in Squid
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27347">[ date ]</a>
              <a href="thread.html#27347">[ thread ]</a>
              <a href="subject.html#27347">[ subject ]</a>
              <a href="author.html#27347">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Dear Squid Support Team,
I am currently configuring Squid to use Kerberos authentication with Active Directory (AD) group-based access control, but I am encountering an issue where the ACLs for AD groups are not being applied correctly. Below are the details of my setup and the challenges I am facing:
Setup Details:

  1.
Kerberos:
     *   Kerberos authentication is working successfully.
     *   The service principal and keytab are correctly configured, and the kinit command works as expected.
  2.
LDAP:
     *   LDAP connectivity is functional. I can successfully query the Active Directory using ldapsearch:

ldapsearch -x -H <A HREF="ldap://172.16.10.254">ldap://172.16.10.254</A> -D &quot;CN=Administrator,CN=Users,DC=demo,DC=local&quot; -w Passw0rd -b &quot;DC=demo,DC=local&quot; &quot;(sAMAccountName=jon.jones)&quot;


     *   The output includes the correct memberof attributes showing the user's group memberships.
  3.
Squid Configuration:
I have configured Squid for LDAP group-based access control as follows:

external_acl_type ldap_group %LOGIN /usr/lib/squid/ext_ldap_group_acl -R \
    -b &quot;DC=demo,DC=local&quot; \
    -D &quot;CN=Administrator,CN=Users,DC=demo,DC=local&quot; \
    -w Passw0rd \
    -f &quot;(&amp;(objectclass=person)(sAMAccountName=%v)(memberof=CN=%a,CN=Users,DC=demo,DC=local))&quot; \
    -h 172.16.10.254

acl FullAccess external ldap_group FullAccess
acl Restricted external ldap_group Restricted
acl Filtered external ldap_group Filtered
acl Blocked external ldap_group Blocked

http_access deny Blocked
http_access allow FullAccess
http_access allow Restricted allowed_sites
http_access deny Restricted
http_access deny Filtered bad_sites
http_access allow Filtered
http_access deny all


  4.
What Works:
     *   Kerberos authentication is functioning as expected.
     *   The ext_ldap_group_acl utility works correctly when tested manually:

echo &quot;jon.jones FullAccess&quot; | /usr/lib/squid/ext_ldap_group_acl -R \
    -b &quot;DC=demo,DC=local&quot; \
    -D &quot;CN=Administrator,CN=Users,DC=demo,DC=local&quot; \
    -w Passw0rd \
    -f &quot;(&amp;(objectclass=person)(sAMAccountName=%v)(memberof=CN=%a,CN=Users,DC=demo,DC=local))&quot; \
    -h 172.16.10.254


The output returns OK, indicating that the LDAP group membership is correctly validated.
  5.
The Problem:
     *   When users authenticate via Kerberos, the Squid ACLs based on AD groups are not being matched.
     *   All users fall into the default http_access deny all rule, even if they belong to a permitted AD group.
  6.
Log Example:
In the cache.log file, I see the following entries:

WARNING: external_acl_type 'ldap_group' queue overload
...
Checklist.cc answer DENIED for match
...
setAuth: WARNING: Graceful closure on conn due to connection-auth erase from ConnStateData::SwanSong cleanup


Request for Assistance:

  *   How can I ensure that Squid properly applies AD group-based ACLs when users authenticate via Kerberos?
  *   Are there specific configurations or known limitations for combining Kerberos authentication with LDAP group validation in Squid?

I would greatly appreciate any guidance or suggestions to resolve this issue. If additional logs or details are needed, please let me know.
Thank you for your support!
Best regards,
Enfal gok

-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20250101/e6326390/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20250101/e6326390/attachment.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="027352.html">[squid-users] StoreID Question
</A></li>
	<LI>Next message (by thread): <A HREF="027350.html">[squid-users] Assistance Needed for Kerberos Authentication with AD Group-Based ACLs in Squid
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27347">[ date ]</a>
              <a href="thread.html#27347">[ thread ]</a>
              <a href="subject.html#27347">[ subject ]</a>
              <a href="author.html#27347">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
