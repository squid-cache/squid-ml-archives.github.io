<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Assistance Needed for Kerberos Authentication with AD Group-Based ACLs in Squid
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Assistance%20Needed%20for%20Kerberos%20Authentication%0A%20with%20AD%20Group-Based%20ACLs%20in%20Squid&In-Reply-To=%3Cf3288d79-0d5b-4ed6-9e82-a9dad641478c%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="027347.html">
   <LINK REL="Next"  HREF="027351.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Assistance Needed for Kerberos Authentication with AD Group-Based ACLs in Squid</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Assistance%20Needed%20for%20Kerberos%20Authentication%0A%20with%20AD%20Group-Based%20ACLs%20in%20Squid&In-Reply-To=%3Cf3288d79-0d5b-4ed6-9e82-a9dad641478c%40treenet.co.nz%3E"
       TITLE="[squid-users] Assistance Needed for Kerberos Authentication with AD Group-Based ACLs in Squid">squid3 at treenet.co.nz
       </A><BR>
    <I>Wed Jan  1 16:55:19 UTC 2025</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="027347.html">[squid-users] Assistance Needed for Kerberos Authentication with AD Group-Based ACLs in Squid
</A></li>
        <LI>Next message (by thread): <A HREF="027351.html">[squid-users] Assistance with Kerberos Authentication and AD Group-Based ACLs in Squid
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27350">[ date ]</a>
              <a href="thread.html#27350">[ thread ]</a>
              <a href="subject.html#27350">[ subject ]</a>
              <a href="author.html#27350">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 1/01/25 23:34, Enfal Gok wrote:
...
&gt;<i>     *The Problem:*
</I>&gt;<i>       * When users authenticate via Kerberos, the Squid ACLs based on AD
</I>&gt;<i>         groups are not being matched.
</I>&gt;<i>       * All users fall into the default |http_access deny all|&#160;rule,
</I>&gt;<i>         even if they belong to a permitted AD group.
</I>&gt;<i>  6.
</I>&gt;<i>     *Log Example:*
</I>&gt;<i>     In the |cache.log|&#160;file, I see the following entries:
</I>&gt;<i> 
</I>&gt;<i>     |WARNING: external_acl_type 'ldap_group' queue overload ...
</I>

You have more lookups being performed than the helper processes can 
handle. Either they are too slow or too many queries per second are 
happening.


First thing to do (quick workaround) is to expand how many helper 
processes are running, and how many queries they can have queued.

These are done with the &quot;children-max=&quot; option on external_acl_type 
lines. Since you have 4 ACLs sharing the helpers, IMO you should set 
that to a 4x the default. Expand as needed if the problem remains.

Avoid &quot;concurrency&quot; as the helper you are using does not (yet) support 
that. If anything, set it to &quot;0&quot; explicitly.



&gt;<i>     Checklist.cc answer DENIED for match ... setAuth: WARNING: Graceful
</I>&gt;<i>     closure on conn due to connection-auth erase from
</I>&gt;<i>     ConnStateData::SwanSong cleanup |
</I>&gt;<i> 
</I>&gt;<i> *Request for Assistance:*
</I>&gt;<i> 
</I>&gt;<i>   * How can I ensure that Squid properly applies AD group-based ACLs
</I>&gt;<i>     when users authenticate via Kerberos?
</I>
The ACL and http_access portions of your config look fine to me. At 
least for the LDAP_Group helper you are using.


If you can try to convert to the newer &quot;note ACL&quot; way of checking groups.

The latest of Kerberos negotiate_kerberos_auth helper should provide the 
&quot;group=&quot; annotations to Squid during the auth credentials check. Then 
you can replace the &quot;external&quot; type ACL with a &quot;note&quot; type, and drop the 
group lookup entirely.

Like so:
&quot;
   acl FullAccess note group SSID-of-FullAccess
   acl Restricted note group SSID-of-Restricted
   acl Filtered note group SSID-of-Filtered
   acl Blocked note group SSID-of-Blocked
&quot;

Where the SSID-of-XX are the values the auth helper produces for those 
groups.




&gt;<i>   * Are there specific configurations or known limitations for combining
</I>&gt;<i>     Kerberos authentication with LDAP group validation in Squid?
</I>&gt;<i> 
</I>
Big ones I know of are true for any use of helpers:
  * speed of the lookups,
  * resource overheads of using more processes,
  * HOL blocking for busy proxies.

Unfortunately LDAP group helper right now ticks all of those checkboxes 
for worst-case usage.



HTH
Amos

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="027347.html">[squid-users] Assistance Needed for Kerberos Authentication with AD Group-Based ACLs in Squid
</A></li>
	<LI>Next message (by thread): <A HREF="027351.html">[squid-users] Assistance with Kerberos Authentication and AD Group-Based ACLs in Squid
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27350">[ date ]</a>
              <a href="thread.html#27350">[ thread ]</a>
              <a href="subject.html#27350">[ subject ]</a>
              <a href="author.html#27350">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
