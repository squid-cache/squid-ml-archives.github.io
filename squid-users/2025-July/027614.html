<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] WCCP and SSL-Bump with Squid 3.5 &#8212; HTTPS traffic not reaching Squid
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20%3D%3Futf-8%3Fq%3FWCCP_and_SSL-Bump_with_Squid_3%3D2E5_%3F%3D%0A%09%3D%3Futf-8%3Fq%3F%3DE2%3D80%3D94_HTTPS_traffic_not_reaching_Squid%3F%3D&In-Reply-To=%3CCAELz2FYSDAYbDbucTnzigTmQjk8sAXR5qJExkxSA8cpdSzZ%2Bng%40mail.gmail.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="027622.html">
   <LINK REL="Next"  HREF="027615.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] WCCP and SSL-Bump with Squid 3.5 &#8212; HTTPS traffic not reaching Squid</H1>
    <B>MAB IT System</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20%3D%3Futf-8%3Fq%3FWCCP_and_SSL-Bump_with_Squid_3%3D2E5_%3F%3D%0A%09%3D%3Futf-8%3Fq%3F%3DE2%3D80%3D94_HTTPS_traffic_not_reaching_Squid%3F%3D&In-Reply-To=%3CCAELz2FYSDAYbDbucTnzigTmQjk8sAXR5qJExkxSA8cpdSzZ%2Bng%40mail.gmail.com%3E"
       TITLE="[squid-users] WCCP and SSL-Bump with Squid 3.5 &#8212; HTTPS traffic not reaching Squid">mab_itsystem at machaero.com
       </A><BR>
    <I>Tue Jul 22 12:48:09 UTC 2025</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="027622.html">[squid-users] make clean install issue with squid 7
</A></li>
        <LI>Next message (by thread): <A HREF="027615.html">[squid-users] WCCP and SSL-Bump with Squid 3.5 &#8212; HTTPS traffic not reaching Squid
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27614">[ date ]</a>
              <a href="thread.html#27614">[ thread ]</a>
              <a href="subject.html#27614">[ subject ]</a>
              <a href="author.html#27614">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello everyone,

I am currently deploying Squid 3.5.12 on Ubuntu Xenial for URL filtering
over multiple VLANs using WCCP.

*Context:*

   -

   HTTP traffic is successfully redirected from my Cisco router to Squid
   via WCCP (Service 0).
   -

   HTTPS traffic is redirected via WCCP (Service 70), GRE tunnel works,
   redirection appears fine on the router side.
   -

   On my Squid box, iptables properly redirects:
   -

      TCP 80 &#8594; 3127 (intercept)
      -

      TCP 443 &#8594; 3128 (ssl-bump)
      -

   My Squid config listens properly on 3127 and 3128 with ssl-bump.

*Problem:*

   -

   HTTP filtering works perfectly via WCCP.
   -

   HTTPS connections show *no traffic hitting Squid's 3128 port* (confirmed
   via access.log and ss -tulnp).
   -

   Yet WCCP router counters show packets being redirected for HTTPS.
   -

   If I manually configure the proxy on a browser, both HTTP and HTTPS are
   filtered correctly.
   -

   If I disable ssl-bump and WCCP for HTTPS, normal navigation resumes.

*iptables NAT rules:*

REDIRECT tcp -- gre1 * 0.0.0.0/0 0.0.0.0/0 tcp dpt:80 redir ports 3127
REDIRECT tcp -- gre1 * 0.0.0.0/0 0.0.0.0/0 tcp dpt:443 redir ports 3128

Squid config (extract):

  http_port 3127 intercept
http_port 3128 ssl-bump cert=/etc/squid/ssl_sert/myCA.pem
key=/etc/squid/ssl_sert/ca-key.pem generate-host-certificates=on
dynamic_cert_mem_cache_size=4MB
sslcrtd_program /usr/libexec/ssl_crtd -s /var/lib/ssl_db -M 4MB

acl step1 at_step SslBump1
ssl_bump peek step1
ssl_bump bump all

*Questions:*

   1.

   Why does HTTPS via WCCP not reach Squid 3128 (ssl-bump) while HTTP works
   fine?
   2.

   Is my WCCP setup wrong for HTTPS? I use service ID 70 with destination
   port 443.
   3.

   Could the lack of DNS resolution or browser certificate trust cause the
   traffic not to appear at all in Squid logs?
   4.

   Am I missing something obvious between the router WCCP and Squid&#8217;s
   ssl-bump setup?

Thank you in advance for any suggestions or troubleshooting steps.

Best regards,

Assoham

-- 
******************************************************************************
The information contained herein may be company confidential and 
proprietary. The information is intended only for the use of the named 
individual or entity. If you are not the intended recipient, the employee 
or agent responsible for delivering it to the intended recipient, you are 
hereby notified that any use, dissemination, distribution or copying of 
this communication is strictly prohibited. If you have received this 
communication in error, please notify the sender (and delete it from your 
systems) immediately. The information herein is not warranted to be free of 
virus or any other defect that may affect the recipient's computer system 
and it is your responsibility to carry out appropriate virus checks of this 
email and attachments (if any).
******************************************************************************
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20250722/c1bc018e/attachment.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20250722/c1bc018e/attachment.htm</A>&gt;
</PRE>









<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="027622.html">[squid-users] make clean install issue with squid 7
</A></li>
	<LI>Next message (by thread): <A HREF="027615.html">[squid-users] WCCP and SSL-Bump with Squid 3.5 &#8212; HTTPS traffic not reaching Squid
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27614">[ date ]</a>
              <a href="thread.html#27614">[ thread ]</a>
              <a href="subject.html#27614">[ subject ]</a>
              <a href="author.html#27614">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
