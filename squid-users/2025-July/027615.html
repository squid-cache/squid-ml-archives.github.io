<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] WCCP and SSL-Bump with Squid 3.5 &#8212; HTTPS traffic not reaching Squid
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20%3D%3Futf-8%3Fq%3FWCCP_and_SSL-Bump_with_Squid_3%3D2E5_%3F%3D%0A%20%3D%3Futf-8%3Fq%3F%3DE2%3D80%3D94_HTTPS_traffic_not_reaching_Squid%3F%3D&In-Reply-To=%3C4d29dfee-8447-4652-8181-b56b581038a7%40treenet.co.nz%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="027614.html">
   <LINK REL="Next"  HREF="027623.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] WCCP and SSL-Bump with Squid 3.5 &#8212; HTTPS traffic not reaching Squid</H1>
    <B>Amos Jeffries</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20%3D%3Futf-8%3Fq%3FWCCP_and_SSL-Bump_with_Squid_3%3D2E5_%3F%3D%0A%20%3D%3Futf-8%3Fq%3F%3DE2%3D80%3D94_HTTPS_traffic_not_reaching_Squid%3F%3D&In-Reply-To=%3C4d29dfee-8447-4652-8181-b56b581038a7%40treenet.co.nz%3E"
       TITLE="[squid-users] WCCP and SSL-Bump with Squid 3.5 &#8212; HTTPS traffic not reaching Squid">squid3 at treenet.co.nz
       </A><BR>
    <I>Tue Jul 22 14:24:31 UTC 2025</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="027614.html">[squid-users] WCCP and SSL-Bump with Squid 3.5 &#8212; HTTPS traffic not reaching Squid
</A></li>
        <LI>Next message (by thread): <A HREF="027623.html">[squid-users] Configuring multiple hosts in LDAP URIs and using DN
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27615">[ date ]</a>
              <a href="thread.html#27615">[ thread ]</a>
              <a href="subject.html#27615">[ subject ]</a>
              <a href="author.html#27615">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 23/07/25 00:48, MAB IT System wrote:
&gt;<i> Hello everyone,
</I>&gt;<i> 
</I>&gt;<i> I am currently deploying Squid 3.5.12 on Ubuntu Xenial for URL filtering 
</I>&gt;<i> over multiple VLANs using WCCP.
</I>&gt;<i> 
</I>
Please consider an upgrade. That versino of Squid has been out of 
support for many years now, and even your Ubuntu Xenial is nearing the 
end of their LTS.


&gt;<i> *Context:*
</I>&gt;<i> 
</I>&gt;<i>   *
</I>&gt;<i> 
</I>&gt;<i>     HTTP traffic is successfully redirected from my Cisco router to
</I>&gt;<i>     Squid via WCCP (Service 0).
</I>&gt;<i> 
</I>&gt;<i>   *
</I>&gt;<i> 
</I>&gt;<i>     HTTPS traffic is redirected via WCCP (Service 70), GRE tunnel works,
</I>&gt;<i>     redirection appears fine on the router side.
</I>&gt;<i> 
</I>
FWIW, I'm not sure if they need different services. WCCP is just a way 
to automatically manage routing of traffic towards Squid. Since both 
ports are going to the same proxy in theory they should just be diverted 
the same way.


&gt;<i>   *
</I>&gt;<i> 
</I>&gt;<i>     On my Squid box, iptables properly redirects:
</I>&gt;<i> 
</I>&gt;<i>       o
</I>&gt;<i> 
</I>&gt;<i>         TCP 80 &#8594; 3127 (intercept)
</I>&gt;<i> 
</I>&gt;<i>       o
</I>&gt;<i> 
</I>&gt;<i>         TCP 443 &#8594; 3128 (ssl-bump)
</I>&gt;<i> 
</I>

That should be &quot;intercept ssl-bump&quot; for NAT intercept + TLS handling


Please consider a different port than 3128 for the HTTPS traffic 
interception. It is a well-known port for Squid and has known malware 
attacks against broken intercept configurations.



&gt;<i> *Problem:*
</I>&gt;<i> 
</I>&gt;<i>   *
</I>&gt;<i> 
</I>&gt;<i>     HTTP filtering works perfectly via WCCP.
</I>&gt;<i> 
</I>&gt;<i>   *
</I>&gt;<i> 
</I>&gt;<i>     HTTPS connections show *no traffic hitting Squid's 3128 port*
</I>&gt;<i>     (confirmed via |access.log| and |ss -tulnp|).
</I>&gt;<i> 
</I>&gt;<i>   *
</I>&gt;<i> 
</I>&gt;<i>     Yet WCCP router counters show packets being redirected for HTTPS.
</I>&gt;<i> 
</I>
Are they making it out of the GRE tunnel so iptables can do its NAT thing?


&gt;<i>   *
</I>&gt;<i> 
</I>&gt;<i>     If I manually configure the proxy on a browser, both HTTP and HTTPS
</I>&gt;<i>     are filtered correctly.
</I>&gt;<i> 
</I>
That indicates that you are missing the required iptables mangle table 
rules to prevent direct connections from clients to your NAT intercept 
ports. That is a major security vulnerability (CVE-2009-0801).


&gt;<i>   *
</I>&gt;<i> 
</I>&gt;<i>     If I disable ssl-bump and WCCP for HTTPS, normal navigation resumes.
</I>&gt;<i> 
</I>&gt;<i> *iptables NAT rules:*
</I>&gt;<i> 
</I>&gt;<i> REDIRECT tcp -- gre1 * 0.0.0.0/0 0.0.0.0/0 tcp dpt:80 redir ports 3127
</I>&gt;<i> REDIRECT tcp -- gre1 * 0.0.0.0/0 0.0.0.0/0 tcp dpt:443 redir ports 3128
</I>&gt;<i> 
</I>
This is not iptables interface syntax, looks like a management tool.
What do these columns mean?


You also seem to be missing MASQUERADE rules to handle the return 
packets SYN+ACK etc. This makes it odd that HTTP was working.



&gt;<i> Squid config (extract):
</I>&gt;<i> 
</I>&gt;<i>  &#160; http_port 3127 intercept
</I>&gt;<i> 
</I>&gt;<i> http_port 3128 ssl-bump cert=/etc/squid/ssl_sert/myCA.pem key=/etc/ 
</I>&gt;<i> squid/ssl_sert/ca-key.pem generate-host-certificates=on 
</I>&gt;<i> dynamic_cert_mem_cache_size=4MB
</I>&gt;<i> sslcrtd_program /usr/libexec/ssl_crtd -s /var/lib/ssl_db -M 4MB
</I>&gt;<i> 
</I>&gt;<i> acl step1 at_step SslBump1
</I>&gt;<i> ssl_bump peek step1
</I>&gt;<i> ssl_bump bump all
</I>&gt;<i> 
</I>
FYI, bump at step2 is quite dangerous. Prefer doing peek-stare-bump for 
the relevant steps 1-2-3. With a whitelist doing splice at step 2 or 3 
for things that you find cannot be bumped.

   acl whitelist ssl_server_name ...
   acl step1 at_step SslBump1
   acl step2 at_step SslBump2

   ssl_bump peek step1
   ssl_bump splice whitelist
   ssl_bump stare step2
   ssl_bump bump all



&gt;<i> *Questions:*
</I>&gt;<i> 
</I>&gt;<i>  1.
</I>&gt;<i> 
</I>&gt;<i>     Why does HTTPS via WCCP not reach Squid 3128 (ssl-bump) while HTTP
</I>&gt;<i>     works fine?
</I>&gt;<i> 
</I>
Insufficient details. You will have to do packet traces of what is going 
to through the GRE interface to answer that.


&gt;<i>  2.
</I>&gt;<i> 
</I>&gt;<i>     Is my WCCP setup wrong for HTTPS? I use service ID 70 with
</I>&gt;<i>     destination port 443.
</I>&gt;<i> 
</I>
See above. If WCCP is sending the port 443 packets through GRE it is 
fine. If not, then something is broken there.

Though from what you said it seems like the packets are going missing 
somewhere before/after the GRE tunnel.


&gt;<i>  3.
</I>&gt;<i> 
</I>&gt;<i>     Could the lack of DNS resolution or browser certificate trust cause
</I>&gt;<i>     the traffic not to appear at all in Squid logs?
</I>&gt;<i> 
</I>
No. In these cases, Squid would still receive the traffic and log errors.


&gt;<i>  4.
</I>&gt;<i> 
</I>&gt;<i>     Am I missing something obvious between the router WCCP and Squid&#8217;s
</I>&gt;<i>     ssl-bump setup?
</I>&gt;<i> 
</I>AFAICS the obvious config issues (mentioned above) would not cause 
missing packets.


HTH
Amos
</PRE>









<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="027614.html">[squid-users] WCCP and SSL-Bump with Squid 3.5 &#8212; HTTPS traffic not reaching Squid
</A></li>
	<LI>Next message (by thread): <A HREF="027623.html">[squid-users] Configuring multiple hosts in LDAP URIs and using DN
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27615">[ date ]</a>
              <a href="thread.html#27615">[ thread ]</a>
              <a href="subject.html#27615">[ subject ]</a>
              <a href="author.html#27615">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
