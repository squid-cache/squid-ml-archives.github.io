<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] User got domain login dialog box prompt, when number of user more than 250++
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20User%20got%20domain%20login%20dialog%20box%20prompt%2C%0A%20when%20number%20of%20user%20more%20than%20250%2B%2B&In-Reply-To=%3C1512835743.441693.1750047935683%40mail.yahoo.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="027570.html">
   <LINK REL="Next"  HREF="027572.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] User got domain login dialog box prompt, when number of user more than 250++</H1>
    <B>wong237ma at yahoo.com</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20User%20got%20domain%20login%20dialog%20box%20prompt%2C%0A%20when%20number%20of%20user%20more%20than%20250%2B%2B&In-Reply-To=%3C1512835743.441693.1750047935683%40mail.yahoo.com%3E"
       TITLE="[squid-users] User got domain login dialog box prompt, when number of user more than 250++">wong237ma at yahoo.com
       </A><BR>
    <I>Mon Jun 16 04:25:35 UTC 2025</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="027570.html">[squid-users] User got domain login dialog box prompt, when number of user more than 250++
</A></li>
        <LI>Next message (by thread): <A HREF="027572.html">[squid-users] User got domain login dialog box prompt, when number of user more than 250++
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27571">[ date ]</a>
              <a href="thread.html#27571">[ thread ]</a>
              <a href="subject.html#27571">[ subject ]</a>
              <a href="author.html#27571">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE> Hi Amos,

Thank for your replied.&#160;

&gt;<i> FTR; the login prompt is not coming from Squid. The client Browser
</I>&gt;<i> decides where to get credentials from - the popup is one source, current
</I>&gt;<i> machine login another, there may be sources as well.
</I>
Our laptop is joined domain. I thought browser will use AD ticket TGT, (which I can view by klist)? not like this?

&gt;<i> Since you are SSL-Bump'ing traffic - whatever result the initial CONNECT
</I>&gt;<i> request credentials were given when the TLS began will be used until
</I>&gt;<i> that TLS connection closes.
</I>
I configure Bumping github website only, the rest of the traffic not decrypt.

&gt;<i> Secondly the auth helper &quot;negative-ttl=900&quot; (from config below) value
</I>&gt;<i> will make Squid only check for different results on new connections
</I>&gt;<i> started 900+ seconds after the first one was rejected.
</I>
squid-cache by default is one hour, so I think I configure 15 mins, which less compare to one hour, not sure whether correct or not.

&gt;<i> Do you still actually **need** NTLM ?
</I>&gt;<i> It has been deprecated for 19 years already, and Windows software has
</I>&gt;<i> progressively been removing the ability to use it.
</I>
Yes, we are using Kerberos, NTLM and basic are for those legacy application, I think.

&gt;<i> The Kerberos auth helper bundled with Squid delivers &quot;group=&quot;
</I>&gt;<i> annotations back to Squid that can be quickly checked instead of using
</I>&gt;<i> extra helper lookups.
</I>
you mean i can use this helper: ext_kerberos_ldap_group_acl, am I right? I will try out, since ChatGPT also mention auth faster compare to ext_wbinfo_group_acl.

Question: Is this main problem?

&gt;<i> FYI, notice that Squid is automatically including all the config files
</I>&gt;<i> in the directory /etc/squid/conf.d/
</I>
yes, it is just a easier manage for me.

I have go through your replied several times and I try to digest.&#160;
My main problem here is that when user hit around 200++, user will prompt out proxy login dialog box ask user to login.

Is there anyway to find out issues?&#160;

Thanks.

    On Friday, June 13, 2025 at 06:09:49 PM GMT+8, Amos Jeffries &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz</A>&gt; wrote:  
 
 On 13/06/25 20:08, wong237ma wrote:
&gt;<i> Hi,
</I>&gt;<i> 
</I>&gt;<i> I had successfully setup squid-openssl (6.10) in Ubuntu 24.04.02 LTS, 
</I>&gt;<i> staging and production. I refer to this squid wiki: <A HREF="https://wiki.squid-">https://wiki.squid-</A> 
</I>&gt;<i> cache.org/ConfigExamples/Authenticate/WindowsActiveDirectory. I had 
</I>&gt;<i> setup Squid-cache authenticate against Activi Directory via kerberos. 
</I>&gt;<i> For proxy user access to staging, windows users (joined AD) no issue on 
</I>&gt;<i> authentication. I test users authenticate seemlessly without any prompt.
</I>&gt;<i> 
</I>&gt;<i> Our office user around 600. when I turn on production proxy. At morning 
</I>&gt;<i> 9am, when user number hit around 100, no issue raise. when user number 
</I>&gt;<i> hit around 250++, windows users, the browser start to prompt user login,
</I>
FTR; the login prompt is not coming from Squid. The client Browser 
decides where to get credentials from - the popup is one source, current 
machine login another, there may be sources as well.

Most often in situations like this, the ActiveDirectory or network 
cannot cope with the number of concurrent credential verification Squid 
is needing to perform.

Alternatively it may just be the clients Browser(s) deciding that login 
has failed and giving up before authentication completes - when the high 
load makes verification slow.


&gt;<i> even domain credential are correct, but seem not work, after that user 
</I>&gt;<i> cannot surf any website.
</I>
There will be a timeouts controlling this.

Since you are SSL-Bump'ing traffic - whatever result the initial CONNECT 
request credentials were given when the TLS began will be used until 
that TLS connection closes.

Secondly the auth helper &quot;negative-ttl=900&quot; (from config below) value 
will make Squid only check for different results on new connections 
started 900+ seconds after the first one was rejected.



&gt;<i> 
</I>&gt;<i> How to troubleshoot this issue?
</I>&gt;<i> 
</I>&gt;<i> I use squidclient to monitor external_acl, negotiateauthenticator, 
</I>&gt;<i> ntlmauthenticator, basicauthenticator, so far no requests timedout.
</I>&gt;<i> 
</I>&gt;<i> I also monitor cache.log with filtering &quot;FATAL:|WARNING:| 
</I>&gt;<i> squidaio_queue_request:|SECURITY ALERT:&quot; didn't find any specifc error.
</I>&gt;<i> 
</I>
You are unlikely to find anything in the Squid logs. Unless one of the 
auth helpers is having issues with its access to your ActiveDirectory 
server.


&gt;<i> Can help to identify, wonder user still got domain login prompt from, 
</I>&gt;<i> e.g. internet browser, like chrome, edge or firefox, outlook and 
</I>&gt;<i> microsoft teams, etc.
</I>&gt;<i> 
</I>&gt;<i> Appciate any help.
</I>&gt;<i> 
</I>&gt;<i> Thanks.
</I>&gt;<i> 
</I>&gt;<i> attach my squid.conf:
</I>&gt;<i> =======================================
</I>&gt;<i> ## negotiate kerberos and ntlm authentication
</I>&gt;<i> auth_param negotiate program /usr/lib/squid/negotiate_wrapper_auth -d -- 
</I>&gt;<i> ntlm /usr/bin/ntlm_auth --diagnostics --helper-protocol=squid-2.5- 
</I>&gt;<i> ntlmssp --domain=MYCOMPANY --kerberos /usr/lib/squid/ 
</I>&gt;<i> negotiate_kerberos_auth -d -s GSS_C_NO_NAME
</I>&gt;<i> auth_param negotiate children 3000 startup=500 idle=200
</I>&gt;<i> auth_param negotiate keep_alive on
</I>&gt;<i> authenticate_ttl 15 minutes
</I>&gt;<i> 
</I>&gt;<i> ## pure ntlm authentication
</I>&gt;<i> auth_param ntlm program /usr/bin/ntlm_auth --diagnostics --helper- 
</I>&gt;<i> protocol=squid-2.5-ntlmssp --domain=MYCOMPANY
</I>&gt;<i> auth_param ntlm children 500 startup=50 idle=10
</I>&gt;<i> auth_param ntlm keep_alive off
</I>&gt;<i> 
</I>
Do you still actually **need** NTLM ?
It has been deprecated for 19 years already, and Windows software has 
progressively been removing the ability to use it.

You may be able to get some metrics out of ActiveDirectory, or the 
server it runs on to measure how many logins are NTLM vs Kerberos.



&gt;<i> ### provide basic authentication via ldap for clients not authenticated 
</I>&gt;<i> via kerberos/ntlm
</I>&gt;<i> auth_param basic program /usr/lib/squid/basic_ldap_auth -R -b 
</I>&gt;<i> &quot;dc=mycompany,dc=com&quot; -D <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squidproxyuser at mycompany.com</A> -W /etc/squid/ 
</I>&gt;<i> ldappass.txt -f sAMAccountName=%s -h mycompanydc.mycompany.com
</I>&gt;<i> auth_param basic children 500 startup=50 idle=10
</I>&gt;<i> auth_param basic realm Internet Proxy
</I>&gt;<i> auth_param basic credentialsttl 1 minute
</I>&gt;<i> 
</I>&gt;<i> #external_acl_type hebadgroup %LOGIN /usr/lib/squid/ext_wbinfo_group_acl
</I>&gt;<i> external_acl_type hebadgroup children-max=1000&#160; children-startup=50 
</I>&gt;<i> children-idle=10 ttl=900 negative_ttl=900 %LOGIN /usr/lib/squid/ 
</I>&gt;<i> ext_wbinfo_group_acl
</I>&gt;<i> 
</I>
The Kerberos auth helper bundled with Squid delivers &quot;group=&quot; 
annotations back to Squid that can be quickly checked instead of using 
extra helper lookups.

Find the SSID in ActiveDirectory for the group (eg &quot;sq_whatsapp&quot;) and 
replace your:

&#160; acl grpwhatsapp external ...

with this (where &quot;SSID&quot; is the string from ActiveDirectory):
&#160; acl grpwhatsapp note group SSID

same for the other groups this helper is used for.


&gt;<i> http_port 3128 ssl-bump generate-host-certificates=on 
</I>&gt;<i> dynamic_cert_mem_cache_size=20MB tls-cert=/etc/squid/cert/squid.crt tls- 
</I>&gt;<i> key=/etc/squid/cert/ca.key
</I>&gt;<i> sslcrtd_program /usr/lib/squid/security_file_certgen -s /var/lib/squid/ 
</I>&gt;<i> ssl_db -M 20MB
</I>&gt;<i> sslcrtd_children 50
</I>&gt;<i> 
</I>&gt;<i> acl localnet src 0.0.0.1-0.255.255.255&#160; # RFC 1122 &quot;this&quot; network (LAN)
</I>&gt;<i> acl localnet src 10.0.0.0/8&#160; &#160; &#160; &#160; &#160; &#160; &#160;# RFC 1918 local private network 
</I>&gt;<i> (LAN)
</I>&gt;<i> acl localnet src 100.64.0.0/10&#160; &#160; &#160; &#160; &#160; # RFC 6598 shared address space 
</I>&gt;<i> (CGN)
</I>&gt;<i> acl localnet src 169.254.0.0/16&#160; &#160; &#160; &#160; &#160;# RFC 3927 link-local (directly 
</I>&gt;<i> plugged) machines
</I>&gt;<i> acl localnet src 172.16.0.0/12&#160; &#160; &#160; &#160; &#160; # RFC 1918 local private network 
</I>&gt;<i> (LAN)
</I>&gt;<i> acl localnet src 192.168.0.0/16&#160; &#160; &#160; &#160; &#160;# RFC 1918 local private network 
</I>&gt;<i> (LAN)
</I>&gt;<i> acl localnet src fc00::/7&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;# RFC 4193 local private network 
</I>&gt;<i> range
</I>&gt;<i> acl localnet src fe80::/10&#160; &#160; &#160; &#160; &#160; &#160; &#160; # RFC 4291 link-local (directly 
</I>&gt;<i> plugged) machines
</I>&gt;<i> 
</I>&gt;<i> acl SSL_ports port 443
</I>&gt;<i> acl Safe_ports port 80&#160; &#160; &#160; &#160; &#160; # http
</I>&gt;<i> acl Safe_ports port 21&#160; &#160; &#160; &#160; &#160; # ftp
</I>&gt;<i> acl Safe_ports port 443&#160; &#160; &#160; &#160; &#160;# https
</I>&gt;<i> acl Safe_ports port 70&#160; &#160; &#160; &#160; &#160; # gopher
</I>&gt;<i> acl Safe_ports port 210&#160; &#160; &#160; &#160; &#160;# wais
</I>&gt;<i> acl Safe_ports port 1025-65535&#160; # unregistered ports
</I>&gt;<i> acl Safe_ports port 280&#160; &#160; &#160; &#160; &#160;# http-mgmt
</I>&gt;<i> acl Safe_ports port 488&#160; &#160; &#160; &#160; &#160;# gss-http
</I>&gt;<i> acl Safe_ports port 591&#160; &#160; &#160; &#160; &#160;# filemaker
</I>&gt;<i> acl Safe_ports port 777&#160; &#160; &#160; &#160; &#160;# multiling http
</I>&gt;<i> 
</I>&gt;<i> acl direct_access dstdomain openshiftapps.com
</I>&gt;<i> cache deny direct_access
</I>
Hmm. calling that ACL &quot;direct_access&quot; implies that whoever designed it 
thinks the &quot;cache&quot; directive has something to do with accessing things.
It does not.

The above two config lines prevent Squid from _storing_ any traffic when 
the domain is exactly the string &quot;openshiftapps.com&quot; (emphasis on the 
exact part, &quot;www.openshiftapps.com&quot; and similar will **not** match that 
ACL definition). So nothing from there should be able to produce HIT or 
REFRESH type responses.



&gt;<i> 
</I>&gt;<i> acl urlwhatsapp dstdomain .whatsapp.com
</I>&gt;<i> acl grpwhatsapp external adgroup sq_whatsapp
</I>&gt;<i> acl grpgithub external adgroup SSLVPN-GitHub-CoPilot
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> # Enable Proxy Authentication
</I>&gt;<i> acl aduser proxy_auth REQUIRED
</I>&gt;<i> 
</I>&gt;<i> # Domains for SSL Bump
</I>&gt;<i> acl url_sslbump dstdomain .github.com
</I>&gt;<i> 
</I>&gt;<i> # Define SSL Bump steps
</I>&gt;<i> acl step1 at_step SslBump1
</I>&gt;<i> acl step2 at_step SslBump2
</I>&gt;<i> acl step3 at_step SslBump3
</I>&gt;<i> 
</I>&gt;<i> # SSL Bump rules for specific traffic
</I>&gt;<i> ssl_bump peek step1 all
</I>&gt;<i> ssl_bump bump step2 url_sslbump
</I>&gt;<i> ssl_bump splice all&#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160; &#160;# Splice (do not bump) all other 
</I>&gt;<i> traffic
</I>&gt;<i> sslproxy_cert_error allow url_sslbump
</I>&gt;<i> 
</I>&gt;<i> 
</I>&gt;<i> #http_access deny !Safe_ports
</I>&gt;<i> #http_access deny CONNECT !SSL_ports
</I>&gt;<i> http_access allow localhost manager
</I>&gt;<i> http_access deny manager
</I>&gt;<i> http_access allow localhost
</I>&gt;<i> http_access deny to_localhost
</I>&gt;<i> http_access deny to_linklocal
</I>&gt;<i> include /etc/squid/conf.d/*.conf
</I>&gt;<i> 
</I>&gt;<i> # Access control for GitHub Copilot Group
</I>&gt;<i> include /etc/squid/github.conf
</I>&gt;<i> 
</I>
FYI, notice that Squid is automatically including all the config files 
in the directory /etc/squid/conf.d/

You should only need to drop the file github.conf into that directory 
and not include it here.


&gt;<i> http_access allow urlwhatsapp grpwhatsapp
</I>&gt;<i> http_access deny urlwhatsapp
</I>&gt;<i> 
</I>&gt;<i> http_access allow aduser
</I> &gt; http_access deny all
 &gt;

Login should happen before any of the ACLs that check group memberships 
or other auth related things.

When done that way it should look something like this:

&#160; # require credentials to both exist and be valid
&#160; acl login proxy_auth REQUIRED
&#160; http_access deny !login

&#160; # ACLs that use login credentials or login related details
&#160; http_access allow group_A somewhere
&#160; http_access deny group_B
&#160; ...

&#160; # maybe allow any LAN clients not denied above.
&#160; http_access allow localnet

&#160; http_access deny all


HTH
Amos

_______________________________________________
squid-users mailing list
<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
<A HREF="https://lists.squid-cache.org/listinfo/squid-users">https://lists.squid-cache.org/listinfo/squid-users</A>
  
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20250616/8acb5df5/attachment-0001.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20250616/8acb5df5/attachment-0001.htm</A>&gt;
</PRE>


<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="027570.html">[squid-users] User got domain login dialog box prompt, when number of user more than 250++
</A></li>
	<LI>Next message (by thread): <A HREF="027572.html">[squid-users] User got domain login dialog box prompt, when number of user more than 250++
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27571">[ date ]</a>
              <a href="thread.html#27571">[ thread ]</a>
              <a href="subject.html#27571">[ subject ]</a>
              <a href="author.html#27571">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
