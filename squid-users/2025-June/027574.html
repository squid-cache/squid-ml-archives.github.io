<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Kerberos Auth weirdness/inconsistency when using CNAMEs/Round-robin DNS
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Kerberos%20Auth%20weirdness/inconsistency%20when%20using%0A%20CNAMEs/Round-robin%20DNS&In-Reply-To=%3C6a32534a-d605-474f-9cca-79d3735385b4%40ed.ac.uk%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="027577.html">
   <LINK REL="Next"  HREF="027575.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Kerberos Auth weirdness/inconsistency when using CNAMEs/Round-robin DNS</H1>
    <B>Mark Cairney</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Kerberos%20Auth%20weirdness/inconsistency%20when%20using%0A%20CNAMEs/Round-robin%20DNS&In-Reply-To=%3C6a32534a-d605-474f-9cca-79d3735385b4%40ed.ac.uk%3E"
       TITLE="[squid-users] Kerberos Auth weirdness/inconsistency when using CNAMEs/Round-robin DNS">Mark.Cairney at ed.ac.uk
       </A><BR>
    <I>Wed Jun 18 08:49:49 UTC 2025</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="027577.html">[squid-users] User got domain login dialog box prompt, when number of user more than 250++
</A></li>
        <LI>Next message (by thread): <A HREF="027575.html">[squid-users] Kerberos Auth weirdness/inconsistency when using CNAMEs/Round-robin DNS
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27574">[ date ]</a>
              <a href="thread.html#27574">[ thread ]</a>
              <a href="subject.html#27574">[ subject ]</a>
              <a href="author.html#27574">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hi,

I&#8217;ve been trying to get Kerberos Authentication against AD working but 
have been seeing inconsistent results/behaviour across multiple Oses and 
I&#8217;m not sure if the issue lies with the DNS configuration, Kerberos 
itself or with the Squid config:

THE DNS setup is as follows:

test.squid.cluster. 3600 IN&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; CNAME&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; 
test-squid-cluster.dyn-zone.

test-squid-cluster.dyn-zone. 60 IN A 1.2.3.4

Where 1.2.3.4 is the IP of one of the servers in the cluster. The 
intention is to have multiple Squid servers behind a single DNS name for 
high-availability.

This is what I&#8217;m seeing in the cache log with my current setup:

Windows:

negotiate_kerberos_auth.cc(182): pid=668789 :2025/06/16 16:03:01| 
negotiate_kerb

eros_auth: ERROR: gss_accept_sec_context() failed: Unspecified GSS 
failure.&#160; Min

or code may provide more information. Cannot find key for HTTP/ 
<A HREF="https://lists.squid-cache.org/listinfo/squid-users">test-squid-cluster.dyn-zone at REALM</A> kvno 2 in keytab (request ticket 
server HTTP/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">test.squid.cluster at REALM</A>

Rocky Linux:

curl -ik -vvv -L --proxy-negotiate -U : -b ~/cookiejar.txt -c 
~/cookiejar.txt -x &quot;test.squid.cluster:3128&quot; <A HREF="https://www.bbc.co.uk">https://www.bbc.co.uk</A>

negotiate_kerberos_auth.cc(182): pid=668789 :2025/06/17 08:51:52| 
negotiate_kerb

eros_auth: ERROR: gss_accept_sec_context() failed: Unspecified GSS 
failure.&#160; Min

2025/06/17 08:51:52| negotiate_kerberos_auth: INFO: User not authenticated

2025/06/17 08:51:52.964 kid1| ERROR: Negotiate Authentication validating 
user. R

esult: {result=BH, notes={message: gss_accept_sec_context() failed: 
Unspecified

er HTTP/server1@ &lt;mailto:HTTP/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">marmalade.cache.ed.ac.uk at ED.AC.UK</A>&gt;REALM); }}

klist -e

Ticket cache: FILE:/tmp/krb5cc_138460_vF4BWcMsZu

Default principal: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">ext6033 at ED.AC.UK</A>

17/06/25 08:51:44&#160; 17/06/25 18:51:24 krbtgt/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">REALM at REALM</A>

 &#160;&#160;&#160;&#160;&#160;&#160;&#160; Etype (skey, tkt): aes256-cts-hmac-sha1-96, aes256-cts-hmac-sha1-96

17/06/25 08:51:52&#160; 17/06/25 18:51:24 HTTP/server@

 &#160;&#160;&#160;&#160;&#160;&#160;&#160; Etype (skey, tkt): aes256-cts-hmac-sha1-96, aes256-cts-hmac-sha1-96

 &#160;&#160;&#160;&#160;&#160;&#160;&#160; Ticket server: server/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">REALM at REALM</A>

With the same behaviour if I use the Dynamic Zone record in the curl 
command i.e.

curl -ik -vvv -L --proxy-negotiate -U : -b ~/cookiejar.txt -c 
~/cookiejar.txt -x &quot; test-squid-cluster.dyn-zone:3128&quot; <A HREF="https://www.bbc.co.uk">https://www.bbc.co.uk</A>

Ubuntu 24.04

curl -ik -vvv -L --proxy-negotiate -U : -b ~/cookiejar.txt -c 
~/cookiejar.txt -x &quot;test.squid.cluster:3128&quot; &quot;<A HREF="https://www.bbc.co.uk">https://www.bbc.co.uk</A>&quot; works


negotiate_kerberos_auth.cc(815): pid=668789 :2025/06/18 09:11:17| 
negotiate_kerberos_auth: DEBUG: OK 
token=oYG3MIG0oAMKAQChCwYJKoZIhvcSAQICooGfBIGcYIGZBgkqhkiG9xIBAgICAG+BiTCBhqADAgEFoQMCAQ+iejB4oAMCARKicQRvJ1BxA5rnZjKbfBVE0YqUlnYx7oLguj09HLH4SJRumUjWWXh99B/4X72vpFqCXeOKmvzSDlWG0Io1ZjQxNOxqni4sFx8exojIzg4aIWKAcYB21OHr9m0T9dfymDVoV61Cofyq38fUaN5Loen9YX0h 
user=account
2025/06/18 09:11:17| negotiate_kerberos_auth: INFO: User account 
authenticated


klist -e
Ticket cache: FILE:/tmp/krb5cc_1001_7KsHEg
Default principal: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">account at REALM</A>

Valid starting&#160;&#160;&#160;&#160; Expires&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; Service principal
06/18/25 09:10:09&#160; 06/18/25 19:10:09&#160; krbtgt/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">REALM at REALM</A>
 &#160;&#160;&#160; renew until 06/19/25 09:09:36, Etype (skey, tkt): 
aes256-cts-hmac-sha1-96, aes256-cts-hmac-sha1-96
06/18/25 09:11:17&#160; 06/18/25 19:10:09 HTTP/test-squid-cluster.dyn-zone@
 &#160;&#160;&#160; renew until 06/19/25 09:09:36, Etype (skey, tkt): 
aes256-cts-hmac-sha1-96, aes256-cts-hmac-sha1-96


curl -ik -vvv -L --proxy-negotiate -U : -b ~/cookiejar.txt -c 
~/cookiejar.txt -x &quot;test-squid-cluster.dyn-zone:3128&quot; 
&quot;<A HREF="https://www.bbc.co.uk">https://www.bbc.co.uk</A>&quot;


Works as well

klist -e
Ticket cache: FILE:/tmp/krb5cc_1001_7KsHEg
Default principal: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">account at REALM</A>

Valid starting&#160;&#160;&#160;&#160; Expires&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; Service principal
06/18/25 09:17:11&#160; 06/18/25 19:17:11&#160; krbtgt/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">REAM at REALM</A>
 &#160;&#160;&#160; renew until 06/19/25 09:16:55, Etype (skey, tkt): 
aes256-cts-hmac-sha1-96, aes256-cts-hmac-sha1-96
06/18/25 09:17:38&#160; 06/18/25 19:17:11 HTTP/test-squid-cluster.dyn-zone@
 &#160;&#160;&#160; renew until 06/19/25 09:16:55, Etype (skey, tkt): 
aes256-cts-hmac-sha1-96, aes256-cts-hmac-sha1-96
 &#160;&#160;&#160; Ticket server: HTTP/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">test-exams-cache.www-dyn.ed.ac.uk at ED.AC.UK</A>


Mac (Sequoia 15.5)

curl -ik -vvv -L --proxy-negotiate -U : -b ~/cookiejar.txt -c 
~/cookiejar.txt -x &quot;test.squid.cluster.dyn-zone:3128&quot; <A HREF="https://www.bbc.co.uk">https://www.bbc.co.uk</A>

2025/06/17 09:32:26| negotiate_kerberos_auth: INFO: User not authenticated

2025/06/17 09:32:26.600 kid1| ERROR: Negotiate Authentication validating 
user. R

esult: {result=BH, notes={message: gss_accept_sec_context() failed: 
Unspecified

GSS failure.&#160; Minor code may provide more information. Cannot find key 
for HTTP/

<A HREF="https://lists.squid-cache.org/listinfo/squid-users">test-squid-cluster.dyn-zone at REALM</A> kvno 2 in keytab (request ticket serv

er HTTP/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">test.squid.cluster at REALM</A>); }}

klist -v

Server: HTTP/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">test.squid.cluster at REALM</A>

Client: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">account at REALM</A>

Ticket etype: aes256-cts-hmac-sha1-96, kvno 2

Ticket length: 1690

Auth time:&#160; Jun 17 09:32:17 2025

Start time: Jun 17 09:32:26 2025

End time:&#160;&#160; Jun 17 19:31:56 2025

Ticket flags: enc-pa-rep, pre-authent, forwardable

Addresses: addressless

curl -ik -vvv -L --proxy-negotiate -U : -b ~/cookiejar.txt -c 
~/cookiejar.txt -x &quot;test-squid-cluster.dyn.zone:3128&quot; <A HREF="https://www.bbc.co.uk">https://www.bbc.co.uk</A>

Successful:

2025/06/17 09:36:38| negotiate_kerberos_auth: INFO: User account 
authenticated

2025/06/17 09:36:38.165 kid1| 82,2| external_acl.cc(700) 
aclMatchExternal: ldap_group = ALLOWED

Klist -v

Server: krbtgt/REALM@ &lt;mailto:krbtgt/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">ED.AC.UK at ED.AC.UK</A>&gt;REALM

Client: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">account at REALM</A>

Ticket etype: aes256-cts-hmac-sha1-96, kvno 11

Ticket length: 1683

Auth time:&#160; Jun 17 09:36:31 2025

End time:&#160;&#160; Jun 17 19:36:23 2025

Ticket flags: enc-pa-rep, pre-authent, initial, forwardable

Addresses: addressless

Server: HTTP/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">test-squid-cluster.dyn.zone at REALM</A>

Client: account@ &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">ext6033 at ED.AC.UK</A>&gt;REALM

Ticket etype: aes256-cts-hmac-sha1-96, kvno 1

Ticket length: 1698

Auth time:&#160; Jun 17 09:36:31 2025

Start time: Jun 17 09:36:38 2025

End time:&#160;&#160; Jun 17 19:36:23 2025

Ticket flags: enc-pa-rep, pre-authent, forwardable

Addresses: addressless

The relevant parts of the squid.conf are:

http_port 3128

cache_mem 256 mb

maximum_object_size_in_memory 512 KB

maximum_object_size 2048 mb

cache_dir ufs /var/spool/squid 51200 16 256

debug_options ALL,2

visible_hostname test-squid-cluster.dyn.zone

unique_hostname server1

refresh_pattern .&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; 0&#160;&#160;&#160;&#160;&#160;&#160; 20% 4320 ignore-reload

auth_param basic children 10

auth_param negotiate program /usr/lib64/squid/negotiate_kerberos_auth -k 
/etc/squid/HTTP.keytab -s HTTP/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">test-squid-cluster.dyn.zone at REALM</A> -d -i -r

(We also have LDAP basic auth configured as a fallback which works as 
expected but modern Windows clients no longer support basic auth for 
proxy servers).

klist -k /etc/squid/HTTP.keytab

Keytab name: FILE:/etc/squid/HTTP.keytab

KVNO Principal

---- 
--------------------------------------------------------------------------

 &#160;&#160; 1 TESTSQUIDCACHE@ &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">TESTEXAMSCACHE at ED.AC.UK</A>&gt;REALM

 &#160;&#160; 1 TESTSQUIDCACHE@ &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">TESTEXAMSCACHE at ED.AC.UK</A>&gt;REALM

 &#160;&#160; 1 TESTSQUIDCACHE@ &lt;mailto:<A HREF="https://lists.squid-cache.org/listinfo/squid-users">TESTEXAMSCACHE at ED.AC.UK</A>&gt;REALM

 &#160;&#160; 1 HTTP/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">test-squid-cache.dyn.zone at REALM</A>

 &#160;&#160; 1 HTTP/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">test-squid-cache.dyn.zone at REALM</A>

 &#160;&#160; 1 HTTP/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">test-squid-cache.dyn.zone at REALM</A>

/etc/hosts

1.2.3.4 server1.cache server1 test-squid-cache.dyn.zone test.squid.cluster

Finally the keytab was generated using msktutil e.g.

msktutil -c -h test-squid-cache.dyn.zone -b 
'OU=Managed-Linux,OU=Infrastructure' --computer-name TESTSQUIDCACHE -s 
HTTP/test-squid-cache.dyn.zone -k /etc/squid/HTTP.keytab --server 
domain.controller --realm REALM --use-service-account 
--dont-expire-password --upn HTTP/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">test-squid-cache.dyn.zone at REALM</A>

This works fairly well/reliably if we use a keytab containing the 
HTTP/fqdn of the server itself i.e. HTTP/server1 AND connect using curl 
using the FQDN of server1 but we need resiliency and high-availability 
so having a single-host service would be a last resort.

Any ideas on where I&#8217;m going wrong or what I need to add in terms of 
DNS/keytab entries? Also some of the clients attempt to use key versions 
which have never been issued e.g. kvno 4?

Kind regards,

Mark

--
/****************************

Mark Cairney
ITI Enterprise Services
Information Services
University of Edinburgh

Tel: 0131 650 6565
Email: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">_Mark.Cairney at ed.ac.uk_</A>

*******************************/

The University of Edinburgh is a charitable body, registered in 
Scotland, with registration number SC005336.signature_2526785256
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20250618/52049dec/attachment-0001.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20250618/52049dec/attachment-0001.htm</A>&gt;
-------------- next part --------------
A non-text attachment was scrubbed...
Name: image002.png
Type: image/png
Size: 263 bytes
Desc: not available
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20250618/52049dec/attachment-0001.png">http://lists.squid-cache.org/pipermail/squid-users/attachments/20250618/52049dec/attachment-0001.png</A>&gt;
</PRE>



<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="027577.html">[squid-users] User got domain login dialog box prompt, when number of user more than 250++
</A></li>
	<LI>Next message (by thread): <A HREF="027575.html">[squid-users] Kerberos Auth weirdness/inconsistency when using CNAMEs/Round-robin DNS
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27574">[ date ]</a>
              <a href="thread.html#27574">[ thread ]</a>
              <a href="subject.html#27574">[ subject ]</a>
              <a href="author.html#27574">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
