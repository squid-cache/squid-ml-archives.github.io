<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] transparent or intercept proxy with iptables and haproxy
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20transparent%20or%20intercept%20proxy%20with%20iptables%20and%0A%20haproxy&In-Reply-To=%3CaFhCFTckdzR2gIPH%40fantomas.sk%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="027578.html">
   <LINK REL="Next"  HREF="027581.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] transparent or intercept proxy with iptables and haproxy</H1>
    <B>Matus UHLAR - fantomas</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20transparent%20or%20intercept%20proxy%20with%20iptables%20and%0A%20haproxy&In-Reply-To=%3CaFhCFTckdzR2gIPH%40fantomas.sk%3E"
       TITLE="[squid-users] transparent or intercept proxy with iptables and haproxy">uhlar at fantomas.sk
       </A><BR>
    <I>Sun Jun 22 17:49:09 UTC 2025</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="027578.html">[squid-users] transparent or intercept proxy with iptables and haproxy
</A></li>
        <LI>Next message (by thread): <A HREF="027581.html">[squid-users] transparent or intercept proxy with iptables and haproxy
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27580">[ date ]</a>
              <a href="thread.html#27580">[ thread ]</a>
              <a href="subject.html#27580">[ subject ]</a>
              <a href="author.html#27580">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>On 19.06.25 15:29, Brendan Kearney wrote:
&gt;<i>i am trying to setup a transparent or intercept proxy, where a client 
</I>&gt;<i>does not know or is not configured to use a proxy, but winds up going 
</I>&gt;<i>through squid instances.&#160; i have an iptables firewall, and can perform 
</I>&gt;<i>DNAT,
</I>
DNAT is dangerous, because the proxy on remote machine loses the real IP the 
connection was directed to.
You need to use policy routing, where you forward packets on other host 
which will intercept the connections itself.

&gt;<i> to point the traffic at a haproxy VIP.&#160; the haproxy VIP will use 
</I>&gt;<i>least-conn load balancing to pick which of my 3 squid instances to 
</I>&gt;<i>send the traffic to.&#160; i would like to configure the squid instances to 
</I>&gt;<i>handle the traffic coming in this way.
</I>&gt;<i>
</I>&gt;<i>i am unclear as to the differences between intercept and tproxy, so 
</I>&gt;<i>some clarity there would be helpful.
</I>
&quot;intercept&quot; intercepts connection to remote hosts and handles it (and 
replies) locally.  
The proxy fakes being the destination server to the client.

&quot;tproxy&quot; does the same, but even changes the client's IP, as if the 
connection came from client
The proxy fakes being the client to the server (in addition to the above).

You don't need tproxy if your clients and proxy are behind NAT, translating 
to the same IP.

&gt;<i> i believe transparent requires 
</I>&gt;<i>that the NAT'ing be done &quot;on-box&quot; as opposed to across the network by 
</I>&gt;<i>my router.&#160; is this accurate?&#160; are there any other differences?&#160; which 
</I>&gt;<i>is the appropriate mechanism for my use case?
</I>
Again, don't to DNAT.

If you redirect HTTP connections on your router to the proxy, use policy 
routing and do intercept on the proxy.

&gt;<i>the connection chain would look something like this:
</I>&gt;<i>
</I>&gt;<i>client -&gt; router (DNAT to VIP) -&gt; haproxy VIP (port 3129, SNAT to VIP 
</I>&gt;<i>IP) -&gt; squid (port 3129) -&gt; internet
</I>&gt;<i>
</I>&gt;<i>is this kind of config viable, and if so, what pieces do i have 
</I>&gt;<i>wrong?&#160; in this scenario is transparent or intercept the proper means 
</I>&gt;<i>within squid?
</I>
You need to find out how HAPROXY handles intercepted connections.
-- 
Matus UHLAR - fantomas, <A HREF="https://lists.squid-cache.org/listinfo/squid-users">uhlar at fantomas.sk</A> ; <A HREF="http://www.fantomas.sk/">http://www.fantomas.sk/</A>
Warning: I wish NOT to receive e-mail advertising to this address.
Varovanie: na tuto adresu chcem NEDOSTAVAT akukolvek reklamnu postu.
Nothing is fool-proof to a talented fool.
</PRE>




<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="027578.html">[squid-users] transparent or intercept proxy with iptables and haproxy
</A></li>
	<LI>Next message (by thread): <A HREF="027581.html">[squid-users] transparent or intercept proxy with iptables and haproxy
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27580">[ date ]</a>
              <a href="thread.html#27580">[ thread ]</a>
              <a href="subject.html#27580">[ subject ]</a>
              <a href="author.html#27580">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
