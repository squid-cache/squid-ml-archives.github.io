<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [squid-users] Kerberos Auth weirdness/inconsistency when using CNAMEs/Round-robin DNS
   </TITLE>
   <LINK REL="Index" HREF="index.html" >
   <LINK REL="made" HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Kerberos%20Auth%20weirdness/inconsistency%20when%20using%0A%20CNAMEs/Round-robin%20DNS&In-Reply-To=%3C2D00F07A-1DC2-4369-9803-D2FE1BF1FB2A%40diladele.com%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="027582.html">
   <LINK REL="Next"  HREF="027578.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[squid-users] Kerberos Auth weirdness/inconsistency when using CNAMEs/Round-robin DNS</H1>
    <B>Rafael Akchurin</B> 
    <A HREF="mailto:squid-users%40lists.squid-cache.org?Subject=Re%3A%20%5Bsquid-users%5D%20Kerberos%20Auth%20weirdness/inconsistency%20when%20using%0A%20CNAMEs/Round-robin%20DNS&In-Reply-To=%3C2D00F07A-1DC2-4369-9803-D2FE1BF1FB2A%40diladele.com%3E"
       TITLE="[squid-users] Kerberos Auth weirdness/inconsistency when using CNAMEs/Round-robin DNS">rafael.akchurin at diladele.com
       </A><BR>
    <I>Mon Jun 23 10:27:05 UTC 2025</I>
    <P><UL>
        <LI>Previous message (by thread): <A HREF="027582.html">[squid-users] Kerberos Auth weirdness/inconsistency when using CNAMEs/Round-robin DNS
</A></li>
        <LI>Next message (by thread): <A HREF="027578.html">[squid-users] transparent or intercept proxy with iptables and haproxy
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27583">[ date ]</a>
              <a href="thread.html#27583">[ thread ]</a>
              <a href="subject.html#27583">[ subject ]</a>
              <a href="author.html#27583">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Hello Mark,

You can just export the keytab generated on windows and use it on your proxy - then there is no need to mess with proxy&#8217;s account in AD - overall this is much easier I believe - see <A HREF="https://www.diladele.com/websafety/docs/authentication/active_directory/kerberos/">https://www.diladele.com/websafety/docs/authentication/active_directory/kerberos/</A>

And it also works pretty nice with several boxes at once - we use it all the time when testing AD integration, see  <A HREF="https://www.diladele.com/websafety/docs/redundancy/haproxy_proxy_protocol/">https://www.diladele.com/websafety/docs/redundancy/haproxy_proxy_protocol/</A>

Hope it helps.

Best regards,
Rafael Akchurin

On 23 Jun 2025, at 12:16, Mark Cairney &lt;<A HREF="https://lists.squid-cache.org/listinfo/squid-users">Mark.Cairney at ed.ac.uk</A>&gt; wrote:

&#65279;Hi,

Thanks- that make sense and as a result I've set the reverse DNS on the 2 hosts to the round-robin DNS name.

RE: the KVNO drift issue, one suggestion was to delete the existing machine account(s) from AD and use ktpass and set the kvno to 0.

I'd previously used msktutil (as suggested on <A HREF="https://wiki.squid-cache.org/ConfigExamples/Authenticate/WindowsActiveDirectory">https://wiki.squid-cache.org/ConfigExamples/Authenticate/WindowsActiveDirectory</A>) with the 'dont-expire-password' flag i.e:

msktutil -c -h test-squid-cluster.dyn.zone -b 'OU=Managed-Linux-Servers' --computer-name TESTSQUID -s HTTP/test-squid-cluster.dyn.zone -k /etc/squid/HTTP.keytab --server domain.controller --realm REALM --use-service-account --dont-expire-password --upn HTTP/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">test-squid-cluster.dyn.zone at REALM</A>

Which is more likely to be reliable (unfortunately I have to use MS AD as the whole purpose of this proxy is to allow Windows clients to use an authenticated proxy).

Kind regards,

Mark

On 19/06/2025 15:21, Amos Jeffries wrote:
[You don't often get email from <A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid3 at treenet.co.nz.</A> Learn why this is important at <A HREF="https://aka.ms/LearnAboutSenderIdentification">https://aka.ms/LearnAboutSenderIdentification</A> ]

On 18/06/25 20:49, Mark Cairney wrote:
Hi,

I&#8217;ve been trying to get Kerberos Authentication against AD working but
have been seeing inconsistent results/behaviour across multiple Oses and
I&#8217;m not sure if the issue lies with the DNS configuration, Kerberos
itself or with the Squid config:

THE DNS setup is as follows:

test.squid.cluster. 3600 IN           CNAME test-squid-
cluster.dyn-zone.

test-squid-cluster.dyn-zone. 60 IN A 1.2.3.4

Where 1.2.3.4 is the IP of one of the servers in the cluster. The
intention is to have multiple Squid servers behind a single DNS name for
high-availability.


FYI, you cannot have multiple CNAME for test.squid.cluster pointing at
different Squid server names. So this should not be a problem.


In Kerberos:
* Setup your keytab entry for HTTP/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">test-squid-cluster.dyn-zone at REALM.</A>
* export the HTTP/<A HREF="https://lists.squid-cache.org/listinfo/squid-users">test-squid-cluster.dyn-zone at REALM</A> keytab to each proxy

In DNS:
* Add as many proxy as you want to test-squid-cluster.dyn-zone with A or
AAAA records in DNS.
* point any domains you want those proxy to be acting as a CDN to
test-squid-cluster.dyn-zone using CNAME in DNS.



Cheers
Amos
_______________________________________________
squid-users mailing list
<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
<A HREF="https://lists.squid-cache.org/listinfo/squid-users">https://lists.squid-cache.org/listinfo/squid-users</A>

--
/****************************

Mark Cairney
ITI Enterprise Services
Information Services
University of Edinburgh

Tel: 0131 650 6565
Email: <A HREF="https://lists.squid-cache.org/listinfo/squid-users">Mark.Cairney at ed.ac.uk</A>

*******************************/

The University of Edinburgh is a charitable body, registered in Scotland, with registration number SC005336.

_______________________________________________
squid-users mailing list
<A HREF="https://lists.squid-cache.org/listinfo/squid-users">squid-users at lists.squid-cache.org</A>
<A HREF="https://lists.squid-cache.org/listinfo/squid-users">https://lists.squid-cache.org/listinfo/squid-users</A>
-------------- next part --------------
An HTML attachment was scrubbed...
URL: &lt;<A HREF="http://lists.squid-cache.org/pipermail/squid-users/attachments/20250623/17dd8bd4/attachment-0001.htm">http://lists.squid-cache.org/pipermail/squid-users/attachments/20250623/17dd8bd4/attachment-0001.htm</A>&gt;
</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message (by thread): <A HREF="027582.html">[squid-users] Kerberos Auth weirdness/inconsistency when using CNAMEs/Round-robin DNS
</A></li>
	<LI>Next message (by thread): <A HREF="027578.html">[squid-users] transparent or intercept proxy with iptables and haproxy
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#27583">[ date ]</a>
              <a href="thread.html#27583">[ thread ]</a>
              <a href="subject.html#27583">[ subject ]</a>
              <a href="author.html#27583">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.squid-cache.org/listinfo/squid-users">More information about the squid-users
mailing list</a><br>
</body></html>
